Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_HasItemEvent(S_DEN_AdventurerNote_a07e15dd-2a7d-4c65-a981-0e6510266168,(FLAG)DEN_AdventurersQuest_State_HasNote_370c7614-e4ff-7213-fe80-23980221bd45);

DB_DialogMoneyTransfer(1, DEN_AdventurerLeader_46fea64f-e098-2df5-f4ee-825080ef9728, 5000);
DB_DialogMoneyTransfer(1, DEN_AdventurersQuest_LeaderAtCorpses_753a0b1e-b28d-e00a-f77f-340cca458dc0, 5000);

DB_DoNotFaceDialog(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, DEN_AdventurersQuest_LeaderAtCorpses_753a0b1e-b28d-e00a-f77f-340cca458dc0);

DB_DEN_AdventurersQuest_AdventurerOnRoad((CHARACTER)S_DEN_RobbedAdventurer_534bceaf-678c-40a0-8ca9-e1134f95ba0d, (DIALOGRESOURCE)DEN_AdventurersQuest_RobbedAdventurerAtCorpses_ff43b1c2-9385-e13d-a4b8-16df167eb307, (TRIGGER)S_DEN_DeadPoint_003_af624df6-cf2a-468a-b7fc-74d46ff24934);
DB_DEN_AdventurersQuest_AdventurerOnRoad(S_DEN_RaidAdventurer_4faf77a0-b883-4f7b-acbf-4500973f446d, DEN_AdventurersQuest_RaidAdventurerAtCorpses_7ac06f55-ebd5-ae29-22af-61df619451f5, S_DEN_DeadPoint_002_d439f0fc-d2c1-4ac2-b5e0-69eda1d9e4d3);
DB_DEN_AdventurersQuest_AdventurerOnRoad(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, DEN_AdventurersQuest_LeaderAtCorpses_753a0b1e-b28d-e00a-f77f-340cca458dc0, S_DEN_DeadPoint_001_5170e97e-e483-4360-a09e-32f37f9d8116);

DB_OneShot_VoiceBarkTrigger(S_DEN_AtCorpsesVBArea_0f297a62-e5e3-4970-b26f-2d33fcdf3029, DEN_AdventurersQuest_VB_AtCorpses_c1000ff3-dab9-c148-3b07-388f697f6ee2, "GlobalIgnoreFailure");

DB_DEN_AdventurersQuest_DenDialogs((CHARACTER)S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, (DIALOGRESOURCE)DEN_AdventurerLeader_46fea64f-e098-2df5-f4ee-825080ef9728);
DB_DEN_AdventurersQuest_DenDialogs(S_DEN_RaidAdventurer_4faf77a0-b883-4f7b-acbf-4500973f446d, DEN_AdventurersQuest_RaidAdventurer_33617ce2-882e-8c82-83da-3c6b0e0b06ef);

DB_DEN_Adventurers((CHARACTER)S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
DB_DEN_Adventurers(S_DEN_RaidAdventurer_4faf77a0-b883-4f7b-acbf-4500973f446d);
DB_DEN_Adventurers(S_DEN_RobbedAdventurer_534bceaf-678c-40a0-8ca9-e1134f95ba0d);

PROC_TriggerRegisterForPlayers(S_DEN_AtCorpsesVBArea_0f297a62-e5e3-4970-b26f-2d33fcdf3029);
PROC_TriggerRegisterForPlayers(S_UND_GrymforgeJournalTrigger_3fdc0311-2ea1-4f2e-8310-17e54b0d67a7);

//REGION SHA_Nightsong Quest
DB_QuestDef_BookReadState("SHA_Nightsong", "HeardOf", S_DEN_AdventurerNote_a07e15dd-2a7d-4c65-a981-0e6510266168);
DB_QuestDef_State(GOB_TempleAccess_Event_PuzzleSolved_e48a7760-a5b2-4f2e-9e9c-52645d772bd3,"SHA_Nightsong","SolvedPuzzle");
DB_QuestDef_BookReadState("SHA_Nightsong", "ReadHalsinDiary", S_GLO_HalsinDiary_5e4aafd4-f56c-4b05-ad5a-00eccdb87d9d);
DB_QuestDef_BookReadState("SHA_Nightsong", "ReadJusticiarBook", S_UND_NightsongBook_03ddecea-d7db-4fda-803b-5c81a0f3493b);
//END_REGION
KBSECTION
//REGION Nightsong Quest
IF
GameBookInterfaceClosed(S_GOB_SharTempleMap_f01b15a1-e670-43ac-abeb-e7ec9d5fc803,_Char)
AND
DB_Players(_Char)
AND
DB_QuestIsAccepted("SHA_Nightsong")
AND
QuestUpdateIsUnlocked(_Char, "SHA_Nightsong", "SawBook", 0)
THEN
QuestUpdate(_Char, "SHA_Nightsong", "RefinedLocation");

IF
GameBookInterfaceClosed(S_GOB_SharTempleMap_f01b15a1-e670-43ac-abeb-e7ec9d5fc803,_Char)
AND
DB_Players(_Char)
AND
NOT DB_QuestIsAccepted("SHA_Nightsong")
THEN
QuestUpdate(_Char, "SHA_Nightsong", "SawBook");

//--- EnteredUnderdark
//When leaving the trigger S_UND_SharFortBox_3419cfbf-5ad0-473b-bfa6-f10cb1e4a415 while still being in UND - that's S_UND_Underdark_SUB_b379a862-a59f-4e52-9166-23fbe0e8976e
//(there's an elevator going outside, it shouldn't be triggering the entry)
IF
Teleported(_Player,_,_OldX,_OldY,_Old,_,_,_,_Reason)
AND
_Reason != "RegionSwap"
AND
DB_Players(_Player)
AND
NOT DB_UND_Nightsong_EnteredUnderdark(_)
AND
DB_QuestIsOpened("SHA_Nightsong")
AND
IsInTrigger(_Player, S_UND_SharFortBox_3419cfbf-5ad0-473b-bfa6-f10cb1e4a415, 1)
AND
PositionIsInTrigger(_OldX,_OldY,_Old, S_UND_Underdark_SUB_b379a862-a59f-4e52-9166-23fbe0e8976e, 0)
THEN
DB_UND_Nightsong_EnteredUnderdark(1);

IF
LeftTrigger(_Player, S_UND_SharFortBox_3419cfbf-5ad0-473b-bfa6-f10cb1e4a415)
AND
DB_Players(_Player)
AND
DB_UND_Nightsong_EnteredUnderdark(1)
AND
IsInTrigger(_Player, S_UND_Underdark_SUB_b379a862-a59f-4e52-9166-23fbe0e8976e, 1)
THEN
QuestUpdate(_Player,"SHA_Nightsong","EnteredUnderdark");
NOT DB_UND_Nightsong_EnteredUnderdark(1);
DB_UND_Nightsong_EnteredUnderdark(0); //put to 0 to avoid executing these rules again

IF
LeftTrigger(_Player, S_UND_SharFortBox_3419cfbf-5ad0-473b-bfa6-f10cb1e4a415)
AND
DB_Players(_Player)
AND
DB_UND_Nightsong_EnteredUnderdark(1)
AND
NOT QRY_CheckOtherPlayersInTrigger(NULL_00000000-0000-0000-0000-000000000000, S_UND_SharFortBox_3419cfbf-5ad0-473b-bfa6-f10cb1e4a415)
THEN
NOT DB_UND_Nightsong_EnteredUnderdark(1); //clear to allow reentering and getting it then

//Unlock this journal entry only if the player has one of these two steps previously unlocked
IF
EnteredTrigger(_Player, (TRIGGER)S_UND_SharTempleVista_77fb985c-36ee-47b6-8d5e-b2304613e13f)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "ReadJusticiarBook", 1)
THEN
QuestUpdate(_Player,"SHA_Nightsong", "ReachedGrymforge");
QuestSetCategory("SHA_Nightsong", "Shadowcurse");

IF
EnteredTrigger(_Player, (TRIGGER)S_UND_SharTempleVista_77fb985c-36ee-47b6-8d5e-b2304613e13f)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "HalsinToldSharTemple", 1)
THEN
QuestUpdate(_Player,"SHA_Nightsong", "ReachedGrymforge");
QuestSetCategory("SHA_Nightsong", "Shadowcurse");

//END_REGION

IF
WentOnStage((CHARACTER)_Adventurer, 0)
AND
DB_DEN_Adventurers(_Adventurer)
THEN
NOT DB_DEN_Adventurers(_Adventurer);

PROC
PROC_StateSet_PermaDefeated(_Adventurer)
AND
DB_DEN_Adventurers((CHARACTER)_Adventurer)
THEN
NOT DB_DEN_Adventurers((CHARACTER)_Adventurer);

IF
DB_GlobalFlag(DEN_RaidingParty_Quest_ConfrontationResolved_dc97da68-5ed9-ffe2-7582-2533be0efbcd)
AND
NOT DB_GlobalFlag((FLAG)DEN_RaidingParty_State_PeacefulResolution_f4529d52-b459-6545-b4bf-8b2fb2cd6f2f)
AND
NOT DB_DEN_Adventurers(_)
AND
NOT DB_PermaDefeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
AND
GetFlag(DEN_AdventurersQuest_Knows_AradinStory_31035679-797f-ae60-533f-17be40a174d3, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_DEN_AtCorpsesVBArea_0f297a62-e5e3-4970-b26f-2d33fcdf3029)
THEN
PROC_DEN_AdventurersQuest_AppearAtCorpses();

PROC
PROC_DEN_AdventurersQuest_AppearAtCorpses()
THEN
PROC_SetCorpseOwner(S_DEN_DeadAdventurer_004_482f39d8-b77e-443b-ab56-0e53b518c133, S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
PROC_SetCorpseOwner(S_DEN_DeadAdventurer_005_031970f5-60d6-44fe-aa68-4cf6406a377d, S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
PROC_SetCorpseOwner(S_DEN_DeadAdventurer_006_de3e1f50-ff58-4475-ab41-84995bc39a96, S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
PROC_TriggerRegisterForPlayers(S_DEN_AtCorpsesArea_76c8dd06-59d4-42e8-8540-147fe0b02291);
PROC_TriggerRegisterForPlayers(S_DEN_AtCorpseLeaveArea_d5f95907-d134-4ac1-ae66-dc5aabc62550);

PROC
PROC_DEN_AdventurersQuest_AppearAtCorpses()
AND
NOT DB_Defeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
THEN
DB_DEN_AdventurersQuest_AdventurersOnRoad(1);
PROC_RemoveOneShotVoiceBarkTrigger(S_DEN_AtCorpsesVBArea_0f297a62-e5e3-4970-b26f-2d33fcdf3029, DEN_AdventurersQuest_VB_AtCorpses_c1000ff3-dab9-c148-3b07-388f697f6ee2);

PROC
PROC_DEN_AdventurersQuest_AppearAtCorpses()
AND
NOT DB_Defeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
AND
NOT DB_PermaDefeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
AND
DB_DEN_AdventurersQuest_AdventurerOnRoad(_Adventurer, _Dialog, _Position)
AND
NOT DB_Defeated(_Adventurer)
THEN
PurgeOsirisQueue(_Adventurer, 0);
TeleportTo(_Adventurer, _Position, "");
SetOnStage(_Adventurer, 1);
PROC_RemoveDialog(_Adventurer);
LookFromTrigger(_Adventurer, _Position, 1);
DB_Dialogs(_Adventurer, _Dialog);

IF
DialogEnded(DEN_AdventurersQuest_LeaderAtCorpses_753a0b1e-b28d-e00a-f77f-340cca458dc0, _)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
PROC_DEN_AdventurersQuest_LeaveCorpses();

PROC
PROC_DEN_AdventurersQuest_LeaveCorpses()
THEN
NOT DB_DEN_AdventurersQuest_AdventurersOnRoad(1);

PROC
PROC_DEN_AdventurersQuest_LeaveCorpses()
AND
QRY_OnlyOnce("DEN_AdventurersQuest_LeaveCorpsesAD")
THEN
PROC_TryStartAD(DEN_AdventurersQuest_AD_LeavingCorpses_1810594b-3b36-7eee-4cb7-03afac0cb99b, S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);

IF
EntityEvent(_, "DEN_AdventurersQuest_LeftCorpses")
AND
NOT DB_GlobalFlag(DEN_AdventurersQuest_Event_LeftCorpses_28156d9f-a66d-4ec6-bc34-405a418635ff)
THEN
SetFlag(DEN_AdventurersQuest_Event_LeftCorpses_28156d9f-a66d-4ec6-bc34-405a418635ff, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
AutomatedDialogEnded(DEN_AdventurersQuest_AD_LeavingCorpses_1810594b-3b36-7eee-4cb7-03afac0cb99b, _)
THEN
PROC_NotifyWhenReadyToMoveOn(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,"RTMO_DEN_AdventurersQuest_LeftCorpses");

PROC
PROC_ReadyToMoveOn(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,"RTMO_DEN_AdventurersQuest_LeftCorpses")
THEN
PROC_DisappearOutOfSightTo(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, S_DEN_AdventurersCorpseLeave_7454b27d-d9a5-49ed-b76e-14faf7d068c1, "Run", 0, "DEN_AdventurersQuest_LeftCorpses");

PROC
PROC_DisappearOutOfSightTo(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, S_DEN_AdventurersCorpseLeave_7454b27d-d9a5-49ed-b76e-14faf7d068c1, "Run", 0, "DEN_AdventurersQuest_LeftCorpses")
AND
DB_DEN_AdventurersQuest_AdventurerOnRoad(_Adventurer, _Dialog, _Position)
AND
_Adventurer != S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c
THEN
PROC_ForceStopDialog(_Adventurer);
PROC_DisappearOutOfSightTo(_Adventurer, S_DEN_AdventurersCorpseLeave_7454b27d-d9a5-49ed-b76e-14faf7d068c1, "Run", 1, "DEN_AdventurersQuest_LeftCorpses");

IF
EntityEvent(_Adventurer, "DEN_AtDen_ReturnComplete")
AND
DB_DEN_AdventurersQuest_DenDialogs((CHARACTER)_Adventurer, _Dialog)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Adventurer);
DB_Dialogs(_Adventurer, _Dialog);

IF
EntityEvent(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, "DEN_AdventurersQuest_LeftCorpses")
THEN
PROC_ClearCorpseOwner(S_DEN_DeadAdventurer_004_482f39d8-b77e-443b-ab56-0e53b518c133);
PROC_ClearCorpseOwner(S_DEN_DeadAdventurer_005_031970f5-60d6-44fe-aa68-4cf6406a377d);
PROC_ClearCorpseOwner(S_DEN_DeadAdventurer_006_de3e1f50-ff58-4475-ab41-84995bc39a96);

IF
EnteredTrigger(_Player, S_DEN_AtCorpsesArea_76c8dd06-59d4-42e8-8540-147fe0b02291)
AND
DB_Players(_Player)
THEN
DB_DEN_AdvenutrersQuest_CheckLeaveCorpseArea(1);

IF
LeftTrigger(_Player, S_DEN_AtCorpseLeaveArea_d5f95907-d134-4ac1-ae66-dc5aabc62550)
AND
DB_Players(_Player)
AND
DB_DEN_AdvenutrersQuest_CheckLeaveCorpseArea(1)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_DEN_AtCorpseLeaveArea_d5f95907-d134-4ac1-ae66-dc5aabc62550)
THEN
PROC_NotifyWhenReadyToMoveOn(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,"RTMO_DEN_AdventurersQuest_LeftCorpses");

//REGION Contract

IF
FlagSet(DEN_AdventurersQuest_Event_GiveContract_5f57b6eb-65b0-b3ed-cf26-abb70fd44ff2, _Player, _)
THEN
ToInventory(S_DEN_AdventurerNote_a07e15dd-2a7d-4c65-a981-0e6510266168, _Player);


//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
