Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, DEN_CapturedGoblin_GuardsGrieve_1a4367a3-5c1a-e5cc-58ea-0e0745597d2a);
DB_Dialogs(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,DEN_CapturedGoblin_Caged_d2bf28d1-209b-154d-6fc8-98ceba56231f);
DB_Dialogs(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52,DEN_CapturedGoblin_Friend_0d1a1c4f-2b80-1fb5-1a7d-f7073e6ab025);

DB_GLO_CharacterCorpseDialog(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,DEN_CapturedGoblin_Dead_eaf24c8e-4b0e-cfc0-b913-dc35911c04cd);
DB_DialogBlockTradeButton(DEN_CapturedGoblin_GuardsGrieve_1a4367a3-5c1a-e5cc-58ea-0e0745597d2a);
DB_DialogBlockTradeButton(DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9);
DB_DoNotFace(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);

PROC_TriggerRegisterForParty(S_DEN_GrieflingGoblitterateSphere_fde02590-d754-4efc-ab60-8ac44205f94a);
PROC_TriggerRegisterForPlayers(S_DEN_GriefSphere_451f6ff2-2c58-4a6e-8077-ef1347019919);
PROC_TriggerRegisterForPlayers(S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a);

TriggerRegisterForCharacter(S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
TriggerRegisterForCharacter(S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a,S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52);
TriggerRegisterForCharacter(S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

TriggerRegisterForCharacter(S_DEN_MidAvengePoint_001_b6a8ac6f-92d6-4641-9b1f-d43736ba656a,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
TriggerRegisterForCharacter(S_DEN_GoblinCageBox_8a92511e-1ff0-4c89-af3a-02600e6087c6,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

DB_State_Current(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_PreGateAttack");
DB_State_Priority(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_PreGateAttack", 1000);
DB_State_Priority(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Grieve", 2000);
DB_State_Priority(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Transit", 3000);
DB_State_Priority(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge", 4000);
DB_State_Priority(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Resolution", 5000);
DB_State_Priority(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_LeftDEN", 6000);
DB_State_Priority(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Permadefeated", 7000);

DB_DEN_CapturedGoblin_EscapeDenTriggers((TRIGGER)S_DEN_GateOpenArea_de98af21-31c2-4560-a3bf-4956d8ca0618);
DB_DEN_CapturedGoblin_EscapeDenTriggers((TRIGGER)S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211);
DB_DEN_CapturedGoblin_EscapeDenTriggers((TRIGGER)S_DEN_Hideout_SUB_8016de65-4be3-4083-960f-4d14a7455d4b);
DB_DEN_CapturedGoblin_EscapeDenTriggers((TRIGGER)S_DEN_Tunnel_SUB_6d2ed20e-f315-463a-9783-d02b173cb35a); 
DB_DEN_CapturedGoblin_EscapeDenTriggers((TRIGGER)S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29);
DB_DEN_CapturedGoblin_EscapeDenTriggers((TRIGGER)S_DEN_DruidVault_SUB_f4c22466-5963-4192-b939-f1056f4f806a);
DB_DEN_CapturedGoblin_EscapeDenTriggers((TRIGGER)S_DEN_TieflingLeader_SUB_f667e6fe-2b30-4509-9bba-7918bb71a2a7);

DB_DEN_CapturedGoblin_Dialog((DIALOGRESOURCE)DEN_CapturedGoblin_GuardsGrieve_1a4367a3-5c1a-e5cc-58ea-0e0745597d2a);
DB_DEN_CapturedGoblin_Dialog(DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9);
DB_DEN_CapturedGoblin_Dialog(DEN_CapturedGoblin_GuardsIdle_30faee78-a303-77eb-f936-6f0b4b4f0a46);

DB_DEN_CapturedGoblin_GrieflingsAndGoblin(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
DB_DEN_CapturedGoblin_GrieflingsAndGoblin(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52);
DB_DEN_CapturedGoblin_GrieflingsAndGoblin(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);

DB_DEN_CapturedGoblin_NPC(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
DB_DEN_CapturedGoblin_NPC(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52);

SetCanJoinCombat(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,0);
PROC_SetCorpseOwner(S_DEN_DeadLover_0126a6b5-3452-47db-a3e5-525b7deca82f,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);

DB_PermaDefeatedFlag(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,DEN_CapturedGoblin_State_GrieflingPermaDefeated_6da41bce-907e-413d-d429-b6509d8914e8);
DB_PermaDefeatedFlag(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52,DEN_CapturedGoblin_State_FriendPermaDefeated_b8c7b150-7c57-81d5-d452-a40237a90648);

//For setting DEN_CapturedGoblin_State_Resolved_df392d3d-95e0-7009-2942-d0418a3e344b
DB_DEN_CapturedGoblin_ResolvedFlags((FLAG)DEN_CapturedGoblin_Event_Foiled_99ff0e4d-0ce5-7164-4d81-b00edd7906a8);
DB_DEN_CapturedGoblin_ResolvedFlags(DEN_CapturedGoblin_Event_GoblinShot_1ccc6b3f-7255-de5f-75ee-296962b85e5c);
DB_DEN_CapturedGoblin_ResolvedFlags(DEN_CapturedGoblin_State_PlayerRescuedGoblin_2030e459-3a80-1172-8bbd-1d90395deace);

DB_DEN_CapturedGoblin_GrieflingLeaveFlags((FLAG)DEN_CapturedGoblin_Event_Foiled_99ff0e4d-0ce5-7164-4d81-b00edd7906a8);
DB_DEN_CapturedGoblin_GrieflingLeaveFlags(DEN_CapturedGoblin_Event_GoblinShot_1ccc6b3f-7255-de5f-75ee-296962b85e5c);
DB_DEN_CapturedGoblin_GrieflingLeaveFlags(DEN_CapturedGoblin_State_FriendPermaDefeated_b8c7b150-7c57-81d5-d452-a40237a90648);

DB_GlobalFlagReactionAfterDialog(DEN_CapturedGoblin_Event_GuardCombat_e19c82e5-5463-fe2a-5511-fb5d08a93899, DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9);
// Sazza doesn't care about players escaping the Tiefling's prison
PROC_CharacterDisableCrime(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,"WLD_DEN_PrisonEscape_AD");

DB_DEN_CapturedGoblin_GrieflingScenes("DEN_CapturedGoblin_GrieflingGrieve");
DB_DEN_CapturedGoblin_GrieflingScenes("DEN_CapturedGoblin_GrieflingAvenge");
KBSECTION
//REGION Quest
IF
DB_Sees(_Char,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_Players(_Char)
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e)
AND
QuestIsAccepted(_Char,"DEN_CapturedGoblin",1)
THEN
QuestUpdate(_Char,"DEN_CapturedGoblin","Released");

PROC
PROC_State_Changed(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_Lockdown")
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
AND
DB_QuestIsAccepted("DEN_CapturedGoblin")
THEN
QuestUpdate("DEN_CapturedGoblin", "NotReleased");

IF
FlagSet(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df,_,_)
AND
DB_Players(_Char)
AND
QuestIsAccepted(_Char,"DEN_CapturedGoblin",1)
THEN
QuestUpdate(_Char,"DEN_CapturedGoblin","Escaped");

PROC
PROC_GOB_Checkpoint_StartThreewayDialogWithCapturedGoblin((CHARACTER)_Char)
THEN
QuestUpdate(_Char,"DEN_CapturedGoblin","FoundCheckpoint");

IF
DialogStarted(GOB_DrowAndCaptured_ThreeWayDialog_46a73870-54c1-902c-fc27-c967c2093ac5,_Inst)
AND
DB_DialogPlayers(_Inst,_Player,1)
THEN
QuestUpdate((CHARACTER)_Player,"DEN_CapturedGoblin","FoundNearDrow");
/*
IF
EnteredTrigger(_Char,_Trigger)
AND
DB_GOB_Checkpoint_CampEntranceTriggers(_Trigger)
AND
DB_Players(_Char)
AND
QuestUpdateIsUnlocked(_Char,"DEN_CapturedGoblin","Escaped",1)
THEN
QuestUpdate(_Char,"DEN_CapturedGoblin","EnteredGoblins");
*/
//Dead
IF
DB_Sees(_Char,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_Players(_Char)
AND
QuestIsAccepted(_Char,"DEN_CapturedGoblin",1)
AND
QuestIsClosed("DEN_CapturedGoblin",0)
AND
NOT QRY_DEN_CapturedGoblin_DiedInPit()
THEN
PROC_DEN_CapturedGoblin_UpdateDead(_Char);

QRY
QRY_DEN_CapturedGoblin_DiedInPit()
AND
DB_GlobalFlag((FLAG)GOB_CapturedGoblin_State_Executed_5505345c-482d-cfc5-3a2b-987611beb4e3)
AND
DB_InRegion(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, S_GOB_SpiderNest_ThePit_0f3188b4-5cfe-4353-8bf0-d528cda0a446)
THEN
DB_NOOP(1);

PROC
PROC_DEN_CapturedGoblin_UpdateDead((CHARACTER)_Char)
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df)
AND
QuestIsClosed("DEN_CapturedGoblin",0)
THEN
QuestUpdate(_Char,"DEN_CapturedGoblin","DiedEscape");

PROC
PROC_DEN_CapturedGoblin_UpdateDead((CHARACTER)_Char)
AND
QuestIsClosed("DEN_CapturedGoblin",0)
AND
QuestUpdateIsUnlocked(_Char,"DEN_CapturedGoblin","MetGoblin",0)
THEN
QuestClose("DEN_CapturedGoblin");

PROC
PROC_DEN_CapturedGoblin_UpdateDead((CHARACTER)_Char)
AND
QuestIsClosed("DEN_CapturedGoblin",0)
THEN
QuestUpdate(_Char,"DEN_CapturedGoblin","GoblinDead");

//Left Act1
PROC
PROC_LevelUnloading("WLD_Main_A")
AND
DB_Players(_Char)
AND
QuestIsAccepted(_Char,"DEN_CapturedGoblin",1)
AND
QuestIsClosed("DEN_CapturedGoblin",0)
THEN
PROC_DEN_CapturedGoblin_UpdateLeft(_Char);

PROC
PROC_DEN_CapturedGoblin_UpdateLeft((CHARACTER)_Char)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df)
AND
QuestIsClosed("DEN_CapturedGoblin",0)
THEN
QuestUpdate(_Char,"DEN_CapturedGoblin","NotReleased");

PROC
PROC_DEN_CapturedGoblin_UpdateLeft((CHARACTER)_Char)
AND
QuestUpdateIsUnlocked(_Char,"DEN_CapturedGoblin","FoundCheckpoint",0)
AND
QuestUpdateIsUnlocked(_Char,"DEN_CapturedGoblin","EnteredGoblins",0)
AND
QuestIsClosed("DEN_CapturedGoblin",0)
THEN
QuestUpdate(_Char,"DEN_CapturedGoblin","NotFoundCheckpoint");

PROC
PROC_DEN_CapturedGoblin_UpdateLeft((CHARACTER)_Char)
AND
QuestIsClosed("DEN_CapturedGoblin",0)
AND
QuestUpdateIsUnlocked(_Char,"DEN_CapturedGoblin","Rewarded",0)
THEN
QuestUpdate(_Char,"DEN_CapturedGoblin","NotRewarded");
//END_REGION

//REGION Goblin
PROC
PROC_DEN_CapturedGoblin_GoblinReleased()
AND
DB_DEN_CapturedGoblin_EscapeDenTriggers(_Trigger)
THEN
TriggerRegisterForCharacter(_Trigger, S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

IF
LeftTrigger(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, _Trigger)
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e)
AND
DB_DEN_CapturedGoblin_EscapeDenTriggers(_Trigger)
AND
NOT QRY_DEN_CapturedGoblin_IsInDen()
AND
NOT DB_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
THEN
SetFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3);
PROC_DEN_CapturedGoblin_LeftDen();

QRY
QRY_DEN_CapturedGoblin_IsInDen()
AND
DB_DEN_CapturedGoblin_EscapeDenTriggers(_Trigger)
AND
IsInTrigger(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, _Trigger, 1)
THEN
DB_NOOP(1);

PROC
PROC_StateSet_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_DEN_CapturedGoblin_Follow(_Own,_)
THEN
ClearFlag(DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25,_Own);

PROC
PROC_DEN_CapturedGoblin_LeftDen()
AND
DB_DEN_CapturedGoblin_Follow(_Own,_)
THEN
ClearFlag(DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25,_Own);

PROC
PROC_DEN_CapturedGoblin_LeftDen()
AND
DB_DEN_CapturedGoblin_Follow(_Player,_)
AND
NOT DB_Is_Wildshaped(_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
QRY_StartDialog_Fixed(DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Player)
THEN
DB_OnlyOnce("DEN_CapturedGoblin_LeftDenThank");

PROC
PROC_DEN_CapturedGoblin_LeftDen()
AND
DB_Players(_Player)
AND
NOT DB_DEN_CapturedGoblin_Follow(_Player,_)
AND
NOT DB_Is_Wildshaped(_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
NOT DB_OnlyOnce("DEN_CapturedGoblin_LeftDenThank")
AND
QRY_StartDialog_Fixed(DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Player)
THEN
DB_OnlyOnce("DEN_CapturedGoblin_LeftDenThank");

PROC
PROC_DEN_CapturedGoblin_LeftDen()
AND
NOT DB_OnlyOnce("DEN_CapturedGoblin_LeftDenThank")
THEN
PROC_TryStartAD(DEN_CapturedGoblin_AD_b1b82bdf-7608-d578-e71d-80e1ae6e0924,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

PROC
PROC_DEN_CapturedGoblin_LeftDen()
AND
DB_DEN_NPC((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_,_)
THEN
PROC_DEN_RemoveFromDenNPCs((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

//Make her go away
IF
AutomatedDialogEnded(DEN_CapturedGoblin_AD_b1b82bdf-7608-d578-e71d-80e1ae6e0924, _)
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df)
THEN
SetFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df);

IF
AutomatedDialogRequestFailed(DEN_CapturedGoblin_AD_b1b82bdf-7608-d578-e71d-80e1ae6e0924,_)
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df)
THEN
SetFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df);

IF
DialogEnded(DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264, _)
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df)
THEN
SetFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df);

IF
AttackedBy(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, _, _, _, _, _, _)
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df)
THEN
SetFlag(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df);

IF
FlagSet(DEN_CapturedGoblin_Event_GoblinEscaped_cbb09299-e736-437b-d93b-5f18f1a9f9df, _, _)
THEN
PROC_NotifyWhenReadyToMoveOn(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,"DEN_CapturedGoblin_ReadyToEscape");

PROC
PROC_ReadyToMoveOn(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,"DEN_CapturedGoblin_ReadyToEscape")
THEN
SetHasDialog(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,0);
PROC_DisappearOutOfSightTo(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,S_DEN_GoblinFleePoint_f96a501e-210c-4fc0-9d2f-1e6311872e25,"Run",0,"DEN_CapturedGoblin_GoblinEscaped");
ClearFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

IF
FlagSet(DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25,_,_)
AND
DB_DEN_CapturedGoblin_Follow(_Char,_)
THEN
ClearFlag(DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25,_Char);

IF
FlagSet(DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25,(CHARACTER)_Char,_ID)
THEN
DB_DEN_CapturedGoblin_Follow(_Char,_ID);

IF
FlagCleared(DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25,(CHARACTER)_Char,_)
AND
DB_DEN_CapturedGoblin_Follow(_Char,_ID)
THEN
NOT DB_DEN_CapturedGoblin_Follow(_Char,_ID);
PROC_DEN_CapturedGoblin_TryRemovePartyFollower(_Char);

PROC
PROC_DEN_CapturedGoblin_TryRemovePartyFollower((CHARACTER)_Char)
AND
CharacterGetOwner(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, _Char)
THEN
PROC_RemovePartyFollower(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

PROC
PROC_GLO_PostReassignFollowerHook(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, (CHARACTER)_OldLeader, (CHARACTER)_NewLeader)
THEN
SetFlag((FLAG)DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25, _NewLeader);
SetFlag((FLAG)DEN_CapturedGoblin_PromisedHelp_9c842df8-4d01-9ac6-52c3-2300fa5a1362, _NewLeader);
SetFlag((FLAG)DEN_CapturedGoblin_HasMet_2bfbef89-969b-3334-034d-c7e2ba377ed7, _NewLeader); // Set HasMet to prevent weird dialog options

IF
LeftLevel(_Char,"WLD_Main_A")
AND
GetFlag(DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25,_Char,1)
THEN
ClearFlag(DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25,_Char);

QRY
QRY_REALLY_BlockFastTravel(NULL_00000000-0000-0000-0000-000000000000)
AND
DB_DEN_CapturedGoblin_Follow(_Own,_)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Range_1e967693-8ef9-13c6-4238-12448dc965fd)
AND
QRY_DEN_CapturedGoblin_WaypointDialog(_Own)
THEN
DB_NOOP(1);

QRY
QRY_REALLY_BlockFastTravel(_Char)
AND
_Char != NULL_00000000-0000-0000-0000-000000000000
AND
DB_DEN_CapturedGoblin_Follow(_Own,_)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Range_1e967693-8ef9-13c6-4238-12448dc965fd)
AND
InSamePartyGroup(_Own,_Char,1)
AND
QRY_DEN_CapturedGoblin_WaypointDialog(_Own)
THEN
DB_NOOP(1);

QRY
QRY_DEN_CapturedGoblin_WaypointDialog((CHARACTER)_Char)
AND
NOT DB_Is_Wildshaped(_Char)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Char)
AND
QRY_StartDialog_Fixed(DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Char)
THEN
SetFlag(DEN_CapturedGoblin_Event_Waypoint_bfdebd10-f49f-42c8-9a37-7df72bf55bc8,NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_DEN_CapturedGoblin_WaypointDialog((CHARACTER)_Char)
AND
GetFlag(DEN_CapturedGoblin_Event_Waypoint_bfdebd10-f49f-42c8-9a37-7df72bf55bc8,NULL_00000000-0000-0000-0000-000000000000,0)
AND
NOT QRY_SetConditionalGlobalFlag(DEN_CapturedGoblin_Range_1e967693-8ef9-13c6-4238-12448dc965fd,1)
THEN
DB_NOOP(1);

IF
DialogEnded(_Dialog,_ID)
AND
DB_DEN_CapturedGoblin_Follow(_Char,_ID)
THEN
AddPartyFollower(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Char);

PROC
PROC_BlockUseOfItem(_Player, (ITEM)S_DEN_GoblinCageDoor_208e7554-1199-4737-b107-b3c1ccddd588)
AND
IsLocked((ITEM)S_DEN_GoblinCageDoor_208e7554-1199-4737-b107-b3c1ccddd588, 0)
THEN
Open(S_DEN_GoblinCageDoor_208e7554-1199-4737-b107-b3c1ccddd588);
DB_CustomUseItemResponse(_Player, S_DEN_GoblinCageDoor_208e7554-1199-4737-b107-b3c1ccddd588, 0);

IF
Opened(S_DEN_GoblinCageDoor_208e7554-1199-4737-b107-b3c1ccddd588)
THEN
SetFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e,NULL_00000000-0000-0000-0000-000000000000,0);

IF
DestroyedBy(S_DEN_GoblinCageDoor_208e7554-1199-4737-b107-b3c1ccddd588,_Player,_,_)
THEN
SetFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e,NULL_00000000-0000-0000-0000-000000000000,0);

IF
LeftTrigger(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,S_DEN_GoblinCageBox_8a92511e-1ff0-4c89-af3a-02600e6087c6)
THEN
SetFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e,NULL_00000000-0000-0000-0000-000000000000,0);

IF
FlagSet(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e,_,_)
THEN
PROC_DEN_CapturedGoblin_GoblinReleased();

PROC
PROC_DEN_CapturedGoblin_GoblinReleased()
THEN
SetCanJoinCombat(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,1);
SetFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
PROC_SetRelationToPlayers((FACTION)ACT1_DEN_CapturedGoblin_40d6a49e-806c-4bce-8214-6228cc0ded72,50);
DB_CRIME_Guards_NoSummonBy(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
PROC_RemoveAllDialogEntriesForSpeaker(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
DB_Dialogs(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264);


IF
EntityEvent(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,"DEN_CapturedGoblin_Event_LeftCage")
AND
QRY_OnlyOnce("DEN_CapturedGoblin_LeftCageMove")
THEN
DB_OnlyOnce("DEN_CapturedGoblin_AfterCage");

IF
DialogStarted(DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264,_)
THEN
NOT DB_OnlyOnce("DEN_CapturedGoblin_AfterCage");

IF
DB_OnlyOnce("DEN_CapturedGoblin_AfterCage")
AND
DB_InRegion(_Char,S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
DB_Players(_Char)
AND
NOT DB_HiddenCharacters(_Char,_)
AND
NOT DB_IsArrested(_,_Char)
AND
NOT DB_CantTalk(_Char)
AND
NOT DB_Is_Wildshaped(_Char)
AND
NOT DB_CantTalk(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_OnlyOnce("DEN_CapturedGoblin_AfterCage")
AND
QRY_StartDialog(DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Char)
THEN
NOT DB_OnlyOnce("DEN_CapturedGoblin_AfterCage");

// We are closing her quest when entering SCL, since she's in the unclear state if left in WLD.
PROC
PROC_LevelUnloading("WLD_Main_A")
AND
NOT DB_GlobalFlag(GOB_CapturedGoblin_State_Spared_28a0e5c2-ee4a-3b33-a7cc-467adb5bdb88)
THEN
PROC_SetOnStage(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, 0);
//END_REGION

//REGION Dialogues
PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Transit")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
DB_Dialogs(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, DEN_CapturedGoblin_Transit_ef8ecc8d-e11a-9640-c19e-baa9024c235c);

PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
DB_Dialogs(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9);

PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Resolution")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
DB_Dialogs(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, DEN_CapturedGoblin_GuardsIdle_30faee78-a303-77eb-f936-6f0b4b4f0a46);

IF
FlagSet(DEN_CapturedGoblin_HasMet_2bfbef89-969b-3334-034d-c7e2ba377ed7,_Char,_)
THEN
SetFlag(DEN_CapturedGoblin_State_UserMet_974ef894-b00c-dcac-ee6d-f7fc43bfad2e,_Char);

IF
EnteredTrigger(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
DB_InRegion(_Char,S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
DB_Players(_Char)
THEN
SetFlag(DEN_CapturedGoblin_State_EnteredFirst_0607e870-f42c-0a9b-80ae-03caaf750259,_Char);

IF
LeftTrigger(_Char,S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
GetFlag(DEN_CapturedGoblin_State_EnteredFirst_0607e870-f42c-0a9b-80ae-03caaf750259,_Char,1)
THEN
ClearFlag(DEN_CapturedGoblin_State_EnteredFirst_0607e870-f42c-0a9b-80ae-03caaf750259,_Char);

//Because the speaker grouping is pain
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)_Dialog,(INTEGER)_ID)
AND
DB_DEN_CapturedGoblin_Dialog(_Dialog)
AND
DB_DialogPlayers(_ID, _Player, _)
THEN
DialogAddActorAtReservedSlot(_ID, _Player, 1, 0, 1);

//Block dialog if speaking player is in prison
QRY
QRY_SelectCustomDialog(_Char ,_Player)
AND
QRY_CapturedGoblin_PlayerIsInPrison((CHARACTER)_Char,(CHARACTER)_Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)GEB_AD_CantTalkNow_ae991ba1-8a2e-9cc7-b4c2-379af7f058c5,_Char,_Player);

//Clicking on Friend while Griedling is nearby will start Griefling dialog
QRY
QRY_SelectCustomDialog(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52,_Player)
AND
NOT QRY_CapturedGoblin_PlayerIsInPrison((CHARACTER)S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52,(CHARACTER)_Player)
AND
DB_DEN_CapturedGoblin_NPC(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,_Player)
AND
DB_Dialogs(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, _Dialog)
AND
DB_DEN_CapturedGoblin_Dialog(_Dialog)
THEN
SetFlag(DEN_CapturedGoblin_Event_FriendStarted_129cd28e-5481-27dd-43bb-53d0d67fbc64);
SetFlag(DEN_CapturedGoblin_FriendHasMet_79e7f911-c30a-287a-6788-7080fda41346,_Player);
PROC_CapturedGoblin_SelectGrieflingDialog((CHARACTER)_Player);

QRY
QRY_SelectCustomDialog(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,_Player)
AND
NOT QRY_CapturedGoblin_PlayerIsInPrison((CHARACTER)S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,(CHARACTER)_Player)
THEN
PROC_CapturedGoblin_SelectGrieflingDialog((CHARACTER)_Player);

PROC
PROC_CapturedGoblin_SelectGrieflingDialog((CHARACTER)_Player)
AND
DB_Dialogs(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, _Dialog)
AND
NOT DB_DEN_CapturedGoblin_Dialog(_Dialog)
THEN
DB_SelectedDialog(_Dialog,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, _Player);

PROC
PROC_CapturedGoblin_SelectGrieflingDialog((CHARACTER)_Player)
AND
DB_Dialogs(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, _Dialog)
AND
DB_DEN_CapturedGoblin_Dialog(_Dialog)
AND
_Dialog != DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9
THEN
DB_SelectedDialog(_Dialog,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, NULL_00000000-0000-0000-0000-000000000000, _Player);

PROC
PROC_CapturedGoblin_SelectGrieflingDialog((CHARACTER)_Player)
AND
DB_Dialogs(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9)
THEN
DB_SelectedDialog(DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Player);

QRY
QRY_CapturedGoblin_PlayerIsInPrison((CHARACTER)_Char,(CHARACTER)_Player)
AND
DB_DEN_CapturedGoblin_GrieflingsAndGoblin(_Char)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_State_IsBeforeState(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Resolution")
AND
GetFlag(IsInPrison_c9b75b21-6eba-065e-7680-fc9a0c5838e4, _Player, 1)
THEN
DB_NOOP(1);

IF
DialogEnded(_Dialog,_)
AND
DB_DEN_CapturedGoblin_Dialog(_Dialog)
AND
DB_GlobalFlag(DEN_CapturedGoblin_Event_FriendStarted_129cd28e-5481-27dd-43bb-53d0d67fbc64)
THEN
ClearFlag(DEN_CapturedGoblin_Event_FriendStarted_129cd28e-5481-27dd-43bb-53d0d67fbc64);

IF
FlagSet(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3,_,_)
AND
GetClosestAlivePlayer(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Char, 20.0)
THEN
StartVoiceBark(DEN_CapturedGoblin_VB_Freed_07678a76-7d55-49a9-f4fb-1037b42ca76a, _Char);

IF
FlagSet(DEN_CapturedGoblin_Knows_Priestess_2ac20f1d-b8a0-4f06-a1e6-50e428a3b487,_,_)
AND
GetClosestAlivePlayer(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Char, 20.0)
THEN
StartVoiceBark(DEN_CapturedGoblin_VB_Healer_486ae68f-03a3-923e-2376-d33621108cf0, _Char);

IF
FlagSet(DEN_CapturedGoblin_State_PlayerWatchedGoblinExecution_cccd8084-dc8f-88c2-c145-482c34ab094f,_,_)
AND
GetClosestAlivePlayer(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Char, 20.0)
THEN
StartVoiceBark(DEN_CapturedGoblin_VB_Shot_321d9d77-6a0f-18cd-5061-53ffd6664240, _Char);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9,(INTEGER)_ID)
AND
DB_DEN_CapturedGoblin_NPC(_Actor)
AND
DB_InRegion(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
DB_InRegion((CHARACTER)_Actor, S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
QRY_SpeakerIsAvailable(_Actor)
THEN
PROC_DialogAddSpeakingActor(_ID,_Actor);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)_CapturedGoblinDialog,(INTEGER)_ID)
AND
DB_DEN_CapturedGoblin_Dialog(_CapturedGoblinDialog)
AND
DB_DEN_CapturedGoblin_NPC(_Actor)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Actor,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8)
THEN
PROC_DialogAddSpeakingActor(_ID,_Actor);

IF
UseFinished(_Char,S_DEN_GoblinCageDoor_208e7554-1199-4737-b107-b3c1ccddd588,0)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e)
AND
DB_Players(_Char)
AND
NOT DB_HiddenCharacters(_Char,_)
AND
NOT DB_Is_Wildshaped(_Char)
AND
IsLocked(S_DEN_GoblinCageDoor_208e7554-1199-4737-b107-b3c1ccddd588,1)
AND
QRY_SelectAndStartDialog(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Char)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_Tamper_270e7bc6-aa68-f106-73af-21184b8f7f68)
THEN
SetFlag(DEN_CapturedGoblin_Event_Tamper_270e7bc6-aa68-f106-73af-21184b8f7f68,NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION Griefling
IF
FlagSet(DEN_CapturedGoblin_State_Grieve_93f4f48a-6edd-93a1-2704-b13691df0bb4, _, _)
THEN
PROC_State_Progress(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Grieve");

IF
FlagSet(DEN_CapturedGoblin_State_InTransit_94643524-4461-c684-049c-b38cc2f5670a, _, _)
THEN
PROC_State_Progress(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Transit");

IF
FlagSet(DEN_CapturedGoblin_State_Avenge_0b50db9b-3055-a749-a58b-472d904faa72, _, _)
THEN
ClearFlag(DEN_CapturedGoblin_State_InTransit_94643524-4461-c684-049c-b38cc2f5670a);
PROC_State_Progress(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge");

IF
FlagSet(DEN_CapturedGoblin_State_Resolved_df392d3d-95e0-7009-2942-d0418a3e344b, _, _)
THEN
PROC_State_Progress(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Resolution");

IF
FlagSet(DEN_CapturedGoblin_Event_GuardsLeft_b79734e0-8efc-228f-9a44-50641da7c55a, _, _)
THEN
PROC_State_Progress(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_LeftDEN");

PROC
PROC_StateSet_PermaDefeated(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8)
THEN
PROC_State_Progress(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Permadefeated");

IF
LeftTrigger(_Player,S_DEN_General_KanonCorpseScene_aa74c57d-1fa3-4dec-993b-37c6c135c2f4)
AND
DB_GlobalFlag(DEN_General_State_Entered_26b2dc6a-e5eb-4d99-a4bd-3ecaa3b86a9e)
AND
QRY_State_IsBeforeState(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Transit")
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_LeftToGrief_7aa6f9bf-c2c1-fb1b-41de-3903c6b861ec)
THEN
SetFlag(DEN_CapturedGoblin_Event_LeftToGrief_7aa6f9bf-c2c1-fb1b-41de-3903c6b861ec,NULL_00000000-0000-0000-0000-000000000000,0);

PROC
PROC_DEN_TryAddGrave(S_DEN_DeadLover_0126a6b5-3452-47db-a3e5-525b7deca82f)
AND
QRY_State_IsBeforeState(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Transit")
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_LeftToGrief_7aa6f9bf-c2c1-fb1b-41de-3903c6b861ec)
THEN
SetFlag(DEN_CapturedGoblin_Event_LeftToGrief_7aa6f9bf-c2c1-fb1b-41de-3903c6b861ec,NULL_00000000-0000-0000-0000-000000000000,0);

IF
FlagSet(DEN_CapturedGoblin_Event_LeftToGrief_7aa6f9bf-c2c1-fb1b-41de-3903c6b861ec,_,_)
THEN
TimerLaunch("DEN_CapturedGoblin_LeftToGrief",18000);

IF
DB_GlobalFlag(DEN_CapturedGoblin_Event_LeftToGrief_7aa6f9bf-c2c1-fb1b-41de-3903c6b861ec)
AND
NOT DB_InRegion(_,S_DEN_General_KanonCorpseScene_aa74c57d-1fa3-4dec-993b-37c6c135c2f4)
AND
QRY_State_IsBeforeState(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge")
AND
QRY_DEN_CheckPeaceState()
THEN
SetFlag(DEN_CapturedGoblin_State_InTransit_94643524-4461-c684-049c-b38cc2f5670a,NULL_00000000-0000-0000-0000-000000000000);
TeleportTo(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,S_DEN_GrieflingMidPoint_010cd3ee-dc17-4030-b3ce-339516aba443);
TeleportTo(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52,S_DEN_MidFriendPoint_eb3c8062-4763-4f05-8838-aa8701645477);

IF
TimerFinished("DEN_CapturedGoblin_LeftToGrief")
AND
DB_State_Current(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Grieve")
AND
QRY_DEN_CheckPeaceState()
THEN
SetFlag(DEN_CapturedGoblin_State_InTransit_94643524-4461-c684-049c-b38cc2f5670a,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Transit")
AND
NOT DB_Defeated(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52)
THEN
PROC_Follow(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52, S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
//So he follows the griefling, even when outside activation range

PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", _State)
AND
NOT QRY_State_IsBeforeState(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge")
THEN
PROC_StopFollow(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52);

PROC
PROC_StateSet_Defeated(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8)
THEN
PROC_StopFollow(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52);

PROC
PROC_StateSet_Defeated(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52)
THEN
PROC_StopFollow(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52);

IF
EnteredTrigger(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,S_DEN_MidAvengePoint_001_b6a8ac6f-92d6-4641-9b1f-d43736ba656a)
AND
DB_State_Current(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge")
THEN
DialogRequestStopForDialog(DEN_CapturedGoblin_AD_Guards_cfa86226-091b-06e1-dbeb-61af5caacc53,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
PROC_TryStartAD(DEN_CapturedGoblin_AD_Guards_cfa86226-091b-06e1-dbeb-61af5caacc53,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);

//Also set from anubis, as a fallback in case something goofy happens
IF
EnteredTrigger(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_Avenge_0b50db9b-3055-a749-a58b-472d904faa72) 
THEN
SetFlag(DEN_CapturedGoblin_State_Avenge_0b50db9b-3055-a749-a58b-472d904faa72);

//When she finishes her AD she shoots the goblin, so wait for the player so they have a chance to intervene
IF
DB_InRegion(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
DB_Players(_Char)
AND
DB_InRegion(_Char,S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_AvengeReady_236cb4d5-3df3-44f9-98ae-f7bac01b667a)
THEN
SetFlag(DEN_CapturedGoblin_State_AvengeReady_236cb4d5-3df3-44f9-98ae-f7bac01b667a);

//So she will attack the goblin on sight once released for the case she enters the prison area and the goblin is free
IF
FlagSet(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e, _, _)
THEN
PROC_SetRelationMutual((FACTION)ACT1_DEN_Griefling_b30628c0-87aa-aa8a-4bc6-84740eb6ef92,(FACTION)ACT1_DEN_CapturedGoblin_40d6a49e-806c-4bce-8214-6228cc0ded72,0);

IF
FlagSet(DEN_CapturedGoblin_State_AvengeReady_236cb4d5-3df3-44f9-98ae-f7bac01b667a, _, _)
AND
NOT DB_OnlyOnce("DEN_CapturedGoblin_GuardsDialog_Interrupt")
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e)
THEN
DB_SpotPlayers(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_GrieflingAvengeSpotter", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_GrieflingAvengeSpotter", S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a);

PROC
PROC_InternSpotPlayers_Spotted(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_GrieflingAvengeSpotter", _Player)
AND
NOT QRY_DEN_CapturedGoblin_PrisonEscapedOrEscapingPlayer((CHARACTER)_Player)
AND
NOT DB_OnlyOnce("DEN_CapturedGoblin_GuardsDialog")
THEN
PROC_DEN_CapturedGoblin_TryAvenge((CHARACTER)_Player);

PROC
PROC_InternSpotPlayers_Spotted(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_GrieflingAvengeSpotter", _Player)
AND
QRY_DEN_CapturedGoblin_PrisonEscapedOrEscapingPlayer((CHARACTER)_Player)
THEN
PROC_DEN_CapturedGoblin_PrisonEscapeeReact((CHARACTER)_Player);

PROC
PROC_DEN_CapturedGoblin_PrisonEscapeeReact((CHARACTER)_Player)
THEN
PROC_ForceStopDialog(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
PROC_SetRelationMutual((FACTION)ACT1_DEN_Griefling_b30628c0-87aa-aa8a-4bc6-84740eb6ef92,(FACTION)ACT1_DEN_CapturedGoblin_40d6a49e-806c-4bce-8214-6228cc0ded72,0);
SetFlag(DEN_CapturedGoblin_Event_GuardCombat_e19c82e5-5463-fe2a-5511-fb5d08a93899);
PROC_SetRelationTemporaryHostile((CHARACTER)S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,(CHARACTER)_Player);
PROC_DEN_CapturedGoblin_EndScene("DEN_CapturedGoblin_GrieflingAvenge");

//Spotting does not always fire if the player is already by the goblin, use the in trigger as a fallback
IF
DB_InRegion(_Player, S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
DB_Players(_Player)
AND
DB_State_Current(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge")
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_AvengeReady_236cb4d5-3df3-44f9-98ae-f7bac01b667a)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e)
AND
NOT QRY_DEN_CapturedGoblin_PrisonEscapedOrEscapingPlayer((CHARACTER)_Player)
THEN
PROC_DEN_CapturedGoblin_TryAvenge((CHARACTER)_Player);

IF
DB_InRegion(_Player, S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
DB_Players(_Player)
AND
DB_State_Current(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge")
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_AvengeReady_236cb4d5-3df3-44f9-98ae-f7bac01b667a)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e)
AND
QRY_DEN_CapturedGoblin_PrisonEscapedOrEscapingPlayer((CHARACTER)_Player)
THEN
PROC_DEN_CapturedGoblin_PrisonEscapeeReact((CHARACTER)_Player);

//If the player uses something like misty step into the scene, the apply status is too slow
QRY
QRY_DEN_CapturedGoblin_PrisonEscapedOrEscapingPlayer((CHARACTER)_Player)
AND
HasActiveStatus(_Player, "GB_FUGITIVE_DEN", 1)
THEN
DB_NOOP(1);

QRY
QRY_DEN_CapturedGoblin_PrisonEscapedOrEscapingPlayer((CHARACTER)_Player)
AND
DB_PlayerEscapedPrison(_Player,_,_,_,_,_,_,_,"GB_FUGITIVE_DEN")
THEN
DB_NOOP(1);

PROC
PROC_DEN_CapturedGoblin_TryAvenge((CHARACTER)_Player)
THEN
PROC_DEN_CapturedGoblin_GuardsDialog((CHARACTER)_Player);

PROC
PROC_DEN_CapturedGoblin_TryAvenge((CHARACTER)_Player)
AND
QRY_GetClosestAvailableCharacterTo(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,0)
AND
DB_ClosestAvailableCharacterTo(_Char,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,_)
AND
NOT DB_OnlyOnce("DEN_CapturedGoblin_GuardsDialog")
THEN
PROC_DEN_CapturedGoblin_GuardsDialog(_Char);

PROC
PROC_DEN_CapturedGoblin_TryAvenge((CHARACTER)_)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player,S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
NOT DB_OnlyOnce("DEN_CapturedGoblin_GuardsDialog")
THEN
PROC_DEN_CapturedGoblin_GuardsDialog(_Player);

PROC
PROC_DEN_CapturedGoblin_TryAvenge((CHARACTER)_Player)
AND
NOT DB_OnlyOnce("DEN_CapturedGoblin_GuardsDialog")
THEN
PROC_SpotPlayers_RestartSpotting(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_GrieflingAvengeSpotter");

PROC
PROC_DEN_CapturedGoblin_GuardsDialog((CHARACTER)_Char)
AND
_Char != NULL_00000000-0000-0000-0000-000000000000
AND
DB_InRegion(_Char,S_DEN_GoblinAndGrieflingBox_52ca1804-f4bd-492c-b9f3-a166da51437a)
AND
NOT DB_HiddenCharacters(_Char,_)
AND
DB_State_Current(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge")
AND
NOT DB_IsArrested(_,_Char)
AND
NOT DB_Is_Wildshaped(_Char)
AND
QRY_SpeakerIsAvailable(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8)
AND
NOT QRY_DEN_CapturedGoblin_InterruptDialog()
AND
QRY_SpeakerIsAvailable(_Char)
AND
QRY_StartDialog(DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000, _Char)
THEN
DB_OnlyOnce("DEN_CapturedGoblin_GuardsDialog");

QRY
QRY_DEN_CapturedGoblin_InterruptDialog()
AND
DB_DialogSpeakers(_ID,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_)
AND
DB_DialogName(_Dialog,_ID)
AND
_Dialog != DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9
AND
DialogIsAutomated(_Dialog,0)
THEN
PROC_ForceStopDialog(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

IF
AttackedBy(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,_,_,_,_)
AND
DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinShot_1ccc6b3f-7255-de5f-75ee-296962b85e5c)
THEN
Die(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,DEATHTYPE.Physical,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,1,0);

PROC
PROC_GlobalFlagReactionAfterDialog(DEN_CapturedGoblin_Event_GuardCombat_e19c82e5-5463-fe2a-5511-fb5d08a93899, DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9)
AND
DB_DialogName(DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9,_ID)
AND
DB_DialogPlayers(_ID, _Player, _)
THEN
PROC_SetRelationTemporaryHostile((CHARACTER)S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,(CHARACTER)_Player);

PROC
PROC_GlobalFlagReactionAfterDialog(DEN_CapturedGoblin_Event_GuardCombat_e19c82e5-5463-fe2a-5511-fb5d08a93899, DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9)
THEN
PROC_SetRelationMutual((FACTION)ACT1_DEN_Griefling_b30628c0-87aa-aa8a-4bc6-84740eb6ef92,(FACTION)ACT1_DEN_CapturedGoblin_40d6a49e-806c-4bce-8214-6228cc0ded72,0);
SetFlag(DEN_CapturedGoblin_Event_GuardCombat_e19c82e5-5463-fe2a-5511-fb5d08a93899);

IF
DialogActorLeft(DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9,_,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,_)
AND
DB_State_Current(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge")
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_GuardCombat_e19c82e5-5463-fe2a-5511-fb5d08a93899)
THEN
SetFlag(DEN_CapturedGoblin_Event_GoblinShot_1ccc6b3f-7255-de5f-75ee-296962b85e5c);

IF
DB_GlobalFlag(DEN_CapturedGoblin_State_PlayerRescuedGoblin_2030e459-3a80-1172-8bbd-1d90395deace)
AND
NOT QRY_DEN_CapturedGoblin_GrieflingIsLeaving()
THEN
SetFlag(DEN_CapturedGoblin_Event_GuardsStayed_288ac3b0-3f5b-5c15-b0fb-def5c4f0b308);

//Griefling leave handling
IF
FlagSet(_Flag, _, _)
AND
DB_DEN_CapturedGoblin_ResolvedFlags(_Flag)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_Resolved_df392d3d-95e0-7009-2942-d0418a3e344b)
THEN
SetFlag(DEN_CapturedGoblin_State_Resolved_df392d3d-95e0-7009-2942-d0418a3e344b);

IF
LeftTrigger(_Player, S_DEN_Cave_SUB_adecafa4-27c6-4b2f-bf9e-6ffd7c81a766)
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_Resolved_df392d3d-95e0-7009-2942-d0418a3e344b)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_DEN_Cave_SUB_adecafa4-27c6-4b2f-bf9e-6ffd7c81a766)
AND
QRY_DEN_CapturedGoblin_GrieflingIsLeaving()
THEN
DB_NOOP(1);

PROC
PROC_State_Changed(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", _State)
AND
NOT DB_DEN_DefaultStates(_State)
AND
QRY_State_IsBeforeState(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Resolution")
THEN
PROC_DEN_CapturedGoblin_ForceConcludeGriefling();

PROC
PROC_DEN_CapturedGoblin_ForceConcludeGriefling()
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_GuardsLeft_b79734e0-8efc-228f-9a44-50641da7c55a)
AND
QRY_DEN_CapturedGoblin_GrieflingIsLeaving()
THEN
SetFlag(DEN_CapturedGoblin_Event_GuardsLeft_b79734e0-8efc-228f-9a44-50641da7c55a);

//Situation did not conclude before a state change
PROC
PROC_DEN_CapturedGoblin_ForceConcludeGriefling()
AND
NOT QRY_DEN_CapturedGoblin_GrieflingIsLeaving()
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e)
THEN
SetFlag(DEN_CapturedGoblin_Event_GoblinShot_1ccc6b3f-7255-de5f-75ee-296962b85e5c);
Die(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, DEATHTYPE.Physical, 1);
SetFlag(DEN_CapturedGoblin_Event_GuardsLeft_b79734e0-8efc-228f-9a44-50641da7c55a);

QRY
QRY_DEN_CapturedGoblin_GrieflingIsLeaving()
AND
DB_DEN_CapturedGoblin_GrieflingLeaveFlags(_Flag)
AND
DB_GlobalFlag(_Flag)
THEN
DB_NOOP(1);

//In case GuardsLeft is set after they have already been flagged as staying
PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_LeftDEN")
AND
DB_GlobalFlag(DEN_CapturedGoblin_Event_GuardsStayed_288ac3b0-3f5b-5c15-b0fb-def5c4f0b308)
THEN
ClearFlag(DEN_CapturedGoblin_Event_GuardsStayed_288ac3b0-3f5b-5c15-b0fb-def5c4f0b308);

IF
DB_State_Current(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_LeftDEN")
AND
NOT DB_DialogNPCs(_,S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,_)
AND
NOT DB_DialogNPCs(_,S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52,_)
THEN
PROC_NotifyWhenReadyToMoveOn(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_CapturedGoblin_GrieflingLeaving");

PROC
PROC_ReadyToMoveOn(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_CapturedGoblin_GrieflingLeaving")
THEN
PROC_CharacterMoveTo(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, S_DEN_OpenGateOutsidePos_768e43ba-7bda-4162-be4a-710775ecbf1f, "Walk", "DEN_CapturedGoblin_ReadytoLeave");

PROC
PROC_ReadyToMoveOn(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_CapturedGoblin_GrieflingLeaving")
THEN
Follow(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52, S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);

IF
EntityEvent(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,"DEN_CapturedGoblin_ReadytoLeave")
THEN
PROC_DisappearOutOfSight(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,"Walk",0,"DEN_CapturedGoblin_GrieflingGone");
StopFollow(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52);
PROC_DisappearOutOfSight(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52,"Walk",0,"DEN_CapturedGoblin_FriendGone");

IF
EntityEvent(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,"DEN_CapturedGoblin_GrieflingGone")
THEN
DB_DEN_CapturedGoblin_DeadGrieflingSetReady(1);

IF
DB_DEN_CapturedGoblin_DeadGrieflingSetReady(1)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_DEN_GrieflingGoblitterateSphere_fde02590-d754-4efc-ab60-8ac44205f94a)
THEN
NOT DB_DEN_CapturedGoblin_DeadGrieflingSetReady(1);
AppearAt(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,S_DEN_GrieflingGoblitteratePoint_944ec5c4-b64d-48e0-a67d-6e9b18dface9,0,NULL_00000000-0000-0000-0000-000000000000,"DEN_CapturedGoblin_GrieflingDeath");

IF
LeftTrigger(_Player, S_DEN_GrieflingGoblitterateSphere_fde02590-d754-4efc-ab60-8ac44205f94a)
AND
DB_DEN_CapturedGoblin_DeadGrieflingSetReady(1)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_DEN_GrieflingGoblitterateSphere_fde02590-d754-4efc-ab60-8ac44205f94a)
THEN
NOT DB_DEN_CapturedGoblin_DeadGrieflingSetReady(1);
AppearAt(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,S_DEN_GrieflingGoblitteratePoint_944ec5c4-b64d-48e0-a67d-6e9b18dface9,0,NULL_00000000-0000-0000-0000-000000000000,"DEN_CapturedGoblin_GrieflingDeath");

IF
EntityEvent(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,"DEN_CapturedGoblin_GrieflingDeath")
THEN
Die(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,DEATHTYPE.Physical,NULL_00000000-0000-0000-0000-000000000000,1,1);

IF
FlagSet(DEN_RaidingParty_Quest_GoblinRaidOver_98712d90-c46b-20c4-c4df-02c0117e85a5,_,_)
THEN
SetFlag(DEN_CapturedGoblin_State_Grieve_93f4f48a-6edd-93a1-2704-b13691df0bb4,NULL_00000000-0000-0000-0000-000000000000,0);

PROC
PROC_StateSet_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_Is_InCombat(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,_ID)
AND
QRY_GLO_IsOrWasInCombat(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, _ID)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinShot_1ccc6b3f-7255-de5f-75ee-296962b85e5c)
THEN
SetFlag(DEN_CapturedGoblin_Event_GoblinShot_1ccc6b3f-7255-de5f-75ee-296962b85e5c,NULL_00000000-0000-0000-0000-000000000000);

//Ignore standard interruptions while grieving or avenging as it should take higher priority
PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Grieve")
AND
DB_DEN_CapturedGoblin_GrieflingScenes("DEN_CapturedGoblin_GrieflingGrieve")
THEN
DB_SceneManager(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_CapturedGoblin_GrieflingGrieve");
DB_SceneManager(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52, "DEN_CapturedGoblin_GrieflingGrieve");

PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Avenge")
AND
DB_DEN_CapturedGoblin_GrieflingScenes("DEN_CapturedGoblin_GrieflingAvenge")
THEN
DB_SceneManager(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_CapturedGoblin_GrieflingAvenge");
DB_SceneManager(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52, "DEN_CapturedGoblin_GrieflingAvenge");

PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", _State)
AND
NOT QRY_State_IsBeforeState(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Resolution")
THEN
PROC_SpotPlayers_StopSpotting(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_GrieflingAvengeSpotter");
PROC_DEN_CapturedGoblin_EndScene("DEN_CapturedGoblin_GrieflingAvenge");

PROC
PROC_State_Changed(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", _State)
AND
NOT QRY_State_IsBeforeState(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, "DEN_Griefling_CapturedGoblin", "DEN_Griefling_State_Transit")
THEN
PROC_DEN_CapturedGoblin_EndScene("DEN_CapturedGoblin_GrieflingGrieve");

IF
FlagSet(DEN_CapturedGoblin_State_SteppedInfrontOfCrossbow_dff39def-ac63-8851-1330-239b310f090f, _Player, _)
THEN
PROC_CharacterMoveTo((CHARACTER)_Player, S_DEN_StandBetweenPoint_75d5a7d4-fdc7-4de3-b8d2-3ce5b6ce4e1c, "Walk", "");

IF
FlagSet(DEN_CapturedGoblin_Event_SteppedBackFromGoblin_8b55ccb8-ab1a-40ea-88d2-fe40ae6994e2, _Player, _)
THEN
PROC_CharacterMoveTo((CHARACTER)_Player, S_DEN_GrieflingPlayerStandPoint_b83b94f6-8982-4399-ba29-89744e9daf54, "Walk", "");

//Griefling is primary actor for scene (GrieflingFriend is optional)
PROC
PROC_StateSet_Defeated(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8)
AND
DB_DEN_CapturedGoblin_GrieflingScenes(_Scene)
THEN
PROC_DEN_CapturedGoblin_EndScene(_Scene);

//In the circumstance that the state of the grove changed before concluding griefling scenes
PROC
PROC_State_Changed(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", _State)
AND
NOT DB_DEN_DefaultStates(_State)
AND
DB_DEN_CapturedGoblin_GrieflingScenes(_Scene)
THEN
PROC_DEN_CapturedGoblin_EndScene(_Scene);

//Become hostile by violent interrupts 
PROC
PROC_SceneInterrupted(_NPC, _Player, "DEN_CapturedGoblin_GrieflingGrieve", _Interruption)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Interruption)
THEN
PROC_ForceStopDialog(_NPC);
PROC_SetRelationTemporaryHostile((CHARACTER)_NPC,(CHARACTER)_Player);
PROC_DEN_CapturedGoblin_EndScene("DEN_CapturedGoblin_GrieflingGrieve");

IF
DB_SceneManager_DisturbanceRegistering(_Player, "LootOwnedCorpse", -1, S_DEN_DeadLover_0126a6b5-3452-47db-a3e5-525b7deca82f, S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8, _CrimeID)
THEN
PROC_ForceStopDialog(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
PROC_SetRelationTemporaryHostile((CHARACTER)S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,(CHARACTER)_Player);
PROC_DEN_CapturedGoblin_EndScene("DEN_CapturedGoblin_GrieflingGrieve");


PROC
PROC_SceneInterrupted(_NPC, _Player, "DEN_CapturedGoblin_GrieflingAvenge", _Interruption) 
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Interruption)
THEN
PROC_ForceStopDialog(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
PROC_SetRelationMutual((FACTION)ACT1_DEN_Griefling_b30628c0-87aa-aa8a-4bc6-84740eb6ef92,(FACTION)ACT1_DEN_CapturedGoblin_40d6a49e-806c-4bce-8214-6228cc0ded72,0);
SetFlag(DEN_CapturedGoblin_Event_GuardCombat_e19c82e5-5463-fe2a-5511-fb5d08a93899);
PROC_SetRelationTemporaryHostile((CHARACTER)_NPC,(CHARACTER)_Player);
PROC_DEN_CapturedGoblin_EndScene("DEN_CapturedGoblin_GrieflingAvenge");

PROC
PROC_OnDialogAttack_GoingHostile((CHARACTER)S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,(CHARACTER)_Player)
AND
DB_DialogName(DEN_CapturedGoblin_GuardsAvenge_4bedcdef-dad2-b1b2-5b1a-85ffb783e1c9,_ID)
AND
DB_DialogPlayers(_ID, _Player, _)
THEN
PROC_SetRelationMutual((FACTION)ACT1_DEN_Griefling_b30628c0-87aa-aa8a-4bc6-84740eb6ef92,(FACTION)ACT1_DEN_CapturedGoblin_40d6a49e-806c-4bce-8214-6228cc0ded72,0);
SetFlag(DEN_CapturedGoblin_Event_GuardCombat_e19c82e5-5463-fe2a-5511-fb5d08a93899);

PROC
PROC_DEN_CapturedGoblin_EndScene((STRING)_Scene)
AND
DB_DEN_CapturedGoblin_GrieflingScenes(_Scene)
THEN
PROC_SceneOver(_Scene);
NOT DB_DEN_CapturedGoblin_GrieflingScenes(_Scene);

//Something weird happened that interrupted her shooting the goblin and the golbin is no longer was available, clear the flag so she doesn't act like she got the kill
IF
FlagSet(DEN_CapturedGoblin_Event_Foiled_99ff0e4d-0ce5-7164-4d81-b00edd7906a8, _, _)
AND
DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinShot_1ccc6b3f-7255-de5f-75ee-296962b85e5c)
THEN
ClearFlag(DEN_CapturedGoblin_Event_GoblinShot_1ccc6b3f-7255-de5f-75ee-296962b85e5c);
//END_REGION

//REGION Crime
IF
DB_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
THEN
ClearOwnership(S_DEN_GoblinCageDoor_208e7554-1199-4737-b107-b3c1ccddd588);

//Sazza doesn't care about guards in the grove
QRY
QRY_CRIME_Guards_GuardKillerExcludeWitness((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
THEN
DB_NOOP(1);

//Ignore crimes if not the victim
PROC
PROC_CharacterRegisterCrime_Success(_Char, _CrimeType, _StoryActionID, _Evidence, _Victim, _CrimeID)
AND
DB_DEN_WasInDen(_Victim)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
AND
_Victim != S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb
THEN
CrimeIgnoreCrime(_CrimeID, S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

IF
FlagSet(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e,_,_)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
AND
NOT DB_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
THEN
PROC_TryStopDialogFor(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
PROC_CharacterRegisterCrime(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,"DEN_CapturedGoblinFree",S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,NULL_00000000-0000-0000-0000-000000000000,0);

IF
FlagSet(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3,_,_)
AND
NOT DB_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
THEN
CharacterStopCrime(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,"DEN_CapturedGoblinFree",S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

PROC
PROC_StateSet_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_Released_63535870-e8f0-6b53-4194-0ca66bc2416e)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
THEN
CharacterStopCrime(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,"DEN_CapturedGoblinFree",S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
NOT DB_CRIME_Guards_NoSummonBy(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

QRY
QRY_CrimeGetCustomWarning((CHARACTER)_NPC,"DEN_CapturedGoblinFree",(DIALOGRESOURCE)_Dialog, _)
THEN
DB_CrimeWarning_Block(_NPC,"DEN_CapturedGoblinFree",_Dialog,1);

PROC
PROC_CrimeSelectWarning(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,_,_ID,"DEN_CapturedGoblinFree",_Dialog,_Criminal,_,_,_)
THEN
PROC_SetRelationTemporaryHostile(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8,_Criminal);

PROC
PROC_CrimeSelectWarning(_NPC,_Region,_ID,"DEN_CapturedGoblinFree",_Dialog,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Criminal2,_Criminal3,_Criminal4)
AND
DB_CrimeWarning_Block(_NPC,"DEN_CapturedGoblinFree",_Dialog,1)
AND
QRY_GetClosestAvailableCharacterTo(_NPC,1,0,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1,1)
AND
DB_ClosestAvailableCharacterTo(_Char,_NPC,_Dist)
AND
_Dist < 20
THEN
NOT DB_CrimeWarning_Block(_NPC,"DEN_CapturedGoblinFree",_Dialog,1);
PROC_CrimeSelectWarning(_NPC,_Region,_ID,"DEN_CapturedGoblinFree",GEB_DEN_CapturedGoblin_Crime_74ca3628-bc97-63c8-e1c3-944ea78600ec,_Char,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Criminal3,_Criminal4);

PROC
PROC_CrimeSelectWarning(_NPC,_,_ID,"DEN_CapturedGoblinFree",_Dialog,_,_,_,_)
AND
DB_CrimeWarning_Block(_NPC,"DEN_CapturedGoblinFree",_Dialog,1)
THEN
PROC_TryStartAD(DEN_CapturedGoblin_AD_Crime_77292cca-f95d-686c-c3b0-3e63ef2ff7a0,_NPC);

PROC
PROC_CrimeSelectWarning(_NPC,_,_,"DEN_CapturedGoblinFree",_Dialog,_Char,_,_,_)
AND
DB_DialogPlayers(_ID,_Char,_)
AND
DB_DialogName(GEB_DEN_CapturedGoblin_Crime_74ca3628-bc97-63c8-e1c3-944ea78600ec,_ID)
THEN
NOT DB_CrimeWarning_Block(_NPC,"DEN_CapturedGoblinFree",_Dialog,1);

PROC
PROC_CrimeSelectWarning(_NPC,_,_ID,"DEN_CapturedGoblinFree",_Dialog,_,_,_,_)
AND
DB_CrimeWarning_Block(_NPC,"DEN_CapturedGoblinFree",_Dialog,1)
THEN
PROC_SetRelationTemporaryHostile(_NPC,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

PROC
PROC_CrimeFailedToInterruptStoryDialog((INTEGER)_ID,(CHARACTER)_NPC,(CHARACTER)_Criminal1,(CHARACTER)_Criminal2,(CHARACTER)_Criminal3,(CHARACTER)_Criminal4,GEB_DEN_CapturedGoblin_Crime_74ca3628-bc97-63c8-e1c3-944ea78600ec)
AND
CharacterGetCrimeRegion(_NPC,_Region)
THEN
DB_CrimeWarning_Block(_NPC,"DEN_CapturedGoblinFree",GEB_DEN_CapturedGoblin_Crime_74ca3628-bc97-63c8-e1c3-944ea78600ec,1);
PROC_CrimeSelectWarning(_NPC,_Region,_ID,"DEN_CapturedGoblinFree",GEB_DEN_CapturedGoblin_Crime_74ca3628-bc97-63c8-e1c3-944ea78600ec,_Criminal1,_Criminal2,_Criminal3,_Criminal4);

IF
OnCrimeConfrontationDone(_ID,_,_,_,_,_,_)
AND
CrimeGetType(_ID,"DEN_CapturedGoblinFree")
THEN
IgnoreCrimeInRadiusWithTags(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_ID,15.0,"");

IF
FlagSet(DEN_CapturedGoblin_Event_GoblinBetrayed_991fd91a-c2bd-3382-b77f-9a930e1ba46a,_,_)
AND
DB_DEN_CapturedGoblin_Follow(_Own,_)
THEN
ClearFlag(DEN_CapturedGoblin_Follow_8df7d87d-1b18-7be5-1003-f4ce70ff1f25,_Own);

IF
DialogEnded(GEB_DEN_CapturedGoblin_Crime_74ca3628-bc97-63c8-e1c3-944ea78600ec,_ID)
AND
DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinBetrayed_991fd91a-c2bd-3382-b77f-9a930e1ba46a)
AND
DB_DialogNPCs(_ID,_NPC,1)
THEN
DB_DEN_CapturedGoblin_Betrayers((CHARACTER)_NPC);

IF
DialogEnded(GEB_DEN_CapturedGoblin_Crime_74ca3628-bc97-63c8-e1c3-944ea78600ec,_ID)
AND
DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinBetrayed_991fd91a-c2bd-3382-b77f-9a930e1ba46a)
AND
NOT DB_GlobalFlag(DEN_CapturedGoblin_Event_LeftGoblin_9c5c270b-ba7d-4a4f-5347-96dd1f47b53e)
AND
DB_DialogPlayers(_ID,_Player,1)
THEN
DB_DEN_CapturedGoblin_Betrayers((CHARACTER)_Player);

IF
FlagSet(TemporaryHostilityAfterDialog_ca0cbe39-d121-069e-b408-c02954b32cf7,_,_ID)
AND
DB_DialogName(GEB_DEN_CapturedGoblin_Crime_74ca3628-bc97-63c8-e1c3-944ea78600ec,_ID)
AND
DB_DialogNPCs(_ID,_NPC,1)
THEN
DB_DEN_CapturedGoblin_Betrayers((CHARACTER)_NPC);

IF
CharacterLeftParty(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinBetrayed_991fd91a-c2bd-3382-b77f-9a930e1ba46a)
THEN
DB_DEN_CapturedGoblin_LeftBetrayed(1);

IF
DB_DEN_CapturedGoblin_LeftBetrayed(1)
AND
DB_DEN_CapturedGoblin_Betrayers(_Char)
THEN
PROC_SetRelationTemporaryHostile((CHARACTER)_Char,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
NOT DB_DEN_CapturedGoblin_Betrayers(_Char);

IF
CombatEnded(_ID)
AND
DB_GlobalFlag(DEN_CapturedGoblin_Event_GoblinBetrayed_991fd91a-c2bd-3382-b77f-9a930e1ba46a)
THEN
ClearFlag(DEN_CapturedGoblin_Event_GoblinBetrayed_991fd91a-c2bd-3382-b77f-9a930e1ba46a,NULL_00000000-0000-0000-0000-000000000000,0);
ClearFlag(DEN_CapturedGoblin_Event_LeftGoblin_9c5c270b-ba7d-4a4f-5347-96dd1f47b53e,NULL_00000000-0000-0000-0000-000000000000,0);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
