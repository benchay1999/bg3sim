Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Dialogs
DB_Dialogs(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156,DEN_ShadowDruid_Leader_44569c62-70e8-28bc-7cec-fdf051daa339);
DB_Dialogs(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d,DEN_ShadowDruid_Opposed_86e153fa-7a4a-7494-ff78-944beec2d4e0);
DB_Dialogs(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, DEN_ShadowDruid_KidFreed_5c74f12a-1806-ba6b-8fa1-66d4f6b85281);
DB_Inclusion_Object(S_DEN_PetWolf_63471e30-7413-4496-97de-0bdf67c2f753,(FLAG)DEN_PetWolf_StartInclusion_492f083e-44ee-751c-2f20-01ed9084ac66, (FLAG)DEN_PetWolf_EndInclusion_9a8cbc05-646d-3c69-86d0-a46b5ebb2403);

DB_Dialogs(S_DEN_ShadowDruid_001_0cb92c37-fb4d-4547-8702-1fb1dd52d0b6,DEN_ShadowDruid_001_a40bb913-19c6-6feb-2fe7-0af38b106584);
DB_Dialogs(S_DEN_ShadowDruid_002_0820c093-f400-4efc-95b9-a6d08a58cac9,DEN_ShadowDruid_002_aabb5613-528f-d50b-5992-a1fd2b5c3b45);
DB_Dialogs(S_DEN_ShadowDruid_003_53b08334-9f79-4bb5-b580-2662355d54ad,DEN_ShadowDruid_003_ae9b341f-faa6-436f-30f1-273be7ca40ac);

DB_DropMutingStatussesDialog(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7);
DB_IgnoreMutingStatussesDialog(DEN_ShadowDruid_001_a40bb913-19c6-6feb-2fe7-0af38b106584);
DB_IgnoreMutingStatussesDialog(DEN_ShadowDruid_002_aabb5613-528f-d50b-5992-a1fd2b5c3b45);
DB_IgnoreMutingStatussesDialog(DEN_ShadowDruid_003_ae9b341f-faa6-436f-30f1-273be7ca40ac);

DB_GLO_CharacterCorpseDialog(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, DEN_DruidLeader_Dead_cdc78613-34d7-a652-db0b-127c98f11526);

//END_REGION
//REGION Snakes Court Scene
DB_DialogBlockAttackButton((DIALOGRESOURCE)DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7);
DB_AddCharactersInTriggerToDialog(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7, S_DEN_SnakesCourtProxSphere_8456dca4-15a1-44b6-93e6-63a7a8a75f06, 1);

PROC_TriggerRegisterForPlayers(S_DEN_SnakesCourtStartBox_01d25948-1be8-4cbe-83de-b75b9cb10fed);
PROC_TriggerRegisterForPlayers(S_DEN_SnakesCourtProxSphere_8456dca4-15a1-44b6-93e6-63a7a8a75f06);

// Scene manager
DB_SceneManager(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d,"DEN_SnakeCourt");
DB_SceneManager(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156,"DEN_SnakeCourt");
DB_SceneManager(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,"DEN_SnakeCourt");
DB_SceneManager(S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8,"DEN_SnakeCourt");
DB_SceneManager(S_DEN_ServantGnome_003_0d971a2f-5fd7-4358-8966-147ed8b106dd,"DEN_SnakeCourt");
DB_SceneManager(S_DEN_Snake_001_af2ff867-467e-4765-a66c-fed091af4a09,"DEN_SnakeCourt");
DB_SceneManager(S_DEN_PetWolf_63471e30-7413-4496-97de-0bdf67c2f753,"DEN_SnakeCourt");
DB_SceneManager(S_DEN_ShadowDruid_001_0cb92c37-fb4d-4547-8702-1fb1dd52d0b6,"DEN_SnakeCourt");
DB_SceneManager(S_DEN_ShadowDruid_003_53b08334-9f79-4bb5-b580-2662355d54ad,"DEN_SnakeCourt");
DB_SceneManager(S_DEN_ShadowDruid_002_0820c093-f400-4efc-95b9-a6d08a58cac9,"DEN_SnakeCourt");

DB_DEN_ShadowDruid_SnakeCourtReactors(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d);
DB_DEN_ShadowDruid_SnakeCourtReactors(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156);

// State manager
DB_State_Current(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "Exposition");
DB_State_Priority(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "Exposition", 0);
DB_State_Priority(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "CourtDialog", 100);
DB_State_Priority(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "SnakeBite", 200);
DB_State_Priority(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "KidFreed", 300);
DB_State_Priority(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "Finished", 500);

// Snakes
DB_DEN_ShadowDruid_Snakes((CHARACTER)S_DEN_Snake_001_af2ff867-467e-4765-a66c-fed091af4a09);

DB_DEN_ShadowDruid_KidDied_Internal(1);

//END_REGION
//REGION Shadow druids

DB_DEN_ShadowDruid_Originals((CHARACTER)S_DEN_ShadowDruid_001_0cb92c37-fb4d-4547-8702-1fb1dd52d0b6);
DB_DEN_ShadowDruid_Originals((CHARACTER)S_DEN_ShadowDruid_002_0820c093-f400-4efc-95b9-a6d08a58cac9);
DB_DEN_ShadowDruid_Originals((CHARACTER)S_DEN_ShadowDruid_003_53b08334-9f79-4bb5-b580-2662355d54ad);

DB_DEN_ShadowDruids((CHARACTER)S_DEN_ShadowDruid_001_0cb92c37-fb4d-4547-8702-1fb1dd52d0b6);
DB_DEN_ShadowDruids((CHARACTER)S_DEN_ShadowDruid_003_53b08334-9f79-4bb5-b580-2662355d54ad);
DB_DEN_ShadowDruids((CHARACTER)S_DEN_ShadowDruid_002_0820c093-f400-4efc-95b9-a6d08a58cac9);
//Kagha
//Marcoryl
//Loic

DB_DEN_ShadowDruid_DenouncingNPCs((CHARACTER)S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d);
DB_DEN_ShadowDruid_DenouncingNPCs((CHARACTER)S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156);
DB_DEN_ShadowDruid_DenouncingNPCs((CHARACTER)S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8);
DB_DEN_ShadowDruid_DenouncingNPCs((CHARACTER)S_DEN_ServantGnome_003_0d971a2f-5fd7-4358-8966-147ed8b106dd);
DB_DEN_ShadowDruid_DenouncingNPCs((CHARACTER)S_DEN_ShadowDruid_001_0cb92c37-fb4d-4547-8702-1fb1dd52d0b6);
DB_DEN_ShadowDruid_DenouncingNPCs((CHARACTER)S_DEN_ShadowDruid_003_53b08334-9f79-4bb5-b580-2662355d54ad);
DB_DEN_ShadowDruid_DenouncingNPCs((CHARACTER)S_DEN_ShadowDruid_002_0820c093-f400-4efc-95b9-a6d08a58cac9);
DB_DEN_ShadowDruid_DenouncingNPCs((CHARACTER)S_DEN_PetWolf_63471e30-7413-4496-97de-0bdf67c2f753);
//Findal added dynamically

DB_HasItemEvent((ITEM)S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c,(FLAG)DEN_ShadowDruid_State_HasRecruitmentLetter_75c42284-4caa-4193-84a6-951fdff58357);
DB_GiveItemToEventWithClear((ITEM)S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c,(FLAG)DEN_ShadowDruid_Event_GiveRecruitmentLetter_7ee8c1f8-4b82-4abf-880a-5cd7abda7475);

DB_BookFlags(S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c,DEN_ShadowDruid_Knows_RecruitmentLetter_587f1e08-f890-4740-a588-e76778143fec);
DB_BookFlags(S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c,DEN_ShadowDruid_Knows_MeetingLocation_a8b8b540-e0d5-4c21-9de1-949de855f094);
DB_BookFlags(S_DEN_ShadowMeetingNote_fbe59587-8dec-440c-94d2-2748727c4cf5,DEN_ShadowDruid_Knows_MeetingLocation_a8b8b540-e0d5-4c21-9de1-949de855f094);

SetOnStage(S_DEN_FaithwardenStaff_5de75000-9141-466b-9019-70df488b2958, 0);
//END_REGION

DB_FlagReactionAfterDialog((FLAG)DEN_ShadowDruid_State_CourtHostile_b79f3102-f47e-339c-23f2-1de2c38d4e6e,(DIALOGRESOURCE)DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7);
DB_FlagReactionAfterDialog((FLAG)DEN_ShadowDruid_State_CourtHostile_b79f3102-f47e-339c-23f2-1de2c38d4e6e,(DIALOGRESOURCE)DEN_ShadowDruid_Leader_44569c62-70e8-28bc-7cec-fdf051daa339);

PROC_TriggerRegisterForPlayers(S_HAG_ShadowTreeSphere_692f6baa-8e34-4474-9afa-96421fb6c294);
SetCanInteract(S_HAG_ShadowTree_30fe7685-0a91-45af-bcfc-9e68a985927a, 0);

DB_PermaDefeatedFlag(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156,DEN_ShadowDruid_State_KaghaIsDead_d7db3ef4-acf7-d0e3-dcd1-1c4b8ca6ba46);
DB_PermaDefeatedFlag(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d,DEN_ShadowDruid_State_RathIsPermaDefeated_439d7789-34eb-a928-7881-b557a5f53150);

DB_ReportKiller(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, DEN_ShadowDruid_State_PlayerKilledKagha_361be740-5c39-49c1-9d3a-ec6a46e3e134);

DB_QuestDef_BookReadState("DEN_Conflict", "ReflectedKagha", S_DEN_DruidRite_466a08de-7143-409f-b12e-6f5440e19793);

DB_DEN_ShadowDruid_KaghaCombatADCount(1);
DB_DoNotFaceDialog(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, (DIALOGRESOURCE)DEN_ShadowDruid_AD_ReactToDeadKid_762ebed6-3c17-a4ae-0915-39de07c2010e);
KBSECTION
//REGION debug

// Snake court scene
IF
FlagSet(DEN_ShadowDruid_Debug_ResolveKidDie_76076244-4ddf-f7e1-c288-6572d72bf3c1,_Player,_)
THEN
PROC_DEN_ShadowDruid_CourtOutcome(0);

IF
FlagSet(DEN_ShadowDruid_Debug_ResolveKidAlive_dfcf720f-16ce-b7e6-bfeb-d111b90b2f0f,_,_)
THEN
SetFlag(DEN_ShadowDruid_State_KidFreed_8d9e9065-7bb5-a516-15c3-c9d8c1f4f5e2, NULL_00000000-0000-0000-0000-000000000000);
PROC_DEN_ShadowDruid_CourtOutcome(1);

IF
TextEvent("snakecourtdone")
THEN
PROC_State_Progress(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "CourtDialog");

IF
TextEvent("snakecourtdone")
AND
DB_SceneManager(_NPC,"DEN_SnakeCourt")
THEN
PROC_ForceStopDialog(_NPC);

IF
TextEvent("snakecourtdone")
AND
GetTextEventParamInteger(1, 1)
THEN
NOT DB_DEN_ShadowDruid_KidDied_Internal(1);
SetFlag(DEN_ShadowDruid_State_KidFreed_8d9e9065-7bb5-a516-15c3-c9d8c1f4f5e2, NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("snakecourtdone")
AND
GetFlag(DEN_ShadowDruid_State_KidFreed_8d9e9065-7bb5-a516-15c3-c9d8c1f4f5e2, NULL_00000000-0000-0000-0000-000000000000, _IsFreed)
THEN
PROC_DEN_ShadowDruid_CourtOutcome(_IsFreed);


// Kagha denouncing
IF
FlagSet(DEN_ShadowDruid_Debug_GiveKaghaLetter_fdf4dca6-e883-55de-98fb-855ec00491e1,_Player,_)
THEN
ToInventory(S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c, _Player, 1, 1, 0);
ToInventory(S_DEN_ShadowMeetingNote_fbe59587-8dec-440c-94d2-2748727c4cf5, _Player, 1, 1, 0);
ToInventory(S_DEN_ShadowTenetsBook_87cad28c-6d41-4532-9289-38ab96ee30f5, _Player, 1, 1, 0);

IF
TextEvent("denouncingkagha")
AND
GetHostCharacter(_Player)
THEN
ToInventory(S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c, _Player, 1, 1, 0);
ToInventory(S_DEN_ShadowMeetingNote_fbe59587-8dec-440c-94d2-2748727c4cf5, _Player, 1, 1, 0);
ToInventory(S_DEN_ShadowTenetsBook_87cad28c-6d41-4532-9289-38ab96ee30f5, _Player, 1, 1, 0);
SetFlag(DEN_ShadowDruid_Knows_RecruitmentLetter_587f1e08-f890-4740-a588-e76778143fec, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(DEN_ShadowDruid_Knows_MeetingLocation_a8b8b540-e0d5-4c21-9de1-949de855f094, NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("denouncingkaghadone")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156);
DB_Dialogs(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156,DEN_ShadowDruid_LeaderPersuaded_e66c2f8b-2c9f-35a1-6564-1aa0fc08a020);
PROC_State_Progress(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_RitualStopped");

IF
TextEvent("denouncingkaghadone")
AND
GetTextEventParamInteger(1, 1)
THEN
SetFlag(DEN_ShadowDruid_Event_KaghaTurnedGood_f2de839d-b971-86ee-f02c-5e09174ce919, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_DEN_ShadowDruids(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156);
NOT DB_DEN_ShadowDruids(S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8);
NOT DB_DEN_ShadowDruids(S_DEN_ServantPatrolling_0d971a2f-5fd7-4358-8966-147ed8b106dd);

IF
TextEvent("denouncingkaghadone")
AND
GetHostCharacter(_Player)
AND
IsTagged(_Player, DRUID_44ac4317-4d38-4d28-80e2-94024c6e42f0, 1)
THEN
DB_DEN_ShadowDruid_DruidDenouncer((GUIDSTRING)_Player);

IF
TextEvent("denouncingkaghadone")
THEN
PROC_DEN_ShadowDruid_DenouncingDialogEnded();

IF
TextEvent("denouncingkaghadone")
AND
DB_DEN_ShadowDruids(_Druid)
AND
NOT DB_Defeated(_Druid)
THEN
Die(_Druid, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 0);

//END_REGION

//REGION Shadow druids

IF
DB_DEN_ShadowDruid_Originals(_NPC)
THEN
//Status "WILDSHAPE_RAT_SECRET" is applied in the sidebar
PROC_SetCanFight(_NPC, 0); //combat is re-enabled when the Denouncing scene starts - in any other occasion, they have to PROC_DisappearOutOfSight instead of fighting 
SetCanJoinCombat(_NPC, 0);
PROC_CharacterDisableAllCrimes(_NPC); //crimes and self-healing remain disabled, these NPCs never need it
PROC_SelfHealing_Disable(_NPC);

QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)_Druid)
AND
DB_DEN_ShadowDruid_DenouncingNPCs(_Druid)
AND
GetFaction(_Druid, ACT1_DEN_ShadowDruid_Hostile_89b57c7d-8a44-49bf-8def-1c42f5513b5a)
THEN
DB_NOOP(1);

IF
FlagSet(DEN_ShadowDruid_Event_RemoveWildShape_6fe9a871-0a72-634c-e993-0c0ccad87784, NULL_00000000-0000-0000-0000-000000000000,_)
AND
DB_DEN_ShadowDruid_Originals(_NPC)
THEN
RemoveStatus(_NPC, "WILDSHAPE_RAT_SECRET");

//END_REGION
//REGION Shadow Druids - leaving conditions

PROC
PROC_State_Changed(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", _New)
AND
_New != "DEN_State_RitualStopped"
AND
DB_DEN_ShadowDruid_Originals(_Druid)
THEN
SetFlag((FLAG)GEN_DisappearOutOfSightWhenAvailable_a5b0b401-a04d-6493-579b-d87cff1474cb, _Druid);

// Attack any single druid -> all of them flee
IF
AttackedBy(_Druid,_,_,_,_,_,_)
AND
DB_DEN_ShadowDruid_Originals((CHARACTER)_Druid)
AND
NOT DB_State_Current(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_RitualStopped")
AND
DB_DEN_ShadowDruid_Originals((CHARACTER)_AnyShadowDruid)
THEN
SetFlag((FLAG)GEN_DisappearOutOfSightWhenAvailable_a5b0b401-a04d-6493-579b-d87cff1474cb, _AnyShadowDruid);

// Fallback if the shadow druid somehow loses HP without getting an AttackedBy event
IF
HitpointsChanged(_Druid, _)
AND
DB_DEN_ShadowDruid_Originals((CHARACTER)_Druid)
AND
NOT DB_State_Current(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_RitualStopped")
AND
GetHitpointsPercentage(_Druid, _Percentage)
AND
_Percentage > 0
AND
_Percentage < 100
AND
DB_DEN_ShadowDruid_Originals((CHARACTER)_AnyShadowDruid)
THEN
SetFlag((FLAG)GEN_DisappearOutOfSightWhenAvailable_a5b0b401-a04d-6493-579b-d87cff1474cb, _AnyShadowDruid);
//END_REGION

//REGION Snakes Court: Interruptions / DruidAttack hook

PROC
PROC_State_Changed(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", _)
THEN
PROC_DEN_ShadowDruid_SnakeCourtSceneEnded();

PROC
PROC_SceneInterrupted(S_DEN_Snake_001_af2ff867-467e-4765-a66c-fed091af4a09,_,"DEN_SnakeCourt",_Reason) //Teela is harmed
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
THEN
SetFlag(DEN_ShadowDruid_State_KidFreed_8d9e9065-7bb5-a516-15c3-c9d8c1f4f5e2);

PROC
PROC_SceneInterrupted(_,_Player,"DEN_SnakeCourt",_Reason)
AND
_Reason != "StartedDialog"
THEN
PROC_DEN_ShadowDruid_ProcessSnakeCourtInterruption(_Reason, _Player);

PROC
PROC_DEN_ShadowDruid_ProcessSnakeCourtInterruption((STRING)_Reason, (CHARACTER)_Player)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
AND
NOT DB_OnlyOnce("DEN_ShadowDruids_SnakeCourtInterrupted")
THEN
PROC_DEN_ShadowDruid_SnakeCourtSceneEnded(); //resolve Snakes Court before starting druid attack

PROC
PROC_DEN_ShadowDruid_ProcessSnakeCourtInterruption((STRING)_Reason, (CHARACTER)_Player)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
AND
NOT DB_OnlyOnce("DEN_ShadowDruids_SnakeCourtInterrupted")
THEN
PROC_DEN_DruidAttack_TryStart(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, _Player);

PROC
PROC_DEN_ShadowDruid_ProcessSnakeCourtInterruption((STRING)_Reason, (CHARACTER)_Player)
AND
NOT DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
AND
DB_Players(_Player)
AND
NOT DB_Defeated(_Player)
AND
DB_State_Current(_, "DEN_SnakeCourt", "Exposition")
AND
IsSpeakerReserved(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, 0)
AND
NOT DB_OnlyOnce("DEN_ShadowDruids_SnakeCourtInterrupted")
AND
QRY_StartDialogCustom_Fixed(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7, 
		S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, 
		S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, 
		S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, 
		S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8, 
		S_DEN_ServantGnome_003_0d971a2f-5fd7-4358-8966-147ed8b106dd, 
		_Player, 0, 0, 1, 1)
THEN
DB_OnlyOnce("DEN_ShadowDruids_SnakeCourtInterrupted");
PROC_State_Progress(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "CourtDialog");

//END_REGION
//REGION Snakes Court: dialog

IF
EnteredTrigger(_Player, S_DEN_SnakesCourtProxSphere_8456dca4-15a1-44b6-93e6-63a7a8a75f06)
AND
DB_Players(_Player)
AND
DB_State_Current(_, "DEN_SnakeCourt", "Exposition")
THEN
SetFlag(DEN_GuardedEntrance_Knows_KaghaHoldsChild_c842fabb-1603-ce99-df44-e284f8e79de0, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_DEN_ShadowDruid_Snakes(_Snake)
THEN
SetHasDialog(_Snake, 1);

//--- start
//auto
IF
EnteredTrigger(_Player, S_DEN_SnakesCourtStartBox_01d25948-1be8-4cbe-83de-b75b9cb10fed)
AND
DB_Players(_Player)
AND
NOT DB_Defeated(_Player)
AND
DB_State_Current(_, "DEN_SnakeCourt", "Exposition")
AND
IsSpeakerReserved(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, 0)
AND
QRY_StartDialogCustom(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7, 
		S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, 
		S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, 
		S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, 
		S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8, 
		S_DEN_ServantGnome_003_0d971a2f-5fd7-4358-8966-147ed8b106dd, 
		_Player, 0, 0, 1, 1)
THEN
PROC_State_Progress(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "CourtDialog");

PROC
PROC_State_Changed((GUIDSTRING)_,"DEN_SnakeCourt",(STRING)_)
THEN
PROC_TriggerUnregisterForPlayers(S_DEN_SnakesCourtStartBox_01d25948-1be8-4cbe-83de-b75b9cb10fed);


// manual
QRY
QRY_SelectCustomDialog((GUIDSTRING)_NPC, (GUIDSTRING)_Player)
AND
DB_Players((CHARACTER)_Player)
AND
DB_SceneManager((CHARACTER)_NPC, "DEN_SnakeCourt")
AND
DB_State_Current(_, "DEN_SnakeCourt", "Exposition")
AND
QRY_SpeakerIsAvailable(_Player, 0, 1)
THEN
DB_SelectedDialog(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7, S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8, S_DEN_ServantGnome_003_0d971a2f-5fd7-4358-8966-147ed8b106dd, _Player);
PROC_State_Progress(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "CourtDialog");

PROC
PROC_State_Changed(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "CourtDialog")
THEN
SetFlag(DEN_ShadowDruid_State_SnakeCourtStarted_461195aa-0d53-44c3-bc45-3b8bbe59649d, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7, (INTEGER)_Inst)
AND
DB_DEN_ShadowDruid_Snakes(_Snake)
THEN
PROC_DialogAddSpeakingActor(_Inst, _Snake);

IF
DialogEnded(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7, _Inst)
THEN
DB_DEN_ShadowDruid_SnakesCourtHappened(1);
PROC_DEN_ShadowDruid_SnakeCourtSceneEnded();

PROC
PROC_DEN_ShadowDruid_SnakeCourtSceneEnded()
AND
GetFlag(DEN_ShadowDruid_State_KidFreed_8d9e9065-7bb5-a516-15c3-c9d8c1f4f5e2, NULL_00000000-0000-0000-0000-000000000000, _IsFreed)
AND
DB_Negate(_IsFreed, _IsDead)
THEN
NOT DB_DEN_ShadowDruid_KidDied_Internal(1);
DB_DEN_ShadowDruid_KidDied_Internal(_IsDead);
PROC_DEN_ShadowDruid_CourtOutcome(_IsFreed);

//END_REGION
//REGION Snakes Court: Outcome - snake bite

PROC
PROC_DEN_ShadowDruid_CourtOutcome(0)
THEN
PROC_State_Progress(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "SnakeBite");

PROC
PROC_State_Changed(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "SnakeBite")
THEN
PROC_DEN_ShadowDruid_KillKid();

//If grove state changes and we didn't help Arabella, it's too late.
PROC
PROC_DEN_ShadowDruid_KillKid()
AND
DB_State_Current(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", _State)
AND
_State != "DEN_State_Peace"
AND
DB_QuestIsOpened("DEN_SnakeCourt")
THEN
QuestUpdate("DEN_SnakeCourt", "SkippedHelp");

PROC
PROC_DEN_ShadowDruid_KillKid()
THEN
PROC_DEN_SnakeKid_RemoveFromDruidAttack();
SetImmortal(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, 0);
TeleportTo(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,S_DEN_SnakeKidDeadPoint_1d397b23-d7e6-46ee-a2f2-9090a8274b74,"");
Die(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,DEATHTYPE.Physical,S_DEN_Snake_001_af2ff867-467e-4765-a66c-fed091af4a09,1,1);
SetFlag(DEN_ShadowDruid_State_KidDied_5b5de896-e733-47ae-81df-85a4b25ebfd1,NULL_00000000-0000-0000-0000-000000000000); //set in dialog, or here if it didn't reach that node
SetCharacterLootOwned(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, 1);
DB_GLO_CharacterCorpseDialog(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, DEN_General_Dead_SnakeKid_b7ad5d8d-1778-feb3-d4bc-8b2f18f14f98);

PROC
PROC_DEN_ShadowDruid_KillKid()
AND
DB_DEN_NPC(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, _Role, _AttackOnDenDialog)
THEN
NOT DB_DEN_NPC(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, _Role, _AttackOnDenDialog);

PROC
PROC_DEN_SnakeKid_RemoveFromDruidAttack()
THEN
DB_NOOP(1);

IF
DialogEnded(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7, _Inst)
AND
DB_DialogPlayers(_Inst, _Player, 1)
AND
GetFlag(DEN_ShadowDruid_State_KidDied_5b5de896-e733-47ae-81df-85a4b25ebfd1, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
StartVoiceBark((VOICEBARKRESOURCE)DEN_ShadowDruid_VB_KidDied_b36bf8fe-bc57-4659-18ea-6bf2219e24fd, (CHARACTER)_Player);


//END_REGION
//REGION Snakes Court: Outcome - kid freed

PROC
PROC_DEN_ShadowDruid_CourtOutcome(1)
THEN
PROC_State_Progress(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "KidFreed");

PROC
PROC_DEN_ShadowDruid_CourtOutcome(1)
AND
QRY_DEN_CheckPeaceState()
THEN
PROC_CharacterMoveTo(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, S_DEN_LairMainInPoint_195062b4-ff6c-46cc-aae1-961fcf4ecf56, "Run", "DEN_ShadowDruid_KidRanToLairDoor");

PROC
PROC_State_Changed(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_DruidAttack")
AND
DB_GlobalFlag(DEN_ShadowDruid_State_KidFreed_8d9e9065-7bb5-a516-15c3-c9d8c1f4f5e2)
THEN
PROC_ClearStoryMove(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f);  //cancel the move if Druid Attack took over
SetEntityEvent(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_ShadowDruid_KidRanToParent");

PROC
PROC_State_Changed(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "KidFreed")
THEN
PROC_DEN_AddOrUpdateDenNPC((CHARACTER)S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "Hideout", DEN_AttackOnDen_SnakeKid_1d800272-037e-6143-c939-07f2a1dfcc2e);

IF
EntityEvent(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_ShadowDruid_KidRanToLairDoor")
THEN
Use(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, S_DEN_LairMainInDoor_026d20eb-779c-4e49-a6f6-70b2dfe8678b, 1, 0, "DEN_ShadowDruid_KidUsedLairDoor");

IF
EntityEvent(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_ShadowDruid_KidUsedLairDoor")
THEN
PROC_CharacterMoveTo(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, S_DEN_ParentA_d6d88c8b-6ba7-4350-b3b3-d60565a44e90, "Run", "DEN_ShadowDruid_KidRanToParent");
//S_DEN_SnakeKidFreePoint_d320d333-0f37-4cee-865a-78d72391daca

//END_REGION
//REGION Snakes Court: end

PROC
PROC_DEN_ShadowDruid_CourtOutcome((INTEGER)_)
THEN
PROC_DEN_ShadowDruid_CourtSceneEnds();

PROC
PROC_DEN_ShadowDruid_CourtSceneEnds()
AND
QRY_OnlyOnce("DEN_ShadowDruid_SnakeCourtEnds")
THEN
PROC_TriggerUnregisterForPlayers(S_DEN_SnakesCourtStartBox_01d25948-1be8-4cbe-83de-b75b9cb10fed);
PROC_DEN_ShadowDruid_TryReactToScene();
SetFlag(DEN_ShadowDruid_State_SnakesCourtDone_cf58dd01-e058-42b8-b1f1-976250296ce6, NULL_00000000-0000-0000-0000-000000000000);
PROC_DEN_ShadowDruid_SnakesLeave();
PROC_SceneOver("DEN_SnakeCourt");
PROC_State_Progress(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, "DEN_SnakeCourt", "Finished");

PROC
PROC_DEN_ShadowDruid_SnakesLeave()
AND
QRY_OnlyOnce("DEN_ShadowDruid_SnakesLeave")
AND
DB_DEN_ShadowDruid_Snakes(_Snake)
AND
NOT DB_PermaDefeated(_Snake)
THEN
PROC_DisappearOutOfSight(_Snake, "Run", 1, "");


//--- React to death
//people who don't really react
PROC
PROC_DEN_ShadowDruid_TryReactToScene()
AND
DB_SceneManager(_NPC, "DEN_SnakeCourt")
AND
NOT DB_DEN_ShadowDruid_SnakeCourtReactors(_NPC)
THEN
SetFlag(DEN_ShadowDruid_Event_ReactionDone_be576fb3-ba9c-4375-8870-e0f66e6eeb4c, _NPC);

// Kagha and Rath
PROC
PROC_DEN_ShadowDruid_TryReactToScene()
AND
NOT QRY_DEN_ShadowDruid_ReactToDeadKid()
AND
DB_DEN_ShadowDruid_KidDied_Internal(_IsDead)
THEN
NOT DB_DEN_ShadowDruid_KidDied_Internal(_IsDead);
SetFlag(DEN_ShadowDruid_Event_ReactionDone_be576fb3-ba9c-4375-8870-e0f66e6eeb4c, S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d);
SetFlag(DEN_ShadowDruid_Event_ReactionDone_be576fb3-ba9c-4375-8870-e0f66e6eeb4c, S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156);

QRY
QRY_DEN_ShadowDruid_ReactToDeadKid()
AND
DB_DEN_ShadowDruid_KidDied_Internal(1)
AND
DB_GlobalFlag(DEN_ShadowDruid_State_SnakeCourtStarted_461195aa-0d53-44c3-bc45-3b8bbe59649d)
AND
NOT DB_CantTalk(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d)
AND
NOT DB_CantTalk(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156)
AND
QRY_DEN_CheckPeaceState()
AND
QRY_StartDialog(DEN_ShadowDruid_AD_ReactToDeadKid_762ebed6-3c17-a4ae-0915-39de07c2010e, S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156)
THEN
NOT DB_DEN_ShadowDruid_KidDied_Internal(1);

IF
AutomatedDialogEnded(DEN_ShadowDruid_AD_ReactToDeadKid_762ebed6-3c17-a4ae-0915-39de07c2010e,_)
THEN
SetFlag(DEN_ShadowDruid_Event_ReactionDone_be576fb3-ba9c-4375-8870-e0f66e6eeb4c, S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d);
SetFlag(DEN_ShadowDruid_Event_ReactionDone_be576fb3-ba9c-4375-8870-e0f66e6eeb4c, S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156);

IF
AutomatedDialogRequestFailed(DEN_ShadowDruid_AD_ReactToDeadKid_762ebed6-3c17-a4ae-0915-39de07c2010e,_)
THEN
SetFlag(DEN_ShadowDruid_Event_ReactionDone_be576fb3-ba9c-4375-8870-e0f66e6eeb4c, S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d);
SetFlag(DEN_ShadowDruid_Event_ReactionDone_be576fb3-ba9c-4375-8870-e0f66e6eeb4c, S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156);

//END_REGION

//REGION Snake Kid off stage / stop Raths reaction

//--- Main ending, leaving area:
IF
LeftTrigger(_Player, S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29)
AND
DB_Players(_Player)
AND
DB_GlobalFlag(DEN_ShadowDruid_State_KidDied_5b5de896-e733-47ae-81df-85a4b25ebfd1)
AND
NOT DB_OnlyOnce("DEN_ShadowDruid_RemoveKid")
AND
NOT QRY_CheckOtherPlayersInTrigger(NULL_00000000-0000-0000-0000-000000000000,S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29)
AND
IsInTrigger(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29,1) 
THEN
PROC_DEN_ShadowDruid_RemoveChildCorpse();

//kid dying when no players is there (in case of a Grove state change)
IF
FlagSet(DEN_ShadowDruid_State_KidDied_5b5de896-e733-47ae-81df-85a4b25ebfd1, NULL_00000000-0000-0000-0000-000000000000, _)
AND
NOT DB_OnlyOnce("DEN_ShadowDruid_RemoveKid")
AND
NOT QRY_CheckOtherPlayersInTrigger(NULL_00000000-0000-0000-0000-000000000000,S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29)
AND
IsInTrigger(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29,1) 
THEN
PROC_DEN_ShadowDruid_RemoveChildCorpse();

PROC
PROC_DEN_ShadowDruid_KillKid()
AND
NOT DB_OnlyOnce("DEN_ShadowDruid_RemoveKid")
AND
NOT QRY_CheckOtherPlayersInTrigger(NULL_00000000-0000-0000-0000-000000000000,S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29)
THEN
PROC_DEN_ShadowDruid_RemoveChildCorpse();


//Edge-case: looting corpse (stop Rath's reaction)
IF
CharacterLootedCharacter(_, S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f)
AND
DB_GlobalFlag(DEN_ShadowDruid_State_KidDied_5b5de896-e733-47ae-81df-85a4b25ebfd1)
AND
NOT DB_OnlyOnce("DEN_ShadowDruid_RemoveKid")
AND
IsInTrigger(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29,1) 
THEN
SetEntityEvent(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, "DEN_ShadowDruid_StopMourningKid");

//Edge-case: moving corpse (stop Rath's reaction)
IF
OnThrown(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,_,_Player,_,_,_,_)
AND
DB_GlobalFlag(DEN_ShadowDruid_State_KidDied_5b5de896-e733-47ae-81df-85a4b25ebfd1)
AND
NOT DB_OnlyOnce("DEN_ShadowDruid_RemoveKid")
AND
IsInTrigger(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29,1) 
THEN
SetEntityEvent(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, "DEN_ShadowDruid_StopMourningKid");

//Edge-case: grove's state change
PROC
PROC_State_Progress(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211,"DEN",_)
AND
DB_GlobalFlag(DEN_ShadowDruid_State_KidDied_5b5de896-e733-47ae-81df-85a4b25ebfd1)
THEN
SetEntityEvent(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, "DEN_ShadowDruid_StopMourningKid");


//--- Corpse off stage / send to grave
PROC
PROC_DEN_ShadowDruid_RemoveChildCorpse()
AND
QRY_OnlyOnce("DEN_ShadowDruid_RemoveKid")
THEN
SetCharacterLootOwned(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, 0);
SetEntityEvent(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, "DEN_ShadowDruid_StopMourningKid");
SetOnStage(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,0);
CreateSurface(S_DEN_SnakeKidDeadPoint_1d397b23-d7e6-46ee-a2f2-9090a8274b74,"SurfaceNone",2.0,1.0); //remove the blood
DB_DEN_ShadowDruid_ReadyToBuryKid(1);

IF
DB_DEN_ShadowDruid_ReadyToBuryKid(1)
AND
NOT DB_DEN_PlayerInDen(_)
THEN
NOT DB_DEN_ShadowDruid_ReadyToBuryKid(1);
PROC_DEN_ShadowDruid_BuryChild();

PROC
PROC_DEN_ShadowDruid_BuryChild()
THEN
//DB_DEN_GraveQueue(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f);
DB_NOOP(1);


//END_REGION

//REGION Hostility / DruidAttack hook

PROC
PROC_ReportKiller((CHARACTER)_, (CHARACTER)_, (CHARACTER)S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, (GUIDSTRING)_ReportID)
THEN
SetFlag((FLAG)_ReportID, NULL_00000000-0000-0000-0000-000000000000, 0);
NOT DB_ReportKiller(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, _ReportID);

PROC
PROC_FlagReactionAfterDialog(_Player, DEN_ShadowDruid_State_CourtHostile_b79f3102-f47e-339c-23f2-1de2c38d4e6e)
THEN
DB_DEN_Conflict_Murder_AttackedKagha(1); //This is for the entry Murder_DAStarted (see in Act1_DEN_Journal)
PROC_DEN_DruidAttack_TryStart(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, (CHARACTER)_Player);

//END_REGION

//REGION Druids self-reflection & hint

//Self-reflection after talking to Kagha
IF
DialogEnded(DEN_ShadowDruid_Leader_44569c62-70e8-28bc-7cec-fdf051daa339, _Inst)
AND
GetFlag(DEN_ShadowDruid_Event_StartDenouncingScene_e01769d4-9ac4-17a0-584e-ceb26e4bc384, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
DB_DialogPlayers(_Inst, _Player, 1)
AND
GetFlag(DEN_ShadowDruid_State_CourtHostile_b79f3102-f47e-339c-23f2-1de2c38d4e6e, _Player, 0)
THEN
PROC_DEN_ShadowDruid_TrySelfReflection(_Inst);

IF
DialogEnded(DEN_ShadowDruid_Leader_44569c62-70e8-28bc-7cec-fdf051daa339, _Inst)
AND
GetFlag(DEN_ShadowDruid_Event_StartDenouncingScene_e01769d4-9ac4-17a0-584e-ceb26e4bc384, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_DialogPlayers(_Inst, _Player, 1)
AND
GetFlag(DEN_ShadowDruid_State_CourtHostile_b79f3102-f47e-339c-23f2-1de2c38d4e6e, _Player, 0)
THEN
PROC_DEN_ShadowDruid_CheckDenouncingSceneQueued(_Inst);

//Do nothing the first time, as denouncing dialog would start.
PROC
PROC_DEN_ShadowDruid_CheckDenouncingSceneQueued((INTEGER)_Inst)
AND
NOT DB_OnlyOnce("DEN_ShadowDruid_DenouncingSceneQueued")
THEN
DB_OnlyOnce("DEN_ShadowDruid_DenouncingSceneQueued");

PROC
PROC_DEN_ShadowDruid_TrySelfReflection((INTEGER)_Inst)
AND
NOT DB_GlobalFlag(DEN_ShadowDruid_State_HadSelfReflection_a630c178-dae8-ae3f-f4be-0c81587208ad)
AND
NOT DB_GlobalFlag(DEN_ShadowDruid_Knows_MeetingLocation_a8b8b540-e0d5-4c21-9de1-949de855f094)
AND
NOT DB_GlobalFlag(DEN_ShadowDruid_Knows_RecruitmentLetter_587f1e08-f890-4740-a588-e76778143fec)
AND
NOT DB_GlobalFlag(DEN_DruidAttack_State_DruidSetup_96fc1420-fa07-4235-98c3-ecb34fcb6b0a)
AND
DB_DialogPlayers(_Inst, _Player, 1)
AND
NOT DB_Defeated(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156)
AND
IsTagged(_Player, DRUID_44ac4317-4d38-4d28-80e2-94024c6e42f0, 1)
AND
GetFlag(DEN_ShadowDruid_Knows_KaghaExplainedRite_79678e1b-2002-b357-1ebb-b3f059d1643c, _Player, 1)
AND
QRY_StartDialog_Fixed(DEN_ShadowDruid_SelfReflection_e5c96d60-1e7a-af4e-0e82-28165eefb9dd, _Player)
THEN
DB_NOOP(1);

//Approaching the hidden chest (anyone in the party is fine since the quest is shared)
IF
FlagSet(DEN_ShadowDruid_State_HadSelfReflection_a630c178-dae8-ae3f-f4be-0c81587208ad, _, _)
AND
NOT DB_DEN_ShadowDruid_FoundChest(1)
THEN
PROC_TriggerRegisterForPlayers(S_DEN_DruidChestHintBox_0fb540c7-f96b-4f14-a139-36540ddd270f);

IF
EnteredTrigger(_Player,S_DEN_DruidChestHintBox_0fb540c7-f96b-4f14-a139-36540ddd270f)
THEN
PROC_KnowledgeCheck_MP((CHARACTER)_Player, "GLO_HiddenItemCheck", S_DEN_DruidChestHintBox_0fb540c7-f96b-4f14-a139-36540ddd270f,"Perception",(DIFFICULTYCLASS)DC_Legacy_10_625be976-7a67-4394-97c8-14c69715ae4b,GLO_PerceptionSuccess_48825dbe-a320-7c4c-fe3e-372b717d5bc9,DEN_ShadowDruid_Knows_SpottedChest_e3af9709-a489-480a-a76c-4c347bb1ae8a);

IF
FlagSet(DEN_ShadowDruid_Knows_SpottedChest_e3af9709-a489-480a-a76c-4c347bb1ae8a, _, _)
THEN
PROC_PlayPerceptionRevealEffect(S_DEN_DruidLeaderChest_07033dbc-6e28-4d56-8134-c6ca530cde37, "DEN_ShadowDruid_HiddenChest");
PROC_TriggerUnregisterForPlayers(S_DEN_DruidChestHintBox_0fb540c7-f96b-4f14-a139-36540ddd270f);

IF
UseStarted(_, S_DEN_DruidLeaderChest_07033dbc-6e28-4d56-8134-c6ca530cde37)
THEN
DB_DEN_ShadowDruid_FoundChest(1);
PROC_TriggerUnregisterForPlayers(S_DEN_DruidChestHintBox_0fb540c7-f96b-4f14-a139-36540ddd270f);

IF
Moved(S_DEN_DruidLeaderChest_07033dbc-6e28-4d56-8134-c6ca530cde37)
THEN
DB_DEN_ShadowDruid_FoundChest(1);
PROC_TriggerUnregisterForPlayers(S_DEN_DruidChestHintBox_0fb540c7-f96b-4f14-a139-36540ddd270f);

IF
UsingSpellOnTarget(_, S_DEN_DruidLeaderChest_07033dbc-6e28-4d56-8134-c6ca530cde37,_,_,_,_)
THEN
DB_DEN_ShadowDruid_FoundChest(1);
PROC_TriggerUnregisterForPlayers(S_DEN_DruidChestHintBox_0fb540c7-f96b-4f14-a139-36540ddd270f);

//END_REGION
//REGION Letter & note

// Knowing who Kagha is (met her)
IF
DialogStarted(_, _Inst)
AND
DB_DialogNPCs(_Inst, S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, _)
AND
DB_DialogPlayers(_Inst, _, 1) //any player in that dialog
THEN
SetFlag(DEN_ShadowDruid_Knows_SawKagha_0834f728-8a95-45c7-88c3-268befd20a65, NULL_00000000-0000-0000-0000-000000000000);


// The note leading to the letter (in her chest in the grove)
PROC
PROC_BookFlags_FlagSet((ITEM)S_DEN_ShadowMeetingNote_fbe59587-8dec-440c-94d2-2748727c4cf5,(FLAG)DEN_ShadowDruid_Knows_MeetingLocation_a8b8b540-e0d5-4c21-9de1-949de855f094,(CHARACTER)_Reader)
THEN
DebugText(_Reader, "Map marker on the secret location");


// The tree hidding the letter
IF
EnteredTrigger(_Player,S_HAG_ShadowTreeSphere_692f6baa-8e34-4474-9afa-96421fb6c294)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag(DEN_ShadowDruid_State_DetectedTree_e198c7f7-1068-4346-9136-450e82db41a5)
AND
GetFlag(DEN_ShadowDruid_Knows_MeetingLocation_a8b8b540-e0d5-4c21-9de1-949de855f094, NULL_00000000-0000-0000-0000-000000000000, _AutoDetect)
THEN
PROC_DEN_ShadowDruid_CheckSpotTree(_Player, _AutoDetect);

PROC
PROC_DEN_ShadowDruid_CheckSpotTree((CHARACTER)_Player, 0)
AND
DB_Players(_NearbyPlayer)
AND
NOT DB_DEN_ShadowDruid_DetectTreeFailed(_NearbyPlayer)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player,_NearbyPlayer)
THEN
PROC_TrySkillCheck((CHARACTER)_NearbyPlayer,S_HAG_ShadowTreeSphere_692f6baa-8e34-4474-9afa-96421fb6c294,"Perception",(DIFFICULTYCLASS)Act1_Hard_831e1fbe-428d-4f4d-bd17-4206d6efea35,"HAG_ShadowTree_Detect");

PROC
PROC_RollResult("HAG_ShadowTree_Detect", _Player, _, 0)
AND
NOT DB_GlobalFlag(DEN_ShadowDruid_State_DetectedTree_e198c7f7-1068-4346-9136-450e82db41a5)
THEN
DB_DEN_ShadowDruid_DetectTreeFailed(_Player);

PROC
PROC_RollResult("HAG_ShadowTree_Detect", _Player, _, 1)
THEN
PROC_DEN_ShadowDruid_CheckSpotTree(_Player, 1);

PROC
PROC_DEN_ShadowDruid_CheckSpotTree((CHARACTER)_Player, 1)
AND
NOT DB_GlobalFlag(DEN_ShadowDruid_State_DetectedTree_e198c7f7-1068-4346-9136-450e82db41a5)
THEN
PROC_GlobalSetFlagAndCache(DEN_ShadowDruid_State_DetectedTree_e198c7f7-1068-4346-9136-450e82db41a5);
SetCanInteract(S_HAG_ShadowTree_30fe7685-0a91-45af-bcfc-9e68a985927a, 1);
PROC_TriggerUnregisterForPlayers(S_HAG_ShadowTreeSphere_692f6baa-8e34-4474-9afa-96421fb6c294);
PROC_PlayPerceptionRevealEffect((ITEM)S_HAG_ShadowTree_30fe7685-0a91-45af-bcfc-9e68a985927a, "HAG_ShadowTree_Detect", 18);
StartVoiceBark(DEN_ShadowDruid_VB_FoundSecretLocation_9f2f4255-cc68-28a9-73da-0b23f2e33cb9, _Player);

PROC
PROC_DEN_ShadowDruid_CheckSpotTree((CHARACTER)_, 1)
AND
DB_DEN_ShadowDruid_DetectTreeFailed(_Player)
THEN
NOT DB_DEN_ShadowDruid_DetectTreeFailed(_Player);


// The incriminating letter (found in the swamp)
IF
GameBookInterfaceClosed((ITEM)S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c, _Player)
AND
DB_State_Current(_, "DEN", "DEN_State_Peace")
AND
NOT DB_GlobalFlag(DEN_ShadowDruid_Knows_RecruitmentLetter_587f1e08-f890-4740-a588-e76778143fec)
AND
NOT DB_PermaDefeated(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156)
AND
GetDistanceTo(_Player, S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, _Dist)
AND
_Dist > 10.0
THEN
StartVoiceBark(DEN_ShadowDruid_VB_FoundRecruitmentLetter_be0a507d-5b16-a84f-2e4d-baf857c27fa4, _Player);

IF
GameBookInterfaceClosed((ITEM)S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c, _Player)
AND
DB_State_Current(_, "DEN", "DEN_State_Peace")
AND
NOT DB_GlobalFlag(DEN_ShadowDruid_Knows_RecruitmentLetter_587f1e08-f890-4740-a588-e76778143fec)
AND
NOT DB_PermaDefeated(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156)
THEN
QuestUpdate(_Player,"DEN_Conflict", "FoundLetterFirst");

IF
GameBookInterfaceClosed((ITEM)S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c, _Player)
AND
DB_State_Current(_, "DEN", "DEN_State_Peace")
AND
DB_GlobalFlag(DEN_ShadowDruid_Knows_RecruitmentLetter_587f1e08-f890-4740-a588-e76778143fec)
AND
NOT DB_PermaDefeated(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156)
THEN
QuestUpdate(_Player,"DEN_Conflict", "FoundLetterAfterNote");

PROC
PROC_BookFlags_FlagSet((ITEM)S_DEN_ShadowDruidsLetter_b0da8ce3-139f-425b-bbce-ae67663b8a2c,(FLAG)DEN_ShadowDruid_Knows_RecruitmentLetter_587f1e08-f890-4740-a588-e76778143fec,(CHARACTER)_Reader)
THEN
DebugText(_Reader, "Quest update");

//END_REGION

//REGION Denouncing: Start

//--- Findal's edge-case
IF
FlagSet(DEN_GoblinScouts_Event_Freed_f5dea723-db2a-4e0f-9082-ba9ebc5ef8aa, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
DB_DEN_ShadowDruid_DenouncingNPCs(S_DEN_ScoutCaptive_f5b5819f-1636-4f2e-82bb-709522cc399f);


//--- Scene starts
IF
FlagSet(DEN_ShadowDruid_Event_StartDenouncingScene_e01769d4-9ac4-17a0-584e-ceb26e4bc384, NULL_00000000-0000-0000-0000-000000000000, _Inst)
AND
DB_DialogPlayers(_Inst,_Player,_)
THEN
//DB_DEN_ShadowDruid_Denouncer((CHARACTER)_Player);
PROC_State_Progress(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_RitualStopped");

PROC
PROC_State_Changed(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_RitualStopped")
THEN
SetFlag(DEN_ShadowDruid_State_DenouncingInProgress_3143a5ba-c508-4a32-a2f1-8091731d83e0,NULL_00000000-0000-0000-0000-000000000000);
ClearOwnership(S_DEN_DruidDormitoryDoor_e762551e-ccce-495a-9995-bb7d6b8a592b);
DB_DEN_ShadowDruid_DenouncingOutcomes(1, "LeaderPersuaded");
DB_DEN_ShadowDruid_DenouncingOutcomes(0, "LeaderHostile");
//new dialogs
DB_DEN_ShadowDruid_PacifiedDialogs((GUIDSTRING)S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156,(DIALOGRESOURCE)DEN_ShadowDruid_LeaderPersuaded_e66c2f8b-2c9f-35a1-6564-1aa0fc08a020);
//optional speakers
DB_DEN_ShadowDruid_DenouncingExtras(S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8);
DB_DEN_ShadowDruid_DenouncingExtras(S_DEN_ServantGnome_003_0d971a2f-5fd7-4358-8966-147ed8b106dd);
DB_DEN_ShadowDruid_DenouncingExtras(S_DEN_ScoutCaptive_f5b5819f-1636-4f2e-82bb-709522cc399f);
DB_DEN_ShadowDruid_DenouncingExtras(S_DEN_ShadowDruid_002_0820c093-f400-4efc-95b9-a6d08a58cac9);
DB_DEN_ShadowDruid_DenouncingExtras(S_DEN_ShadowDruid_003_53b08334-9f79-4bb5-b580-2662355d54ad);
//flags for optional
DB_DEN_ShadowDruid_OptionalDruids(S_DEN_ServantGnome_003_0d971a2f-5fd7-4358-8966-147ed8b106dd, (FLAG)DEN_ShadowDruid_State_DenouncingWithLoic_ab24cd39-f8aa-6044-2e4e-c5200b343028);
DB_DEN_ShadowDruid_OptionalDruids(S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8, (FLAG)DEN_ShadowDruid_State_DenouncingWithMarcoryl_d2c1d4da-ff77-6e9c-5441-3a3d12f047ba);
DB_DEN_ShadowDruid_OptionalDruids(S_DEN_ScoutCaptive_f5b5819f-1636-4f2e-82bb-709522cc399f, (FLAG)DEN_ShadowDruid_State_DenouncingWithFindal_6f6ff79b-6386-e31d-9fa1-d61bd209f3b0);
//main outcome = shadow druids turn hostile
DB_DEN_ShadowDruids(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156);
DB_DEN_ShadowDruids(S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8);
DB_DEN_ShadowDruids(S_DEN_ServantPatrolling_0d971a2f-5fd7-4358-8966-147ed8b106dd);
//setup scene
PROC_DEN_ShadowDruid_SetupSceneManager();
//setup sates
DB_State_Current(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Start");
DB_State_Priority(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Start", 0);
DB_State_Priority(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Moving", 100);
DB_State_Priority(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Confronting", 200);
DB_State_Priority(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "LeaderHostile", 300);
DB_State_Priority(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "LeaderPersuaded", 350);
DB_State_Priority(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Hostile", 400);
DB_State_Priority(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Finished", 500);

PROC
PROC_State_Changed(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_RitualStopped")
AND
DB_DEN_ShadowDruid_Originals(_Druid)
THEN
PROC_SetCanFight(_Druid, 1);
SetCanJoinCombat(_Druid, 1);

PROC
PROC_DEN_ShadowDruid_SetupSceneManager()
AND
DB_DEN_ShadowDruid_DenouncingNPCs(_NPC)
AND
NOT DB_Defeated(_NPC)
THEN
DB_SceneManager(_NPC,"DEN_Denouncing");


//--- Dialog starts
IF
DialogEnded(DEN_ShadowDruid_Leader_44569c62-70e8-28bc-7cec-fdf051daa339, _Inst)
AND
GetFlag(DEN_ShadowDruid_Event_StartDenouncingScene_e01769d4-9ac4-17a0-584e-ceb26e4bc384, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_State_Current(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Start")
AND
DB_DialogPlayers(_Inst,_Player,1)
THEN
PROC_State_Progress(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Moving");
PROC_DEN_ShadowDruid_DenouncingStarts(_Player);

//END_REGION
//REGION Denouncing: dialog starts

PROC
PROC_DEN_ShadowDruid_DenouncingStarts((GUIDSTRING)_Player)
AND
NOT QRY_StartDialogCustom_Fixed(DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443, 
	S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156,
	S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, 
	S_DEN_ShadowDruid_001_0cb92c37-fb4d-4547-8702-1fb1dd52d0b6, 
	_Player, 0, 0, 1, 1)
THEN
PROC_DEN_ShadowDruid_DenouncingAutoStartFailed();

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443, (INTEGER)_Inst)
AND
DB_DEN_ShadowDruid_DenouncingExtras(_NPC)
AND
NOT DB_Defeated(_NPC)
AND
IsInTrigger(_NPC, S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29, 1) //TODO: refine to be a more accurate proximity check
THEN
PROC_ForceStopDialog(_NPC);
SetFlag(DEN_ShadowDruid_State_IsDenouncing_a9fb84af-744d-4f4f-b0bc-a3fc93ae8abb, _NPC);
PROC_DialogAddSpeakingActor(_Inst, _NPC);

IF
DialogStarted(DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443, _Inst)
THEN
SetFlag(DEN_ShadowDruid_State_DenouncingSceneInProgress_a9e1b188-80a7-4432-86b2-129c7623cb16, NULL_00000000-0000-0000-0000-000000000000);

IF
DialogStarted(DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443, _Inst)
AND
DB_DialogPlayers(_Inst, _Player, 1)
AND
IsTagged(_Player, DRUID_44ac4317-4d38-4d28-80e2-94024c6e42f0, 1)
THEN
DB_DEN_ShadowDruid_DruidDenouncer(_Player);

IF
DialogActorJoined(DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443, _Inst, _NPC, _)
AND
DB_DEN_ShadowDruid_OptionalDruids(_NPC, _Flag)
THEN
SetFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000);

IF
DialogStarted(DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443, _Inst)
THEN
PROC_State_Progress(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Confronting");


// auto-start failed (could replace by basic behaviour and wait for player to click)
PROC
PROC_DEN_ShadowDruid_DenouncingAutoStartFailed()
THEN
PROC_DEN_ShadowDruid_DenouncingDialogEnded();

// Player clicks on a NPC to starts it //might be deprecated or very edge-casy
QRY
QRY_SelectCustomDialog((GUIDSTRING)_NPC, (GUIDSTRING)_Player)
AND
DB_Players((CHARACTER)_Player)
AND
DB_SceneManager((CHARACTER)_NPC, "DEN_Denouncing")
AND
DB_State_Current(_, "DEN_Denouncing", "Moving")
AND
QRY_SpeakerIsAvailable(_Player)
THEN
DB_SelectedDialog(DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443, 
	S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, 
	S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, 
	S_DEN_ShadowDruid_001_0cb92c37-fb4d-4547-8702-1fb1dd52d0b6, 
	_Player); //TODO: dead edge-case, etc.
PROC_State_Progress(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Confronting");

//END_REGION
//REGION Denouncing: end denouncing, split outcomes

IF
FlagSet(DEN_ShadowDruid_Event_KaghaTurnedGood_f2de839d-b971-86ee-f02c-5e09174ce919, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
NOT DB_DEN_ShadowDruids(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156);
NOT DB_DEN_ShadowDruids(S_DEN_ServantIntolerant_002_6f36c7a1-edfd-4e99-bd90-6d874f68c9b8);
NOT DB_DEN_ShadowDruids(S_DEN_ServantPatrolling_0d971a2f-5fd7-4358-8966-147ed8b106dd);
PROC_State_Progress(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "LeaderPersuaded");

IF
DialogEnded(DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443,_)
THEN
PROC_DEN_ShadowDruid_DenouncingDialogEnded();

PROC
PROC_DEN_ShadowDruid_DenouncingDialogEnded()
AND
GetFlag(DEN_ShadowDruid_Event_KaghaTurnedGood_f2de839d-b971-86ee-f02c-5e09174ce919, NULL_00000000-0000-0000-0000-000000000000, _IsPersuaded)
AND
DB_DEN_ShadowDruid_DenouncingOutcomes(_IsPersuaded, _StateProgress)
THEN
SetFlag(DEN_GroveConflict_State_DruidsPacified_0f747b55-d68d-436f-ac33-9fecaf30387d, NULL_00000000-0000-0000-0000-000000000000);
PROC_State_Progress(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", _StateProgress);
PROC_DEN_ShadowDruid_DenouncingPrepCombat();
PROC_DEN_GroveConflict_SDCombat_JournalHook(_IsPersuaded);

PROC
PROC_DEN_ShadowDruid_DenouncingPrepCombat()
AND
DB_DEN_ShadowDruids(_ShadowDruid)
AND
NOT DB_Defeated(_ShadowDruid)
THEN
DB_GLO_DefeatCounter(_ShadowDruid, "DEN_ShadowDruid_DenouncingDefeatCounter");

PROC
PROC_DEN_ShadowDruid_DenouncingPrepCombat()
THEN
SetTag(S_DEN_PetWolf_63471e30-7413-4496-97de-0bdf67c2f753,AI_UNPREFERRED_TARGET_9787450d-f34d-43bd-be88-d2bac00bb8ee);
SetTag(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d,AI_UNPREFERRED_TARGET_9787450d-f34d-43bd-be88-d2bac00bb8ee);

PROC
PROC_DEN_ShadowDruid_DenouncingPrepCombat()
AND
DB_DEN_ShadowDruid_DenouncingNPCs(_Character)
AND
NOT DB_DEN_ShadowDruids(_Character)
AND
NOT DB_PermaDefeated(_Character)
THEN
SetFaction(_Character, ACT1_DEN_ShadowDruid_PlayerAlly_7af438aa-13a7-4ef0-ab77-f6f9e8abaf66);

IF
DialogEnded(DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443,_)
AND
DB_DEN_ShadowDruids(_NPC)
AND
NOT DB_PermaDefeated(_NPC)
THEN
SetFaction(_NPC, (FACTION)ACT1_DEN_ShadowDruid_Hostile_89b57c7d-8a44-49bf-8def-1c42f5513b5a);
//TODO: fix Silver's faction! 

IF
DialogEnded(DEN_ShadowDruid_Denouncing_0e60d16a-0cdb-0704-e703-7943f3356443,_)
AND
DB_DEN_ShadowDruid_PacifiedDialogs(_NPC, _Dialog)
AND
NOT DB_PermaDefeated(_NPC)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_NPC);
DB_Dialogs(_NPC, _Dialog);

//END_REGION
//REGION Denouncing: outcome - LeaderPersuaded

PROC
PROC_State_Changed(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "LeaderPersuaded")
THEN
PROC_DEN_ShadowDruid_KaghaTurnedGood_JournalHook();

PROC
PROC_DEN_ShadowDruid_KaghaTurnedGood_JournalHook()
THEN
DB_NOOP(1);

//END_REGION
//REGION Denouncing: outcome - LeaderHostile
IF
AutomatedDialogStarted(DEN_ShadowDruid_AD_KaghaInCombat_45107382-8f6f-39e6-288c-aa7668ca83f2, _)
AND
DB_DEN_ShadowDruid_KaghaCombatADCount(_OldCount)
AND
_OldCount < 3
AND
IntegerSum(_OldCount, 1, _NewCount)
THEN
NOT DB_DEN_ShadowDruid_KaghaCombatADCount(_OldCount);
DB_DEN_ShadowDruid_KaghaCombatADCount(_NewCount);
DB_CombatReact_AD_OnNextTurn(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156,(DIALOGRESOURCE)DEN_ShadowDruid_AD_KaghaInCombat_45107382-8f6f-39e6-288c-aa7668ca83f2);

PROC
PROC_State_Changed(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "LeaderHostile")
THEN
DB_CombatReact_AD_OnNextTurn(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156,(DIALOGRESOURCE)DEN_ShadowDruid_AD_KaghaInCombat_45107382-8f6f-39e6-288c-aa7668ca83f2);
DB_DEN_ShadowDruid_SetKaghaKilled(1);

IF
DB_PermaDefeated(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156)
AND
DB_DEN_ShadowDruid_SetKaghaKilled(1)
THEN
SetFlag(DEN_ShadowDruid_State_KaghaKilled_fbf50ed0-6ebb-4306-bc5a-0a94e0a1c593, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION
//REGION Denouncing: combat ended

PROC
PROC_GLO_DefeatCounter_AllDefeated("DEN_ShadowDruid_DenouncingDefeatCounter")
THEN
ClearFlag(DEN_ShadowDruid_State_DenouncingSceneInProgress_a9e1b188-80a7-4432-86b2-129c7623cb16, NULL_00000000-0000-0000-0000-000000000000);
ClearTag(S_DEN_PetWolf_63471e30-7413-4496-97de-0bdf67c2f753,AI_UNPREFERRED_TARGET_9787450d-f34d-43bd-be88-d2bac00bb8ee);
ClearTag(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d,AI_UNPREFERRED_TARGET_9787450d-f34d-43bd-be88-d2bac00bb8ee);
PROC_DEN_ShadowDruid_FightEnded_JournalHook();
PROC_State_Progress(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, "DEN_Denouncing", "Finished");
PROC_SceneOver("DEN_Denouncing");
PROC_DEN_ShadowDruid_InitDruidReward();

PROC
PROC_GLO_DefeatCounter_AllDefeated("DEN_ShadowDruid_DenouncingDefeatCounter")
AND
NOT DB_GlobalFlag(DEN_AttackOnDen_Event_Start_c641da6a-b3f5-4873-bd34-c53768d30d6f)
AND
DB_DEN_ShadowDruid_DenouncingNPCs(_Character)
AND
NOT DB_DEN_ShadowDruids(_Character)
AND
NOT DB_PermaDefeated(_Character)
THEN
SetFaction(_Character, ACT1_DEN_Apprentice_4565e710-476b-6f86-1f7b-0ca50a6045c7);

PROC
PROC_DEN_ShadowDruid_FightEnded_JournalHook()
THEN
DB_NOOP(1);

//END_REGION

//REGION Faithwarden tag & reward

//--- Setting up who gives the reward / delaying after the combat
PROC
PROC_DEN_ShadowDruid_InitDruidReward()
AND
DB_DEN_ShadowDruid_DruidDenouncer(_Player)
THEN
ObjectTimerLaunch(_Player, "DEN_ShadowDruid_DruidReward", 4000);

PROC
PROC_DEN_ShadowDruid_InitDruidReward()
THEN
DB_DEN_ShadowDruid_FaithwardenRewarder(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, (DIALOGRESOURCE)DEN_ShadowDruid_LeaderPersuaded_e66c2f8b-2c9f-35a1-6564-1aa0fc08a020);

IF
DB_DEN_ShadowDruid_FaithwardenRewarder(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, DEN_ShadowDruid_LeaderPersuaded_e66c2f8b-2c9f-35a1-6564-1aa0fc08a020)
AND
DB_Defeated(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156)
THEN
NOT DB_DEN_ShadowDruid_FaithwardenRewarder(S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, DEN_ShadowDruid_LeaderPersuaded_e66c2f8b-2c9f-35a1-6564-1aa0fc08a020);
DB_DEN_ShadowDruid_FaithwardenRewarder(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, (DIALOGRESOURCE)DEN_ShadowDruid_OpposedFaithwarden_2838438c-f376-40cf-fc64-8b3dcb64c4a6);

IF
DB_DEN_ShadowDruid_FaithwardenRewarder(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, DEN_ShadowDruid_OpposedFaithwarden_2838438c-f376-40cf-fc64-8b3dcb64c4a6)
AND
DB_Defeated(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d)
THEN
PROC_DEN_ShadowDruid_FaithwardenRewardCleanup();


//--- Move to and talk
IF
ObjectTimerFinished((CHARACTER)_Player, "DEN_ShadowDruid_DruidReward")
THEN
TriggerRegisterForCharacter(S_DEN_DruidFaithwardenSphere_e278fa41-52e8-4625-b8f4-d99f234f524d, _Player);

IF
EnteredTrigger(_Player, S_DEN_DruidFaithwardenSphere_e278fa41-52e8-4625-b8f4-d99f234f524d)
AND
DB_DEN_ShadowDruid_DruidDenouncer(_Player)
AND
DB_DEN_ShadowDruid_FaithwardenRewarder(_, _)
AND
QRY_DEN_ShadowDruid_TryGiveReward(_Player)
THEN
DB_NOOP(1);

QRY
QRY_DEN_ShadowDruid_TryGiveReward((CHARACTER)_Player)
AND
NOT DB_Defeated(_Player)
AND
NOT DB_CantTalk(_Player)
AND
DB_DEN_ShadowDruid_FaithwardenRewarder(_Druid, _Dialog)
THEN
PROC_CharacterMoveToAndTalk((CHARACTER)_Druid, _Player, (DIALOGRESOURCE)_Dialog, "DEN_ShadowDruid_FaithwardenReward", "Stroll", 8.0, 0, 0, 0);


//--- Gives reward
QRY
QRY_SelectCustomDialog(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d,(GUIDSTRING)_Player) //kagha is using her default dialog, so she doesn't need this check
AND
DB_DEN_ShadowDruid_FaithwardenRewarder(S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, _Dialog)
AND
IsTagged(_Player, DRUID_44ac4317-4d38-4d28-80e2-94024c6e42f0, 1)
THEN
DB_SelectedDialog(_Dialog, S_DEN_DruidOpposed_322cf8d2-32ee-453f-987e-f12b32652b5d, _Player);

PROC
PROC_DialogFlagSetup((DIALOGRESOURCE)_Dialog,(GUIDSTRING)_Druid,(GUIDSTRING)_Player) //allows any druid to click on them and get the reward
AND
DB_DEN_ShadowDruid_FaithwardenRewarder(_Druid, _Dialog)
AND
IsTagged(_Player, DRUID_44ac4317-4d38-4d28-80e2-94024c6e42f0, 1)
THEN
SetFlag(DEN_ShadowDruid_Event_DeservesFaithwardenReward_280547cc-008c-4f3e-885b-e160946f2f14, _Player);

IF
FlagSet(DEN_ShadowDruid_Event_SetFaithwarden_d8451137-e2a7-247a-1bc2-758ad990255f,NULL_00000000-0000-0000-0000-000000000000,_Inst)
AND
DB_DialogPlayers(_Inst,  _Player, 1)
THEN
PROC_ToInventoryAndOnStage(S_DEN_FaithwardenStaff_5de75000-9141-466b-9019-70df488b2958, _Player, 1, 1, 1);
SetTag(_Player, ACT1_DEN_FAITHWARDEN_cd873546-4158-4d9a-9c87-958ea63a1b08);
PROC_DEN_ShadowDruid_FaithwardenRewardCleanup();

PROC
PROC_State_Changed(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_RitualStopped", (STRING)_)
THEN
PROC_DEN_ShadowDruid_FaithwardenRewardCleanup();

PROC
PROC_DEN_ShadowDruid_FaithwardenRewardCleanup()
AND
DB_DEN_ShadowDruid_DruidDenouncer(_Player)
THEN
NOT DB_DEN_ShadowDruid_DruidDenouncer(_Player);
TriggerUnregisterForCharacter(S_DEN_DruidFaithwardenSphere_e278fa41-52e8-4625-b8f4-d99f234f524d, (CHARACTER)_PlayeR);

PROC
PROC_DEN_ShadowDruid_FaithwardenRewardCleanup()
AND
DB_DEN_ShadowDruid_FaithwardenRewarder(_Druid, _Dialog)
THEN
NOT DB_DEN_ShadowDruid_FaithwardenRewarder(_Druid, _Dialog);

//END_REGION

//REGION Parents scene

//This scene happens in CAMP when both parents are alive and the kid is dead.
//See Act1_CAMP_GoblinHuntCelebration


//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
