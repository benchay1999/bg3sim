Version 1
SubGoalCombiner SGC_AND
INITSECTION
ApplyStatus(S_WLD_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_OWLBEAR_INJURY",-1.0,1);
PROC_SetHitpointsPercentage_BlockSelfHealing(S_WLD_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,90.0);

PROC_TriggerRegisterForPlayers(S_FOR_OwlBear_LeaveAreaTrigger_beef9aac-fda9-4bc1-baad-2b2f974ba61e);
PROC_TriggerRegisterForPlayers(S_FOR_Owlbear_VbTrigger_0aa2efc9-663f-40e2-ac8d-6364054f3f50);
PROC_DeclareCounter("FOR_OwlBear_LeaveAreaTrigger_Counter");
DB_AutoSaveTrigger(S_FOR_OwlBear_SUB_1fa871e1-4979-4259-9e5e-5017b06d077f);

DB_SpotPlayers((CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_Owlbear_Hostile",(FLAG)NULL_00000000-0000-0000-0000-000000000000,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_Owlbear_Hostile",(FLAG)NULL_00000000-0000-0000-0000-000000000000,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous((CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_Owlbear_Hostile");
DB_SpotPlayers_Continuous((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_Owlbear_Hostile");
DB_SpotPlayers_SpotTrigger((CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_Owlbear_Hostile",(TRIGGER)S_FOR_OwlBear_HostilityTrigger_db2fa4cc-243f-476a-af4b-652e5dbc6893);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_Owlbear_Hostile",(TRIGGER)S_FOR_OwlBear_HostilityTrigger_db2fa4cc-243f-476a-af4b-652e5dbc6893);
DB_SpotPlayers_TargetIgnoreCantTalk(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_Owlbear_Hostile");
DB_SpotPlayers_TargetIgnoreCantTalk(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_Owlbear_Hostile");
DB_SpotPlayers_IncludeWildshapedPlayers(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_Owlbear_Hostile");
DB_SpotPlayers_IncludeWildshapedPlayers(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_Owlbear_Hostile");
DB_SpotPlayers_IncludeFollowers(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_Owlbear_Hostile");
DB_SpotPlayers_IncludeFollowers(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_Owlbear_Hostile");
DB_SpotPlayers_IncludeSummons(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_Owlbear_Hostile");
DB_SpotPlayers_IncludeSummons(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_Owlbear_Hostile");

DB_FOR_OwlBears((CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08);
DB_FOR_OwlBears(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);

DB_FOR_OwlBear_GoblinCubnappers((CHARACTER)S_FOR_Owlbear_Cubnapper_01_Dead_7bfcdc8d-4916-4e8c-8683-a2462950231f);
DB_FOR_OwlBear_GoblinCubnappers(S_FOR_Owlbear_Cubnapper_02_Dead_3dff646d-4631-49da-b799-35f2572a5c7f);
DB_FOR_OwlBear_GoblinCubnappers(S_FOR_Owlbear_Cubnapper_03_Dead_43172e6e-ad91-41ea-bf3b-332f269af436);
DB_FOR_OwlBear_GoblinCubnappers(S_FOR_Owlbear_Cubnapper_04_Dead_e66c151c-3d1c-42d5-b816-1b9700eb7a21);

DB_NoLowAttitudeDialog((CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08);
DB_NoLowAttitudeDialog((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);

DB_KnowledgeCheckTrigger_AD("FOR_Owlbear_HatchedEggs_Recognised",S_FOR_Owlbear_HatchedEggs_SkillCheck_e4ce70aa-6b95-4c29-b365-20275261cd17,"Survival",Act1_VeryEasy_8d398021-34e0-40b9-b7b2-0445f38a4c0b,FOR_Owlbear_AD_HatchedEgg_30cd5c4c-3a19-2ad2-55db-ab4ebd3d19d5,FOR_Owlbear_HatchedEgg_PassedCheck_55d8e30b-2a54-8773-b8ba-40546b117c03);

DB_HasItemEvent(S_FOR_OwlBear_Egg_cac64420-e7d7-4ac2-aac9-5ed22cbe4272,(FLAG)FOR_Owlbear_HasOwlbearEgg_473a562b-6aef-4352-b285-48bd1c8b49cb);

DB_PermaDefeatedFlag(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,(FLAG)FOR_Owlbear_State_PermaDefeated_a2cd3c0f-95be-7155-d67c-edbdb2ca1104);
DB_PermaDefeatedFlag(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,(FLAG)GLO_OwlbearCub_State_PermaDefeated_e407829a-d8ff-4759-9dbc-89f2b2f33151);

//PROC_RegisterPartyDecisionDialogOutcomes_Fixed(DIALOGGUID_FOR_OwlBear_LastCub_GVD_29e6db7d-e7eb-019d-40d1-936d74354bcc,(FLAG)FOR_OwlBear_KillCub_250a57cf-993a-7a7d-4374-881a3617fcdc,(FLAG)FOR_OwlBear_SpareCub_cc7925fb-681e-73ad-8783-76a6d7c03dd6,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

DB_GLO_HasSpellCheckInDialog(1,(DIALOGRESOURCE)DIALOGRESOURCEGUID_FOR_OwlBear_0936248b-8932-a2f3-002b-2e1cc97c9283,"Target_CureWounds",2);

DB_SpotPlayers(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_OwlBear_SpotPlayer",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_TargetIgnoreCantTalk(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_OwlBear_SpotPlayer");
DB_SpotPlayers_IncludeWildshapedPlayers(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_OwlBear_SpotPlayer");

DB_GLO_PaladinOathbreaker_ProtectedNPCs((TAG)PALADIN_ANCIENTS_7c89622b-4194-41df-b2ff-145a5056ee49, (CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);

DB_FOR_OwlbearEnrage_Spells("Shout_FOR_Owlbear_Enrage","FOR_OWLBEAR_ENRAGE");
DB_FOR_OwlbearEnrage_Spells("Shout_FOR_Owlbear_Enrage_Hardcore","FOR_OWLBEAR_ENRAGE_HARDCORE");

SetOnStage(S_FOR_OwlbearCave_Stalactite_01_7b369d79-8741-4fdf-b4fe-305cf7cface6,0);
SetOnStage(S_FOR_OwlbearCave_Stalactite_02_bea76203-5824-4538-8a3e-d802b5809e37,0);
SetOnStage(S_FOR_OwlbearCave_Stalactite_03_a269d9cb-a880-4e57-923b-898dea81e347,0);
KBSECTION
IF
DB_FOR_OwlBear_GoblinCubnappers(_Goblin)
THEN
SetOnStage(_Goblin,0);

IF
EnteredTrigger(_Player,S_FOR_Owlbear_VbTrigger_0aa2efc9-663f-40e2-ac8d-6364054f3f50)
AND
QRY_OncePerUserAndNearbyPlayers(_Player,"FOR_OwlBear_VB_EnterCave")
THEN
StartVoiceBark((VOICEBARKRESOURCE)FOR_OwlBear_VB_EnterCave_d7787991-ee48-7379-78cb-30c446fb1cfb,_Player);

//REGION Dialog with Owlbear

PROC
PROC_SpotPlayers_Spotted(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_OwlBear_SpotPlayer",_Player)
AND
QRY_StartDialog(DIALOGRESOURCEGUID_FOR_OwlBear_0936248b-8932-a2f3-002b-2e1cc97c9283,S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_Player)
THEN
MakePlayerActive(_Player);
DB_Dialogs(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,DIALOGRESOURCEGUID_FOR_OwlBear_0936248b-8932-a2f3-002b-2e1cc97c9283);
DB_FOR_OwlBear_DialogStartedOnce(1);

IF
DialogStarted(DIALOGRESOURCEGUID_FOR_OwlBear_0936248b-8932-a2f3-002b-2e1cc97c9283,_)
AND
DB_PriestsConqueringGod(_Priest)
AND
DB_DialogNPCs(_,_Priest,_)
THEN
PROC_ForceStopDialog(_Priest);

IF
DialogRequestFailed(DIALOGRESOURCEGUID_FOR_OwlBear_0936248b-8932-a2f3-002b-2e1cc97c9283,_)
AND
NOT DB_FOR_OwlBear_DialogStartedOnce(1)
THEN
SetEntityEvent(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"StartEventOnSight_RestartSpotting");

// If any of the owlbears go into combat and the owlbear dialog is playing, stop it immediately.
IF
DB_Is_InCombat(_Owlbear, _)
AND
DB_FOR_OwlBears((CHARACTER)_Owlbear)
AND
DB_DialogName(FOR_OwlBear_0936248b-8932-a2f3-002b-2e1cc97c9283, _)
THEN
PROC_ForceStopDialog(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08);

IF
FlagSet(FOR_Owlbear_Retreat_7a497024-58c9-b1d6-d1de-1f643e6cc664, _, _)
THEN
PROC_CharacterMoveTo(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,S_FOR_Owlbear_WanderTrigger_b375964b-59ca-4ae7-8cb2-93706f9b03f6,"Walk","");

//END_REGION


//REGION Leaving the Area

IF
Saw(_Player,S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_)
AND
DB_Players(_Player)
AND
NOT DB_FOR_OwlBear_FoundTheOwlBear(1)
THEN
DB_FOR_OwlBear_FoundTheOwlBear(1);

IF
EnteredTrigger(_Player,S_FOR_OwlBear_LeaveAreaTrigger_beef9aac-fda9-4bc1-baad-2b2f974ba61e)
AND
DB_Players(_Player)
THEN
PROC_IncreaseCounter("FOR_OwlBear_LeaveAreaTrigger_Counter");

IF
LeftTrigger(_Player,S_FOR_OwlBear_LeaveAreaTrigger_beef9aac-fda9-4bc1-baad-2b2f974ba61e)
AND
DB_Players(_Player)
THEN
PROC_DecreaseCounter("FOR_OwlBear_LeaveAreaTrigger_Counter");

PROC
PROC_CounterDecreased("FOR_OwlBear_LeaveAreaTrigger_Counter",0)
AND
DB_FOR_OwlBear_FoundTheOwlBear(1)
AND
NOT DB_OnlyOnce("PROC_FOR_OwlBear_LastCubResolution")
THEN
DB_FOR_OwlbearCaveStateChange_OnLongRest(1);

PROC
PROC_LongRest()
AND
DB_FOR_OwlbearCaveStateChange_OnLongRest(1)
THEN
NOT DB_FOR_OwlbearCaveStateChange_OnLongRest(1);
DB_FOR_OwlbearCaveStateChange_InWLD(1);

IF
DB_FOR_OwlbearCaveStateChange_InWLD(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_FOR_OwlbearCaveStateChange_InWLD(1);
PROC_FOR_OwlBear_GoblinsCome();
PROC_FOR_OwlBear_LastCubResolution(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);

PROC
PROC_FOR_OwlBear_GoblinsCome()
AND
NOT DB_FOR_OwlBear_GoblinsCame(_)
AND
NOT DB_PermaDefeated((CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
DB_FOR_OwlBear_GoblinCubnappers(_Goblin)
THEN
SetOnStage(_Goblin,1);
Die(_Goblin,DEATHTYPE.Physical,S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,1,1);

PROC
PROC_FOR_OwlBear_GoblinsCome()
AND
DB_FOR_OwlbearDad(_OwlbearDad)
AND
NOT DB_Dead((CHARACTER)_OwlbearDad)
THEN
Die(_OwlbearDad,DEATHTYPE.Physical,S_FOR_Owlbear_Cubnapper_01_Dead_7bfcdc8d-4916-4e8c-8683-a2462950231f,1,1);

PROC
PROC_FOR_OwlBear_GoblinsCome()
AND
NOT DB_FOR_OwlBear_GoblinsCame(_)
AND
NOT DB_Dead((CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
THEN
Die(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,DEATHTYPE.Physical,S_FOR_Owlbear_Cubnapper_01_Dead_7bfcdc8d-4916-4e8c-8683-a2462950231f,1,1);
DB_FOR_OwlBear_GoblinsCame(1);

IF
DB_Sees(_Player,(CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
DB_Players(_Player)
AND
DB_FOR_OwlBear_GoblinsCame(1)
AND
QRY_OncePerUserAndNearbyPlayers(_Player,"FOR_Owlbear_VB_KilledByGoblins")
THEN
StartVoiceBark(FOR_Owlbear_VB_KilledByGoblins_0a3fd665-6d71-a989-0644-740445209506,_Player);

//END_REGION

//REGION Healing

IF 
StatusApplied(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_String,_Player,_)
AND
QRY_IsHealingStatus(_String)
AND
GetFlag(FOR_OwlBear_Healed_e7d5538f-094c-9acf-d309-a989175a8769,_Player,0)
THEN
RemoveStatus(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_OWLBEAR_INJURY");
SetFlag((FLAG)FOR_OwlBear_Healed_e7d5538f-094c-9acf-d309-a989175a8769,_Player);

IF
FlagSet(FOR_OwlBear_Healed_e7d5538f-094c-9acf-d309-a989175a8769,_Player,_)
THEN
ObjectTimerLaunch(_Player,"FOR_Owlbear_Healed_PAD_ReactionDelayTimer",900);

IF
ObjectTimerFinished(_Player,"FOR_Owlbear_Healed_PAD_ReactionDelayTimer")
THEN
PROC_TryStartAD((DIALOGRESOURCE)FOR_Owlbear_PAD_HealedOwlbear_a49a13b5-fa21-8e67-773a-dc4dc8bbec97,_Player);

//END_REGION


//REGION Owlbear is hostile to players while in combat

IF
EnteredCombat(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_)
AND
GetRelation((FACTION)FOR_Owlbear_784be375-5641-e659-e4ea-a3ac17480d28,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,_Int)
AND
_Int != 0
THEN
PROC_SetRelationToPlayers((FACTION)FOR_Owlbear_784be375-5641-e659-e4ea-a3ac17480d28,0);
DB_FOR_Owlbear_TempHostile(1);

IF
EnteredCombat((CHARACTER)_Player,_Id)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08, _Id)
AND
DB_FOR_Owlbear_TempHostile(1)
THEN
NOT DB_FOR_Owlbear_TempHostile(1);

IF
LeftCombat(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_)
AND
DB_FOR_Owlbear_TempHostile(1)
THEN
NOT DB_FOR_Owlbear_TempHostile(1);
PROC_SetRelationToPlayers((FACTION)FOR_Owlbear_784be375-5641-e659-e4ea-a3ac17480d28,50);

IF
DB_FOR_OwlbearDad(_OwlbearDad)
AND
DB_FOR_Owlbear_TempHostile(1)
THEN
NOT DB_FOR_Owlbear_TempHostile(1);

//END_REGION

//REGION Hostility Trigger
PROC
PROC_SpotPlayers_Spotted(_,"FOR_Owlbear_Hostile",_Player)
THEN
PROC_MakeNPCHostile(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_Player);
PROC_ForceStopDialog(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08);
PROC_SpotPlayers_StopSpotting(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_Owlbear_Hostile");
PROC_SpotPlayers_StopSpotting(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_Owlbear_Hostile");

IF
LeftCombat((CHARACTER)_Player,_GUID)
AND
DB_Players(_Player)
AND
DB_Was_InCombat(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08, _GUID)
AND
NOT DB_PermaDefeated(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
THEN
PROC_SpotPlayers_RestartSpotting(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"FOR_Owlbear_Hostile");
PROC_SpotPlayers_RestartSpotting(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_Owlbear_Hostile");

//END_REGION

//REGION Cultists kill knocked out owlbear so their following dialog makes sense
IF
DB_KnockedOut(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
DB_PriestsConqueringGod(_Priest)
AND
NOT DB_Defeated(_Priest)
AND
NOT DB_CantAct(_Priest)
AND
NOT DB_FOR_OwlbearDad(_)
AND
IsInTrigger(_Priest,S_FOR_OwlBear_SUB_1fa871e1-4979-4259-9e5e-5017b06d077f,1)
AND
QRY_OnlyOnce("FOR_ConqueringGodPriest_KnockedOwlbearDeathBlow_OnlyOnce")
THEN
Attack(_Priest,S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,1);
//END_REGION

//REGION Honour Mode: Owlbear Dad
IF
CastedSpell(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"Shout_FOR_Owlbear_CallConsort",_,_,_)
AND
QRY_OnlyOnce("FOR_OwlbearMomCallsDad_OnlyOnce")
AND
CreateAtObject(Owlbear_Dad_7a87360f-6a37-4b66-96c8-446390f3c7b3,S_FOR_Owlbear_OwlbearDadSpawn_Trigger_a66f8746-22b0-4fc4-8702-efc54d263cc0,0,1,"FOR_OwlbearDad_Spawned",1,_OwlbearDad)
THEN
DB_FOR_OwlbearDad(_OwlbearDad);

IF
EntityEvent(_OwlbearDad,"FOR_OwlbearDad_Spawned")
AND
DB_FOR_OwlbearDad(_OwlbearDad)
THEN
SetCombatGroupAndEnterCombat(_OwlbearDad,"e53d2d42-421c-fab8-47ff-6b52975793ce",S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08);

IF
DB_PermaDefeated(_OwlbearDad)
AND
DB_FOR_OwlbearDad(_OwlbearDad)
THEN
NOT DB_FOR_OwlbearDad(_OwlbearDad);
//END_REGION

//REGION Last Cub
PROC
PROC_StateSet_PermaDefeated(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
NOT DB_FOR_OwlbearDad(_)
AND
GetFlag(FOR_OwlBear_LastCubResolution_ToGoblinCamp_f804d502-80bb-ce09-3e34-735573a5ffa1,S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,0)
AND
QRY_OnlyOnce("FOR_OwlBearCub_LastCubLeaveCombat")
AND
NOT DB_FOR_OwlBear_GoblinsCame(1)
AND
NOT DB_Defeated(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
THEN
PROC_FOR_OwlBearCub_LastCubLeaveCombat(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);

PROC
PROC_FOR_OwlBearCub_LastCubLeaveCombat((CHARACTER)_Cub)
THEN
SetFaction(_Cub,(FACTION)ACT1_FOR_OwlbearLastCub_71235128-c21a-4ccf-7552-71824901405c);

PROC
PROC_FOR_OwlBearCub_LastCubLeaveCombat((CHARACTER)_Cub)
AND
NOT DB_KnockedOut(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
THEN
PROC_FOR_OwlbearCubEatsMotherSetup();

PROC
PROC_FOR_OwlbearCubEatsMotherSetup()
THEN
PROC_CharacterMoveTo(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,"Run","UpdateState_Grieving");
DB_SpotPlayers(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_OwlBearCub_SpotPlayer",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_TargetIgnoreCantTalk((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_OwlBearCub_SpotPlayer");
DB_SpotPlayers_IncludeWildshapedPlayers((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_OwlBearCub_SpotPlayer");
PROC_FOR_OwlBearCub_LastCubLeaveCombat_VB();

PROC
PROC_FOR_OwlBearCub_LastCubLeaveCombat((CHARACTER)_Cub)
AND
DB_KnockedOut(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
NOT QRY_FOR_CultistsInOwlbearCave()
THEN
PROC_DisappearOutOfSight(_Cub, "Run", 0, "");

PROC
PROC_FOR_OwlBearCub_LastCubLeaveCombat((CHARACTER)_Cub)
AND
DB_KnockedOut(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
QRY_FOR_CultistsInOwlbearCave()
THEN
DB_FOR_OwlbearCubEatsMotherOnHerPermaDefeat(1);
RealtimeObjectTimerLaunch(_Cub,"FOR_OwlbearCubWithCutlistsInTheCave_Timer",10000);

QRY
QRY_FOR_CultistsInOwlbearCave()
AND
DB_PriestsConqueringGod(_Priest)
AND
NOT DB_Defeated(_Priest)
AND
IsInTrigger(_Priest,S_FOR_OwlBear_SUB_1fa871e1-4979-4259-9e5e-5017b06d077f,1)
THEN
DB_NOOP(1);

// In case the owlbear hasn't started eating mother by now, it runs away. Handles edge cases of players interrupting cultists killing the knocked out owlbear
IF
TimerFinished("FOR_OwlbearCubWithCutlistsInTheCave_Timer")
AND
DB_FOR_OwlbearCubEatsMotherOnHerPermaDefeat(1)
THEN
NOT DB_FOR_OwlbearCubEatsMotherOnHerPermaDefeat(1);
PROC_DisappearOutOfSight(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, "Run", 0, "");

PROC
PROC_StateSet_Defeated(_Cultist)
AND
DB_PriestsConqueringGod((CHARACTER)_Cultist)
AND
DB_FOR_OwlbearCubEatsMotherOnHerPermaDefeat(1)
THEN
NOT DB_FOR_OwlbearCubEatsMotherOnHerPermaDefeat(1);
PROC_DisappearOutOfSight(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, "Run", 0, "");

IF
Died(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
DB_FOR_OwlbearCubEatsMotherOnHerPermaDefeat(1)
THEN
NOT DB_FOR_OwlbearCubEatsMotherOnHerPermaDefeat(1);
PROC_FOR_OwlbearCubEatsMotherSetup();

IF
EntityEvent(_Cub,"UpdateState_Grieving")
THEN
SetFlag((FLAG)FOR_OwlBear_LastCubResolution_IsGrieving_f8bcda43-9f8e-4a41-a3a7-8e15136d53bc, _Cub); // flagType: Object
DB_Dialogs(_Cub,DIALOGRESOURCEGUID_FOR_OwlBear_LastCub_0cd008b8-4501-3e68-83d9-3c9ca0fa3709);

PROC
PROC_SpotPlayers_Spotted(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"FOR_OwlBearCub_SpotPlayer",_Player)
AND
QRY_StartDialog(DIALOGRESOURCEGUID_FOR_OwlBear_LastCub_0cd008b8-4501-3e68-83d9-3c9ca0fa3709,S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,_Player)
THEN 
DB_NOOP(1);

//only play vb if players are far away
PROC
PROC_FOR_OwlBearCub_LastCubLeaveCombat_VB()
AND
GetClosestAlivePlayer(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,(CHARACTER)_Player,_Dist)
AND
_Dist > 12.0
THEN
StartVoiceBark(FOR_OwlBear_VB_LastCub_96dbd09e-f944-2dfd-2c6c-a83815aad594,_Player);

PROC
PROC_FOR_OwlBear_LastCubResolution((CHARACTER)_Cub)
AND
NOT DB_GlobalFlag((FLAG)GLO_OwlbearCub_State_PermaDefeated_e407829a-d8ff-4759-9dbc-89f2b2f33151)
AND
QRY_OnlyOnce("PROC_FOR_OwlBear_LastCubResolution")
THEN
SetFlag((FLAG)FOR_OwlBear_LastCubResolution_ToGoblinCamp_f804d502-80bb-ce09-3e34-735573a5ffa1, _Cub);
ClearFlag((FLAG)FOR_OwlBear_LastCubResolution_IsGrieving_f8bcda43-9f8e-4a41-a3a7-8e15136d53bc, _Cub);
PROC_SpotPlayers_StopSpotting(_Cub,"FOR_OwlBearCub_SpotPlayer");
PROC_DisappearOutOfSight(_Cub, "Run", 0, "FOR_Owlbear_LastCubResolution_ToGoblinCamp");

IF
DialogEnded(DIALOGRESOURCEGUID_FOR_OwlBear_LastCub_0cd008b8-4501-3e68-83d9-3c9ca0fa3709,_ID)
AND
DB_DialogPlayers(_ID,_Player,_)
AND
QRY_OnlyOnce("PROC_FOR_OwlBear_LastCubResolution_VB")
THEN
StartVoiceBark(FOR_OwlBear_VB_CubResolution_df2928ad-d5dd-f205-35cf-64dbc7453508,(CHARACTER)_Player);

IF
VoiceBarkEnded(FOR_OwlBear_VB_CubResolution_df2928ad-d5dd-f205-35cf-64dbc7453508,_ID)
AND
DB_GlobalFlag((FLAG)FOR_PriestsConqueringGod_Global_GoToOwlbearCave_8ec1f489-609b-a15d-56d7-b16ffb2f9a2f)
AND
QRY_FOR_PriestConqueringGod_CheckAliveForAD((DIALOGRESOURCE)FOR_PriestOfTheConqueringGod_AD_OwlbearCubResolution_00f2a91a-b9b8-e8cc-14fd-129ff3ce1759)
THEN
DB_NOOP(1);
//END_REGION

//REGION Owlbear Egg

IF
AddedTo(S_FOR_OwlBear_Egg_cac64420-e7d7-4ac2-aac9-5ed22cbe4272,(CHARACTER)_Player, _)
AND
DB_Players(_Player)
AND
NOT DB_PermaDefeated(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
QRY_OnlyOnce("FOR_OwlBear_VB_EggPickedUp")
THEN
SetFlag((FLAG)FOR_OwlBear_EggPickedInCombat_ace87b61-b29c-2011-5c0f-0a7ee890bac1, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
StartVoiceBark((VOICEBARKRESOURCE)FOR_OwlBear_VB_EggPickedUp_1b4110a0-598b-2112-d169-7548ea2fcc47,_Player);

IF
AddedTo(S_FOR_OwlBear_Egg_cac64420-e7d7-4ac2-aac9-5ed22cbe4272,(CHARACTER)_Player, _)
AND
DB_Players(_Player)
AND
DB_PermaDefeated(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
QRY_OnlyOnce("FOR_OwlBear_VB_EggPickedUp")
THEN
StartVoiceBark((VOICEBARKRESOURCE)FOR_OwlBear_VB_EggPickedUp_1b4110a0-598b-2112-d169-7548ea2fcc47,_Player);

//END_REGION

//REGION Combat Mechanics

//REGION Egg Taunt

IF
AddedTo(S_FOR_OwlBear_Egg_cac64420-e7d7-4ac2-aac9-5ed22cbe4272,(CHARACTER)_Player, _)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player,_Id)
AND
QRY_FOR_OwlbearParentInCombat(_Id)
AND
HasActiveStatus(_Player,"FOR_OWLBEAR_EGG",0)
THEN
ApplyStatus(_Player,"FOR_OWLBEAR_EGG",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

IF
EnteredCombat((CHARACTER)_Player,_Id)
AND
DB_Players(_Player)
AND
QRY_FOR_OwlbearParentInCombat(_Id)
AND
GetFlag(FOR_Owlbear_HasOwlbearEgg_473a562b-6aef-4352-b285-48bd1c8b49cb,_Player,1)
AND
IsInInventoryOf(S_FOR_OwlBear_Egg_cac64420-e7d7-4ac2-aac9-5ed22cbe4272,_Player,1)
AND
HasActiveStatus(_Player,"FOR_OWLBEAR_EGG",0)
THEN
ApplyStatus(_Player,"FOR_OWLBEAR_EGG",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_FOR_OwlbearParentInCombat((GUIDSTRING)_CombatId)
AND
DB_Is_InCombat(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_CombatId)
THEN
DB_NOOP(1);

QRY
QRY_FOR_OwlbearParentInCombat((GUIDSTRING)_CombatId)
AND
DB_FOR_OwlbearDad(_OwlbearDad)
AND
DB_Is_InCombat(_OwlbearDad,_CombatId)
THEN
DB_NOOP(1);

IF
EnteredCombat(_OwlbearParent,_Id)
AND
QRY_FOR_IsOwlbearParent(_OwlbearParent)
AND
DB_Is_InCombat(_Player,_Id)
AND
DB_Players((CHARACTER)_Player)
AND
GetFlag(FOR_Owlbear_HasOwlbearEgg_473a562b-6aef-4352-b285-48bd1c8b49cb,_Player,1)
AND
IsInInventoryOf(S_FOR_OwlBear_Egg_cac64420-e7d7-4ac2-aac9-5ed22cbe4272,_Player,1)
AND
HasActiveStatus(_Player,"FOR_OWLBEAR_EGG",0)
THEN
ApplyStatus(_Player,"FOR_OWLBEAR_EGG",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_FOR_IsOwlbearParent((GUIDSTRING)_Character)
AND
_Character == S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08
THEN
DB_NOOP(1);

QRY
QRY_FOR_IsOwlbearParent((GUIDSTRING)_Character)
AND
DB_FOR_OwlbearDad(_Character)
THEN
DB_NOOP(1);

IF
RemovedFrom(S_FOR_OwlBear_Egg_cac64420-e7d7-4ac2-aac9-5ed22cbe4272,_Player)
AND
HasActiveStatus(_Player,"FOR_OWLBEAR_EGG",1)
THEN
RemoveStatus(_Player,"FOR_OWLBEAR_EGG");

IF
LeftCombat(_Player,_)
AND
HasActiveStatus(_Player,"FOR_OWLBEAR_EGG",1)
THEN
RemoveStatus(_Player,"FOR_OWLBEAR_EGG");

//END_REGION

//REGION Enrage
IF
UsingSpell(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_Spell,_,_,_)
AND
DB_FOR_OwlbearEnrage_Spells(_Spell,_)
AND
DB_Is_InCombat(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_CombatID)
AND
DB_Is_InCombat(_Player,_CombatID)
AND
DB_PartyMembers((CHARACTER)_Player)
AND
QRY_StartDialogCustom((DIALOGRESOURCE)FOR_OwlBear_CMB_Enrage_74bc53d8-1c77-ce1f-525a-9122d638856e,(CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_Player,0,0,0,0)
THEN
DB_NOOP(1);

IF
CastSpellFailed(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_Spell,_,_,_)
AND
DB_FOR_OwlbearEnrage_Spells(_Spell,_Status)
THEN
ApplyStatus(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_Status,-1.0);

IF
CastedSpell(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_Spell,_,_,_)
AND
DB_FOR_OwlbearEnrage_Spells(_Spell,_)
THEN
TriggerSetSoundState((TRIGGER)Amb_SV_OwlbearCave_FZ_000_c9a10443-63a8-136c-89f0-8b94e8a17d44,"CombatPhase_FOR_OwlBear","Enraged",1);

PROC
PROC_StateSet_Defeated(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_PermaDefeated(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
QRY_OnlyOnce("FOR_OwlBear_Enrage")
THEN
SetFlag((FLAG)FOR_Owlbear_State_EnragedBecauseCubOrEggDefeated_14fd06c1-9642-4117-8f1f-fbcb9a509950);
SetTag(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,(TAG)AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);

IF
DestroyingBy(S_FOR_OwlBear_Egg_cac64420-e7d7-4ac2-aac9-5ed22cbe4272,_,_,_)
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_PermaDefeated(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
QRY_OnlyOnce("FOR_OwlBear_Enrage")
THEN
SetFlag((FLAG)FOR_Owlbear_State_EnragedBecauseCubOrEggDefeated_14fd06c1-9642-4117-8f1f-fbcb9a509950);
SetTag(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,(TAG)AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);

IF
HitpointsChanged(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_Int)
AND
_Int < 60.0
AND
QRY_OnlyOnce("FOR_OwlBear_Enrage")
THEN
SetTag(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,(TAG)AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);

IF
AttackedBy((CHARACTER)_Owlbear,_Player,_,_,_,_,_)
AND
DB_FOR_OwlBears(_Owlbear)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("FOR_OwlBear_GoHostile")
THEN
PROC_MakeNPCHostile(_Owlbear,_Player);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)FOR_OwlBear_CMB_Enrage_74bc53d8-1c77-ce1f-525a-9122d638856e, _Inst)
AND
DB_Is_InCombat(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,_CombatID)
AND
DB_Is_InCombat(_Player,_CombatID)
AND
DB_PartyMembers((CHARACTER)_Player)
AND
DB_InRegion(_Player, (TRIGGER)S_FOR_OwlBear_SUB_1fa871e1-4979-4259-9e5e-5017b06d077f)
THEN
PROC_DialogAddListeningActor(_Inst, _Player);
//END_REGION

//END_REGION


//REGION Debug

IF
TextEvent("Owlbear_DebugSetUp")
AND
GetHostCharacter((CHARACTER)_Player)
THEN
TemplateAddTo(CONS_Potion_Healing_A_Greater_e3b95c96-dc26-40fe-bfc0-baa05e1abd20,_Player,1);
TemplateAddTo(CONS_Poison_Basic_28645376-e6e8-436a-8e9a-c62877fae07d,_Player,1);
TeleportTo(_Player,TRIGGERGUID_S_FOR_Owlbear_CaveExit_Trigger_52a2e9f6-eb66-4331-9c74-004d8de95261,"",1);

//END_REGION
EXITSECTION
PROC_TriggerUnregisterForPlayers(S_FOR_OwlBear_HostilityTrigger_db2fa4cc-243f-476a-af4b-652e5dbc6893);
PROC_TriggerUnregisterForPlayers(S_FOR_OwlBear_LeaveAreaTrigger_beef9aac-fda9-4bc1-baad-2b2f974ba61e);
ENDEXITSECTION
ParentTargetEdge "Act1"
