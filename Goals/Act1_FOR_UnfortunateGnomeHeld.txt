Version 1
SubGoalCombiner SGC_AND
INITSECTION
SetHasDialog(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, 1);
SetHasDialog(S_FOR_GnomeGoblin2_51300d83-e9f1-4f01-a27e-27c73f9e6318, 1);
SetHasDialog(S_FOR_GnomeGoblin3_bff8ab5f-739d-422a-9ad3-92f4b897f1bc, 1);
SetHasDialog(S_FOR_GnomeGoblin4_20eba5fb-3e93-4887-9700-d7fd7f2c418f, 1);
SetHasDialog(S_FOR_GnomeGoblin5_0e54fa5d-e2dd-4e15-acbb-82a4e0c63012, 1);
SetHasDialog(S_FOR_GnomeGoblin6_f0f4d3e2-8081-489a-b4ee-aee7b1ecee12, 1);
SetHasDialog(S_FOR_GnomeWorg1_e595394b-fbc9-438a-be7a-5b6fb5c3261d, 1);
SetHasDialog(S_FOR_GnomeWorg2_a5b311ad-5c73-4e88-9f77-106e8350f1d0, 1);

DB_FOR_GnomeGoblins((CHARACTER)S_WLD_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, S_MOO_GnomeGoblinTrigger1_3e7a9523-c7b1-42fb-a94a-c7432267880c, (DIALOGRESOURCE)FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, 300);
DB_FOR_GnomeGoblins(S_WLD_GnomeGoblin2_51300d83-e9f1-4f01-a27e-27c73f9e6318, S_MOO_GnomeGoblinTrigger2_8e5d9723-cbe9-41f7-964d-becbe7490dfd, DIALOGRESOURCEGUID_FOR_GnomeGoblin2_0c427c88-ac3b-157f-3bd1-b03baeba1da5, 1000);
DB_FOR_GnomeGoblins(S_WLD_GnomeGoblin3_bff8ab5f-739d-422a-9ad3-92f4b897f1bc, S_MOO_GnomeGoblinTrigger3_419097ca-c29c-4517-9f85-8daa436e11d5, DIALOGRESOURCEGUID_FOR_GnomeGoblin3_7d2d84c1-aa91-a5d4-c29c-adf3a77e8e7b, 1500);
DB_FOR_GnomeGoblins(S_FOR_GnomeGoblin4_20eba5fb-3e93-4887-9700-d7fd7f2c418f, NULL_00000000-0000-0000-0000-000000000000, FOR_GnomeGoblin4_c1e1d0d7-325a-8dc0-01f3-ada8b5c4d94e, 7000);
DB_FOR_GnomeGoblins(S_FOR_GnomeGoblin5_0e54fa5d-e2dd-4e15-acbb-82a4e0c63012, NULL_00000000-0000-0000-0000-000000000000, FOR_GnomeGoblin5_1cf9960c-d2e6-99a2-101e-7a7f77e704ca, 2800);
DB_FOR_GnomeGoblins(S_FOR_GnomeGoblin6_f0f4d3e2-8081-489a-b4ee-aee7b1ecee12, NULL_00000000-0000-0000-0000-000000000000, FOR_GnomeGoblin6_d3095e1c-44cd-a1c7-43cf-226f81a79775, 1500);
DB_FOR_GnomeGoblins(S_FOR_GnomeGoblin7_4b2be2ad-f9e3-4aa0-9a0a-aae7f7813fd3, NULL_00000000-0000-0000-0000-000000000000, FOR_GnomeGoblin7_18a97f81-c70d-64e7-3e31-04fc48f1344e, 5500);
DB_FOR_GnomeGoblins(S_FOR_GnomeWorg1_e595394b-fbc9-438a-be7a-5b6fb5c3261d, NULL_00000000-0000-0000-0000-000000000000, FOR_GnomeWorg1_faa66fcb-f791-b32e-5402-893b2bb39361, 8000);
DB_FOR_GnomeGoblins(S_FOR_GnomeWorg2_a5b311ad-5c73-4e88-9f77-106e8350f1d0, NULL_00000000-0000-0000-0000-000000000000, FOR_GnomeWorg2_04166e83-37c9-0009-e501-0e0b4b4ffc5a, 3400);

Use(S_WLD_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_WLD_FOR_UnfortunateGnomePyre_74cf2839-80b6-4f42-ab7c-679f0b6b74ac, "");

DB_FallibleCheckItem("FOR_UnfortunateGnomeChains", S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, "SleightOfHand", (DIFFICULTYCLASS)DC_Legacy_10_625be976-7a67-4394-97c8-14c69715ae4b, "", (ANIMATION)ANIMATION_Fidget_Forward_01_00000000-0000-0000-0000-000000000000);
DB_TrespassTrigger(TRIGGERGUID_S_WLD_WIL_NearCapturedGnome_a877c0ce-1016-4120-9c51-6557fea123b0, NULL_00000000-0000-0000-0000-000000000000, "WLD_FOR_ApproachUnfortunateGnome");
DB_TrespassTrigger(FOR_UnfortunateGnome_Trespass_Combat_2639acb2-11c3-480b-87ae-34d99421ae32, NULL_00000000-0000-0000-0000-000000000000, "WLD_FOR_UnfortunateGnome_ApproachHighPerch");

DB_Inclusion_Object(S_FOR_GnomeGoblin2_51300d83-e9f1-4f01-a27e-27c73f9e6318,(FLAG)FOR_GnomeGoblin2_StartInclusion_48674792-60cd-97ea-3b07-850df0ea880c,(FLAG)FOR_GnomeGoblin2_EndInclusion_94e35f8f-e63d-c131-515c-79af0f889b2d);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9,S_FOR_GnomeGoblin2_51300d83-e9f1-4f01-a27e-27c73f9e6318);
DB_Inclusion_Object(S_FOR_GnomeGoblin3_bff8ab5f-739d-422a-9ad3-92f4b897f1bc,(FLAG)FOR_GnomeGoblin3_StartInclusion_17cd6948-2ddb-4822-8bc0-7cc6f1e7805f,(FLAG)FOR_GnomeGoblin3_EndInclusion_ed369ebc-6d32-4ca0-88b6-c676d33b7554);
DB_Inclusion_Object(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,(FLAG)FOR_UnfortunateGnome_StartInclusion_b0183150-35a0-4777-9c87-faa523f1ddb4,(FLAG)FOR_UnfortunateGnome_EndInclusion_05242d63-48b8-4281-bc91-37037093e25b);

DB_DialogMoneyTransfer(1, FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, 1000, 3);
DB_DialogMoneyTransfer(2, FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, 5, 3);

DB_DeadOnceFlag(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404,(FLAG)FOR_GnomeGoblin1_State_Dead_130e60e5-4559-490e-b8fd-890e400253ba);
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("FOR_GnomeGoblins",(FLAG)FOR_GnomeGoblinsDead_8910f084-c9ad-2336-c6a7-098d71914529);

SetOnStage(ITEMGUID_S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, 0);

DB_FOR_UnfortunateGnomeMillRotatingFasterReaction(0);

DB_GLO_CompoundFlag(WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714, WLD_FOR_GnomeGoblinStopSpot_283b6c8d-77e3-4575-8262-3d729a3b36ec);
DB_GLO_CompoundFlag(WLD_FOR_GnomeGoblinsAngry_42a4e444-5e6e-c574-f360-ea3cf57e4426, WLD_FOR_GnomeGoblinStopSpot_283b6c8d-77e3-4575-8262-3d729a3b36ec);
DB_GLO_CompoundFlag(FOR_GnomeGoblinsPromisedLeave_b957a042-bef5-b837-597c-97e529f61357, WLD_FOR_GnomeGoblinStopSpot_283b6c8d-77e3-4575-8262-3d729a3b36ec);

DB_SpotPlayers_SpotTrigger_ManualRegistering(S_FOR_GnomeGoblinSpotArea_5c4d7246-3f71-4a87-a31d-159ef394b66f);
PROC_TriggerRegisterForPlayers(S_FOR_GnomeGoblinSpotArea_5c4d7246-3f71-4a87-a31d-159ef394b66f);

DB_HasItemEvent(S_FOR_UnfortunateGnome_Amulet_899635f4-d00f-472f-b856-cba4f9fc2678, FOR_UnfortunateGnome_State_HasAmulet_632de610-a024-47d1-90dd-78537db48898);
DB_GiveItemToEventWithClear(S_FOR_UnfortunateGnome_Amulet_899635f4-d00f-472f-b856-cba4f9fc2678, (FLAG)FOR_UnfortunateGnome_Event_GiveAmulet_85ffa219-7941-446f-bb65-7ca826c45608);

DB_FOR_UnfortunateGnome_GnomeInvestiGoblins(1, S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, 0);
DB_FOR_UnfortunateGnome_GnomeInvestiGoblins(2, S_FOR_GnomeGoblin4_20eba5fb-3e93-4887-9700-d7fd7f2c418f, 1);
DB_FOR_UnfortunateGnome_GnomeInvestiGoblins(3, S_FOR_GnomeGoblin5_0e54fa5d-e2dd-4e15-acbb-82a4e0c63012, 1);
DB_FOR_UnfortunateGnome_GnomeInvestiGoblins(4, S_FOR_GnomeGoblin6_f0f4d3e2-8081-489a-b4ee-aee7b1ecee12, 1);

DB_Dialogs_DialogBlockStatusesDialogOverride((DIALOGRESOURCE)FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, (DIALOGRESOURCE)FOR_GnomeGoblin1_StatusFallback_5cb8777c-2dd3-9bf0-0b25-85bbc5db719d);

//Combat NPC Reactivity
DB_CombatReact_AD_OnNextTurn(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404,(DIALOGRESOURCE)FOR_AD_Combat_GnomeGoblin1_000_cc7ce962-e45b-6ca8-2c83-05dc111d00ac);
DB_CombatReact_AD_OnNextTurn(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404,(DIALOGRESOURCE)FOR_AD_Combat_GnomeGoblin1_001_ee5781c9-4d66-c613-16c7-13b621767f04);
DB_CombatReact_AD_OnNextTurn(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404,(DIALOGRESOURCE)FOR_AD_Combat_GnomeGoblin1_002_9afb20e0-874f-d525-1b85-05ef921da702);
DB_CombatReact_AD_OnNextTurn(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404,(DIALOGRESOURCE)FOR_AD_Combat_GnomeGoblin1_003_6db2135a-3f52-3ae7-6420-c59121b2fb69);
DB_CombatReact_AD_OnNextTurn(S_FOR_GnomeGoblin2_51300d83-e9f1-4f01-a27e-27c73f9e6318,(DIALOGRESOURCE)FOR_AD_Combat_GnomeGoblin2_c1d43819-1abc-f7e5-8510-c95062341089);
KBSECTION
//REGION Goblins start dialogue with player
IF
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
THEN
DB_SpotPlayers(_Goblin, "FOR_GnomeGoblins", (FLAG)WLD_FOR_GnomeGoblinStartSpot_83a8e4d1-29aa-4c33-91b8-f622ed90b898, WLD_FOR_GnomeGoblinStopSpot_283b6c8d-77e3-4575-8262-3d729a3b36ec);
DB_SpotPlayers_SpotTrigger(_Goblin, "FOR_GnomeGoblins", TRIGGERGUID_S_FOR_GnomeGoblinSpotArea_5c4d7246-3f71-4a87-a31d-159ef394b66f);
DB_SpotPlayers_SpotterIgnoreCantTalk(_Goblin, "FOR_GnomeGoblins");
DB_SpotPlayers_TargetIgnoreCantTalk(_Goblin, "FOR_GnomeGoblins");
DB_SpotPlayers_IncludeWildshapedPlayers(_Goblin, "FOR_GnomeGoblins");
DB_SpotPlayers_IncludeSummons(_Goblin, "FOR_GnomeGoblins");
DB_SpotPlayers_IncludeFollowers(_Goblin, "FOR_GnomeGoblins");
DB_SpotPlayers(_Goblin, "FOR_GnomeGoblins_NearLevers", (FLAG)NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(_Goblin, "FOR_GnomeGoblins_NearLevers", S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5);
DB_SpotPlayers_SpotterIgnoreCantTalk(_Goblin, "FOR_GnomeGoblins_NearLevers");
DB_SpotPlayers_TargetIgnoreCantTalk(_Goblin, "FOR_GnomeGoblins_NearLevers");
DB_SpotPlayers_IncludeWildshapedPlayers(_Goblin, "FOR_GnomeGoblins_NearLevers");
DB_SpotPlayers_IncludeSummons(_Goblin, "FOR_GnomeGoblins_NearLevers");
DB_SpotPlayers_IncludeFollowers(_Goblin, "FOR_GnomeGoblins_NearLevers");
DB_NoLowAttitudeDialog(_Goblin);
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins_NearLevers");
SetCanTrade(_Goblin, 0);

IF
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
AND
_Goblin != S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404
THEN
TriggerRegisterForCharacter(TRIGGERGUID_S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5, _Goblin);

QRY
QRY_SelectCustomDialog(_Goblin, _Source)
AND
DB_FOR_GnomeGoblins((CHARACTER)_Goblin, _, _, _)
AND
QRY_FOR_UnfortunateGnome_GoblinRequestRedirected_Clear()
AND
1 == 0
THEN
DB_NOOP(1);

QRY
QRY_FOR_UnfortunateGnome_GoblinRequestRedirected_Clear()
THEN
NOT DB_FOR_UnfortunateGnome_GoblinRequestRedirected(1); 

QRY
QRY_SelectCustomDialog(_Goblin, _Source)
AND
DB_FOR_GnomeGoblins((CHARACTER)_Goblin, _, _, _)
AND
NOT DB_InRegion((CHARACTER)_Goblin, TRIGGERGUID_S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5)
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714) // flagType: Global
AND
_Goblin != CHARACTERGUID_S_WLD_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404
AND
NOT DB_Defeated(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
AND
QRY_SelectAndStartDialog(CHARACTERGUID_S_WLD_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, _Source)
THEN
DB_FOR_UnfortunateGnome_GoblinRequestRedirected(1);

QRY
QRY_SelectCustomDialog(_Goblin, _Source)
AND
DB_FOR_GnomeGoblins((CHARACTER)_Goblin, _, _Dialog, _)
AND
NOT DB_InRegion((CHARACTER)_Goblin, TRIGGERGUID_S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5)
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714) // flagType: Global
AND
_Goblin != CHARACTERGUID_S_WLD_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404
AND
NOT DB_Defeated(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
AND
NOT DB_FOR_UnfortunateGnome_GoblinRequestRedirected(1)
AND
NOT DB_QRYRTN_StartDialog_FailReason("CrimeOverride")
AND
NOT DB_QRYRTN_StartDialog_FailReason("OriginMomentOverride")
AND
QRY_SpeakerIsAvailable(_Goblin)
THEN
DB_SelectedDialog(_Dialog, _Goblin, _Source);

PROC
PROC_DialogFlagSetup(_Dialog, _Goblin, _)
AND
DB_FOR_GnomeGoblins(_, _, _Dialog, _)
THEN
ClearFlag(FOR_UnfortunateGnome_Event_RedirectToGnomeGoblin1_282f91a8-e929-4fdd-bbc7-cf9ad5d41e5c, _Goblin, 0);

PROC
PROC_DialogFlagSetup(_Dialog, _Goblin, _)
AND
DB_FOR_GnomeGoblins(_, _, _Dialog, _)
AND
DB_DialogName((DIALOGRESOURCE)FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, _)
AND
NOT DB_InRegion((CHARACTER)_Goblin, TRIGGERGUID_S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5)
THEN
SetFlag(FOR_UnfortunateGnome_Event_RedirectToGnomeGoblin1_282f91a8-e929-4fdd-bbc7-cf9ad5d41e5c, _Goblin, 0);

PROC
PROC_SpotPlayers_Spotted(_Goblin, "FOR_GnomeGoblins", _Player)
AND
NOT QRY_SelectAndStartDialog(_Goblin, _Player)
AND
NOT DB_FOR_UnfortunateGnome_GoblinRequestRedirected(1)
AND
NOT DB_InteractiveDialogSpeaker(_, _Goblin)
AND
DB_FOR_GnomeGoblins((CHARACTER)_Goblin, _, _Dialog, _)
AND
NOT QRY_StartDialog(_Dialog, _Goblin, _Player)
THEN
SetFlag((FLAG)WLD_FOR_GnomeGoblinsAngry_42a4e444-5e6e-c574-f360-ea3cf57e4426, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
PROC_SetRelationMutual((FACTION)WLD_FOR_GnomeGoblins_c7f36445-ea01-a654-f76d-3511d32ba226, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
PROC_SetRelationMutual((FACTION)WLD_FOR_GnomeGoblins_c7f36445-ea01-a654-f76d-3511d32ba226, (FACTION)ACT1_FOR_UnfortunateGnome_b07fe550-1c04-7fed-03d4-f6ea6ff836f1, 0);

PROC
PROC_SpotPlayers_Spotted(_Goblin, "FOR_GnomeGoblins_NearLevers", _Player)
AND
NOT QRY_SelectAndStartDialog(_Goblin, _Player)
AND
DB_FOR_GnomeGoblins((CHARACTER)_Goblin, _, _Dialog, _)
AND
NOT QRY_StartDialog(_Dialog, _Goblin, _Player)
THEN
SetFlag((FLAG)WLD_FOR_GnomeGoblinsAngry_42a4e444-5e6e-c574-f360-ea3cf57e4426, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
PROC_SetRelationMutual((FACTION)WLD_FOR_GnomeGoblins_c7f36445-ea01-a654-f76d-3511d32ba226, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
PROC_SetRelationMutual((FACTION)WLD_FOR_GnomeGoblins_c7f36445-ea01-a654-f76d-3511d32ba226, (FACTION)ACT1_FOR_UnfortunateGnome_b07fe550-1c04-7fed-03d4-f6ea6ff836f1, 0);

QRY
QRY_SelectCustomDialog(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, _Player)
AND
NOT DB_Surrendered(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
AND
NOT DB_KnockedOut(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
THEN
DB_SelectedDialog(WLD_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,_Player);

PROC
PROC_DialogFlagSetup(WLD_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, _, _, _)
AND
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
THEN
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins");

IF
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
AND
NOT DB_DialogNPCs(_, _Goblin, _)
AND
NOT DB_DialogNPCs(_, S_WLD_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, _)
AND
NOT DB_DialogNPCs(_, S_WLD_GnomeGoblin2_51300d83-e9f1-4f01-a27e-27c73f9e6318, _)
AND
NOT DB_DialogNPCs(_, S_WLD_GnomeGoblin3_bff8ab5f-739d-422a-9ad3-92f4b897f1bc, _)
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsAngry_42a4e444-5e6e-c574-f360-ea3cf57e4426) // flagType: Global
AND
NOT DB_InRegion(_, TRIGGERGUID_S_FOR_GnomeGoblinSpotArea_5c4d7246-3f71-4a87-a31d-159ef394b66f)
THEN
SetFlag((FLAG)WLD_FOR_GnomeGoblinStartSpot_83a8e4d1-29aa-4c33-91b8-f622ed90b898, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

//END_REGION

//REGION If you stop the windmill while the goblins are watching, they investigate
PROC
PROC_LongRest()
THEN
NOT DB_OnlyOnce("FOR_GnomeGoblins_AD_ReactWindmillStop");

//REGION Interactive dialogue

QRY
QRY_UnfortunateGnome_Slowdown_WithGoblins((CHARACTER)_Character, (INTEGER)_SpeedUp)
AND
QRY_UnfortunateGnome_InvestiGoblinSpeakers()
AND
NOT DB_GlobalFlag(WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714)
AND
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(1, S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
AND
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(2, _Speaker2)
AND
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(3, _Speaker3)
AND
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(4, _Speaker4)
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)FOR_UnfortunateGnome_SlowDown_e5a2eee5-2eef-e746-ff88-a461d03e336c, _Character, (CHARACTER)S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, _Speaker2, _Speaker3, _Speaker4, 0, 0, 0, 0)
THEN
PROC_UnfortunateGnome_Slowdown_WithGoblins_SetFlag(_SpeedUp);

PROC
PROC_UnfortunateGnome_Slowdown_WithGoblins_SetFlag(0)
THEN
ClearFlag(FOR_UnfortunateGnome_Slowdown_WithGoblins_SpeedingUp_04992a5a-6711-4ff4-9d26-0baf5d6ddc7d, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_UnfortunateGnome_Slowdown_WithGoblins_SetFlag(1)
THEN
SetFlag(FOR_UnfortunateGnome_Slowdown_WithGoblins_SpeedingUp_04992a5a-6711-4ff4-9d26-0baf5d6ddc7d, NULL_00000000-0000-0000-0000-000000000000, 0);

QRY
QRY_UnfortunateGnome_InvestiGoblinSpeakers()
THEN
SysClear("DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers", 2);


QRY
QRY_UnfortunateGnome_InvestiGoblinSpeakers()
AND
DB_FOR_UnfortunateGnome_GnomeInvestiGoblins(_ID, _Goblin, _)
AND
NOT DB_GlobalFlag((FLAG)GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746)
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_UnfortunateGnome_State_Fast_ad363172-0964-4f0c-9f1d-4fea67834e60)
AND
QRY_SpeakerIsAvailable(_Goblin)
AND
IsInTrigger(_Goblin, S_FOR_GnomeGoblinApproach_5f593aa2-5e02-4da4-821c-c19390730370, 1)
THEN
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(_ID, _Goblin);

QRY
QRY_UnfortunateGnome_InvestiGoblinSpeakers()
AND
DB_FOR_UnfortunateGnome_GnomeInvestiGoblins(_ID, _Goblin, _)
AND
NOT DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(_ID, _Goblin)
THEN
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(_ID, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

IF
DB_GlobalFlag(GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746)
AND
NOT DB_Is_InCombat(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, _)
AND
NOT DB_DialogName((DIALOGRESOURCE)FOR_UnfortunateGnome_SlowDown_NoGoblins_8859f0e0-0d0b-e54f-c141-7dff95ae05a4, _)
AND
NOT DB_GlobalFlag((FLAG)FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714)
AND
QRY_OnlyOnce("FOR_GnomeGoblins_AD_ReactWindmillStop")
AND
NOT QRY_StartDialog(DIALOGRESOURCEGUID_FOR_GnomeGoblin1_AD_InvestigateMill_cf27ec59-299d-7a19-7d1b-7a20b4c4a7e3, S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, S_FOR_GnomeGoblin3_bff8ab5f-739d-422a-9ad3-92f4b897f1bc)
AND
DB_FOR_UnfortunateGnome_GnomeInvestiGoblins(_, _Goblin, 1)
THEN
SetEntityEvent(_Goblin, "FOR_GnomeGoblins_Investigate");

IF
DB_DialogNPCs(_ID, _Goblin, _)
AND
DB_DialogName(FOR_UnfortunateGnome_SlowDown_e5a2eee5-2eef-e746-ff88-a461d03e336c, _ID)
AND
DB_FOR_UnfortunateGnome_GnomeInvestiGoblins(_, _Goblin, 1)
THEN
DB_FOR_UnfortunateGnome_GnomeInvestiGoblinsInDialog(_ID, _Goblin);

IF
DB_FOR_UnfortunateGnome_GnomeInvestiGoblinsInDialog(_ID, _)
AND
DB_DialogNPCs(_ID, (CHARACTER)S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, _ID)
THEN
DB_OnlyOnce("FOR_GnomeGoblins_AD_ReactWindmillStop");

IF
DialogEnded(FOR_UnfortunateGnome_SlowDown_e5a2eee5-2eef-e746-ff88-a461d03e336c, _ID)
AND
NOT DB_GlobalFlag((FLAG)FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714)
AND
DB_FOR_UnfortunateGnome_GnomeInvestiGoblinsInDialog(_ID, _Goblin)
THEN
NOT DB_FOR_UnfortunateGnome_GnomeInvestiGoblinsInDialog(_ID, _Goblin);
SetEntityEvent(_Goblin, "FOR_GnomeGoblins_Investigate");

IF
AutomatedDialogEnded(DIALOGRESOURCEGUID_FOR_GnomeGoblin1_AD_InvestigateMill_cf27ec59-299d-7a19-7d1b-7a20b4c4a7e3, _)
AND
DB_FOR_UnfortunateGnome_GnomeInvestiGoblins(_, _Goblin, 1)
AND
NOT DB_GlobalFlag((FLAG)FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714)
THEN
SetEntityEvent(_Goblin, "FOR_GnomeGoblins_Investigate");

IF
EnteredTrigger(_Goblin, TRIGGERGUID_S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5)
AND
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714)
THEN
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins");
PROC_SpotPlayers_RestartSpotting(_Goblin, "FOR_GnomeGoblins_NearLevers");

IF
EnteredTrigger(_Goblin, TRIGGERGUID_S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5)
AND
DB_FOR_GnomeGoblins(_Goblin, _, _Dialog, _)
AND
_Dialog != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_Dialogs(_Goblin, _Dialog);

IF
LeftTrigger(_Goblin, TRIGGERGUID_S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5)
THEN
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins_NearLevers");

IF
LeftTrigger(_Goblin, TRIGGERGUID_S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5)
AND
DB_InternPlayerSpot_Spotting(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, "FOR_GnomeGoblins")
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714)
THEN
PROC_SpotPlayers_RestartSpotting(_Goblin, "FOR_GnomeGoblins");

IF
LeftTrigger(_Goblin, TRIGGERGUID_S_FOR_GnomeGoblins_NearLevers_ce545f6f-f2b3-4a87-9205-5d69edca93d5)
AND
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
AND
NOT DB_PermaDefeated(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Goblin);

PROC
PROC_DialogFlagSetup(_Dialog, _, _)
AND
_Dialog != FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9
AND
DB_FOR_GnomeGoblins(_, _, _Dialog, _)
AND
DB_InternPlayerSpot_Spotting(_Goblin, "FOR_GnomeGoblins_NearLevers")
THEN
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins_NearLevers");

//END_REGION

//REGION Player can free the gnome by successfully untying the rope
IF
DestroyedBy(S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, _, _, _)
THEN
PROC_WLD_FOR_UnfortunateGnomeSkillCheckPassed();

IF
FlagSet((FLAG)GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_FOR_UnfortunateGnome_OnWindMill(_Character)
THEN
TimerLaunch("FOR_WindmillRopesRemove", 1800);

IF
TimerFinished("FOR_WindmillRopesRemove")
AND
DB_FOR_UnfortunateGnome_OnWindMill(_Character)
AND
DB_GlobalFlag(GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746)
THEN
SetOnStage(S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, 1);

IF
WentOnStage(S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, 1)
AND
DB_FOR_UnfortunateGnome_OnWindMill(_Character)
THEN
PROC_StopLoopEffect(_Character, "FOR_WindmillRopes");


IF
FlagCleared((FLAG)GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_FOR_UnfortunateGnome_OnWindMill(_Character)
THEN
TimerCancel("FOR_WindmillRopesRemove");
PROC_StopLoopEffect(_Character, "FOR_WindmillRopes"); //If the timer is still in-progress, remove the effect to avoid duplicates.
PROC_LoopEffect(VFX_Script_PUZ_GEN_Tied_Ropes_A_Gnome_A_01_25f36571-f664-fcd6-5ca5-1fce4ad85444, _Character, "FOR_WindmillRopes", "WLD_Main_A", "");

IF
FlagCleared((FLAG)GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
SetOnStage(S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, 0);

IF
UseStarted(_Player, S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa)
AND
DB_GlobalFlag(FOR_GnomeGoblinsDead_8910f084-c9ad-2336-c6a7-098d71914529)
AND
DB_Players(_Player)
AND
NOT QRY_StartDialog_Fixed(DIALOGRESOURCEGUID_FOR_UnfortunateGnome_TiedUp_7cfd03aa-cbd3-997b-1da3-db66622876a2, S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, _Player)
AND
NOT QRY_StartDialog(DIALOGRESOURCEGUID_WLD_FOR_AD_UnfortunateGnomeFreed_d1c7a920-9624-339f-4fb3-5ef67d993d48, S_WLD_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
PROC_WLD_FOR_UnfortunateGnomeSkillCheckPassed();

IF
UseStarted(_Player, S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa)
AND
DB_GlobalFlag(WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714)
AND
DB_Players(_Player)
AND
NOT QRY_StartDialog_Fixed(DIALOGRESOURCEGUID_FOR_UnfortunateGnome_TiedUp_7cfd03aa-cbd3-997b-1da3-db66622876a2, S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, _Player)
AND
NOT QRY_StartDialog(DIALOGRESOURCEGUID_WLD_FOR_AD_UnfortunateGnomeFreed_d1c7a920-9624-339f-4fb3-5ef67d993d48, S_WLD_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
PROC_WLD_FOR_UnfortunateGnomeSkillCheckPassed();

PROC
PROC_CharacterPassedItemSkillCheck(_Player, _, S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa)
AND
DB_Players(_Player)
AND
NOT QRY_StartDialog(DIALOGRESOURCEGUID_WLD_FOR_AD_UnfortunateGnomeFreed_d1c7a920-9624-339f-4fb3-5ef67d993d48, S_WLD_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
PROC_WLD_FOR_UnfortunateGnomeSkillCheckPassed();

PROC
PROC_CharacterPassedItemSkillCheck(_Player, _, S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa)
AND
NOT DB_Players(_Player)
THEN
PROC_WLD_FOR_UnfortunateGnomeSkillCheckPassed();

PROC
PROC_WLD_FOR_UnfortunateGnomeSkillCheckPassed()
THEN
SetOnStage(S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, 0);
EndRepose(S_WLD_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
PROC_Helper_SafeTeleportTo(S_WLD_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_FOR_UnfortunateGnome_Dismount_f7ff4e2b-072b-4355-815d-46ef7863c8d8, "FOR_GnomeGoblin1_ReadyForFlee", 0);

PROC
PROC_WLD_FOR_UnfortunateGnomeSkillCheckPassed()
AND
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
THEN
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins");
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins_NearLevers");

IF
Dying(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
AND
DB_FOR_UnfortunateGnome_OnWindMill(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
PROC_FOR_GnomeFreed();

IF
Dying(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
AND
DB_FOR_UnfortunateGnome_OnWindMill(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
AND
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
THEN
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins");
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins_NearLevers");

IF
FlagSet(FOR_UnfortunateGnome_Event_FreeGnomeDialog_5b0e932a-2e6c-8953-6673-f113d71b6a16, _, _) // flagType: Global
THEN
PROC_WLD_FOR_UnfortunateGnomeSkillCheckPassed();

PROC
PROC_WLD_FOR_UnfortunateGnomeSkillCheckPassed()
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714) // flagType: Global
AND
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
THEN
PROC_ForceStopDialog(_Goblin);
SetHasDialog(_Goblin, 0);

IF
AutomatedDialogStarted(DIALOGRESOURCEGUID_WLD_FOR_AD_UnfortunateGnomeFreed_d1c7a920-9624-339f-4fb3-5ef67d993d48, _)
THEN
EndRepose(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
PROC_Helper_SafeTeleportTo(S_WLD_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_FOR_UnfortunateGnome_Dismount_f7ff4e2b-072b-4355-815d-46ef7863c8d8, "FOR_GnomeGoblin1_ReadyForFlee", 0);

IF
AutomatedDialogRequestFailed(DIALOGRESOURCEGUID_WLD_FOR_AD_UnfortunateGnomeFreed_d1c7a920-9624-339f-4fb3-5ef67d993d48, _)
THEN
EndRepose(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
PROC_Helper_SafeTeleportTo(S_WLD_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_FOR_UnfortunateGnome_Dismount_f7ff4e2b-072b-4355-815d-46ef7863c8d8, "FOR_GnomeGoblin1_ReadyForFlee", 0);

IF
ReposeRemoved(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,_)
THEN
SetOnStage(S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, 0);
PROC_FOR_GnomeFreed();

PROC
PROC_CharacterFailedItemSkillCheck(_Player, _, S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa)
THEN
PROC_TryStartAD(DIALOGRESOURCEGUID_WLD_FOR_AD_UnfortunateGnomePikeFail_05d00ea2-e676-0470-df8f-09dfbcfaf7b6, _Player);

IF
DialogStarted(FOR_UnfortunateGnome_TiedUp_7cfd03aa-cbd3-997b-1da3-db66622876a2, _)
THEN
ClearFlag(FOR_UnfortunateGnome_State_WasJustFreed_f4c90b9a-8ba0-4372-ae49-05fa920212d2, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogRequestFailed(FOR_UnfortunateGnome_TiedUp_7cfd03aa-cbd3-997b-1da3-db66622876a2, _)
THEN
ClearFlag(FOR_UnfortunateGnome_State_WasJustFreed_f4c90b9a-8ba0-4372-ae49-05fa920212d2, NULL_00000000-0000-0000-0000-000000000000, 0);


//END_REGION

//REGION Throwing the gnome off.
IF
FlagSet(FOR_UnfortunateGnome_Event_ThrowOff_87ddb5ee-952a-4513-8759-03d1a98e1afc, _, _ID)
AND
_ID != 0
THEN
DB_FOR_UnfortunateGnome_ThrowOffDialog(_ID);

IF
DialogEnded(_Dialog, _ID)
AND
DB_FOR_UnfortunateGnome_ThrowOffDialog(_ID)
THEN
TeleportTo(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_FOR_UnfortunateGnome_AfterFasterPoint_eb149073-0723-40c6-8776-a34f306ba29e, "", 0, 0, 1);
Die(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, DEATHTYPE.Falling, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

IF
FlagSet(GLO_DuergarCamp_EverEnteredBefore_ac0bae57-7006-4676-88b8-7498dde79c41, _, _)
THEN
SetFlag(FOR_UnfortunateGnome_Event_ThrowOff_87ddb5ee-952a-4513-8759-03d1a98e1afc, NULL_00000000-0000-0000-0000-000000000000, 0);
TeleportTo(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_FOR_UnfortunateGnome_AfterFasterPoint_eb149073-0723-40c6-8776-a34f306ba29e, "", 0, 0, 1);
Die(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, DEATHTYPE.Falling, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

IF
FlagSet(WLD_FOR_UnfortunateGnome_State_Fast_ad363172-0964-4f0c-9f1d-4fea67834e60, _, _)
AND
NOT DB_FOR_UnfortunateGnome_ThrowOffDialog(_)
AND
NOT DB_GlobalFlag((FLAG)FOR_UnfortunateGnome_State_Freed_c829895d-aba7-46e5-bc10-eb2516c8ddd6)
AND
NOT DB_DialogName(FOR_UnfortunateGnome_SpeedUp_b7098519-067a-43ee-1446-1ef3a604de87, _)
AND
NOT DB_DialogName((DIALOGRESOURCE)FOR_UnfortunateGnome_SlowDown_e5a2eee5-2eef-e746-ff88-a461d03e336c, _)
THEN
SetFlag(FOR_UnfortunateGnome_Event_ThrowOff_87ddb5ee-952a-4513-8759-03d1a98e1afc, NULL_00000000-0000-0000-0000-000000000000, 0);
TeleportTo(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_FOR_UnfortunateGnome_AfterFasterPoint_eb149073-0723-40c6-8776-a34f306ba29e, "", 0, 0, 1);
Die(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, DEATHTYPE.Falling, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

PROC
PROC_LevelUnloading("WLD_Main_A")
THEN
SetFlag(FOR_UnfortunateGnome_Event_ThrowOff_87ddb5ee-952a-4513-8759-03d1a98e1afc, NULL_00000000-0000-0000-0000-000000000000, 0);
TeleportTo(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_FOR_UnfortunateGnome_AfterFasterPoint_eb149073-0723-40c6-8776-a34f306ba29e, "", 0, 0, 1);
Die(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, DEATHTYPE.Falling, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

PROC
PROC_LevelUnloading("WLD_Main_A")
AND
DB_FOR_GnomeGoblins(_Goblin, _Trigger, _Dialog, _Delay)
AND
NOT DB_PermaDefeated(_Goblin)
AND
IsOnStage(_Goblin, 1)
THEN
NOT DB_FOR_GnomeGoblins(_Goblin, _Trigger, _Dialog, _Delay);
SetOnStage(_Goblin, 0);
SetFlag((FLAG)FOR_GnomeGoblinsReturnedHome_be23fd5b-22ed-b163-0204-779faf6e131c, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
PROC_RemoveDBTrespassTrigger(TRIGGERGUID_S_WLD_WIL_NearCapturedGnome_a877c0ce-1016-4120-9c51-6557fea123b0, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION Start a dialogue if the gnome can be taken off.
IF
FlagCleared(GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746, _, _)
THEN
PROC_RemoveNPCADs(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
PROC_RemoveAllDialogEntriesForSpeaker(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
SetHasDialog(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, 0);

IF
DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714) // flagType: Global
AND
DB_GlobalFlag(GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746)
THEN
DB_Dialogs(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, DIALOGRESOURCEGUID_FOR_UnfortunateGnome_TiedUp_7cfd03aa-cbd3-997b-1da3-db66622876a2);

IF
DB_GlobalFlag((FLAG)FOR_GnomeGoblinsDead_8910f084-c9ad-2336-c6a7-098d71914529) // flagType: Global
AND
DB_GlobalFlag(GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746)
THEN
DB_Dialogs(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, DIALOGRESOURCEGUID_FOR_UnfortunateGnome_TiedUp_7cfd03aa-cbd3-997b-1da3-db66622876a2);

IF
DB_GlobalFlag(GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746)
AND
NOT DB_GlobalFlag((FLAG)FOR_GnomeGoblinsDead_8910f084-c9ad-2336-c6a7-098d71914529) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714) // flagType: Global
THEN
DB_AD_Dialog(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, DIALOGRESOURCEGUID_WLD_AD_UnfortunateGnome_62294548-4e3c-b877-0798-a9b72630ccf5);
//END_REGION

//REGION Once the gnome is free, make the NPCs hostile (if necessary) & end the goal.
PROC
PROC_FOR_GnomeFreed()
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714) // flagType: Global
THEN
SetFlag((FLAG)WLD_FOR_GnomeGoblinsAngry_42a4e444-5e6e-c574-f360-ea3cf57e4426, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
PROC_SetRelationMutual((FACTION)WLD_FOR_GnomeGoblins_c7f36445-ea01-a654-f76d-3511d32ba226, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
PROC_SetRelationMutual((FACTION)WLD_FOR_GnomeGoblins_c7f36445-ea01-a654-f76d-3511d32ba226, (FACTION)ACT1_FOR_UnfortunateGnome_b07fe550-1c04-7fed-03d4-f6ea6ff836f1, 0);

PROC
PROC_FOR_GnomeFreed()
AND
NOT DB_PermaDefeated(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
SetFlag(FOR_UnfortunateGnome_State_Freed_c829895d-aba7-46e5-bc10-eb2516c8ddd6, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_FOR_GnomeFreed()
THEN
GoalCompleted;

PROC
PROC_StateSet_PermaDefeated(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
GoalCompleted;
//END_REGION

//REGION Once all the goblins are dead or allow it, freeing the gnome no longer requires a check.
IF
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
THEN
DB_GLO_DefeatCounter(_Goblin, "FOR_GnomeGoblins");

IF
FlagSet(WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714, _, _) // flagType: Global
THEN
PROC_RemoveDBTrespassTrigger(TRIGGERGUID_S_WLD_WIL_NearCapturedGnome_a877c0ce-1016-4120-9c51-6557fea123b0, NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(FOR_GnomeGoblinsDead_8910f084-c9ad-2336-c6a7-098d71914529, _, _)
THEN
NOT DB_FallibleCheckItem("FOR_UnfortunateGnomeChains", S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, "SleightOfHand", (DIFFICULTYCLASS)DC_Legacy_10_625be976-7a67-4394-97c8-14c69715ae4b, "", (ANIMATION)ANIMATION_Fidget_Forward_01_00000000-0000-0000-0000-000000000000);

IF
FlagSet(WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714, _, _)
THEN
NOT DB_FallibleCheckItem("FOR_UnfortunateGnomeChains", S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, "SleightOfHand", (DIFFICULTYCLASS)DC_Legacy_10_625be976-7a67-4394-97c8-14c69715ae4b, "", (ANIMATION)ANIMATION_Fidget_Forward_01_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION Goblins walk away once they are pacified
IF
FlagSet(WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714, _, _) // flagType: Global
AND
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
THEN
SetCanTrade(_Goblin, 0);
PROC_SpotPlayers_StopSpotting(_Goblin, "FOR_GnomeGoblins_NearLevers");

IF
DB_FOR_GnomeGoblins(_Goblin, _, _, _)
AND
NOT DB_DialogNPCs(_, _Goblin, _)
AND
NOT DB_DialogNPCs(_, S_WLD_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, _)
AND
NOT DB_DialogNPCs(_, S_WLD_GnomeGoblin2_51300d83-e9f1-4f01-a27e-27c73f9e6318, _)
AND
NOT DB_DialogNPCs(_, S_WLD_GnomeGoblin3_bff8ab5f-739d-422a-9ad3-92f4b897f1bc, _)
AND
DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsAngry_42a4e444-5e6e-c574-f360-ea3cf57e4426) // flagType: Global
AND
QRY_OnlyOnce("FOR_GnomeGoblinsLeavePacified")
THEN
PROC_FOR_GnomeGoblins_LeavePacified();

//END_REGION

//REGION What happens to the satchel?
IF
AttackedBy(S_FOR_UnfortunateGnome_BlackpowderSatchel_67a1414e-354e-433a-9ca5-745bd688c939, _AttackerOwner, _Attacker, "Fire", _, _, _)
AND
GetDistanceTo(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_FOR_UnfortunateGnome_BlackpowderSatchel_67a1414e-354e-433a-9ca5-745bd688c939, _Dist)
AND
_Dist <= 18.0
AND
QRY_GetCharacterOwnerIfItemSummon(_AttackerOwner,_Attacker)
AND
DB_QRYRTN_GetCharacterOwnerIfItemSummon(_ResolvedAttacker)
THEN
PROC_FOR_UnfortunateGnome_SatchelExploded((CHARACTER)_ResolvedAttacker);

PROC
PROC_FOR_UnfortunateGnome_SatchelExploded((CHARACTER)_Attacker)
AND
DB_Is_InCombat(_Attacker, _ID)
AND
DB_Is_InCombat(_OtherPlayer, _ID)
AND
DB_Players((CHARACTER)_OtherPlayer)
THEN
SetFlag((FLAG)FOR_UnfortunateGnome_State_SatchelExploded_9e10fc33-8904-4809-8379-81f38a5a6139, _OtherPlayer); // flagType: User

PROC
PROC_FOR_UnfortunateGnome_SatchelExploded((CHARACTER)_Attacker)
THEN
SetFlag((FLAG)FOR_UnfortunateGnome_State_SatchelExploded_9e10fc33-8904-4809-8379-81f38a5a6139, _Attacker); // flagType: User

PROC
PROC_FOR_UnfortunateGnome_SatchelExploded((CHARACTER)_Attacker)
AND
DB_Players(_Player)
AND
GetDistanceTo(S_FOR_UnfortunateGnome_BlackpowderSatchel_67a1414e-354e-433a-9ca5-745bd688c939, _Player, _DistPlayer)
AND
_DistPlayer <= 18.0
THEN
SetFlag((FLAG)FOR_UnfortunateGnome_State_SatchelExploded_9e10fc33-8904-4809-8379-81f38a5a6139, _Player); // flagType: User

IF
AddedTo(S_FOR_UnfortunateGnome_BlackpowderSatchel_67a1414e-354e-433a-9ca5-745bd688c939, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
GetDistanceTo(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, _Player, _Dist)
AND
_Dist <= 18.0
THEN
SetFlag((FLAG)FOR_UnfortunateGnome_State_HadSatchel_bee0372e-aa78-45e2-8c65-d5ab0372b5e4, _Player); // flagType: User //Don't clear - the player picked it up.

//END_REGION

//REGION Automated calculating values of bribe
IF
DB_DialogMoneyTransfer(1, FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, _Number, 3)
AND
IntegerDivide(_Number, 2, _Number3)
AND
IntegerDivide(_Number, 4, _Number4)
AND
IntegerDivide(_Number, 10, _Number5)
THEN
DB_DialogMoneyTransfer(3, FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, _Number3, 3);
DB_DialogMoneyTransfer(4, FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, _Number4, 3);
DB_DialogMoneyTransfer(5, FOR_GnomeGoblin1_6b85e9ac-82c4-9126-cce2-4d0259475ae9, _Number5, 3);
//END_REGION

//REGION Death of a Goblin

PROC
PROC_StateSet_Defeated(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714) // flagType: Global
AND
NOT DB_Surrendered((CHARACTER)S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
AND
DB_FOR_GnomeGoblins(_Goblin, _, _Dialog, _)
AND
_Goblin != S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404
THEN
DB_Dialogs(_Goblin, _Dialog);
SetFlag(FOR_GnomeGoblin1_State_Incapacitated_6effeebc-285b-4846-9098-488f6f192139, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_StateCleared_Defeated(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
AND
DB_FOR_GnomeGoblins(_Goblin, _, _Dialog, _)
AND
_Dialog != NULL_00000000-0000-0000-0000-000000000000
AND
_Goblin != S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Goblin);
ClearFlag(FOR_GnomeGoblin1_State_Incapacitated_6effeebc-285b-4846-9098-488f6f192139, NULL_00000000-0000-0000-0000-000000000000, 0);
//END_REGION

//REGION Goblin Hostility
IF
FlagSet(WLD_FOR_GnomeGoblinsAngry_42a4e444-5e6e-c574-f360-ea3cf57e4426, _, _ID) // flagType: Object
THEN
DB_FOR_GnomeGoblins_HostileAfterDialog(_ID);

IF
DialogEnded(_, _ID)
AND
DB_FOR_GnomeGoblins_HostileAfterDialog(_ID)
THEN
PROC_SetRelationMutual((FACTION)WLD_FOR_GnomeGoblins_c7f36445-ea01-a654-f76d-3511d32ba226, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);

IF
EnteredCombat(_Goblin, _)
AND
DB_FOR_GnomeGoblins((CHARACTER)_Goblin, _, _, _)
AND
DB_FOR_GnomeGoblins(_OtherGoblin, _, _, _)
AND
IsSpeakerReserved(_OtherGoblin, 1)
THEN
PROC_ForceStopDialog(_OtherGoblin);

//END_REGION

//REGION Gnome screams for help while turning.
IF
DualEntityEvent(_, _, "FOR_UnfortunateGnome_Lever")
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_UnfortunateGnome_State_Fast_ad363172-0964-4f0c-9f1d-4fea67834e60)
THEN
PROC_FOR_UnfortunateGnomeMillRotatingFasterReaction();

PROC
PROC_FOR_UnfortunateGnomeMillRotatingFasterReaction()
AND
DB_FOR_UnfortunateGnomeMillRotatingFasterReaction(_Counter)
AND
QRY_SpeakerIsAvailable(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
AND
IntegerSum(_Counter, 1, _NewCounter)
THEN
NOT DB_FOR_UnfortunateGnomeMillRotatingFasterReaction(_Counter);
DB_FOR_UnfortunateGnomeMillRotatingFasterReaction(_NewCounter);
PROC_TryStartAD(DIALOGRESOURCEGUID_FOR_UnfortunateGnome_AD_RotatingFasterReaction_c7a37e9f-0406-5e21-532f-46f111158aef, S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);

IF
DB_FOR_UnfortunateGnomeMillRotatingFasterReaction(3)
THEN
NOT DB_FOR_UnfortunateGnomeMillRotatingFasterReaction(3);
//END_REGION

EXITSECTION
SetHasDialog(S_WLD_GnomeGoblin2_51300d83-e9f1-4f01-a27e-27c73f9e6318, 0);
SetHasDialog(S_WLD_GnomeGoblin3_bff8ab5f-739d-422a-9ad3-92f4b897f1bc, 0);
PROC_RemoveNPCADs(S_WLD_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
PROC_RemoveAllDialogEntriesForSpeaker(S_WLD_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
DB_Dialogs(S_WLD_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, DIALOGRESOURCEGUID_FOR_UnfortunateGnome_eb447f2f-14f4-df3f-24d3-f2aa0b2bc4f4);
DB_SpotPlayers(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, "FOR_UnfortunateGnome", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

NOT DB_FallibleCheckItem("FOR_UnfortunateGnomeChains", S_FOR_UnfortunateGnomeChains_Free_6c85929a-dfa7-4a2e-8cf3-60a31493e5fa, "SleightOfHand", (DIFFICULTYCLASS)DC_Legacy_10_625be976-7a67-4394-97c8-14c69715ae4b, "", (ANIMATION)ANIMATION_Fidget_Forward_01_00000000-0000-0000-0000-000000000000);

PROC_UND_DEBUG_UnfortunateGnome_Setup();

SysClear("DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers", 2);
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(1, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(2, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(3, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_UnfortunateGnome_InvestiGoblinSpeakers(4, NULL_00000000-0000-0000-0000-000000000000);
ENDEXITSECTION
ParentTargetEdge "Act1"
