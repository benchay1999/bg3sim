Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, DIALOGRESOURCEGUID_GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256);

DB_GOB_ChickenChase_Ball((CHARACTER)S_GOB_Festivities_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785);

/* Not used anymore. Left for reference, these Spectator Points are now assigned in Anubis
DB_GOB_ChickenChase_Spectators(S_GOB_Festivities_Goblin_000_031e9fb7-136a-46c7-91d7-77ce3e20236a, S_GOB_ChickenChase_SpectatorPoint_000_af5caf7a-ea65-46fa-9179-daa46b7eefb3);
DB_GOB_ChickenChase_Spectators(S_GOB_Festivities_Goblin_003_0296a9f6-b2bc-46a0-8632-ba72679a36d3, S_GOB_ChickenChase_SpectatorPoint_003_dd5fa011-6a59-4ec8-9510-3560d9a56029);
DB_GOB_ChickenChase_Spectators(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, S_GOB_ChickenChase_SpectatorPoint_004_8e0cba26-1815-4e9c-92f9-cf11238aeddb);
DB_GOB_ChickenChase_Spectators(S_GOB_Festivities_Goblin_005_a955aea9-9040-4d4c-9264-e46e385dea94, S_GOB_ChickenChase_SpectatorPoint_005_980c5123-eec4-4d91-a4b4-43eb1a3765e2);
DB_GOB_ChickenChase_Spectators(S_GOB_Festivities_Goblin_006_f3f416d1-b946-4019-95ba-7053f63dd776, S_GOB_ChickenChase_SpectatorPoint_006_a6679e81-14a4-4e67-868a-31cb73338caf);
DB_GOB_ChickenChase_Spectators(S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0, S_GOB_ChickenChase_SpectatorPoint_007_6271d3a7-a8dc-4ec5-a462-68a5a7f005e2);*/

DB_GOB_ChickenChase_FieldPart((TRIGGER)S_GOB_Commentator_LeftOut_1f261b58-0623-427b-8b4f-82119b0ca1be,(FLAG)GOB_ChickenChase_State_LeftOut_3992d361-b602-7b2a-ba55-ff4c5189f901);
DB_GOB_ChickenChase_FieldPart(S_GOB_Commentator_NearExit_9d3205a2-a7d0-418e-a0fa-bf1a746e5c11,GOB_ChickenChase_State_NearExit_732b9d4e-d858-9613-742f-b0715fdee612);
DB_GOB_ChickenChase_FieldPart(S_GOB_Commentator_NearGates_b06ce4cb-0596-4e15-bec3-a4e8de8cc797,GOB_ChickenChase_State_NearGates_5c88c20d-016f-6cfb-7b12-807fd4bbf1a3);
DB_GOB_ChickenChase_FieldPart(S_GOB_Commentator_RightOut_20d21013-9b2b-4352-a365-323eb32936ca,GOB_ChickenChase_State_RightOut_ef8488d5-89aa-566e-060f-fc9ae7f2f559);
DB_GOB_ChickenChase_LastAD((FLAG)NULL_00000000-0000-0000-0000-000000000000);

PROC_TriggerRegisterForPlayers(S_GOB_ChickenChase_StartArea_37352f92-b862-47f8-ae3a-9c0a3f4a31d1);
PROC_TriggerRegisterForPlayers(S_GOB_ChickenChase_GameRing_feb54bd2-75dd-43cd-a7b1-bdc8a12026e5);
PROC_TriggerRegisterForPlayers(S_GOB_ChickenChase_LeftRingTrigger_c9cdf63a-b1bf-431d-9d09-3c76e9ae12a1);

TriggerRegisterForCharacter(S_GOB_ChickenChase_CommentatorArea_4aeac57c-d4e8-4a20-882c-231b2b039299, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);
TriggerRegisterForCharacter(S_GOB_ChickenChase_ChickenShovePoint_2e97f1e8-123c-4dde-be45-67ad8b49453c, S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785);
TriggerRegisterForCharacter(S_GOB_ChickenChase_OwlbearStartPoint_6c2de754-b12a-4b2a-8d7c-66c8aa6d3be7, S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);

DB_GOB_ChickenChase_OwlbearDiscussion((CHARACTER)S_GOB_Festivities_Goblin_000_031e9fb7-136a-46c7-91d7-77ce3e20236a, (TRIGGER)S_GOB_OwlbearDiscussionPoint_000_11b4e93a-2f05-46ba-99c8-81f1ab2ea9dd);
DB_GOB_ChickenChase_OwlbearDiscussion(S_GOB_Festivities_Goblin_001_774c78ed-1227-48f9-812e-aac0021c71bf, S_GOB_OwlbearDiscussionPoint_001_359097c2-31c3-47ef-bbc0-c6fdefaba37f);
DB_GOB_ChickenChase_OwlbearDiscussion(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, S_GOB_Festivities_TableTrigger_Commentator_e5775bee-7cce-47d5-a894-74fad0931867);
DB_GOB_ChickenChase_OwlbearDiscussion(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, NULL_00000000-0000-0000-0000-000000000000);

DB_GlobalFlagReactionAfterDialog(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256);
DB_GlobalFlagReactionAfterDialog(GOB_Festivities_ChickenAttack_19172c12-41db-7409-03ca-2933747c0561, GOB_ChickenChase_Ball_1c9415de-3317-9b39-5639-87429bb8c777);

DB_FlagReactionAfterDialog(GOB_ChickenChase_Event_OwlbearAttack_9eb04a84-4c3e-6d20-2a19-f3ff09f3047d, GOB_ChickenChase_Owlbear_b617a785-1b83-f772-8e86-a1aebe05a707);

DB_FlagReactionAfterDialog(GOB_Festivities_BallToldAboutGates_67c96492-3a87-8278-e2ee-2b0a8bd7aeb7, GOB_ChickenChase_Ball_1c9415de-3317-9b39-5639-87429bb8c777);
DB_FlagReactionAfterDialog(GOB_Festivities_BallToldAboutGates_67c96492-3a87-8278-e2ee-2b0a8bd7aeb7, GOB_ChickenChase_Owlbear_b617a785-1b83-f772-8e86-a1aebe05a707);

DB_GOB_ChickenChase_OwlbearAcquisitionDialogs((DIALOGRESOURCE)GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256);
DB_GOB_ChickenChase_OwlbearAcquisitionDialogs((DIALOGRESOURCE)GOB_ChickenChase_Owlbear_b617a785-1b83-f772-8e86-a1aebe05a707);

AddGold(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, 300);
DB_DialogMoneyTransfer(1, GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, 30, 2, 1); // The Player, small bet
DB_DialogMoneyTransfer(2, GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, 300, 2, 1); // The Player, big bet
DB_DialogMoneyTransfer(3, GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, 60, 1, 1); // The Commentator, small winnings
DB_DialogMoneyTransfer(4, GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, 600, 1, 1); // The Commentator, big winnings
DB_DialogMoneyTransfer(5, GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, 500, 2, 1); // Buying the owlbear
DB_DialogMoneyTransfer(6, GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, 10, 2, 1); // charlatan (small bet)
DB_DialogMoneyTransfer(7, GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, 100, 2, 1); // charlatan (big bet)

DB_ItemOwnerShipTriggers("WLD_Main_A", S_GOB_ChickenChase_OwnershipTigger_7148555f-dc54-4ddd-8467-ab08db4ecfdd, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);
ClearOwnership(S_GOB_BuriedMound_02_051d672e-3f83-4216-8b01-467e4d247f84);
ClearOwnership(S_GOB_BuriedChest_02_a276d029-79fe-405a-8687-ae04841c0acb);

DB_GOB_ChickenChase_GreaseBottles((TRIGGER)S_GOB_ChickenChase_OilBarrelTrigger_000_a951079c-e987-4f0c-9f70-ad584e7428e5, (CHARACTER)S_GOB_Festivities_Goblin_005_a955aea9-9040-4d4c-9264-e46e385dea94);
SetFlag(Debug_GOB_ChickenChase_State_FireDisabled_14182872-d77d-4f5d-9ff7-cea5a0533c53, NULL_00000000-0000-0000-0000-000000000000); // hides an already recorded line in the Commentator dialog
KBSECTION
//REGION Debug
IF
TextEvent("debug_fireworks")
THEN
PROC_GOB_ChickenChase_Fireworks();

IF
FlagSet(Debug_Quest_OwlbearToCamp_a1279bc2-6ad8-b2d8-08bd-6c6626f65c94, _Player, _)
THEN
PROC_FOR_OwlBear_LastCubResolution(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);

IF
FlagSet(Debug_Quest_ScoreChickenChase_8dc7b04a-2f3a-d5fe-cdb0-3e4ce1eb52b1, _Player, _)
AND
DB_GOB_ChickenChase_Ball(_Ball)
THEN
PROC_CharacterMoveTo(_Ball, S_GOB_ChickenChase_FootballGatesBox_8cdc4a7f-9972-4578-b545-2383faf65c60, "Run", "");
//END_REGION Debug

//REGION Owlbear flow
// If the players or the commentator are dead then we don't do this since the chase won't start
// Teleportation only happens when there is no players in the area
IF
EntityEvent(_Owlbear, "FOR_Owlbear_LastCubResolution_ToGoblinCamp")
AND
NOT QRY_GOB_ChickenChase_OwlbearDiscussionNPCsUnavailable()
THEN
PROC_GOB_Festivities_TeleportNPCToFestivities((CHARACTER)_Owlbear, "GOB_ChickenChase_Event_OwlbearCubTeleported", S_GOB_ChickenChase_OwlbearAppearPosition_10a6b193-be30-4094-84ac-c968d2a0e810);

IF
EntityEvent(_Owlbear, "FOR_Owlbear_LastCubResolution_ToGoblinCamp")
AND
QRY_GOB_ChickenChase_OwlbearDiscussionNPCsUnavailable()
THEN
SetFlag(GOB_ChickenChase_State_OwlbearAcquired_da704027-02ea-717c-4390-f538e5e5cd7a);
PROC_RemoveAllDialogEntriesForSpeaker(_Owlbear);

QRY
QRY_GOB_ChickenChase_OwlbearDiscussionNPCsUnavailable()
AND
DB_GOB_ChickenChase_OwlbearDiscussionNPC_PermaDefeated(1)
THEN
DB_NOOP(1);

// Handling edge case when all festivities goblins have left together with the owlbear discussion NPCs
QRY
QRY_GOB_ChickenChase_OwlbearDiscussionNPCsUnavailable()
AND
DB_CAMP_GoblinHuntCelebration_BetraylFightComplete(1)
AND
NOT DB_GlobalFlag(CAMP_GoblinHuntCelebration_State_DrowBetrayalOver_75aa1308-f580-e495-4893-09d215528472)
THEN
DB_NOOP(1);

IF
DB_PermaDefeated(_Character)
AND
DB_GOB_ChickenChase_OwlbearDiscussion((CHARACTER)_Character,_)
AND
NOT DB_GOB_ChickenChase_OwlbearDiscussionNPC_PermaDefeated(1)
THEN
DB_GOB_ChickenChase_OwlbearDiscussionNPC_PermaDefeated(1);

// setup the scene
IF
EntityEvent(_Owlbear, "GOB_ChickenChase_Event_OwlbearCubTeleported")
THEN
PROC_GOB_ChickenChase_ReplaceChickenWithOwlbear();
SetEntityEvent(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, "GOB_ChickenChase_OwlbearInGoblinCamp");
SetFaction(_Owlbear, (FACTION)ACT1_GOB_OwlbearCub_449efa78-d66d-a301-7944-f08f233fb5e7);
PROC_RemoveAllDialogEntriesForSpeaker(_Owlbear);
DB_Dialogs(_Owlbear, GOB_ChickenChase_Owlbear_b617a785-1b83-f772-8e86-a1aebe05a707);
SetFlag(GOB_ChickenChase_Event_OwlbearDiscussion_b0364ea7-a813-4d71-aebb-13bea72c812a, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(GOB_ChickenChase_State_OwlbearReplacedChicken_aabd6c48-57e4-12bb-8123-912f747f1f07, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(GOB_ChickenChase_Event_OwlbearDiscussion_b0364ea7-a813-4d71-aebb-13bea72c812a, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_GOB_ChickenChase_OwlbearDiscussion(_Goblin, _Trigger)
AND
_Trigger != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_TryStopDialogFor(_Goblin);
TeleportTo(_Goblin, _Trigger);
LookFromTrigger(_Goblin, _Trigger, 0);

IF
FlagSet(GOB_ChickenChase_Event_OwlbearDiscussion_b0364ea7-a813-4d71-aebb-13bea72c812a,NULL_00000000-0000-0000-0000-000000000000,_)
THEN
DB_GOB_ChickenChase_OwlbearIntro(1);

QRY
QRY_SelectCustomDialog((CHARACTER)_OwlbearDiscussionParticipant, _Player)
AND
DB_GOB_ChickenChase_OwlbearIntro(1)
AND
DB_GOB_ChickenChase_OwlbearDiscussion(_OwlbearDiscussionParticipant, _)
AND
NOT QRY_GOB_ChickenChase_IsWildShapedPlayerTalkingToOwlbearCub((CHARACTER)_Player,_OwlbearDiscussionParticipant)
THEN
DB_SelectedDialog(DIALOGRESOURCEGUID_GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _Player);

QRY
QRY_SelectCustomDialog((CHARACTER)_OwlbearDiscussionParticipant, _Player)
AND
DB_GOB_ChickenChase_OwlbearIntro(1)
AND
DB_GOB_ChickenChase_OwlbearDiscussion(_OwlbearDiscussionParticipant, _)
AND
QRY_GOB_ChickenChase_IsWildShapedPlayerTalkingToOwlbearCub((CHARACTER)_Player,_OwlbearDiscussionParticipant)
THEN
DB_SelectedDialog(GOB_ChickenChase_Owlbear_b617a785-1b83-f772-8e86-a1aebe05a707, _OwlbearDiscussionParticipant, _Player);

QRY
QRY_GOB_ChickenChase_IsWildShapedPlayerTalkingToOwlbearCub((CHARACTER)_Player,(CHARACTER)_OwlbearDiscussionParticipant)
AND
DB_Is_WildShaped(_Player)
AND
_OwlbearDiscussionParticipant == S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09
THEN
DB_NOOP(1);

IF
DialogEnded(GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, _ID)
AND
GetFlag(GOB_ChickenChase_Event_OwlbearAcquired_775e6984-4640-41d3-97e5-b1f96c572ddd, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
GetFlag(GOB_OwlbearCub_Event_InvitedToCamp_2b4acc5e-fe2f-0f0b-8945-043403b50e2f, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
DialogGetInvolvedPlayer(_ID, 1, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
DB_GOB_ChickenChase_OwlbearIntro(1)
AND
QRY_StartDialog_Fixed(GOB_ChickenChase_Owlbear_b617a785-1b83-f772-8e86-a1aebe05a707, S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, _Player)
THEN
DB_NOOP(1);

IF
DialogEnded(GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, _)
AND
DB_GOB_ChickenChase_OwlbearIntro(1)
AND
NOT DB_GlobalFlag(GOB_VoloBallad_State_OnStage_0bc1d7d7-9129-4c6e-188d-054640cea3b9)
THEN
NOT DB_GOB_ChickenChase_OwlbearIntro(1);
PROC_GOB_ChickenChase_OwlbearIntroEnded();

IF
DialogEnded(_Dialog, _ID)
AND
DB_GOB_ChickenChase_OwlbearAcquisitionDialogs(_Dialog)
AND
GetFlag(GOB_ChickenChase_Event_OwlbearAcquired_775e6984-4640-41d3-97e5-b1f96c572ddd, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
GetFlag(GOB_OwlbearCub_Event_InvitedToCamp_2b4acc5e-fe2f-0f0b-8945-043403b50e2f, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DialogGetInvolvedPlayer(_ID, 1, _Player)
THEN
PROC_GOB_ChickenChase_OwlbearAcquired((CHARACTER)_Player);

PROC
PROC_GOB_ChickenChase_OwlbearAcquired((CHARACTER)_Player)
AND
QRY_OnlyOnce("GOB_ChickenChase_PlayerAcquiredOwlbearCub")
THEN
PROC_GOB_ChickenChase_OwlbearAcquired_Internal();
DB_GOB_ChickenChase_Acquirer((CHARACTER)_Player);
PROC_CharacterMoveTo(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, _Player, "Run", "GOB_ChickenChase_CubMovedToPlayerThenCamp");

PROC
PROC_GOB_ChickenChase_OwlbearAcquired()
AND
QRY_OnlyOnce("GOB_ChickenChase_PlayerAcquiredOwlbearCub")
THEN
PROC_GOB_ChickenChase_OwlbearAcquired_Internal();

PROC
PROC_GOB_ChickenChase_OwlbearAcquired_Internal()
THEN
SetFlag(GOB_ChickenChase_State_OwlbearAcquired_da704027-02ea-717c-4390-f538e5e5cd7a, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(GOB_ChickenChase_State_BallIsDead_4d3be956-dcdf-3199-0e53-d76cf6f66051, NULL_00000000-0000-0000-0000-000000000000); // disabling the chicken chase
PROC_GOB_ChickenChase_OwlbearIntroEnded();

IF
EntityEvent((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, "GOB_ChickenChase_CubMovedToPlayerThenCamp")
AND
DB_GOB_ChickenChase_Acquirer(_Player)
THEN
NOT DB_GOB_ChickenChase_Acquirer(_Player);
StartVoiceBark(GOB_ChickenChase_VB_AcquiredOwlbear_2397f90d-eaf5-a3bb-785b-d57d3e41a83a, _Player);
PROC_GOB_ChickenChase_MoveOwlbearToCamp(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);

PROC
PROC_GOB_ChickenChase_OwlbearIntroEnded()
THEN
ClearFlag((FLAG)GOB_ChickenChase_Event_OwlbearDiscussion_b0364ea7-a813-4d71-aebb-13bea72c812a, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_ChickenChase_OwlbearIntroEnded()
AND
DB_GOB_ChickenChase_OwlbearDiscussion(_Participant, _)
THEN
PROC_ForceStopDialog(_Participant);

PROC
PROC_FlagReactionAfterDialog((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, GOB_ChickenChase_Event_OwlbearAttack_9eb04a84-4c3e-6d20-2a19-f3ff09f3047d)
THEN
PROC_CharacterMoveTo(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "Run", "GOB_ChickenChase_OwlbearAttack");

IF
EntityEvent(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, "GOB_ChickenChase_OwlbearAttack")
THEN
Attack(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, 1);

IF
AttackedBy(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, _, _, _, _, _)
THEN
PROC_MakeNPCHostile(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);

IF
DB_Defeated(_Participant)
AND
DB_GOB_ChickenChase_OwlbearDiscussion((CHARACTER)_Participant, _)
AND
DB_GOB_ChickenChase_OwlbearIntro(1)
THEN
NOT DB_GOB_ChickenChase_OwlbearIntro(1);
PROC_GOB_ChickenChase_OwlbearIntroEnded();
//END_REGION Owlbear flow

//REGION Replacing the chicken with the owlbear cub
PROC
PROC_GOB_ChickenChase_ReplaceChickenWithOwlbear()
AND
GetFlag((FLAG)GOB_ChickenChase_State_BallIsDead_4d3be956-dcdf-3199-0e53-d76cf6f66051, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
ClearFlag((FLAG)GOB_ChickenChase_State_BallIsDead_4d3be956-dcdf-3199-0e53-d76cf6f66051, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_ChickenChase_ReplaceChickenWithOwlbear()
AND
NOT DB_Dead(S_GOB_Festivities_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785)
THEN
Die(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 0);
TeleportTo(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, S_GOB_ChickenChase_DeadChickenPosition_b123645f-bfcb-4d49-95ce-fa106834a14e, "", 0, 0, 0);
SetOnStage(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, 0);

PROC
PROC_GOB_ChickenChase_ReplaceChickenWithOwlbear()
THEN
PROC_GOB_ChickenChase_UnregisterTriggersFor(S_GOB_Festivities_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785);
NOT DB_GOB_ChickenChase_Ball(S_GOB_Festivities_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785);
DB_GOB_ChickenChase_Ball(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);
//END_REGION Replacing the chicken with the owlbear cub

//REGION Intro scene (if Volo has not arrived to Goblin Camp)
IF
EnteredTrigger(_Player, S_GOB_Festivities_BingeArea_f4a4031d-7e0c-45b8-970b-47c62d4908d8)
AND
QRY_OnlyOnce("GOB_ChickenChase_IntroEvent")
AND
NOT DB_GlobalFlag((FLAG)GOB_VoloBallad_State_OnStage_0bc1d7d7-9129-4c6e-188d-054640cea3b9)
THEN
SetFlag((FLAG)GOB_ChickenChase_Quest_Intro_88253a4f-d618-8945-1473-5362d63c1829, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagCleared(GOB_VoloBallad_State_OnStage_0bc1d7d7-9129-4c6e-188d-054640cea3b9, _, _)
AND
NOT DB_GlobalFlag((FLAG)GOB_ChickenChase_State_ChaseIntroduced_79cb96c2-8d50-40c1-8bce-4d4e12d2d484)
AND
NOT DB_GOB_ChickenChase_OwlbearIntro(1)
THEN
SetFlag((FLAG)GOB_ChickenChase_Quest_Intro_88253a4f-d618-8945-1473-5362d63c1829, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Return to intro

//REGION Chicken Suicide Run
PROC
PROC_GlobalFlagReactionAfterDialog(GOB_Festivities_ChickenAttack_19172c12-41db-7409-03ca-2933747c0561)
THEN
PROC_CharacterMoveTo(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "Run", "GOB_ChickenChase_ChickenAttack");

IF
EntityEvent(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, "GOB_ChickenChase_ChickenAttack")
THEN
PROC_SetCanFight(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, 1);
PROC_MakeNPCHostile(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);
//END_REGION

//REGION Start chase
IF
DialogEnded(DIALOGRESOURCEGUID_GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, _Id)
AND
DialogGetInvolvedPlayer(_Id, 1, (CHARACTER)_Player)
AND
GetFlag(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
DetachFromPartyGroup(_Player);

PROC
PROC_GlobalFlagReactionAfterDialog(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed)
THEN
PROC_GOB_ChickenChase_StartChase();

PROC
PROC_GOB_ChickenChase_StartChase()
THEN
SetFlag(GOB_ChickenChase_State_ChaseIntroduced_79cb96c2-8d50-40c1-8bce-4d4e12d2d484, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, _, _)
THEN
SetFlag(GOB_ChickenChase_State_PlayedOnce_ccfb238d-915d-422d-b63a-b627b0417fcd,NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_ChickenChase_Quest_Intro_88253a4f-d618-8945-1473-5362d63c1829, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_ChickenChase_State_LeftRing_e95c9b62-8b8a-4f31-bdb8-3777d5a11a0a, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_ChickenChase_State_TimeIsOut_76a6939e-b3f1-4687-ae9a-971a57c1c523, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_ChickenChase_State_ExtraPlayer_ddb5220c-4fc8-451e-bb65-80087f3ffa88, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_ChickenChase_StartChase()
AND
DB_GOB_ChickenChase_Winner(_Winner)
THEN
NOT DB_GOB_ChickenChase_Winner(_Winner);
ClearFlag((FLAG)GOB_ChickenChase_Quest_Winner_8cc28e29-0b10-0496-04c1-69db3397722c, _Winner);

PROC
PROC_GOB_ChickenChase_StartChase()
THEN
SetHasDialog(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, 0);
ObjectTimerLaunch(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase_DialogDelay", 1000);
LookAtEntity(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, S_GOB_Commentator_CallLookAt_3a075c87-8747-46e6-a7d6-b60808674140);

IF
ObjectTimerFinished(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase_DialogDelay")
THEN
PROC_TryStartAD(GOB_ChickenChase_AD_GameStarts_44ff6ccd-fe78-16e7-6bfc-390b03eaba79, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);
ObjectTimerLaunch(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase_ForceStart", 1000);

// The commentator might be in a crime dialog when she is supposed to start an AD
IF
ObjectTimerFinished(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase_ForceStart")
AND
DB_GOB_ChickenChase_StartedGame(1)
THEN
NOT DB_GOB_ChickenChase_StartedGame(1);

IF
ObjectTimerFinished(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase_ForceStart")
AND
NOT DB_GOB_ChickenChase_StartedGame(1)
THEN
PROC_GOB_ChickenChase_MoveCommentatorToGame();
PROC_GOB_ChickenChase_MoveBallToGame();
//PROC_GOB_ChickenChase_MoveFansToGameWithDelay();

IF
AutomatedDialogStarted(GOB_ChickenChase_AD_GameStarts_44ff6ccd-fe78-16e7-6bfc-390b03eaba79, _ID)
THEN
DB_GOB_ChickenChase_StartedGame(1);
PROC_GOB_ChickenChase_MoveCommentatorToGame();
PROC_GOB_ChickenChase_MoveBallToGame();

IF
AutomatedDialogRequestFailed(GOB_ChickenChase_AD_GameStarts_44ff6ccd-fe78-16e7-6bfc-390b03eaba79, _ID)
THEN
DB_GOB_ChickenChase_StartedGame(1);
PROC_GOB_ChickenChase_MoveCommentatorToGame();
PROC_GOB_ChickenChase_MoveBallToGame();

PROC
PROC_GOB_ChickenChase_MoveBallToGame()
AND
DB_GOB_ChickenChase_Ball(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
THEN
PROC_CharacterMoveTo(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,S_GOB_ChickenChase_OwlbearStartPoint_6c2de754-b12a-4b2a-8d7c-66c8aa6d3be7,"Run","");

PROC
PROC_GOB_ChickenChase_MoveCommentatorToGame()
AND
IsInTrigger(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, S_GOB_ChickenChase_CommentatorArea_4aeac57c-d4e8-4a20-882c-231b2b039299, 0)
THEN
PROC_CharacterMoveTo(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, S_GOB_ChickenChase_CommentatorPoint_0408bdfe-5b6e-4cec-8bd0-661b8c68968e, "Walk", "GOB_ChickenChase_CommentatorOnBench");

PROC
PROC_GOB_ChickenChase_MoveCommentatorToGame()
AND
IsInTrigger(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, S_GOB_ChickenChase_CommentatorArea_4aeac57c-d4e8-4a20-882c-231b2b039299, 1)
THEN
SetEntityEvent(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase_CommentatorOnBench");

IF
EntityEvent((CHARACTER)_Commentator, "GOB_ChickenChase_CommentatorOnBench")
THEN
SetHasDialog(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, 1);

IF
EnteredTrigger(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, S_GOB_ChickenChase_CommentatorArea_4aeac57c-d4e8-4a20-882c-231b2b039299)
THEN
DB_GOB_ChickenChase_CommentatorIsReady(1);

IF
LeftTrigger(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, S_GOB_ChickenChase_CommentatorArea_4aeac57c-d4e8-4a20-882c-231b2b039299)
THEN
NOT DB_GOB_ChickenChase_CommentatorIsReady(1);

IF
EnteredTrigger(_Player, S_GOB_ChickenChase_StartArea_37352f92-b862-47f8-ae3a-9c0a3f4a31d1)
AND
DB_Players(_Player)
AND
GetFlag(GOB_ChickenChase_State_GameInProgress_ccbbaaf5-1f56-f106-42f9-d5b415e1abf9, _Player, 1)
THEN
DB_GOB_ChickenChase_PlayerIsReady((CHARACTER)_Player);

IF
LeftTrigger(_Player, S_GOB_ChickenChase_StartArea_37352f92-b862-47f8-ae3a-9c0a3f4a31d1)
AND
DB_Players(_Player)
AND
GetFlag(GOB_ChickenChase_State_GameInProgress_ccbbaaf5-1f56-f106-42f9-d5b415e1abf9,_Player, 1)
THEN
NOT DB_GOB_ChickenChase_PlayerIsReady((CHARACTER)_Player);

IF
EnteredTrigger(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, S_GOB_ChickenChase_ChickenShovePoint_2e97f1e8-123c-4dde-be45-67ad8b49453c)
THEN
DB_GOB_ChickenChase_BallIsReady(1);

IF
LeftTrigger(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, S_GOB_ChickenChase_ChickenShovePoint_2e97f1e8-123c-4dde-be45-67ad8b49453c)
THEN
NOT DB_GOB_ChickenChase_BallIsReady(1);

IF
EnteredTrigger(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, S_GOB_ChickenChase_OwlbearStartPoint_6c2de754-b12a-4b2a-8d7c-66c8aa6d3be7)
THEN
DB_GOB_ChickenChase_BallIsReady(1);

IF
LeftTrigger(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, S_GOB_ChickenChase_OwlbearStartPoint_6c2de754-b12a-4b2a-8d7c-66c8aa6d3be7)
THEN
NOT DB_GOB_ChickenChase_BallIsReady(1);

IF
EnteredTrigger(_Player, S_GOB_ChickenChase_GameRing_feb54bd2-75dd-43cd-a7b1-bdc8a12026e5)
AND
DB_Players(_Player)
THEN
PROC_GOB_CheckIllegalPlayers();

IF
LeftTrigger(_Player, S_GOB_ChickenChase_GameRing_feb54bd2-75dd-43cd-a7b1-bdc8a12026e5)
AND
DB_Players(_Player)
THEN
PROC_GOB_CheckIllegalPlayers();

PROC
PROC_GOB_CheckIllegalPlayers()
AND
QRY_GOB_ChickenChase_IllegalPlayersOnField()
THEN
SetFlag(GOB_ChickenChase_State_IllegalPlayer_10cce241-f9f4-378d-5374-565f66194b95, NULL_00000000-0000-0000-0000-000000000000);
DB_GOB_ChickenChase_IllegalPlayers(1); // for DB check below

PROC
PROC_GOB_CheckIllegalPlayers()
AND
NOT QRY_GOB_ChickenChase_IllegalPlayersOnField()
THEN
ClearFlag(GOB_ChickenChase_State_IllegalPlayer_10cce241-f9f4-378d-5374-565f66194b95, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GOB_ChickenChase_IllegalPlayers(1);

QRY
QRY_GOB_ChickenChase_IllegalPlayersOnField()
AND
DB_Players(_Player)
AND
IsInTrigger(_Player, S_GOB_ChickenChase_GameRing_feb54bd2-75dd-43cd-a7b1-bdc8a12026e5, 1)
AND
GetFlag(GOB_ChickenChase_State_GameInProgress_ccbbaaf5-1f56-f106-42f9-d5b415e1abf9, _Player, 0)
THEN
DB_NOOP(1);

IF
DB_GOB_ChickenChase_CommentatorIsReady(1)
AND
DB_GOB_ChickenChase_BallIsReady(1)
AND
DB_GOB_ChickenChase_PlayerIsReady(_Player)
AND
NOT DB_GOB_ChickenChase_IllegalPlayers(1)
THEN
PROC_GOB_ChickenChase_CheckIfReady(_Player);

PROC
PROC_GOB_ChickenChase_CheckIfReady((CHARACTER)_Player)
AND
DB_GOB_ChickenChase_Ball(_Ball)
AND
GetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
GetFlag(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
NOT QRY_GOB_ChickenChase_TooManyPlayers(_Player)
AND
NOT DB_GOB_ChickenChase_StartingGame(1)
THEN
DB_GOB_ChickenChase_StartingGame(1);
SetHasDialog(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, 0);
PROC_ForceStopDialog(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);
TriggerClearItemsOwner(S_GOB_ChickenChase_OwnershipTigger_7148555f-dc54-4ddd-8467-ab08db4ecfdd);
PROC_GOB_ChickenChase_DisableCrimes(_Ball);
PROC_GOB_ChickenChase_ThrowBallIfCan();
PlaySound(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "SE_Chicken_Chase_Start");
PROC_TryStartAD((DIALOGRESOURCE)GOB_ChickenChase_AD_StartChase_a3173f52-4ead-ebd7-5b9c-159967611962, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);
DB_GOB_ChickenChase_IsCommenting(1);
ObjectTimerLaunch(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase_StartChaseComment", 6000);
SetHasDialog(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, 1);

IF
ObjectTimerFinished(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase_StartChaseComment")
THEN
NOT DB_GOB_ChickenChase_IsCommenting(1);

PROC
PROC_GOB_ChickenChase_DisableCrimes((CHARACTER)_Ball)
THEN
PROC_CharacterDisableAllCrimes(_Ball, 1);

PROC
PROC_GOB_ChickenChase_ThrowBallIfCan()
AND
DB_GOB_ChickenChase_Ball(_Ball)
AND
_Ball == S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785
THEN
RealtimeObjectTimerLaunch(_Ball, "GOB_ChickenChase_ThrowFallback", 6000);
SetFlag(GOB_ChickenChase_State_WaitingForBallToLand_3ecdcf8e-c5eb-4fe7-93fd-daf9a6da1c1d, NULL_00000000-0000-0000-0000-000000000000);
UseSpell(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "Target_GOB_ChickenChase_CommentatorShove", S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785);
SetTag(_Ball, IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);

IF
CastedSpell(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "Target_GOB_ChickenChase_CommentatorShove", _, _, _)
THEN
SetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_ChickenChase_State_WaitingForBallToLand_3ecdcf8e-c5eb-4fe7-93fd-daf9a6da1c1d, NULL_00000000-0000-0000-0000-000000000000);

IF
CastSpellFailed(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "Target_GOB_ChickenChase_CommentatorShove", _, _, _)
AND
GetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
DB_GOB_ChickenChase_Ball(_Ball)
THEN
SetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_ChickenChase_State_WaitingForBallToLand_3ecdcf8e-c5eb-4fe7-93fd-daf9a6da1c1d, NULL_00000000-0000-0000-0000-000000000000);
PROC_CharacterMoveTo(_Ball, S_GOB_ChickenChase_OwlbearStartPoint_6c2de754-b12a-4b2a-8d7c-66c8aa6d3be7, "Run", "");

IF
ObjectTimerFinished((CHARACTER)_Ball, "GOB_ChickenChase_ThrowFallback")
AND
GetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
SetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_ChickenChase_State_WaitingForBallToLand_3ecdcf8e-c5eb-4fe7-93fd-daf9a6da1c1d, NULL_00000000-0000-0000-0000-000000000000);
PROC_CharacterMoveTo(_Ball, S_GOB_ChickenChase_OwlbearStartPoint_6c2de754-b12a-4b2a-8d7c-66c8aa6d3be7, "Run", "");

PROC
PROC_GOB_ChickenChase_ThrowBallIfCan()
AND
DB_GOB_ChickenChase_Ball(_Ball)
AND
_Ball != S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785
THEN
SetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000);
SetTag(_Ball, IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);

IF
AutomatedDialogStarted(GOB_ChickenChase_AD_StartChase_a3173f52-4ead-ebd7-5b9c-159967611962, _)
AND
DB_Players(_Player)
AND
GetFlag(GOB_ChickenChase_State_GameInProgress_ccbbaaf5-1f56-f106-42f9-d5b415e1abf9, _Player, 1)
THEN
ObjectTimerLaunch(_Player, "GOB_ChickenChase_LostChaseOnTime", 60000);
ApplyStatus(_Player, "GOB_CHICKENCHASE", 60.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ObjectQuestTimerLaunch(_Player,"GOB_ChickenChase_Game","GOB_ChickenChase_GameTimer",60000,0);

IF
AutomatedDialogRequestFailed(GOB_ChickenChase_AD_StartChase_a3173f52-4ead-ebd7-5b9c-159967611962, _)
AND
DB_Players(_Player)
AND
GetFlag(GOB_ChickenChase_State_GameInProgress_ccbbaaf5-1f56-f106-42f9-d5b415e1abf9, _Player, 1)
THEN
ObjectTimerLaunch(_Player, "GOB_ChickenChase_LostChaseOnTime", 60000);
ApplyStatus(_Player, "GOB_CHICKENCHASE", 60.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ObjectQuestTimerLaunch(_Player,"GOB_ChickenChase_Game","GOB_ChickenChase_GameTimer",60000,0);
//END_REGION Start chase

//REGION Commentator
IF
DB_GOB_ChickenChase_FieldPart(_,(FLAG)_Flag)
THEN
DB_GOB_ChickenChase_ADFlags((FLAG)_Flag);

IF
EnteredTrigger(_Ball, _Trigger)
AND
DB_GOB_ChickenChase_Ball(_Ball)
AND
DB_GOB_ChickenChase_FieldPart(_Trigger,(FLAG)_Flag)
THEN
SetFlag((FLAG)_Flag, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);

IF
LeftTrigger(_Ball, _Trigger)
AND
DB_GOB_ChickenChase_Ball(_Ball)
AND
DB_GOB_ChickenChase_FieldPart(_Trigger,(FLAG)_Flag)
THEN
ClearFlag((FLAG)_Flag, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);

IF
AutomatedDialogStarted(DIALOGRESOURCEGUID_GOB_ChickenChase_AD_Comments_8ec0b010-5d5c-e31a-4c54-be6dd909c64f, _)
THEN
DB_GOB_ChickenChase_IsCommenting(1);

IF
AutomatedDialogEnded(DIALOGRESOURCEGUID_GOB_ChickenChase_AD_Comments_8ec0b010-5d5c-e31a-4c54-be6dd909c64f, _)
THEN
NOT DB_GOB_ChickenChase_IsCommenting(1);

IF
FlagSet((FLAG)_Flag, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _)
AND
DB_GlobalFlag((FLAG)GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed)
AND
DB_GlobalFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc)
AND
DB_GOB_ChickenChase_ADFlags((FLAG)_Flag)
AND
NOT DB_GOB_ChickenChase_IsCommenting(1)
AND
DB_GOB_ChickenChase_LastAD((FLAG)_PrevFlag)
AND
_Flag != _PrevFlag
AND
NOT DB_DialogNPCs(_, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _)
AND
NOT DB_MovingTo(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _, _, _)
THEN
PROC_TryStartAD(DIALOGRESOURCEGUID_GOB_ChickenChase_AD_Comments_8ec0b010-5d5c-e31a-4c54-be6dd909c64f, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);
NOT DB_GOB_ChickenChase_LastAD((FLAG)_PrevFlag);
DB_GOB_ChickenChase_LastAD((FLAG)_Flag);

IF
FlagSet((FLAG)_Flag, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _)
AND
DB_GlobalFlag((FLAG)GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed)
AND
DB_GOB_ChickenChase_ADFlags((FLAG)_Flag)
AND
DB_GOB_ChickenChase_IsCommenting(1)
THEN
ClearFlag((FLAG)_Flag, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);
//END_REGION Commentator

//REGION Chicken football
// goal condition
IF
EnteredTrigger(_Ball, S_GOB_ChickenChase_FootballGatesBox_8cdc4a7f-9972-4578-b545-2383faf65c60)
AND
DB_GOB_ChickenChase_Ball(_Ball)
AND
DB_GlobalFlag((FLAG)GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed)
AND
DB_GlobalFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc)
AND
GetFlag(GOB_ChickenChase_State_GoalScored_79b6eef1-c8b6-d471-f7ca-811c5abf564f, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
SetFlag((FLAG)GOB_ChickenChase_State_GoalScored_79b6eef1-c8b6-d471-f7ca-811c5abf564f, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_ChickenChase_SetupWinner();

PROC
PROC_GOB_ChickenChase_SetupWinner()
AND
DB_GOB_ChickenChase_Ball(_Ball)
AND
GetClosestAlivePlayer(_Ball, _Winner, _Dist)
THEN
DB_GOB_ChickenChase_Winner((CHARACTER)_Winner);
SetFlag((FLAG)GOB_ChickenChase_Quest_Winner_8cc28e29-0b10-0496-04c1-69db3397722c, _Winner);

PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Ball, GOB_Festivities_BallToldAboutGates_67c96492-3a87-8278-e2ee-2b0a8bd7aeb7)
THEN
PROC_CharacterMoveTo(_Ball, S_GOB_ChickenChase_FootballGatesBox_8cdc4a7f-9972-4578-b545-2383faf65c60, "Run", "");
//END_REGION

//REGION Ending Chase conditions
// 1. Player left the ring
// 2. Ball died
// 3. Time is out
// 4. Goal scored
// 5. More than 1 player in the ring - the commentator should mention that before the game!
// 6. Commentator is dead

//GOB_ChickenChase_State_LeftRing			GOB_ChickenChase_State_LeftRing_e95c9b62-8b8a-4f31-bdb8-3777d5a11a0a
//GOB_ChickenChase_State_BallIsDead			GOB_ChickenChase_State_BallIsDead_4d3be956-dcdf-3199-0e53-d76cf6f66051
//GOB_ChickenChase_State_TimeIsOut			GOB_ChickenChase_State_TimeIsOut_76a6939e-b3f1-4687-ae9a-971a57c1c523
//GOB_ChickenChase_State_GoalScored			GOB_ChickenChase_State_GoalScored_79b6eef1-c8b6-d471-f7ca-811c5abf564f
//GOB_ChickenChase_State_ExtraPlayer		GOB_ChickenChase_State_ExtraPlayer_ddb5220c-4fc8-451e-bb65-80087f3ffa88
//GOB_ChickenChase_State_CommentatorIsDead	GOB_ChickenChase_State_CommentatorIsDead_1ad6f5ec-09d7-f7b7-b79a-5c32b40ec1a5

// 1. Player left the ring
IF
LeftTrigger(_Player, S_GOB_ChickenChase_LeftRingTrigger_c9cdf63a-b1bf-431d-9d09-3c76e9ae12a1)
AND
DB_Players(_Player)
AND
GetFlag(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
GetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
SetFlag(GOB_ChickenChase_State_LeftRing_e95c9b62-8b8a-4f31-bdb8-3777d5a11a0a, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_ChickenChase_EndChase();

// 2. Ball died
IF
DB_PermaDefeated(_Ball)
AND
DB_GOB_ChickenChase_Ball((CHARACTER)_Ball)
THEN
SetFlag((FLAG)GOB_ChickenChase_State_BallIsDead_4d3be956-dcdf-3199-0e53-d76cf6f66051, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_PermaDefeated(_Ball)
AND
DB_GOB_ChickenChase_Ball((CHARACTER)_Ball)
AND
DB_GlobalFlag((FLAG)GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed)
THEN
PROC_GOB_ChickenChase_EndChase();

// 3. Time is out
IF
ObjectTimerFinished(_Player, "GOB_ChickenChase_LostChaseOnTime")
THEN
SetFlag(GOB_ChickenChase_State_TimeIsOut_76a6939e-b3f1-4687-ae9a-971a57c1c523, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_ChickenChase_EndChase();

// 4. Goal scored
IF
FlagSet(GOB_ChickenChase_State_GoalScored_79b6eef1-c8b6-d471-f7ca-811c5abf564f, _, _)
THEN
PROC_GOB_ChickenChase_Fireworks();
PROC_GOB_ChickenChase_EndChase();

IF
FlagSet(GOB_ChickenChase_State_GoalScored_79b6eef1-c8b6-d471-f7ca-811c5abf564f, _, _)
AND
DB_Players(_Player)
AND
GetFlag(GOB_ChickenChase_State_GameInProgress_ccbbaaf5-1f56-f106-42f9-d5b415e1abf9, _Player, 1)
THEN
QuestUpdate(_Player, "HIDDEN_WLD_Boosters", "GOB_ChickenChase_Won");

// 5. More than 1 player in the ring
IF
EnteredTrigger(_Player, S_GOB_ChickenChase_GameRing_feb54bd2-75dd-43cd-a7b1-bdc8a12026e5)
AND
DB_Players(_Player)
AND
GetFlag(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
GetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
QRY_GOB_ChickenChase_IllegalPlayersOnField()
THEN
SetFlag(GOB_ChickenChase_State_ExtraPlayer_ddb5220c-4fc8-451e-bb65-80087f3ffa88, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_ChickenChase_EndChase();

QRY
QRY_GOB_ChickenChase_TooManyPlayers((CHARACTER)_Player)
AND
DB_Players(_OtherPlayer)
AND
_OtherPlayer != _Player
AND
IsInTrigger(_OtherPlayer, S_GOB_ChickenChase_GameRing_feb54bd2-75dd-43cd-a7b1-bdc8a12026e5, 1)
THEN
DB_NOOP(1);

// 6. Commentator is dead
IF
DB_PermaDefeated(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b)
THEN
SetFlag((FLAG)GOB_ChickenChase_State_CommentatorIsPermaDefeated_1ad6f5ec-09d7-f7b7-b79a-5c32b40ec1a5, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_ChickenChase_EndChase();
//END_REGION Ending Chase conditions

//REGION Ending Chase
PROC
PROC_GOB_ChickenChase_EndChase()
THEN
PROC_GOB_ChickenChase_PlaySoundIfGameInProgress();
PROC_GOB_ChickenChase_ChaseEnded_CancelTimer();
PROC_GOB_ChickenChase_ChaseEnded_UpdateFlags();
PROC_GOB_ChickenChase_ChaseEnded_StartSpottingThePlayer_Internal();
PROC_GOB_ChickenChase_ChaseEnded_RestoreBallSettings();
TimerLaunch("GOB_ChickenChase_RestoreOwnership", 3000);
NOT DB_GOB_ChickenChase_StartingGame(1);

PROC
PROC_GOB_ChickenChase_PlaySoundIfGameInProgress()
AND
DB_GlobalFlag(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed)
THEN
PlaySound(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "SE_Chicken_Chase_End");

IF
TimerFinished("GOB_ChickenChase_RestoreOwnership")
THEN
PROC_GOB_ChickenChase_ChaseEnded_RestoreFieldOwner();

PROC
PROC_GOB_ChickenChase_ChaseEnded_CancelTimer()
AND
DB_Players(_Player)
THEN
ObjectTimerCancel(_Player, "GOB_ChickenChase_LostChaseOnTime");
RemoveStatus(_Player, "GOB_CHICKENCHASE");

IF
StatusRemoved(_Player,"GOB_CHICKENCHASE",_,_)
THEN
ObjectTimerCancel(_Player,"GOB_ChickenChase_Game");

PROC
PROC_GOB_ChickenChase_ChaseEnded_UpdateFlags()
THEN
ClearFlag(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_ChickenChase_ChaseEnded_UpdateFlags()
AND
DB_Players(_Player)
AND
GetFlag(GOB_ChickenChase_State_GameInProgress_ccbbaaf5-1f56-f106-42f9-d5b415e1abf9, _Player, 1)
THEN
SetFlag(GOB_ChickenChase_State_ChaseEnded_ba1fc19f-ef95-c08e-91f8-2ab7879db77e, _Player);
SetFlag(GOB_ChickenChase_State_WaitingAfterGame_041b8b86-c92d-4b34-be67-a035257a1cec, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_ChickenChase_ChaseEnded_StartSpottingThePlayer_Internal()
THEN
TimerLaunch("GOB_ChickenChase_StartSpottingWithDelay", 2000);

IF
TimerFinished("GOB_ChickenChase_StartSpottingWithDelay")
AND
DB_Players(_Player)
AND
GetFlag(GOB_ChickenChase_State_GameInProgress_ccbbaaf5-1f56-f106-42f9-d5b415e1abf9, _Player, 1)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)GOB_ChickenChase_GameOver_ef1f7bc6-8a65-15aa-085b-f4c181d95d16, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _Player)
THEN
PROC_GOB_ChickenChase_ChaseEnded_StartSpottingThePlayer();

PROC
PROC_GOB_ChickenChase_ChaseEnded_StartSpottingThePlayer()
AND
NOT DB_SpotPlayers(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase", _, _)
THEN
DB_SpotPlayers_HasObjectFlag(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase", GOB_ChickenChase_State_GameInProgress_ccbbaaf5-1f56-f106-42f9-d5b415e1abf9, 1);
DB_SpotPlayers_HasObjectFlag(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase", GOB_ChickenChase_State_ChaseEnded_ba1fc19f-ef95-c08e-91f8-2ab7879db77e, 1);
DB_SpotPlayers_CustomRadius(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase", 12.0);
DB_SpotPlayers(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_ChickenChase_ChaseEnded_StartSpottingThePlayer()
AND
DB_SpotPlayers(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000)
THEN
PROC_SpotPlayers_RestartSpotting(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase");

PROC
PROC_SpotPlayers_Spotted(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, "GOB_ChickenChase", _Player)
AND
QRY_StartDialog(GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _Player)
THEN
DB_NOOP(1);

PROC
PROC_GOB_ChickenChase_ChaseEnded_RestoreFieldOwner()
THEN
PROC_ItemOwnership_SetNewTriggerOwner(S_GOB_ChickenChase_OwnershipTigger_7148555f-dc54-4ddd-8467-ab08db4ecfdd, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);

PROC
PROC_GOB_ChickenChase_ChaseEnded_RestoreBallSettings()
AND
DB_GOB_ChickenChase_Ball(_Ball)
THEN
CharacterEnableAllCrimes(_Ball);
ClearTag(_Ball, IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);

PROC
PROC_GOB_ChickenChase_Fireworks()
THEN
PROC_LoopEffect(VFX_Environment_Fireworks_Emitter_01_2562430f-b79b-8440-dae8-017ac7587fa7, (TRIGGER)S_GOB_ChickenChase_FireworksPosition_735b35fd-6e60-4c6a-b75d-245808fb4b2d, "GOB_ChickenChase_Fireworks", "WLD_Main_A", "");
TimerLaunch("GOB_ChickenChase_Fireworks", 6000);

IF
TimerFinished("GOB_ChickenChase_Fireworks")
THEN
PROC_StopLoopEffect((TRIGGER)S_GOB_ChickenChase_FireworksPosition_735b35fd-6e60-4c6a-b75d-245808fb4b2d, "GOB_ChickenChase_Fireworks");

IF
FlagCleared(GOB_ChickenChase_State_ChaseEnded_ba1fc19f-ef95-c08e-91f8-2ab7879db77e, _Player, _)
THEN
ClearFlag(GOB_ChickenChase_State_WaitingAfterGame_041b8b86-c92d-4b34-be67-a035257a1cec, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Ending Chase

//REGION Throwing Grease Bottles
IF
DB_GOB_ChickenChase_GreaseBottles(_Trigger, _Goblin)
THEN
TemplateAddTo(GRN_GreaseBottle_A_e2968a2e-bc83-4d50-99ef-39ce78d2d630, _Goblin, 1, 0);
PROC_TriggerRegisterForPlayers(_Trigger);

IF
EnteredTrigger(_Player, _GreaseBottleTrigger)
AND
DB_Players(_Player)
AND
DB_GOB_ChickenChase_GreaseBottles(_GreaseBottleTrigger, _Goblin)
AND
GetFlag(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
GetFlag(GOB_ChickenChase_State_BallOnField_afefbe32-abfc-4bd0-b0f7-d11206a2c7cc, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
NOT DB_PermaDefeated(_Goblin)
AND
GetItemByTemplateInInventory(GRN_GreaseBottle_A_e2968a2e-bc83-4d50-99ef-39ce78d2d630, _Goblin, _GreaseBottle)
THEN
PROC_TryStartAD((DIALOGRESOURCE)GOB_ChickenChase_AD_ShootingBarrel_c51593a6-e719-3199-4ebf-c20c9d82a703, S_GOB_Festivities_Goblin_005_Ranger_02_a955aea9-9040-4d4c-9264-e46e385dea94);
UseSpell(_Goblin, "Throw_Throw", _GreaseBottleTrigger, _GreaseBottle);
PROC_GOB_ChickenChase_HandleCommentOnThrowing((TRIGGER)_GreaseBottleTrigger, (CHARACTER)_Goblin);

PROC
PROC_GOB_ChickenChase_HandleCommentOnThrowing((TRIGGER)_GreaseBottleTrigger, (CHARACTER)_Goblin)
THEN
DB_GOB_ChickenChase_GreaseBottleWasThrown((TRIGGER)_GreaseBottleTrigger, (CHARACTER)_Goblin);

IF
AttackedBy((CHARACTER)_Player, _Goblin, _Goblin, _, _, "InventoryThrow", _)
AND
DB_Players(_Player)
AND
DB_GOB_ChickenChase_GreaseBottleWasThrown(_, (CHARACTER)_Goblin)
THEN
DB_GOB_ChickenChase_GreaseBottleHitPlayer(1);

IF
OnThrown(_, GRN_GreaseBottle_A_e2968a2e-bc83-4d50-99ef-39ce78d2d630, _Goblin, _, _X, _Y, _Z)
AND
DB_GOB_ChickenChase_GreaseBottleWasThrown(_Trigger, (CHARACTER)_Goblin)
AND
DB_GOB_ChickenChase_GreaseBottleHitPlayer(1)
THEN
SysClear("DB_GOB_ChickenChase_GreaseBottleWasThrown", 2);
SysClear("DB_GOB_ChickenChase_GreaseBottleHitPlayer", 1);
//PROC_TryStartAD((DIALOGRESOURCE)GOB_ChickenChase_AD_BarrelShotMiss_0dd58ecd-152c-cf1e-efd4-0eeb63c613a1, S_GOB_Festivities_Goblin_006_Ranger_04_f3f416d1-b946-4019-95ba-7053f63dd776);

IF
OnThrown(_, GRN_GreaseBottle_A_e2968a2e-bc83-4d50-99ef-39ce78d2d630, _Goblin, _, _X, _Y, _Z)
AND
DB_GOB_ChickenChase_GreaseBottleWasThrown(_Trigger, (CHARACTER)_Goblin)
AND
NOT DB_GOB_ChickenChase_GreaseBottleHitPlayer(1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)GOB_ChickenChase_AD_BarrelShotHit_d0dff7d3-39a6-97f7-a3fc-0a72c998bba3, S_GOB_Festivities_Goblin_006_Ranger_04_f3f416d1-b946-4019-95ba-7053f63dd776);
SysClear("DB_GOB_ChickenChase_GreaseBottleWasThrown", 2);
SysClear("DB_GOB_ChickenChase_GreaseBottleHitPlayer", 1);
//END_REGION Throwing Grease Bottles

//REGION Getting all the commentators money
IF
FlagSet(GOB_ChickenChase_Event_GetAllCommentatorMoney_6cef7559-5e39-4b15-889c-e1a486371b02, _Player, _)
AND
GetGold(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _Amount)
AND
IntegerSubtract(0, _Amount, _RemoveGold)
THEN
PROC_AddGoldToMagicPockets((CHARACTER)_Player, _Amount);
AddGold(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _RemoveGold);

//END_REGION

//REGION Owlbear to party camp
PROC
PROC_GOB_ChickenChase_MoveOwlbearToCamp((CHARACTER)_Owlbear)
THEN
PROC_DisappearOutOfSightTo(_Owlbear, S_GOB_ChickenChase_OwlbearEscapePoint_f465c3e3-6abe-4234-98e4-b366058e33ca, "Run", 1, "GOB_ChickenChase_CubDisappeared");

IF
EntityEvent(_Owlbear, "GOB_ChickenChase_CubDisappeared")
THEN
DB_GOB_ChickenChase_OwlbearTeleported(1);
PROC_RemoveAllDialogEntriesForSpeaker(_Owlbear);
//END_REGION

//REGION Trigger registration for balls
IF
DB_GOB_ChickenChase_Ball((CHARACTER)_Char)
THEN
TriggerRegisterForCharacter(S_GOB_ChickenChase_FootballGatesBox_8cdc4a7f-9972-4578-b545-2383faf65c60, _Char);
TriggerRegisterForCharacter( S_GOB_ChickenChase_GameRing_feb54bd2-75dd-43cd-a7b1-bdc8a12026e5, _Char);
TriggerRegisterForCharacter(S_GOB_ChickenChase_StartArea_37352f92-b862-47f8-ae3a-9c0a3f4a31d1, _Char);

IF
DB_GOB_ChickenChase_FieldPart(_PartBox,(FLAG)_)
AND
DB_GOB_ChickenChase_Ball(_Char)
THEN
TriggerRegisterForCharacter(_PartBox, _Char);

PROC
PROC_GOB_ChickenChase_UnregisterTriggersFor((CHARACTER)_Ball)
THEN
TriggerUnregisterForCharacter(S_GOB_ChickenChase_FootballGatesBox_8cdc4a7f-9972-4578-b545-2383faf65c60, _Ball);

PROC
PROC_GOB_ChickenChase_UnregisterTriggersFor((CHARACTER)_Ball)
AND
DB_GOB_ChickenChase_FieldPart(_PartBox,(FLAG)_)
THEN
TriggerUnregisterForCharacter(_PartBox, _Ball);
//END_REGION Trigger registration for balls

//REGION Debug
IF
TextEvent("debug_preparechase")
AND
DB_Players(_Player)
THEN
SetTag(_Player, PETPAL_dc860a81-f3c2-4c1a-ab90-e7583324845c);
AddGold(_Player, 10);

IF
TextEvent("cub2camp")
AND
NOT DB_PermaDefeated(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
NOT DB_GOB_ChickenChase_OwlbearTeleported(1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)GOB_ChickenChase_State_OwlbearAcquired_da704027-02ea-717c-4390-f538e5e5cd7a);
PROC_GOB_ChickenChase_MoveOwlbearToCamp(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);
//END_REGION

//REGION Toast is Success
IF
FlagSet(GOB_GoblinToast_State_RealizedPoison_0e867c08-b2b9-4f43-8260-168026663e2c, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
SetFlag(GOB_ChickenChase_State_BallIsDead_4d3be956-dcdf-3199-0e53-d76cf6f66051, NULL_00000000-0000-0000-0000-000000000000); // disabling the chicken chase
//END_REGION Toast is Success

//REGION Chase Marker
PROC
PROC_GOB_ChickenChase_StartChase()
THEN
PROC_StopLoopEffect((TRIGGER)S_GOB_ChickenChase_FireworksPosition_735b35fd-6e60-4c6a-b75d-245808fb4b2d, "GOB_ChickenChase_Fireworks");
PROC_ShowMarker(NULL_00000000-0000-0000-0000-000000000000, "GOB_ChickenChase");

IF
DB_GOB_ChickenChase_PlayerIsReady(_Player)
THEN
PROC_HideMarker(NULL_00000000-0000-0000-0000-000000000000, "GOB_ChickenChase");
//END_REGION Chase Marker

//REGION Blocking chase if the Commentator does not have enough money
PROC
PROC_DialogFlagSetup((DIALOGRESOURCE)GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, _, _)
AND
DB_DialogMoneyTransfer(1, GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, _SmallBet, 2, 1) // we need to have at least as much as a small bet
AND
GetGold(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b, _Amount)
AND
_Amount < _SmallBet
THEN
SetFlag(GOB_ChickenChase_State_NoMoneyLeft_b88f1359-78b8-4adc-bf8a-7c92d3814bbf, NULL_00000000-0000-0000-0000-000000000000);

IF
DialogEnded(GOB_ChickenChase_Commentator_32841789-f270-c37c-8454-e50ca6ada256, _)
AND
DB_GlobalFlag(GOB_ChickenChase_State_NoMoneyLeft_b88f1359-78b8-4adc-bf8a-7c92d3814bbf)
THEN
ClearFlag(GOB_ChickenChase_State_NoMoneyLeft_b88f1359-78b8-4adc-bf8a-7c92d3814bbf, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Blocking chase if the Commentator does not have enough money

//REGION In case owlbear cub captors are permadefeated or battle stations triggered, the cub goes to the camp if invited.
IF
DB_PermaDefeated(S_GOB_Festivities_Goblin_000_031e9fb7-136a-46c7-91d7-77ce3e20236a)
AND
DB_PermaDefeated(S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b)
AND
DB_GlobalFlag((FLAG)GOB_ChickenChase_State_OwlbearReplacedChicken_aabd6c48-57e4-12bb-8123-912f747f1f07)
THEN
PROC_GOB_AcquiredOwlbearToInitialPosition();

IF
FlagSet(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a,_,_)
AND
DB_GlobalFlag((FLAG)GOB_ChickenChase_State_OwlbearReplacedChicken_aabd6c48-57e4-12bb-8123-912f747f1f07)
THEN
PROC_GOB_AcquiredOwlbearToInitialPosition();

PROC
PROC_GOB_AcquiredOwlbearToInitialPosition()
AND
NOT DB_GlobalFlag((FLAG)GOB_ChickenChase_State_OwlbearAcquired_da704027-02ea-717c-4390-f538e5e5cd7a)
AND
NOT DB_GlobalFlag((FLAG)GOB_ChickenChase_Event_OwlbearAcquired_775e6984-4640-41d3-97e5-b1f96c572ddd)
AND
NOT DB_GlobalFlag((FLAG)GOB_OwlbearCub_Event_InvitedToCamp_2b4acc5e-fe2f-0f0b-8945-043403b50e2f)
THEN
PROC_GlobalSetFlagAndCache((FLAG)GOB_ChickenChase_Event_OwlbearAcquired_775e6984-4640-41d3-97e5-b1f96c572ddd);
PROC_CharacterMoveTo(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, S_GOB_ChickenChase_OwlbearAppearPosition_10a6b193-be30-4094-84ac-c968d2a0e810, "Run", "");

// If the cub was already invited, just leaves for the camp
PROC
PROC_GOB_AcquiredOwlbearToInitialPosition()
AND
NOT DB_GlobalFlag((FLAG)GOB_ChickenChase_State_OwlbearAcquired_da704027-02ea-717c-4390-f538e5e5cd7a)
AND
NOT DB_GlobalFlag((FLAG)GOB_ChickenChase_Event_OwlbearAcquired_775e6984-4640-41d3-97e5-b1f96c572ddd)
AND
DB_GlobalFlag((FLAG)GOB_OwlbearCub_Event_InvitedToCamp_2b4acc5e-fe2f-0f0b-8945-043403b50e2f)
THEN
PROC_GOB_ChickenChase_OwlbearAcquired();
PROC_GOB_ChickenChase_MoveOwlbearToCamp(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);
//END_REGION

//REGION Goal Completion
PROC
PROC_LevelLoadedOnce("BGO_Main_A")
THEN
GoalCompleted;
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
