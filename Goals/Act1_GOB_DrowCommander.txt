Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_GOB_DrowCommander_RaidersInGoblinCamp((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_RaiderBold_1c9fd1dd-12bc-4b81-acb8-9eef54174c55);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_RaiderHardy_6687f78f-5d6a-40d4-8cfd-2b972dacde3c);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_RaiderHefty_fcbb04a8-f4e6-4065-901c-1a4a708ccd54);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_RaiderArrogant_43d953fa-575e-452c-b220-939e6bdcc36b);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_RaiderStupid_5d049dbe-ff35-45be-88f9-5f999dc0ffe4);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_RaiderCunning_abdd3748-0834-46f3-8214-18dd4dca9d40);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_GoblinLush_d738c9a4-a031-4dd9-912f-93cda8d8d8b7);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39);
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_WarchiefGrumpy_126e39d1-7c38-453c-888b-4cddce7f3e41);

DB_GOB_DrowCommander_Raiders((CHARACTER)S_GOB_RaiderHefty_fcbb04a8-f4e6-4065-901c-1a4a708ccd54, (TRIGGER)S_GOB_LeavePos_005_5c30dc56-ecef-4816-924c-fe751efbd382, "GOB_DrowCommander_Boss1", 1000);
DB_GOB_DrowCommander_Raiders(S_GOB_RaiderBold_1c9fd1dd-12bc-4b81-acb8-9eef54174c55, S_GOB_LeavePos_006_1122b330-4ea4-43d0-a0fe-51b5497e3b6a, "GOB_DrowCommander_Boss1", 1400);
DB_GOB_DrowCommander_Raiders(S_GOB_RaiderHardy_6687f78f-5d6a-40d4-8cfd-2b972dacde3c, S_GOB_LeavePos_007_590ee106-cb24-4e69-9875-bdbd7df91b60, "GOB_DrowCommander_Boss1", 1900);

DB_GOB_DrowCommander_Raiders(S_GOB_RaiderArrogant_43d953fa-575e-452c-b220-939e6bdcc36b, S_GOB_LeavePos_002_2e3517e9-f175-4e28-bb92-ceb710e1c453, "GOB_DrowCommander_Boss2", 1900);
DB_GOB_DrowCommander_Raiders(S_GOB_RaiderStupid_5d049dbe-ff35-45be-88f9-5f999dc0ffe4, S_GOB_LeavePos_003_db687775-ac6f-42b3-a087-1185a0f1c8a0, "GOB_DrowCommander_Boss2", 1400);
DB_GOB_DrowCommander_Raiders(S_GOB_RaiderCunning_abdd3748-0834-46f3-8214-18dd4dca9d40, S_GOB_LeavePos_004_61d46198-9896-43db-9312-871760d46379, "GOB_DrowCommander_Boss2", 1000);


DB_GOB_DrowCommander_Raiders(S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280, S_GOB_LeavePos_008_43ea3eae-95f1-4b22-9ba0-adeb2baff3d3, "GOB_DrowCommander_Drow1", 1000);
DB_GOB_DrowCommander_Raiders(S_GOB_WarchiefGrumpy_126e39d1-7c38-453c-888b-4cddce7f3e41, S_GOB_LeavePos_009_8c9deb48-5f90-4443-a638-13c3620f15a2, "GOB_DrowCommander_Boss3", 1000);
DB_GOB_DrowCommander_Raiders(S_GOB_GoblinLush_d738c9a4-a031-4dd9-912f-93cda8d8d8b7, S_GOB_LeavePos_010_5cf89a14-d242-4399-8453-0b2056731325, "GOB_DrowCommander_Drow2", 1000);

DB_GOB_DrowCommander_RaiderLeaveTimers((CHARACTER)S_GOB_RaiderCunning_abdd3748-0834-46f3-8214-18dd4dca9d40, 1000);
DB_GOB_DrowCommander_RaiderLeaveTimers(S_GOB_RaiderHefty_fcbb04a8-f4e6-4065-901c-1a4a708ccd54, 1000);
DB_GOB_DrowCommander_RaiderLeaveTimers(S_GOB_RaiderHardy_6687f78f-5d6a-40d4-8cfd-2b972dacde3c, 1000);
DB_GOB_DrowCommander_RaiderLeaveTimers(S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280, 1000);
DB_GOB_DrowCommander_RaiderLeaveTimers(S_GOB_WarchiefGrumpy_126e39d1-7c38-453c-888b-4cddce7f3e41, 2000);
DB_GOB_DrowCommander_RaiderLeaveTimers(S_GOB_GoblinLush_d738c9a4-a031-4dd9-912f-93cda8d8d8b7, 2000);

DB_GOB_DrowCommander_LeaveADs((DIALOGRESOURCE)GOB_DrowCommander_AD_DrowLeaving2_09355e30-2754-e08e-c890-09cf6a5ab278, (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0, "GOB_DrowCommander_Drow1");
DB_GOB_DrowCommander_LeaveADs(GOB_DrowCommander_AD_DrowLeaving3_1efcc66b-8a51-ea90-87a0-da041c3a101b, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0, "GOB_DrowCommander_Drow2");
DB_GOB_DrowCommander_LeaveADs(GOB_DrowCommander_AD_BossLeaving2_560dd7ea-ddd3-1c49-1fe3-bc1178df7ece, S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, 1, "GOB_DrowCommander_Boss1");
DB_GOB_DrowCommander_LeaveADs(GOB_DrowCommander_AD_BossLeaving3_67e7ae54-ca0f-883b-cdac-b1a1b3608e0f, S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, 1, "GOB_DrowCommander_Boss2");
DB_GOB_DrowCommander_LeaveADs(GOB_DrowCommander_AD_BossLeaving4_c732d4fb-9c84-87e1-637e-ea15d977d8b2, S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, 1, "GOB_DrowCommander_Boss3");

DB_GOB_DrowCommander_LeaveMoves("GOB_DrowCommander_Drow1", (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TRIGGER)S_GOB_LeavingRaiderPos_b180c27b-346e-4b79-b39a-b04001f07165, "Walk");
DB_GOB_DrowCommander_LeaveMoves("GOB_DrowCommander_Drow2", S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, S_GOB_LeavingLushPos_793f8a7d-b38b-4281-91e1-c9399ca4efee, "Walk");
DB_GOB_DrowCommander_LeaveMoves("GOB_DrowCommander_Drow3", S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, S_GOB_DrowLeavePos_d3fc3f03-0cf7-4f1d-930c-247ac08d654f, "Walk");
DB_GOB_DrowCommander_LeaveMoves("GOB_DrowCommander_Boss1", S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, S_GOB_LeavingStonePos_03572ffa-aca1-4863-82d9-5d941dccd52b, "Run");
DB_GOB_DrowCommander_LeaveMoves("GOB_DrowCommander_Boss2", S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, S_GOB_LeavingCoalPos_327a6489-85db-406c-9592-43b27e0bbb90, "Run");
DB_GOB_DrowCommander_LeaveMoves("GOB_DrowCommander_Boss3", S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, S_GOB_LeavingChiefPos_15a0a2fb-b3fd-4df0-8270-9513f51feff1, "Run");
DB_GOB_DrowCommander_LeaveMoves("GOB_DrowCommander_Boss4", S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, S_GOB_LeavePos_001_535d4401-1746-4e5d-8c44-1e772475166e, "Run");

DB_GOB_DrowCommander_NextMoveTalk("GOB_DrowCommander_Drow1", "GOB_DrowCommander_Drow2");
DB_GOB_DrowCommander_NextMoveTalk("GOB_DrowCommander_Drow2", "GOB_DrowCommander_Drow3");
DB_GOB_DrowCommander_NextMoveTalk("GOB_DrowCommander_Drow3", "");
DB_GOB_DrowCommander_NextMoveTalk("GOB_DrowCommander_Boss1", "GOB_DrowCommander_Boss2");
DB_GOB_DrowCommander_NextMoveTalk("GOB_DrowCommander_Boss2", "GOB_DrowCommander_Boss3");
DB_GOB_DrowCommander_NextMoveTalk("GOB_DrowCommander_Boss3", "GOB_DrowCommander_Boss4");
DB_GOB_DrowCommander_NextMoveTalk("GOB_DrowCommander_Boss4", "");

DB_GOB_DrowCommander_MoveInterruptExclusion("GOB_DrowCommander_Boss4");
DB_GOB_DrowCommander_MoveInterruptExclusion("GOB_DrowCommander_Drow3");

DB_Dialogs(S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280,GOB_RaiderChieftain_92a92b0b-2678-f793-8cfa-31ba6c767cc0);
DB_Dialogs(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39,GOB_WarchiefBrave_9ab19e81-227b-241b-da68-d084cb11347c);
DB_Dialogs(S_GOB_WarchiefGrumpy_126e39d1-7c38-453c-888b-4cddce7f3e41,GOB_WarchiefGrumpy_2636277d-85e3-8011-09e9-8b1e3c92666f);
DB_Dialogs(S_GOB_Eye_7e80dd2a-19f6-4411-8a52-35c3878ef4c8,(DIALOGRESOURCE)GOB_Eye_da8a5114-6c05-cbff-5c17-89d07e1f92a6);

DB_GLO_DefeatCounter(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GOB_WarMapArea");
DB_GLO_DefeatCounter(S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280,"GOB_WarMapArea");
DB_GLO_DefeatCounter(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39,"GOB_WarMapArea");
DB_GLO_DefeatCounter(S_GOB_WarchiefGrumpy_126e39d1-7c38-453c-888b-4cddce7f3e41,"GOB_WarMapArea");

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("GOB_WarMapArea",(FLAG)GOB_WarMapArea_State_Swept_73aa9614-8c08-4b17-add8-216f71a90eec);
DB_PreventKnockedOutPermaDefeated((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_Surrender_BlockPermaDefeatedOnFlee((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);

TriggerRegisterForCharacter((TRIGGER)S_GOB_DrowCommander_KnockedOutRecruitmentBox_2a19441e-2c24-4b62-b35e-08f53089ffaa, (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);

PROC_GOB_DrowCommander_Init();
KBSECTION
//equip hack for minthara's offhand mace - the Dual wield passive activates after equipment is loaded in, 
//meaning she can't dual wield her maces through stats alone.
PROC
PROC_GOB_DrowCommander_Init()
AND
CreateAtObject(WPN_HUM_Mace_A_0_3186796d-3ab3-4d49-bfc2-cba1aff0cf5a,S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,0,0,"",0,(ITEM)_Mace)
AND
QRY_OnlyOnce("GOB_DrowCommander_Init")
THEN
Equip((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_Mace);
DB_Dialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, GOB_DrowCommander_b31382b6-355d-9ab4-3d20-4680e2c26477);

//REGION

//Meeting in Act 1
IF
DB_DialogNPCs(_ID, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
NOT DB_GLO_Minthara_MetBeforeExecution(1)
THEN
DB_GLO_Minthara_MetBeforeExecution(1);

//END_REGION

//REGION Raiders leave Goblin Camp

//Drow Commander goes to entrance.
//Goblin Boss goes around camp and triggers raiders.
	//Pathing goes to certain triggers were the goblins are. If raiders are dead or not at their designated spot, spot gets ignored.
	//Play AD when at spot. Raiders move shortly after.
	//If Boss is dead, Drow does this herself.
//When triggered, a raider goes to entrance.
//When all available raiders are in center, they use door and are set off stage.

IF
FlagSet(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
PROC_GOB_DrowCommander_LearnedGroveLocation_JournalHook();

PROC
PROC_GOB_DrowCommander_LearnedGroveLocation_JournalHook()
THEN
DB_NOOP(1);


IF
DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
AND
NOT DB_GOB_DrowCommander_DEBUG_BlockSortie(1)
AND
NOT DB_DialogNPCs(_, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _)
AND
QRY_OnlyOnce("GOB_DrowCommander_Leave")
THEN
PROC_GOB_DrowCommander_MoveOut();

//Drow leaves, ADs if warchief is there. Timer for warchief to leave.
PROC
PROC_GOB_DrowCommander_MoveOut()
THEN
PROC_RemoveDialog(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_ForceStopDialog(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39);
PROC_RemoveDialog(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39);

PROC
PROC_GOB_DrowCommander_MoveOut()
AND
NOT DB_Defeated(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39)
THEN
PROC_TryStartAD(GOB_DrowCommander_AD_DrowLeaving1_f5390938-081a-f91c-3a38-38298aaddd4a, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_GOB_DrowCommander_Move("GOB_DrowCommander_Drow1");
SetEntityEvent(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "GOB_DrowCommander_LeavingGoblinCamp");
ObjectTimerLaunch(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, "GOB_DrowCommander_ChiefGatherTimer", 2000);

PROC
PROC_GOB_DrowCommander_MoveOut()
AND
DB_Defeated(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39)
THEN
PROC_GOB_DrowCommander_Move("GOB_DrowCommander_Drow1");
SetEntityEvent(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "GOB_DrowCommander_LeavingGoblinCamp");

PROC
PROC_GOB_DrowCommander_TryTalkOrMove((STRING)_Talk)
AND
DB_GOB_DrowCommander_Raiders(_, _, _Talk, _)
AND
QRY_OnlyOnce(_Talk)
AND
DB_GOB_DrowCommander_LeaveADs(_Dialog, _Character, _, _Talk)
AND
DB_GOB_DrowCommander_LeaveMoves(_Talk, _, _LookFrom, _)
THEN
LookFromTrigger(_Character, _LookFrom, 0);
PROC_TryStartAD(_Dialog, _Character);


PROC
PROC_GOB_DrowCommander_TryTalkOrMove("GOB_DrowCommander_Drow3")
THEN
DB_GOB_DrowCommander_RaidersOnStandby((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
SetFlag(GOB_DrowCommander_State_AboutToLeave_687a5a02-6e56-98a4-abb2-a4182ae25c1d, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0);	//flagType: Object
PROC_RemoveDialog(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_Dialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, DEN_AttackOnDen_Drow_84abf1c9-de21-4db1-cbb1-0046faf2fc45);



PROC
PROC_GOB_DrowCommander_TryTalkOrMove("GOB_DrowCommander_Boss4")
THEN
DB_GOB_DrowCommander_RaidersOnStandby(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39);
SetFlag(GOB_DrowCommander_State_AboutToLeave_687a5a02-6e56-98a4-abb2-a4182ae25c1d, S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, 0);	//flagType: Object
PROC_RemoveDialog(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39);
DB_Dialogs(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, DEN_AttackOnDen_RaiderClumsy_edecd45b-5d2d-6b63-eaed-e52e715f39e8);


PROC
PROC_GOB_DrowCommander_TryTalkOrMove((STRING)_MoveTalkEvent)
AND
NOT DB_GOB_DrowCommander_Raiders(_, _, _MoveTalkEvent, _)
AND
DB_GOB_DrowCommander_NextMoveTalk(_MoveTalkEvent, _NextMoveTalkEvent)
THEN
PROC_GOB_DrowCommander_Move(_NextMoveTalkEvent);


PROC
PROC_GOB_DrowCommander_Move((STRING)_MoveTalkEvent)
AND
DB_GOB_DrowCommander_LeaveMoves(_MoveTalkEvent, _NPC, _Position, _MovementSpeed)
THEN
PROC_CharacterMoveTo(_NPC, _Position, _MovementSpeed, _MoveTalkEvent);
DB_GOB_DrowCommander_InLeaveMove(_NPC, _MoveTalkEvent);


IF
DB_GOB_DrowCommander_InLeaveMove(_NPC, _MoveTalkEvent)
AND
NOT DB_GOB_DrowCommander_MoveInterruptExclusion(_MoveTalkEvent)
AND
NOT DB_GOB_DrowCommander_Raiders(_, _, _MoveTalkEvent, _)
THEN
PROC_ClearStoryMove(_NPC);
SetEntityEvent(_NPC, _MoveTalkEvent);

IF
EntityEvent((CHARACTER)_Character, _MoveTalkEvent)
AND
DB_GOB_DrowCommander_NextMoveTalk(_MoveTalkEvent, _)
THEN
NOT DB_GOB_DrowCommander_InLeaveMove(_Character, _MoveTalkEvent);
PROC_GOB_DrowCommander_TryTalkOrMove(_MoveTalkEvent);

IF
ObjectTimerFinished(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, "GOB_DrowCommander_ChiefGatherTimer")
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
NOT DB_GOB_DrowCommander_ForceLeaveTriggered(1)
THEN
DB_GOB_DrowCommander_WarchiefBravePurged(1);
PurgeOsirisQueue(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39);

IF
QueuePurged(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39)
AND
DB_GOB_DrowCommander_WarchiefBravePurged(1)
THEN
PROC_TryStartAD(GOB_DrowCommander_AD_BossLeaving1_1ac61ec5-f10b-ced0-d47d-de1418a1b385, S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39);
PROC_GOB_DrowCommander_Move("GOB_DrowCommander_Boss1");
SetEntityEvent(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, "GOB_DrowCommander_LeavingGoblinCamp");

PROC
PROC_GOB_DrowCommander_StartResponseOnce((STRING)_MoveTalkEventResponse)
AND
QRY_OnlyOnce(_MoveTalkEventResponse)
THEN
PROC_GOB_DrowCommander_TryRaiderAD(_MoveTalkEventResponse);

IF
ObjectTimerFinished((CHARACTER)_Raider, "GOB_DrowCommander_GoToEntranceRunning")
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
NOT DB_GOB_DrowCommander_ForceLeaveTriggered(1)
AND
DB_GOB_DrowCommander_Raiders(_Raider, _Pos, _MoveTalkEvent, _Time)
AND
Concatenate(_MoveTalkEvent, "_Response", _Response)
THEN
DB_GOB_DrowCommander_GoToEntrance((CHARACTER)_Raider, "Run");
PROC_GOB_DrowCommander_StartResponseOnce(_Response);

IF
ObjectTimerFinished((CHARACTER)_Raider, "GOB_DrowCommander_GoToEntranceWalking")
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
NOT DB_GOB_DrowCommander_ForceLeaveTriggered(1)
AND
DB_GOB_DrowCommander_Raiders(_Raider, _Pos, _MoveTalkEvent, _Time)
AND
Concatenate(_MoveTalkEvent, "_Response", _Response)
THEN
DB_GOB_DrowCommander_GoToEntrance((CHARACTER)_Raider, "Walk");
PROC_GOB_DrowCommander_StartResponseOnce(_Response);

IF
DB_GOB_DrowCommander_GoToEntrance(_Raider, _)
THEN
SetEntityEvent(_Raider, "GOB_DrowCommander_LeavingGoblinCamp");

IF
AutomatedDialogEnded(_AD, _)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
NOT DB_GOB_DrowCommander_ForceLeaveTriggered(1)
AND
DB_GOB_DrowCommander_LeaveADs(_AD, _, _, _MoveTalkEvent)
AND
DB_GOB_DrowCommander_NextMoveTalk(_MoveTalkEvent, _NextMoveTalkEvent)
THEN
PROC_GOB_DrowCommander_Move(_NextMoveTalkEvent);


IF
AutomatedDialogEnded(_AD, _)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
NOT DB_GOB_DrowCommander_ForceLeaveTriggered(1)
AND
DB_GOB_DrowCommander_LeaveADs(_AD, _, 1, _MoveTalkEvent)
AND
DB_GOB_DrowCommander_Raiders(_Raider, _, _MoveTalkEvent, _Time)
THEN
ObjectTimerLaunch(_Raider, "GOB_DrowCommander_GoToEntranceRunning", _Time);


IF
AutomatedDialogEnded(_AD, _)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
NOT DB_GOB_DrowCommander_ForceLeaveTriggered(1)
AND
DB_GOB_DrowCommander_LeaveADs(_AD, _, 0, _MoveTalkEvent)
AND
DB_GOB_DrowCommander_Raiders(_Raider, _, _MoveTalkEvent, _Time)
THEN
ObjectTimerLaunch(_Raider, "GOB_DrowCommander_GoToEntranceWalking", _Time);


IF
DB_GOB_DrowCommander_GoToEntrance(_Raider, _MovementSpeed)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
NOT DB_GOB_DrowCommander_ForceLeaveTriggered(1)
AND
DB_GOB_DrowCommander_Raiders(_Raider, _Pos, _MoveTalkEvent, _Time)
AND
NOT DB_DialogNPCs(_, _Raider, _)
AND
NOT DB_GOB_DrowCommander_RaiderInMovement(_Raider)
THEN
DB_GOB_DrowCommander_RaiderInMovement(_Raider);
DB_GOB_DrowCommander_PurgedQueueRaider(_Raider);
PurgeOsirisQueue(_Raider);

IF
DB_GOB_DrowCommander_GoToEntrance(_Raider, _MovementSpeed)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
NOT DB_GOB_DrowCommander_ForceLeaveTriggered(1)
AND
DB_GOB_DrowCommander_Raiders(_Raider, _Pos, _MoveTalkEvent, _Time)
AND
DB_DialogNPCs(_ID, _Raider, _)
AND
DB_AutomatedDialog(_ID)
AND
NOT DB_GOB_DrowCommander_RaiderInMovement(_Raider)
THEN
DB_GOB_DrowCommander_RaiderInMovement(_Raider);
DB_GOB_DrowCommander_PurgedQueueRaider(_Raider);
PurgeOsirisQueue(_Raider);

IF
QueuePurged((CHARACTER)_Raider)
AND
DB_GOB_DrowCommander_PurgedQueueRaider(_Raider)
AND
DB_GOB_DrowCommander_GoToEntrance(_Raider, _MovementSpeed)
AND
DB_GOB_DrowCommander_Raiders(_Raider, _Pos, _, _)
THEN
NOT DB_GOB_DrowCommander_PurgedQueueRaider(_Raider);
RemoveHarmfulStatuses(_Raider);
LeaveCombat(_Raider);
PROC_RemoveDialog(_Raider);
PROC_CharacterMoveTo(_Raider, _Pos, _MovementSpeed, "GOB_DrowCommander_WaitingAtEntrance");


IF
EntityEvent((CHARACTER)_Raider, "GOB_DrowCommander_WaitingAtEntrance")
AND
NOT DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
THEN
DB_GOB_DrowCommander_RaidersOnStandby(_Raider);
SetFlag(GOB_DrowCommander_State_AboutToLeave_687a5a02-6e56-98a4-abb2-a4182ae25c1d, _Raider, 0);	//flagType: Object


PROC
PROC_GOB_DrowCommander_ChangeDialog((CHARACTER)_Raider)
AND
DB_DEN_AttackOnDen_RaiderDialogs(_Raider, _Dialog)
THEN
DB_Dialogs(_Raider, _Dialog);


IF
UseStarted(_Raider, S_GOB_Door_ToCamp_7cfeb44e-e17e-44ea-b42e-b2a4a4fca58c)
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
THEN
SetOnStage(_Raider, 0);
ClearFlag(GOB_DrowCommander_State_AboutToLeave_687a5a02-6e56-98a4-abb2-a4182ae25c1d, _Raider, 0);

IF
WentOnStage((CHARACTER)_Raider, 0)
AND
DB_GOB_DrowCommander_RaidersInGoblinCamp(_Raider)
AND
DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
THEN
NOT DB_GOB_DrowCommander_RaidersInGoblinCamp(_Raider);
NOT DB_GOB_DrowCommander_RaidersOnStandby(_Raider);
SetEntityEvent(_Raider, "GOB_DrowCommander_LeftGoblinCamp");
ClearFlag(GOB_DrowCommander_State_AboutToLeave_687a5a02-6e56-98a4-abb2-a4182ae25c1d, _Raider, 0);
SetFaction(_Raider, (FACTION)ACT1_DEN_AttackRaiders_Standby_aca56eff-f292-1b69-8f22-ec96197b8d25);

//Went off stage without sortie being triggered for some reason
IF
WentOnStage((CHARACTER)_Raider, 0)
AND
DB_GOB_DrowCommander_RaidersInGoblinCamp(_Raider)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
THEN
PROC_GOB_DrowCommander_ClearFromRaid(_Raider);


IF
DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
AND
NOT DB_GOB_DrowCommander_DEBUG_BlockSortie(1)
AND
DB_GOB_DrowCommander_RaidersOnStandby(_)
AND
SysCount("DB_GOB_DrowCommander_RaidersInGoblinCamp", 1, _RaiderCount)
AND
SysCount("DB_GOB_DrowCommander_RaidersOnStandby", 1, _StandbyCount)
AND
_StandbyCount >= _RaiderCount
AND
QRY_OnlyOnce("GOB_DrowCommander_EveryoneLeaves")
THEN
PROC_TriggerRegisterForPlayers(S_GOB_LeaveArea_2ebb0d7e-2240-4b4d-8d51-ee2873b39d20);
DB_GOB_DrowCommander_LeaveForRaid(1);

IF
EnteredTrigger(_Player, S_GOB_LeaveArea_2ebb0d7e-2240-4b4d-8d51-ee2873b39d20)
AND
DB_Players(_Player)
THEN
DB_GOB_DrowCommander_LeaveForRaid(2);


IF
DB_GOB_DrowCommander_LeaveForRaid(2)
AND
DB_GOB_DrowCommander_RaidersInGoblinCamp(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
NOT DB_DialogNPCs(_, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _)
AND
QRY_OnlyOnce("GOB_DrowCommander_LeaveAD")
THEN
PROC_TriggerUnregisterForPlayers(S_GOB_LeaveArea_2ebb0d7e-2240-4b4d-8d51-ee2873b39d20);
SysClear("DB_GOB_DrowCommander_LeaveForRaid", 1);
RemoveHarmfulStatuses(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_RemoveDialog(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_GOB_DrowCommander_RemoveRaiderDialogs();
SetEntityEvent(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "GOB_DrowCommander_DrowLeaves");

PROC
PROC_GOB_DrowCommander_RemoveRaiderDialogs()
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
THEN
PROC_RemoveDialog(_Raider);


IF
FlagSet(GOB_DrowCommander_Event_EveryoneLeaves_38c2ef1b-ae7f-9fe6-84f0-bba3a4703607, _, _)
THEN
PROC_GOB_DrowCommander_EveryoneLeaves();

PROC
PROC_GOB_DrowCommander_EveryoneLeaves()
AND
IsOpened(S_GOB_SecondEntranceDoor_3870ee00-35c9-4c6a-b4f7-4721115b7b72, 0)
THEN
Open(S_GOB_SecondEntranceDoor_3870ee00-35c9-4c6a-b4f7-4721115b7b72);

PROC
PROC_GOB_DrowCommander_EveryoneLeaves()
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
AND
DB_GOB_BattleStations_CombatGroupCharacters(_Raider, _Combat, _Position)
THEN
NOT DB_GOB_BattleStations_CombatGroupCharacters(_Raider, _Combat, _Position);

PROC
PROC_GOB_DrowCommander_EveryoneLeaves()
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
AND
DB_GOB_BattleStations_PotentialReinforcements(_Raider)
THEN
NOT DB_GOB_BattleStations_PotentialReinforcements(_Raider);

PROC
PROC_GOB_DrowCommander_EveryoneLeaves()
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
AND
DB_GOB_BattleStations_AlarmCharacters(_Raider)
THEN
NOT DB_GOB_BattleStations_AlarmCharacters(_Raider);

PROC
PROC_GOB_DrowCommander_EveryoneLeaves()
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
AND
DB_GOB_WolfPens_Reinforcement(_Raider, _Pos, _NewPos)
THEN
NOT DB_GOB_WolfPens_Reinforcement(_Raider, _Pos, _NewPos);

PROC
PROC_GOB_DrowCommander_EveryoneLeaves()
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
AND
NOT DB_GOB_DrowCommander_RaiderLeaveTimers(_Raider, _)
THEN
RemoveHarmfulStatuses(_Raider);
PROC_ForceStopDialog(_Raider);
PROC_CharacterMoveTo(_Raider, S_GOB_OutsidePos_c9884e96-b3c7-4ee1-9ec8-b8aeec065837, "Run", "GOB_DrowCommander_LeftTemple");

PROC
PROC_GOB_DrowCommander_EveryoneLeaves()
THEN
RemoveHarmfulStatuses(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_CharacterMoveTo(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, S_GOB_OutsidePos_c9884e96-b3c7-4ee1-9ec8-b8aeec065837, "Run", "GOB_DrowCommander_LeftTemple");

PROC
PROC_GOB_DrowCommander_EveryoneLeaves()
THEN
ObjectTimerLaunch(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, "GOB_DrowCommander_LeaveTimer", 2000);

PROC
PROC_GOB_DrowCommander_EveryoneLeaves()
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
AND
DB_GOB_DrowCommander_RaiderLeaveTimers(_Raider, _Timer)
THEN
ObjectTimerLaunch(_Raider, "GOB_DrowCommander_LeaveTimer", _Timer);

IF
ObjectTimerFinished(_Raider, "GOB_DrowCommander_LeaveTimer")
THEN
RemoveHarmfulStatuses(_Raider);
PROC_ForceStopDialog(_Raider);
PROC_CharacterMoveTo((CHARACTER)_Raider, S_GOB_OutsidePos_c9884e96-b3c7-4ee1-9ec8-b8aeec065837, "Run", "GOB_DrowCommander_LeftTemple");

IF
EntityEvent(_Raider, "GOB_DrowCommander_LeftTemple")
THEN
PROC_DisappearOutOfSightTo((CHARACTER)_Raider, S_GOB_ExitPos_e62721a0-270d-4c91-a449-97f7ac8a2160, "Run", 1, "");


PROC
PROC_StateSet_Defeated((CHARACTER)_Raider)
AND
DB_GOB_DrowCommander_RaidersInGoblinCamp(_Raider)
THEN
PROC_GOB_DrowCommander_ClearFromRaid(_Raider);

PROC
PROC_GOB_DrowCommander_ClearFromRaid((CHARACTER)_Raider)
AND
DB_GOB_DrowCommander_RaidersInGoblinCamp(_Raider)
THEN
NOT DB_GOB_DrowCommander_RaidersInGoblinCamp(_Raider);

PROC
PROC_GOB_DrowCommander_ClearFromRaid((CHARACTER)_Raider)
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
THEN
NOT DB_GOB_DrowCommander_RaidersOnStandby(_Raider);

PROC
PROC_GOB_DrowCommander_ClearFromRaid((CHARACTER)_Raider)
AND
DB_GOB_DrowCommander_Raiders(_Raider, _Pos, _Event, _Index)
THEN
NOT DB_GOB_DrowCommander_Raiders(_Raider, _Pos, _Event, _Index);

PROC
PROC_GOB_DrowCommander_ClearFromRaid((CHARACTER)_Raider)
AND
DB_DEN_AttackOnDen_Raiders(_Raider, _Pos, _AppearPos, _AppearDirection)
THEN
NOT DB_DEN_AttackOnDen_Raiders(_Raider, _Pos, _AppearPos, _AppearDirection);

PROC
PROC_GOB_DrowCommander_ClearFromRaid((CHARACTER)_Raider)
AND
DB_DEN_AttackOnDen_LockdownRaiders(_Raider, _Pos)
THEN
NOT DB_DEN_AttackOnDen_LockdownRaiders(_Raider, _Pos);

PROC
PROC_GOB_DrowCommander_ClearFromRaid((CHARACTER)_Raider)
AND
DB_DEN_AttackOnDen_RaiderVictoryPositions(_Raider, _Pos)
THEN
NOT DB_DEN_AttackOnDen_RaiderVictoryPositions(_Raider, _Pos);

PROC
PROC_GOB_DrowCommander_ClearFromRaid((CHARACTER)_Raider)
AND
DB_DEN_AttackOnDen_WavePriority(_Raider, _Wave)
THEN
NOT DB_DEN_AttackOnDen_WavePriority(_Raider, _Wave);

PROC
PROC_GOB_DrowCommander_ClearFromRaid((CHARACTER)_Raider)
AND
DB_DEN_AttackOnDen_VictoryRaiders(_Raider)
THEN
NOT DB_DEN_AttackOnDen_VictoryRaiders(_Raider);

IF
DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
AND
NOT DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
NOT DB_GOB_DrowCommander_RaidersOnStandby(_)
AND
NOT DB_GOB_DrowCommander_RaidersInGoblinCamp(_)
THEN
SetFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480, _, _)
THEN
PROC_GOB_DrowCommander_RaidersLeft_JournalHook();

IF
DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
DB_GlobalFlag(DEN_RaidingParty_Quest_GoblinRaidOver_98712d90-c46b-20c4-c4df-02c0117e85a5)
THEN
SetFlag((FLAG)GLO_AttackOnDen_State_RaidReady_eb361773-da88-dee4-f4c8-a22acae60948, NULL_00000000-0000-0000-0000-000000000000, 0);	//flagType: Global


PROC
PROC_GOB_DrowCommander_TryRaiderAD("GOB_DrowCommander_Boss2_Response")
AND
DB_GOB_DrowCommander_Raiders(S_GOB_RaiderArrogant_43d953fa-575e-452c-b220-939e6bdcc36b, _, _, _)
AND
DB_GOB_DrowCommander_Raiders(S_GOB_RaiderStupid_5d049dbe-ff35-45be-88f9-5f999dc0ffe4, _, _, _)
AND
DB_GOB_DrowCommander_Raiders(S_GOB_RaiderCunning_abdd3748-0834-46f3-8214-18dd4dca9d40, _, _, _)
THEN
PROC_TryStartAD(GOB_DrowCommander_AD_CoalTrioLeaving_50eea3c1-6b94-33ca-f66c-60c67cc9dfc6, S_GOB_RaiderArrogant_43d953fa-575e-452c-b220-939e6bdcc36b, S_GOB_RaiderStupid_5d049dbe-ff35-45be-88f9-5f999dc0ffe4, S_GOB_RaiderCunning_abdd3748-0834-46f3-8214-18dd4dca9d40);

PROC
PROC_GOB_DrowCommander_TryRaiderAD("GOB_DrowCommander_Drow1_Response")
AND
DB_GOB_DrowCommander_Raiders(S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280, _, _, _)
THEN
PROC_TryStartAD(GOB_DrowCommander_AD_DepartingChieftain_3f56841f-0ccc-5381-5ad7-c8884c9e5eca, S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280);

PROC
PROC_GOB_DrowCommander_TryRaiderAD("GOB_DrowCommander_Drow2_Response")
AND
DB_GOB_DrowCommander_Raiders(S_GOB_GoblinLush_d738c9a4-a031-4dd9-912f-93cda8d8d8b7, _, _, _)
THEN
PROC_TryStartAD(GOB_DrowCommander_AD_DepartingLush_47e46135-e5a4-0043-36ff-8dcad5cd5598, S_GOB_GoblinLush_d738c9a4-a031-4dd9-912f-93cda8d8d8b7);

PROC
PROC_GOB_DrowCommander_TryRaiderAD("GOB_DrowCommander_Boss1_Response")
AND
DB_GOB_DrowCommander_Raiders(S_GOB_RaiderHardy_6687f78f-5d6a-40d4-8cfd-2b972dacde3c, _, _, _)
THEN
PROC_TryStartAD(GOB_DrowCommander_AD_WaitingHardy_edfc8607-5e7f-fea0-e590-640c9e88e3d5, S_GOB_RaiderHardy_6687f78f-5d6a-40d4-8cfd-2b972dacde3c);

PROC
PROC_GOB_DrowCommander_TryRaiderAD("GOB_DrowCommander_Boss3_Response")
AND
DB_GOB_DrowCommander_Raiders(S_GOB_WarchiefGrumpy_126e39d1-7c38-453c-888b-4cddce7f3e41, _, _, _)
THEN
PROC_TryStartAD(GOB_DrowCommander_AD_WaitingGrumpy_bb6547ca-2f63-6b63-4a2f-d9784bec3a6a, S_GOB_WarchiefGrumpy_126e39d1-7c38-453c-888b-4cddce7f3e41);


IF 
EntityEvent((CHARACTER)_Character, "GOB_DrowCommander_LeftGoblinCamp")
AND
DB_GOB_BattleStations_CombatGroupCharacters(_Character, _Combat, _Position)
THEN
NOT DB_GOB_BattleStations_CombatGroupCharacters(_Character, _Combat, _Position);

IF
LeftTrigger(_Player, S_GOB_ThroneRoom_SUB_bb81678b-641c-43fc-bd41-53295d59be03)
AND
DB_Players(_Player)
AND
DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
AND
NOT QRY_CheckOtherPlayersInTrigger(_Player, S_GOB_ThroneRoom_SUB_bb81678b-641c-43fc-bd41-53295d59be03)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersLeftForAttack_ce12e8de-2922-4a2b-843b-0494833b8480)
AND
QRY_OnlyOnce("GOB_DrowCommander_ForceRaidersLeave")
THEN
PROC_GOB_DrowCommander_RaidersForceLeave();

IF
FlagSet(GOB_DrowCommander_HasMet_4cdf4899-bd4e-569d-44b6-236e815ec000,_,_)
THEN
SetFlag((FLAG)GOB_DrowCommander_Event_MetVisitors_f86ea32a-1b1b-c407-0cf8-0f39b942cfef);


//END_REGION


//REGION Dialogs at Goblin Camp

QRY
QRY_SelectCustomDialog_AfterGenerics(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, _Player)
AND
DB_Dialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,GOB_DrowCommander_b31382b6-355d-9ab4-3d20-4680e2c26477)
AND
NOT DB_GlobalFlag((FLAG)GOB_CapturedGoblin_State_AtDrow_0ed79536-5635-2538-8a2e-240a4778b1d6)
AND
GetFlag(GOB_DrowCommander_HasMet_4cdf4899-bd4e-569d-44b6-236e815ec000, _Player, 0)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39)
THEN
DB_SelectedDialog(GOB_DrowCommander_b31382b6-355d-9ab4-3d20-4680e2c26477, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Player, S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Player)
AND
DB_Dialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,GOB_DrowCommander_b31382b6-355d-9ab4-3d20-4680e2c26477)
AND
NOT DB_GlobalFlag((FLAG)GOB_CapturedGoblin_State_AtDrow_0ed79536-5635-2538-8a2e-240a4778b1d6)
AND
GetFlag(GOB_DrowCommander_HasMet_4cdf4899-bd4e-569d-44b6-236e815ec000, _Player, 0)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
DB_SelectedDialog(GOB_DrowCommander_b31382b6-355d-9ab4-3d20-4680e2c26477, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Player, S_GOB_WarchiefBrave_6601b8f7-1a92-46bb-b409-6fcef7406a39);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280, _Player)
AND
DB_Dialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,GOB_DrowCommander_b31382b6-355d-9ab4-3d20-4680e2c26477)
AND
DB_Dialogs(S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280, GOB_RaiderChieftain_92a92b0b-2678-f793-8cfa-31ba6c767cc0)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GOB_Eye_7e80dd2a-19f6-4411-8a52-35c3878ef4c8, S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280)
THEN
DB_SelectedDialog(GOB_RaiderChieftain_92a92b0b-2678-f793-8cfa-31ba6c767cc0, S_GOB_RaiderChieftain_5bac0842-c1d4-4358-a85c-24ab745d0280, _Player, S_GOB_Eye_7e80dd2a-19f6-4411-8a52-35c3878ef4c8);


IF
FlagSet((FLAG)GOB_DrowCommander_HasMet_4cdf4899-bd4e-569d-44b6-236e815ec000, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)DEN_GroveConflict_Knows_LeaderNameDrow_20f20de4-4f03-b2b9-6a6b-e96f5e190160)
THEN
SetFlag((FLAG)DEN_GroveConflict_Knows_LeaderNameDrow_20f20de4-4f03-b2b9-6a6b-e96f5e190160);
//END_REGION

//REGION Hostility in Goblin Camp
IF
DialogActorLeft(GOB_DrowCommander_b31382b6-355d-9ab4-3d20-4680e2c26477, _, (CHARACTER)_Player, _)
AND
DB_Players(_Player)
AND
DB_GlobalFlag(GOB_DrowCommander_State_Hostile_27a5c5a6-70bc-81e2-6aa9-ca1f4e619623)
THEN
ClearFlag(GOB_DrowCommander_State_Hostile_27a5c5a6-70bc-81e2-6aa9-ca1f4e619623, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_SetHostileToIndivPlayerFaction((FACTION)ACT1_GOB_Leaders_a25829dd-772a-6b00-572f-e036f89471aa, _Player);


//Attacking Minthara in Den after capturing it should set Goblins allied to her and neutral to players so that the Grove goblins will defend Minthara, but goblins that don't see you kill Minthara remain non-hostile.
IF
FlagSet(GOB_DrowCommander_State_Hostile_27a5c5a6-70bc-81e2-6aa9-ca1f4e619623, _, _)
AND
DB_GlobalFlag(DEN_AttackOnDen_State_RaidersAtDen_29f372ac-f9f1-4d54-bc9e-7eb493fa09d8)
THEN
PROC_SetRelationMutual((FACTION)ACT1_DEN_AttackRaiders_Fighters_bfdc773b-6521-4fd1-3784-3d1404f1b2f5, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 50);
PROC_SetRelationMutual((FACTION)ACT1_DEN_AttackRaiders_Fighters_bfdc773b-6521-4fd1-3784-3d1404f1b2f5, (FACTION)ACT1_DEN_AttackRaiders_Standby_aca56eff-f292-1b69-8f22-ec96197b8d25, 100);
SetCombatGroupID(S_GOB_RaiderArrogant_43d953fa-575e-452c-b220-939e6bdcc36b, "");
SetCombatGroupID(S_GOB_WarchiefGrumpy_126e39d1-7c38-453c-888b-4cddce7f3e41, "");

//END_REGION
IF
StatusApplied((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "KNOCKED_OUT_PERMANENTLY", _, _)
AND
IsInTrigger((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TRIGGER)S_GOB_DrowCommander_KnockedOutRecruitmentBox_2a19441e-2c24-4b62-b35e-08f53089ffaa, 1)
THEN
DB_ORI_Minthara_RemoveKnockedOutLater(1);
NOT DB_GLO_DefeatCounter(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GOB_GoblinHunt_Leaders");

IF
StatusRemoved((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "KNOCKED_OUT", _, _)
AND
NOT DB_PermaDefeated((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
IsInTrigger((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TRIGGER)S_GOB_DrowCommander_KnockedOutRecruitmentBox_2a19441e-2c24-4b62-b35e-08f53089ffaa, 1)
THEN
ScatterStoryItems(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_SetOnStage(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0);
DB_ORI_Minthara_RemoveKnockedOutLater(1);
NOT DB_GLO_DefeatCounter(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GOB_GoblinHunt_Leaders");

IF
TagSet((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727)
AND
IsDead((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0)
THEN
ClearTag(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
NOT DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);

IF
LevelUnloading("WLD_Main_A")
AND
NOT DB_PermaDefeated((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_KnockedOut(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
IsOnStage((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1)
THEN
ScatterStoryItems(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_SetOnStage(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0);
DB_ORI_Minthara_RemoveKnockedOutLater(1);
NOT DB_GLO_DefeatCounter(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GOB_GoblinHunt_Leaders");

QRY
QRY_SelectCustomDialog_AfterGenerics(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_Player)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
NOT QRY_MOO_IsInMOO((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_GlobalFlag((FLAG)GOB_CapturedGoblin_State_AtDrow_0ed79536-5635-2538-8a2e-240a4778b1d6)
AND
NOT DB_GlobalFlag((FLAG)GOB_CapturedGoblin_Event_Resolved_aae95a8b-bbec-e7c6-f47a-53834c294a2b)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
AND
NOT DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
DB_SelectedDialog(GOB_DrowAndCaptured_ThreeWayDialog_46a73870-54c1-902c-fc27-c967c2093ac5,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_Player)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
NOT QRY_MOO_IsInMOO((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_GlobalFlag((FLAG)GOB_CapturedGoblin_State_AtDrow_0ed79536-5635-2538-8a2e-240a4778b1d6)
AND
NOT DB_GlobalFlag((FLAG)GOB_CapturedGoblin_Event_Resolved_aae95a8b-bbec-e7c6-f47a-53834c294a2b)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
AND
NOT DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
DB_SelectedDialog(GOB_DrowAndCaptured_ThreeWayDialog_46a73870-54c1-902c-fc27-c967c2093ac5,S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_Player);


IF
FlagSet(GOB_DrowCommander_Event_DrowHostile_57558ea3-4be2-aa9e-6caf-3d53832d04b7, (CHARACTER)_Player, _ID) // flagType: Object
THEN
DB_GOB_DrowCommander_Event_DrowHostileAfterDialog((CHARACTER)_Player,_ID);

IF
DialogEnded(GOB_DrowAndCaptured_ThreeWayDialog_46a73870-54c1-902c-fc27-c967c2093ac5,_ID)
AND
DB_GOB_DrowCommander_Event_DrowHostileAfterDialog(_Player,_ID)
AND
GetFaction(_Player, _PlayerFaction)
AND
GetFaction(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Faction)
THEN
PROC_SetRelationMutual(_Faction, _PlayerFaction, 0);

IF
DialogEnded(GOB_DrowAndCaptured_ThreeWayDialog_46a73870-54c1-902c-fc27-c967c2093ac5,_ID)
AND
DB_GlobalFlag((FLAG)GOB_CapturedGoblin_State_Spared_28a0e5c2-ee4a-3b33-a7cc-467adb5bdb88) // flagType: Global
AND
QRY_StartDialog(GOB_DrowCommander_AD_CapturedSpared_fa9e90c0-8f4a-e809-bf2d-637c5d0c3342,S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
PROC_CharacterMoveTo(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,S_GOB_CapturedGoblin_SparedPoint_38085169-9e5c-44ef-ab24-f299803ee9a6,"Walk","");
DB_Dialogs((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, (DIALOGRESOURCE)DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264);
SetHasDialog(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, 1);

IF
CombatEnded(_CombatID)
AND
DB_DrowAndCaptured_CombatResolution(_CombatID)
AND
DB_Was_InCombat(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, _CombatID)
AND
DB_Defeated((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
ClearFlag((FLAG)GOB_CapturedGoblin_State_Executed_5505345c-482d-cfc5-3a2b-987611beb4e3);
SetFlag((FLAG)GOB_CapturedGoblin_State_Spared_28a0e5c2-ee4a-3b33-a7cc-467adb5bdb88);
PROC_CharacterMoveTo(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,S_GOB_CapturedGoblin_SparedPoint_38085169-9e5c-44ef-ab24-f299803ee9a6,"Walk","");
DB_Dialogs((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, (DIALOGRESOURCE)DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264);
SetHasDialog(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, 1);

IF
TextEvent("raidersleavegoblincamp")
THEN
SetFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_GOB_DrowCommander_RaidersForceLeave()
THEN
DB_GOB_DrowCommander_ForceLeaveTriggered(1);
PROC_TriggerUnregisterForPlayers(S_GOB_LeaveArea_2ebb0d7e-2240-4b4d-8d51-ee2873b39d20);

PROC
PROC_GOB_DrowCommander_RaidersForceLeave()
AND
DB_GOB_DrowCommander_RaidersInGoblinCamp(_Raider)
AND
NOT DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
THEN
DB_GOB_DrowCommander_RaidersOnStandby(_Raider);

PROC
PROC_GOB_DrowCommander_RaidersForceLeave()
AND
DB_GOB_DrowCommander_RaidersInGoblinCamp(_Raider)
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
THEN
PROC_ClearStoryMove(_Raider);
RemoveHarmfulStatuses(_Raider);
LeaveCombat(_Raider);
PROC_RemoveAllDialogEntriesForSpeaker(_Raider);
PROC_GOB_DrowCommander_ChangeDialog(_Raider);
SetOnStage(_Raider, 0);

PROC
PROC_GOB_DrowCommander_RaidersForceLeave()
THEN
PROC_RemoveDialog(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_Dialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, DEN_AttackOnDen_Drow_84abf1c9-de21-4db1-cbb1-0046faf2fc45);

IF
EntityEvent(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "GOB_DrowCommander_LeftGoblinCamp")
THEN
TimerLaunch("GOB_DrowCommander_FallbackForceSetup", 10000);

IF
TimerFinished("GOB_DrowCommander_FallbackForceSetup")
THEN
PROC_GOB_DrowCommander_ClearMissingStandbyRaiders();

PROC
PROC_GOB_DrowCommander_ClearMissingStandbyRaiders()
AND
DB_GOB_DrowCommander_RaidersOnStandby(_Raider)
THEN
PROC_GOB_DrowCommander_ClearFromRaid(_Raider);

IF
DB_Permadefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
THEN
ClearFlag((FLAG)GOB_CapturedGoblin_State_AtDrow_0ed79536-5635-2538-8a2e-240a4778b1d6);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
