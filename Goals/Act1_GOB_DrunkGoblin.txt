Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, GOB_DrunkGoblin_48cdc0fd-1ed7-202b-e84c-8874d50d0800);
DB_Dialogs(S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee, GOB_DrunkGoblin_Friend0_a7c2fe80-3d92-1eeb-329d-26affcfb4148);
DB_Dialogs(S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269, GOB_DrunkGoblin_Friend1_c98b1e63-afa5-fdd1-5169-bfa124d62cc5);
DB_Dialogs(S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c, GOB_DrunkGoblin_Friend2_7bcb89fa-97db-ee09-1616-4dd060ee7dba);

DB_GOB_DrunkGoblin_SceneParticipants((CHARACTER)S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);
DB_GOB_DrunkGoblin_SceneParticipants(S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee);
DB_GOB_DrunkGoblin_SceneParticipants(S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269);
DB_GOB_DrunkGoblin_SceneParticipants(S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c);

DB_GOB_DrunkGoblin_Friends((CHARACTER)S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee);
DB_GOB_DrunkGoblin_Friends(S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269);
DB_GOB_DrunkGoblin_Friends(S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c);

// Goblin, point to move when escaping, AD to play when escaping
DB_GOB_DrunkGoblin_Friends_EscapeFight((CHARACTER)S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee, (TRIGGER)S_GOB_DrunkGoblin_FightPoint_000_f92c53f9-01ef-4ce3-a37b-b6ae95ee2f4f, (DIALOGRESOURCE)GOB_DrunkGoblin_AD_LeftFight_Breg_4c9fc7f0-f65b-113d-5d5d-aa939b5a4187);
DB_GOB_DrunkGoblin_Friends_EscapeFight(S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269, S_GOB_DrunkGoblin_FightPoint_001_0425c806-0236-4c99-bb8e-26d66908ce0d, GOB_DrunkGoblin_AD_LeftFight_Kirz_ce51a0cc-6344-332b-96ee-a99a8a269bf0);
DB_GOB_DrunkGoblin_Friends_EscapeFight(S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c, S_GOB_DrunkGoblin_FightPoint_002_e1d570a1-8861-4616-bde7-ac0ec5d0569a, GOB_DrunkGoblin_AD_LeftFight_Tiny_34791900-6cd5-9c3c-7ac0-c3789599dc21);

DB_Inclusion_Object(S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee,(FLAG)GOB_DrunkGoblin_AddGoblin0_3969ab4d-5203-48c1-951e-9fa311e8f43e,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_Object(S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269,(FLAG)GOB_DrunkGoblin_AddGoblin1_3775cd24-f67c-4b53-b7fa-ee7e25356624,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_Object(S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c,(FLAG)GOB_DrunkGoblin_AddGoblin2_10f27775-4e10-f066-858e-1fb9f59c2ea3,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)GOB_DrunkGoblin_AD_Stories_e4c05178-cd73-bbaa-9e16-bd1cfc10ccce,S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)GOB_DrunkGoblin_AD_Stories_e4c05178-cd73-bbaa-9e16-bd1cfc10ccce,S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)GOB_DrunkGoblin_AD_Stories_e4c05178-cd73-bbaa-9e16-bd1cfc10ccce,S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c);

// Drunk Goblin friends will react on the result of your actions in their dialogs
DB_GOB_DrunkGoblin_GoblinSharedFlags((FLAG)GOB_DrunkGoblin_Event_KissedFeet_d252b771-2479-fb5d-4de0-20f97c375cc1);
DB_GOB_DrunkGoblin_GoblinSharedFlags((FLAG)GOB_DrunkGoblin_Event_Mocked_a9d88205-e99e-8c95-4270-2617a38291e5);
DB_GOB_DrunkGoblin_GoblinSharedFlags((FLAG)GOB_DrunkGoblin_Event_MoveToSecludedPlace_e0a9dff2-0eba-587f-c301-1c600ce0adf3);

//To setup fist fight
DB_GOB_DrunkGoblin_OtherGoblins((CHARACTER)S_GOB_Festivities_Goblin_000_031e9fb7-136a-46c7-91d7-77ce3e20236a);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_Festivities_Goblin_001_774c78ed-1227-48f9-812e-aac0021c71bf);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_Festivities_Goblin_002_bb9c82a2-7ed9-45ed-99b6-58f84520fb8c);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_Festivities_Goblin_003_0296a9f6-b2bc-46a0-8632-ba72679a36d3);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_Festivities_Goblin_005_a955aea9-9040-4d4c-9264-e46e385dea94);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_Festivities_Goblin_006_f3f416d1-b946-4019-95ba-7053f63dd776);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_VoloGuard_000_c25f0e79-b9f7-453c-8138-964bca267d93);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_RoastingDwarfOperator_000_1fe911f8-c9c9-4405-83fa-d343d59c7be9);
DB_GOB_DrunkGoblin_OtherGoblins(S_GOB_RoastingDwarfOperator_001_3837d519-dc92-459c-ab2d-1eac0b208fc7);

//REGION Aftermath Reactions
DB_GOB_DrunkGoblin_GoblinMockedReactions((CHARACTER)S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee, (DIALOGRESOURCE)GOB_DrunkGoblin_AD_KissedFootComment_001_112876ea-7667-0b15-7746-972805c2e4fc, 5000);
DB_GOB_DrunkGoblin_GoblinMockedReactions(S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269, GOB_DrunkGoblin_AD_KissedFootComment_002_6551de79-b844-954f-9671-4991aa1ac9f2, 1000);

DB_GOB_DrunkGoblin_GoblinSparedReactions((CHARACTER)S_GOB_RoastingDwarfOperator_001_3837d519-dc92-459c-ab2d-1eac0b208fc7, (DIALOGRESOURCE)GOB_DrunkGoblin_AD_DefeatComment_001_1c5d723e-3c27-67a0-1716-858a989c5f78, 1000);
DB_GOB_DrunkGoblin_GoblinSparedReactions(S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee, GOB_DrunkGoblin_AD_DefeatComment_002_c469c610-94dd-0ad1-a092-2ef20c23077e, 5000);

DB_GOB_DrunkGoblin_PlayerKissedFootReactions((CHARACTER)S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee, (DIALOGRESOURCE)GOB_DrunkGoblin_AD_PlayerKissedFoot_001_1a18f7b4-e475-5b62-7760-0fdf55d7fff7, 5000);
DB_GOB_DrunkGoblin_PlayerKissedFootReactions(S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c, GOB_DrunkGoblin_AD_PlayerKissedFoot_002_19418a12-3561-b46e-5c8b-4c19c37f4715, 1000);

DB_GOB_DrunkGoblin_DeadReactions((CHARACTER)S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee, (DIALOGRESOURCE)GOB_DrunkGoblin_AD_PlayerKilledDrunkGoblin_001_fd30b3c6-37ef-33eb-d46c-b7bb3012bfd2);
DB_GOB_DrunkGoblin_DeadReactions(S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c, GOB_DrunkGoblin_AD_PlayerKilledDrunkGoblin_002_c78cb398-be7d-529b-6dd5-6b775ab6bd7c);
//END_REGION Aftermath Reactions

Equip((CHARACTER)S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86,(ITEM)S_GOB_DrunkGoblin_Ring_91c90b8b-59d5-4a89-bb68-0ac465a707a3);
DB_FlagReactionAfterDialog(GOB_DrunkGoblin_Event_RingStolen_78805014-8f74-a0ef-9a4b-2f608e31e4e7, GOB_DrunkGoblin_48cdc0fd-1ed7-202b-e84c-8874d50d0800);

SetFlag(GOB_DrunkGoblin_State_TellingStories_f4ebead3-02c8-5681-79b7-b31b80fc9d6a,NULL_00000000-0000-0000-0000-000000000000);

DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_GLO_CharacterCorpseDialog(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, (DIALOGRESOURCE)GOB_DrunkGoblin_Dead_6b498e2a-95cd-7e98-1605-f81b4105462d);
KBSECTION
//REGION Telling Stories AD
// used to be in Anubis, but that doesn't work with inclusion system
// so moved to using an event sent here and starting the AD in Osiris
IF
EntityEvent(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86,"GOB_DrunkGoblin_Event_StartTellingStoriesAD")
AND
NOT DB_GlobalFlag((FLAG)GOB_DrunkGoblin_Event_FistFight_c1248900-1056-45a8-aabf-2d5eb8a8d3ee)
AND
QRY_StartDialog(GOB_DrunkGoblin_AD_Stories_e4c05178-cd73-bbaa-9e16-bd1cfc10ccce,S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
THEN
DB_NOOP(1);

IF
AutomatedDialogStarted(GOB_DrunkGoblin_AD_Stories_e4c05178-cd73-bbaa-9e16-bd1cfc10ccce, _)
THEN
SetFlag(GOB_DrunkGoblin_Event_IsTellingStory_9ce4a245-59eb-4df2-a85b-9717e351ebbe);

IF
AutomatedDialogEnded(GOB_DrunkGoblin_AD_Stories_e4c05178-cd73-bbaa-9e16-bd1cfc10ccce, _)
AND
DB_GlobalFlag(GOB_DrunkGoblin_Event_IsTellingStory_9ce4a245-59eb-4df2-a85b-9717e351ebbe)
THEN
ClearFlag(GOB_DrunkGoblin_Event_IsTellingStory_9ce4a245-59eb-4df2-a85b-9717e351ebbe);
//END_REGION Telling stories AD

//REGION Faction changes
PROC
PROC_GOB_DrunkGoblin_SetFactionForFistFight()
AND
QRY_OnlyOnce("GOB_DrunkGoblin_ChangeFaction")
AND
DB_GOB_DrunkGoblin_SceneParticipants(_DrunkGoblinFriend)
THEN
SetFaction(_DrunkGoblinFriend,ACT1_GOB_DrunkGoblin_FistFight_381ddd56-5aa8-dd7b-bb2e-b1d1fba64a8f);

IF
BaseFactionChanged(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86,_,ACT1_GOB_DrunkGoblin_FistFight_381ddd56-5aa8-dd7b-bb2e-b1d1fba64a8f)
THEN
PROC_SetRelationToPlayers(ACT1_GOB_DrunkGoblin_FistFight_381ddd56-5aa8-dd7b-bb2e-b1d1fba64a8f,0);

PROC
PROC_GOB_DrunkGoblin_RestoreFaction()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_DrunkGoblinFriend)
THEN
SetFaction(_DrunkGoblinFriend,ACT1_GOB_DrunkGoblin_b09cdb9e-22b9-404a-b78e-13815217bfa7);
//END_REGION Faction changes

//REGION Start fight after dialogue
// Real fight
IF
DialogEnded(GOB_DrunkGoblin_48cdc0fd-1ed7-202b-e84c-8874d50d0800, _Id)
AND
DialogGetInvolvedPlayer(_Id, 1, (CHARACTER)_Player)
AND
QRY_GOB_DrunkGoblin_CheckAndClearFlag(_Player,(FLAG)GOB_DrunkGoblin_Event_RealFight_9f0649f5-a0e8-8aee-65b7-bf18f9246a04)
THEN
PROC_MakeNPCHostile((CHARACTER)S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86,_Player);

//Fist fight
IF
DialogEnded(GOB_DrunkGoblin_48cdc0fd-1ed7-202b-e84c-8874d50d0800, _Id)
AND
DialogGetInvolvedPlayer(_Id, 1, (CHARACTER)_Player)
AND
QRY_GOB_DrunkGoblin_CheckAndClearFlag((CHARACTER)_Player,(FLAG)GOB_DrunkGoblin_Event_StartFistFight_b686f325-d703-e0ad-9acb-81543c48fe95)
THEN
PROC_GOB_DrunkGoblin_DrunkAndFriends_SetBlockRegenAfterCombat();
PROC_GOB_DrunkGoblin_DrunkAndFriends_SetIgnoreAssault();
PROC_GOB_DrunkGoblin_DrunkAndFriends_SetImmortal(1);
PROC_GOB_DrunkGoblin_FestivitiesGoblins_SaveCoweringState();
PROC_GOB_DrunkGoblin_FestivitiesGoblins_BlockCowering();
DB_GOB_DrunkGoblin_PlayerInFight(_Player);
SetFlag((FLAG)GOB_DrunkGoblin_Event_FistFight_c1248900-1056-45a8-aabf-2d5eb8a8d3ee, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag((FLAG)GOB_DrunkGoblin_State_GoblinsAreCheering_45ac1c47-bf41-4758-a02b-d5a8702f2919, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_GOB_DrunkGoblin_SetFactionForFistFight();
PROC_GOB_DrunkGoblin_SetPreventPermaDefeatedAfterKnockOut();
PROC_ForceStopSpecificDialog(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, (DIALOGRESOURCE)GOB_DrunkGoblin_AD_Stories_e4c05178-cd73-bbaa-9e16-bd1cfc10ccce);
//END_REGION Start fight after dialogue

//REGION Fight setup helpers
QRY
QRY_GOB_DrunkGoblin_CheckAndClearFlag((CHARACTER)_Character,(FLAG)_Flag)
AND
GetFlag((FLAG)_Flag, _Character, 1)
THEN
ClearFlag((FLAG)_Flag, _Character);

PROC
PROC_GOB_DrunkGoblin_DrunkAndFriends_SetIgnoreAssault()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
THEN
DB_IgnoreAssault(_Goblin);

PROC
PROC_GOB_DrunkGoblin_DrunkAndFriends_RemoveIgnoreAssault()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
THEN
NOT DB_IgnoreAssault(_Goblin);

PROC
PROC_GOB_DrunkGoblin_DrunkAndFriends_SetBlockRegenAfterCombat()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
THEN
PROC_SelfHealing_Disable(_Goblin);

PROC
PROC_GOB_DrunkGoblin_DrunkAndFriends_ClearBlockRegenAfterCombat()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
THEN
PROC_SelfHealing_Enable(_Goblin);

PROC
PROC_GOB_DrunkGoblin_DrunkAndFriends_SetImmortal((INTEGER)_IsImmortal)
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
AND
NOT DB_PermaDefeated(_Goblin)
THEN
SetImmortal(_Goblin, _IsImmortal);

// if NoCower flag is already set for some reason, then we store this fact and do not remove it later
PROC
PROC_GOB_DrunkGoblin_FestivitiesGoblins_SaveCoweringState()
AND
DB_GOB_DrunkGoblin_OtherGoblins(_Goblin)
AND
GetFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb, _Goblin, 1)
THEN
DB_GOB_DrunkGoblin_NoCower((CHARACTER)_Goblin);

PROC
PROC_GOB_DrunkGoblin_FestivitiesGoblins_BlockCowering()
AND
DB_GOB_DrunkGoblin_OtherGoblins(_Goblin)
AND
GetFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb, _Goblin, 0)
THEN
SetFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb, _Goblin);

PROC
PROC_GOB_DrunkGoblin_FestivitiesGoblins_RestoreCowering()
AND
DB_GOB_DrunkGoblin_OtherGoblins(_Goblin)
AND
NOT DB_GOB_DrunkGoblin_NoCower(_Goblin)
THEN
ClearFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb, _Goblin);

PROC
PROC_GOB_DrunkGoblin_SetPreventPermaDefeatedAfterKnockOut()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
THEN
DB_PreventKnockedOutPermaDefeated(_Goblin);
DB_DoNotChangeAttitudeAfterCombat(_Goblin);
DB_DontRemoveDialogsOnKnockedOut(_Goblin);

PROC
PROC_GOB_DrunkGoblin_ClearPreventPermaDefeatedAfterKnockOut()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
THEN
NOT DB_PreventKnockedOutPermaDefeated(_Goblin);
NOT DB_DoNotChangeAttitudeAfterCombat(_Goblin);
NOT DB_DontRemoveDialogsOnKnockedOut(_Goblin);

// immediately SetCanJoinCombat back to 0
PROC
PROC_KnockedOut_Ended((CHARACTER)_Goblin)
AND
DB_GOB_DrunkGoblin_Friends(_Goblin)
AND
DB_GOB_DrunkGoblin_FistFightId(_CombatID)
AND
QRY_GLO_IsOrWasInCombat(_Goblin, _CombatID)
THEN
SetCanJoinCombat(_Goblin, 0);
//END_REGION Fight setup helpers

//REGION Fight Interruptions
// if the player that is in Fist Fight with Crusher attacks anyone who is not in the combat - interrupt the scene
IF
AttackedBy(_Goblin, (CHARACTER)_Player, _, _, _, _, _)
AND
DB_Players(_Player)
AND
DB_GLO_DefeatCounter((CHARACTER)_Goblin, "GOB_FestivitiesArea")
AND
DB_GOB_DrunkGoblin_FistFightId(_CombatID)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
NOT DB_Is_InCombat(_Goblin, _CombatID)
AND
NOT QRY_GOB_DrunkGoblin_FleeingFriend(_Goblin)
THEN
PROC_GOB_DrunkGoblin_InterruptScene(_CombatID);

QRY
QRY_GOB_DrunkGoblin_FleeingFriend((CHARACTER)_Goblin)
AND
DB_GOB_DrunkGoblin_Friends(_Goblin)
AND
DB_StoryMoving(_Goblin, _)
THEN
DB_NOOP(1);

PROC
PROC_GOB_DrunkGoblin_InterruptScene((GUIDSTRING)_CombatID)
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
THEN
NOT DB_IgnoreAssault(_Goblin);

PROC
PROC_GOB_DrunkGoblin_InterruptScene((GUIDSTRING)_CombatID)
THEN
PROC_GOB_DrunkGoblin_RestoreFaction();

PROC
PROC_GOB_DrunkGoblin_InterruptScene((GUIDSTRING)_CombatID)
THEN
PROC_GOB_DrunkGoblin_DrunkAndFriends_ClearBlockRegenAfterCombat();
PROC_GOB_DrunkGoblin_DrunkAndFriends_RemoveIgnoreAssault();
PROC_GOB_DrunkGoblin_DrunkAndFriends_SetImmortal(0);
PROC_GOB_DrunkGoblin_FestivitiesGoblins_RestoreCowering();
SysClear("DB_GOB_DrunkGoblin_PlayerInFight", 1);
ClearFlag((FLAG)GOB_DrunkGoblin_Event_FistFight_c1248900-1056-45a8-aabf-2d5eb8a8d3ee, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag((FLAG)GOB_DrunkGoblin_State_GoblinsAreCheering_45ac1c47-bf41-4758-a02b-d5a8702f2919, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GOB_DrunkGoblin_FistFightId(_CombatID);
//END_REGION Fight Interruptions

//REGION End Fight
IF
CombatEnded(_Id)
AND
DB_GOB_DrunkGoblin_FistFightId(_Id)
THEN
ClearFlag((FLAG)GOB_DrunkGoblin_Event_FistFight_c1248900-1056-45a8-aabf-2d5eb8a8d3ee, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_GOB_DrunkGoblin_RemoveHarmfulStatuses();
PROC_GOB_DrunkGoblin_RemoveHarmfulStatusesFromPlayers(_Id);
NOT DB_GOB_DrunkGoblin_FistFightId(_Id);
PROC_GOB_DrunkGoblin_RestoreHitPointsToMinimum();
PROC_GOB_DrunkGoblin_DrunkAndFriends_SetImmortal(0);
PROC_GOB_DrunkGoblin_RestoreFaction();
PROC_GOB_DrunkGoblin_Surrender();
TimerLaunch("GOB_DrunkGoblin_StopCowerTimer", 5000);

PROC
PROC_GOB_DrunkGoblin_RemoveHarmfulStatuses()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
THEN
RemoveSurfaceLayer(_Goblin,"Ground",2.0);
RemoveSurfaceLayer(_Goblin,"Cloud",2.0);
RemoveHarmfulStatuses(_Goblin);
RemoveStatus(_Goblin, "BLEEDING");
RemoveStatus(_Goblin, "BURNING");

// the Drunk Goblin might end the fight and start a dialog while the player characters are affected by negative statuses
// which might lead to their death without the player being able to do anything
PROC
PROC_GOB_DrunkGoblin_RemoveHarmfulStatusesFromPlayers((GUIDSTRING)_CombatId)
AND
DB_Players(_Player)
AND
DB_Was_InCombat(_Player, _CombatId)
THEN
RemoveSurfaceLayer(_Player,"Ground",2.0);
RemoveSurfaceLayer(_Player,"Cloud",2.0);
RemoveHarmfulStatuses(_Player);
RemoveStatus(_Player, "BLEEDING");
RemoveStatus(_Player, "BURNING");
RemoveStatusesWithType(_Player, "DOWNED", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_DrunkGoblin_RestoreHitPointsToMinimum((CHARACTER)_Goblin)
AND
NOT DB_PermaDefeated(_Goblin)
AND
GetHitpoints(_Goblin, _HitPoints)
AND
_HitPoints < 1
THEN
SetHitpoints(_Goblin, 1);

PROC
PROC_GOB_DrunkGoblin_RestoreHitPointsToMinimum()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
THEN
PROC_GOB_DrunkGoblin_RestoreHitPointsToMinimum(_Goblin);

IF
TimerFinished("GOB_DrunkGoblin_StopCowerTimer")
THEN
PROC_GOB_DrunkGoblin_FestivitiesGoblins_RestoreCowering();
PROC_GOB_DrunkGoblin_Friends_RestoreVariablesAfterCombat();
PROC_GOB_DrunkGoblin_ClearPreventPermaDefeatedAfterKnockOut();

//Drunk goblin has low hp -> stop fist fight for everyone
IF
HitpointsChanged(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, _)
AND
GetFlag((FLAG)GOB_DrunkGoblin_Event_FistFight_c1248900-1056-45a8-aabf-2d5eb8a8d3ee, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
QRY_GOB_DrunkGoblin_ShouldStopCombat(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
AND
DB_GOB_DrunkGoblin_FistFightId(_CombatId)
THEN
TimerLaunch("GOB_DrunkGoblin_StopCombat", 1000); // spells like Magic Missile or Scorching Ray cause trouble otherwise

IF
TimerFinished("GOB_DrunkGoblin_StopCombat")
AND
DB_GOB_DrunkGoblin_FistFightId(_CombatId)
AND
DB_GOB_DrunkGoblin_PlayerInFight(_Player)
THEN
PROC_GOB_DrunkGoblin_AllFriends_LeaveCombat();
PROC_SetRelationToPlayers((FACTION)ACT1_GOB_DrunkGoblin_FistFight_381ddd56-5aa8-dd7b-bb2e-b1d1fba64a8f, 50);
NOT DB_IgnoreAssault(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);
DB_GOB_DrunkGoblin_PlayerWon(1);
EndCombat(_CombatId);
PROC_SetRelationToPlayers(ACT1_GOB_DrunkGoblin_FistFight_381ddd56-5aa8-dd7b-bb2e-b1d1fba64a8f,50);

// Drunk's Friend has low hp -> friend leaves fist fight and starts cheering
IF
HitpointsChanged(_Goblin, _)
AND
DB_GOB_DrunkGoblin_Friends((CHARACTER)_Goblin)
AND
GetFlag((FLAG)GOB_DrunkGoblin_Event_FistFight_c1248900-1056-45a8-aabf-2d5eb8a8d3ee, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
QRY_GOB_DrunkGoblin_ShouldStopCombat(_Goblin)
THEN
RealtimeObjectTimerLaunch(_Goblin, "GOB_DrunkGoblin_LeaveCombat", 1000); // otherwise the immortality could be removed too soon, for example when an attack applies a harmful status

IF
ObjectTimerFinished((CHARACTER)_Goblin, "GOB_DrunkGoblin_LeaveCombat")
THEN
PROC_GOB_DrunkGoblin_Friend_LeaveCombat(_Goblin);
PROC_GOB_DrunkGoblin_FriendMoveAway(_Goblin);

QRY
QRY_GOB_DrunkGoblin_ShouldStopCombat((CHARACTER)_Goblin)
AND
GetHitpointsPercentage(_Goblin, _RemainingVitality)
AND
_RemainingVitality < 50
AND
QRY_GOB_DrunkGoblin_AtLeastOnePlayerIsAlive()
THEN
DB_NOOP(1);

// the goblins only surrender if at least one of the players is alive and can fight
QRY
QRY_GOB_DrunkGoblin_AtLeastOnePlayerIsAlive()
AND
DB_GOB_DrunkGoblin_FistFightId(_CombatId)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _CombatId)
AND
NOT DB_Defeated(_Player)
THEN
DB_NOOP(1);

PROC
PROC_GOB_DrunkGoblin_AllFriends_LeaveCombat()
AND
DB_GOB_DrunkGoblin_Friends(_Goblin)
THEN
PROC_GOB_DrunkGoblin_Friend_LeaveCombat(_Goblin);

PROC
PROC_GOB_DrunkGoblin_Friend_LeaveCombat((CHARACTER)_Goblin)
THEN
RemoveSurfaceLayer(_Goblin,"Ground",2.0);
RemoveSurfaceLayer(_Goblin,"Cloud",2.0);
RemoveHarmfulStatuses(_Goblin);
RemoveStatus(_Goblin, "BLEEDING");
RemoveStatus(_Goblin, "BURNING");
SetCanJoinCombat(_Goblin, 0);
LeaveCombat(_Goblin);
SetCombatGroupID(_Goblin,"ccf8718a-6881-7633-35b8-f6feea676347");
PROC_GOB_DrunkGoblin_RestoreHitPointsToMinimum(_Goblin);
RealtimeObjectTimerLaunch(_Goblin, "GOB_DrunkGoblin_RestoreCombat", 6000);

IF
ObjectTimerFinished(_Goblin,"GOB_DrunkGoblin_RestoreCombat")
THEN
SetFaction(_Goblin, (FACTION)ACT1_GOB_FestivitiesAreaGoblins_0e01ffb1-ecd5-834b-edc4-f19a61dcd405);

IF
BaseFactionChanged(_Goblin, (FACTION)ACT1_GOB_DrunkGoblin_FistFight_381ddd56-5aa8-dd7b-bb2e-b1d1fba64a8f, (FACTION)ACT1_GOB_FestivitiesAreaGoblins_0e01ffb1-ecd5-834b-edc4-f19a61dcd405)
THEN
SetImmortal((CHARACTER)_Goblin, 0);
NOT DB_IgnoreAssault(_Goblin);
SetCanJoinCombat(_Goblin, 1);

PROC
PROC_GOB_DrunkGoblin_Friends_RestoreVariablesAfterCombat()
AND
DB_GOB_DrunkGoblin_Friends(_Goblin)
THEN
PROC_SetCanFight(_Goblin, 1);
SetCanJoinCombat(_Goblin, 1);

PROC
PROC_GOB_DrunkGoblin_FriendMoveAway((CHARACTER)_Goblin)
AND
DB_GOB_DrunkGoblin_Friends_EscapeFight(_Goblin, _Point, _AD)
THEN
PROC_TryStartAD(_AD, _Goblin);
PROC_CharacterMoveTo(_Goblin, _Point, "Run", "");

PROC
PROC_GOB_DrunkGoblin_Surrender()
AND
DB_GOB_DrunkGoblin_PlayerWon(1)
AND
DB_GOB_DrunkGoblin_PlayerInFight(_Player)
THEN
QuestUpdate(_Player, "HIDDEN_WLD_Boosters", "GOB_DrunkGoblin_WonDuel");

PROC
PROC_GOB_DrunkGoblin_Surrender()
AND
DB_GOB_DrunkGoblin_PlayerWon(1)
AND
DB_GOB_DrunkGoblin_PlayerInFight(_Player)
AND
NOT QRY_StartDialogCustom_Fixed(GOB_DrunkGoblin_FistFight_c417af76-70b1-2811-8bb6-894c925f5487, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, _Player, 0, 0, 0, 1)
THEN
SetFlag((FLAG)GOB_DrunkGoblin_Quest_GoblinSparedInFight_9d6482a0-69d4-d83a-005e-7a62c302ad46, NULL_00000000-0000-0000-0000-000000000000);
PROC_SetRelationToPlayers(ACT1_GOB_DrunkGoblin_FistFight_381ddd56-5aa8-dd7b-bb2e-b1d1fba64a8f,50);
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay();

PROC
PROC_GOB_DrunkGoblin_Surrender()
AND
NOT DB_GOB_DrunkGoblin_PlayerWon(1)
AND
DB_GOB_DrunkGoblin_PlayerInFight(_Player)
THEN
PROC_SetRelationToPlayers(ACT1_GOB_DrunkGoblin_FistFight_381ddd56-5aa8-dd7b-bb2e-b1d1fba64a8f,50);
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay();

IF
DialogEnded(GOB_DrunkGoblin_FistFight_c417af76-70b1-2811-8bb6-894c925f5487, _DialogueId)
AND
DialogGetInvolvedPlayer(_DialogueId, 1, (CHARACTER)_Player)
AND
GetFlag((FLAG)GOB_DrunkGoblin_Event_Spared_c9e51740-61ac-4ddb-ee56-0f43e2364ff1, _Player, 1)
THEN
SetFlag((FLAG)GOB_DrunkGoblin_Quest_GoblinSparedInFight_9d6482a0-69d4-d83a-005e-7a62c302ad46, NULL_00000000-0000-0000-0000-000000000000);
PROC_SetRelationToPlayers(ACT1_GOB_DrunkGoblin_FistFight_381ddd56-5aa8-dd7b-bb2e-b1d1fba64a8f,50);
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay();

IF
DialogEnded(GOB_DrunkGoblin_FistFight_c417af76-70b1-2811-8bb6-894c925f5487, _DialogueId)
AND
DialogGetInvolvedPlayer(_DialogueId, 1, (CHARACTER)_Player)
AND
GetFlag((FLAG)GOB_DrunkGoblin_Event_NotSpared_28fa7194-84fd-f7b9-188f-471a6217e7ce, _Player, 1)
THEN
SetFlag((FLAG)GOB_DrunkGoblin_Quest_GoblinNotSparedInFight_a74376d9-09e4-4bd8-8884-49ebb72d7c3e, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_MakeFestivitiesAreaHostile();

IF
EnteredCombat(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, _CombatId)
AND
GetFlag((FLAG)GOB_DrunkGoblin_Event_FistFight_c1248900-1056-45a8-aabf-2d5eb8a8d3ee, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
DB_GOB_DrunkGoblin_FistFightId(_CombatId);
//END_REGION End Fight

//REGION Knocking out
PROC
PROC_KnockedOut(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, (GUIDSTRING)_Cause)
AND
DB_GOB_DrunkGoblin_FistFightId(_Id)
THEN
SetFlag((FLAG)GOB_DrunkGoblin_Quest_GoblinSparedInFight_9d6482a0-69d4-d83a-005e-7a62c302ad46, NULL_00000000-0000-0000-0000-000000000000);
DB_GOB_DrunkGoblin_WasKnockedOut(1);
EndCombat(_Id);

// After the KNOCKED OUT status is removed the generic scripting restores HasDialog property, we should disable it again
// the player shouldn't be able to start the dialog before Crusher reaches his new position
PROC
PROC_KnockedOut_Ended((CHARACTER)S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
AND
DB_GOB_DrunkGoblin_WasKnockedOut(1)
THEN
NOT DB_GOB_DrunkGoblin_WasKnockedOut(1);
SetHasDialog(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 0);
//END_REGION Knocking out

//REGION Move to the secluded point
IF
DialogEnded(GOB_DrunkGoblin_48cdc0fd-1ed7-202b-e84c-8874d50d0800, _Id)
AND
QRY_GOB_DrunkGoblin_CheckAndClearFlag(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86,(FLAG)GOB_DrunkGoblin_Event_MoveToSecludedPlace_e0a9dff2-0eba-587f-c301-1c600ce0adf3)
THEN
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay();

PROC
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay()
THEN
SetCombatGroupID(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, "");
PROC_SelfHealing_Enable(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);
SetEntityEvent(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, "GOB_DrunkGoblin_StartedComplaining");
SetEntityEvent(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, "ClearPeaceReturn", 1);
PROC_RemoveAllDialogEntriesForSpeaker(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);
DB_Dialogs(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, GOB_DrunkGoblin_AtSecludedPlace_bed9f590-ac9f-92ae-3754-9065fcec8a3c);
SetHasDialog(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 0);
TimerLaunch("GOB_DrunkGoblin_MoveAwayDelay", 3000);

PROC
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay()
AND
DB_GOB_DrunkGoblin_Friends(_Friend)
AND
NOT DB_PermaDefeated(_Friend)
THEN
LookAtEntity(_Friend, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);

IF
TimerFinished("GOB_DrunkGoblin_MoveAwayDelay")
THEN
ClearFlag(GOB_DrunkGoblin_State_GoblinsAreCheering_45ac1c47-bf41-4758-a02b-d5a8702f2919, NULL_00000000-0000-0000-0000-000000000000);

IF
TimerFinished("GOB_DrunkGoblin_MoveAwayDelay")
THEN
PROC_TryStartAD(GOB_DrunkGoblin_AD_MovingAway_e511cdf2-7c7c-bf6f-9270-4010438644b9, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);

IF
AutomatedDialogEnded(GOB_DrunkGoblin_AD_MovingAway_e511cdf2-7c7c-bf6f-9270-4010438644b9, _Id)
THEN
PROC_GOB_DrunkGoblin_MoveToSecludedPlace();

IF
AutomatedDialogRequestFailed(GOB_DrunkGoblin_AD_MovingAway_e511cdf2-7c7c-bf6f-9270-4010438644b9, _Id)
THEN
PROC_GOB_DrunkGoblin_MoveToSecludedPlace();

PROC
PROC_GOB_DrunkGoblin_MoveToSecludedPlace()
THEN
PROC_CharacterMoveTo(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, TRIGGERGUID_S_GOB_DrunkGolbin_SecludedPoint_9104e831-9cd9-4066-9cad-61bf2dfef092, "Walk", "GOB_DrunkGoblin_MovedToSecludedPoint");
PROC_DrunkGoblin_SendDrunkGoblinFriendsToTables();

// if the Drunk Goblin is already moving to the secluded spot, but before he leaves the festivities area the goblins
// register Poisoning he goes back to his position (which is his battle station at the same time)
IF
FlagSet(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_Dialogs(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, GOB_DrunkGoblin_AtSecludedPlace_bed9f590-ac9f-92ae-3754-9065fcec8a3c)
AND
IsInTrigger(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, S_GOB_Festivities_BingeArea_f4a4031d-7e0c-45b8-970b-47c62d4908d8, 1)
THEN
TimerCancel("GOB_DrunkGoblin_MoveAwayDelay");
PROC_ClearStoryMove(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);
PROC_CharacterMoveTo(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, S_GOB_GoblinToast_BattlePosition_Crusher_1d5ebd49-a00a-449f-afb8-89d7fc492330, "Run", "GOB_DrunkGoblin_AtBattlePosition");

IF
EntityEvent(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, "GOB_DrunkGoblin_AtBattlePosition")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);
DB_Dialogs(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, GOB_DrunkGoblin_48cdc0fd-1ed7-202b-e84c-8874d50d0800);
SetHasDialog(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 1);
LookFromTrigger(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, S_GOB_GoblinToast_BattlePosition_Crusher_1d5ebd49-a00a-449f-afb8-89d7fc492330, 0);

IF
EntityEvent(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, "GOB_DrunkGoblin_MovedToSecludedPoint")
THEN
NOT DB_GLO_DefeatCounter(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, "GOB_FestivitiesArea");
SetHasDialog(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 1);
SetFlag((FLAG)GOB_DrunkGoblin_Event_AtSecludedPlace_74094fe2-812d-4ffe-ea07-1495a03b7c2e, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);
LookFromTrigger(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, TRIGGERGUID_S_GOB_DrunkGolbin_SecludedPoint_9104e831-9cd9-4066-9cad-61bf2dfef092, 1);
//END_REGION Move to the secluded point

//REGION Ring
IF
FlagSet(GOB_DrunkGoblin_Event_RingStolen_78805014-8f74-a0ef-9a4b-2f608e31e4e7, (CHARACTER)_Player, _)
AND
DB_Players(_Player)
THEN
DB_GOB_StoleDrunkenGoblinRingInDialog(_Player);
Unequip((CHARACTER)S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86,(ITEM)S_GOB_DrunkGoblin_Ring_91c90b8b-59d5-4a89-bb68-0ac465a707a3);

IF
Unequipped((ITEM)S_GOB_DrunkGoblin_Ring_91c90b8b-59d5-4a89-bb68-0ac465a707a3,(CHARACTER)S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
AND
DB_GOB_StoleDrunkenGoblinRingInDialog(_Player)
THEN
ToInventory(S_GOB_DrunkGoblin_Ring_91c90b8b-59d5-4a89-bb68-0ac465a707a3, _Player, 1, 1, 1);
NOT DB_GOB_StoleDrunkenGoblinRingInDialog(_Player);

PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Player, GOB_DrunkGoblin_Event_RingStolen_78805014-8f74-a0ef-9a4b-2f608e31e4e7)
THEN
QuestUpdate(_Player, "HIDDEN_WLD_Boosters", "GOB_DrunkGoblin_StoleRing");
//END_REGION Ring

//REGION Shared Flags among Goblins
IF
FlagSet((FLAG)_SharedFlag, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, _)
AND
DB_GOB_DrunkGoblin_GoblinSharedFlags((FLAG)_SharedFlag)
AND
DB_GOB_DrunkGoblin_Friends(_Friend)
THEN
SetFlag((FLAG)_SharedFlag, _Friend);
//END_REGION Shared Flags among Goblins

//REGION Behaviour management
PROC
PROC_DrunkGoblin_SendDrunkGoblinFriendsToTables()
THEN
ClearFlag((FLAG)GOB_DrunkGoblin_State_TellingStories_f4ebead3-02c8-5681-79b7-b31b80fc9d6a, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
ClearFlag((FLAG)GOB_DrunkGoblin_State_TellingStories_f4ebead3-02c8-5681-79b7-b31b80fc9d6a, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_PermaDefeated(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
THEN
ClearFlag((FLAG)GOB_DrunkGoblin_State_TellingStories_f4ebead3-02c8-5681-79b7-b31b80fc9d6a, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_DrunkGoblin_SendDrunkGoblinFriendsToTables()
AND
DB_GOB_DrunkGoblin_Friends(_Goblin)
AND
GetFlag(GOB_DrunkGoblin_Mourning_07bffc4e-cdb6-4bf6-ac5f-55ae1688d419,_Goblin,0)
THEN
DB_GOB_GoblinToast_ToastParticipants(_Goblin);

PROC
PROC_DrunkGoblin_SendDrunkGoblinFriendsToTables()
THEN
DB_GOB_GoblinToast_GoblinsToPoison(S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee, 11000);
//END_REGION Behaviour management

//REGION Drunk Goblin dies
IF
DB_Dead(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
AND
DB_GOB_DrunkGoblin_Friends(_Friend)
AND
CanSee(_Friend, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 1)
AND
GetFlag(GOB_DrunkGoblin_Knows_Dead_ed00186e-0f4e-4aeb-90e9-01ffb404b7ff, _Friend, 0)
THEN
SetFlag(GOB_DrunkGoblin_Knows_Dead_ed00186e-0f4e-4aeb-90e9-01ffb404b7ff, _Friend);

IF
Saw(_Friend, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, _)
AND
DB_GOB_DrunkGoblin_Friends(_Friend)
AND
DB_Dead(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
AND
GetFlag(GOB_DrunkGoblin_Knows_Dead_ed00186e-0f4e-4aeb-90e9-01ffb404b7ff, _Friend, 0)
THEN
SetFlag(GOB_DrunkGoblin_Knows_Dead_ed00186e-0f4e-4aeb-90e9-01ffb404b7ff, _Friend);

IF
FlagSet(GOB_DrunkGoblin_Knows_Dead_ed00186e-0f4e-4aeb-90e9-01ffb404b7ff, (CHARACTER)_Friend, _)
AND
DB_GOB_DrunkGoblin_DeadReactions(_Friend, _Dialog)
AND
NOT DB_Is_InCombat(_Friend, _)
THEN
PROC_ForceStopDialog(_Friend);
LookAtEntity(_Friend, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);
PROC_TryStartAD(_Dialog, _Friend);
//END_REGION Drunk Goblin dies

//REGION Reactions
PROC
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay()
AND
GetFlag(GOB_DrunkGoblin_Event_Mocked_a9d88205-e99e-8c95-4270-2617a38291e5, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 1)
AND
DB_GOB_DrunkGoblin_GoblinMockedReactions(_Goblin, _Dialog, _Delay)
AND
NOT DB_PermaDefeated(_Goblin)
THEN
DB_GOB_DrunkGoblin_DelayedReaction((CHARACTER)_Goblin, (DIALOGRESOURCE)_Dialog);
RealtimeObjectTimerLaunch(_Goblin, "GOB_DrunkGoblin_DelayedReaction", _Delay);

PROC
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay()
AND
GetFlag(GOB_DrunkGoblin_Event_Mocked_a9d88205-e99e-8c95-4270-2617a38291e5, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 0)
AND
GetFlag(GOB_DrunkGoblin_Quest_GoblinSparedInFight_9d6482a0-69d4-d83a-005e-7a62c302ad46, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_GOB_DrunkGoblin_GoblinSparedReactions(_Goblin, _Dialog, _Delay)
AND
NOT DB_PermaDefeated(_Goblin)
THEN
DB_GOB_DrunkGoblin_DelayedReaction((CHARACTER)_Goblin, (DIALOGRESOURCE)_Dialog);
RealtimeObjectTimerLaunch(_Goblin, "GOB_DrunkGoblin_DelayedReaction", _Delay);

PROC
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay()
AND
GetFlag(GOB_DrunkGoblin_Event_Mocked_a9d88205-e99e-8c95-4270-2617a38291e5, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 0)
AND
GetFlag(GOB_DrunkGoblin_Quest_GoblinSparedInFight_9d6482a0-69d4-d83a-005e-7a62c302ad46, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
GetFlag(GOB_DrunkGoblin_Event_KissedFeet_d252b771-2479-fb5d-4de0-20f97c375cc1, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 1)
AND
DB_GOB_DrunkGoblin_PlayerKissedFootReactions(_Goblin, _Dialog, _Delay)
AND
NOT DB_PermaDefeated(_Goblin)
THEN
DB_GOB_DrunkGoblin_DelayedReaction((CHARACTER)_Goblin, (DIALOGRESOURCE)_Dialog);
RealtimeObjectTimerLaunch(_Goblin, "GOB_DrunkGoblin_DelayedReaction", _Delay);

IF
ObjectTimerFinished((CHARACTER)_Goblin, "GOB_DrunkGoblin_DelayedReaction")
AND
DB_GOB_DrunkGoblin_DelayedReaction(_Goblin, _Dialog)
THEN
PROC_TryStartAD(_Dialog, _Goblin);
NOT DB_GOB_DrunkGoblin_DelayedReaction(_Goblin, _Dialog);

//END_REGION Reactions

//REGION Disabling crime for the friends of the Drunk Goblin
IF
FlagSet(GOB_Checkpoint_Quest_UsedPsionics_8f8ffbd0-b3ee-1ddf-a573-712664cd386a, _, _)
AND
DB_GOB_DrunkGoblin_Friends(_Friend)
THEN
PROC_CharacterDisableCrime(_Friend, "GOB_Festivities_Poisoning");
//END_REGION Disabling crime for the friends of the Drunk Goblin

//REGION Inclusion of Crusher friends
QRY
QRY_SelectCustomDialog_AfterGenerics(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, _Player)
AND
GetFlag(GOB_DrunkGoblin_Event_AtSecludedPlace_74094fe2-812d-4ffe-ea07-1495a03b7c2e, S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 0)
AND
GetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
PROC_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_Player);

PROC
PROC_GOB_DrunkGoblin_SelectAvailableForDialogFriends((GUIDSTRING)_Player)
THEN
SysClear("DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends",3);
DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_DrunkGoblin_SelectAvailableForDialogFriends((GUIDSTRING)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee)
AND
DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_F1, _F2, _F3)
THEN
NOT DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_F1, _F2, _F3);
DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee, _F2, _F3);

PROC
PROC_GOB_DrunkGoblin_SelectAvailableForDialogFriends((GUIDSTRING)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269)
AND
DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_F1, _F2, _F3)
THEN
NOT DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_F1, _F2, _F3);
DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_F1, S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269, _F3);

PROC
PROC_GOB_DrunkGoblin_SelectAvailableForDialogFriends((GUIDSTRING)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c)
AND
DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_F1, _F2, _F3)
THEN
NOT DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_F1, _F2, _F3);
DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_F1, _F2, S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c);

PROC
PROC_GOB_DrunkGoblin_SelectAvailableForDialogFriends((GUIDSTRING)_Player)
AND
DB_GOB_DrunkGoblin_SelectAvailableForDialogFriends(_F1, _F2, _F3)
THEN
DB_SelectedDialog(GOB_DrunkGoblin_48cdc0fd-1ed7-202b-e84c-8874d50d0800,S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86,_F1,_F2,_F3,_Player);
//END_REGION Inclusion of Crusher friends
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
