Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_ItemOwnerShipTriggers("WLD_Main_A", S_GOB_TablesArea_OwnershipTigger_76833627-48b3-4ab8-8cc3-780f170acc31, S_GOB_RoastingDwarfOperator_001_3837d519-dc92-459c-ab2d-1eac0b208fc7);

DB_GOB_Festivities_NpcTeleportationForbiddenRegions((TRIGGER)S_GOB_Festivities_BingeArea_f4a4031d-7e0c-45b8-970b-47c62d4908d8);

DB_GOB_Festivities_NpcTeleportationOnLeavingRegions((TRIGGER)S_GOB_ThroneRoom_SUB_bb81678b-641c-43fc-bd41-53295d59be03);
DB_GOB_Festivities_NpcTeleportationOnLeavingRegions(S_GOB_CampFirstHalfArea_d98ba3fa-743e-4d0e-98d8-2b3f79c17647);

DB_GOB_Festivities_BehaviourFlags((FLAG)GOB_Festivities_Behaviour_CheckRoastedDwarf_ad79f5ab-8de3-43e3-b51c-7f52426932d5);
DB_GOB_Festivities_BehaviourFlags(GOB_Festivities_Behaviour_Refill_b24b9209-3020-4992-9616-a3bfb405f960);
DB_GOB_Festivities_BehaviourFlags(GOB_Festivities_Behaviour_Piss_302cb878-cc90-4a90-8ae2-04e17aef25c5);
DB_GOB_Festivities_BehaviourFlags(GOB_Festivities_Behaviour_Graffiti_24b1e6d5-5540-43e4-8440-acf9b297fa72);

DB_OneShotPlayerTrigger(S_GOB_Festivities_AstarionShadowHeartBanterActivationTrigger_862ba502-c279-4e24-bbcb-aae9daedf6bd);

DB_Dialogs(S_GOB_Festivities_Ogre_00_ffe2ab58-fddc-47ce-b369-bdb93b4a52dd,GOB_Festivities_Ogre_00_85c9c1ec-c771-a29b-e05f-0ddec493ab76);
DB_Dialogs(S_GOB_Festivities_Bugbear_Wanderer_c45936ea-2e38-4cf5-b5e1-1ff382888737,GOB_Festivities_Bugbear_Wanderer_adbb6fe6-53e9-9a74-70a2-2ba256b6ab6d);
/*
//Goblins 001, 002, 003 should be at the same table. Goblins 004 & 005 also should be at the same table
DB_GOB_Festivities_SaloonTables_Assigned((TRIGGER)S_GOB_Festivities_TableTrigger_000_81c40abd-0ff6-4402-88d2-d2f21b5537db, (CHARACTER)S_GOB_Festivities_Goblin_000_031e9fb7-136a-46c7-91d7-77ce3e20236a);
DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_Festivities_TableTrigger_001_7a62549e-0b90-4d4c-bb17-7925caba984c, S_GOB_Festivities_Goblin_001_774c78ed-1227-48f9-812e-aac0021c71bf);
DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_Festivities_TableTrigger_002_22b1285d-001a-4ba8-b6ee-724f481cb2d0, S_GOB_Festivities_Goblin_002_bb9c82a2-7ed9-45ed-99b6-58f84520fb8c);
DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_Festivities_TableTrigger_003_904ae0ca-25d5-4e4d-82a0-c33c73c11e62, S_GOB_Festivities_Goblin_003_0296a9f6-b2bc-46a0-8632-ba72679a36d3);
DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_Festivities_TableTrigger_004_98a91f82-4840-42ed-bdcd-5c43e6dc6dcd, S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748);
DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_Festivities_TableTrigger_005_b8ee800b-dc6f-4fbf-b85b-d4404c2f5841, S_GOB_Festivities_Goblin_005_a955aea9-9040-4d4c-9264-e46e385dea94);
DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_Festivities_TableTrigger_006_66855103-b007-46a6-9249-928e4a2b3719, S_GOB_Festivities_Goblin_006_f3f416d1-b946-4019-95ba-7053f63dd776);
DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_Festivities_TableTrigger_007_5d5c2faf-cb30-49cc-96f6-743423380d13, S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0);

DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_Festivities_TableTrigger_Commentator_e5775bee-7cce-47d5-a894-74fad0931867, S_GOB_ChickenChase_Commentator_eb2c434d-1833-485e-bca2-f181eed6010b);
DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_DwarfOperator_IdlePoint_000_6a41e179-7a04-4a19-bf7c-413ed7dac5e0, S_GOB_RoastingDwarfOperator_000_1fe911f8-c9c9-4405-83fa-d343d59c7be9);
DB_GOB_Festivities_SaloonTables_Assigned(S_GOB_DwarfOperator_IdlePoint_001_fd90a3f9-38f4-43e2-89a4-7cac955af6f3, S_GOB_RoastingDwarfOperator_001_3837d519-dc92-459c-ab2d-1eac0b208fc7);

// Tables reserved for Drunk friends
DB_GOB_Festivities_SaloonTables_Reserved((CHARACTER)S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee,(TRIGGER)S_GOB_Festivities_TableTrigger_008_8b4daef8-4583-4f37-affe-cac1105fae02);
DB_GOB_Festivities_SaloonTables_Reserved(S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269,S_GOB_Festivities_TableTrigger_009_0dd3784b-d304-49ff-9a89-bbd817393e73);
DB_GOB_Festivities_SaloonTables_Reserved(S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c,S_GOB_Festivities_TableTrigger_010_adc5a879-a707-45c7-af79-cf68bc38b6fe);
*/

//REGION Trader
DB_Dialogs((CHARACTER)S_GOB_Festivities_Trader_3c9f9d17-835c-46bf-929d-240e3b4adb55, GOB_Festivities_Trader_baaf58f0-558d-7a40-9eaf-639b8bc6fddb);
DB_ItemOwnerShipTriggers("WLD_Main_A", (TRIGGER)S_GOB_Festivities_Trader_OwnershipTrigger_9a09e415-6b33-4443-94e5-8a592618d9b7, (CHARACTER)S_GOB_Festivities_Trader_3c9f9d17-835c-46bf-929d-240e3b4adb55);
DB_ItemShopTrigger((TRIGGER)S_GOB_Festivities_Trader_OwnershipTrigger_9a09e415-6b33-4443-94e5-8a592618d9b7, (CHARACTER)S_GOB_Festivities_Trader_3c9f9d17-835c-46bf-929d-240e3b4adb55);
//END_REGION

PROC_TriggerRegisterForPlayers(S_GOB_HalsinQuest_RD_Trigger_da19d795-0d66-4aa9-bd31-0f4205cd50c1);

// Combat NPC Reactivity
DB_CombatReact_AD_OnNextTurn(S_GOB_Festivities_Ogre_00_ffe2ab58-fddc-47ce-b369-bdb93b4a52dd, (DIALOGRESOURCE)GOB_Festivities_AD_Ogre_00_Combat_1c8d7a06-88ff-9341-3244-b70d1dba5d20);
DB_CombatReact_AD_OnNextTurn(S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0, (DIALOGRESOURCE)GOB_Festivities_AD_Goblin_007_Combat_668ebdda-7e7b-aeac-fbc0-7e465c871b40);
DB_CombatReact_AD_OnNextTurn(S_GOB_Festivities_Goblin_002_bb9c82a2-7ed9-45ed-99b6-58f84520fb8c, (DIALOGRESOURCE)GOB_Festivities_AD_Goblin_002_Combat_186d8263-5681-e893-6fce-dc8bd196edee);
DB_CombatReact_AD_OnNextTurn(S_GOB_Festivities_Goblin_001_774c78ed-1227-48f9-812e-aac0021c71bf, (DIALOGRESOURCE)GOB_Festivities_AD_Goblin_001_Combat_0c60008d-e565-b07d-13fc-0276737a6ecd);
DB_CombatReact_AD_OnNextTurn(S_GOB_Festivities_Goblin_000_031e9fb7-136a-46c7-91d7-77ce3e20236a, (DIALOGRESOURCE)GOB_Festivities_AD_Goblin_000_Combat_7a07a9b7-839b-6503-aaa8-38eec993704d);
KBSECTION
//REGION Debug
IF
TextEvent("gob_resetbeh")
AND
DB_GOB_Festivities_BehaviourFlags(_Flag)
THEN
ClearFlag(_Flag, S_GOB_Festivities_Goblin_000_031e9fb7-136a-46c7-91d7-77ce3e20236a);
ClearFlag(_Flag, S_GOB_Festivities_Goblin_001_774c78ed-1227-48f9-812e-aac0021c71bf);
ClearFlag(_Flag, S_GOB_Festivities_Goblin_002_bb9c82a2-7ed9-45ed-99b6-58f84520fb8c);
ClearFlag(_Flag, S_GOB_Festivities_Goblin_003_0296a9f6-b2bc-46a0-8632-ba72679a36d3);
ClearFlag(_Flag, S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748);
ClearFlag(_Flag, S_GOB_Festivities_Goblin_005_a955aea9-9040-4d4c-9264-e46e385dea94);
ClearFlag(_Flag, S_GOB_Festivities_Goblin_006_f3f416d1-b946-4019-95ba-7053f63dd776);
ClearFlag(_Flag, S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0);
//END_REGION Debug

//REGION Check if NPC can be teleported to festivities area
// Used to teleport Volo and owlbear cub to the festivities area
IF
DB_GOB_Festivities_NpcTeleportationForbiddenRegions(_Region)
THEN
PROC_TriggerRegisterForPlayers(_Region);

IF
DB_GOB_Festivities_NpcTeleportationOnLeavingRegions(_Region)
THEN
PROC_TriggerRegisterForPlayers(_Region);

PROC
PROC_GOB_Festivities_TeleportNPCToFestivities((CHARACTER)_Npc, (STRING)_Event, (TRIGGER)_Point)
THEN
DB_GOB_Festivities_TeleportNpcEvent((CHARACTER)_Npc, (STRING)_Event, (TRIGGER)_Point);
PROC_GOB_Festivities_TryTeleportNpcToCampIfPermitted(_Npc);

IF
TeleportToWaypoint(_Player, S_GOB_WaypointTrigger_3b1b1ab2-1962-47cc-8e25-5cfde2a6c32f)
AND
DB_GOB_Festivities_TeleportNpcEvent((CHARACTER)_Npc, (STRING)_Event, (TRIGGER)_Point)
THEN
PROC_GOB_Festivities_TryTeleportNpcToCampIfPermitted(_Npc);

IF
LeftTrigger(_Player, _Trigger)
AND
DB_Players(_Player)
AND
DB_GOB_Festivities_NpcTeleportationOnLeavingRegions(_Trigger)
AND
DB_GOB_Festivities_TeleportNpcEvent((CHARACTER)_Npc, _, _)
THEN
PROC_GOB_Festivities_TryTeleportNpcToCampIfPermitted(_Npc);

PROC
PROC_GOB_Festivities_TryTeleportNpcToCampIfPermitted((CHARACTER)_Npc)
AND
NOT QRY_GOB_Festivities_NpcTeleportationIsForbidden((CHARACTER)_Npc)
THEN
PROC_GOB_Festivities_TeleportNpcToCamp((CHARACTER)_Npc);


PROC
PROC_GOB_Festivities_TeleportNpcToCamp((CHARACTER)_Npc)
AND
DB_GOB_Festivities_TeleportNpcEvent((CHARACTER)_Npc, (STRING)_Event, (TRIGGER)_Point)
THEN
AppearAt(_Npc, _Point, 0, NULL_00000000-0000-0000-0000-000000000000, _Event);
NOT DB_GOB_Festivities_TeleportNpcEvent(_Npc, _Event, _Point);

QRY
QRY_GOB_Festivities_NpcTeleportationIsForbidden((CHARACTER)_Npc)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GOB_Festivities_NpcTeleportationForbiddenRegions(_Trigger)
AND
IsInTrigger(_Player, _Trigger, 1)
THEN
DB_NOOP(1);

QRY
QRY_GOB_Festivities_NpcTeleportationIsForbidden((CHARACTER)_Npc)
AND
DB_Players(_Player)
AND
DB_Sees(_Player, _Npc)
THEN
DB_NOOP(1);

//END_REGION

//REGION Festiv behaviour flags
IF
FlagSet(_Flag,_Goblin,_DlgInst)
AND
DB_GOB_Festivities_BehaviourFlags(_Flag)
THEN
SetFlag(GOB_Festivities_Behaviour_Absent_ed2fbbf4-42b3-4845-865d-39827dedb503,_Goblin,_DlgInst);

IF
FlagCleared(_Flag,_Goblin,_DlgInst)
AND
DB_GOB_Festivities_BehaviourFlags(_Flag)
AND
NOT QRY_GOB_Festivities_HasAnyOfBehaviourFlags((CHARACTER)_Goblin)
THEN
ClearFlag(GOB_Festivities_Behaviour_Absent_ed2fbbf4-42b3-4845-865d-39827dedb503,_Goblin,_DlgInst);

IF
FlagCleared(_Flag, _, _)
AND
DB_GOB_Festivities_BehaviourFlags(_Flag)
THEN
SetEntityEventGuid(S_GOB_Festivities_Coordinator_f2cd133a-8339-4043-9277-e5dd8fe93e5f, "GOB_Coordinator_BehaviourFlagCleared", _Flag, 1);

QRY
QRY_GOB_Festivities_HasAnyOfBehaviourFlags((CHARACTER)_Goblin)
AND
DB_GOB_Festivities_BehaviourFlags(_Flag)
AND
GetFlag(_Flag,_Goblin,1)
THEN
DB_NOOP(1);
//END_REGION Festiv behaviour flags

//REGION Fulfilling the condition for Astarion - Shadowheart Banter
PROC
PROC_OneShotTriggerEntered(_Player, S_GOB_Festivities_AstarionShadowHeartBanterActivationTrigger_862ba502-c279-4e24-bbcb-aae9daedf6bd)
THEN
SetFlag(GOB_Festivities_State_Observed_d7e0190c-ff9f-46fb-a8b2-36b411c56822, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION


//REGION Halsin Quest VB
IF
EnteredTrigger(_Player,S_GOB_HalsinQuest_RD_Trigger_da19d795-0d66-4aa9-bd31-0f4205cd50c1)
AND
DB_Players(_Player)
AND
QuestIsAccepted(_Player,"GLO_Tadpole_SUB_Druid",1)
AND
GetFlag(GLO_Halsin_Knows_WentWithAdventurers_76537faa-016f-f6a9-8136-b236fbefd2e1,NULL_00000000-0000-0000-0000-000000000000,1)
AND
GetFlag(GLO_Halsin_Knows_IsFound_a0d83476-e2d0-4972-a76b-b23c39078cd7,NULL_00000000-0000-0000-0000-000000000000,0)
AND
QRY_OnlyOnce("GOB_HalsinQuest_VB_Trigger")
THEN
StartVoiceBark((VOICEBARKRESOURCE)GOB_Halsin_VB_EnteringGoblinCamp_465f0720-5a44-6200-5627-7ab86e908e3f, _Player);
PROC_TriggerUnregisterForPlayers(S_GOB_HalsinQuest_RD_Trigger_da19d795-0d66-4aa9-bd31-0f4205cd50c1);

IF
QuestClosed("GLO_Tadpole_SUB_Druid")
THEN
PROC_TriggerUnregisterForPlayers(S_GOB_HalsinQuest_RD_Trigger_da19d795-0d66-4aa9-bd31-0f4205cd50c1);
//END_REGION Halsin Quest RD

//REGION Disable looking at each other for a specific AD
IF
FlagSet((FLAG)GOB_VoloBallad_State_OnStage_0bc1d7d7-9129-4c6e-188d-054640cea3b9, _, _)
THEN
DB_DoNotFaceDialog(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, (DIALOGRESOURCE)GOB_Festivities_AD_Table1_f2300bf3-81e3-ffae-70ee-5a08f52884e0);
DB_DoNotFaceDialog(S_GOB_Festivities_Goblin_005_a955aea9-9040-4d4c-9264-e46e385dea94, (DIALOGRESOURCE)GOB_Festivities_AD_Table1_f2300bf3-81e3-ffae-70ee-5a08f52884e0);

IF
FlagCleared((FLAG)GOB_VoloBallad_State_OnStage_0bc1d7d7-9129-4c6e-188d-054640cea3b9, _, _)
THEN
NOT DB_DoNotFaceDialog(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, (DIALOGRESOURCE)GOB_Festivities_AD_Table1_f2300bf3-81e3-ffae-70ee-5a08f52884e0);
NOT DB_DoNotFaceDialog(S_GOB_Festivities_Goblin_005_a955aea9-9040-4d4c-9264-e46e385dea94, (DIALOGRESOURCE)GOB_Festivities_AD_Table1_f2300bf3-81e3-ffae-70ee-5a08f52884e0);
//END_REGON
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
