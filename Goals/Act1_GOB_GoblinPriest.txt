Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, DIALOGRESOURCEGUID_GOB_GoblinPriest_ca566e7f-421a-61cb-04e0-04e30855d376);
DB_Dialogs(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,GOB_GoblinPriestOgre_4fe7a074-3c8a-884f-eec3-2a6ab7d02c19);
DB_GLO_CharacterCorpseDialog(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,(DIALOGRESOURCE)GOB_GoblinPriest_Dead_0828b81f-6790-d49a-c496-c7833f68641d);

DB_HasItemEvent(S_GOB_GoblinPriest_SleepPotion_ac533c0a-c664-40bb-9cd9-ed4b07a6deb6,GOB_GoblinPriest_HasSleepPotion_fdf20a6f-06a9-4d80-82cd-d375ba1b3633);
DB_HasItemEvent(S_GOB_PriestDungeon_ChainsKey_62dda6b7-2992-488b-8ae7-07b82750e0cf,(FLAG)GOB_GoblinPriest_HasChainsKey_541cbd9f-c261-4887-9e02-fe7723d0751d);

DB_OneShot_VoiceBarkTrigger(S_GOB_GoblinPriest_BrandingVB_fb74eb0b-49b1-4fb1-aed6-d747e658b7f8,GOB_GoblinPriest_VB_Branding_e67f6ade-f475-46bd-ae8a-b0d14a285948);

DB_GOB_GoblinPriest_Minions((CHARACTER)S_GOB_GoblinLush_d738c9a4-a031-4dd9-912f-93cda8d8d8b7);
DB_GOB_GoblinPriest_Minions(S_GOB_GoblinJolly_59557329-d49b-448b-bdd0-fd66ae0d67f6);
DB_GOB_GoblinPriest_Minions(S_GOB_GoblinGlib_f63f921c-ae35-4574-9a70-30aee55fdb26);
DB_GOB_GoblinPriest_Minions(S_GOB_GoblinBrash_35ffa172-7f23-4452-8f90-5dc24fd3bb6d);
DB_GOB_GoblinPriest_Minions(S_GOB_GoblinWily_d8667091-dd64-499c-8bee-000cf42175fc);
DB_GOB_GoblinPriest_Minions(S_GOB_GoblinSulky_dd21e1d9-c426-4b12-b5a0-ef3445e9e967);

PROC_TriggerRegisterForPlayers(S_GOB_GoblinPriest_ChainedBox_000_d9f4a96e-5f45-462e-b2b5-8b7680135036);

DB_FlagReactionAfterDialog((FLAG)GOB_GoblinPriest_Event_BreakChains_871ecada-cdde-beff-3be5-5875529bdaab, (DIALOGRESOURCE)GOB_GoblinPriest_ChainedCharacter_eecd9977-8ba4-b993-0c0a-066123f79b24);

PROC_TriggerRegisterForPlayers(S_GOB_OgreSpotTrigger_229f5142-3180-4518-9f23-a61f81b1c177);
TriggerRegisterForCharacter(S_GOB_OgreSpotTrigger_229f5142-3180-4518-9f23-a61f81b1c177, S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511);

SetFlag((FLAG)GOB_GoblinPriest_Event_Branding_bd95af19-d8cc-7311-06a8-4e7ed4aa633e, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9); // flagType: Object
SetEntityEvent(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, "GOB_GoblinPriest_Event_Branding",1);

DB_TrespassTrigger((TRIGGER)S_GOB_GoblinPriest_OgreTrespassTrigger_e8629a34-2111-4b7d-b50a-13044c445b4a,S_GOB_GoblinPriest_OutDungeonTrigger_58c346df-0c41-48df-9edb-cdba1b67dc4c);
DB_ItemOwnerShipTriggers("WLD_Main_A",S_GOB_GoblinPriest_DungeonOwnershipTrigger_1c35651c-024f-4ad0-bc06-e9b4b012bc76,S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
DB_ItemOwnerShipTriggers("WLD_Main_A",S_GOB_GoblinPriest_ChapelOwnershipTrigger_0fb0d990-5015-463f-9256-9b53b5102c87, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
DB_ItemOwnerShipTriggersFallback(S_GOB_GoblinPriest_DungeonOwnershipTrigger_1c35651c-024f-4ad0-bc06-e9b4b012bc76,S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511);

DB_NoLowAttitudeDialog((CHARACTER)S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511);
DB_DialogBlockTradeButton((DIALOGRESOURCE)GOB_GoblinPriest_ChainedCharacter_eecd9977-8ba4-b993-0c0a-066123f79b24);
DB_DialogBlockAttackButton((DIALOGRESOURCE)GOB_GoblinPriest_ChainedCharacter_eecd9977-8ba4-b993-0c0a-066123f79b24);
DB_DialogBlockTradeButton((DIALOGRESOURCE)GOB_GoblinPriest_Cellar_0b1cbf40-3e14-d0d7-42d7-2c9707144573);

DB_GOB_GoblinPriest_StatueInUse((ITEM)S_GoblinPriestess_Statue_01_dc68d2e5-b526-424b-ad9a-316238a75f65, (TRIGGER)S_GoblinPriestess_StatueDamageBox_01_ba77a85b-d404-42c3-b1c0-269349e515bd, (ITEM)S_GoblinPriestess_InvisHelper_01_a26bc70c-8b80-4e0f-95be-de7962f51a54, "GOB_GoblinPriest_Statue_01");
DB_GOB_GoblinPriest_StatueInUse(S_GoblinPriestess_Statue_02_84e50877-e8b2-4a9c-89f1-c589fdb63643, S_GoblinPriestess_StatueDamageBox_02_7b9637dc-102e-426a-b2a0-deb5d66ac2ef, S_GoblinPriestess_InvisHelper_02_1a1dd4b9-b9c3-49e2-a480-4fb35b591f6e, "GOB_GoblinPriest_Statue_02");
//Two entries added after datalock
DB_GOB_GoblinPriest_StatueInUse(S_GoblinPriestess_Statue_03_554a7eef-6b57-4b3f-a844-673b300a8f8a, S_GoblinPriestess_StatueDamageBox_03_22060e18-3820-43fb-b794-6fa5319e7c90, S_GoblinPriestess_InvisHelper_03_c9852772-1f95-4489-9ea6-20ea531b3099, "GOB_GoblinPriest_Statue_03");
DB_GOB_GoblinPriest_StatueInUse(S_GoblinPriestess_Statue_04_d00851b1-cc9f-4c72-bb26-477be47ac005, S_GoblinPriestess_StatueDamageBox_04_9aceb6ed-1b96-468e-9b5b-4ac48a7d7658, S_GoblinPriestess_InvisHelper_04_96afadca-bc9d-4dd8-99fb-52bf19bb3a45, "GOB_GoblinPriest_Statue_04");

DB_DefeatedStateFlag(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, GOB_GoblinPriest_State_Defeated_78f21b35-a10a-4db2-9230-025691645103);
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);

SetTag(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);

SetOnStage(S_GOB_Chains_26ece288-8ff4-4c58-aa2b-2af55a0b7bef,0);

DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_GOB_GoblinPriest_2d0b3c0e-279c-29c5-5e14-57de02a5dce9,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_GOB_GoblinPriest_Guards_6d266e80-f605-488d-a2e0-2c4e8ea19384,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_GOB_GoblinWily_e7a1f0f7-5f59-438f-91c8-96d6b620495c,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_GOB_AbsoluteCultists_58a5996f-0631-9f9d-9ac2-94fe62edcf5f,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_GOB_Torturers_8a9e7e9a-1e72-eed1-8175-6c8d50ef7372,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_GOB_Bravado_83d9ecec-772f-487a-85f9-79aaee46befb,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_FOR_PainPriest_59c586cd-eca6-26bf-7f5a-b6fca6f3e016,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_GOB_Guards_f75246c5-0984-ec12-ee44-954231e0a219,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_GOB_Leaders_a25829dd-772a-6b00-572f-e036f89471aa,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_FOR_PainPriest_59c586cd-eca6-26bf-7f5a-b6fca6f3e016,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);

DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_GoblinPriestLowerLevel",(FACTION)ACT1_GOB_GoblinPriest_Ogre_fa18e2bb-e9ea-4053-9cf1-2d9acb5bf545,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
KBSECTION
//REGION DEBUG
IF
TextEvent("gobgut")
AND
DB_Players(_Player)
AND
IsControlled(_Player,1)
THEN
ClearFlag((FLAG)GOB_GoblinPriest_Event_Branding_bd95af19-d8cc-7311-06a8-4e7ed4aa633e, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9); // flagType: Object
PROC_GOB_GoblinPriest_FadeOut(_Player);

//END_REGION


//REGION Floor Collapse
IF
AttackedBy(S_GOB_GoblinPriest_FallingCage_ad3c12d3-ba91-495f-afbb-c2f91ef27029, _, _, _, _, _, _)
THEN
SetGravity(S_GOB_GoblinPriest_FallingCage_ad3c12d3-ba91-495f-afbb-c2f91ef27029,GRAVITYTYPE.Enabled);

IF
PlatformDestroyed(S_PLT_GOB_GoblinPriest_Floor_c0480f7e-acae-46e3-a561-fabdd6501b22)
THEN
PROC_GlobalSetFlagAndCache((FLAG)GOB_GoblinPriest_State_DungeonFloorDestroyed_cccb6c09-25b8-4e18-9ff2-51da5487afa2);

IF
Fell((ITEM)S_GOB_GoblinPriest_FallingCage_ad3c12d3-ba91-495f-afbb-c2f91ef27029,_)
THEN
DestroyPlatform(S_PLT_GOB_GoblinPriest_Floor_c0480f7e-acae-46e3-a561-fabdd6501b22);

//END_REGION


//REGION Finish branding
IF
DialogEnded(GOB_GoblinPriest_ca566e7f-421a-61cb-04e0-04e30855d376, _ID)
AND
NOT DB_GOB_GoblinPriest_MovedAwayFromBranding(1)
AND
GetFlag((FLAG)GOB_GoblinPriest_Event_StopBranding_3be36a99-a6bb-7ca3-f678-ffa9559d3406, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, 1)
AND
DialogGetInvolvedPlayer(_ID, 1, _Player)
THEN
PROC_TriggerRegisterForPlayers(GOB_GoblinPriest_ChapelTrigger_3dc95e64-7fb7-4944-b056-57f8199de53d);
ClearFlag((FLAG)GOB_GoblinPriest_Event_Branding_bd95af19-d8cc-7311-06a8-4e7ed4aa633e, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
Unlock(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702);
DB_GOB_GoblinPriest_StoppedBrandingPlayer((CHARACTER)_Player);
ClearOwnership(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702);

IF
DB_GOB_GoblinPriest_StoppedBrandingPlayer(_Player)
AND
NOT DB_DialogNPCs(_,(CHARACTER)S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_)
AND
NOT DB_GOB_GoblinPriest_MovedAwayFromBranding(1)
AND
GetFlag((FLAG)GOB_GoblinPriest_Event_StopBranding_3be36a99-a6bb-7ca3-f678-ffa9559d3406, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, 1)
THEN
PROC_RemoveDialog(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
PROC_CharacterMoveTo(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, GOB_GoblinPriest_ChapelPoint_b605c292-aa63-423f-9e83-9e8bd29a3ca8, "Walk", "GOB_GoblinPriest_Event_MovedToChapel");
LookFromTrigger(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,S_GOB_GoblinPriest_ChapelPoint_b605c292-aa63-423f-9e83-9e8bd29a3ca8,0);
PROC_GOB_PlayMovingAwayAD();

IF
EntityEvent(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, "GOB_GoblinPriest_Event_MovedToChapel")
THEN
DB_GOB_GoblinPriest_MovedAwayFromBranding(1);
DB_Dialogs(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,(DIALOGRESOURCE)GOB_GoblinPriest_Chapel_a5ab8ece-6d80-b110-4d8f-886420d0914d);
ClearFlag((FLAG)GOB_GoblinPriest_Event_StartMovingToChapel_919035a6-fb21-1145-77d5-e2c6dfae9651, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9); // flagType: Object
SetFlag((FLAG)GOB_GoblinPriest_Event_MovedToChapel_8ff66c21-e6cf-56fc-f9a4-ce15057697fa, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9); // flagType: Object
ClearTag(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
SetTag(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,(TAG)AI_USESPELL_C_64d4bb52-dd35-4d61-a112-0bc9a5789597);
PROC_TriggerRegisterForPlayers(TRIGGERGUID_S_GOB_GoblinPriest_CallNearChapelTrigger_c9214324-a2e3-47e2-b847-0d48e2d15dba);

// if last goblin in line was not brnaded
PROC
PROC_GOB_PlayMovingAwayAD()
AND
GetFlag((FLAG)GOB_GoblinPriest_Branded_1824ac41-a036-cbef-803a-27933fb39876, S_GOB_GoblinBrash_35ffa172-7f23-4452-8f90-5dc24fd3bb6d, 0) // flagType: Object
THEN
PROC_TryStartAD(DIALOGRESOURCEGUID_GOB_GoblinPriest_AD_LeavingBranding_b5f25e01-d800-5ec2-67e8-186cccdb7c01, S_GOB_GoblinSulky_dd21e1d9-c426-4b12-b5a0-ef3445e9e967, S_GOB_GoblinBrash_35ffa172-7f23-4452-8f90-5dc24fd3bb6d);

//END_REGION


//REGION Call for player when waiting
IF
EnteredTrigger(_Player, TRIGGERGUID_S_GOB_GoblinPriest_CallNearChapelTrigger_c9214324-a2e3-47e2-b847-0d48e2d15dba)
AND
DB_Players(_Player)
AND
DB_GOB_GoblinPriest_StoppedBrandingPlayer(_Player)
AND
CanSee(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, _Player, 1)
THEN
NOT DB_GOB_GoblinPriest_StoppedBrandingPlayer(_Player);
PlayAnimation(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,CUST_Waving_01_8d682545-f220-4db9-b170-71b1c22c6f2f);
PROC_TryStartAD(DIALOGRESOURCEGUID_GOB_GoblinPriest_AD_Call_47a4b020-945b-2cba-58b7-963a4b38102a, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);

IF
DialogStarted((DIALOGRESOURCE)GOB_GoblinPriest_Chapel_a5ab8ece-6d80-b110-4d8f-886420d0914d, _)
THEN
PROC_TriggerUnregisterForPlayers(TRIGGERGUID_S_GOB_GoblinPriest_CallNearChapelTrigger_c9214324-a2e3-47e2-b847-0d48e2d15dba);

//END_REGION


//REGION lock the doors
IF
Closed(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702)
THEN
SetFlag((FLAG)GOB_GoblinPriest_Event_DoorClosed_ea6bbcaf-b120-73ba-41f5-ce5771b5e1ad, S_Act1_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9); // flagType: Object

IF
Opened(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702)
THEN
ClearFlag((FLAG)GOB_GoblinPriest_Event_DoorClosed_ea6bbcaf-b120-73ba-41f5-ce5771b5e1ad, S_Act1_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9); // flagType: Object

IF
FlagSet(GOB_GoblinPriest_Event_TryCloseDoor_29b74271-0e8d-608c-f61f-c1a522564935, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, _) // flagType: Object
AND
DB_Defeated(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702)
THEN
SetFlag((FLAG)GOB_GoblinPriest_Event_CloseDoorFailed_3883b36e-2cf5-3cea-825e-8995177dc4d0, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);

IF
FlagSet(GOB_GoblinPriest_Event_TryCloseDoor_29b74271-0e8d-608c-f61f-c1a522564935, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, _) // flagType: Object
AND
NOT DB_Defeated(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702)
THEN
PROC_ItemCloseAndLock(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702,"GOB_GoblinPriest_ChapelDoorKey");



IF
UseStarted(_Player,S_GOB_GoblinPriest_TempleDoor_30b9f282-d34f-4db5-85f2-f10252d00c9c)
THEN
Unlock(S_GOB_GoblinPriest_SecludedRoomDoor_685bbe73-b643-4096-aa70-a06875598218);

//END_REGION


//REGION Count players
IF
FlagSet((FLAG)GOB_GoblinPriest_Event_CountPlayers_8773e88d-a53e-e51a-43d1-5fd334c9ceb0,(CHARACTER)_Player,_ID)
THEN
ClearFlag((FLAG)GOB_GoblinPriest_Event_CountPlayers_8773e88d-a53e-e51a-43d1-5fd334c9ceb0,_Player,_ID);
ClearFlag((FLAG)GOB_GoblinPriest_State_PlayersAroundChapel_6fdb000d-b0c9-4295-b6df-a1b6171dab8d,_Player,_ID);

IF
FlagSet((FLAG)GOB_GoblinPriest_Event_CountPlayers_8773e88d-a53e-e51a-43d1-5fd334c9ceb0,(CHARACTER)_Player,_ID)
AND
DB_Players(_Other)
AND
_Other != _Player
AND
DB_InRegion(_Other, GOB_GoblinPriest_ChapelTrigger_3dc95e64-7fb7-4944-b056-57f8199de53d)
AND
NOT DB_HiddenCharacters(_Other,_)
THEN
SetFlag((FLAG)GOB_GoblinPriest_State_PlayersAroundChapel_6fdb000d-b0c9-4295-b6df-a1b6171dab8d,_Player);
DetachFromPartyGroup(_Player);

//END_REGION


//REGION Teleport to the dungeon
IF
DialogEnded((DIALOGRESOURCE)GOB_GoblinPriest_Chapel_a5ab8ece-6d80-b110-4d8f-886420d0914d,_ID)
AND
GetFlag((FLAG)GOB_GoblinPriest_Event_CastSleep_0202a489-2e8a-d3a6-164c-693b654cf59b, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, 1) // flagType: Object
AND
DialogGetInvolvedPlayer(_ID,1,(CHARACTER)_Player)
THEN
ClearFlag((FLAG)GOB_GoblinPriest_Event_CastSleep_0202a489-2e8a-d3a6-164c-693b654cf59b, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9); // flagType: Object
PROC_GOB_GoblinPriest_FadeOut(_Player);

IF
DialogEnded(GOB_GoblinPriest_Chapel_a5ab8ece-6d80-b110-4d8f-886420d0914d,_ID)
AND
DB_DialogPlayers(_ID,_Player,_)
AND
GetFlag(GOB_GoblinPriest_Event_DrinkPotion_0d4b8077-d748-dcd8-12fc-0135c7f1a054, (CHARACTER)_Player, 1)
THEN
RequestDelete(S_GOB_GoblinPriest_SleepPotion_ac533c0a-c664-40bb-9cd9-ed4b07a6deb6);
PROC_GOB_GoblinPriest_FadeOut(_Player);

PROC
PROC_GOB_GoblinPriest_FadeOut((CHARACTER)_Player)
THEN
DB_GOB_GoblinPriest_Chains_ChainedCharacter(_Player);
ScreenFadeTo(_Player, 0.5, 0, "GOB_GoblinPriest_Event_SleepingFadeOutBlackId");

IF
ScreenFadeDone(_,"GOB_GoblinPriest_Event_SleepingFadeOutBlackId")
AND
DB_GOB_GoblinPriest_Chains_ChainedCharacter(_Player)
THEN
TeleportTo(_Player, S_GOB_GoblinPriest_ChainedBox_000_d9f4a96e-5f45-462e-b2b5-8b7680135036, "GOB_GoblinPriest_Event_CharacterTeleported", 0, 0, 0, 1, 1);
PROC_GOB_GoblinPriest_TeleportPriest();

PROC
PROC_GOB_GoblinPriest_TeleportPriest()
THEN
ClearFlag((FLAG)GOB_GoblinPriest_Event_StartMovingToChapel_919035a6-fb21-1145-77d5-e2c6dfae9651, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
ClearFlag((FLAG)GOB_GoblinPriest_Event_MovedToChapel_8ff66c21-e6cf-56fc-f9a4-ce15057697fa, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
TeleportTo(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, S_GOB_GoblinPriest_ChainRoom_Point_71c4764c-fed3-467f-87d0-9493a07847fc, "GOB_GoblinPriest_Event_MovedToSecludedPlace", 0);
ToInventory(S_GOB_PriestDungeon_ChainsKey_62dda6b7-2992-488b-8ae7-07b82750e0cf,S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
ClearTag(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,AI_USESPELL_C_64d4bb52-dd35-4d61-a112-0bc9a5789597); //remove tag allowing her to use certain spells
SetTag(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd); //add tag allowing her to use certain spells
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_GoblinPriestLowerLevel",(FACTION)ACT1_GOB_GoblinPriest_2d0b3c0e-279c-29c5-5e14-57de02a5dce9,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
NOT DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",(FACTION)ACT1_GOB_GoblinPriest_2d0b3c0e-279c-29c5-5e14-57de02a5dce9,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);

IF
EntityEvent((CHARACTER)_Player, "GOB_GoblinPriest_Event_CharacterTeleported")
THEN
SetFlag((FLAG)GOB_GoblinPriest_Quest_WasChained_f3d570f7-deb2-d18c-1043-c2a49e7d8783, _Player);
SetFlag((FLAG)GOB_GoblinPriest_Event_ChainedCharacter_df8b22d8-803e-97c3-871d-5494e1fb84e2, _Player);
SetFlag(GOB_GoblinPriest_Quest_CureIsHoax_9296acbd-c107-4fe4-ae63-7d5f89cd7099,NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_GoblinPriest_ApplyChainedStatus(_Player);
PROC_GOB_GoblinPriest_FadeIn(_Player);

PROC
PROC_GOB_GoblinPriest_FadeIn((CHARACTER)_Player)
THEN
ClearScreenFade(_Player, 2.0, "GOB_GoblinPriest_Event_SleepingFadeOutBlackId");

PROC
PROC_GOB_GoblinPriest_FadeIn((CHARACTER)_Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)GOB_GoblinPriest_ChainedCharacter_eecd9977-8ba4-b993-0c0a-066123f79b24, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, _Player)
THEN
DB_NOOP(1);

//END_REGION


//REGION Priest moves away from players
IF
FlagSet(GOB_GoblinPriest_Event_BreakChains_871ecada-cdde-beff-3be5-5875529bdaab, _Player, _DialogInstance)
AND
NOT DB_GOB_GoblinPriest_BreakChains(_Player, _DialogInstance)
THEN
DB_GOB_GoblinPriest_BreakChains(_Player, _DialogInstance);

IF
InstanceDialogChanged(_,(DIALOGRESOURCE)GOB_GoblinPriest_ChainedCharacter_eecd9977-8ba4-b993-0c0a-066123f79b24,(DIALOGRESOURCE)GOB_GoblinPriest_Chains_fbe594c5-21e7-c9b1-3350-dd7f8242aea3,0)
THEN
PROC_GOB_PriestessLeavesCell();

IF
DialogEnded((DIALOGRESOURCE)GOB_GoblinPriest_ChainedCharacter_eecd9977-8ba4-b993-0c0a-066123f79b24, _DialogInstance)
AND
NOT DB_GOB_GoblinPriest_BreakChains(_, _DialogInstance)
THEN
PROC_GOB_PriestessLeavesCell();

PROC
PROC_GOB_PriestessLeavesCell()
AND
QRY_OnlyOnce("GOB_PriestessLeavesCell_OnlyOnce")
THEN
Proc_RemoveAllDialogEntriesForSpeaker(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
DB_Dialogs(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,DIALOGRESOURCEGUID_GOB_GoblinPriest_Cellar_0b1cbf40-3e14-d0d7-42d7-2c9707144573);
PROC_CharacterMoveTo(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, TRIGGERGUID_GOB_GoblinPriest_PrayingPoint_fa423870-8805-4af9-ba58-670d1bcdc5dd, "Run", "GOB_GoblinPriest_Event_MovedToPrayingPoint");

IF
EntityEvent(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, "GOB_GoblinPriest_Event_MovedToPrayingPoint")
AND
NOT DB_GOB_WarlockProposal_WarlockEvent(_)
THEN
SetFlag((FLAG)GOB_GoblinPriest_Quest_PlayersChainedAlone_93c5fc69-7c8e-4991-a44c-1b3dbf1880f9, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
LookFromTrigger(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, TRIGGERGUID_GOB_GoblinPriest_PrayingPoint_fa423870-8805-4af9-ba58-670d1bcdc5dd, 0);
DB_SpotPlayers(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"GOB_GoblinPriest_SpotPlayerInDungeon",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_TargetIgnoreCantTalk((CHARACTER)S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"GOB_GoblinPriest_SpotPlayerInDungeon");
DB_SpotPlayers_IncludeWildshapedPlayers((CHARACTER)S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"GOB_GoblinPriest_SpotPlayerInDungeon");
DB_SpotPlayers_IncludeFollowers((CHARACTER)S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"GOB_GoblinPriest_SpotPlayerInDungeon");
DB_SpotPlayers_IncludeSummons((CHARACTER)S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"GOB_GoblinPriest_SpotPlayerInDungeon");

PROC
PROC_SpotPlayers_Spotted(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"GOB_GoblinPriest_SpotPlayerInDungeon",_Player)
AND
QRY_StartDialog(DIALOGRESOURCEGUID_GOB_GoblinPriest_Cellar_0b1cbf40-3e14-d0d7-42d7-2c9707144573, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_Player)
THEN
DB_NOOP(1);

IF
LeftCombat(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_Combat)
AND
DB_SpotPlayers(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"GOB_GoblinPriest_SpotPlayerInDungeon",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000)
AND
DB_Players(_Player)
AND
DB_Was_InCombat(_Player,_Combat)
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"GOB_GoblinPriest_SpotPlayerInDungeon");

PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Player, (FLAG)GOB_GoblinPriest_Event_BreakChains_871ecada-cdde-beff-3be5-5875529bdaab)
THEN
PROC_GOB_GoblinPriest_FreeCharacter(_Player);
//END_REGION


//REGION Freed in dialogue with chains
IF //Freed self
NestedDialogPlayed(GOB_GoblinPriest_Chains_fbe594c5-21e7-c9b1-3350-dd7f8242aea3, _Id)
AND
DialogGetInvolvedPlayer(_Id, 1, _Player)
AND
GetFlag((FLAG)GOB_GoblinPriest_Event_FreedFromChains_38ee56fc-1ee7-7ce7-a247-39913c3335ed, _Player, 1) // flagType: Object
AND
GetFlag((FLAG)GOB_GoblinPriest_Event_ChainedCharacter_df8b22d8-803e-97c3-871d-5494e1fb84e2, _Player, 1) // flagType: Object
THEN
PROC_GOB_GoblinPriest_FreeCharacter((CHARACTER)_Player);

IF //Freed another character
NestedDialogPlayed(GOB_GoblinPriest_Chains_fbe594c5-21e7-c9b1-3350-dd7f8242aea3, _Id)
AND
DialogGetInvolvedPlayer(_Id, 1, _Player)
AND
GetFlag((FLAG)GOB_GoblinPriest_Event_FreedOtherFromChains_a760e678-6a62-9ba9-f822-4068eed9710b, _Player, 1) // flagType: Object
AND
DB_GOB_GoblinPriest_Chains_ChainedCharacter(_ChainedCharacter)
THEN
PROC_GOB_GoblinPriest_FreeCharacter((CHARACTER)_ChainedCharacter);

//END_REGION


//REGION Chains interaction
IF
DB_GOB_GoblinPriest_Chains_ChainedCharacter(_Character)
THEN
DB_DangerZone((TRIGGER)S_GOB_WarlockProposal_ChainRoom_DangerZone_b7a36d66-af5f-43a7-8f4d-6dc816a8bda4,"GOB_WarlockProposal_ChainRoom");

IF
DB_DangerZone(S_GOB_WarlockProposal_ChainRoom_DangerZone_b7a36d66-af5f-43a7-8f4d-6dc816a8bda4,"GOB_WarlockProposal_ChainRoom")
AND
NOT DB_GOB_GoblinPriest_Chains_ChainedCharacter(_)
AND
DB_PermaDefeated(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9)
THEN
PROC_DangerZone_Safe("GOB_WarlockProposal_ChainRoom");

IF
DB_PermaDefeated(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9)
AND
DB_DangerZone(S_GOB_WarlockProposal_ChainRoom_DangerZone_b7a36d66-af5f-43a7-8f4d-6dc816a8bda4, "GOB_WarlockProposal_ChainRoom")
THEN
PROC_DangerZone_Safe("GOB_WarlockProposal_ChainRoom");

IF
LeftTrigger(_Player,S_GOB_WarlockProposal_ChainRoom_DangerZone_b7a36d66-af5f-43a7-8f4d-6dc816a8bda4)
AND
NOT DB_GOB_GoblinPriest_Chains_ChainedCharacter(_)
THEN
// let danger zone Osiris code to react to LeftTrigger
RealtimeObjectTimerLaunch(_Player,"GOB_WarlockProposal_ChainRoom_RemoveDangerZone",0);

IF
ObjectTimerFinished(_,"GOB_WarlockProposal_ChainRoom_RemoveDangerZone")
THEN
PROC_DangerZone_Safe("GOB_WarlockProposal_ChainRoom");

PROC
PROC_GOB_GoblinPriest_ApplyChainedStatus((CHARACTER)_Character)
THEN
PROC_RemoveMutingStatusses(_Character);
ApplyStatus(_Character, "GOB_GOBLINPRIEST_CHAINS", -1.0, 1);
SetFlag((FLAG)GOB_GoblinPriest_Event_ChainedCharacter_df8b22d8-803e-97c3-871d-5494e1fb84e2, _Character);
Lock(S_GOB_GoblinPriest_Chain_000_0456483e-1158-4aa5-8876-3b9fd22f46e3,"GOB_PriestDungeon_ChainsLock");
SetOnStage(S_GOB_GoblinPriest_Chains_Spring_26ece288-8ff4-4c58-aa2b-2af55a0b7bef,1);
AttachSpring(S_GOB_GoblinPriest_Chains_Spring_26ece288-8ff4-4c58-aa2b-2af55a0b7bef,"Dummy_Attach_01",_Character,"Ankle_R");
AttachSpring(S_GOB_GoblinPriest_Chains_Spring_26ece288-8ff4-4c58-aa2b-2af55a0b7bef,"Dummy_Attach_02",S_GOB_GoblinPriest_Chain_000_0456483e-1158-4aa5-8876-3b9fd22f46e3,"Dummy_Pos_01");

PROC
PROC_GOB_GoblinPriest_FreeCharacter((CHARACTER)_Character)
THEN
NOT DB_GOB_GoblinPriest_Chains_ChainedCharacter(_Character);
RemoveStatus(_Character, "GOB_GOBLINPRIEST_CHAINS");
ClearFlag((FLAG)GOB_GoblinPriest_Event_ChainedCharacter_df8b22d8-803e-97c3-871d-5494e1fb84e2, _Character);
Unlock(S_GOB_GoblinPriest_Chain_000_0456483e-1158-4aa5-8876-3b9fd22f46e3);
DetachSpring(S_GOB_GoblinPriest_Chains_Spring_26ece288-8ff4-4c58-aa2b-2af55a0b7bef,"Dummy_Attach_01");
DetachSpring(S_GOB_GoblinPriest_Chains_Spring_26ece288-8ff4-4c58-aa2b-2af55a0b7bef,"Dummy_Attach_02");
SetOnStage(S_GOB_GoblinPriest_Chains_Spring_26ece288-8ff4-4c58-aa2b-2af55a0b7bef,0);

// Through Help action
IF
StatusRemoved(_Character,"GOB_GOBLINPRIEST_CHAINS",_,_)
THEN
PROC_GOB_GoblinPriest_FreeCharacter((CHARACTER)_Character);

IF
Unlocked(S_GOB_GoblinPriest_Chain_000_0456483e-1158-4aa5-8876-3b9fd22f46e3,_,_)
AND
DB_GOB_GoblinPriest_Chains_ChainedCharacter(_Player)
THEN
PROC_GOB_GoblinPriest_FreeCharacter((CHARACTER)_Player);

IF
DestroyedBy(S_GOB_GoblinPriest_Chain_000_0456483e-1158-4aa5-8876-3b9fd22f46e3,_,_,_)
AND
DB_GOB_GoblinPriest_Chains_ChainedCharacter(_Player)
THEN
PROC_GOB_GoblinPriest_FreeCharacter((CHARACTER)_Player);

IF
LeftTrigger(_Player, S_GOB_GoblinPriest_ChainedBox_000_d9f4a96e-5f45-462e-b2b5-8b7680135036)
AND
DB_GOB_GoblinPriest_Chains_ChainedCharacter(_Player)
THEN
PROC_GOB_GoblinPriest_FreeCharacter(_Player);

IF
FlagSet(GOB_GoblinPriest_Event_DislocatedWrist_3c7849ac-1614-4a1b-9881-3cec92e87c35,_Player,_)
THEN
ApplyDamage(_Player,3,"Piercing",_Player);


//END_REGION


//REGION Priest not killed after the long rest
PROC
PROC_LongRest()
AND
NOT DB_Defeated(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9)
AND
GetFlag((FLAG)GOB_GoblinPriest_Event_AwaitCeremorphosis_cbf4c784-ca27-2ea8-6153-416bd3c48f97, S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, 1) // flagType: Object
AND
GetFlag((FLAG)GOB_GoblinPriest_Quest_PlayerEscaped_97c3a596-e927-9cfb-b5a7-1c591e7382a2, NULL_00000000-0000-0000-0000-000000000000, 0) // flagType: Global
THEN
SetFlag((FLAG)GOB_GoblinPriest_Quest_PlayerEscaped_97c3a596-e927-9cfb-b5a7-1c591e7382a2, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
FlagSet(GOB_GoblinPriest_Quest_PlayerEscaped_97c3a596-e927-9cfb-b5a7-1c591e7382a2, _, _)
THEN
DB_ExecuteInLevel("GOB_GoblinPriest_PlayerEscaped","WLD_Main_A");

PROC
PROC_ExecuteInLevel("GOB_GoblinPriest_PlayerEscaped","WLD_Main_A")
THEN
RemoveHarmfulStatuses(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
PROC_CharacterMoveTo(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, TRIGGERGUID_S_GOB_GoblinPriest_HideScaredPoint_a72b2809-920a-4d4d-9e70-5c8477f47452, "Run", "GOB_GoblinPriest_MovedToScaredPoint");

//END_REGION


//REGION Ogre
PROC
PROC_StateSet_Defeated(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9)
AND
IsTagged(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,(TAG)AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd,1) //Gut can only have this tag if she's in the backroom
THEN
SetTag((CHARACTER)S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,(TAG)AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd); //this allows Polma to cast GOB_Ogre_Enrage

PROC
PROC_GOB_GoblinPriest_TeleportPriest()
AND
GetCombatGroupID(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,_OgreCombatGroup)
THEN
SetCombatGroupID(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_OgreCombatGroup);

IF
DB_GlobalFlag((FLAG)GOB_GoblinPriest_Quest_PlayersChainedAlone_93c5fc69-7c8e-4991-a44c-1b3dbf1880f9)
THEN
PROC_RemoveDBTrespassTrigger((TRIGGER)S_GOB_GoblinPriest_OgreTrespassTrigger_e8629a34-2111-4b7d-b50a-13044c445b4a,S_GOB_GoblinPriest_OutDungeonTrigger_58c346df-0c41-48df-9edb-cdba1b67dc4c);
DB_SpotPlayers(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,"GOB_GoblinPriestOgre_SpotEscapedCharacters",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_TargetIgnoreCantTalk(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,"GOB_GoblinPriestOgre_SpotEscapedCharacters");
DB_SpotPlayers_IncludeWildshapedPlayers(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,"GOB_GoblinPriestOgre_SpotEscapedCharacters");
DB_SpotPlayers_IncludeFollowers(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,"GOB_GoblinPriestOgre_SpotEscapedCharacters");
DB_SpotPlayers_IncludeSummons(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,"GOB_GoblinPriestOgre_SpotEscapedCharacters");

PROC
PROC_SpotPlayers_Spotted(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,"GOB_GoblinPriestOgre_SpotEscapedCharacters",_Player)
AND
QRY_StartDialog(GOB_GoblinPriestOgre_4fe7a074-3c8a-884f-eec3-2a6ab7d02c19,S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,_Player)
THEN
DB_NOOP(1);

IF
LeftCombat(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,_Combat)
AND
DB_SpotPlayers(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,"GOB_GoblinPriestOgre_SpotEscapedCharacters",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000)
AND
DB_Players(_Player)
AND
DB_Was_InCombat(_Player,_Combat)
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511,"GOB_GoblinPriestOgre_SpotEscapedCharacters");

IF
FlagSet((FLAG)GOB_WarlockProposal_Event_PriestDeath_b9e8c596-55dc-4edc-8fbd-e52d601839d2, _, _)
AND
NOT QRY_GOB_WarlockProposal_FreePlayerPresent()
THEN
SetFlag((FLAG)GOB_WarlockProposal_Event_OgreKilledByWarlock_cc5bc6ff-a73e-4358-b923-9bfc01abf982, NULL_00000000-0000-0000-0000-000000000000, 0);
Die(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511, DEATHTYPE.DoT, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, 0, 0);

QRY
QRY_GOB_WarlockProposal_FreePlayerPresent()
AND
DB_Players(_Player)
AND
DB_GOB_GoblinPriest_Chains_ChainedCharacter((CHARACTER)_Char)
AND
_Char != _Player
AND
DB_InRegion(_Player, S_GOB_PriestDungeon_SUB_d693268c-84c9-44c2-ac7d-11ebc5524764)
AND
NOT DB_PermaDefeated(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511)
AND
DB_InRegion(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511, S_GOB_OgreSpotTrigger_229f5142-3180-4518-9f23-a61f81b1c177)
THEN
DB_NOOP(1);

IF
EnteredTrigger(_Player, S_GOB_OgreSpotTrigger_229f5142-3180-4518-9f23-a61f81b1c177)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)GOB_WarlockProposal_Event_OgreKilledByWarlock_cc5bc6ff-a73e-4358-b923-9bfc01abf982)
AND
DB_InRegion(S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511, S_GOB_OgreSpotTrigger_229f5142-3180-4518-9f23-a61f81b1c177)
THEN
StartVoiceBark((VOICEBARKRESOURCE)GOB_WarlockProposal_VB_OgreBurned_5f62f90c-8697-d99a-b9fc-db480911cc86, _Player);
PROC_TriggerUnregisterForPlayers(S_GOB_OgreSpotTrigger_229f5142-3180-4518-9f23-a61f81b1c177);

IF
CharacterLootedCharacter(_Player,S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511)
AND
GetFlag(GOB_WarlockProposal_Event_PriestDeath_b9e8c596-55dc-4edc-8fbd-e52d601839d2,NULL_00000000-0000-0000-0000-000000000000,1)
AND
//The AD is specifically about burnt ogre, don't want to trigger it on alive one yet
DB_Dead((CHARACTER)S_GOB_GoblinPriestOgre_658c5f80-33ea-4f8d-bded-8ef6ac2ed511)
AND
QRY_OnlyOnce("GOB_GoblinPriest_SaidPAD_DeadOgre")
THEN
PROC_TryStartAD((DIALOGRESOURCE)GOB_GoblinPriest_PAD_DeadOgre_f7cdcd7a-931e-0e07-2481-22515920743d,_Player);

//END_REGION


//REGION Combat - statue logic
IF
DB_GOB_GoblinPriest_StatueInUse(_,_Trigger,_, _)
THEN
TriggerRegisterForCharacter(_Trigger,S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);

IF
StatusApplied(_Statue,"GOB_PRIESTESS_STATUE_DESTROY",_,_)
AND
DB_GOB_GoblinPriest_StatueInUse((ITEM)_Statue,_,_Helper, _CameraEvent)
THEN
Die(_Statue,DEATHTYPE.DoT,S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,0,0);
RealtimeObjectTimerLaunch(_Statue, "GOB_GoblinPriest_FallingStatue_Timer",1600);
DB_GOB_GoblinPriest_DestroyingStatues_Event(_Statue);

IF
DestroyedBy(_Statue,_,_,_)
AND
DB_GOB_GoblinPriest_StatueInUse(_Statue,_,_Helper, _)
THEN
RealtimeObjectTimerLaunch(_Statue, "GOB_GoblinPriest_FallingStatue_Timer",1800);
RealtimeObjectTimerLaunch(_Statue, "GOB_GoblinPriest_FallingStatue_Cleanup_Timer",2000);
DB_GOB_GoblinPriest_DestroyingStatues_Event(_Statue);

//CameraEvent
IF
DB_GOB_GoblinPriest_DestroyingStatues_Event(_Statue)
AND
DB_GOB_GoblinPriest_StatueInUse((ITEM)_Statue,_Trigger,_, _CameraEvent)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _CombatGuid)
AND
DB_Is_InCombat(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9, _CombatGuid)
THEN
SendArenaCameraEvent(_Player, NULL_00000000-0000-0000-0000-000000000000, _CameraEvent);
NOT DB_GOB_GoblinPriest_DestroyingStatues_Event(_Statue);

IF
ObjectTimerFinished(_Statue,"GOB_GoblinPriest_FallingStatue_Timer")
AND
DB_GOB_GoblinPriest_StatueInUse((ITEM)_Statue,(TRIGGER)_Trigger,(ITEM)_Helper, _CameraEvent)
THEN
ClearTag(_Statue,ACT1_GOB_PRIESTESS_STATUE_UNSAFE_9ceba3bd-c44b-4b7b-a52c-ba6109c73b68);
AiRemoveInterestingItem(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_Statue);
CreateExplosion(_Helper,"Projectile_GOB_GoblinPriestess_StatueDebris",3);
TriggerUnregisterForCharacter(_Trigger,S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);

//Delay the unregister of the trigger so that the explosion logic can reason about who is in the trigger.
IF
ObjectTimerFinished(_Statue,"GOB_GoblinPriest_FallingStatue_Cleanup_Timer")
AND
DB_GOB_GoblinPriest_StatueInUse((ITEM)_Statue,(TRIGGER)_Trigger,(ITEM)_Helper, _CameraEvent)
THEN
NOT DB_GOB_GoblinPriest_StatueInUse((ITEM)_Statue,(TRIGGER)_Trigger,(ITEM)_Helper, _CameraEvent);
PROC_TriggerUnregisterforPlayers(_Trigger);

PROC
PROC_TriggerUnregisterforPlayers(_Trigger)
AND
DB_GOB_GoblinPriest_PlayersInDanger((TRIGGER)_Trigger,(CHARACTER)_Player)
THEN
NOT DB_GOB_GoblinPriest_PlayersInDanger((TRIGGER)_Trigger,(CHARACTER)_Player);
ClearTag(_Player,ACT1_GOB_PRIESTESS_PLAYER_DANGER_27a0ab52-9a5e-473f-aabd-573fa54d30eb);

IF
DB_GOB_GoblinPriest_StatueInUse(_,_Trigger,_, _)
THEN
PROC_TriggerRegisterforPlayers(_Trigger);

IF
EnteredTrigger(_Player,_Trigger)
AND
DB_GOB_GoblinPriest_StatueInUse((ITEM)_Statue,(TRIGGER)_Trigger,_, _)
THEN
DB_GOB_GoblinPriest_PlayersInDanger((TRIGGER)_Trigger,(CHARACTER)_Player);
SetTag(_Statue,ACT1_GOB_PRIESTESS_STATUE_f1fbea64-76c0-4ab0-9e3d-c5a748351b17);
SetTag(_Player,ACT1_GOB_PRIESTESS_PLAYER_DANGER_27a0ab52-9a5e-473f-aabd-573fa54d30eb);
AiAddInterestingItem(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_Statue);

IF
LeftTrigger(_Player,_Trigger)
AND
DB_GOB_GoblinPriest_StatueInUse((ITEM)_Statue,(TRIGGER)_Trigger,_, _)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(_Trigger)
THEN
ClearTag(_Statue,ACT1_GOB_PRIESTESS_STATUE_f1fbea64-76c0-4ab0-9e3d-c5a748351b17);
AiRemoveInterestingItem(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_Statue);

IF
LeftTrigger(_Player,_Trigger)
AND
DB_GOB_GoblinPriest_PlayersInDanger((TRIGGER)_Trigger,(CHARACTER)_Player)
THEN
NOT DB_GOB_GoblinPriest_PlayersInDanger((TRIGGER)_Trigger,(CHARACTER)_Player);
ClearTag(_Player,ACT1_GOB_PRIESTESS_PLAYER_DANGER_27a0ab52-9a5e-473f-aabd-573fa54d30eb);

IF
EnteredTrigger(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_Trigger)
AND
DB_GOB_GoblinPriest_StatueInUse((ITEM)_Statue,(TRIGGER)_Trigger,_, _)
THEN
SetTag(_Statue,ACT1_GOB_PRIESTESS_STATUE_UNSAFE_9ceba3bd-c44b-4b7b-a52c-ba6109c73b68);

IF
LeftTrigger(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_Trigger)
AND
DB_GOB_GoblinPriest_StatueInUse((ITEM)_Statue,(TRIGGER)_Trigger,_, _)
THEN
ClearTag(_Statue,ACT1_GOB_PRIESTESS_STATUE_UNSAFE_9ceba3bd-c44b-4b7b-a52c-ba6109c73b68);
//END_REGION


//REGION Combat - Chapel reinforcements
IF
FlagSet(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_GOB_DrowCommander_RaidersInGoblinCamp(_Goblin)
AND
DB_GOB_GoblinPriest_Minions(_Goblin)
THEN
NOT DB_GOB_GoblinPriest_Minions(_Goblin);

IF
UsingSpell(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"Shout_GOB_GoblinPriest_CallForHelp",_,_,_)
THEN
PROC_TryStartAD(GOB_GoblinPriest_AD_CallingForHelp_405d703d-fd10-4a0d-e48b-b726f18f044a,S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);

IF
CastedSpell(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"Shout_GOB_GoblinPriest_CallForHelp",_,_,_)
AND
DB_GOB_GoblinPriest_Minions(_Goblin)
THEN
PROC_CharacterMoveTo(_Goblin,S_GOB_GoblinPriest_Minions_ToChapel_e48e6f7a-87aa-4777-9a12-7893112c4d4e,"Run","GOB_GoblinMinion_ArrivedChapel");

IF
EntityEvent((CHARACTER)_Goblin,"GOB_GoblinMinion_ArrivedChapel")
AND
DB_GOB_GoblinPriest_Minions(_Goblin)
AND
GetCombatGroupID(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,_CombatGroup)
THEN
SetCombatGroupID(_Goblin,_CombatGroup);

IF
EntityEvent((CHARACTER)_Goblin,"GOB_GoblinMinion_ArrivedChapel")
AND
DB_GOB_GoblinPriest_Minions(_Goblin)
AND
QRY_OnlyOnce("GOB_GoblinPriest_MakeReinforcementsHostile")
THEN
PROC_SetRelationToPlayers(ACT1_GOB_GoblinPriest_Guards_6d266e80-f605-488d-a2e0-2c4e8ea19384,0);

IF
EntityEvent((CHARACTER)_Goblin,"GOB_GoblinMinion_ArrivedChapel")
AND
DB_GOB_GoblinPriest_Minions(_Goblin)
AND
GetFaction(_Goblin,_Faction)
AND
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",_Faction,_Tag)
THEN
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_GoblinPriestLowerLevel",_Faction,_Tag);
NOT DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_UpperLevel",_Faction,_Tag);

IF
CastedSpell(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9,"Shout_GOB_GoblinPriest_CallForHelp",_,_,_)
AND
IsLocked(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702,1)
AND
IsDestroyed(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702,0)
AND
DB_GOB_GoblinPriest_Minions(_Goblin)
THEN
AiAddInterestingItem(_Goblin,S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702);
DB_GOB_GoblinPriest_Minion_AttackingDoor(_Goblin);

IF
Unlocked(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702,_,_)
AND
DB_GOB_GoblinPriest_Minion_AttackingDoor(_Goblin)
THEN
AiRemoveInterestingItem(_Goblin,S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702);
NOT DB_GOB_GoblinPriest_Minion_AttackingDoor(_Goblin);

IF
DestroyedBy(S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702,_,_,_)
AND
DB_GOB_GoblinPriest_Minion_AttackingDoor(_Goblin)
THEN
AiRemoveInterestingItem(_Goblin,S_GOB_GoblinPriest_ChapelDoor_965b910b-f20f-4ea7-8756-4b2ff6b9a702);
NOT DB_GOB_GoblinPriest_Minion_AttackingDoor(_Goblin);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
