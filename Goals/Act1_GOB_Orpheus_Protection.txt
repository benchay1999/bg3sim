Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_GOB_Orpheus_ProtectionTriggers(
	(TRIGGER)S_GOB_Orpheus_BridgeEntrance_4f9172c0-cf44-4476-853e-f48baadcd43d,
	(TRIGGER)S_GOB_Orpheus_BridgeEntrance_AddToDialogArea_ac143b80-368c-46e2-bed3-c1d84b1fa3ba,
	(TRIGGER)S_GOB_Orpheus_BridgeEntrance_SHPos_114d3b5d-c358-4c22-a2c0-9115ad48ec87,
	(TRIGGER)S_GOB_Orpheus_BridgeEntrance_SHEndPos_998c9884-b247-4d79-a7d5-dd6bcd0fb8fb);
DB_GOB_Orpheus_ProtectionTriggers(
	(TRIGGER)S_GOB_Orpheus_PlainsEntrance_14864342-8a4f-47f0-aae4-466494695f76,
	(TRIGGER)S_GOB_Orpheus_PlainsEntrance_AddToDialogArea_fc5a15cd-c698-4707-ad85-390914145b10,
	(TRIGGER)S_GOB_Orpheus_PlainsEntrance_SHPos_be24aea9-965e-4f94-9b68-25f97e57391b,
	(TRIGGER)S_GOB_Orpheus_PlainsEntrance_SHEndPos_fca0c0d4-4c5e-452d-8d99-c05843efe550);
DB_GOB_Orpheus_ProtectionTriggers(
	(TRIGGER)S_GOB_Orpheus_SecludedGoblinEntrance_96946abd-9b25-42f7-858d-1b8870bfe9cb,
	(TRIGGER)S_GOB_Orpheus_SecludedGoblinEntrance_AddToDialogArea_89cea0f0-0bcd-4253-bb3e-10f9af9dfc2f,
	(TRIGGER)S_GOB_Orpheus_SecludedGoblinEntrance_SHPos_bca5773d-3ed7-4d1a-899a-d1886ab17f12,
	(TRIGGER)S_GOB_Orpheus_SecludedGoblinEntrance_SHEndPos_f09855c4-c8ee-47a5-b71f-c24c54dbb3e9);
DB_GOB_Orpheus_ProtectionTriggers(
	(TRIGGER)S_GOB_Orpheus_WindmillEntrance_e03d7047-1ca3-419e-a28b-83de255de924,
	(TRIGGER)S_GOB_Orpheus_WindmillEntrance_AddToDialogArea_603c4d49-7ca8-4b26-9dd6-7a51d00837f7,
	(TRIGGER)S_GOB_Orpheus_WindmillEntrance_SHPos_d64cb4fc-bb2d-4c64-ac8b-4efa0af2129d,
	(TRIGGER)S_GOB_Orpheus_WindmillEntrance_SHEndPos_a67bbed3-751b-4d86-b838-1a4ac3e6e232);
DB_GOB_Orpheus_ProtectionTriggers(
	(TRIGGER)S_GOB_Orpheus_RisingRoad_71c69f61-ee70-4bfc-8a87-4d4ed54e923f,
	(TRIGGER)S_GOB_Orpheus_RisingRoad_AddToDialogArea_37575969-7e17-4dc7-8f7e-77c0cb7e960f,
	(TRIGGER)S_GOB_Orpheus_RisingRoad_SHPos_ff536b30-4509-4b78-a3ef-8444f1264f53,
	(TRIGGER)S_GOB_Orpheus_RisingRoad_SHEndPos_a249f1ef-7c12-4b98-9a30-654a43c8f691);
DB_GOB_Orpheus_ProtectionTriggers(
	(TRIGGER)S_GOB_Orpheus_MountainPass_e2980e60-973a-4844-a825-b0dfeae0f630,
	(TRIGGER)S_GOB_Orpheus_MountainPass_AddToDialogArea_e94c5cc9-c9d3-4db7-9714-b3f499f0dcba,
	(TRIGGER)S_GOB_Orpheus_MountainPass_SHPos_524a8dde-1617-438e-8479-decac9d7c0e7,
	(TRIGGER)S_GOB_Orpheus_MountainPass_SHEndPos_ad47fbd9-4276-4c98-9c36-7a8c43c86bff);
DB_GOB_Orpheus_ProtectionTriggers(
	(TRIGGER)S_GOB_Orpheus_KethericCity_e9f8b6bb-fa09-4d35-93bf-1ee96ea3a322,
	(TRIGGER)S_GOB_Orpheus_KethericCity_AddToDialogArea_5887df5b-4c46-47e6-8065-2e99900b2901,
	(TRIGGER)S_GOB_Orpheus_KethericCity_SHPos_6221cb03-1cba-419b-ab3c-1bdb9392b1c9,
	(TRIGGER)S_GOB_Orpheus_KethericCity_SHEndPos_66acf44b-c1f3-42fb-8ed4-c18dd6a17eab);
DB_GOB_Orpheus_ProtectionTriggers(
	(TRIGGER)S_GOB_Orpheus_TempleFallbackA_05f36c7a-a9b9-4529-a97c-8b4021d61a0b,
	(TRIGGER)S_GOB_Orpheus_TempleFallbackA_AddToDialogArea_5b10adf9-25c0-45b2-a5c7-6c3288705e9d,
	(TRIGGER)S_GOB_Orpheus_TempleFallbackA_SHPos_27e591aa-4834-4883-b6d8-fad4ada31079,
	(TRIGGER)S_GOB_Orpheus_TempleFallbackA_SHEndPos_ac9861b4-e5e2-4258-9925-fcbafe3e6e7d);
DB_GOB_Orpheus_ProtectionTriggers(
	(TRIGGER)S_GOB_Orpheus_TempleFallbackB_1f74d835-d58b-4ef4-95f5-f36349d5617e,
	(TRIGGER)S_GOB_Orpheus_TempleFallbackB_AddToDialogArea_f0f924fc-d0ea-4d94-805d-4374d1227f58,
	(TRIGGER)S_GOB_Orpheus_TempleFallbackB_SHPos_2f1a537d-5b45-484a-9539-c8efaf610734,
	(TRIGGER)S_GOB_Orpheus_TempleFallbackB_SHEndPos_2ff55e93-3fa0-45dd-a003-d962487c8308);

DB_GOB_Orpheus_Teleporters((ITEM)S_PLA_TeleporterToCrecheFromPlains_016525f4-0ddd-4cf1-85ab-3feaa6f6292a);
DB_GOB_Orpheus_Teleporters((ITEM)S_GOB_TeleporterToCrecheFromGoblinCamp_a81232d7-af15-4c77-b0e1-d7e791fd463b);
DB_GOB_Orpheus_Teleporters((ITEM)S_UND_Elevator_Fort_ToShadowlands_e48a9110-dabc-4471-bcae-3cc8aa57b8c5);
DB_GOB_Orpheus_Teleporters((ITEM)S_GOB_ThroneRoom_Door_Entrance_bf8a7b29-383d-4344-bbe6-b72f10c1ba50);
DB_GOB_Orpheus_Teleporters((ITEM)S_GOB_Festivities_SecretEntrance_Door_ddbb3184-e682-47b7-ac0f-94d631b3f3ed);

DB_GOB_Orpheus_VoiceDialogs((DIALOGRESOURCE)GOB_Orpheus_VoiceOfAbsolute_ShadowheartHasBox_8996ac21-4624-8bd4-02f2-24c92219d8cd);
DB_GOB_Orpheus_VoiceDialogs((DIALOGRESOURCE)GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b);
KBSECTION
//REGION Triggering the moment
IF
DB_GOB_Orpheus_VoiceDialogs(_Dialog)
THEN
DB_DropMutingStatussesDialog(_Dialog);
DB_DialogBlockTradeButton(_Dialog);
DB_DialogBlockAttackButton(_Dialog); // GUS-171665

IF
DB_GOB_Orpheus_ProtectionTriggers(_EntranceTrigger, _, _, _)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)_EntranceTrigger);

IF
EnteredTrigger(_Player, _EntranceTrigger)
AND
NOT DB_GOB_Orpheus_VoiceDialogStarted(1)
AND
DB_Players(_Player)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EntranceTrigger, _, _, _)
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
NOT DB_Is_InCombat(_Player,_)
AND
NOT DB_InteractiveDialogSpeaker(_, _Player)
THEN
PROC_GOB_Orpheus_StartVoiceDialog(_Player, _EntranceTrigger);

// cant start - in combat
IF
EnteredTrigger(_Player, _EntranceTrigger)
AND
NOT DB_GOB_Orpheus_VoiceDialogStarted(1)
AND
DB_Players(_Player)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EntranceTrigger, _, _, _)
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
DB_Is_InCombat(_Player,_)
AND
NOT DB_GOB_Orpheus_PostponeEventStart(_Player)
THEN
DB_GOB_Orpheus_PostponeEventStart(_Player);

// cant start - in the dialog
IF
EnteredTrigger(_Player, _EntranceTrigger)
AND
NOT DB_GOB_Orpheus_VoiceDialogStarted(1)
AND
DB_Players(_Player)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EntranceTrigger, _, _, _)
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
DB_InteractiveDialogSpeaker(_,_Player)
AND
NOT DB_GOB_Orpheus_PostponeEventStart(_Player)
THEN
DB_GOB_Orpheus_PostponeEventStart(_Player);

IF
DB_GOB_Orpheus_PostponeEventStart(_Player)
AND
DB_GOB_Orpheus_PostponeEventStart(_OtherPlayer)
AND
_Player != _OtherPlayer
THEN
NOT DB_GOB_Orpheus_PostponeEventStart(_OtherPlayer);

IF
DB_GOB_Orpheus_PostponeEventStart((CHARACTER)_Player)
AND
NOT DB_InteractiveDialogSpeaker(_,_Player)
AND
NOT DB_Is_InCombat(_Player,_)
AND
NOT DB_GOB_Orpheus_VoiceDialogStarted(1)
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_PartyWasFaintedByVoice_4c7a0307-eb7d-4933-899c-80272dc5bcb2)
AND
NOT DB_InCamp(_Player)
THEN
NOT DB_GOB_Orpheus_PostponeEventStart(_Player);
PROC_GOB_Orpheus_StartVoiceDialog((CHARACTER)_Player);

PROC
PROC_BlockUseOfItem((CHARACTER)_Player,(ITEM)_Teleporter)
AND
DB_GOB_Orpheus_Teleporters(_Teleporter)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
NOT DB_Is_InCombat(_Player, _)
THEN
DB_CustomUseItemResponse(_Player, _Teleporter, 0);
PROC_GOB_Orpheus_StartVoiceDialog(_Player);

QRY
QRY_GOB_Orpheus_AnyPlayerInPreparedOrpheus()
AND
DB_Players(_PLayer)
AND
DB_GOB_Orpheus_PostponeEventStart(_AnyPlayer)
THEN
DB_NOOP(1);

QRY
QRY_GOB_Orpheus_SomeoneInsideDialog()
AND
DB_GOB_Orpheus_VoiceDialogs(_Dialog)
AND
DB_DialogName(_Dialog, _)
THEN
DB_NOOP(1);
//END_REGION Triggering the moment

//REGION Voice Dialog - Preparing
// Setting Up trigger to auto-add other players to the dialog
QRY
QRY_GOB_Orpheus_PrepareAddToDialogTrigger((TRIGGER)_AddToDialogTrigger, (DIALOGRESOURCE)_Dialog)
AND
DB_GOB_Orpheus_ProtectionTriggers(_, _AddToDialogTrigger, _, _)
AND
NOT DB_AddCharactersInTriggerToDialog(_, _AddToDialogTrigger, _, _, _, _)
THEN
PROC_TriggerRegisterForPlayers(_AddToDialogTrigger);
DB_AddCharactersInTriggerToDialog(_Dialog, _AddToDialogTrigger, 1, 0, 1);

// Should succeed even if the trigger has been registered already
QRY
QRY_GOB_Orpheus_PrepareAddToDialogTrigger((TRIGGER)_AddToDialogTrigger, (DIALOGRESOURCE)_Dialog)
THEN
DB_NOOP(1);

// Start voice dialog without knowing the exact trigger
PROC
PROC_GOB_Orpheus_StartVoiceDialog((CHARACTER)_Player)
AND
DB_Players(_AnyPlayer)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EntranceTrigger, _AddToDialogArea, _, _)
AND
NOT DB_GOB_Orpheus_VoiceDialogStarted(1)
AND
IsInTrigger(_AnyPlayer, _AddToDialogArea, 1)
THEN
PROC_GOB_Orpheus_StartVoiceDialog(_AnyPlayer, _EntranceTrigger);
//END_REGION Voice Dialog - Preparing

//REGION Voice Dialog - Starting
// 1) Shadowheart-companion takes out the box, her bounded Avatar nearby questions her
PROC
PROC_GOB_Orpheus_StartVoiceDialog(_, (TRIGGER)_EntranceTrigger)
AND
QRY_GOB_Orpheus_VoiceDialogStartUnblocked()
AND
GetFlag(GLO_InfernalBox_State_BoxBoundedTo_f4d2be66-0443-4069-8ca2-570143f17e27, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
AND
NOT DB_Avatars(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EntranceTrigger, _AddToDialogArea, _, _)
AND
IsInTrigger(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _AddToDialogArea, 1)
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,1,1)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,_Avatar)
AND
QRY_SpeakerIsAvailable(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_GOB_Orpheus_PrepareAddToDialogTrigger(_AddToDialogArea, GOB_Orpheus_VoiceOfAbsolute_ShadowheartHasBox_8996ac21-4624-8bd4-02f2-24c92219d8cd)
AND
QRY_GOB_Orpheus_StartDialog(GOB_Orpheus_VoiceOfAbsolute_ShadowheartHasBox_8996ac21-4624-8bd4-02f2-24c92219d8cd,
							S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,
							S_GOB_Orpheus_VoiceOfAbsoluteHelper_696b6670-c31c-4cfe-a1dd-fa80c3b59dad,
							_Avatar)
THEN
DB_NOOP(1);

// 2) Companion has the box, Avatar sees the box being taken out, companion may have an inclusion
PROC
PROC_GOB_Orpheus_StartVoiceDialog(_, (TRIGGER)_EntranceTrigger)
AND
QRY_GOB_Orpheus_VoiceDialogStartUnblocked()
AND
GetFlag(GLO_InfernalBox_State_BoxBoundedTo_f4d2be66-0443-4069-8ca2-570143f17e27, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0)
AND
DB_GLO_InfernalBox_CharacterWithBox(_CharacterWithBox)
AND
DB_Players(_CharacterWithBox)
AND
NOT DB_Avatars(_CharacterWithBox)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EntranceTrigger, _AddToDialogArea, _, _)
AND
IsInTrigger(_CharacterWithBox, _AddToDialogArea, 1)
AND
QRY_GetClosestAvailableCharacterTo(_CharacterWithBox, 0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar, _CharacterWithBox, _, 1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_CharacterWithBox, _ClosestAvatar, 0, 1)
AND
QRY_GOB_Orpheus_PrepareAddToDialogTrigger(_AddToDialogArea, GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b)
AND
QRY_GOB_Orpheus_StartDialog(GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b,
							S_GOB_Orpheus_VoiceOfAbsoluteHelper_696b6670-c31c-4cfe-a1dd-fa80c3b59dad,
							_ClosestAvatar)
THEN
DB_NOOP(1);

// 3) Avatar or Orphan-Companion (SH or not) takes out the box (if no Avatar to witness is nearby)
PROC
PROC_GOB_Orpheus_StartVoiceDialog(_, (TRIGGER)_EntranceTrigger)
AND
QRY_GOB_Orpheus_VoiceDialogStartUnblocked()
AND
DB_GLO_InfernalBox_CharacterWithBox(_CharacterWithBox)
AND
DB_Players(_CharacterWithBox)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EntranceTrigger, _AddToDialogArea, _, _)
AND
IsInTrigger(_CharacterWithBox, _AddToDialogArea, 1)
AND
QRY_SpeakerIsAvailable(_CharacterWithBox)
AND
QRY_GOB_Orpheus_PrepareAddToDialogTrigger(_AddToDialogArea, GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b)
AND
QRY_GOB_Orpheus_StartDialog(GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b,
							S_GOB_Orpheus_VoiceOfAbsoluteHelper_696b6670-c31c-4cfe-a1dd-fa80c3b59dad,
							_CharacterWithBox)
THEN
DB_NOOP(1);

// 4) No one around in the party has the box - as unrecruited SH has it with her.
//    She will pop and save the party and then will be available for the recruitment.
PROC
PROC_GOB_Orpheus_StartVoiceDialog((CHARACTER)_EnteredPlayer, (TRIGGER)_EnteredTrigger)
AND
QRY_GOB_Orpheus_VoiceDialogStartUnblocked()
AND
DB_GOB_Orpheus_ProtectionTriggers(_EnteredTrigger, _AddToDialogArea, _, _)
AND
NOT DB_GlobalFlag(GLO_InfernalBox_State_TeamHasBox_d8b25e35-ec84-45e5-8395-5ce6faa36fbd)
AND
GetFlag(GLO_InfernalBox_State_BoxBoundedTo_f4d2be66-0443-4069-8ca2-570143f17e27, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
AND
NOT DB_Defeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_PartOfTheTeam(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_Is_InCombat((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _)
THEN
PROC_GOB_Orpheus_StartVoiceDialog_WithShadowheartRecruitment(_EnteredPlayer, _EnteredTrigger);

// 5) The party owns the box, but no one around has it - start dialog with closest avatar,
//    the box will magically appear.
PROC
PROC_GOB_Orpheus_StartVoiceDialog((CHARACTER)_EnteredPlayer, (TRIGGER)_EnteredTrigger)
AND
QRY_GOB_Orpheus_VoiceDialogStartUnblocked()
AND
QRY_GetClosestAvailableCharacterTo(_EnteredPlayer, 0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestPlayer, _EnteredPlayer, _Distance, 1)
AND
_Distance < 25.0
AND
DB_GOB_Orpheus_ProtectionTriggers(_EnteredTrigger, _AddToDialogArea, _, _)
AND
IsInTrigger(_ClosestPlayer, _AddToDialogArea, 1)
AND
QRY_GOB_Orpheus_PrepareAddToDialogTrigger(_AddToDialogArea, GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b)
AND
QRY_GOB_Orpheus_StartDialog(GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b,
							S_GOB_Orpheus_VoiceOfAbsoluteHelper_696b6670-c31c-4cfe-a1dd-fa80c3b59dad,
							_ClosestPlayer)
THEN
SetFlag(GOB_Orpheus_Event_TransferBoxToCharacter_1dfabd27-de06-44f3-98df-3c492d550933, _ClosestPlayer);

// 6) Fallback to the character who entered the trigger,
//    the box will magically appear.
PROC
PROC_GOB_Orpheus_StartVoiceDialog((CHARACTER)_EnteredPlayer, (TRIGGER)_EnteredTrigger)
AND
QRY_GOB_Orpheus_VoiceDialogStartUnblocked()
AND
DB_GOB_Orpheus_ProtectionTriggers(_EnteredTrigger, _AddToDialogArea, _, _)
AND
IsInTrigger(_EnteredPlayer, _AddToDialogArea, 1)
AND
QRY_GOB_Orpheus_PrepareAddToDialogTrigger(_AddToDialogArea, GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b)
AND
QRY_GOB_Orpheus_StartDialog(GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b,
							S_GOB_Orpheus_VoiceOfAbsoluteHelper_696b6670-c31c-4cfe-a1dd-fa80c3b59dad,
							_EnteredPlayer)
THEN
SetFlag(GOB_Orpheus_Event_TransferBoxToCharacter_1dfabd27-de06-44f3-98df-3c492d550933, _EnteredPlayer);

// 7) Fallback : dialog didn-t start at all
PROC
PROC_GOB_Orpheus_StartVoiceDialog((CHARACTER)_EnteredPlayer, (TRIGGER)_EnteredTrigger)
AND
QRY_GOB_Orpheus_VoiceDialogStartUnblocked()
THEN
PROC_GOB_Orpheus_OnVoiceDialogFailed(GOB_Orpheus_VoiceOfAbsolute_7f6edcc6-8f3e-9082-5cfc-c72aeced596b);

QRY
QRY_GOB_Orpheus_VoiceDialogStartUnblocked()
AND
NOT DB_GOB_Orpheus_VoiceDialogStarted(1)
AND
NOT DB_GLO_Orpheus_ShadowheartRecruitment_ChainingInProgress(1)
THEN
DB_NOOP(1);
//END_REGION Voice Dialog - Starting

//REGION Voice Dialog - Shadowheart appearing
// Preparing dialog
PROC
PROC_GOB_Orpheus_StartVoiceDialog_WithShadowheartRecruitment((CHARACTER)_EnteredPlayer, (TRIGGER)_EnteredTrigger)
AND
NOT DB_GLO_Orpheus_ShadowheartRecruitment_ChainingInProgress(1)
AND
QRY_GOB_Orpheus_SelectCharacterForVoiceDialog_PreferAvatar((CHARACTER)_EnteredPlayer, (TRIGGER)_EnteredTrigger)
AND
DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer(_Player, _ShadowheartTrigger)
THEN
PROC_GOB_Orpheus_PrepShadowheartRecruitment((CHARACTER)_Player, (TRIGGER)_ShadowheartTrigger);

PROC
PROC_GOB_Orpheus_PrepShadowheartRecruitment((CHARACTER)_Player, (TRIGGER)_ShadowheartTrigger)
AND
NOT DB_GLO_Orpheus_ShadowheartRecruitment_ChainingInProgress(1)
AND
NOT DB_State_Current(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment","GOB")
THEN
DB_GLO_Orpheus_ShadowheartRecruitment_ChainingInProgress(1);
PROC_CancelDisappearOutOfSight(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
PROC_ForceStopDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
PROC_ClearStoryMove(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
RemoveHarmfulStatuses(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
ApplyStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "INVISIBLE", 3.0, 1, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
TeleportTo(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _ShadowheartTrigger, "GOB_Orpheus_ShadowheartTeleported");

// after retrying
PROC
PROC_GOB_Orpheus_PrepShadowheartRecruitment((CHARACTER)_Player, (TRIGGER)_ShadowheartTrigger)
AND
NOT DB_GLO_Orpheus_ShadowheartRecruitment_ChainingInProgress(1)
AND
DB_State_Current(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment","GOB")
THEN
PROC_GOB_Orpheus_OnShadowheartReady();

IF
EntityEvent(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "GOB_Orpheus_ShadowheartTeleported")
AND
NOT DB_OffStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_GOB_Orpheus_OnShadowheartAppeared();

IF
EntityEvent(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "GOB_Orpheus_ShadowheartTeleported")
AND
DB_OffStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_GOB_Orpheus_WaitingToWentOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
DB_GOB_Orpheus_WaitingToWentOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
SetOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);

IF
WentOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
AND
DB_GOB_Orpheus_WaitingToWentOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
NOT DB_GOB_Orpheus_WaitingToWentOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
PROC_GOB_Orpheus_OnShadowheartAppeared();

PROC
PROC_GOB_Orpheus_OnShadowheartAppeared()
AND
DB_GLO_Orpheus_ShadowheartRecruitment_ChainingInProgress(1)
AND
DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer(_Player, _ShadowheartTrigger)
AND
DB_GOB_Orpheus_ProtectionTriggers(_, _, _ShadowheartTrigger, _ShadowheartTriggerEndTrigger)
THEN
RemoveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "INVISIBLE");
PROC_State_Progress(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment","GOB");
PROC_GLO_Origins_SetRecruitmentDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,ShadowHeart_Recruitment_Gob_cd0dd81e-a7b4-1cae-6d4c-750a7a65ff59);
PROC_CharacterMoveTo(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _ShadowheartTriggerEndTrigger, "Sprint", "GOB_Orpheus_ShadowheartArrived");
PROC_GOB_Orpheus_OnShadowheartReady();

// Starting the Voice dialog
PROC
PROC_GOB_Orpheus_OnShadowheartReady()
AND
DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer(_Player, _ShadowheartTrigger)
AND
DB_GOB_Orpheus_ProtectionTriggers(_, _AddToDialogTrigger, _ShadowheartTrigger, _)
AND
QRY_GOB_Orpheus_PrepareAddToDialogTrigger(_AddToDialogTrigger, GOB_Orpheus_VoiceOfAbsolute_ShadowheartHasBox_8996ac21-4624-8bd4-02f2-24c92219d8cd)
AND
QRY_GOB_Orpheus_StartDialog(GOB_Orpheus_VoiceOfAbsolute_ShadowheartHasBox_8996ac21-4624-8bd4-02f2-24c92219d8cd,
							S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,
							S_GOB_Orpheus_VoiceOfAbsoluteHelper_696b6670-c31c-4cfe-a1dd-fa80c3b59dad,
							_Player)
THEN
DB_Dialogs_DialogBlockRestoreMutingStatuses(GOB_Orpheus_VoiceOfAbsolute_ShadowheartHasBox_8996ac21-4624-8bd4-02f2-24c92219d8cd, _Player);

// Searching for a player and a spot
QRY
QRY_GOB_Orpheus_SelectCharacterForVoiceDialog_PreferAvatar((CHARACTER)_EnteredPlayer, (TRIGGER)_EnteredTrigger)
AND
NOT DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer(_, _)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EnteredTrigger, _AddToDialogTrigger, _ShadowheartTrigger, _)
AND
QRY_GetClosestAvailableCharacterTo(_EnteredPlayer, 0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestPlayer, _EnteredPlayer, _, _)
AND
IsInTrigger(_ClosestPlayer, _AddToDialogTrigger, 1)
THEN
DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer((CHARACTER)_ClosestPlayer, (TRIGGER)_ShadowheartTrigger);

QRY
QRY_GOB_Orpheus_SelectCharacterForVoiceDialog_PreferAvatar((CHARACTER)_EnteredPlayer, (TRIGGER)_EnteredTrigger)
AND
NOT DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer(_, _)
AND
QRY_SpeakerIsAvailable(_EnteredPlayer, 0, 1)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EnteredTrigger, _AddToDialogTrigger, _ShadowheartTrigger, _)
THEN
DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer((CHARACTER)_EnteredPlayer, (TRIGGER)_ShadowheartTrigger);

QRY
QRY_GOB_Orpheus_SelectCharacterForVoiceDialog_PreferAvatar(_, (TRIGGER)_EnteredTrigger)
AND
DB_GOB_Orpheus_ProtectionTriggers(_EnteredTrigger, _AddToDialogTrigger, _ShadowheartTrigger, _)
AND
DB_Players(_Player)
AND
NOT DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer(_, _)
AND
IsInTrigger(_Player, _AddToDialogTrigger, 1)
AND
QRY_SpeakerIsAvailable(_Player, 0, 1)
THEN
DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer((CHARACTER)_Player, (TRIGGER)_ShadowheartTrigger);
//END_REGION Voice Dialog - Shadowheart appearing

//REGION Voice Dialog - Starting Wrapper
QRY
QRY_GOB_Orpheus_StartDialog((DIALOGRESOURCE)_Dialog, (CHARACTER)_Speaker1, (CHARACTER)_Speaker2, (CHARACTER)_Speaker3)
AND
QRY_StartDialog(_Dialog, _Speaker1, _Speaker2, _Speaker3)
THEN
PROC_GOB_Orpheus_OnVoiceDialogStarted();

QRY
QRY_GOB_Orpheus_StartDialog((DIALOGRESOURCE)_Dialog, (CHARACTER)_Speaker1, (CHARACTER)_Speaker2)
AND
QRY_StartDialog(_Dialog, _Speaker1, _Speaker2)
THEN
PROC_GOB_Orpheus_OnVoiceDialogStarted();

QRY
QRY_GOB_Orpheus_StartDialog(_Dialog, _, _, _)
AND
NOT DB_GOB_Orpheus_VoiceDialogStarted(1)
THEN
PROC_GOB_Orpheus_OnVoiceDialogFailed(_Dialog);

QRY
QRY_GOB_Orpheus_StartDialog(_Dialog, _, _)
AND
NOT DB_GOB_Orpheus_VoiceDialogStarted(1)
THEN
PROC_GOB_Orpheus_OnVoiceDialogFailed(_Dialog);
//END_REGION Voice Dialog - Starting Wrapper

//REGION Voice Dialog - Ended
IF
DialogRequestFailed(_Dialog,_)
AND
DB_GOB_Orpheus_VoiceDialogs(_Dialog)
THEN
PROC_GOB_Orpheus_OnVoiceDialogFailed(_Dialog);

IF
DialogEnded(_Dialog, _)
AND
DB_GOB_Orpheus_VoiceDialogs(_Dialog)
THEN
PROC_GOB_Orpheus_OnVoiceDialogEnded(_Dialog);
//END_REGION Voice Dialog - Ended

//REGION Protection Status
IF
FlagSet((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7, _, _)
AND
DB_PartyMembers(_PartyMember)
AND
NOT DB_PermaDefeated(_PartyMember)
AND
IsTagged(_PartyMember, ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
AND
HasAppliedStatus(_PartyMember, "GLO_ORPHEUS_PROTECTED", 0)
THEN
ApplyStatus(_PartyMember, "GLO_ORPHEUS_PROTECTED", -1.0, 1, S_GLO_PuzzleBox_326324f9-0920-8f0f-3e85-3781fbf48282);

IF
FlagSet((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7, _, _)
AND
DB_State_Current(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment","GOB")
AND
NOT DB_PartOfTheTeam(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_Defeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
ApplyStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "GLO_ORPHEUS_PROTECTED", -1.0, 1, S_GLO_PuzzleBox_326324f9-0920-8f0f-3e85-3781fbf48282);
//END_REGION Protection Status

//REGION Voice Dialog - Clearing
PROC
PROC_GOB_Orpheus_OnVoiceDialogStarted()
AND
NOT DB_GOB_Orpheus_VoiceDialogStarted(1)
THEN
DB_GOB_Orpheus_VoiceDialogStarted(1);

PROC
PROC_GOB_Orpheus_OnVoiceDialogFailed((DIALOGRESOURCE)_Dialog)
THEN
PROC_GOB_Orpheus_ClearVoiceDialogData(_Dialog);

PROC
PROC_GOB_Orpheus_OnVoiceDialogEnded((DIALOGRESOURCE)_Dialog)
THEN
PROC_GOB_Orpheus_ClearVoiceDialogData(_Dialog);

PROC
PROC_GOB_Orpheus_ClearVoiceDialogData((DIALOGRESOURCE)_Dialog)
AND
DB_GLO_Orpheus_ShadowheartRecruitment_ChainingInProgress(1)
THEN
NOT DB_GLO_Orpheus_ShadowheartRecruitment_ChainingInProgress(1);

PROC
PROC_GOB_Orpheus_ClearVoiceDialogData((DIALOGRESOURCE)_Dialog)
AND
DB_Dialogs_DialogBlockRestoreMutingStatuses(_Dialog, _Player)
THEN
NOT DB_Dialogs_DialogBlockRestoreMutingStatuses(_Dialog, _Player);

PROC
PROC_GOB_Orpheus_ClearVoiceDialogData((DIALOGRESOURCE)_Dialog)
AND
DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer(_ClosestPlayer, _ShadowheartTrigger)
THEN
NOT DB_GOB_Orpheus_ShadowheartRecruitment_SelectedPlayer(_ClosestPlayer, _ShadowheartTrigger);

PROC
PROC_GOB_Orpheus_ClearVoiceDialogData((DIALOGRESOURCE)_Dialog)
AND
DB_AddCharactersInTriggerToDialog(_Dialog, _AddToDialogTrigger, _,_)
THEN
PROC_AddCharactersInTriggerToDialog_Clear(_Dialog, _AddToDialogTrigger);

PROC
PROC_GOB_Orpheus_ClearVoiceDialogData((DIALOGRESOURCE)_Dialog)
AND
DB_GOB_Orpheus_VoiceDialogStarted(1)
THEN
NOT DB_GOB_Orpheus_VoiceDialogStarted(1);

// TODO: Also needs to unregister after proceeding into Act 2
IF
FlagSet((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7, _, _)
THEN
PROC_GOB_Orpheus_UnregisterVoiceTriggers();

PROC
PROC_GOB_Orpheus_UnregisterVoiceTriggers()
AND
DB_GOB_Orpheus_ProtectionTriggers(_EntranceTrigger, _, _, _)
THEN
PROC_TriggerUnregisterForPlayers(_EntranceTrigger);

PROC
PROC_GOB_Orpheus_UnregisterVoiceTriggers()
AND
DB_GOB_Orpheus_ProtectionTriggers(_, _AddToDialogArea, _, _)
THEN
PROC_TriggerUnregisterForPlayers(_AddToDialogArea);
//END_REGION Voice Dialog - Clearing

//REGION Fainting - force resting
PROC
PROC_GOB_Orpheus_OnVoiceDialogFailed(_Dialog)
AND
DB_GOB_Orpheus_RetriedToStart(1)
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
THEN
PROC_GlobalSetFlagAndCache(GOB_Orpheus_State_PartyWasFaintedByVoice_4c7a0307-eb7d-4933-899c-80272dc5bcb2);
PROC_GOB_Orpheus_StartFainting();

PROC
PROC_GOB_Orpheus_OnVoiceDialogEnded(_Dialog)
AND
DB_GOB_Orpheus_RetriedToStart(1)
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
THEN
PROC_GlobalSetFlagAndCache(GOB_Orpheus_State_PartyWasFaintedByVoice_4c7a0307-eb7d-4933-899c-80272dc5bcb2);

PROC
PROC_GOB_Orpheus_OnVoiceDialogEnded(_Dialog)
AND
DB_GlobalFlag(GOB_Orpheus_State_PartyWasFaintedByVoice_4c7a0307-eb7d-4933-899c-80272dc5bcb2)
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
DB_DialogName(_Dialog, _Id)
AND
NOT DB_GOB_Orpheus_WaitForDialogToClear(_Dialog, _Id)
THEN
DB_GOB_Orpheus_WaitForDialogToClear(_Dialog, _Id);

IF
DB_GOB_Orpheus_WaitForDialogToClear(_Dialog, _Id)
AND
NOT DB_DialogPlayers(_Id, _,_)
AND
NOT DB_InteractiveDialogSpeaker(_Id, _)
THEN
NOT DB_GOB_Orpheus_WaitForDialogToClear(_Dialog, _Id);
PROC_GOB_Orpheus_StartFainting();

PROC
PROC_GOB_Orpheus_StartFainting()
AND
DB_Players(_Player)
AND
NOT DB_GOB_Orpheus_EnteredNightMode(1)
AND
DB_GOB_Orpheus_ProtectionTriggers(_, _AddToDialogArea, _, _)
AND
IsInTrigger(_Player, _AddToDialogArea, 1)
THEN
DB_GOB_Orpheus_EnteredNightMode(1);
PROC_Camp_ForceEndTheDay(_Player,"");
//END_REGION Fainting - force resting

//REGION Voice Dialog - Failing and restarting
// failed to start
PROC
PROC_GOB_Orpheus_OnVoiceDialogFailed((DIALOGRESOURCE)_Dialog)
AND
NOT DB_GOB_Orpheus_RetriedToStart(1)
THEN
PROC_GOB_Orpheus_RetryVoiceDialog(_Dialog);

// ended too early
PROC
PROC_GOB_Orpheus_OnVoiceDialogEnded((DIALOGRESOURCE)_Dialog)
AND
NOT DB_GlobalFlag(GOB_Orpheus_State_PartyWasFaintedByVoice_4c7a0307-eb7d-4933-899c-80272dc5bcb2)
AND
NOT DB_GlobalFlag(GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
NOT DB_GOB_Orpheus_RetriedToStart(1)
THEN
PROC_GOB_Orpheus_RetryVoiceDialog(_Dialog);

PROC
PROC_GOB_Orpheus_RetryVoiceDialog(_)
AND
DB_Players(_Player)
AND
NOT DB_GOB_Orpheus_RetriedToStart(1) // works like QRY_OnlyOnce here basically
AND
DB_GOB_Orpheus_ProtectionTriggers(_, _AddToDialogArea, _, _)
AND
IsInTrigger(_Player, _AddToDialogArea, 1)
AND
QRY_SpeakerIsAvailable(_Player, 0, 1)
THEN
DB_GOB_Orpheus_RetriedToStart(1);
PROC_GOB_Orpheus_StartVoiceDialog((CHARACTER)_Player);

PROC
PROC_GOB_Orpheus_RetryVoiceDialog((DIALOGRESOURCE)_Dialog)
AND
NOT DB_GOB_Orpheus_RetriedToStart(1)
THEN
DB_GOB_Orpheus_RetriedToStart(1);
PROC_GOB_Orpheus_OnVoiceDialogFailed((DIALOGRESOURCE)_Dialog);

//END_REGION Voice Dialog - Failing and restarting

//REGION Killing Shadowheart
PROC
PROC_Camp_EnterNight_PreFadeout_Hook()
AND
NOT DB_PartOfTheTeam(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_GOB_Orpheus_ShouldKillShadowheartOnRest()
THEN
DB_GLO_InfernalBox_BlockTakingBoxDialog(1); // we are handling the box in the camp night scene here
PROC_GOB_Orpheus_KillShadowheart();

QRY
QRY_GOB_Orpheus_ShouldKillShadowheartOnRest()
AND
DB_GlobalFlag(GOB_Orpheus_State_PartyWasFaintedByVoice_4c7a0307-eb7d-4933-899c-80272dc5bcb2)
THEN
DB_NOOP(1);

QRY
QRY_GOB_Orpheus_ShouldKillShadowheartOnRest()
AND
DB_GlobalFlag(GOB_Shadowheart_State_HostileAfterRecruitment_1e3517cc-7795-7183-eca3-8e0894bb71ef)
THEN
DB_NOOP(1);

PROC
PROC_LevelUnloading("WLD_Main_A")
AND
NOT DB_PartOfTheTeam(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag(GOB_Orpheus_State_PartyWasFaintedByVoice_4c7a0307-eb7d-4933-899c-80272dc5bcb2)
THEN
PROC_GOB_Orpheus_KillShadowheart();

PROC
PROC_GOB_Orpheus_KillShadowheart()
AND
NOT DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
SetTag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
Die(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, DEATHTYPE.Psychic, NULL_00000000-0000-0000-0000-000000000000, 0, 0);
PROC_GlobalSetFlagAndCache(ORI_Shadowheart_State_DiedNoGobRecruitment_b3f2edb8-2b9f-4258-a258-818a65767d35);
DB_SeenDeadNPCGlobalFlag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, GOB_Orpheus_State_SeenDeadShadowheart_5bfacbd0-4cc0-4a35-bc7a-e4ac9185f164);

IF
DB_Dead(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_State_KilledByParty_a35bdc79-95b4-4ddd-8a2a-344d372998e8)
AND
DB_Sees(_Player, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_Players(_Player)
AND
NOT DB_CantTalk(_Player)
AND
DB_GlobalFlag(ORI_Shadowheart_State_DiedNoGobRecruitment_b3f2edb8-2b9f-4258-a258-818a65767d35)
AND
DB_GlobalFlag(GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
NOT DB_Camp_Faded(_Player, _)
AND
NOT DB_OnlyOnce("RecruitedFirstTime_ShadowHeart")
AND
NOT QRY_OncePerUserAndNearbyPlayers_IsSet(_Player, "GOB_Orpheus_PAD_SawDeadShadowheart")
AND
QRY_StartDialog(GOB_Orpheus_PAD_SawDeadShadowheart_82d91b94-9864-162e-173b-2ec350850fe8, _Player)
AND
QRY_OncePerUserAndNearbyPlayers(_Player, "GOB_Orpheus_PAD_SawDeadShadowheart")
THEN
DB_NOOP(1);
//END_REGION Killing Shadowheart

//REGION Transferring the Box
IF
FlagSet(GLO_InfernalBox_Event_ForceGiveBox_7addbb64-502f-48aa-9b71-da1b8d6c28eb, _Character, _)
AND
_Character != S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679
AND
DB_PartOfTheTeam(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
GetFlag(GLO_InfernalBox_State_BoxBoundedTo_f4d2be66-0443-4069-8ca2-570143f17e27, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
THEN
PROC_GlobalSetFlagAndCache(GOB_Orpheus_State_ShadowheartLostBox_97d91025-211f-4a6e-960a-0dc6de3de4ab);

PROC
PROC_GOB_Orpheus_OnVoiceDialogEnded(_Dialog)
AND
DB_GlobalFlag(GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
DB_DialogName(_Dialog, _ID)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
GetFlag(GOB_Orpheus_Event_TransferBoxToCharacter_1dfabd27-de06-44f3-98df-3c492d550933, _Player, 1)
THEN
SetFlag(GLO_InfernalBox_Event_ForceGiveBox_7addbb64-502f-48aa-9b71-da1b8d6c28eb, _Player, _ID);

PROC
PROC_GOB_Orpheus_ClearVoiceDialogData(_Dialog)
AND
NOT DB_GlobalFlag(GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
AND
DB_DialogName(_Dialog, _ID)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
GetFlag(GOB_Orpheus_Event_TransferBoxToCharacter_1dfabd27-de06-44f3-98df-3c492d550933, _Player, 1)
THEN
ClearFlag(GOB_Orpheus_Event_TransferBoxToCharacter_1dfabd27-de06-44f3-98df-3c492d550933, _Player, _ID);
//END_REGION Transferring the Box

//REGION Completing the goal
PROC
PROC_LevelUnloading("WLD_Main_A")
AND
NOT DB_GlobalFlag(ORI_Shadowheart_State_DiedNoGobRecruitment_b3f2edb8-2b9f-4258-a258-818a65767d35)
THEN
GoalCompleted;

PROC
PROC_LevelBecameUnreachable("WLD_Main_A")
THEN
GoalCompleted;
//END_REGION

//REGION Debug
IF
TextEvent("GOB_Orpheus_State_HadVoiceOfAbsoluteEvent")
THEN
PROC_GlobalSetFlagAndCache((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7);

IF
TextEvent("GOB_Orpheus_State_HadVoiceOfAbsoluteEvent")
AND
NOT DB_GlobalFlag((FLAG)GLO_InfernalBox_State_TeamHasBox_d8b25e35-ec84-45e5-8395-5ce6faa36fbd)
AND
GetHostCharacter(_Player)
THEN
SetFlag(GLO_InfernalBox_Event_ForceGiveBox_7addbb64-502f-48aa-9b71-da1b8d6c28eb, _Player);
//END_REGION Debug
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
