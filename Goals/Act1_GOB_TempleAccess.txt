Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_GOB_TempleAccess_Disk((ITEM)ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266);
DB_GOB_TempleAccess_Disk(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c);
DB_GOB_TempleAccess_Disk(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22);
DB_GOB_TempleAccess_Disk(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7);

DB_GOB_TempleAccess_Rotation((ITEM)ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 0);
DB_GOB_TempleAccess_Rotation(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 0);
DB_GOB_TempleAccess_Rotation(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 0);
DB_GOB_TempleAccess_Rotation(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 0);

DB_GOB_TempleAccess_DiskBones(0, "Dummy_Attachment_04", "GOB_TempleAccess_MoonState0");
DB_GOB_TempleAccess_DiskBones(1, "Dummy_Attachment_03", "GOB_TempleAccess_MoonState1");
DB_GOB_TempleAccess_DiskBones(2, "Dummy_Attachment_02", "GOB_TempleAccess_MoonState2");
DB_GOB_TempleAccess_DiskBones(3, "Dummy_Attachment_01", "GOB_TempleAccess_MoonState3");
DB_GOB_TempleAccess_DiskBones(4, "Dummy_Attachment_08", "GOB_TempleAccess_MoonState4");
DB_GOB_TempleAccess_DiskBones(5, "Dummy_Attachment_07", "GOB_TempleAccess_MoonState5");
DB_GOB_TempleAccess_DiskBones(6, "Dummy_Attachment_06", "GOB_TempleAccess_MoonState6");
DB_GOB_TempleAccess_DiskBones(7, "Dummy_Attachment_05", "GOB_TempleAccess_MoonState7");

DB_GOB_TempleAccess_CurrentState((ITEM)ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 0, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 1, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 2, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 3, 0);

DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 0, 0);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 1, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 2, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 3, 2);

DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 0, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 1, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 2, 0);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 3, 2);

DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 0, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 1, 0);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 2, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 3, 2);

DB_GOB_TempleAccess_Neighbours((ITEM)ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 1, (ITEM)ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c);
DB_GOB_TempleAccess_Neighbours(ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 2, ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22);
DB_GOB_TempleAccess_Neighbours(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 2, ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7);
DB_GOB_TempleAccess_Neighbours(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 3, ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266);
DB_GOB_TempleAccess_Neighbours(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 0, ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266);
DB_GOB_TempleAccess_Neighbours(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 1, ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7);
DB_GOB_TempleAccess_Neighbours(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 0, ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c);
DB_GOB_TempleAccess_Neighbours(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 3, ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22);

DB_GOB_TempleAccess_MoonState(2, (EFFECTRESOURCE)VFX_Script_PUZ_Temple_Shar_Moon_Full_A_01_31b64b6c-918e-451f-91d5-bbda02959246);
DB_GOB_TempleAccess_MoonState(1, VFX_Script_PUZ_Temple_Shar_Moon_Crescent_A_01_be15adbd-e8c6-47ae-f6d4-ac257bfd1f85);
DB_GOB_TempleAccess_MoonState(0, VFX_Script_PUZ_Temple_Shar_Moon_New_A_01_4e356292-a2a4-1400-4564-3f5b052b0827);

PROC_GOB_TempleAccess_InitialEffects();

DB_GOB_TempleAccess_GoalState((ITEM)ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 2);
DB_GOB_TempleAccess_GoalState(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 0);

DB_KnowledgeCheckTrigger_AD("GOB_TempleAccess_PuzzleApproach", TRIGGERGUID_S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1, "Investigation", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, DIALOGRESOURCEGUID_GOB_TempleAccess_PuzzleApproach_AD_b1cf463a-da1c-c6fd-00c6-b15387da8a98, GOB_TempleAccess_State_Puzzle_CheckMade_b5774b21-5d68-1480-7fc0-bd4bd28cb1fa);

PROC_TriggerRegisterForPlayers(S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1);

DB_BookFlags(S_GOB_TempleAccess_Lorebook_283d7eff-f6e5-401f-852e-7ad7fb728b88,SHA_TempleOfShar_Quest_ReadInstructionPaper_c52a5b36-9a3b-4c68-843b-bc5242436019);
KBSECTION
//REGION Door opening logic

PROC
PROC_GOB_TempleAccess_InitialEffects()
AND
DB_GOB_TempleAccess_CurrentState(_Disk, _Pos, _State)
AND
DB_GOB_TempleAccess_Neighbours(_Disk, _Pos, _Neighbour)
AND
DB_GOB_TempleAccess_Neighbours(_Neighbour, _Pos2, _Disk)
AND
DB_GOB_TempleAccess_DiskBones(_Pos2, _, _EffectID2)
AND
NOT DB_LoopEffect(_Neighbour, _, _EffectID2, _, _, _, _)
AND
DB_GOB_TempleAccess_DiskBones(_Pos, _Bone1, _EffectID1)
AND
DB_GOB_TempleAccess_MoonState(_State, _EffectName)
THEN
PROC_LoopEffect(_EffectName, _Disk, _EffectID1,  "WLD_Main_A", _Bone1, 1.0);

PROC
PROC_GOB_TempleAccess_InitialEffects()
AND
DB_GOB_TempleAccess_CurrentState(_Disk, _Pos, _State)
AND
NOT DB_GOB_TempleAccess_Neighbours(_Disk, _Pos, _)
AND
DB_GOB_TempleAccess_DiskBones(_Pos, _Bone1, _EffectID1)
AND
DB_GOB_TempleAccess_MoonState(_State, _EffectName)
THEN
PROC_LoopEffect(_EffectName, _Disk, _EffectID1,  "WLD_Main_A", _Bone1, 1.0);

IF
UseStarted(_, _Disk)
AND
DB_GOB_TempleAccess_Disk(_Disk)
THEN
PROC_GOB_TempleAccess_DisksCanUse(0);
PROC_GOB_TempleAccess_SwitchEffectsTo(_Disk);
PROC_GOB_TempleAccess_Rotate(_Disk);

PROC
PROC_GOB_TempleAccess_DisksCanUse((INTEGER)_CanUse)
AND
DB_GOB_TempleAccess_Disk(_Disk)
THEN
SetCanInteract(_Disk, _CanUse);

PROC
PROC_GOB_TempleAccess_SwitchEffectsTo((ITEM)_Disk)
AND
DB_GOB_TempleAccess_Rotation(_Disk, _MyRot)
AND
DB_GOB_TempleAccess_DiskBones(_PosBone, _, _)
AND
IntegerModulo(_PosBone, 4, _BasePositionBone)
AND
IntegerSubtract(_PosBone, _BasePositionBone, _OrientationBone)
AND
IntegerSubtract(_PosBone, _MyRot, _RawPos)
AND
IntegerSum(_RawPos, 8, _AssuredPositivePos)
AND
IntegerModulo(_AssuredPositivePos, 4, _NeighbourPos)
AND
DB_GOB_TempleAccess_Neighbours(_Disk, _NeighbourPos, _Neighbour)
AND
DB_GOB_TempleAccess_Rotation(_Neighbour, _NeighbourRot)
AND
IntegerSum(_NeighbourPos, 2, _RawFlippedBone)
AND
IntegerModulo(_RawFlippedBone, 4, _UnalignedNeighbourBone)
AND
IntegerSum(_UnalignedNeighbourBone, _NeighbourRot, _RawRotationAdjustedUnalignedNeighbourBone)
AND
IntegerModulo(_RawRotationAdjustedUnalignedNeighbourBone, 4, _RotationAdjustedUnalignedNeighbourBone)
AND
IntegerSum(4, _OrientationBone, _MaxInvertedOrientationBone)
AND
IntegerModulo(_MaxInvertedOrientationBone, 8, _InvertedOrientationBone)
AND
IntegerSum(_InvertedOrientationBone, _RotationAdjustedUnalignedNeighbourBone, _AlignedNeighbourBone)
AND
DB_GOB_TempleAccess_DiskBones(_AlignedNeighbourBone, _Bone2, _EffectID2)
AND
DB_LoopEffect(_Neighbour, _, _EffectID2, _, _, _, _)
AND
DB_GOB_TempleAccess_DiskBones(_PosBone, _Bone1, _EffectID1)
AND
DB_GOB_TempleAccess_CurrentState(_Disk, _NeighbourPos, _Value)
AND
DB_GOB_TempleAccess_MoonState(_Value, _EffectName)
THEN
PROC_GOB_TempleAccess_DebugText("Removing ", _Neighbour, _Bone2, _AlignedNeighbourBone);
PROC_GOB_TempleAccess_DebugText("Adding ", _Disk, _Bone1, _PosBone);
PROC_StopLoopEffect(_Neighbour, _EffectID2);
PROC_LoopEffect(_EffectName, _Disk, _EffectID1,  "WLD_Main_A", _Bone1, 0.2);

PROC
PROC_GOB_TempleAccess_DebugText((STRING)_Change, (GUIDSTRING)_Object, (STRING)_BoneName, (INTEGER)_BoneID)
AND
Concatenate(_Change, _BoneName, _Str1)
AND
Concatenate(_Str1, ", at ID ", _Str2)
AND
ConcatenateInteger(_Str2, _BoneID, _DebugText)
THEN
DebugText(_Object, _DebugText);

IF
TextEvent("GOB_TempleAccess_DebugDiskEffect")
AND
GetTextEventParamInteger(1, _Int)
AND
DB_GOB_TempleAccess_Disk(_Disk)
AND
DB_GOB_TempleAccess_DiskBones(_Int, _Bone, _)
THEN
PlayEffect(_Disk, VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416, _Bone, 1.0);

PROC
PROC_GOB_TempleAccess_Rotate((ITEM)_Disk)
AND
DB_GOB_TempleAccess_Rotation(_Disk, _Rotation)
THEN
DB_GOB_TempleAccess_RotatingDisks(_Disk);
ObjectTimerLaunch(_Disk, "GOB_TempleAccess_Rotating", 2300);
SetAnimationEventInt(_Disk, "TempleDiscState", _Rotation);

IF
//EntityEvent(_Disk, "GOB_TempleAccess_DoneRotating")
ObjectTimerFinished(_Disk, "GOB_TempleAccess_Rotating")
THEN
NOT DB_GOB_TempleAccess_RotatingDisks((ITEM)_Disk);

IF
ObjectTimerFinished(_Disk, "GOB_TempleAccess_Rotating")
AND
NOT DB_GOB_TempleAccess_RotatingDisks(_)
THEN
PROC_GOB_TempleAccess_FinishedRotation((ITEM)_Disk);

PROC
PROC_GOB_TempleAccess_FinishedRotation((ITEM)_Disk)
AND
DB_GOB_TempleAccess_Rotation(_Disk, _OldState)
AND
IntegerSum(_OldState, 1, _I)
AND
IntegerModulo(_I, 4, _NewState)
THEN
NOT DB_GOB_TempleAccess_Rotation(_Disk, _OldState);
DB_GOB_TempleAccess_Rotation(_Disk, _NewState);

PROC
PROC_GOB_TempleAccess_FinishedRotation((ITEM)_Disk)
AND
DB_GOB_TempleAccess_CurrentState(_Disk, _Index, _OldMoon)
AND
IntegerSubtract(_Index, 1, _NewIndex)
AND
IntegerSum(_NewIndex, 4, _NewIndex2)
AND
IntegerModulo(_NewIndex2, 4, _ModIndex)
THEN
DB_GOB_TempleAccess_TempState(_Disk, _ModIndex, _OldMoon);
NOT DB_GOB_TempleAccess_CurrentState(_Disk, _Index, _OldMoon);

PROC
PROC_GOB_TempleAccess_FinishedRotation((ITEM)_Disk)
AND
DB_GOB_TempleAccess_TempState(_Disk, _Index, _NewMoon)
THEN
NOT DB_GOB_TempleAccess_TempState(_Disk, _Index, _NewMoon);
DB_GOB_TempleAccess_CurrentState(_Disk, _Index, _NewMoon);


PROC
PROC_GOB_TempleAccess_FinishedRotation((ITEM)_Disk)
AND
DB_GOB_TempleAccess_CurrentState(_Disk, _Index, _NewMoon)
AND
DB_GOB_TempleAccess_Neighbours(_Disk, _Index, _OtherDisk)
AND
IntegerSum(_Index, 2, _NewIndex)
AND
IntegerModulo(_NewIndex, 4, _ModIndex)
AND
DB_GOB_TempleAccess_CurrentState(_OtherDisk, _ModIndex, _OldMoon)
THEN
NOT DB_GOB_TempleAccess_CurrentState(_OtherDisk, _ModIndex, _OldMoon);
DB_GOB_TempleAccess_CurrentState(_OtherDisk, _ModIndex, _NewMoon);

PROC
PROC_GOB_TempleAccess_FinishedRotation((ITEM)_Disk)
THEN
PROC_GOB_TempleAccess_DisksCanUse(1);

QRY
QRY_GOB_TempleAccess_AllDisksCorrect()
AND
NOT QRY_GOB_TempleAccess_AnyDiskWrong()
THEN
DB_NOOP(1);

QRY
QRY_GOB_TempleAccess_AnyDiskWrong()
AND
DB_GOB_TempleAccess_GoalState(_Disk, _TargetState)
AND
DB_GOB_TempleAccess_CurrentState(_Disk, _, _CurrentState)
AND
_TargetState != _CurrentState
THEN
DB_NOOP(1);

PROC
PROC_GOB_TempleAccess_FinishedRotation(_Disk)
AND
QRY_GOB_TempleAccess_AllDisksCorrect()
AND
DB_Players(_Player)
AND
IsInTrigger(_Player, S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1, 1)
AND
QRY_SpeakerIsAvailable(_Player, 1)
AND
QRY_OnlyOnce("GOB_TempleAccess_DoorWasOpened")
THEN
StartVoiceBark(GOB_TempleAccess_VB_SolvedPuzzle_d01f181a-617e-bc4b-2fd0-b1b8e7a9b986, _Player);

IF
DB_GOB_TempleAccess_DesiredPosition(1)
THEN
DB_OnlyOnce("GOB_TempleAccess_DoorWasOpened");
NOT DB_KnowledgeCheckTrigger_AD("GOB_TempleAccess_PuzzleApproach", TRIGGERGUID_S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1, "Investigation", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, DIALOGRESOURCEGUID_GOB_TempleAccess_PuzzleApproach_AD_b1cf463a-da1c-c6fd-00c6-b15387da8a98, GOB_TempleAccess_State_Puzzle_CheckMade_b5774b21-5d68-1480-7fc0-bd4bd28cb1fa);

PROC
PROC_GOB_TempleAccess_FinishedRotation(_Disk)
AND
QRY_GOB_TempleAccess_AllDisksCorrect()
THEN
PROC_GOB_TempleAccess_OpenDoor();
PROC_GOB_TempleAccess_SolvedPuzzleSound();

PROC
PROC_GOB_TempleAccess_SolvedPuzzleSound()
AND
IsLocked(ITEMGUID_S_GOB_TempleAccess_Door_7241f91d-e34f-4615-b484-3b338c109d55, 1)
AND
IsClosed(ITEMGUID_S_GOB_TempleAccess_Door_7241f91d-e34f-4615-b484-3b338c109d55, 1)
THEN
PlaySound(ITEMGUID_S_GOB_TempleAccess_Door_7241f91d-e34f-4615-b484-3b338c109d55, "SE_PUZ_GoblinTemple_Complete");

PROC
PROC_GOB_TempleAccess_OpenDoor()
AND
QRY_OnlyOnce("GOB_TempleAccess_DoorOpenReward")
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "HIDDEN_WLD_Boosters", "GOB_TempleAccess_Solved");

PROC
PROC_GOB_TempleAccess_OpenDoor()
THEN
SetFlag(GOB_TempleAccess_Event_PuzzleSolved_e48a7760-a5b2-4f2e-9e9c-52645d772bd3, NULL_00000000-0000-0000-0000-000000000000, 0);
Open(ITEMGUID_S_GOB_TempleAccess_Door_7241f91d-e34f-4615-b484-3b338c109d55);
SetPortalIsOpen(S_TempleAccess_RoomTrigger_30655ce6-8b68-442f-9f16-ee253fb49f55,1);
SetEntityEvent(ITEMGUID_S_GOB_TempleAccess_SconceHolder_c9efc370-7ed3-4c2e-a9b3-f2b5fc159b70, "StoryReveal");
TriggerUnregisterForPlayers(TRIGGERGUID_S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1);

PROC
PROC_GOB_TempleAccess_OpenDoor()
AND
IsLocked(S_GOB_TempleAccess_SconceHolder_c9efc370-7ed3-4c2e-a9b3-f2b5fc159b70, 1)
THEN
Unlock(ITEMGUID_S_GOB_TempleAccess_SconceHolder_c9efc370-7ed3-4c2e-a9b3-f2b5fc159b70);

PROC
PROC_GOB_TempleAccess_FinishedRotation(_Disk)
AND
DB_GOB_TempleAccess_Disk(_Disk)
AND
NOT QRY_GOB_TempleAccess_AllDisksCorrect()
THEN
Close(ITEMGUID_S_GOB_TempleAccess_Door_7241f91d-e34f-4615-b484-3b338c109d55);

IF
UseStarted(_, _Disk)
AND
DB_GOB_TempleAccess_Disk(_Disk)
AND
NOT DB_GlobalFlag((FLAG)GOB_TempleAccess_SconceHolderLockpicked_fce36e1c-ca39-48fc-b276-bfacde3663ed) // flagType: Global
AND
QRY_GOB_TempleAccess_DiskHasDifferentSymbols(_Disk) //Don't need to lock this if the disk has all the same symbols, as this is a null operation.
THEN
Lock(ITEMGUID_S_GOB_TempleAccess_SconceHolder_c9efc370-7ed3-4c2e-a9b3-f2b5fc159b70, "Act1_TempleAccess_PuzzleLock");

QRY
QRY_GOB_TempleAccess_DiskHasDifferentSymbols((ITEM)_Disk)
AND
DB_GOB_TempleAccess_CurrentState(_Disk, _, _State1)
AND
DB_GOB_TempleAccess_CurrentState(_Disk, _, _State2)
AND
_State1 != _State2
THEN
DB_NOOP(1);

IF
DualEntityEvent(_, _, "SHA_TempleAccess_Lever")
AND
NOT QRY_GOB_OpenTempleAccessDoor()
THEN
Close(ITEMGUID_S_GOB_TempleAccess_Door_7241f91d-e34f-4615-b484-3b338c109d55);

QRY
QRY_GOB_OpenTempleAccessDoor()
AND
IsOpened(IITEMGUID_S_GOB_TempleAccess_Door_7241f91d-e34f-4615-b484-3b338c109d55, 0)
THEN
SetFlag(GOB_TempleAccess_Event_PuzzleSolved_e48a7760-a5b2-4f2e-9e9c-52645d772bd3, NULL_00000000-0000-0000-0000-000000000000, 0);
Open(ITEMGUID_S_GOB_TempleAccess_Door_7241f91d-e34f-4615-b484-3b338c109d55);
SetPortalIsOpen(S_TempleAccess_RoomTrigger_30655ce6-8b68-442f-9f16-ee253fb49f55,1);
TriggerUnregisterForPlayers(TRIGGERGUID_S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1);

IF
UseStarted(_, S_SHA_TempleAccess_StairsDownstairs_3780fa8f-9257-4998-81c4-1b28c293b26e)
THEN
SetPortalIsOpen(S_TempleAccess_RoomTrigger_30655ce6-8b68-442f-9f16-ee253fb49f55, 1);
TriggerUnregisterForPlayers(TRIGGERGUID_S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1);


PROC
PROC_UND_TransitionCinematic_PassingTo(S_GOB_TempleAccess_TriggerUpstairs_67b88035-5a5c-4303-bf67-daa9b04497e5)
THEN
SetPortalIsOpen(S_TempleAccess_RoomTrigger_30655ce6-8b68-442f-9f16-ee253fb49f55, 1);
TriggerUnregisterForPlayers(TRIGGERGUID_S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1);

//END_REGION

//REGION Closing and opening the secret lever
IF
Unlocked(S_GOB_TempleAccess_SconceHolder_c9efc370-7ed3-4c2e-a9b3-f2b5fc159b70, _Character, _)
AND
_Character != NULL_00000000-0000-0000-0000-000000000000
THEN
SetFlag((FLAG)GOB_TempleAccess_SconceHolderLockpicked_fce36e1c-ca39-48fc-b276-bfacde3663ed, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
DB_GOB_TempleAccess_DesiredPosition(_Desired)
AND
DB_GOB_TempleAccess_DesiredPosition(_OldDesired)
AND
_Desired != _OldDesired
THEN
NOT DB_GOB_TempleAccess_DesiredPosition(_OldDesired);

//END_REGION


//REGION Debug

PROC
PROC_GOB_TempleAccess_DebugSolve()
THEN
SysClear("DB_GOB_TempleAccess_CurrentState", 3);

PROC
PROC_GOB_TempleAccess_DebugSolve()
AND
DB_GOB_TempleAccess_Disk(_Disk)
AND
DB_GOB_TempleAccess_DiskBones(_, _, _EffectID)
THEN
PROC_StopLoopEffect(_Disk, _EffectID);

PROC
PROC_GOB_TempleAccess_DebugSolve()
THEN
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 0, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 1, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 2, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk11_a8bd8016-7cc5-4a5a-92de-15613aebc266, 3, 2);

DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 0, 0);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 1, 0);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 2, 0);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk22_fca07efd-bd0c-4936-9e9d-2df2532864f7, 3, 0);

DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 0, 1);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 1, 1);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 2, 0);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk12_75ae740b-0cf0-411f-b49d-9d339711493c, 3, 2);

DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 0, 2);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 1, 0);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 2, 1);
DB_GOB_TempleAccess_CurrentState(ITEMGUID_S_GOB_TempleAccess_Disk21_242d119d-cb79-45d4-a394-b190f488fa22, 3, 1);

PROC
PROC_GOB_TempleAccess_DebugSolve()
THEN
PROC_GOB_TempleAccess_InitialEffects();
Open(ITEMGUID_S_GOB_TempleAccess_Door_7241f91d-e34f-4615-b484-3b338c109d55);
SetPortalIsOpen(S_TempleAccess_RoomTrigger_30655ce6-8b68-442f-9f16-ee253fb49f55,1);
TriggerUnregisterForPlayers(TRIGGERGUID_S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1);

//END_REGION

//REGION Once the players have read the more detailed lorebook, they no longer need pesky skill checks.

IF
FlagSet(SHA_TempleOfShar_Quest_ReadInstructionPaper_c52a5b36-9a3b-4c68-843b-bc5242436019, _, _)
THEN
NOT DB_KnowledgeCheckTrigger_AD("GOB_TempleAccess_PuzzleApproach", TRIGGERGUID_S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1, "Investigation", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, DIALOGRESOURCEGUID_GOB_TempleAccess_PuzzleApproach_AD_b1cf463a-da1c-c6fd-00c6-b15387da8a98, GOB_TempleAccess_State_Puzzle_CheckMade_b5774b21-5d68-1480-7fc0-bd4bd28cb1fa);

IF
DB_InRegion(_Player, TRIGGERGUID_S_GOB_TempleAccess_PuzzleApproach_AD_04cc41aa-0675-4c25-b5a7-5360f33a85a1)
AND
DB_GlobalFlag((FLAG)SHA_TempleOfShar_Quest_ReadInstructionPaper_c52a5b36-9a3b-4c68-843b-bc5242436019) // flagType: Global
AND
QRY_OncePerUserAndNearbyPlayers(_Player,"GOB_TempleAccess_InformedVB")
THEN
StartVoiceBark(VOICEBARKRESOURCEGUID_GOB_TempleAccess_PuzzleApproach_ReadInstructions_VB_e1f8165c-2e3c-08b3-bbfa-7c476c3a816a, _Player);

//END_REGION


//REGION Journal Logic
IF
GameBookInterfaceClosed(S_GOB_TempleAccess_Lorebook_283d7eff-f6e5-401f-852e-7ad7fb728b88, _Player)
AND
NOT DB_GOB_TempleAccess_ReadLorebook(1)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "ReadHalsinDiary", 1)
THEN
QuestUpdate(_Player, "SHA_Nightsong", "ReadAgedJournal");

IF
GameBookInterfaceClosed(S_GOB_TempleAccess_Lorebook_283d7eff-f6e5-401f-852e-7ad7fb728b88, _Player)
AND
NOT DB_GOB_TempleAccess_ReadLorebook(1)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "SawBook", 1)
THEN
QuestUpdate(_Player, "SHA_Nightsong", "ReadAgedJournal");

IF
GameBookInterfaceClosed(S_GOB_TempleAccess_Lorebook_283d7eff-f6e5-401f-852e-7ad7fb728b88, _Player)
AND
NOT DB_GOB_TempleAccess_ReadLorebook(1)
THEN
DB_GOB_TempleAccess_ReadLorebook(1);

IF
QuestUpdateUnlocked(_Player, "SHA_Nightsong", "ReadHalsinDiary")
AND
DB_GOB_TempleAccess_ReadLorebook(1)
THEN
QuestUpdate(_Player, "SHA_Nightsong", "ReadAgedJournal");

IF
QuestUpdateUnlocked(_Player, "SHA_Nightsong", "SawBook")
AND
DB_GOB_TempleAccess_ReadLorebook(1)
THEN
QuestUpdate(_Player, "SHA_Nightsong", "ReadAgedJournal");

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
