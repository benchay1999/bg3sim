Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION General
DB_Dialogs(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, GOB_WolfPens_Parent_003_f1f511b0-f7fb-f726-0b94-4038fc67982f);
DB_Dialogs(S_GOB_WolfPens_Kid_001_dff4432a-85b4-4d5c-95b5-6d1179dbabf4, GOB_WolfPens_Kid_001_63d481d8-85f2-3c53-c137-9ddb31056a4f);
DB_Dialogs(S_GOB_WolfPens_Kid_002_fc3116bd-4ed0-4246-a7db-64b3a0fd48d1, GOB_WolfPens_Kid_002_3fdfa3ff-8262-aafa-248a-2f5d64f3f063);
DB_Dialogs(S_GOB_WolfPens_Beastmaster_001_20383707-2661-4d72-bcba-3aa4b2cbb35b, GOB_WolfPens_Beastmaster001_9d672460-8ea6-e7e4-25e9-dc16c343a2bd);
DB_Dialogs(S_GOB_WolfPens_Beastmaster_002_1fadb35a-6996-4a6a-bd0d-e695b53a3a14, GOB_WolfPens_Beastmaster002_d0cc40d6-eb66-38ea-1e78-7083e83ef2d0);
DB_Dialogs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, GOB_WolfPens_HalsinsBear_AfterCombat_InCage_0a228bf7-fb12-c89b-4a31-b96505d9d783);

DB_GOB_WolfPens_LeversAndCages((ITEM)S_GOB_WolfPens_LeverForCage001_611d4226-459f-46a9-be08-697553271bd4, (ITEM)S_GOB_WolfPens_CageDoor_001_d29ec2f5-46c0-41cc-8fee-a259338f33ad);
DB_GOB_WolfPens_LeversAndCages(S_GOB_WolfPens_LeverForCage002_1022a47d-cfc3-4c40-91a8-5c8568b50639, S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e);

DB_GLO_DefeatCounter(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, "GOB_WolfPens_DefeatCounter");
DB_GLO_DefeatCounter(S_GOB_WolfPens_Beastmaster_001_20383707-2661-4d72-bcba-3aa4b2cbb35b, "GOB_WolfPens_DefeatCounter");
DB_GLO_DefeatCounter(S_GOB_WolfPens_Beastmaster_002_1fadb35a-6996-4a6a-bd0d-e695b53a3a14, "GOB_WolfPens_DefeatCounter");
DB_GLO_DefeatCounter(S_GOB_WolfPens_Worg_001_47ed5f19-5289-485a-a031-95f7f32ce5c8, "GOB_WolfPens_DefeatCounter");
DB_GLO_DefeatCounter(S_GOB_WolfPens_Worg_002_f3dbcf5d-c3f5-46bc-8401-782f731a3de8, "GOB_WolfPens_DefeatCounter");
DB_GLO_DefeatCounter(S_GOB_PrisonGuard_000_96f411f3-5849-4608-b6fa-b7fb6ffaa7d6, "GOB_WolfPens_DefeatCounter");

DB_GOB_WolfPens_Beastmasters((CHARACTER)S_GOB_WolfPens_Beastmaster_001_20383707-2661-4d72-bcba-3aa4b2cbb35b);
DB_GOB_WolfPens_Beastmasters(S_GOB_WolfPens_Beastmaster_002_1fadb35a-6996-4a6a-bd0d-e695b53a3a14);

DB_GOB_WolfPens_Reinforcement((CHARACTER)S_GOB_RaiderArrogant_43d953fa-575e-452c-b220-939e6bdcc36b, (TRIGGER)S_GOB_WolfPens_ReinforcementPosition_001_080fafa8-22b6-45a6-8635-9188f9939114, (TRIGGER)S_GOB_ReinforcementDestination_01_c761439f-14e1-4175-ade7-186c3e002ff8);
DB_GOB_WolfPens_Reinforcement(S_GOB_RaiderCunning_abdd3748-0834-46f3-8214-18dd4dca9d40, S_GOB_WolfPens_ReinforcementPosition_002_333d2ac3-9172-429f-85d8-16f745c71a16, S_GOB_ReinforcementDestination_02_c49eaa8e-bcef-4794-becd-0fc992cd1fad);
DB_GOB_WolfPens_Reinforcement(S_GOB_RaiderStupid_5d049dbe-ff35-45be-88f9-5f999dc0ffe4, S_GOB_WolfPens_ReinforcementPosition_003_85abeba8-2d34-4b88-bfff-6c24ad85c11e, S_GOB_ReinforcementDestination_03_3cec1bbc-1032-4a4b-aee6-42fafd5b68c0);

// kid, warning dialog - plays when warning the reinforcement about the problem in the Wolf Pens
DB_GOB_WolfPens_Kids((CHARACTER)S_GOB_WolfPens_Kid_001_dff4432a-85b4-4d5c-95b5-6d1179dbabf4, (DIALOGRESOURCE)GOB_WolfPens_AD_Warning_11362a16-9d94-6bee-bbd2-a35bac9e4b05);
DB_GOB_WolfPens_Kids(S_GOB_WolfPens_Kid_002_fc3116bd-4ed0-4246-a7db-64b3a0fd48d1, GOB_WolfPens_AD_Warning_002_5f3c4ec9-f0cd-27a1-2d9f-7c545487ee46);

DB_ItemOwnerShipTriggers("WLD_Main_A", S_GOB_WolfPens_OwnershipTrigger_f1e91f3a-7c64-4d5f-82bf-9cc709f6d642, S_GOB_WolfPens_Beastmaster_001_20383707-2661-4d72-bcba-3aa4b2cbb35b);
DB_ItemOwnerShipClearItem("WLD_Main_A", S_GOB_WolfPens_Exit_67d8b37a-4e5e-4548-b35c-785b7f504038);

DB_AutoSaveTrigger(S_GOB_WolfPens_Autosave_d6427f0e-d33e-4551-9d5e-fae100eb1981);

TriggerRegisterForItems(S_GOB_WolfPens_SplatteringTrigger_80390dec-caa3-4e6b-b2bc-632525d95dee);
TriggerRegisterForCharacter((TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);

DB_CustomDialogRange(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 14);
DB_GOB_WolfPens_Prisoner_BeforeCombatDialog((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_GroupDialogWithBear_2f6674c3-e4a8-7715-4ce5-d44261ad7c10);
DB_GOB_WolfPens_Prisoner_AfterCombatDialog((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_HalsinsBear_AfterCombat_InCage_0a228bf7-fb12-c89b-4a31-b96505d9d783);
DB_GOB_WolfPens_Prisoner_AfterCombatDialog_OutsideCage((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);
DB_GOB_WolfPens_Prisoner_AfterReleaseDialog((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_AfterRelease_Bear_74de2e20-e083-50ab-81e3-92c06906d170);
DB_GOB_WolfPens_Prisoner_SceneInterruptionCombatFlags((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (FLAG)GOB_WolfPens_State_BearEnraged_9b6a106b-6431-42b9-8ac1-48ba2a79e46b);

PROC_TriggerRegisterForPlayers(S_GOB_WolfPens_MainDialogTrigger_fdbf663a-8d8c-4037-9e1f-128a1f1f6d3b);

DB_GlobalFlagReactionAfterDialog((FLAG)GOB_WolfPens_Event_DoorAttackedInCinematic_f69d26a9-48e8-4b82-8f21-59ecf0ee5b90, GOB_WolfPens_GroupDialogWithBear_2f6674c3-e4a8-7715-4ce5-d44261ad7c10);
DB_GlobalFlagReactionAfterDialog((FLAG)GOB_WolfPens_Event_DoorAttackedInCinematic_f69d26a9-48e8-4b82-8f21-59ecf0ee5b90, GOB_WolfPens_CombatCutscene_Bear_97680fca-99e9-2fa7-5282-48e386e03423);
DB_GlobalFlagReactionAfterDialog((FLAG)GOB_WolfPens_Event_PersuadedToReleasePrisoner_e49112a6-09e1-4a0a-95cc-0e6c8097b2be, GOB_WolfPens_GroupDialogWithBear_2f6674c3-e4a8-7715-4ce5-d44261ad7c10);
DB_GlobalFlagReactionAfterDialog((FLAG)GOB_WolfPens_Event_HalsinLeftParty_c67822f6-a2f4-4d22-94c2-0824f2ac3f62, GOB_WolfPens_Halsin_Following_4c8c0646-03ab-6449-15be-a8a32a31da49);
DB_GlobalFlagReactionAfterDialog((FLAG)GOB_WolfPens_Event_HalsinLeftParty_c67822f6-a2f4-4d22-94c2-0824f2ac3f62, GOB_WolfPens_Halsin_Following_Elf_26317dd0-f609-1b72-27d0-602d4b3e1013);
DB_GlobalFlagReactionAfterDialog((FLAG)GOB_WolfPens_Event_HalsinLeavesGoblinCamp_a247e755-d8a0-4938-d122-d8ad9f48a674, GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);
DB_FlagReactionAfterDialog(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, (DIALOGRESOURCE)GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);
DB_Dialogs_DialogBlockRestoreMutingStatuses((DIALOGRESOURCE)GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);

DB_AddCharactersInTriggerToDialog(GOB_WolfPens_GroupDialogWithBear_2f6674c3-e4a8-7715-4ce5-d44261ad7c10, (TRIGGER)S_GOB_WolfPens_MainDialogTrigger_fdbf663a-8d8c-4037-9e1f-128a1f1f6d3b, 1, 0, 1);
DB_AddCharactersInTriggerToDialog(GOB_WolfPens_CombatCutscene_Bear_97680fca-99e9-2fa7-5282-48e386e03423, (TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6, 1, 0, 1);

DB_GOB_WolfPens_Prisoner_CombatCutscenes((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_CombatCutscene_Bear_97680fca-99e9-2fa7-5282-48e386e03423);
//END_REGION General

//REGION Flag for the cinematic (to show / not show the goblin parent)
DB_PermaDefeatedFlag(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, GOB_WolfPens_State_GoblinParentIsDead_5e4df0db-91cd-461e-b80e-a647afa36dec);
//END_REGION

//REGION Worgs protecting their cage
DB_GOB_WolfPens_Worgs((CHARACTER)S_GOB_WolfPens_Worg_001_47ed5f19-5289-485a-a031-95f7f32ce5c8);
DB_GOB_WolfPens_Worgs((CHARACTER)S_GOB_WolfPens_Worg_002_f3dbcf5d-c3f5-46bc-8401-782f731a3de8);
//END_REGION Worgs protecting their cage

//REGION Scene Handling
DB_SceneTriggerManager("GOB_WolfPens", (TRIGGER)S_GOB_WolfPens_MainDialogTrigger_fdbf663a-8d8c-4037-9e1f-128a1f1f6d3b, 0);
DB_SceneManager(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, "GOB_WolfPens");
DB_SceneManager(S_GOB_WolfPens_Kid_001_dff4432a-85b4-4d5c-95b5-6d1179dbabf4, "GOB_WolfPens");
DB_SceneManager(S_GOB_WolfPens_Kid_002_fc3116bd-4ed0-4246-a7db-64b3a0fd48d1, "GOB_WolfPens");
//END_REGION Scene Handling

DB_PermaDefeatedFlag(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, GLO_Halsin_State_PermaDefeated_86bc3df1-08b4-fbc4-b542-6241bcd03df1);
DB_GLO_CompoundFlag(GLO_Halsin_State_PermaDefeated_86bc3df1-08b4-fbc4-b542-6241bcd03df1, GOB_WolfPens_State_PrisonerPermaDefeated_a1bd5b3f-c4fe-4fac-b3b6-52367e97b545);

DB_OnlyOnce("GOB_WolfPens_DontReplaceBear");
PROC_GOB_WolfPens_Init();

DB_GOB_WolfPens_ExitPoints((ITEM)S_GOB_ThroneRoom_Door_Exit_7cfeb44e-e17e-44ea-b42e-b2a4a4fca58c);
DB_GOB_WolfPens_ExitPoints((ITEM)S_GOB_GoblinPriest_SecludedRoomDoor_685bbe73-b643-4096-aa70-a06875598218);
DB_GOB_WolfPens_ExitPoints((ITEM)S_GOB_GoblinPriest_SecludedRoom_DoorFromSpiders_b7393877-e52a-4eee-b922-ee4308210e3f);
DB_GOB_WolfPens_ExitPoints((ITEM)S_GOB_GoblinThrone_SecretEntrance_LadderFrom_1e4c968c-370c-4c8d-a074-ab227d85b28d);

DB_GOB_WolfPens_GoblinTempleTriggers((TRIGGER)S_GOB_ThroneRoom_SUB_bb81678b-641c-43fc-bd41-53295d59be03);
DB_GOB_WolfPens_GoblinTempleTriggers(S_GOB_PriestDungeon_SUB_d693268c-84c9-44c2-ac7d-11ebc5524764);
DB_GOB_WolfPens_GoblinTempleTriggers(S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6);

//REGION Reaction on Halsin escaping on his own
DB_GOB_WolfPens_Corpses((CHARACTER)S_GOB_WolfPens_Worg_001_47ed5f19-5289-485a-a031-95f7f32ce5c8, (TRIGGER)S_GOB_WolfPens_Corpses_Worg_001_387ff778-5012-46a7-a229-5cbb937e36b3);
DB_GOB_WolfPens_Corpses((CHARACTER)S_GOB_WolfPens_Worg_002_f3dbcf5d-c3f5-46bc-8401-782f731a3de8, (TRIGGER)S_GOB_WolfPens_Corpses_Worg_002_86a5ff1f-ba88-47c5-91b3-8b9ce0af2242);
DB_GOB_WolfPens_Corpses((CHARACTER)S_GOB_WolfPens_Beastmaster_001_20383707-2661-4d72-bcba-3aa4b2cbb35b, (TRIGGER)S_GOB_WolfPens_Corpses_Beastmaster_001_387ff778-5012-46a7-a229-5cbb937e36b3);
DB_GOB_WolfPens_Corpses((CHARACTER)S_GOB_WolfPens_Beastmaster_002_1fadb35a-6996-4a6a-bd0d-e695b53a3a14, (TRIGGER)S_GOB_WolfPens_Corpses_Beastmaster_002_aac24980-638e-4feb-8b2e-5eaeeddda387);
//END_REGION Reaction on Halsin escaping on his own

//REGION Remove red outlines for owned corpses/items
// Include offstage because the kids will run offstage
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A","Act1_GOB_WolfPens", (FACTION)ACT1_GOB_WolfPens_7adb52e1-1e4d-5312-3b0e-eb262d0a72e0, (TAG)PERMA_DEFEATED_OR_OFFSTAGE_b9e63705-637a-4d3b-87ef-a49324cf703f);
DB_FactionTagging_FactionTagged("WLD_Main_A",(FACTION)ACT1_GOB_WolfPens_Backup_805a2548-8ff2-464e-d975-b34e703f7825, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
//END_REGION

DB_IgnoreMutingStatussesDialog(GOB_WolfPens_CombatCutscene_Bear_97680fca-99e9-2fa7-5282-48e386e03423);

DB_DialogBlockAttackButton((DIALOGRESOURCE)GOB_WolfPens_GroupDialogWithBear_2f6674c3-e4a8-7715-4ce5-d44261ad7c10);
DB_DialogBlockTradeButton((DIALOGRESOURCE)GOB_WolfPens_GroupDialogWithBear_2f6674c3-e4a8-7715-4ce5-d44261ad7c10);
KBSECTION
//REGION Kill counter
PROC
PROC_GLO_DefeatCounter_AllDefeated("GOB_WolfPens_DefeatCounter")
THEN
SetFlag(GOB_WolfPens_State_Swept_fc032064-28cf-17cb-51bb-14ae6d8a85b6, NULL_00000000-0000-0000-0000-000000000000, 0);
//END_REGION Kill counter
 
//REGION Kids
// Goblin kids are not in DB_Children since we can kill them
IF
DB_GOB_WolfPens_Kids(_Kid, _)
THEN
TriggerRegisterForCharacter(S_GOB_WolfPens_KidsEscapeArea_684454aa-3632-442b-a48d-e0bca0d553bc, _Kid);
//END_REGION Kids

//REGION Worgs protecting their cage
IF
DB_GOB_WolfPens_Worgs(_Worg)
THEN
DB_SpotPlayers(_Worg, "GOB_WolfPens_Worgs", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(_Worg, "GOB_WolfPens_Worgs", S_GOB_WolfPens_Cage_001_9aea6349-9a8f-453d-ad86-fee65a820bdf);
TriggerRegisterForCharacter(S_GOB_WolfPens_Cage_001_9aea6349-9a8f-453d-ad86-fee65a820bdf, _Worg);
// Will allow the player to enter if the player joined them in combat against the prisoner
PROC
PROC_SpotPlayers_Spotted(_Worg, "GOB_WolfPens_Worgs", _Player)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_GOB_WolfPens_7adb52e1-1e4d-5312-3b0e-eb262d0a72e0, 0);

// this flag is used for setting the relation between the goblins and the player
// that is why we do not use it as StopSpotting flag in DB_SpotPlayers
// since DB_SpotPlayers clears the StopSpotting flags
IF
FlagSet((FLAG)GOB_WolfPens_Event_SidedWithGoblins_8887d64d-f76a-4410-b5a5-9f33f0362a64, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
PROC_SpotPlayers_StopSpotting(S_GOB_WolfPens_Worg_001_47ed5f19-5289-485a-a031-95f7f32ce5c8, "GOB_WolfPens_Worgs");
PROC_SpotPlayers_StopSpotting(S_GOB_WolfPens_Worg_002_f3dbcf5d-c3f5-46bc-8401-782f731a3de8, "GOB_WolfPens_Worgs");

IF
Opened(S_GOB_WolfPens_CageDoor_001_d29ec2f5-46c0-41cc-8fee-a259338f33ad)
AND
NOT DB_GlobalFlag((FLAG)GOB_WolfPens_Event_SidedWithGoblins_8887d64d-f76a-4410-b5a5-9f33f0362a64)
AND
NOT DB_GlobalFlag((FLAG)GOB_WolfPens_State_CombatInProgress_7253c9e4-4d4d-4cc1-a8b3-ba36b2e2c6ec)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_GOB_WolfPens_Worgs_2df5ac7c-486f-ad96-dabb-31cf3b26dc89, 0);
//END_REGION Worgs protecting their cage

//REGION Opening cages
IF
DualEntityEvent((CHARACTER)_Player, (ITEM)_Lever, "GOB_WolfPens_OpenCage")
AND
DB_GOB_WolfPens_LeversAndCages(_Lever, _CageDoor)
AND
IsDestroyed(_CageDoor, 0)
THEN
Unlock(_CageDoor);
Open(_CageDoor);

IF
DualEntityEvent((CHARACTER)_Player, (ITEM)_Lever, "GOB_WolfPens_CloseCage")
AND
DB_GOB_WolfPens_LeversAndCages(_Lever, _CageDoor)
AND
IsDestroyed(_CageDoor, 0)
THEN
Close(_CageDoor);
Lock(_CageDoor, "GOB_WolfPens");
//END_REGION Opening cages

//REGION Init
PROC
PROC_GOB_WolfPens_Init()
AND
QRY_OnlyOnce("GOB_WolfPens_Init")
THEN
PROC_GOB_WolfPens_Imprison(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_GLO_Halsin_SetupApplyWildshape(1);
SetTag(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
ApplyStatus(S_GOB_WolfPens_MeatPlaceholder_0c8ee3ad-4f89-49df-9ae6-1309482072ee, "INVULNERABLE_NOT_SHOWN", -1.0);
SetOnStage(S_GOB_WolfPens_MeatPlaceholder_0c8ee3ad-4f89-49df-9ae6-1309482072ee, 0);
PROC_CharacterDisableCrime(S_GOB_WolfPens_Worg_001_47ed5f19-5289-485a-a031-95f7f32ce5c8, "UseForbiddenItem");
PROC_CharacterDisableCrime(S_GOB_WolfPens_Worg_002_f3dbcf5d-c3f5-46bc-8401-782f731a3de8, "UseForbiddenItem");

IF
LevelGameplayStarted("WLD_Main_A", _)
AND
DB_GLO_Halsin_SetupApplyWildshape(1)
THEN
NOT DB_GLO_Halsin_SetupApplyWildshape(1);
PROC_GLO_Halsin_ApplyWildshape();

IF
DB_GLO_DefeatCounter(_Character, "GOB_WolfPens_DefeatCounter")
THEN
TriggerRegisterForCharacter(S_GOB_WolfPens_DoorDamageTrigger_35e21ace-d889-4239-a8bc-e1b12ea33b80, (CHARACTER)_Character);
//END_REGION Init

//REGION Imprisonment
PROC
PROC_GOB_WolfPens_Imprison((CHARACTER)_Character)
THEN
PROC_SelfHealing_Disable(_Character);
DB_GOB_WolfPens_Prisoner(_Character);
PROC_CharacterDisableAllCrimes(_Character, 1);
SetCanTrade(_Character, 0);
PROC_SetCanFight(_Character, 0);
SetCanJoinCombat(_Character, 0);
SetTag(_Character, IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);
DB_NoLowAttitudeDialog(_Character);
TriggerRegisterForCharacter(S_GOB_WolfPens_Cage_002_59104718-66ff-418a-b7ac-46696a1e2fc3, _Character);
DB_SceneManager(_Character, "GOB_WolfPens");
DB_SceneNoHostileContinuousDisturbance("GOB_WolfPens");
DB_PermaDefeatedFlag(_Character, GOB_WolfPens_State_PrisonerPermaDefeated_a1bd5b3f-c4fe-4fac-b3b6-52367e97b545);

PROC
PROC_GOB_WolfPens_RestorePrisonerParams((CHARACTER)_Prisoner)
THEN
PROC_SetCanFight(_Prisoner, 1);
SetCanJoinCombat(_Prisoner, 1);
NOT DB_NoLowAttitudeDialog(_Prisoner);
PROC_CharacterEnableAllCrimes(_Prisoner);
ClearTag(_Prisoner, IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);
TriggerUnregisterForCharacter(S_GOB_WolfPens_Cage_002_59104718-66ff-418a-b7ac-46696a1e2fc3, _Prisoner);
NOT DB_SceneManager(_Prisoner, "GOB_WolfPens");
NOT DB_SpotPlayers(_Prisoner, "GOB_WolfPens", NULL_00000000-0000-0000-0000-000000000000, GOB_WolfPens_Event_StopSpottingForMainDialog_33fceac3-40d9-4c55-b09c-2d7f17aab059);
PROC_SpotPlayers_ClearSpotTrigger(_Prisoner, "GOB_WolfPens");
//END_REGION Imprisonment

//REGION Scene interruption
IF
DB_SceneManager(_Character, "GOB_WolfPens")
THEN
DB_SpotPlayers(_Character, "GOB_WolfPens", NULL_00000000-0000-0000-0000-000000000000, GOB_WolfPens_Event_StopSpottingForMainDialog_33fceac3-40d9-4c55-b09c-2d7f17aab059);
DB_SpotPlayers_SpotTrigger(_Character, "GOB_WolfPens", S_GOB_WolfPens_AutoStartDialogTrigger_756da918-0270-4e27-b74c-3bfcf863bf1f);
DB_SpotPlayers_SpotTrigger(_Character, "GOB_WolfPens", S_GOB_WolfPens_Cage_002_59104718-66ff-418a-b7ac-46696a1e2fc3);

PROC 
PROC_SceneInterrupted(_NPC, _Player, "GOB_WolfPens", "Attacked")
THEN
PROC_GOB_WolfPens_SceneInterrupted(_NPC, _Player);

PROC 
PROC_SceneInterrupted(_NPC, _Player, "GOB_WolfPens", "Died")
AND
QRY_GOB_WolfPens_GoblinDiedInCinematic((CHARACTER)_NPC)
THEN
DB_NOOP(1);

PROC 
PROC_SceneInterrupted(_NPC, _Player, "GOB_WolfPens", "Died")
AND
NOT QRY_GOB_WolfPens_GoblinDiedInCinematic((CHARACTER)_NPC)
THEN
PROC_GOB_WolfPens_SceneInterrupted(_NPC, _Player);

QRY
QRY_GOB_WolfPens_GoblinDiedInCinematic((CHARACTER)_NPC)
AND
_NPC == S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0
AND
GetFlag((FLAG)GOB_WolfPens_Event_DoorAttackedInCinematic_f69d26a9-48e8-4b82-8f21-59ecf0ee5b90, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
DB_NOOP(1);

PROC 
PROC_SceneInterrupted(_NPC, _Player, "GOB_WolfPens", "EnteredCombat")
THEN
PROC_GOB_WolfPens_SceneInterrupted(_NPC, _Player);

PROC
PROC_SceneInterrupted(_Item, _Player, "GOB_WolfPens", "DestroyedItem")
AND
_Item == GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e
THEN
PROC_GOB_WolfPens_SceneInterrupted((CHARACTER)S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, _Player);

PROC
PROC_GOB_WolfPens_SceneInterrupted((GUIDSTRING)_NPC, (GUIDSTRING)_Player)
THEN
PROC_SceneOver("GOB_WolfPens");
PROC_GOB_WolfPens_StopMainSpotting();
PROC_GOB_WolfPens_SceneInterrupted_StartFight();
PROC_GOB_WolfPens_ForceCombat(_NPC, _Player);
PROC_GOB_WolfPens_SceneInterrupted_ForceStopDialog(_NPC);

PROC
PROC_GOB_WolfPens_ForceCombat((GUIDSTRING)_NPC, (GUIDSTRING)_Player)
AND
DB_GLO_DefeatCounter(_OtherNPC, "GOB_WolfPens_DefeatCounter")
AND
_OtherNPC != _NPC
AND
NOT DB_Defeated(_OtherNPC)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
THEN
PROC_EnterCombat(_OtherNPC, _Player);
PROC_EnterCombat(_OtherNPC, _Prisoner);

PROC
PROC_GOB_WolfPens_SceneInterrupted_ForceStopDialog((GUIDSTRING)_NPC)
THEN
PROC_ForceStopDialog(_NPC);

PROC
PROC_GOB_WolfPens_SceneInterrupted_StartFight()
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
THEN
PROC_SetCanFight(_Prisoner, 1);
SetCanJoinCombat(_Prisoner, 1);

PROC
PROC_GOB_WolfPens_SceneInterrupted_StartFight()
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
AND
DB_GOB_WolfPens_Prisoner_SceneInterruptionCombatFlags(_Prisoner, _Flag)
THEN
SetFlag(GOB_WolfPens_Event_SidedWithPrisoner_0c160e6c-0a72-4093-9e8c-3094962ef57a, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_WolfPens_StartFight();

IF
DialogStarted(_Dialog, _)
AND
DB_GOB_WolfPens_Prisoner_BeforeCombatDialog(_Prisoner, _Dialog)
THEN
PROC_GOB_WolfPens_StopMainSpotting();

IF
DialogEnded(_Dialog, _)
AND
DB_GOB_WolfPens_Prisoner_BeforeCombatDialog(_Prisoner, _Dialog)
AND
GetFlag(GOB_WolfPens_Event_PersuadedToReleasePrisoner_e49112a6-09e1-4a0a-95cc-0e6c8097b2be, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
PROC_SceneOver("GOB_WolfPens");

PROC
PROC_GOB_WolfPens_StopMainSpotting()
THEN
DB_GOB_WolfPens_MainSpottingStopped(1);

PROC
PROC_GOB_WolfPens_StopMainSpotting()
THEN
PROC_SpotPlayers_StopSpotting(S_GOB_WolfPens_Kid_001_dff4432a-85b4-4d5c-95b5-6d1179dbabf4, "GOB_WolfPens");
PROC_SpotPlayers_StopSpotting(S_GOB_WolfPens_Kid_002_fc3116bd-4ed0-4246-a7db-64b3a0fd48d1, "GOB_WolfPens");
PROC_SpotPlayers_StopSpotting(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, "GOB_WolfPens");

PROC
PROC_GOB_WolfPens_StopMainSpotting()
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
THEN
PROC_SpotPlayers_StopSpotting(_Prisoner, "GOB_WolfPens");
//END_REGION Scene interruption

//REGION Group dialog
PROC
PROC_SpotPlayers_Spotted(_Character, "GOB_WolfPens", _Player)
AND
NOT DB_GOB_WolfPens_MainSpottingStopped(1)
THEN
PROC_GOB_WolfPens_StartGroupDialogWithPrisoner(_Player, _Character);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)_Character, _Player)
AND
DB_InternPlayerSpot_Spotting(_Character, "GOB_WolfPens")
THEN
PROC_GOB_WolfPens_StartGroupDialogWithPrisoner((CHARACTER)_Player, _Character);

PROC
PROC_GOB_WolfPens_StartGroupDialogWithPrisoner((CHARACTER)_Player, (CHARACTER)_Character)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
AND
DB_GOB_WolfPens_Prisoner_BeforeCombatDialog(_Prisoner, _PrisonerDialog)
AND
DB_Dialogs(_Character, _DefaultDialog)
AND
QRY_StartDialog(_PrisonerDialog, 
S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0,
S_GOB_WolfPens_Kid_001_dff4432a-85b4-4d5c-95b5-6d1179dbabf4,
S_GOB_WolfPens_Kid_002_fc3116bd-4ed0-4246-a7db-64b3a0fd48d1,
_Prisoner,
_Player)
THEN
DB_NOOP(1);

QRY
QRY_DialogShouldIgnoreMutingStatusses((DIALOGRESOURCE)GOB_WolfPens_GroupDialogWithBear_2f6674c3-e4a8-7715-4ce5-d44261ad7c10, _, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_QRYRTN_DialogShouldIgnoreMutingStatusses(0)
THEN
NOT DB_QRYRTN_DialogShouldIgnoreMutingStatusses(0);
DB_QRYRTN_DialogShouldIgnoreMutingStatusses(1);

IF
DialogEnded((DIALOGRESOURCE)_Dialog, _)
AND
DB_GOB_WolfPens_Prisoner_BeforeCombatDialog(_, _Dialog)
THEN
PROC_GlobalSetFlagAndCache(GOB_WolfPens_State_MainDialogEnded_5dd5553d-8a15-583c-40e8-911d960a18d0);
//END_REGION Group dialog

//REGION Goblin Parent releases the prisoner
PROC
PROC_GlobalFlagReactionAfterDialog(GOB_WolfPens_Event_PersuadedToReleasePrisoner_e49112a6-09e1-4a0a-95cc-0e6c8097b2be)
THEN
PROC_GOB_WolfPens_PersuasionResult();

PROC
PROC_GOB_WolfPens_PersuasionResult()
THEN
Use(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, S_GOB_WolfPens_LeverForCage002_1022a47d-cfc3-4c40-91a8-5c8568b50639, "GOB_WolfPens_LeverUsed");
//END_REGION Goblin Parent releases the prisoner

//REGION Prisoners breaks out of the cage
// CINEMATIC FLOW
IF
FlagSet(GOB_WolfPens_Event_DoorAttackedInCinematic_f69d26a9-48e8-4b82-8f21-59ecf0ee5b90, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
SetOnStage(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, 0);

IF
FlagSet(GOB_WolfPens_Event_DoorAttackedInCinematic_f69d26a9-48e8-4b82-8f21-59ecf0ee5b90, NULL_00000000-0000-0000-0000-000000000000, _)
AND
IsInTrigger(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, S_GOB_WolfPens_DoorDamageTrigger_35e21ace-d889-4239-a8bc-e1b12ea33b80, 1)
AND
IsDead(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, 0)
THEN
DB_DialogDeath(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0);
Die(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1);
CreateSurface(S_GOB_WolfPens_SplatteringTrigger_80390dec-caa3-4e6b-b2bc-632525d95dee, "SurfaceBlood", 1.0, -1.0);

// NON-CINEMATIC FLOW
IF
AttackedBy(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, _Prisoner, _, _, _, _, _)
AND
DB_GOB_WolfPens_Prisoner((CHARACTER)_Prisoner)
THEN
PlaySound(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, "SE_GOB_PrisonDoor_Smashed_By_Halsin_Bear_01");
TimerLaunch("GOB_WolfPens_MoveDoor", 400);

IF
TimerFinished("GOB_WolfPens_MoveDoor")
THEN
ItemMoveTo(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, S_GOB_WolfPens_DoorEndPosition_c4452482-6976-453e-9f97-08d2ffe9b686, 15.0, 10.0, 0);

IF
ItemEnteredTrigger(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, S_GOB_WolfPens_SplatteringTrigger_80390dec-caa3-4e6b-b2bc-632525d95dee, _)
AND
IsInTrigger(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, S_GOB_WolfPens_DoorDamageTrigger_35e21ace-d889-4239-a8bc-e1b12ea33b80, 1)
AND
IsDead(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, 0)
THEN
Die(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1);
CreateSurface(S_GOB_WolfPens_SplatteringTrigger_80390dec-caa3-4e6b-b2bc-632525d95dee, "SurfaceBlood", 1.0, -1.0);

// the player gets 3d10 bludgeoning damage if they are in the splattering trigger
IF
ItemEnteredTrigger(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, S_GOB_WolfPens_SplatteringTrigger_80390dec-caa3-4e6b-b2bc-632525d95dee, _)
AND
DB_Players(_Player)
AND
IsInTrigger(_Player, S_GOB_WolfPens_DoorDamageTrigger_35e21ace-d889-4239-a8bc-e1b12ea33b80, 1)
AND
NOT DB_GlobalFlag(GOB_WolfPens_Event_DoorAttackedInCinematic_f69d26a9-48e8-4b82-8f21-59ecf0ee5b90)
AND
Random(10, _Rand)
AND
IntegerProduct(_Rand, 3, _Damage)
THEN
ApplyDamage(_Player, _Damage, "Bludgeoning", S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e);

IF
ItemEnteredTrigger(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, S_GOB_WolfPens_SplatteringTrigger_80390dec-caa3-4e6b-b2bc-632525d95dee, _)
AND
DB_GLO_DefeatCounter(_Character, "GOB_WolfPens_DefeatCounter")
AND
_Character != S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0
AND
IsInTrigger(_Character, S_GOB_WolfPens_DoorDamageTrigger_35e21ace-d889-4239-a8bc-e1b12ea33b80, 1)
AND
Random(10, _Rand)
AND
IntegerProduct(_Rand, 3, _Damage)
THEN
ApplyDamage(_Character, _Damage, "Bludgeoning", S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e);

IF
EnteredTrigger(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, S_GOB_WolfPens_DoorDamageTrigger_35e21ace-d889-4239-a8bc-e1b12ea33b80)
THEN
SetFlag(GOB_WolfPens_State_GoblinParentIsInPositionForCinematic_5b59e7e5-1a82-4add-860d-6a512961b4b3, NULL_00000000-0000-0000-0000-000000000000);

IF
LeftTrigger(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, S_GOB_WolfPens_DoorDamageTrigger_35e21ace-d889-4239-a8bc-e1b12ea33b80)
THEN
ClearFlag(GOB_WolfPens_State_GoblinParentIsInPositionForCinematic_5b59e7e5-1a82-4add-860d-6a512961b4b3, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_PermaDefeated(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0)
THEN
ClearFlag(GOB_WolfPens_State_GoblinParentIsInPositionForCinematic_5b59e7e5-1a82-4add-860d-6a512961b4b3);

IF
ItemEnteredTrigger(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, S_GOB_WolfPens_SplatteringTrigger_80390dec-caa3-4e6b-b2bc-632525d95dee, _)
THEN
SetOnStage(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, 0);

IF
WentOnStage(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, 0)
THEN
Die(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1);
//END_REGION Prisoners breaks out of the cage

//REGION Releasing the prisoner
IF
LeftTrigger(_Prisoner, S_GOB_WolfPens_Cage_002_59104718-66ff-418a-b7ac-46696a1e2fc3)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
THEN
ObjectTimerLaunch(_Prisoner, "GOB_WolfPens_PrisonerLeftCage", 1000);

IF
ObjectTimerFinished(_Prisoner, "GOB_WolfPens_PrisonerLeftCage")
THEN
SetFlag((FLAG)GOB_WolfPens_State_PrisonerLeftCage_4cd17a8b-7605-47c7-a13c-93821e68f177, _Prisoner);

IF
FlagSet(GOB_WolfPens_State_PrisonerLeftCage_4cd17a8b-7605-47c7-a13c-93821e68f177, (CHARACTER)_Prisoner, _)
AND
DB_GOB_WolfPens_Prisoner_AfterCombatDialog(_Prisoner, _InsideCageDialog)
AND
DB_GOB_WolfPens_Prisoner_AfterCombatDialog_OutsideCage(_Prisoner, _OutsideCageDialog)
THEN
PROC_GOB_WolfPens_StopMainSpotting();
PROC_SceneOver("GOB_WolfPens");
NOT DB_GOB_WolfPens_Prisoner_AfterCombatDialog(_Prisoner, _InsideCageDialog);
DB_GOB_WolfPens_Prisoner_AfterCombatDialog(_Prisoner, _OutsideCageDialog);
PROC_RemoveAllDialogEntriesForSpeaker(_Prisoner);
DB_Dialogs(_Prisoner, _OutsideCageDialog);
PROC_GOB_WolfPens_RestorePrisonerParams(_Prisoner);
PROC_GOB_WolfPens_CheckPrepareForAfterCombatDialog(_Prisoner);

// all goblins died before Halsin was released
PROC
PROC_GOB_WolfPens_CheckPrepareForAfterCombatDialog((CHARACTER)_Prisoner)
AND
DB_GlobalFlag((FLAG)GOB_WolfPens_State_Swept_fc032064-28cf-17cb-51bb-14ae6d8a85b6)
THEN
PROC_GOB_WolfPens_PrepareForAfterCombatDialog(_Prisoner);

IF
FlagSet(GOB_WolfPens_State_PrisonerLeftCage_4cd17a8b-7605-47c7-a13c-93821e68f177, _Prisoner, _ID)
AND
DB_GlobalFlag(GOB_WolfPens_State_BearEnraged_9b6a106b-6431-42b9-8ac1-48ba2a79e46b)
THEN
ClearFlag(GOB_WolfPens_State_BearEnraged_9b6a106b-6431-42b9-8ac1-48ba2a79e46b, NULL_00000000-0000-0000-0000-000000000000);

// prisoner left the cage after the main dialog, after killing the goblin
// relation to the player was setup in the main dialog
IF
FlagSet(GOB_WolfPens_State_PrisonerLeftCage_4cd17a8b-7605-47c7-a13c-93821e68f177, _Prisoner, _)
AND
NOT DB_GlobalFlag((FLAG)GOB_WolfPens_State_Swept_fc032064-28cf-17cb-51bb-14ae6d8a85b6)
AND 
NOT DB_GlobalFlag((FLAG)GOB_WolfPens_Event_PersuadedToReleasePrisoner_e49112a6-09e1-4a0a-95cc-0e6c8097b2be)
AND
DB_GlobalFlag((FLAG)GOB_WolfPens_State_MainDialogEnded_5dd5553d-8a15-583c-40e8-911d960a18d0)
THEN
PROC_GOB_WolfPens_StartFight();

// prisoner left the cage without the main dialog ending (maybe the player simply used the lever)
// prisoner is on the Player's side
IF
FlagSet(GOB_WolfPens_State_PrisonerLeftCage_4cd17a8b-7605-47c7-a13c-93821e68f177, _Prisoner, _)
AND
NOT DB_GlobalFlag((FLAG)GOB_WolfPens_State_Swept_fc032064-28cf-17cb-51bb-14ae6d8a85b6)
AND 
NOT DB_GlobalFlag((FLAG)GOB_WolfPens_Event_PersuadedToReleasePrisoner_e49112a6-09e1-4a0a-95cc-0e6c8097b2be)
AND
NOT DB_GlobalFlag((FLAG)GOB_WolfPens_State_MainDialogEnded_5dd5553d-8a15-583c-40e8-911d960a18d0)
THEN
SetFlag(GOB_WolfPens_Event_SidedWithPrisoner_0c160e6c-0a72-4093-9e8c-3094962ef57a);
PROC_GOB_WolfPens_StartFight();

// player convinced the goblin to release Halsin
IF
FlagSet(GOB_WolfPens_State_PrisonerLeftCage_4cd17a8b-7605-47c7-a13c-93821e68f177, _Prisoner, _)
AND
NOT DB_GlobalFlag((FLAG)GOB_WolfPens_State_Swept_fc032064-28cf-17cb-51bb-14ae6d8a85b6)
AND
DB_GlobalFlag((FLAG)GOB_WolfPens_Event_PersuadedToReleasePrisoner_e49112a6-09e1-4a0a-95cc-0e6c8097b2be)
THEN
PROC_GOB_WolfPens_TryStartAfterReleaseDialog();

PROC
PROC_GOB_WolfPens_TryStartAfterReleaseDialog()
AND
DB_Players(_Player)
AND
GetFlag(GOB_WolfPens_State_PersuadedToReleasePrisoner_5dd13aaf-6906-4aad-b4d5-0c187bc172b4, _Player, 1)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
AND
DB_GOB_WolfPens_Prisoner_AfterReleaseDialog(_Prisoner, _Dialog)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)_Dialog, _Prisoner, S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, _Player)
THEN
// by default Halsin joins the player if the player persuaded the goblin to release him, but Halsin can't start a dialog with him
SetFlag(GOB_WolfPens_Event_SidedWithPrisoner_0c160e6c-0a72-4093-9e8c-3094962ef57a, NULL_00000000-0000-0000-0000-000000000000);
PROC_SceneOver("GOB_WolfPens");
PROC_GOB_WolfPens_StartFight();

QRY
QRY_DialogShouldIgnoreMutingStatusses((DIALOGRESOURCE)GOB_WolfPens_AfterRelease_Bear_74de2e20-e083-50ab-81e3-92c06906d170, _, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_CantTalk_IgnoreStatuses(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_Is_EngineBlock_Talk(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_KnockedOut(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
NOT DB_QRYRTN_DialogShouldIgnoreMutingStatusses(0);
DB_QRYRTN_DialogShouldIgnoreMutingStatusses(1);

IF
DialogEnded((DIALOGRESOURCE)_Dialog, _)
AND
DB_GOB_WolfPens_Prisoner_AfterReleaseDialog(_, _Dialog)
THEN
PROC_SceneOver("GOB_WolfPens");
PROC_GOB_WolfPens_StartFight();
//END_REGION

//REGION Hostility Setup
PROC
PROC_GOB_WolfPens_StartFight()
THEN
PROC_GOB_WolfPens_UpdateWolfPensToPrisonerRelation();
PROC_GOB_WolfPens_UpdateWolfPensToPlayerRelation();
PROC_GOB_WolfPens_UpdatePrisonerToPlayerRelation();

PROC
PROC_GOB_WolfPens_UpdateWolfPensToPrisonerRelation()
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
AND
GetFaction(_Prisoner, _PrisonerFaction)
THEN
PROC_SetRelationMutual(_PrisonerFaction, ACT1_GOB_WolfPens_7adb52e1-1e4d-5312-3b0e-eb262d0a72e0, 0);

PROC
PROC_GOB_WolfPens_UpdateWolfPensToPlayerRelation()
AND
GetFlag((FLAG)GOB_WolfPens_Event_SidedWithGoblins_8887d64d-f76a-4410-b5a5-9f33f0362a64, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
PROC_SetRelationToPlayers(ACT1_GOB_WolfPens_7adb52e1-1e4d-5312-3b0e-eb262d0a72e0, 100);

PROC
PROC_GOB_WolfPens_UpdateWolfPensToPlayerRelation()
AND
GetFlag((FLAG)GOB_WolfPens_Event_SidedWithPrisoner_0c160e6c-0a72-4093-9e8c-3094962ef57a, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
PROC_SetRelationToPlayers(ACT1_GOB_WolfPens_7adb52e1-1e4d-5312-3b0e-eb262d0a72e0, 0);

PROC
PROC_GOB_WolfPens_UpdatePrisonerToPlayerRelation()
AND
GetFlag((FLAG)GOB_WolfPens_Event_SidedWithPrisoner_0c160e6c-0a72-4093-9e8c-3094962ef57a, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
AND
GetFaction(_Prisoner, _PrisonerFaction)
THEN
PROC_SetRelationToPlayers(_PrisonerFaction, 100);

// if the player decided to stay neutral - make the prisoner hostile
PROC
PROC_GOB_WolfPens_UpdatePrisonerToPlayerRelation()
AND
GetFlag((FLAG)GOB_WolfPens_Event_SidedWithPrisoner_0c160e6c-0a72-4093-9e8c-3094962ef57a, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
AND
IsInTrigger(_Prisoner, S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6, 1)
AND
GetFaction(_Prisoner, _PrisonerFaction)
THEN
PROC_SetRelationToPlayers(_PrisonerFaction, 0);
//END_REGION Hostility Setup

//REGION Combat - register the combat
IF
CombatStarted(_CombatID)
AND
DB_GLO_DefeatCounter(_Goblin, "GOB_WolfPens_DefeatCounter")
AND
DB_Is_InCombat((CHARACTER)_Goblin, _CombatID)
AND
NOT DB_GOB_WolfPens_CombatID(_CombatID)
THEN
DB_GOB_WolfPens_CombatID(_CombatID);
SetFlag(GOB_WolfPens_State_CombatInProgress_7253c9e4-4d4d-4cc1-a8b3-ba36b2e2c6ec, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(GOB_WolfPens_Event_StopSpottingForMainDialog_33fceac3-40d9-4c55-b09c-2d7f17aab059, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Combat - register the combat

//REGION Combat - summon the reinforcement
IF
DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
THEN
DB_GOB_WolfPens_ReinforcementBlocked(1);

IF
EnteredTrigger(_Kid, S_GOB_WolfPens_KidsEscapeArea_684454aa-3632-442b-a48d-e0bca0d553bc)
AND
DB_GOB_WolfPens_Kids(_Kid, _)
AND
IsInCombat(_Kid, 1)
THEN
SetCanJoinCombat(_Kid, 0);
LeaveCombat(_Kid);
PROC_CharacterMoveTo(_Kid, S_GOB_WolfPens_EntranceTrigger_8e107d0e-cb7d-44d7-b92a-19a5f2f9974a, "Run", "GOB_WolfPens_Event_WarnAdults");

IF
EntityEvent((CHARACTER)_Kid, "GOB_WolfPens_Event_WarnAdults")
AND
DB_GOB_WolfPens_Kids(_Kid, _WarningDialogue)
AND
DB_OnlyOnce("GOB_WolfPens_WarningReinforcement")
THEN
PROC_DisappearOutOfSight(_Kid, "Run", 1, "");

IF
EntityEvent((CHARACTER)_Kid, "GOB_WolfPens_Event_WarnAdults")
AND
DB_GOB_WolfPens_Kids(_Kid, _WarningDialogue)
AND
QRY_OnlyOnce("GOB_WolfPens_WarningReinforcement")
THEN
LookFromTrigger(_Kid, S_GOB_WolfPens_EntranceTrigger_8e107d0e-cb7d-44d7-b92a-19a5f2f9974a, 0);
PROC_TryStartAD(_WarningDialogue, _Kid);

IF
AutomatedDialogEnded(_WarningDialogue, _ID)
AND
DB_GOB_WolfPens_Kids(_Kid, _WarningDialogue)
THEN
PROC_DisappearOutOfSight(_Kid, "Run", 1, "");
PROC_GOB_WolfPens_SendReinforcement();
//END_REGION Combat - summon the reinforcement

//REGION Combat Ended resolution
IF
DB_Was_InCombat(_Character, _CombatID)
AND
DB_GOB_WolfPens_CombatID(_CombatID)
AND
IsCharacter(_Character, 1)
AND
NOT DB_Players((CHARACTER)_Character)
THEN
SetEntityEvent(_Character, "ClearPeaceReturn", 1);

IF
DB_Was_InCombat(_Character, _CombatID)
AND
DB_GOB_WolfPens_CombatID(_CombatID)
AND
IsCharacter(_Character, 1)
AND
DB_GOB_WolfPens_Beastmasters((CHARACTER)_Character)
AND
NOT DB_GOB_WolfPens_CommentedOnPrisoner(_Character)
THEN
SetEntityEvent(_Character, "GOB_WolfPens_CommentOnPrisonersBody");
DB_GOB_WolfPens_CommentedOnPrisoner(_Character);

// Sets up a scene if Halsin was killed was wildshaped
IF
CombatEnded(_CombatID)
AND
DB_GOB_WolfPens_CombatID(_CombatID)
AND
DB_GlobalFlag(GLO_Halsin_State_PermaDefeated_86bc3df1-08b4-fbc4-b542-6241bcd03df1)
AND
GetClosestAlivePlayer(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player, _Distance)
AND
_Distance < 20.0
AND
DB_Players((CHARACTER)_Player)
AND
QRY_StartDialog(GOB_WolfPens_HalsinDiedBearform_ec786e87-df01-1b5f-99cf-aab0ff9f3f72, _Player)
THEN
DB_NOOP(1);

IF
CombatEnded(_CombatID)
AND
DB_GOB_WolfPens_CombatID(_CombatID)
THEN
PROC_GOB_WolfPens_AfterCombat_PrepareAfterCombatDialog();
PROC_GOB_WolfPens_AfterCombat_ClearCombatDB(_CombatID);

PROC
PROC_GOB_WolfPens_AfterCombat_ClearCombatDB((GUIDSTRING)_CombatID)
THEN
ClearFlag(GOB_WolfPens_State_CombatInProgress_7253c9e4-4d4d-4cc1-a8b3-ba36b2e2c6ec, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_WolfPens_Event_StopSpottingForMainDialog_33fceac3-40d9-4c55-b09c-2d7f17aab059, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GOB_WolfPens_CombatID(_CombatID);

// combat might end before the flag Swept is set
PROC
PROC_GOB_WolfPens_AfterCombat_PrepareAfterCombatDialog()
AND
DB_GlobalFlag((FLAG)GOB_WolfPens_State_Swept_fc032064-28cf-17cb-51bb-14ae6d8a85b6)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
THEN
PROC_GOB_WolfPens_PrepareForAfterCombatDialog(_Prisoner);

// or flag might be set before the combat is over (reinforcement could be still alive)
IF
FlagSet(GOB_WolfPens_State_Swept_fc032064-28cf-17cb-51bb-14ae6d8a85b6, _, _)
AND
NOT DB_GOB_WolfPens_CombatID(_)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
THEN
PROC_GOB_WolfPens_PrepareForAfterCombatDialog(_Prisoner);

// Halsin does not react on crimes other than Assault while in Wolf Pens
PROC
PROC_GOB_WolfPens_PrepareForAfterCombatDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
PROC_CharacterDisableAllCrimes(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
PROC_CharacterEnableCrime(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "Assault");

PROC
PROC_GOB_WolfPens_PrepareForAfterCombatDialog((CHARACTER)_Prisoner)
AND
NOT DB_Is_InCombat(_Prisoner, _)
AND
NOT QRY_GOB_WolfPens_Imprisoned()
AND
IsInTrigger(_Prisoner, S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6, 1)
AND
NOT DB_OnlyOnce("GOB_WolfPens_PrepareForAfterCombatDialog")
THEN
DB_OnlyOnce("GOB_WolfPens_PrepareForAfterCombatDialog");
PROC_CharacterRegisterCrime(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "GOB_WolfPens_EscapedPrisoner", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_GLO_Halsin_RemoveWildshape();
SetFlag(GLO_Halsin_Knows_IsFound_a0d83476-e2d0-4972-a76b-b23c39078cd7, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GLO_Halsin_WildshapeRemoved()
AND
DB_OnlyOnce("GOB_WolfPens_PrepareForAfterCombatDialog")
AND
IsInTrigger(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6, 1)
AND
QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
AND
NOT DB_PermaDefeated(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_Is_InCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _)
AND
QRY_OnlyOnce("GOB_WolfPens_RestoreHpAfterFight")
THEN
UseSpell(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "Target_GOB_WolfPens_HalsinCureWounds", S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, NULL_00000000-0000-0000-0000-000000000000);

IF
CastedSpell(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "Target_GOB_WolfPens_HalsinCureWounds", _, _, _)
THEN
PROC_SelfHealing_Enable((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_SpotPlayers_IncludeWildshapedPlayers(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "GOB_WolfPens_Prisoner");
DB_SpotPlayers(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "GOB_WolfPens_Prisoner", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
CastSpellFailed(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "Target_GOB_WolfPens_HalsinCureWounds", _, _, _)
THEN
PROC_SelfHealing_Enable((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_SpotPlayers_IncludeWildshapedPlayers(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "GOB_WolfPens_Prisoner");
DB_SpotPlayers(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "GOB_WolfPens_Prisoner", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_Prisoner, "GOB_WolfPens_Prisoner", _Player)
AND
QRY_GLO_SelectFavouredSpeaker_SingleTag((GUIDSTRING)_Player, _Prisoner, (TAG)AVATAR_306b9b05-1057-4770-aa17-01af21acd650, 1)
AND
DB_QRYRTN_GLO_SelectFavouredSpeaker(_Speaker)
AND
DB_GOB_WolfPens_Prisoner_AfterCombatDialog(_Prisoner, _PrisonerDialog)
AND
QRY_StartDialog(_PrisonerDialog, _Prisoner, _Speaker)
THEN
RemoveHarmfulStatuses(_Prisoner);
RemoveSurfaceLayer(_Prisoner, "Ground", 2.0);
RemoveSurfaceLayer(_Prisoner, "Cloud", 2.0);
RemoveStatus(_Prisoner, "BLEEDING");
RemoveStatus(_Prisoner, "BURNING");
RemoveHarmfulStatuses(_Speaker);
RemoveSurfaceLayer(_Speaker, "Ground", 2.0);
RemoveSurfaceLayer(_Speaker, "Cloud", 2.0);
RemoveStatus(_Speaker, "BLEEDING");
RemoveStatus(_Speaker, "BURNING");

// in case player initiates the conversation while stealthing
IF
DialogStarted(_Dialog, _ID)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
AND
DB_GOB_WolfPens_Prisoner_AfterCombatDialog(_Prisoner, _Dialog)
THEN
PROC_SpotPlayers_StopSpotting(_Prisoner, "GOB_WolfPens_Prisoner");

//END_REGION Combat Ended resolution

//REGION clearing the db after the prisoner leaves the area
IF
LeftTrigger(_Prisoner, S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
AND
DB_GOB_WolfPens_Prisoner(_Prisoner)
THEN
NOT DB_GOB_WolfPens_Prisoner(_Prisoner);
//END_REGION clearing the db after the prisoner leaves the area

//REGION Reinforcement - activating the behavior
// After the player talked to one of them and they ended their group AD their 
// individual behavior is enabled
IF
DialogEnded(_Dialog, _)
AND
DB_Dialogs(_Character, _Dialog)
AND
DB_GOB_WolfPens_Reinforcement((CHARACTER)_Character, _, _)
AND
QRY_OnlyOnce("GOB_WolfPens_TalkedToReinforcement")
THEN
DB_NOOP(1);

IF
AutomatedDialogStarted(GOB_WoflPens_AD_BackupGroup_c5356a97-4bc1-a3a1-b72a-ab091f2a35f0, _)
AND
QRY_TriggerEvents_AnyPlayerInTrigger(S_GOB_WolfPens_BackupArea_4b78357e-a01c-4fca-aae4-47bc6c7ff6ab)
AND
QRY_OnlyOnce("GOB_WolfPens_ListenedToReinforcement")
THEN
DB_NOOP(1);

IF
DB_OnlyOnce("GOB_WolfPens_TalkedToReinforcement")
AND
DB_OnlyOnce("GOB_WolfPens_ListenedToReinforcement")
THEN
SetFlag(GOB_WolfPens_State_ReinforcementIntroduced_88e9d8d1-c9ca-4e28-905a-ed3c5f8d2573, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION  Reinforcement - activating the behavior

//REGION Reinforcement
// The three goblins outside the wolf pens will go inside only if they see a kid shouting 
// about the escaped prisoner
// after the fight is over they will comment on the body of the prisoner and return to their positions
PROC
PROC_GOB_WolfPens_SendReinforcement()
AND
NOT DB_GOB_WolfPens_ReinforcementBlocked(1)
AND
DB_GOB_WolfPens_Reinforcement(_Goblin, _, _NewPosition)
AND
NOT DB_Dead(_Goblin)
AND
GetCombatGroupID(_Goblin, _CombatGroupID)
AND
GetFaction(_Goblin, _Faction)
THEN
TriggerRegisterForCharacter(S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6, _Goblin);
SetFlag(GOB_BattleStations_State_BlockRunnerFlag_db41660e-85c9-4fab-aff2-79c61b73f8c5, _Goblin);
PROC_ForceStopDialog(_Goblin);
SetCombatGroupID(_Goblin, "");
DB_GOB_WolfPens_ReinforcementParams((CHARACTER)_Goblin, (STRING)_CombatGroupID, (FACTION)_Faction);
SetEntityEvent(_Goblin, "GOB_WolfPens_Alarmed");
PROC_CharacterMoveTo(_Goblin, _NewPosition, "Run", "GOB_WolfPens_ArrivedToWolfPens");
PROC_GOB_DrowCommander_ClearFromRaid(_Goblin);
DB_CorpseLooting_ClearRedOutlineOnFactionGroupTagged("WLD_Main_A", "Act1_GOB_WolfPens", _Faction, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
NOT DB_FactionTagging_FactionTagged("WLD_Main_A", _Faction, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);

IF
EntityEvent(_Goblin, "GOB_WolfPens_ArrivedToWolfPens")
THEN
SetCombatGroupID(_Goblin, "8b08fc36-919a-4dc1-a510-06667bd906d0");

IF
EnteredTrigger(_Goblin, S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
AND
DB_GOB_WolfPens_ReinforcementParams((CHARACTER)_Goblin, (STRING)_CombatGroupID, (FACTION)_Faction)
AND
QRY_TriggerEvents_AnyPlayerInTrigger(S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
THEN
RealtimeObjectTimerLaunch(_Goblin, "GOB_WolfPens_UpdateReinforcementFaction", 1000);

// faction change and them entering combat in the Wolf Pens might coincide
// small delay to prevent from asserting about setting and getting their faction
// at the same time
// need to change the faction because they might arrive after the player have already killed the Wolf Pens goblins
// and combat is over
IF
ObjectTimerFinished(_Goblin, "GOB_WolfPens_UpdateReinforcementFaction")
AND
IsInCombat(_Goblin, 0)
THEN
SetFaction(_Goblin, (FACTION)ACT1_GOB_WolfPens_7adb52e1-1e4d-5312-3b0e-eb262d0a72e0);

IF
LeftTrigger(_Goblin, S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
AND
DB_GOB_WolfPens_ReinforcementParams(_Goblin, _CombatGroupID, _Faction)
THEN
TriggerUnregisterForCharacter(S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6, _Goblin);
SetCombatGroupID(_Goblin, _CombatGroupID);
PROC_GOB_WolfPens_CheckRestoreReinforcementFaction(_Goblin, _Faction);
NOT DB_GOB_WolfPens_ReinforcementParams(_Goblin, _CombatGroupID, _Faction);
ClearFlag(GOB_BattleStations_State_BlockRunnerFlag_db41660e-85c9-4fab-aff2-79c61b73f8c5, _Goblin);

// we do not restore the faction for the goblins that participated in combat
PROC
PROC_GOB_WolfPens_CheckRestoreReinforcementFaction((CHARACTER)_Goblin, (FACTION)_Faction)
AND
NOT DB_GOB_WolfPens_DoNotRestoreFaction(_Goblin)
THEN
SetFaction(_Goblin, _Faction);

// the reinforcement goblins enter the combat before they arrive to their destination points,
// this prevents them from continuing running after combat is over
IF
EnteredCombat(_Goblin, _CombatID)
AND
DB_GOB_WolfPens_Reinforcement((CHARACTER)_Goblin, _, _)
AND
DB_GOB_WolfPens_CombatID(_CombatID)
THEN
DB_GOB_WolfPens_DoNotRestoreFaction((CHARACTER)_Goblin);
PROC_ClearStoryMove(_Goblin);

IF
EntityEvent((CHARACTER)_Goblin, "GOB_WolfPens_SendReinforcementBack")
AND
DB_GOB_WolfPens_Reinforcement(_Goblin, _DefaultPosition, _)
AND
NOT DB_CantMove(_Goblin)
THEN
PROC_CharacterMoveTo(_Goblin, _DefaultPosition, "Walk", "GOB_WolfPens_Event_ReinforcementReturned");

IF
EntityEvent((CHARACTER)_Goblin, "GOB_WolfPens_Event_ReinforcementReturned")
AND
DB_GOB_WolfPens_Reinforcement(_Goblin, _DefaultPosition, _)
THEN
LookFromTrigger(_Goblin, _DefaultPosition, 0);
//END_REGION Reinforcement

//REGION Combat Cutscene
//////// If the player interrupts the main scene then combat starts. During this combat the prisoner, on its turn, will try to break out of the cage
//////// It is done in a cutscene
IF
EntityEvent((CHARACTER)_Prisoner, "GOB_WolfPens_StartCombatCutscene")
AND
NOT DB_OnlyOnce("GOB_WolfPens_CombatCutsceneStarted")
AND
DB_GOB_WolfPens_CombatID(_CombatID)
AND
DB_GOB_WolfPens_Prisoner_CombatCutscenes(_Prisoner, _Dialog)
AND
GetClosestAlivePlayer(_Prisoner, _Player, _)
AND
NOT QRY_StartDialogCustom((DIALOGRESOURCE)_Dialog, _Prisoner, (CHARACTER)S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0, _Player, 0, 0, 0, 0)
THEN
SetFlag(GOB_WolfPens_State_CombatCutsceneHappened_54a81a88-e628-4820-a84f-b0a5603e459d, NULL_00000000-0000-0000-0000-000000000000); // this flag is set in the dialog if it succeeds

IF
DialogStarted(_Dialog, _ID)
AND
DB_GOB_WolfPens_Prisoner_CombatCutscenes(_Prisoner, _Dialog)
THEN
DB_OnlyOnce("GOB_WolfPens_CombatCutsceneStarted");
//END_REGION Combat Cutscene

//REGION Debug
IF
TextEvent("debug_testre1")
AND
DB_GOB_WolfPens_Reinforcement(_Goblin, _DefaultPosition, _)
THEN
PROC_CharacterMoveTo(_Goblin, _DefaultPosition, "Run", "");

IF
TextEvent("debug_testre2")
AND
DB_GOB_WolfPens_Reinforcement(_Goblin, _DefaultPosition, _)
THEN
SetEntityEvent(_Goblin, "GOB_WolfPens_CommentOnPrisonersBody");

IF
TextEvent("testlever")
THEN
PROC_GOB_WolfPens_PersuasionResult();

IF
TextEvent("send_reinf")
THEN
PROC_GOB_WolfPens_SendReinforcement();

IF
TextEvent("freehalsin")
THEN
DB_OnlyOnce("GOB_WolfPens_RestoreHpAfterFight");
PROC_GOB_WolfPens_HalsinForceBreakout();
TimerLaunch("GOB_WolfPens_FreeHalsinTeleport", 1000);

IF
TimerFinished("GOB_WolfPens_FreeHalsinTeleport")
THEN
PROC_TeleportPartiesTo((TRIGGER)S_GOB_WolfPens_AutoStartDialogTrigger_756da918-0270-4e27-b74c-3bfcf863bf1f, "");

IF
TextEvent("wp_doorsmash")
THEN
Attack((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, 1);
//END_REGION Debug

//REGION Halsin massacres the goblins
PROC
PROC_GOB_WolfPens_ClearWolfPens()
AND
DB_GLO_DefeatCounter(_Goblin, "GOB_WolfPens_DefeatCounter")
THEN
Die(_Goblin, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

PROC
PROC_GOB_WolfPens_ClearWolfPens()
AND
DB_GOB_WolfPens_Kids(_Kid, _)
THEN
Die(_Kid, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

PROC
PROC_GOB_WolfPens_ClearWolfPens()
AND
DB_GOB_WolfPens_Corpses(_Corpse, _Trigger)
THEN
TeleportTo(_Corpse, _Trigger);

PROC
PROC_GOB_WolfPens_ClearWolfPens()
THEN
DB_OneShotPlayerTrigger(S_GOB_WolfPens_Corpses_VB_1ea96bd4-1810-41b4-a9fa-66208559da82);

PROC
PROC_OneShotTriggerEntered(_Player, S_GOB_WolfPens_Corpses_VB_1ea96bd4-1810-41b4-a9fa-66208559da82)
THEN
StartVoiceBark(GOB_WolfPens_VB_Massacre_9688b41f-4ed2-f8b6-b36c-c24bec9dd8e5, _Player);

PROC
PROC_GOB_WolfPens_DestroyDoors()
THEN
Die(S_GOB_WolfPens_CageDoor_001_d29ec2f5-46c0-41cc-8fee-a259338f33ad, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1);
SetOnStage(S_GOB_WolfPens_CageDoor_002_19b032a0-e027-4524-96f9-1c0cd48d726e, 0); // the door dies when being set off stage in another place

PROC
PROC_GOB_WolfPens_TeleportHalsin()
THEN
TeleportTo(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, S_GOB_WolfPens_WaitingArea_3e29895c-5b0d-4b98-80be-a0e5fe324690, "");
//END_REGION Halsin massacres the goblins

//REGION Halsin

QRY
QRY_GOB_WolfPens_HalsinLeader()
AND
DB_QRYRTN_GOB_WolfPens_HalsinLeader(_Player)
THEN
NOT DB_QRYRTN_GOB_WolfPens_HalsinLeader(_Player);

QRY
QRY_GOB_WolfPens_HalsinLeader()
AND
CharacterGetOwner(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player)
AND
GetFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player, 1)
THEN
DB_QRYRTN_GOB_WolfPens_HalsinLeader(_Player);

QRY
QRY_GOB_WolfPens_HalsinLeader()
AND
NOT DB_QRYRTN_GOB_WolfPens_HalsinLeader(_)
AND
DB_GLO_Follower_Reassigning(_Follower, _, _Player)
AND
GetFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player, 1)
THEN
DB_QRYRTN_GOB_WolfPens_HalsinLeader(_Player);

IF
DB_PermaDefeated(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
QRY_GOB_WolfPens_HalsinLeader()
AND
DB_QRYRTN_GOB_WolfPens_HalsinLeader(_Player)
THEN
PROC_RemovePartyFollower(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
ClearFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player);

PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Player, GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59)
AND
NOT DB_GlobalFlag(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6)
THEN
DB_GOB_WolfPens_ApplyWildShape(1);
AddPartyFollower(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player);

IF
CharacterJoinedParty(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_GOB_WolfPens_ApplyWildShape(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_GOB_WolfPens_ApplyWildShape(1);
PROC_GLO_Halsin_ApplyWildshape();
PROC_GOB_WolfPens_GiveBearDialogue();

//Need to prevent Halsin from joining up with the players if leaders get killed as the player is recruiting Halsin as a follower.
PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Player, GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59)
AND
DB_GlobalFlag(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6)
THEN
SetFlag(GOB_WolfPens_State_HalsinHelpedToKillLeaders_f40ff780-3bad-7826-ef4b-06c9a29cb700, NULL_00000000-0000-0000-0000-000000000000);
DB_IgnoreMutingStatussesDialog(GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);
PROC_GOB_WolfPens_StartHalsinDialog(_Player);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)GOB_WolfPens_Event_HalsinLeftParty_c67822f6-a2f4-4d22-94c2-0824f2ac3f62)
AND
CharacterGetOwner(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player)
AND
GetFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player, 1)
THEN
PROC_GOB_WolfPens_Halsin_RemoveFromParty((CHARACTER)_Player);

IF
FlagSet(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player, _)
THEN
ClearFlag(GOB_WolfPens_Event_HalsinLeftParty_c67822f6-a2f4-4d22-94c2-0824f2ac3f62, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(GOB_WolfPens_State_HalsinIsInParty_7d95447a-3fd3-4ac9-851f-b817106d54ef, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagCleared(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player, _)
AND
NOT QRY_GOB_WolfPens_HalsinFollowsSomeone()
THEN
ClearFlag(GOB_WolfPens_State_HalsinIsInParty_7d95447a-3fd3-4ac9-851f-b817106d54ef, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_GOB_WolfPens_HalsinFollowsSomeone()
AND
DB_Players(_Player)
AND
GetFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player, 1)
THEN
DB_NOOP(1);

PROC
PROC_GLO_PostReassignFollowerHook(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (CHARACTER)_OldLeader, (CHARACTER)_NewLeader)
THEN
SetFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _NewLeader);
ClearFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _OldLeader);

IF
FlagSet(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9, NULL_00000000-0000-0000-0000-000000000000, _)
AND
CharacterGetOwner(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player)
AND
GetFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player, 1)
THEN
PROC_GOB_WolfPens_Halsin_RemoveFromParty((CHARACTER)_Player);
DB_IgnoreMutingStatussesDialog(GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);
PROC_GOB_WolfPens_StartHalsinDialog(_Player);

PROC
PROC_GOB_WolfPens_StartHalsinDialog((CHARACTER)_Player)
AND
QRY_StartDialog_Fixed(GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player)
THEN
DB_NOOP(1);

IF
FlagSet(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6, NULL_00000000-0000-0000-0000-000000000000, _)
AND
CharacterGetOwner(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player)
AND
GetFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player, 1)
AND
NOT DB_Is_InCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _)
THEN
PROC_GOB_WolfPens_Halsin_RemoveFromParty((CHARACTER)_Player);
DB_IgnoreMutingStatussesDialog(GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);
SetFlag(GOB_WolfPens_State_HalsinHelpedToKillLeaders_f40ff780-3bad-7826-ef4b-06c9a29cb700, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_WolfPens_StartHalsinDialog(_Player);

IF
FlagSet(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6, NULL_00000000-0000-0000-0000-000000000000, _)
AND
CharacterGetOwner(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player)
AND
DB_Is_InCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _CombatID)
THEN
DB_GOB_WolfPens_LeadersKilledInCombat((GUIDSTRING)_CombatID);

IF
FlagSet(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_GLO_Follower_Reassigning(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _, _Player)
AND
DB_Is_InCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _CombatID)
THEN
DB_GOB_WolfPens_LeadersKilledInCombat((GUIDSTRING)_CombatID);

IF
CombatEnded(_CombatID)
AND
QRY_GOB_WolfPens_HalsinLeader()
AND
DB_QRYRTN_GOB_WolfPens_HalsinLeader(_Player)
AND
DB_GOB_WolfPens_LeadersKilledInCombat(_CombatID)
THEN
PROC_GOB_WolfPens_Halsin_RemoveFromParty((CHARACTER)_Player);
SetFlag(GOB_WolfPens_State_HalsinHelpedToKillLeaders_f40ff780-3bad-7826-ef4b-06c9a29cb700, NULL_00000000-0000-0000-0000-000000000000);
DB_IgnoreMutingStatussesDialog(GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);
PROC_GOB_WolfPens_StartHalsinDialog(_Player);

//Blocking the player from leaving the region with Halsin in party
//PROC_BlockUseOfItem to block leaving via "Doors" & Portable Hole;
PROC
PROC_BlockUseOfItem(_OtherPlayer, _Item)
AND
DB_GOB_WolfPens_ExitPoints(_Item)
AND
QRY_GOB_WolfPens_HalsinLeader()
AND
DB_QRYRTN_GOB_WolfPens_HalsinLeader(_Player)
AND
QRY_GOB_WolfPens_HalsinNeedsToStopPlayer(_OtherPlayer, _Player)
THEN
DB_CustomUseItemResponse(_OtherPlayer, _Item, 0);
PROC_GOB_WolfPens_RemoveHalsinFromPartyAndStopPlayer(_Player);

QRY
QRY_REALLY_BlockFastTravel(_OtherPlayer)
AND
QRY_GOB_WolfPens_HalsinLeader()
AND
DB_QRYRTN_GOB_WolfPens_HalsinLeader(_Player)
AND
QRY_GOB_WolfPens_HalsinNeedsToStopPlayer(_OtherPlayer, _Player)
THEN
PROC_GOB_WolfPens_RemoveHalsinFromPartyAndStopPlayer(_Player);

PROC
PROC_GOB_WolfPens_RemoveHalsinFromPartyAndStopPlayer((CHARACTER)_Player)
THEN
SetFlag(GOB_WolfPens_Event_HalsinStoppedPlayer_87fc04cc-9152-47d8-a35d-5504e942c4a5, NULL_00000000-0000-0000-0000-000000000000);
DB_IgnoreMutingStatussesDialog(GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);
PROC_GOB_WolfPens_Halsin_RemoveFromParty(_Player);
PROC_GOB_WolfPens_Halsin_StartDialogAfterStoppingPlayer((CHARACTER)_Player);

QRY
QRY_GOB_WolfPens_HalsinNeedsToStopPlayer(NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)_HalsinOwner)
THEN
DB_NOOP(1);

QRY
QRY_GOB_WolfPens_HalsinNeedsToStopPlayer((CHARACTER)_Player, (CHARACTER)_HalsinOwner)
AND
_Player == _HalsinOwner
THEN
DB_NOOP(1);

QRY
QRY_GOB_WolfPens_HalsinNeedsToStopPlayer((CHARACTER)_Player, (CHARACTER)_HalsinOwner)
AND
_Player != _HalsinOwner
AND
IsInPartyWith(_HalsinOwner, _Player, 1)
AND
InSamePartyGroup(_HalsinOwner, _Player, 1)
THEN
DB_NOOP(1);

PROC
PROC_GOB_WolfPens_Halsin_StartDialogAfterStoppingPlayer((CHARACTER)_Player)
AND
QRY_StartDialog_Fixed(GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player)
THEN
DB_NOOP(1);
 
PROC
PROC_GOB_WolfPens_Halsin_RemoveFromParty((CHARACTER)_Player)
THEN
PROC_RemovePartyFollower(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
ClearFlag(GOB_WolfPens_State_HalsinIsFollowing_b6cb47ab-d002-0985-b378-d78f3c4ccd59, _Player);
PROC_GLO_Halsin_RemoveWildshape();
PROC_GOB_WolfPens_GiveHumanDialogue();

IF
StatusRemoved(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Status, _, _)
AND
DB_GLO_Halsin_WildshapeSpells(_Spell, _Status)
AND
IsPartyFollower((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1)
AND
HasActiveStatus(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Status, 0)
AND
DB_Dialogs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_Halsin_Following_4c8c0646-03ab-6449-15be-a8a32a31da49)
THEN
PROC_RemoveDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_Halsin_Following_Elf_26317dd0-f609-1b72-27d0-602d4b3e1013);

IF
StatusApplied(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Status, _, _)
AND
DB_GLO_Halsin_WildshapeSpells(_Spell, _Status)
AND
IsPartyFollower((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1)
AND
DB_Dialogs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_Halsin_Following_Elf_26317dd0-f609-1b72-27d0-602d4b3e1013)
THEN
PROC_RemoveDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_Halsin_Following_4c8c0646-03ab-6449-15be-a8a32a31da49);

PROC
PROC_GOB_WolfPens_GiveHumanDialogue()
THEN
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be);

PROC
PROC_GOB_WolfPens_GiveBearDialogue()
THEN
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_Halsin_Following_4c8c0646-03ab-6449-15be-a8a32a31da49);

QRY
QRY_DialogShouldIgnoreMutingStatusses((DIALOGRESOURCE)GOB_WolfPens_Halsin_Following_4c8c0646-03ab-6449-15be-a8a32a31da49, _, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_CantTalk_IgnoreStatuses(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_Is_EngineBlock_Talk((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_KnockedOut((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
NOT DB_QRYRTN_DialogShouldIgnoreMutingStatusses(0);
DB_QRYRTN_DialogShouldIgnoreMutingStatusses(1);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)GOB_WolfPens_Event_HalsinLeavesGoblinCamp_a247e755-d8a0-4938-d122-d8ad9f48a674)
THEN
PROC_GOB_WolfPens_HalsinForceLeaving();

IF
FlagSet(GLO_Halsin_State_PermaDefeated_86bc3df1-08b4-fbc4-b542-6241bcd03df1, NULL_00000000-0000-0000-0000-000000000000, _)
AND
NOT DB_GlobalFlag(GLO_Halsin_State_Returned_5af86099-47f9-ba69-199a-fe91292a41bd)
THEN
SetFlag(GLO_Halsin_State_DeadInGOB_268f1aa0-1ba9-43d4-bfba-6c507b8e88ab, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Halsin

//REGION Moving Halsin to the Grove
// If one player successfully defends the grove then several cases possible:
// 1. Halsin is still in prison, no players in the Wolf Pens - Halsin Breaks Out, then Leaves;
// 2. Halsin is in prison, there are players in the Wolf Pens
// 2.1. If they save him he asks them to defend the grove, they respond that it has already been saved, he Leaves after the dialog
// 2.2. If they leave without saving him - he Breaks Out, then Leaves
// 3. Halsin is in prison, waiting for the player to report back about the leaders / attack on Den; He just Leaves;
// 4.1. In addition we force leave Halsin if the Leaders are dead and the player leaves the inner part of the goblin camp after saving Halsin and telling him to wait
// 4.2. In addition we force leave Halsin if the Leaders are dead and the player leaves the inner part of the goblin camp without visiting Wolf Pens
// 	- However, it's fine if the player simply takes a long rest inside the Goblin Camp. That also leads to the player leaving the Temple (they go to the camp), but we don't want to break out Halsin in that case
//	- If the player, however, after a long rest doesn't return to the Goblin Temple, but goes somewhere else - then we break out Halsin
// 5. Halsin is in party with another player - impossible.
// 6. Players kill all three goblin leaders but then flee from combat
// nuance = DEN_AttackOnDen_State_DenVictory is set both when we kill the leaders inside the goblin camp and we defend the Groove
// that's why we checking if Raid was actually started
// 7. Sometimes the wildshape was failing and this makes sure Halsin still Wildshapes away after talking to him once all the leaders are dead if the leave proc failed before

//1.
IF
DB_GlobalFlag(DEN_AttackOnDen_State_RaidersAtDen_29f372ac-f9f1-4d54-bc9e-7eb493fa09d8)
AND
QRY_GOB_WolfPens_Imprisoned()
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
THEN
PROC_GOB_WolfPens_HalsinForceBreakoutAndLeaving();

//2.1
//We don't need to do anything here. When the situation in the Wolf Pens is resolved Halsin will auto-start his main dialog, thank the player for Saving the Groove and leave

//2.2
IF
LeftTrigger(_Player, S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
AND
DB_GlobalFlag(DEN_AttackOnDen_State_RaidersAtDen_29f372ac-f9f1-4d54-bc9e-7eb493fa09d8)
AND
QRY_GOB_WolfPens_Imprisoned()
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
THEN
PROC_GOB_WolfPens_HalsinForceBreakoutAndLeaving();

//3.

//Attack on Den
IF
DB_GlobalFlag(DEN_AttackOnDen_State_RaidersAtDen_29f372ac-f9f1-4d54-bc9e-7eb493fa09d8)
AND
NOT QRY_GOB_WolfPens_Imprisoned()
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
THEN
PROC_GOB_WolfPens_HalsinForceLeaving();

// 4.1
IF
LeftTrigger(_Player, _Trigger)
AND
DB_Players(_Player)
AND
DB_GOB_WolfPens_GoblinTempleTriggers(_Trigger)
AND
NOT QRY_GOB_WolfPens_Imprisoned()
AND
DB_GlobalFlag(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6)
THEN
TimerLaunch("GOB_WolfPens_MoveHalsin", 1000);

// 4.2
IF
LeftTrigger(_Player, _Trigger)
AND
DB_Players(_Player)
AND
DB_GOB_WolfPens_GoblinTempleTriggers(_Trigger)
AND
QRY_GOB_WolfPens_Imprisoned()
AND
DB_GlobalFlag(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6)
THEN
TimerLaunch("GOB_WolfPens_BreakMoveHalsin", 1000);

IF
FlagSet(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6, _, _)
AND
NOT QRY_GOB_AnyPlayerInGoblinTemple()
AND
QRY_GOB_WolfPens_Imprisoned()
THEN
PROC_GOB_WolfPens_HalsinForceBreakoutAndLeaving();

// Goblin Temple has 3 subregions, need to check all three at the same time
// to prevent Halsin from leaving too soon

// Player took a long rest inside the Goblin Temple (no players outside the Player Camp) - don't break out Halsin immediately
// We'll check where the player goes after the long rest
IF
TimerFinished("GOB_WolfPens_BreakMoveHalsin")
AND
NOT QRY_GOB_AnyPlayerInGoblinTemple()
AND
NOT QRY_GOB_WolfPens_AnyPlayerOutsidePlayerCamp()
THEN
DB_GOB_WolfPens_CheckBreakOutAfterLongRest(1);

// Player left the Goblin Temple and there are players outside the Player Camp (so, we aren't taking a long rest) break out Halsin immediately
IF
TimerFinished("GOB_WolfPens_BreakMoveHalsin")
AND
NOT QRY_GOB_AnyPlayerInGoblinTemple()
AND
QRY_GOB_WolfPens_AnyPlayerOutsidePlayerCamp()
AND
QRY_OnlyOnce("GOB_WolfPens_MoveHalsin")
THEN
PROC_GOB_WolfPens_HalsinForceBreakoutAndLeaving();

QRY
QRY_GOB_WolfPens_AnyPlayerOutsidePlayerCamp()
AND
DB_Players(_Player)
AND
NOT DB_InCamp(_Player)
THEN
DB_NOOP(1);

// If the player doesn't return to the Goblin Temple after a long rest - we break out Halsin
PROC
PROC_CAMP_LastPlayerLeftCamp()
AND
DB_GOB_WolfPens_CheckBreakOutAfterLongRest(1)
AND
NOT QRY_GOB_AnyPlayerInGoblinTemple()
AND
QRY_OnlyOnce("GOB_WolfPens_MoveHalsin")
THEN
PROC_GOB_WolfPens_HalsinForceBreakoutAndLeaving();

// If the player returns to the Goblin Temple after a long rest - we don't break out Halsin
PROC
PROC_CAMP_LastPlayerLeftCamp()
AND
DB_GOB_WolfPens_CheckBreakOutAfterLongRest(1)
AND
QRY_GOB_AnyPlayerInGoblinTemple()
THEN
NOT DB_GOB_WolfPens_CheckBreakOutAfterLongRest(1);

IF
TimerFinished("GOB_WolfPens_MoveHalsin")
AND
NOT QRY_GOB_AnyPlayerInGoblinTemple()
AND
QRY_OnlyOnce("GOB_WolfPens_MoveHalsin")
THEN
PROC_GOB_WolfPens_HalsinForceLeaving();

QRY
QRY_GOB_AnyPlayerInGoblinTemple()
AND
DB_GOB_WolfPens_GoblinTempleTriggers(_Trigger)
AND
QRY_TriggerEvents_AnyPlayerInTrigger(_Trigger)
THEN
DB_NOOP(1);

QRY
QRY_GOB_WolfPens_Imprisoned()
AND
GetFlag(GOB_WolfPens_State_PrisonerLeftCage_4cd17a8b-7605-47c7-a13c-93821e68f177, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0)
THEN
DB_NOOP(1);

PROC
PROC_GOB_WolfPens_HalsinForceBreakout()
THEN
DB_GOB_WolfPens_HalsinLeftOnHisOwn(1);
PROC_GlobalSetFlagAndCache(GOB_WolfPens_State_Swept_fc032064-28cf-17cb-51bb-14ae6d8a85b6);
PROC_GOB_WolfPens_ClearWolfPens();
PROC_GOB_WolfPens_DestroyDoors();
PROC_GOB_WolfPens_TeleportHalsin();
PROC_GLO_Halsin_RemoveWildshape();
SetFlag(GOB_WolfPens_State_PrisonerLeftCage_4cd17a8b-7605-47c7-a13c-93821e68f177, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);

IF
DialogActorLeft(_Dialog, _ID, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _)
AND
NOT DB_AutomatedDialog(_ID)
AND
DB_GOB_WolfPens_HalsinLeftOnHisOwn(1)
THEN
SetFlag(S_GOB_WolfPens_State_MetHalsinAfterPrisonBreak_3eceba95-a942-463a-9ad5-c19bdf1899c4, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GOB_WolfPens_HalsinLeftOnHisOwn(1);

PROC
PROC_GOB_WolfPens_HalsinForceLeaving()
AND
NOT DB_GlobalFlag(GOB_WolfPens_State_HalsinIsAggravated_12fa854c-00e0-4e33-87d0-a650a93b5769)
AND
QRY_OnlyOnce("GOB_WolfPens_HalsinForceLeaving")
THEN
PROC_ForceStopDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
CharacterStopCrime(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "GOB_WolfPens_EscapedPrisoner", NULL_00000000-0000-0000-0000-000000000000);
SetCanJoinCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0);
SetFlag(GOB_WolfPens_Event_SidedWithPrisoner_0c160e6c-0a72-4093-9e8c-3094962ef57a, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "WILDSHAPE_RAT", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "WILDSHAPE_RAT", _, _)
THEN
PROC_DisappearOutOfSight(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "Run", 1, "GLO_Halsin_LeftGoblinCamp");

PROC
PROC_GOB_WolfPens_HalsinForceBreakoutAndLeaving()
AND
QRY_OnlyOnce("GOB_WolfPens_HalsinForceBreakoutAndLeaving")
THEN
PROC_GOB_WolfPens_HalsinForceBreakout();
TimerLaunch("GOB_WolfPens_RemoveHalsin", 500);

IF
TimerFinished("GOB_WolfPens_RemoveHalsin")
THEN
PROC_GOB_WolfPens_HalsinForceLeaving();

//6. 
// Leaving Combat Edge Case
IF 
FleeFromCombat(_, _ID)
AND
DB_GlobalFlag(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6)
AND
DB_Is_InCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _ID)
AND
IsPartyFollower(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1)
THEN
DB_GLO_Halsin_ReadyForDen(1);

//7.
//For some reason the Rat Wildshape failed the first time, and players still talk to Halsin and get him to move on to camp
IF
DialogEnded(GOB_WolfPens_HalsinsBear_AfterCombat_00675ad1-8413-8548-7a91-77405b2860be, _)
AND
DB_GlobalFlag(GOB_WolfPens_Event_HalsinLeavesGoblinCamp_a247e755-d8a0-4938-d122-d8ad9f48a674)
AND
DB_OnlyOnce("GOB_WolfPens_HalsinForceLeaving") //checking that for some reason running this Proc before passed the QRY only once but still failed to complete all of its THEN block
THEN
PROC_ForceStopDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
CharacterStopCrime(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "GOB_WolfPens_EscapedPrisoner", NULL_00000000-0000-0000-0000-000000000000);
SetCanJoinCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0);
SetFlag(GOB_WolfPens_Event_SidedWithPrisoner_0c160e6c-0a72-4093-9e8c-3094962ef57a, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "WILDSHAPE_RAT", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION Moving Halsin to the Grove

//REGION Disabling dialogs while enraged
IF
FlagSet(GOB_WolfPens_State_BearEnraged_9b6a106b-6431-42b9-8ac1-48ba2a79e46b, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
SetHasDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0);

IF
FlagCleared(GOB_WolfPens_State_BearEnraged_9b6a106b-6431-42b9-8ac1-48ba2a79e46b, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
SetHasDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
//END_REGION Disabling dialogs while enraged

//REGION Edge cases for the feeding behavior 
IF
AddedTo(S_GOB_WolfPens_MeatPlaceholder_0c8ee3ad-4f89-49df-9ae6-1309482072ee, (CHARACTER)_Player, _)
AND
DB_Players(_Player)
THEN
SetFlag(GOB_WolfPens_State_MeatStolen_f36cdfde-171b-4010-bc92-8f9a0d6ae361, NULL_00000000-0000-0000-0000-000000000000);

IF
DestroyedBy(S_GOB_WolfPens_MeatPlaceholder_0c8ee3ad-4f89-49df-9ae6-1309482072ee, _, _, _)
THEN
SetFlag(GOB_WolfPens_State_MeatStolen_f36cdfde-171b-4010-bc92-8f9a0d6ae361, NULL_00000000-0000-0000-0000-000000000000);

IF
MovedBy(S_GOB_WolfPens_MeatPlaceholder_0c8ee3ad-4f89-49df-9ae6-1309482072ee, _Player)
AND
DB_Players(_Player)
THEN
SetFlag(GOB_WolfPens_State_MeatStolen_f36cdfde-171b-4010-bc92-8f9a0d6ae361, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Edge cases for the feeding behavior

//REGION Halsin's wildhshape in Wolf Pens
// Goblins in the Wolf Pens shouldn't react to him being a bear
QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "DangerousMonsterReactionFallback_Beast", _, _, _)
AND
DB_InRegion(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
THEN
DB_NOOP(1);

QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "DangerousMonsterReaction_Beast", _, _, _)
AND
DB_InRegion(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6)
THEN
DB_NOOP(1);
//END_REGION

//REGION Surprise Round
// If the player throws a rock at the bear, the bear smashes the cage door and attacks the player & goblins in the room
// They need to be surprised
IF
FlagSet((FLAG)GOB_WolfPens_Event_ThrewRock_9af39233-b6e9-4279-b3ca-d68163b240bc, _, _)
AND
DB_GOB_WolfPens_Beastmasters(_Goblin)
THEN
PROC_MakeSurprised(_Goblin);

IF
FlagSet((FLAG)GOB_WolfPens_Event_ThrewRock_9af39233-b6e9-4279-b3ca-d68163b240bc, _, _)
AND
DB_GOB_WolfPens_Kids(_Goblin, _)
THEN
PROC_MakeSurprised(_Goblin);

IF
FlagSet((FLAG)GOB_WolfPens_Event_ThrewRock_9af39233-b6e9-4279-b3ca-d68163b240bc, _, _)
AND
DB_GOB_WolfPens_Worgs(_Worg)
THEN
PROC_MakeSurprised(_Worg);

IF
FlagSet((FLAG)GOB_WolfPens_Event_ThrewRock_9af39233-b6e9-4279-b3ca-d68163b240bc, _, _)
THEN
PROC_MakeSurprised(S_GOB_WolfPens_Parent_6e4dd891-7bfe-4656-a9a0-ecf0916fd8f0);
PROC_MakeSurprised(S_GOB_PrisonGuard_000_96f411f3-5849-4608-b6fa-b7fb6ffaa7d6);

IF
FlagSet((FLAG)GOB_WolfPens_Event_ThrewRock_9af39233-b6e9-4279-b3ca-d68163b240bc, _, _)
AND
DB_PartyMembers(_PartyMember)
AND
IsInTrigger(_PartyMember, (TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6, 1)
THEN
PROC_MakeSurprised(_PartyMember);
//END_REGION

//REGION Block the dialog for the worgs when they are outside, as the dialog always show them inside the cage
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)_Worg, _Player)
AND
DB_GOB_WolfPens_Worgs(_Worg)
AND
NOT DB_InRegion(_Worg, S_GOB_WolfPens_Cage_001_9aea6349-9a8f-453d-ad86-fee65a820bdf)
THEN
DB_SelectedDialog(GEB_GOB_WolfPens_AD_WorgOutsideCage_e457f25b-5e1f-0f3d-73f1-4130f3215d5e, _Worg, _Player);
//END_REGION

//REGION Goal Completion
PROC
PROC_LevelLoadedOnce("BGO_Main_A")
THEN
GoalCompleted;
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
