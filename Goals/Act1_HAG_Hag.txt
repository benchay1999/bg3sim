Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_HAG_HagDoubles(S_HAG_HagAmbush_Hag_fb9cc235-398e-418d-a4a2-5da058fe7055,(FLAG)HAG_HagAmbush_Hag_State_InConversation_ad9e703a-2fa7-47d2-a623-a824bfd5f18c);

DB_Inclusion_Object(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(FLAG)HAG_Hag_Event_StartInclusion_fc3ad0c5-d5c4-d96b-be7b-8e4418606195,(FLAG)HAG_Hag_Event_EndInclusion_e267d8d3-75c3-3b8a-c790-14a952d92bf7);

//DB_SeenDeadNPCPartyFlag(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(FLAG)HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2); Doesn't work any more, as 
DB_DeadOnceFlag(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(FLAG)HAG_Hag_State_IsDead_781391e2-7d33-642d-28c0-e9b06cde32bb);
DB_PreventPermaDefeated(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_DoNotRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

Equip(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, S_HAG_Phylactery_e98f9aab-6e73-4c43-9f97-201d7447fc36);
DB_HasItemEvent(S_HAG_Phylactery_e98f9aab-6e73-4c43-9f97-201d7447fc36, HAG_Hag_State_HasPhylactery_d22103c4-b41f-4111-a3cf-f412396e04d7);

DB_DefeatedStateFlag(S_HAG_HagAmbush_Brother_001_767e2e80-b340-4e0f-9a6c-fd7df92d6e9e,(FLAG)HAG_Hag_Brother_001_State_IsDead_a1e1e9cc-4a79-fe57-2df9-0e0e7399350c);
DB_DefeatedStateFlag(S_HAG_HagAmbush_Brother_002_24c7e849-2ad6-414e-bc38-6ea3f358a80b,(FLAG)HAG_Hag_Brother_002_State_IsDead_0aece58b-c166-1182-7d76-f6dbb44bac0a);

// If brothers arrive and sister is dead, sister cannot participate in dialog
DB_HAG_Hagspawn_SurrogateMotherSpeaker(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

PROC_TriggerRegisterForPlayers(TRIGGERGUID_S_HAG_Hag_EnteredHomeArea_16b039c0-8f92-492a-974d-d15872fe6900);

//REGION Hag dialog state progression
//Hag is not yet in the swamp
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen",1);

// Initial scene
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","MayrinaTeaScene",10);
// Initial scene interrupted by brothers (-> go back to initial scene afterwards)
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","BrothersInterruptingMayrinaTeaScene",10);
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","AfterBrothersInterruptingMayrinaTeaScene",10);
// "Welcomed" by Hag after initial scene
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","WelcomeAfterTeaScene",20);
// Scene with bothers after initial scene
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","BrothersHouseScene",30);
// Side with hag in house against brothers
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","HouseSidedWithHag",32);
// Brothers' scene over
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","AfterBrothersHouseScene",35);
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","LairScene",100);
DB_State_Priority(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","AfterLairScene",200);

DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen");

DB_HAG_Hag_SceneSpeakers(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

DB_HAG_TriggerDialogStates("MayrinaTeaScene");
DB_HAG_TriggerDialogStates("LairScene");
//END_REGION


SetFlag((FLAG)HAG_HagAmbush_Brother_001_Present_f05e8220-d031-d959-4dd3-d5069b3cb6e9, S_HAG_HagAmbush_Brother_001_767e2e80-b340-4e0f-9a6c-fd7df92d6e9e); // flagType: Object
SetFlag((FLAG)HAG_HagAmbush_Brother_002_Present_23bfc6ea-ac3e-ac74-1b41-b2041f2a62c9, S_HAG_HagAmbush_Brother_002_24c7e849-2ad6-414e-bc38-6ea3f358a80b); // flagType: Object

//REGION Default spotting
DB_SpotPlayers_SpotTrigger((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag", S_HAG_HagHouse_fae45ba1-2da5-4ab7-b24b-8bf7539a3c64);
// Don't start spotting while the hag is in the Den
SetFlag((FLAG)HAG_Hag_Event_StopSpotting_bec6d572-cc9d-498f-8764-5aa60a80dc12, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_SpotPlayers_SpotEvent((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag", "HAG_Hag_Event_SpottedPlayer");
DB_SpotPlayers((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag", (FLAG)HAG_Hag_Event_StartSpotting_4606ad33-1fda-4e30-9c30-0011eda5aea4, (FLAG)HAG_Hag_Event_StopSpotting_bec6d572-cc9d-498f-8764-5aa60a80dc12);

//END_REGION


DB_SpotPlayers(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_Hag_SurrogateMother_Event_AfterFightSpotted",HAG_Hagspawn_SurrogateMother_Event_StartSpotting_ef9cdeb4-bf12-4893-a360-a3c4b3482b91,NULL_00000000-0000-0000-0000-000000000000);
PROC_SpotPlayers_StopSpotting(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_Hag_SurrogateMother_Event_AfterFightSpotted");

DB_GLO_CharacterCorpseDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, HAG_Hag_Dead_ce5651fe-84a8-598c-a98c-abd136055663);

DB_Inclusion_CombatInclusionDialog(DIALOGRESOURCEGUID_HAG_Hag_AD_TeleportSurrogateMother_d32494d4-0658-adb7-4433-82486e723607);

DB_Subregion(S_HAG_Swamp_SUB_5bd69370-6b30-4643-8b8f-412a2b837770, "HAG_Swamp_SUB", 1, 1);
DB_SubregionMarker(S_HAG_House_SUB_a54033ab-fc50-476b-99c6-5d6ad01bcf18, "HAG_HagHouse_SUB", "HAG_HagHouse", 10);
DB_ItemOwnerShipTriggers("WLD_Main_A", S_HAG_Hag_Ownership_562adca2-1807-4701-b3d5-d49112309e46, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_ItemOwnerShipClearItem("WLD_Main_A",DLC_DD_Painting_Portrait_Sebille_000_5b2b57cc-1c10-49f9-990f-6347060e11bb);

SetOnStage(S_HAG_Hag_HumanDouble_3f461909-81a2-825c-2365-5387db9121f9, 0);

DB_DangerZone((TRIGGER)S_HAG_HagLair_DangerZone_8e900990-2bf5-4c3e-b5bc-d2bb1c33d4af, "HAG_HagLair");

DB_Dialogs(S_HAG_Well_00e4f29c-0733-4050-982e-0c8c5f422ed1, HAG_Well_00363ae4-7092-b8a9-6b1f-0ef6a8726b66);

SetOnStage(S_HAG_Hag_InspirationAmulet_f3b1fff1-33c1-4283-8f02-84abfdc5e84e, 0);

ApplyStatus(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5, "HAG_CORPSEROOT", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

DB_HostileToPlayerGroupCancelFlag(HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c, GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e);

DB_DoNotFaceDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,HAG_Hagspawn_AD_HagSurrogateMotherStartScene_f0b0eeac-2db6-66f6-d910-0e704c238895);

//REGION Journals
//END_REGION
KBSECTION
//REGION Danger zone
IF
DB_HAG_HagLair_HagDefeatedFlags(_Flag)
THEN
DB_DangerZone_SafeOnGlobalFlagSet("HAG_HagLair", _Flag);
//END_REGION

//REGION The Hag is unavailable while one of her doubles is in conversation

IF
DB_HAG_HagDoubles(_Double,(FLAG)_Flag)
AND
DB_DialogNPCs(_, _Double, _)
THEN
SetFlag((FLAG)_Flag, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
DB_HAG_HagDoubles(_Double,(FLAG)_Flag)
AND
NOT DB_DialogNPCs(_, _Double, _)
THEN
ClearFlag((FLAG)_Flag, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

QRY
QRY_SelectCustomDialog(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Player)
AND
DB_HAG_HagDoubles(_Double,(FLAG)_Flag)
AND
DB_DialogNPCs(_, _Double, _)
THEN
DB_SelectedDialog(DIALOGRESOURCEGUID_HAG_Hag_AD_Occupied_5501f50d-4b10-cc59-2344-9227909185ff, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
DB_HAG_HagDoubles(_Double,_)
THEN
SetImmortal((CHARACTER)_Double,1);
SetCanTrade(_Double, 0);

IF
FlagSet(HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720, _, _) // flagType: Global
AND
DB_HAG_HagDoubles(_Double,(FLAG)_)
AND
NOT DB_PermaDefeated((CHARACTER)_Double)
AND
IsOnStage(_Double, 1)
THEN
PROC_RemoveDialog(_Double);
SetEntityEvent(_Double,"HAG_RemoveDouble");
//END_REGION


//REGION The hag can drop her illusion
IF
FlagSet(GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95, _, _) // flagType: Global
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_DISGUISE");
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_DISGUISE_DEN");
PROC_RemoveAllDialogEntriesForSpeaker(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetHasDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 0);

IF
FlagSet(GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95, _, _) // flagType: Global
AND
GetFlag(HAG_Hag_State_ReadyForLair_658c4d09-b278-42dd-8f72-b98ec3efd0d5, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
DB_Dialogs((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, HAG_Hag_Transformed_87f5b7b8-196e-b6d9-336e-288a969ba19c);

IF
DB_Is_InCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
AND
NOT DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
AND
NOT DB_OnlyOnce("HAG_FleeToLair")
AND
NOT DB_GlobalFlag((FLAG)HAG_ForestIllusion_Event_DropIllusion_c8a36ee5-68eb-a944-8295-55188d026506)
AND
NOT DB_HAG_ForestIllusion_ForestIllusionDialog(_)
THEN
PROC_RemoveDialog((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetFlag((FLAG)HAG_ForestIllusion_Event_DropIllusion_c8a36ee5-68eb-a944-8295-55188d026506);
DB_HAG_Hag_DroppedIllusionInCombat(_ID);
SetEntityEventReal(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "GLO_CombatWait", -1.0, 1);

IF
DB_Is_InCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
AND
NOT DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
AND
NOT DB_OnlyOnce("HAG_FleeToLair")
AND
DB_GlobalFlag((FLAG)HAG_ForestIllusion_Event_DropIllusion_c8a36ee5-68eb-a944-8295-55188d026506)
AND
DB_HAG_ForestIllusion_ForestIllusionDialog(_)
AND
NOT DB_DialogName((DIALOGRESOURCE)HAG_ForestIllusion_Illusioncheck_ad27b62d-9b83-dd71-4298-1a29a73b69bd, _)
AND
NOT DB_DialogRequestCache_DialogInstance((DIALOGRESOURCE)HAG_ForestIllusion_Illusioncheck_ad27b62d-9b83-dd71-4298-1a29a73b69bd, _)
AND
NOT DB_GlobalFlag((FLAG)GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95)
THEN
PROC_RemoveDialog((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetFlag((FLAG)GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95);
DB_HAG_Hag_DroppedIllusionInCombat(_ID);
SetEntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "GLO_CancelCombatWait", 1);

IF
LeftCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
AND
DB_HAG_Hag_DroppedIllusionInCombat(_ID)
THEN
SetEntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "GLO_CancelCombatWait", 1);

//Only summon pets if players are hostile to hag
IF
EnteredCombat(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Id)
AND
DB_Is_InCombat(_Player,_Id)
AND
QRY_IsPartyMember((CHARACTER)_Player,1)
AND
IsEnemy(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player,1)
THEN
DB_HAG_ForestIllusion_AnimalsJoinFight(_Id);

IF
EnteredCombat((CHARACTER)_Player,_Id)
AND
NOT DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
AND
NOT DB_OnlyOnce("HAG_FleeToLair")
AND
QRY_IsPartyMember(_Player, 1)
AND
DB_Is_InCombat(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Id)
AND
IsEnemy(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player,1)
THEN
DB_HAG_ForestIllusion_AnimalsJoinFight(_Id);

//Relation Change During Combat
IF
RelationChanged(_HagFaction,_PlayerFaction,0,_)
AND
DB_Is_InCombat(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Id)
AND
DB_Players(_AnyPlayer)
AND
GetFaction(_AnyPlayer, _PlayerFaction)
AND
NOT DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
AND
NOT DB_OnlyOnce("HAG_FleeToLair")
AND
GetFaction(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HagFaction)
AND
DB_Is_InCombat(_Character,_Id)
AND
GetFaction(_Character, _PlayerFaction) //Character is either the player or their summon (those inherit factions).
THEN
DB_HAG_ForestIllusion_AnimalsJoinFight(_Id);

IF
DB_Sees(_Player, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_GlobalFlag((FLAG)GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95) // flagType: Global
THEN
SetFlag((FLAG)GLO_Hag_Knows_HagIsHag_854188c2-4f14-7e49-7502-f63a98a1372e, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
DialogEnded((DIALOGRESOURCE)HAG_Hagspawn_StartScene_82f22190-3781-afef-dbff-8599905f5d69, _ID)
AND
DB_GlobalFlag((FLAG)HAG_Hag_Event_DropDisguise_30c887ff-c8b4-6442-dc43-4602df81d315)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
NOT QRY_StartDialog_Fixed(HAG_ForestIllusion_Illusioncheck_ad27b62d-9b83-dd71-4298-1a29a73b69bd, _Player, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
SetFlag((FLAG)HAG_ForestIllusion_Event_DropIllusion_c8a36ee5-68eb-a944-8295-55188d026506);
DB_HAG_ForestIllusion_IllusionCheckPlayer(_Player);

IF
DialogEnded((DIALOGRESOURCE)HAG_Hagspawn_StartScene_82f22190-3781-afef-dbff-8599905f5d69, _ID)
AND
DB_HAG_ForestIllusion_IllusionCheckPlayer(_Player)
THEN
NOT DB_HAG_ForestIllusion_IllusionCheckPlayer(_Player);

IF
FlagSet(GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95, _, _Id)
AND
_Id != 0
THEN
DB_HAG_Hag_State_TransformedDialog(_Id);

IF
DialogEnded(_, _Id)
AND
DB_HAG_Hag_State_TransformedDialog(_Id)
AND
DB_DialogPlayers(_Id, _Player, 1)
AND
GetFlag(HAG_Hag_Event_HostileToPlayersAfterDialog_18a04a5b-3d05-ecee-a55f-4affa337fa28, _Player, 0)
AND
NOT QRY_StartDialog_Fixed(HAG_Hag_Transformed_87f5b7b8-196e-b6d9-336e-288a969ba19c, (CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Player)
THEN
SetFlag(HAG_Hag_State_NotFirstTransformedDialog_cb1bbb3f-d54b-c02d-93e9-3995e7a00c9e, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION Flee to Lair

IF
DialogEnded((DIALOGRESOURCE)HAG_Hagspawn_StartScene_82f22190-3781-afef-dbff-8599905f5d69, _ID)
AND
DB_GlobalFlag((FLAG)HAG_ForestIllusion_Event_DropIllusion_c8a36ee5-68eb-a944-8295-55188d026506) //If the illusion isn't yet dropped and she turns hostile, the dialogue will go into IllusionCheck to show the dropping of the illusion.
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
GetFlag((FLAG)HAG_Hag_Event_HostileToPlayersAfterDialog_18a04a5b-3d05-ecee-a55f-4affa337fa28, _Player, 1)
THEN
ClearFlag(HAG_Hag_Event_HostileToPlayerGroupAfterDialog_18a04a5b-3d05-ecee-a55f-4affa337fa28, _Player, _ID);
DB_HostileToPlayerGroup((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, (CHARACTER)_Player);
PROC_EnterCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Player);

//If the dialogue was interrupted between the hostility flag being set and the transformation.
IF
DialogEnded((DIALOGRESOURCE)HAG_Hagspawn_StartScene_82f22190-3781-afef-dbff-8599905f5d69, _ID)
AND
NOT DB_GlobalFlag((FLAG)HAG_ForestIllusion_Event_DropIllusion_c8a36ee5-68eb-a944-8295-55188d026506)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_Event_DropDisguise_30c887ff-c8b4-6442-dc43-4602df81d315)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
GetFlag((FLAG)HAG_Hag_Event_HostileToPlayersAfterDialog_18a04a5b-3d05-ecee-a55f-4affa337fa28, _Player, 1)
THEN
ClearFlag(HAG_Hag_Event_HostileToPlayerGroupAfterDialog_18a04a5b-3d05-ecee-a55f-4affa337fa28, _Player, _ID);
DB_HostileToPlayerGroup((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, (CHARACTER)_Player);
PROC_EnterCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Player);

IF
DialogEnded((DIALOGRESOURCE)HAG_ForestIllusion_Illusioncheck_ad27b62d-9b83-dd71-4298-1a29a73b69bd,_ID)
AND
DB_Players(_Player) //On the off chance the character in the Illusioncheck is someone else than the one in the StartScene
AND
GetFlag((FLAG)HAG_Hag_Event_HostileToPlayersAfterDialog_18a04a5b-3d05-ecee-a55f-4affa337fa28, _Player, 1)
THEN
ClearFlag(HAG_Hag_Event_HostileToPlayerGroupAfterDialog_18a04a5b-3d05-ecee-a55f-4affa337fa28, _Player, _ID);
DB_HostileToPlayerGroup((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, (CHARACTER)_Player);
PROC_EnterCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Player);

IF
FlagSet(HAG_LairEntranceEvent_Event_DropIllusion_a5ec3b10-5876-4a19-8cc6-59fd8dc31982, _, _) // flagType: Global
THEN
PROC_HAG_ForestIllusion_ClearFireplaceIllusion();
SetOnStage(ITEMGUID_S_HAG_HagLairAccess_CrateIllusion_66b0ba70-059e-47ec-81c7-8434ab263f79, 0);
Open(S_DOORPROXY_HagFireplace_66ba8103-b253-46c7-b603-862a290a5aa0);
PROC_KnowledgeCheck_Clear(S_HAG_FireplaceIllusion_Box_1881d262-e0dc-44bf-b8a0-cabc5cc300ee);
PROC_RemoveDBTrespassTrigger((TRIGGER)S_HAG_Hag_TrespassNearLair_05b9a2b1-4272-4611-b2c9-58b47e098f2b, NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_HAG_Fireplace_e622c423-b381-4006-b539-55a7492f912f, "BURNING");

IF
TurnStarted(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_Is_InCombat(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_ID)
AND
QRY_CurrentCombatRoundIsGreaterThan(_ID,1)
AND
NOT DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c) // flagType: Global
AND
QRY_OnlyOnce("HAG_FleeToLair")
THEN
SetFlag((FLAG)GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetFlag((FLAG)HAG_Hag_State_ToLairBecauseCombat_256770d9-04b6-4cdb-92db-e14e30b2700d, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag((FLAG)HAG_Hag_State_ReadyForLair_658c4d09-b278-42dd-8f72-b98ec3efd0d5, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet((FLAG)HAG_Hag_State_ReadyForLair_658c4d09-b278-42dd-8f72-b98ec3efd0d5, _, _)
THEN
BlockNewCrimeReactions(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 1);

//Prevent having to handle Ethel in hag-form in her usual dialogues by always sending her to the lair if she dropped her illusion due to combat.
IF
DB_HAG_Hag_DroppedIllusionInCombat(_ID)
AND
NOT DB_Is_InCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
THEN
SetFlag((FLAG)HAG_Hag_State_ToLairBecauseCombat_256770d9-04b6-4cdb-92db-e14e30b2700d, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag((FLAG)HAG_Hag_State_ReadyForLair_658c4d09-b278-42dd-8f72-b98ec3efd0d5, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
EntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_LairEntrance_Event_IllusionDispelCast")
THEN
SetFlag((FLAG)HAG_LairEntranceEvent_Event_DropIllusion_a5ec3b10-5876-4a19-8cc6-59fd8dc31982, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
UseStarted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, S_HAG_HagLair_PortalToLair_b9e148b4-7b9b-45e5-bef4-f0673fffc93e)
THEN
TeleportTo(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, TRIGGERGUID_S_HAG_HagLair_ToTeaHouse_96663c68-8d9b-4793-ad30-89fd08efd77a, "HAG_Hag_HagEscape_PastBrambles", 0, 0, 0);

IF
UseStarted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, S_HAG_HagLair_PortalToLair_b9e148b4-7b9b-45e5-bef4-f0673fffc93e)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("HAG_Hag_AD_Fled")
AND
IsInTrigger(_Player, S_HAG_HagHouse_fae45ba1-2da5-4ab7-b24b-8bf7539a3c64, 1)
AND
QRY_SpeakerIsAvailable(_Player, 1)
THEN
StartVoiceBark(HAG_Hag_VB_Fled_af318438-815e-e3a0-8e01-9ecbb6aa9907, _Player);
DB_OnlyOnce("HAG_Hag_AD_Fled");

IF
EntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_HagEscape_PastBrambles")
THEN
CharacterMoveTo(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, TRIGGERGUID_S_HAG_HagLair_ToTeaHouse_96663c68-8d9b-4793-ad30-89fd08efd77a, "Run", "HAG_Hag_HagEscape_PastAtHatch");

IF
TextEvent("HAG_TestEscapeSequence")
THEN
SetFlag(HAG_LairEntranceEvent_Event_DropIllusion_a5ec3b10-5876-4a19-8cc6-59fd8dc31982, NULL_00000000-0000-0000-0000-000000000000, 0);
SetEntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_HagEscape_PastAtHatch");


IF
DB_GlobalFlag(HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c)
AND
DB_InRegion(_Player, S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07)
THEN
DB_OnlyOnce("HAG_HagSpawn_FledLair");
QuestUpdate(_Player, "HAG_HagSpawn", "EnteredLair");

IF
DB_GlobalFlag(HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c)
AND
DB_InRegion(_Player, TRIGGERGUID_S_HAG_Hag_EnteredHomeArea_16b039c0-8f92-492a-974d-d15872fe6900)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "HAG_HagSpawn", "EnteredLair", 0)
AND
GetFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
QRY_OnlyOnce("HAG_HagSpawn_FledLair")
THEN
QuestUpdate(_Player, "HAG_HagSpawn", "FledLair");

IF
DB_GlobalFlag(HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c)
AND
DB_InRegion(_Player, TRIGGERGUID_S_HAG_Hag_EnteredHomeArea_16b039c0-8f92-492a-974d-d15872fe6900)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "HAG_HagSpawn", "EnteredLair", 0)
AND
GetFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
QRY_OnlyOnce("HAG_HagSpawn_FledLair")
THEN
QuestUpdate(_Player, "HAG_HagSpawn", "FledLairWithoutMayrina");

IF
EntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_HagEscape_PastAtHatch")
AND
IsTagged(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, (TAG)ACT1_DEN_HAGTRADER_55fe3f63-d568-43d3-936e-b3984eed3cc3, 1) //The hag hasn't left the Den normally.
THEN
DB_CustomDialogRange(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 19);
SetImmortal(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 0);
NOT DB_IgnoreAssault((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetCanJoinCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 1);
SetOnStage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 1);
NOT DB_GLO_CompoundFlag((FLAG)DEN_HagTrader_Quest_Complete_b4a08056-e4cf-0835-a345-c52e523e7eda, (FLAG)DEN_HagTrader_State_LeaveDen_a203db46-2bac-4590-8d0b-13acafedc92e);
SetHitpointsPercentage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 100.0);
ClearTag(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, (TAG)ACT1_DEN_HAGTRADER_55fe3f63-d568-43d3-936e-b3984eed3cc3);

IF
EntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_HagEscape_PastAtHatch")
THEN
BlockNewCrimeReactions(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 0);
PROC_SpotPlayers_ClearSpotTrigger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag");
LeaveCombat(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
TeleportTo(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,TRIGGERGUID_HAG_Lair_HagSpot_fdd01e3a-b187-4109-8444-195574033955,"",1,1,1);
SetCanTrade(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 0);
SetFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetFlag((FLAG)HAG_Hag_Event_StartSpotting_4606ad33-1fda-4e30-9c30-0011eda5aea4, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 50);
PROC_State_Progress(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","LairScene");
DB_NoLowAttitudeDialog(CHARACTERGUID_S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
ApplyStatus(S_HAG_Fireplace_e622c423-b381-4006-b539-55a7492f912f, "BURNING", -1.0, 1, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
TriggerSetSoundState(Amb_SV_Hag_Lair_FZ_513adaab-3e65-4fee-ab08-762b78fd3df3, "Amb_SV_Hag_Alive_Dead", "Alive", 0);
TriggerSetSoundState(Amb_SV_Hag_Lair_Laboratory_FZ_0fc035a5-4cc8-464e-956c-95f92d2a715d, "Amb_SV_Hag_Alive_Dead", "Alive", 0);
PROC_SetCustomTradeTreasure(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Ethel");

IF
EntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_HagEscape_PastAtHatch")
AND
DB_GlobalFlag(HAG_Hag_State_ToLairBecauseCombat_256770d9-04b6-4cdb-92db-e14e30b2700d)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_HAG_Illusions_e7613afc-2775-22c5-9d37-e07a9bbea429, 0);

IF
DB_GlobalFlag(HAG_Hag_State_TeleportSurrogateMotherToLair_3da9b42e-a6e8-471f-9f12-87c2c8cf3885)
AND
NOT DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10)
AND
NOT DB_DialogNPCs(_, S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _)
THEN
PROC_HAG_SetupSurrogateMotherCage();
 
IF
DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c)
AND
NOT DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10)
THEN
DB_Dialogs((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, NULL_00000000-0000-0000-0000-000000000000, (DIALOGRESOURCE)HAG_Hagspawn_SurrogateMother_93854c48-68de-2a4f-c36e-36a24ab727b8);

IF
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c)
THEN
DB_Dialogs((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, NULL_00000000-0000-0000-0000-000000000000, (DIALOGRESOURCE)HAG_Hagspawn_SurrogateMother_93854c48-68de-2a4f-c36e-36a24ab727b8);

IF
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c)
THEN
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
SetHasDialog(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, 1);

//END_REGION

//REGION Register entering the house
IF
EnteredTrigger(_, TRIGGERGUID_S_HAG_Hag_EnteredHomeArea_16b039c0-8f92-492a-974d-d15872fe6900)
THEN
SetFlag((FLAG)HAG_Hag_EnteredHome_231cda70-853f-47e4-91b9-31f126b395ba, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
//END_REGION

//REGION Logic to decide when the Hag should spot and start a dialog

IF
DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea",_State)
AND
NOT DB_CantTalk((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
NOT DB_CantTalk((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hagspawn_State_InitialSceneDone_ddd2ea7d-9ffd-27b6-4b7d-e6cd90b9db56)
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag");
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "HAG_Hag");

IF
DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea",_State)
AND
DB_CantTalk((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hagspawn_State_InitialSceneDone_ddd2ea7d-9ffd-27b6-4b7d-e6cd90b9db56)
THEN
PROC_SpotPlayers_StopSpotting((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag");
PROC_SpotPlayers_StopSpotting((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "HAG_Hag");

IF
DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea",_State)
AND
DB_CantTalk((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hagspawn_State_InitialSceneDone_ddd2ea7d-9ffd-27b6-4b7d-e6cd90b9db56)
THEN
PROC_SpotPlayers_StopSpotting((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag");
PROC_SpotPlayers_StopSpotting((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "HAG_Hag");

IF
DialogEnded(DIALOGRESOURCEGUID_HAG_Hagspawn_StartScene_82f22190-3781-afef-dbff-8599905f5d69, _ID)
AND
NOT DB_DialogRequestFailed(DIALOGRESOURCEGUID_HAG_Hagspawn_StartScene_82f22190-3781-afef-dbff-8599905f5d69, _ID)
THEN
PROC_State_IfCurrentProgress(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","MayrinaTeaScene","WelcomeAfterTeaScene");
PROC_State_IfCurrentProgress(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","HouseSidedWithHag","WelcomeAfterTeaScene");

IF
DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HagTea", "WelcomeAfterTeaScene" )
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c)
AND
NOT DB_GlobalFlag((FLAG)GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95)
THEN
DB_Dialogs((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, NULL_00000000-0000-0000-0000-000000000000, (DIALOGRESOURCE)HAG_Hagspawn_StartScene_82f22190-3781-afef-dbff-8599905f5d69);

IF
TextEvent("HAG_HagRetreat")
THEN
SetHitpointsPercentage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,50.0);
ApplyDamage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1,"Piercing",NULL_00000000-0000-0000-0000-000000000000);

// Restart the dialog between the hag and the sister if the brothers interrupted
// (except if they left peacefully, then it's already handled in the dialog)
PROC
PROC_State_Changed(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea",_,_NewState)
AND
DB_HAG_TriggerDialogStates(_NewState)
THEN
PROC_HAG_Hag_SetUpForDialogSpotting();

//END_REGION

//REGION Hag spots someone and starts a dialog
PROC
PROC_HAG_Hag_SetUpForDialogSpotting()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_RemoveAllDialogEntriesForSpeaker(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
SetHasDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 1);
SetHasDialog(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, 1);

QRY
QRY_SelectCustomDialog((GUIDSTRING)_NPC, (GUIDSTRING)_Player)
AND
DB_HAG_Hag_SceneSpeakers(_NPC)
AND
NOT DB_PermaDefeated((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_Dead((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_GlobalFlag((FLAG)GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95)
AND
DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea",_State)
AND
DB_HAG_TriggerDialogStates(_State)
THEN
SetFlag((FLAG)HAG_Hag_Event_StopSpotting_bec6d572-cc9d-498f-8764-5aa60a80dc12, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
PROC_SpotPlayers_Spotted((CHARACTER)_NPC, "HAG_Hag", (CHARACTER)_Player, "HAG_Hag_Event_SpottedPlayer");

PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag", (CHARACTER)_Player, "HAG_Hag_Event_SpottedPlayer")
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c) // flagType: Global
AND
IsInTrigger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, S_HAG_HagHouse_fae45ba1-2da5-4ab7-b24b-8bf7539a3c64, 1)
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagHouse_fae45ba1-2da5-4ab7-b24b-8bf7539a3c64, 1)
AND
NOT QRY_StartDialogCustom(DIALOGRESOURCEGUID_HAG_Hagspawn_StartScene_82f22190-3781-afef-dbff-8599905f5d69, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Player, 0, 1, 1, 1)
THEN
SetFlag((FLAG)HAG_Hag_Event_StartSpotting_4606ad33-1fda-4e30-9c30-0011eda5aea4, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag", (CHARACTER)_Player, "HAG_Hag_Event_SpottedPlayer")
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c) // flagType: Global
AND
IsInTrigger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, S_HAG_HagHouse_fae45ba1-2da5-4ab7-b24b-8bf7539a3c64, 0)
THEN
PROC_TryStartAD((DIALOGRESOURCE)HAG_Hag_AD_Occupied_5501f50d-4b10-cc59-2344-9227909185ff, (CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_Character, "HAG_Hag", (CHARACTER)_Player, "HAG_Hag_Event_SpottedPlayer")
AND
_Character != S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(_Character, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
PROC_HAG_HagUnavailableDialog((CHARACTER)_Player);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_Character, "HAG_Hag", (CHARACTER)_Player, "HAG_Hag_Event_SpottedPlayer")
AND
_Character != S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Character)
THEN
PROC_HAG_HagUnavailableDialog((CHARACTER)_Player);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_Character, "HAG_Hag", (CHARACTER)_Player, "HAG_Hag_Event_SpottedPlayer")
AND
_Character != S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Character, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
PROC_SpotPlayers_Spotted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag", _Player, "HAG_Hag_Event_SpottedPlayer");

PROC
PROC_HAG_HagUnavailableDialog(_Player)
AND
QRY_StartDialogCustom(HAG_Hagspawn_SurrogateMother_AD_HagOccupied_f9a80aa8-9f34-1d1c-ee7c-20c4e4823b40, S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Player, 0, 1, 1, 0)
THEN
DB_NOOP(0);

PROC
PROC_HAG_HagUnavailableDialog((GUIDSTRING)_Player)
THEN
SetFlag((FLAG)HAG_Hag_Event_StartSpotting_4606ad33-1fda-4e30-9c30-0011eda5aea4, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

//END_REGION

//REGION Reward for accepting the deal
IF
FlagSet(HAG_Hag_Event_GiveInspirationTalisman_a7e73ff1-94e0-9745-fab6-34fd415d145c, _Player, _)
THEN
PROC_ToInventoryAndOnStage(S_HAG_Hag_InspirationAmulet_f3b1fff1-33c1-4283-8f02-84abfdc5e84e, _Player, -1, 1, 1);

IF
DialogEnded(HAG_Hag_Transformed_87f5b7b8-196e-b6d9-336e-288a969ba19c, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Tadpole", "HagTriedTadpoleHeal", 1)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
StartVoiceBark(HAG_Hag_VB_TadpoleDivine_97562b5e-ae71-2560-e1d8-e418fa15cbb2, (CHARACTER)_Player);

//END_REGION

//REGION Victory - the hag dies.
IF
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
NOT DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
THEN
SetFlag((FLAG)HAG_Hag_SurrogateMother_Event_AfterFightSpot_60934b0e-6c01-435d-a531-f7f4d3e89abd, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag((FLAG)HAG_Hag_SurrogateMother_Event_AfterFightSpot_60934b0e-6c01-435d-a531-f7f4d3e89abd) // flagType: Global
AND
NOT DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
NOT DB_Is_InCombat(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _)
AND
NOT DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
NOT DB_OnlyOnce("HAG_Hag_SurrogateMother_Event_AfterFightSpotted")
THEN
SetFlag((FLAG)HAG_Hagspawn_SurrogateMother_Event_StartSpotting_ef9cdeb4-bf12-4893-a360-a3c4b3482b91, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

PROC
PROC_SpotPlayers_Spotted(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_Hag_SurrogateMother_Event_AfterFightSpotted",_Player)
AND
NOT DB_OnlyOnce("HAG_Hag_SurrogateMother_Event_AfterFightSpotted")
THEN
PROC_HAG_SurrogateMotherThank(_Player);

PROC
PROC_HAG_SurrogateMotherThank(_Player)
THEN
DB_OnlyOnce("HAG_Hag_SurrogateMother_Event_AfterFightSpotted");

PROC
PROC_HAG_SurrogateMotherThank((GUIDSTRING)_Player)
AND
NOT DB_OnlyOnce("HAG_Hag_SurrogateMotherThank")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)HAG_Hagspawn_SurrogateMother_Lair_f7e9efb2-3b82-9e2f-07c4-44f492429a0b, S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Player)
THEN
DB_OnlyOnce("HAG_Hag_SurrogateMotherThank");

PROC
PROC_HAG_SurrogateMotherThank(_Player)
AND
NOT DB_OnlyOnce("HAG_Hag_SurrogateMotherThank")
THEN
SetFlag((FLAG)HAG_Hagspawn_SurrogateMother_Event_StartSpotting_ef9cdeb4-bf12-4893-a360-a3c4b3482b91, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

QRY
QRY_SelectCustomDialog(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Player)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)HAG_HagSpawn_State_ResurrectionHappening_14c80b7a-d066-4f8f-944f-196d0c4243c9) // flagType: Global
AND
NOT DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
THEN
NOT DB_OnlyOnce("HAG_Hag_SurrogateMotherThank");
PROC_HAG_SurrogateMotherThank(_Player);

QRY
QRY_SelectCustomDialog(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Player)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720) // flagType: Global
AND
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)HAG_HagSpawn_State_ResurrectionHappening_14c80b7a-d066-4f8f-944f-196d0c4243c9) // flagType: Global
AND
NOT DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10) // flagType: Global
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,  S_HAG_HagLair_MayrinaInCageVbTrigger_4253e9d2-249f-479d-bb59-df7978fdfe7e, 0)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAG_Hagspawn_SurrogateMother_93854c48-68de-2a4f-c36e-36a24ab727b8, (CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, NULL_00000000-0000-0000-0000-000000000000, _Player);

QRY
QRY_SelectCustomDialog(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Player)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720) // flagType: Global
AND
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)HAG_HagSpawn_State_ResurrectionHappening_14c80b7a-d066-4f8f-944f-196d0c4243c9) // flagType: Global
AND
NOT DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10) // flagType: Global
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,  S_HAG_HagLair_MayrinaInCageVbTrigger_4253e9d2-249f-479d-bb59-df7978fdfe7e, 1)
AND
IsInTrigger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,  S_HAG_HagLair_MayrinaInCageVbTrigger_4253e9d2-249f-479d-bb59-df7978fdfe7e, 0)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAG_Hagspawn_SurrogateMother_93854c48-68de-2a4f-c36e-36a24ab727b8, (CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, NULL_00000000-0000-0000-0000-000000000000, _Player);

QRY
QRY_SelectCustomDialog(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Player)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720) // flagType: Global
AND
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)HAG_HagSpawn_State_ResurrectionHappening_14c80b7a-d066-4f8f-944f-196d0c4243c9) // flagType: Global
AND
NOT DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10) // flagType: Global
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,  S_HAG_HagLair_MayrinaInCageVbTrigger_4253e9d2-249f-479d-bb59-df7978fdfe7e, 1)
AND
IsInTrigger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,  S_HAG_HagLair_MayrinaInCageVbTrigger_4253e9d2-249f-479d-bb59-df7978fdfe7e, 1)
AND
DB_DialogName((DIALOGRESOURCE)HAG_Hag_Lair_a70f5acb-ecbe-8d0a-ae9c-be07a532e2d8, _ID)
THEN
PROC_DialogAddListeningActor(_ID, _Player); //Get drawn into encounter dialog.

QRY
QRY_SelectCustomDialog(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Player)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720) // flagType: Global
AND
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)HAG_HagSpawn_State_ResurrectionHappening_14c80b7a-d066-4f8f-944f-196d0c4243c9) // flagType: Global
AND
NOT DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
DB_GlobalFlag((FLAG)HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10) // flagType: Global
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,  S_HAG_HagLair_MayrinaInCageVbTrigger_4253e9d2-249f-479d-bb59-df7978fdfe7e, 1)
AND
IsInTrigger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,  S_HAG_HagLair_MayrinaInCageVbTrigger_4253e9d2-249f-479d-bb59-df7978fdfe7e, 1)
AND
NOT DB_DialogName((DIALOGRESOURCE)HAG_Hag_Lair_a70f5acb-ecbe-8d0a-ae9c-be07a532e2d8, _)
THEN
PROC_SpotPlayers_Spotted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair", (CHARACTER)_Player);

QRY
QRY_SelectCustomDialog(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Player)
AND
DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
THEN
PROC_TryStartAD((DIALOGRESOURCE)HAG_HagLair_AD_SurrogateMotherInCage_4986e653-6891-d7ce-7a33-afa56207957b, (CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

// Pregnant woman sees hag dead -> knows she's dead (in the hag lair different conditions apply, see goal HAG_HagLair_Combat).
IF
DB_Dead(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_Sees(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07,0)
THEN
SetFlag((FLAG)HAG_Hag_SurrogateMother_Event_AfterFightSpot_60934b0e-6c01-435d-a531-f7f4d3e89abd, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

// Pregnant woman sees hag dead -> knows she's dead.
IF
DB_Dead(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_Sees(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
SetFlag((FLAG)HAG_Hagspawn_State_SurrogateKnowsHagDead_9aaf09dc-3428-a1b2-083e-06e2b424e59a, S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd); // flagType: Object
//END_REGION

//REGION Killing the Hag removes the illusory wall to her lair, and removes any cackling.

IF
Died(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
SetFlag((FLAG)HAG_LairEntranceEvent_Event_DropIllusion_a5ec3b10-5876-4a19-8cc6-59fd8dc31982, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
TriggerSetSoundState(Amb_SV_Hag_Lair_FZ_513adaab-3e65-4fee-ab08-762b78fd3df3, "Amb_SV_Hag_Alive_Dead", "Dead", 0);
TriggerSetSoundState(Amb_SV_Hag_Lair_Laboratory_FZ_0fc035a5-4cc8-464e-956c-95f92d2a715d, "Amb_SV_Hag_Alive_Dead", "Dead", 0);


//END_REGION

//REGION Sound Debug
IF
TextEvent("HAG_HagLair_SetLairSound")
AND
GetTextEventParamString(1, _Param)
THEN
TriggerSetSoundState(Amb_SV_Hag_Lair_FZ_513adaab-3e65-4fee-ab08-762b78fd3df3, "Amb_SV_Hag_Alive_Dead", _Param, 0);
TriggerSetSoundState(Amb_SV_Hag_Lair_Laboratory_FZ_0fc035a5-4cc8-464e-956c-95f92d2a715d, "Amb_SV_Hag_Alive_Dead", _Param, 0);

//END_REGION

//REGION Journal Updates
IF
FlagSet(HAG_Hagspawn_State_InitialSceneStarted_1f2c6a85-0780-729b-6078-6ea4e9a090d4, _, _)
THEN
PROC_HAG_Hag_StartSceneJournalUpdate();

PROC
PROC_HAG_Hag_StartSceneJournalUpdate()
AND
DB_HAG_HagAmbush_HagTraderMet(1)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "HAG_HagSpawn", "SpokeToBrothers", 1)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "HAG_HagSpawn", "StartScene3");

PROC
PROC_HAG_Hag_StartSceneJournalUpdate()
AND
NOT DB_HAG_HagAmbush_HagTraderMet(1)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "HAG_HagSpawn", "StartScene1");

PROC
PROC_HAG_Hag_StartSceneJournalUpdate()
AND
DB_HAG_HagAmbush_HagTraderMet(1)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "HAG_HagSpawn", "SpokeToBrothers", 0)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "HAG_HagSpawn", "StartScene2");

IF
TextEvent("HAG_TestHairReward")
AND
GetHostCharacter(_Character)
THEN
QuestUpdate(_Character, "HIDDEN_HAG_Reward", "HagReward");

//END_REGION

//REGION Hag well

IF
FlagSet(HAG_Well_Event_DrinkWell_d1cc47b0-ac06-3fc2-f70c-4bb1762b932d, _Character, _)
AND
HasActiveStatus(_Character, "HAG_WELL_GOOD", 0)
AND
HasActiveStatus(_Character, "HAG_WELL_BAD", 0)
THEN
ApplyStatus(_Character, "HAG_WELL_GOOD", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(HAG_Well_Event_DrinkWell_d1cc47b0-ac06-3fc2-f70c-4bb1762b932d, _Character, 0);

IF
FlagSet(HAG_Well_Event_DrinkWell_d1cc47b0-ac06-3fc2-f70c-4bb1762b932d, _Character, _)
AND
HasActiveStatus(_Character, "HAG_WELL_BAD", 1)
THEN
RemoveStatus(_Character, "HAG_WELL_BAD");
ApplyStatus(_Character, "HAG_WELL_WORSE", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(_Character, "HAG_WELL_GOOD", _, _)
THEN
DB_HAG_HagWell_Affected(_Character, 1);

IF
StatusRemoved(_Character, "HAG_WELL_GOOD", _, _)
THEN
NOT DB_HAG_HagWell_Affected(_Character, 1);

IF
StatusApplied(_Character, "HAG_WELL_BAD", _, _)
THEN
DB_HAG_HagWell_Affected(_Character, -1);
SetFlag(HAG_Well_Event_WellPoisoned_11a0de08-ecf0-4795-a2ba-5773ffa9317e, _Character, 0);

IF
StatusApplied(_Character, "HAG_WELL_WORSE", _, _)
THEN
DB_HAG_HagWell_Affected(_Character, -1);
SetFlag(HAG_Well_Event_WellPoisoned_11a0de08-ecf0-4795-a2ba-5773ffa9317e, _Character, 0);

IF
StatusRemoved(_Character, "HAG_WELL_BAD", _, _)
AND
HasActiveStatus(_Character, "HAG_WELL_WORSE", 0)
THEN
NOT DB_HAG_HagWell_Affected(_Character, -1);
ClearFlag(HAG_Well_Event_WellPoisoned_11a0de08-ecf0-4795-a2ba-5773ffa9317e, _Character, 0);

IF
StatusRemoved(_Character, "HAG_WELL_WORSE", _, _)
AND
HasActiveStatus(_Character, "HAG_WELL_BAD", 0)
THEN
NOT DB_HAG_HagWell_Affected(_Character, -1);
ClearFlag(HAG_Well_Event_WellPoisoned_11a0de08-ecf0-4795-a2ba-5773ffa9317e, _Character, 0);

PROC
PROC_LongRest()
AND
DB_HAG_HagWell_Affected(_Character, 1)
THEN
RemoveStatus(_Character, "HAG_WELL_GOOD");
ApplyStatus(_Character, "HAG_WELL_BAD", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
EnteredCombat(_Character, _ID)
AND
DB_HAG_HagWell_Affected(_Character, 1)
AND
DB_Is_InCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
THEN
RemoveStatus(_Character, "HAG_WELL_GOOD");
ApplyStatus(_Character, "HAG_WELL_BAD", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_GlobalSetFlagAndCache(HAG_Well_State_Worsened_6cc9e3e0-4802-49d2-9127-9a42c5ad39fa);

IF
EnteredCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
AND
DB_HAG_HagWell_Affected(_Character, 1)
AND
DB_Is_InCombat((CHARACTER)_Character, _ID)
THEN
RemoveStatus(_Character, "HAG_WELL_GOOD");
ApplyStatus(_Character, "HAG_WELL_BAD", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_GlobalSetFlagAndCache(HAG_Well_State_Worsened_6cc9e3e0-4802-49d2-9127-9a42c5ad39fa);




//END_REGION

//REGION GLO_Tadpole Journal

IF
RelationChanged(GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, _, _)
AND
DB_Players(_AnyPlayer)
AND
NOT DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
AND
QRY_IsEnemy(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _AnyPlayer)
THEN
QuestUpdate(_AnyPlayer, "GLO_Tadpole", "HagHostile");

IF
RelationChanged(GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, _PlayerFaction, _, _)
AND
DB_Players(_AnyPlayer)
AND
GetFaction(_AnyPlayer, _PlayerFaction)
AND
NOT DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
AND
QRY_IsEnemy(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _AnyPlayer)
THEN
QuestUpdate(_AnyPlayer, "GLO_Tadpole", "HagHostile");

//END_REGION

//REGION Detecting that Auntie Ethel is defeated
IF
DB_Sees(_Player, (CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_GlobalFlag(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2)
AND
DB_Dead((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_PartyMembers(_Player)
THEN
PROC_GlobalSetFlagAndCache(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2);

IF
DB_Sees(_Player, (CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_GlobalFlag(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2)
AND
DB_KnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_PartyMembers(_Player)
THEN
PROC_GlobalSetFlagAndCache(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2);

IF
DB_Is_InCombat(_Player, _Combat)
AND
DB_Is_InCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Combat)
AND
NOT DB_GlobalFlag(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2)
AND
DB_Dead((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_PartyMembers((CHARACTER)_Player)
THEN
PROC_GlobalSetFlagAndCache(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2);

IF
DB_Is_InCombat(_Player, _Combat)
AND
DB_Is_InCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Combat)
AND
NOT DB_GlobalFlag(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2)
AND
DB_KnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_PartyMembers((CHARACTER)_Player)
THEN
PROC_GlobalSetFlagAndCache(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2);

IF
KilledBy(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Attacker, _, _)
AND
DB_PartyMembers((CHARACTER)_Attacker)
THEN
PROC_GlobalSetFlagAndCache(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2);

IF
StatusApplied(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "KNOCKED_OUT", _Attacker, _)
AND
DB_PartyMembers((CHARACTER)_Attacker)
THEN
PROC_GlobalSetFlagAndCache(HAG_Hag_Knows_HagDead_6bc41bd0-ef96-4358-0493-0ff80438d5c2);

//END_REGION

IF
TextEvent("HAG_ExhumeHusband")
AND
GetHostCharacter(_Character)
THEN
SetFlag((FLAG)HAG_HagSpawn_State_DugUpHusband_59a20c10-f5be-47b5-900a-73a8960a062f, NULL_00000000-0000-0000-0000-000000000000);
SetOnStage(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5, 1);
SetOnStage(S_HAG_HusbandGrave_11f47099-24f3-4e40-b905-c45c55fd46a6, 0);


//REGION Touching the forcefield

IF
UseStarted(_Character, S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f)
AND
DB_Players(_Character)
THEN
PROC_TryStartAD((DIALOGRESOURCE)HAG_PAD_HusbandGraveForcefield_bc601a0e-5428-2174-a318-e970a762fd98, _Character);

IF
UseStarted(_Character, S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f)
AND
HasActiveStatus(_Character, "HAG_FORCEFIELD_2", 1)
THEN
RequestPassiveRoll(_Character, S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f, "SavingThrow", "Wisdom", (DIFFICULTYCLASS)DC_Legacy_10_625be976-7a67-4394-97c8-14c69715ae4b, 0, "HAG_HusbandForceField");

IF
UseStarted(_Character, S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f)
AND
HasActiveStatus(_Character, "HAG_FORCEFIELD_1", 1)
AND
HasActiveStatus(_Character, "HAG_FORCEFIELD_2", 0)
THEN
ApplyStatus(_Character, "HAG_FORCEFIELD_2", 60.0, 0, (ITEM)S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f);

IF
UseStarted(_Character, S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f)
AND
HasActiveStatus(_Character, "HAG_FORCEFIELD_1", 0)
AND
HasActiveStatus(_Character, "HAG_FORCEFIELD_2", 0)
THEN
ApplyStatus(_Character, "HAG_FORCEFIELD_1", 60.0, 0, (ITEM)S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f);

IF
RollResult("HAG_HusbandForceField", _Character, _, 1, _, _)
THEN
ApplyStatus(_Character, "HAG_FORCEFIELD_2", 60.0, 0, (ITEM)S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f);

IF
RollResult("HAG_HusbandForceField", _Character, _, 0, _, _)
THEN
ApplyStatus(_Character, "HAG_FORCEFIELD_3", 60.0, 0, (ITEM)S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f);
ApplyStatus(_Character, "HAG_FORCEFIELD_FEAR", 60.0, 0, (ITEM)S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f);

IF
StatusRemoved(_Character, "HAG_FORCEFIELD_FEAR", _Character, _)
AND
HasActiveStatus(_Character, "HAG_FORCEFIELD_3", 1)
THEN
RemoveStatus(_Character, "HAG_FORCEFIELD_3");

IF
StatusRemoved(_Character, "HAG_FORCEFIELD_3", _Character, _)
AND
HasActiveStatus(_Character, "HAG_FORCEFIELD_FEAR", 1)
THEN
RemoveStatus(_Character, "HAG_FORCEFIELD_FEAR");

//END_REGION

IF
DB_CurrentLevel("CTY_Main_A")
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
