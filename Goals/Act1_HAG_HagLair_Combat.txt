Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Subregion(S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07,"HAG_HagLair_SUB",0, 1);
SetStayInAiHints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 1);
SetAiHint(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, AI_HINT_UNIQUE_1902723d-dd16-4e7a-87d6-7b07f63add79);
SetTag(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, AI_USEITEM_A_f532d904-4e7c-469f-8e47-67a639cd1ae1);

DB_AutoSaveTrigger(S_HAG_HagLair_Autosave_01_cbe0514b-4fa3-42db-9b5a-9f4a9274e017);
DB_AutoSaveTrigger(S_HAG_HagLair_Autosave_02_78a5b25e-b066-4664-8c1c-45c641f5fa3e);
DB_AutoSaveTrigger(S_HAG_HagLair_Autosave_03_c94e3d54-2ee8-4381-8302-9cadc0d7ffa1);

TriggerRegisterForCharacter(S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
PROC_TriggerRegisterForPlayers(S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e);
PROC_TriggerRegisterForPlayers(S_HAG_HagLair_MayrinaInCageVbTrigger_4253e9d2-249f-479d-bb59-df7978fdfe7e);
SetCanInteract(S_HAG_HagLair_PenDoorLever_1e48ac14-7c05-4618-9c80-712d9173e41b,0);

DB_Subregion(S_HAG_HagLair_SUB_CombatArea_0ace1ca2-9f1b-44d2-ae49-5bde98e1d251,"HAG_HagLair_SUB_CombatArea",0, 1);
DB_Subregion(S_HAG_HagLair_SUB_Workshop_0971db30-b6ff-4f64-af20-f573c5148198,"HAG_HagLair_SUB_Workshop",0, 1);

//Hag Defeated Flags
DB_HAG_HagLair_HagDefeatedFlags((FLAG)HAG_Hag_State_IsDead_781391e2-7d33-642d-28c0-e9b06cde32bb);
//DB_HAG_HagLair_HagDefeatedFlags("HAG_Hag_State_HagMotherDealCancelled");
//DB_HAG_HagLair_HagDefeatedFlags("HAG_Hag_State_HagGaveReward");
//DB_HAG_HagLair_HagDefeatedFlags("HAG_Hag_State_HagTookMother");
DB_HAG_HagLair_HagDefeatedFlags((FLAG)HAG_Hag_State_HagGivenMercy_a3c0a36a-ccce-4f35-7b54-9ab22d6ac534);
////////HAG_Hag_State_HagDefeated

PROC_HAG_HagLair_Combat_Init();

//Make sure something happens when Ethel is absent.
PROC_RegisterWorldGossipTrigger(S_PartyBanterTrigger_HagLair_BossRoom_ba3610c1-a43e-44e4-bb86-2436381a6e1b);
DB_OneShot_VoiceBarkTrigger(S_HAG_HagLair_VB_Explore1_2e643275-ec10-4dc9-be45-537de1550fe2, HAG_HagLair_VB_Explore1_f160717b-dbf2-1a87-f33f-9144e3ffc45e);
DB_OneShot_VoiceBarkTrigger(S_HAG_HagLair_VB_Explore2_147208a1-dff3-4979-8bdb-e979e6d26910, HAG_HagLair_VB_Explore2_eb6fcab5-70b3-5f9f-fdfe-30befb011562);

DB_HAG_MaskedVictims((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8, S_HAG_MaskedVictim01_Moveto_13bb41c4-9425-4e71-a6f6-2bedd98bd0dc, 100, (DIALOGRESOURCE)HAG_Hag_MaskedVictim1_AD_Resist_e238cfcb-0b01-bce9-237e-79e526ac8932);
DB_HAG_MaskedVictims((CHARACTER)S_HAG_Hag_MaskedVictim2_535f23bc-2d27-4c40-a1f3-1cf58bfd1698, S_HAG_MaskedVictim02_Moveto_a8e13b09-5fb4-4795-ab6a-1cf7e06dd7de, 300, (DIALOGRESOURCE)HAG_Hag_MaskedVictim2_AD_Resist_44fd2fa5-5450-7fb4-b2c2-1c86e217fd9d);
DB_HAG_MaskedVictims((CHARACTER)S_HAG_Hag_MaskedVictim3_d7707fd3-301b-49a3-b7f1-2fb92cfa9805, S_HAG_MaskedVictim03_Moveto_2d8e4f9e-385a-44b0-84ba-dcbc1b0e6569, 600, (DIALOGRESOURCE)HAG_Hag_MaskedVictim3_AD_Resist_4b0971c2-2966-28b1-709b-858b8cab9073);
DB_HAG_MaskedVictims((CHARACTER)S_HAG_Hag_MaskedVictim4_74dcb337-e6d1-4329-ac2b-5a3723346159, S_HAG_MaskedVictim04_Moveto_269f768e-0936-4c1c-82c7-786fc28824e8, 700, (DIALOGRESOURCE)HAG_Hag_MaskedVictim4_AD_Resist_3125ae17-3589-77a2-4d33-b747508cbb91);

SetVisible(S_HAG_MayrinaCage_Helper_a8258f6a-a97d-4201-8734-89e5e6aa7e4f, 0);

// Hag Doubles
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_001_b836eb41-0d5e-45c5-8189-d74861912aec);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_002_4640c616-30f2-43d2-ac18-df239fab2f8e);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_003_329283d3-7636-46d0-bda9-902bed38e421);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_004_bf2efd3b-0fc8-4239-ba6d-dfc57c9662a5);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_005_cc4555cb-1e60-47aa-956a-62b697f59efb);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_006_b4096deb-9b5c-455c-884b-9ad0ce89b29d);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_007_a42972f3-1d23-468d-9afe-a8e4948c6902);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_008_3cd13786-518e-4820-b9fb-6b409fb8e07f);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_009_338fe1bd-2493-4996-8e21-84f83d7d49ec);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_010_78eac65e-b90e-4e51-9548-48dead826941);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_011_b25b48ae-68a8-4fc6-8a70-a4461537560b);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_015_c5b6fd79-ed3f-4a41-94d6-3e3329f1f1d2);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_016_a3ddb527-04dc-4085-82b8-887e28abc7c6);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_017_41f57447-e404-41e5-a74d-047461ee3f8b);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_018_7c1bfbda-67b1-465e-bfc1-38e03eb1294a);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_019_6ba06cb0-1bb0-4134-94b3-bfadcb2fe703);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_020_534d4aeb-6f56-4390-b625-922ed24915e8);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_021_53af3730-9cbc-4637-bb36-ca2640f18e4d);
DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_022_0981727a-9b75-4abe-8028-1ffe7ac96512);

PROC_GLO_DifficultyModes_AddHPBoostedEntity(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23);
KBSECTION
//Teleport the hag towards the Lair Entrance when she reveals the Illusion
IF
CastedSpell(_Hag,"Target_HAG_ClearIllusion",_,_,_)
AND
CreateAtObject(Helper_Invisible_Walkthrough_c13a872b-7d9b-4c1d-8c65-f672333b0c11,_Hag,0,0,"",0,_Helper)
THEN
DB_HAG_BeamHelper(_Helper);
TeleportTo(_Hag,S_HAG_EscapeTeaHouseTeleport_2d244b26-0b8f-4b25-95fd-648b7044d0ae);
PlayEffect((TRIGGER)S_HAG_EscapeTeaHouseTeleport_2d244b26-0b8f-4b25-95fd-648b7044d0ae,VFX_Script_Hag_SpawnDoubles_Reappear_01_5259b176-0aaf-e1a0-663e-85fdebbaa681,"");
PlayEffect(_Hag,VFX_Script_Hag_SpawnDoubles_Reappear_Overlay_01_3a1bf6ef-f124-b468-348b-516ae935e813,"Dummy_BodyFX");

IF
EnteredLevel(_Helper, _, _)
AND
DB_HAG_BeamHelper(_Helper)
THEN
NOT DB_HAG_BeamHelper(_Helper);
PlayBeamEffect(_Helper,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,VFX_Script_Hag_SpawnDoubles_Beam_01_1b57f75e-e1ed-c838-3421-0b21422b2a0e,"","");

IF
DB_GlobalFlag(HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c) // flagType: Global
AND
NOT DB_CantTalk((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
QRY_OnlyOnce("HAG_HagLair_HagArrivalSetup")
THEN
PROC_HAG_TeaSceneOver();
RemoveHarmfulStatuses(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetHitpointsPercentage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,100.0);
PROC_UnregisterWorldGossipTrigger(S_PartyBanterTrigger_HagLair_BossRoom_ba3610c1-a43e-44e4-bb86-2436381a6e1b);
DB_AmbushTrigger(S_HAG_HagLair_HagCombatAmbushTrigger_1f6e4e9f-dc50-40ae-88d1-1885c905d11d,(TRIGGER)S_HAG_HagLair_HagCombatAmbushDetectTrigger_ac6f21d8-45ff-466a-80bf-4471d87b48c6,(DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539);
DB_AmbushTrigger_Ambusher(S_HAG_HagLair_HagCombatAmbushTrigger_1f6e4e9f-dc50-40ae-88d1-1885c905d11d,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,0);
PROC_SpotPlayers_RestartSpotting(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag");
DB_SpotPlayers(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair");
DB_SpotPlayers_IncludeWildshapedPlayers(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair");
DB_SpotPlayers_IncludeFollowers(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair");
DB_SpotPlayers_IncludeSummons(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair");
DB_SpotPlayers_IgnoreCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair");
DB_SpotPlayers_SpotterIgnoreCantTalk(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair");
DB_SpotPlayers_SpotTrigger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair", S_HAG_HagLair_NearbyBox_4b8b455d-744c-4f6a-b8b1-72ae53a864da);
SetIsBoss(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1);
SetCombatGroupID(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_Hag_State_HagInLair");
PROC_RemoveOneShotVoiceBarkTrigger(S_HAG_HagLair_VB_Explore1_2e643275-ec10-4dc9-be45-537de1550fe2, HAG_HagLair_VB_Explore1_f160717b-dbf2-1a87-f33f-9144e3ffc45e);
PROC_RemoveOneShotVoiceBarkTrigger(S_HAG_HagLair_VB_Explore2_147208a1-dff3-4979-8bdb-e979e6d26910, HAG_HagLair_VB_Explore2_eb6fcab5-70b3-5f9f-fdfe-30befb011562);
SetVarInteger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"StayInAiHints",1);
SetAiHint(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(TAG)AI_HINT_CASTER_45a231e4-e94f-4b0e-a941-2daf1adf44b5);
ClearTag(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, AI_USEITEM_A_f532d904-4e7c-469f-8e47-67a639cd1ae1);
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"INVISIBLE",-1.0,1);

IF
FlagSet(HAG_HagLair_PenOpened_caa8579f-036d-4884-87df-89ef6fd6b91b, _, _) // flagType: Global
THEN
SetFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb, S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

PROC
PROC_LaunchAmbush(S_HAG_HagLair_HagCombatAmbushTrigger_1f6e4e9f-dc50-40ae-88d1-1885c905d11d, _Player)
AND
QRY_SpeakerIsAvailable(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
PROC_SpotPlayers_Spotted((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag", _Player, "HAG_Hag_Event_SpottedPlayer");

//REGION destroying the Cage kills characters inside

IF
DestroyingBy(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,_Character,_,_)
AND
DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
NOT DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
SetFlag((FLAG)HAG_HagLair_QueueMotherDeathReaction_63d848de-a770-4690-7caa-c6e4432f7a97, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d); // flagType: Object
PROC_HAG_RegisterCageKiller(_Character);

//END_REGION

//REGION Tracking of who killed Mayrina
 
PROC
PROC_HAG_RegisterCageKiller((GUIDSTRING)_Character)
AND
QRY_IsPartyMember((CHARACTER)_Character, 1)
THEN
QuestUpdate(_Character, "HAG_HagSpawn", "KilledMayrina");

PROC
PROC_HAG_RegisterCageKiller((GUIDSTRING)_Character)
AND
QRY_IsPartyMember((CHARACTER)_Character, 1)
AND
QuestUpdateIsUnlocked((CHARACTER)_Character, "HAG_HagSpawn", "FightJake", 0)
AND
QuestUpdateIsUnlocked((CHARACTER)_Character, "HAG_HagSpawn", "DealInterrupted", 0)
THEN
QuestUpdate((CHARACTER)_Character, "HAG_HagSpawn", "KilledMayrina");

PROC
PROC_HAG_RegisterCageKiller(_Character)
AND
NOT QRY_IsPartyMember((CHARACTER)_Character, 0)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "HAG_HagSpawn", "FightJake", 0)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "HAG_HagSpawn", "DealInterrupted", 0)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "HAG_HagSpawn", "MayrinaDead");

IF
DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
NOT DB_Dead(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
DB_SeenPermaDefeatedNPCPartyFlag(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(FLAG)HAG_Hagspawn_Knows_SurrogateMotherDefeated_8f4738c9-7877-86e4-316a-2447a949e136);

IF
DB_Dead(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
DB_SeenDeadNPCPartyFlag(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(FLAG)HAG_Hagspawn_Knows_SurrogateMotherDead_84db6af7-3f52-4ae9-a3fc-7ce5a35fc16c);


//END_REGION

//REGION Hag is in lair and taunts the players.
PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag", _Player, "HAG_Hag_Event_SpottedPlayer")
AND
NOT DB_InRegion(_Player, S_HAG_HagLair_NearbyBox_4b8b455d-744c-4f6a-b8b1-72ae53a864da)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c) // flagType: Global
AND
NOT QRY_HAG_Lair_HasNearbyThreat()
AND
QRY_HAG_CheckCheckSurrogateMotherAvailable(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_HAG_Hagspawn_SurrogateMotherSpeaker(_SurrogateMotherSpeaker)
AND
NOT QRY_StartDialog(DIALOGRESOURCEGUID_HAG_Hag_Lair_a70f5acb-ecbe-8d0a-ae9c-be07a532e2d8, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _SurrogateMotherSpeaker, _Player)
THEN
SetFlag((FLAG)HAG_Hag_Event_StartSpotting_4606ad33-1fda-4e30-9c30-0011eda5aea4, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

QRY
QRY_HAG_Lair_HasNearbyThreat()
AND
DB_InRegion(_Player, S_HAG_HagLair_NearbyBox_4b8b455d-744c-4f6a-b8b1-72ae53a864da)
AND
HasLineOfSight(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Player, 1)
AND
IsInvisible(_Player, 0)
THEN
LookAtEntity((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Player); 
PROC_SpotPlayers_Spotted((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair", _Player);

PROC
PROC_SpotPlayers_Spotted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag", _Player, "HAG_Hag_Event_SpottedPlayer")
AND
DB_InRegion(_Player, S_HAG_HagLair_NearbyBox_4b8b455d-744c-4f6a-b8b1-72ae53a864da)
THEN
PROC_SpotPlayers_Spotted((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair", _Player);

PROC
PROC_SpotPlayers_Spotted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair", _Player)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "INVISIBLE");
PROC_CancelAmbush(S_HAG_HagLair_HagCombatAmbushTrigger_1f6e4e9f-dc50-40ae-88d1-1885c905d11d);
PROC_ForceStopDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_SpotPlayers_StopSpotting(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair");
PROC_State_Progress(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HagTea", "AfterLairScene");
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 0);
DB_HAG_FightWithHagWhenHostile(_Player);
//PROC_EnterCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player);
//PROC_EnterCombat(_Player,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
QuestUpdate((CHARACTER)_Player, "HAG_HagSpawn", "LairFight");

PROC
PROC_DialogFlagSetup(DIALOGRESOURCEGUID_HAG_Hag_Lair_a70f5acb-ecbe-8d0a-ae9c-be07a532e2d8, _, _, _, _, _)
THEN
PROC_SpotPlayers_StopSpotting(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag");

QRY
QRY_HAG_CheckCheckSurrogateMotherAvailable(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c) // flagType: Global
THEN
SysClear("DB_HAG_Hagspawn_SurrogateMotherSpeaker", 1);
DB_HAG_Hagspawn_SurrogateMotherSpeaker(NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_HAG_CheckCheckSurrogateMotherAvailable(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c) // flagType: Global
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07,1)
AND
NOT DB_CantTalk(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
NOT DB_HAG_Hagspawn_SurrogateMotherSpeaker(NULL_00000000-0000-0000-0000-000000000000);
DB_HAG_Hagspawn_SurrogateMotherSpeaker(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

IF
DialogStarted(DIALOGRESOURCEGUID_HAG_Hag_Lair_a70f5acb-ecbe-8d0a-ae9c-be07a532e2d8, _Id)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"INVISIBLE");

IF
DialogEnded(DIALOGRESOURCEGUID_HAG_Hag_Lair_a70f5acb-ecbe-8d0a-ae9c-be07a532e2d8, _Id)
AND
DB_DialogPlayers(_Id,_Player,1)
THEN
PROC_SpotPlayers_StopSpotting(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_Lair");
PROC_State_Progress(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HagTea", "AfterLairScene");
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 0);
DB_HAG_FightWithHagWhenHostile((CHARACTER)_Player);
//PROC_EnterCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player);
//PROC_EnterCombat(_Player,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
QuestUpdate((CHARACTER)_Player, "HAG_HagSpawn", "LairFight");

IF
RelationChanged(GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, _)
AND
DB_HAG_FightWithHagWhenHostile(_Player)
THEN
PROC_EnterCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player);
PROC_EnterCombat(_Player,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
NOT DB_HAG_FightWithHagWhenHostile(_Player);

//END_REGION

//REGION Summon Victims

IF
FlagSet(HAG_Hag_SummonedVictims_755d8269-7864-b72c-f355-b00aa02cd17e, _, _) // flagType: Global
AND
DB_Is_InCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
AND
QRY_HAG_SummonCutscene_CreateSpeakers(_ID)
AND
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(1, _Speaker1)
AND
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(2, _Speaker2)
AND
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(3, _Speaker3)
AND
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(4, _Speaker4)
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)HAG_HagLair_SummonVictimsScene_14c8f9f3-ec33-b9de-8e50-ee7c874e5312, _Speaker1, _Speaker2, _Speaker3, _Speaker4, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 0, 0)
THEN
DB_NOOP(1);

QRY
QRY_HAG_SummonCutscene_CreateSpeakers(_)
THEN
SysClear("DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers", 2);
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(1, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(2, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(3, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(4, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_HAG_SummonCutscene_CreateSpeakers((GUIDSTRING)_ID)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _ID)
THEN
PROC_HAG_SummonCutscene_AddToSlot(_Player);

PROC
PROC_HAG_SummonCutscene_AddToSlot((CHARACTER)_Player)
AND
NOT DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(3, NULL_00000000-0000-0000-0000-000000000000)
AND
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(4, NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(4, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(4, _Player);


PROC
PROC_HAG_SummonCutscene_AddToSlot((CHARACTER)_Player)
AND
NOT DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(2, NULL_00000000-0000-0000-0000-000000000000)
AND
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(3, NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(3, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(3, _Player);

PROC
PROC_HAG_SummonCutscene_AddToSlot((CHARACTER)_Player)
AND
NOT DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(1, NULL_00000000-0000-0000-0000-000000000000)
AND
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(2, NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(2, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(2, _Player);

PROC
PROC_HAG_SummonCutscene_AddToSlot((CHARACTER)_Player)
AND
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(1, NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(1, NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAG_SummonCutscene_CreateSpeakers(1, _Player);

PROC
PROC_StartDialog_AddExtraSpeakers(HAG_HagLair_SummonVictimsScene_14c8f9f3-ec33-b9de-8e50-ee7c874e5312, _ID)
AND
DB_HAG_MaskedVictims(_Victim, _, _, _)
AND
NOT DB_CantTalk_IgnoreCombat(_Victim)
THEN
PROC_DialogAddSpeakingActor(_ID, _Victim);

IF
FlagSet(HAG_Hag_SummonedVictims_755d8269-7864-b72c-f355-b00aa02cd17e, _, _) // flagType: Global
AND
DB_HAG_MaskedVictims(_Victim, _, _Timer, _)
THEN
PROC_ForceStopDialog(_Victim);
ObjectTimerLaunch(_Victim, "HAG_HagLair_Victim_Summon",_Timer);

//Delay timer before teleport down
IF
ObjectTimerFinished(_Victim, "HAG_HagLair_Victim_Summon")
AND
DB_HAG_MaskedVictims((CHARACTER)_Victim, _Trigger, _, _)
THEN
PlayEffect(_Victim,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f,"",1.0);
PlayEffect(_Trigger,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f,"",1.0);
TeleportTo(_Victim, _Trigger);
SetCombatGroupID(_Victim,"HAG_Hag_State_HagInLair");
SetFaction(_Victim, GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e);

PROC
PROC_HAG_HagLair_Doubles_Removed(_)
AND
DB_Dead(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
PROC_HAG_TryMaskedVictimsNeutral();

IF
DB_Dead(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
PROC_HAG_TryMaskedVictimsNeutral();

IF
DB_KnockedOut(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
PROC_HAG_TryMaskedVictimsNeutral();

PROC
PROC_HAG_TryMaskedVictimsNeutral()
AND
NOT QRY_HAG_DoublesPresent()
THEN
PROC_HAG_MaskedVictimsNeutral();

QRY
QRY_HAG_DoublesPresent()
AND
DB_HAG_HagLair_Doubles(_Double)
AND
IsOnStage(_Double, 1)
THEN
DB_NOOP(1);

PROC
PROC_HAG_MaskedVictimsNeutral()
THEN
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 50);

PROC
PROC_HAG_MaskedVictimsNeutral()
AND
DB_HAG_MaskedVictims(_Victim, _Trigger, _, _)
THEN
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 50);
SetFaction(_Victim, GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0);

PROC
PROC_HAG_MaskedVictimsNeutral()
THEN
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 50);
PROC_SetRelationToPlayers(GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0, 50);

PROC
PROC_HAG_MaskedVictimsNeutral()
AND
DB_HAG_MaskedVictims(_Victim, _, _, _)
AND
NOT DB_KnockedOut(_Victim)
THEN
SetHasDialog(_Victim, 1);

//END_REGION

//REGION Pen / Cage Logic

//REGION Cage Appear

IF
TextEvent("HAG_SetupSurrogateMotherCage")
THEN
PROC_HAG_SetupSurrogateMotherCage();

PROC
PROC_HAG_SetupSurrogateMotherCage()
AND
NOT DB_OnlyOnce("HAG_SetupSurrogateMotherCage")
AND
DB_QuestIsOpened("HAG_HagSpawn") //Will be set only if the quest already opened (blocks collecting it and unlocking it once accepted)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "HAG_HagSpawn", "MayrinaTeleported");

PROC
PROC_HAG_SetupSurrogateMotherCage()
AND
NOT DB_OnlyOnce("HAG_SetupSurrogateMotherCage")
AND
GetPosition(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _X, _Y, _Z)
THEN
PlayEffectAtPosition(VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f, _X, _Y, _Z);
SetOnStage(S_HAG_HagLair_MayrinaCageBottom_3f4391c6-a6b0-8499-46ae-526879a5d419,1);
SetOnStage(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,1);
SetEntityEvent(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "ClearCrimeReturn", 1);
PurgeOsirisQueue(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
LeaveCombat(CHARACTERGUID_S_HAG_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
TeleportTo(CHARACTERGUID_S_HAG_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e,"",1,1,1);
SetFlag(HAG_HagSpawn_SurrogateMother_State_InLair_400601e6-9c76-4d93-a4bf-d561de28cc10, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_SpotPlayers_StopSpotting((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag");
PROC_SpotPlayers_StopSpotting((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "HAG_Hag");
SetCanInteract(S_HAG_HagLair_PenDoorLever_1e48ac14-7c05-4618-9c80-712d9173e41b,1);
DB_HAG_Hagspawn_SetupCageHelperTrigger(1);

PROC
PROC_HAG_SetupSurrogateMotherCage()
AND
NOT DB_OnlyOnce("HAG_SetupSurrogateMotherCage")
THEN
SetCombatGroupID(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_Hag_State_HagInLair");
DB_OnlyOnce("HAG_SetupSurrogateMotherCage");

//END_REGION

//REGION Lever/Orb loop effects

PROC
PROC_HAG_SetupSurrogateMotherCage()
THEN
PROC_LoopEffect(VFX_Script_PUZ_HAG_Lever_Wood_A_Activated_01_a0b28c77-fa48-5245-74ca-d3249fcf397b,S_HAG_HagLair_PenDoorLever_1e48ac14-7c05-4618-9c80-712d9173e41b,"HAG_HagCombat_LeverFx","WLD_Main_A","Dummy_PUZ_HAG_Lever_Wood_A");

IF
FlagSet((FLAG)HAG_HagLair_PenOpened_caa8579f-036d-4884-87df-89ef6fd6b91b, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
PROC_StopLoopEffect(S_HAG_HagLair_PenDoorLever_1e48ac14-7c05-4618-9c80-712d9173e41b,"HAG_HagCombat_LeverFx");
SetCanInteract(S_HAG_HagLair_PenDoorLever_1e48ac14-7c05-4618-9c80-712d9173e41b,0);

IF
DestroyingBy(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,_,_,_)
THEN
PROC_StopLoopEffect(S_HAG_HagLair_PenDoorLever_1e48ac14-7c05-4618-9c80-712d9173e41b,"HAG_HagCombat_LeverFx");
SetCanInteract(S_HAG_HagLair_PenDoorLever_1e48ac14-7c05-4618-9c80-712d9173e41b,0);

//END_REGION


IF
EnteredTrigger(_Player,S_HAG_HagLair_MayrinaInCageVbTrigger_4253e9d2-249f-479d-bb59-df7978fdfe7e)
AND
DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
NOT DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QRY_OnlyOnce("HAG_HagLair_MayrinaInCageVbTrigger")
THEN
PROC_TryStartAD(DIALOGRESOURCEGUID_HAG_HagLair_VB_MayrinaInCage_63dada40-252d-fde6-12ee-fb10a1b0b43c,_Player);

IF
UseStarted(_Player,S_HAG_HagLair_PenDoorLever_1e48ac14-7c05-4618-9c80-712d9173e41b)
AND
IsOnStage(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,1)
AND
IsDestroyed(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,0)
AND
QRY_OnlyOnce("HAG_HagLair_OpenPenDoor")
THEN
NOT DB_HAG_Hagspawn_SetupCageHelperTrigger(1);
DB_HAG_HagLair_OpenPenDoorPlayer(_Player);
TimerLaunch("HAG_HagLair_OpenPenDoor",500);

IF
TimerFinished("HAG_HagLair_OpenPenDoor")
THEN
SetFlag((FLAG)HAG_HagLair_PenOpened_caa8579f-036d-4884-87df-89ef6fd6b91b, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global


IF
DB_GlobalFlag(HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
NOT DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
IsInTrigger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07,1)
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07,1)
THEN
SetFlag((FLAG)HAG_Hag_SurrogateMother_Event_AfterFightSpot_60934b0e-6c01-435d-a531-f7f4d3e89abd, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetFlag((FLAG)HAG_Hagspawn_State_SurrogateKnowsHagDead_9aaf09dc-3428-a1b2-083e-06e2b424e59a, S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd); // flagType: Object

IF
FlagSet((FLAG)HAG_HagLair_PenOpened_caa8579f-036d-4884-87df-89ef6fd6b91b, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
DB_HAG_HagLair_OpenPenDoorPlayer(_Player)
AND
GetPosition(S_HAG_HagLair_MayrinaCageOpenPoint_35ba1cee-0a7e-4768-ad97-ebc188a40027,_X,_Y,_Z)
THEN
NOT DB_HAG_HagLair_OpenPenDoorPlayer(_Player);
PlatformMoveTo((LEVELTEMPLATE)LT_PLT_HAG_CageBottom_001_8eff8e38-088d-4b64-ab8e-251c2eab99c0,_X,_Y,_Z,1.5,"S_HAG_HagLair_MayrinaCage_MoveFinished", 0);
PROC_SetInvulnerable(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,1);

IF
PlatformMovementFinished((LEVELTEMPLATE)LT_PLT_HAG_CageBottom_001_8eff8e38-088d-4b64-ab8e-251c2eab99c0,"S_HAG_HagLair_MayrinaCage_MoveFinished")
THEN
PROC_SetInvulnerable(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,0);

IF
DestroyingBy(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,_,_,_)
THEN
DestroyPlatform((LEVELTEMPLATE)LT_PLT_HAG_CageBottom_001_8eff8e38-088d-4b64-ab8e-251c2eab99c0);

//Set Up initial position
PROC
PROC_HAG_HagLair_Combat_Init()
AND
GetPosition(S_HAG_HagLair_MayrinaCageClosedPoint_06cb52fe-6cfd-4204-aee2-b17356a42305,_X,_Y,_Z)
THEN
PlatformMoveTo((LEVELTEMPLATE)LT_PLT_HAG_CageBottom_001_8eff8e38-088d-4b64-ab8e-251c2eab99c0,_X,_Y,_Z,1.5,"S_HAG_HagLair_Combat_Init", 0);
SetOnStage(S_HAG_HagLair_MayrinaCageBottom_3f4391c6-a6b0-8499-46ae-526879a5d419,0);
SetOnStage(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,0);

//END_REGION


//REGION combat ADs

IF
TurnStarted((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c) // flagType: Global
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _ID)
AND
DB_Is_InCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e,1)
AND
HasActiveStatus(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,"BURNING",1)
AND
QRY_OnlyOnce("HAG_HagLair_VB_BurningCage")
THEN
PROC_TryStartAD(DIALOGRESOURCEGUID_HAG_HagLair_VB_BurningCage_e91002f3-1e31-e015-c5fe-1b3e32bcf70c,_Player);

IF
StatusApplied(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23, "BURNING", _, _)
THEN
SetFlag(HAG_HagLair_State_CageBurning_e1014810-9f1b-46d6-ac5e-8962565fc2b7, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
StatusRemoved(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23, "BURNING", _, _)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
ClearFlag(HAG_HagLair_State_CageBurning_e1014810-9f1b-46d6-ac5e-8962565fc2b7, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
LeftCombat(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _)
AND
DB_InRegion(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
THEN
SetEntityEvent(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "ClearPeaceReturn", 1); //Don't go back into the cage.

IF
LeftTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
DB_Is_InCombat((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _)
THEN
SetEntityEvent(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "ClearPeaceReturn", 1); //Don't go back into the cage.

//REGION When Mayrina should be cowering - if she is in her cage and it is on fire (she is afraid she might fall in) or if she is outside of her cage and the players are fighting Ethel (she is afraid of the fighting)
IF
DB_GlobalFlag(HAG_HagLair_State_CageBurning_e1014810-9f1b-46d6-ac5e-8962565fc2b7)
AND
DB_InRegion((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, (TRIGGER)S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
NOT DB_PermaDefeated((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
DB_HagSpawn_SurrogateMotherAfraid(1);

IF
DB_Is_InCombat((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _Combat)
AND
DB_Is_InCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Combat)
AND
NOT DB_InRegion((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, (TRIGGER)S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
THEN
DB_HagSpawn_SurrogateMotherAfraid(1);

IF
DB_HagSpawn_SurrogateMotherAfraid(1)
AND
NOT DB_Is_InCombat(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _)
AND
NOT DB_InRegion((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, (TRIGGER)S_HAG_HagLair_WomanSpot_b18b7488-dbad-433e-b89b-af06a0bc415e)
AND
NOT DB_PermaDefeated((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
NOT DB_HagSpawn_SurrogateMotherAfraid(1);
RemoveStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "ANIM_COWER");

IF
DB_HagSpawn_SurrogateMotherAfraid(1)
AND
NOT DB_Is_InCombat(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, _)
AND
NOT DB_GlobalFlag(HAG_HagLair_State_CageBurning_e1014810-9f1b-46d6-ac5e-8962565fc2b7)
AND
NOT DB_PermaDefeated((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
NOT DB_HagSpawn_SurrogateMotherAfraid(1);
RemoveStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "ANIM_COWER");

IF
DB_HagSpawn_SurrogateMotherAfraid(1)
THEN
ApplyStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "ANIM_COWER", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//END_REGION

//REGION Hag Items StoryObject toggle to prevent trading them (hack until GUS-168258) 
PROC
PROC_HAG_HagLair_Combat_Init()
THEN
DB_HAG_HagLair_GrenadeTemplates(LOOT_HAG_Throwable_Goo_Ball_A_Fire_A_a0b56e94-bd59-4cfd-af1b-bb07ff95f931);
DB_HAG_HagLair_GrenadeTemplates(LOOT_HAG_Throwable_Goo_Ball_A_Poison_A_dfafe6b2-fa8a-49c2-bf93-1966736a7ce9);

IF
TemplateRemovedFrom(_Template,_Grenade,_)
AND
DB_HAG_HagLair_GrenadeTemplates((ITEMROOT)_Template)
THEN
SetStoryItem((ITEM)_Grenade,0);

//END_REGION

//REGION Hag begs for Mercy

IF
TurnStarted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_CantTalk_IgnoreCombat(HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagInLair_b1559527-2aa5-41e1-bab2-89ace2bf450c) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)HAG_HagLair_Event_HagBegsForMercy_591edd40-4668-4eca-99d1-3a41a4189bbf) // flagType: Global
AND
GetHitpointsPercentage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Per)
AND
_Per < 20
AND
DB_Is_InCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Combat)
AND
QRY_HAG_FindHagSurrenderTarget(_Combat)
AND
DB_QRYRTN_HAG_FindHagSurrenderTarget(_Player)
AND
QRY_HAG_SurrenderMayrina()
AND
DB_QRYRTN_HAG_SurrenderMayrina(_Mayrina)
AND 
QRY_StartDialogCustom(DIALOGRESOURCEGUID_HAG_HagLair_HagBegsForMercy_071783af-7275-172e-a255-aa0b600b9a0f, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _Mayrina, _Player, 0, 0, -1, 0)
THEN
PROC_HAG_Surrender_TeleportMayrina(_Mayrina);
SetFlag((FLAG)HAG_HagLair_Event_HagBegsForMercy_591edd40-4668-4eca-99d1-3a41a4189bbf, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

QRY
QRY_HAG_FindHagSurrenderTarget((GUIDSTRING)_Combat)
AND
DB_QRYRTN_HAG_FindHagSurrenderTarget(_Player)
THEN
NOT DB_QRYRTN_HAG_FindHagSurrenderTarget(_Player);

QRY
QRY_HAG_FindHagSurrenderTarget((GUIDSTRING)_Combat)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _Combat)
AND
NOT DB_HiddenCharacters(_Player, _)
AND
NOT DB_CantTalk_IgnoreCombat(_Player)
THEN
DB_QRYRTN_HAG_FindHagSurrenderTarget(_Player);

IF
DB_QRYRTN_HAG_FindHagSurrenderTarget(_Player)
AND
DB_QRYRTN_HAG_FindHagSurrenderTarget(_OtherPlayer)
AND
GetDistanceTo(_Player, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _DistNew)
AND
GetDistanceTo(_OtherPlayer, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _DistOld)
AND
_DistNew < _DistOld
THEN
NOT DB_QRYRTN_HAG_FindHagSurrenderTarget(_OtherPlayer);
DB_QRYRTN_HAG_FindHagSurrenderTarget(_Player);


QRY
QRY_HAG_SurrenderMayrina()
THEN
NOT DB_QRYRTN_HAG_SurrenderMayrina((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
DB_QRYRTN_HAG_SurrenderMayrina(NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_HAG_SurrenderMayrina()
AND
NOT DB_CantTalk_IgnoreCombat(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07,1)
THEN
DB_QRYRTN_HAG_SurrenderMayrina((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
NOT DB_QRYRTN_HAG_SurrenderMayrina(NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_HAG_Surrender_TeleportMayrina((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
TeleportTo(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PlayEffect(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f);
SetFlag((FLAG)HAG_HagLair_SurrogateMotherInMercyDialog_bc90bc84-e2e6-1aab-1776-cea57d42d4df, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
DB_DialogName((DIALOGRESOURCE)HAG_HagLair_HagBegsForMercy_071783af-7275-172e-a255-aa0b600b9a0f,(INTEGER)_Id)
AND
DB_Players(_Player)
AND
NOT DB_InteractiveDialogSpeaker(_,_Player)
AND
DB_Is_InCombat(_Player,_CId)
AND
DB_Is_InCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_CId)
THEN
PROC_DialogAddListeningActor(_Id,_Player);

IF
DialogEnded(DIALOGRESOURCEGUID_HAG_HagLair_HagBegsForMercy_071783af-7275-172e-a255-aa0b600b9a0f,_)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagTookMother_38dc6752-5ab3-e108-64ed-fe63971d69fd) // flagType: Global
THEN
PROC_Poof(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f);

IF
DialogEnded(DIALOGRESOURCEGUID_HAG_HagLair_HagBegsForMercy_071783af-7275-172e-a255-aa0b600b9a0f,_)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagGivenMercy_a3c0a36a-ccce-4f35-7b54-9ab22d6ac534) // flagType: Global
THEN
PROC_Poof(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f);

//Defeated Flag
IF
FlagSet((FLAG)_Flag, _, _) // flagType: Global
AND
DB_HAG_HagLair_HagDefeatedFlags((FLAG)_Flag)
THEN
SetFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
PROC_DangerZone_Safe("HAG_HagLair");

IF
DB_KnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
SetFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

//END_REGION

//REGION Mayrina Event

//REGION Spell can only be used if Mayrina is freed in the Lair
IF
FlagSet(HAG_HagLair_PenOpened_caa8579f-036d-4884-87df-89ef6fd6b91b,_,_)
AND
NOT DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
QRY_OnlyOnce("HAG_HagLair_MayrinaEventAccessable")
THEN
PROC_HAG_HagLair_MayrinaEventAccessable();

IF
FlagSet(HAG_HagLair_AttackedCage_51a4833f-45ea-4eb1-9c9e-32f46ad6fe14, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _)
AND
NOT DB_HAG_HagLair_HagAttackedCage(1)
THEN
DB_HAG_HagLair_HagAttackedCage(1);

//Let the Hag use the Mayrina event if the player doused the cage
IF
StatusRemoved(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23,"BURNING",_,_)
AND
DB_HAG_HagLair_HagAttackedCage(1)
AND
NOT DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
QRY_OnlyOnce("HAG_HagLair_MayrinaEventAccessable")
THEN
PROC_HAG_HagLair_MayrinaEventAccessable();
//END_REGION

PROC
PROC_HAG_SpawnDoubles_MayrinaIllusion((CHARACTER)_Hag)
THEN
SetFlag((FLAG)HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d, NULL_00000000-0000-0000-0000-000000000000);

//Find random spots to move the Hag and Mayrina to - using same pipeline as the spawn doubles
PROC
PROC_HAG_SpawnDoubles_MayrinaAndHagPositionChange((CHARACTER)_Char,(CHARACTER)_Victim)
AND
DB_HAG_HagLair_DoublesSpawnPoints_Available((TRIGGER)_Trigger)
AND
QRY_HAG_HagLair_DoublesSpawnPoint_GetClosest((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Trigger)
THEN
DB_NOOP(1);

PROC
PROC_HAG_SpawnDoubles_MayrinaAndHagPositionChange((CHARACTER)_Char,(CHARACTER)_Victim)
AND
DB_HAG_HagLair_DoublesSpawnPoints_DistToCaster(_Trigger,_Dist)
AND
DB_HAG_HagLair_DoublesSpawnPoints_Available(_Trigger)
AND
GetPosition(_Trigger,_X,_Y,_Z)
AND
FindValidPosition(_X,_Y,_Z,12.0,_Char,1,_NewX,_NewY,_NewZ)
AND
GetPosition(_Char,_CasterX,_CasterY,_CasterZ)
AND
FindValidPosition(_CasterX,_CasterY,_CasterZ,12.0,_Victim,1,_VictimX,_VictimY,_VictimZ)
AND
DB_HAG_HagLair_DoublesSpawnFxHelper(_Helper)
THEN
NOT DB_HAG_SpawnDoubles_FindValidPosition(_Char,_X,_Y,_Z);
NOT DB_HAG_HagLair_DoublesSpawnPoints_Available(_Trigger);
TeleportToPosition(_Char,_NewX,_NewY,_NewZ,"HAG_HagLair_MayrinaEventSpawnFx",0,0,0);
TeleportToPosition(_Victim,_VictimX,_VictimY,_VictimZ,"",0,0,0);
PlayEffectAtPosition(VFX_Script_Hag_Trickery_Reappear_01_eaf17f6c-d71a-9c19-7639-2a7744ef1cad,_NewX,_NewY,_NewZ);
PlayEffectAtPosition(VFX_Script_Hag_Trickery_Reappear_01_eaf17f6c-d71a-9c19-7639-2a7744ef1cad,_VictimX,_VictimY,_VictimZ);
PlayEffect(_Char,VFX_Script_Hag_Trickery_Reappear_Overlay_01_210d83e8-eaed-65ed-8a59-cdcbb3c7ae79,"Dummy_BodyFX");
PlayEffect(_Victim,VFX_Script_Hag_Trickery_Reappear_Overlay_01_210d83e8-eaed-65ed-8a59-cdcbb3c7ae79,"Dummy_BodyFX");

//Beam Fx to Hag
IF
EntityEvent(_Char,"HAG_HagLair_MayrinaEventSpawnFx")
AND
DB_HAG_HagLair_DoublesSpawnFxHelper(_Helper)
THEN
PlayBeamEffect(_Helper,_Char,VFX_Script_Hag_Trickery_Beam_01_556102a9-7070-a5f2-3790-319e86f30c98,"","");

PROC
PROC_HAG_SpawnDoubles_MayrinaIllusion((CHARACTER)_Hag)
THEN
PROC_HAG_ApplyDoublesStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,-1.0);
PROC_HAG_ApplyDoublesStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,-1.0);

//REGION Create new state for hag/mayrina

IF
UsingSpell(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"Shout_HAG_SpawnDoubles_MayrinaIllusion",_,_,_)
THEN
TimerLaunch("HAG_SpawnDoubles_MayrinaIllusion_MayrinaFxDelay",500);

IF
TimerFinished("HAG_SpawnDoubles_MayrinaIllusion_MayrinaFxDelay")
THEN
PlayEffect(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,VFX_Script_Hag_Trickery_Victim_Disappearing_01_16a24d20-baed-6e2c-4eb8-3dbf5b05dd62,"Dummy_BodyFX");

//Spawn the Hag and Mayrina in new locations near eachother
IF
DB_GlobalFlag(HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d)
THEN
DB_DoNotRemoveKnockedOutCharacterOnLongRest(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
DB_ForceTemporaryKnockedOut(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
ObjectSetTitleHidden(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1);
PROC_SetRelationToPlayers((FACTION)ACT1_HAG_SurrogateMother_87a64aac-e57e-caa2-9a8e-3c0a08b72841,0);
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_DISGUISE_MAYRINA",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
PROC_TryStartAD((DIALOGRESOURCE)HAG_HagLair_AD_MayrinaIllusion_Fake_4448acfa-be42-ab3e-94ba-a798a2e79581,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_HAG_SpawnDoubles_GetAvailableSpawnPoints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_HAG_SpawnDoubles_MayrinaAndHagPositionChange(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
PROC_HAG_HagLair_DoublesSpawnPoints_CleanUp();
RealtimeObjectTimerLaunch(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_MayrinaEvent_MayrinaAD_Delay",1000);
RealtimeObjectTimerLaunch(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_MayrinaEvent_HagCower_Delay",500);

IF
FlagSet((FLAG)HAG_Hag_State_HagTookMother_38dc6752-5ab3-e108-64ed-fe63971d69fd, _, _)
THEN
NOT DB_DoNotRemoveKnockedOutCharacterOnLongRest(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
NOT DB_ForceTemporaryKnockedOut(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

PROC
PROC_StateSet_PermaDefeated(HAG_Hag_State_HagTookMother_38dc6752-5ab3-e108-64ed-fe63971d69fd)
THEN
NOT DB_DoNotRemoveKnockedOutCharacterOnLongRest(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
NOT DB_ForceTemporaryKnockedOut(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

IF
FlagSet((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720, _, _)
AND
NOT DB_KnockedOut(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
NOT DB_DoNotRemoveKnockedOutCharacterOnLongRest(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
NOT DB_ForceTemporaryKnockedOut(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

IF
StatusRemoved(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "KNOCKED_OUT_TEMPORARILY", _, _)
THEN
NOT DB_DoNotRemoveKnockedOutCharacterOnLongRest(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
NOT DB_ForceTemporaryKnockedOut(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

IF
ObjectTimerFinished(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_MayrinaEvent_HagCower_Delay")
THEN
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"ANIM_COWER",-1.0,1);

IF
ObjectTimerFinished(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_MayrinaEvent_MayrinaAD_Delay")
THEN
PROC_TryStartAD((DIALOGRESOURCE)HAG_HagLair_AD_MayrinaIllusion_Real_eeb9ed5d-1348-3036-4258-2c914dd634fe,(CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

IF
FlagCleared((FLAG)HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d,_,_)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_DISGUISE_MAYRINA");
PlayEffect(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,VFX_Script_Hag_Trickery_Reappear_Overlay_01_210d83e8-eaed-65ed-8a59-cdcbb3c7ae79,"Dummy_BodyFX");

IF
TurnStarted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_GlobalFlag(HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d)
THEN
SetEntityEventReal(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"GLO_CombatWait",2.0);
PROC_TryStartAD((DIALOGRESOURCE)HAG_HagLair_AD_MayrinaIllusion_Fake_4448acfa-be42-ab3e-94ba-a798a2e79581,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
UsingSpell(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"Target_HAG_SinisterStrike",_,_,_)
THEN
PROC_TryStartAD((DIALOGRESOURCE)HAG_HagLair_AD_HagCackles_726c595a-b3e3-3ba7-043c-11db987fd5a6,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
//END_REGION

//Exit State
IF
StatusRemoved(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_DOUBLES",_,_)
AND
DB_GlobalFlag(HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d)
THEN
PROC_HAG_CMB_ExitMayrinaIllusionState();

IF
StatusRemoved(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_DOUBLES",_,_)
AND
DB_GlobalFlag(HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d)
THEN
PROC_HAG_CMB_ExitMayrinaIllusionState();
PROC_TryStartAD((DIALOGRESOURCE)HAG_HagLair_AD_MayrinaIllusion_Real_eeb9ed5d-1348-3036-4258-2c914dd634fe,(CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

IF
CastedSpell(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"Target_HAG_SinisterStrike",_,_,_)
AND
DB_GlobalFlag(HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d)
THEN
PROC_HAG_CMB_ExitMayrinaIllusionState();

PROC
PROC_HAG_CMB_ExitMayrinaIllusionState()
THEN
ObjectSetTitleHidden(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,0);
PROC_SetRelationToPlayers((FACTION)ACT1_HAG_SurrogateMother_87a64aac-e57e-caa2-9a8e-3c0a08b72841,50);
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_DOUBLES");
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"ANIM_COWER");
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_DISGUISE_MAYRINA");
ClearFlag((FLAG)HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d,NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"HAG_DOUBLES");
PlayEffect(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(EFFECTRESOURCE)VFX_Script_Hag_Trickery_Reappear_01_eaf17f6c-d71a-9c19-7639-2a7744ef1cad,"Dummy_BodyFX");

//REGION Mayrina Event state Fallbacks 
//Verify state on turn
IF
TurnStarted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_GlobalFlag(HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d)
AND
HasActiveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_DISGUISE_MAYRINA",0)
THEN
PROC_HAG_CMB_ExitMayrinaIllusionState();

IF
TurnStarted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
HasActiveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_DISGUISE_MAYRINA",1)
AND
NOT DB_GlobalFlag(HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d)
THEN
PROC_HAG_CMB_ExitMayrinaIllusionState();

//END_REGION
//END_REGION

//REGION Debug

IF
TextEvent("HagLairSetup")
THEN
SetFlag((FLAG)Debug_HAG_HagLair_Setup_88c35db3-7221-c3aa-dfda-4866fe0ceea5, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
TextEvent("HAG_ClearPetrify")
THEN
RemoveStatus(S_HAG_HagLair_Victim_001_48062828-eb14-43ab-ac97-3d7ed6cb2ecd,"PETRIFIED");

IF
FlagSet(Debug_HAG_HagLair_Setup_88c35db3-7221-c3aa-dfda-4866fe0ceea5, _, _) // flagType: Global
AND
GetHostCharacter((CHARACTER)_Player)
THEN
SetFlag((FLAG)HAG_Debug_TeleportOutOfDen_424a57d9-00a9-4453-462a-9a24e2fdcb42, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
FlushOsirisQueue(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetEntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_LairEntrance_Event_IllusionDispelCast");
SetEntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"ClearPeaceReturn", 1);
PROC_HAG_TeaSceneOver();
TimerLaunch("Debug_HAG_HagLair_Setup_Timer",1000);

IF
TimerFinished("Debug_HAG_HagLair_Setup_Timer")
THEN
SetFlag((FLAG)GLO_Hag_State_Transformed_c4c1bbcb-28d2-d607-2658-a06f1cf89d95, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
PROC_TryStartAD(DIALOGRESOURCEGUID_HAG_Hag_AD_TeleportSurrogateMother_d32494d4-0658-adb7-4433-82486e723607,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_ForceStopDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetEntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "HAG_Hag_HagEscape_PastAtHatch");
TeleportTo(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,S_HAG_Lair_HagSpot_fdd01e3a-b187-4109-8444-195574033955,"");
SetOnStage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 1);
PROC_HAG_SetupSurrogateMotherCage();

//Mercy Event
IF
TextEvent("HagMercy")
THEN
SetHitpointsPercentage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,9.0);
ApplyDamage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1,"Piercing",NULL_00000000-0000-0000-0000-000000000000);

//FX testing
IF
TextEvent("HagFxTest")
AND
GetHostCharacter((CHARACTER)_Player)
THEN
SetFlag((FLAG)Debug_HAG_HagLair_Setup_88c35db3-7221-c3aa-dfda-4866fe0ceea5, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
MakePlayer(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player);
DB_Debug_HagFxTest(1);

IF
TimerFinished("Debug_HAG_HagLair_Setup_Timer")
AND
DB_Debug_HagFxTest(1)
THEN
MakePlayerActive(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"INVISIBLE");
SetFlag((FLAG)HAG_HagLair_PenOpened_caa8579f-036d-4884-87df-89ef6fd6b91b, NULL_00000000-0000-0000-0000-000000000000, 0); ////////////
TeleportTo(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_HAG_HagLair_WomanCombatFleeSpot_41cf48af-5364-41cb-a35d-f5509459b711,"");
NOT DB_Debug_HagFxTest(1);

//Reset Fx test
IF
TextEvent("HagFxTest_ClearDoubles")
AND
DB_HAG_HagLair_Doubles(_Double)
THEN
SetEntityEvent(_Double,"HAG_RemoveDouble");

IF
TextEvent("HagFxTest_ClearDoubles")
THEN
ClearFlag((FLAG)HAG_CMB_MayrinaIllusion_Real_289009b8-4d9f-403f-aa56-102f1b64dc6d,NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION Drop Paladins who work with Ethel
IF
FlagSet((FLAG)HAG_Hag_State_HagTookMother_38dc6752-5ab3-e108-64ed-fe63971d69fd, _, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
IsTagged(_Player, (TAG)PALADIN_DEVOTION_2de0a4fc-5831-4439-94d3-a7ff9b7aacf6, 1)
THEN
PROC_GLO_PaladinOathbreaker_BrokeOath((CHARACTER)_Player);

IF
FlagSet((FLAG)HAG_Hag_State_HagGivenMercy_a3c0a36a-ccce-4f35-7b54-9ab22d6ac534, _, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
IsTagged(_Player, (TAG)PALADIN_DEVOTION_2de0a4fc-5831-4439-94d3-a7ff9b7aacf6, 0)
AND
IsTagged(_Player, (TAG)PALADIN_6d85ab2d-5c23-498c-a61e-98f05a00177a, 1)
THEN
PROC_GLO_PaladinOathbreaker_BrokeOath((CHARACTER)_Player);



//END_REGION

//REGION AI helper for the lever
IF
DB_InRegion(_Character, S_HAG_HagLair_MayrinaCage_AIHelperTrigger_1df6fdca-a463-47e4-994a-4c2fa838d71b)
AND
DB_HAG_Hagspawn_SetupCageHelperTrigger(1)
THEN
DB_HAG_Hagspawn_InCageHelpertrigger(_Character);

IF
DB_HAG_Hagspawn_InCageHelpertrigger(_Character)
AND
NOT DB_InRegion(_Character, S_HAG_HagLair_MayrinaCage_AIHelperTrigger_1df6fdca-a463-47e4-994a-4c2fa838d71b)
THEN
NOT DB_HAG_Hagspawn_InCageHelpertrigger(_Character);

IF
DB_HAG_Hagspawn_InCageHelpertrigger(_Character)
AND
NOT DB_HAG_Hagspawn_SetupCageHelperTrigger(1)
THEN
NOT DB_HAG_Hagspawn_InCageHelpertrigger(_Character);

IF
DB_HAG_Hagspawn_SetupCageHelperTrigger(1)
AND
DB_Is_InCombat(_Character, _Combat)
AND
IsCharacter(_Character, 1)
AND
DB_HAG_Hagspawn_InCageHelpertrigger((CHARACTER)_Character)
AND
DB_Is_InCombat(_OtherCharacter, _Combat)
AND
IsCharacter(_OtherCharacter, 1)
AND
IsEnemy((CHARACTER)_OtherCharacter, (CHARACTER)_Character, 1)
AND
_OtherCharacter != S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d
AND
NOT DB_HAG_HagDoubles(_OtherCharacter, _)
AND
NOT DB_HAG_MaskedVictims(_OtherCharacter, _, _, _)
THEN
SetTag(_OtherCharacter, (TAG)HAG_AIHELPER_CAGELEVER_28d93787-9cce-47bd-b111-8f0c483fbade);
DB_HAG_Hagspawn_InterestedInLever((CHARACTER)_OtherCharacter);
  
IF
RelationChanged(_, _, _, _)
AND
DB_HAG_Hagspawn_SetupCageHelperTrigger(1)
AND
DB_Is_InCombat(_Character, _Combat)
AND
IsCharacter(_Character, 1)
AND
DB_HAG_Hagspawn_InCageHelpertrigger((CHARACTER)_Character)
AND
DB_Is_InCombat(_OtherCharacter, _Combat)
AND
IsCharacter(_OtherCharacter, 1)
AND
IsEnemy((CHARACTER)_OtherCharacter, (CHARACTER)_Character, 1)
AND
_OtherCharacter != S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d
AND
NOT DB_HAG_HagDoubles(_OtherCharacter, _)
AND
NOT DB_HAG_MaskedVictims(_OtherCharacter, _, _, _)
THEN
SetTag(_OtherCharacter, (TAG)HAG_AIHELPER_CAGELEVER_28d93787-9cce-47bd-b111-8f0c483fbade);
DB_HAG_Hagspawn_InterestedInLever((CHARACTER)_OtherCharacter);

IF
DB_HAG_Hagspawn_InterestedInLever(_Character)
AND
NOT DB_Is_InCombat(_Character, _)
THEN
NOT DB_HAG_Hagspawn_InterestedInLever(_Character);
ClearTag(_Character, (TAG)HAG_AIHELPER_CAGELEVER_28d93787-9cce-47bd-b111-8f0c483fbade);

IF
DB_HAG_Hagspawn_InterestedInLever(_Character)
AND
NOT DB_HAG_Hagspawn_InCageHelpertrigger(_)
THEN
NOT DB_HAG_Hagspawn_InterestedInLever(_Character);
ClearTag(_Character, (TAG)HAG_AIHELPER_CAGELEVER_28d93787-9cce-47bd-b111-8f0c483fbade);

IF
DB_HAG_Hagspawn_InterestedInLever(_Character)
AND
NOT DB_HAG_Hagspawn_SetupCageHelperTrigger(1)
THEN
NOT DB_HAG_Hagspawn_InterestedInLever(_Character);
ClearTag(_Character, (TAG)HAG_AIHELPER_CAGELEVER_28d93787-9cce-47bd-b111-8f0c483fbade);

//END_REGION

IF
DB_CurrentLevel("CTY_Main_A")
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
