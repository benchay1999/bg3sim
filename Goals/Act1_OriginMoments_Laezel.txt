Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Laezel Origin Moments
TriggerRegisterForCharacter((TRIGGER)S_DEN_General_Laezel_CommentAfterVisitingGrove_ea4a466a-7449-4630-81ef-86fb1204dd02,(CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

PROC_DefineSingleOriginMoment(DEN_General_TieflingGuard11_5285ea7c-7994-ba01-02c7-fa05017342ee,(TAG)LAEZEL_3b07eac7-fab3-4120-a46c-51dbb3ec500b,(DIALOGRESOURCE)DEN_ThingLikeMe_OM_Laezel_AOM_OOM_ee6c3da5-c872-803e-77c5-79f4f22795a8,(DIALOGRESOURCE)DEN_ThingLikeMe_OM_Laezel_COM_b1e7f9b2-9726-8868-f1e4-c3a6cf574e2c,(DIALOGRESOURCE)DEN_ThingLikeMe_OM_Laezel_AOM_OOM_ee6c3da5-c872-803e-77c5-79f4f22795a8);
DB_DEN_ThingLikeMe_TieflingPositions((FLAG)DEN_ThingLikeMe_State_TieflingStand_d4869137-9586-2f01-292c-78909b45e3f8, "DEN_ThingLikeMe_HideFear");
DB_DEN_ThingLikeMe_TieflingPositions((FLAG)DEN_ThingLikeMe_State_TieflingBow_438787a5-d483-a51b-4a57-668f7956dcc2, "DEN_ThingLikeMe_KneelHideFear");
DB_DEN_ThingLikeMe_TieflingPositions((FLAG)DEN_ThingLikeMe_State_TieflingKneel_fdfebaa6-dbfa-35ff-8e52-28c603bad645, "DEN_ThingLikeMe_LowBowFearful");
DB_DEN_ThingLikeMe_CurrentPosition((FLAG)DEN_ThingLikeMe_State_TieflingStand_d4869137-9586-2f01-292c-78909b45e3f8, "DEN_ThingLikeMe_HideFear");

DB_DEN_ThingLikeMe_OriginDialogs((DIALOGRESOURCE)DEN_ThingLikeMe_OM_Laezel_AOM_OOM_ee6c3da5-c872-803e-77c5-79f4f22795a8);
DB_DEN_ThingLikeMe_OriginDialogs(DEN_ThingLikeMe_OM_Laezel_COM_b1e7f9b2-9726-8868-f1e4-c3a6cf574e2c);

DB_PermaDefeatedFlag(S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f, (FLAG)ORI_Laezel_Quest_ZorruIsPermaDefeated_209f9a35-5e97-4f13-bd6e-25b05fc85975);
DB_SeenDeadNPCGlobalFlag(S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f, (FLAG)ORI_Laezel_Quest_SawDeadZorru_10783903-034f-41be-ad6a-e2cbbb73242a);
//END_REGION

DB_CampNight((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,2030 /*3030 for avatar*/,(CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
DB_CampNight_Camp((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,"WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,"WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,"WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,"WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,"WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,"WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,"WLDBAS");
DB_CampNight_ExpiresAfter((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,1);
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,(FLAG)GLO_GithChokepoint_Event_LaezelOMStarted_84283682-101d-1531-7aae-33aa56999a70);
DB_CampNight_CancelledBy(NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5, (FLAG)ORI_laezel_State_HadAfterChokepointDiscussion_e90acc28-3c0c-476c-ac2d-2d074a666b96);
DB_CampNight_CRD((FLAG)NIGHT_Laezel_GithChokepoint_63990fd7-ff59-4c1b-b9e5-5961cde235d5,(CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(DIALOGRESOURCE)PLA_GithChokepoint_WRD_LaezelAfterVossAtChokepoint_05b0a5cc-5ea2-1c67-acff-a048b3eeb679,(FLAG)NULL_00000000-0000-0000-0000-000000000000);

SetFlag((FLAG)ORI_Laezel_State_HasNotPassedCreche_946ca251-adb9-4177-9e12-64499d02cff1, NULL_00000000-0000-0000-0000-000000000000, 0);
KBSECTION
//REGION Laezel waking up

// Delete when it becomes possible to start as Lae'zel (the trick is to call that during the intro cutscene)
IF
TextEvent("laezelwakingup")
AND
GetHostCharacter(_Player)
THEN
SetFlag(Debug_AddGith_39ecbda9-cb44-becf-57b9-c3b631a5517b, _Player);
SetFlag(Debug_BecomeAvatar_34371b8e-a34b-3354-54e7-fcda800d703a, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
SetFlag(Debug_BecomeCompanion_4670c626-a52f-aeed-c18a-dc8d9c78b7cb, _Player);

//END_REGION

//REGION Fighting in Raiding Party

IF
DB_DEN_GoblinRaidCombatID(_ID)
AND
DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _ID)
AND
NOT DB_GlobalFlag(ORI_Laezel_State_FoughtInRaidingParty_079d3597-a944-46f5-9e74-8abaf9ea3262)
THEN
//gossip condition:
SetFlag(ORI_Laezel_State_FoughtInRaidingParty_079d3597-a944-46f5-9e74-8abaf9ea3262, NULL_00000000-0000-0000-0000-000000000000);


//END_REGION

//REGION Thing Like Me (Laezel Origin Moment)

//Started game without Lae'zel Avatar,send kid to hideout 
PROC
PROC_GLO_Origins_SetupRecruitment("WLD_Main_A")
AND
NOT DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
SetEntityEvent(S_DEN_TieflingKid_004_6644185d-385e-4dfc-973c-bb854cbfd540, "DEN_TieflingKid_004_NoAvatar", 1);

//Started game with Lae'zel Avatar,stop Zorru patrolling, make stand in corner for scene 
PROC
PROC_GLO_Origins_SetupRecruitment("WLD_Main_A")
AND
DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
SetFlag(DEN_ThingLikeMe_State_BeforeOM_9e9cecdb-44ee-4b32-970c-535d1e7a5496, NULL_00000000-0000-0000-0000-000000000000);

//Companion Lae'zel joined party,stop Zorru patrolling, make stand in corner for scene 
IF
CharacterJoinedParty(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_GlobalFlag(DEN_ThingLikeMe_State_OMPlayed_43e9e5e6-8445-489b-b062-453cf8c47b49)
THEN
SetFlag(DEN_ThingLikeMe_State_BeforeOM_9e9cecdb-44ee-4b32-970c-535d1e7a5496, NULL_00000000-0000-0000-0000-000000000000);

//Companion Lae'zel left party,start Zorru patrolling
IF
CharacterLeftParty(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_GlobalFlag(DEN_ThingLikeMe_State_OMPlayed_43e9e5e6-8445-489b-b062-453cf8c47b49)
THEN
ClearFlag(DEN_ThingLikeMe_State_BeforeOM_9e9cecdb-44ee-4b32-970c-535d1e7a5496, NULL_00000000-0000-0000-0000-000000000000);

//Tiefling Kid finished his AD, have Avatar Lae'zel VB in response
IF
EntityEvent((CHARACTER)_Laezel, "DEN_TieflingKid_004_FinishedAD")
AND
IsTagged(_Laezel, (TAG)REALLY_LAEZEL_b5682d1d-c395-489c-9675-1f9b0c328ea5, 1)
THEN
StartVoiceBark((VOICEBARKRESOURCE)DEN_ThingLikeMe_VB_AfterKid_c4e842c6-3901-1072-b868-2cd3622097ab, _Laezel);

//Don't have Zorru do a followup default dialog after the origin moment
QRY
QRY_OriginMoment_PreventRelaunchDialog(_Dialog, S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f, _Player)
AND
DB_DEN_ThingLikeMe_OriginDialogs(_Dialog)
THEN
DB_NOOP(1);

//Zorru won't react to most crimes Lae'zel does, as he's afraid of her
QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_Char,_Type,_,(CHARACTER)S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f,_)
AND
IsTagged(_Char, (TAG)LAEZEL_3b07eac7-fab3-4120-a46c-51dbb3ec500b, 1)
AND
QRY_CRIME_GetCrimeFamily(_Type)
AND
DB_QRYRTN_CRIME_GetCrimeFamily(_Family)
AND
_Family!="Assault"
AND
_Family!="Murder"
AND
DB_GlobalFlag(DEN_ThingLikeMe_State_OMPlayed_43e9e5e6-8445-489b-b062-453cf8c47b49)
THEN
DB_NOOP(1);

//OM done
IF
DialogEnded(_Dialog, _Id)
AND
DB_DEN_ThingLikeMe_OriginDialogs(_Dialog)
THEN
PROC_DEN_ThingLikeMe_OriginDialogEnded(_Id);
PROC_DEN_ThingLikeMe_OMEndedJournalHook();

PROC
PROC_DEN_ThingLikeMe_OMEndedJournalHook()
THEN
DB_NOOP(1);

PROC
PROC_DEN_ThingLikeMe_OriginDialogEnded((INTEGER)_Id)
AND
NOT DB_GlobalFlag(DEN_ThingLikeMe_State_OMPlayed_43e9e5e6-8445-489b-b062-453cf8c47b49)
THEN
SetFlag((FLAG)DEN_ThingLikeMe_State_OMPlayed_43e9e5e6-8445-489b-b062-453cf8c47b49, NULL_00000000-0000-0000-0000-000000000000, 0);

//Trigger Lae'zel followup RD after OM
PROC
PROC_DEN_ThingLikeMe_OriginDialogEnded((INTEGER)_Id)
AND
GetFlag(DEN_ThingLikeMe_Event_Followup_9e143f99-e9fe-16e5-2632-ec4393639d4d, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_DialogPlayers(_Id,_Laezel,1)
AND
IsTagged(_Laezel, (TAG)REALLY_LAEZEL_b5682d1d-c395-489c-9675-1f9b0c328ea5, 1)
AND
QRY_OnlyOnce("DEN_ThingLikeMe_RD_LaezelCreche")
THEN
PROC_RelationshipDialog((CHARACTER)_Laezel, (DIALOGRESOURCE)DEN_ThingLikeMe_RD_LaezelCreche_0ff96e33-eeac-3fb6-54bd-bbee82f8db46, _Laezel);

//Zorru saw Lae'zel, figure out which animation to switch into if any
IF
Saw(S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f, (CHARACTER)_Char, _)
AND
IsTagged(_Char, (TAG)LAEZEL_3b07eac7-fab3-4120-a46c-51dbb3ec500b, 1)
AND
DB_GlobalFlag((FLAG)DEN_ThingLikeMe_State_OMPlayed_43e9e5e6-8445-489b-b062-453cf8c47b49)
AND
DB_DEN_ThingLikeMe_CurrentPosition(_Flag, _Animation)
AND
GetFlag(_Flag, S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f, 1)
THEN
PROC_DEN_ThingLikeMe_ChangeDialogPosition((STRING)_Animation, (CHARACTER)_Char);
SetFlag((FLAG)DEN_ThingLikeMe_State_AnimateForLaezel_6acad37a-9107-45fd-be56-47f1396085b3, NULL_00000000-0000-0000-0000-000000000000, 0);

//Zorru lost sight of Lae'zel, return to default animation
IF
LostSightOf((CHARACTER)S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f, (CHARACTER)_Char)
AND
IsTagged(_Char, (TAG)LAEZEL_3b07eac7-fab3-4120-a46c-51dbb3ec500b, 1)
THEN
PROC_DEN_ThingLikeMe_ChangeDialogPosition("DEN_ThingLikeMe_HideFear", (CHARACTER)_Char);
ClearFlag((FLAG)DEN_ThingLikeMe_State_AnimateForLaezel_6acad37a-9107-45fd-be56-47f1396085b3, NULL_00000000-0000-0000-0000-000000000000, 0);

//Zorru animates externally while in the timeline
IF
FlagSet((FLAG)_Flag, S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f, _Id)
AND
DB_DEN_ThingLikeMe_TieflingPositions(_Flag, _Animation)
AND
NOT DB_DEN_ThingLikeMe_CurrentPosition(_Flag, _Animation)
AND
DB_DialogPlayers(_Id,_Char,_)
AND
IsTagged(_Char, (TAG)LAEZEL_3b07eac7-fab3-4120-a46c-51dbb3ec500b, 1)
THEN
SysClear("DB_DEN_ThingLikeMe_CurrentPosition", 2);
DB_DEN_ThingLikeMe_CurrentPosition(_Flag, _Animation);
PROC_DEN_ThingLikeMe_ChangeDialogPosition((STRING)_Animation, (CHARACTER)_Char);
SetFlag((FLAG)DEN_ThingLikeMe_State_AnimateForLaezel_6acad37a-9107-45fd-be56-47f1396085b3, NULL_00000000-0000-0000-0000-000000000000, 0);

//Event caught in Anubis
PROC
PROC_DEN_ThingLikeMe_ChangeDialogPosition((STRING)_Animation, (CHARACTER)_Char)
AND
_Animation!=""
THEN
SetDualEntityEvent(S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f,_Char,_Animation);
//END_REGION

//REGION General Grove Moments (Laezel Origin Moment)
IF
EnteredTrigger((CHARACTER)_Laezel, (TRIGGER)S_DEN_Cave_SUB_adecafa4-27c6-4b2f-bf9e-6ffd7c81a766)
AND
IsTagged(_Laezel, (TAG)REALLY_LAEZEL_b5682d1d-c395-489c-9675-1f9b0c328ea5, 1)
AND
GetFlag(DEN_LaezelGeneral_Event_ExploredGrove_f175174d-d17c-4cc7-8f6c-e53d5d966c7c, _Laezel, 0)
THEN
SetFlag(DEN_LaezelGeneral_Event_ExploredGrove_f175174d-d17c-4cc7-8f6c-e53d5d966c7c, _Laezel, 0);

IF
EnteredTrigger((CHARACTER)_Laezel, (TRIGGER)S_DEN_General_Laezel_CommentAfterVisitingGrove_ea4a466a-7449-4630-81ef-86fb1204dd02)
AND
GetFlag(DEN_LaezelGeneral_Event_ExploredGrove_f175174d-d17c-4cc7-8f6c-e53d5d966c7c, _Laezel, 1)
AND
NOT DB_GlobalFlag((FLAG)DEN_AttackOnDen_Event_Start_c641da6a-b3f5-4873-bd34-c53768d30d6f)
AND
NOT DB_GlobalFlag((FLAG)DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
AND
NOT DB_GlobalFlag((FLAG)DEN_ShadowDruid_State_CourtHostile_b79f3102-f47e-339c-23f2-1de2c38d4e6e)
AND
NOT DB_GlobalFlag((FLAG)DEN_Lockdown_State_Active_0b54c7d2-b7b1-4d0f-b8e4-0cf1ee32b1eb)
AND
NOT DB_GlobalFlag((FLAG)DEN_TieflingLeader_State_PermaDefeated_b8eac5ee-2c63-9924-91c2-668d5bffa74c)
AND
NOT DB_OnlyOnce("DEN_LaezelGeneral_WRD_LeftGrove")
THEN
StartVoiceBark((VOICEBARKRESOURCE)DEN_LaezelGeneral_VB_FishOutofWater_100ec4a4-238c-de7e-59c0-62f6361ecc61, _Laezel);
TriggerUnregisterForCharacter((TRIGGER)S_DEN_General_Laezel_CommentAfterVisitingGrove_ea4a466a-7449-4630-81ef-86fb1204dd02,(CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
//END_REGION

IF
TextEvent("thinglikemedone")
THEN
SetFlag(DEN_ThingLikeMe_State_TieflingBow_438787a5-d483-a51b-4a57-668f7956dcc2,S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f,0);
SysClear("DB_DEN_ThingLikeMe_CurrentPosition", 2);
DB_DEN_ThingLikeMe_CurrentPosition(DEN_ThingLikeMe_State_TieflingBow_438787a5-d483-a51b-4a57-668f7956dcc2, "DEN_ThingLikeMe_KneelHideFear");
SetFlag(DEN_ThingLikeMe_State_OMPlayed_43e9e5e6-8445-489b-b062-453cf8c47b49, NULL_00000000-0000-0000-0000-000000000000, 0);
SetEntityEvent(S_DEN_Tiefling_011_77439e86-3f60-4456-bd55-931e2f45654f, "DEN_ThingLikeMe_KneelHideFear");
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
