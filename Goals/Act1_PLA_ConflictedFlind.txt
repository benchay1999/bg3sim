Version 1
SubGoalCombiner SGC_AND
INITSECTION
PROC_TriggerRegisterForParty((TRIGGER)S_PLA_ConflictedFlind_Cave_DangerZone_0aa90ecf-f46e-441e-ac25-8a9e236f2738);

DB_PLA_ConflictedFlind_Gnolls_States((FLAG)PLA_ConflictedFlind_State_NotEncountered_c4bed850-2d45-4806-bc6d-5d778e60cde4);
DB_PLA_ConflictedFlind_Gnolls_States((FLAG)PLA_ConflictedFlind_State_Hostile_4ba98bb7-f66b-a105-b5fd-0569dd61b030);
DB_PLA_ConflictedFlind_Gnolls_States((FLAG)PLA_ConflictedFlind_State_TalkingToFlind_dd11bd98-c488-4964-83aa-765ddd7b0562);
DB_PLA_ConflictedFlind_Gnolls_States((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2);
DB_PLA_ConflictedFlind_Gnolls_States((FLAG)PLA_ConflictedFlind_State_AfterKilledRegularGnolls_51320d12-ea6d-4948-99dd-5cf372577fb2);
DB_PLA_ConflictedFlind_Gnolls_States((FLAG)PLA_ConflictedFlind_State_AfterLongRest_346fa778-1a8a-4793-9abf-f129445e0631);
DB_PLA_ConflictedFlind_Gnolls_States((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2);
PROC_GlobalSetFlagAndCache((FLAG)PLA_ConflictedFlind_State_NotEncountered_c4bed850-2d45-4806-bc6d-5d778e60cde4);

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("PLA_ConflictedFlind_Gnolls",(FLAG)PLA_ConflictedFlind_State_Dead_89900583-c7c4-4f3b-9352-fda1fc57a9e2);

//REGION Pack
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_Ranger_01_8c73365b-a23e-4aba-b556-fa7dedc8d33b);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_Ranger_02_008ec55e-ce89-49f0-b50d-0fe705951a32);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_Ranger_03_81b29ac1-ba32-466b-bca8-9bb555aa3a6d);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_FleshGnawer_01_4929dbdd-bf47-4fb2-aa07-3814c7eac07c);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_FangOfYeenoghu_01_f787a3c0-ecde-480d-a24b-5ec18f191f03);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Hyena_01_69bc3485-8f3b-4a76-a3ca-fd9da89bb908);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Hyena_02_9c5f8832-a4c3-43c7-a860-4d7b4aa309b5);

DB_PLA_ConflictedFlind_GnollPack((CHARACTER)S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_Ranger_01_8c73365b-a23e-4aba-b556-fa7dedc8d33b);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_Ranger_02_008ec55e-ce89-49f0-b50d-0fe705951a32);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_Ranger_03_81b29ac1-ba32-466b-bca8-9bb555aa3a6d);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_FleshGnawer_01_4929dbdd-bf47-4fb2-aa07-3814c7eac07c);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Gnoll_FangOfYeenoghu_01_f787a3c0-ecde-480d-a24b-5ec18f191f03);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Hyena_01_69bc3485-8f3b-4a76-a3ca-fd9da89bb908);
DB_PLA_ConflictedFlind_GnollPack(S_PLA_ConflictedFlind_Hyena_02_9c5f8832-a4c3-43c7-a860-4d7b4aa309b5);

PROC_ConflictedFlind_DisableCrimesOnZhents();
//END_REGION Pack

//REGION Reaction After Dialog
DB_FlagReactionAfterDialog(
	S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, 
	(FLAG)PLA_ConflictedFlind_Event_MindControl_Leave_53e6cdf7-d5ce-dd99-6b4b-1006c8221f5d, 
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04);
DB_FlagReactionAfterDialog(
	S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0,
	(FLAG)PLA_ConflictedFlind_Event_MindControl_Attack_8b622d47-729f-555a-ae8c-e5b7a51e7552, 
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04);
DB_FlagReactionAfterDialog(
	S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0,
	(FLAG)PLA_ConflictedFlind_Event_TurnedOnGnolls_e106f8d7-1cc5-46a2-8b6d-46f2de0f4ea1, 
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04);
DB_FlagReactionAfterDialog(
	(FLAG)PLA_ConflictedFlind_Event_MindControlDamage_Minor_74513fa5-0adb-9023-cad4-132d7ea5742c, 
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04);
DB_FlagReactionAfterDialog(
	(FLAG)PLA_ConflictedFlind_Event_MindControlDamage_Heavy_2721b722-2d3e-48ac-8c2d-122d4f3873c4, 
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04);
DB_FlagReactionAfterDialog(
	S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, 
	(FLAG)PLA_ConflictedFlind_Event_MindControl_KillHerself_89d4304d-1256-d655-a53f-b6c52f62d23f, 
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04);
DB_FlagReactionAfterDialog(
	(FLAG)PLA_ConflictedFlind_Event_MakeGnollsLaugh_cf856e51-194f-4560-b51c-8dc2c29e568a,
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04);
//END_REGION Reaction After Dialog

DB_AutoSaveTrigger(TRIGGERGUID_S_PLA_ConflictedFlind_Autosave_49e111b9-92dc-4272-b164-bb8902ef329c);

PROC_DeclareCounter("PLA_ConflictedFlind_DialogAttempts");

DB_NoLowAttitudeDialog(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0);
SetCanTrade(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,0);

PROC_TriggerRegisterForParty(S_PLA_ZhentShipment_GnollBehaviorCommentArea_2895b396-8f1c-49fc-b97a-bfe427b4ce5c);

//REGION AD manager
DB_GLO_ADManager_Category("PLA_ConflictedFlind",(FLAG)PLA_ConflictedFlind_State_BlockAD_a440d701-ef76-4ae1-aace-98b1035d50b4, 1500, 500);
DB_GLO_ADManager_AD("PLA_ConflictedFlind", PLA_ConflictedFlind_GnollRanger01_AD_ecdb6acb-cc88-758e-4f70-0efbb72da23e,(FLAG)PLA_ConflictedFlind_State_BlockAD_GnollRanger01_cc713add-a59c-44ea-9a4d-4335aa170f07);
DB_GLO_ADManager_AD("PLA_ConflictedFlind", PLA_ConflictedFlind_GnollRanger02_AD_5de19839-b8e8-96d4-7a39-887345c01db7,(FLAG)PLA_ConflictedFlind_State_BlockAD_GnollRanger02_c7933897-40b5-43e5-997b-5ebeb0c57d0b);
DB_GLO_ADManager_AD("PLA_ConflictedFlind", PLA_ConflictedFlind_GnollRanger03_AD_11d4ed98-1e5e-684e-d652-2cd15b034d37,(FLAG)PLA_ConflictedFlind_State_BlockAD_GnollRanger03_2d2d02cb-5864-4696-8ce2-62984b141745);
DB_GLO_ADManager_AD("PLA_ConflictedFlind", PLA_ConflictedFlind_GnollRanger04_AD_b03f1805-8792-5aa4-c759-9ee2f3db1bad,(FLAG)PLA_ConflictedFlind_State_BlockAD_GnollRanger04_117eb698-98c9-4370-b072-a31a3fc66e67);
DB_GLO_ADManager_AD("PLA_ConflictedFlind", PLA_ConflictedFlind_Flind_AD_ffdccc02-fdba-2efb-cc0b-db3f7dc11e67, (FLAG)PLA_ConflictedFlind_State_BlockAD_Flind_5810ce7f-0e34-4498-968c-dc67f88d5389);
DB_GLO_ADManager_AD("PLA_ConflictedFlind", PLA_ConflictedFlind_Gnoll_FangOfYeenoghu_01_AD_e9564fca-53bb-7917-e3f7-dfaa8c0f4028, (FLAG)PLA_ConflictedFlind_State_BlockAD_Fang_3a931891-216e-4965-a94e-338dae690a36);
//END_REGION AD manager

//REGION Howling trigger
DB_PLA_ConflictedFlind_Howling((TRIGGER)S_PLA_ConflictedFlind_GnollHowlingArea_Cave_f1f05654-27ef-4c6b-ae94-61bd3a500b5d, "SE_Distant_Howls_ConflictedFlind_Underground");
DB_PLA_ConflictedFlind_Howling((TRIGGER)S_PLA_ConflictedFlind_GnollHowlingArea_Outdoor_22624dab-5113-4e9b-a544-6d3142abb3b9, "SE_Distant_Howls_ConflictedFlind_Above");
//END_REGION Howling trigger

//REGION Blood Absolyte Symbol
DB_PLA_ConflictedFlind_BloodSymbols((TRIGGER)S_PLA_ConflictedFlind_BloodSymbolArea_001_a0b09223-a353-40b0-a29e-8ad87b9cc534, (TRIGGER)S_PLA_ConflictedFlind_BloodSymbol_VFXTrigger_001_49f3ab79-ab8a-4779-b1b8-2be1efd15aef);
DB_PLA_ConflictedFlind_BloodSymbols((TRIGGER)S_PLA_ConflictedFlind_BloodSymbolArea_002_b54f9462-c07c-40c1-9b3e-de80b03d495e, (TRIGGER)S_PLA_ConflictedFlind_BloodSymbol_VFXTrigger_002_6cd434a0-5862-4bbb-89c6-be6d81d0cee2);
//END_REGION Blood Absolyte Symbol
KBSECTION
//REGION Surfaces
IF
EnteredTrigger(_Player, S_PLA_Plains_SUB_bcc3efa5-bfe1-4224-9df1-6758cac764cd)
AND
DB_PartyMembers(_Player)
AND
DB_GlobalFlag(PLA_ConflictedFlind_State_NotEncountered_c4bed850-2d45-4806-bc6d-5d778e60cde4)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
QRY_OnlyOnce("PLA_ConflictedFlind_Surfaces_Oneshot")
THEN
CreateSurface(S_PLA_ConflictedFlind_EntranceSurfaces_1_3f32deb8-6635-4ed4-9b6f-26184d351f65, "SurfaceFire", 1.5, -1.0);
CreateSurface(S_PLA_ConflictedFlind_EntranceSurfaces_2_256722b2-71d2-4bee-a619-6437d04957a8, "SurfaceFire", 1.5, -1.0);
CreateSurface(S_PLA_ConflictedFlind_EntranceSurfaces_3_032ad108-973d-4bba-9a52-cfc5ec2ea7e7, "SurfaceFire", 1.5, -1.0);
CreateSurface(S_PLA_ConflictedFlind_Zhentarim_Corpse_01973f38-1fd2-4035-abb3-27429f49bd47, "SurfaceBlood", 1.7, -1.0); 
CreateSurface(S_PLA_ConflictedFlind_BurnedHyenaTrigger_15588ab4-e483-43ab-a52f-31880ab61ce9, "SurfaceFire", 1.5, -1.0);

PROC
PROC_PLA_ConflictedFlind_AfterAbandoningZhents()
THEN
PROC_PLA_ConflictedFlind_ClearSurfaces();

PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
THEN
PROC_PLA_ConflictedFlind_ClearSurfaces();

PROC
PROC_PLA_ConflictedFlind_ClearSurfaces()
THEN
RemoveSurfaceLayer(TRIGGERGUID_S_PLA_ConflictedFlind_BehindFireTrigger_850796f3-766e-4955-acf7-1490796ebe5a, "Ground", 8.0);
RemoveSurfaceLayer(S_PLA_ConflictedFlind_BurnedHyenaTrigger_15588ab4-e483-43ab-a52f-31880ab61ce9, "Ground", 2.0);
//END_REGION Surfaces

//REGION State flags
IF
FlagSet((FLAG)_Flag, _, _)
AND
DB_GlobalFlag(_Flag)
AND
DB_PLA_ConflictedFlind_Gnolls_States(_Flag)
THEN
PROC_PLA_ConflictedFlind_ChangeState(_Flag);

PROC
PROC_PLA_ConflictedFlind_ChangeState((FLAG)_Flag)
AND
NOT DB_GlobalFlag(_Flag)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

PROC
PROC_PLA_ConflictedFlind_ChangeState((FLAG)_Flag)
AND
DB_PLA_ConflictedFlind_Gnolls_States(_Flag)
AND
DB_PLA_ConflictedFlind_Gnolls_CurrentState((FLAG)_OldFlag)
AND
_OldFlag != _Flag
THEN
PROC_GlobalClearFlagAndCache(_OldFlag);
NOT DB_PLA_ConflictedFlind_Gnolls_CurrentState(_OldFlag);
DB_PLA_ConflictedFlind_Gnolls_CurrentState(_Flag);
PROC_ConflictedFlind_OnStateChanged(_OldFlag, _Flag);

IF
FlagSet((FLAG)_Flag, _, _)
AND
DB_PLA_ConflictedFlind_Gnolls_States(_Flag)
AND
NOT DB_PLA_ConflictedFlind_Gnolls_CurrentState(_)
THEN
DB_PLA_ConflictedFlind_Gnolls_CurrentState(_Flag);

PROC
PROC_ConflictedFlind_OnStateChanged((FLAG)_OldFlag, (FLAG)_NewFlag)
THEN
DB_NOOP(1);
//END_REGION State flags

//REGION Party banter
IF
FlagSet((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
AND
DB_GlobalFlag(PLA_DyingHyena_State_Gone_62e3eb5c-d0c8-48ca-be82-b6c64008b093)
AND
QRY_OnlyOnce("PLA_ConflictedFlind_Activate_PartyBanterTrigger")
THEN
PROC_RegisterWorldGossipTrigger(TRIGGERGUID_S_PartyBanterTrigger_PLA_HillCleared_367f316d-e9e2-4d6e-9f08-eaf63b480e22);

IF
FlagSet((FLAG)PLA_DyingHyena_State_Gone_62e3eb5c-d0c8-48ca-be82-b6c64008b093, _, _)
AND
DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
QRY_OnlyOnce("PLA_ConflictedFlind_Activate_PartyBanterTrigger")
THEN
PROC_RegisterWorldGossipTrigger(TRIGGERGUID_S_PartyBanterTrigger_PLA_HillCleared_367f316d-e9e2-4d6e-9f08-eaf63b480e22);
//END_REGION Party banter

//REGION Hostile State
IF 
TurnStarted(_Gnoll)
AND
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_TalkingToFlind_dd11bd98-c488-4964-83aa-765ddd7b0562)
AND
QRY_PLA_ZhentShipment_PlayersAndGnollsAreFighting()
AND
QRY_PLA_ConflictedFlind_GnollsHostile()
THEN
PROC_PLA_ConflictedFlind_ChangeState(PLA_ConflictedFlind_State_Hostile_4ba98bb7-f66b-a105-b5fd-0569dd61b030);

IF
DialogEnded((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04, _DialogID)
AND 
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Hostile_4ba98bb7-f66b-a105-b5fd-0569dd61b030)
AND
DB_DialogPlayers(_DialogID, _PlayerInDialog, 1)
THEN
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(0);
PROC_PLA_ConflictedFlind_FlindPlaysAngryAnimation(_PlayerInDialog);
//END_REGION Hostile State

//REGION Flind plays angry animation and AD after dialog ends
PROC
PROC_PLA_ConflictedFlind_FlindPlaysAngryAnimation((GUIDSTRING)_EntityLookAt)
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, (GUIDSTRING)_CombatID)
THEN
SetDualEntityEvent(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _EntityLookAt, "PLA_ConflictedFlind_Event_PlayAngryAnim", 1);
//END_REGION Flind plays angry animation and AD after dialog ends

//REGION Flind interrupts combat
// Interrupting the combat and talk with Tadpoled character
IF 
TurnStarted(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
QRY_ConflictedFlind_FlindCanInterruptCombat()
AND
NOT DB_PLA_ConflictedFlind_MovingToPlayer(_, _)
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
AND
NOT QRY_PLA_ConflictedFlind_ZhentsAreInCombat(_CombatID)
AND
NOT QRY_PLA_ConflictedFlind_OtherPackGnollsAreInCombat(_CombatID)
AND
QRY_PLA_ConflictedFlind_GetClosestAvailableCharacterTo(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
DB_ClosestAvailableCharacterTo((CHARACTER)_Player, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _Distance)
AND
NOT DB_InRegion(_Player, S_PLA_ZhentShipment_InsideCaveCombatArea_1482ce04-5188-4759-a548-f609c6e74181)
THEN
DB_OnlyOnce("PLA_ConflictedFlind_Event_InterruptCombat");
PROC_PLA_ConflictedFlind_CharacterMoveToAndTalk(_Player, "PLA_ConflictedFlind_FlindMovesToPlayer", _Distance);

IF 
TurnStarted(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
QRY_PLA_ConflictedFlind_FlindHeavilyWounded()
AND
QRY_OnlyOnce("PLA_ConflictedFlind_FlindHeavilyWoundedAD")
THEN 
PROC_TryStartAD(PLA_ConflictedFlind_Flind_Wounded_AD_5732796b-dfe9-3830-1b15-0d98cb01fea5, S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0);

IF 
TurnStarted(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
AND
QRY_PLA_ConflictedFlind_ZhentsAreInCombat(_CombatID)
AND
QRY_OnlyOnce("PLA_ConflictedFlind_FlindHeavilyWoundedAD")
THEN 
PROC_TryStartAD(PLA_ConflictedFlind_Flind_Wounded_AD_5732796b-dfe9-3830-1b15-0d98cb01fea5, S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0);

IF
AttackedBy(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, (CHARACTER)_AttackerOwner, _, _, _DamageAmount, _, _)
AND
NOT DB_OnlyOnce("PLA_ConflictedFlind_FlindHeavilyWoundedAD")
AND
DB_PartyMembers(_AttackerOwner)
AND
_DamageAmount > 1
AND
QRY_PLA_ConflictedFlind_FlindHeavilyWounded()
AND
QRY_OnlyOnce("PLA_ConflictedFlind_FlindHeavilyWoundedAD")
THEN 
PROC_TryStartAD(PLA_ConflictedFlind_Flind_Wounded_AD_5732796b-dfe9-3830-1b15-0d98cb01fea5, S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0);

QRY
QRY_ConflictedFlind_FlindCanInterruptCombat()
AND
NOT DB_OnlyOnce("PLA_ConflictedFlind_Event_InterruptCombat")
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_AfterLongRest_346fa778-1a8a-4793-9abf-f129445e0631)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Event_ProvokeGnolls_b7fe3fee-61ce-7d8d-64a6-519f0dc610cb)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a)
AND
NOT DB_Defeated(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
HasActiveStatus(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,"SURPRISED",0)
AND
SysCount("DB_PLA_ConflictedFlind_GnollPack", 1, _GnollsLeftCount)
AND
_GnollsLeftCount > 1
AND
NOT QRY_PLA_ConflictedFlind_FlindHeavilyWounded()
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_FlindHeavilyWounded()
AND
GetHitpointsPercentage(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _Percent)
AND
_Percent < 50.0
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_ZhentsAreInCombat((GUIDSTRING)_CombatID)
AND
NOT DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_)
AND
DB_PLA_ZhentShipment_Agents((CHARACTER)_Agent)
AND
DB_Is_InCombat(_Agent, _CombatID)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_OtherPackGnollsAreInCombat((GUIDSTRING)_CombatID)
AND
DB_PLA_DyingHyena_GnollPack((CHARACTER)_OtherPackGnoll, _)
AND
DB_Is_InCombat(_OtherPackGnoll, _CombatID)
THEN
DB_NOOP(1);

// Searhing for the closest player with sight check
QRY
QRY_PLA_ConflictedFlind_GetClosestAvailableCharacterTo((CHARACTER)_Character)
AND
QRY_GetClosestAvailableCharacterTo(_Character, 1, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_ClosestAvailableCharacterTo(_, _Character, _)
THEN
DB_NOOP(1);

// Then without sight check (if no one with sight check has been found)
QRY
QRY_PLA_ConflictedFlind_GetClosestAvailableCharacterTo((CHARACTER)_Character)
AND
NOT DB_ClosestAvailableCharacterTo(_, _Character, _)
AND
QRY_GetClosestAvailableCharacterTo(_Character, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
DB_NOOP(1);
//END_REGION Flind interrupts combat

//REGION Flind starts Main Dialog
PROC
PROC_PLA_ConflictedFlind_CharacterMoveToAndTalk((CHARACTER)_Target, (STRING)_MoveID, (REAL)_Distance)
AND
NOT DB_PLA_ConflictedFlind_MovingToPlayer(_Target, _MoveID)
AND
NOT DB_PLA_ConflictedFlind_FlindDialogStarted(_)
AND
_Distance <= 5
THEN
PROC_PLA_ConflictedFlind_StartFlindDialog(_Target);

PROC
PROC_PLA_ConflictedFlind_CharacterMoveToAndTalk((CHARACTER)_Target, (STRING)_MoveID, (REAL)_Distance)
AND
NOT DB_PLA_ConflictedFlind_MovingToPlayer(_Target, _MoveID)
AND
NOT DB_PLA_ConflictedFlind_FlindDialogStarted(_)
AND
_Distance > 5
AND
NOT DB_CantMove(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
THEN
DB_PLA_ConflictedFlind_MovingToPlayer((CHARACTER)_Target, _MoveID);
CharacterMoveToAndTalk(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _Target, (DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04, _MoveID, "Walk", 25.0);

PROC
PROC_PLA_ConflictedFlind_StartFlindDialog((CHARACTER)_Target)
AND 
NOT DB_PLA_ConflictedFlind_FlindDialogStarted((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04)
AND
QRY_StartDialogCustom(PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04, S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _Target, 0, 0, 0, 1)
THEN
DB_PLA_ConflictedFlind_FlindDialogStarted(PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04);

// Adding other players to the Flind's dialog
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04, (INTEGER)_DialogID)
AND
DB_DialogRequestCache_SpeakerList_Players((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04,_DialogID, _PlayerInDialog, 1)
AND
DB_Is_InCombat(_PlayerInDialog, (GUIDSTRING)_CombatID)
AND
DB_Players((CHARACTER)_OtherPlayer)
AND
_PlayerInDialog != _OtherPlayer
AND
DB_Is_InCombat(_OtherPlayer, _CombatID)
AND
NOT DB_DialogRequestCache_SpeakerList_Players((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04,_DialogID, _OtherPlayer, _)
THEN
PROC_DialogAddListeningActor(_DialogID, _OtherPlayer);

IF
DialogStarted((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04, _DialogID)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_AfterKilledRegularGnolls_51320d12-ea6d-4948-99dd-5cf372577fb2)
THEN
PROC_PLA_ConflictedFlind_ChangeState((FLAG)PLA_ConflictedFlind_State_TalkingToFlind_dd11bd98-c488-4964-83aa-765ddd7b0562);

// Also adding new players joining combat
IF
EnteredCombat((CHARACTER)_Player, _CombatID)
AND
DB_Players((CHARACTER)_Player)
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
AND
DB_DialogNPCs((INTEGER)_DialogID, (CHARACTER)S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _)
AND
NOT DB_DialogPlayers(_DialogID, _Player, _)
THEN
PROC_DialogAddListeningActor(_DialogID, _Player);

IF
CombatEnded(_CombatID)
AND
DB_Was_InCombat(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
AND
DB_PartyMembers(_Player)
AND
DB_Was_InCombat(_Player, _CombatID)
THEN
DB_OnlyOnce("PLA_ConflictedFlind_CombatWithFlindEnded");

IF
DialogStarted((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04, _DialogID)
AND
QRY_OnlyOnce("PLA_ConflictedFlind_DashFirstTime")
THEN
ApplyStatus(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, "PLA_CONFLICTEDFLIND_FAKEDASH", 1.0, 1, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0);

IF
AttackedBy(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _AttackOwner, _, _, _, _, _)
AND
DB_PartyMembers((CHARACTER)_AttackOwner)
AND
DB_DialogName((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04, _InstanceID)
AND
DB_DialogNPCs(_InstanceID, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _)
AND
DB_DialogPlayers(_InstanceID, _Player, _)
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ConflictedFlind_State_Hostile_4ba98bb7-f66b-a105-b5fd-0569dd61b030);
PROC_ForceStopDialog(_Player);
//END_REGION Flind starts Main Dialog

//REGION Handling Flinds CharacterMoveToAndTalk during combat
IF
CharacterMoveToAndTalkFailed(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, (CHARACTER)_Target, "PLA_ConflictedFlind_FlindMovesToPlayer",(STRING)_Reason)
AND
DB_PLA_ConflictedFlind_MovingToPlayer(_Target, _MoveID)
AND
Concatenate("CharacterMoveToAndTalk FAILED: ", _Reason, _DebugMSG)
THEN
DebugText(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _DebugMSG);
NOT DB_PLA_ConflictedFlind_MovingToPlayer(_Target, _MoveID);
PROC_PLA_ConflictedFlind_FlindDialogFallback(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _Target);

PROC
PROC_PLA_ConflictedFlind_FlindDialogFallback(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, (CHARACTER)_FailedTargetCharacter)
AND
NOT DB_PLA_ConflictedFlind_FlindDialogStarted((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04)
AND
QRY_PLA_ConflictedFlind_GetClosestAvailableCharacterTo(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
DB_ClosestAvailableCharacterTo(_Player, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _Distance)
AND
_Distance <= 5.0
THEN
PROC_PLA_ConflictedFlind_StartFlindDialog(_Player);

PROC
PROC_PLA_ConflictedFlind_FlindDialogFallback(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, (CHARACTER)_FailedTargetCharacter)
AND
NOT DB_PLA_ConflictedFlind_FlindDialogStarted((DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04)
AND
DB_ClosestAvailableCharacterTo(_Player, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _Distance)
AND
_Distance > 5.0
AND
DB_GlobalCounter("PLA_ConflictedFlind_DialogAttempts", _currentCounter)
AND
_currentCounter < 2
AND
NOT QRY_PLA_ConflictedFlind_FlindHeavilyWounded()
THEN
PROC_IncreaseCounter("PLA_ConflictedFlind_DialogAttempts");
NOT DB_OnlyOnce("PLA_ConflictedFlind_Event_InterruptCombat");
PROC_TryStartAD(PLA_ConflictedFlind_Flind_Wounded_AD_5732796b-dfe9-3830-1b15-0d98cb01fea5, S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0);
EndTurn(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0);

IF
AttackedBy(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,(CHARACTER)_Source,_,_,_DamageAmount,_,_)
AND
DB_PLA_ConflictedFlind_MovingToPlayer(_Source, _MoveID)
AND
DB_PartyMembers(_Source)
AND
_DamageAmount > 4
THEN
CharacterMoveToAndTalkFail(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,_Source,_MoveID,"Attacked");

IF
Died(_Target)
AND
DB_PLA_ConflictedFlind_MovingToPlayer(_Target, _MoveID)
THEN
CharacterMoveToAndTalkFail(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,_Target,_MoveID,"TargetDied");

IF
Died(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
DB_PLA_ConflictedFlind_MovingToPlayer(_Target, _MoveID)
THEN
CharacterMoveToAndTalkFail(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,_Target,_MoveID,"CharacterDied");

IF
CharacterMoveToAndTalkRequestDialog(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,(CHARACTER)_Target,(DIALOGRESOURCE)_Dialog,(STRING)_MoveID)
AND
DB_PLA_ConflictedFlind_MovingToPlayer(_Target, _MoveID)
AND
NOT DB_PLA_ConflictedFlind_FlindDialogStarted(_Dialog)
THEN
PROC_PLA_ConflictedFlind_StartFlindDialog(_Target);

IF
CharacterMoveToAndTalkRequestDialog(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,(GUIDSTRING)_Target,(DIALOGRESOURCE)_Dialog,(STRING)_MoveID)
AND
DB_CharacterMoveToAndTalk_Info(_Character,_Target,_Dialog,_MoveEvent,_Fixed)
AND
NOT DB_PLA_ConflictedFlind_FlindDialogStarted(_Dialog)
THEN
CharacterMoveToAndTalkFail(_Character,_Target,_MoveEvent,"DialogFailedToStart");

IF
CharacterMoveToAndTalkRequestDialog(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,(CHARACTER)_Target,(DIALOGRESOURCE)_Dialog,(STRING)_MoveID)
AND
DB_PLA_ConflictedFlind_MovingToPlayer(_Target, _MoveID)
THEN
NOT DB_PLA_ConflictedFlind_MovingToPlayer(_Target, _MoveID);

IF
DialogStarted((DIALOGRESOURCE)_Dialog, _)
AND
DB_PLA_ConflictedFlind_FlindDialogStarted(_Dialog)
THEN
NOT DB_PLA_ConflictedFlind_FlindDialogStarted(_Dialog);
//END_REGION Handling Flinds CharacterMoveToAndTalk during combat

//REGION Force gnolls to leave the area
PROC
PROC_FlagReactionAfterDialog(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0,(FLAG)PLA_ConflictedFlind_Event_MindControl_Leave_53e6cdf7-d5ce-dd99-6b4b-1006c8221f5d)
THEN
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(50);
PROC_PLA_ConflictedFlind_Leave();

PROC
PROC_PLA_ConflictedFlind_Leave()
THEN
PROC_PLA_ConflictedFlind_SetPeacefulResolutionXP();

PROC
PROC_PLA_ConflictedFlind_Leave()
AND
QRY_OnlyOnce("PLA_ConflictedFlind_LeftForAnotherPlace_OnlyOnce")
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
SetHasDialog(_Gnoll, 0);
PROC_NotifyWhenReadyToMoveOn(_Gnoll, "PLA_ConflictedFlind_LeftForAnotherPlace_Notify");

PROC
PROC_ReadyToMoveOn(_Gnoll, "PLA_ConflictedFlind_LeftForAnotherPlace_Notify")
THEN
PROC_DisappearOutOfSightTo(_Gnoll, S_PLA_ConflictedFlind_LeaveToTrigger_c30f35ca-ae9f-4861-b32a-f69c88de273c, "Sprint", 0, "PLA_ConflictedFlind_GnollDisappeared");

IF
EntityEvent(_Gnoll, "PLA_ConflictedFlind_GnollDisappeared")
AND
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
THEN
NOT DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll);

IF
EntityEvent(_Gnoll, "PLA_ConflictedFlind_GnollDisappeared")
AND
NOT DB_PLA_ConflictedFlind_GnollPack(_)
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ConflictedFlind_State_Left_ac73cf2a-7b7f-4f41-8fc4-4e0ab6f73c70);
//END_REGION Force gnolls to leave the area

//REGION Instigate
PROC
PROC_FlagReactionAfterDialog(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0,(FLAG)PLA_ConflictedFlind_Event_MindControl_Attack_8b622d47-729f-555a-ae8c-e5b7a51e7552)
THEN
PROC_PLA_ConflictedFlind_StartInstigateAlliedWithGnolls();

PROC
PROC_PLA_ConflictedFlind_StartInstigateAlliedWithGnolls()
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
AND
QRY_PLA_ZhentShipment_AnyAgentInCombat(_CombatID)
THEN
PROC_PLA_ConflictedFlind_FlindPlaysAngryAnimation(S_PLA_ConflictedFlind_BehindFireTrigger_850796f3-766e-4955-acf7-1490796ebe5a);

PROC
PROC_PLA_ConflictedFlind_StartInstigateAlliedWithGnolls()
AND
NOT DB_PLA_ConflictedFlind_InstigatingAlliedWithGnolls(1)
THEN
DB_PLA_ConflictedFlind_InstigatingAlliedWithGnolls(1);
PROC_PLA_ConflictedFlind_StartInstigate(1);
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(50);
PROC_PLA_ZhentShipment_MakeZhentsAndPlayersHostile();

PROC
PROC_PLA_ConflictedFlind_StartInstigateAlliedWithGnolls()
AND
DB_Is_InCombat((CHARACTER)S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, (GUIDSTRING)_CombatID)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
DB_Is_InCombat(_Agent, _CombatID)
AND
QRY_OnlyOnce("PLA_ConflictedFlind_StartInstigateAlliedWithGnolls_Hostility")
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();

PROC
PROC_PLA_ConflictedFlind_StartInstigateAlliedWithGnolls()
AND
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
THEN
SetDualEntityEvent(_Gnoll, (CHARACTER)S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, "PLA_ConflictedFlind_Event_PlayReactionPeace", 1);

PROC
PROC_PLA_ConflictedFlind_StartInstigateAlliedWithGnolls()
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
PROC_SelfHealing_Disable(_Agent);

PROC
PROC_PLA_ConflictedFlind_StartInstigateAlliedWithGnolls()
AND
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
THEN
PROC_SelfHealing_Disable(_Gnoll);

PROC
PROC_PLA_ConflictedFlind_StartInstigateAlliedWithGnolls()
AND
DB_PLA_ConflictedFlind_InstigatingAlliedWithGnolls(1)
THEN
NOT DB_PLA_ConflictedFlind_InstigatingAlliedWithGnolls(1);

// attack Zhents after combat ends
IF
CombatEnded(_CombatID)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_AfterLongRest_346fa778-1a8a-4793-9abf-f129445e0631)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
DB_Was_InCombat(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
AND
DB_PLA_ConflictedFlind_GnollPack(_)
AND
QRY_OnlyOnce("PLA_ConflictedFlind_InstigateAfterCombatEnded")
THEN
PROC_PLA_ConflictedFlind_StartInstigate(1);

PROC
PROC_PLA_ConflictedFlind_StartInstigate((INTEGER)_WithInspiringSpeech)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a)
AND
DB_PLA_ConflictedFlind_GnollPack(_)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
GetFlag((FLAG)PLA_ConflictedFlind_Event_TurnedOnGnolls_e106f8d7-1cc5-46a2-8b6d-46f2de0f4ea1, (CHARACTER)S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, 0)
THEN
PROC_PLA_ConflictedFlind_ChangeState((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2);
PROC_PLA_ConfclitedFlind_ClearPeaceReturn();
PROC_PLA_ConflictedFlind_OnInstigateStarted(_WithInspiringSpeech);

PROC
PROC_PLA_ConflictedFlind_OnInstigateStarted(_)
AND
NOT DB_Defeated(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
DB_DialogNPCs(_,S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,_)
THEN
PROC_ForceStopDialog(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0); // If Instigate started by the other player when dialog was running

PROC
PROC_PLA_ConflictedFlind_OnInstigateStarted(1)
AND
DB_Defeated(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
THEN
PROC_PLA_ConflictedFlind_OnInstigateStarted(0);

PROC
PROC_PLA_ConflictedFlind_OnInstigateStarted(1)
AND
NOT DB_Defeated(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
THEN
TimerLaunch("PLA_ConflictedFlind_RushAtZhents_Timer", 4500);

PROC
PROC_PLA_ConflictedFlind_OnInstigateStarted(0)
THEN
TimerLaunch("PLA_ConflictedFlind_RushAtZhents_Timer", 2000);

IF
TimerFinished("PLA_ConflictedFlind_RushAtZhents_Timer")
THEN
PROC_PLA_ConflictedFlind_RushAtZhents();

PROC
PROC_PLA_ConflictedFlind_RushAtZhents()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
SetEntityEvent(_Gnoll, "PLA_ConflictedFlind_Event_RushAtZhents", 1); // To gnolls Anubis behaviour

IF
DB_Is_InCombat(_Player, _CombatID)
AND
DB_GlobalFlag(PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
DB_PartyMembers((CHARACTER)_Player)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
DB_Is_InCombat(_Agent, _CombatID)
AND
NOT DB_OnlyOnce("PLA_ConflictedFlind_CombatWithPlayersAndZhentsStartedWithGnollsNear")
AND
QRY_PLA_ZhentShipment_AreZhentsAndPlayersHostile()
AND
NOT QRY_PLA_ConflictedFlind_GnollsHostile()
AND
QRY_OnlyOnce("PLA_ConflictedFlind_CombatWithPlayersAndZhentsStartedWithGnollsNear")
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();
//END_REGION Instigate

//REGION Gnolls after Instigate
IF
FlagSet(PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a, _, _)
AND
DB_GlobalFlag(PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT QRY_PLA_ConflictedFlind_GnollsHostile()
AND
NOT DB_Defeated(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
THEN
DB_SpotPlayers(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, "PLA_ConflictedFlind_FlindSpotter_AfterInstigate",NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a, _, _)
AND
NOT QRY_PLA_ConflictedFlind_GnollsHostile()
AND
DB_Defeated(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
THEN
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(0);

PROC
PROC_SpotPlayers_Spotted(_Gnoll, "PLA_ConflictedFlind_FlindSpotter_AfterInstigate", _Player)
AND
DB_Players(_Player)
AND
NOT QRY_PLA_ConflictedFlind_GnollsHostile()
AND
QRY_OnlyOnce("PLA_ConflictedFlind_FlindSpotter_AfterInstigate")
THEN
PROC_CharacterMoveToAndTalk(
	S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,
	_Player, 
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04,
	"PLA_ConflictedFlind_FlindMovesToPlayer_AfterInstigate",
	"Run", 
	15.0, 1, 0, 0);

IF
CharacterMoveToAndTalkFailed(
	S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, 
	(CHARACTER)_Player, 
	"PLA_ConflictedFlind_FlindMovesToPlayer_AfterInstigate", 
	_)
AND
DB_Players(_Player)
THEN
TimerLaunch("PLA_ConflictedFlind_FlindMovesToPlayer_AfterInstigate_Timer", 5000);

IF
TimerFinished("PLA_ConflictedFlind_FlindMovesToPlayer_AfterInstigate_Timer")
AND
DB_Defeated(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
QRY_OnlyOnce_Reset("PLA_ConflictedFlind_FlindSpotter_AfterInstigate")
THEN
DB_SpotPlayers(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, "PLA_ConflictedFlind_FlindSpotter_AfterInstigate",NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Gnolls after Instigate

//REGION Flind dialog players damage event
PROC
PROC_FlagReactionAfterDialog(_Character,(FLAG)PLA_ConflictedFlind_Event_MindControlDamage_Minor_74513fa5-0adb-9023-cad4-132d7ea5742c)
AND
DB_Players((CHARACTER)_Character)
THEN
PROC_ApplyLimitedDamagePercent(_Character, 10.0, "Psychic", S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0);
//END_REGION Flind dialog players damage event

//REGION Flind attacks other gnolls after mind-meld
PROC
PROC_FlagReactionAfterDialog(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0,(FLAG)PLA_ConflictedFlind_Event_TurnedOnGnolls_e106f8d7-1cc5-46a2-8b6d-46f2de0f4ea1)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
QRY_OnlyOnce("PLA_ConflictedFlind_FlindAttackGnolls")
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, 50);
PROC_SetRelation((FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, (FACTION)ACT1_PLA_ConflictedFlind_GnollPack_6f5c2543-dadb-7f16-94d4-9c7e5f23acf2, 0);
PROC_SetRelation((FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, (FACTION)ACT1_PLA_CaravanGnolls_efcabb7b-9f84-464e-bfce-134a81664ae5, 0);
PROC_PLA_ConflictedFlind_FlindPlaysAngryAnimation(_Gnoll);
PROC_PLA_ConflictedFlind_SetPeacefulResolutionXP();

PROC
PROC_PLA_ConflictedFlind_SetPeacefulResolutionXP()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
NOT DB_PermaDefeated(_Gnoll)
THEN
PROC_PeacefulResolve(_Gnoll);

IF
AttackedBy((CHARACTER)_Gnoll, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _, _, _DamageAmount, _, _)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
GetFlag(PLA_ConflictedFlind_Event_TurnedOnGnolls_e106f8d7-1cc5-46a2-8b6d-46f2de0f4ea1, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, 1)
AND
_DamageAmount > 0
THEN
PROC_PLA_ConflictedFlind_GnollsReactOnFlindBetrayal();

IF
TurnEnded(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
GetFlag(PLA_ConflictedFlind_Event_TurnedOnGnolls_e106f8d7-1cc5-46a2-8b6d-46f2de0f4ea1, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, 1)
AND
NOT DB_PLA_ConflictedFlind_GnollsReactOnFlindBetrayal(1)
THEN
PROC_PLA_ConflictedFlind_GnollsReactOnFlindBetrayal();

PROC
PROC_PLA_ConflictedFlind_GnollsReactOnFlindBetrayal()
AND
NOT DB_PLA_ConflictedFlind_GnollsReactOnFlindBetrayal(1)
THEN
DB_PLA_ConflictedFlind_GnollsReactOnFlindBetrayal(1);
PROC_SetRelation((FACTION)ACT1_PLA_ConflictedFlind_GnollPack_6f5c2543-dadb-7f16-94d4-9c7e5f23acf2, (FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, 0);

PROC
PROC_PLA_ConflictedFlind_GnollsReactOnFlindBetrayal()
AND
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
THEN
SetDualEntityEvent(_Gnoll, (CHARACTER)S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, "PLA_ConflictedFlind_Event_PlayReactionCombat", 1);

PROC
PROC_FlagReactionAfterDialog(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0,(FLAG)PLA_ConflictedFlind_Event_TurnedOnGnolls_e106f8d7-1cc5-46a2-8b6d-46f2de0f4ea1)
AND
GetRelation((FACTION)ACT1_PLA_ConflictedFlind_GnollPack_6f5c2543-dadb-7f16-94d4-9c7e5f23acf2, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, _Relation)
AND
_Relation > 0
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_ConflictedFlind_GnollPack_6f5c2543-dadb-7f16-94d4-9c7e5f23acf2, 0);

// If zhents join combat, Flind becomes hostile to the players
IF
FlagSet((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92, _, _)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
DB_Is_InCombat(_Agent, _CombatID)
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
AND
GetFlag((FLAG)PLA_ConflictedFlind_Event_TurnedOnGnolls_e106f8d7-1cc5-46a2-8b6d-46f2de0f4ea1, (CHARACTER)S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, 1)
AND
NOT QRY_PLA_ZhentShipment_AreZhentsAndPlayersHostile()
AND
QRY_OnlyOnce("PLA_ConflictedFlind_FlindAttacksPlayerAfterZhentsJoined")
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, 0);

// Combat ends after flind attacked other gnolls
IF
CombatEnded((GUIDSTRING)_CombatID)
AND
DB_Was_InCombat(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
AND
NOT DB_Defeated(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_RegularGnollsDead_7415a408-ed52-4e7c-8a96-fe697647e24a)
AND
GetFlag((FLAG)PLA_ConflictedFlind_Event_TurnedOnGnolls_e106f8d7-1cc5-46a2-8b6d-46f2de0f4ea1, (CHARACTER)S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, 1)
THEN
PROC_PLA_ConflictedFlind_ChangeState((FLAG)PLA_ConflictedFlind_State_AfterKilledRegularGnolls_51320d12-ea6d-4948-99dd-5cf372577fb2);
PROC_PLA_ConflictedFlind_FlindMovesAfterKillingGnolls();

PROC
PROC_PLA_ConflictedFlind_FlindMovesAfterKillingGnolls()
AND
GetClosestAlivePlayer(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, (CHARACTER)_Player, (REAL)_Dist)
AND
_Dist < 25.0
THEN
PROC_CharacterMoveToAndTalk(
	S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,
	_Player, 
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04,
	"PROC_PLA_ConflictedFlind_FlindMovesAfterKillingGnolls",
	"Run", 5.0, 1, 0, 0);

PROC
PROC_PLA_ConflictedFlind_FlindMovesAfterKillingGnolls()
AND
GetClosestAlivePlayer(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, (CHARACTER)_Player, (REAL)_Dist)
AND
_Dist >= 25.0
THEN
PROC_PLA_ConflictedFlind_FlindFailedToMoveAfterKillingGnolls();

IF
CharacterMoveToAndTalkFailed(_, _, "PROC_PLA_ConflictedFlind_FlindMovesAfterKillingGnolls", _)
THEN
PROC_PLA_ConflictedFlind_FlindFailedToMoveAfterKillingGnolls();

PROC
PROC_PLA_ConflictedFlind_FlindFailedToMoveAfterKillingGnolls()
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_FailedToTalkWithPlayer_556282ab-2667-4e93-80a0-3f75bb8d315e)
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ConflictedFlind_State_FailedToTalkWithPlayer_556282ab-2667-4e93-80a0-3f75bb8d315e);
DB_SpotPlayers(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, "PLA_ConflictedFlind_FlindSpotter_AfterKilledGnolls",NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(_Gnoll, "PLA_ConflictedFlind_FlindSpotter_AfterKilledGnolls", _Player)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_AfterKilledRegularGnolls_51320d12-ea6d-4948-99dd-5cf372577fb2)
AND
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_FailedToTalkWithPlayer_556282ab-2667-4e93-80a0-3f75bb8d315e)
THEN
PROC_CharacterMoveToAndTalk(
	S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0,
	_Player, 
	(DIALOGRESOURCE)PLA_ConflictedFlind_Flind_e6a8c973-961f-8375-61ce-87a6dfbb3f04,
	"PROC_PLA_ConflictedFlind_FlindMovesAfterKillingGnolls_SecondAttempt",
	"Run", 15.0, 1, 0, 0);

IF
CharacterMoveToAndTalkFailed(_, _, "PROC_PLA_ConflictedFlind_FlindMovesAfterKillingGnolls_SecondAttempt", _)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, 0);

PROC
PROC_FlagReactionAfterDialog(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0,(FLAG)PLA_ConflictedFlind_Event_MindControl_KillHerself_89d4304d-1256-d655-a53f-b6c52f62d23f)
THEN
Die(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0);
//END_REGION Flind attacks other gnolls

//REGION Checking Flind vs gnolls state
QRY
QRY_PLA_ConflictedFlind_FlindNotTurnedOnGnollsOrDead()
AND
DB_Defeated(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_FlindNotTurnedOnGnollsOrDead()
AND
GetFlag((FLAG)PLA_ConflictedFlind_Event_TurnedOnGnolls_e106f8d7-1cc5-46a2-8b6d-46f2de0f4ea1, (CHARACTER)S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, 0)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_FlindNotTurnedOnGnollsOrKilledThemOrDead()
AND
QRY_PLA_ConflictedFlind_FlindNotTurnedOnGnollsOrDead()
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_FlindNotTurnedOnGnollsOrKilledThemOrDead()
AND
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_AfterKilledRegularGnolls_51320d12-ea6d-4948-99dd-5cf372577fb2)
THEN
DB_NOOP(1);
//END_REGION Checking Flind vs gnolls state

//REGION Leaving region/taking long rest
// Left sub trigger
IF
LeftTrigger(_Player, S_PLA_Plains_SUB_bcc3efa5-bfe1-4224-9df1-6758cac764cd)
AND
DB_PartyMembers(_Player)
AND
QRY_PLA_ConflictedFlind_CanAbandonZhents()
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger((TRIGGER)S_PLA_Plains_SUB_bcc3efa5-bfe1-4224-9df1-6758cac764cd)
THEN
PROC_PLA_ConflictedFlind_AfterAbandoningZhents();

// Left smaller trigger, but provoke situation progressing by touching the chest
IF
LeftTrigger(_Player, S_PLA_ConflictedFlind_Cave_DangerZone_0aa90ecf-f46e-441e-ac25-8a9e236f2738)
AND
DB_PartyMembers(_Player)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_TouchedChest_1db4a628-dc86-4142-83cb-fe27d69532ef)
AND
QRY_PLA_ConflictedFlind_CanAbandonZhents()
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger((TRIGGER)S_PLA_ConflictedFlind_Cave_DangerZone_0aa90ecf-f46e-441e-ac25-8a9e236f2738)
THEN
PROC_PLA_ConflictedFlind_AfterAbandoningZhents();

QRY
QRY_PLA_ConflictedFlind_CanAbandonZhents()
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_AfterLongRest_346fa778-1a8a-4793-9abf-f129445e0631)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_Knows_SurvivorsInCave_6318e058-45f9-4640-a9f5-59489fccb843)
AND
DB_GlobalFlag(PLA_ConflictedFlind_Knows_Gnolls_c353a7d3-7561-05dc-c725-32e363ce6bf3)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_AfterLongRest_346fa778-1a8a-4793-9abf-f129445e0631)
THEN
DB_NOOP(1);

PROC
PROC_PLA_ConflictedFlind_AfterAbandoningZhents()
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ConflictedFlind_State_AfterLongRest_346fa778-1a8a-4793-9abf-f129445e0631);

PROC
PROC_PLA_ConflictedFlind_AfterAbandoningZhents()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
TriggerGetRandomPosition(S_PLA_ConflictedFlind_MainCombatArea_a45aa75d-81d7-4420-a69b-cee1d0174506, _X, _Y, _Z)
AND
FindValidPosition(_X, _Y, _Z, 5.0, _Gnoll, 0, _vX, _vY, _vZ)
THEN
TeleportToPosition(_Gnoll, _vX, _vY, _vZ, "", 0, 0, 1);

//FindValidPosition Fallback
PROC
PROC_PLA_ConflictedFlind_AfterAbandoningZhents()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
TriggerGetRandomPosition(S_PLA_ConflictedFlind_MainCombatArea_a45aa75d-81d7-4420-a69b-cee1d0174506, _X, _Y, _Z)
THEN
TeleportToPosition(_Gnoll, _X, _Y, _Z, "", 0, 0, 1);

PROC
PROC_PLA_ConflictedFlind_AfterAbandoningZhents()
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e)
THEN
Die(_Agent, DEATHTYPE.DoT, 1);

PROC
PROC_PLA_ConflictedFlind_AfterAbandoningZhents()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
PROC_SelfHealing_Enable(_Gnoll);

PROC
PROC_PLA_ConflictedFlind_AfterAbandoningZhents()
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();
//END_REGION Leaving region/taking long rest

//REGION KillCounter
IF
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
THEN
DB_GLO_DefeatCounter(_Gnoll, "PLA_ConflictedFlind_Gnolls");

PROC
PROC_GLO_DefeatCounter_AllDefeated("PLA_ConflictedFlind_Gnolls")
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
THEN
PROC_GlobalSetFlagAndCache(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2);
//END_REGION KillCounter

//REGION Gnolls dying / gone
IF
Dying(_Gnoll)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
NOT DB_PLA_ConflictedFlind_GnollPack(_Gnoll);
DB_PLA_ConflictedFlind_DeadGnoll(_Gnoll);

IF
DB_PLA_ConflictedFlind_DeadGnoll(_)
AND
NOT DB_PLA_ConflictedFlind_GnollPack(_)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
THEN
PROC_GlobalSetFlagAndCache(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2);

IF
DB_PLA_ConflictedFlind_DeadGnoll(_)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_RegularGnollsDead_7415a408-ed52-4e7c-8a96-fe697647e24a)
AND
NOT QRY_PLA_ConflictedFlind_RegularGnollsAlive()
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ConflictedFlind_State_RegularGnollsDead_7415a408-ed52-4e7c-8a96-fe697647e24a);

QRY
QRY_PLA_ConflictedFlind_RegularGnollsAlive()
AND
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
AND
_Gnoll != S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0
THEN
DB_NOOP(1);

// Left = gone
IF
FlagSet(PLA_ConflictedFlind_State_Left_ac73cf2a-7b7f-4f41-8fc4-4e0ab6f73c70, _, _)
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
THEN
PROC_GlobalSetFlagAndCache(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2);

//END_REGION Gnolls Gnolls dying / gone

//REGION Discover trigger
IF
EnteredTrigger(_Player, S_PLA_ZhentShipment_GnollBehaviorCommentArea_2895b396-8f1c-49fc-b97a-bfe427b4ce5c)
AND
DB_PartyMembers(_Player)
THEN
PROC_PLA_ConflictedFlind_OnSpotGnollsPack(_Player);

IF
CombatStarted(_CombatID)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_Knows_Gnolls_c353a7d3-7561-05dc-c725-32e363ce6bf3)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
DB_Is_InCombat(_Gnoll, _CombatID)
AND
DB_PartyMembers(_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
QRY_OnlyOnce("PLA_ConflictedFlind_KnowGnollsOnCombatWithThem")
THEN
PROC_PLA_ConflictedFlind_OnSpotGnollsPack(_Player);

PROC
PROC_PLA_ConflictedFlind_OnSpotGnollsPack((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_Knows_Gnolls_c353a7d3-7561-05dc-c725-32e363ce6bf3)
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ConflictedFlind_Knows_Gnolls_c353a7d3-7561-05dc-c725-32e363ce6bf3);

IF
FlagSet((FLAG)PLA_ZhentShipment_Quest_HasMet_5359e72b-f8ca-d2d6-4c3a-8fc00efe5c2c, _, _)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_Knows_Gnolls_c353a7d3-7561-05dc-c725-32e363ce6bf3)
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ConflictedFlind_Knows_Gnolls_c353a7d3-7561-05dc-c725-32e363ce6bf3);

PROC
PROC_PLA_ConflictedFlind_OnSpotGnollsPack()
THEN
PROC_TriggerUnregisterForParty(S_PLA_ZhentShipment_GnollBehaviorCommentArea_2895b396-8f1c-49fc-b97a-bfe427b4ce5c);
//END_REGION Discover trigger

//REGION Relations
PROC
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers((INTEGER)_Relation)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_ConflictedFlind_GnollPack_6f5c2543-dadb-7f16-94d4-9c7e5f23acf2, _Relation);
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, _Relation);

QRY
QRY_PLA_ConflictedFlind_GnollsHostile()
AND
GetRelation((FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, _Relation)
AND
_Relation < 50
THEN
DB_NOOP(1);
//END_REGION Relations

//REGION ClearPeaceReturn
IF
CombatStarted((GUIDSTRING)_CombatID)
AND
QRY_PLA_ConflictedFlind_ShouldClearPeaceReturn(_CombatID)
THEN
PROC_PLA_ConfclitedFlind_ClearPeaceReturn();

PROC
PROC_PLA_ConfclitedFlind_ClearPeaceReturn()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
SetEntityEvent(_Gnoll, "ClearPeaceReturn", 1);

QRY
QRY_PLA_ConflictedFlind_ShouldClearPeaceReturn((GUIDSTRING)_CombatID)
AND
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
DB_Is_InCombat(_Gnoll, _CombatID)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_ShouldClearPeaceReturn((GUIDSTRING)_CombatID)
AND
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Hostile_4ba98bb7-f66b-a105-b5fd-0569dd61b030)
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Gnoll_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
THEN
DB_NOOP(1);
//END_REGION ClearPeaceReturn

//REGION Crimes
PROC
PROC_ConflictedFlind_DisableCrimesOnZhents()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
DB_AssaultFamilyIgnoreFor(_Gnoll, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
DB_AssaultFamilyIgnoreFor(_Gnoll, S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c);
DB_MurderIgnoreFor(_Gnoll, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
DB_MurderIgnoreFor(_Gnoll, S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c);

IF
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
THEN
DB_NoLowAttitudeDialog(_Gnoll);
//END_REGION Crimes

//REGION Howling Sounds
IF
DB_PLA_ConflictedFlind_Howling(_Trigger, _)
THEN
PROC_TriggerRegisterForParty(_Trigger);

IF
EnteredTrigger((CHARACTER)_Player, (TRIGGER)_Trigger)
AND
DB_PLA_ConflictedFlind_Howling(_Trigger, (STRING)_SoundEvent)
AND
DB_PartyMembers(_Player)
AND
Concatenate("PLA_ConflictedFlind_HowlingSounds", _SoundEvent, _StringID)
AND
QRY_OncePerUserAndNearbyPlayers(_Player, _StringID)
THEN
PROC_PLA_ConflctedFlind_UnregisterHowling();
PlaySound(_Player, _SoundEvent);

PROC
PROC_PLA_ConflctedFlind_UnregisterHowling()
AND
DB_PLA_ConflictedFlind_Howling(_Trigger, _)
THEN
PROC_TriggerUnregisterForParty(_Trigger);

PROC
PROC_ConflictedFlind_OnStateChanged(_OldFlag, _)
THEN
PROC_PLA_ConflctedFlind_UnregisterHowling();
//END_REGION Howling Sounds

//REGION Blood Absolyte Symbol
IF
DB_PLA_ConflictedFlind_BloodSymbols((TRIGGER)_Trigger, _)
THEN
PROC_TriggerRegisterForPlayers(_Trigger);

IF
EnteredTrigger(_Player, _Trigger)
AND
DB_Players(_Player)
AND
DB_PLA_ConflictedFlind_BloodSymbols(_Trigger, (TRIGGER)_VFXTrigger)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_AfterKilledRegularGnolls_51320d12-ea6d-4948-99dd-5cf372577fb2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_TalkingToFlind_dd11bd98-c488-4964-83aa-765ddd7b0562)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Hostile_4ba98bb7-f66b-a105-b5fd-0569dd61b030)
AND
NOT DB_CantTalk(_Player)
AND
QRY_OncePerUserAndNearbyPlayers(_Player, "PLA_ZhentShipment_FoundBloodSymbol")
THEN
StartVoiceBark(VOICEBARKRESOURCEGUID_PLA_ZhentShipment_VB_BloodSymbol_ecb53599-72c2-aeba-d6c1-9052a8ac86c6, _Player);
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_Quest_FoundBloodSymbol_79e44428-edb2-499a-b297-6f075c191073);
PROC_PlayPerceptionRevealEffect(_VFXTrigger, "PLA_ZhentShipment_BloodSymbolVFX");

PROC
PROC_PLA_ConflictedFlind_UnregisterBloodSymbolAreas()
AND
DB_PLA_ConflictedFlind_BloodSymbols(_Trigger, _)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);
//END_REGION Blood Absolyte Symbol

//REGION Self-Heal
IF
EntityEvent((CHARACTER)_Gnoll, "PLA_ConflictedFlind_Event_GnollRushesIntoFire")
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
PROC_SelfHealing_Disable(_Gnoll);

IF
EntityEvent((CHARACTER)_Gnoll, "PLA_ConflictedFlind_Event_PlayAggressiveAnim")
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
PROC_SelfHealing_Enable(_Gnoll);
//END_REGION Self-Heal

//REGION Debug
IF
FlagSet(PLA_ZhentShipment_Debug_MakeGnollsHostile_7ba796b8-9ead-4e41-b2cf-fbb7e85be34e, _, _)
THEN
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(0);

IF
FlagSet(Debug_PLA_KillGnolls_5283045d-9655-55aa-0a55-213b7808f23c, _, _)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
NOT DB_Dead(_Gnoll)
THEN
Die(_Gnoll, DEATHTYPE.DoT, 1);

IF
TextEvent("PLA_ConflictedFlind_KillGnolls")
THEN
SetFlag(Debug_PLA_KillGnolls_5283045d-9655-55aa-0a55-213b7808f23c, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
TextEvent("PLA_ConflictedFlind_Instigate")
THEN
PROC_PLA_ConflictedFlind_StartInstigate(0);
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(0);

IF
TextEvent("PLA_ConflictedFlind_InstigateFriendly")
THEN
PROC_PLA_ConflictedFlind_StartInstigateAlliedWithGnolls();

IF
TextEvent("PLA_ConflictedFlind_HealGnolls")
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
SetHitpointsPercentage(_Gnoll, 100.0);

IF
TextEvent("PLA_ConflictedFlind_MakeNeutral")
THEN
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(50);
//END_REGION Debug

//REGION Making gnolls laugh
IF
TextEvent("Test_GnollJoke")
AND
GetHostCharacter(_Player)
THEN
PROC_PLA_ConflictedFlind_MakeGnollsLaugh((CHARACTER)_Player);

PROC
PROC_FlagReactionAfterDialog(_Player,PLA_ConflictedFlind_Event_MakeGnollsLaugh_cf856e51-194f-4560-b51c-8dc2c29e568a)
THEN
PROC_PLA_ConflictedFlind_MakeGnollsLaugh((CHARACTER)_Player);

PROC
PROC_PLA_ConflictedFlind_MakeGnollsLaugh((CHARACTER)_Player)
AND
NOT DB_PLA_ConflictedFlind_GnollJoke_Caster(_,_)
AND
DB_Is_InCombat(_Player,_)
THEN
PROC_PLA_ConflictedFlind_GnollJoke_Start((CHARACTER)_Player);

PROC
PROC_PLA_ConflictedFlind_GnollJoke_Start((CHARACTER)_Player)
AND
NOT DB_PLA_ConflictedFlind_GnollJoke_Caster(_,_)
AND
DB_Is_InCombat(_Player,_CombatID)
THEN
PauseCombat(_CombatID);
DB_PLA_ConflictedFlind_GnollJoke_Caster(_Player,_CombatID);

PROC
PROC_PLA_ConflictedFlind_GnollJoke_Start(_)
AND
DB_PLA_ConflictedFlind_GnollJoke_Timer(_Value)
THEN
NOT DB_PLA_ConflictedFlind_GnollJoke_Timer(_Value);

PROC
PROC_PLA_ConflictedFlind_GnollJoke_Start(_)
THEN
DB_PLA_ConflictedFlind_GnollJoke_Timer(500);

PROC
PROC_PLA_ConflictedFlind_GnollJoke_Start(_Player)
AND
DB_Is_InCombat(_Player,_CombatID)
AND
DB_Is_InCombat(_Gnoll,_CombatID)
AND
QRY_PLA_ConflictedFlind_IsGnollOrHyena((CHARACTER)_Gnoll) // we can't check just the DB_PLA_ConflictedFlind_GnollPack, because there might be other gnolls and hyenas joined the combat
AND
NOT DB_PLA_ConflictedFlind_GnollJoke_Awaiting(_Gnoll)
AND
DB_PLA_ConflictedFlind_GnollJoke_Timer(_Value)
AND
IntegerSum(_Value,300,_NewValue)
THEN
NOT DB_PLA_ConflictedFlind_GnollJoke_Timer(_Value);
DB_PLA_ConflictedFlind_GnollJoke_Timer(_NewValue);
DB_PLA_ConflictedFlind_GnollJoke_Awaiting(_Gnoll);
RealtimeObjectTimerLaunch(_Gnoll,"PLA_ConflictedFlind_GnollJokeTimer",_Value);

PROC
PROC_PLA_ConflictedFlind_GnollJoke_Start(_Player)
AND
NOT DB_PLA_ConflictedFlind_GnollJoke_Awaiting(_)
AND
DB_PLA_ConflictedFlind_GnollJoke_Caster(_Player,_CombatID)
THEN
PROC_PLA_ConflictedFlind_GnollJoke_Start_End();

QRY
QRY_PLA_ConflictedFlind_IsGnollOrHyena((CHARACTER)_Gnoll)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_IsGnollOrHyena((CHARACTER)_Gnoll)
AND
DB_PLA_DyingHyena_GnollPack(_Gnoll,_)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_IsGnollOrHyena((CHARACTER)_Gnoll)
AND
DB_PLA_DyingHyena_NewbornGnolls(_Gnoll)
THEN
DB_NOOP(1);

IF
ObjectTimerFinished((CHARACTER)_Gnoll,"PLA_ConflictedFlind_GnollJokeTimer")
AND
NOT DB_Defeated(_Gnoll)
AND
DB_PLA_ConflictedFlind_GnollJoke_Awaiting(_Gnoll)
AND
DB_PLA_ConflictedFlind_GnollJoke_Caster(_Player,_)
AND
HasAppliedStatus(_Gnoll,"SILENCED",0)
THEN
PROC_PLA_ConflictedFlind_ApplyLaughingStatus(_Gnoll,_Player);

IF
ObjectTimerFinished((CHARACTER)_Gnoll,"PLA_ConflictedFlind_GnollJokeTimer")
AND
DB_PLA_ConflictedFlind_GnollJoke_Awaiting(_Gnoll)
THEN
NOT DB_PLA_ConflictedFlind_GnollJoke_Awaiting(_Gnoll);
PROC_PLA_ConflictedFlind_GnollJoke_CheckEnd();

PROC
PROC_PLA_ConflictedFlind_ApplyLaughingStatus((CHARACTER)_Gnoll,(CHARACTER)_Player)
AND
IsTagged(_Gnoll,(TAG)GNOLL_1350164f-85e1-42f9-89c9-eb0c6703e890,1)
THEN
ApplyStatus(_Gnoll,"PLA_LAUGHINGHARD_GNOLL",12.0,1,_Player);

PROC
PROC_PLA_ConflictedFlind_ApplyLaughingStatus((CHARACTER)_Hyena,(CHARACTER)_Player)
AND
IsTagged(_Hyena,(TAG)HYENA_035128b6-9778-4aa7-8f5f-6623aa4bf4c6,1)
THEN
ApplyStatus(_Hyena,"PLA_LAUGHINGHARD_HYENA",12.0,1,_Player);

PROC
PROC_PLA_ConflictedFlind_GnollJoke_CheckEnd()
AND
NOT DB_PLA_ConflictedFlind_GnollJoke_Awaiting(_)
AND
DB_PLA_ConflictedFlind_GnollJoke_Caster(_Player,_CombatID)
THEN
PROC_PLA_ConflictedFlind_GnollJoke_Start_End();

PROC
PROC_PLA_ConflictedFlind_GnollJoke_Start_End()
AND
DB_PLA_ConflictedFlind_GnollJoke_Caster(_Player,_CombatID)
THEN
NOT DB_PLA_ConflictedFlind_GnollJoke_Caster(_Player,_CombatID);
ResumeCombat(_CombatID);
//END_REGION

PROC
PROC_LevelBecameUnreachable("WLD_Main_A")
THEN
GoalCompleted;
EXITSECTION
PROC_PLA_ConflictedFlind_UnregisterBloodSymbolAreas();
ENDEXITSECTION
ParentTargetEdge "Act1"
