Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Dialog
DB_Dialogs(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, PLA_GithChokepoint_TieflingScout_c7d900d8-9e51-740d-99b7-d8913d135c7d);
DB_AD_Dialog(S_PLA_GithChokepoint_Sign_f45068f8-eb3b-4aca-b9e9-42a120a17286, PLA_GithChokepoint_Sign_AD_e6ed1b75-aabc-3431-293c-940947e99f20);
DB_GLO_CharacterCorpseDialog(S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259, PLA_GithCaptain_Dead_84fe8d48-0763-669b-d09b-c55e2b7a4d31);
DB_GLO_CharacterCorpseDialog(S_PLA_DeadZorruFriend_2e5a05d0-66ef-407c-806d-a12d4ab0c1df, PLA_GithChokepoint_ZorruFriend_Dead_84d47c66-4c56-7484-80ec-2db0cbcb18a9);

DB_Dialogs(	S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,
			S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,
			DIALOGRESOURCEGUID_PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e);

DB_PLA_GithChokepoint_ExtraConfrontationSpeakers(PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e,S_GLO_GithRaider_002_5dd3bb4a-97fa-48b6-9489-5cd577d217f2);
DB_PLA_GithChokepoint_ExtraConfrontationSpeakers(PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e,S_GLO_GithRaider_003_353152d2-d8c9-4257-bcba-4e682b4463df);
DB_PLA_GithChokepoint_ExtraConfrontationSpeakers(PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e,S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f);
DB_PLA_GithChokepoint_ExtraConfrontationSpeakers(PLA_GithChokepoint_ConfrontationLaezel_dfb80d70-8cfe-1a55-bae7-826f164def60,S_GLO_GithRaider_002_5dd3bb4a-97fa-48b6-9489-5cd577d217f2);
DB_PLA_GithChokepoint_ExtraConfrontationSpeakers(PLA_GithChokepoint_ConfrontationLaezel_dfb80d70-8cfe-1a55-bae7-826f164def60,S_GLO_GithRaider_003_353152d2-d8c9-4257-bcba-4e682b4463df);
DB_PLA_GithChokepoint_ExtraConfrontationSpeakers(PLA_GithChokepoint_ConfrontationLaezel_dfb80d70-8cfe-1a55-bae7-826f164def60,S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f);

DB_PLA_GithChokepoint_Confrontation((DIALOGRESOURCE)PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e, 0);
DB_PLA_GithChokepoint_Confrontation((DIALOGRESOURCE)PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94, 1);
DB_PLA_GithChokepoint_Confrontation((DIALOGRESOURCE)PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f, 1);
DB_PLA_GithChokepoint_Confrontation((DIALOGRESOURCE)PLA_GithChokepoint_ConfrontationLaezel_dfb80d70-8cfe-1a55-bae7-826f164def60, 1);

DB_DropMutingStatussesDialog(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c); //patch4 fix
DB_DialogBlockTradeButton(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c);
DB_DialogBlockTradeButton(PLA_GithChokepoint_CINE_RiderAndDragonLeave_3ad8ad7a-b3f0-7537-3303-507dc8c3dfc4);

DB_GLO_Cinematic_PositionedDialog(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c,"PLA_GithChokepoint_DragonEvent");
DB_GLO_Cinematic_PositionFlags("PLA_GithChokepoint_DragonEvent",(TRIGGER)S_PLA_GithFootbridgeBox_9c7ab7c2-85d0-40af-9b93-ac99c1e83371, (FLAG)PLA_GithChokepoint_Event_FootbridgePosition_8c8dd86f-07cb-4f97-b734-33d593b064d1);
DB_GLO_Cinematic_PositionFlags("PLA_GithChokepoint_DragonEvent",(TRIGGER)S_PLA_GithFeatherfallBox_cb46c6bc-6219-475f-806b-8b17c0f17fac, (FLAG)PLA_GithChokepoint_Event_FeatherfallPosition_a8778da0-4bd3-45c1-9da0-a0947bbb868c);
DB_GLO_Cinematic_PositionFlags("PLA_GithChokepoint_DragonEvent",(TRIGGER)S_PLA_GithSlopeBox_19249168-77a0-47e6-8a3a-8b37c1831a16, (FLAG)PLA_GithChokepoint_Event_SlopePosition_237f7d37-308f-4fbb-8cc2-36849b16536c);
DB_GLO_Cinematic_PositionFlags("PLA_GithChokepoint_DragonEvent",(TRIGGER)S_PLA_GithLadderTopBox_39d8ea17-5bb2-43c8-aeef-2e3bb4de00db, (FLAG)PLA_GithChokepoint_Event_LadderTopPosition_f42ee636-fb95-4873-8d99-c848def4ac44);

DB_Dialog_AddAllNearbyPlayersAtStart((DIALOGRESOURCE)GLO_GithChokepoint_PartyReaction_5dd64d54-c8f3-96f3-07c6-c39d85ffa5c0);
DB_Dialog_AddAllNearbyPlayersAtStart((DIALOGRESOURCE)PLA_PreGithChokepoint_WRD_Laezel_3c5e4463-ad9f-c79f-6167-7e0e4c4f45fa);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)PLA_GithChokepoint_ConfrontationLaezel_dfb80d70-8cfe-1a55-bae7-826f164def60);
//END_REGION
//REGION Triggers
PROC_TriggerRegisterForPlayers((TRIGGER)S_PLA_GithRaceCheckSphere_e92009dc-1d11-43ae-b15d-9afa61d21d35);
PROC_TriggerRegisterForPlayers(S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb);
PROC_TriggerRegisterForPlayers(S_PLA_DragonShadow_Box_38005c53-9dd1-4f79-8581-0a4f30370baf); //Dragon shadow 
PROC_TriggerRegisterForPlayers(S_PLA_GithEventPoly_4f1d2ca3-8ebe-4ebd-a4e5-8e92944ff1d1); //Main cutscene
PROC_TriggerRegisterForPlayers(S_PLA_GithChorpseSphere_84fce832-8d59-438f-a440-ab483c22d9e7); //behaviour
PROC_TriggerRegisterForPlayers(S_PLA_GithKnight_SneakBox_c43fdf39-8d20-403d-aca1-ac993f8fb8d4);
PROC_TriggerRegisterForPlayers(S_PLA_GithChokepoint_OngoingSceneArea_6f67dee0-2720-4617-a263-68a58da5681c);

TriggerRegisterForCharacter(S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660, S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6);
//END_REGION
//REGION Objects
SetOnStage(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0,0);
AddPreferredAiTargetTag((CHARACTER)S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, (TAG)REALLY_GITHYANKI_e49c027c-6ec6-4158-9afb-8b59236d10fd);
PROC_SetCanFight(S_GLO_GithRaider_001_6b265792-c6ce-4eb0-94cd-a12b7bbe590d, 0);
SetCanJoinCombat(S_GLO_GithRaider_001_6b265792-c6ce-4eb0-94cd-a12b7bbe590d, 0);
SetHasDialog(S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,0); //doesn't feel good that she's the only one with a speech bubble before the scene
SetOnStage(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 0);
SetOnStage(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 0);

DB_PLA_GithChokepoint_Gith((CHARACTER)S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,(TRIGGER)S_PLA_GithRaiderCaptainPoint_d77e5bc2-a83f-4c87-9f4a-cc4bbbe92d63);
DB_PLA_GithChokepoint_Gith(S_GLO_GithRaider_001_6b265792-c6ce-4eb0-94cd-a12b7bbe590d, NULL_00000000-0000-0000-0000-000000000000);
DB_PLA_GithChokepoint_Gith(S_GLO_GithRaider_002_5dd3bb4a-97fa-48b6-9489-5cd577d217f2, S_PLA_GithRaiderPoint_002_717be1e7-b5b2-49ad-8a89-d1f93817e2b9);
DB_PLA_GithChokepoint_Gith(S_GLO_GithRaider_003_353152d2-d8c9-4257-bcba-4e682b4463df,S_PLA_GithRaiderPoint_003_2f7f60ad-957e-4111-a6f9-12e97adea67f);

DB_PLA_GithChokepoint_Fodder((CHARACTER)S_PLA_GithFodder_001_ab8515a1-cd07-41ae-a5b4-cb50ffb9da4b, "c2ad8bad-d5fd-aa07-6af0-915b3dbe9526", "Main");
DB_PLA_GithChokepoint_Fodder(S_PLA_GithFodder_002_7d9d5ef6-da86-433c-8a53-adfeee5c56b8,"","");
DB_PLA_GithChokepoint_Fodder(S_PLA_GithFodder_003_5d9c2cad-e4cc-4d10-9f00-265b930d7572,"","");
DB_PLA_GithChokepoint_Fodder(S_PLA_GithFodder_004_f8b1afb2-f3f7-41a0-9ac4-a5a4585f569b,"","");

//END_REGION
//REGION Player Reaction Priority
DB_PLA_GithChokepoint_LevelRequirement("WLD_Main_A", 5); //should make this a smarter check because 1 level 5 character is nowhere near as strong as a full party of level 5 characters
DB_DropMutingStatussesDialog(GLO_GithChokepoint_PartyReaction_5dd64d54-c8f3-96f3-07c6-c39d85ffa5c0);
DB_DropMutingStatussesDialog(PLA_PreGithChokepoint_WRD_Laezel_3c5e4463-ad9f-c79f-6167-7e0e4c4f45fa);

DB_PLA_GithChokepoint_PreReaction_Slots((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1); //she's using another dialog
DB_PLA_GithChokepoint_PreReaction_Slots((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 2);
DB_PLA_GithChokepoint_PreReaction_Slots((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 3);
DB_PLA_GithChokepoint_PreReaction_Slots((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 4);

//END_REGION
//REGION Laezel moment 

//overriding the normal confrontation dialog:
PROC_DefineSingleOriginMoment(PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e, (TAG)REALLY_LAEZEL_b5682d1d-c395-489c-9675-1f9b0c328ea5, PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94, PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f, PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94);

DB_PLA_GithChokepoint_OM(PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94);
DB_PLA_GithChokepoint_OM(PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f);

DB_OriginMoment_ExtraNPCs(PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94, S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259);
DB_OriginMoment_ExtraNPCs(PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94, S_GLO_GithRaider_002_5dd3bb4a-97fa-48b6-9489-5cd577d217f2);
DB_OriginMoment_ExtraNPCs(PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94, S_GLO_GithRaider_003_353152d2-d8c9-4257-bcba-4e682b4463df);
DB_OriginMoment_ExtraNPCs(PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94, S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f);

DB_OriginMoment_ExtraNPCs(PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f, S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259);
DB_OriginMoment_ExtraNPCs(PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f, S_GLO_GithRaider_002_5dd3bb4a-97fa-48b6-9489-5cd577d217f2);
DB_OriginMoment_ExtraNPCs(PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f, S_GLO_GithRaider_003_353152d2-d8c9-4257-bcba-4e682b4463df);
DB_OriginMoment_ExtraNPCs(PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f, S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f);

PROC_TriggerRegisterForPlayers(S_PLA_ChokePoint_LaezelInvolveZone_c4ef3fa8-7468-41a2-b46a-14b0d8bc2307);
//END_REGION

//REGION Quests & boosters

//TODO - update gith chokepoints dialogues to make Voss give the insignia
//DB_HasItemEvent((ITEM)TODO, CRE_Invading_State_HasGithInsignia_4a34a580-6aa4-46c4-a907-71d6d0c95c2f);
//DB_GiveItemToEventWithClear((ITEM)TODO, CRE_Invading_Event_GiveGithInsignia_ac2da89d-a2e2-40f8-a4b4-a3136f26725b);

DB_QuestDef_State(GLO_GithChokepoint_Quest_GithLeave_8b2f94b5-9373-36ab-edfe-419764fbb85a, "HIDDEN_WLD_Boosters", "PLA_GithChokepoint_Fooled");

SetOnStage(S_PLA_ChokepointShield_2614ee9a-b62a-4bac-942c-526227c12690, 0);

//END_REGION

//REGION Orpheus Moments (Act 1) RD after dialog with Voss
DB_PLA_Orpheus_GithChokepoint_Confrontation((DIALOGRESOURCE)PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e);
//DB_PLA_Orpheus_GithChokepoint_Confrontation((DIALOGRESOURCE)PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94); //TODO
//DB_PLA_Orpheus_GithChokepoint_Confrontation((DIALOGRESOURCE)PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f); //TODO
DB_PLA_Orpheus_GithChokepoint_Confrontation((DIALOGRESOURCE)PLA_GithChokepoint_ConfrontationLaezel_dfb80d70-8cfe-1a55-bae7-826f164def60);

//END_REGION

DB_PLA_GithChokepoint_ValidInterruptions("EnteredCombat");
DB_PLA_GithChokepoint_ValidInterruptions("Attacked");
DB_PLA_GithChokepoint_ValidInterruptions("Died");

PROC_PLA_GithChokepoint_Init();

DB_Origins_BlockTransferReasons("LaezelRanToKnight");
DB_Origins_BlockTransferReasons("TurnedHostileAtChokepoint");

//REGION Autosave
DB_AutoSaveTrigger((TRIGGER)S_PLA_Gith_Autosave_e97285c9-d08a-464a-9e8b-98cb034d29a9);

//END_REGION

DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("PLA_GithChokepoint_DefeatCounter",PLA_GithChokepoint_Event_AllGithsDefeated_b329e2d8-31c8-4861-ae87-224e86f51682);
DB_GLO_DefeatCounter_AllDeadGlobalFlag("PLA_GithChokepoint_DefeatCounter",PLA_GithChokepoint_Event_AllGithsDead_1e596139-4b27-486d-8cd5-b4ff1b3451dc);
KBSECTION
//REGION Debug

IF
TextEvent("interruptgc")
THEN
PROC_PLA_GithChokepoint_InterruptScene();

IF
TextEvent("plascoutimmortal")
AND
GetTextEventParamInteger(1, _OnOff)
THEN
SetImmortal(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, _OnOff);
PROC_SetInvulnerable(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, _OnOff);

IF
TextEvent("plascouttogith")
THEN
SetOnStage(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, 1);
TeleportTo(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, S_PLA_GithWanderAnchor_4b1b348c-5c53-4ba3-ba1e-a632f6e6c92f);

IF
TextEvent("plagcinterrupt")
AND
GetHostCharacter(_Player)
THEN
PROC_SceneInterrupted(S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,(CHARACTER)_Player,"PLA_GithChokepoint","Attacked");

IF
TextEvent("plagctotavern")
AND
GetHostCharacter(_Player)
THEN
DB_OnlyOnce("GLO_GithChokepoint_DragonFlyOver");
DB_OnlyOnce("PLA_GithChokepoint_StartDragonScene");
PROC_PLA_GithChokepoint_MakeDragonLeave(0);
TeleportTo(_Player,S_Debug_PlainsChokepoint_0667b0a8-c78e-4c72-9e7d-443df93682a9);

IF
TextEvent("plagctotavern")
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
THEN
TeleportTo(_Gith,S_Debug_PlainsChokepoint_0667b0a8-c78e-4c72-9e7d-443df93682a9);

IF
TextEvent("gcshadow")
AND
DB_PLA_GithChokepoint_Debug_Speed(_Speed)
THEN
NOT DB_PLA_GithChokepoint_Debug_Speed(_Speed);

IF
TextEvent("gcshadow")
THEN
NOT DB_PLA_GithChokepoint_Debug_DoFrightened(1);

IF
TextEvent("gcshadow")
AND
GetTextEventParamReal(1, _Speed)
THEN
DB_PLA_GithChokepoint_Debug_Speed(_Speed);

IF
TextEvent("gcshadow")
AND
GetTextEventParamInteger(2, 1)
THEN
DB_PLA_GithChokepoint_Debug_DoFrightened(1);

IF
TextEvent("gcshadow")
AND
GetHostCharacter(_Player)
THEN
StopAnimation(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, 0);
PROC_PLA_GithChokepoint_Debug_CheckSpeed();
PROC_PLA_GithChokepoint_Debug_MoveShadow(_Player);

PROC
PROC_PLA_GithChokepoint_Debug_CheckSpeed()
AND
NOT DB_PLA_GithChokepoint_Debug_Speed(_)
THEN
DB_PLA_GithChokepoint_Debug_Speed(12.0);

PROC
PROC_PLA_GithChokepoint_Debug_MoveShadow((CHARACTER)_Player)
AND
DB_PLA_GithChokepoint_Debug_Speed(_Speed)
THEN
NOT DB_PLA_GithChokepoint_Debug_Speed(_Speed);
PROC_GithChokepoint_DragonFlyOver(_Speed);

PROC
PROC_PLA_GithChokepoint_Debug_MoveShadow((CHARACTER)_Player)
AND
DB_PLA_GithChokepoint_Debug_DoFrightened(1)
THEN
NOT DB_OnlyOnce("PLA_GithChokepoint_DragonShadowVB");
NOT DB_PLA_GithChokepoint_Debug_DoFrightened(1);
PROC_PLA_GithChokepoint_InitFrightenedSavingThrow(_Player);

IF
TextEvent("beargithchokepoint")
AND
DB_Players(_Player)
AND
NOT DB_Is_WildShaped(_Player)
THEN
ApplyStatus(_Player,"WILDSHAPE_BEAR_POLAR_PLAYER",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("wsgithchokepoint")
THEN
ApplyStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,"WILDSHAPE_BEAR_POLAR_PLAYER",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,"WILDSHAPE_WOLF_DIRE_PLAYER",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"WILDSHAPE_RAVEN_PLAYER",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,"WILDSHAPE_DEEP_ROTHE_PLAYER",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

//recruiting her from debug book after the second recruitment was activated
IF
FlagSet((FLAG)_Flag, (CHARACTER)_Character, _) // flagType: Object
AND
DB_Debug_CharacterAddFlags((FLAG)_Flag, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(FLAG)_)
AND
DB_GlobalFlag(ORI_LaezelRecruitment_State_PlainsVersionInitiated_59bda4f5-708b-4f23-aaba-d5f387ae95c2)
THEN
ClearFlag(ORI_LaezelRecruitment_State_PlainsVersionInitiated_59bda4f5-708b-4f23-aaba-d5f387ae95c2, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(PLA_LaezelRecruitment_Event_NormalFlow_4c50a81b-38ac-4365-914e-64c19d3880b8);
TeleportTo(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Character);

//END_REGION

//REGION Init

IF
DB_PLA_GithChokepoint_Fodder(_Char,_,_)
THEN
PROC_SetCanFight(_Char,0);
SetCanJoinCombat(_Char,0);
SetCanTrade(_Char, 0);

PROC
PROC_PLA_GithChokepoint_Init()
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
THEN
DB_GLO_DefeatCounter(_Gith, "PLA_GithChokepoint_DefeatCounter");
DB_SceneManager(_Gith, "PLA_GithChokepoint");
SetCanTrade(_Gith, 0);

PROC
PROC_PLA_GithChokepoint_Init()
AND
DB_PLA_GithChokepoint_Fodder(_Fodder, _, _)
THEN
DB_SceneManager(_Fodder, "PLA_GithChokepoint");

PROC
PROC_PLA_GithChokepoint_Init()
THEN
DB_SceneManager(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, "PLA_GithChokepoint");
DB_SceneManager(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, "PLA_GithChokepoint");
PROC_PLA_GithChokepoint_SetKeyCharImmortal(1);
SetCanTrade(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 0);

PROC
PROC_PLA_GithChokepoint_SetKeyCharImmortal((INTEGER)_Bool)
THEN
SetImmortal(S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,_Bool);
SetImmortal(S_PLA_GithFodder_001_ab8515a1-cd07-41ae-a5b4-cb50ffb9da4b,_Bool);
PROC_SetInvulnerable(S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,_Bool);
PROC_SetInvulnerable(S_PLA_GithFodder_001_ab8515a1-cd07-41ae-a5b4-cb50ffb9da4b,_Bool);

IF
DB_PLA_GithChokepoint_Confrontation(_ConfrontationDialog, _)
THEN
DB_DialogBlockTradeButton(_ConfrontationDialog);

//END_REGION

//REGION Shadow

//Player enters trigger for the first time -> start event
IF
EnteredTrigger(_Player, S_PLA_DragonShadow_Box_38005c53-9dd1-4f79-8581-0a4f30370baf)
AND
NOT DB_GlobalFlag((FLAG)GLO_GithChokepoint_DragonAppear_cf1be49e-50fb-b2e1-fa39-efbf7fdd4abf) // flagType: Global
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_StartDragonScene")
AND
QRY_OnlyOnce("GLO_GithChokepoint_DragonFlyOver")
THEN
PROC_TriggerUnregisterForPlayers(S_PLA_DragonShadow_Box_38005c53-9dd1-4f79-8581-0a4f30370baf);
PROC_GithChokepoint_DragonFlyOver(12.0);
PROC_PLA_GithChokepoint_InitFrightenedSavingThrow(_Player);

PROC
PROC_GithChokepoint_DragonFlyOver((REAL)_Speed)
THEN
//SetForceUpdate(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0,1);
SetFlag(PLA_GithChokepoint_Knows_SawDragonShadow_93c4f67f-2f8a-4556-bf66-de1645caedf9, NULL_00000000-0000-0000-0000-000000000000);
TriggerRegisterForItems(S_PLA_ScoutDragonDetectionBox_f3cde32c-792f-46e6-84f2-f1f2dc3f5870);
//TeleportTo(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, S_PLA_DragonShadow_Start_cf5e4190-56bb-4fb4-86a2-30a685b8440d, "", 0, 0, 0, 1, 0);
//SetOnStage(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, 1);
//PROC_PlayLoopingAnimation(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0,(ANIMATION)NULL_00000000-0000-0000-0000-000000000000,(ANIMATION)CUST_Fly_Over_01_e3aa9740-9ed4-4972-bff6-804d7ab93d2f,(ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
//ItemMoveTo(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, S_PLA_DragonShadow_Leave_e0b91d7e-781c-4b99-b795-c30aac915ddb, _Speed, 0.0, 0, "GLO_GithChokepoint_ShadowPassed", 0);
ObjectTimerLaunch(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0,"S_PLA_DragonShadow_PlaySound",200,0);

IF
ObjectTimerFinished(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0,"S_PLA_DragonShadow_PlaySound")
THEN
PlaySound(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0,"Dragon_Rig_DFLT_CUST_Fly_Over_01_Roar");
/*
IF
EntityEvent(_, "GLO_GithChokepoint_ShadowPassed")
THEN
SetForceUpdate(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0,0);
StopAnimation(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, 0);
SetOnStage(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, 0);
*/

PROC
PROC_PLA_GithChokepoint_InitFrightenedSavingThrow((CHARACTER)_RefPlayer)
AND
DB_PartyMembers(_Player)
AND
NOT DB_CantAct(_Player)
AND
QRY_IsInRange(_Player, _RefPlayer, 10.0)
THEN
PROC_PLA_GithChokepoint_DoFrightenedSavingThrow((CHARACTER)_Player);

PROC
PROC_PLA_GithChokepoint_DoFrightenedSavingThrow((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
SetFlag(ORI_Laezel_Quest_SawDragonRider_b82787bc-316b-417a-ae95-a1abc1f7116a, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
ObjectTimerLaunch(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "PLA_GithChokepoint_DragonShadowVBTimer", 1500);

PROC
PROC_PLA_GithChokepoint_DoFrightenedSavingThrow((CHARACTER)_Player)
AND
_Player != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
AND
IsTagged(_Player, (TAG)REALLY_GITHYANKI_e49c027c-6ec6-4158-9afb-8b59236d10fd, _IsGithyanki)
AND
DB_Players(_AnyPlayerSource)
AND
IsImmuneToStatusGroup(_Player, "SG_Frightened", _AnyPlayerSource, 0)
AND
QRY_OnlyOnce("PLA_GithChokepoint_FrightenedCheck")
THEN
RequestPassiveRoll(_Player, S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, "SavingThrow", "Wisdom", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, _IsGithyanki, "PLA_GithChokepoint_FrightenedSV"); //gith has advantage

IF
RollResult("PLA_GithChokepoint_FrightenedSV", _Player, S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, _Result, _, _)
AND
_Result != 1
THEN
PROC_PLA_GithChokepoint_ApplyFrightened(_Player);

PROC
PROC_PLA_GithChokepoint_ApplyFrightened((CHARACTER)_Player)
AND
NOT DB_Is_InCombat(_Player, _)
THEN
ApplyStatus(_Player, "PLA_GITHCHOKEPOINT_FRIGHTENED", 4.0, 0, S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f); //Replace with normal Frightened status
SetFlag(PLA_GithChokepoint_State_FailedFrightenedSV_5023eadd-b2c2-61d8-9aac-51272b77ec18, _Player);

PROC
PROC_PLA_GithChokepoint_ApplyFrightened((CHARACTER)_Player)
AND
DB_Is_InCombat(_Player, _)
THEN
ApplyStatus(_Player, "PLA_GITHCHOKEPOINT_FRIGHTENED", 2.0, 0, S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f); //Replace with normal Frightened status
SetFlag(PLA_GithChokepoint_State_FailedFrightenedSV_5023eadd-b2c2-61d8-9aac-51272b77ec18, _Player);

IF
RollResult("PLA_GithChokepoint_FrightenedSV", _Player, S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, _, _, _)
THEN
ObjectTimerLaunch(_Player, "PLA_GithChokepoint_DragonShadowVBTimer", 1500);

IF
ObjectTimerFinished((CHARACTER)_Player, "PLA_GithChokepoint_DragonShadowVBTimer")
AND
NOT DB_CantTalk(_Player)
AND
DB_InRegion(_Player, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb)
AND
QRY_OnlyOnce("PLA_GithChokepoint_DragonShadowVB")
THEN
StartVoiceBark((VOICEBARKRESOURCE)PLA_GithChokepoint_VB_DragonShadow_8da03e13-b4db-3bcf-f5d0-264d3edf11c9, _Player);

//END_REGION

//REGION Tiefling Scout

//TODO: disable this scout if the Gith Chokepoint is cancelled

// Reacts to dragon
IF
ItemEnteredTrigger(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, S_PLA_ScoutDragonDetectionBox_f3cde32c-792f-46e6-84f2-f1f2dc3f5870, _)
AND
IsInTrigger(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6,S_PLA_ScoutReactionSphere_1d08709b-706e-4136-8a7b-9de3371f573f, 1)
THEN
PROC_TryStartAD(PLA_GithChokepoint_AD_ScoutReactsToDragon_4dc8829a-4d30-f9f0-0034-3bf28ba64309, S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6);

IF
ItemEnteredTrigger(S_PLA_DragonShadow_817589f4-8bda-49be-8567-57fe21374cf0, S_PLA_ScoutDragonDetectionBox_f3cde32c-792f-46e6-84f2-f1f2dc3f5870, _)
THEN
TriggerUnregisterForItems(S_PLA_ScoutDragonDetectionBox_f3cde32c-792f-46e6-84f2-f1f2dc3f5870);


// Level check
IF
DialogStarted(PLA_GithChokepoint_TieflingScout_c7d900d8-9e51-740d-99b7-d8913d135c7d, _Inst)
AND
DialogGetInvolvedPlayer(_Inst, 1, _Player)
THEN
PROC_GLO_GithChokepoint_CheckLevel((CHARACTER)_Player);


// Getting in trouble
IF
EnteredTrigger(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6,S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660)
THEN
DB_PLA_GithChokepoint_ScoutMessesUpScene(1);
PROC_SceneInterrupted(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6,NULL_00000000-0000-0000-0000-000000000000,"PLA_GithChokepoint","PLA_GithChokepoint_ScoutPushedDown");
SetEntityEvent(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, "ClearCrimeReturn", 1);

QRY
QRY_CRIME_BlockRegisterCrime(_,_,_,S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6,_)
AND
IsInTrigger(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6,S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660, 1)
THEN
SetEntityEvent(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, "ClearCrimeReturn", 1);


//--- DragonEvent starts/ Make her leave, or wait for the scene to finish
PROC
PROC_PLA_GithChokepoint_DragonSceneEnded()
THEN
PROC_PLA_GithChokepoint_CheckResolveScout();

PROC
PROC_PLA_GithChokepoint_CheckResolveScout()
AND
IsInTrigger(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6,S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660, 1)
THEN
PROC_PLA_GithChokepoint_ScoutTryLeaveCombat();
SetEntityEvent(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, "ClearCrimeReturn", 1);

// Leaving out of sight
PROC
PROC_PLA_GithChokepoint_CheckResolveScout()
AND
NOT DB_PLA_GithChokepoint_ScoutMessesUpScene(1)
THEN
PROC_PLA_GithChokepoint_ScoutTryLeaveCombat();
DB_OnlyOnce("PLA_ChokepointScout_Disappear");

IF
FlagSet(PLA_GithChokepoint_Event_AllGithsDefeated_b329e2d8-31c8-4861-ae87-224e86f51682, NULL_00000000-0000-0000-0000-000000000000, _)
AND
QRY_OnlyOnce("PLA_ChokepointScout_Disappear")
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)FactionHostileToPlayerGroupAfterDialog_d73ce44b-1b9a-2e02-f29a-d8e9e68c7edc, S_PLA_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, _)
THEN
DB_PLA_GithChokepoint_TieflingScout_AttackRequested(1);

IF
DB_OnDialogAttackRequested(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6,_Player,0)
THEN
DB_PLA_GithChokepoint_TieflingScout_AttackRequested(1);

IF
DialogEnded(PLA_GithChokepoint_TieflingScout_c7d900d8-9e51-740d-99b7-d8913d135c7d, _Inst)
AND
NOT DB_HostileToPlayerGroupAfterDialog(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, _Inst)
AND
NOT DB_PLA_GithChokepoint_TieflingScout_AttackRequested(1)
AND
QRY_OnlyOnce("PLA_ChokepointScout_Disappear")
THEN
DB_NOOP(1);

PROC
PROC_StateSet_Defeated(PLA_GithChokepoint_TieflingScout_c7d900d8-9e51-740d-99b7-d8913d135c7d)
AND
QRY_OnlyOnce("PLA_ChokepointScout_Disappear")
THEN
DB_NOOP(1);

IF
DB_OnlyOnce("PLA_ChokepointScout_Disappear")
AND
NOT DB_CantTalk(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6)
AND
NOT DB_CantMove(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6)
AND
NOT DB_EnterCombatRequested(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6)
THEN
PROC_TryStartAD(PLA_GithChokepoint_AD_ScoutLeaves_031b4116-1e7d-712f-74b0-c6e4e8febb87,S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6); //generic enough to play anytime
PROC_SetCanFight(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, 0);
SetCanJoinCombat(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, 0);
PROC_DisappearOutOfSightTo(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, S_PLA_ScoutDisappearPoint_ab57d0ef-73a8-4d11-b15d-ead5f0ddf75d, "Run", 0, "");


// Ending combat
PROC
PROC_PLA_GithChokepoint_ScoutTryLeaveCombat() //edge-case: the scout was fighting the gith when the player triggered the cutscene
AND
DB_Is_InCombat(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, _)
THEN
PROC_SetCanFight(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, 0);
SetCanJoinCombat(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, 0);


//--- Fighting githyanki & players
//Ellyka is neutral to giths at first. If she's pushed down, she becomes hostile to githyanki and to players (it's safe to assume that players pushed her down, something else would be rare)
//adding her to the defeat counter will make the game wait for her death, in the unlikely event of her surviving the fight until she's the last one standing 
PROC
PROC_PLA_GithChokepoint_DragonSceneEnded_NotifyScout()
AND
QRY_PLA_GithChokepoint_ScoutAtGith()
THEN
PROC_SceneInterrupted(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6,NULL_00000000-0000-0000-0000-000000000000,"PLA_GithChokepoint","PLA_GithChokepoint_ScoutPushedDown"); //now interrupting after DragonEvent, will trigger hostility

PROC
PROC_PLA_GithChokepoint_SetScoutHostile()
AND
QRY_PLA_GithChokepoint_ScoutAtGith()
THEN
NOT DB_OnlyOnce("PLA_ChokepointScout_Disappear");
PROC_SetCanFight(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, 1);
SetCanJoinCombat(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, 1);
SetFaction(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, ACT1_PLA_ChokepointScout_Hostile_80dd7a29-f7b2-495d-8f10-70868dcda4a7);
DB_GLO_DefeatCounter(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, "PLA_GithChokepoint_DefeatCounter");

QRY
QRY_PLA_GithChokepoint_ScoutAtGith()
AND
NOT DB_Defeated(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6) //if the scout died from the fall, no need to cancel the whole gith chokepoint
AND
IsInTrigger(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6,S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660, 1)
AND
IsOnStage(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, 1)
THEN
DB_NOOP(1);

//END_REGION

//REGION Dragon Scene

//--- Start
IF
DB_InRegion(_Player, S_PLA_GithEventPoly_4f1d2ca3-8ebe-4ebd-a4e5-8e92944ff1d1)
AND
DB_PartyMembers(_Player)
AND
NOT DB_Defeated(_Player)
THEN
PROC_PLA_GithChokepoint_CheckStartDragonScene(_Player);

PROC
PROC_PLA_GithChokepoint_CheckStartDragonScene((CHARACTER)_Player)
AND
QRY_OnlyOnce("PLA_GithChokepoint_StartDragonScene")
THEN
SetFlag(PLA_GithChokepoint_Knows_SawDragonShadow_93c4f67f-2f8a-4556-bf66-de1645caedf9, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(PLA_GithChokepoint_Event_DragonEventStarts_046af9e7-4d1a-4a9b-80a9-826c171a25b0, NULL_00000000-0000-0000-0000-000000000000);
SetHasDialog(S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,1);
PROC_TriggerUnregisterForPlayers(S_PLA_GithEventPoly_4f1d2ca3-8ebe-4ebd-a4e5-8e92944ff1d1);
TriggerUnregisterForCharacter(S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660,S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6);
PROC_PLA_GithChokepoint_TriggeredScene(_Player);

PROC
PROC_PLA_GithChokepoint_TriggeredScene((CHARACTER)_Player)
THEN
PROC_ForceStopDialog(_Player);
PROC_PLA_GithChokepoint_SetKeyCharImmortal(0);
PROC_PLA_GithChokepoint_StartDragonScene(_Player);


// remove from scene so they can die
PROC
PROC_PLA_GithChokepoint_StartDragonScene((CHARACTER)_)
AND
DB_PLA_GithChokepoint_Fodder(_Fodder, _, _)
THEN
NOT DB_SceneManager(_Fodder, "PLA_GithChokepoint");

PROC
PROC_PLA_GithChokepoint_StartDragonScene((CHARACTER)_)
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
AND
DB_Is_InCombat(_Gith, _)
THEN
LeaveCombat(_Gith);


// start scene
PROC
PROC_PLA_GithChokepoint_StartDragonScene((CHARACTER)_Player)
AND
NOT QRY_StartDialogCustom(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c, 
	S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259, 
	S_PLA_GithFodder_001_ab8515a1-cd07-41ae-a5b4-cb50ffb9da4b,
	NULL_00000000-0000-0000-0000-000000000000, //knight
	NULL_00000000-0000-0000-0000-000000000000, //dragon
	_Player, 0, 0, 0, 0)
THEN
PROC_PLA_GithChokepoint_DragonSceneFailed();

PROC
PROC_PLA_GithChokepoint_StartDragonScene((CHARACTER)_)
THEN
TriggerLaunchIterator(S_PLA_GithBridgeOnBox_cacfc8c6-ecb1-46c6-9163-e8307ed3aa63, "PLA_GithChokepoint_OnBridge", "");

IF
EntityEvent((CHARACTER)_NPC, "PLA_GithChokepoint_OnBridge")
AND
NOT DB_PLA_GithChokepoint_Fodder(_NPC, _, _)
AND
NOT DB_PLA_GithChokepoint_Gith(_NPC,_)
THEN
TeleportTo(_NPC, S_PLA_GithBridgeOutPoint_4e9c6115-836d-44c4-b0cb-bcf1f553443a, "");


//--- Dialog starts
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c,(INTEGER)_Inst)
THEN
PROC_DialogAddSpeakingActor(_Inst, S_GLO_GithRaider_002_5dd3bb4a-97fa-48b6-9489-5cd577d217f2);
PROC_DialogAddSpeakingActor(_Inst, S_GLO_GithRaider_003_353152d2-d8c9-4257-bcba-4e682b4463df);
PROC_DialogAddSpeakingActor(_Inst, S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea);
PROC_DialogAddSpeakingActor(_Inst, S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f);
PROC_PLA_GithChokepoint_DragonSceneStarted();

IF
DialogActorJoined(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c,_Inst,(CHARACTER)_Player, _)
AND
DB_PartyMembers(_Player)
AND
QRY_OnlyOnce("PLA_GithChokepoint_DragonSceneStarted")
THEN
DB_PLA_GithChokepoint_AddOtherPlayers(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c);
DB_AddCharactersInTriggerToDialog(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb, 1, 1, 1);

PROC
PROC_PLA_GithChokepoint_DragonSceneStarted()
THEN
PROC_PLA_LaezelRecruit_DragonSceneStarted();

PROC
PROC_PLA_GithChokepoint_DragonSceneStarted()
AND
DB_PLA_GithChokepoint_Gith(_Gith,_Trigger)
AND
_Trigger != NULL_00000000-0000-0000-0000-000000000000
THEN
TeleportTo(_Gith,_Trigger,"");

PROC
PROC_PLA_GithChokepoint_DragonSceneStarted()
AND
DB_PLA_GithChokepoint_Fodder(_NPC, "", "")
THEN
SetDetached(_NPC, 1);
TeleportTo(_NPC, S_PLA_GithBridgeOutPoint_4e9c6115-836d-44c4-b0cb-bcf1f553443a, "");

//wait for the dialog to fully start before removing this one
//TODO: we have to remove the bridge from the scene in script because of timeline issues. Needs to be followed up.
//There's a safety rule on the DialogEnded event in case the dialog fails to start
IF
DialogStarted(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c,_)
THEN
DestroyPlatform(S_PLA_GithChokepointBridge_PLT_67721125-597f-4cc8-a8a5-5ffaaf5d44d7);


//--- Dialog failed
PROC
PROC_PLA_GithChokepoint_DragonSceneFailed()
THEN
PROC_PLA_GithChokepoint_DragonSceneStarted();
PROC_PLA_GithChokepoint_DragonSceneEnded();

//END_REGION
//REGION Dragon Scene: ending (killing FF, changing bridge)

//--- Dragon & knight appears
IF
FlagSet(GLO_GithChokepoint_DragonAppear_cf1be49e-50fb-b2e1-fa39-efbf7fdd4abf, _, _Inst) // flagType: Global
THEN
//UseSpell(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, "Zone_PLA_Chokepoint_DragonBreath", S_PLA_GithFodder_004_f8b1afb2-f3f7-41a0-9ac4-a5a4585f569b, 0, 1, 1);
DB_NOOP(1);

//--- Scene ends
IF
DialogEnded(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c,_)
THEN
PROC_PLA_GithChokepoint_DragonSceneEnded();

PROC
PROC_PLA_GithChokepoint_DragonSceneEnded() //called when the dialog fails too
AND
QRY_OnlyOnce("PLA_GithChokepoint_DragonSceneEnded_Cleanup2")
THEN
PROC_SetOnStage(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 1);
PROC_SetOnStage(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 1);
SetImmortal(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f,1);
SetImmortal(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,1);
PROC_SetInvulnerable(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f,1);
PROC_SetInvulnerable(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,1);
TriggerLaunchIterator(S_PLA_GithCollapsedBridgeOnBox_f5ed7468-b5d2-4138-9a13-963757256477, "PLA_GithChokepoint_OnCollapsedBridge", "");
TriggerLaunchIterator(S_PLA_GithCollapsedBridgeOnVoidBox_a392fd55-153c-4a8d-bf58-889fc0a65c74, "PLA_GithChokepoint_OnCollapsedBridge", "");

IF
LeftLevel(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, "WLD_Main_A")
AND
IsImmortal(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 1)
THEN
SetImmortal(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 0);
PROC_SetInvulnerable(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f,0);

IF
LeftLevel(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, "WLD_Main_A")
AND
IsImmortal(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 1)
THEN
SetImmortal(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 0);
PROC_SetInvulnerable(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 0);

IF
EntityEvent(_Char, "PLA_GithChokepoint_OnCollapsedBridge")
THEN
TeleportTo(_Char, S_PLA_GithCollapsedDeathEdgeCasePoint_d9e96cbe-db24-40d7-9c85-fa095154777a, "");

IF
EntityEvent((CHARACTER)_Char, "PLA_GithChokepoint_OnCollapsedBridge")
AND
DB_Players(_Char)
THEN
Die(_Char, DEATHTYPE.Incinerate, S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 0, 1);

IF
EntityEvent((CHARACTER)_Char, "PLA_GithChokepoint_OnCollapsedBridge")
AND
NOT DB_Players(_Char)
THEN
Die(_Char, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

PROC
PROC_PLA_GithChokepoint_DragonSceneEnded()
AND
QRY_OnlyOnce("PLA_GithChokepoint_DragonSceneEnded_Cleanup1")
THEN
SetFlag((FLAG)GLO_GithChokepoint_DragonEventEnd_ded1de27-9668-418f-93f6-4b5a789b5640, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
Die(S_PLA_GithBridgeCollapsedHelper_a777c47b-b54e-4286-93c7-72c1fc5b5828);
PROC_PLA_GithChokepoint_KillFodderAndBridge();
NOT DB_OnlyOnce("PLA_GithChokepoint_InterruptedScene");
DB_SceneTriggerManager("PLA_GithChokepoint", S_PLA_ChokepointConfrontSceneBox_00cb3901-cdb0-4505-bffb-6b24390db71b);
PROC_TriggerRegisterForPlayers(S_PLA_ChokepointConfrontSceneBox_00cb3901-cdb0-4505-bffb-6b24390db71b);
PROC_PLA_GithChokepoint_DragonSceneEnded_NotifyScout();

//--- Bridge destroyed
PROC
PROC_PLA_GithChokepoint_KillFodderAndBridge()
AND
DB_PLA_GithChokepoint_Fodder((CHARACTER)_Char, _, _)
THEN
TeleportTo(_Char, S_PLA_GithFodderTPTrigger_234397bb-f6f8-4880-82fd-6450f3a7091c, "");
SetOnStage(_Char, 0);

PROC
PROC_PLA_GithChokepoint_KillFodderAndBridge()
THEN
DestroyPlatform(S_PLA_GithChokepointBridge_PLT_67721125-597f-4cc8-a8a5-5ffaaf5d44d7);

//END_REGION

//REGION Companion reactions (selection)
IF
DialogEnded(PLA_GithChokepoint_DragonEvent_3eb22b2c-bc59-03de-7a6e-68940620b16c,_Id)
AND
NOT QRY_PLA_GithChokepoint_SkipReaction()
AND
DialogGetInvolvedPlayer(_Id,1,(CHARACTER)_Player)
AND
QRY_GithChokepoint_SetHookPlayer(_Player, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb)
THEN
TimerLaunch("GLO_GithChokepoint_PlayerReaction_Timer",200);

QRY
QRY_PLA_GithChokepoint_SkipReaction()
AND
DB_PLA_GithChokepoint_ScoutMessesUpScene(1)
THEN
PROC_PLA_LaezelRecruit_ReactionEnded();

QRY
QRY_GithChokepoint_SetHookPlayer((CHARACTER)_Avatar, (TRIGGER)_) //is avatar
AND
DB_Avatars(_Avatar)
AND
NOT DB_CantAct(_Avatar)
THEN
DB_GLO_GithChokepoint_PlayerReaction(_Avatar);

QRY 
QRY_GithChokepoint_SetHookPlayer((CHARACTER)_Player, (TRIGGER)_ControlTrig) //is companion, get avatar
AND
NOT DB_GLO_GithChokepoint_PlayerReaction(_)
AND
QRY_GetBestAvatarForCompanion(_Player,1,0)
AND
DB_QRYRTN_GetBestAvatarForCompanion(_Player,_Avatar)
AND
DB_InRegion(_Avatar, _ControlTrig)
AND
NOT DB_CantAct(_Avatar)
THEN
DB_GLO_GithChokepoint_PlayerReaction(_Avatar);

QRY
QRY_GithChokepoint_SetHookPlayer((CHARACTER)_, (TRIGGER)_ControlTrig) //get any avatar
AND
NOT DB_GLO_GithChokepoint_PlayerReaction(_)
AND
DB_Avatars(_Avatar)
AND
NOT DB_GLO_GithChokepoint_PlayerReaction(_)
AND
DB_InRegion(_Avatar, _ControlTrig)
AND
NOT DB_CantAct(_Avatar)
THEN
DB_GLO_GithChokepoint_PlayerReaction(_Avatar);

QRY
QRY_GithChokepoint_SetHookPlayer((CHARACTER)_Player, (TRIGGER)_) //set this char
AND
NOT DB_GLO_GithChokepoint_PlayerReaction(_)
AND
DB_Players(_Player)
AND
NOT DB_CantAct(_Player)
THEN
DB_GLO_GithChokepoint_PlayerReaction(_Player);

QRY
QRY_GithChokepoint_SetHookPlayer((CHARACTER)_NotPlayer, (TRIGGER)_ControlTrig) //set any player
AND
NOT DB_GLO_GithChokepoint_PlayerReaction(_)
AND
NOT DB_Players(_NotPlayer)
AND
DB_Players(_Player)
AND
NOT DB_GLO_GithChokepoint_PlayerReaction(_)
AND
DB_InRegion(_Player, _ControlTrig)
AND
NOT DB_CantAct(_Player)
THEN
DB_GLO_GithChokepoint_PlayerReaction(_Player);

IF
TimerFinished("GLO_GithChokepoint_PlayerReaction_Timer")
AND
DB_GLO_GithChokepoint_PlayerReaction(_Player)
THEN
PROC_GLO_GithChokepoint_CheckLevel(_Player);
PROC_GLO_GithChokepoint_CompanionReactionDialog(_Player);
NOT DB_GLO_GithChokepoint_PlayerReaction(_Player);


//--- Check level
PROC
PROC_GLO_GithChokepoint_CheckLevel((CHARACTER)_Player)
AND
DB_CurrentLevel(_CurrentLevel)
AND
DB_PLA_GithChokepoint_LevelRequirement(_CurrentLevel, _LevelRequired)
AND
GetLevel(_Player,_Level)
AND
_Level >= _LevelRequired
AND
SysCount("DB_Players", 1, _PlayerCount)
AND
_PlayerCount >= 3
THEN
SetFlag((FLAG)GLO_GithChokepoint_State_MeetsLevel_a57d969d-dbb0-246e-c97a-7d2d0a9d77b2, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

PROC
PROC_GLO_GithChokepoint_CompanionReactionDialog((CHARACTER)_Player) // 1) Lae'zel
AND
_Player != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
AND
DB_Players(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_InRegion(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_ChokePoint_LaezelInvolveZone_c4ef3fa8-7468-41a2-b46a-14b0d8bc2307)
AND
QRY_OnlyOnce("PLA_GithChokepoint_PlayerReaction_OnlyOnce")
THEN
PROC_GLO_GithChokepoint_CompanionReactionDialog(_Player,S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

PROC
PROC_GLO_GithChokepoint_CompanionReactionDialog((CHARACTER)_Player) // 2) generic gith companion
AND
DB_Players(_GithCompanion)
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_PlayerReaction_OnlyOnce")
AND
_Player != _GithCompanion
AND
NOT DB_Avatars(_GithCompanion)
AND
IsTagged(_GithCompanion, (TAG)REALLY_GITHYANKI_e49c027c-6ec6-4158-9afb-8b59236d10fd, 1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, _GithCompanion)
AND
QRY_OnlyOnce("PLA_GithChokepoint_PlayerReaction_OnlyOnce")
THEN
PROC_GLO_GithChokepoint_CompanionReactionDialog(_Player,_GithCompanion);

PROC
PROC_GLO_GithChokepoint_CompanionReactionDialog((CHARACTER)_Player) // 3) origins companions
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_PlayerReaction_OnlyOnce")
AND
QRY_PLA_GithChokepoint_FindCompanionReactionCompanion((CHARACTER)_Player)
AND
DB_QRYRTN_PLA_GithChokepoint_FindCompanionReactionCompanion(_OriginCompanion)
AND
QRY_OnlyOnce("PLA_GithChokepoint_PlayerReaction_OnlyOnce")
THEN
PROC_GLO_GithChokepoint_CompanionReactionDialog(_Player,_OriginCompanion);

QRY
QRY_PLA_GithChokepoint_FindCompanionReactionCompanion((CHARACTER)_Player)
AND
DB_PLA_GithChokepoint_PreReaction_Slots(_Companion, _Priority)
AND
_Player != _Companion
AND
DB_Players(_Companion)
AND
NOT DB_Avatars(_Companion)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, _Companion)
AND
QRY_PLA_GithChokepoint_PreReaction_IsBetterCompanionReactionCompanion(_Companion, _Priority)
THEN
DB_QRYRTN_PLA_GithChokepoint_FindCompanionReactionCompanion(_Companion);

QRY
QRY_PLA_GithChokepoint_PreReaction_IsBetterCompanionReactionCompanion(_ , _)
AND
NOT DB_QRYRTN_PLA_GithChokepoint_FindCompanionReactionCompanion(_)
THEN
DB_NOOP(1);

QRY
QRY_PLA_GithChokepoint_PreReaction_IsBetterCompanionReactionCompanion((CHARACTER)_NewOption , (INTEGER)_NewPrio)
AND
DB_QRYRTN_PLA_GithChokepoint_FindCompanionReactionCompanion(_OldOption)
AND
DB_PLA_GithChokepoint_PreReaction_Slots(_OldOption, _OldPrio)
AND
_NewPrio < _OldPrio
THEN
NOT DB_PLA_GithChokepoint_PreReaction_Slots(_OldOption, _OldPrio);

PROC
PROC_GLO_GithChokepoint_CompanionReactionDialog((CHARACTER)_Player) // 3) any other
AND
DB_Players(_OtherCompanion)
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_PlayerReaction_OnlyOnce")
AND
_Player != _OtherCompanion
AND
NOT DB_PLA_GithChokepoint_PreReaction_Slots((CHARACTER)_OtherCompanion, _)
AND
NOT DB_Avatars(_OtherCompanion)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, _OtherCompanion)
AND
QRY_OnlyOnce("PLA_GithChokepoint_PlayerReaction_OnlyOnce")
THEN
PROC_GLO_GithChokepoint_CompanionReactionDialog(_Player,_OtherCompanion);


//No Companion
PROC
PROC_GLO_GithChokepoint_CompanionReactionDialog((CHARACTER)_Player)
AND
QRY_OnlyOnce("PLA_GithChokepoint_PlayerReaction_OnlyOnce")
THEN
SetFlag(PLA_GithChokepoint_Event_SoloReaction_5065f076-bc0e-4b89-a058-d36b5c9d3eaf, NULL_00000000-0000-0000-0000-000000000000);
PROC_GLO_GithChokepoint_CompanionReactionDialog(_Player,NULL_00000000-0000-0000-0000-000000000000);

//END_REGION
//REGION Compation reactions - starting dialog

//Lae'zel's dialog is in it's own REGION to handle some more stuff with it

//Solo comment
PROC
PROC_GLO_GithChokepoint_CompanionReactionDialog((CHARACTER)_Player, NULL_00000000-0000-0000-0000-000000000000)
AND
NOT QRY_StartDialogCustom_Fixed(GLO_GithChokepoint_PartyReaction_5dd64d54-c8f3-96f3-07c6-c39d85ffa5c0,
	_Player,
	NULL_00000000-0000-0000-0000-000000000000,
	0,0,1,0)
THEN
PROC_PLA_LaezelRecruit_ReactionEnded();


//Generic companion
PROC
PROC_GLO_GithChokepoint_CompanionReactionDialog((CHARACTER)_Player,(CHARACTER)_Companion)
AND
_Companion != NULL_00000000-0000-0000-0000-000000000000
AND
_Companion != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
AND
NOT QRY_StartDialogCustom_Fixed(GLO_GithChokepoint_PartyReaction_5dd64d54-c8f3-96f3-07c6-c39d85ffa5c0,
	_Companion,
	_Player,
	0,0,1,0)
THEN
PROC_PLA_LaezelRecruit_ReactionEnded();


//Send event when it's done
IF
DialogEnded(GLO_GithChokepoint_PartyReaction_5dd64d54-c8f3-96f3-07c6-c39d85ffa5c0, _)
THEN
PROC_PLA_LaezelRecruit_ReactionEnded();

PROC
PROC_PLA_LaezelRecruit_ReactionEnded()
THEN
DB_NOOP(1);


//END_REGION
//REGION Companion reactions - starting dialog - Laezel

PROC
PROC_GLO_GithChokepoint_CompanionReactionDialog((CHARACTER)_Player,S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_StartDialogCustom_Fixed(PLA_PreGithChokepoint_WRD_Laezel_3c5e4463-ad9f-c79f-6167-7e0e4c4f45fa,S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,_Player, 0, 0, 0, 0)
THEN
DB_NOOP(1);

IF
DialogEnded(PLA_PreGithChokepoint_WRD_Laezel_3c5e4463-ad9f-c79f-6167-7e0e4c4f45fa,_)
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,_Avatar)
THEN
DB_GLO_PartyMembers_BlockReturnToRecruitmentPosition(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
DB_CompanionLeaving(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,_Avatar);
PROC_Origins_CompanionLeaveTemporarily((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "LaezelRanToKnight");
DB_PLA_GithChokepoint_LaezelIsWithKnight(_Avatar);
SetFlag(PLA_GithChokepoint_Event_LaezelLeftParty_7bdf419f-d3d5-48bb-a6ed-636afc48f50a, NULL_00000000-0000-0000-0000-000000000000);
PROC_TriggerRegisterForPlayers(S_PLA_ChokepointAbandonVBSphere_a7512987-5a65-47f7-a4f5-b2d58762fe0f);
TriggerRegisterForCharacter((TRIGGER)S_PLA_ChokepointLaezelADArea_b0ef4dd5-b22a-43cd-8129-ad52b532eba1, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
PROC_PLA_GithChokepoint_LaezelRunToKnight(_Avatar);

IF
EnteredTrigger((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(TRIGGER)S_PLA_ChokepointLaezelADArea_b0ef4dd5-b22a-43cd-8129-ad52b532eba1)
THEN
TriggerUnregisterForCharacter((TRIGGER)S_PLA_ChokepointLaezelADArea_b0ef4dd5-b22a-43cd-8129-ad52b532eba1, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
PROC_TryStartAD(PLA_GithChokepoint_AD_LaezelRunsToKnight_b461e25a-f0cb-909d-d0be-f196ba5e54fa, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
//END_REGION

//REGION Laezel: Crash version edge-case

//Handling edge-cases of edge-cases
QRY
QRY_CRA_LaezelRecruit_BlockCRAVersion() //CRA -> PLA
AND
NOT DB_GlobalFlag(PLA_GithChokepoint_State_SceneDone_2fa4006f-12e5-4666-931b-e31dee737f2f)
AND
IsInTrigger(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_LaezelChokepointProxSphere_62e2c26f-1019-4289-b377-ff36d02e5772, 1)
THEN
PROC_PLA_LaezelRecruit_MergeIntoPLAVersion();

IF
Resurrected(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12) //CHA -> PLA
AND
DB_GlobalFlag(ORI_LaezelRecruitment_State_ChapelVersionInitiated_e6015bdf-276e-47b2-9a43-9bc0c981e1ad)
AND
NOT DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_GlobalFlag(PLA_GithChokepoint_State_SceneDone_2fa4006f-12e5-4666-931b-e31dee737f2f)
AND
IsInTrigger(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_LaezelChokepointProxSphere_62e2c26f-1019-4289-b377-ff36d02e5772, 1)
THEN
PROC_PLA_LaezelRecruit_MergeIntoPLAVersion();

PROC
PROC_PLA_LaezelRecruit_MergeIntoPLAVersion()
AND
NOT DB_GlobalFlag(ORI_LaezelRecruitment_State_PlainsVersionInitiated_59bda4f5-708b-4f23-aaba-d5f387ae95c2)
THEN
PROC_CRA_LaezelRecruit_EndCrashVersion();
PROC_TriggerUnregisterForPlayers(S_PLA_UpdateLaezelRecruitBox_1a1deda3-7203-4e57-a017-7ccb1c6ed181);
PROC_GlobalSetFlagAndCache(ORI_LaezelRecruitment_State_PlainsVersionInitiated_59bda4f5-708b-4f23-aaba-d5f387ae95c2);
SetFlag(ORI_LaezelRecruitment_State_ResurrectedAtChokepoint_244e5e8c-849c-4a93-a129-4da54d32f779, NULL_00000000-0000-0000-0000-000000000000); //also set if she joins combat against the githyanki

IF
DB_InRegion(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660)
AND
NOT DB_Players(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Defeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
TriggerUnregisterForCharacter(S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
PROC_SceneInterrupted(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,NULL_00000000-0000-0000-0000-000000000000,"PLA_GithChokepoint","PLA_GithChokepoint_LaezelResurrected");

//END_REGION
//REGION Laezel: 2nd recruit

//--- Lae'zel failed to be re-added in the party
PROC
PROC_PLA_LaezelRecruit_ReAddFailed((CHARACTER)_Player)
THEN
SetFlag(PLA_GithChokepoint_State_LaezelFailedJoinFullParty_194dbfd6-8702-4c41-aa43-4ad438048401, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(ORI_LaezelRecruitment_State_PlainsVersionInitiated_59bda4f5-708b-4f23-aaba-d5f387ae95c2, NULL_00000000-0000-0000-0000-000000000000);
PROC_PLA_LaezelRecruit_SetSecondRecruitmentDialog();


//--- Entering the plains
//hoping that no player are near Lae'zel in CHA when another enters here. Should be rare to miss the second recruitment because of this
//it's to simplify the checks. 
IF
EnteredTrigger(_Player, S_PLA_UpdateLaezelRecruitBox_1a1deda3-7203-4e57-a017-7ccb1c6ed181) //it's registered only when LZ is a NPC starting on WLD_Main_A
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag(ORI_LaezelRecruitment_State_PlainsVersionInitiated_59bda4f5-708b-4f23-aaba-d5f387ae95c2)
AND
QRY_PLA_LaezelRecruit_TryResolvePreviousRecruitment()
THEN
PROC_PLA_LaezelRecruit_CheckPrepSecondRecruitment();

QRY
QRY_PLA_LaezelRecruit_TryResolvePreviousRecruitment()
AND
DB_GlobalFlag(ORI_LaezelRecruitment_State_CrashVersionInitiated_a80f2bd8-ffa1-4065-a92a-d01d59907637)
AND
DB_GlobalFlag(ORI_LaezelRecruitment_Event_CrashVersionDone_df73c46d-ed94-47de-be8b-36df1dbd973f)
THEN
DB_NOOP(1); //CRA is resolved -> pass (player must resolve it since it implies reviving Lae'zel)

QRY
QRY_PLA_LaezelRecruit_TryResolvePreviousRecruitment()
AND
DB_GlobalFlag(ORI_LaezelRecruitment_State_ChapelVersionInitiated_e6015bdf-276e-47b2-9a43-9bc0c981e1ad)
AND
DB_GlobalFlag(CHA_LaezelTieflings_State_SceneOver_b6fcc020-c718-45d3-964d-2099f95a70c1)
THEN
DB_NOOP(1); //CHA is already resolved -> pass

QRY
QRY_PLA_LaezelRecruit_TryResolvePreviousRecruitment()
AND
DB_GlobalFlag(ORI_LaezelRecruitment_State_ChapelVersionInitiated_e6015bdf-276e-47b2-9a43-9bc0c981e1ad)
AND
NOT DB_GlobalFlag(CHA_LaezelTieflings_State_SceneOver_b6fcc020-c718-45d3-964d-2099f95a70c1)
AND
NOT QRY_CHA_LaezelRecruit_PlayersRemaining()
THEN
PROC_CHA_LaezelRecruit_ResolveScene(); //CHA is not resolved, but it can be -> resolve and pass


// Initiate second recruit
PROC
PROC_PLA_LaezelRecruit_CheckPrepSecondRecruitment()
AND
NOT DB_IronFlasked(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_PartOfTheTeam(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
IsPlayer(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0)
AND
IsDead(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0)
AND
GetFlag(ORI_LaezelRecruitment_Event_InvitedToCamp_5ac352a5-58c2-a8ed-1957-199d8bc284da, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
PROC_TriggerUnregisterForPlayers(S_PLA_UpdateLaezelRecruitBox_1a1deda3-7203-4e57-a017-7ccb1c6ed181);
PROC_GlobalSetFlagAndCache(ORI_LaezelRecruitment_State_PlainsVersionInitiated_59bda4f5-708b-4f23-aaba-d5f387ae95c2);
PROC_PLA_LaezelRecruit_SetSecondRecruitmentDialog();
PROC_PLA_LaezelRecruit_PrepSecondRecruitment();
PROC_ORI_Laezel_GiveNewEquipment();

PROC
PROC_PLA_LaezelRecruit_SetSecondRecruitmentDialog()
THEN
PROC_GLO_Origins_SetRecruitmentDialog((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(DIALOGRESOURCE)Laezel_Recruitment_Plains_962cb218-6f76-a571-02c0-28070bd09fed);

PROC
PROC_PLA_LaezelRecruit_PrepSecondRecruitment()
THEN
TeleportTo(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_LaezelRunStartPoint_7e9f70e8-a0f4-4d31-a878-873f90ede4eb);
SetOnStage(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0);
SetLevel(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 4); //TODO: actually she could take the level of a player starting the Gith Chokepoint to not be higher level than the rest of the party
RemoveHarmfulStatuses(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
PROC_GlobalSetFlagAndCache(PLA_LaezelRecruitment_Event_NormalFlow_4c50a81b-38ac-4365-914e-64c19d3880b8);

PROC
PROC_PLA_LaezelRecruit_DragonSceneStarted()
AND
DB_GlobalFlag(PLA_LaezelRecruitment_Event_NormalFlow_4c50a81b-38ac-4365-914e-64c19d3880b8)
THEN
TeleportTo(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_LaezelRunStartPoint_7e9f70e8-a0f4-4d31-a878-873f90ede4eb);
SetOnStage(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1);

PROC
PROC_PLA_LaezelRecruit_ReactionEnded()
AND
DB_GlobalFlag(PLA_LaezelRecruitment_Event_NormalFlow_4c50a81b-38ac-4365-914e-64c19d3880b8)
THEN
TriggerRegisterForCharacter(S_PLA_LaezelRunningADBox_03ec992f-6384-42df-a1df-a08b100bbb9f, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
DB_PLA_GithChokepoint_RunningToKnight(1);
PROC_PLA_GithChokepoint_LaezelRunToKnight(NULL_00000000-0000-0000-0000-000000000000);


//--- AD while running
IF
EnteredTrigger(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_LaezelRunningADBox_03ec992f-6384-42df-a1df-a08b100bbb9f)
AND
DB_MovingTo(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,S_PLA_LaezelRecruitPoint_9f9daa3c-b446-4d03-a2a1-0a9383adccbe,_,_ID)
THEN
TriggerUnregisterForCharacter(S_PLA_LaezelRunningADBox_03ec992f-6384-42df-a1df-a08b100bbb9f, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
PROC_TryStartAD(PLA_GithChokepoint_AD_LaezelRunsToKnight_b461e25a-f0cb-909d-d0be-f196ba5e54fa, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

PROC
PROC_ClearStoryMove(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_PLA_GithChokepoint_RunningToKnight(1)
THEN
NOT DB_PLA_GithChokepoint_RunningToKnight(1);
TriggerUnregisterForCharacter(S_PLA_LaezelRunningADBox_03ec992f-6384-42df-a1df-a08b100bbb9f, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);


IF
EntityEvent(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "GLO_GithChokepoint_LaezelRanUpToKnight")
THEN
TriggerUnregisterForCharacter(S_PLA_LaezelRunningADBox_03ec992f-6384-42df-a1df-a08b100bbb9f, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);


//--- Confrontation
QRY
QRY_PLA_GithChokepoint_StartConfrontationLaezel((CHARACTER)_Player)
AND
QRY_PLA_LaezelRecruit_IsAtPlains()
AND
QRY_StartDialogCustom_Fixed(PLA_GithChokepoint_ConfrontationLaezel_dfb80d70-8cfe-1a55-bae7-826f164def60,
		S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,
		S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,
		_Player,
		S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,
		NULL_00000000-0000-0000-0000-000000000000,
		NULL_00000000-0000-0000-0000-000000000000,
		0,0,0,0)
THEN
PROC_PLA_LaezelRecruit_SetSecondRecruitmentDialog(); //normal she already has it; this will change Laezel_Recruitment_Crash


//--- Post confrontation
PROC
PROC_PLA_LaezelRecruit_CheckStartReaction()
THEN
ObjectTimerLaunch(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "PLA_LaezelRecruit_ChokepointReaction", 1500);

IF
ObjectTimerFinished(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "PLA_LaezelRecruit_ChokepointReaction")
AND
QRY_PLA_LaezelRecruit_IsAtPlains()
THEN
SetFlag((FLAG)ORI_Laezel_State_NPCLaezelAtGithChokepoint_52bc45fb-11c3-44fc-82be-679be13d3f81);
PROC_TryStartAD(PLA_GithChokepoint_AD_LaezelPostConfrontation_d48b01a4-30b8-fb22-84e2-5eee99e864df, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

QRY
QRY_PLA_LaezelRecruit_IsAtPlains()
AND
DB_GlobalFlag(ORI_LaezelRecruitment_State_PlainsVersionInitiated_59bda4f5-708b-4f23-aaba-d5f387ae95c2)
AND
NOT DB_Defeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
IsInTrigger(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_GithRaceCheckSphere_e92009dc-1d11-43ae-b15d-9afa61d21d35, 1)
THEN
DB_NOOP(1);


//--- Recruitment approval boost (when you let her do the talking)
IF
FlagSet(OriginAddToParty_4870b2cd-210c-0fdc-9c58-4d0142bdae29, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Inst)
AND
DB_DialogName(Laezel_Recruitment_Plains_962cb218-6f76-a571-02c0-28070bd09fed, _Inst)
AND
DB_DialogPlayers(_Inst, _Player, 1)
AND
GetFlag(PLA_GithChokepoint_State_LetLaezelSpeak_f0c1618b-fc4a-fe1c-75ab-1dffc21eee28, _Player, 1)
AND
ChangeApprovalRating((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (CHARACTER)_Player, 0, 5,_)
THEN
DB_NOOP(1);

//END_REGION
//REGION Laezel: with Knight

//--- Going to the gith
PROC
PROC_PLA_GithChokepoint_LaezelRunToKnight((CHARACTER)_) //also used in her 2nd recruit
THEN
DB_SceneManager(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "PLA_GithChokepoint");
SetFlag(PLA_GithChokepoint_Event_LaezelRunsToKnight_5f5d15e8-ecbb-4b3f-8ac8-da29ef763d92, NULL_00000000-0000-0000-0000-000000000000);
SetHasDialog(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0);
PROC_CharacterMoveTo(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_LaezelRecruitPoint_9f9daa3c-b446-4d03-a2a1-0a9383adccbe, "Run", "GLO_GithChokepoint_LaezelRanUpToKnight");
DB_CustomDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 20);
DB_CustomDialogRange(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 20);

IF
EntityEvent(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "GLO_GithChokepoint_LaezelRanUpToKnight")
THEN
SetFlag(PLA_GithChokepoint_State_TalkingToLaezel_12b26742-cb8e-48cb-8249-75c62902c75f, S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea); //allows him to start ADing

IF
Dying(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_PLA_GithChokepoint_LaezelIsWithKnight(_Avatar)
THEN
NOT DB_PLA_GithChokepoint_LaezelIsWithKnight(_Avatar);


//--- Commenting on abandoning Lae'zel behind
IF
LeftTrigger(_Player, S_PLA_ChokepointAbandonVBSphere_a7512987-5a65-47f7-a4f5-b2d58762fe0f)
AND
DB_Players(_Player)
AND
NOT DB_CantTalk(_Player)
AND
DB_PLA_GithChokepoint_LaezelIsWithKnight(_)
AND
QRY_OnlyOnce("PLA_GithChokepoint_AbandonLaezel")
AND
IsInTrigger(_Player, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb, 1)
THEN
PROC_TriggerUnregisterForPlayers(S_PLA_ChokepointAbandonVBSphere_a7512987-5a65-47f7-a4f5-b2d58762fe0f);
StartVoiceBark((VOICEBARKRESOURCE)PLA_GithChokepoint_VB_LeavingLaezelBehind_74b04ddb-cb89-4161-52ad-6808acadde62, _Player);


// Lae'zel re-added to party
PROC
PROC_GLO_GithChokepoint_CheckReAddLaezel()
THEN
PROC_CheckPartyFull();

PROC
PROC_GLO_GithChokepoint_CheckReAddLaezel()
AND
DB_PLA_GithChokepoint_LaezelIsWithKnight(_)
AND
QRY_PLA_GithChokepoint_GetLaezelBestAvatar()
AND
DB_PLA_GithChokepoint_LaezelIsWithKnight(_Avatar)
AND
GetFlag((FLAG)GEN_MaxPlayerCountReached_823b5064-8aa4-c0b7-1b8c-657b46987ccd, NULL_00000000-0000-0000-0000-000000000000, _FullParty) // flagType: Global
THEN
NOT DB_PLA_GithChokepoint_LaezelIsWithKnight(_Avatar);
PROC_GLO_GithChokepoint_ReAddLaezel((CHARACTER)_Avatar, _FullParty); //full party

PROC
PROC_GLO_GithChokepoint_ReAddLaezel((CHARACTER)_Player, 1) //FAIL
THEN
PROC_PLA_LaezelRecruit_ReAddFailed(_Player);

PROC
PROC_GLO_GithChokepoint_ReAddLaezel((CHARACTER)_Player, 0)
THEN
NOT DB_SceneManager(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "PLA_GithChokepoint");
PROC_GLO_PartyMembers_Add(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,_Player);
ClearTag(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);

QRY
QRY_PLA_GithChokepoint_GetLaezelBestAvatar()
AND
DB_PLA_GithChokepoint_LaezelIsWithKnight(_NotAvatar)
AND
NOT DB_Avatars(_NotAvatar)
THEN
NOT DB_PLA_GithChokepoint_LaezelIsWithKnight(_NotAvatar);

QRY
QRY_PLA_GithChokepoint_GetLaezelBestAvatar()
AND
DB_Avatars(_Avatar)
AND
NOT DB_PLA_GithChokepoint_LaezelIsWithKnight(_)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Avatar, S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
THEN
DB_PLA_GithChokepoint_LaezelIsWithKnight(_Avatar);

QRY
QRY_PLA_GithChokepoint_GetLaezelBestAvatar()
AND
DB_Avatars(_Avatar)
AND
NOT DB_PLA_GithChokepoint_LaezelIsWithKnight(_)
THEN
DB_PLA_GithChokepoint_LaezelIsWithKnight(_Avatar);

QRY
QRY_PLA_GithChokepoint_GetLaezelBestAvatar()
THEN
DB_NOOP(1);

//--- Lae'zel dies because trigger was exited
IF
LeftTrigger(_Player, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb)
AND
DB_Players(_Player)
AND
DB_GlobalFlag(GLO_GithChokepoint_DragonEventEnd_ded1de27-9668-418f-93f6-4b5a789b5640)
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_StartConfrontation")
AND
NOT QRY_CheckOtherPlayersInTrigger(NULL_00000000-0000-0000-0000-000000000000, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb)
AND
QRY_OnlyOnce("PLA_GithChokepoint_KillLaezel")
AND
NOT DB_Players(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
IsInTrigger(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb, 1)
THEN
DB_PLA_GithChokepoint_LaezelDiedAlone(1);
TeleportTo(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_LaezelRecruitPoint_9f9daa3c-b446-4d03-a2a1-0a9383adccbe); //in case she wasn't done running there yet
Die(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1);
PROC_GlobalSetFlagAndCache(PLA_GithChokepoint_State_LaezelDiedAlone_236d8e71-4727-4b88-9a2b-fcd558b2b8b3);
PROC_PLA_GithChokepoint_MakeDragonLeave(0);
TriggerRegisterForCharacter(S_PLA_GithChorpseSphere_84fce832-8d59-438f-a440-ab483c22d9e7, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
PROC_PLA_GithChokepoint_AddCorpse(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
PROC_GithChokepoint_Cancel("PLA");

IF
DB_Defeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_Sees(_Player, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_Players(_Player)
AND
DB_PLA_GithChokepoint_LaezelDiedAlone(1)
THEN
NOT DB_PLA_GithChokepoint_LaezelDiedAlone(1);
StartVoiceBark(PLA_GithChokepoint_VB_LaezelKilledByGith_5a1da769-d221-fe41-8fe9-4f8a516b4f0b, _Player);

IF
Resurrected(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_PLA_GithChokepoint_LaezelDiedAlone(1)
THEN
NOT DB_PLA_GithChokepoint_LaezelDiedAlone(1);

//END_REGION
//REGION Laezel: siding with Gith
//--- Lae'zel joining the gith after scene interruption
/*
- Before confrontation: Lae'zel NPC sides with githyanki
- During/after confrontation: Lae'zel NPC is neutral to players, hostile to githyanki
*/ 
PROC
PROC_PLA_GithChokepoint_CheckLaezelSide()
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_StartConfrontation")
AND
NOT DB_Players(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Defeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
IsInTrigger(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_PLA_GithRaceCheckSphere_e92009dc-1d11-43ae-b15d-9afa61d21d35, 1) //smaller trigger, very close to the other npcs
THEN
PROC_PLA_GithChokepoint_LaezelSidesWithGith();

PROC
PROC_PLA_GithChokepoint_LaezelSidesWithGith()
THEN
SetFlag(ORI_Laezel_State_HostileAtGithChokepoint_fc58ccc7-55ec-49b8-b8c0-d8d2c581c0be,NULL_00000000-0000-0000-0000-000000000000);
SetTag(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
DB_PLA_GithChokepoint_Gith(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,NULL_00000000-0000-0000-0000-000000000000);
DB_GLO_DefeatCounter(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "PLA_GithChokepoint_DefeatCounter");
QuestUpdate("ORI_COM_Laezel", "CompanionHostile");
DB_PLA_GithChokepoint_ReactToPlayerBetrayal(1);

IF
TurnStarted(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_PLA_GithChokepoint_ReactToPlayerBetrayal(1)
THEN
NOT DB_PLA_GithChokepoint_ReactToPlayerBetrayal(1);
PROC_PLA_GithChokepoint_CheckReactToPlayerBetrayal();

PROC
PROC_PLA_GithChokepoint_CheckReactToPlayerBetrayal()
AND
QRY_PLA_GithChokepoint_AnyPlayerSeesLaezel()
THEN
PROC_TryStartAD(PLA_GithChokepoint_AD_LaezelSidesWithGith_ff56a4b4-5cb1-7141-9cac-c697fafe8a6e, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

QRY
QRY_PLA_GithChokepoint_AnyPlayerSeesLaezel()
AND
DB_Players(_Player)
AND
DB_Sees(_Player, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_NOOP(1);

//END_REGION

//REGION Scene control / interruptions

PROC
PROC_SceneInterrupted((GUIDSTRING)_NPC,(CHARACTER)NULL_00000000-0000-0000-0000-000000000000,"PLA_GithChokepoint","LeftTrigger")
AND
DB_PLA_GithChokepoint_Gith((CHARACTER)_NPC,_)
THEN
PROC_PLA_GithChokepoint_MakeDragonLeave(0); //combat outcome

//--- Generic reasons
PROC
PROC_SceneInterrupted((GUIDSTRING)_,(CHARACTER)_Source,"PLA_GithChokepoint",(STRING)_Reason)
AND
DB_PLA_GithChokepoint_ValidInterruptions(_Reason)
AND
QRY_PLA_GithChokepoint_ValidSource(_Source)
AND
QRY_OnlyOnce("PLA_GithChokepoint_InterruptedScene") //cleared after the DragonEvent cutscene so the scene may be interrupted again
THEN
DB_PLA_GithChokepoint_Interrupted((CHARACTER)_Source);
PROC_PLA_GithChokepoint_InterruptScene();

QRY
QRY_PLA_GithChokepoint_ValidSource((CHARACTER)_Source)
AND
_Source != S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f
THEN
DB_NOOP(1);

//--- Custom reason
PROC
PROC_SceneInterrupted((GUIDSTRING)_,(CHARACTER)_Source,"PLA_GithChokepoint","PLA_GithChokepoint_ScoutPushedDown") //the scout was shoved below
AND
QRY_OnlyOnce("PLA_GithChokepoint_InterruptedScene")
THEN
DB_PLA_GithChokepoint_Interrupted((CHARACTER)_Source);
PROC_PLA_GithChokepoint_InterruptScene();

PROC
PROC_SceneInterrupted((GUIDSTRING)_,(CHARACTER)_Source,"PLA_GithChokepoint","PLA_GithChokepoint_LaezelResurrected") //LZ appears at the scene
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_StartDragonScene") //LZ was not meant to be there before DragonEvent, so her presence interrupts the scene and starts it
AND
QRY_OnlyOnce("PLA_GithChokepoint_InterruptedScene")
THEN
DB_PLA_GithChokepoint_Interrupted((CHARACTER)_Source);
PROC_PLA_GithChokepoint_InterruptScene();

//--- Interrupt
PROC
PROC_PLA_GithChokepoint_InterruptScene() //--- during/after the dragon scene
AND
DB_OnlyOnce("PLA_GithChokepoint_StartDragonScene")
THEN
NOT DB_CustomDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 20);
NOT DB_CustomDialogRange(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 20);
PROC_PLA_GithChokepoint_CheckLaezelSide();
PROC_PLA_GithChokepoint_MakeDragonLeave(0); //combat outcome
PROC_PLA_GithChokepoint_CancelConfrontation();

PROC
PROC_PLA_GithChokepoint_InterruptScene() //--- before
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_StartDragonScene")
AND
NOT QRY_PLA_GithChokepoint_ForceStartDragonScene() //worst edge-case, somehow there are no players to force start the cutscene with
THEN
PROC_PLA_GithChokepoint_StartDragonScene((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_PLA_GithChokepoint_ForceStartDragonScene()
AND
DB_PartyMembers(_Player)
AND
IsDead(_Player, 0)
AND
IsInTrigger(_Player, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb, 1)
THEN
PROC_PLA_GithChokepoint_CheckStartDragonScene((CHARACTER)_Player);


//END_REGION

//REGION Confrontation: start

//--- Scene interrupted
PROC
PROC_PLA_GithChokepoint_CancelConfrontation()
THEN
PROC_TriggerUnregisterForPlayers(S_PLA_ChokepointConfrontSceneBox_00cb3901-cdb0-4505-bffb-6b24390db71b);
PROC_TriggerUnregisterForPlayers(S_PLA_GithKnight_SneakBox_c43fdf39-8d20-403d-aca1-ac993f8fb8d4);
DB_OnlyOnce("PLA_GithChokepoint_StartConfrontation");


//--- Wildshape or summon wandering too close: interrupts the scene
IF
DB_InRegion(_Player, S_PLA_GithKnight_SneakBox_c43fdf39-8d20-403d-aca1-ac993f8fb8d4)
AND
DB_PartyMembers(_Player)
AND
DB_Is_WildShaped(_Player)
AND
DB_OnlyOnce("PLA_GithChokepoint_StartDragonScene")
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_StartConfrontation")
THEN
PROC_TriggerUnregisterForPlayers(S_PLA_GithKnight_SneakBox_c43fdf39-8d20-403d-aca1-ac993f8fb8d4);
PROC_SceneInterrupted(NULL_00000000-0000-0000-0000-000000000000,_Player,"PLA_GithChokepoint","Attacked");

IF
DB_InRegion(_Summon, S_PLA_GithKnight_SneakBox_c43fdf39-8d20-403d-aca1-ac993f8fb8d4)
AND
DB_PlayerSummons(_Summon)
AND
DB_OnlyOnce("PLA_GithChokepoint_StartDragonScene")
AND
NOT DB_OnlyOnce("PLA_GithChokepoint_StartConfrontation")
THEN
PROC_TriggerUnregisterForPlayers(S_PLA_GithKnight_SneakBox_c43fdf39-8d20-403d-aca1-ac993f8fb8d4);
PROC_SceneInterrupted(NULL_00000000-0000-0000-0000-000000000000,_Summon,"PLA_GithChokepoint","Attacked");


//--- Start confrontation
IF
DB_InRegion(_Player, S_PLA_ChokepointConfrontSceneBox_00cb3901-cdb0-4505-bffb-6b24390db71b)
AND
DB_Players(_Player)
AND
NOT DB_HiddenCharacters(_Player, _)
AND
NOT DB_Is_WildShaped(_Player)
AND
QRY_OnlyOnce("PLA_GithChokepoint_StartConfrontation")
THEN
SetFlag(PLA_GithChokepoint_Event_ConfrontationStarts_81a6ce09-a457-4eb8-aacc-676778a6d9e7, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(PLA_GithChokepoint_State_ConfrontationIsOngoing_9c3fc7db-3ac3-4b6d-b895-106601db5d4a, NULL_00000000-0000-0000-0000-000000000000);
//DB_PLA_GithChokepoint_AttemptingStart(_Player);
PROC_GLO_GithChokepoint_CheckReAddLaezel();
PROC_PLA_GithChokepoint_StartConfrontation((CHARACTER)_Player);

PROC
PROC_PLA_GithChokepoint_StartConfrontation((CHARACTER)_Player)
AND
NOT QRY_PLA_GithChokepoint_StartConfrontationLaezel((CHARACTER)_Player)
AND
NOT QRY_PLA_GithChokepoint_StartLaezelOM((CHARACTER)_Player)
AND
NOT QRY_StartDialogCustom_Fixed(DIALOGRESOURCEGUID_PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e,
		S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,
		S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,
		_Player, 0,0,0,0)
AND
NOT DB_OriginDialog(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94) 
AND
NOT DB_OriginDialog(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f) 
THEN
PROC_PLA_GithChokepoint_MakeDragonLeave(0);

QRY
QRY_PLA_GithChokepoint_StartLaezelOM((CHARACTER)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
AND
QRY_PLA_GithChokepoint_StartLaezelOM_TryOriginalAvatar()
THEN
DB_PLA_GithChokepoint_LaezelOMStarted(1);

QRY
QRY_PLA_GithChokepoint_StartLaezelOM((CHARACTER)_Player)
AND
NOT DB_PLA_GithChokepoint_LaezelOMStarted(1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
AND
QRY_PLA_GithChokepoint_StartLaezelOM_TryAnyOtherAvatar((CHARACTER)_Player)
THEN
DB_PLA_GithChokepoint_LaezelOMStarted(1);

//Prefer to play on the original avatar, even if another Avatar was the one to walk in and trigger the scene
QRY
QRY_PLA_GithChokepoint_StartLaezelOM_TryOriginalAvatar()
AND
QRY_GetBestAvatarForCompanion(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1, 1)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Avatar)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Avatar, S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
AND
QRY_StartDialogCustom_Fixed(DIALOGRESOURCEGUID_PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e,
		S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,
		S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,
		_Avatar, 0,0,0,0)
THEN
DB_PLA_GithChokepoint_LaezelOMStarted(1);

//Override OM system and play the COM on a different Avatar if one is available, when the original Avatar is not available
QRY
QRY_PLA_GithChokepoint_StartLaezelOM_TryAnyOtherAvatar((CHARACTER)_Player)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
AND
QRY_GetClosestAvailableCharacterTo(_Player, 0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar, _Player, _Dist, 1)
AND
_Dist <= 15.0 
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f,
		S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,
		S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,
		_ClosestAvatar,
		S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259, 0,0,0,0) 
THEN
DB_PLA_GithChokepoint_LaezelOMStarted(1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)_Dialog,(INTEGER)_Inst)
AND
DB_PLA_GithChokepoint_ExtraConfrontationSpeakers(_Dialog, _Speaker)
THEN
PROC_DialogAddSpeakingActor(_Inst, _Speaker);

IF
DialogStarted(_Dialog, _)
AND
DB_PLA_GithChokepoint_Confrontation(_Dialog, _)
THEN
DB_PLA_GithChokepoint_ActiveConfrontation(_Dialog);

PROC
PROC_StartDialog_AddExtraSpeakers(_Dialog, _Id)
AND
DB_PLA_GithChokepoint_Confrontation(_Dialog, _)
AND
DB_Players((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
GetDistanceTo(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, _Dist)
AND
_Dist <= 20.0
THEN
PROC_DialogAddSpeakingActor(_Id, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
DialogActorJoined(_ActiveConfrontation,_Inst,(CHARACTER)_Player, _) //adding other players _after_ the first one joined (bug if done on DialogStarted)
AND
DB_Players(_Player)
AND
DB_PLA_GithChokepoint_ActiveConfrontation(_ActiveConfrontation)
AND
NOT DB_PLA_GithChokepoint_OM(_ActiveConfrontation)
AND
NOT DB_PLA_GithChokepoint_AddOtherPlayers(_ActiveConfrontation)
THEN
DB_PLA_GithChokepoint_AddOtherPlayers(_ActiveConfrontation);
DB_AddCharactersInTriggerToDialog(_ActiveConfrontation, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb, 1, 1, 1);

IF
FlagSet((FLAG)GLO_GithChokepoint_Event_LaezelOMStarted_84283682-101d-1531-7aae-33aa56999a70,NULL_00000000-0000-0000-0000-000000000000,_Inst)
AND
DB_DialogName(_ConfrontationOM,_Inst)
AND
DB_PLA_GithChokepoint_ActiveConfrontation(_ConfrontationOM)
AND
NOT DB_PLA_GithChokepoint_AddOtherPlayers(_ConfrontationOM)
THEN
DB_PLA_GithChokepoint_AddOtherPlayers(_ConfrontationOM);
DB_AddCharactersInTriggerToDialog(_ConfrontationOM, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb, 1, 1, 1);

IF
DialogEnded(_Dialog, _)
AND
DB_PLA_GithChokepoint_AddOtherPlayers(_Dialog)
THEN
NOT DB_PLA_GithChokepoint_AddOtherPlayers(_Dialog);
PROC_AddCharactersInTriggerToDialog_Clear(_Dialog, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb);

//END_REGION
//REGION Confrontation: Laezel OM / Second recruit

// Avatar refused to let Lae'zel talk, so it branches to the default dialog
IF
DialogEnded(_ConfrontationDialog, _Inst)
AND
DB_PLA_GithChokepoint_Confrontation(_ConfrontationDialog, 1)
AND
GetFlag(PLA_GithChokepoint_Event_ContinueFromLaezel_1987005a-f786-30f9-662a-c5d83f92cd4d, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
PROC_PLA_GithChokepoint_ContinueFromLaezel(_ConfrontationDialog, _Inst);

PROC
PROC_PLA_GithChokepoint_ContinueFromLaezel((DIALOGRESOURCE)_ConfrontationDialog, (INTEGER)_)
THEN
NOT DB_PLA_GithChokepoint_ActiveConfrontation(_ConfrontationDialog); //must be cleared, otherwise hostility will start

PROC
PROC_PLA_GithChokepoint_ContinueFromLaezel((DIALOGRESOURCE)_, (INTEGER)_Inst)
AND
DB_DialogPlayers(_Inst,_Player, _) //player is in slot 2 in the COM and in slot 1 in ConfrontationLaezel (because she's a NPC in that one); both dialogues may have many players because of DB_AddCharactersInTriggerToDialog
AND
_Player != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
AND
QRY_OnlyOnce("PLA_GithChokepoint_ContinueFromLaezel")
AND
NOT QRY_StartDialog_Fixed(DIALOGRESOURCEGUID_PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e,
		S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,
		S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259,
		_Player)
THEN
PROC_PLA_GithChokepoint_MakeDragonLeave(0);

//END_REGION
//REGION Confrontation: Checking races

IF
DialogStarted(_ConfrontationDialog, _)
AND
DB_PLA_GithChokepoint_Confrontation(_ConfrontationDialog, _)
AND
_ConfrontationDialog != PLA_GithChokepoint_ConfrontationLaezel_dfb80d70-8cfe-1a55-bae7-826f164def60 //_ConfrontationLaezel doesn't use this flag - it should be set when/if the default _Confrontation starts after
THEN
PROC_PLA_GithChokepoint_CheckPresenceOfNonGith();

PROC
PROC_PLA_GithChokepoint_CheckPresenceOfNonGith()
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_PLA_GithRaceCheckSphere_e92009dc-1d11-43ae-b15d-9afa61d21d35)
AND
NOT DB_HiddenCharacters(_Player,_)
AND
NOT DB_Defeated(_Player)
AND
IsTagged(_Player, (TAG)GITHYANKI_677ffa76-2562-4217-873e-2253d4720ba4, 0)
THEN
SetFlag(PLA_GithChokepoint_State_NonGithInTow_dc0e7d2a-9000-432d-872a-ceab5bc055bc, NULL_00000000-0000-0000-0000-000000000000);
	//flag is checked on the second nodes of _Confrontation and leads to an easy peaceful resolution if not set. In the other dialogues, it's used to do a node variation to refer to Lae'zel's 'slaves'

//END_REGION

//REGION Knight & Dragon: leaves

PROC
PROC_PLA_GithChokepoint_MakeDragonLeave((INTEGER)_Outcome)
THEN
DB_PLA_GithChokepoint_Outcome(_Outcome);

PROC
PROC_PLA_GithChokepoint_MakeDragonLeave(_)
AND
NOT DB_PLA_GithChokepoint_Interrupted(_)
THEN
DB_AddCharactersInTriggerToDialog(PLA_GithChokepoint_CINE_RiderAndDragonLeave_3ad8ad7a-b3f0-7537-3303-507dc8c3dfc4, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb, 1, 1, 1);
PROC_PLA_GithChokepoint_CheckStartDragonLeaveCine();

PROC
PROC_PLA_GithChokepoint_MakeDragonLeave(_)
AND
DB_PLA_GithChokepoint_Interrupted(_)
THEN
PROC_PLA_GithChokepoint_VossAndDragonLeaveInGameplay();
PROC_GLO_GithChokepoint_Outcome(0);

PROC
PROC_PLA_GithChokepoint_CheckStartDragonLeaveCine()
AND
NOT QRY_PLA_GithChokepoint_StartWithPlayer()
AND
NOT QRY_PLA_GithChokepoint_StartWithoutPlayer()
THEN
PROC_PLA_GithChokepoint_DragonEvent_FinishDragonLeaving();

QRY
QRY_PLA_GithChokepoint_StartWithPlayer()
AND
DB_InRegion(_Player, S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb)
AND
QRY_SpeakerIsAvailable(_Player, 1, 1)
AND
QRY_StartDialogCustom(PLA_GithChokepoint_CINE_RiderAndDragonLeave_3ad8ad7a-b3f0-7537-3303-507dc8c3dfc4,
	S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,
	S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f,
	_Player, 0, 0, 0, 0)
THEN
DB_NOOP(1);

QRY
QRY_PLA_GithChokepoint_StartWithoutPlayer()
AND
QRY_CheckOtherPlayersInTrigger(NULL_00000000-0000-0000-0000-000000000000,S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb)
AND
QRY_StartDialogCustom(PLA_GithChokepoint_CINE_RiderAndDragonLeave_3ad8ad7a-b3f0-7537-3303-507dc8c3dfc4,
	S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,
	S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f,
	NULL_00000000-0000-0000-0000-000000000000, 0, 0, 0, 0)
THEN
DB_NOOP(1);

IF
DialogEnded(PLA_GithChokepoint_CINE_RiderAndDragonLeave_3ad8ad7a-b3f0-7537-3303-507dc8c3dfc4,_)
THEN
PROC_PLA_GithChokepoint_DragonEvent_FinishDragonLeaving();

PROC
PROC_PLA_GithChokepoint_VossAndDragonLeaveInGameplay()
THEN
SetCanJoinCombat((CHARACTER)S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 0);
SetDetached(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 1);
DB_PLA_GithChokepoint_DragonLeavingInGameplay(1);
PlayAnimation(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, CUST_TakeOff_01_5f3d7746-eb42-4599-849e-cdd8e6fecce6, "");
UseSpell(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, "Shout_GLO_Voss_TeleportOut", S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea);

IF
AnimationEvent(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, "AnimationSetOffStage", _)
AND
DB_PLA_GithChokepoint_DragonLeavingInGameplay(1)
THEN
NOT DB_PLA_GithChokepoint_DragonLeavingInGameplay(1);
PROC_PLA_GithChokepoint_DragonEvent_FinishDragonLeaving();

PROC
PROC_PLA_GithChokepoint_DragonEvent_FinishDragonLeaving()
AND
DB_PLA_GithChokepoint_Outcome(_Outcome)
THEN
NOT DB_CustomDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 20);
NOT DB_CustomDialogRange(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 20);
NOT DB_PLA_GithChokepoint_Outcome(_Outcome);
ClearFlag(PLA_GithChokepoint_State_ConfrontationIsOngoing_9c3fc7db-3ac3-4b6d-b895-106601db5d4a, NULL_00000000-0000-0000-0000-000000000000);
PurgeOsirisQueue(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f);
PurgeOsirisQueue(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea);
PROC_SetOnStage(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f,0);
PROC_SetOnStage(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,0);
PROC_PLA_GithChokepoint_MakeKnightAndDragonMortals();
SetCanJoinCombat((CHARACTER)S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 1);
SetDetached(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 0);
PROC_GLO_GithChokepoint_Outcome(_Outcome);

PROC
PROC_PLA_GithChokepoint_MakeKnightAndDragonMortals()
THEN
SetImmortal(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f,0);
SetImmortal(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,0);
PROC_SetInvulnerable(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f,0);
PROC_SetInvulnerable(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,0);

//END_REGION
//REGION Behaviour polish: adding player corpse

//--- Making gith search dead players
IF
DB_Dead(_Player)
AND
DB_InRegion(_Player, S_PLA_GithChorpseSphere_84fce832-8d59-438f-a440-ab483c22d9e7)
AND
NOT DB_PLA_GithChokepoint_PlayerCorpses(_Player)
THEN
DB_PLA_GithChokepoint_PlayerCorpses(_Player);
PROC_PLA_GithChokepoint_AddCorpse(_Player);

PROC
PROC_PLA_GithChokepoint_AddCorpse((CHARACTER)_Player)
AND
_Player != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
AND
NOT DB_Defeated(_Gith)
THEN
SetDualEntityEvent(_Gith,_Player,"PLA_GithChokepoint_AddCorpseToList");

//--- Removing invalid players
IF
DB_PLA_GithChokepoint_PlayerCorpses(_Player)
AND
NOT DB_Dead(_Player)
THEN
NOT DB_PLA_GithChokepoint_PlayerCorpses(_Player);
PROC_PLA_GithChokepoint_RemoveCorpse(_Player);

IF
DB_PLA_GithChokepoint_PlayerCorpses(_Player)
AND
NOT DB_InRegion(_Player, S_PLA_GithChorpseSphere_84fce832-8d59-438f-a440-ab483c22d9e7)
THEN
NOT DB_PLA_GithChokepoint_PlayerCorpses(_Player);
PROC_PLA_GithChokepoint_RemoveCorpse(_Player);

PROC
PROC_PLA_GithChokepoint_RemoveCorpse((CHARACTER)_Player)
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
THEN
SetDualEntityEvent(_Gith,_Player,"PLA_GithChokepoint_RemoveCorpseFromList");

//--- Stop this behaviour
PROC
PROC_PLA_GithChokepoint_StopLookingForCorpses()
THEN
PROC_TriggerUnregisterForPlayers(S_PLA_GithChorpseSphere_84fce832-8d59-438f-a440-ab483c22d9e7);
TriggerUnregisterForCharacter(S_PLA_GithChorpseSphere_84fce832-8d59-438f-a440-ab483c22d9e7, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

PROC
PROC_PLA_GithChokepoint_StopLookingForCorpses()
AND
DB_PLA_GithChokepoint_PlayerCorpses(_Player)
THEN
NOT DB_PLA_GithChokepoint_PlayerCorpses(_Player);
PROC_PLA_GithChokepoint_RemoveCorpse(_Player);

//END_REGION

//REGION Outcomes: combat/leaving

//--- End situation
IF
DialogEnded(_Dialog,_Inst)
AND
DB_PLA_GithChokepoint_ActiveConfrontation(_Dialog)
AND
GetFlag((FLAG)GLO_GithChokepoint_Quest_GithLeave_8b2f94b5-9373-36ab-edfe-419764fbb85a, NULL_00000000-0000-0000-0000-000000000000, _GithLeave) // flagType: Global
THEN
PROC_PLA_GithChokepoint_MakeDragonLeave(_GithLeave);
NOT DB_PLA_GithChokepoint_ActiveConfrontation(_Dialog);

//--- Gith are leaving:
PROC
PROC_GLO_GithChokepoint_Outcome(1)
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
THEN
PROC_DisappearOutOfSight(_Gith,"Sprint",0,"");

PROC
PROC_GLO_GithChokepoint_Outcome(1)
THEN
PROC_PLA_GithChokepoint_Ended_JournalHook();
PROC_PLA_LaezelRecruit_CheckStartReaction(); //npc
PROC_PLA_GithChokepoint_CheckStartWRD(); //companion
PROC_PLA_GithChokepoint_StopLookingForCorpses();
PROC_PLA_GithChokepoint_SetPeacefulResolutionXP();

PROC
PROC_PLA_GithChokepoint_SetPeacefulResolutionXP()
AND
DB_PLA_GithChokepoint_Gith(_Gith, _)
AND
NOT DB_PermaDefeated(_Gith)
THEN
PROC_PeacefulResolve(_Gith);

//--- Gith weren't persuaded to leave; default combat:
PROC
PROC_GLO_GithChokepoint_Outcome(0)
AND
QRY_OnlyOnce("PLA_GithChokepoint_FightStarted")
THEN
PROC_SetCanFight(S_GLO_GithRaider_001_6b265792-c6ce-4eb0-94cd-a12b7bbe590d, 1);
SetCanJoinCombat(S_GLO_GithRaider_001_6b265792-c6ce-4eb0-94cd-a12b7bbe590d, 1);
ClearOwnership(S_GLO_GithCrecheMap_480f350e-79ae-46f6-aee7-e7ab63d2a011);
PROC_PLA_GithChokepoint_PrepareLaezelBetrayalAD();
PROC_PLA_GithChokepoint_SetRaidersHostile();
PROC_PLA_GithChokepoint_SetScoutHostile();
PROC_PLA_GithChokepoint_SetCombatGroupsAndEnterCombat();

PROC
PROC_GLO_GithChokepoint_Outcome(_)
THEN
PROC_PLA_GithChokepoint_CleanUp();

//END_REGION
//REGION Combat starts

// Githyanki turn hostile
PROC
PROC_PLA_GithChokepoint_SetRaidersHostile()
AND
QRY_OnlyOnce("PLA_GithChokepoint_SetRaidersHostile")
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
AND
NOT DB_PermaDefeated(_Gith)
THEN
SetFaction(_Gith, (FACTION)ACT1_PLA_GithChokepointHostile_ae4c996b-5040-4c68-b682-0314e0334d35);

// The Gith become hostile regardless of distance and sight checks
PROC
PROC_PLA_GithChokepoint_SetCombatGroupsAndEnterCombat()
AND
DB_PLA_GithChokepoint_Interrupted(_InterruptionSource)
THEN
SetCombatGroupAndEnterCombat(_InterruptionSource, "fc52998f-783d-b3ab-e533-bc914db98c7a", S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259);

PROC
PROC_PLA_GithChokepoint_SetCombatGroupsAndEnterCombat()
AND
DB_PLA_GithChokepoint_Interrupted(_InterruptionSource)
AND
DB_PLA_GithChokepoint_Gith((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "TurnedHostileAtChokepoint");
PROC_SetRelationToPlayers((FACTION)Origin_Laezel_bee8449b-d682-93c8-e7da-9e4bad369476, 0);
SetCombatGroupAndEnterCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "fc52998f-783d-b3ab-e533-bc914db98c7a", S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259);

//Resetting the player combat group when they leave the combat
IF
LeftCombat(_Player, _)
AND
DB_PLA_GithChokepoint_Interrupted((CHARACTER)_Player)
AND
GetCombatGroupID(_Player, "fc52998f-783d-b3ab-e533-bc914db98c7a")
THEN
NOT DB_PLA_GithChokepoint_Interrupted(_Player);
SetCombatGroupID(_Player, "");

// Lae'zel does an AD (feedback that she's getting betrayed)
PROC
PROC_PLA_GithChokepoint_PrepareLaezelBetrayalAD()
AND
NOT DB_Players(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_PLA_GithChokepoint_Gith(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,_)
AND
NOT DB_Defeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_SceneManager(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "PLA_GithChokepoint")
THEN
DB_PLA_GithChokepoint_LZBetrayalAD(1);

IF
TurnStarted(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_PLA_GithChokepoint_LZBetrayalAD(1)
AND
QRY_PLA_GithChokepoint_InCombatAgainstGith((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
NOT DB_PLA_GithChokepoint_LZBetrayalAD(1);
PROC_TryStartAD(PLA_GithChokepoint_AD_LaezelBetrayed_45a44fb6-9630-ba25-c43e-921b5edb7ace, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

IF
TurnStarted(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_PLA_GithChokepoint_LZBetrayalAD(1)
AND
NOT QRY_PLA_GithChokepoint_InCombatAgainstGith((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
NOT DB_PLA_GithChokepoint_LZBetrayalAD(1);

QRY
QRY_PLA_GithChokepoint_InCombatAgainstGith((CHARACTER)_Char)
AND
DB_Is_InCombat(_Char, _Combat)
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
AND
DB_Is_InCombat(_Gith, _Combat)
AND
IsEnemy(_Char, _Gith, 1)
THEN
DB_NOOP(1);


//CRA Recruit edge-case: Checking if LZ took part in that combat (handles some edge-cases in dialog)
IF
EnteredCombat((CHARACTER)_Gith, _CombatGuid)
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
AND
NOT DB_PLA_GithChokepoint_Gith(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,_)
AND
DB_GlobalFlag(ORI_LaezelRecruitment_State_CrashVersionInitiated_a80f2bd8-ffa1-4065-a92a-d01d59907637)
AND
DB_GlobalFlag(ORI_LaezelRecruitment_Event_CrashVersionDone_df73c46d-ed94-47de-be8b-36df1dbd973f)
AND
NOT DB_GlobalFlag(ORI_LaezelRecruitment_State_ResurrectedAtChokepoint_244e5e8c-849c-4a93-a129-4da54d32f779)
THEN
DB_PLA_GithChokepoint_CombatGuid(_CombatGuid);

IF
DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _CombatGuid)
AND
DB_PLA_GithChokepoint_CombatGuid(_CombatGuid)
THEN
SetFlag(ORI_LaezelRecruitment_State_ResurrectedAtChokepoint_244e5e8c-849c-4a93-a129-4da54d32f779, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(ORI_LaezelRecruitment_State_ResurrectedAtChokepoint_244e5e8c-849c-4a93-a129-4da54d32f779, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_PLA_GithChokepoint_CombatGuid(_CombatGuid)
THEN
NOT DB_PLA_GithChokepoint_CombatGuid(_CombatGuid);

//END_REGION
//REGION Combat ends / Laezel OM/PAD post-fight

//--- Combat ends
PROC
PROC_GLO_DefeatCounter_AllDefeated("PLA_GithChokepoint_DefeatCounter")
THEN
NOT DB_PLA_GithChokepoint_LZBetrayalAD(1);
PROC_PLA_GithChokepoint_Ended_JournalHook();
PROC_PLA_GithChokepoint_CheckStartWRD(); // also when the gith leave
PROC_PLA_LaezelRecruit_CheckStartReaction(); //--- NPC Lae'zel
PROC_PLA_GithChokepoint_StopLookingForCorpses();

PROC
PROC_PLA_GithChokepoint_Ended_JournalHook()
THEN
DB_NOOP(1);


//--- Companion Lae'zel
//Moved Laezel WRD trigger to Act1_PLA_GithChokepoint_PostEA goal

//--- Avatar Lae'zel
PROC
PROC_GLO_DefeatCounter_AllDead("PLA_GithChokepoint_DefeatCounter") //PAD mentions corpses
AND
DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Defeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_PLA_GithChokepoint_CloseToGith(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_OnlyOnce("PLA_GithChokepoint_AvatarLaezelRespondsAfterCombat")
THEN
PROC_TryStartAD(PLA_GithChokepoint_PAD_LaezelPostFight_9b68f31d-f0ca-ff6f-9d85-a880f2ce3e27,S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);


//proximity check (checking corpses instead of a trigger, in case the fight moved
QRY
QRY_PLA_GithChokepoint_CloseToGith((CHARACTER)_Char)
AND
DB_PLA_GithChokepoint_Gith(_Gith,_)
AND
GetDistanceTo(_Char, S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259, _Dist)
AND
_Dist <= 30.0
THEN
DB_NOOP(1);

//END_REGION

//REGION Map removed from Baretha

//Lae'zel will avoid saying that you should loot the corpses if the map is potentially not on Baretha anymore
IF
RemovedFrom((ITEM)_Item,S_GLO_GithCaptain_27fa0802-fa38-4eea-9c03-496f2e022259)
AND
DB_GLO_GithMap(_Item)
THEN
SetFlag(PLA_GithChokepoint_State_MapRemovedFromBaretha_dadbfa61-e396-4372-a415-ea926969b4aa, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//TODO: getting to the gith creche cancels the gith chokepoint

//REGION Cancelled 
PROC
PROC_GithChokepoint_Cancel("PLA")
THEN
PROC_PLA_GithChokepoint_MakeKnightAndDragonMortals();

//END_REGION

//REGION Scene ends / clean up
PROC
PROC_PLA_GithChokepoint_CleanUp()
THEN
PROC_SceneOver("PLA_GithChokepoint");
PROC_PLA_GithChokepoint_CancelConfrontation();
SetFlag(PLA_GithChokepoint_State_SceneDone_2fa4006f-12e5-4666-931b-e31dee737f2f, NULL_00000000-0000-0000-0000-000000000000);
TriggerUnregisterForCharacter(S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
PROC_TriggerUnregisterForPlayers(S_PLA_DragonShadow_Box_38005c53-9dd1-4f79-8581-0a4f30370baf);

//END_REGION

//REGION Journal

//For others quests.
PROC
PROC_PLA_GithChokepoint_Ended_JournalHook()
THEN
DB_NOOP(1);

//END_REGION

IF
LevelLoaded("SCL_Main_A")
AND
DB_OnlyOnce("PLA_GithChokepoint_StartDragonScene")
THEN
PROC_GithChokepoint_Cancel("PLA");
GoalCompleted;

//REGION Banter
IF
DB_GlobalFlag((FLAG)GLO_GithChokepoint_DragonEventEnd_ded1de27-9668-418f-93f6-4b5a789b5640)
AND
DB_GlobalFlag((FLAG)PLA_GithChokepoint_State_SceneDone_2fa4006f-12e5-4666-931b-e31dee737f2f)
AND
NOT DB_GithChokepoint_SafeForBanter(1)
THEN
DB_GithChokepoint_SafeForBanter(1);

PROC
PROC_LongRest()
AND
DB_GithChokepoint_SafeForBanter(1)
THEN
PROC_RegisterWorldGossipTrigger((TRIGGER)S_PartyBanterTrigger_PLA_GithResolved_3264c97b-d523-43dc-bc3b-0fb4b5fd2b0f);
//END_REGION
//REGION CampNight


//PLA_GithChokepoint_State_MonitorIntroRequirementMet is also set in the dialog Laezel_Recruitment_Plains when Lae'zel is recruited or invited to camp

//Companion version
IF
FlagSet(PLA_GithChokepoint_State_SceneDone_2fa4006f-12e5-4666-931b-e31dee737f2f, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_QuestIsAccepted("ORI_COM_Laezel")
AND
NOT DB_GlobalFlag(PLA_GithChokepoint_State_LaezelDiedAlone_236d8e71-4727-4b88-9a2b-fcd558b2b8b3)
THEN
SetFlag(PLA_GithChokepoint_State_MonitorIntroRequirementMet_4d226b35-cc1b-4750-a06b-30f231b0633c,NULL_00000000-0000-0000-0000-000000000000);

IF
DialogStarted(Laezel_Recruitment_Plains_962cb218-6f76-a571-02c0-28070bd09fed, _)
AND
DB_QuestIsAccepted("ORI_COM_Laezel")
AND
DB_GlobalFlag(PLA_GithChokepoint_State_LaezelDiedAlone_236d8e71-4727-4b88-9a2b-fcd558b2b8b3)
THEN
SetFlag(PLA_GithChokepoint_State_MonitorIntroRequirementMet_4d226b35-cc1b-4750-a06b-30f231b0633c,NULL_00000000-0000-0000-0000-000000000000);
//END_REGION
//REGION Clickable Booster
PROC
PROC_PLA_GithChokepoint_KillFodderAndBridge()
THEN
SetOnStage(S_PLA_ChokepointShield_2614ee9a-b62a-4bac-942c-526227c12690,1);

IF
AddedTo(S_PLA_ChokepointShield_2614ee9a-b62a-4bac-942c-526227c12690,_Char, _)
AND
DB_Players((CHARACTER)_Char)
AND
QRY_OnlyOnce("PLA_ChokepointShield")
THEN
StartVoiceBark(PLA_GithChokepoint_VB_Shield_f05ec898-8c68-7e54-0a91-5a41ad2e9ca3,_Char);

IF
MovedBy(S_PLA_ChokepointShield_2614ee9a-b62a-4bac-942c-526227c12690,_Char)
AND
DB_Players(_Char)
AND
QRY_OnlyOnce("PLA_ChokepointShield")
THEN
StartVoiceBark(PLA_GithChokepoint_VB_Shield_f05ec898-8c68-7e54-0a91-5a41ad2e9ca3,_Char);
//END_REGION

//REGION Orpheus Moments (Act 1) RD after dialog with Voss
IF
DialogEnded(_Dialog, _ID)
AND
DB_PLA_Orpheus_GithChokepoint_Confrontation(_Dialog)
THEN
PROC_PLA_Orpheus_GithChokepoint_TryDefineRD(_ID);

IF
DialogEnded(PLA_GithChokepoint_CINE_RiderAndDragonLeave_3ad8ad7a-b3f0-7537-3303-507dc8c3dfc4,_ID)
THEN
PROC_PLA_Orpheus_GithChokepoint_TryDefineRD(_ID);

PROC
PROC_PLA_Orpheus_GithChokepoint_TryDefineRD((INTEGER)_ID)
AND
DB_GlobalFlag((FLAG)PLA_GithChokepoint_Event_MentionedWeapon_569656de-2acb-6d5d-236c-c86df165e9b6)
AND
DB_DialogPlayers(_ID,_Player, _)
AND
DB_Avatars((CHARACTER)_Player)
THEN
PROC_PLA_Orpheus_GithChokepoint_StartRDTimer(_Player);

PROC
PROC_PLA_Orpheus_GithChokepoint_StartRDTimer((CHARACTER)_Player)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_SameUser(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,_Player)
AND
NOT DB_PLA_Orpheus_GithChokepoint_TimerLaunched(1)
THEN
DB_PLA_Orpheus_GithChokepoint_TimerLaunched(1);
ObjectTimerLaunch(_Player,"PLA_Orpheus_RD_GithChokepoint_Timer",5000);

PROC
PROC_PLA_Orpheus_GithChokepoint_StartRDTimer((CHARACTER)_Player)
AND
NOT DB_PLA_Orpheus_GithChokepoint_TimerLaunched(1)
THEN
DB_PLA_Orpheus_GithChokepoint_TimerLaunched(1);
ObjectTimerLaunch(_Player,"PLA_Orpheus_RD_GithChokepoint_Timer",1500);
//END_REGION

//REGION Cancelling the chokepoint
PROC
PROC_LevelLoadedOnce("INT_Main_A")
AND
NOT DB_GlobalFlag(PLA_GithChokepoint_State_Cancelled_125f66fd-d046-4daa-ac1c-eb4fc29cfb1c)
THEN
SetFlag(PLA_GithChokepoint_State_Cancelled_125f66fd-d046-4daa-ac1c-eb4fc29cfb1c);

IF
LeftLevel(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, "WLD_Main_A")
AND
QRY_OnlyOnce("PROC_PLA_GithChokepoint_Cancel")
THEN
PROC_PLA_GithChokepoint_Cancel();

IF
DB_GlobalFlag(PLA_GithChokepoint_State_Cancelled_125f66fd-d046-4daa-ac1c-eb4fc29cfb1c)
AND
QRY_OnlyOnce("PROC_PLA_GithChokepoint_Cancel")
THEN
PROC_PLA_GithChokepoint_Cancel();

PROC
PROC_PLA_GithChokepoint_Cancel()
THEN
NOT DB_CustomDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 20);
NOT DB_CustomDialogRange(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 20);
PROC_TriggerUnregisterForPlayers(S_PLA_DragonShadow_Box_38005c53-9dd1-4f79-8581-0a4f30370baf);
PROC_TriggerUnregisterForPlayers(S_PLA_GithRaceCheckSphere_e92009dc-1d11-43ae-b15d-9afa61d21d35);
PROC_TriggerUnregisterForPlayers(S_PLA_ChokepointControlSphere_ca3e6cb3-bd1e-456f-8e12-4b75be7f3fdb);
PROC_TriggerUnregisterForPlayers(S_PLA_GithEventPoly_4f1d2ca3-8ebe-4ebd-a4e5-8e92944ff1d1);
PROC_TriggerUnregisterForPlayers(S_PLA_GithChorpseSphere_84fce832-8d59-438f-a440-ab483c22d9e7);
PROC_TriggerUnregisterForPlayers(S_PLA_GithKnight_SneakBox_c43fdf39-8d20-403d-aca1-ac993f8fb8d4);
PROC_TriggerUnregisterForPlayers(S_PLA_NPCInterruptionBox_198849d7-7f06-4520-a9e6-1ddedfe38660);
PROC_TriggerUnregisterForPlayers(S_PLA_GithChokepoint_OngoingSceneArea_6f67dee0-2720-4617-a263-68a58da5681c);

PROC
PROC_PLA_GithChokepoint_Cancel()
THEN
PROC_SceneOver("PLA_GithChokepoint");
DB_PLA_GithChokepoint_Cancelled(1);

IF
DB_PLA_GithChokepoint_Cancelled(1)
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_PLA_GithChokepoint_Gith(_Gith, _)
THEN
SetOnStage(_Gith, 0);

IF
DB_PLA_GithChokepoint_Cancelled(1)
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_PLA_GithChokepoint_Fodder(_Fodder, _, _)
THEN
SetOnStage(_Fodder, 0);

IF
DB_PLA_GithChokepoint_Cancelled(1)
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_GlobalFlag((FLAG)GLO_GithCreche_State_EverEnteredBefore_3ebdfeaa-4e83-4878-90db-01adb9fdf629) //Checking this because once the Creche is entered, she is teleported and found dead in the Creche with a SwD dialog
THEN
PROC_SetOnStage(S_GLO_ChokepointScout_627e03ed-d23c-42fa-90c8-1e8d6f927fd6, 0);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
