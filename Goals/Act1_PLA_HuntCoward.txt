Version 1
SubGoalCombiner SGC_AND
INITSECTION
PROC_SetOnStage(ITEMGUID_S_PLA_ZhentDungeon_LiftDown_Whole_854202a8-d00d-4473-bbf4-d24a35dc846e, 0);

DB_PLA_ZhentDungeon_Portal(ITEMGUID_S_PLA_ZhentDungeon_LiftDown_2e18ea36-cf07-49df-a3f6-f98ec020e4af);
DB_PLA_ZhentDungeon_Portal(ITEMGUID_S_UND_Elevator_ToCaravanserai_b0bafa5b-ca00-4c94-af1c-12ced8562b4e);

TriggerRegisterForItems(S_PLA_EscapingZhentarim_BarrelTrigger_48b62ce9-35d9-48cc-9f15-348c8cff225e);
PROC_TriggerRegisterForPlayers(S_PLA_EscapingZhentarim_BarrelTrigger_48b62ce9-35d9-48cc-9f15-348c8cff225e);

SetVisible(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 0);

DB_KnowledgeCheckTrigger_AD("PLA_EscapingZhentarim_PerceptionBox", S_PLA_EscapingZhentarim_PerceptionBox_0498ebfc-7582-4971-802c-e870cb53e9e5, "Perception", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)PLA_EscapingZhentarim_AD_PerceptionSucceeded_bc683438-a647-eb61-6293-cc92095e4802, PLA_EscapingZhentarim_Event_Spotted_e0f0653a-1db3-36c9-012b-da237f709fd1);

PROC_SetOnStage(S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6, 0);

//REGION Spotting by the Zhent at the entrance.

DB_SpotPlayers(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeSummons(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance");
DB_SpotPlayers_IncludeFollowers(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance");
DB_SpotPlayers_IncludeWildshapedPlayers(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance");
DB_SpotPlayers_SpotTrigger(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance", (TRIGGER)S_PLA_EscapingZhentarim_Trigger_43876afe-b9b0-4afd-8e29-7cb5ca34fbc3);

DB_SpotPlayers(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeSummons(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach");
DB_SpotPlayers_IncludeFollowers(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach");
DB_SpotPlayers_IncludeWildshapedPlayers(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach");
DB_SpotPlayers_SpotterIgnoreCantTalk(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach");
DB_SpotPlayers_SpotTrigger(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach", (TRIGGER)S_PLA_EscapingZhent_NearBreach_d41a4a60-6679-46d8-948f-051c17d3ed2a);

DB_SpotPlayers(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeSummons(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind");
DB_SpotPlayers_IncludeFollowers(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind");
DB_SpotPlayers_IncludeWildshapedPlayers(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind");
DB_SpotPlayers_SpotterIgnoreCantTalk(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind");
DB_SpotPlayers_SpotTrigger(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind", (TRIGGER)S_PLA_EscapingZhent_Trespass1_26250927-48e9-4338-b406-ca286370fe62);

//END_REGION

DB_Dialogs(S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077, PLA_ZhentDungeon_Zhent06_96d82683-6bf9-5f63-0ddb-6963dfa25151);
DB_Dialogs(S_PLA_ZhentDungeon_Zhent07_32f7a4dc-d7a8-4e89-875c-3f3722879fbb, PLA_ZhentDungeon_Zhent07_9416be6c-800c-1fa0-973d-8c015c7b8a61);
DB_Dialogs(S_PLA_ZhentDungeon_Zhent08_3f629653-f427-43f9-92ac-89324de5ec11, PLA_ZhentDungeon_Zhent08_e805cd55-8436-c162-193e-14932b382ff3);
DB_Dialogs(S_PLA_ZhentDungeon_Dog_03_980c9203-0287-42fc-97d2-19f7b08620dc, PLA_ZhentDungeon_Dog_03_f1627d7a-a79f-62f5-faae-132d9d762c22);
DB_Dialogs(S_PLA_ZhentDungeon_Dog_02_b91c4f2c-89b1-4319-933a-a47db2bc6f12, PLA_ZhentDungeon_Dog_02_83338dd3-70bc-ad16-8323-24c5538f1b91);
DB_Dialogs(S_PLA_ZhentDungeon_Dog_01_53bf6aa7-9750-4650-87d7-4aa2107b3e2f, PLA_ZhentDungeon_Dog_01_32216fb9-ceb7-2e9f-7939-ec81c24ef722);


PROC_TriggerRegisterForPlayers(TRIGGERGUID_S_PLA_Cellar_37d69b60-1487-4b4f-8035-a36e55778293);
PROC_TriggerRegisterForParty(TRIGGERGUID_S_PLA_ZhentDungeon_053719f0-c4bf-487b-a0f4-44b11e7153c8);

DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_001_9823247f-56c4-4d87-a038-57327b4bd902);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_026_021554a8-5a7a-401d-bc0c-317e80b0645e);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_015_17608495-7c30-4668-a46e-8bf09793109e);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_001_412c2d7c-28ac-49dc-ba27-7d28614b0e3e);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_011_4627ab5c-b1c0-4992-a396-a1b0949bfccb);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_014_4aab5623-41c5-484d-b4a5-2803460a6950);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_005_516ebbe0-0b5b-4acb-87b9-f50918303636);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_017_5443d888-83e7-4c80-8d6e-1bc4f353193a);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_012_5b6cd7c4-1014-491c-bab3-2e9afd468f12);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_028_62e59d3f-f944-4c55-b745-eb8e56f8eb43);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_023_64350bfe-9539-4f3b-9cac-cecad61579be);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_022_6fcd19b7-9e01-488a-adbb-93fded8f5630);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_031_6ff9d988-b4c6-4269-ae58-f42e8aaddcf6);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_007_7bc05a00-1411-47dd-b0a5-5b7b8a62458c);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_013_7eef86ef-c010-4d88-ace9-c61739131cf9);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_003_80ebcd0d-5d2b-4ca3-a85f-f8f9f6e0a887);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_024_85dd6c72-3fcd-48bc-9a25-6b25f1203165);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_006_929d4c24-bda9-4f26-b82c-7729a5250876);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_008_9a376129-dbb0-479e-90b3-157f02120eba);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_019_a864d440-1b02-45f7-89fc-6947f710431a);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_010_b174be06-a5d5-4f8d-8164-acccea1bfc0c);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_020_b496f50a-4e49-45f3-80cf-ebdfebe23b60);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_018_b6193e73-9a8d-487e-91b5-a7ca043341a4);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_021_b96f1f0f-548e-47a4-aa69-4b07737e2505);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_027_befcffa8-2405-473d-95c0-ea9277106c16);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_004_c03ceff0-f513-4db9-9490-2e1e91c88c76);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_016_c3d2051f-a8b9-4b83-b6a4-e609bf022ff6);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_009_c50ac3fa-1c05-4644-b341-72bf3313095d);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_030_ce01f6cc-0a94-4686-ab97-e54ee8528a67);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_002_e71ed55f-bdb6-41db-8aee-c78dcc75c88b);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_029_ed8ec6a8-22e3-4bbe-9a5c-adb460b7e651);
DB_PLA_ZhentDungeon_Fuses(S_PLA_ZhentDungeon_Fuse_025_f53f766e-d109-41a8-a4f6-e685156f25e8);

DB_PLA_ZhentDungeon_Traps_Chains((ITEM)S_PLA_ZhentDungeon_Traps_Chain1_4759e64e-db93-43c3-b257-dfd75e136acb, (TRIGGER)S_PLA_ZhentDungeon_Traps_Chain1_0_7323ee8b-1df3-440a-90da-143a53d393ba, (TRIGGER)S_PLA_ZhentDungeon_Traps_Chain1_1_dfe46970-c30a-4210-a221-07c9f02df9f2);//Some aesthetic chains that visually indicate what the lever does.
DB_PLA_ZhentDungeon_Traps_Chains((ITEM)S_PLA_ZhentDungeon_Traps_Chain2_c679543a-e18f-4c27-a39e-6622e5b9faa4, (TRIGGER)S_PLA_ZhentDungeon_Traps_Chain2_0_a2ddc960-b0b8-4bd3-8045-655304c183ce, (TRIGGER)S_PLA_ZhentDungeon_Traps_Chain2_1_0ebed115-b530-4d2b-955e-7a8eafb53762);

PROC_TriggerRegisterForPlayers(S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67);
PROC_TriggerRegisterForPlayers(S_PLA_ZhentDungeon_Dialog2Start_c063d535-3f1f-4254-ab28-2375878111aa);
PROC_TriggerRegisterForPlayers(S_PLA_ZhentDungeon_Dialog3Start_9139856f-204b-4728-bea0-62fac03faad6);

DB_PLA_ZhentDungeon_SpotEvents("PLA_Zhent02_Spotted_02", (DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196);
DB_PLA_ZhentDungeon_SpotEvents("PLA_Zhent02_Spotted_Trap", PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968);

DB_Dialogs(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b);

DB_AddCharactersInTriggerToDialog(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, TRIGGERGUID_S_PLA_EscapingZhentarim_Trigger_43876afe-b9b0-4afd-8e29-7cb5ca34fbc3, 1);

PROC_TriggerRegisterForPlayers(S_PLA_EscapingZhentarim_Trigger_43876afe-b9b0-4afd-8e29-7cb5ca34fbc3);

//DB_GLO_DefeatCounter(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_DefeatCounter");
DB_GLO_DefeatCounter(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon_DefeatCounter");
DB_GLO_DefeatCounter(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, "PLA_ZhentDungeon_DefeatCounter");
DB_GLO_DefeatCounter(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, "PLA_ZhentDungeon_DefeatCounter");
DB_GLO_DefeatCounter(S_PLA_ZhentDungeon_Zhent05_356c9a7d-1f9d-4a51-8d9b-6908f16f7b7d, "PLA_ZhentDungeon_DefeatCounter");
SetCanTrade(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 0);
SetCanTrade(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, 0);
SetCanTrade(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, 0);
SetCanTrade(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, 0);
SetCanTrade(S_PLA_ZhentDungeon_Zhent05_356c9a7d-1f9d-4a51-8d9b-6908f16f7b7d, 0);

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("PLA_ZhentDungeon_DefeatCounter",(FLAG)PLA_ZhentDungeon_State_AllPermaDefeated_4dcee939-9346-ebb7-d328-1342e3e1d326);
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("PLA_ZhentDungeon_DefeatCounter",(FLAG)PLA_ZhentDungeon_State_AllDefeated_a870d184-006a-d1f5-9eb5-29b31cb0f30f);
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("PLA_ZhentDungeon_FF",(FLAG)PLA_ZhentDungeon_FF_State_AllPermaDefeated_ff177da0-eedd-4627-abaf-166a56e2443e);
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("PLA_ZhentDungeon_FF",(FLAG)PLA_ZhentDungeon_FF_State_AllDefeated_5cfeb5fc-1c58-47c2-b64c-d2f1c21dc5fe);

DB_OneShot_VoiceBarkTrigger(TRIGGERGUID_S_PLA_ZhentDungeon_VB_Entrance_3ba8de7d-947e-4c98-a3ab-5132ee76513f, VOICEBARKRESOURCEGUID_PLA_ZhentDungeon_VB_Entrance_130b5dc4-ea82-182f-e0b0-df5f547d0c0c);

DB_Inclusion_Object(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4,(FLAG)PLA_ZhentShipment_Agent_001_StartInclusion_9eed3b8d-4733-19c7-a68e-1cc08f5f3784,(FLAG)PLA_ZhentShipment_Agent_001_EndInclusion_8a1b0535-8ed4-4221-8124-c01de297b964);
DB_Inclusion_Object(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176,(FLAG)PLA_ZhentDungeon_Zhent04_StartInclusion_6a0c824f-3805-411b-9eb0-fb7696172728,(FLAG)PLA_ZhentDungeon_Zhent04_EndInclusion_0b1237ca-814c-4b19-b8d3-8c815b73663f);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12,S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12,S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176);

DB_DeadOnceFlag(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, PLA_ZhentShipment_Agent_001_State_Dead_f887843a-cbab-4c5c-8e96-4e95d304fc83);

//REGION AD manager
DB_GLO_ADManager_Category("PLA_ZhentDungeon",(FLAG)PLA_ZhentDungeon_State_BlockAD_f2d6834a-a9ef-4328-9ed1-a1cb84226d8c, 2000, 2000);

DB_GLO_ADManager_Category("PLA_ZhentDungeon_Back",(FLAG)PLA_ZhentDungeon_State_BlockAD_Back_f2d6834a-a9ef-4328-9ed1-a1cb84226d8c, 2000, 2000);

DB_GLO_ADManager_AD("PLA_ZhentDungeon", DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent01_AD_Idle_da02f66b-5c0d-fb8e-2f2a-7be53c470e0b,(FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent01_cba5e872-9938-4f1b-8c48-e81fa1416c23);
DB_GLO_ADManager_AD("PLA_ZhentDungeon", DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_AD_Idle_6a10711b-d27d-50a2-44bc-682f8b0c81cb,(FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent02_9579d2d4-819d-4449-9931-3c15ca3d498c);
DB_GLO_ADManager_AD("PLA_ZhentDungeon", DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent03_AD_Idle_32107905-bfee-fbf6-6fae-66650b8b8e51,(FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent03_c080dcab-107d-4efc-967f-c58d0e248ec9);
DB_GLO_ADManager_AD("PLA_ZhentDungeon", PLA_ZhentDungeon_Zhent03_AD_Zhent04_e7a1d28c-b7ae-9b04-9d70-1fb274587647,(FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent03_c080dcab-107d-4efc-967f-c58d0e248ec9);
DB_GLO_ADManager_AD("PLA_ZhentDungeon", PLA_ZhentDungeon_Zhent03_AD_ArtCritics_6a949731-cd0a-a5f7-8282-697902eb902e,(FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent03_c080dcab-107d-4efc-967f-c58d0e248ec9);
DB_GLO_ADManager_AD("PLA_ZhentDungeon", DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent04_AD_Idle_6f02166c-5fbd-e1f3-4193-e532c9f135b6,(FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent04_c3f602b4-1542-4427-a020-a0147c3ce8c5);
DB_GLO_ADManager_AD("PLA_ZhentDungeon", DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent05_AD_Idle_0a05e8c2-fc6f-dcaa-657f-61141bfae6cb,(FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent05_d98ca482-f19c-4c26-ae9d-4ca58df16df2);
DB_GLO_ADManager_AD("PLA_ZhentDungeon", DIALOGRESOURCEGUID_PLA_ZhentDungeon_AD_ZhentShipmentAgents_67d1553c-a673-c4c0-6979-c129c813ed95,(FLAG)PLA_ZhentDungeon_State_BlockAD_Agents_5eb196ec-4ed0-4aa4-83ed-1d86cfdcd03c);
DB_GLO_ADManager_AD("PLA_ZhentDungeon", PLA_ZhentDungeon_AD_ZhentShipmentAgents_OllyDead_cf2112f6-6e61-ad9d-ae7e-ba561e2cb03c, (FLAG)PLA_ZhentDungeon_State_BlockAD_Agents_5eb196ec-4ed0-4aa4-83ed-1d86cfdcd03c);
DB_GLO_ADManager_AD("PLA_ZhentDungeon", (DIALOGRESOURCE)PLA_ZhentDungeon_DoubtingArtist_AD_Idle_0db3c73d-7128-5dc0-bc35-76bd7d8d0f41,(FLAG)PLA_ZhentDungeon_State_BlockAD_DoubtingArtist_3453fab1-8b6c-46b6-86c9-a1de22b054d6);

DB_GLO_ADManager_AD("PLA_ZhentDungeon_Back", PLA_ZhentDungeon_Zhent06_AD_8b4d52e6-dfce-693e-6521-abdac761a559, (FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent06_b2533761-ad35-4193-b0b1-e5cd1e9f484d);
DB_GLO_ADManager_AD("PLA_ZhentDungeon_Back", PLA_ZhentDungeon_Zhent07_AD_daa60cf6-4fb5-9763-7163-a5fd910f1796, (FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent07_158a3e16-d0a8-43ba-96dd-41c68a6cfc63);
DB_GLO_ADManager_AD("PLA_ZhentDungeon_Back", PLA_ZhentDungeon_Zhent08_AD_dc9176d7-8e33-d527-eec2-f4e63d4ddf32, (FLAG)PLA_ZhentDungeon_State_BlockAD_Zhent08_24891eed-5c69-42ad-9a82-f83a446c9e07);

//END_REGION

//REGION Spotting of characters in the cave & dialogues

DB_SpotPlayers(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", PLA_ZhentDungeon_StartSpot_eaa4e6ca-ca1e-40ef-97a8-dbbbb7756e9a, PLA_ZhentDungeon_StopSpot_e62bcfd1-0407-4905-9361-3d6dba40a575);
DB_SpotPlayers_Continuous(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
DB_SpotPlayers_SpotterIgnoreCantTalk(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
DB_SpotPlayers_SpotEvent(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", "PLA_Zhent02_Spotted");
DB_SpotPlayers_IncludeSummons(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
DB_SpotPlayers_IncludeFollowers(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
DB_SpotPlayers_IncludeWildshapedPlayers(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");

DB_PLA_ZhentDungeon_IntroductionDialogs((DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196, (TRIGGER)S_PLA_ZhentDungeon_CaughtUpStart_2d28f0f0-ee59-421d-9f01-20afac3b4247, "", 4);
DB_PLA_ZhentDungeon_IntroductionDialogs(PLA_ZhentDungeon_Zhent02_Stage3_e21cde6d-eb08-feac-4f43-9cfc1c9da759, (TRIGGER)TRIGGERGUID_S_PLA_ZhentDungeon_Dialog3Start_9139856f-204b-4728-bea0-62fac03faad6, "", 3);
DB_PLA_ZhentDungeon_IntroductionDialogs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage2_676b4e1f-8ba8-33f0-87ef-0caabc37fa66, TRIGGERGUID_S_PLA_ZhentDungeon_Dialog2Start_c063d535-3f1f-4254-ab28-2375878111aa, "PLA_ZhentDungeon_TriggerExplosives", 2);
DB_PLA_ZhentDungeon_IntroductionDialogs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12, TRIGGERGUID_S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67, "PLA_ZhentDungeon_TriggerTraps", 1);

//END_REGION

DB_ItemOwnerShipTriggers("WLD_Main_A", S_PLA_ZhentDungeon_Ownership_Zhent06_01_fa80cf84-e72d-46bc-89fb-14230f52ec23, S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077);
DB_ItemOwnerShipTriggers("WLD_Main_A", S_PLA_ZhentDungeon_Ownership_Zhent06_02_712d1f41-fa9d-48dd-ab6f-bac7f3102b9a, S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077);
DB_ItemOwnerShipTriggers("WLD_Main_A", (TRIGGER)S_PLA_ZhentDungeon_OwnershipTriggerBack_1bbf35ea-d1f5-4425-8c9c-534132a97ad3, S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077);
DB_ItemOwnerShipTriggers("WLD_Main_A", (TRIGGER)S_PLA_ZhentDungeon_OwnershipTriggerFront_4624a97a-8206-4ff7-bbb9-827d5b6d8cbf, (CHARACTER)S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca);

//REGION Doubting Artist
DB_DialogMoneyTransfer(1,(DIALOGRESOURCE)PLA_ZhentDungeon_Zhent03_9ba49e21-c139-0151-c88f-afb05da976bc,1000);
DB_DialogMoneyTransfer(2,(DIALOGRESOURCE)PLA_ZhentDungeon_Zhent03_9ba49e21-c139-0151-c88f-afb05da976bc,600);

DB_DialogMoneyTransfer(1,(DIALOGRESOURCE)PLA_ZhentDungeon_DoubtingArtist_4c065742-3512-2eed-ff15-adb10d46e365, 200);

DB_PLA_DoubtingArtistPaintings((ITEM)S_PLA_DoubtingArtist_Painting2_04c523a0-bdbe-486c-97b3-95309e2b3c10);
DB_PLA_DoubtingArtistPaintings((ITEM)S_PLA_DoubtingArtist_Painting1_71da76e5-2936-42b2-8953-973b57cf2888);

DB_PLA_DoubtingArtistPaintingDestructionFlag((ITEM)S_PLA_DoubtingArtist_Painting2_04c523a0-bdbe-486c-97b3-95309e2b3c10, (FLAG)PLA_DoubtingArtist_State_Painting2Destroyed_026c829f-6976-4a3f-aea4-fbff09923e7c);
DB_PLA_DoubtingArtistPaintingDestructionFlag((ITEM)S_PLA_DoubtingArtist_Painting1_71da76e5-2936-42b2-8953-973b57cf2888, PLA_DoubtingArtist_State_Painting1Destroyed_79d29af5-1fb6-4df9-9c7a-dbac13beb8d1);

DB_HasItemEvent((ITEM)S_PLA_DoubtingArtist_Painting1_71da76e5-2936-42b2-8953-973b57cf2888, PLA_DoubtingArtist_State_HasPainting1_b63331fd-5ae6-4a01-a394-4802389e298c);
DB_HasItemEvent((ITEM)S_PLA_DoubtingArtist_Painting2_04c523a0-bdbe-486c-97b3-95309e2b3c10, PLA_DoubtingArtist_State_HasPainting2_f10b9cac-cfbc-4a21-a7b5-45287cc6385f);

DB_Dialogs(S_PLA_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd, PLA_ZhentDungeon_DoubtingArtist_4c065742-3512-2eed-ff15-adb10d46e365);
DB_DeadOnceFlag((CHARACTER)S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd, PLA_DoubtingArtist_State_Dead_0a27ed23-fc91-43ba-8a26-b7053f1f97e2);
DB_Inclusion_Object((CHARACTER)S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd, PLA_DoubtingArtist_Event_StartInclusion_2d3d52fc-6b47-4ea5-ace8-74227604c54c, PLA_DoubtingArtist_Event_EndInclusion_5d8bb626-f915-4181-b2b6-392b8a0fc22a);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)PLA_ZhentDungeon_Zhent03_9ba49e21-c139-0151-c88f-afb05da976bc,(CHARACTER)S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd);

DB_PLA_DoubtingArtist_FreedFlags((FLAG)PLA_DoubtingArtist_State_FreeNoMoreZhent_31e7355f-9904-47e4-af13-e790a3efcde8);
DB_PLA_DoubtingArtist_FreedFlags((FLAG)PLA_DoubtingArtist_State_FreeBribe_4b48199b-dfa4-49f9-8612-79d197e7e3fb);
DB_PLA_DoubtingArtist_FreedFlags((FLAG)PLA_DoubtingArtist_Event_FreedByPersuade_6929a287-8e5a-2710-063b-a86b4803c267);


//END_REGION

PROC_SetOnStage(S_PLA_ZhentDungeon_SurvivorChair_fe75ec47-b188-41e9-97a4-b1166931c2ec, 0);

DB_HasItemEvent(S_PLA_EscapingZhentarim_HiddenEntranceKey2_d377fa14-70f3-45fd-906c-701480238cc1, PLA_EscapingZhentarim_HasItem_HiddenEntranceKey2_886a1e00-a10f-4e3a-a115-96d27de00176);
DB_GiveItemToEventWithClear(S_PLA_EscapingZhentarim_HiddenEntranceKey2_d377fa14-70f3-45fd-906c-701480238cc1, PLA_EscapingZhentarim_GiveItem_HiddenEntranceKey2_a85c50aa-acaa-4ef5-89be-50edb7d2bd72);

PROC_TriggerRegisterForParty(S_PLA_ZhentDungeon_WallTrigger_e68e90f7-6646-4dcb-8e4c-13f14b88381b);

PROC_PLA_ZhentDungeon_InitFuseSize();

DB_PLA_HuntCoward_HiddenEntrancePositions(1, S_PLA_EscapingZhentarim_HiddenEntranceUp_8e20e402-a8ce-425d-b966-73d25be25336, "PLA_HuntCoward_HiddenEntrance_Opened");
DB_PLA_HuntCoward_HiddenEntrancePositions(0, S_PLA_EscapingZhentarim_HiddenEntranceDown_2d6e0af8-5744-4f6b-abfa-c618ad31738c, "PLA_HuntCoward_HiddenEntrance_Closed");
TriggerRegisterForItems(S_PLA_EscapingZhentarim_UnderHiddenEntrance_4f43f593-3393-4f91-8fa0-737bf1173064);


DB_PLA_ZhentDungeon_ShadowTriggers(S_PLA_ZhentDungeon_ShadowsRetreat3_82529a70-f2fb-4be9-a782-94db8a4fc0e6);
DB_PLA_ZhentDungeon_ShadowTriggers(S_PLA_ZhentDungeon_ShadowsRetreat1_6a314fd6-1695-4afd-8089-99d0a5024dbc);
DB_PLA_ZhentDungeon_ShadowTriggers(S_PLA_ZhentDungeon_ShadowsRetreat2_bb7f97ba-242b-4f1c-87d8-790be9380ce4);
DB_PLA_ZhentDungeon_ShadowTriggers(S_PLA_ZhentDungeon_ShadowsRetreat4_0a866be8-caa6-4492-aeab-962c7e608b0d);

DB_PLA_ZhentDungeon_Dogs((CHARACTER)S_PLA_ZhentDungeon_Dog_01_53bf6aa7-9750-4650-87d7-4aa2107b3e2f);
DB_PLA_ZhentDungeon_Dogs(S_PLA_ZhentDungeon_Dog_02_b91c4f2c-89b1-4319-933a-a47db2bc6f12);
DB_PLA_ZhentDungeon_Dogs(S_PLA_ZhentDungeon_Dog_03_980c9203-0287-42fc-97d2-19f7b08620dc);

DB_TrespassTrigger(S_PLA_ZhentDungeon_SecretWall_TrespassTrigger_a121d081-812e-4a6d-a28d-c04be7803c49, NULL_00000000-0000-0000-0000-000000000000);
DB_TrespassTrigger(S_PLA_ZhentDungeon_Vault_TrespassTrigger_000_e4802a35-9387-4620-af4b-8f8b2df41446, NULL_00000000-0000-0000-0000-000000000000);
DB_TrespassTrigger(S_PLA_ZhentDungeon_Vault_TrespassTrigger_001_f8c6b27b-9576-478b-b21a-bfcbd08c2e40, NULL_00000000-0000-0000-0000-000000000000);

DB_QuestDef_State((FLAG)PLA_ZhentDungeon_State_AllPermaDefeated_4dcee939-9346-ebb7-d328-1342e3e1d326, "GLO_DoubtingArtist", "ZhentDungeon_FreedByViolence");
DB_QuestDef_SawPermaDefeatedState("GLO_DoubtingArtist", "ArtistIsDead", (CHARACTER)S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd);

DB_SeenDeadNPCPartyFlag(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, PLA_ZhentDungeon_Knows_Zhent02_Dead_089efe7b-7222-4bb1-ba92-c6dd77a8162e);

DB_FlagReactionAfterDialog(
	(FLAG)PLA_ZhentDungeon_Event_KillTiedZhent_2964b502-35c6-1fd0-e153-ec5bafdb4ca4, 
	(DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_TiedUp_3fb799d1-a452-2121-f933-faa8803116bf);

DB_GLO_CharacterCorpseDialog((CHARACTER)S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd, (DIALOGRESOURCE)PLA_ZhentDungeon_DoubtingArtist_Dead_72550650-2fde-d5bd-075b-098c0cff8aff);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_Dead_c4c4b962-8bda-c27c-ed5d-f03affa79ebd);

DB_DeadOnceFlag((CHARACTER)S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, (FLAG)PLA_ZhentDungeon_State_Zhent03_Dead_77e2bc5f-553b-4244-9de2-f4b5cf67ec64);

DB_QuestDef_State((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d, "HIDDEN_WLD_Boosters", "PLA_ZhentDungeon_Persuaded");

AddGold(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, 550);
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_0cd5e00a-6490-e165-7cf7-b31bed8dd898, 10, 1);
DB_DialogMoneyTransfer(2, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_0cd5e00a-6490-e165-7cf7-b31bed8dd898, 500, 1);
DB_DialogMoneyTransfer(3, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_0cd5e00a-6490-e165-7cf7-b31bed8dd898, 250, 1);

PROC_CharacterDisableCrime(S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd, "Trespassing");

DB_PLA_ZhentDungeon_PlatformHelpers((ITEM)PLT_Goblins_Bridge_Wood_01_Destruct_Target_000_f767149f-d068-843a-67ef-f61a1d2d0e4d);
DB_PLA_ZhentDungeon_PlatformHelpers((ITEM)PLT_Goblins_Bridge_Wood_01_Destruct_Target_000_89015a21-9ef6-85bf-3d75-9d37ea19df2e);

// Combat NPC Reactivity
DB_CombatReact_AD_AppliedStatus(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_AD_Combat_PoisonUsed_0b4fb0be-2819-efe4-743a-0653ee1c3e35, "POISON_BASIC");
DB_CombatReact_AD_AppliedStatus(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent03_AD_Combat_PoisonUsed_f4268f92-c912-02bc-562a-ea5e19cbb1e1, "POISON_BASIC");
DB_CombatReact_AD_AppliedStatus(S_PLA_ZhentDungeon_Zhent05_356c9a7d-1f9d-4a51-8d9b-6908f16f7b7d, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent05_AD_Combat_PoisonUsed_ed9e12cf-d0b9-5bbf-453f-162e0502f51b, "POISON_BASIC");
DB_CombatReact_AD_OnDeathOther(S_PLA_ZhentDungeon_Zhent05_356c9a7d-1f9d-4a51-8d9b-6908f16f7b7d, S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent05_AD_Combat_LeaderDied_d577c3ac-8ac9-ce0c-29d0-576c4a1f09c8);
DB_CombatReact_AD_OnNextTurn(S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent06_AD_Combat_10ccaf69-c454-7838-7d8f-dadd78f210ff);
DB_CombatReact_AD_OnNextTurn(S_PLA_ZhentDungeon_Zhent07_32f7a4dc-d7a8-4e89-875c-3f3722879fbb, (DIALOGRESOURCE)PLA_ZhentDungeon_Zhent07_AD_Combat_c075abca-6be0-a18d-b07d-a3e710290020);

// Prevent turning in ADs
DB_DoNotFaceDialog(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, PLA_ZhentDungeon_Zhent04_AD_Idle_6f02166c-5fbd-e1f3-4193-e532c9f135b6);
DB_DoNotFaceDialog(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, PLA_ZhentDungeon_Zhent04_AD_Idle_6f02166c-5fbd-e1f3-4193-e532c9f135b6);
DB_DoNotFaceDialog(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, PLA_ZhentDungeon_Zhent03_AD_Zhent04_e7a1d28c-b7ae-9b04-9d70-1fb274587647);
DB_DoNotFaceDialog(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, PLA_ZhentDungeon_Zhent03_AD_Zhent04_e7a1d28c-b7ae-9b04-9d70-1fb274587647);
DB_DoNotFaceDialog(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, PLA_ZhentDungeon_Zhent03_AD_ArtCritics_6a949731-cd0a-a5f7-8282-697902eb902e);
DB_DoNotFaceDialog(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, PLA_ZhentDungeon_Zhent03_AD_ArtCritics_6a949731-cd0a-a5f7-8282-697902eb902e);
KBSECTION
//REGION Cheat
IF
TextEvent("PLA_SaveGnollZhent")
THEN
SetEntityEvent(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_Event_LeftCave");
SetEntityEvent(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, "PLA_ZhentShipment_Event_LeftCave");

IF
TextEvent("PLA_ArtistIsFree")
THEN
SetFlag(PLA_DoubtingArtist_State_Leaving_201c1ed0-ecc3-4c25-8f68-8716bd5ca7ae,NULL_00000000-0000-0000-0000-000000000000,0);
SetFlag(PLA_DoubtingArtist_State_Free_4b48199b-dfa4-49f9-8612-79d197e7e3fb,NULL_00000000-0000-0000-0000-000000000000,0);

IF
TextEvent("PLA_ZhentHostile")
THEN
PROC_SetRelationToPlayers(ACT1_PLA_HideoutZhents_339b19c5-f1fb-1389-44b9-a9d31965b560,0);

//END_REGION

//REGION The escaping zhent

IF
FlagSet(PLA_EscapingZhentarim_State_Permitted_4af170a8-0c07-bc6e-ef28-3fa3a9eedef2, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513);
DB_Dialogs((CHARACTER)S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, (DIALOGRESOURCE)PLA_EscapingZhentarim_Permitted_098d8725-df16-f51c-b565-15c1deea485b);
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance");
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach");
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind");

//REGION Spot check at entrance

IF
UseStarted(_, S_PLA_EscapingZhentarim_Hatch_6f4de170-be4f-4bbb-bb37-69f2a5ddd929)
THEN
PROC_PLA_EscaplingZhentarim_CleanupSpot();

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach", _Player)
THEN
PROC_PLA_EscaplingZhentarim_CleanupSpot();

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind", _Player)
THEN
PROC_PLA_EscaplingZhentarim_CleanupSpot();

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance", _Player)
THEN
PROC_PLA_EscaplingZhentarim_CleanupSpot();

PROC
PROC_StateSet_PermaDefeated(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
THEN
PROC_PLA_EscaplingZhentarim_CleanupSpot();

PROC
PROC_PLA_EscaplingZhentarim_CleanupSpot()
THEN
PROC_TriggerUnregisterForPlayers(S_PLA_EscapingZhentarim_PerceptionBox_0498ebfc-7582-4971-802c-e870cb53e9e5);

PROC
PROC_PLA_EscaplingZhentarim_CleanupSpot()
AND
DB_KnowledgeCheckTrigger_AD("PLA_EscapingZhentarim_PerceptionBox", S_PLA_EscapingZhentarim_PerceptionBox_0498ebfc-7582-4971-802c-e870cb53e9e5, "Perception", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)PLA_EscapingZhentarim_AD_PerceptionSucceeded_bc683438-a647-eb61-6293-cc92095e4802, PLA_EscapingZhentarim_Event_Spotted_e0f0653a-1db3-36c9-012b-da237f709fd1)
THEN
NOT DB_KnowledgeCheckTrigger_AD("PLA_EscapingZhentarim_PerceptionBox", S_PLA_EscapingZhentarim_PerceptionBox_0498ebfc-7582-4971-802c-e870cb53e9e5, "Perception", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)PLA_EscapingZhentarim_AD_PerceptionSucceeded_bc683438-a647-eb61-6293-cc92095e4802, PLA_EscapingZhentarim_Event_Spotted_e0f0653a-1db3-36c9-012b-da237f709fd1);

IF
QuestUpdateUnlocked(_, "PLA_ZhentShipment", "GotPassword")
AND
DB_KnowledgeCheckTrigger_AD("PLA_EscapingZhentarim_PerceptionBox", S_PLA_EscapingZhentarim_PerceptionBox_0498ebfc-7582-4971-802c-e870cb53e9e5, "Perception", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)PLA_EscapingZhentarim_AD_PerceptionSucceeded_bc683438-a647-eb61-6293-cc92095e4802, PLA_EscapingZhentarim_Event_Spotted_e0f0653a-1db3-36c9-012b-da237f709fd1)
THEN
NOT DB_KnowledgeCheckTrigger_AD("PLA_EscapingZhentarim_PerceptionBox", S_PLA_EscapingZhentarim_PerceptionBox_0498ebfc-7582-4971-802c-e870cb53e9e5, "Perception", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)PLA_EscapingZhentarim_AD_PerceptionSucceeded_bc683438-a647-eb61-6293-cc92095e4802, PLA_EscapingZhentarim_Event_Spotted_e0f0653a-1db3-36c9-012b-da237f709fd1);
SetFlag(PLA_EscapingZhentarim_Event_Spotted_e0f0653a-1db3-36c9-012b-da237f709fd1, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
QuestUpdateUnlocked(_, "PLA_ZhentShipment", "GotPassword")
THEN
NOT DB_QuestDef_State((FLAG)PLA_ZhentShipment_Quest_DirectionsDead_8d437983-e741-2027-8ea6-d07bd501bc08, "PLA_ZhentShipment", "GotDirectionsDead");
NOT DB_QuestDef_State((FLAG)PLA_ZhentShipment_Quest_PasswordDead_e1d4ba1b-868b-ccc4-4405-68a05fe97bce, "PLA_ZhentShipment", "GotPasswordDead");

IF
EnteredTrigger(_Player, S_PLA_EscapingZhentarim_PerceptionBox_0498ebfc-7582-4971-802c-e870cb53e9e5)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "PLA_ZhentShipment", "GotPassword", 1)
AND
NOT DB_OnlyOnce("PLA_EscapingZhentarim_AD_PerceptionSucceeded_ToldInDungeon")
AND
QRY_StartDialog(PLA_EscapingZhentarim_AD_PerceptionSucceeded_bc683438-a647-eb61-6293-cc92095e4802, _Player)
THEN
DB_OnlyOnce("PLA_EscapingZhentarim_AD_PerceptionSucceeded_ToldInDungeon");


//END_REGION

IF
FlagSet(PLA_EscapingZhentarim_Event_Spotted_e0f0653a-1db3-36c9-012b-da237f709fd1, _, _)
THEN
SetVisible(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 1);

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance", _Player)
AND
QRY_IsSummonOrPartyFollower((CHARACTER)_Player)
THEN
PROC_ZhentDungeon_ExpedientEscape(_Player);

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach", _Player)
AND
QRY_IsSummonOrPartyFollower((CHARACTER)_Player)
THEN
PROC_ZhentDungeon_ExpedientEscape(_Player);

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind", _Player)
THEN
PROC_ZhentDungeon_ExpedientEscape(_Player);

PROC
PROC_ZhentDungeon_Zhent01_AttackBarrel()
AND
DB_GlobalFlag((FLAG)PLA_EscapingZhentarim_Escape_05222e53-c29d-39c2-8795-0a18565a7226) // flagType: Global
AND
NOT DB_CantTalk(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
NOT DB_OnlyOnce("PLA_EscapingZhentarim_Escape")
AND
CanSee(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d, 1)
AND
NOT DB_GlobalFlag(PLA_EscapingZhentarim_State_BarrelGone_2c0b3970-3f48-4b6b-8b79-410f9222e6c1)
THEN
DB_OnlyOnce("PLA_EscapingZhentarim_Escape");
UseSpell(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "Projectile_FireBolt", S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d);
PROC_PLA_EscapingZhentarim_FlagBarrelTargets();

PROC
PROC_PLA_EscapingZhentarim_FlagBarrelTargets()
AND
DB_Players(_Character)
AND
IsInTrigger(_Character, S_PLA_EscapingZhentarim_Trigger_43876afe-b9b0-4afd-8e29-7cb5ca34fbc3,1 )
THEN
SetFlag(PLA_EscapingZhentarim_Knows_Attacked_e04c5735-27a8-7597-f3fd-f990ab7c78b4, _Character, 0);

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach", _Player)
AND
NOT QRY_IsSummonOrPartyFollower((CHARACTER)_Player)
AND
NOT QRY_ZhentDungeon_CancelDialogNearBreach(_Player)
AND
NOT QRY_StartDialog(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, _Player)
THEN
PROC_ZhentDungeon_ExpedientEscape(_Player);

QRY
QRY_ZhentDungeon_CancelDialogNearBreach((CHARACTER)_Player)
AND
DB_DialogName(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, _)
THEN
PROC_ZhentDungeon_ExpedientEscape(_Player);

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance", _Player)
AND
NOT QRY_IsSummonOrPartyFollower((CHARACTER)_Player)
AND
NOT QRY_StartDialog(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, _Player)
THEN
PROC_ZhentDungeon_ExpedientEscape(_Player);

PROC
PROC_DialogFlagSetup(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, _Player)
THEN
NOT DB_QuestDef_State((FLAG)PLA_ZhentShipment_Quest_DirectionsDead_8d437983-e741-2027-8ea6-d07bd501bc08, "PLA_ZhentShipment", "GotDirectionsDead");
NOT DB_QuestDef_State((FLAG)PLA_ZhentShipment_Quest_PasswordDead_e1d4ba1b-868b-ccc4-4405-68a05fe97bce, "PLA_ZhentShipment", "GotPasswordDead");

PROC
PROC_ZhentDungeon_ExpedientEscape((CHARACTER)_Player)
AND
QRY_OnlyOnce("PROC_ZhentDungeon_ExpedientEscape")
THEN
LookAtEntity(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, _Player, 2.0); 
PROC_ForceStopDialog((CHARACTER)S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513);
PROC_ZhentDungeon_Zhent01_AttackBarrel();
SetVisible(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 1);
SetFlag((FLAG)PLA_EscapingZhentarim_Escape_05222e53-c29d-39c2-8795-0a18565a7226, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetHasDialog(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 0);
PROC_TryStartAD(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_AD_Backup_baeef9ec-9c03-d27c-8a0a-ffc92d9bb57a, S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513);
NOT DB_QuestDef_State((FLAG)PLA_ZhentShipment_Quest_DirectionsDead_8d437983-e741-2027-8ea6-d07bd501bc08, "PLA_ZhentShipment", "GotDirectionsDead");
NOT DB_QuestDef_State((FLAG)PLA_ZhentShipment_Quest_PasswordDead_e1d4ba1b-868b-ccc4-4405-68a05fe97bce, "PLA_ZhentShipment", "GotPasswordDead");

PROC
PROC_ZhentDungeon_ExpedientEscape(_)
THEN
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind");
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach");
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance");

PROC
PROC_DialogFlagSetup(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, _, _Player)
AND
IsInTrigger(_Player, S_PLA_EscapingZhent_NearBreach_d41a4a60-6679-46d8-948f-051c17d3ed2a, 1)
THEN
SetFlag(PLA_EscapingZhentarim_State_NearBreach_3067640f-3d27-c69c-ade9-9a5e143e11ab, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogStarted(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, _)
THEN
SetVisible(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 1);

IF
DialogEnded(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, _)
AND
NOT DB_GlobalFlag(PLA_EscapingZhentarim_State_Permitted_4af170a8-0c07-bc6e-ef28-3fa3a9eedef2)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513);
SetHasDialog(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 0);
SetFlag((FLAG)PLA_EscapingZhentarim_Escape_05222e53-c29d-39c2-8795-0a18565a7226, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

QRY
QRY_DialogAttackRequested_CustomResponse(_, _Player)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
DB_DialogName(PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, _ID)
THEN
PROC_ZhentDungeon_ExpedientEscape((CHARACTER)_Player);


IF
DestroyingBy(S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d, _, _, _)
THEN
SetFlag(PLA_EscapingZhentarim_State_BarrelGone_2c0b3970-3f48-4b6b-8b79-410f9222e6c1, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
LeftTrigger(S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d, S_PLA_EscapingZhentarim_BarrelTrigger_48b62ce9-35d9-48cc-9f15-348c8cff225e)
THEN
SetFlag(PLA_EscapingZhentarim_State_BarrelGone_2c0b3970-3f48-4b6b-8b79-410f9222e6c1, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_DialogName(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
DB_InRegion((CHARACTER)_Player, S_PLA_EscapingZhentarim_BarrelTrigger_48b62ce9-35d9-48cc-9f15-348c8cff225e)
THEN
SetFlag(PLA_ZhentDungeon_State_PlayerNearBarrel_76470a53-f3f3-48db-9fc9-c203ff9a0d28, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(PLA_ZhentDungeon_State_PlayerNearBarrel_76470a53-f3f3-48db-9fc9-c203ff9a0d28)
AND
DB_DialogName(DIALOGRESOURCEGUID_PLA_EscapingZhentarim_7535f174-e3ff-a417-5adf-b89f5bc4544b, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
NOT DB_InRegion((CHARACTER)_Player, S_PLA_EscapingZhentarim_BarrelTrigger_48b62ce9-35d9-48cc-9f15-348c8cff225e)
THEN
ClearFlag(PLA_ZhentDungeon_State_PlayerNearBarrel_76470a53-f3f3-48db-9fc9-c203ff9a0d28, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag((FLAG)PLA_EscapingZhentarim_Escape_05222e53-c29d-39c2-8795-0a18565a7226) // flagType: Global
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_PlayerNearBarrel_76470a53-f3f3-48db-9fc9-c203ff9a0d28)
AND
NOT DB_CantTalk(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
NOT DB_OnlyOnce("PLA_EscapingZhentarim_Escape")
AND
CanSee(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d, 1)
AND
NOT DB_GlobalFlag(PLA_EscapingZhentarim_State_BarrelGone_2c0b3970-3f48-4b6b-8b79-410f9222e6c1)
THEN
DB_OnlyOnce("PLA_EscapingZhentarim_Escape");
ApplyDamage(S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d, 100, "Fire", S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513);
PROC_PLA_EscapingZhentarim_FlagBarrelTargets();

IF
EntityEvent(_, "PLA_EscapingZhentarim_Escaped")
THEN
TriggerUnregisterForItems(S_PLA_EscapingZhentarim_BarrelTrigger_48b62ce9-35d9-48cc-9f15-348c8cff225e);
PROC_TriggerUnregisterForPlayers(S_PLA_EscapingZhentarim_BarrelTrigger_48b62ce9-35d9-48cc-9f15-348c8cff225e);

PROC
PROC_StateSet_PermaDefeated(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
THEN
PROC_TriggerUnregisterForItemsWhenInLevel(S_PLA_EscapingZhentarim_BarrelTrigger_48b62ce9-35d9-48cc-9f15-348c8cff225e,"WLD_Main_A");
PROC_TriggerUnregisterForPlayers(S_PLA_EscapingZhentarim_BarrelTrigger_48b62ce9-35d9-48cc-9f15-348c8cff225e);

IF
EntityEvent(_, "PLA_EscapingZhentarim_Escaped")
AND
NOT QRY_PLA_ZhentDungeon_Zhent01_ToCellar()
THEN
AppearOutOfSightTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_ZhentDungeon_EscapeTrigger1_1_9e1f98c1-0700-49c6-89c6-ee6c43c48355, S_PLA_ZhentDungeon_WelcomeTrigger_fadb42a8-ae41-4185-bb9b-2d09bfc44701, 0, NULL_00000000-0000-0000-0000-000000000000, "PLA_ZhentDungeon_Arrived");
PROC_CharacterMoveTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, TRIGGERGUID_S_PLA_ZhentDungeon_EscapeTrigger1_1_9e1f98c1-0700-49c6-89c6-ee6c43c48355, "Walk", "PLA_ZhentDungeon_Arrived");
SetFlag((FLAG)PLA_ZhentDungeon_State_Zhent01InHideout_99444408-da2e-4df6-9c50-f2aa7a37051d, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetCombatGroupID(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "9703ba85-b9df-fa08-d65d-338657f844cf");
SetFaction(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, (FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72);
PROC_PLA_ZhentDungeon_ObstructHiddenEntrance();

PROC
PROC_PLA_ZhentDungeon_ObstructHiddenEntrance()
AND
IsInTrigger(ITEMGUID_S_PLA_ZhentDungeon_HatchBlocker_8296a36e-20e1-4dcb-a143-24883f3a0f02, TRIGGERGUID_S_PLA_Cellar_37d69b60-1487-4b4f-8035-a36e55778293, 1)
THEN
TeleportTo(ITEMGUID_S_PLA_ZhentDungeon_HatchBlocker_8296a36e-20e1-4dcb-a143-24883f3a0f02, TRIGGERGUID_S_PLA_ZhentDungeon_HatchBlockerTrigger_e13bca67-a6c0-4493-b3f9-c4724280d16d, "PLA_ZhentDungeon_FixRotation", 0, 0, 0);

QRY
QRY_PLA_ZhentDungeon_Zhent01_ToCellar()
AND
DB_InRegion(_, TRIGGERGUID_S_PLA_Cellar_37d69b60-1487-4b4f-8035-a36e55778293)
AND
QRY_OnlyOnce("PLA_ZhentDungeon_Zhent01_ToCellar")
THEN
TeleportTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_Cellar_TriggerUp_e7fdcc26-a65b-4220-a626-e12d76292641, "", 0, 0, 1);
PROC_SetRelationToPlayers(ACT1_PLA_HideoutZhents_Outside_6678e326-fb9b-e1bb-17b8-092c6f67d83c, 0);
SetForceUpdate(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 1);

QRY
QRY_PLA_ZhentDungeon_Zhent01_ToCellar()
AND
IsInInventoryOf(S_PLA_EscapingZhentarim_HiddenEntranceKey_e1068cbf-5a42-4d8c-b739-709cf9163401, S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 1)
AND
QRY_OnlyOnce("PLA_ZhentDungeon_Zhent01_ToCellar")
THEN
TeleportTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_Cellar_TriggerUp_e7fdcc26-a65b-4220-a626-e12d76292641, "", 0, 0, 1);
PROC_SetRelationToPlayers(ACT1_PLA_HideoutZhents_Outside_6678e326-fb9b-e1bb-17b8-092c6f67d83c, 0);

IF
EntityEvent(_, "PLA_ZhentDungeon_ReachedLadderToDungeon")
AND
NOT QRY_PLA_ZhentDungeon_Zhent01_ToCellar()
THEN
AppearOutOfSightTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_ZhentDungeon_EscapeTrigger1_1_9e1f98c1-0700-49c6-89c6-ee6c43c48355, S_PLA_ZhentDungeon_WelcomeTrigger_fadb42a8-ae41-4185-bb9b-2d09bfc44701, 0, NULL_00000000-0000-0000-0000-000000000000, "PLA_ZhentDungeon_Arrived");
SetFlag((FLAG)PLA_ZhentDungeon_State_Zhent01InHideout_99444408-da2e-4df6-9c50-f2aa7a37051d, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetFaction(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, (FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72);

IF
EntityEvent(_, "PLA_ZhentDungeon_ReachedLadderToDungeon")
THEN
TeleportTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, TRIGGERGUID_S_PLA_ZhentDungeon_TriggerUp_f0f53e94-e51b-49c4-b278-9be6c27edb41, "", 0, 0, 0);
SetFlag((FLAG)PLA_ZhentDungeon_State_Zhent01InHideout_99444408-da2e-4df6-9c50-f2aa7a37051d, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetCombatGroupID(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "9703ba85-b9df-fa08-d65d-338657f844cf");
SetFaction(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, (FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72);
DB_GLO_DefeatCounter(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_DefeatCounter");

IF
EntityEvent(_, "PLA_ZhentDungeon_ReachedLadderToDungeon")
THEN
PROC_PLA_HuntCoward_OpenWardrobe(0);
Lock(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, "PLA_EscapingZhentarim_HiddenEntrance");
AppearOutOfSightTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_ZhentDungeon_EscapeTrigger1_1_9e1f98c1-0700-49c6-89c6-ee6c43c48355, S_PLA_ZhentDungeon_WelcomeTrigger_fadb42a8-ae41-4185-bb9b-2d09bfc44701, 0, NULL_00000000-0000-0000-0000-000000000000, "PLA_ZhentDungeon_Arrived");
SetFlag((FLAG)PLA_ZhentDungeon_State_Zhent01InHideout_99444408-da2e-4df6-9c50-f2aa7a37051d, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetCombatGroupID(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "9703ba85-b9df-fa08-d65d-338657f844cf");
SetFaction(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, (FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72);
SetForceUpdate(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 0);

IF
EntityEvent(_, "PLA_ZhentDungeon_OpenSecretDoor")
THEN
PROC_PLA_HuntCoward_OpenWardrobe(1);

IF
EntityEvent(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Arrived")
THEN
SetFlag(PLA_ZhentDungeon_State_Zhent01Arrived_444dcaeb-3de2-4199-a066-5e85eabdb0ed, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
EntityEvent(ITEMGUID_S_PLA_ZhentDungeon_HatchBlocker_8296a36e-20e1-4dcb-a143-24883f3a0f02, "PLA_ZhentDungeon_FixRotation")
THEN
ItemMoveTo(ITEMGUID_S_PLA_ZhentDungeon_HatchBlocker_8296a36e-20e1-4dcb-a143-24883f3a0f02, TRIGGERGUID_S_PLA_ZhentDungeon_HatchBlockerTrigger_e13bca67-a6c0-4493-b3f9-c4724280d16d, 10.0, 0.0, 1, "", 0);
DB_KnowledgeCheckTrigger_AD("PLA_ZhentDungeon_InvestigationCheck", S_PLA_ZhentDungeon_InvestigationCheck_fcab6448-5967-4f96-869f-5af4182b6cd9, "Investigation", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, PLA_ZhentDungeon_AD_InvestigationCheck_1016a978-d84f-ccfa-d4d3-690ddda1570a, PLA_ZhentDungeon_Event_InvestigationCheckSuccess_8db92b7e-13ab-5545-b329-c8426f530acc);

PROC
PROC_BlockPickupOfItem(_Character, S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d)
AND
NOT DB_GlobalFlag((FLAG)PLA_EscapingZhentarim_Escape_05222e53-c29d-39c2-8795-0a18565a7226) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)PLA_EscapingZhentarim_State_Permitted_4af170a8-0c07-bc6e-ef28-3fa3a9eedef2) // flagType: Global
AND
NOT DB_CantTalk(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
NOT DB_OnlyOnce("PLA_ZhentDungeon_ZhentGuardLeavePeaceful")
AND
NOT DB_OnlyOnce("PLA_EscapingZhentarim_Escape")
AND
CanSee(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d, 1)
AND
NOT DB_GlobalFlag(PLA_EscapingZhentarim_State_BarrelGone_2c0b3970-3f48-4b6b-8b79-410f9222e6c1)
THEN
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance", _Character);
DB_CustomPickupItemResponse(_Character, S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d, 0);

PROC
PROC_BlockMoveOfItem(_Character, S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d)
AND
NOT DB_GlobalFlag((FLAG)PLA_EscapingZhentarim_Escape_05222e53-c29d-39c2-8795-0a18565a7226) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)PLA_EscapingZhentarim_State_Permitted_4af170a8-0c07-bc6e-ef28-3fa3a9eedef2) // flagType: Global
AND
NOT DB_CantTalk(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
NOT DB_OnlyOnce("PLA_ZhentDungeon_ZhentGuardLeavePeaceful")
AND
NOT DB_OnlyOnce("PLA_EscapingZhentarim_Escape")
AND
CanSee(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d, 1)
AND
NOT DB_GlobalFlag(PLA_EscapingZhentarim_State_BarrelGone_2c0b3970-3f48-4b6b-8b79-410f9222e6c1)
THEN
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance", _Character);
DB_CustomMoveItemResponse(_Character, S_PLA_EscapingZhentarim_Barrel_23a9f12f-b35f-4751-8e2e-0164c386d91d, 0);

IF
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d)
AND
NOT DB_GlobalFlag((FLAG)PLA_EscapingZhentarim_State_Permitted_4af170a8-0c07-bc6e-ef28-3fa3a9eedef2)
AND
NOT DB_GlobalFlag((FLAG)PLA_EscapingZhentarim_Escape_05222e53-c29d-39c2-8795-0a18565a7226)
AND
NOT DB_CantTalk(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
QRY_OnlyOnce("PLA_ZhentDungeon_ZhentGuardLeavePeaceful")
THEN
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513);
PROC_CharacterMoveTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_EscapingZhentarim_UpTrigger_c7e2d500-428a-4bc2-bd91-206e99ab037a, "Walk", "PLA_ZhentDungeon_ZhentGuardLeavePeaceful");
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Behind");
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance_NearBreach");
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_Entrance");
SetVisible(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 1);

IF
EntityEvent(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_ZhentDungeon_ZhentGuardLeavePeaceful")
THEN
AppearOutOfSightTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, S_PLA_ZhentDungeon_EscapeTrigger1_1_9e1f98c1-0700-49c6-89c6-ee6c43c48355, S_PLA_ZhentDungeon_WelcomeTrigger_fadb42a8-ae41-4185-bb9b-2d09bfc44701, 0, NULL_00000000-0000-0000-0000-000000000000, "PLA_ZhentDungeon_Arrived");
PROC_CharacterMoveTo(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, TRIGGERGUID_S_PLA_ZhentDungeon_EscapeTrigger1_1_9e1f98c1-0700-49c6-89c6-ee6c43c48355, "Walk", "PLA_ZhentDungeon_Arrived");
SetFlag((FLAG)PLA_ZhentDungeon_State_Zhent01InHideout_99444408-da2e-4df6-9c50-f2aa7a37051d, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetCombatGroupID(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "9703ba85-b9df-fa08-d65d-338657f844cf");
SetFaction(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, (FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72);

//END_REGION

//REGION Cellar

IF
UseFinished(_Character, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0)
AND
DB_PLA_HuntCoward_Wardrobe_PlannedState(_DesiredState)
THEN
PROC_PLA_HuntCoward_OpenWardrobe((INTEGER)_DesiredState);
NOT DB_PLA_HuntCoward_Wardrobe_PlannedState(_DesiredState);

PROC
PROC_PLA_HuntCoward_OpenWardrobe((INTEGER)_DesiredState)
AND
NOT DB_PLA_HuntCoward_WardRobeMoving(1)
AND
IsDestroyed(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0)
THEN
PROC_PLA_HuntCoward_DoOpenWardrobe(_DesiredState);

PROC
PROC_PLA_HuntCoward_DoOpenWardrobe((INTEGER)_ID)
AND
DB_PLA_HuntCoward_HiddenEntrancePositions(_ID, _Destination, _Event)
THEN
NOT DB_QuestDef_State((FLAG)PLA_ZhentShipment_Quest_DirectionsDead_8d437983-e741-2027-8ea6-d07bd501bc08, "PLA_ZhentShipment", "GotDirectionsDead");
NOT DB_QuestDef_State((FLAG)PLA_ZhentShipment_Quest_PasswordDead_e1d4ba1b-868b-ccc4-4405-68a05fe97bce, "PLA_ZhentShipment", "GotPasswordDead");
DB_PLA_HuntCoward_WardRobeMoving(1);
SetCanInteract(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0);
SetCanInteract(S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6, 0);
PROC_SetOnStage(S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6, 1);
ItemMoveTo(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, _Destination, 1.5, 1.0, 0, _Event, 1);
PlaySound(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, "S_PLA_EscapingZhentarim_HiddenEntrance");

// if wardrobe gets destroyed, reveal entrance
IF
DestroyedBy(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, _, _, _)
THEN
PROC_SetOnStage(S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6, 1);
SetCanInteract(S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6, 1);
SetCanInteract(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 1);

IF
DB_PLA_HuntCoward_WardRobeMoving(1)
AND
DB_PLA_HuntCoward_WardRobeState(_State)
THEN
NOT DB_PLA_HuntCoward_WardRobeState(_State);
ClearFlag(PLA_EscapingZhentarim_HiddenEntrance_State_Open_9bc094ea-343b-4525-ae21-04f1f85df833, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_PLA_HuntCoward_WardRobeState(1)
THEN
SetFlag(PLA_EscapingZhentarim_HiddenEntrance_State_Open_9bc094ea-343b-4525-ae21-04f1f85df833, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
EntityEvent(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, _Event)
AND
DB_PLA_HuntCoward_HiddenEntrancePositions(_State, _, _Event)
THEN
NOT DB_PLA_HuntCoward_WardRobeMoving(1);
SetCanInteract(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 1);
DB_PLA_HuntCoward_WardRobeState(_State);
PROC_SetOnStage(S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6, _State);
SetCanInteract(S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6, _State);

IF
UseStarted(_, ITEMGUID_S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6)
THEN
PROC_RemoveOneShotVoiceBarkTrigger(TRIGGERGUID_S_PLA_ZhentDungeon_VB_Cellar_fcab6448-5967-4f96-869f-5af4182b6cd9, VOICEBARKRESOURCEGUID_PLA_ZhentDungeon_VB_Cellar_ee265b73-d973-104c-2aa2-27acfa72623b);

IF
UseStarted(_, S_PLA_ZhentDungeon_LadderUp_46b911d0-321f-431e-9936-33c793943b78)
THEN
PROC_PLA_HuntCoward_OpenWardrobe(1);

PROC
PROC_BlockUseOfItem(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335)
AND
DB_GlobalFlag(PLA_ZhentDungeon_Event_InvestigationCheckSuccess_8db92b7e-13ab-5545-b329-c8426f530acc)
AND
IsLocked(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 1)
AND
NOT QRY_TakeItemFromMagicPockets(_Player, S_PLA_EscapingZhentarim_HiddenEntranceKey_e1068cbf-5a42-4d8c-b739-709cf9163401, _Player)
AND
NOT QRY_TakeItemFromMagicPockets(_Player, S_PLA_EscapingZhentarim_HiddenEntranceKey2_d377fa14-70f3-45fd-906c-701480238cc1, _Player)
AND
NOT DB_OnlyOnce("PLA_ZhentDungeon_AD_InvestigationCheck2")
AND
QRY_StartDialog_Fixed(PLA_ZhentDungeon_AD_InvestigationCheck2_18d281ae-0503-e04b-e4d4-84079869d3ba, _Player)
THEN
DB_OnlyOnce("PLA_ZhentDungeon_AD_InvestigationCheck2");

PROC
PROC_BlockUseOfItem(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335)
AND
IsLocked(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 1)
AND
IsStuck(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0)
AND
QRY_TakeItemFromMagicPockets(_Player, S_PLA_EscapingZhentarim_HiddenEntranceKey_e1068cbf-5a42-4d8c-b739-709cf9163401, _Player)
THEN
Unlock(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335);
DB_PLA_HuntCoward_Wardrobe_PlannedState(1);
DB_CustomUseItemResponse(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0);

PROC
PROC_BlockUseOfItem(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335)
AND
IsLocked(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 1)
AND
IsStuck(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0)
AND
NOT QRY_TakeItemFromMagicPockets(_Player, S_PLA_EscapingZhentarim_HiddenEntranceKey_e1068cbf-5a42-4d8c-b739-709cf9163401, _Player)
AND
QRY_TakeItemFromMagicPockets(_Player, S_PLA_EscapingZhentarim_HiddenEntranceKey2_d377fa14-70f3-45fd-906c-701480238cc1, _Player)
THEN
Unlock(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335);
DB_PLA_HuntCoward_Wardrobe_PlannedState(1);
DB_CustomUseItemResponse(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0);

PROC
PROC_BlockUseOfItem(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335)
AND
IsStuck(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0)
AND
IsLocked(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0)
AND
NOT DB_PLA_HuntCoward_WardRobeState(1)
THEN
DB_PLA_HuntCoward_Wardrobe_PlannedState(1);
DB_CustomUseItemResponse(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0);

PROC
PROC_BlockUseOfItem(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335)
AND
IsLocked(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0)
AND
DB_PLA_HuntCoward_WardRobeState(1)
AND
NOT DB_CustomUseItemResponse(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, _)
THEN
DB_CustomUseItemResponse(_Player, S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 0);
DB_PLA_HuntCoward_Wardrobe_PlannedState(0);

IF
ItemEnteredTrigger(_Item, S_PLA_EscapingZhentarim_UnderHiddenEntrance_4f43f593-3393-4f91-8fa0-737bf1173064, _)
AND
Exists(_Item,1)
THEN
DB_PLA_EscapingZhentarim_UnderHiddenEntrance(_Item);

IF
ItemLeftTrigger(_Item, S_PLA_EscapingZhentarim_UnderHiddenEntrance_4f43f593-3393-4f91-8fa0-737bf1173064, _)
THEN
NOT DB_PLA_EscapingZhentarim_UnderHiddenEntrance(_Item);

IF
DB_PLA_HuntCoward_WardRobeState(0)
AND
DB_PLA_EscapingZhentarim_UnderHiddenEntrance(_Item)
AND
Exists(_Item,1)
AND
IsMovable(_Item, 1)
AND
GetPosition(S_PLA_Cellar_TriggerDown_f7ca358e-ad27-428a-a565-af1344b30de6, _X, _Y, _Z)
THEN
ScatterAt(_Item, _X, _Y, _Z);

IF
EntityEvent(_, "PLA_HuntCoward_HiddenEntrance_Opened")
AND
QRY_OnlyOnce("PLA_ZhentDungeon_VB_HiddenEntrance_Opened")
AND
QRY_GetClosestAvailableCharacterTo(S_PLA_EscapingZhentarim_HiddenEntranceDown_2d6e0af8-5744-4f6b-abfa-c618ad31738c, 0)
AND
DB_ClosestAvailableCharacterTo(_Char,S_PLA_EscapingZhentarim_HiddenEntranceDown_2d6e0af8-5744-4f6b-abfa-c618ad31738c,_Dist)
AND
_Dist <= 6
THEN
StartVoiceBark(PLA_ZhentDungeon_VB_HiddenEntrance_Opened_a797837d-a681-5a26-04fd-99e7c0247dc1, _Char);

//END_REGION

//REGION Zhent after escape

IF
EntityEvent(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, "PLA_EscapingZhentarim_Escaped")
AND
NOT DB_InRegion(_, TRIGGERGUID_S_PLA_ZhentDungeon_053719f0-c4bf-487b-a0f4-44b11e7153c8)
THEN
SetFlag((FLAG)PLA_ZhentDungeon_StartSpot_eaa4e6ca-ca1e-40ef-97a8-dbbbb7756e9a, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Object

IF
EnteredTrigger(_, TRIGGERGUID_S_PLA_ZhentDungeon_053719f0-c4bf-487b-a0f4-44b11e7153c8)
AND
QRY_OnlyOnce("PLA_ZhentDungeon_Event_Setup")
THEN
SetForceUpdate(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 1);
SetForceUpdate(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, 1);
SetFlag((FLAG)PLA_ZhentDungeon_Event_Setup_74c2faf3-c744-4fa3-981e-2c7be31d6a8e, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

//END_REGION

//REGION Gnoll Zhents
IF
EntityEvent(_ZhentAgent, "PLA_ZhentShipment_Event_LeftCave")
AND
NOT DB_PermaDefeated(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4) // Olly not coming alone
THEN
DB_PLA_ZhentDungeon_GnollAgentReady(_ZhentAgent);

PROC
PROC_LongRest()
AND
DB_PLA_ZhentDungeon_GnollAgentReady(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_PLA_ZhentDungeon_GnollAgentReady(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
THEN
DB_ExecuteInLevel("PLA_ZhentDungeon_GnollAgentsToDungeon","WLD_Main_A");

PROC
PROC_LongRest()
AND
DB_PLA_ZhentDungeon_GnollAgentReady(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_PermaDefeated(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
THEN
DB_ExecuteInLevel("PLA_ZhentDungeon_GnollAgentsToDungeon","WLD_Main_A");

PROC
PROC_ExecuteInLevel("PLA_ZhentDungeon_GnollAgentsToDungeon","WLD_Main_A")
THEN
PROC_PLA_ZhentDungeon_GnollAgentsToDungeon();

IF
DB_PLA_ZhentDungeon_GnollAgentReady(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_PLA_ZhentDungeon_GnollAgentReady(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
AND
NOT DB_InRegion(_, TRIGGERGUID_S_PLA_ZhentDungeon_053719f0-c4bf-487b-a0f4-44b11e7153c8)
THEN
PROC_PLA_ZhentDungeon_GnollAgentsToDungeon();

IF
DB_PLA_ZhentDungeon_GnollAgentReady(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_PermaDefeated(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
AND
NOT DB_InRegion(_, TRIGGERGUID_S_PLA_ZhentDungeon_053719f0-c4bf-487b-a0f4-44b11e7153c8)
THEN
PROC_PLA_ZhentDungeon_GnollAgentsToDungeon();

PROC
PROC_PLA_ZhentDungeon_GnollAgentsToDungeon()
THEN
Unlock(ITEMGUID_S_PLA_ZhentDungeon_Door1_b7d96e68-cd39-4048-9e98-86967f6f5d88);
SetFlag((FLAG)PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
RemoveHarmfulStatuses(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
RemoveStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "BURNING"); //Is not currently recognised as a harmful status.

PROC
PROC_PLA_ZhentDungeon_GnollAgentsToDungeon()
AND
NOT DB_PermaDefeated(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
THEN
TeleportTo(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, TRIGGERGUID_S_PLA_ZhentDungeon_GnollZhentTrigger1_d2a075c3-87f0-4848-b996-b48e0d8931be, "", 0, 0, 1);

PROC
PROC_PLA_ZhentDungeon_GnollAgentsToDungeon()
AND
NOT DB_PermaDefeated(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
THEN
PROC_SetOnStage(S_PLA_ZhentDungeon_SurvivorChair_fe75ec47-b188-41e9-97a4-b1166931c2ec, 1);
TeleportTo(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, S_PLA_ZhentDungeon_SurvivorChair_fe75ec47-b188-41e9-97a4-b1166931c2ec, "PLA_ZhentShipment_Agent_001_TieUp", 0, 0, 1);

IF
EntityEvent(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_Agent_001_TieUp")
THEN
Use(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, S_PLA_ZhentDungeon_SurvivorChair_fe75ec47-b188-41e9-97a4-b1166931c2ec, "");

IF
UseStarted(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, S_PLA_ZhentDungeon_SurvivorChair_fe75ec47-b188-41e9-97a4-b1166931c2ec)
AND
NOT DB_Defeated(S_PLA_ZhentDungeon_SurvivorChair_fe75ec47-b188-41e9-97a4-b1166931c2ec)
AND
NOT DB_PLA_TiedZhentFreed(1)
THEN
ApplyStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "TIED_TO_CHAIR", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
SetHitpoints(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, 2);
CreatePuddle(S_PLA_ZhentDungeon_SurvivorChair_fe75ec47-b188-41e9-97a4-b1166931c2ec, "SurfaceBlood", 3, 15, 12, 12, 1.0);

IF
ReposeRemoved(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4,_)
AND
HasActiveStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "TIED_TO_CHAIR", 1)
THEN
RemoveStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "TIED_TO_CHAIR");

PROC
PROC_BlockUseOfItem(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, S_PLA_ZhentDungeon_SurvivorChair_fe75ec47-b188-41e9-97a4-b1166931c2ec)
AND
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_AgentFreed_c76fac51-f641-3c4b-9710-8b1fb93db25f)
THEN
DB_CustomUseItemResponse(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, S_PLA_ZhentDungeon_SurvivorChair_fe75ec47-b188-41e9-97a4-b1166931c2ec, 0);

IF
DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
AND
NOT DB_PermaDefeated(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
THEN
TeleportTo(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, TRIGGERGUID_S_PLA_ZhentDungeon_GnollZhentTrigger2_d4633219-9c25-46a6-b175-be0c90e108ec, "", 0, 0, 1);
RemoveHarmfulStatuses(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c);
RemoveStatus(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, "BURNING");

PROC
PROC_PLA_ZhentDungeon_GnollAgentsToDungeon()
AND
NOT DB_PermaDefeated(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
THEN
SetFlag(PLA_ZhentDungeon_State_ZhentAgent002Arrived_9265cea9-2ff1-4eb9-ba27-cb7f44ec1bb4, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
AND
NOT DB_PermaDefeated(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
THEN
TeleportTo(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, S_PLA_ZhentDungeon_GnollZhentTrigger2_000_a5bf59f9-b7ea-4d95-a647-93292a940274, "", 0, 0, 1);
PROC_DieImmediate(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, DEATHTYPE.DoT, 1);

PROC
PROC_PLA_ZhentDungeon_GnollAgentsToDungeon()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
AND
DB_PLA_ZhentShipment_Agents(_Agent)
AND
NOT DB_PermaDefeated(_Agent)
THEN
SetFaction(_Agent, (FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72);
PROC_PLA_ZhentDungeon_AddZhent(_Agent);

PROC
PROC_PLA_ZhentDungeon_AddZhent((CHARACTER)_Agent)
THEN
DB_GLO_DefeatCounter(_Agent, "PLA_ZhentDungeon_DefeatCounter");
DB_GLO_DefeatCounter(_Agent, "PLA_ZhentDungeon_FF");
SetCombatGroupID(_Agent, "9703ba85-b9df-fa08-d65d-338657f844cf");
SetFaction(_Agent, (FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72);

IF
DB_GlobalFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
AND
NOT DB_InRegion(_, TRIGGERGUID_S_PLA_ZhentDungeon_053719f0-c4bf-487b-a0f4-44b11e7153c8)
THEN
PROC_PLA_ZhentDungeon_ZhentsLeave();

PROC
PROC_PLA_ZhentDungeon_ZhentsLeave()
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
THEN
PROC_SetOnStage(_Zhent, 0); //Zhents flee.

PROC
PROC_PLA_ZhentDungeon_ZhentsLeave()
THEN
PROC_SetOnStage(S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077, 0);
PROC_SetOnStage(S_PLA_ZhentDungeon_Zhent07_32f7a4dc-d7a8-4e89-875c-3f3722879fbb, 0);
PROC_SetOnStage(S_PLA_ZhentDungeon_Zhent08_3f629653-f427-43f9-92ac-89324de5ec11, 0);

PROC
PROC_PLA_ZhentDungeon_ZhentsLeave()
AND
DB_PLA_ZhentDungeon_Dogs(_Dog)
AND
NOT DB_Defeated(_Dog)
THEN
PROC_SetOnStage(_Dog, 0);

//END_REGION

//REGION Dialogues with Zhent as the player approaches her
IF
DB_PLA_ZhentDungeon_IntroductionDialogs(_, _Trigger, _, _)
THEN
DB_SpotPlayers_SpotTrigger(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", (TRIGGER)_Trigger);

IF
DB_GlobalFlag(PLA_ZhentDungeon_State_EntranceDarknessDetected_27ff4aba-e2b9-4e0f-aef8-a27777d77f1a)
AND
NOT DB_OnlyOnce("PLA_ZhentDungeon_TriggerTraps")
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_WaitForGnollZhent_a6eecc2a-7652-e80e-2eb5-eb091019a169)
AND
NOT DB_CantTalk(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
AND
QRY_StartDialog(PLA_ZhentDungeon_Zhent02_AD_Stage1Darkness_43515a4f-1bc6-e9f0-ce65-c9c15fa5fe65, S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca)
THEN
DB_OnlyOnce("PLA_ZhentDungeon_TriggerTraps");

IF
AutomatedDialogEnded(PLA_ZhentDungeon_Zhent02_AD_Stage1Darkness_43515a4f-1bc6-e9f0-ce65-c9c15fa5fe65, _)
THEN
PROC_PLA_ZhentDungeon_ChaseDialogEnded(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12);

PROC
PROC_SpotPlayers_Spotted(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", _Player, "PLA_Zhent02_Spotted")
AND
DB_PLA_ZhentDungeon_IntroductionDialogs(_Dialog, _StartTrigger, _OnlyOnce, _Urgency)
AND
IsInTrigger(_Player, _StartTrigger, 1)
AND
NOT QRY_PLA_ZhentDungeon_ChaseDialog_PlayerInMoreUrgentTrigger(_Player, _StartTrigger, _Urgency)
AND
NOT DB_OnlyOnce(_OnlyOnce)
THEN
PROC_PLA_ZhentDungeon_StartChaseDialog(_Player, _Dialog);

// If player is in another trigger too that has as higher urgency
QRY
QRY_PLA_ZhentDungeon_ChaseDialog_PlayerInMoreUrgentTrigger((CHARACTER)_Player, (TRIGGER)_Trigger, (INTEGER)_Urgency)
AND
DB_PLA_ZhentDungeon_IntroductionDialogs(_, _OtherTrigger, _, _OtherUrgency)
AND
_OtherTrigger != _Trigger
AND
_OtherUrgency > _Urgency
AND
DB_InRegion(_Player, _OtherTrigger)
THEN
DB_NOOP(1);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_NPC, _, _Character, (STRING)_Event)
AND
DB_PLA_ZhentDungeon_SpotEvents(_Event, _Dialog)
THEN
PROC_ClearStoryMove((CHARACTER)_NPC);
PROC_PLA_ZhentDungeon_StartChaseDialog(_Character, _Dialog);
PROC_RemoveOneShotVoiceBarkTrigger(TRIGGERGUID_S_PLA_ZhentDungeon_VB_Entrance_3ba8de7d-947e-4c98-a3ab-5132ee76513f, VOICEBARKRESOURCEGUID_PLA_ZhentDungeon_VB_Entrance_130b5dc4-ea82-182f-e0b0-df5f547d0c0c);

//Stop active ADs in region
PROC
PROC_PLA_ZhentDungeon_StartChaseDialog(_, _)
AND
DB_GLO_ADManager_AD("PLA_ZhentDungeon", _ID)
THEN
NOT DB_GLO_ADManager_AD("PLA_ZhentDungeon", _ID);

PROC
PROC_PLA_ZhentDungeon_StartChaseDialog(_, _Dialog)
AND
DB_DialogNPCs(_ID, S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, _)
AND
NOT DB_DialogName(_Dialog, _ID)
THEN
PROC_ForceStopDialog(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca);

PROC
PROC_PLA_ZhentDungeon_StartChaseDialog((GUIDSTRING)_Player, (DIALOGRESOURCE)_Dialog)
AND
QRY_IsSummonOrPartyFollower((CHARACTER)_Player)
THEN
PROC_PLA_ZhentDungeon_ChaseDialogEnded(_Dialog);

PROC
PROC_PLA_ZhentDungeon_StartChaseDialog(_Player, _Dialog)
AND
_Dialog != PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968
AND
NOT QRY_IsSummonOrPartyFollower((CHARACTER)_Player)
AND
NOT QRY_StartDialog(_Dialog, S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, _Player)
THEN
PROC_PLA_ZhentDungeon_ChaseDialogEnded(_Dialog);

PROC
PROC_PLA_ZhentDungeon_StartChaseDialog(_Player, PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968)
AND
DB_Defeated(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
THEN
PROC_PLA_ZhentDungeon_ChaseDialogEnded(PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968);

PROC
PROC_PLA_ZhentDungeon_StartChaseDialog(_Player, PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968)
AND
NOT DB_Defeated(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
NOT QRY_IsSummonOrPartyFollower((CHARACTER)_Player)
AND
NOT QRY_StartDialog(PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968, S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Player)
THEN
PROC_PLA_ZhentDungeon_ChaseDialogEnded(PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968);

PROC
PROC_PLA_ZhentDungeon_StartChaseDialog(_, _)
THEN
SetFlag((FLAG)PLA_ZhentDungeon_State_BlockAD_f2d6834a-a9ef-4328-9ed1-a1cb84226d8c, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
TimerCancel("GLO_ADManager_AdBlockerTimer_PLA_ZhentDungeon");

IF
DialogEnded(_Dialog, _)
AND
DB_PLA_ZhentDungeon_SpotEvents(_Event, _Dialog)
THEN
PROC_PLA_ZhentDungeon_ChaseDialogEnded(_Dialog);

PROC
PROC_PLA_ZhentDungeon_StartChaseDialog(_, _)
THEN
PROC_RemoveOneShotVoiceBarkTrigger(TRIGGERGUID_S_PLA_ZhentDungeon_VB_Entrance_3ba8de7d-947e-4c98-a3ab-5132ee76513f, VOICEBARKRESOURCEGUID_PLA_ZhentDungeon_VB_Entrance_130b5dc4-ea82-182f-e0b0-df5f547d0c0c);
SetFlag((FLAG)PLA_ZhentDungeon_State_BlockAD_f2d6834a-a9ef-4328-9ed1-a1cb84226d8c, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
TimerCancel("GLO_ADManager_AdBlockerTimer_PLA_ZhentDungeon");


PROC
PROC_DialogFlagSetup(PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968, _, _, _)
THEN
SetFlag(PLA_ZhentDungeon_State_TrapDialogueInProgress_fbe1f682-fea0-44f6-ab2a-d454cc151c12, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded((DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968)
AND
QRY_OnlyOnce("PLA_ZhentDungeon_Zhent02_TrapOver")
THEN
TimerLaunch("PLA_ZhentDungeon_Zhent02_TrapOver", 3000);

IF
TimerFinished("PLA_ZhentDungeon_Zhent02_TrapOver")
THEN
ClearFlag(PLA_ZhentDungeon_State_TrapDialogueInProgress_fbe1f682-fea0-44f6-ab2a-d454cc151c12, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_DialogFlagSetup(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage2_676b4e1f-8ba8-33f0-87ef-0caabc37fa66, _, _)
AND
NOT QRY_PLA_ZhentDungeon_FuseInterrupted()
AND
QRY_PLA_ZhentDungeon_NearFuseBrazier()
THEN
SetFlag(PLA_ZhentDungeon_Zhent02_State_CanFireArrow_996d2ea9-0873-4866-b947-f32a519cf5a4, NULL_00000000-0000-0000-0000-000000000000, 0); //This dialogue can only be started once, so the flag doesn't need to be cleared.

QRY
QRY_PLA_ZhentDungeon_NearFuseBrazier()
AND
GetDistanceTo(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, S_PLA_ZhentDungeon_FuseLightBrazier_0669f832-852b-4868-beed-c4a333222ad8, _Dist)
AND
_Dist <= 5.5
THEN
DB_NOOP(1);

QRY
QRY_PLA_ZhentDungeon_NearFuseBrazier()
AND
GetDistanceTo(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, S_PLA_ZhentDungeon_FuseLightBrazier_2_4f16d514-074d-46c5-996d-01a7be62a637, _Dist)
AND
_Dist <= 5.5
THEN
DB_NOOP(1);


PROC
PROC_DialogFlagSetup(_Dialog, _, _)
AND
DB_PLA_ZhentDungeon_IntroductionDialogs(_Dialog, _, _, _Urgency)
AND
_Urgency > 1
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_WaitForGnollZhent_a6eecc2a-7652-e80e-2eb5-eb091019a169)
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ZhentDungeon_State_NotWelcome_9a8d1e40-517d-ba04-5a9a-4d88fe6467a9);
SetFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_DialogFlagSetup(_Dialog, _, _)
AND
DB_PLA_ZhentDungeon_IntroductionDialogs(_Dialog, _, _, _Urgency)
AND
_Urgency > 1
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_WaitForGnollZhent_a6eecc2a-7652-e80e-2eb5-eb091019a169)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
THEN
SetFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d, NULL_00000000-0000-0000-0000-000000000000, 0);

// If starting the Stage 2 dialog flag failed.
PROC
PROC_DialogFlagSetup(_Dialog, _, _)
AND
DB_PLA_ZhentDungeon_IntroductionDialogs(_Dialog, _, _, _Urgency)
AND
_Urgency > 1
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
THEN
SetFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d, NULL_00000000-0000-0000-0000-000000000000, 0);

// If starting the Stage 2 dialog flag failed.
PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded((DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage2_676b4e1f-8ba8-33f0-87ef-0caabc37fa66) 
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_Event_FireArrow_36714058-9c1a-9fea-33e3-25f7078aff57)
AND
NOT QRY_PLA_ZhentDungeon_FuseInterrupted()
AND
QRY_PLA_ZhentDungeon_NearFuseBrazier()
THEN
PROC_TryStartAD(PLA_ZhentDungeon_Zhent02_AD_Stage2_881ca643-2c75-1d87-806b-d483c4966ac0, S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca);
SetFlag(PLA_ZhentDungeon_Event_FireArrow_36714058-9c1a-9fea-33e3-25f7078aff57, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded(PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_JoinedZhent_f952fd87-42f8-2633-f1b5-7e925138d56f)
THEN
SetFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72, 0);
PROC_SetRelationToPlayers(Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, 0);

PROC
PROC_PLA_ZhentDungeon_StartChaseDialog(_, _Dialog)
AND
DB_PLA_ZhentDungeon_SpotEvents(_, _Dialog) //These dialogues always lead to combat (or a peaceful resolution), and are not OnlyOnce-restricted like the trigger-bound ones.
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentDungeon_StopSpot_e62bcfd1-0407-4905-9361-3d6dba40a575);

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded((DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
AND
NOT DB_PermaDefeated(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca)
THEN
PROC_SetRelationMutual(Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 50);

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded((DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196)
THEN
ClearOwnership(S_PLA_ZhentDungeon_Defense_TrapLever_50f5c39e-8b66-4214-b98a-e1cbbea63dc3);

IF
FlagSet((FLAG)PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d, _, _)
THEN
ClearOwnership(S_PLA_ZhentDungeon_CorridorTrapLever_4e0d91a8-48f4-4e3a-963c-52c0f89b88a0);

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded((DIALOGRESOURCE)_Dialog)
AND
DB_PLA_ZhentDungeon_IntroductionDialogs(_Dialog, _StartTrigger, _OnlyOnce, _Urgency)
AND
_OnlyOnce != ""
THEN
DB_OnlyOnce(_OnlyOnce);

QRY
QRY_SpeakerIsInDialogRange((CHARACTER)S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, _Player)
AND
DB_DialogRequestCache_SpeakerList_Players((DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12,_, _Player,1)
AND
IsInTrigger(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, S_PLA_ZhentDungeon_FrontRoomBelow_bc2727f4-e6a3-4fef-89d3-239da6eb6a9b, 1)
THEN
DB_NOOP(1);

QRY
QRY_SpeakerIsInDialogRange((CHARACTER)S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, _NPC)
AND
DB_DialogRequestCache_SpeakerList_NPCs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12, _, (CHARACTER)_NPC,_)
AND
IsInTrigger(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, S_PLA_ZhentDungeon_FrontRoomBelow_bc2727f4-e6a3-4fef-89d3-239da6eb6a9b, 1)
THEN
DB_NOOP(1);

QRY
QRY_SpeakerIsInDialogRange((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Player)
AND
DB_DialogRequestCache_SpeakerList_Players((DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12,_, _Player,1)
AND
QRY_SpeakerIsInDialogRange((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (CHARACTER)S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca)
THEN
DB_NOOP(1);

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12)
THEN
NOT DB_SpotPlayers_SpotTrigger(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", TRIGGERGUID_S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67);

PROC
PROC_DialogFlagSetup(_Dialog, _, _)
AND
DB_PLA_ZhentDungeon_IntroductionDialogs(_Dialog, _StartTrigger, _OnlyOnce, _Urgency)
AND
_OnlyOnce != ""
THEN
DB_OnlyOnce(_OnlyOnce);

IF
DialogEnded(_Dialog, _)
AND
DB_PLA_ZhentDungeon_IntroductionDialogs(_Dialog, _, _, _)
THEN
PROC_PLA_ZhentDungeon_ChaseDialogEnded(_Dialog);

IF
DB_OnlyOnce("PLA_ZhentDungeon_TriggerExplosives")
THEN
DB_OnlyOnce("PLA_ZhentDungeon_TriggerTraps");

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_WaitForGnollZhent_a6eecc2a-7652-e80e-2eb5-eb091019a169)
THEN
SetFlag((FLAG)PLA_ZhentDungeon_State_Stage1Ended_78f17b3e-bbe1-4b2c-bed8-6ec2fd230232, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
SetFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
PROC_SpotPlayers_RestartSpotting(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");

IF
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d)
THEN
ClearFlag(PLA_ZhentDungeon_State_BlockAD_f2d6834a-a9ef-4328-9ed1-a1cb84226d8c, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_Dialogs(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_0cd5e00a-6490-e165-7cf7-b31bed8dd898);
DB_Dialogs(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent03_9ba49e21-c139-0151-c88f-afb05da976bc);
DB_Dialogs(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent04_86307d4b-7bf3-060f-4842-8a4141b4de43);
DB_Dialogs(S_PLA_ZhentDungeon_Zhent05_356c9a7d-1f9d-4a51-8d9b-6908f16f7b7d, DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent05_7e7f3cbe-2703-0113-c4e3-b4cf7bbe1445);
NOT DB_PLA_ZhentDungeon_IntroductionDialogs((DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage2_676b4e1f-8ba8-33f0-87ef-0caabc37fa66, (TRIGGER)TRIGGERGUID_S_PLA_ZhentDungeon_Dialog2Start_c063d535-3f1f-4254-ab28-2375878111aa, "PLA_ZhentDungeon_TriggerExplosives", 2);
NOT DB_PLA_ZhentDungeon_IntroductionDialogs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12, TRIGGERGUID_S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67, "PLA_ZhentDungeon_TriggerTraps", 1);
PROC_TriggerUnregisterForPlayers(S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67);
PROC_TriggerUnregisterForPlayers(S_PLA_ZhentDungeon_Dialog2Start_c063d535-3f1f-4254-ab28-2375878111aa);
DB_SpotPlayers(S_PLA_ZhentDungeon_Ranger_02_50c17970-3683-4417-b4f3-bd1e117e3176, "PLA_ZhentDungeon_WelcomePlayer", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(S_PLA_ZhentDungeon_Ranger_02_50c17970-3683-4417-b4f3-bd1e117e3176, "PLA_ZhentDungeon_WelcomePlayer", S_PLA_ZhentDungeon_WelcomeSpotTrigger_58837aad-8c9a-405c-8601-c5d5653eb784);
PROC_TriggerRegisterForPlayers(S_PLA_ZhentDungeon_PlayerWelcomeCancel_f9218878-0e20-4592-9d74-74b16dd03589);

IF
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
THEN
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
PROC_SetRelationToPlayers(Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, 50);

//Player has agreed to kill Rugan.
IF
FlagSet(PLA_ZhentDungeon_State_JoinedZhent_f952fd87-42f8-2633-f1b5-7e925138d56f, _, _) // flagType: Global
THEN
PROC_SetRelationToPlayers(Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, 50);

IF
FlagSet(PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d, _, _) // flagType: Global
AND
NOT DB_SpotPlayers_SpotEvent(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", "PLA_Zhent02_Spotted_Trap")
THEN
SetFlag((FLAG)PLA_ZhentDungeon_StopSpot_e62bcfd1-0407-4905-9361-3d6dba40a575, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Object
PROC_SetRelationToPlayers(Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, 50);

IF
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
AND
DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
AND
DB_GlobalFlag(PLA_ZhentShipment_Rugan_Knows_Thief_26f50a78-b9bf-43f2-bedd-d7d7347a9128)
AND
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
THEN
NOT DB_PLA_ZhentDungeon_IntroductionDialogs((DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196, (TRIGGER)TRIGGERGUID_S_PLA_ZhentDungeon_Dialog3Start_9139856f-204b-4728-bea0-62fac03faad6, "", 4);
NOT DB_PLA_ZhentDungeon_IntroductionDialogs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage2_676b4e1f-8ba8-33f0-87ef-0caabc37fa66, TRIGGERGUID_S_PLA_ZhentDungeon_Dialog2Start_c063d535-3f1f-4254-ab28-2375878111aa, "PLA_ZhentDungeon_TriggerExplosives", 2);
NOT DB_PLA_ZhentDungeon_IntroductionDialogs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12, TRIGGERGUID_S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67, "PLA_ZhentDungeon_TriggerTraps", 1);
NOT DB_SpotPlayers_SpotTrigger(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67);
NOT DB_SpotPlayers_SpotTrigger(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", TRIGGERGUID_S_PLA_ZhentDungeon_Dialog2Start_c063d535-3f1f-4254-ab28-2375878111aa);
NOT DB_SpotPlayers_SpotTrigger(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", TRIGGERGUID_S_PLA_ZhentDungeon_Dialog3Start_9139856f-204b-4728-bea0-62fac03faad6);
DB_PLA_ZhentDungeon_IntroductionDialogs(PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968, PLA_ZhentDungeon_TrapDialogStart_5efcb48a-c21f-4821-adbc-373b1e0c9ddd, "PLA_ZhentDungeon_TriggerTraps", 1);
NOT DB_SpotPlayers_SpotEvent(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", "PLA_Zhent02_Spotted");
DB_SpotPlayers_SpotEvent(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", "PLA_Zhent02_Spotted_Trap");
DB_SpotPlayers_IgnoreCombat(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca,  "PLA_ZhentDungeon");
SetFlag(PLA_ZhentDungeon_StartSpot_eaa4e6ca-ca1e-40ef-97a8-dbbbb7756e9a, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_TrespassTrigger(S_PLA_ZhentDungeon_TrapTrespass_638c0b6b-02f0-450c-b7f0-772840763d7b, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
AND
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_Zhent01Arrived_444dcaeb-3de2-4199-a066-5e85eabdb0ed) // flagType: Global
THEN
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513);
DB_Dialogs(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent01_5e10997f-ad97-db52-1afd-010ee3a1854f);

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196)
THEN
PROC_SpotPlayers_StopSpotting(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
DB_OnlyOnce("PLA_ZhentDungeon_TriggerExplosives");
DB_OnlyOnce("PLA_ZhentDungeon_TriggerTraps");
NOT DB_PLA_ZhentDungeon_IntroductionDialogs((DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196, (TRIGGER)NULL_00000000-0000-0000-0000-000000000000, "", 4);
NOT DB_PLA_ZhentDungeon_IntroductionDialogs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage2_676b4e1f-8ba8-33f0-87ef-0caabc37fa66, TRIGGERGUID_S_PLA_ZhentDungeon_Dialog2Start_c063d535-3f1f-4254-ab28-2375878111aa, "PLA_ZhentDungeon_TriggerExplosives", 2);
NOT DB_PLA_ZhentDungeon_IntroductionDialogs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12, TRIGGERGUID_S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67, "PLA_ZhentDungeon_TriggerTraps", 1);

PROC
PROC_DialogFlagSetup(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196, _, _)
THEN
DB_OnlyOnce("PLA_ZhentDungeon_CaughtUpDialogue");
DB_OnlyOnce("PLA_ZhentDungeon_TriggerExplosives");
DB_OnlyOnce("PLA_ZhentDungeon_TriggerTraps");
NOT DB_PLA_ZhentDungeon_IntroductionDialogs((DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196, (TRIGGER)TRIGGERGUID_S_PLA_ZhentDungeon_Dialog3Start_9139856f-204b-4728-bea0-62fac03faad6, "", 4);
NOT DB_PLA_ZhentDungeon_IntroductionDialogs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage2_676b4e1f-8ba8-33f0-87ef-0caabc37fa66, TRIGGERGUID_S_PLA_ZhentDungeon_Dialog2Start_c063d535-3f1f-4254-ab28-2375878111aa, "PLA_ZhentDungeon_TriggerExplosives", 2);
NOT DB_PLA_ZhentDungeon_IntroductionDialogs(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12, TRIGGERGUID_S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67, "PLA_ZhentDungeon_TriggerTraps", 1);

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentDungeon_Ranger_02_50c17970-3683-4417-b4f3-bd1e117e3176, "PLA_ZhentDungeon_WelcomePlayer", _Player)
AND
QRY_StartDialog(PLA_ZhentDungeon_Zhent04_AD_Welcome_f8b7e643-7102-c6be-d496-d4f8fdd0fc72, S_PLA_ZhentDungeon_Ranger_02_50c17970-3683-4417-b4f3-bd1e117e3176)
THEN
SetFlag(PLA_ZhentDungeon_State_CancelWelcome_74ec27a7-86a6-4f28-99d8-663207cebdac, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
EnteredTrigger(_Player, S_PLA_ZhentDungeon_PlayerWelcomeCancel_f9218878-0e20-4592-9d74-74b16dd03589)
THEN
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Ranger_02_50c17970-3683-4417-b4f3-bd1e117e3176, "PLA_ZhentDungeon_WelcomePlayer");
SetFlag(PLA_ZhentDungeon_State_CancelWelcome_74ec27a7-86a6-4f28-99d8-663207cebdac, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
EntityEvent(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, "PLA_BackToPacking")
THEN
SetFlag(PLA_ZhentDungeon_Zhent03_DidWelcome_a5ebc449-50eb-495d-a3ff-11851d94d373, S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, 0);

//When everyone leaves, if she's waiting for the other Zhentarim to return, she start trying to give the first warning again.
IF
DB_OnlyOnce("PLA_ZhentDungeon_TriggerTraps")
AND
NOT DB_OnlyOnce("PLA_ZhentDungeon_TriggerExplosives")
AND
NOT DB_InRegion(_, TRIGGERGUID_S_PLA_ZhentDungeon_053719f0-c4bf-487b-a0f4-44b11e7153c8)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_WaitForGnollZhent_a6eecc2a-7652-e80e-2eb5-eb091019a169)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d)
THEN
NOT DB_OnlyOnce("PLA_ZhentDungeon_TriggerTraps");


PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded(PLA_ZhentDungeon_Zhent02_Stage2_676b4e1f-8ba8-33f0-87ef-0caabc37fa66)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
THEN
PROC_SpotPlayers_ClearSpotTrigger(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded(PLA_ZhentDungeon_Zhent02_Stage3_e21cde6d-eb08-feac-4f43-9cfc1c9da759)
AND
QRY_OnlyOnce("PLA_ZhentDungeon_Stage3")
THEN
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
SetFlag(PLA_ZhentDungeon_Zhent02_State_GetToLadder_c281ffaa-413e-40c5-ba02-7fe3f4ae92cd, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(PLA_ZhentDungeon_Event_RetreatToShadows_ff0e0b2e-d254-0a75-a7e0-86524e9c5b4c, _, _)
AND
DB_PLA_ZhentDungeon_ShadowTriggers_Used(_Trigger, _AnyPlayer)
THEN
NOT DB_PLA_ZhentDungeon_ShadowTriggers_Used(_Trigger, _AnyPlayer);

IF
FlagSet(PLA_ZhentDungeon_Event_RetreatToShadows_ff0e0b2e-d254-0a75-a7e0-86524e9c5b4c, _Player, _)
THEN
ClearFlag(PLA_ZhentDungeon_Event_RetreatToShadows_ff0e0b2e-d254-0a75-a7e0-86524e9c5b4c, _Player, 0);

IF
FlagSet(PLA_ZhentDungeon_Event_RetreatToShadows_ff0e0b2e-d254-0a75-a7e0-86524e9c5b4c, (CHARACTER)_Player, _)
AND
DB_Players(_AnyPlayer)
AND
QRY_SameUser(_AnyPlayer, _Player)
AND
IsInTrigger(_AnyPlayer, S_PLA_ZhentDungeon_ShadowsRetreatBox_f2418e52-bf44-470c-b250-a8ec750ec5e0, 1)
AND
DB_PLA_ZhentDungeon_ShadowTriggers(_Trigger)
THEN
PROC_PLA_ZhentDungeon_TryFallBackToShadows(_Trigger, _AnyPlayer);

PROC
PROC_PLA_ZhentDungeon_TryFallBackToShadows((GUIDSTRING)_Trigger, (CHARACTER)_Player)
AND
NOT DB_PLA_ZhentDungeon_ShadowTriggers_Used(_Trigger, _)
AND
NOT DB_PLA_ZhentDungeon_ShadowTriggers_Used(_, _Player)
THEN
CharacterMoveTo(_Player, _Trigger, "Sprint", "PLA_ZhentDungeon_MovedToShadowTrigger");
DB_PLA_ZhentDungeon_ShadowTriggers_Used(_Trigger, _Player);

IF
EntityEvent(_Player, "PLA_ZhentDungeon_MovedToShadowTrigger")
THEN
LookFromTrigger((CHARACTER)_Player, S_PLA_ZhentDungeon_ShadowsRetreat3_82529a70-f2fb-4be9-a782-94db8a4fc0e6, 0);

QRY
QRY_DialogAttackRequested_CustomResponse(_, _Player)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
DB_DialogName(_Name, _ID)
AND
DB_PLA_ZhentDungeon_IntroductionDialogs(_Name, _, _, _)
THEN
PROC_ForceStopDialog(_Player);//Dialog end logic takes care of the rest.

// Oskar Fevras will ignore crimes committed against the Zhent that hold/held him captive.
PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_CrimeID, _Perp, _CrimeType, _Evidence, _Victim)
AND
_Victim != NULL_00000000-0000-0000-0000-000000000000
AND
GetFaction(_Victim, (FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72)
THEN
CrimeIgnoreCrime(_CrimeID, S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd);
//END_REGION

//REGION Zhents do not care about destruction once they start falling back
IF
DB_GlobalFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
THEN
PROC_CharacterDisableAllCrimes((CHARACTER)_Zhent);
TriggerRegisterForCharacter(S_PLA_ZhentDungeon_ResumeCrimesAfterFallback_0dfabaa4-50e1-41ef-abc6-878b17ea138b, _Zhent);
SetHasDialog(_Zhent, 0);

IF
EnteredTrigger(_Zhent, S_PLA_ZhentDungeon_ResumeCrimesAfterFallback_0dfabaa4-50e1-41ef-abc6-878b17ea138b)
THEN
PROC_CharacterEnableAllCrimes((CHARACTER)_Zhent);
SetCombatGroupID(_Zhent, "c3f79c6b-edb0-349c-2345-46aecb69c7ed");
SetFaction(_Zhent, Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc);
SetHasDialog(_Zhent, 1);

IF
EnteredTrigger(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, S_PLA_ZhentDungeon_ResumeCrimesAfterFallback_0dfabaa4-50e1-41ef-abc6-878b17ea138b)
THEN
RemoveStatus(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZHENTSPOTTER_SIGHT");
PROC_SetRelationToPlayers((FACTION)Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, 0);

IF
EnteredTrigger(_, S_PLA_ZhentDungeon_ResumeCrimesAfterFallback_0dfabaa4-50e1-41ef-abc6-878b17ea138b)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d)
AND
DB_Defeated(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca)
THEN
PROC_SetRelationToPlayers((FACTION)Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, 0);

IF
EntityEvent(_Zhent, "PLA_ZhentDungeon_FailedToMoveToBackPosition")
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d)
THEN
PROC_CharacterEnableAllCrimes((CHARACTER)_Zhent);
SetFaction(_Zhent, ACT1_PLA_HideoutZhents_Inside_Trapped_afdeba4b-4fee-4b9a-be25-7fedc71f0e2e);
//END_REGION

//REGION The Zhentarim are dissatisfied with what the players bring them
// sold cursed iron flask to Zarys
IF
MovedFromTo(S_GLO_CursedIronFlask_83b010d4-7f1a-448c-9475-176347962cb2, _SellingPlayer, S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, 1)
AND
SpeakerGetDialog(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, 0, _, _DialogID)
AND
DB_Players(_Player)
AND
SpeakerGetDialog(_Player, 0, _, _DialogID)
THEN
SetFlag((FLAG)PLA_ZhentDungeon_State_SoldCompromisedShipmentToZarys_4223b884-ecc1-dec4-626b-a55c076643f0, _Player);
PROC_ForceStopDialog(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca);

IF
MovedFromTo(S_PLA_ZhentShipment_Chest_fc3f4359-ec62-4cbf-8756-ecb9780c34e8, _SellingPlayer, S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, 1)
AND
IsLocked(S_PLA_ZhentShipment_Chest_fc3f4359-ec62-4cbf-8756-ecb9780c34e8, 0)
AND
SpeakerGetDialog(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, 0, _, _DialogID)
AND
DB_Players(_Player)
AND
SpeakerGetDialog(_Player, 0, _, _DialogID)
THEN
SetFlag((FLAG)PLA_ZhentDungeon_State_SoldCompromisedShipmentToZarys_4223b884-ecc1-dec4-626b-a55c076643f0, _Player);
PROC_ForceStopDialog(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca);

// Try to start a dialog where Zarys will give her reason for attacking then start combat, or start combat as fallback.
IF
DialogEnded(PLA_ZhentDungeon_Zhent02_0cd5e00a-6490-e165-7cf7-b31bed8dd898, _)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_DeliveredUnlockedChest_e0d1eda7-7ad4-48d2-a12c-7c554ffe4fdd)
AND
DB_Players(_Player)
AND
GetFlag(PLA_ZhentDungeon_State_SoldCompromisedShipmentToZarys_4223b884-ecc1-dec4-626b-a55c076643f0, _Player, 1)
AND
NOT QRY_StartDialog(PLA_ZhentDungeon_Zhent02_0cd5e00a-6490-e165-7cf7-b31bed8dd898, S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, _Player)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72, 0);

IF
FlagSet(PLA_ZhentShipment_State_DeliveredUnlockedChest_e0d1eda7-7ad4-48d2-a12c-7c554ffe4fdd, _, _)
THEN
SetFlag(PLA_ZhentDungeon_State_TrapDialogueInProgress_fbe1f682-fea0-44f6-ab2a-d454cc151c12, NULL_00000000-0000-0000-0000-000000000000, 0); //Zhentarim move upstairs.

IF
DialogEnded(PLA_ZhentDungeon_Zhent02_0cd5e00a-6490-e165-7cf7-b31bed8dd898, _)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_DeliveredUnlockedChest_e0d1eda7-7ad4-48d2-a12c-7c554ffe4fdd)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72, 0);

//END_REGION

//REGION The imprisoned Gnoll Zhent

IF
FlagSet(PLA_ZhentDungeon_State_JoinedZhent_f952fd87-42f8-2633-f1b5-7e925138d56f, _, _)
THEN
DB_DontCreateMurder(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
PROC_RemoveDBTrespassTrigger(S_PLA_ZhentDungeon_TrapTrespass_638c0b6b-02f0-450c-b7f0-772840763d7b, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "TIED_TO_CHAIR", _, _)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
DB_Dialogs(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, PLA_ZhentShipment_Agent_001_TiedUp_3fb799d1-a452-2121-f933-faa8803116bf);
SetFaction(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (FACTION)Act1_PLA_ZhentDungeon_CapturedZhent_c0b1ad4c-f7cb-4db0-a472-4289162f8b54);
PROC_SetRelationMutual((FACTION)ACT1_PLA_HideoutZhents_339b19c5-f1fb-1389-44b9-a9d31965b560, (FACTION)Act1_PLA_ZhentDungeon_CapturedZhent_c0b1ad4c-f7cb-4db0-a472-4289162f8b54, 51); // true neutral relation between Zhent and Rugan
PROC_CharacterDisableCrime(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "Trespassing");

PROC
PROC_FlagReactionAfterDialog(
	(CHARACTER)_Player, 
	(FLAG)PLA_ZhentDungeon_Event_KillTiedZhent_2964b502-35c6-1fd0-e153-ec5bafdb4ca4, 
	(DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_TiedUp_3fb799d1-a452-2121-f933-faa8803116bf)
AND
DB_Players(_Player)
AND
NOT DB_Dead(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
THEN
Die(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4,DEATHTYPE.DoT,0);
PROC_CharacterRegisterCrime(_Player, "Murder", NULL_00000000-0000-0000-0000-000000000000, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, 0);

IF
DialogEnded(PLA_ZhentShipment_Agent_001_TiedUp_3fb799d1-a452-2121-f933-faa8803116bf, _)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_AgentFreed_c76fac51-f641-3c4b-9710-8b1fb93db25f)
AND
HasActiveStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "TIED_TO_CHAIR", 1)
THEN
EndRepose(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
RemoveStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "TIED_TO_CHAIR");

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968, (INTEGER)_ID)
AND
GetDistanceTo(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, S_PLA_ZhentDungeon_GnollZhentTrigger2_000_a5bf59f9-b7ea-4d95-a647-93292a940274, _Dist)
AND
_Dist <= 3.0
THEN
PROC_DialogAddSpeakingActor(_ID, S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c);

IF
FlagSet(PLA_ZhentDungeon_State_JoinedZhent_f952fd87-42f8-2633-f1b5-7e925138d56f, _, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
CharacterMoveTo((CHARACTER)_Player, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "Walk", "PLA_ZhentDungeon_ExecuteAgent");

IF
EntityEvent(_Player, "PLA_ZhentDungeon_ExecuteAgent")
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_Agent_001_ReadyForExecution_42897631-a3cc-3b5c-bfa5-08e3b4356972)
THEN
Attack((CHARACTER)_Player, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, 1);

IF
AttackedBy(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _AttackerOwner, _Attacker, _, _, _, _)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_Agent_001_ReadyForExecution_42897631-a3cc-3b5c-bfa5-08e3b4356972)
AND
DB_DialogName(PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968, _Inst)
AND
DialogRemoveActorFromDialog(_Inst, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, 1)
AND
QRY_GetCharacterOwnerIfItemSummon(_AttackerOwner,_Attacker)
AND
DB_QRYRTN_GetCharacterOwnerIfItemSummon(_ResolvedAttacker)
THEN
Die(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, DEATHTYPE.Physical, _AttackerOwner, 1, 0);

IF
DialogEnded(PLA_ZhentDungeon_Zhent02_Trap_1e0f9dc3-8697-676c-1867-8695806ba968, _)
AND
NOT DB_PermaDefeated(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_JoinedZhent_f952fd87-42f8-2633-f1b5-7e925138d56f)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
Die(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, DEATHTYPE.Physical, _Player, 1, 0);

IF
StatusRemoved(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "TIED_TO_CHAIR", _, _)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_JoinedZhent_f952fd87-42f8-2633-f1b5-7e925138d56f)
AND
GetFaction(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Faction)
THEN
PROC_SetRelationMutual(_Faction, (FACTION)ACT1_PLA_HideoutZhents_339b19c5-f1fb-1389-44b9-a9d31965b560, 0);
PROC_RemoveAllDialogEntriesForSpeaker(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
SetHasDialog(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4,0);
SetFlag(PLA_ZhentDungeon_State_ZhentFreed_c76fac51-f641-3c4b-9710-8b1fb93db25f, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(PLA_ZhentDungeon_State_AgentFreed_c76fac51-f641-3c4b-9710-8b1fb93db25f, NULL_00000000-0000-0000-0000-000000000000, _ID)
AND
_ID != 0
THEN
DB_OnlyOnce("PLA_ZhentShipment_Agent_001_Thank");

IF
StatusRemoved(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "TIED_TO_CHAIR", _, _)
AND
QRY_OnlyOnce("PLA_ZhentShipment_Agent_001_Thank")
THEN
EndRepose(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
DB_PLA_TiedZhentFreed(1);
DB_Dialogs(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, DIALOGRESOURCEGUID_PLA_ZhentShipment_Agent_001_ba3b62b6-9ca9-2e36-eec0-8d7272a14c8a);
DB_SpotPlayers(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_Agent_001_Thank", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_Agent_001_Thank", _Player)
AND
QRY_SelectAndStartDialog(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Player)
THEN
DB_NOOP(1);

IF
DialogEnded(PLA_ZhentShipment_Agent_001_TiedUp_3fb799d1-a452-2121-f933-faa8803116bf, _)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_AgentFreed_c76fac51-f641-3c4b-9710-8b1fb93db25f)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
SetHasDialog(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4,0);

IF
DB_GlobalFlag(PLA_ZhentDungeon_State_AgentFreed_c76fac51-f641-3c4b-9710-8b1fb93db25f)
AND
NOT DB_CantAct(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
NOT DB_CantMove(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
GetFaction(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 100);
PROC_DisappearOutOfSight(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "Run", 0, "PLA_ZhentDungeon_RuganEscaped");
PROC_GenericsClearBusyDialog(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);

IF
DialogActorJoined(_,_,S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4,_)
AND
DB_DisappearedOutOfSight(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4,_,_,_,"PLA_ZhentDungeon_RuganEscaped",_,_)
THEN
DB_PLA_ZhentDungeon_PausedRuganDisappear(1);
PROC_CancelDisappearOutOfSight(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);

IF
DialogActorLeft(_,_,S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4,_)
AND
DB_PLA_ZhentDungeon_PausedRuganDisappear(1)
THEN
NOT DB_PLA_ZhentDungeon_PausedRuganDisappear(1);
PROC_DisappearOutOfSight(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "Run", 0, "PLA_ZhentDungeon_RuganEscaped");
PROC_GenericsClearBusyDialog(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);

IF
DB_Is_InCombat(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _ID)
AND
NOT DB_OnlyOnce("PLA_ZhentsHostileAfterAgentFreed")
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_AgentFreed_c76fac51-f641-3c4b-9710-8b1fb93db25f)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
AND
DB_Is_InCombat(_Zhent, _ID)
THEN
DB_SpotPlayers((CHARACTER)_Zhent, "PLA_ZhentDungeon_AgentEscape", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IgnoreCombat(_Zhent, "PLA_ZhentDungeon_AgentEscape");
DB_SpotPlayers_Continuous(_Zhent, "PLA_ZhentDungeon_AgentEscape");
DB_SpotPlayers_IncludeSummons(_Zhent, "PLA_ZhentDungeon_AgentEscape");
DB_SpotPlayers_IncludeFollowers(_Zhent, "PLA_ZhentDungeon_AgentEscape");
DB_SpotPlayers_IncludeWildshapedPlayers(_Zhent, "PLA_ZhentDungeon_AgentEscape");

PROC
PROC_SpotPlayers_Spotted(_, "PLA_ZhentDungeon_AgentEscape", _)
THEN
PROC_SetRelationToPlayers(ACT1_PLA_HideoutZhents_339b19c5-f1fb-1389-44b9-a9d31965b560, 0);

IF
LeftCombat(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, _)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
THEN
PROC_SpotPlayers_StopSpotting((CHARACTER)_Zhent, "PLA_ZhentDungeon_AgentEscape");

IF
EntityEvent(_, "PLA_ZhentDungeon_RuganEscaped")
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
THEN
PROC_SpotPlayers_StopSpotting((CHARACTER)_Zhent, "PLA_ZhentDungeon_AgentEscape");

IF
EntityEvent(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentDungeon_RuganEscaped")
THEN
PROC_CharacterEnableCrime((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "Trespassing");

IF
EnteredCombat(_Player, _ID)
AND
NOT DB_OnlyOnce("PLA_ZhentsHostileAfterAgentFreed")
AND
QRY_IsPartyMember((CHARACTER)_Player, 1)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_AgentFreed_c76fac51-f641-3c4b-9710-8b1fb93db25f)
AND
DB_Is_InCombat(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _ID)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
AND
DB_Is_InCombat(_Zhent, _ID)
AND
NOT DB_OnlyOnce("PLA_ZhentsHostileAfterAgentFreed")
THEN
PROC_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed(_Player);

IF
EnteredCombat(_Zhent, _ID)
AND
NOT DB_OnlyOnce("PLA_ZhentsHostileAfterAgentFreed")
AND
DB_GLO_DefeatCounter((CHARACTER)_Zhent, "PLA_ZhentDungeon_DefeatCounter")
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_AgentFreed_c76fac51-f641-3c4b-9710-8b1fb93db25f)
AND
DB_Is_InCombat(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _ID)
AND
DB_Is_InCombat(_Player, _ID)
AND
QRY_IsPartyMember((CHARACTER)_Player, 1)
AND
NOT DB_OnlyOnce("PLA_ZhentsHostileAfterAgentFreed")
THEN
PROC_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed(_Player);

PROC
PROC_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed(_Player)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
AND
QRY_SpeakerIsAvailable(_Zhent, 1)
AND
GetDistanceTo(_Zhent, _Player, _Distance)
THEN
DB_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed(_Zhent, _Distance);

IF
DB_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed(_Zhent, _Distance)
AND
DB_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed(_Zhent2, _Distance2)
AND
_Zhent != _Zhent2
AND
_Distance2 >= _Distance
THEN
NOT DB_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed(_Zhent2, _Distance2);

PROC
PROC_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed((CHARACTER)_Player)
AND
DB_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed(_Zhent, _)
AND
QRY_StartDialog(PLA_ZhentDungeon_Zhents_AD_ZhentAgentEscape_309ffdf2-cd6a-9402-c57b-55bd2e36edc8, _Zhent)
THEN
DB_OnlyOnce("PLA_ZhentsHostileAfterAgentFreed");

PROC
PROC_PLA_ZhentDungeon_ZhentsHostileAfterAgentFreed(_)
THEN
DB_Dialogs(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, DIALOGRESOURCEGUID_PLA_ZhentShipment_Agent_001_ba3b62b6-9ca9-2e36-eec0-8d7272a14c8a);
DB_SpotPlayers(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_Agent_001_Thank", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_OnlyOnce("PLA_ZhentsHostileAfterAgentFreed");
//END_REGION

//REGION Explosives
PROC
PROC_PLA_ZhentDungeon_InitFuseSize()
AND
GetSurfaceSize(S_PLA_ZhentDungeon_Fuse_013_7eef86ef-c010-4d88-ace9-c61739131cf9, "Ground", _Size)
THEN
DB_PLA_ZhentDungeon_StartFuseSize(_Size);

QRY
QRY_PLA_ZhentDungeon_FuseInterrupted()
AND
GetSurfaceGroundAt(S_PLA_ZhentDungeon_Fuse_013_7eef86ef-c010-4d88-ace9-c61739131cf9, "SurfaceOil")
AND
GetSurfaceSize(S_PLA_ZhentDungeon_Fuse_013_7eef86ef-c010-4d88-ace9-c61739131cf9, "Ground", _Size)
AND
DB_PLA_ZhentDungeon_StartFuseSize(_OriginalSize)
AND
IntegerProduct(_Size, 2, _TargetSize)
AND
_TargetSize < _OriginalSize
THEN
DB_NOOP(1);

IF
DB_PLA_ZhentDungeon_Fuses(_Item)
THEN
SetVisible(_Item, 0);

IF
StatusAttempt(_Item, "BURNING", _, _)
AND
DB_PLA_ZhentDungeon_Fuses(_Item)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_Event_FireArrow_36714058-9c1a-9fea-33e3-25f7078aff57)
THEN
PROC_PLA_ZhentDungeon_ExplosivesTriggered();

PROC
PROC_PLA_ZhentDungeon_ExplosivesTriggered()
AND
DB_GLO_DefeatCounter(_NPC, "PLA_ZhentDungeon_DefeatCounter")
THEN
PROC_ForceStopDialog(_NPC);

PROC
PROC_PLA_ZhentDungeon_ExplosivesTriggered()
AND
QRY_OnlyOnce("PLA_ZhentDungeon_ExplosivesTriggered_FallBack")
THEN
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
SetFlag(PLA_ZhentDungeon_Zhent02_State_GetToLadder_c281ffaa-413e-40c5-ba02-7fe3f4ae92cd, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(PLA_ZhentDungeon_Event_FireArrow_36714058-9c1a-9fea-33e3-25f7078aff57, NULL_00000000-0000-0000-0000-000000000000, _)
AND
GetDistanceTo(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, S_PLA_ZhentDungeon_FuseLightBrazier_0669f832-852b-4868-beed-c4a333222ad8, _Dist)
AND
_Dist <= 5.5
THEN
DB_OnlyOnce("PLA_ZhentDungeon_FuseLight");
ApplyStatus(S_PLA_ZhentDungeon_FuseLightBrazier_0669f832-852b-4868-beed-c4a333222ad8, "BURNING", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
UseSpell(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "Target_Dip", S_PLA_ZhentDungeon_FuseLightBrazier_0669f832-852b-4868-beed-c4a333222ad8);

IF
FlagSet(PLA_ZhentDungeon_Event_FireArrow_36714058-9c1a-9fea-33e3-25f7078aff57, NULL_00000000-0000-0000-0000-000000000000, _)
AND
NOT DB_OnlyOnce("PLA_ZhentDungeon_FuseLight")
AND
GetDistanceTo(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, S_PLA_ZhentDungeon_FuseLightBrazier_2_4f16d514-074d-46c5-996d-01a7be62a637, _Dist)
AND
_Dist <= 5.5
THEN
DB_OnlyOnce("PLA_ZhentDungeon_FuseLight");
ApplyStatus(S_PLA_ZhentDungeon_FuseLightBrazier_0669f832-852b-4868-beed-c4a333222ad8, "BURNING", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
UseSpell(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "Target_Dip", S_PLA_ZhentDungeon_FuseLightBrazier_2_4f16d514-074d-46c5-996d-01a7be62a637);

IF
StatusApplied(_Bow, "DIPPED_FIRE", _, _)
AND
DB_OnlyOnce("PLA_ZhentDungeon_FuseLight")
AND
GetEquippedWeapon(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, (ITEM)_Bow)
AND
GetPosition(S_PLA_ZhentDungeon_Fuse_013_7eef86ef-c010-4d88-ace9-c61739131cf9, _X, _Y, _Z)
THEN
PROC_PLA_ZhentDungeon_ExplosivesTriggered();
UseSpellAtPosition(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "Projectile_MainHandAttack", _X, _Y, _Z);
NOT DB_OnlyOnce("PLA_ZhentDungeon_FuseLight");

IF
DB_PermaDefeated((CHARACTER)S_PLA_ZhentDungeon_Zhent07_32f7a4dc-d7a8-4e89-875c-3f3722879fbb)
AND
NOT DB_PermaDefeated((CHARACTER)S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077)
AND
NOT DB_OnlyOnce("PLA_ZhentDungeon_CaughtUpDialogue")
THEN
SetOwner((ITEM)S_PLA_ZhentDungeon_Defense_TrapLever_50f5c39e-8b66-4214-b98a-e1cbbea63dc3, (CHARACTER)S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077);
SetOriginalOwner((ITEM)S_PLA_ZhentDungeon_Defense_TrapLever_50f5c39e-8b66-4214-b98a-e1cbbea63dc3, (CHARACTER)S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077);

IF
DB_PermaDefeated((CHARACTER)S_PLA_ZhentDungeon_Zhent07_32f7a4dc-d7a8-4e89-875c-3f3722879fbb)
AND
DB_PermaDefeated((CHARACTER)S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077)
AND
NOT DB_PermaDefeated((CHARACTER)S_PLA_ZhentDungeon_Zhent08_3f629653-f427-43f9-92ac-89324de5ec11)
AND
NOT DB_OnlyOnce("PLA_ZhentDungeon_CaughtUpDialogue")
THEN
SetOwner((ITEM)S_PLA_ZhentDungeon_Defense_TrapLever_50f5c39e-8b66-4214-b98a-e1cbbea63dc3, (CHARACTER)S_PLA_ZhentDungeon_Zhent08_3f629653-f427-43f9-92ac-89324de5ec11);
SetOriginalOwner((ITEM)S_PLA_ZhentDungeon_Defense_TrapLever_50f5c39e-8b66-4214-b98a-e1cbbea63dc3, (CHARACTER)S_PLA_ZhentDungeon_Zhent08_3f629653-f427-43f9-92ac-89324de5ec11);

//END_REGION

//REGION Catchup To The Zhent

IF
EntityEvent(_, "PLA_ZhentMovedPastLadder")
THEN
DB_SpotPlayers_CustomRadius(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", 12.0);
SetFlag((FLAG)PLA_ZhentDungeon_StartSpot_eaa4e6ca-ca1e-40ef-97a8-dbbbb7756e9a, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
DB_SpotPlayers_SpotEvent(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", "PLA_Zhent02_Spotted_02");

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196)
AND
NOT DB_OnlyOnce("PLA_ZhentDungeon_CaughtUpDialogue")
THEN
PROC_TryStartAD(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_AD_CaughtUp_8bea8bd7-63e8-b07a-c55f-fc5b7925ae5d, CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca);

PROC
PROC_StateSet_PermaDefeated(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72, 0);
PROC_SetRelationToPlayers(Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, 0);

PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded(DIALOGRESOURCEGUID_PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196)
THEN
PROC_SpotPlayers_StopSpotting(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon");
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72, 0);


IF
EntityEvent(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon_ReachedLift")
AND
DB_SpotPlayers_CustomRadius(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", _OldRange)
THEN
NOT DB_SpotPlayers_CustomRadius(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", _OldRange);
//END_REGION

//REGION Repairing lift

IF
Unlocked(S_PLA_ZhentDungeon_LiftDown_Broken_c28dd7c5-6c55-41e5-9e26-6a4aa70e0e63, _, _)
THEN
SetCanInteract(S_PLA_ZhentDungeon_LiftDown_Broken_c28dd7c5-6c55-41e5-9e26-6a4aa70e0e63, 0);
SetFlag(PLA_ZhentDungeon_State_LiftFixed_dd69a326-4346-23bf-e25b-bed93fca037e, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_PLA_ZhentDungeon_Portal(_Portal)
THEN
SetTag(_Portal, (TAG)NO_PATHFINDING_PORTAL_d9793375-20f0-437f-8033-011014b0b9ca);

IF
FlagSet(PLA_ZhentDungeon_State_LiftFixed_dd69a326-4346-23bf-e25b-bed93fca037e, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_PLA_ZhentDungeon_Portal(_Portal)
THEN
ClearTag(_Portal, (TAG)NO_PATHFINDING_PORTAL_d9793375-20f0-437f-8033-011014b0b9ca);
NOT DB_PLA_ZhentDungeon_Portal(_Portal);

PROC
PROC_BlockUseOfItem(_Player, _Portal)
AND
DB_PLA_ZhentDungeon_Portal(_Portal)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_LiftFixed_dd69a326-4346-23bf-e25b-bed93fca037e)
THEN
PROC_TryStartAD(DIALOGRESOURCEGUID_PLA_ZhentDungeon_AD_UseLift_3378c436-e3df-3bed-7980-5f6ed8956166, _Player);
DB_CustomUseItemResponse(_Player, _Portal, 0);

IF
DualEntityEvent(_Player, _Wall, "PLA_CheckInvestigation")
THEN
PROC_TrySkillCheck((CHARACTER)_Player, _Wall, "Investigation", (DIFFICULTYCLASS)DC_Legacy_10_625be976-7a67-4394-97c8-14c69715ae4b, "PLA_BackWallInvestigation");

PROC
PROC_RollResult("PLA_BackWallInvestigation", _Player, _Wall, 1)
THEN
SetEntityEvent(_Player, "PLA_ZhentWallReveal");
PROC_TryStartAD(PLA_ZhentDungeon_PAD_NoticedFakeWall_f6e2ea69-5636-772c-464e-b57a093af98b, _Player);

IF
EnteredTrigger(_Character, S_PLA_ZhentDungeon_WallTrigger_e68e90f7-6646-4dcb-8e4c-13f14b88381b)
THEN
SetEntityEvent(_Character, "PLA_ZhentLiftAreaEntered");
PROC_TriggerUnregisterForParty(S_PLA_ZhentDungeon_WallTrigger_e68e90f7-6646-4dcb-8e4c-13f14b88381b);

//END_REGION

//REGION Zhentarim Combat
//=====================================# Player attacks Zhent #=================================
// Player cause temporary hostility with Zhent -> Zhent try to fall back and become perma hostile.
IF
RelationChanged((FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72, _, 0, 0) // temp hostility
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72, 0);
PROC_SetRelationToPlayers((FACTION)Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, 0);
SetFlag((FLAG)PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d);

//=====================================# Arm the Traps #=================================

//=====================# Deactivate this if the bombs are not remote controlled #==================

//If Zhent01 nearby Attempt to activate the traps
IF
TurnStarted(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
QRY_PLA_ZhentDungeon_ZhentAvailableToActivateTraps(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07)
THEN
PROC_PLA_ZhentDungeon_TryEnablingFallbackMines(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513);

//If Zhent04 nearby Attempt to activate the traps
IF
TurnStarted(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176)
AND
NOT QRY_PLA_ZhentDungeon_ZhentAvailableToActivateTraps((CHARACTER)S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
QRY_PLA_ZhentDungeon_ZhentAvailableToActivateTraps((CHARACTER)S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07)
THEN
PROC_PLA_ZhentDungeon_TryEnablingFallbackMines(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176);

QRY
QRY_PLA_ZhentDungeon_ZhentAvailableToActivateTraps((CHARACTER)_Zhent)
AND
NOT DB_CantAct(_Zhent)
AND
IsInTrigger(_Zhent, S_PLA_ZhentDungeon_CombatArea_7194c7e5-9412-47ce-b543-28f009a9a3c9, 1)
THEN
DB_NOOP(1);

// If no one is enabling the mines yet, try enabling the mines
PROC
PROC_PLA_ZhentDungeon_TryEnablingFallbackMines((CHARACTER)_Zhent)
AND
NOT DB_PLA_ZhentDungeon_FallbackMinesGettingTurnedOn(_)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07)
THEN
DB_PLA_ZhentDungeon_FallbackMinesGettingTurnedOn(1);
Use(_Zhent, S_PLA_ZhentDungeon_Defense_TrapLever_50f5c39e-8b66-4214-b98a-e1cbbea63dc3, "PLA_ZhentDungeon_ActivateTraps");

IF
DB_GlobalFlag(PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07)
AND
DB_PLA_ZhentDungeon_FallbackMinesGettingTurnedOn(1)
THEN
NOT DB_PLA_ZhentDungeon_FallbackMinesGettingTurnedOn(1);

IF
DualEntityEvent(_, _Player, "PLA_ZhentDungeon_Defense_TrapLever")
AND
DB_PartyMembers((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d)
AND
NOT GetRelation(ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0)
THEN
PROC_TryStartAD((DIALOGRESOURCE)PLA_ZhentDungeon_Zhent07_AD_TrapsActivated_70a8161f-bb44-bb69-0773-3b693cb68de3, S_PLA_ZhentDungeon_Zhent07_32f7a4dc-d7a8-4e89-875c-3f3722879fbb);
PROC_SetRelationToPlayers(ACT1_PLA_HideoutZhents_Inside_202629fa-35bb-2f4f-faa5-18e9b6930b72, 0);
PROC_SetRelationToPlayers(Act1_Pla_HideoutZhents_Inside_Back_7598248e-0293-412b-b665-413a9b12cefc, 0);

IF
DualEntityEvent(_, _, "PLA_ZhentDungeon_Defense_TrapLever")
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07);

IF
DualEntityEvent(_, _, "PLA_ZhentDungeon_Defense_TrapLever_Deactivated")
THEN
PROC_GlobalClearFlagAndCache((FLAG)PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07);

IF
FlagSet(PLA_ZhentDungeon_State_ZhentFallingBack_23e80cd7-cf99-4f3b-8085-80a188058a93, _Zhent, _)
THEN
DB_PLA_ZhentDungeon_ZhentFallingBack(_Zhent);
DB_PLA_ZhentDungeon_ZhentAreFallingBack(1);

IF
FlagCleared(PLA_ZhentDungeon_State_ZhentFallingBack_23e80cd7-cf99-4f3b-8085-80a188058a93, _Zhent, _)
AND
DB_PLA_ZhentDungeon_ZhentFallingBack(_Zhent)
THEN
NOT DB_PLA_ZhentDungeon_ZhentFallingBack(_Zhent);

// Wait for anyone who is still running to arrive
IF
DB_PLA_ZhentDungeon_ZhentAreFallingBack(1)
AND
NOT DB_PLA_ZhentDungeon_ZhentFallingBack(_)
THEN
NOT DB_PLA_ZhentDungeon_ZhentAreFallingBack(1);
PROC_PLA_ZhentDungeon_ActivateFallbackMines();

// If Zhent01 is where he should be, activate trap
PROC
PROC_PLA_ZhentDungeon_ActivateFallbackMines()
AND
QRY_PLA_ZhentDungeon_ZhentAvailableToActivateTraps(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07)
THEN
PROC_PLA_ZhentDungeon_TryEnablingFallbackMines(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513);

// If Zhent04 is where he should be, activate trap
PROC
PROC_PLA_ZhentDungeon_ActivateFallbackMines()
AND
NOT QRY_PLA_ZhentDungeon_ZhentAvailableToActivateTraps(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513)
AND
QRY_PLA_ZhentDungeon_ZhentAvailableToActivateTraps(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07)
THEN
PROC_PLA_ZhentDungeon_TryEnablingFallbackMines(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176);

//=======================================================================================
//END_REGION

//REGION Doubting Artist
IF
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
THEN
TriggerRegisterForCharacter(S_PLA_Doubting_ZhentarimOnPath_841ba6fe-e3e8-4e37-acd0-1e5d490740c2,(CHARACTER)_Zhent);

IF
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_FF")
THEN
TriggerRegisterForCharacter(S_PLA_Doubting_ZhentarimOnPath_841ba6fe-e3e8-4e37-acd0-1e5d490740c2,(CHARACTER)_Zhent);

IF
LeftTrigger(_,S_PLA_Doubting_ZhentarimOnPath_841ba6fe-e3e8-4e37-acd0-1e5d490740c2)
AND
NOT DB_InRegion(_,S_PLA_Doubting_ZhentarimOnPath_841ba6fe-e3e8-4e37-acd0-1e5d490740c2)
THEN
SetFlag(PLA_DoubtingArtist_State_FreeNoMoreZhent_31e7355f-9904-47e4-af13-e790a3efcde8,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_StateSet_PermaDefeated((GUIDSTRING)_Zhent)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
AND
NOT DB_InRegion(_,S_PLA_Doubting_ZhentarimOnPath_841ba6fe-e3e8-4e37-acd0-1e5d490740c2)
THEN
SetFlag(PLA_DoubtingArtist_State_FreeNoMoreZhent_31e7355f-9904-47e4-af13-e790a3efcde8,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_StateSet_PermaDefeated((GUIDSTRING)_Zhent)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_FF")
AND
NOT DB_InRegion(_,S_PLA_Doubting_ZhentarimOnPath_841ba6fe-e3e8-4e37-acd0-1e5d490740c2)
THEN
SetFlag(PLA_DoubtingArtist_State_FreeNoMoreZhent_31e7355f-9904-47e4-af13-e790a3efcde8,NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(PLA_DoubtingArtist_State_FreeNoMoreZhent_31e7355f-9904-47e4-af13-e790a3efcde8,NULL_00000000-0000-0000-0000-000000000000,0)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
THEN
TriggerUnregisterForCharacter(S_PLA_Doubting_ZhentarimOnPath_841ba6fe-e3e8-4e37-acd0-1e5d490740c2,(CHARACTER)_Zhent);

IF
FlagSet(PLA_DoubtingArtist_State_FreeNoMoreZhent_31e7355f-9904-47e4-af13-e790a3efcde8,NULL_00000000-0000-0000-0000-000000000000,0)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_FF")
THEN
TriggerUnregisterForCharacter(S_PLA_Doubting_ZhentarimOnPath_841ba6fe-e3e8-4e37-acd0-1e5d490740c2,(CHARACTER)_Zhent);

IF
UseStarted(S_PLA_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd,S_PLA_ZhentDungeon_LadderUp_46b911d0-321f-431e-9936-33c793943b78)
THEN
PROC_DisappearOutOfSightTo(S_PLA_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd,S_PLA_Cellar_LadderUp_322be7d0-bd42-4919-84e5-c7c90245be63,"Run",0,"PLA_DoubtingArtistDisappeared");

IF
EntityEvent(_, "PLA_ZhentDungeon_DoubtingArtist_Hostile")
THEN
PROC_SetRelationToPlayers(ACT1_PLA_DoubtingArtist_d800ec60-240e-49e8-9b26-f0a90416c4a0, 0);

PROC
PROC_LevelBecameUnreachable("WLD_Main_A")
AND
QRY_PLA_DoubtingArtist_CheckIfFreed()
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_DoubtingArtist","ZhentDungeon_LeftForBG")
THEN
QuestUpdate("GLO_DoubtingArtist","ZhentDungeon_LeftLevelOskarFree");
SetFlag((FLAG)LOW_OskarsBeloved_State_ArtistLeftHideout_76dca7be-5c6a-4444-afa4-3ae4b13d6315);
QuestSetCategory("GLO_DoubtingArtist", "BaldursGate");

PROC
PROC_LevelBecameUnreachable("WLD_Main_A")
AND
NOT QRY_PLA_DoubtingArtist_CheckIfFreed()
AND
DB_QuestIsOpened("GLO_DoubtingArtist")
THEN
QuestUpdate("GLO_DoubtingArtist","LeftDidntSave");

IF
QuestUpdateUnlocked(_, "GLO_DoubtingArtist", "ZhentDungeon_LeftForBG")
THEN
QuestSetCategory("GLO_DoubtingArtist", "BaldursGate");

QRY
QRY_PLA_DoubtingArtist_CheckIfFreed()
AND
DB_PLA_DoubtingArtist_FreedFlags(_Flag)
AND
DB_GlobalFlag(_Flag)
THEN
DB_NOOP(1);


//END_REGION

//REGION Doubting Artist Dialog Manager
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)PLA_ZhentDungeon_DoubtingArtist_4c065742-3512-2eed-ff15-adb10d46e365, (INTEGER)_ID)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_JoinedZhent_f952fd87-42f8-2633-f1b5-7e925138d56f)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd)
THEN
PROC_DialogAddSpeakingActor(_ID, S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176);

IF
FlagSet(PLA_DoubtingArtist_State_Cowering_c6a3f02f-af54-4448-9617-0aaf4c99c429,_,_)
THEN
DialogRequestStop(S_PLA_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd);
PROC_RemoveAllDialogEntriesForSpeaker(S_PLA_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd);
DB_AD_Dialog(S_PLA_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd,PLA_ZhentDungeon_DoubtingArtist_AD_Cowering_81706fb0-3cb4-c249-ba98-c2180b2237f8);

IF
FlagCleared(PLA_DoubtingArtist_State_Cowering_c6a3f02f-af54-4448-9617-0aaf4c99c429,_,_)
THEN
PROC_RemoveNPCADs(S_PLA_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd);

IF
FlagCleared(PLA_DoubtingArtist_State_Cowering_c6a3f02f-af54-4448-9617-0aaf4c99c429,_,_)
AND
GetFlag(PLA_DoubtingArtist_State_Leaving_201c1ed0-ecc3-4c25-8f68-8716bd5ca7ae,NULL_00000000-0000-0000-0000-000000000000,0)
THEN
DB_Dialogs(S_PLA_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd, PLA_ZhentDungeon_DoubtingArtist_4c065742-3512-2eed-ff15-adb10d46e365);

IF
FlagSet(PLA_DoubtingArtist_State_Leaving_201c1ed0-ecc3-4c25-8f68-8716bd5ca7ae,_,_)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_PLA_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd);

//It is considered sufficient to have witnessed the destruction of one painting, if both are destroyed, to be aware that the paintings are destroyed.
IF
DestroyingBy(_Painting, _, _, _)
AND
DB_PLA_DoubtingArtistPaintingDestructionFlag(_Painting, _)
AND
DB_PartyMembers(_PartyMember)
AND
CanSee(_PartyMember, _Painting, 1)
THEN
SetFlag(PLA_DoubtingArtist_Knows_PaintingDestroyed_8b133e61-d325-4e0c-a7c5-0ef5d3961c13, _PartyMember, 0);

IF
DestroyingBy(_Painting, _, _, _)
AND
DB_PLA_DoubtingArtistPaintingDestructionFlag(_Painting, _Flag)
THEN
SetFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION Doubting Artist quest manager
IF
FlagSet(PLA_ZhentDungeon_State_AllPermaDefeated_4dcee939-9346-ebb7-d328-1342e3e1d326,_,_)
AND
GetFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d,NULL_00000000-0000-0000-0000-000000000000,0)
AND
GetFlag(PLA_DoubtingArtist_State_Leaving_201c1ed0-ecc3-4c25-8f68-8716bd5ca7ae,NULL_00000000-0000-0000-0000-000000000000,0)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player,"GLO_DoubtingArtist","ZhentDungeon_FreedByViolence");

IF
FlagSet(PLA_DoubtingArtist_Event_FreedByPersuade_6929a287-8e5a-2710-063b-a86b4803c267, _, _)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player,"GLO_DoubtingArtist", "ZhentDungeon_FreedByPersuade");
//END_REGION

//REGION Doubting Artist Paintings
IF
Moved(_Painting)
AND
DB_PLA_DoubtingArtistPaintings(_Painting)
THEN
NOT DB_PLA_DoubtingArtistPaintings(_Painting);
SetEntityEvent(S_PLA_ZhentDungeon_Melee_01_8f63a70b-93e1-4841-8dea-b1f1542fd3c1,"PLA_CheckPaintings");

IF
EntityEvent(S_PLA_ZhentDungeon_Melee_01_8f63a70b-93e1-4841-8dea-b1f1542fd3c1,"PLA_CheckPaintings")
AND
NOT DB_PLA_DoubtingArtistPaintings(_)
THEN
SetEntityEvent(S_PLA_ZhentDungeon_Melee_01_8f63a70b-93e1-4841-8dea-b1f1542fd3c1,"PLA_NoMorePainting");
//END_REGION

//REGION Reward for helping the Zhentarim

IF
FlagSet(PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d, _, _)
THEN
SetCanTrade(S_PLA_ZhentDungeon_Zhent01_85e11906-83ea-4f2f-b5cb-f1e2a6710513, 1);
SetCanTrade(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, 1);
SetCanTrade(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, 1);
SetCanTrade(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, 1);
SetCanTrade(S_PLA_ZhentDungeon_Zhent05_356c9a7d-1f9d-4a51-8d9b-6908f16f7b7d, 1);
// Disarm traps



IF
FlagSet(PLA_ZhentDungeon_State_AllowedSpecialTrade_1bba9a5b-8d05-4dc1-9df1-b6d3c3a382c6, _, _)
THEN
PROC_SetCustomTradeTreasure(S_PLA_ZhentDungeon_Zhent03_8f63a70b-93e1-4841-8dea-b1f1542fd3c1, "PLA_ZhentarimTrader");

//END_REGION

//REGION Sending away Zhentarim chest
PROC
PROC_PLA_ZhentDungeon_GnollAgentsToDungeon()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_Quest_Intimidated_641d7a2e-724a-1533-41a9-9d074a5de560)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_Persuaded_0cc48ea5-9dad-42f1-bf61-d609bd83b914)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
AND
NOT DB_Defeated(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
THEN
PROC_PLA_ZhentDungeon_SendChestAway();

IF
LeftTrigger(_PartyMember, S_PLA_ZhentDungeon_SUB_e9d974cf-01b9-4493-a618-79494cd00fd9)
AND
DB_PartyMembers(_PartyMember)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_AllDefeated_a870d184-006a-d1f5-9eb5-29b31cb0f30f)
AND
NOT QRY_CheckOtherPartyMembersInTrigger(_PartyMember, S_PLA_ZhentDungeon_SUB_e9d974cf-01b9-4493-a618-79494cd00fd9)
AND
GetInventoryOwner(S_PLA_ZhentShipment_Chest_fc3f4359-ec62-4cbf-8756-ecb9780c34e8, _Character)
AND
DB_GLO_DefeatCounter(_Character, "PLA_ZhentDungeon_DefeatCounter")
AND
IsInTrigger(_Character, S_PLA_ZhentDungeon_SUB_e9d974cf-01b9-4493-a618-79494cd00fd9, 1)
THEN
PROC_PLA_ZhentDungeon_SendChestAway();

PROC
PROC_PLA_ZhentDungeon_ZhentsLeave()
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_AllDefeated_a870d184-006a-d1f5-9eb5-29b31cb0f30f)
AND
GetInventoryOwner(S_PLA_ZhentShipment_Chest_fc3f4359-ec62-4cbf-8756-ecb9780c34e8, _Character)
AND
DB_GLO_DefeatCounter(_Character, "PLA_ZhentDungeon_DefeatCounter")
AND
IsInTrigger(_Character, S_PLA_ZhentDungeon_SUB_e9d974cf-01b9-4493-a618-79494cd00fd9, 1)
THEN
PROC_PLA_ZhentDungeon_SendChestAway();

PROC
PROC_PLA_ZhentDungeon_SendChestAway()
THEN
DB_NOOP(1);
//END_REGION

//REGION Activating Banter

PROC
PROC_LongRest()
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_AllDefeated_a870d184-006a-d1f5-9eb5-29b31cb0f30f) // flagType: Global
AND
QRY_OnlyOnce("PartyBanterTrigger_PLA_HideoutCleared")
THEN
PROC_RegisterWorldGossipTrigger(S_PartyBanterTrigger_PLA_HighHideoutCleared_1a961eb7-58dc-42a9-9e0c-ef17f54dc40c);
PROC_RegisterWorldGossipTrigger(S_PartyBanterTrigger_PLA_LowHideoutCleared_95817c18-e042-482d-ae32-6a5438c6cb23);

PROC
PROC_LongRest()
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d)
AND
DB_GlobalFlag(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
AND
QRY_OnlyOnce("PartyBanterTrigger_PLA_HideoutCleared")
THEN
PROC_RegisterWorldGossipTrigger(S_PartyBanterTrigger_PLA_HighHideoutCleared_1a961eb7-58dc-42a9-9e0c-ef17f54dc40c);
PROC_RegisterWorldGossipTrigger(S_PartyBanterTrigger_PLA_LowHideoutCleared_95817c18-e042-482d-ae32-6a5438c6cb23);

//END_REGION

//REGION Corridor trap
// From dialog
IF
FlagSet(PLA_ZhentDungeon_Event_TrapsTriggeredInDialog_0f317e00-3986-de51-2462-97c309077c57, _, _)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_CorridorTrap_State_Active_5f9e8d89-463f-4d86-9d17-b05cc89e6cb3)
AND
NOT DB_Defeated(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_StopTriggerTraps_d35a34e2-9850-46c8-85bf-04efc6b9e8cb)
THEN
Use(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, S_PLA_ZhentDungeon_TrapLever_4e0d91a8-48f4-4e3a-963c-52c0f89b88a0, 1, 0, "");
PROC_GlobalSetFlagAndCache((FLAG)PLA_ZhentDungeon_State_StopTriggerTraps_d35a34e2-9850-46c8-85bf-04efc6b9e8cb);

// If trap is active before Zarys gives free passage, disable the trap again.
IF
FlagSet((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d, _, _)
AND
DB_GlobalFlag(PLA_ZhentDungeon_CorridorTrap_State_Active_5f9e8d89-463f-4d86-9d17-b05cc89e6cb3)
AND
NOT DB_Defeated(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176)
THEN
Use(S_PLA_ZhentDungeon_Zhent04_50c17970-3683-4417-b4f3-bd1e117e3176, S_PLA_ZhentDungeon_TrapLever_4e0d91a8-48f4-4e3a-963c-52c0f89b88a0, 1, 0, "");

// For the case when dialog ended prematurely, without setting any trap-related flags
PROC
PROC_PLA_ZhentDungeon_ChaseDialogEnded((GUIDSTRING)PLA_ZhentDungeon_Zhent02_Stage1_ea84574d-5a57-df6a-bd53-075fda897f12)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_Event_TrapsTriggeredInDialog_0f317e00-3986-de51-2462-97c309077c57)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_Event_ArmCorridorTraps_1a1425b1-7926-46ac-b2cd-58a58ee99f5d)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_StopTriggerTraps_d35a34e2-9850-46c8-85bf-04efc6b9e8cb)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentDungeon_Event_TrapsTriggeredInDialog_0f317e00-3986-de51-2462-97c309077c57);

IF
FlagSet(PLA_ZhentDungeon_Event_TrapsTriggeredInDialog_0f317e00-3986-de51-2462-97c309077c57, _, _)
THEN
ClearFlag(PLA_ZhentDungeon_Event_TrapsTriggeredInDialog_0f317e00-3986-de51-2462-97c309077c57, NULL_00000000-0000-0000-0000-000000000000, 0);

// Activation
IF
EntityEvent(_, "PLA_ZhentDungeon_TrapLever_Activate")
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_CorridorTrap_State_Active_5f9e8d89-463f-4d86-9d17-b05cc89e6cb3)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentDungeon_CorridorTrap_State_Active_5f9e8d89-463f-4d86-9d17-b05cc89e6cb3);

IF
EntityEvent(_, "PLA_ZhentDungeon_TrapLever_Activate")
AND
DB_PLA_ZhentDungeon_Traps_Chains(_Chain, _, _Pos1)
THEN
ItemMoveTo(_Chain, _Pos1, 2.0, 0.0, 0, "", 0);

IF
EntityEvent(_, "PLA_ZhentDungeon_TrapLever_Deactivate")
AND
DB_GlobalFlag(PLA_ZhentDungeon_CorridorTrap_State_Active_5f9e8d89-463f-4d86-9d17-b05cc89e6cb3)
THEN
PROC_GlobalClearFlagAndCache(PLA_ZhentDungeon_CorridorTrap_State_Active_5f9e8d89-463f-4d86-9d17-b05cc89e6cb3);

IF
EntityEvent(_, "PLA_ZhentDungeon_TrapLever_Deactivate")
AND
DB_PLA_ZhentDungeon_Traps_Chains(_Chain, _Pos0, _)
THEN
ItemMoveTo(_Chain, _Pos0, 2.0, 0.0, 0, "", 0);

// for Zhent04 behaviour and Zarys dialog nodes
IF
FlagSet(PLA_ZhentDungeon_CorridorTrap_State_Active_5f9e8d89-463f-4d86-9d17-b05cc89e6cb3, _, _)
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_State_StopTriggerTraps_d35a34e2-9850-46c8-85bf-04efc6b9e8cb)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentDungeon_State_StopTriggerTraps_d35a34e2-9850-46c8-85bf-04efc6b9e8cb);


// PAD on Lever usage
IF
UseStarted(_Player, S_PLA_ZhentDungeon_CorridorTrapLever_4e0d91a8-48f4-4e3a-963c-52c0f89b88a0)
AND
DB_Players(_Player)
AND
NOT DB_CantTalk(_Player)
AND
NOT QRY_OncePerUserAndNearbyPlayers_IsSet(_Player, "PLA_ZhentDungeon_CorridorTrap_LeverUsed")
AND
QRY_StartDialog((DIALOGRESOURCE)GLO_WhatDidThatDo_AD_e0f4869f-3902-00df-1775-28b0bce3c88e, _Player)
AND
QRY_OncePerUserAndNearbyPlayers(_Player, "PLA_ZhentDungeon_CorridorTrap_LeverUsed")
THEN
DB_NOOP(1);

//END_REGION Corridor trap

//REGION If the Zhents are stuck in the front room after they started falling back, they become hostile.
IF
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d)
AND
DB_GLO_DefeatCounter(_Zhent, "PLA_ZhentDungeon_DefeatCounter")
AND
DB_PLA_ZhentDungeon_LaddersUpBlocked(1)
THEN
TriggerRegisterForCharacter(S_PLA_ZhentDungeon_FrontRoomBelow_bc2727f4-e6a3-4fef-89d3-239da6eb6a9b, (CHARACTER)_Zhent);

IF
DB_Destroyed(S_PLA_ZhentDungeon_FrontRoom_Ladder2_163f6b39-5957-40ff-ab10-6bd45b663522)
AND
DB_Destroyed(S_PLA_ZhentDungeon_FrontRoom_Ladder1_b729b5ea-921f-4f6f-aca7-d706d13021b2)
THEN
DB_PLA_ZhentDungeon_LaddersUpBlocked(1);

IF
DB_Destroyed(S_PLA_ZhentDungeon_FrontRoom_Ladder3_ac239831-2875-457f-aa9b-8374907e26c9)
AND
DB_Destroyed(S_PLA_ZhentDungeon_FrontRoom_Ladder1_b729b5ea-921f-4f6f-aca7-d706d13021b2)
THEN
DB_PLA_ZhentDungeon_LaddersUpBlocked(1);

IF
EnteredTrigger(_Character, S_PLA_ZhentDungeon_FrontRoomBelow_bc2727f4-e6a3-4fef-89d3-239da6eb6a9b)
THEN
SetCombatGroupID(_Character, "");
SetFaction(_Character, (FACTION)ACT1_PLA_HideoutZhents_Inside_Trapped_afdeba4b-4fee-4b9a-be25-7fedc71f0e2e);

//END_REGION

//REGION Zhents don't love if you destroy their bridges

IF
DB_PLA_ZhentDungeon_PlatformHelpers(_Bridge)
THEN
SetOwner(_Bridge, S_PLA_ZhentDungeon_Zhent06_254e7fbc-4849-4b60-a98f-4ae3becab077);

IF
FlagSet((FLAG)PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d, _, _)
AND
DB_PLA_ZhentDungeon_PlatformHelpers(_Bridge)
THEN
ClearOwnership(_Bridge);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
