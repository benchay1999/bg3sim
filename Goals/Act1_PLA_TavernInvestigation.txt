Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_PLA_FlamingFistSpeakerCounter(0);

DB_PLA_FlamingFist(1, (CHARACTER)S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911, (DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_FlamingFist1_AD_Occupied_aae77d89-b404-8eed-9022-c611cd24c433, (DIALOGRESOURCE)DIALOGRESOURCEGUID_PLA_FlamingFist1_7028bb67-6893-14d1-a909-fab5e6a395a0);
DB_PLA_FlamingFist(2, S_PLA_FlamingFist2_48b99fd9-f34e-4c11-a1a6-435ea6ef1c80, DIALOGRESOURCEGUID_PLA_FlamingFist2_AD_Occupied_059df3cb-832f-ab79-2454-f88d6e227281, DIALOGRESOURCEGUID_PLA_FlamingFist2_e4ad40e4-ad0c-6fca-4238-c74af932b821);
DB_PLA_FlamingFist(3, S_PLA_FlamingFist3_4bae156f-e1a1-4190-b6fa-84dac624c913, DIALOGRESOURCEGUID_PLA_FlamingFist3_AD_Occupied_23e719c5-bdbe-d989-5c8a-65e61d88f3e3, DIALOGRESOURCEGUID_PLA_FlamingFist3_4acebf78-f9fa-f701-bc10-0dc6b00ae55f);
DB_PLA_FlamingFist(4, S_PLA_FlamingFist4_5791727f-ace8-4b04-973a-cdf1f02f4984, DIALOGRESOURCEGUID_PLA_FlamingFist4_AD_Occupied_79749e87-f05c-8cc6-f86c-751cb73736aa, DIALOGRESOURCEGUID_PLA_FlamingFist4_01133c28-0dec-cd60-8000-218c127a6ab9);

TriggerRegisterForCharacter(S_PLA_DesireTrappedRoom_3063bdd1-3c92-4c46-9804-15098cfe54ad, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);
DB_PermaDefeatedFlag((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9,(FLAG)GLO_Florrick_State_PermaDefeated_c190fb1f-4c27-4948-87f0-29dc5a9b5b55);

DB_GLO_DefeatCounter_Target("PLA_FlamingFists", 1);
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("PLA_FlamingFists",PLA_FlamingFists_State_DefeatCounter_e4c4ad77-ddc0-4802-9374-7971f0c1fd82);

TriggerRegisterForCharacter(TRIGGERGUID_S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);
TriggerRegisterForCharacter(S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30, S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911);
TriggerRegisterForCharacter(S_PLA_DesireFreedTrigger2_6ecb7b16-2371-40de-b948-1f18d227d9d6, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);

SetHasDialog(GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, 1);

DB_GLO_ADManager_AD("PLA_FlamingFists", PLA_FlamingFist1_AD_Working_90427c48-02a3-df89-3fe8-e6dae85ebd19, PLA_FlamingFists_State_BlockAD_FlamingFist1_6fecbb70-4914-459c-8181-94833ca61673);
DB_GLO_ADManager_AD("PLA_FlamingFists", PLA_FlamingFist2_AD_Working_c6105fad-8948-e113-fdca-83630e4fd0ee, PLA_FlamingFists_State_BlockAD_FlamingFist2_126c1e38-8329-4a29-a17a-e192ecfef29a);
DB_GLO_ADManager_AD("PLA_FlamingFists", PLA_FlamingFist3_AD_Working_c537fe58-0eac-c865-d6b3-6d371b1d33d7, PLA_FlamingFists_State_BlockAD_FlamingFist3_b2c22470-46ca-4a49-a9c3-bf14eb61e1d6);
DB_GLO_ADManager_AD("PLA_FlamingFists", PLA_FlamingFist4_AD_Working_44aaf960-5253-cc28-e324-807bfede46af, PLA_FlamingFists_State_BlockAD_FlamingFist4_7cdeb0c0-3f9e-4381-870f-69d19cde316f);
DB_GLO_ADManager_AD("PLA_FlamingFists", PLA_FlamingFist6_AD_FlamingFist5_079b9beb-46f5-b788-92b3-9b36be717f15, PLA_FlamingFists_State_BlockAD_FlamingFist6_c8374fa2-8e20-4a99-8c9c-379e66b307f1);
DB_GLO_ADManager_AD("PLA_FlamingFists", PLA_FlamingFist7_AD_b0ac3d38-87e8-0682-0a39-5e1cfb84ec7a, PLA_FlamingFists_State_BlockAD_FlamingFist7_f0ab6cbe-358c-4dba-9e75-f74c8f8a7909);

DB_GLO_ADManager_Category("PLA_FlamingFists", PLA_FlamingFists_State_BlockAD_b40a237c-de00-4d22-9434-b6e8957dcbd8, 3000, 3000);

DB_HasItemEvent(S_PLA_TavernInvestigation_DesireDoorKey_c8feace1-e292-4fb9-bb98-2bae35020fc5, PLA_Desire_State_HasDesireKey_694a4db1-1e02-858c-05d1-881adc9d0076);

PROC_DefineSingleOriginMoment((DIALOGRESOURCE)PLA_FlamingFists_2ec42843-e88d-1453-0e4d-19496d99214e, (TAG)WYLL_facf82dc-a6e1-4720-a0bd-6efde960dc5f, (DIALOGRESOURCE)PLA_FlamingFists_OM_Wyll_AOM_OOM_bd65b9b4-c263-2ab3-cec6-9af89e470e55, (DIALOGRESOURCE)PLA_FlamingFists_OM_Wyll_COM_aa2656a6-ca46-1c28-766a-0615fceac215, (DIALOGRESOURCE)PLA_FlamingFists_OM_Wyll_AOM_OOM_bd65b9b4-c263-2ab3-cec6-9af89e470e55);

DB_PLA_FlamingFistsDialogues((DIALOGRESOURCE)PLA_FlamingFists_2ec42843-e88d-1453-0e4d-19496d99214e);
DB_PLA_FlamingFistsDialogues((DIALOGRESOURCE)PLA_FlamingFists_OM_Wyll_AOM_OOM_bd65b9b4-c263-2ab3-cec6-9af89e470e55);
DB_PLA_FlamingFistsDialogues((DIALOGRESOURCE)PLA_FlamingFists_OM_Wyll_COM_aa2656a6-ca46-1c28-766a-0615fceac215);

DB_PLA_FlamingFistsDismissedFlag(PLA_Desire_Knows_StelmaneTaken_215e6f0d-d0b3-3d5c-0b0a-7cad1ef3b2af);
DB_PLA_FlamingFistsDismissedFlag((FLAG)PLA_FlamingFists_State_Dismissed_dd58c8da-5800-4344-a535-5e78d05401d0);

DB_PLA_LeavingFlamingFistOutside((CHARACTER)S_PLA_FlamingFist8_c7dbb25b-69c0-4fb7-b4ba-f398b3e0e30a);
DB_PLA_LeavingFlamingFistOutside((CHARACTER)S_PLA_FlamingFist7_c28e5d52-8674-49a2-a60a-6e5ed47f4441);

PROC_SetCorpseOwner(S_PLA_FlamingFist6_0ba41cd1-e1f6-4f17-8e92-10ebef850268, S_PLA_FlamingFist5_c49b27b2-bd55-4c3f-a09a-7d787ab547ae);

PROC_TriggerRegisterForPlayers(S_PLA_Tavern_BuildingTrigger_16c5d3bb-422a-4bd8-a6a7-665d32d7303b);
PROC_TriggerRegisterForPlayers(S_PLA_StuckHalfElf_Room1Box_98660638-e875-49d4-a0b0-95d39ae56728);
PROC_TriggerRegisterForPlayers(S_PLA_DesireSideBuilding_b7f015ba-8712-4e08-953f-6177cc8b2830);

DB_PLA_FlamingFists_DisableCrimes((CHARACTER)S_PLA_FlamingFist5_c49b27b2-bd55-4c3f-a09a-7d787ab547ae);
DB_PLA_FlamingFists_DisableCrimes(S_PLA_FlamingFist7_c28e5d52-8674-49a2-a60a-6e5ed47f4441);
DB_PLA_FlamingFists_DisableCrimes(S_PLA_FlamingFist8_c7dbb25b-69c0-4fb7-b4ba-f398b3e0e30a);
DB_PLA_FlamingFists_DisableCrimes(S_PLA_StuckHalfElf_5fcc3167-5a0c-41e7-b44c-d629d34370cb);

PROC_TriggerRegisterForPlayers(S_PLA_StuckHalfElf_TavernBox_fc69dced-9f44-4760-9378-8598b4a9e859);

//REGION
//DB_PLA_TavernInvestigation_FirePuddle(_Trigger, _CellMin, _CellMax, _GrowMin, _GrowMax, _GrowTime, _Approached)
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_000_c9775c80-ce1b-4a76-9b2a-336ffaad6a0d, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_001_3f291ad3-a117-48b7-8bca-f4a01494fd82, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_002_267db4b3-c437-45ce-bc8c-e2d6a8fb17a7, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_003_862cfd84-9a66-42c5-b06b-b296feddda29, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_004_2503f4e0-a90f-479f-9935-076ffbc5c9a3, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_005_9aefb3d2-56cb-40ea-a7ff-270527f8357c, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_006_a37487ed-3719-4b90-bd48-55b1debe11ba, 3, 40, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_007_ed3b71a2-f7ee-4f27-803d-5b35c26f3b4e, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_008_f79f8fc2-0bdc-4b95-93e5-8fe166db8f60, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_009_270d6cd3-8c8f-4aa5-b0b7-f1fbb05f55ca, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_010_1bebbd51-78d4-4bdd-b017-ff97b4f37f7c, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_011_ee7f7237-dd78-4cd4-8799-b85e794e7d57, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_012_64e9c2c6-3047-4453-bf37-caccc3e489f8, 3, 70, 4, 7, 2.0, 0);
DB_PLA_TavernInvestigation_FirePuddle((TRIGGER)S_PLA_TavernInvestigation_FirePuddle_013_98efd078-b27b-4d76-be63-a74071972624, 3, 70, 4, 7, 2.0, 0);
//END_REGION

DB_PLA_TavernInvestigation_PersistentFlame(S_PLA_PersistentFlame_000_59cb1667-4134-42b9-8fb9-951e99625b46);
DB_PLA_TavernInvestigation_PersistentFlame(S_PLA_PersistentFlame_001_118b67fa-3d55-46f4-bdf5-92775e880a63);
DB_PLA_TavernInvestigation_PersistentFlame(S_PLA_PersistentFlame_002_bbb87b3d-f003-4495-ab1a-462209eb26b5);
DB_PLA_TavernInvestigation_PersistentFlame(S_PLA_PersistentFlame_003_f66d1256-dcd2-425d-a5e7-12b6245653ab);
DB_PLA_TavernInvestigation_PersistentFlame(S_PLA_PersistentFlame_004_93f0838c-341c-4b72-ba95-657a50a8ef74);
DB_PLA_TavernInvestigation_PersistentFlame(S_PLA_PersistentFlame_005_3910b21e-8c7e-4bee-871d-d5c79091aa70);
DB_PLA_TavernInvestigation_PersistentFlame(S_PLA_PersistentFlame_006_631b5f2f-bb10-4710-8f50-4bbca1fb49f1);
DB_PLA_TavernInvestigation_PersistentFlame(S_PLA_PersistentFlame_007_40e6aee4-c561-46c2-9931-838ffd9b4891);
DB_PLA_TavernInvestigation_PersistentFlame(S_PLA_PersistentFlame_008_8de18d6c-928e-4d65-bfa2-f608ed119a3f);

SetHitpointsPercentage(S_PLA_TavernInvestigation_DesireDoor2_e6b2f9ca-a59b-4842-8c1b-1b6499b884f7, 78.0);
SetHitpointsPercentage(S_PLA_TavernInvestigation_RoomDoor2_f4ad4ed3-5906-47a4-b874-20c7c96780d0, 50.0);
SetHitpointsPercentage(S_PLA_TavernInvestigation_RoomDoor3_9fff6aeb-8bd1-43bd-b215-ef218729e0b1, 65.0);
SetHitpointsPercentage((ITEM)S_PLA_TavernInvestigation_BrokenDoor1_ca3d67a8-b632-4f5d-b5b1-77b036ba3122, 30.0);

DB_GLO_CharacterCorpseDialog((CHARACTER)S_PLA_FlamingFist7_c28e5d52-8674-49a2-a60a-6e5ed47f4441, (DIALOGRESOURCE)PLA_FlamingFist7_Dead_5c8566ef-be51-1a9d-e9ad-75563ce8a173);

DB_SpotPlayers((CHARACTER)S_PLA_FlamingFist5_c49b27b2-bd55-4c3f-a09a-7d787ab547ae, "PLA_FlamingFists_CheckDrow", PLA_FlamingFists_Event_RestartCheckDrow_72fafb77-fb70-47da-8598-6bbd0d71f578, PLA_FlamingFists_Event_PersuadedDrow_f4938c3e-9353-44e8-9088-b8163d3222c8);
DB_CustomDialogRange(S_PLA_FlamingFist5_c49b27b2-bd55-4c3f-a09a-7d787ab547ae, 25);
DB_HostileToPlayerGroupCancelFlag(PLA_FlamingFists_State_PersuadedDrow_d8bc1e0a-6e88-4890-ac53-6bc2457cfa6a, ACT1_PLA_FlamingFists_b4e6e166-ea5f-50ef-6365-84c889f28238);

DB_SeenDeadNPCGlobalFlag((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, GLO_Knows_DesireDead_97850586-ce48-47ef-ab47-7402b1b15c82);


//REGION Autosave
DB_AutoSaveTrigger((TRIGGER)S_PartyBanterTrigger_PLA_TollhouseCleared_683e29e2-5840-41d1-8fd2-626f92852f53);
//END_REGION

DB_PartyDialogSuppressionZone(S_PLA_TG_InTavern_3d3f482f-8e20-4f33-b927-5cdb96971390);

ApplyStatus(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "DIRT_COVERED_FULL", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "SWEATY_LIGHT", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
KBSECTION
//REGION Reaching Desire
IF
DB_PLA_FlamingFist(_Num, _Fist, _, _)
THEN
SetHasDialog(_Fist, 1);
TriggerRegisterForCharacter(TRIGGERGUID_S_PLA_DesireSpotFF_4e4a06d4-0926-4440-94a9-bd320ccd00bc, _Fist);
DB_PLA_FlamingFists_DisableCrimes(_Fist);

IF
DB_PLA_FlamingFists_DisableCrimes(_Fist)
THEN
PROC_CharacterDisableCrime(_Fist, "VandaliseNoOwner");

IF
DB_PLA_FlamingFists_DisableCrimes(_Fist)
AND
DB_CRIME_ShapeshiftDisturbance(_, _Crime, _Crime2, "DangerousBeast")
THEN
PROC_CharacterDisableCrime(_Fist, _Crime);
PROC_CharacterDisableCrime(_Fist, _Crime2);

//REGION Keep track of whether a given NPC is available

IF
DB_PLA_FlamingFist(_Num, _Fist, _, _)
AND
NOT DB_CantTalk(_Fist)
THEN
NOT DB_PLA_FlamingFistAvailable(_Num, NULL_00000000-0000-0000-0000-000000000000);
DB_PLA_FlamingFistAvailable(_Num, _Fist);

IF
DB_PLA_FlamingFist(_Num, _Fist, _, _)
AND
DB_CantTalk(_Fist)
THEN
DB_PLA_FlamingFistAvailable(_Num, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_PLA_FlamingFistAvailable(_Num, _Fist);

IF
DB_PLA_FlamingFistAvailable(_Num, NULL_00000000-0000-0000-0000-000000000000)
THEN
PROC_PLA_RemoveFlamingFistSpeaker();

IF
DB_PLA_FlamingFistAvailable(_Num, _Fist)
AND
_Fist != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_PLA_AddFlamingFistSpeaker();

PROC
PROC_PLA_AddFlamingFistSpeaker()
AND
DB_PLA_FlamingFistSpeakerCounter(_OldNum)
AND
IntegerSum(_OldNum, 1, _NewNum)
THEN
NOT DB_PLA_FlamingFistSpeakerCounter(_OldNum);
DB_PLA_FlamingFistSpeakerCounter(_NewNum);

PROC
PROC_PLA_RemoveFlamingFistSpeaker()
AND
DB_PLA_FlamingFistSpeakerCounter(_OldNum)
AND
IntegerSubtract(_OldNum, 1, _NewNum)
THEN
NOT DB_PLA_FlamingFistSpeakerCounter(_OldNum);
DB_PLA_FlamingFistSpeakerCounter(_NewNum);



//REGION Desire dialogue (NPC needs to be in the associated trigger)

IF
DB_PLA_FlamingFistAvailable(_Num, _Fist)
AND
DB_InRegion((CHARACTER)_Fist, TRIGGERGUID_S_PLA_DesireSpotFF_4e4a06d4-0926-4440-94a9-bd320ccd00bc)
THEN
DB_PLA_FlamingFistAvailableForDesire(_Num, _Fist);
NOT DB_PLA_FlamingFistAvailableForDesire(_Num, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_PLA_FlamingFistAvailable(_Num, _Fist)
AND
_Fist != NULL_00000000-0000-0000-0000-000000000000
AND
NOT DB_InRegion((CHARACTER)_Fist, TRIGGERGUID_S_PLA_DesireSpotFF_4e4a06d4-0926-4440-94a9-bd320ccd00bc)
THEN
NOT DB_PLA_FlamingFistAvailableForDesire(_Num, _Fist);
DB_PLA_FlamingFistAvailableForDesire(_Num, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_InRegion((CHARACTER)_Fist, TRIGGERGUID_S_PLA_DesireSpotFF_4e4a06d4-0926-4440-94a9-bd320ccd00bc)
AND
DB_PLA_FlamingFist(_Num, _Fist, _, _)
AND
NOT DB_PLA_FlamingFistAvailable(_Num, _Fist)
THEN
NOT DB_PLA_FlamingFistAvailableForDesire(_Num, _Fist);
DB_PLA_FlamingFistAvailableForDesire(_Num, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)_FlamingFistDialog,(INTEGER)_Inst)
AND
DB_PLA_FlamingFistsDialogues(_FlamingFistDialog)
AND
DB_PLA_FlamingFistAvailableForDesire(_, _Fist)
THEN
PROC_DialogAddSpeakingActor(_Inst, _Fist);
//END_REGION


//END_REGION

//REGION Keeping track of how many Flaming Fists are dead
IF
DB_PLA_FlamingFist(_, _Fist, _, _)
THEN
DB_GLO_DefeatCounter(_Fist, "PLA_FlamingFists");

//END_REGION

//REGION Talking to any of the NPCs starts a group dialogue. Failing that, it will go to a fallback AD.

//Outside

QRY
QRY_SelectCustomDialog_AfterGenerics(_Fist, _Player)
AND
DB_PLA_FlamingFist(_, (CHARACTER)_Fist, _, _)
AND
NOT DB_GlobalFlag((FLAG)PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4) // flagType: Global
THEN
PROC_PLA_FlamingFists_OutsideDialog(_Fist, _Player);

PROC
PROC_PLA_FlamingFists_OutsideDialog((GUIDSTRING)_Fist, (GUIDSTRING)_Player)
AND
DB_PLA_FlamingFist(_, (CHARACTER)_Fist, _BackupAD, _)
AND
NOT QRY_PLA_FlamingFist_FourFlamingFistsDialogue(_Player)
THEN
DB_SelectedDialog(_BackupAD, _Fist);


QRY
QRY_PLA_FlamingFist_FourFlamingFistsDialogue((GUIDSTRING)_Player)
AND
DB_PLA_FlamingFistAvailable(1, S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911)
AND
IsInTrigger(S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911, S_PLA_FlamingFists_BeforeObstruction_ce0ee4d4-20d6-437e-a422-eec4ecd753f5, 1)
AND
DB_PLA_FlamingFistAvailable(2, _Fist2)
AND
DB_PLA_FlamingFistAvailable(3, _Fist3)
AND
DB_PLA_FlamingFistAvailable(4, _Fist4)
THEN
DB_SelectedDialog(DIALOGRESOURCEGUID_PLA_FlamingFists_2ec42843-e88d-1453-0e4d-19496d99214e, S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911, _Fist2, _Fist3, _Fist4, _Player);

//Inside

QRY
QRY_SelectCustomDialog_AfterGenerics(_Fist, _Player)
AND
NOT DB_PLA_FlamingFistAvailableForDesire(_, (CHARACTER)_Fist)
AND
DB_PLA_FlamingFist(_, _Fist, _BackupAD, _)
AND
DB_GlobalFlag((FLAG)PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4) // flagType: Global
AND
QRY_SpeakerIsAvailable(_Fist, 1)
THEN
DB_SelectedDialog(_BackupAD, _Fist);

QRY
QRY_SelectCustomDialog_AfterGenerics(_Fist, _Player)
AND
DB_PLA_FlamingFistAvailableForDesire(_, (CHARACTER)_Fist)
AND
DB_PLA_FlamingFist(_, _Fist, _BackupAD, _)
AND
DB_GlobalFlag((FLAG)PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4) // flagType: Global
AND
DB_GlobalFlag((FLAG)PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509) // flagType: Global
AND
DB_InRegion(_Fist, TRIGGERGUID_S_PLA_DesireSpotFF_4e4a06d4-0926-4440-94a9-bd320ccd00bc)
AND
DB_PLA_FlamingFistAvailableForDesire(1, _Fist1)
AND
DB_PLA_FlamingFistAvailableForDesire(2, _Fist2)
AND
DB_PLA_FlamingFistAvailableForDesire(3, _Fist3)
AND
DB_PLA_FlamingFistAvailableForDesire(4, _Fist4)
AND
QRY_GLO_SelectFavouredSpeaker_SingleTag((GUIDSTRING)_Player, GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, (TAG)AVATAR_306b9b05-1057-4770-aa17-01af21acd650, 0)
AND
DB_QRYRTN_GLO_SelectFavouredSpeaker(_Speaker)
AND
NOT QRY_StartDialog(DIALOGRESOURCEGUID_PLA_Desire_8fbcdeb4-056d-168f-8c91-cc3af7acc4a4, GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, _Fist1, _Fist2, _Fist3, _Fist4, _Speaker) 
THEN
DB_SelectedDialog(_BackupAD, _Fist);

QRY
QRY_SelectCustomDialog_AfterGenerics(_Fist, _Player)
AND
DB_PLA_FlamingFistAvailableForDesire(_, (CHARACTER)_Fist)
AND
DB_PLA_FlamingFist(_, _Fist, _, _Dialog) 
AND
DB_GlobalFlag((FLAG)PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4) // flagType: Global
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509) // flagType: Global
AND
DB_InRegion(_Fist, TRIGGERGUID_S_PLA_DesireSpotFF_4e4a06d4-0926-4440-94a9-bd320ccd00bc)
THEN
DB_SelectedDialog(_Dialog, _Fist, _Player);

//END_REGION

//REGION Removing the wall
IF
UseStarted(_Player, S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9)
AND
IsInTrigger(_Player, S_PLA_TavernInvestigation_Obstruction_SimpleClear_67e53b6e-fec3-4ba3-acd0-3395ac26821e, 1)
THEN
Die((ITEM)S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9);

IF
UseStarted(_Player, S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9)
AND
IsInTrigger(_Player, S_PLA_TavernInvestigation_Obstruction_SimpleClear_67e53b6e-fec3-4ba3-acd0-3395ac26821e, 0)
AND
DB_CantTalk(_Player)
AND
GetFlag(PLA_TavernInvestigation_State_TriedOnce_578df9b5-0b25-d7cc-0180-e29d765a63a4, (GUIDSTRING)_Player, 0)
AND
IsPartyMember((CHARACTER)_Player, 1, 1)
THEN
RequestActiveRoll(_Player, S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9, "Athletics", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, "PLA_TavernInvestigation_RollSuccess");

IF
UseStarted(_Player, S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9)
AND
IsInTrigger(_Player, S_PLA_TavernInvestigation_Obstruction_SimpleClear_67e53b6e-fec3-4ba3-acd0-3395ac26821e, 0)
AND
NOT DB_CantTalk(_Player)
AND
NOT QRY_PLA_FlamingFistsDialogue(_Player)
AND
NOT DB_QRYRTN_StartDialog_FailReason(_)
AND
NOT QRY_PLA_AddToFlamingFists(_Player)
AND
GetFlag(PLA_TavernInvestigation_State_TriedOnce_578df9b5-0b25-d7cc-0180-e29d765a63a4, (GUIDSTRING)_Player, 0)
AND
IsPartyMember((CHARACTER)_Player, 1, 1)
THEN
PROC_TrySkillCheck(_Player, S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9, "Athletics", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, "PLA_TavernInvestigation_RollSuccess");

IF
UseStarted(_Player, S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9)
AND
IsInTrigger(_Player, S_PLA_TavernInvestigation_Obstruction_SimpleClear_67e53b6e-fec3-4ba3-acd0-3395ac26821e, 1)
AND
IsPartyMember(_Player, 1, 1)
THEN
SetFlag(PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4, NULL_00000000-0000-0000-0000-000000000000, 0);

QRY
QRY_PLA_FlamingFistsDialogue((GUIDSTRING)_Player)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_PLA_FlamingFistsDismissedDialog(_)
AND
IsInTrigger(S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911, S_PLA_FlamingFists_BeforeObstruction_ce0ee4d4-20d6-437e-a422-eec4ecd753f5, 1)
AND
QRY_SelectAndStartDialog(S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911, _Player)
THEN
DB_NOOP(1);

QRY
QRY_PLA_AddToFlamingFists((GUIDSTRING)_Player)
AND
DB_DialogName(DIALOGRESOURCEGUID_PLA_FlamingFists_2ec42843-e88d-1453-0e4d-19496d99214e, _ID)
THEN
PROC_DialogAddListeningActor(_ID, _Player);

QRY
QRY_PLA_AddToFlamingFists((GUIDSTRING)_Player)
AND
DB_DialogName((DIALOGRESOURCE)PLA_FlamingFists_OM_Wyll_COM_aa2656a6-ca46-1c28-766a-0615fceac215, _ID)
THEN
PROC_DialogAddListeningActor(_ID, _Player);

QRY
QRY_PLA_AddToFlamingFists((GUIDSTRING)_Player)
AND
DB_DialogName((DIALOGRESOURCE)PLA_FlamingFists_OM_Wyll_AOM_OOM_bd65b9b4-c263-2ab3-cec6-9af89e470e55, _ID)
THEN
PROC_DialogAddListeningActor(_ID, _Player);

PROC
PROC_RollResult("PLA_TavernInvestigation_RollSuccess", _Player, S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9, 1)
THEN
SetFlag(PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_RollResult("PLA_TavernInvestigation_RollSuccess", _Player, S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9, 0)
THEN
SetFlag(PLA_TavernInvestigation_State_TriedOnce_578df9b5-0b25-d7cc-0180-e29d765a63a4, _Player, 0);

IF
FlagSet(PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4, _, _) // flagType: Global
THEN
Die((ITEM)S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9);

IF
DestroyingBy((ITEM)S_PLA_TavernInvestigation_Obstruction_649559a6-2430-412f-983b-7a136f7be9c9, _, _, _)
THEN
SetFlag((FLAG)PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
DialogEnded(DIALOGRESOURCEGUID_PLA_FlamingFists_2ec42843-e88d-1453-0e4d-19496d99214e, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
GetFlag(PLA_TavernInvestigation_State_TriedOnce_578df9b5-0b25-d7cc-0180-e29d765a63a4, _Player, 1)
AND
QRY_OncePerUserAndNearbyPlayers((CHARACTER)_Player,"PLA_TavernInvestigation_VB_OtherWay")
THEN
StartVoiceBark(PLA_TavernInvestigation_VB_OtherWay_f862aa1b-5c3d-730b-69e3-e0891378f042, _Player);

//END_REGION

//REGION Desire Dialogue

QRY
QRY_SelectCustomDialog_AfterGenerics(GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, _Player)
AND
QRY_PLA_DesireFreed()
AND
DB_PLA_FlamingFistAvailableForDesire(1, _Fist1)
AND
DB_PLA_FlamingFistAvailableForDesire(2, _Fist2)
AND
DB_PLA_FlamingFistAvailableForDesire(3, _Fist3)
AND
DB_PLA_FlamingFistAvailableForDesire(4, _Fist4)
THEN
DB_SelectedDialog(PLA_Desire_8fbcdeb4-056d-168f-8c91-cc3af7acc4a4, GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, _Fist1, _Fist2, _Fist3, _Fist4, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, _Player)
AND
NOT QRY_PLA_DesireFreed()
THEN
DB_SelectedDialog(PLA_Desire_8fbcdeb4-056d-168f-8c91-cc3af7acc4a4, GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Player);

PROC
PROC_SpotPlayers_Spotted(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire", _Player)
AND
NOT QRY_PLA_DesireFreed()
AND
QRY_StartDialog(PLA_Desire_FirstThanks_7bf20efb-e74b-2e8e-c15a-f5620115b254, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, _Player)
THEN
DB_OnlyOnce("PLA_Desire_FirstThanks");

PROC
PROC_SpotPlayers_Spotted(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire", _Player)
AND
QRY_PLA_DesireFreed()
AND
DB_PLA_FlamingFistAvailableForDesire(1, _Fist1)
AND
DB_PLA_FlamingFistAvailableForDesire(2, _Fist2)
AND
DB_PLA_FlamingFistAvailableForDesire(3, _Fist3)
AND
DB_PLA_FlamingFistAvailableForDesire(4, _Fist4)
AND
QRY_GLO_SelectFavouredSpeaker_SingleTag((GUIDSTRING)_Player, GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, (TAG)AVATAR_306b9b05-1057-4770-aa17-01af21acd650, 0)
AND
DB_QRYRTN_GLO_SelectFavouredSpeaker(_Speaker)
AND
NOT QRY_StartDialog(DIALOGRESOURCEGUID_PLA_Desire_8fbcdeb4-056d-168f-8c91-cc3af7acc4a4, GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, _Fist1, _Fist2, _Fist3, _Fist4, _Speaker) 
THEN
DB_NOOP(1);

PROC
PROC_DialogFlagSetup(DIALOGRESOURCEGUID_PLA_Desire_8fbcdeb4-056d-168f-8c91-cc3af7acc4a4, _, _, _, _, _, _)
AND
DB_GlobalFlag((FLAG)PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509) // flagType: Global
THEN
PROC_SpotPlayers_StopSpotting(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire");

QRY
QRY_PLA_DesireFreed()
AND
DB_GlobalFlag(PLA_Desire_State_Freed2_46dbc8ef-61fa-42c4-bc89-4a8f53d53e5b)
THEN
DB_NOOP(1);

IF
DialogEnded(DIALOGRESOURCEGUID_PLA_Desire_8fbcdeb4-056d-168f-8c91-cc3af7acc4a4, _)
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_Knows_StelmaneTaken_215e6f0d-d0b3-3d5c-0b0a-7cad1ef3b2af) // flagType: Global
AND
DB_GlobalFlag((FLAG)PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509) // flagType: Global
THEN
PROC_SpotPlayers_RestartSpotting(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire");

IF
DialogEnded(DIALOGRESOURCEGUID_PLA_Desire_8fbcdeb4-056d-168f-8c91-cc3af7acc4a4, _)
AND
DB_GlobalFlag((FLAG)PLA_Desire_Knows_StelmaneTaken_215e6f0d-d0b3-3d5c-0b0a-7cad1ef3b2af) // flagType: Global
THEN
PROC_RemoveAllDialogEntriesForSpeaker(GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);
PROC_CharacterMoveTo(GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_Tavern_DisappearPoint_7f357e5d-fd79-432c-9585-588396e0e9d1, "Walk", "PLA_Tavern_ReadyForDisappear");
TriggerUnregisterForCharacter(TRIGGERGUID_S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);
TriggerUnregisterForCharacter(S_PLA_DesireFreedTrigger2_6ecb7b16-2371-40de-b948-1f18d227d9d6, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);

IF
FlagSet(_Flag, _, _ID)
AND
DB_PLA_FlamingFistsDismissedFlag(_Flag)
AND
NOT DB_PLA_FlamingFistsDismissedDialog(_)
THEN
DB_PLA_FlamingFistsDismissedDialog(_ID);

IF
DB_PLA_FlamingFistsDismissedDialog(_ID)
AND
NOT DB_DialogName(_, _ID)
AND
DB_PLA_FlamingFist(_, _Fist, _, _)
AND
NOT DB_CantMove(_Fist)
AND
NOT DB_DialogNPCs(_, _Fist, _)
AND
NOT DB_Is_InCombat(_Fist, _)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Fist);
PROC_CharacterMoveTo(_Fist, S_PLA_Tavern_DisappearPoint_7f357e5d-fd79-432c-9585-588396e0e9d1, "Walk", "PLA_Tavern_ReadyForDisappear");


IF
DB_GlobalFlag(PLA_FlamingFists_State_Dismissed_dd58c8da-5800-4344-a535-5e78d05401d0)
AND
DB_PLA_FlamingFist(_, _Fist, _, _)
AND
NOT DB_CantMove(_Fist)
AND
NOT DB_DialogNPCs(_, _Fist, _)
AND
NOT DB_Is_InCombat(_Fist, _)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Fist);
PROC_CharacterMoveTo(_Fist, S_PLA_Tavern_DisappearPoint_7f357e5d-fd79-432c-9585-588396e0e9d1, "Walk", "PLA_Tavern_ReadyForDisappear");


//If the player learns of Stelmane being taken before the place burns down, i.e. they learn this from the Counsellor,
//These guys are no longer required and can go on their merry way.
IF
DB_PLA_FlamingFistsDismissedDialog(_ID)
AND
NOT DB_DialogName(_, _ID)
AND
DB_PLA_LeavingFlamingFistOutside(_Fist)
AND
NOT DB_CantMove(_Fist)
AND
NOT DB_DialogNPCs(_, _Fist, _)
AND
NOT DB_Is_InCombat(_Fist, _)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Fist);
PROC_CharacterMoveTo(_Fist, S_PLA_Tavern_DisappearPoint_7f357e5d-fd79-432c-9585-588396e0e9d1, "Walk", "PLA_Tavern_ReadyForDisappear");

IF
DB_GlobalFlag((FLAG)PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4)
AND
DB_PermaDefeated((CHARACTER)S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911)
AND
NOT DB_PLA_FlamingFistsDismissedDialog(_)
THEN
SetFlag(PLA_FlamingFists_State_Dismissed_dd58c8da-5800-4344-a535-5e78d05401d0, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

IF 
DB_InRegion(CHARACTERGUID_S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911, S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30)
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509) // flagType: Global
AND
NOT DB_CantTalk_IgnoreCombat(S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911)
AND
NOT DB_CantTalk_IgnoreCombat(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9)
AND
NOT DB_Defeated(S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911)
AND
NOT DB_Defeated(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9)
AND
NOT DB_GlobalFlag(PLA_TavernInvestigation_State_InstructionGiven_cacad2cd-873d-4661-aed8-94cd366d72f6)
AND
DB_InRegion(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_DesireTrappedRoom_3063bdd1-3c92-4c46-9804-15098cfe54ad)
AND
Exists(S_PLA_Tavern_Support3_52471f6d-8514-4168-96da-0f09b7a3b36f, 1)
AND
IsDestroyed(S_PLA_Tavern_Support3_52471f6d-8514-4168-96da-0f09b7a3b36f, 0)
AND
Exists(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, 1)
AND
IsDestroyed(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, 0)
AND
IsLocked(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, 1)
AND
QRY_StartDialog(DIALOGRESOURCEGUID_PLA_FlamingFist1_AD_FlamingFist1ComeIn_4e30fe12-f782-6813-e093-7fcddde35ff7, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911)
THEN
PROC_GlobalSetFlagAndCache(PLA_TavernInvestigation_State_InstructionGiven_cacad2cd-873d-4661-aed8-94cd366d72f6);
TriggerUnregisterForCharacter(S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30, CHARACTERGUID_S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911);

//REGION Desire can be dead.
IF
DB_PermaDefeated((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9)
AND
DB_Sees(_FlamingFist, (CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9)
AND
DB_PLA_FlamingFist(_, _FlamingFist, _, _)
AND
NOT DB_GlobalFlag(PLA_FlamingFists_State_Dismissed_dd58c8da-5800-4344-a535-5e78d05401d0)
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_Knows_StelmaneTaken_215e6f0d-d0b3-3d5c-0b0a-7cad1ef3b2af)
AND
NOT DB_OnlyOnce("PLA_FlamingFists_ReactToDeadDesire")
AND
NOT DB_CantTalk(_FlamingFist) //Dialogue may feel out of place during combat.
AND
NOT QRY_StartDialog((DIALOGRESOURCE)PLA_Flamingfists_AD_FoundDeadDesire_bd32b055-5b44-5fe6-4d10-93b95251e52a, _FlamingFist)
THEN
PROC_GlobalSetFlagAndCache(PLA_FlamingFists_State_Dismissed_dd58c8da-5800-4344-a535-5e78d05401d0);

IF
DB_PermaDefeated((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9)
AND
DB_Sees(_FlamingFist, (CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9)
AND
DB_PLA_FlamingFist(_, _FlamingFist, _, _)
AND
NOT DB_GlobalFlag(PLA_FlamingFists_State_Dismissed_dd58c8da-5800-4344-a535-5e78d05401d0)
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_Knows_StelmaneTaken_215e6f0d-d0b3-3d5c-0b0a-7cad1ef3b2af)
AND
NOT DB_OnlyOnce("PLA_FlamingFists_ReactToDeadDesire")
AND
DB_CantTalk(_FlamingFist) //Dialogue may feel out of place during combat.
AND
NOT DB_Defeated(_FlamingFist)
THEN
PROC_GlobalSetFlagAndCache(PLA_FlamingFists_State_Dismissed_dd58c8da-5800-4344-a535-5e78d05401d0);

PROC
PROC_DialogFlagSetup(PLA_Flamingfists_AD_FoundDeadDesire_bd32b055-5b44-5fe6-4d10-93b95251e52a, _)
THEN
DB_OnlyOnce("PLA_FlamingFists_ReactToDeadDesire");

//END_REGION

//END_REGION

//REGION If the players leave and return, the place burns down
PROC
PROC_PLA_TryBurnDownTavern()
AND
QRY_OnlyOnce("PLA_TryBurnDownTavern")
THEN
PROC_PLA_BurnDownTavern();

PROC
PROC_PLA_BurnDownTavern()
AND
NOT QRY_PLA_Desire_Freed()
THEN
Die(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, DEATHTYPE.Incinerate,1);

PROC
PROC_PLA_BurnDownTavern()
AND
QRY_PLA_Desire_Freed()
THEN
SetOnStage(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, 0);

PROC
PROC_PLA_BurnDownTavern()
THEN
PROC_TriggerUnregisterForParty(S_PLA_TavernInvestigation_BurnDownTrigger_Inner_df11a25c-e374-499b-9993-47c44b9b84b0);
SetFlag(PLA_TavernInvestigation_State_BurntDown_ad34c392-4499-402c-ae51-8c3d40985f8b, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_PLA_TavernInvestigation_DousePersistentFlames();
SetOnStage(S_PLA_StuckHalfElf_HazardFire01_1e1efef8-e728-48fb-97ee-09c714e3b7ec, 0);
SetOnStage(S_PLA_StuckHalfElf_HazardFire02_14e9c573-bade-4b3d-97cf-578d76ba61ec, 0);
SetOnStage(S_PLA_StuckHalfElf_HazardFire03_f4a5b9b0-b19c-45cc-ae97-5b32723d98bd, 0);
SetOnStage(S_PLA_StuckHalfElf_HazardFire04_c191f4ee-1830-41bc-8b1e-4d04cd44e341, 0);
SetOnStage(S_PLA_StuckHalfElf_HazardFire05_27aff04a-b6e6-4983-9f19-af7fe3f8118f, 0);
SetOnStage(S_PLA_StuckHalfElf_HazardFire06_0c076fe6-b588-4304-a6e4-5c33d81e840b, 0);

PROC
PROC_PLA_TavernInvestigation_DousePersistentFlames()
AND
DB_PLA_TavernInvestigation_PersistentFlame(_Flame)
THEN
CreateSurface(_Flame, "SurfaceAsh", 4.0, 0.0);
CreatePuddle(_Flame, "SurfaceAsh", 6, 8, 2, 4, 1.0);
SetOnStage(_Flame, 0);

PROC
PROC_PLA_BurnDownTavern()
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_State_Freed2_46dbc8ef-61fa-42c4-bc89-4a8f53d53e5b)
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509)
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_Knows_StelmaneTaken_215e6f0d-d0b3-3d5c-0b0a-7cad1ef3b2af)
THEN
SetFlag(PLA_FlamingFists_Knows_DesireDead_e84b2694-9377-e8c1-eaf1-970df68b2049, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_PLA_BurnDownTavern()
AND
DB_PLA_TavernFloors(_Support, _)
AND
Exists(_Support, 1)
AND
IsDestroyed(_Support, 0)
THEN
Die(_Support, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 1);

PROC
PROC_PLA_BurnDownTavern()
AND
NOT DB_GlobalFlag((FLAG)PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4) // flagType: Global
AND
NOT DB_GlobalFlag(PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509) // flagType: Global
AND
NOT DB_GlobalFlag(PLA_Desire_State_Freed2_46dbc8ef-61fa-42c4-bc89-4a8f53d53e5b)
THEN
SetOnStage(ITEMGUID_S_PLA_TavernInvestigation_ObstructionBoard_649559a6-2430-412f-983b-7a136f7be9c9, 0);


PROC
PROC_PLA_BurnDownTavern()
AND
IsInTrigger(S_PLA_TavernInvestigation_DukesRiches_003cce23-b6ac-4442-a968-cd3430cb150c, S_PLA_TavernInvestigation_DukeRoom_dd5b0510-6067-490f-8bb8-392a1a430a59, 1)
THEN
Die(S_PLA_TavernInvestigation_DukesRiches_003cce23-b6ac-4442-a968-cd3430cb150c, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 1);

PROC
PROC_PLA_BurnDownTavern()
AND
NOT DB_Dead((CHARACTER)S_PLA_FlamingFist8_c7dbb25b-69c0-4fb7-b4ba-f398b3e0e30a)
AND
IsInTrigger(S_PLA_FlamingFist8_c7dbb25b-69c0-4fb7-b4ba-f398b3e0e30a, S_PLA_TavernInvestigation_BurnDownTrigger_Inner_df11a25c-e374-499b-9993-47c44b9b84b0, 1)
THEN
TeleportTo(S_PLA_FlamingFist8_c7dbb25b-69c0-4fb7-b4ba-f398b3e0e30a, S_PLA_FlamingFist8Home_25d8f28d-fbf5-4971-bde0-b25cbdebeed1, "", 0, 0, 0);

PROC
PROC_PLA_BurnDownTavern()
AND
NOT DB_Dead((CHARACTER)S_PLA_FlamingFist7_c28e5d52-8674-49a2-a60a-6e5ed47f4441)
AND
IsInTrigger(S_PLA_FlamingFist7_c28e5d52-8674-49a2-a60a-6e5ed47f4441, S_PLA_TavernInvestigation_BurnDownTrigger_Inner_df11a25c-e374-499b-9993-47c44b9b84b0, 1)
THEN
TeleportTo(S_PLA_FlamingFist7_c28e5d52-8674-49a2-a60a-6e5ed47f4441, S_PLA_FlamingFist7_WanderTrigger_78adc24c-5334-408e-90e4-b3f40ef0d3f6, "", 0, 0, 0);

PROC
PROC_PLA_BurnDownTavern()
AND
QRY_PLA_Desire_Freed()
AND
DB_Players(_Player)
AND
NOT QRY_PLA_Desire_TalkedToDesire(_Player)
THEN
QuestUpdate(_Player, "PLA_GrandDukeRescue", "LeftRegionAct1");

PROC
PROC_PLA_BurnDownTavern()
AND
NOT QRY_PLA_Desire_Freed()
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "PLA_GrandDukeRescue", "Counsellor_DidntRescue");

QRY
QRY_PLA_Desire_TalkedToDesire((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "PLA_GrandDukeRescue", "Counsellor_AcceptedHelp_NoLocation", 1)
THEN
DB_NOOP(1);

QRY
QRY_PLA_Desire_TalkedToDesire((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "PLA_GrandDukeRescue", "Counsellor_AcceptedHelp_Moonrise", 1)
THEN
DB_NOOP(1);

QRY
QRY_PLA_Desire_TalkedToDesire((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "PLA_GrandDukeRescue", "Counsellor_RefusedHelp", 1)
THEN
DB_NOOP(1);
//END_REGION


//REGION Extracting Desire

PROC
PROC_BlockUseOfItem(_Player, S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307)
AND
IsDestroyed(S_PLA_Tavern_Support3_52471f6d-8514-4168-96da-0f09b7a3b36f, 0)
AND
IsDestroyed(S_PLA_TavernInvestigation_DesireDoor2_e6b2f9ca-a59b-4842-8c1b-1b6499b884f7, 0)
AND
IsLocked(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, 1)
AND
DB_Players(_Player)
AND
IsInTrigger(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_DesireTrappedRoom_3063bdd1-3c92-4c46-9804-15098cfe54ad, 1)
AND
IsInTrigger(_Player, S_PLA_DesireTrappedRoom_3063bdd1-3c92-4c46-9804-15098cfe54ad, 0)
AND
QRY_StartDialog_Fixed(PLA_TavernInvestigation_DesireDoor_b74d5928-f524-cc8f-f55f-4a665fd7aeac, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, _Player)
THEN
DB_CustomUseItemResponse(_Player, (ITEM)S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, 0);

IF
DialogEnded(PLA_TavernInvestigation_DesireDoor_b74d5928-f524-cc8f-f55f-4a665fd7aeac, _)
AND
DB_GlobalFlag(PLA_Desire_Quest_OpenDoor_233986ed-f17a-f9a2-4ca5-918ce0488f3d)
AND
NOT DB_Destroyed((ITEM)S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307)
AND
IsClosed(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, 1)
THEN
PROC_ItemUnlockAndOpen(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307);

IF
DialogEnded(PLA_TavernInvestigation_DesireDoor_b74d5928-f524-cc8f-f55f-4a665fd7aeac, _ID)
AND
DB_GlobalFlag((FLAG)PLA_Desire_Quest_BreakDoor_6e4af16c-bd4e-ae09-3c67-82c3da549fda)
AND
NOT DB_Destroyed((ITEM)S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307)
AND
IsClosed(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, 1)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
Die(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, DEATHTYPE.Physical, _Player, 0, 1, 25.0);

IF
Unlocked(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, _, _)
THEN
Open(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307);

IF
Opened(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307)
THEN
PROC_TryStopDialogFor(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);
SetFlag(PLA_TavernInvestigation_State_DesireFreed_6cbc6d66-e45a-4b98-a9df-59dfad97d1f0, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
LeftTrigger(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_DesireTrappedRoom_3063bdd1-3c92-4c46-9804-15098cfe54ad)
AND
NOT DB_GlobalFlag(PLA_Desire_Quest_OpenDoor_233986ed-f17a-f9a2-4ca5-918ce0488f3d) //Desire thanks the player if they open the door.
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_Quest_BreakDoor_6e4af16c-bd4e-ae09-3c67-82c3da549fda) //Desire thanks the player if they open the door.
AND
NOT DB_OnlyOnce("PLA_Desire_FirstThanks")
THEN
DB_SpotPlayers(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_CustomRadius(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire", 11.0);

IF
Opened(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307)
AND
DB_DialogName((DIALOGRESOURCE)PLA_TavernInvestigation_DesireDoor_b74d5928-f524-cc8f-f55f-4a665fd7aeac, _)
THEN
ClearFlag(PLA_Desire_Quest_OpenDoor_233986ed-f17a-f9a2-4ca5-918ce0488f3d, NULL_00000000-0000-0000-0000-000000000000, 0); //These block thanking dialogue, and if the door is opened during
ClearFlag(PLA_Desire_Quest_BreakDoor_6e4af16c-bd4e-ae09-3c67-82c3da549fda, NULL_00000000-0000-0000-0000-000000000000, 0); //the dialogue, it must've been opened by some outside force. The flags imply it was opened in the dialogue.
PROC_ForceStopDialog((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);

IF
DestroyingBy(S_PLA_TavernInvestigation_DesireDoor_4f19d4a7-b9b0-4a6f-a9ce-b2442ad8a307, _, _, _)
AND
DB_DialogName((DIALOGRESOURCE)PLA_TavernInvestigation_DesireDoor_b74d5928-f524-cc8f-f55f-4a665fd7aeac, _)
THEN
ClearFlag(PLA_Desire_Quest_OpenDoor_233986ed-f17a-f9a2-4ca5-918ce0488f3d, NULL_00000000-0000-0000-0000-000000000000, 0); //These block thanking dialogue, and if the door is opened during
ClearFlag(PLA_Desire_Quest_BreakDoor_6e4af16c-bd4e-ae09-3c67-82c3da549fda, NULL_00000000-0000-0000-0000-000000000000, 0); //the dialogue, it must've been opened by some outside force. The flags imply it was opened in the dialogue.
PROC_ForceStopDialog((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);

IF
DB_InRegion(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, TRIGGERGUID_S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30)
AND
DB_GlobalFlag(PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4)
THEN
SetFlag((FLAG)PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
DB_InRegion(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, TRIGGERGUID_S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30)
AND
DB_GlobalFlag(PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4)
AND
NOT QRY_PLA_DesireFreed()
AND
NOT DB_OnlyOnce("PLA_Desire_FirstThanks")
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire"); 

IF
DB_InRegion(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_DesireFreedTrigger2_6ecb7b16-2371-40de-b948-1f18d227d9d6)
THEN
SetFlag((FLAG)PLA_Desire_State_Freed2_46dbc8ef-61fa-42c4-bc89-4a8f53d53e5b, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global
DB_SpotPlayers(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_CustomRadius(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire", 11.0);
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire");

IF
LeftTrigger(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, TRIGGERGUID_S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30)
AND
NOT DB_InRegion(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_DesireFreedTrigger2_6ecb7b16-2371-40de-b948-1f18d227d9d6)
THEN
PROC_SpotPlayers_StopSpotting(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire");

IF
LeftTrigger(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_DesireFreedTrigger2_6ecb7b16-2371-40de-b948-1f18d227d9d6)
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_Knows_StelmaneTaken_215e6f0d-d0b3-3d5c-0b0a-7cad1ef3b2af) // Once Desire leaves, this is no longer relevant
THEN
ClearFlag((FLAG)PLA_Desire_State_Freed2_46dbc8ef-61fa-42c4-bc89-4a8f53d53e5b, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
LeftTrigger(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, TRIGGERGUID_S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30)
AND
NOT DB_GlobalFlag((FLAG)PLA_Desire_Knows_StelmaneTaken_215e6f0d-d0b3-3d5c-0b0a-7cad1ef3b2af) // Once Desire leaves, this is no longer relevant
THEN
ClearFlag((FLAG)PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

IF
LeftTrigger(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_DesireFreedTrigger2_6ecb7b16-2371-40de-b948-1f18d227d9d6)
AND
NOT DB_InRegion(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30)
THEN
PROC_SpotPlayers_StopSpotting(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, "PLA_Desire");

IF
DestroyedBy(S_PLA_Floor3_e8d5e5f9-90c6-423d-8d1c-73fbf3d08985, _, _, _)
AND
IsInTrigger(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_PLA_DesireTrappedRoom_3063bdd1-3c92-4c46-9804-15098cfe54ad, 1)
THEN
PROC_TryStartAD(PLA_Desire_AD_FloorCollapse_96f20c7d-d1ab-aae5-2f5a-6df05bd25afe, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);

QRY
QRY_PLA_Desire_Freed()
AND
DB_GlobalFlag(PLA_Desire_State_Freed_1c015349-190c-d49f-1d93-227886976509)
THEN
DB_NOOP(1);

QRY
QRY_PLA_Desire_Freed()
AND
DB_GlobalFlag(PLA_Desire_State_Freed2_46dbc8ef-61fa-42c4-bc89-4a8f53d53e5b)
THEN
DB_NOOP(1);
//END_REGION


//REGION Wyll OM

QRY
QRY_OriginMoment_PreventRelaunchDialog(_Dialog, _, _Player)
AND
DB_PLA_FlamingFistsDialogues(_Dialog)
AND
DB_GlobalFlag((FLAG)PLA_TavernInvestigation_Quest_WallCollapsed_391d017d-cbfb-768a-086d-ea404313eab4)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_PreventRelaunchDialog(_Dialog, _, _Player)
AND
DB_PLA_FlamingFistsDialogues(_Dialog)
AND
GetFlag(PLA_TavernInvestigation_State_TriedOnce_578df9b5-0b25-d7cc-0180-e29d765a63a4, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_PreventRelaunchDialog(_Dialog, _, _Player)
AND
DB_PLA_FlamingFistsDialogues(_Dialog)
AND
GetFlag(PLA_TavernInvestigation_State_TriedOnce_578df9b5-0b25-d7cc-0180-e29d765a63a4, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 1)
THEN
DB_NOOP(1);

//END_REGION

//REGION Fire screen shakes
IF
EntityEvent(_ScreenShakeHelper, "PLA_TavernInvestigation_FireCameraShake")
AND
NOT DB_PLA_TavernInvestigation_BlockCameraShake(1)
AND
IsInCombat(_ScreenShakeHelper, 0) // Play camera shakes only outside combat
AND
GetPosition(_ScreenShakeHelper, _X, _Y, _Z)
AND
GetClosestPlayerToPosition(_X, _Y, _Z, _Player, _Dist)
AND
_Dist < 10.0 // Only play if there's a player close
AND
Random(500, _Rand) // Camera shake duration between 1 and 1.5 seconds
AND
IntegerSum(100, _Rand, _Time)
THEN
DB_PLA_TavernInvestigation_BlockCameraShake(1);
ObjectTimerLaunch(_ScreenShakeHelper, "PLA_TavernInvestigation_BlockCameraShake", 10000);
PROC_CameraShakeAroundObject(_ScreenShakeHelper, _Time, 10.0);

IF
ObjectTimerFinished(_ScreenShakeHelper, "PLA_TavernInvestigation_BlockCameraShake")
THEN
NOT DB_PLA_TavernInvestigation_BlockCameraShake(1);
//END_REGION

//REGION Fire puddles
IF
DB_PLA_TavernInvestigation_FirePuddle(_Trigger, _CellMin, _CellMax, _GrowMin, _GrowMax, _GrowTime, _Approached)
THEN
PROC_TriggerRegisterForParty(_Trigger);

IF
EnteredTrigger(_, _Trigger)
AND
DB_PLA_TavernInvestigation_FirePuddle(_Trigger, _CellMin, _CellMax, _GrowMin, _GrowMax, _GrowTime, 0)
AND
GetDistanceTo(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, _Trigger, _Dist)
AND
_Dist > 10.0
THEN
NOT DB_PLA_TavernInvestigation_FirePuddle(_Trigger, _CellMin, _CellMax, _GrowMin, _GrowMax, _GrowTime, 0);
DB_PLA_TavernInvestigation_FirePuddle(_Trigger, _CellMin, _CellMax, _GrowMin, _GrowMax, _GrowTime, 1);
CreatePuddle(_Trigger, "SurfaceFire", _CellMin, _CellMax, _GrowMin, _GrowMax, _GrowTime);
PROC_TriggerUnregisterForParty(_Trigger);

PROC
PROC_PLA_BurnDownTavern()
AND
DB_PLA_TavernInvestigation_FirePuddle(_Trigger, _, _, _, _, _, 0)
THEN
PROC_TriggerUnregisterForParty(_Trigger);

PROC
PROC_PLA_BurnDownTavern()
AND
DB_PLA_TavernInvestigation_FirePuddle(_Trigger, _, _, _, _, _, _)
THEN
CreateSurface(_Trigger, "SurfaceAsh", 10.0, 0.0);
//END_REGION

//REGION Journal
IF
EnteredTrigger(_Player, S_PLA_Tavern_BuildingTrigger_16c5d3bb-422a-4bd8-a6a7-665d32d7303b)
THEN
QuestUpdate(_Player, "PLA_GrandDukeRescue", "EnteredInn");

IF
EnteredTrigger(_Player, S_PLA_DesireSideBuilding_b7f015ba-8712-4e08-953f-6177cc8b2830)
THEN
QuestUpdate(_Player, "PLA_GrandDukeRescue", "EnteredInn");

IF
EnteredTrigger(_Player, S_PLA_StuckHalfElf_Room1Box_98660638-e875-49d4-a0b0-95d39ae56728)
THEN
QuestUpdate(_Player, "PLA_GrandDukeRescue", "FoundStuckHalfElf");
//END_REGION

//REGION Flaming Fist react to Drow.

IF
DB_PLA_FlamingFist(_, _Character, _, _)
THEN
DB_SpotPlayers(_Character, "PLA_FlamingFists_CheckDrow", PLA_FlamingFists_Event_RestartCheckDrow_72fafb77-fb70-47da-8598-6bbd0d71f578, PLA_FlamingFists_Event_PersuadedDrow_f4938c3e-9353-44e8-9088-b8163d3222c8);

IF
DB_PLA_LeavingFlamingFistOutside(_Character)
THEN
DB_SpotPlayers(_Character, "PLA_FlamingFists_CheckDrow", PLA_FlamingFists_Event_RestartCheckDrow_72fafb77-fb70-47da-8598-6bbd0d71f578, PLA_FlamingFists_Event_PersuadedDrow_f4938c3e-9353-44e8-9088-b8163d3222c8);

PROC
PROC_SpotPlayers_Spotted(_Character, "PLA_FlamingFists_CheckDrow", _Player)
THEN
PROC_ForceStopDialog(S_PLA_FlamingFist5_c49b27b2-bd55-4c3f-a09a-7d787ab547ae);

PROC
PROC_SpotPlayers_Spotted(_Character, "PLA_FlamingFists_CheckDrow", _Player)
AND
NOT QRY_PLA_TavernInvestigation_StartDrowAttack(_Player)
THEN
DB_HostileToPlayerGroup((FACTION)ACT1_PLA_FlamingFists_b4e6e166-ea5f-50ef-6365-84c889f28238, _Player);
PROC_EnterCombat(_Character, _Player);

QRY
QRY_PLA_TavernInvestigation_StartDrowAttack((CHARACTER)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, S_PLA_FlamingFist5_c49b27b2-bd55-4c3f-a09a-7d787ab547ae)
AND
QRY_SelectAndStartDialog(S_PLA_FlamingFist5_c49b27b2-bd55-4c3f-a09a-7d787ab547ae, _Player)
AND
DB_SpotPlayers(_Character, "PLA_FlamingFists_CheckDrow", _, _)
THEN
PROC_SpotPlayers_StopSpotting(_Character, "PLA_FlamingFists_CheckDrow"); //Wait for the resolution of this dialogue to restart spotting.

IF
DB_SpotPlayers(_Character, "PLA_FlamingFists_CheckDrow", _, _)
THEN
DB_SpotPlayers_SpotterIgnoreCantTalk(_Character, "PLA_FlamingFists_CheckDrow");
DB_SpotPlayers_HasTag(_Character, "PLA_FlamingFists_CheckDrow", LOLTHDROWELF_ef9c5b74-56a8-48cc-b0b9-169ee16bf026, 1);

IF
LeftCombat(_Character, _)
AND
NOT DB_GlobalFlag((FLAG)PLA_FlamingFists_State_PersuadedDrow_d8bc1e0a-6e88-4890-ac53-6bc2457cfa6a)
AND
DB_SpotPlayers((CHARACTER)_Character, "PLA_FlamingFists_CheckDrow", _, _)
THEN
SetFlag(PLA_FlamingFists_Event_RestartCheckDrow_72fafb77-fb70-47da-8598-6bbd0d71f578, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(PLA_FlamingFists_State_PersuadedDrow_d8bc1e0a-6e88-4890-ac53-6bc2457cfa6a, _, _)
THEN
SetFlag(PLA_FlamingFists_Event_PersuadedDrow_f4938c3e-9353-44e8-9088-b8163d3222c8, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION Completing the goal
PROC
PROC_PLA_BurnDownTavern()
THEN
GoalCompleted;
//END_REGION

//REGION
IF
TextEvent("PLA_Tavern_BurnDown")
THEN
PROC_PLA_BurnDownTavern();
//END_REGION
EXITSECTION
TriggerUnregisterForCharacter(S_PLA_DesireTrappedRoom_3063bdd1-3c92-4c46-9804-15098cfe54ad, S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);
TriggerUnregisterForCharacter(S_PLA_DesireFreedTrigger_851f5f1e-8472-4fca-9da0-603620973c30, S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911);

PROC_TriggerUnregisterForPlayers(S_PLA_Tavern_BuildingTrigger_16c5d3bb-422a-4bd8-a6a7-665d32d7303b);
PROC_TriggerUnregisterForPlayers(S_PLA_StuckHalfElf_Room1Box_98660638-e875-49d4-a0b0-95d39ae56728);
PROC_TriggerUnregisterForPlayers(S_PLA_DesireSideBuilding_b7f015ba-8712-4e08-953f-6177cc8b2830);

NOT DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("PLA_FlamingFists",PLA_FlamingFists_State_DefeatCounter_e4c4ad77-ddc0-4802-9374-7971f0c1fd82);
ENDEXITSECTION
ParentTargetEdge "Act1"
