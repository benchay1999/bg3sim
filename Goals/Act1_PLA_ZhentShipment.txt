Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Dialogues
DB_Dialogs(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_Cave_94dbe10c-0be7-7bef-85ee-35a617603716);
DB_Dialogs(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, (DIALOGRESOURCE)PLA_ZhentShipment_Agent_002_5198e66c-1609-e216-ddde-9663b3caee09);

DB_Inclusion_Object(
	S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, 
	(FLAG)PLA_ZhentShipment_Agent_002_StartInclusion_59a7ae31-e46c-986f-658f-890f9f9def69, 
	(FLAG)PLA_ZhentShipment_Agent_002_EndInclusion_2bad0ac9-2099-42ce-b11a-741b467ac028);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)PLA_ZhentDungeon_Zhent02_CaughtUp_96d44f6a-6ecc-00fb-298e-f0732fc77196,S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_ba3b62b6-9ca9-2e36-eec0-8d7272a14c8a,S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_Cave_94dbe10c-0be7-7bef-85ee-35a617603716,S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c);

DB_DialogBlockTradeButton((DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_Cave_94dbe10c-0be7-7bef-85ee-35a617603716);
DB_DialogBlockTradeButton((DIALOGRESOURCE)PLA_ZhentShipment_Agent_002_5198e66c-1609-e216-ddde-9663b3caee09);

DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_ba3b62b6-9ca9-2e36-eec0-8d7272a14c8a, 150, 1, 1); // Rugan paying to player
//DB_DialogMoneyTransfer(2, DIALOGRESOURCEGUID_PLA_ZhentShipment_Agent_001_ba3b62b6-9ca9-2e36-eec0-8d7272a14c8a, 50, 3, 1); // Olly paying to player
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_Cave_94dbe10c-0be7-7bef-85ee-35a617603716, 150, 1, 1); // Rugan paying to player

DB_GlobalFlagReactionAfterDialog((FLAG)PLA_ZhentShipment_Event_ProvokeGnolls_b7fe3fee-61ce-7d8d-64a6-519f0dc610cb, (DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_Cave_94dbe10c-0be7-7bef-85ee-35a617603716);
//END_REGION Dialogues

//REGION SwD
DB_GLO_CharacterCorpseDialog(S_PLA_ZhentShipment_Agent_003_3c3f7d7c-6d91-4aa4-bec4-dbb7c2c12ea6, (DIALOGRESOURCE)PLA_ZhentShipment_Agent_003_SwD_2849e535-df84-70d3-e039-b224d1267747);
DB_GLO_CharacterCorpseDialog(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, (DIALOGRESOURCE)PLA_ZhentShipment_Agent_002_SpeakWithDead_190282f6-8d99-36b6-a762-7362c0898a79);
DB_GLO_CharacterCorpseDialog(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_SpeakWithDead_d7d827b3-24ce-dcc5-6e69-9bf1efd50902);
//END_REGION SwD

//REGION Agents
DB_PLA_ZhentShipment_Agents((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
DB_PLA_ZhentShipment_Agents(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c);

DB_PLA_ZhentShipment_AliveAgents((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
DB_PLA_ZhentShipment_AliveAgents(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c);

DB_SeenDeadNPCPartyFlag(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, PLA_ZhentShipment_State_Agent001Dead_62feb5b3-ecfd-4e43-ba22-e52d4e352f46);
DB_SeenDeadNPCPartyFlag(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, PLA_ZhentShipment_State_Agent002Dead_f51a12b5-e82a-4d88-a8c9-46ad0375107a);

AddSpell(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "Projectile_PLA_FakeAlchemistFire", 0, 0);
AddSpell(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, "Projectile_PLA_FakeAlchemistFire", 0, 0);

ApplyStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "SWEATY", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "DIRT_COVERED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "SWEATY", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, "BLOOD_COVERED_SLIGHT", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Agents

//REGION Spotting
DB_SpotPlayers(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_AgentSpotter", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_AgentSpotter");
DB_SpotPlayers_SpotTrigger(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_AgentSpotter", (TRIGGER)S_PLA_ZhentShipment_Agent_001_SpotTrigger_1d8f916d-d524-4da6-a9f7-07551fdb5061);
//END_REGION Spotting

//REGION Misc setups
SetFlag((FLAG)PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC_SetHitpointsPercentage_BlockSelfHealing(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, 75.0);
PROC_SelfHealing_Disable(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
AddGold(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, 150);

PROC_TriggerRegisterForPlayers(TRIGGERGUID_S_PLA_ZhentShipment_WreckedCaravanArea_86c8011d-dc85-4b6f-ac98-fb8a60ae5b3a);
PROC_TriggerRegisterForParty(S_PLA_ZhentShipment_StartThrowingAlchFireArea_48f9b38a-0730-4f16-8a05-11f5c2f4bcd2);
PROC_TriggerRegisterForParty(S_PLA_ZhentShipment_StopThrowingAlchFireArea_ab77f4ff-7185-49cc-a104-9c4841d8fcdc);
PROC_TriggerRegisterForParty(TRIGGERGUID_S_PLA_ZhentShipment_GnollsBorderTrigger_f42b580d-5dec-4261-959c-27cfeaec20a0);
PROC_TriggerRegisterForParty(S_PLA_ZhentShipment_NoticingZhentsArea_9741f301-f369-4ecc-b9f1-fe48d8bb107a);
PROC_PLA_ZhentShipment_RegisterGnollsBorder();

DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(0);

DB_PLA_ZhentShipment_CanThrowAlchFire(1);
DB_PLA_ZhentShipment_PreviousAgentWhoHasThrown((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);

PROC_PLA_ZhentShipment_DisableCrimesOnGnolls();
//END_REGION Misc setups

//REGION Items onwership
DB_ItemOwnerShipTriggers("WLD_Main_A", S_PLA_ZhentShipment_OwnershipTrigger_893e9484-b653-4032-af9f-cdc28009bf13, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);

DB_PLA_ZhentShipment_Flasks((ITEM)S_GLO_CursedIronFlask_83b010d4-7f1a-448c-9475-176347962cb2);

TriggerRegisterForItems(S_PLA_ZhentShipment_OwnershipTrigger_893e9484-b653-4032-af9f-cdc28009bf13);
DB_PLA_ZhentShipment_FireFlasksOnTheGround((ITEM)S_PLA_ZhentShipment_FireFlask_A_000_4c97243c-3dff-4d90-95c2-53f1277d0d2d);
DB_PLA_ZhentShipment_FireFlasksOnTheGround((ITEM)S_PLA_ZhentShipment_FireFlask_A_001_fccfb63d-4852-491c-a673-af08a5a439e8);
DB_PLA_ZhentShipment_FireFlasksOnTheGround((ITEM)S_PLA_ZhentShipment_FireFlask_A_002_82b8d647-868e-49a0-903d-8bea7dca1bc7);
DB_PLA_ZhentShipment_FireFlasksOnTheGround((ITEM)S_PLA_ZhentShipment_FireFlask_A_003_6425e8ac-a52c-4880-b687-c3665ef3e324);
//END_REGION Items onwership

//REGION Autosave
DB_AutoSaveTrigger((TRIGGER)S_PLA_ZhentDungeon_Autosave_ccd905fb-b68a-4cc8-85e3-90de349f3931);
//END_REGION
KBSECTION
//REGION Switching Agent001 Main dialog
IF
FlagSet(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a, _, _)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
THEN
PROC_PLA_ZhentShipment_SwitchDialogToSecondPhase();

IF
FlagSet(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
THEN
PROC_PLA_ZhentShipment_SwitchDialogToSecondPhase();

PROC
PROC_PLA_ZhentShipment_SwitchDialogToSecondPhase()
THEN
PROC_SpotPlayers_ClearSpotTrigger(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_AgentSpotter");
PROC_RemoveDialog((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4);
DB_Dialogs(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (DIALOGRESOURCE)PLA_ZhentShipment_Agent_001_ba3b62b6-9ca9-2e36-eec0-8d7272a14c8a);

// Rugan (Agent001) interfere and starts dialog with the player instead of Olly (Agent002) if player has not talked to him yet
IF
DialogStartRequested(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, (CHARACTER)_Player)
AND
NOT DB_OnlyOnce("PLA_ZhentShipment_AgentSpotter_InitialDialogStarted")
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_HasMet_5359e72b-f8ca-d2d6-4c3a-8fc00efe5c2c)
AND
NOT DB_Defeated((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_Dialogs(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (DIALOGRESOURCE)_Dialog)
AND
QRY_StartDialog_Fixed(_Dialog, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Player)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentSpotter_InitialDialogStarted")
THEN
PROC_PLA_ZhentShipment_AgentsStopSpotting();
//END_REGION Switching Agent001 Main dialog

//REGION Auto-dialog on SPOT
PROC
PROC_SpotPlayers_Spotted(_Agent, _, _Player)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
DB_Players(_Player)
AND
QRY_PLA_ConflictedFlind_NotEncounteredOrGone()
AND
NOT QRY_PLA_ZhentShipment_AreZhentsAndPlayerHostile(_Player)
THEN
PROC_PLA_ZhentShipment_StartSpotDialog(_Agent, _Player);

QRY
QRY_PLA_ConflictedFlind_NotEncounteredOrGone()
AND
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_NotEncountered_c4bed850-2d45-4806-bc6d-5d778e60cde4)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ConflictedFlind_NotEncounteredOrGone()
AND
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
THEN
DB_NOOP(1);

PROC
PROC_PLA_ZhentShipment_StartSpotDialog((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("PLA_ZhentShipment_AgentSpotter_SpotDialogStarted")
AND
DB_Dialogs(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (DIALOGRESOURCE)_Dialog)
AND
QRY_StartDialog(_Dialog, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Player)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentSpotter_SpotDialogStarted")
THEN
PROC_PLA_ZhentShipment_AgentsStopSpotting();

PROC
PROC_PLA_ZhentShipment_StartSpotDialog((CHARACTER)S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, (CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("PLA_ZhentShipment_AgentSpotter_SpotDialogStarted")
AND
NOT DB_Defeated((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_Dialogs(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (DIALOGRESOURCE)_Dialog)
AND
QRY_StartDialog(_Dialog, S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Player)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentSpotter_SpotDialogStarted")
THEN
PROC_PLA_ZhentShipment_AgentsStopSpotting();

PROC
PROC_PLA_ZhentShipment_StartSpotDialog((CHARACTER)S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, (CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("PLA_ZhentShipment_AgentSpotter_SpotDialogStarted")
AND
DB_Dialogs(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, (DIALOGRESOURCE)_Dialog)
AND
QRY_StartDialog(_Dialog, S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, _Player)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentSpotter_SpotDialogStarted")
THEN
PROC_PLA_ZhentShipment_AgentsStopSpotting();

// Enable auto-spotting for Olly after Rugan dies
IF
FlagCleared(PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f, _, _)
AND
NOT DB_PermaDefeated(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_HasMet_5359e72b-f8ca-d2d6-4c3a-8fc00efe5c2c)
AND
DB_SpotPlayers(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "PLA_ZhentShipment_AgentSpotter", _, _)
THEN
DB_SpotPlayers_CustomRadius(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, "PLA_ZhentShipment_AgentSpotter", 8.0);
DB_SpotPlayers(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, "PLA_ZhentShipment_AgentSpotter", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

// Enable auto-spotting for Olly with a small radius after gnolls are gone
//IF
//FlagSet(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
//AND
//NOT DB_Defeated(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
//AND
//NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_HasMet_5359e72b-f8ca-d2d6-4c3a-8fc00efe5c2c)
//AND
//NOT DB_SpotPlayers(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, "PLA_ZhentShipment_AgentSpotter", _, _)
//THEN
//DB_SpotPlayers_CustomRadius(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, "PLA_ZhentShipment_AgentSpotter", 6.0);
//DB_SpotPlayers(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, "PLA_ZhentShipment_AgentSpotter", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a, _, _)
THEN
PROC_PLA_ZhentShipment_AgentsStopSpotting();

IF
FlagSet(PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1, _, _)
THEN
PROC_PLA_ZhentShipment_AgentsStopSpotting();

IF
FlagSet(PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e, _, _)
THEN
PROC_PLA_ZhentShipment_AgentsStopSpotting();

PROC
PROC_PLA_ZhentShipment_AgentsStopSpotting()
AND
DB_PLA_ZhentShipment_AliveAgents((CHARACTER)_Agent)
THEN
PROC_SpotPlayers_StopSpotting(_Agent, "PLA_ZhentShipment_AgentSpotter");

// Try start dialog immediately for Rugan after combat if they joined it, but player never talked to agents
IF
FlagSet(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
AND
NOT DB_Defeated((CHARACTER)S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_TalkedToRugan_8100f823-5ecf-b1b8-497f-d151d980bcd2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
GetClosestAlivePlayer(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Player, _Dist)
AND
_Dist < 25.0
AND
QRY_OnlyOnce("PLA_ZhentShipment_RuganMoveToAndTalk")
THEN
PROC_CharacterMoveToAndTalk(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _Player, PLA_ZhentShipment_Agent_001_ba3b62b6-9ca9-2e36-eec0-8d7272a14c8a, "PLA_ZhentShipment_Event_RuganMovedToAndTalked", "Run", 20.0);

IF
EntityEvent(_, "PLA_ZhentShipment_Event_RuganMovedToAndTalked")
THEN
PROC_PLA_ZhentShipment_AgentsStopSpotting();

IF
FlagSet(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
AND
DB_DialogBlockTradeButton((DIALOGRESOURCE)PLA_ZhentShipment_Agent_002_5198e66c-1609-e216-ddde-9663b3caee09)
THEN
NOT DB_DialogBlockTradeButton((DIALOGRESOURCE)PLA_ZhentShipment_Agent_002_5198e66c-1609-e216-ddde-9663b3caee09);
//END_REGION Auto-dialog on SPOT

//REGION Voice barks about the caravan, gnolls etc
IF
EnteredTrigger(_Player, TRIGGERGUID_S_PLA_ZhentShipment_WreckedCaravanArea_86c8011d-dc85-4b6f-ac98-fb8a60ae5b3a)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Knows_SurvivorsInCave_6318e058-45f9-4640-a9f5-59489fccb843)
AND
NOT DB_CantTalk(_Player)
AND
QRY_OncePerUserAndNearbyPlayers(_Player, "PLA_ZhentShipment_FoundCaravan")
THEN
StartVoiceBark(VOICEBARKRESOURCEGUID_PLA_ZhentShipment_VB_WreckedCaravan_b6599109-8246-4827-6cce-45b6e667a8d0, _Player);
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_Quest_FoundCaravan_f67929e9-34cc-45d0-a828-f7df4f298633);

IF
FlagSet((FLAG)PLA_ZhentShipment_Quest_HasMet_5359e72b-f8ca-d2d6-4c3a-8fc00efe5c2c, NULL_00000000-0000-0000-0000-000000000000, _)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_Knows_SurvivorsInCave_6318e058-45f9-4640-a9f5-59489fccb843)
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ZhentShipment_Knows_SurvivorsInCave_6318e058-45f9-4640-a9f5-59489fccb843);

IF
FlagSet((FLAG)PLA_ZhentShipment_Knows_SurvivorsAreDead_d889b0c1-89aa-480f-9735-b24f04525453, NULL_00000000-0000-0000-0000-000000000000, _)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_Knows_SurvivorsInCave_6318e058-45f9-4640-a9f5-59489fccb843)
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ZhentShipment_Knows_SurvivorsInCave_6318e058-45f9-4640-a9f5-59489fccb843);
//END_REGION Voice barks about the caravan, gnolls etc

//REGION Throwing alchemist fire
IF
EnteredTrigger(_Player, S_PLA_ZhentShipment_StartThrowingAlchFireArea_48f9b38a-0730-4f16-8a05-11f5c2f4bcd2)
AND
DB_PLA_ZhentShipment_CanThrowAlchFire(1)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f)
AND
GetFlag(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
DB_PartyMembers((CHARACTER)_Player)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a);  

IF
EnteredTrigger(_Player, S_PLA_ZhentShipment_StopThrowingAlchFireArea_ab77f4ff-7185-49cc-a104-9c4841d8fcdc)
AND
DB_PLA_ZhentShipment_CanThrowAlchFire(1)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f)
AND
GetFlag(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_PartyMembers(_Player)
THEN
ClearFlag(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
LeftTrigger(_Player, S_PLA_ZhentShipment_StopThrowingAlchFireArea_ab77f4ff-7185-49cc-a104-9c4841d8fcdc)
AND
DB_PLA_ZhentShipment_CanThrowAlchFire(1)
AND
QRY_PLA_ZhentShipment_AgentsHaveFireFlasks()
AND
DB_GlobalFlag(PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f)
AND
GetFlag(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
DB_PartyMembers(_Player)
AND
IsInTrigger(_Player, S_PLA_ZhentShipment_StartThrowingAlchFireArea_48f9b38a-0730-4f16-8a05-11f5c2f4bcd2, 1)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a);  

PROC
PROC_PLA_ZhentShipment_StopThrowingAlchFire()
AND
DB_PLA_ZhentShipment_CanThrowAlchFire(1)
THEN
PROC_TriggerUnregisterForParty(S_PLA_ZhentShipment_StopThrowingAlchFireArea_ab77f4ff-7185-49cc-a104-9c4841d8fcdc);
PROC_TriggerUnregisterForParty(S_PLA_ZhentShipment_StartThrowingAlchFireArea_48f9b38a-0730-4f16-8a05-11f5c2f4bcd2);
ClearFlag(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_TriggerUnregisterForItemsWhenInLevel(S_PLA_ZhentShipment_OwnershipTrigger_893e9484-b653-4032-af9f-cdc28009bf13,"WLD_Main_A"); 

PROC
PROC_PLA_ZhentShipment_StopThrowingAlchFire()
AND
DB_PLA_ZhentShipment_CanThrowAlchFire(1)
THEN
NOT DB_PLA_ZhentShipment_CanThrowAlchFire(1);

PROC
PROC_ConflictedFlind_OnStateChanged(_OldFlag, _)
AND
_OldFlag != PLA_ConflictedFlind_State_NotEncountered_c4bed850-2d45-4806-bc6d-5d778e60cde4
THEN
PROC_PLA_ZhentShipment_StopThrowingAlchFire();

IF
DialogStarted(PLA_ZhentShipment_Agent_001_Cave_94dbe10c-0be7-7bef-85ee-35a617603716, _)
AND
DB_PLA_ZhentShipment_CanThrowAlchFire(1)
AND
GetFlag(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
ClearFlag(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogEnded(PLA_ZhentShipment_Agent_001_Cave_94dbe10c-0be7-7bef-85ee-35a617603716, _)
AND
DB_PLA_ZhentShipment_CanThrowAlchFire(1)
AND
GetFlag(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a);
//END_REGION Throwing alchemist fire

//REGION Bookkeeping Flame Flasks (for cases of pickpocketing / stealing)
QRY
QRY_PLA_ZhentShipment_AgentsHaveFireFlasks()
AND
QRY_PLA_ZhentShipment_AgentsHaveFireFlaskOnTheGround()
THEN
DB_NOOP(1);

QRY
QRY_PLA_ZhentShipment_AgentsHaveFireFlasks()
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
QRY_PLA_ZhentShipment_AgentHasFireFlaskInInventory(_Agent)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ZhentShipment_AgentsHaveFireFlaskOnTheGround()
AND
DB_PLA_ZhentShipment_FireFlasksOnTheGround(_)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ZhentShipment_AgentHasFireFlaskInInventory((CHARACTER)_Agent)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
TemplateIsInInventory(GRN_FireFlask_A_0b1aa718-fe45-4e4c-8811-ced51c581075, _Agent, (INTEGER)_FlasksCount)
AND
_FlasksCount > 0
THEN
DB_NOOP(1);

IF
TemplateRemovedFrom(GRN_FireFlask_A_0b1aa718-fe45-4e4c-8811-ced51c581075, (ITEM)_Item, (CHARACTER)_Agent)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
PROC_PLA_ZhentShipment_StopThrowingIfNoFlasksLeft();

// Bookkeeping flasks on the ground
IF
TemplateAddedTo(GRN_FireFlask_A_0b1aa718-fe45-4e4c-8811-ced51c581075, _Item, _Holder, _)
AND
DB_PLA_ZhentShipment_FireFlasksOnTheGround((ITEM)_Item)
THEN
NOT DB_PLA_ZhentShipment_FireFlasksOnTheGround(_Item);
PROC_PLA_ZhentShipment_StopThrowingIfNoFlasksLeft();

IF
TemplateEnteredTrigger(GRN_FireFlask_A_0b1aa718-fe45-4e4c-8811-ced51c581075, (ITEM)_Item, S_PLA_ZhentShipment_OwnershipTrigger_893e9484-b653-4032-af9f-cdc28009bf13, _, _)
AND
IsInInventory(_Item, 0)
AND
NOT DB_PLA_ZhentShipment_FireFlasksOnTheGround(_Item)
THEN
DB_PLA_ZhentShipment_FireFlasksOnTheGround(_Item);

IF
TemplateLeftTrigger(GRN_FireFlask_A_0b1aa718-fe45-4e4c-8811-ced51c581075, (ITEM)_Item, S_PLA_ZhentShipment_OwnershipTrigger_893e9484-b653-4032-af9f-cdc28009bf13, _, _)
AND
DB_PLA_ZhentShipment_FireFlasksOnTheGround(_Item)
THEN
NOT DB_PLA_ZhentShipment_FireFlasksOnTheGround(_Item);
PROC_PLA_ZhentShipment_StopThrowingIfNoFlasksLeft();
//END_REGION Bookkeeping Flame Flasks (for cases of pickpocketing / stealing)

//REGION Running out of flasks / depleting
IF
DialogEnded(PLA_ZhentShipment_Agent_001_Cave_94dbe10c-0be7-7bef-85ee-35a617603716, _)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_CanThrowActualFlasks_dd620c49-a2c2-4f2b-9f09-a894e78ddc2f)
AND
DB_PLA_ZhentShipment_CanThrowAlchFire(1)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_CanThrowActualFlasks_dd620c49-a2c2-4f2b-9f09-a894e78ddc2f);

IF
RequestPickpocket(_Player, _Agent)
AND
DB_Players(_Player)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_CanThrowActualFlasks_dd620c49-a2c2-4f2b-9f09-a894e78ddc2f)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_CanThrowActualFlasks_dd620c49-a2c2-4f2b-9f09-a894e78ddc2f);

IF
FlagSet(PLA_ZhentShipment_State_TouchedChest_1db4a628-dc86-4142-83cb-fe27d69532ef, _, _)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_CanThrowActualFlasks_dd620c49-a2c2-4f2b-9f09-a894e78ddc2f)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_CanThrowActualFlasks_dd620c49-a2c2-4f2b-9f09-a894e78ddc2f);

// When this proc is first called, that's means now we want to depleate flasks
PROC
PROC_PLA_ZhentShipment_StopThrowingIfNoFlasksLeft()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_CanThrowActualFlasks_dd620c49-a2c2-4f2b-9f09-a894e78ddc2f)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_CanThrowActualFlasks_dd620c49-a2c2-4f2b-9f09-a894e78ddc2f);

PROC
PROC_PLA_ZhentShipment_StopThrowingIfNoFlasksLeft()
AND 
NOT QRY_PLA_ZhentShipment_AgentsHaveFireFlasks()
AND
QRY_OnlyOnce("PLA_ZhentShipment_OnOutOfFlasks")
THEN
PROC_PLA_ZhentShipment_OnOutOfFlasks();
PROC_PLA_ZhentShipment_StopThrowingAlchFire();

// Actually item removing from inventory
IF
CastedSpell(_Agent, "Projectile_PLA_FakeAlchemistFire", _, _, _)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_CanThrowActualFlasks_dd620c49-a2c2-4f2b-9f09-a894e78ddc2f)
AND
DB_PLA_ZhentShipment_AliveAgents((CHARACTER)_Agent)
AND
QRY_TriggerEvents_AnyPartyMemberInTrigger((TRIGGER)S_PLA_ZhentShipment_FlaskDepleteThrowingArea_938f9004-ca1e-4473-b3e9-2874d2ef8d25)
THEN
TemplateRemoveFrom(GRN_FireFlask_A_0b1aa718-fe45-4e4c-8811-ced51c581075, _Agent, 1);
PROC_PLA_ZhentShipment_StopThrowingIfNoFlasksLeft();
PROC_PLA_ZhentShipment_PickupFlaskIfNoLeftInInventory(_Agent);

PROC
PROC_PLA_ZhentShipment_PickupFlaskIfNoLeftInInventory((CHARACTER)_Agent)
AND
QRY_OnlyOnce_Reset("PLA_ZhentShipment_TryPickupFlask")
AND
QRY_PLA_ZhentShipment_AgentsHaveFireFlaskOnTheGround()
AND
NOT QRY_PLA_ZhentShipment_AgentHasFireFlaskInInventory(_Agent)
AND
DB_PLA_ZhentShipment_FireFlasksOnTheGround((ITEM)_Flask)
AND
QRY_OnlyOnce("PLA_ZhentShipment_TryPickupFlask")
THEN
SetDualEntityEvent(_Agent, _Flask, "PLA_ZhentShipment_Event_PickupFlask", 1);

PROC
PROC_PLA_ZhentShipment_OnOutOfFlasks()
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
SetEntityEvent(_Agent, "PLA_ZhentShipment_Event_OutOfFlasks", 1);
TimerLaunch("PLA_ZhentShipment_OnOutOfFlasks_Timer", 8000);

PROC
PROC_PLA_ZhentShipment_OnOutOfFlasks()
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f)
THEN
PROC_PLA_ZhentShipment_GnollsInstigatingAfterOutOfFlasks();

IF
TimerFinished("PLA_ZhentShipment_OnOutOfFlasks_Timer")
THEN
PROC_PLA_ZhentShipment_GnollsInstigatingAfterOutOfFlasks();

PROC
PROC_PLA_ZhentShipment_GnollsInstigatingAfterOutOfFlasks()
THEN
PROC_PLA_ConflictedFlind_StartInstigate(0);
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(0);
PROC_PLA_ZhentShipment_DefendPositions();

// Pickup events from Anubis
IF
EntityEvent((CHARACTER)_Agent, "PLA_ZhentShipment_Event_NoFlasksInPocket")
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
PROC_PLA_ZhentShipment_StopThrowingIfNoFlasksLeft();
PROC_PLA_ZhentShipment_PickupFlaskIfNoLeftInInventory(_Agent);

IF
EntityEvent((ITEM)_Flask, "PLA_ZhentShipment_Event_FlaskUnreachable")
AND
DB_PLA_ZhentShipment_FireFlasksOnTheGround(_Flask)
THEN
NOT DB_PLA_ZhentShipment_FireFlasksOnTheGround(_Flask);
//END_REGION Running out of flasks / depleting

//REGION Flasks throwing - Anubis behaviour messaging
IF
FlagSet(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a, _, _)
AND
QRY_PLA_ZhentShipment_FindNextAgentToThrow()
AND
DB_PLA_ZhentShipment_NextAgentToThrowFlask(_Agent)
THEN
SetEntityEvent(_Agent, "PLA_ZhentShipment_Event_PrepareThrow", 1);

IF
EntityEvent((CHARACTER)_Gnoll, "PLA_ConflictedFlind_Event_GnollRushesIntoFire")
AND
QRY_PLA_ZhentShipment_FindNextAgentToThrow()
AND
DB_PLA_ZhentShipment_NextAgentToThrowFlask(_Agent)
THEN
SetDualEntityEvent(_Agent, S_PLA_ConflictedFlind_BehindFireTrigger_850796f3-766e-4955-acf7-1490796ebe5a, "PLA_ZhentShipment_Event_PrepareThrow");
PROC_PLA_ZhentShipment_StartPreclusiveThrowingTimer();
DB_PLA_ZhentShipment_PreviousAgentWhoHasThrown(_Agent);

IF
TimerFinished("PLA_ZhentShipment_PreclusiveThrowing_Timer")
AND
DB_GlobalFlag(PLA_ZhentShipment_State_ZhentsThrowAlchFire_ce92177b-1162-4dc2-980f-ec64f3085c7a)
AND
QRY_PLA_ZhentShipment_FindNextAgentToThrow()
AND
DB_PLA_ZhentShipment_NextAgentToThrowFlask(_Agent)
THEN
SetEntityEvent(_Agent, "PLA_ZhentShipment_Event_PrepareThrow", 1);
DB_PLA_ZhentShipment_PreviousAgentWhoHasThrown(_Agent);

IF
TimerFinished("PLA_ZhentShipment_PreclusiveThrowing_Timer")
AND
DB_PLA_ZhentShipment_CanThrowAlchFire(1)
THEN
PROC_PLA_ZhentShipment_StartPreclusiveThrowingTimer();

PROC
PROC_PLA_ZhentShipment_StartPreclusiveThrowingTimer()
AND
Random(5000, _Random)
AND
IntegerSum(_Random, 7000, _Time)
THEN
TimerCancel("PLA_ZhentShipment_PreclusiveThrowing_Timer");
TimerLaunch("PLA_ZhentShipment_PreclusiveThrowing_Timer", _Time);

QRY
QRY_PLA_ZhentShipment_FindNextAgentToThrow()
AND
QRY_OnlyOnce_Reset("PLA_ZhentShipment_NextAgentToThrowFlask")
AND
DB_PLA_ZhentShipment_NextAgentToThrowFlask(_Agent)
THEN
NOT DB_PLA_ZhentShipment_NextAgentToThrowFlask(_Agent);

// First, try to find agent who didn't throw last time
QRY
QRY_PLA_ZhentShipment_FindNextAgentToThrow()
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
NOT DB_PLA_ZhentShipment_PreviousAgentWhoHasThrown(_Agent)
AND
QRY_PLA_ZhentShipment_AgentHasFireFlaskInInventory(_Agent)
AND
QRY_OnlyOnce("PLA_ZhentShipment_NextAgentToThrowFlask")
THEN
DB_PLA_ZhentShipment_NextAgentToThrowFlask(_Agent);

// If no one was found, try to use the one who threw last time
QRY
QRY_PLA_ZhentShipment_FindNextAgentToThrow()
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
DB_PLA_ZhentShipment_PreviousAgentWhoHasThrown(_Agent)
AND
NOT DB_PLA_ZhentShipment_NextAgentToThrowFlask(_)
AND
QRY_PLA_ZhentShipment_AgentHasFireFlaskInInventory(_Agent)
AND
QRY_OnlyOnce("PLA_ZhentShipment_NextAgentToThrowFlask")
THEN
DB_PLA_ZhentShipment_NextAgentToThrowFlask(_Agent);

// Cycle clearing
IF
DB_PLA_ZhentShipment_PreviousAgentWhoHasThrown(_Agent)
AND
SysCount("DB_PLA_ZhentShipment_PreviousAgentWhoHasThrown", 1, _CountThrown)
AND
SysCount("DB_PLA_ZhentShipment_AliveAgents", 1, _CountAlive)
AND
_CountThrown >= _CountAlive
AND
DB_PLA_ZhentShipment_PreviousAgentWhoHasThrown(_OtherAgent)
AND
_OtherAgent != _Agent
THEN
NOT DB_PLA_ZhentShipment_PreviousAgentWhoHasThrown(_OtherAgent);
//END_REGION Flasks throwing - Anubis behaviour messaging

//REGION Zhents start combat with gnolls after initial dialog
IF
FlagSet(PLA_ZhentShipment_State_AgreedToHelpInBattle_185140b4-9dec-49d7-abad-e6e628cdf4cd, _, _)
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndPlayersAllies();

IF
DialogEnded(PLA_ZhentShipment_Agent_001_Cave_94dbe10c-0be7-7bef-85ee-35a617603716, _InstanceID)
AND
DB_DialogPlayers(_InstanceID, _Player, 1)
AND
DB_GlobalFlag(PLA_ZhentShipment_Event_AgentsAttackGnolls_e9e42b1f-91ec-0779-013a-639bc8bc3f5e)
AND
NOT DB_PLA_ZhentShipment_PlayerAgreedToHelpInDialog(_Player)
AND
NOT DB_PLA_ZhentShipment_AgentsAttackingGnolls(1)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentsStartCombat")
THEN
DB_PLA_ZhentShipment_PlayerAgreedToHelpInDialog(_Player);
DB_PLA_ZhentShipment_AgentsAttackingGnolls(1);
TimerLaunch("PLA_ZhentShipment_AgentsStartCombatThrow_Timer", 5000);
TimerLaunch("PLA_ZhentShipment_AgentsStartCombatRun_Timer", 10000); // backup timer in case something goes wrong in the Anubis script

IF
TimerFinished("PLA_ZhentShipment_AgentsStartCombatThrow_Timer")
AND
QRY_PLA_ZhentShipment_FindNextAgentToThrow()
AND
DB_PLA_ZhentShipment_NextAgentToThrowFlask(_Agent)
THEN
SetDualEntityEvent(_Agent, S_PLA_ConflictedFlind_GnollRanger02_BasePos_c85cb0a9-27cd-4524-a072-e121906b555d, "PLA_ZhentShipment_Event_PrepareThrow", 1);

IF
EntityEvent((CHARACTER)_Agent, "PLA_ZhentShipment_FireFlaskThrown")
AND
DB_PLA_ZhentShipment_Agents(_Agent)
THEN
PROC_PLA_ZhentShipment_RunAwayAfterAttackingGnolls();

IF
EntityEvent((CHARACTER)_Agent, "PLA_ZhentShipment_Event_NoFlasksInPocket")
AND
DB_PLA_ZhentShipment_Agents(_Agent)
THEN
PROC_PLA_ZhentShipment_RunAwayAfterAttackingGnolls();

IF
TimerFinished("PLA_ZhentShipment_AgentsStartCombatRun_Timer")
THEN
PROC_PLA_ZhentShipment_RunAwayAfterAttackingGnolls();

PROC
PROC_PLA_ZhentShipment_RunAwayAfterAttackingGnolls()
AND
DB_PLA_ZhentShipment_AgentsAttackingGnolls(1)
AND
DB_GlobalFlag(PLA_ZhentShipment_Event_AgentsAttackGnolls_e9e42b1f-91ec-0779-013a-639bc8bc3f5e)
THEN
NOT DB_PLA_ZhentShipment_AgentsAttackingGnolls(1);
PROC_PLA_ZhentShipment_CoverPositions();
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(0);
PROC_PLA_ConflictedFlind_StartInstigate(0);
TimerLaunch("PLA_ZhentShipment_AgentsStartCombatHostility_Timer", 3000);

IF
TimerFinished("PLA_ZhentShipment_AgentsStartCombatHostility_Timer")
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();

IF
TimerFinished("PLA_ZhentShipment_AgentsStartCombatHostility_Timer")
AND
DB_PLA_ZhentShipment_AliveAgents((CHARACTER)_Agent)
AND
NOT DB_Is_InCombat(_Agent, _)
AND
DB_GlobalFlag(PLA_ZhentShipment_Event_AgentsAttackGnolls_e9e42b1f-91ec-0779-013a-639bc8bc3f5e)
THEN
PROC_EnterCombat(_Agent, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0);

// Dragging player into the combat after zhents threw fire flask at gnolls
IF
EnteredCombat((CHARACTER)_Gnoll, _CombatID)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_AgreedToHelpInBattle_185140b4-9dec-49d7-abad-e6e628cdf4cd)
AND
DB_GlobalFlag(PLA_ZhentShipment_Event_AgentsAttackGnolls_e9e42b1f-91ec-0779-013a-639bc8bc3f5e)
AND
NOT DB_OnlyOnce("PLA_ZhentShipment_EnterCombatOnZhentsStartFight")
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
DB_PLA_ZhentShipment_PlayerAgreedToHelpInDialog(_Player)
AND
NOT DB_Is_InCombat(_Player, _)
AND
QRY_OnlyOnce("PLA_ZhentShipment_EnterCombatOnZhentsStartFight")
THEN
PROC_EnterCombat(_Player, _Gnoll);
PROC_GlobalClearFlagAndCache(PLA_ZhentShipment_Event_AgentsAttackGnolls_e9e42b1f-91ec-0779-013a-639bc8bc3f5e);

IF
LeftCombat((CHARACTER)_Agent, (GUIDSTRING)_CombatID)
AND
DB_PLA_ZhentShipment_Agents(_Agent)
AND
DB_PLA_ZhentShipment_PlayerAgreedToHelpInDialog(_Player)
THEN
NOT DB_PLA_ZhentShipment_PlayerAgreedToHelpInDialog(_Player);
//END_REGION Zhents start combat with gnolls after initial dialog

//REGION Zhents take cover near the entrance
PROC
PROC_PLA_ZhentShipment_CoverPositions()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_OnCoverPositions_4b302512-e44f-4960-b13b-03b0afc5b8ff)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_OnCoverPositions_4b302512-e44f-4960-b13b-03b0afc5b8ff);
PROC_PLA_ZhentShipment_StopThrowingAlchFire();

IF
FlagSet(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_OnCoverPositions_4b302512-e44f-4960-b13b-03b0afc5b8ff)
THEN
ClearFlag(PLA_ZhentShipment_State_OnCoverPositions_4b302512-e44f-4960-b13b-03b0afc5b8ff, NULL_00000000-0000-0000-0000-000000000000, 0);
//END_REGION Zhents take cover near the entrance

//REGION Entering/Leaving combat just for playing AD
PROC
PROC_PLA_ZhentShipment_EnterCombatWithFlindToPlayAD()
AND
DB_PLA_ZhentShipment_AliveAgents((CHARACTER)_Agent)
AND
NOT DB_Is_InCombat(_Agent, _)
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _)
AND
NOT DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_Event_AgentsAttackGnolls_e9e42b1f-91ec-0779-013a-639bc8bc3f5e)
THEN
DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent);
PROC_PLA_ZhentShipment_ChangeRelationToFlind(0); // neeeded so they can enter the combat

IF
RelationChanged((FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, (FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, 0, 1)
AND
DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent)
AND
NOT DB_Is_InCombat(_Agent, _)
THEN
SetEntityEvent(_Agent, "ClearPeaceReturn", 1);
PROC_EnterCombat(_Agent, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0);

IF
TurnEnded((CHARACTER)_Agent)
AND
DB_PLA_ZhentShipment_Agents(_Agent)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_PLA_ZhentShipment_ZhentsAndGnollsHostile(1)
AND
DB_PLA_ZhentShipment_AliveAgents((CHARACTER)_AnyAgent)
AND
DB_Is_InCombat(_AnyAgent, _)
AND
DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_AnyAgent)
THEN
PROC_PLA_ZhentShipment_ChangeRelationToFlind(50); // needed to leave the combat
LeaveCombat(_AnyAgent);

IF
EnterCombatFailed((CHARACTER)_Agent, _)
AND
DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent)
THEN
NOT DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent);

IF
LeftCombat((CHARACTER)_Agent, _)
AND
DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent)
THEN
NOT DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent);

PROC
PROC_PLA_ZhentShipment_OnGnollsHostileToZhents()
AND
DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD((CHARACTER)_Agent)
THEN
NOT DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent);

IF
FlagSet(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_OnCoverPositions_4b302512-e44f-4960-b13b-03b0afc5b8ff)
THEN
ClearFlag(PLA_ZhentShipment_State_OnCoverPositions_4b302512-e44f-4960-b13b-03b0afc5b8ff, NULL_00000000-0000-0000-0000-000000000000, 0);

// Player leaves combat before Zhents can play AD
IF
LeftCombat((CHARACTER)_Player, _CombatID)
AND
DB_Players(_Player)
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
NOT DB_PLA_ZhentShipment_ZhentsAndGnollsHostile(1)
AND
NOT QRY_PLA_ZhentShipment_AnyPlayersInCombat(_CombatID)
AND
DB_PLA_ZhentShipment_AliveAgents((CHARACTER)_AnyAgent)
AND
DB_Is_InCombat(_AnyAgent, _CombatID)
AND
DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_AnyAgent)
THEN
PROC_PLA_ZhentShipment_ChangeRelationToFlind(50); // needed to leave the combat
LeaveCombat(_AnyAgent);
//END_REGION Entering/Leaving combat just for playing AD

//REGION Zhents retreat to defense positions
PROC
PROC_PLA_ZhentShipment_DefendPositions()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_OnDefensePositions_7ffc9c16-cffd-4fa1-8d76-32ceedbe3cc4)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_OnDefensePositions_7ffc9c16-cffd-4fa1-8d76-32ceedbe3cc4);
PROC_PLA_ZhentShipment_StopThrowingAlchFire();
PROC_PLA_ZhentShipment_StartMoveToDefendPositions();

PROC
PROC_PLA_ZhentShipment_DefendPositions()
AND
DB_GlobalFlag(PLA_ZhentShipment_State_OnCoverPositions_4b302512-e44f-4960-b13b-03b0afc5b8ff)
THEN
ClearFlag(PLA_ZhentShipment_State_OnCoverPositions_4b302512-e44f-4960-b13b-03b0afc5b8ff, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_PLA_ZhentShipment_StartMoveToDefendPositions()
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
PROC_TryStopDialogFor(_Agent);
SetHasDialog(_Agent, 0);

IF
EntityEvent((CHARACTER)_Agent, "PLA_ZhentShipment_Event_AtDefensePosition")
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
SetHasDialog(_Agent, 1);

IF
FlagSet(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
SetHasDialog(_Agent, 1);

IF
EntityEvent((CHARACTER)_Agent, "PLA_ZhentShipment_Event_AtDefensePosition")
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
QRY_OnlyOnce("PLA_ZhentShipment_OnZhentsArrivedOnDefensePos")
THEN
PROC_PLA_ZhentShipment_OnZhentsArrivedOnDefensePos();

// Setting hostility towards Gnolls after Zhents provoke gnolls. 
// If gnolls are not fighting players setting it right away.
PROC
PROC_PLA_ZhentShipment_OnZhentsArrivedOnDefensePos()
AND
NOT QRY_PLA_ZhentShipment_PlayersAndGnollsAreFighting()
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();

// if gnolls are fighting player, wait till next round 
PROC
PROC_PLA_ZhentShipment_OnZhentsArrivedOnDefensePos()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
DB_Is_InCombat(_Gnoll, _CombatID)
AND
DB_PartyMembers(_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
NOT DB_PLA_ZhentShipment_SetZhentsAndGnollsHostileSecondRound(_CombatID)
AND
QRY_OnlyOnce("PLA_ZhentShipment_SetZhentsAndGnollsHostileSecondRound")
THEN
DB_PLA_ZhentShipment_SetZhentsAndGnollsHostileSecondRound(_CombatID);

IF
CombatRoundStarted(_CombatID, _Round)
AND
DB_PLA_ZhentShipment_SetZhentsAndGnollsHostileSecondRound(_CombatID)
AND
_Round > 0
THEN
NOT DB_PLA_ZhentShipment_SetZhentsAndGnollsHostileSecondRound(_CombatID);
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();

IF
FlagSet(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_OnDefensePositions_7ffc9c16-cffd-4fa1-8d76-32ceedbe3cc4)
THEN
ClearFlag(PLA_ZhentShipment_State_OnDefensePositions_7ffc9c16-cffd-4fa1-8d76-32ceedbe3cc4, NULL_00000000-0000-0000-0000-000000000000, 0);
//END_REGION Zhents retreat to defense positions

//REGION Gnolls provoked by Zhents after player rejects to help them
PROC
PROC_GlobalFlagReactionAfterDialog(PLA_ZhentShipment_Event_ProvokeGnolls_b7fe3fee-61ce-7d8d-64a6-519f0dc610cb, _)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
THEN
PROC_PLA_ConflictedFlind_StartInstigate(0);
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(0);
PROC_PLA_ZhentShipment_DefendPositions();
//END_REGION Gnolls provoked by Zhents after player rejects to help them

//REGION Combat with gnolls started - Zhents join OR retreat deep into the cave
IF
EnteredCombat((CHARACTER)_Character, _CombatID)
AND
DB_PLA_ConflictedFlind_GnollPack(_Character)
AND
NOT DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1)
THEN
PROC_PLA_ZhentShipment_OnEnteredCombat(_CombatID);

IF
EnteredCombat((CHARACTER)_Character, _CombatID)
AND
DB_PartyMembers(_Character)
AND
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
AND
DB_Is_InCombat(_Gnoll, _CombatID)
AND
NOT DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1)
THEN
PROC_PLA_ZhentShipment_OnEnteredCombat(_CombatID);

// join fight if player agreed to help
PROC
PROC_PLA_ZhentShipment_OnEnteredCombat((GUIDSTRING)_CombatID)
AND
NOT DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_AgreedToHelpInBattle_185140b4-9dec-49d7-abad-e6e628cdf4cd)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
QRY_PLA_ConflictedFlind_FlindNotTurnedOnGnollsOrKilledThemOrDead()
AND
QRY_PLA_ZhentShipment_EnterCombatWithGnollsAndPlayers(_CombatID)
THEN
DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1);
PROC_PLA_ZhentShipment_StopThrowingAlchFire();

// ...join combat if Zhents provoked gnolls to rush (but from defense positions)
PROC
PROC_PLA_ZhentShipment_OnEnteredCombat((GUIDSTRING)_CombatID)
AND
NOT DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
DB_GlobalFlag(PLA_ZhentShipment_Event_ProvokeGnolls_b7fe3fee-61ce-7d8d-64a6-519f0dc610cb)
AND
QRY_PLA_ZhentShipment_EnterCombatWithGnollsAndPlayers(_CombatID)
THEN
DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1);
PROC_PLA_ZhentShipment_StopThrowingAlchFire();

// ...if combat started when gnolls noticed us in the cave
PROC
PROC_PLA_ZhentShipment_OnEnteredCombat((GUIDSTRING)_CombatID)
AND
NOT DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_Event_ProvokeGnolls_b7fe3fee-61ce-7d8d-64a6-519f0dc610cb)
AND
QRY_PLA_ZhentShipment_IsAnyPlayerInCombatAndInCave(_CombatID)
AND
QRY_PLA_ZhentShipment_EnterCombatWithGnollsAndPlayers(_CombatID)
THEN
DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1);

// ...just retreat
PROC
PROC_PLA_ZhentShipment_OnEnteredCombat((GUIDSTRING)_CombatID)
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _CombatID)
AND
NOT DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_AgreedToHelpInBattle_185140b4-9dec-49d7-abad-e6e628cdf4cd)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_OnDefensePositions_7ffc9c16-cffd-4fa1-8d76-32ceedbe3cc4)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_Event_ProvokeGnolls_b7fe3fee-61ce-7d8d-64a6-519f0dc610cb)
AND
NOT QRY_PLA_ZhentShipment_IsAnyPlayerInCombatAndInCave(_CombatID)
THEN
DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1);
PROC_PLA_ZhentShipment_CoverPositions();
PROC_PLA_ZhentShipment_EnterCombatWithFlindToPlayAD();

// when player agreed to help zhents but gnolls rushed in before player attacked them
// (because zhents run out flasks)
PROC
PROC_PLA_ZhentShipment_OnEnteredCombat((GUIDSTRING)_CombatID)
AND
NOT DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_AgreedToHelpInBattle_185140b4-9dec-49d7-abad-e6e628cdf4cd)
AND
DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
QRY_PLA_ZhentShipment_EnterCombatWithGnollsAndPlayers(_CombatID)
THEN
DB_PLA_ZhentShipment_AgentsReactedOnCombatStart(1);

QRY
QRY_PLA_ZhentShipment_IsAnyPlayerInCombatAndInCave((GUIDSTRING)_CombatID)
AND
DB_PartyMembers((CHARACTER)_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
IsInTrigger(_Player, S_PLA_ZhentShipment_InsideCaveCombatArea_1482ce04-5188-4759-a548-f609c6e74181, 1)
THEN
DB_NOOP(1);
//END_REGION Combat with gnolls started - Zhents join OR retreat deep into the cave

//REGION Setting JoinedFightWithGnolls flag
// Zhents enter combat where gnolls are present - to fight
IF
EnteredCombat((CHARACTER)_Agent, _CombatID)
AND
NOT DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
PROC_PLA_ZhentShipment_OnAgentEnteredCombat(_Agent, _CombatID);

PROC
PROC_PLA_ZhentShipment_OnAgentEnteredCombat(_, _)
THEN
PROC_PLA_ZhentShipment_StopThrowingAlchFire();

PROC
PROC_PLA_ZhentShipment_OnAgentEnteredCombat((CHARACTER)_Agent, (GUIDSTRING)_CombatID)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
DB_PLA_ConflictedFlind_GnollPack((CHARACTER)_Gnoll)
AND
DB_Is_InCombat(_Gnoll, _CombatID)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentsJoinCombatWithGnolls")
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92);

// Gnolls enter combat where agents are present
IF
EnteredCombat((CHARACTER)_Gnoll, _CombatID)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
DB_PLA_ZhentShipment_Agents((CHARACTER)_Agent)
AND
DB_Is_InCombat(_Agent, _CombatID)
AND
NOT DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentsJoinCombatWithGnolls")
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92);

PROC
PROC_PLA_ZhentShipment_OnGnollsHostileToZhents()
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Event_ProvokeGnolls_b7fe3fee-61ce-7d8d-64a6-519f0dc610cb)
AND
DB_PLA_ZhentShipment_AliveAgents(_)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentsJoinCombatWithGnolls")
THEN
PROC_GlobalSetFlagAndCache((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92);

IF
FlagSet((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
SetEntityEvent(_Agent, "ClearPeaceReturn", 1);
//END_REGION Setting JoinedFightWithGnolls flag

//REGION Auto-attack gnolls if they got too close for some wierd reason
PROC
PROC_PLA_ZhentShipment_RegisterGnollsBorder()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
TriggerRegisterForCharacter(TRIGGERGUID_S_PLA_ZhentShipment_GnollsBorderTrigger_f42b580d-5dec-4261-959c-27cfeaec20a0, _Gnoll);

IF
EnteredTrigger(_Gnoll, TRIGGERGUID_S_PLA_ZhentShipment_GnollsBorderTrigger_f42b580d-5dec-4261-959c-27cfeaec20a0)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_OnDefensePositions_7ffc9c16-cffd-4fa1-8d76-32ceedbe3cc4)
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();

IF
EnteredTrigger(_Player, TRIGGERGUID_S_PLA_ZhentShipment_GnollsBorderTrigger_f42b580d-5dec-4261-959c-27cfeaec20a0)
AND
DB_PartyMembers(_Player)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a)
AND
QRY_PLA_ZhentShipment_EnterCombatWithGnollsAndPlayer(_Player)
THEN
PROC_PLA_ZhentShipment_UnregisterGnollsBorder();

IF
TurnStarted(_Player)
AND
DB_PartyMembers((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_JoinedFightWithGnolls_834c500f-8718-47b5-b320-8d37b2ad9b92)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a)
AND
DB_InRegion(_Player, S_PLA_ZhentShipment_GnollsBorderTrigger_f42b580d-5dec-4261-959c-27cfeaec20a0)
AND
QRY_PLA_ZhentShipment_EnterCombatWithGnollsAndPlayer(_Player)
THEN
PROC_PLA_ZhentShipment_UnregisterGnollsBorder();

IF
FlagSet(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2, _, _)
THEN
PROC_PLA_ZhentShipment_UnregisterGnollsBorder();

PROC
PROC_PLA_ZhentShipment_DefendPositions()
THEN
PROC_PLA_ZhentShipment_UnregisterGnollsBorder();

PROC
PROC_PLA_ZhentShipment_UnregisterGnollsBorder()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
TriggerUnregisterForCharacter(TRIGGERGUID_S_PLA_ZhentShipment_GnollsBorderTrigger_f42b580d-5dec-4261-959c-27cfeaec20a0, _Gnoll);

PROC
PROC_PLA_ZhentShipment_UnregisterGnollsBorder()
THEN
PROC_TriggerUnregisterForParty(TRIGGERGUID_S_PLA_ZhentShipment_GnollsBorderTrigger_f42b580d-5dec-4261-959c-27cfeaec20a0);
//END_REGION Auto-attack gnolls if they got too close for some wierd reason

//REGION Players attack agents - gnolls join the combat
IF
TurnEnded((CHARACTER)_Agent)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
NOT DB_OnlyOnce("PLA_ZhentShipment_GnollsJoinCombatWithZhents")
AND
DB_PLA_ZhentShipment_Agents(_Agent)
AND
DB_Is_InCombat(_Agent, (GUIDSTRING)_CombatID)
AND
QRY_PLA_ZhentShipment_AnyPlayersInCombat(_CombatID)
AND
NOT DB_PLA_ZhentShipment_ReadyToProvokeGnolls(_Agent)
THEN
DB_PLA_ZhentShipment_ReadyToProvokeGnolls(_Agent);

IF
DB_PLA_ZhentShipment_ReadyToProvokeGnolls(_Agent)
THEN
PROC_PLA_ZhentShipment_TryProvokeGnolls();

IF
LeftCombat((CHARACTER)_Agent, _)
AND
DB_PLA_ZhentShipment_Agents(_Agent)
THEN
PROC_PLA_ZhentShipment_TryProvokeGnolls();

PROC
PROC_PLA_ZhentShipment_TryProvokeGnolls()
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
SysCount("DB_PLA_ZhentShipment_ReadyToProvokeGnolls", 1, _CountReady)
AND
SysCount("DB_PLA_ZhentShipment_AliveAgents", 1, _CountAlive)
AND
_CountReady >= _CountAlive
THEN
PROC_PLA_ConflictedFlind_StartInstigate(0);
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(0);

QRY
QRY_PLA_ZhentShipment_AnyPlayersInCombat((GUIDSTRING)_CombatID)
AND
DB_PartyMembers((CHARACTER)_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
THEN
DB_NOOP(1);

IF
AttackedBy((CHARACTER)_Agent, (CHARACTER)_Player, _, _, _, _, _)
AND
DB_PLA_ZhentShipment_Agents(_Agent)
AND
DB_PartyMembers(_Player)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
GetRelation((FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, _Relation)
AND
_Relation < 50
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1);

IF
RelationChanged((FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, (FACTION)_OtherFaction, _NewRelation, _)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
NOT DB_PLA_ConflictedFlind_InstigatingAlliedWithGnolls(1)
AND
_NewRelation < 50
AND
DB_PartyMembers((CHARACTER)_Player)
AND
GetFaction(_Player, (FACTION)_PlayerFaction)
AND
_OtherFaction == _PlayerFaction
AND
QRY_OnlyOnce("PLA_ZhentShipment_PlayersAttackedAgentsRelationChanged")
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1);
//END_REGION Players attack agents - gnolls join the combat

//REGION Third party attacks agents - gnolls also rush into the cave
IF
TurnStarted((CHARACTER)_Agent)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
DB_PLA_ZhentShipment_Agents(_Agent)
AND
DB_Is_InCombat(_Agent, _CombatID)
AND
NOT QRY_PLA_ZhentShipment_AnyPlayersInCombat(_CombatID)
AND
QRY_OnlyOnce("PLA_ZhentShipment_GnollsJoinCombatWithZhents")
THEN
PROC_PLA_ConflictedFlind_StartInstigate(0);
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();
PROC_PLA_ConflictedFlind_ChangeGnollsRelationToPlayers(0);
//END_REGION

//REGION After talking to Rugan
IF
FlagSet(PLA_ZhentShipment_Agent_001_ToldToMeet_d7f2080d-45aa-fb89-578e-947b3e21cb46, (CHARACTER)_Player, _)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_TalkedAfterKilledGnolls_8c60be2a-fb0a-ec52-ca14-883cab378dc0)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e);

IF
DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_TalkedAfterKilledGnolls_8c60be2a-fb0a-ec52-ca14-883cab378dc0)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "PLA_ZhentShipment", "AgreedHelp", 1)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e);
//END_REGION After talking to Rugan

//REGION Gnolls gone dialog for Olly
IF
FlagSet(PLA_ZhentShipment_Event_TalkedToOllyAfterCombat_b5927ed5-cfa3-fd2b-aaf2-425eb069b899, _, _)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e);

IF
FlagSet(PLA_ZhentShipment_Event_TalkedToOllyAfterCombat_b5927ed5-cfa3-fd2b-aaf2-425eb069b899, _, _)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_TalkedAfterKilledGnolls_8c60be2a-fb0a-ec52-ca14-883cab378dc0)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_TalkedAfterKilledGnolls_8c60be2a-fb0a-ec52-ca14-883cab378dc0);
//END_REGION Gnolls gone dialog

//REGION Removing the agents and the chest after quest complete
IF
LeftTrigger(_Player, S_PLA_Plains_SUB_bcc3efa5-bfe1-4224-9df1-6758cac764cd)
AND
DB_PartyMembers(_Player)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger((TRIGGER)S_PLA_ZhentShipment_Cave_DangerZone_0aa90ecf-f46e-441e-ac25-8a9e236f2738)
AND
DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
DB_GlobalFlag(PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_LeftCave_ae55c369-a884-41d7-9622-ad49ae1b019c)
AND
QRY_OnlyOnce("PLA_ZhentShipment_RemoveAgentsFromTheCave")
THEN
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave();

PROC
PROC_LongRestOrLevelUnloading("WLD_Main_A")
AND
DB_PartyMembers(_Player)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger((TRIGGER)S_PLA_ZhentShipment_Cave_DangerZone_0aa90ecf-f46e-441e-ac25-8a9e236f2738)
AND
DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_ReadyToLeaveCave_e458690a-ebd9-a0a1-e44e-acca93224b3e)
AND
DB_GlobalFlag((FLAG)PLA_ZhentShipment_Quest_AttackedAgents_9efe32a4-5418-91b3-3674-6bfb15b2dda1)
AND
QRY_PLA_ZhentShipment_SomePlayerHasChest()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_LeftCave_ae55c369-a884-41d7-9622-ad49ae1b019c)
AND
QRY_OnlyOnce("PLA_ZhentShipment_RemoveAgentsFromTheCave")
THEN
DB_ExecuteInLevel("PLA_ZhentShipment_RemoveAgentsFromTheCave","WLD_Main_A");

PROC
PROC_ExecuteInLevel("PLA_ZhentShipment_RemoveAgentsFromTheCave","WLD_Main_A")
THEN
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave();

PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_LeftCave_ae55c369-a884-41d7-9622-ad49ae1b019c)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_LeftCave_ae55c369-a884-41d7-9622-ad49ae1b019c);

// removing fire flasks
PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a)
AND
DB_PLA_ZhentShipment_FireFlasksOnTheGround(_Item)
AND
IsInInventory(_Item, 0)
THEN
SetOnStage(_Item, 0);

// and backpack
PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a)
THEN
PROC_PLA_ZhentShipment_RemoveItemFromCave(S_PLA_ZhentShipment_ZhentBackpack_000_1bd43073-7a20-4dd9-879e-8c6a2584c545); 

// and a pouch
PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a)
THEN
PROC_PLA_ZhentShipment_RemoveItemFromCave(S_PLA_ZhentShipment_Bag_000_c3513515-0b7b-4f2e-a3b1-52e308998612);

PROC
PROC_PLA_ZhentShipment_RemoveItemFromCave((ITEM)_Item)
AND
GetOwner(_Item, _Character)
AND
DB_PLA_ZhentShipment_Agents(_Character)
AND
IsOnStage(_Item, 1)
THEN
SetOnStage(_Item, 0);

PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
THEN
PROC_PLA_ZhentShipment_StopThrowingAlchFire();

PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
THEN
PROC_PLA_ZhentShipment_AgentsStopSpotting();

// in case the second agent was killed before
PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
AND
NOT DB_Defeated(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4)
AND
DB_Defeated(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c)
THEN
PROC_PLA_ZhentShipment_LootSecondAgent();

PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
AND
DB_PLA_ZhentShipment_Agents(_Agent)
THEN
PROC_PLA_ZhentShipment_AgentLeaveCave(_Agent);

PROC
PROC_PLA_ZhentShipment_AgentLeaveCave((CHARACTER)_Agent)
AND
NOT DB_Defeated(_Agent)
AND
DB_PLA_ZhentShipment_Agents(_Agent)
THEN
RemoveSplatters(_Agent);
SetEntityEvent(_Agent, "PLA_ZhentShipment_Event_LeftCave");

PROC
PROC_PLA_ZhentShipment_AgentLeaveCave(_Agent)
AND
NOT DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
THEN
PROC_SelfHealing_Enable(_Agent);

PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
THEN
PROC_TriggerUnregisterForItemsWhenInLevel(S_PLA_ZhentShipment_OwnershipTrigger_893e9484-b653-4032-af9f-cdc28009bf13,"WLD_Main_A");

//END_REGION Removing the agents and the chest after quest complete

//REGION Clearing items ownership
PROC
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave()
THEN
PROC_PLA_ZhentShipment_ClearItemsOwnershipFromTrigger();

IF
FlagSet(PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a, _, _)
THEN
PROC_PLA_ZhentShipment_ClearItemsOwnershipFromTrigger();

PROC
PROC_PLA_ZhentShipment_ClearItemsOwnershipFromTrigger()
THEN
TriggerClearItemsOwner(S_PLA_ZhentShipment_OwnershipTrigger_893e9484-b653-4032-af9f-cdc28009bf13);

IF
FlagSet(PLA_ZhentShipment_State_AgreedToHelpInBattle_185140b4-9dec-49d7-abad-e6e628cdf4cd, _, _)
THEN
PROC_PLA_ZhentShipment_ClearFlaskOwnership();

IF
FlagSet(PLA_ZhentShipment_State_TalkedAfterKilledGnolls_8c60be2a-fb0a-ec52-ca14-883cab378dc0, _, _)
THEN
PROC_PLA_ZhentShipment_ClearFlaskOwnership();

PROC
PROC_PLA_ZhentShipment_ClearFlaskOwnership()
AND
DB_PLA_ZhentShipment_FireFlasksOnTheGround(_Item)
AND
IsInInventory(_Item, 0)
THEN
ClearOwnership(_Item);
//END_REGION Clearing items ownership

//REGION Looting Olly-s dead body
IF
EntityEvent(_, "PLA_ZhentShipment_Looting")
THEN
PROC_PLA_ZhentShipment_LootSecondAgent();

PROC
PROC_PLA_ZhentShipment_LootSecondAgent()
AND
NOT DB_OnlyOnce("PLA_ZhentShipment_LootSecondAgent")
AND
GetGold(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, _GoldAmount)
AND
_GoldAmount > 0
AND
IntegerProduct(-1, _GoldAmount, _AntiGoldAmount)
THEN
DB_OnlyOnce("PLA_ZhentShipment_LootSecondAgent");
AddGold(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, _GoldAmount);
AddGold(S_PLA_ZhentShipment_Agent_002_7eda738e-8a85-4975-a1e1-1b3b2c4d641c, _AntiGoldAmount);
//END_REGION Looting Olly-s dead body

//REGION Change Relation
PROC
PROC_PLA_ZhentShipment_ChangeRelationToFlind((INTEGER)_Relation)
THEN
PROC_SetRelation((FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, (FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, _Relation);

PROC
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile()
AND
NOT DB_PLA_ZhentShipment_ZhentsAndGnollsHostile(1)
THEN
DB_PLA_ZhentShipment_ZhentsAndGnollsHostile(1);
PROC_SetRelationMutual((FACTION)ACT1_PLA_ConflictedFlind_GnollPack_6f5c2543-dadb-7f16-94d4-9c7e5f23acf2,(FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9,0);
PROC_SetRelationMutual((FACTION)ACT1_PLA_ConflictedFlind_Flind_df4d741f-a2b3-c281-a3a4-111dac02f109, (FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9,0);

// Stop dialog when Gnolls attack
PROC
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile()
AND
DB_PLA_ZhentShipment_Agents(_Zhent)
THEN
PROC_ForceStopDialog(_Zhent);

PROC
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile()
THEN
PROC_PLA_ZhentShipment_UnregisterGnollsBorder();

IF
RelationChanged((FACTION)ACT1_PLA_ConflictedFlind_GnollPack_6f5c2543-dadb-7f16-94d4-9c7e5f23acf2, (FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, _Relation, _)
AND
_Relation < 50
THEN
PROC_PLA_ZhentShipment_OnGnollsHostileToZhents();

PROC
PROC_PLA_ZhentShipment_MakeZhentsAndPlayersHostile()
AND 
NOT QRY_PLA_ZhentShipment_AreZhentsAndPlayersHostile()
THEN
PROC_SetRelationMutual((FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);

PROC
PROC_PLA_ZhentShipment_MakeZhentsAndPlayersAllies()
AND
GetRelation((FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, _Relation)
AND
_Relation < 100
THEN
PROC_SetRelationMutual((FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 100);

QRY
QRY_PLA_ZhentShipment_AreZhentsAndPlayersHostile()
AND
GetRelation((FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, _Relation)
AND
_Relation < 50
THEN
DB_NOOP(1);

QRY
QRY_PLA_ZhentShipment_AreZhentsAndPlayerHostile((CHARACTER)_Player)
AND
GetFaction(_Player, (FACTION)_Faction)
AND
GetRelation((FACTION)ACT1_PLA_ShipmentZhents_Cave_4ab6ad89-f96c-7ac4-5e5b-142925bf56b9, _Faction, _Relation)
AND
_Relation < 50
THEN
DB_NOOP(1);
//END_REGION Change Relation

//REGION Agents death
IF
Dying(_Agent)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
THEN
ClearFlag(PLA_ZhentShipment_State_BothAgentsAreAlive_d7404f8a-8101-90c1-3105-0b49cddf7e1f, NULL_00000000-0000-0000-0000-000000000000, 0);
NOT DB_PLA_ZhentShipment_AliveAgents(_Agent);
PROC_PLA_ZhentShipment_StopThrowingAlchFire();
PROC_PLA_ZhentShipment_TrySetStateDeadAgentsFlag();

PROC
PROC_PLA_ZhentShipment_TrySetStateDeadAgentsFlag()
AND
NOT DB_PLA_ZhentShipment_AliveAgents(_)
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_State_SurvivorsAreDead_bb54af09-b0c2-46c2-84e8-642280ccec6a);

IF
KilledBy(_Agent, _AttackOwner, _, _)
AND
DB_PLA_ZhentShipment_Agents(_Agent)
AND
DB_PartyMembers((CHARACTER)_AttackOwner)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
AND
NOT DB_GlobalFlag((FLAG)PLA_ConflictedFlind_State_Instigate_273fb05a-4c2c-4816-8458-7af837d919a2)
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndPlayersHostile();
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();
PROC_PLA_ConflictedFlind_StartInstigate(0);

IF
FlagSet(PLA_ZhentShipment_State_Agent001Dead_62feb5b3-ecfd-4e43-ba22-e52d4e352f46, _Player, _)
THEN
PROC_PLA_ZhentShipment_TrySetSeenDeadAgentsFlag();

IF
FlagSet(PLA_ZhentShipment_State_Agent002Dead_f51a12b5-e82a-4d88-a8c9-46ad0375107a, _Player, _)
THEN
PROC_PLA_ZhentShipment_TrySetSeenDeadAgentsFlag();

PROC
PROC_PLA_ZhentShipment_TrySetSeenDeadAgentsFlag()
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_Knows_SurvivorsAreDead_d889b0c1-89aa-480f-9735-b24f04525453)
AND
DB_PartyMembers((CHARACTER)_Player)
AND
GetFlag(PLA_ZhentShipment_Knows_Agent001Dead_62feb5b3-ecfd-4e43-ba22-e52d4e352f46, _Player, 1)
AND
GetFlag(PLA_ZhentShipment_Knows_Agent002Dead_f51a12b5-e82a-4d88-a8c9-46ad0375107a, _Player, 1)
AND
QRY_OnlyOnce("PLA_ZhentShipment_State_SurvivorsAreDeadFlagSet")
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentShipment_Knows_SurvivorsAreDead_d889b0c1-89aa-480f-9735-b24f04525453);
//END_REGION Agents death

//REGION Combat queries
QRY
QRY_PLA_ZhentShipment_PlayersAndGnollsAreFighting()
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
DB_Is_InCombat(_Gnoll, (GUIDSTRING)_CombatID)
AND
DB_PartyMembers(_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
THEN
DB_NOOP(1);

QRY
QRY_PLA_ZhentShipment_EnterCombatWithGnollsAndPlayer((CHARACTER)_Player)
AND
DB_PartyMembers(_Player)
AND
DB_Is_InCombat(_Player, (GUIDSTRING)_CombatID)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
DB_Is_InCombat(_Gnoll, _CombatID)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
NOT DB_Is_InCombat(_Agent, _CombatID)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentsJoinFightWithGnolls")
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();
PROC_EnterCombat(_Agent, _Gnoll);

QRY
QRY_PLA_ZhentShipment_EnterCombatWithGnollsAndPlayers((GUIDSTRING)_CombatID)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
AND
DB_Is_InCombat(_Gnoll, _CombatID)
AND
DB_PartyMembers(_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
DB_PLA_ZhentShipment_AliveAgents(_Agent)
AND
NOT DB_Is_InCombat(_Agent, _CombatID)
AND
QRY_OnlyOnce("PLA_ZhentShipment_AgentsJoinFightWithGnolls")
THEN
PROC_PLA_ZhentShipment_MakeZhentsAndGnollsHostile();
PROC_EnterCombat(_Agent, _Gnoll);

QRY
QRY_PLA_ZhentShipment_EnterCombatWithGnollsAndPlayers(_)
AND
DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent)
THEN
NOT DB_PLA_ZhentShipment_ZhentEnteredCombatJustForAD(_Agent);

QRY
QRY_PLA_ZhentShipment_AnyAgentInCombat((GUIDSTRING)_CombatID)
AND
DB_PLA_ZhentShipment_AliveAgents((CHARACTER)_Agent)
AND
DB_Is_InCombat(_Agent, _CombatID)
THEN
DB_NOOP(1);
//END_REGION Combat queries

//REGION Crimes against gnolls
PROC
PROC_PLA_ZhentShipment_DisableCrimesOnGnolls()
AND
DB_PLA_ZhentShipment_Agents(_Agent)
AND
DB_PLA_ConflictedFlind_GnollPack(_Gnoll)
THEN
DB_AssaultFamilyIgnoreFor(_Agent, _Gnoll);
DB_MurderIgnoreFor(_Agent, _Gnoll);
//END_REGION Crimes against gnolls

//REGION Debug
IF
TextEvent("PLA_ZhentShipment_ZhentsToHideout")
THEN
SetFlag(PLA_ZhentShipment_Quest_HasMet_5359e72b-f8ca-d2d6-4c3a-8fc00efe5c2c, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(Debug_PLA_KillGnolls_5283045d-9655-55aa-0a55-213b7808f23c, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(PLA_ZhentShipment_State_TalkedAfterKilledGnolls_8c60be2a-fb0a-ec52-ca14-883cab378dc0, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave();

IF
TextEvent("PLA_ZhentShipment_ZhentsToHideout_TiedUp")
THEN
SetFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(PLA_ZhentShipment_Quest_HasMet_5359e72b-f8ca-d2d6-4c3a-8fc00efe5c2c, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(Debug_PLA_KillGnolls_5283045d-9655-55aa-0a55-213b7808f23c, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(PLA_ZhentShipment_State_TalkedAfterKilledGnolls_8c60be2a-fb0a-ec52-ca14-883cab378dc0, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_PLA_ZhentShipment_RemoveAgentsFromTheCave();

IF
TextEvent("PLA_ZhentShipment_TestJournal")
AND
DB_Players((CHARACTER)_Player)
THEN
QuestUpdate(_Player, "PLA_ZhentShipment", "NoticedStruggle_Cave"); //1150
QuestUpdate(_Player, "PLA_ZhentShipment", "FoundOrders"); //1100

IF
TextEvent("PLA_ZhentShipment_StartZarys")
AND
DB_Players((CHARACTER)_Player)
THEN
QuestUpdate(_Player, "PLA_ZhentShipment", "AgreedHelp");
//END_REGION Debug

PROC
PROC_LevelBecameUnreachable("WLD_Main_A")
THEN
GoalCompleted;
EXITSECTION
PROC_TriggerUnregisterForParty(S_PLA_ZhentShipment_NoticingZhentsArea_9741f301-f369-4ecc-b9f1-fe48d8bb107a);
PROC_TriggerUnregisterForPlayers(TRIGGERGUID_S_PLA_ZhentShipment_WreckedCaravanArea_86c8011d-dc85-4b6f-ac98-fb8a60ae5b3a);
PROC_PLA_ZhentShipment_UnregisterGnollsBorder();
ENDEXITSECTION
ParentTargetEdge "Act1"
