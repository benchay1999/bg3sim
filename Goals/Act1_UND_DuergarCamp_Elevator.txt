Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_UND_ElevatorNPCs((CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af);
DB_UND_ElevatorNPCs(S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d);
DB_UND_ElevatorNPCs(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765);

SetHasDialog((CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af, 1);
SetHasDialog((CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d, 1);
SetHasDialog((CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765, 1);

DB_OneShotPartyTrigger((TRIGGER)S_UND_ElevatorGuards_EmptyMug_OneShotADTrigger_66df133f-900f-4da2-a5fe-a4c3e085355f);

DB_UND_ElevatorGuards((CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af);
DB_UND_ElevatorGuards((CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d);

DB_HasItemEvent((ITEM)S_UND_ElevatorGnome_Poison_9fed4fa7-4d94-4bc2-98b3-446c2987b35b,UND_ElevatorGnome_HasPoison_3f0573c2-2539-46fb-acaf-95f74842ec00);
DB_GiveItemToEvent((ITEM)S_UND_ElevatorGnome_Poison_9fed4fa7-4d94-4bc2-98b3-446c2987b35b,UND_ElevatorGnome_GivePoison_65b93808-94a4-491c-926a-936ad966f543);

DB_GlobalFlagReactionAfterDialog((FLAG)UND_ElevatorGnome_State_CaveIn_3be5d4ab-7b67-4224-8e7f-207bfd7f14ab,(DIALOGRESOURCE)UND_ElevatorGnome_dd648348-5a8b-26c4-43d0-43f74c6bd2e5);
DB_GlobalFlagReactionAfterDialog((FLAG)UND_ElevatorGnome_State_Myconids_7c7d96f4-f1e9-4d6f-96ec-dd8c5ac8153d,(DIALOGRESOURCE)UND_ElevatorGnome_dd648348-5a8b-26c4-43d0-43f74c6bd2e5);
DB_GlobalFlagReactionAfterDialog((FLAG)UND_ElevatorGnome_State_Shadowlands_23f0472a-c83d-4a43-a82e-79b75554e178,(DIALOGRESOURCE)UND_ElevatorGnome_dd648348-5a8b-26c4-43d0-43f74c6bd2e5);
DB_GlobalFlagReactionAfterDialog((FLAG)UND_ElevatorGnome_State_OffStage_91348abe-231b-4706-ad8c-6211eca2ee7d,(DIALOGRESOURCE)UND_ElevatorGnome_dd648348-5a8b-26c4-43d0-43f74c6bd2e5);

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_DeadElevatorGuards",UND_ElevatorGuards_State_PermaDefeated_5f1f5c9b-e05d-46be-aca2-4e298f8ef4bd);
DB_GLO_DefeatCounter_AllDeadGlobalFlag("UND_DeadElevatorGuards",UND_ELevatorGuards_State_Dead_15d7e621-ef8c-49fb-87f3-a1a1694990f3);
KBSECTION
//REGION INIT
IF
DB_UND_ElevatorGuards(_Guard)
THEN
DB_GLO_DefeatCounter(_Guard,"UND_DeadElevatorGuards");

PROC
PROC_StateSet_Defeated((CHARACTER)_Guard)
AND
DB_UND_ElevatorGuards(_Guard)
THEN
PROC_UND_ElevatorGuards_ClearDialogEvent();

IF
Died(_Guard)
AND
DB_UND_ElevatorGuards(_Guard)
THEN
PROC_ClearCorpseOwner(_Guard);
NOT DB_UND_ElevatorGuards(_Guard);

//END_REGION

//REGION Three-way Dialog Event
IF
Died(_NPC)
AND
DB_UND_ElevatorNPCs(_NPC)
AND
NOT DB_GlobalFlag(UND_ElevatorGuards_State_Did3WayDialogue_fdb6d402-df59-591d-2800-16a7df81b78d)
THEN
PROC_UND_ElevatorGuards_ClearDialogEvent();

IF
WentOnStage(_NPC, 0)
AND
DB_UND_ElevatorNPCs((CHARACTER)_NPC)
AND
NOT DB_GlobalFlag(UND_ElevatorGuards_State_Did3WayDialogue_fdb6d402-df59-591d-2800-16a7df81b78d)
THEN
PROC_UND_ElevatorGuards_ClearDialogEvent();

IF
FlagSet(UND_ElevatorGuards_State_Did3WayDialogue_fdb6d402-df59-591d-2800-16a7df81b78d, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
PROC_UND_ElevatorGuards_ClearDialogEvent();

PROC
PROC_UND_ElevatorGuards_ClearDialogEvent()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af);
PROC_RemoveAllDialogEntriesForSpeaker(S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d);
PROC_RemoveAllDialogEntriesForSpeaker(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765);


QRY
QRY_SelectCustomDialog_AfterGenerics(_NPC, _Player)
AND
DB_UND_ElevatorNPCs((CHARACTER)_NPC)
AND
NOT DB_GlobalFlag(UND_ElevatorGuards_State_Did3WayDialogue_fdb6d402-df59-591d-2800-16a7df81b78d)
AND
NOT DB_OffStage(S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af)
AND
NOT DB_OffStage(S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d)
AND
NOT DB_OffStage(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)UND_ElevatorGuards_04a31948-693c-a2ff-a074-940830a5d60e, (CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af,(CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d,(CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af, _Player)
AND
NOT DB_SelectedDialog((DIALOGRESOURCE)UND_ElevatorGuards_04a31948-693c-a2ff-a074-940830a5d60e, (CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af,(CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d,(CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)UND_ElevatorGuard_001_26a4f8f3-a030-9dfe-6fdb-d6e202d20641, (CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d, _Player)
AND
NOT DB_SelectedDialog((DIALOGRESOURCE)UND_ElevatorGuards_04a31948-693c-a2ff-a074-940830a5d60e, (CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af,(CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d,(CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)UND_ElevatorGuard_002_5c63904b-bc50-1f94-c3e8-95f907dbf49b, (CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765, _Player)
AND
NOT QRY_UND_ElevatorGnome_LeftElevator()
AND
NOT DB_SelectedDialog((DIALOGRESOURCE)UND_ElevatorGuards_04a31948-693c-a2ff-a074-940830a5d60e, (CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af,(CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d,(CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)UND_ElevatorGnome_dd648348-5a8b-26c4-43d0-43f74c6bd2e5, (CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765, _Player);

PROC
PROC_UND_DuergarCamp_Deserted()
THEN
NOT DB_OneShotPartyTrigger((TRIGGER)S_UND_ElevatorGuards_EmptyMug_OneShotADTrigger_66df133f-900f-4da2-a5fe-a4c3e085355f);
PROC_TriggerUnregisterForParty(S_UND_ElevatorGuards_EmptyMug_OneShotADTrigger_66df133f-900f-4da2-a5fe-a4c3e085355f);

PROC
PROC_OneShotTriggerEntered(_Player,(TRIGGER)S_UND_ElevatorGuards_EmptyMug_OneShotADTrigger_66df133f-900f-4da2-a5fe-a4c3e085355f)
AND
NOT QRY_UND_DuergarCamp_Elevator_OffStage()
THEN
PROC_TryStartAD((DIALOGRESOURCE)UND_ElevatorGuards_AD_EmptyMug_d805c62d-cf92-262d-3761-d67dbfdefa4b,
				(CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af,
				(CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d,
				(CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765);

QRY
QRY_UND_DuergarCamp_Elevator_OffStage()
AND
DB_UND_ElevatorNPCs(_Character)
AND
DB_OffStage(_Character)
THEN
DB_NOOP(1);

QRY
QRY_UND_ElevatorGnome_LeftElevator()
AND
DB_GlobalFlag((FLAG)UND_ElevatorGnome_State_CaveIn_3be5d4ab-7b67-4224-8e7f-207bfd7f14ab)
THEN
DB_NOOP(1);

QRY
QRY_UND_ElevatorGnome_LeftElevator()
AND
DB_GlobalFlag((FLAG)UND_ElevatorGnome_State_Myconids_7c7d96f4-f1e9-4d6f-96ec-dd8c5ac8153d)
THEN
DB_NOOP(1);

//END_REGION


IF
DialogEnded(UND_ElevatorGnome_dd648348-5a8b-26c4-43d0-43f74c6bd2e5,_)
AND
DB_GlobalFlag((FLAG)UND_ElevatorGnome_Event_AttackDuergar_0f9ed1a1-9497-44dc-b331-b3f54fb657aa)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_ElevatorGnome_c71c6d74-33a4-41c8-8256-f85a7c763b20,(FACTION)ACT1_UND_DuergarRebels_ElevatorGuards_a14e975e-df2c-4a93-874a-311e45969a79,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarRebels_ElevatorGuards_a14e975e-df2c-4a93-874a-311e45969a79,0);
ClearFlag(UND_ElevatorGnome_Event_AttackDuergar_0f9ed1a1-9497-44dc-b331-b3f54fb657aa);

//Ensuring the Gnome doesn't investigate the death of the Duergar hassling him
IF
CrimeIsRegistered(_Duergar, "Assault", _Id, _, _, _, _, _)
AND
DB_UND_ElevatorGuards(_Duergar)
THEN
CrimeIgnoreCrime(_Id, S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765);

//REGION Trying elevator
IF
UseStarted(_Player,S_UND_Elevator_Fort_ToShadowlands_e48a9110-dabc-4471-bcae-3cc8aa57b8c5)
AND
NOT DB_GlobalFlag(UND_ElevatorToScl_Used_0a667e94-d789-4914-a5d5-93bd02ece820)
THEN
PROC_GlobalSetFlagAndCache(UND_ElevatorToScl_Used_0a667e94-d789-4914-a5d5-93bd02ece820);

PROC
PROC_BlockUseOfItem(_Player,S_UND_ElevatorGate_df97b259-59ce-4e8b-a3cc-6fa9008a195f)
AND
DB_Players(_Player)
AND
NOT DB_OffStage(S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af,_Player)
AND
QRY_OnlyOnce("UND_DuergarCamp_ElevatorWarned")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)UND_DuergarCamp_ElevatorWarning_f54502b3-1439-1cc8-371a-5a412dc0428f,(CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af,NULL_00000000-0000-0000-0000-000000000000,_Player)
THEN
DB_CustomUseItemResponse(_Player,(ITEM)S_UND_ElevatorGate_df97b259-59ce-4e8b-a3cc-6fa9008a195f,0);

PROC
PROC_BlockUseOfItem(_Player,S_UND_ElevatorGate_df97b259-59ce-4e8b-a3cc-6fa9008a195f)
AND
DB_Players(_Player)
AND
NOT DB_OffStage(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765)
AND
QRY_OnlyOnce("UND_DuergarCamp_ElevatorWarned")
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,_Player)
AND
QRY_StartDialog((DIALOGRESOURCE)UND_DuergarCamp_ElevatorWarningGnome_39275aa4-dd5e-129f-f987-bebef7a2d324,(CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,_Player)
THEN
DB_CustomUseItemResponse(_Player,(ITEM)S_UND_ElevatorGate_df97b259-59ce-4e8b-a3cc-6fa9008a195f,0);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)UND_DuergarCamp_ElevatorWarning_f54502b3-1439-1cc8-371a-5a412dc0428f,(INTEGER)_ID)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d,(CHARACTER)S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af)
THEN
PROC_DialogAddSpeakingActor(_ID,(CHARACTER)S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d);

//END_REGION


//REGION Outcomes
//Move to the cave-in
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)UND_ElevatorGnome_State_CaveIn_3be5d4ab-7b67-4224-8e7f-207bfd7f14ab)
THEN
SetHasDialog(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,0);
PROC_RemoveAllDialogEntriesForSpeaker(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765);
PROC_CharacterMoveTo(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,S_UND_ElevatorGnome_CaveInTrigger_2823a172-444e-4280-a954-b69861e3dee0,"Run","UND_ElevatorGnome_ReachedCaveIn");
DB_UND_GnomeWorkers((CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,(TRIGGER)S_UND_ElevatorGnome_SavedTrigger_b4cd2e76-6b72-4e02-ad20-eb9e5c3061d2,(DIALOGRESOURCE)UND_ElevatorGnome_Saved_5fc7dfab-bc17-358b-63e4-fbdfb0fa476c,1,0);

IF
EntityEvent(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,"UND_ElevatorGnome_ReachedCaveIn")
THEN
DB_Dialogs((CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,(DIALOGRESOURCE)UND_ElevatorGnome_CaveIn_4b8f96a4-035a-0167-cc51-c9834ebdc1d7);

//Leave to Myconids
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)UND_ElevatorGnome_State_Myconids_7c7d96f4-f1e9-4d6f-96ec-dd8c5ac8153d)
THEN
DB_UND_GnomeWorkers((CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,(TRIGGER)S_UND_ElevatorGnome_SavedTrigger_b4cd2e76-6b72-4e02-ad20-eb9e5c3061d2,(DIALOGRESOURCE)UND_ElevatorGnome_Saved_5fc7dfab-bc17-358b-63e4-fbdfb0fa476c,1,0);
SetHasDialog(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,0);
PROC_RemoveAllDialogEntriesForSpeaker(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765);
PROC_DisappearOutOfSightTo(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,S_UND_DarkLake_BoatPassengerPositionAtCamp_3478b34d-0e4f-4a4b-8f9f-b7d9361eec8b,"Run",1,"UND_GnomeWorker_Left");

//Go to SCL
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)UND_ElevatorGnome_State_Shadowlands_23f0472a-c83d-4a43-a82e-79b75554e178)
THEN
SetHasDialog(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,0);
PROC_RemoveAllDialogEntriesForSpeaker(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765);
PROC_CharacterMoveTo(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,S_UND_Elevator_Fort_ToShadowlands_e48a9110-dabc-4471-bcae-3cc8aa57b8c5,"Walk","UND_ElevatorGnome_ToSCL");

IF
EntityEvent(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,"UND_ElevatorGnome_ToSCL")
THEN
TeleportTo(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,S_SCL_ElevatorGnome_DeathTrigger_2effedd7-4e97-4615-9cdf-5211145f224c,"");
Die(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,DEATHTYPE.Incinerate,1);

//Go offstage
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)UND_ElevatorGnome_State_OffStage_91348abe-231b-4706-ad8c-6211eca2ee7d)
THEN
SetHasDialog(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,0);
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765);
PROC_DisappearOutOfSightTo(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,S_UND_DarkLake_BoatPassengerPositionAtCamp_3478b34d-0e4f-4a4b-8f9f-b7d9361eec8b,"Run",1,"");

//END_REGION

//REGION Beer poisoning
IF
Combined(S_UND_ElevatorGnome_BeerBarrel_3c1836b4-2bae-4f2d-9903-4b609639cf57, _, _, _, _, _Player, _NewBarrel)
THEN
SetFlag((FLAG)UND_ElevatorGnome_State_BarrelPoisoned_58a8b308-5e24-4ec1-a404-7904331e7e39);
SetDualEntityEvent(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765, _NewBarrel, "UND_ElevatorGnome_NewBarrel");
PROC_UND_DuergarCamp_SetPoisonedBeerOwnership(_NewBarrel);

PROC
PROC_UND_DuergarCamp_SetPoisonedBeerOwnership((ITEM)_NewBarrel)
AND
DB_UND_ElevatorGuards(_Guard)
THEN
SetOwner(_NewBarrel,_Guard);

IF
TemplateUseFinished(_Player, FUR_GEN_Tavern_Barrel_Beer_Small_A_Interactable_Poisoned_a26ae9d0-6a7a-448e-82e8-66d79eb5e6a0, _Item, 1)
AND
DB_Players(_Player)
THEN
ApplyStatus(_Player, "GOB_SMALLPOISON", 60.0, 1, _Item); // the status doesn't mention goblins, only beer, so works fine
//END_REGION Beer poisoning

//REGION Debug
IF
TextEvent("und_ug")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player, S_UND_ElevatorGnome_Home_b799dd45-b354-4ffd-8ea1-e0c9892145ca, "", 1, 1, 1, 1, 1);


IF
TextEvent("UND_ElevatorGuard_Poison")
AND
DB_UND_ElevatorGuards(_Duergar)
THEN
SetEntityEvent(_Duergar, "UND_ElevatorGnome_Poisoned");

IF
TextEvent("UND_CampDeserted")
THEN
PROC_UND_DuergarCamp_Deserted();
//END_REGION Debug

//REGION AD from the gnome after the duergar die from poison
IF
EntityEvent((CHARACTER)_Duergar, "UND_ElevatorGnome_Poisoned")
AND
DB_UND_ElevatorGuards(_Duergar)
THEN
Die(_Duergar, DEATHTYPE.DoT, 1);
DB_UND_ElevatorGnome_DuergarPoisoned(_Duergar);

IF
DB_UND_ElevatorGnome_DuergarPoisoned(S_UND_ElevatorGuard_001_986cb3be-bb31-4aa8-85c0-1f9a315760af)
AND
DB_UND_ElevatorGnome_DuergarPoisoned(S_UND_ElevatorGuard_002_472eba90-f5e8-48cb-ad55-2397e0013a2d)
THEN
PROC_TryStartAD(UND_ElevatorGnome_AD_DuergarPoisoned_c294fb9c-d8f7-0d65-f68c-379826d856b7, (CHARACTER)S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765);

IF
FlagSet(UND_ElevatorGuards_State_PermaDefeated_5f1f5c9b-e05d-46be-aca2-4e298f8ef4bd,_,_)
THEN
TimerLaunch("UND_ElevatorGnome_PoisonReaction_Spotting_Timer",4000); // give gnome time to AD

IF
TimerFinished("UND_ElevatorGnome_PoisonReaction_Spotting_Timer")
THEN
DB_SpotPlayers(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,"UND_ElevatorGnome_PoisonReaction_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

// If we manually talk to Skickpit after resolving the situation prevent spot events
// Prevents dialog from starting twice in a row
IF
DialogEnded(UND_ElevatorGnome_dd648348-5a8b-26c4-43d0-43f74c6bd2e5, _)
AND
DB_GlobalFlag((FLAG)UND_ElevatorGuards_State_PermaDefeated_5f1f5c9b-e05d-46be-aca2-4e298f8ef4bd)
THEN
TimerCancel("UND_ElevatorGnome_PoisonReaction_Spotting_Timer");

IF
DialogEnded(UND_ElevatorGnome_dd648348-5a8b-26c4-43d0-43f74c6bd2e5, _)
AND
DB_GlobalFlag((FLAG)UND_ElevatorGuards_State_PermaDefeated_5f1f5c9b-e05d-46be-aca2-4e298f8ef4bd)
AND
DB_SpotPlayers(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,"UND_ElevatorGnome_PoisonReaction_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_SpotPlayers(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,"UND_ElevatorGnome_PoisonReaction_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,"UND_ElevatorGnome_PoisonReaction_Spotting",_Player)
AND
NOT QRY_GOB_Orpheus_AnyPlayerInPreparedOrpheus()
AND
NOT QRY_GOB_Orpheus_SomeoneInsideDialog()
AND
QRY_StartDialog((DIALOGRESOURCE)UND_ElevatorGnome_dd648348-5a8b-26c4-43d0-43f74c6bd2e5,S_UND_ElevatorGnome_348c5bc8-c514-41d7-a997-c8e58814d765,_Player)
THEN
DB_NOOP(1);

//END_REGION AD from the gnome after the duergar die from poison


EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
