Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Dialogs
//DB_Dialogs(S_UND_GnomeForeman_42abeae0-3ccd-4b02-94d7-08175b343321,UND_GnomeForeman_a59832df-8838-e23b-3106-bb65e599f7fa);
DB_Dialogs(S_UND_GnomeWorkerLumpy_925df004-4815-4919-8545-d128b74043b1,UND_GnomeWorkerLumpy_6a313dc7-8810-50da-93f6-7e70f008f215);
DB_Dialogs(S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,UND_GnomeWorkerDaffy_fae83730-13d3-892a-91b5-0dbaef3d92e7);
DB_Dialogs(S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,UND_GnomeWorkerSilly_04c2bc70-2dac-a170-85dc-d7eb36bdd047);
//DB_Dialogs((CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,(CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,(DIALOGRESOURCE)UND_ArguingGnomes_9c452899-9ae3-08e5-2034-d1b1d6dcfde5);

DB_Dialogs(S_UND_DuergarGuardBored_30fb7e6e-40d2-4e77-b5ea-887f8eb345c9,UND_DuergarGuardBored_bd832a1a-aadf-0413-7c4d-f06f0d695a0a);
DB_Dialogs(S_UND_DuergarGuardFocused_ccf9ef29-3d8e-4751-a7ae-203bec7352c3,UND_DuergarGuardFocused_29dfbe39-220f-35d3-9c21-767105b66da8);
DB_Dialogs(S_UND_DuergarRebelGuard_03_baac0ae3-7b2e-47e6-85e4-579f70d4b4fa,UND_DuergarGuardFrantic_b40c913a-8f25-d92b-f449-7bf9e5ed1dbd);
DB_Dialogs(S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3,UND_DuergarGuardGreedy_50eb3fcd-29ef-3c75-adf9-e2971594d96b);
DB_Dialogs(S_UND_DuergarGuardNervous_908f6096-360e-44dc-b2ff-63a7d32c015b,UND_DuergarGuardNervous_ce6deff1-6fa8-f7dc-086a-c776fe8812fb);
DB_Dialogs(S_UND_DuergarGuardWry_dd93e23c-c62d-4927-9ea7-50e11621825e,UND_DuergarGuardWry_681a4583-cf53-0f20-0ad3-12797fda7eb6);
DB_Dialogs(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,UND_DuergarGuardSergeant_7b319090-fe6f-d6bd-dcc9-5ebada7f369a);

//Dialogs for trapped characters disabled at start to prevent any unintational way of triggering them
//DB_Dialogs(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,UND_TheDrowNere_FollowUp_6b0c0d3d-91b3-84af-3704-8edad589d983);

DB_Dialogs((CHARACTER)S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73,(DIALOGRESOURCE)UND_ScryingEye_7bec9639-5f5d-e9a0-c66f-7f4fd6e424eb);

DB_GLO_CharacterCorpseDialog(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,UND_TheDrowNere_Dead_8bfa90e1-50f5-4104-0fd6-818f0e136704);
DB_GLO_CharacterCorpseDialog(S_UND_GnomeForeman_42abeae0-3ccd-4b02-94d7-08175b343321,UND_GnomeForeman_Dead_135c2e88-8244-c5c2-d529-51479c367f8f);
DB_GLO_CharacterCorpseDialog(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,UND_DuergarGuardSergeant_Dead_137ab97e-b81b-f64a-ad3c-b62e55ac7a35);


//END_REGION


//REGION Member Count
//DB_UND_GnomeWorkers(_Character,_TriggerAtMyconids,_DialogAtMyconids,_ShouldGoToMyconidsBool,_DebrisCleanerBool);
DB_UND_GnomeWorkers((CHARACTER)S_UND_GnomeForeman_42abeae0-3ccd-4b02-94d7-08175b343321,(TRIGGER)S_UND_GnomeForeman_SavedTrigger_ae84fc10-001b-4052-8f2b-c7e1e9e004e4,(DIALOGRESOURCE)UND_GnomeForeman_Saved_5fa4695e-2f34-156b-9886-34333af2f98c,1,0);
DB_UND_GnomeWorkers(S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,(TRIGGER)S_UND_GnomeWorkerDaffy_SavedTrigger_8a9d6d50-8208-4424-8416-f01e6c2ca098,(DIALOGRESOURCE)UND_GnomeWorkerDaffy_Saved_f8b822c4-0450-126f-4b5d-2f0c33623c63,1,1);
DB_UND_GnomeWorkers(S_UND_GnomeWorkerLumpy_925df004-4815-4919-8545-d128b74043b1,(TRIGGER)S_UND_GnomeWorkerLumpy_SavedTrigger_073ef3d0-f1fa-4aa9-9a85-d4f21a8d3b22,(DIALOGRESOURCE)UND_GnomeWorkerLumpy_Saved_5dda9ddc-e941-a00f-42f9-43fcf8f152f2,1,1);
DB_UND_GnomeWorkers(S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,(TRIGGER)S_UND_GnomeWorkerSilly_SavedTrigger_aed85589-355a-4c25-bdb7-f6c4c3120a86,(DIALOGRESOURCE)UND_GnomeWorkerSilly_04c2bc70-2dac-a170-85dc-d7eb36bdd047,1,1);
DB_UND_GnomeWorkers(S_UND_GnomeWorkerSerene_Trapped_0203c8b5-2a34-4bf2-b729-f0f240f26a4f,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,0,0);

DB_UND_DuergarGuards_Excavation((CHARACTER)S_UND_DuergarGuardBored_30fb7e6e-40d2-4e77-b5ea-887f8eb345c9,(TRIGGER)S_UND_DuergarGuardBored_CaveInTrigger_7370f40d-f9e2-4c19-ae1d-1d4e058338ab);
DB_UND_DuergarGuards_Excavation(S_UND_DuergarGuardFocused_ccf9ef29-3d8e-4751-a7ae-203bec7352c3,S_UND_DuergarGuardFocused_CaveInTrigger_ff20e06e-4cf0-4c81-b0b5-9cccf9fa52a9);
DB_UND_DuergarGuards_Excavation(S_UND_DuergarRebelGuard_03_baac0ae3-7b2e-47e6-85e4-579f70d4b4fa,S_UND_DuergarGuardFrantic_CaveInTrigger_02ce3d3c-7d33-4e04-8670-2765a74b95c9);
DB_UND_DuergarGuards_Excavation(S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3,S_UND_DuergarGuardGreedy_CaveInTrigger_0dd3b29f-35de-4123-b599-12bd84b00f41);
DB_UND_DuergarGuards_Excavation(S_UND_DuergarGuardNervous_908f6096-360e-44dc-b2ff-63a7d32c015b,S_UND_DuergarGuardNervous_CaveInTrigger_ec7bd665-a682-4014-b3d6-405ebc4136bc);
DB_UND_DuergarGuards_Excavation(S_UND_DuergarGuardWry_dd93e23c-c62d-4927-9ea7-50e11621825e,S_UND_DuergarGuardWry_CaveInTrigger_f7903cec-b7c9-4170-8572-2108da5ca2b4);
DB_UND_DuergarGuards_Excavation(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,S_UND_DuergarGuardSergeant_AtDrowTrigger_e6186dc7-71f0-4bff-a5b4-190dbd4d3f7f);
DB_UND_DuergarGuards_Excavation(S_UND_DuergarLoyalGuard_02_cc942779-3d2d-4327-9704-c6c385c12c82,S_UND_DuergarLoyalGuard_02_HomeTrigger_895e38e3-aa19-4d0d-9285-5f10dbc864a4);

//END_REGION

DB_PermaDefeatedFlag(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,(FLAG)UND_TheDrowNere_State_PermaDefeated_53f1e115-adf8-4608-b85c-08e0dc7d67ad);
DB_PermaDefeatedFlag(S_UND_GnomeForeman_42abeae0-3ccd-4b02-94d7-08175b343321,(FLAG)UND_GnomeForeman_State_PermaDefeated_32e110c6-7830-4ebe-be12-de932bd16e3f);
DB_PermaDefeatedFlag(S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,(FLAG)UND_GnomeWorkerDaffy_PermaDefeated_92f4d092-e94e-4b31-ab50-e8cb404fe908);
DB_PermaDefeatedFlag(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,(FLAG)UND_DuergarSergeant_PermaDefeated_c4136bfb-d994-4ba5-8c1c-cc3216d6f299);
DB_PermaDefeatedFlag(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73,(FLAG)UND_ScryingEye_PermaDefeated_dc0f5dbb-36df-46c1-af81-6428a8733e9a);
DB_PermaDefeatedFlag(S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3, (FLAG)UND_DuergarRebelGreedy_State_PermaDefeated_ba3892f1-29d9-b8c3-fba1-a045018592bc);
DB_PermaDefeatedFlag(S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,(FLAG)UND_GnomeWorkerSilly_State_PermaDefeated_dddd720d-12bc-4561-a103-cf0149a8eaf6);


DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_PermaDefeatedDuergarExcavationGuards",(FLAG)UND_DuergarGuards_Excavation_State_PermaDefeated_3f30c825-10f1-4fa5-84b8-073f293e6650);
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_PermaDefeatedGnomeWorkers",(FLAG)UND_GnomeWorkers_State_PermaDefeated_99fa547a-d3c9-46fe-b53f-7cceb510cd6f);
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_PermaDefeatedDebrisCleaners",(FLAG)UND_DebrisCleaners_State_PermaDefeated_c74816bf-a62c-49b7-80a8-4e0f95020f91);

DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_TheDrowNere_Mutiny_27bbde20-f6d3-5c4c-c7ac-0c7345b29a9a);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_TheDrowNere_FollowUp_6b0c0d3d-91b3-84af-3704-8edad589d983);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_DuergarLoyalSergeant_FollowUp_bc4bb06b-b548-7308-8cfc-267e15f4bad9);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_DuergarCamp_LoyalFollowUp_13a8c8cf-d624-af41-4517-a89ae6ab4ba2);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_DuergarCamp_Mutineers_FollowUp_c8cb06cc-f045-4f52-09d7-1585957a579f);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_DuergarCamp_Mutineers_GroupFollowUp_30f6e1f4-3801-2792-5355-1fd1dc8475d3);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_DuergarCamp_RebelGreedyExtort_215eee07-c03b-83af-4d82-72951456e6c1);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_DuergarCamp_RebelsExtort_71f0ea58-5db0-5631-9126-11b47baf7bc2);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_TheDrowNere_Mindmeld_7c77bbf6-fe5d-f1dd-8666-7da1f1fca029);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_TheDrowNere_Mindmeld_LeavingRegion_61d63c10-bbd8-da75-3e0e-179714b95278);

DB_NoLowAttitudeDialog((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);

DB_FlagReactionAfterDialog((FLAG)UND_ScryingEye_Event_AttackEye_8001df48-3539-2040-212e-b4f0a4d58334,(DIALOGRESOURCE)UND_ScryingEye_7bec9639-5f5d-e9a0-c66f-7f4fd6e424eb);

TriggerRegisterForItems(S_UND_DuergarCamp_ExplosionDetectionTrigger_18f27e06-8e2d-4df2-bde2-c6bd66f435cb);

DB_OneShot_VoiceBarkTrigger(S_UND_DuergarCamp_Entrance_VB_Trigger_22ae5c73-e009-4b28-9614-661586a71453,UND_DuergarCamp_Entrance_VB_ecd2ecc6-bcfd-0eb8-a01e-83cf1ea9b90e);

//Mutineers after Nere combat
DB_DialogMoneyTransfer(1,(DIALOGRESOURCE)UND_DuergarCamp_RebelsExtort_71f0ea58-5db0-5631-9126-11b47baf7bc2,500,2);
DB_DialogMoneyTransfer(1,(DIALOGRESOURCE)UND_DuergarCamp_RebelGreedyExtort_215eee07-c03b-83af-4d82-72951456e6c1,500,2);

DB_HasItemEvent(S_UND_GnomeRevivifyScroll_d834fcd2-e700-4d1c-8a99-5fe7d40dabac,(FLAG)UND_GnomeWorkerSilly_HasScroll_dce0b7da-4347-4a73-acbf-8cb7aedcb211);
DB_GiveItemToEvent(S_UND_GnomeRevivifyScroll_d834fcd2-e700-4d1c-8a99-5fe7d40dabac,(FLAG)UND_GnomeWorkerSilly_GiveScroll_bc961604-bb0e-4705-ba36-78527e78f067);

DB_Inclusion_Object((CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,(FLAG)UND_TheDrowNere_Mutiny_InclusionStart_GnomeSilly_cd2a64d5-8b75-4ba7-9fdf-9cfefff1e9f2,(FLAG)UND_TheDrowNere_Mutiny_InclusionEnd_GnomeSilly_2639761d-63d2-0862-b23e-04bc5b71904e);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)UND_TheDrowNere_Mutiny_27bbde20-f6d3-5c4c-c7ac-0c7345b29a9a,(CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e);
DB_CustomDialogRange((CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,20);

DB_Inclusion_Object((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,(FLAG)UND_GnomeForeman_UnfortunateGnome_InclusionStart_722c413e-800a-46c4-9382-bc21d63a09b3,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)UND_GnomeForeman_a59832df-8838-e23b-3106-bb65e599f7fa,(CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
DB_CustomDialogRange((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,20);

//Mutineers reward
DB_DialogMoneyTransfer(1,(DIALOGRESOURCE)UND_DuergarCamp_Mutineers_FollowUp_c8cb06cc-f045-4f52-09d7-1585957a579f,400,1);
DB_DialogMoneyTransfer(2,(DIALOGRESOURCE)UND_DuergarCamp_Mutineers_FollowUp_c8cb06cc-f045-4f52-09d7-1585957a579f,500,1);
DB_DialogMoneyTransfer(1,(DIALOGRESOURCE)UND_DuergarCamp_Mutineers_GroupFollowUp_30f6e1f4-3801-2792-5355-1fd1dc8475d3,400,1);
DB_DialogMoneyTransfer(2,(DIALOGRESOURCE)UND_DuergarCamp_Mutineers_GroupFollowUp_30f6e1f4-3801-2792-5355-1fd1dc8475d3,500,1);
//Adding through story to have the guaranteed sum available
AddGold(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,1000);

DB_HasItemEvent((ITEM)S_UND_TheDrowNere_DaggerReward_6f3783a1-bb65-4900-82be-538153b99ee1,(FLAG)UND_TheDrowNere_HasDagger_d540c5b4-4155-4dc9-9c72-3804b4df4378);
DB_GiveItemToEvent((ITEM)S_UND_TheDrowNere_DaggerReward_6f3783a1-bb65-4900-82be-538153b99ee1,(FLAG)UND_TheDrowNere_GiveDagger_065e0499-3538-41f2-b849-ac541e7d89a6);

//Nere combat aura helper
PROC_SetOnStage(S_UND_KC_Nere_Destination_Helper_01_425e741a-f3a4-4f71-ab25-3a3c75fefdf5,0);

DB_GlobalFlagReactionAfterDialog(UND_DuergarCamp_State_SidedDrow_9c15716b-2e73-3bde-7e1c-8580aa4b1850,(DIALOGRESOURCE)UND_TheDrowNere_Mutiny_27bbde20-f6d3-5c4c-c7ac-0c7345b29a9a);

DB_UND_DuergarCamp_Mutineers_FollowUpSpeakers((CHARACTER)S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3,(DIALOGRESOURCE)UND_DuergarCamp_Mutineers_FollowUp_c8cb06cc-f045-4f52-09d7-1585957a579f,(DIALOGRESOURCE)UND_DuergarCamp_RebelGreedyExtort_215eee07-c03b-83af-4d82-72951456e6c1);
DB_UND_DuergarCamp_Mutineers_FollowUpSpeakers((CHARACTER)S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,UND_DuergarCamp_Mutineers_GroupFollowUp_30f6e1f4-3801-2792-5355-1fd1dc8475d3,UND_DuergarCamp_RebelsExtort_71f0ea58-5db0-5631-9126-11b47baf7bc2);

DB_UND_DuergarCamp_NerePostCombat_FollowUpSpeakers((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,(DIALOGRESOURCE)UND_TheDrowNere_FollowUp_6b0c0d3d-91b3-84af-3704-8edad589d983);
DB_UND_DuergarCamp_NerePostCombat_FollowUpSpeakers((CHARACTER)S_UND_DuergarLoyalSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,(DIALOGRESOURCE)UND_DuergarLoyalSergeant_FollowUp_bc4bb06b-b548-7308-8cfc-267e15f4bad9);
DB_UND_DuergarCamp_NerePostCombat_FollowUpSpeakers((CHARACTER)S_UND_DuergarLoyalFallback_0160d049-e0b2-473b-a5c2-ff8b13719d84,(DIALOGRESOURCE)UND_DuergarCamp_LoyalFollowUp_13a8c8cf-d624-af41-4517-a89ae6ab4ba2);

PROC_SetOnStage(S_UND_DuergarLoyalFallback_0160d049-e0b2-473b-a5c2-ff8b13719d84,0);
PROC_SetOnStage(S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,0);

DB_GLO_FireBowls(S_UND_Firebowl_Bowl_001_644a933b-9671-4892-9fc2-01681ae50cd8,S_UND_Firebowl_Hinge_001_7de34dde-1145-463f-ac85-29552f33115e);	//Underdark, Nere Bossfight

SetTag(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);

//UND_GnomeRescue
DB_QuestDef_State((FLAG)UND_TheDrowNere_State_GnomesExecuted_7f3f882c-40fb-430e-8df6-c1d6e450aebd,"UND_GnomeRescue","GnomesExecuted");
DB_QuestDef_State((FLAG)UND_DuergarCamp_State_SidedNone_c17245d9-ecb7-4562-a9fe-74a6759ff47b,"UND_GnomeRescue","SidedNone");
DB_QuestDef_State((FLAG)UND_DuergarCamp_State_SidedMutineers_581443f0-b4bd-d3c2-7122-a4d2aa7fb5f9,"UND_GnomeRescue","SidedMutineers");
DB_QuestDef_State((FLAG)UND_State_LeaderFreedGnomes_49acb531-d0c4-d3d1-6af4-c79e246e4327,"UND_GnomeRescue","DealtWithSlavers");
DB_QuestDef_State((FLAG)UND_DuergarCamp_State_GnomesHostile_53aab2ec-c119-b4ed-c3b2-7181e4ecbaf7,"UND_GnomeRescue","SidedLoyal");
DB_QuestDef_State((FLAG)UND_GnomeWorkers_State_PermaDefeated_99fa547a-d3c9-46fe-b53f-7cceb510cd6f,"UND_GnomeRescue","GnomesDefeated");
DB_QuestDef_State((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3, "UND_GnomeRescue","LeftAct");

//UND_CaveIn
DB_QuestDef_State((FLAG)UND_Mutineers_Quest_Accepted_d37a860e-a0ea-9d9a-7dc0-d73a66f8663e,"UND_CaveIn","MutineersAskedHelp");
DB_QuestDef_State((FLAG)UND_FearfulRothe_State_RubbleDestroyed_f20c21ab-db2f-495d-ad0c-986187ec0570,"UND_CaveIn","ClearedOtherRubbles");

DB_QuestDef_State((FLAG)UND_Mutineers_Quest_KillEye_4d6b2dfd-ec3e-0a9d-c180-7dc064981566,"UND_CaveIn","MutineersTaskedKillEye");
DB_QuestDef_State((FLAG)UND_ScryingEye_PermaDefeated_dc0f5dbb-36df-46c1-af81-6428a8733e9a,"UND_CaveIn","KilledEye");
DB_QuestDef_DefeatedState("UND_CaveIn","BrithvarDefeated",S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3);

DB_QuestDef_BookReadState("UND_CaveIn","PhilomeenMapRead",(ITEM)S_UND_HiddenGnomeLetter_a2f4af6f-4fb2-408a-a2d3-3c670e512a23);

DB_QuestDef_State((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3, "UND_CaveIn","Eye_MainClosed");
DB_QuestDef_State((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3, "UND_CaveIn","Smokepowder_MainClosed");
DB_QuestDef_State_ConditionalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3, "UND_CaveIn","LeftAct", 0, (FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd);
DB_QuestDef_State_ConditionalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3, "UND_CaveIn","LeftAct_Cleared", 1, (FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd);
DB_QuestDef_State((FLAG)UND_DuergarCamp_State_SidedLoyal_74c05609-77b6-4f62-b9e0-9bcb24908d4b, "UND_CaveIn", "DuergarAttacked");
DB_QuestDef_State((FLAG)UND_DuergarCamp_State_SidedDrow_9c15716b-2e73-3bde-7e1c-8580aa4b1850, "UND_CaveIn", "DuergarAttacked");

//REGION Mutiny states flag management
DB_UND_KethericCity_MutinySides((FLAG)UND_DuergarCamp_State_SidedLoyal_74c05609-77b6-4f62-b9e0-9bcb24908d4b);
DB_UND_KethericCity_MutinySides((FLAG)UND_DuergarCamp_State_SidedMutineers_581443f0-b4bd-d3c2-7122-a4d2aa7fb5f9);
DB_UND_KethericCity_MutinySides((FLAG)UND_DuergarCamp_State_SidedDrow_9c15716b-2e73-3bde-7e1c-8580aa4b1850);
DB_UND_KethericCity_MutinySides((FLAG)UND_DuergarCamp_State_SidedNone_c17245d9-ecb7-4562-a9fe-74a6759ff47b);
//END_REGION Mutiny states flag management

//REGION Scrying Eye
DB_GLO_ScryingEye((CHARACTER)S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73,S_UND_ScryingEye_Area_18ce1f19-de95-45d7-a8a6-9430c43471e6);
PROC_CharacterDisableAllCrimes(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73);

DB_CRIME_Guards_RegionReinforcements("WLD_Main_A_UND", 1);
DB_CRIME_Guards_RegionInfo("WLD_Main_A_UND", "UND_DuergarCamp", NULL_00000000-0000-0000-0000-000000000000);
DB_CRIME_Guards_RegionGuard("WLD_Main_A_UND","UND_DuergarCamp",(CHARACTER)S_UND_DuergarLoyalFocused_ccf9ef29-3d8e-4751-a7ae-203bec7352c3);
DB_CRIME_Guards_RegionGuard("WLD_Main_A_UND","UND_DuergarCamp",(CHARACTER)S_UND_DuergarLoyalNervous_908f6096-360e-44dc-b2ff-63a7d32c015b);
DB_CRIME_Guards_RegionGuard("WLD_Main_A_UND","UND_DuergarCamp",(CHARACTER)S_UND_DuergarLoyalWry_dd93e23c-c62d-4927-9ea7-50e11621825e);
DB_CRIME_Guards_RegionGuard("WLD_Main_A_UND","UND_DuergarCamp",(CHARACTER)S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5);

DB_GLO_ScryingEye_AbsoluteFactions((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5);
DB_GLO_ScryingEye_AbsoluteFactions((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95);

DB_GLO_ScryingEye_PerRegionCrime((FLAG)UND_ScryingEyes_State_ActedHostile_d2dbf815-a401-48f2-a9fa-314fb0bf88f2,(TRIGGER)S_UND_KethericCity_SUB_eeb2e8d6-6c21-41d9-aef8-30b6f267a0a5);
//END_REGION

// Combat NPC Reactivity
DB_CombatReact_AD_OnCast(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, (DIALOGRESOURCE)UND_DuergarCamp_Nere_AD_ShieldOfScreams_1_bf874cc6-8e3e-97b4-1527-1ea299667a48, "Shout_UND_Nere_ShieldOfScreams");
DB_CombatReact_AD_OnCast(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, (DIALOGRESOURCE)UND_DuergarCamp_Nere_AD_ShieldOfScreams_2_6cf4feb2-2c73-6776-2fcc-74a7b8070d37, "Shout_UND_Nere_ShieldOfScreams");
DB_CombatReact_AD_OnCast(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, (DIALOGRESOURCE)UND_DuergarCamp_Nere_AD_Coercion_1_7f1dab57-2b9a-fea2-de82-cccb9f7288ec, "Target_UND_Nere_Coercion");
DB_CombatReact_AD_OnCast(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, (DIALOGRESOURCE)UND_DuergarCamp_Nere_AD_Coercion_2_db4e4ba6-a4a9-5e30-5e9c-239cb8ab2ca8, "Target_UND_Nere_Coercion");
DB_CombatReact_AD_OnCast(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, (DIALOGRESOURCE)UND_DuergarCamp_Nere_AD_Coercion_3_ab05a492-57a6-d2c3-a422-9440e0c286e5, "Target_UND_Nere_Coercion");

PROC_GLO_DifficultyModes_AddHPBoostedEntity(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);

ToInventory(S_UND_TheDrowNere_SpidersLyre_a9dcae28-c5ee-497c-91bd-d510efdf6099, S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, 1, 0, 0);
DB_HasItemEvent((ITEM)S_UND_TheDrowNere_SpidersLyre_a9dcae28-c5ee-497c-91bd-d510efdf6099, (FLAG)SCL_Drider_State_HasNereSpidersLyre_bdffc46f-be1c-4a88-bab2-a5692a2604df);
DB_GiveItemToEvent(S_UND_TheDrowNere_SpidersLyre_a9dcae28-c5ee-497c-91bd-d510efdf6099, (FLAG)UND_TheDrowNere_Event_GiveSpidersLyre_769a260f-9f93-4187-a535-ccc427d2babb);
KBSECTION
//REGION Debug
IF
FlagSet(Debug_UND_SaveGnomes_7fa45985-f058-0d01-e347-95d548ea09af,_,_)
AND
DB_UND_GnomeWorkers(_Gnome,_,_,_,_)
THEN
SetFlag(Debug_UND_CampWipe_4b370563-0b4a-8642-2f5a-bc040a0b85b1,NULL_00000000-0000-0000-0000-000000000000,0);
Die(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,DEATHTYPE.DoT,1);
SetFlag(UND_GnomeWorkers_Event_Leave_ad897c6f-87d5-4a30-88f0-41c92b965bc8,NULL_00000000-0000-0000-0000-000000000000,0);
PROC_ForceStopDialog(_Gnome);
SetHasDialog(_Gnome,0);
PROC_RemoveAllDialogEntriesForSpeaker(_Gnome);
PROC_DisappearOutOfSightTo(_Gnome,S_UND_DarkLake_BoatPassengerPositionAtCamp_3478b34d-0e4f-4a4b-8f9f-b7d9361eec8b,"Run",1,"UND_GnomeWorker_Left");

//END_REGION

//REGION INIT
IF
DB_UND_DuergarGuards_Excavation(_Duergar,_)
THEN
DB_GLO_DefeatCounter(_Duergar,"UND_PermaDefeatedDuergarExcavationGuards");

IF
DB_UND_GnomeWorkers(_Gnome,_,_,_,_)
THEN
DB_GLO_DefeatCounter(_Gnome,"UND_PermaDefeatedGnomeWorkers");

IF
DB_UND_GnomeWorkers(_Gnome,_,_,_,1)
THEN
DB_GLO_DefeatCounter(_Gnome,"UND_PermaDefeatedDebrisCleaners");

QRY
QRY_CRIME_Guards_GuardKillerExcludeWitness((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
THEN
DB_NOOP(1);

PROC
PROC_StateSet_PermaDefeated((CHARACTER)_Gnome)
AND
DB_UND_GnomeWorkers(_Gnome,_SavedTrigger,_SavedDialog,_GoesMyconids,_Digging)
THEN
NOT DB_UND_GnomeWorkers(_Gnome,_SavedTrigger,_SavedDialog,_GoesMyconids,_Digging);

QRY
QRY_CorpseLooting_BlockMakeOwned(_Duergar)
AND
DB_UND_DuergarGuards_Excavation(_Duergar,_)
THEN
DB_NOOP(1);

IF
DB_UND_DuergarCamp_Mutineers_FollowUpSpeakers(_Speaker,_,_)
THEN
DB_NoLowAttitudeDialog(_Speaker);

IF
DB_UND_DuergarCamp_NerePostCombat_FollowUpSpeakers(_Speaker,_)
THEN
DB_NoLowAttitudeDialog(_Speaker);

//END_REGION

//REGION Misc
IF
CharacterLootedCharacter(_Player,S_UND_DeadScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73)
AND
QRY_OncePerUserAndNearbyPlayers(_Player,"UND_DuergarCamp_PAD_DeadScryingEye")
THEN
PROC_TryStartAD((DIALOGRESOURCE)UND_DuergarCamp_PAD_DeadScryingEye_34f4f2a4-7ca2-fd24-e3a9-eee0c843975b,(CHARACTER)_Player);

IF
DB_Sees(_Player,(CHARACTER)S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73)
AND
DB_Players(_Player)
AND
QRY_OncePerUserAndNearbyPlayers(_Player,"UND_DuergarCamp_VB_SeenScryingEye")
THEN
StartVoiceBark(UND_DuergarCamp_VB_SeenScryingEye_6128e08d-fb99-552a-cdcf-08bf1ae15f70,_Player);

IF
EntityEvent(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec,"UND_DuergarRaftCaptain_DebriefingEnd")
THEN
PROC_CharacterMoveTo(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec,TRIGGERGUID_S_UND_DuergarRaftCaptain_FirePitTrigger_bca8bf9a-8c24-4c07-81bc-d015490ea68f,"Walk","");

IF
FlagSet(_Flag,_,_)
AND
DB_UND_KethericCity_MutinySides(_Flag)
AND
DB_UND_KethericCity_MutinySides(_Flag2)
AND
_Flag != _Flag2
THEN
ClearFlag(_Flag2,NULL_00000000-0000-0000-0000-000000000000,0);
//END_REGION

//REGION Scrying Eye Murder
//Rebels ignore any crimes with eye once deal has been made to kill it
IF
CrimeIsRegistered(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73, _Crime, _ID, _, _, _, _, _)
AND
DB_GlobalFlag(UND_Mutineers_Quest_KillEye_4d6b2dfd-ec3e-0a9d-c180-7dc064981566)
AND
DB_UND_DuergarCamp_Rebels(_Rebel)
THEN
CrimeIgnoreCrime(_ID, _Rebel);

PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Player,(FLAG)UND_ScryingEye_Event_AttackEye_8001df48-3539-2040-212e-b4f0a4d58334)
AND
DB_Players(_Player)
THEN
Attack(_Player,S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73);
ClearFlag(UND_ScryingEye_Event_AttackEye_8001df48-3539-2040-212e-b4f0a4d58334,_Player,0);

/*
QRY
QRY_CrimeMurderGetCrimeTypesCustom(_Killer, (CHARACTER)S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73)
THEN
DB_QRYRTN_CrimeMurderGetCrimeTypes("UND_ScryingEye_Murder");
*/

//END_REGION Scrying Eye Murder

//REGION Gnome dialogs

//Removing Barcus inclusion after leaving
IF
FlagSet(UND_UnfortunateGnome_Event_GoCamp_ce63b2ca-4692-551f-db78-0bff8dd0da6d, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
NOT DB_Inclusion_Object((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,(FLAG)UND_GnomeForeman_UnfortunateGnome_InclusionStart_722c413e-800a-46c4-9382-bc21d63a09b3,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_Inclusion_NPCDialog((DIALOGRESOURCE)UND_GnomeForeman_a59832df-8838-e23b-3106-bb65e599f7fa,(CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
NOT DB_CustomDialogRange((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,20);


//Dialog between Beldron and Lunkbug
QRY
QRY_SelectCustomDialog_AfterGenerics(S_UND_GnomeForeman_Trapped_42abeae0-3ccd-4b02-94d7-08175b343321,_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,(CHARACTER)S_UND_GnomeForeman_Trapped_42abeae0-3ccd-4b02-94d7-08175b343321)
AND
NOT DB_GlobalFlag(UND_GnomeWorkers_State_Left_25c2b06a-4101-4ea6-bcc0-273ca5aeb86a)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
QRY_OnlyOnce("UND_GnomeForemanAndSilly_JointDialogOnce")
THEN
DB_SelectedDialog((DIALOGRESOURCE)UND_GnomeForeman_a59832df-8838-e23b-3106-bb65e599f7fa,(CHARACTER)S_UND_GnomeForeman_Trapped_42abeae0-3ccd-4b02-94d7-08175b343321,_Player,(CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e);

//Dialog between Beldron and Lunkbug
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,(CHARACTER)S_UND_GnomeForeman_Trapped_42abeae0-3ccd-4b02-94d7-08175b343321)
AND
NOT DB_GlobalFlag(UND_GnomeWorkers_State_Left_25c2b06a-4101-4ea6-bcc0-273ca5aeb86a)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
QRY_OnlyOnce("UND_GnomeForemanAndSilly_JointDialogOnce")
THEN
DB_SelectedDialog((DIALOGRESOURCE)UND_GnomeForeman_a59832df-8838-e23b-3106-bb65e599f7fa,(CHARACTER)S_UND_GnomeForeman_Trapped_42abeae0-3ccd-4b02-94d7-08175b343321,_Player,(CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e);

//Dialog between Lunkbug and Laridda
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,(CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d)
AND
NOT DB_Defeated((CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d)
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
THEN
DB_SelectedDialog((DIALOGRESOURCE)UND_ArguingGnomes_9c452899-9ae3-08e5-2034-d1b1d6dcfde5,(CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,(CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,_Player);
DB_OnlyOnce("UND_ArguingGnomes_Daffy_JointDialogOnce");

//Dialog between Lunkbug and Laridda, trigger it only once, for the first time, for Larrida
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,(CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d)
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
QRY_OnlyOnce("UND_ArguingGnomes_Daffy_JointDialogOnce")
THEN
DB_SelectedDialog((DIALOGRESOURCE)UND_ArguingGnomes_9c452899-9ae3-08e5-2034-d1b1d6dcfde5,(CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,(CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,_Player);

IF
FlagSet(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd,_,_)
AND
DB_DialogNPCs(_ID, S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e, _)
AND
NOT DB_AutomatedDialog(_ID)
THEN
DialogRequestStop(S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e);

//Reseting dialogs for gnomes to individual ones, Setting dialogs for the trapped characters
IF
FlagSet(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd,_,_)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e);
DB_Dialogs(S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,UND_GnomeWorkerSilly_04c2bc70-2dac-a170-85dc-d7eb36bdd047);
PROC_RemoveDialog((CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d);
DB_Dialogs(S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,UND_GnomeWorkerDaffy_fae83730-13d3-892a-91b5-0dbaef3d92e7);
DB_Dialogs(S_UND_GnomeForeman_42abeae0-3ccd-4b02-94d7-08175b343321,UND_GnomeForeman_a59832df-8838-e23b-3106-bb65e599f7fa);
DB_Dialogs(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,UND_TheDrowNere_FollowUp_6b0c0d3d-91b3-84af-3704-8edad589d983);

//END_REGION

//REGION Killing the gnomes
PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("UND_PermaDefeatedDebrisCleaners")
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
DB_GlobalFlag(UND_DebrisCleaners_State_PermaDefeated_c74816bf-a62c-49b7-80a8-4e0f95020f91)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);

//END_REGION Killing the gnomes

//REGION Cave In
IF
ItemEnteredTrigger(_Item,S_UND_DuergarCamp_ExplosionDetection_Trigger_18f27e06-8e2d-4df2-bde2-c6bd66f435cb,_Player)
AND
Exists(_Item,1)
AND
IsTagged(_Item,EXPLOSIVES_f6e89388-0e91-4e9d-b5b7-1d4938dda540,1)
AND
DB_Players((CHARACTER)_Player)
THEN
DB_UND_DuergarCamp_Explosives(_Item);
SetFlag((FLAG)UND_DuergarCamp_State_ExplosivesAtCaveIn_41633d28-12de-4fad-989f-863f411132c4,NULL_00000000-0000-0000-0000-000000000000);
SetTag(_Item,(TAG)IGNOREVANDALISE_7e9915ff-d7a4-4e52-9ac3-806075102ccc);

IF
FlagSet((FLAG)UND_DuergarCamp_State_ExplosivesAtCaveIn_41633d28-12de-4fad-989f-863f411132c4,_,_)
AND
QRY_OnlyOnce("UND_DebrisCleaner_PlayBarrelsAD")
THEN
PROC_TryStartAD((DIALOGRESOURCE)UND_GnomeWorkerDaffy_AD_BarrelPlaced_81984ecf-af8c-f2a3-3ed1-ba484d91c04e, (CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d);

IF
AutomatedDialogEnded(UND_GnomeWorkerDaffy_AD_BarrelPlaced_81984ecf-af8c-f2a3-3ed1-ba484d91c04e,_)
THEN
PROC_TryStartAD((DIALOGRESOURCE)UND_DuergarGuardWry_AD_7dfabc13-1474-ea35-aa86-4ef6a4836dfc,(CHARACTER)S_UND_DuergarGuardWry_dd93e23c-c62d-4927-9ea7-50e11621825e);

IF
ItemLeftTrigger(_Item,S_UND_DuergarCamp_ExplosionDetection_Trigger_18f27e06-8e2d-4df2-bde2-c6bd66f435cb,_)
AND
DB_UND_DuergarCamp_Explosives(_Item)
AND
Exists(_Item,1)
THEN
ClearTag(_Item,(TAG)IGNOREVANDALISE_7e9915ff-d7a4-4e52-9ac3-806075102ccc);

IF
ItemLeftTrigger(_Item,S_UND_DuergarCamp_ExplosionDetection_Trigger_18f27e06-8e2d-4df2-bde2-c6bd66f435cb,_)
AND
DB_UND_DuergarCamp_Explosives(_Item)
THEN
NOT DB_UND_DuergarCamp_Explosives(_Item);
PROC_UND_DuergarCamp_CheckLastExplosives();

IF
DestroyedBy(_Item,_,_,_)
AND
DB_UND_DuergarCamp_Explosives(_Item)
THEN
ClearTag(_Item,(TAG)IGNOREVANDALISE_7e9915ff-d7a4-4e52-9ac3-806075102ccc);
NOT DB_UND_DuergarCamp_Explosives(_Item);
PROC_UND_DuergarCamp_CheckLastExplosives();

PROC
PROC_UND_DuergarCamp_CheckLastExplosives()
AND
QRY_IsEmptyDB("DB_UND_DuergarCamp_Explosives",1)
THEN
ClearFlag((FLAG)UND_DuergarCamp_State_ExplosivesAtCaveIn_41633d28-12de-4fad-989f-863f411132c4,NULL_00000000-0000-0000-0000-000000000000);

IF
DestroyedBy(S_UND_DuergarCamp_CaveIn_0c5b70d8-112a-4380-99c6-68e299d720b0,_,_,_)
THEN
QuestUpdate("UND_CaveIn","Smokepowder_CaveInCleared"); //closing the subs before the main quest gets closed
QuestUpdate("UND_CaveIn","Eye_CaveInCleared");
SetFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd,NULL_00000000-0000-0000-0000-000000000000,0);
TriggerUnregisterForItems(S_UND_DuergarCamp_ExplosionDetectionTrigger_18f27e06-8e2d-4df2-bde2-c6bd66f435cb);
Open(S_UND_NeresRoom_InvisibleDoor_0fe4cf3f-33ab-48de-a3c0-2bf1dae7368e);

IF
DestroyedBy(S_UND_DuergarCamp_CaveIn_0c5b70d8-112a-4380-99c6-68e299d720b0,_,_,_)
AND
NOT DB_GlobalFlag(UND_TheDrowNere_State_DiedDeserted_d9349fbe-a9bd-45f1-8c9e-8f97cf648841)
THEN
QuestUpdate("UND_CaveIn","CaveInCleared");
QuestUpdate("UND_GnomeRescue","ClearedRubble");

IF
DestroyedBy(S_UND_DuergarCamp_CaveIn_0c5b70d8-112a-4380-99c6-68e299d720b0,_,_,_)
AND
NOT DB_GlobalFlag(UND_TheDrowNere_State_DiedDeserted_d9349fbe-a9bd-45f1-8c9e-8f97cf648841)
AND
NOT DB_GlobalFlag(UND_DuergarGuards_Excavation_State_PermaDefeated_3f30c825-10f1-4fa5-84b8-073f293e6650)
THEN
DB_DangerZone(S_UND_DuergarCamp_SUB_05c3bf1f-29a6-437c-9a98-c1ff0ec53a53,"UND_NereConfrontation");

IF
FlagSet(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd,_,_)
AND
DB_GlobalFlag((FLAG)UND_ScryingEye_PermaDefeated_dc0f5dbb-36df-46c1-af81-6428a8733e9a)
THEN
PROC_GlobalSetFlagAndCache(UND_ScryingEye_DiedBeforeCaveIn_b48f4d8c-374b-44e4-879c-73a5a7e7a2ea);

IF
FlagSet(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd,_,_)
AND
DB_UND_DuergarGuards_Excavation(_ExcavationDuergar,_CaveInTrigger)
AND
NOT DB_CantMove(_ExcavationDuergar)
AND
NOT QRY_IsInRange(_ExcavationDuergar,_CaveInTrigger,10.0)
THEN
PROC_CharacterMoveTo(_ExcavationDuergar,_CaveInTrigger,"Run","ReachedConfrontation");

//END_REGION

//REGION True Soul Nere
IF
UseStarted(_Player,S_UND_DuergarCamp_CaveIn_0c5b70d8-112a-4380-99c6-68e299d720b0)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)UND_TheDrowNere_Mindmeld_7c77bbf6-fe5d-f1dd-8666-7da1f1fca029,(CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,(CHARACTER)_Player)
THEN
QuestUpdate(_Player,"UND_CaveIn","TrueSoulAskedHelp");

IF
DestroyedBy(S_UND_DuergarCamp_CaveIn_0c5b70d8-112a-4380-99c6-68e299d720b0,_,_,_)
THEN
DB_SpotPlayers(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,"UND_Drow_Spot_Confrontation",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_TargetIgnoreCantTalk(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,"UND_Drow_Spot_Confrontation");
DB_SpotPlayers_IncludeWildshapedPlayers(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,"UND_Drow_Spot_Confrontation");
PROC_SetRelationMutual((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,(FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,100);
SetCombatGroupID(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,"00f902af-d72c-7dd6-0606-1c61aede2fa9");
PROC_UND_KethericCity_CaveIn_SetupScene();

PROC
PROC_UND_KethericCity_CaveIn_SetupScene()
AND
DB_UND_DuergarGuards_Excavation(_Duergar,_)
THEN
DB_SceneManager(_Duergar,"PROC_UND_KethericCity_Mutiny_Scene");

PROC
PROC_UND_KethericCity_CaveIn_SetupScene()
AND
DB_UND_GnomeWorkers(_Gnome,_,_,_,_)
THEN
DB_SceneManager(_Gnome,"PROC_UND_KethericCity_Mutiny_Scene");

PROC
PROC_UND_KethericCity_CaveIn_SetupScene()
THEN
DB_SceneManager((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,"PROC_UND_KethericCity_Mutiny_Scene");
DB_SceneAllowAllDisturbances("PROC_UND_KethericCity_Mutiny_Scene");

IF
DestroyedBy(S_UND_DuergarCamp_CaveIn_0c5b70d8-112a-4380-99c6-68e299d720b0,_,_,_)
AND
NOT QRY_UND_DuergarCamp_CaveInDestroyedAD((DIALOGRESOURCE)UND_GnomeWorkerSilly_AD_CaveInDestroyed_eb766758-35da-1341-8382-6e23a9c9006f, (CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e)
AND
NOT QRY_UND_DuergarCamp_CaveInDestroyedAD((DIALOGRESOURCE)UND_DuergarRebelGreedy_AD_CaveInDestroyed_aee242be-2d3a-ef64-adba-a06a394f445f, (CHARACTER)S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3)
AND
NOT QRY_UND_DuergarCamp_CaveInDestroyedAD((DIALOGRESOURCE)UND_DuergarLoyalSergeant_AD_CaveInDestroyed_cdcb2c73-27d7-f0f4-f3f7-7d560dcea671, (CHARACTER)S_UND_DuergarLoyalSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5)
THEN
DB_NOOP(1);

QRY
QRY_UND_DuergarCamp_CaveInDestroyedAD((DIALOGRESOURCE)_Dialog, (CHARACTER)_Speaker)
AND
_Speaker != S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3
AND
GetDistanceTo(S_UND_DuergarCamp_ExplosionDetectionTrigger_18f27e06-8e2d-4df2-bde2-c6bd66f435cb, _Speaker, _Distance)
AND
_Distance < 22.0
AND
QRY_StartDialog(_Dialog, _Speaker)
THEN
DB_NOOP(1);

QRY
QRY_UND_DuergarCamp_CaveInDestroyedAD((DIALOGRESOURCE)_Dialog, (CHARACTER)S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3)
AND
DB_GlobalFlag((FLAG)UND_Mutineers_Quest_Accepted_d37a860e-a0ea-9d9a-7dc0-d73a66f8663e)
AND
DB_GlobalFlag((FLAG)UND_ScryingEye_State_PermaDefeated_dc0f5dbb-36df-46c1-af81-6428a8733e9a)
AND
GetDistanceTo(S_UND_DuergarCamp_ExplosionDetectionTrigger_18f27e06-8e2d-4df2-bde2-c6bd66f435cb, (CHARACTER)S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3, _Distance)
AND
_Distance < 22.0
AND
QRY_StartDialog(_Dialog, (CHARACTER)S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3)
THEN
DB_NOOP(1);

PROC
PROC_SpotPlayers_Spotted(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,"UND_Drow_Spot_Confrontation",_Player)
AND
QRY_GetClosestAvailableCharacterTo(_Player,0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar,_Player,_Dist,_)
AND
_Dist < 30.0
THEN
PROC_RemoveMutingStatusses(_ClosestAvatar);
DB_UND_DuergarCamp_Confrontation_Spotted(1);
PROC_UND_DuergarCamp_Confrontation_CheckAlive((CHARACTER)_ClosestAvatar);

QRY
QRY_SelectCustomDialog(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,(CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_BattleStarted_ff6b8579-5926-4406-a983-b9843f875159)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedDrow_9c15716b-2e73-3bde-7e1c-8580aa4b1850)
THEN
PROC_UND_DuergarCamp_Confrontation_CheckAlive(_Player);

QRY
QRY_SelectCustomDialog(S_UND_DuergarLoyalSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,(CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_BattleStarted_ff6b8579-5926-4406-a983-b9843f875159)
THEN
PROC_UND_DuergarCamp_Confrontation_CheckAlive(_Player);

PROC
PROC_UND_DuergarCamp_Confrontation_CheckAlive((CHARACTER)_Player)
AND
NOT DB_PermaDefeated(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5)
AND
NOT DB_PermaDefeated((CHARACTER)S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3)
THEN
PROC_UND_DuergarCamp_Confrontation_SetSpeakers(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3,_Player);

PROC
PROC_UND_DuergarCamp_Confrontation_CheckAlive((CHARACTER)_Player)
AND
DB_PermaDefeated(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5)
AND
DB_PermaDefeated(S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3)
THEN
PROC_UND_DuergarCamp_Confrontation_SetSpeakers(NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,_Player);

PROC
PROC_UND_DuergarCamp_Confrontation_CheckAlive((CHARACTER)_Player)
AND
NOT DB_PermaDefeated(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5)
AND
DB_PermaDefeated(S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3)
THEN
PROC_UND_DuergarCamp_Confrontation_SetSpeakers(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,NULL_00000000-0000-0000-0000-000000000000,_Player);

PROC
PROC_UND_DuergarCamp_Confrontation_CheckAlive((CHARACTER)_Player)
AND
DB_PermaDefeated(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5)
AND
NOT DB_PermaDefeated(S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3)
THEN
PROC_UND_DuergarCamp_Confrontation_SetSpeakers(NULL_00000000-0000-0000-0000-000000000000,S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3,_Player);

PROC
PROC_UND_DuergarCamp_Confrontation_SetSpeakers((CHARACTER)_Sergeant,(CHARACTER)_MutineerLeader,(CHARACTER)_Player)
AND
DB_UND_DuergarCamp_Confrontation_Spotted(1)
AND
QRY_StartDialog((DIALOGRESOURCE)UND_TheDrowNere_Mutiny_27bbde20-f6d3-5c4c-c7ac-0c7345b29a9a,S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_Sergeant,_MutineerLeader,_Player)
THEN
NOT DB_UND_DuergarCamp_Confrontation_Spotted(1);

PROC
PROC_UND_DuergarCamp_Confrontation_SetSpeakers((CHARACTER)_Sergeant,(CHARACTER)_MutineerLeader,(CHARACTER)_Player)
AND
NOT DB_UND_DuergarCamp_Confrontation_Spotted(_)
THEN
DB_SelectedDialog((DIALOGRESOURCE)UND_TheDrowNere_Mutiny_27bbde20-f6d3-5c4c-c7ac-0c7345b29a9a,S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_Sergeant,_MutineerLeader,_Player);

IF
FlagSet(UND_TheDrowNere_State_KilledGnomeSerene_4842989d-23d1-c137-560b-f0ad880a9576,_,_)
THEN
PROC_SceneManager_RemoveFromScene(S_UND_GnomeWorkerSerene_Trapped_0203c8b5-2a34-4bf2-b729-f0f240f26a4f, "PROC_UND_KethericCity_Mutiny_Scene");
Die(S_UND_GnomeWorkerSerene_Trapped_0203c8b5-2a34-4bf2-b729-f0f240f26a4f,DEATHTYPE.Incinerate,1);
SetOnStage(S_UND_GnomeWorkerSerene_Trapped_0203c8b5-2a34-4bf2-b729-f0f240f26a4f,0);

IF
FlagSet(UND_TheDrowNere_State_KilledSergeant_46d5a2aa-186a-5f0a-f9f8-7c0048baaa86,_,_Id)
AND
DialogRemoveActorFromDialog(_Id,S_UND_DuergarLoyalSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,1)
THEN
PROC_SceneManager_RemoveFromScene(S_UND_DuergarLoyalSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,"PROC_UND_KethericCity_Mutiny_Scene");
Die(S_UND_DuergarLoyalSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,DEATHTYPE.Falling,1);

PROC
PROC_SceneInterrupted(_,_Player,"PROC_UND_KethericCity_Mutiny_Scene", _Interruption)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Interruption)
THEN
PROC_GlobalSetFlagAndCache((FLAG)UND_DuergarCamp_State_SidedNone_c17245d9-ecb7-4562-a9fe-74a6759ff47b);
PROC_SceneOver("PROC_UND_KethericCity_Mutiny_Scene");

PROC
PROC_SceneInterrupted(_,_Player,"PROC_UND_KethericCity_Mutiny_Scene","DisturbanceRegistering")
AND
DB_SceneManager_DisturbanceRegistering(_Player,_CrimeType,_,_,_Victim,_CrimeID)
AND
QRY_UND_KethericCityMutinyScene_CheckCrimeType(_CrimeType,_Victim)
THEN
DB_SceneManager_BlockDisturbance(_CrimeID);
PROC_GlobalSetFlagAndCache((FLAG)UND_DuergarCamp_State_SidedNone_c17245d9-ecb7-4562-a9fe-74a6759ff47b);
PROC_SceneOver("PROC_UND_KethericCity_Mutiny_Scene");

QRY
QRY_UND_KethericCityMutinyScene_CheckCrimeType((STRING)_CrimeType,(CHARACTER)_Victim)
AND
QRY_CRIME_IsCrimeFamilyMember(_CrimeType,"AssaultRelated")
THEN
DB_UND_KethericCityMutinyScene_InterruptedCrimeVictim(_Victim);

QRY
QRY_UND_KethericCityMutinyScene_CheckCrimeType((STRING)_CrimeType,(CHARACTER)_Victim)
AND
QRY_CRIME_IsCrimeFamilyMember(_CrimeType,"Murder")
THEN
DB_UND_KethericCityMutinyScene_InterruptedCrimeVictim(_Victim);

QRY
QRY_UND_KethericCityMutinyScene_CheckCrimeType((STRING)_CrimeType,(CHARACTER)_Victim)
AND
QRY_CRIME_IsCrimeFamilyMember(_CrimeType,"Assault")
THEN
DB_UND_KethericCityMutinyScene_InterruptedCrimeVictim(_Victim);

IF
DB_UND_KethericCityMutinyScene_InterruptedCrimeVictim(_Victim)
AND
DB_UND_GnomeWorkers(_Victim,_,_,_,_)
THEN
PROC_GlobalSetFlagAndCache((FLAG)UND_DuergarCamp_State_GnomesHostile_53aab2ec-c119-b4ed-c3b2-7181e4ecbaf7);

IF
DialogEnded((DIALOGRESOURCE)UND_TheDrowNere_Mutiny_27bbde20-f6d3-5c4c-c7ac-0c7345b29a9a,_) //Dialog ended earlier without a choice but wasnt interrupted
AND
NOT QRY_UND_DuergarCamp_AnyMutinySidePicked()
THEN
PROC_GlobalSetFlagAndCache((FLAG)UND_DuergarCamp_State_SidedNone_c17245d9-ecb7-4562-a9fe-74a6759ff47b);

IF
DialogEnded((DIALOGRESOURCE)UND_TheDrowNere_Mutiny_27bbde20-f6d3-5c4c-c7ac-0c7345b29a9a,_) //Default flow without any interrupts
THEN
PROC_SceneOver("PROC_UND_KethericCity_Mutiny_Scene");

QRY
QRY_UND_DuergarCamp_AnyMutinySidePicked()
AND
DB_UND_KethericCity_MutinySides(_MutinyStateFlag)
AND
GetFlag(_MutinyStateFlag, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
DB_NOOP(1);

PROC
PROC_SceneOver("PROC_UND_KethericCity_Mutiny_Scene")
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_GnomesHostile_53aab2ec-c119-b4ed-c3b2-7181e4ecbaf7)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,100);
PROC_SetRelationMutual((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,(FACTION)ACT1_UND_GnomeWorkers_196ce147-a664-9984-8526-66471d417c44,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_GnomeWorkers_196ce147-a664-9984-8526-66471d417c44,0);

PROC
PROC_SceneOver("PROC_UND_KethericCity_Mutiny_Scene")
AND
QRY_UND_DuergarCamp_CheckPlayerSide()
THEN
SetFlag((FLAG)UND_DuergarCamp_State_BattleStarted_ff6b8579-5926-4406-a983-b9843f875159,NULL_00000000-0000-0000-0000-000000000000,0);
SetFlag(UND_TheDrowNere_State_KilledGnomeSerene_4842989d-23d1-c137-560b-f0ad880a9576,NULL_00000000-0000-0000-0000-000000000000,0);
PROC_SpotPlayers_StopSpotting(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,"UND_Drow_Spot_Confrontation");
PROC_ForceStopDialog((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);

QRY
QRY_UND_DuergarCamp_CheckPlayerSide()
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedLoyal_74c05609-77b6-4f62-b9e0-9bcb24908d4b)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,(FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,100);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,100);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);

QRY
QRY_UND_DuergarCamp_CheckPlayerSide()
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedMutineers_581443f0-b4bd-d3c2-7122-a4d2aa7fb5f9)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,(FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);
PROC_SetRelationMutual((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,(FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,0);

QRY
QRY_UND_DuergarCamp_CheckPlayerSide()
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedDrow_9c15716b-2e73-3bde-7e1c-8580aa4b1850)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,(FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,0);
PROC_SetRelationMutual((FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,(FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,100);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);

QRY
QRY_UND_DuergarCamp_CheckPlayerSide()
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedNone_c17245d9-ecb7-4562-a9fe-74a6759ff47b)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,(FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,100);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);
//END_REGION

//REGION True Soul Nere Combat
IF
EnteredCombat(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_CombatID)
AND
DB_GlobalFlag(UND_DuergarCamp_State_BattleStarted_ff6b8579-5926-4406-a983-b9843f875159)
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
THEN
DB_DuergarCamp_MutinyBattle_CombatID(_CombatID);

IF
SwitchedCombat(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_CombatID,_NewCombatID)
AND
DB_DuergarCamp_MutinyBattle_CombatID(_CombatID)
THEN
NOT DB_DuergarCamp_MutinyBattle_CombatID(_CombatID);
DB_DuergarCamp_MutinyBattle_CombatID(_NewCombatID);

IF
CombatEnded(_CombatID)
AND
DB_DuergarCamp_MutinyBattle_CombatID(_CombatID)
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
THEN
NOT DB_DuergarCamp_MutinyBattle_CombatID(_CombatID);
PROC_GlobalSetFlagAndCache(UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582);
PROC_DangerZone_Safe("UND_NereConfrontation");
PROC_UND_DuergarCamp_BattleEnded();

IF
EnteredCombat(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_)
THEN
TriggerRegisterForCharacter(S_UND_KC_Nere_Destination_AiHint_01_05ef594d-9983-47f6-88f7-b43e0dac4b41, S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);
SetAiHint(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, AI_HINT_UNIQUE_1902723d-dd16-4e7a-87d6-7b07f63add79);
PROC_SetOnStage(S_UND_KC_Nere_Destination_Helper_01_425e741a-f3a4-4f71-ab25-3a3c75fefdf5,1);

IF
EnteredTrigger(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,S_UND_KC_Nere_Destination_AiHint_01_05ef594d-9983-47f6-88f7-b43e0dac4b41)
THEN
SetAiHint(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,NULL_00000000-0000-0000-0000-000000000000);
TriggerUnregisterForCharacter(S_UND_KC_Nere_Destination_AiHint_01_05ef594d-9983-47f6-88f7-b43e0dac4b41, S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);
PROC_SetOnStage(S_UND_KC_Nere_Destination_Helper_01_425e741a-f3a4-4f71-ab25-3a3c75fefdf5,0);

IF
TurnStarted(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30) // in case he is a spore Servant
AND
GetHitpointsPercentage(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_Hp)
AND
_Hp < 70.0
AND
QRY_OnlyOnce("UND_KC_Nere_Combat_Phase2")
THEN
RequestSetBaseArchetype(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,"melee");
ClearTag(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
SetTag(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd);
PROC_TryStartAD((DIALOGRESOURCE)UND_Nere_Combat_02c28157-6201-374b-727f-65369a5fe5e1,S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);

IF
DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
DB_GlobalFlag((FLAG)UND_DuergarGuards_Excavation_State_PermaDefeated_3f30c825-10f1-4fa5-84b8-073f293e6650)
THEN
PROC_DangerZone_Safe("UND_NereConfrontation");
//END_REGION

//REGION Sergeant and get her boots back
IF
DialogEnded(UND_DuergarLoyalSergeant_7b319090-fe6f-d6bd-dcc9-5ebada7f369a,_ID)
AND
IsInInventoryOf(S_UND_MyconidCircle_BootsOfSpeed_fca76ec8-f3dd-446c-bd69-dc2f6ccca285,(CHARACTER)S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,1)
AND
IsEquipped(S_UND_MyconidCircle_BootsOfSpeed_fca76ec8-f3dd-446c-bd69-dc2f6ccca285,0)
AND
QRY_OnlyOnce("UND_DuergarLoyalSergeant_EquipBoots")
THEN
Equip(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,S_UND_MyconidCircle_BootsOfSpeed_fca76ec8-f3dd-446c-bd69-dc2f6ccca285);
Transform(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5, Dwarves_Female_Duergar_Sergeant_Thrinn_With_Boots_6201f05e-c59b-4e4c-9a56-e04ca95dfbac, DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);
//END_REGION

//REGION Nere post combat
QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_SidedLoyal_74c05609-77b6-4f62-b9e0-9bcb24908d4b)
THEN
DB_NOOP(1);

PROC
PROC_GlobalFlagReactionAfterDialog(UND_DuergarCamp_State_SidedDrow_9c15716b-2e73-3bde-7e1c-8580aa4b1850)
THEN
PROC_UND_DuergarCamp_PostCombat_SetupSpotting((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);

PROC
PROC_UND_DuergarCamp_BattleEnded()
AND
DB_GlobalFlag(UND_DuergarCamp_State_SidedLoyal_74c05609-77b6-4f62-b9e0-9bcb24908d4b)
THEN
PROC_UND_DuergarCamp_PostCombat_CheckNerePermaDefeated();

PROC
PROC_UND_DuergarCamp_PostCombat_CheckNerePermaDefeated()
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
THEN
PROC_UND_DuergarCamp_PostCombat_SetupSpotting((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);

PROC
PROC_UND_DuergarCamp_PostCombat_CheckNerePermaDefeated()
AND
DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
NOT DB_PermaDefeated((CHARACTER)S_UND_DuergarLoyalSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5)
THEN
PROC_UND_DuergarCamp_PostCombat_SetupSpotting((CHARACTER)S_UND_DuergarLoyalSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5);

PROC
PROC_UND_DuergarCamp_PostCombat_CheckNerePermaDefeated()
AND
DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
DB_PermaDefeated((CHARACTER)S_UND_DuergarLoyalSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5)
THEN
PROC_UND_DuergarCamp_PostCombat_SetupSpotting((CHARACTER)S_UND_DuergarLoyalFallback_0160d049-e0b2-473b-a5c2-ff8b13719d84);
PROC_AppearOutOfSightTo(S_UND_DuergarLoyalFallback_0160d049-e0b2-473b-a5c2-ff8b13719d84,S_UND_DuergarGuardSergeant_AtDrowTrigger_e6186dc7-71f0-4bff-a5b4-190dbd4d3f7f,S_UND_DuergarGuardSergeant_HomeTrigger_14856ff0-65bb-48bb-bc34-67fb255c7b02,"UND_DuergarLoyalFallback_Appeared");

IF
EntityEvent(S_UND_DuergarLoyalFallback_0160d049-e0b2-473b-a5c2-ff8b13719d84,"UND_DuergarLoyalFallback_Appeared")
THEN
PROC_CharacterMoveTo(S_UND_DuergarLoyalFallback_0160d049-e0b2-473b-a5c2-ff8b13719d84,S_UND_DuergarGuardSergeant_AtDrowTrigger_e6186dc7-71f0-4bff-a5b4-190dbd4d3f7f,"Run","");

PROC
PROC_UND_DuergarCamp_PostCombat_SetupSpotting((CHARACTER)_Spotter)
THEN
DB_SpotPlayers(_Spotter,"UND_Drow_Spot_PostCombat",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_TargetIgnoreCantTalk(_Spotter,"UND_Drow_Spot_PostCombat");
DB_SpotPlayers_IncludeWildshapedPlayers(_Spotter,"UND_Drow_Spot_PostCombat");

PROC
PROC_SpotPlayers_Spotted(_Speaker,"UND_Drow_Spot_PostCombat",_Player)
AND
DB_UND_DuergarCamp_NerePostCombat_FollowUpSpeakers(_Speaker,_Dialog)
AND
QRY_GetClosestAvailableCharacterTo(_Player,0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar,_Player,_Dist,_)
AND
_Dist < 30.0
AND
QRY_StartDialog(_Dialog,_Speaker,_ClosestAvatar)
THEN
PurgeOsirisQueue(_Speaker,0);

PROC
PROC_DialogFlagSetup(_Dialog,_ClosestAvatar)
AND
DB_UND_DuergarCamp_NerePostCombat_FollowUpSpeakers(_,_Dialog)
THEN
PROC_RemoveMutingStatusses(_ClosestAvatar);
PROC_DangerZone_Safe("UND_NereConfrontation");

IF
DialogEnded((DIALOGRESOURCE)UND_DuergarCamp_LoyalFollowUp_13a8c8cf-d624-af41-4517-a89ae6ab4ba2,_ID)
THEN
PROC_DisappearOutOfSightTo(S_UND_DuergarLoyalFallback_0160d049-e0b2-473b-a5c2-ff8b13719d84,S_UND_DuergarGuardSergeant_HomeTrigger_14856ff0-65bb-48bb-bc34-67fb255c7b02,"Run",1,"");

IF
DialogEnded(UND_TheDrowNere_FollowUp_6b0c0d3d-91b3-84af-3704-8edad589d983,_ID)
AND
DB_GlobalFlag((FLAG)UND_TheDrowNere_Event_Leave_d12183d4-3907-4325-8913-988bb88e4377)
THEN
PROC_RemoveDialog((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);
DB_Dialogs(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,UND_TheDrowNere_376f1186-b9fe-f08f-25c2-3eee5be9d0f3);

IF
FlagSet(UND_TheDrowNere_State_GnomesExecuted_7f3f882c-40fb-430e-8df6-c1d6e450aebd,_,_Id)
AND
DialogRemoveActorFromDialog(_Id,S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e,1)
THEN
DB_NOOP(1);

IF
FlagSet(UND_TheDrowNere_State_GnomesExecuted_7f3f882c-40fb-430e-8df6-c1d6e450aebd,_,_)
AND
DB_UND_GnomeWorkers(_Gnome,_,_,_,_)
THEN
PROC_SceneManager_RemoveFromScene(_Gnome, "PROC_UND_KethericCity_Mutiny_Scene");
Die(_Gnome,DEATHTYPE.Physical,1);

//END_REGION

//REGION Mutineers post combat
PROC
PROC_UND_DuergarCamp_BattleEnded()
AND
DB_GlobalFlag(UND_DuergarCamp_State_SidedMutineers_581443f0-b4bd-d3c2-7122-a4d2aa7fb5f9)
AND
QRY_OnlyOnce("UND_Mutineer_Spot_PostNereCombat_OnlyOnce")
THEN
PROC_UND_DuergarCamp_Mutineers_PostNereCombat_CheckPermaDefeated();

PROC
PROC_UND_DuergarCamp_Mutineers_PostNereCombat_CheckPermaDefeated()
AND
NOT DB_PermaDefeated((CHARACTER)S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3)
THEN
PROC_UND_DuergarCamp_Mutineers_PostNereCombatSpotting(S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3);

PROC
PROC_UND_DuergarCamp_Mutineers_PostNereCombat_CheckPermaDefeated()
AND
DB_PermaDefeated((CHARACTER)S_UND_DuergarRebelGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3)
THEN
PROC_UND_DuergarCamp_Mutineers_PostNereCombatSpotting((CHARACTER)S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2);
PROC_AppearOutOfSightTo(S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,S_UND_DuergarGuardSergeant_AtDrowTrigger_e6186dc7-71f0-4bff-a5b4-190dbd4d3f7f,S_UND_DuergarGuardSergeant_HomeTrigger_14856ff0-65bb-48bb-bc34-67fb255c7b02,"UND_DuergarRebelFrantic_Appeared");

IF
EntityEvent(S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,"UND_DuergarRebelFrantic_Appeared")
THEN
PROC_CharacterMoveTo(S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,S_UND_DuergarGuardSergeant_AtDrowTrigger_e6186dc7-71f0-4bff-a5b4-190dbd4d3f7f,"Run","");

PROC
PROC_UND_DuergarCamp_Mutineers_PostNereCombatSpotting((CHARACTER)_Spotter)
AND
GetGold(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, _GoldAmount)
AND
_GoldAmount > 0
AND
IntegerProduct(-1, _GoldAmount, _AntiGoldAmount)
THEN
AddGold(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, _AntiGoldAmount);
AddGold(_Spotter, _GoldAmount);

PROC
PROC_UND_DuergarCamp_Mutineers_PostNereCombatSpotting((CHARACTER)_Spotter)
THEN
DB_SpotPlayers(_Spotter,"UND_Mutineer_Spot_PostNereCombat",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_UND_DuergarCamp_Mutineers_PostNereCombatSpotting((CHARACTER)_Spotter)
AND
DB_GlobalFlag(UND_ScryingEye_DiedBeforeCaveIn_b48f4d8c-374b-44e4-879c-73a5a7e7a2ea)
AND
DB_UND_DuergarCamp_Mutineers_FollowUpSpeakers(_Spotter,_FollowUpDialog,_)
THEN
DB_UND_PostMutinyRebelLeaderDialog(_Spotter,_FollowUpDialog);

PROC
PROC_UND_DuergarCamp_Mutineers_PostNereCombatSpotting((CHARACTER)_Spotter)
AND
NOT DB_GlobalFlag(UND_ScryingEye_DiedBeforeCaveIn_b48f4d8c-374b-44e4-879c-73a5a7e7a2ea)
AND
DB_UND_DuergarCamp_Mutineers_FollowUpSpeakers(_Spotter,_,_ExtortDialog)
THEN
DB_UND_PostMutinyRebelLeaderDialog(_Spotter,_ExtortDialog);

IF
DB_UND_PostMutinyRebelLeaderDialog(S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,_Dialog)
THEN
DB_Dialogs(S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,_Dialog);

PROC
PROC_SpotPlayers_Spotted(_Spotter,"UND_Mutineer_Spot_PostNereCombat",_Player)
AND
QRY_GetClosestAvailableCharacterTo(_Player,0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar,_Player,_Dist,_)
AND
_Dist < 30.0
AND
DB_UND_PostMutinyRebelLeaderDialog(_Spotter,_Dialog)
AND
QRY_StartDialog(_Dialog,_Spotter,_ClosestAvatar)
THEN
PurgeOsirisQueue(_Spotter,0);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3, _Player)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedMutineers_581443f0-b4bd-d3c2-7122-a4d2aa7fb5f9)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarMutineers_Event_Leave_6c64d5fa-b59f-4a94-8d2f-6f5caf37fb34)
AND
DB_UND_PostMutinyRebelLeaderDialog(S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3,_PostMutinyDialog)
THEN
DB_SelectedDialog(_PostMutinyDialog,(CHARACTER)S_UND_DuergarGuardGreedy_379fd131-79ab-4588-a8f0-28cdb51546e3,_Player);

IF
FlagSet((FLAG)UND_DuergarMutineers_Event_Leave_6c64d5fa-b59f-4a94-8d2f-6f5caf37fb34,_,_DialogInst)
AND
DB_DialogNPCs(_DialogInst,S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,_)
THEN
PROC_NotifyWhenReadyToMoveOn(S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,"UND_DuergarRebelFrantic_Notify");

PROC
PROC_ReadyToMoveOn(S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,"UND_DuergarRebelFrantic_Notify")
THEN
PROC_DisappearOutOfSight(S_UND_DuergarRebelFrantic_93529dbc-a5b5-4e77-a0b7-bcb8204173b2,"Run",0,"");

IF
DialogEnded(_Dialog,_)
AND
DB_UND_PostMutinyRebelLeaderDialog(_Character,_Dialog)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarMutineers_Event_Leave_6c64d5fa-b59f-4a94-8d2f-6f5caf37fb34)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);
//END_REGION

//REGION Hostiles leave Post-Mutiny
PROC
PROC_UND_DuergarCamp_BattleEnded()
AND
DB_UND_DuergarGuards_City(_Duergar,_)
THEN
PROC_UND_DuergarCamp_CheckAndRemoveHostiles(_Duergar);

PROC
PROC_UND_DuergarCamp_BattleEnded()
AND
DB_UND_ElevatorNPCs(_Duergar)
THEN
PROC_UND_DuergarCamp_CheckAndRemoveHostiles(_Duergar);

PROC
PROC_UND_DuergarCamp_BattleEnded()
AND
DB_UND_DuergarSpiders(_Spider)
THEN
PROC_UND_DuergarCamp_CheckAndRemoveHostiles(_Spider);

// Fearful Rothe - only remove all three duergar at once! otherwise - wait until the long rest is over
PROC
PROC_UND_DuergarCamp_BattleEnded()
AND
NOT QRY_UND_DuergarCamp_GuardsCantDisappear()
THEN
PROC_UND_DuergarCamp_BattleEnded_RemoveFearfulRotheGuards();

PROC
PROC_UND_DuergarCamp_BattleEnded_RemoveFearfulRotheGuards()
AND
DB_UND_FearfulRothe_Guards(_Duergar)
THEN
PROC_DisappearOutOfSight(_Duergar, "Run", 1, "UND_DuergarCamp_HostileGone");

PROC
PROC_UND_DuergarCamp_BattleEnded_RemoveFearfulRotheGuards()
THEN
SetFlag(UND_FearfulRothe_State_GuardsArePermaDefeated_60c74db1-dd75-96b6-5c9e-fa1d9a83bf58, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_UND_DuergarCamp_GuardsCantDisappear()
AND
DB_UND_FearfulRothe_Guards(_Duergar)
AND
QRY_UND_DuergarCamp_CantDisappear(_Duergar)
THEN
DB_NOOP(1);

QRY
QRY_UND_DuergarCamp_CantDisappear((CHARACTER)_Character)
AND
DB_Is_InCombat(_Character,_)
THEN
DB_NOOP(1);

QRY
QRY_UND_DuergarCamp_CantDisappear((CHARACTER)_Character)
AND
DB_CantMove(_Character)
THEN
DB_NOOP(1);

QRY
QRY_UND_DuergarCamp_CantDisappear((CHARACTER)_Character)
AND
GetFaction(_Character, _Faction)
AND
GetRelation(_Faction, Hero_a1542c81-6895-929e-4522-10ce218bb360, _Relation)
AND
_Relation != 0
THEN
DB_NOOP(1);


PROC
PROC_UND_DuergarCamp_BattleEnded()
AND
DB_UND_DeadInTheWater_CorpseDisposers(_Duergar, _)
THEN
PROC_UND_DuergarCamp_CheckAndRemoveHostiles(_Duergar);

PROC
PROC_UND_DuergarCamp_CheckAndRemoveHostiles((CHARACTER)_Character)
AND
NOT DB_Is_InCombat(_Character,_)
AND
NOT DB_CantMove(_Character) // takes in account interactive dialogs, petrification, statuses etc
AND
GetFaction(_Character,_Faction)
AND
GetRelation(_Faction,Hero_a1542c81-6895-929e-4522-10ce218bb360,0)
THEN
PROC_DisappearOutOfSight(_Character,"Run",1,"UND_DuergarCamp_HostileGone");
//END_REGION

//REGION Nere leaves
IF
EntityEvent((CHARACTER)_Player,"UND_Grymforge_Empty")
AND
DB_GlobalFlag((FLAG)UND_TheDrowNere_Event_Leave_d12183d4-3907-4325-8913-988bb88e4377)
AND
QRY_OnlyOnce("UND_TheDrowNere_Event_LeaveCamp")
THEN
PROC_UND_TheDrowNere_Leave();

PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)UND_TheDrowNere_Event_Leave_d12183d4-3907-4325-8913-988bb88e4377)
AND
QRY_OnlyOnce("UND_TheDrowNere_Event_LeaveCamp")
THEN
DB_ExecuteInLevel("UND_TheDrowNere_Leave","WLD_Main_A");

PROC
PROC_ExecuteInLevel("UND_TheDrowNere_Leave","WLD_Main_A")
THEN
PROC_UND_TheDrowNere_Leave();

PROC
PROC_UND_TheDrowNere_Leave()
AND
DB_UND_DuergarCamp_Absolutists(_Loyal)
AND
NOT DB_PermaDefeated(_Loyal)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Loyal);
SetOnStage(_Loyal,0);

PROC
PROC_UND_TheDrowNere_Leave()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);
SetOnStage(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,0);
SetOnStage(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73,0);

PROC
PROC_UND_TheDrowNere_Leave()
AND
NOT DB_GlobalFlag(UND_TheDrowNere_State_LeftAbsolute_1bcd2c89-b50c-45f3-a1fb-c2a1ea3d77b9)
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
THEN
SetFlag((FLAG)UND_TheDrowNere_State_WentMT_e118cea2-da4d-4a4a-a761-0dd096699a43,NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION Mutineers Leave
IF
FlagSet((FLAG)UND_DuergarMutineers_Event_Leave_6c64d5fa-b59f-4a94-8d2f-6f5caf37fb34,_,_)
AND
DB_UND_DuergarCamp_Rebels(_Mutineer)
THEN
PROC_PeacefulResolve(_Mutineer);

IF
EntityEvent((CHARACTER)_Player,"UND_Grymforge_Empty")
AND
DB_GlobalFlag((FLAG)UND_DuergarMutineers_Event_Leave_6c64d5fa-b59f-4a94-8d2f-6f5caf37fb34)
AND
QRY_OnlyOnce("DuergarMutineers_Event_Leave")
THEN
PROC_UND_DuergarMutineers_Leave();
SetOnStage(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73,0);

PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)UND_DuergarMutineers_Event_Leave_6c64d5fa-b59f-4a94-8d2f-6f5caf37fb34)
AND
QRY_OnlyOnce("DuergarMutineers_Event_Leave")
THEN
DB_ExecuteInLevel("UND_DuergarMutineers_Leave","WLD_Main_A");

PROC
PROC_ExecuteInLevel("UND_DuergarMutineers_Leave","WLD_Main_A")
THEN
PROC_UND_DuergarMutineers_Leave();
SetOnStage(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73,0);

PROC
PROC_UND_DuergarMutineers_Leave()
AND
DB_UND_DuergarCamp_Rebels(_Rebel)
AND
NOT DB_PermaDefeated(_Rebel)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Rebel);
SetOnStage(_Rebel,0);

PROC
PROC_UND_DuergarMutineers_Leave()
AND
DB_UND_ElevatorGuards(_Rebel)
AND
NOT DB_PermaDefeated(_Rebel)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Rebel);
SetOnStage(_Rebel,0);

//END_REGION

//REGION Gnomes Leave
PROC
PROC_UND_DuergarCamp_BattleEnded()
AND
DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
DB_GlobalFlag((FLAG)UND_DuergarGuards_Excavation_State_PermaDefeated_3f30c825-10f1-4fa5-84b8-073f293e6650)
AND
DB_GlobalFlag((FLAG)UND_DuergarMutineers_State_PermaDefeated_b6a21d83-2b49-45c6-a89d-ddccddcf413a)
AND
NOT DB_GlobalFlag((FLAG)UND_GnomeWorkers_State_PermaDefeated_99fa547a-d3c9-46fe-b53f-7cceb510cd6f)
THEN
PROC_GlobalSetFlagAndCache((FLAG)UND_State_LeaderFreedGnomes_49acb531-d0c4-d3d1-6af4-c79e246e4327);

IF
EntityEvent(_Player,"UND_Grymforge_Empty")
AND
DB_GlobalFlag((FLAG)UND_State_LeaderFreedGnomes_49acb531-d0c4-d3d1-6af4-c79e246e4327)
AND
NOT DB_GlobalFlag((FLAG)UND_GnomeWorkers_Event_Leave_ad897c6f-87d5-4a30-88f0-41c92b965bc8)
THEN
PROC_UND_GnomeWorkers_Leave();

PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)UND_State_LeaderFreedGnomes_49acb531-d0c4-d3d1-6af4-c79e246e4327)
AND
NOT DB_GlobalFlag((FLAG)UND_GnomeWorkers_Event_Leave_ad897c6f-87d5-4a30-88f0-41c92b965bc8)
AND
NOT DB_GlobalFlag((FLAG)HAV_SavingPrisoners_State_WulbrenReturned_73a0c737-a7d1-9945-01d3-003fde6ed946)
THEN
PROC_UND_GnomeWorkers_Leave();

PROC
PROC_UND_GnomeWorkers_Leave()
THEN
PROC_GlobalSetFlagAndCache((FLAG)UND_GnomeWorkers_Event_Leave_ad897c6f-87d5-4a30-88f0-41c92b965bc8);
NOT DB_UND_GnomeWorkers(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,0,1); //Clear this DB right away for Barcus to be moved to HAV if necessary.
QuestUpdate("UND_GnomeRescue","Left_Freed");
DB_ExecuteInLevel("UND_GnomeWorkers_Leave","WLD_Main_A");

PROC
PROC_ExecuteInLevel("UND_GnomeWorkers_Leave","WLD_Main_A")
THEN
SetOnStage(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73,0);

// fill-in _Leaving() DB before sending each gnome to disappear
PROC
PROC_ExecuteInLevel("UND_GnomeWorkers_Leave","WLD_Main_A")
AND
DB_UND_GnomeWorkers(_Gnome,_,_,_,_)
AND
NOT DB_Defeated(_Gnome)
THEN
DB_UND_GnomeWorkers_Leaving(_Gnome);

PROC
PROC_ExecuteInLevel("UND_GnomeWorkers_Leave","WLD_Main_A")
AND
DB_UND_GnomeWorkers(_Gnome,_,_,_,_)
AND
NOT DB_Defeated(_Gnome)
THEN
PROC_ForceStopDialog(_Gnome);
SetHasDialog(_Gnome,0);
PROC_RemoveAllDialogEntriesForSpeaker(_Gnome);
SetOnStage(_Gnome, 0);

IF
DB_OffStage(_Gnome)
AND
DB_UND_GnomeWorkers_Leaving((CHARACTER)_Gnome)
THEN
NOT DB_UND_GnomeWorkers_Leaving((CHARACTER)_Gnome);
PROC_UND_GnomeWorkers_TryAppear();

IF
LeftTrigger(_PartyMember, S_UND_MyconidCircle_SUB_4b5cc8fc-88f4-465e-bf82-4c20b055c019)
AND
DB_PartyMembers(_PartyMember)
AND
DB_GlobalFlag(UND_GnomeWorkers_Event_Leave_ad897c6f-87d5-4a30-88f0-41c92b965bc8)
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_GnomeAtMyconids_f48d9c4e-e6eb-46dc-93a7-89326d11829b)
THEN
PROC_UND_GnomeWorkers_TryAppear();

PROC
PROC_UND_GnomeWorkers_TryAppear()
THEN
DB_ExecuteInLevel("UND_GnomeWorkers_TryAppear","WLD_Main_A");

PROC
PROC_ExecuteInLevel("UND_GnomeWorkers_TryAppear","WLD_Main_A")
AND
NOT DB_UND_GnomeWorkers_Leaving(_)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger(S_UND_MyconidCircle_SUB_4b5cc8fc-88f4-465e-bf82-4c20b055c019)
AND
QRY_OnlyOnce("UND_GnomeWorkers_AppearOutOfSightTo")
AND
DB_UND_GnomeWorkers(_Gnome,_SavedTrigger,_Dialog,1,_)
THEN
TeleportTo(_Gnome, _SavedTrigger, "UND_GnomeWorker_AppearedSaved");
SetOnStage(_Gnome, 1);
DB_Dialogs(_Gnome,_Dialog);

IF
EntityEvent(_,"UND_GnomeWorker_AppearedSaved")
AND
QRY_OnlyOnce("UND_GnomeWorkers_AtMyconids")
THEN
PROC_GlobalSetFlagAndCache((FLAG)UND_DuergarCamp_State_GnomeAtMyconids_f48d9c4e-e6eb-46dc-93a7-89326d11829b);
PROC_GlobalSetFlagAndCache((FLAG)UND_GnomeWorkers_State_Left_25c2b06a-4101-4ea6-bcc0-273ca5aeb86a);

//END_REGION

//REGION Remove Neutral NPCs
IF
EntityEvent((CHARACTER)_Player,"UND_Grymforge_Empty")
AND
DB_GlobalFlag(UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("UND_DuergarCamp_RemoveNeutralNPCs")
THEN
PROC_UND_DuergarCamp_RemoveNeutralNPCs();

PROC
PROC_LongRest()
AND
DB_GlobalFlag(UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
AND
QRY_OnlyOnce("UND_DuergarCamp_RemoveNeutralNPCs")
THEN
DB_ExecuteInLevel("UND_DuergarCamp_RemoveNeutralNPCs","WLD_Main_A");

PROC
PROC_ExecuteInLevel("UND_DuergarCamp_RemoveNeutralNPCs","WLD_Main_A")
THEN
PROC_UND_DuergarCamp_RemoveNeutralNPCs();

PROC
PROC_UND_DuergarCamp_RemoveNeutralNPCs()
AND
DB_UND_DuergarGuards_City(_Duergar,_)
THEN
PROC_UND_DuergarCamp_RemoveNeutral(_Duergar);

PROC
PROC_UND_DuergarCamp_RemoveNeutralNPCs()
AND
DB_UND_ElevatorNPCs(_Duergar)
THEN
PROC_UND_DuergarCamp_RemoveNeutral(_Duergar);

PROC
PROC_UND_DuergarCamp_RemoveNeutralNPCs()
AND
DB_UND_DuergarSpiders(_Spider)
THEN
PROC_UND_DuergarCamp_RemoveNeutral(_Spider);

PROC
PROC_UND_DuergarCamp_RemoveNeutralNPCs()
AND
DB_UND_DuergarCamp_Rothes(_Character)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_RemoveNeutralNPCs()
AND
DB_UND_FearfulRothe_Rothe(_Character)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_RemoveNeutralNPCs()
AND
DB_UND_FearfulRothe_Guards(_Character)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_RemoveNeutralNPCs()
AND
DB_UND_DeadInTheWater_CorpseDisposers(_Character, _)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_RemoveNeutral((CHARACTER)_Character)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Character);
SetOnStage(_Character, 0);
//END_REGION Remove Neutral NPCs

//REGION Journal scripting
IF
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
AND
DB_GlobalFlag((FLAG)UND_DuergarGuards_Excavation_State_PermaDefeated_3f30c825-10f1-4fa5-84b8-073f293e6650)
AND
DB_GlobalFlag((FLAG)UND_TheDrowNere_State_PermaDefeated_53f1e115-adf8-4608-b85c-08e0dc7d67ad)
THEN
QuestUpdate("UND_GnomeRescue","DealtWithSlavers");

IF
QuestUpdateUnlocked(_,"UND_GnomeRescue","DealtWithSlavers")
AND
QRY_UND_GnomeRescue_CheckDefeatedLeaders()
AND
DB_GlobalFlag(UND_InjuredGnome_State_GaveQuest_2e8e3582-bd63-4edb-f305-cd9cd8dd85ce)
THEN
QuestUpdate("UND_GnomeRescue","ThankedFreed_BeldronThulla");

IF
QuestUpdateUnlocked(_,"UND_GnomeRescue","DealtWithSlavers")
AND
QRY_UND_GnomeRescue_CheckDefeatedLeaders()
AND
NOT DB_GlobalFlag(UND_InjuredGnome_State_GaveQuest_2e8e3582-bd63-4edb-f305-cd9cd8dd85ce)
THEN
QuestUpdate("UND_GnomeRescue","ThankedFreed_Beldron");

QRY
QRY_UND_GnomeRescue_CheckDefeatedLeaders()
AND
DB_GlobalFlag(UND_GnomeForeman_State_PermaDefeated_32e110c6-7830-4ebe-be12-de932bd16e3f)
THEN
DB_NOOP(1);

QRY
QRY_UND_GnomeRescue_CheckDefeatedLeaders()
AND
DB_GlobalFlag(UND_UnfortunateGnome_State_Present_3bfdff8e-c1fc-4031-9910-c9cfca2135ef)
AND
DB_GlobalFlag((FLAG)UND_DuergarGuards_State_PermaDefeated_b2211d1b-3dea-9b74-b19c-71938ac4b218)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)_Dialog,_ID)
AND
QRY_UND_DuergarCamp_CheckPostCombatDialog(_Dialog)
AND
DB_DialogPlayers(_ID,_Player,_)
AND
DB_DialogNPCs(_ID,_NPCSpeaker,1)
AND
NOT DB_GlobalFlag((FLAG)UND_State_LeaderFreedGnomes_49acb531-d0c4-d3d1-6af4-c79e246e4327)
AND
NOT DB_GlobalFlag((FLAG)UND_GnomeWorkers_State_PermaDefeated_99fa547a-d3c9-46fe-b53f-7cceb510cd6f)
AND
NOT QRY_IsEnemy(_NPCSpeaker,_Player)
THEN
QuestUpdate("UND_GnomeRescue","DuergarKeptGnomes");
//TODO: Consider players attacking the duergar after the dialog and the gnomes being freed in the end.

QRY
QRY_UND_DuergarCamp_CheckPostCombatDialog((DIALOGRESOURCE)_Dialog)
AND
DB_UND_DuergarCamp_NerePostCombat_FollowUpSpeakers(_,_Dialog)
THEN
DB_NOOP(1);

QRY
QRY_UND_DuergarCamp_CheckPostCombatDialog((DIALOGRESOURCE)_Dialog)
AND
DB_UND_DuergarCamp_Mutineers_FollowUpSpeakers(_,_Dialog,_)
THEN
DB_NOOP(1);

QRY
QRY_UND_DuergarCamp_CheckPostCombatDialog((DIALOGRESOURCE)_Dialog)
AND
DB_UND_DuergarCamp_Mutineers_FollowUpSpeakers(_,_,_Dialog)
THEN
DB_NOOP(1);

IF
QuestAccepted(_Player,"UND_CaveIn")
AND
ItemTagIsInInventory("EXPLOSIVES_f6e89388-0e91-4e9d-b5b7-1d4938dda540",_Player,_Count)
AND
_Count >= 1
THEN
QuestUpdate(_Player,"UND_CaveIn","FoundExplosive");

IF
FlagSet(UND_ArguingGnomes_Event_LearnedAboutPhilomeen_e5b4aed4-5cf3-4b39-442d-e44d1c2df782,_,_)
AND
NOT QRY_UND_DuergarCamp_PlayerGroupHasExplosives()
THEN
QuestUpdate("UND_CaveIn","Smokepowder_LearnedExplosive");

QRY
QRY_UND_DuergarCamp_PlayerGroupHasExplosives()
AND
DB_Players(_Player)
AND
ItemTagIsInInventory("EXPLOSIVES_f6e89388-0e91-4e9d-b5b7-1d4938dda540",_Player,_Count)
AND
_Count >= 1
THEN
QuestUpdate("UND_CaveIn","LearnedExplosiveHasSomeAlready");

IF
AddedTo(_Explosive,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_QuestIsOpened("UND_CaveIn")
AND
NOT DB_UND_CaveIn_ExplosiveQuestUpdate(_Player)
AND
IsTagged(_Explosive,(TAG)EXPLOSIVES_f6e89388-0e91-4e9d-b5b7-1d4938dda540,1)
THEN
PROC_UND_CaveIn_FoundExplosives_ProcessQuestUpdate(_Player);
QuestUpdate(_Player,"UND_CaveIn","FoundExplosive");
DB_UND_CaveIn_ExplosiveQuestUpdate(_Player);

PROC
PROC_UND_CaveIn_FoundExplosives_ProcessQuestUpdate((CHARACTER)_Player)
AND
GetFlag(UND_HiddenGnome_HasVial_c21860d0-c8af-430e-aa42-de81ff020568,_Player,0)
AND
QuestIsAccepted(_Player,"UND_CaveIn_SUB_Smokepowder",1)
THEN
QuestUpdate(_Player,"UND_CaveIn","GotSmokepowder");

PROC
PROC_UND_CaveIn_FoundExplosives_ProcessQuestUpdate((CHARACTER)_Player)
AND
GetFlag(UND_HiddenGnome_HasVial_c21860d0-c8af-430e-aa42-de81ff020568,_Player,0)
AND
QuestUpdateIsUnlocked(_Player,"UND_CaveIn","PhilomeenMapRead",1)
THEN
QuestUpdate(_Player,"UND_CaveIn","GotMoreSmokepowder");

IF
FlagSet((FLAG)UND_HiddenGnome_GiveVial_5a67f77b-a8ef-4197-817c-7ae4cab1515f, _Player, _Instance)
AND
DB_DialogPlayers(_Instance, _Player, _)
AND
NOT DB_Defeated(S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e)
THEN
QuestUpdate((CHARACTER)_Player, "UND_CaveIn", "PhilomeenGaveVial");

IF
AttackedBy(S_UND_DuergarCamp_CaveIn_0c5b70d8-112a-4380-99c6-68e299d720b0,(CHARACTER)_Player,_,_,_DamageAmmount,_,_)
AND
_DamageAmmount > 0
AND
IsDestroyed(S_UND_DuergarCamp_CaveIn_0c5b70d8-112a-4380-99c6-68e299d720b0,0)
THEN
QuestUpdate(_Player,"UND_CaveIn","DamagedCaveIn");

IF
DB_GlobalFlag((FLAG)UND_PanicRoom_State_GnomeDead_f5193345-c742-452a-87f4-7eb00d4f8991)
AND
DB_Destroyed(S_UND_Runepowder_Barrel_f09c0a57-6b72-4308-a588-322cb06d47f3)
THEN
QuestUpdate("UND_CaveIn","PhilomeenExploded");

IF
DB_Offstage(S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e)
AND
IsInInventoryOf(S_UND_Runepowder_Barrel_f09c0a57-6b72-4308-a588-322cb06d47f3, S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e, 1)
THEN
QuestUpdate("UND_CaveIn","PhilomeenExploded"); // that-s of course not explosion but her leaving, however the text of the update still fits

IF
EnteredTrigger(_Player,S_UND_DuergarCamp_DesertedTrigger_2f1a7d23-a664-4f0c-92d6-0eaaeaacce33)
THEN
PROC_UND_DuergarCamp_OnEnteredDesertedTrigger(_Player);
PROC_TriggerUnregisterForPlayers(S_UND_DuergarCamp_DesertedTrigger_2f1a7d23-a664-4f0c-92d6-0eaaeaacce33);

PROC
PROC_UND_DuergarCamp_OnEnteredDesertedTrigger((CHARACTER)_Player)
THEN
QuestUpdate("UND_GnomeRescue","GnomesCaptured");
QuestUpdate("UND_CaveIn","Eye_MainClosed");
QuestUpdate("UND_CaveIn","Smokepowder_MainClosed");
QuestUpdate("UND_CaveIn","CaveInCleared_Auto");

IF
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
NOT DB_Is_InCombat(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_)
THEN
QuestUpdate("UND_CaveIn", "DuergarDefeated");

IF
DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
NOT DB_GlobalFlag((FLAG)UND_TheDrowNere_State_DiedDeserted_d9349fbe-a9bd-45f1-8c9e-8f97cf648841)
THEN
QuestUpdate("UND_CaveIn", "NerePermaDefeated");

IF
RelationChanged((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95, 0, 1)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
THEN
QuestUpdate("UND_CaveIn", "AttackedNere");
//END_REGION

//REGION Deserting the area
IF
EntityEvent((CHARACTER)_Player,"UND_Grymforge_Empty")
THEN
PROC_UND_DuergarCamp_CheckSuffocating(_Player);

PROC
PROC_LongRest_InLevel("WLD_Main_A")
AND
DB_Players(_Player)
THEN
PROC_UND_DuergarCamp_CheckSuffocating(_Player);

PROC
PROC_UND_DuergarCamp_CheckSuffocating((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)UND_TheDrowNere_Event_HadMindMeld_698b418b-a9be-b13a-6af7-a1628fedf1a3)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_TriedLeavingOnce_6ac9eaf7-f778-9b2c-c6c2-884420cf1203)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_BattleStarted_ff6b8579-5926-4406-a983-b9843f875159)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
QRY_GetClosestAvailableCharacterTo(_Player,0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar,_Player,_Dist,_)
AND
_Dist < 30.0
AND
QRY_StartDialog((DIALOGRESOURCE)UND_TheDrowNere_Mindmeld_LeavingRegion_61d63c10-bbd8-da75-3e0e-179714b95278,(CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_ClosestAvatar)
THEN
QuestUpdate(_Player,"UND_CaveIn","TrueSoulAskedHelp");
QuestUpdate(_Player,"UND_CaveIn","WarnedAboutPoison");

PROC
PROC_UND_DuergarCamp_CheckSuffocating((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_TriedLeavingOnce_6ac9eaf7-f778-9b2c-c6c2-884420cf1203)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_BattleStarted_ff6b8579-5926-4406-a983-b9843f875159)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
QRY_OnlyOnce("UND_DuergarCamp_Deserted")
THEN
PROC_UND_DuergarCamp_Deserted();

PROC
PROC_UND_DuergarCamp_Deserted()
AND
DB_UND_DuergarGuards_Excavation(_Character,_)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
DB_UND_DuergarGuards_City(_Character,_)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
DB_UND_ElevatorNPCs(_Character)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
DB_UND_DuergarSpiders(_Character)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
DB_UND_DuergarCamp_Rothes(_Character)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
DB_UND_GnomeWorkers(_Character,_,_,_,_)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
DB_UND_FearfulRothe_Rothe(_Character)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
DB_UND_FearfulRothe_Guards(_Character)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
DB_UND_DeadInTheWater_CorpseDisposers(_Character, _)
THEN
SetOnStage(_Character,0);

PROC
PROC_UND_DuergarCamp_Deserted()
THEN
PROC_UND_PanicRoom_HiddenGnomeLeave_Immediately();
SetOnStage(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73,0);
Die((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,DEATHTYPE.DoT,1);
PROC_GlobalSetFlagAndCache(UND_TheDrowNere_State_DiedDeserted_d9349fbe-a9bd-45f1-8c9e-8f97cf648841);
Die(S_UND_DuergarCamp_CaveIn_0c5b70d8-112a-4380-99c6-68e299d720b0);
PROC_TriggerRegisterForPlayers(S_UND_DuergarCamp_DesertedTrigger_2f1a7d23-a664-4f0c-92d6-0eaaeaacce33);
TeleportTo(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,S_UND_TheDrowNere_CaveInTrigger_288c2053-5699-4f51-8e4e-516ffd372a62);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
GetGold(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_GoldAmount)
AND
_GoldAmount > 0
AND
IntegerProduct(-1, _GoldAmount, _AntiGoldAmount)
THEN
AddGold(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,_AntiGoldAmount);

PROC
PROC_UND_DuergarCamp_Deserted()
AND
IsInInventoryOf(S_UND_TheDrowNere_DaggerReward_6f3783a1-bb65-4900-82be-538153b99ee1,S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,1)
THEN
SetOnStage(S_UND_TheDrowNere_DaggerReward_6f3783a1-bb65-4900-82be-538153b99ee1,0);

//END_REGION

//REGION Goal completion
PROC
PROC_LevelLoadedOnce("BGO_Main_A")
THEN
GoalCompleted;
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
