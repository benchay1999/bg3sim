Version 1
SubGoalCombiner SGC_AND
INITSECTION
//EkaterinaA SPb

//REGION List of NPCs

DB_UND_LoneDuergar_Duergars((CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18);
DB_UND_LoneDuergar_Duergars(S_UND_LoneDuergar_BoatGuard_8146788d-9d39-4cf2-99ca-03484deb0c55);
DB_UND_LoneDuergar_Duergars(S_UND_LoneDuergar_Squad_Caster_ffacce35-8921-429a-8266-6d4a7a98428d);
DB_UND_LoneDuergar_Duergars(S_UND_LoneDuergar_Squad_Ranged_9c792a46-8a05-43fb-8efa-63d234dbcc6a);

//END_REGION

//REGION Dialogs
DB_Dialogs(
	S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, 
	DIALOGRESOURCEGUID_UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b);

DB_Dialogs(
	S_UND_LoneDuergar_Squad_Ranged_9c792a46-8a05-43fb-8efa-63d234dbcc6a,
	UND_LoneDuergar_Henchmen_Surprised_154adece-74de-535d-ea39-8dcbf4979308);
DB_Dialogs(
	S_UND_LoneDuergar_Squad_Caster_ffacce35-8921-429a-8266-6d4a7a98428d,
	UND_LoneDuergar_Henchmen_Surprised_154adece-74de-535d-ea39-8dcbf4979308);
DB_Dialogs(
	S_UND_LoneDuergar_BoatGuard_8146788d-9d39-4cf2-99ca-03484deb0c55,
	UND_LoneDuergar_Henchmen_Surprised_154adece-74de-535d-ea39-8dcbf4979308);

DB_UND_LoneDuergar_HenchmanDialogs(S_UND_LoneDuergar_Squad_Caster_ffacce35-8921-429a-8266-6d4a7a98428d,(DIALOGRESOURCE)UND_LoneDuergar_Squad_Wizard_8549da22-5922-bf5e-c9e7-d8f99d914af6);
DB_UND_LoneDuergar_HenchmanDialogs(S_UND_LoneDuergar_Squad_Ranged_9c792a46-8a05-43fb-8efa-63d234dbcc6a,(DIALOGRESOURCE)UND_LoneDuergar_Squad_Sniper_e02692e8-b5fc-c87f-b0a5-86a71a0ffcb2);
DB_UND_LoneDuergar_HenchmanDialogs(S_UND_LoneDuergar_BoatGuard_8146788d-9d39-4cf2-99ca-03484deb0c55,(DIALOGRESOURCE)UND_LoneDuergar_GEB_ForbiddenRaft_a0ef86da-fc74-4059-8c49-2d6f3c214d9d);

//END_REGION

//REGION Triggers
DB_ItemOwnerShipTriggers("WLD_Main_A", (TRIGGER)S_UND_LoneDuergar_OwnershipTrigger_30c8cc07-68c1-4731-be4b-ee265c911911, (CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18);
PROC_TriggerRegisterForPlayers((TRIGGER)S_UND_LoneDuergar_FoundCampTrigger_8624592b-6e5c-4a4b-aed4-1f05e14cd797);
PROC_TriggerRegisterForPlayers((TRIGGER)S_UND_LoneDuergar_LowGroundTrigger_150d5292-81f3-482b-85fc-8bcf2b0e3f23);
//END_REGION

//REGION Duergars minions
DB_UND_LoneDuergar_DeadMinions((CHARACTER)S_UND_LoneDuergar_DeadDuergar_cb30e918-7cf9-405c-b2df-bf91b7432726);
DB_UND_LoneDuergar_DeadMinions((CHARACTER)S_UND_LoneDuergar_DeadDuergar_2_847e7c72-857f-4f7e-a71b-758b0037bd25);
DB_UND_LoneDuergar_DeadMinions(CHARACTERGUID_S_UND_LoneDuergar_DeadMyconid_1_9b535b9d-576a-4d94-8e6e-628a142c1153);
DB_UND_LoneDuergar_DeadMinions(CHARACTERGUID_S_UND_LoneDuergar_DeadMyconid_2_d4b1e753-7579-4309-9be7-6b59ed4003c3);
DB_UND_LoneDuergar_DeadMinions(CHARACTERGUID_S_UND_LoneDuergar_DeadMyconid_3_1d5cb4c7-86e2-4499-bbc1-1ce373b75959);
DB_UND_LoneDuergar_DeadMinions(S_UND_MyconidCircle_DeadMyconid_000_4b026c61-6aaf-449c-b23e-dd8c5078ace5);
DB_UND_LoneDuergar_DeadMinions(S_UND_MyconidCircle_DeadMyconid_001_034518b5-36f4-405c-946e-d8f18a441f7d);
DB_UND_LoneDuergar_DeadMinions(S_UND_MyconidCircle_DeadMyconid_002_5e1d5291-f414-4d01-a5f1-abcd18457554);
//END_REGION

//REGION Ambush
SetCanTrade(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, 0);

DB_AmbushTrigger((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, (TRIGGER)S_UND_LoneDuergar_DetectAmbushTrigger_1ac3459b-a8e4-4ae2-815b-77f3d4d471ba, (DIFFICULTYCLASS)DC_Legacy_20_881bda2f-b08b-4788-b0ec-e410b5bacc57);
DB_AmbushTrigger_Ambusher((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, (CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, S_UND_LoneDuergar_BoatGuard_8146788d-9d39-4cf2-99ca-03484deb0c55, 0);
DB_AmbushTrigger_Ambusher((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, S_UND_LoneDuergar_Squad_Ranged_9c792a46-8a05-43fb-8efa-63d234dbcc6a, 0);
DB_AmbushTrigger_Ambusher((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, S_UND_LoneDuergar_Squad_Caster_ffacce35-8921-429a-8266-6d4a7a98428d, 0);

//Allow the Gekh's guards to spot the player
DB_SpotPlayers((CHARACTER)S_UND_LoneDuergar_Squad_Ranged_9c792a46-8a05-43fb-8efa-63d234dbcc6a, "UND_LoneDuergar_SurpriseSpotterID", NULL_00000000-0000-0000-0000-000000000000, (FLAG)UND_LoneDuergar_Event_SpottedSurprise_706c158b-331a-44d7-9ed9-4c6c437e117b);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_UND_LoneDuergar_Squad_Ranged_9c792a46-8a05-43fb-8efa-63d234dbcc6a, "UND_LoneDuergar_SurpriseSpotterID", (TRIGGER)S_UND_LoneDuergar_SurpriseSpottingArea_3dbc265c-c1ae-4c64-9635-65d77ee2afc3);

DB_SpotPlayers((CHARACTER)S_UND_LoneDuergar_Squad_Caster_ffacce35-8921-429a-8266-6d4a7a98428d, "UND_LoneDuergar_SurpriseSpotterID", NULL_00000000-0000-0000-0000-000000000000, (FLAG)UND_LoneDuergar_Event_SpottedSurprise_706c158b-331a-44d7-9ed9-4c6c437e117b);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_UND_LoneDuergar_Squad_Caster_ffacce35-8921-429a-8266-6d4a7a98428d, "UND_LoneDuergar_SurpriseSpotterID", (TRIGGER)S_UND_LoneDuergar_SurpriseSpottingArea_3dbc265c-c1ae-4c64-9635-65d77ee2afc3);
//END_REGION

PROC_CharacterDisableCrime(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,"Trespassing");

DB_GLO_CharacterCorpseDialog(S_UND_LoneDuergar_DeadDuergar_cb30e918-7cf9-405c-b2df-bf91b7432726, UND_LoneDuergar_DeadDuergar_Dead_6f2490c7-16ed-3915-5f47-44d918070a7e);
DB_GLO_DefeatCounter(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,"UND_BroodingSovereign_KillCounter_LoneDuergar");
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_BroodingSovereign_KillCounter_LoneDuergar", UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394);

DB_SpotPlayers((CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, "UND_LoneDuergar_GekhSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

DB_FlagReactionAfterDialog((FLAG)UND_DuergarGuardSergeant_GaveBoots_8dd74496-7a8c-fff8-5b26-f68b06991bf4, UND_DuergarGuardSergeant_7b319090-fe6f-d6bd-dcc9-5ebada7f369a);

//REGION Forbidden Raft
DB_UND_LoneDuergar_ForbiddenRaft((ITEM)S_UND_EbonLake_RaftAtCave_FullRaft_a24aa852-9f72-48bc-8d94-7a92da7ca4c1);
//END_REGION Forbidden Raft

PROC_TriggerRegisterForPlayers(S_UND_DuergarCamp_SUB_05c3bf1f-29a6-437c-9a98-c1ff0ec53a53);

DB_QuestDef_State(UND_DuergarCamp_State_BattleStarted_ff6b8579-5926-4406-a983-b9843f875159,"UND_LoneDuergar","CampHostile");
DB_QuestDef_State(UND_DuergarSergeant_PermaDefeated_c4136bfb-d994-4ba5-8c1c-cc3216d6f299,"UND_LoneDuergar","SargeDead");

// Combat NPC Reactivity
DB_CombatReact_AD_OnTurn(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, (DIALOGRESOURCE)UND_LoneDuergar_AD_CombatTurn_37e4964e-4931-530d-da8d-32c6b325fd59, 2);
DB_CombatReact_AD_OnNextTurn(S_UND_LoneDuergar_Squad_Ranged_9c792a46-8a05-43fb-8efa-63d234dbcc6a, (DIALOGRESOURCE)UND_LoneDuergar_Squad_Ranged_AD_CombatTurn_2a883646-7f99-0a3e-12c1-9aee0afa2763);
DB_CombatReact_AD_OnNextTurn(S_UND_LoneDuergar_Squad_Caster_ffacce35-8921-429a-8266-6d4a7a98428d, (DIALOGRESOURCE)UND_LoneDuergar_Squad_Caster_AD_CombatTurn_b992095e-f618-8017-3a6e-fd87383c1a3e);
DB_CombatReact_AD_OnCast(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, (DIALOGRESOURCE)UND_LoneDuergar_AD_AnimateDead_cf720476-2371-8778-3b26-0ac5571d68dc, "Target_UND_LoneDuergar_AnimateDead");
KBSECTION
//REGION Starting dialog with duergar
IF
DB_InRegion(_Player, (TRIGGER)S_UND_LoneDuergar_LowGroundTrigger_150d5292-81f3-482b-85fc-8bcf2b0e3f23)
AND
DB_Players(_Player)
THEN
SetFlag((FLAG)UND_LoneDuergar_State_LowGround_59e0b728-e660-43fb-8b1e-fa1886e6e3cf, _Player, 0);

IF
LeftTrigger(_Player, (TRIGGER)S_UND_LoneDuergar_LowGroundTrigger_150d5292-81f3-482b-85fc-8bcf2b0e3f23)
AND
DB_Players(_Player)
THEN
ClearFlag((FLAG)UND_LoneDuergar_State_LowGround_59e0b728-e660-43fb-8b1e-fa1886e6e3cf, _Player, 0);

PROC
PROC_LaunchAmbush((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, _Player)
AND
DB_Players(_Player)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b, S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _Player)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_LoneDuergar_b83a7d7a-ee94-b12d-777d-360348d123a5, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
PROC_EnterCombat(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _Player);

PROC
PROC_DialogStoppedBecauseDeadDownedPlayer((DIALOGRESOURCE)UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b, (GUIDSTRING)_Player)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_LoneDuergar_b83a7d7a-ee94-b12d-777d-360348d123a5, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);

PROC
PROC_LaunchAmbush((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, _Player)
AND
DB_PartyMembers(_Player)
AND
NOT DB_Players(_Player)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_LoneDuergar_b83a7d7a-ee94-b12d-777d-360348d123a5, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
PROC_EnterCombat(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _Player);

PROC
PROC_DialogFlagSetup(UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b,_Duergar,_)
AND
GetDistanceTo(_Duergar,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_dist)
AND
_dist<=15.0
THEN
SetFlag((FLAG)UND_LoneDuergar_State_SawSovereign_0b5b2325-db47-3e2f-3042-ce415d6d7a3f,NULL_00000000-0000-0000-0000-000000000000,0);

PROC
PROC_DialogFlagSetup(UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b,_,_Player)
AND
GetDistanceTo(_Player,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_dist)
AND
_dist<=15.0
THEN
SetFlag((FLAG)UND_LoneDuergar_State_SawSovereign_0b5b2325-db47-3e2f-3042-ce415d6d7a3f,NULL_00000000-0000-0000-0000-000000000000,0);

IF
Saw(_Duergar, S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_)
AND
NOT DB_GlobalFlag(UND_LoneDuergar_State_ReactedToSovereign_2df7c0e0-0d45-43bb-86b4-3145cc11ac96)
AND
DB_UND_LoneDuergar_Duergars(_Duergar)
AND
NOT DB_PermaDefeated(_Duergar)
AND
DB_UND_BroodingSovereign_Leader(_Player)
AND
NOT DB_AmbushTrigger_Ambusher((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, (CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _)
AND
NOT QRY_UND_LoneDuergar_StartGlutReactionDialog(_Player)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_LoneDuergar_b83a7d7a-ee94-b12d-777d-360348d123a5, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
PROC_CancelAmbush((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c);

IF
Saw(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_)
AND
NOT DB_PermaDefeated(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18)
THEN
SetFlag((FLAG)UND_LoneDuergar_State_SawSovereign_0b5b2325-db47-3e2f-3042-ce415d6d7a3f,NULL_00000000-0000-0000-0000-000000000000,0);
SetFlag((FLAG)UND_LoneDuergar_State_ReactedToSovereign_2df7c0e0-0d45-43bb-86b4-3145cc11ac96,NULL_00000000-0000-0000-0000-000000000000,0);

IF
DB_GlobalFlag((FLAG)UND_LoneDuergar_Quest_AttackMyconids_07d9e136-ed69-bbb0-62a7-23b38594c1ad)
THEN
SetCanTrade(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, 1);

// increased dialog range for this specific dialog only
// to help with the issue where the ambush is revealed, a henchman talks to us, the dialog ends we try to start a dialog with Lone Duergar
// but Lone Duergar sees Glut at the same time, but can't start a dialog with us, since he is too far away and becomes hostile
QRY
QRY_UND_LoneDuergar_StartGlutReactionDialog((CHARACTER)_Player)
AND
QRY_SpeakerIsAvailable(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, 0, 0)
AND
GetDistanceTo(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _Player, _Distance)
AND
_Distance < 15.0
AND
QRY_StartDialog((DIALOGRESOURCE)UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b, S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _Player)
THEN
DB_NOOP(1);

PROC
PROC_StateSet_Defeated(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18)
AND
DB_UND_LoneDuergar_HenchmanDialogs(_Henchman,_)
THEN
DB_SpotPlayers((CHARACTER)_Henchman,"UND_LoneDuergar_Spotting_FallbackHenchmen",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeFollowers((CHARACTER)_Henchman, "UND_LoneDuergar_Spotting_FallbackHenchmen");
DB_SpotPlayers_SpotTrigger((CHARACTER)_Henchman,"UND_LoneDuergar_Spotting_FallbackHenchmen",S_UND_LoneDuergar_DetectAmbushTrigger_1ac3459b-a8e4-4ae2-815b-77f3d4d471ba);


PROC
PROC_SpotPlayers_Spotted(_Henchman,"UND_LoneDuergar_Spotting_FallbackHenchmen",S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_UND_BroodingSovereign_Leader(_Player)
AND
DB_UND_LoneDuergar_HenchmanDialogs(_Henchman,_)
AND
NOT QRY_UND_LoneDuergar_StartGlutReactionDialog(_Player)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_LoneDuergar_b83a7d7a-ee94-b12d-777d-360348d123a5, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
PROC_CancelAmbush((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c);
//END_REGION

//REGION ownership and ambush
// Gekh's henchmen use their innate invisibility to ambush
// If player reveals them the duergar become hostile
IF
DB_AmbushTrigger_Ambusher((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, _Ambusher, 0)
THEN
UseSpell((CHARACTER)_Ambusher, "Shout_Invisibility_Duergar", _Ambusher);

PROC
PROC_GLO_KnowledgeCheckSuccess((CHARACTER)_Player, (STRING)_Identifier, S_UND_LoneDuergar_DetectAmbushTrigger_1ac3459b-a8e4-4ae2-815b-77f3d4d471ba)
THEN
SetFlag(UND_LoneDuergar_State_Surprised_272ebc10-5a54-4bf3-965d-3aac5f32c019,NULL_00000000-0000-0000-0000-000000000000,0);

IF
FlagSet((FLAG)UND_LoneDuergar_Quest_ReadyToLeave_d75ec4ad-9311-30a1-aef6-64cb8ea338be,_,_)
AND
DB_UND_LoneDuergar_ForbiddenRaft(_RaftPart)
THEN
ClearOwnership(_RaftPart);

IF
DialogStarted(UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b,_)
THEN
SetFlag(UND_LoneDuergar_DialogStarted_a26672b5-85d0-4533-b8cc-ca8168f4159e,NULL_00000000-0000-0000-0000-000000000000,0);

IF
DialogEnded(UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b, _)
AND
DB_AmbushTrigger_Ambusher((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c,_Ambusher,_)
AND
HasActiveStatus(_Ambusher, "INVISIBILITY", 1)
THEN
RemoveStatus(_Ambusher, "INVISIBILITY", _Ambusher);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_Spotter, "UND_LoneDuergar_SurpriseSpotterID", (CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("UND_LoneDuergar_StartedSurpriseDialog")
AND
DB_Dialogs(_Spotter,_Dialog)
AND
QRY_StartDialog(_Dialog,_Spotter,_Player)
THEN
DB_OnlyOnce("UND_LoneDuergar_StartedSurpriseDialog");
RemoveStatus(_Spotter, "INVISIBILITY", _Spotter);
SetFlag((FLAG)UND_LoneDuergar_Event_SpottedSurprise_706c158b-331a-44d7-9ed9-4c6c437e117b,NULL_00000000-0000-0000-0000-000000000000,0);
PROC_CancelAmbush((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c);

IF
DialogStarted(UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b,_)
AND
DB_UND_LoneDuergar_HenchmanDialogs(_Character,_Dialog)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Character);
DB_Dialogs(_Character,_Dialog);
//SetFlag(UND_LoneDuergar_State_Surprised_272ebc10-5a54-4bf3-965d-3aac5f32c019,NULL_00000000-0000-0000-0000-000000000000,0);

IF
DialogEnded(UND_LoneDuergar_Henchmen_Surprised_154adece-74de-535d-ea39-8dcbf4979308,_id)
AND
DialogGetInvolvedPlayer(_id,1,_Player)
AND
GetFlag(UND_LoneDuergar_Event_WaitingForMainDialog_2e032437-900c-7f8c-1cf6-fefb7823a042,_Player,1)
AND
QRY_StartDialog_Fixed(
	DIALOGRESOURCEGUID_UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b,
	S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,
	_Player)
THEN
DB_NOOP(1);

//END_REGION

//REGION touching raft before Lone Duergar allows you
IF
FlagSet(UND_EbonLake_Event_MoveToLake_c3786fb8-8c5e-4ad5-8742-3b50477aedfa, _Player, _)
AND
NOT DB_GlobalFlag((FLAG)UND_LoneDuergar_State_StoleRaft_c73d9e72-1f2f-44c8-b7f3-edebe21bf34f)
AND
GetOwner(S_UND_EbonLake_RaftAtCave_FullRaft_a24aa852-9f72-48bc-8d94-7a92da7ca4c1, S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18)
THEN
SetFlag(UND_LoneDuergar_State_StoleRaft_c73d9e72-1f2f-44c8-b7f3-edebe21bf34f, NULL_00000000-0000-0000-0000-000000000000, 0);

// If raft was stolen after the ambush was triggered start spot events for the boat guard
// Boat guard is the only duergar (except Gekh) who reveals himself outside of combat
IF
FlagSet(UND_LoneDuergar_State_StoleRaft_c73d9e72-1f2f-44c8-b7f3-edebe21bf34f, _, _)
AND
NOT DB_AmbushTrigger_Ambusher((TRIGGER)S_UND_LoneDuergar_AmbushTrigger_bac32eb3-3214-452f-ab1d-1e9e13d8b87c, (CHARACTER)S_UND_LoneDuergar_BoatGuard_8146788d-9d39-4cf2-99ca-03484deb0c55, _)
THEN
DB_SpotPlayers((CHARACTER)S_UND_LoneDuergar_BoatGuard_8146788d-9d39-4cf2-99ca-03484deb0c55, "UND_LoneDuergar_BoatGuardSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(UND_LoneDuergar_Knows_PlayerIsTrueSoul_57f46856-1129-9e2a-9436-e6c2c27c513d,_,_)
AND
DB_UND_LoneDuergar_ForbiddenRaft(_RaftPart)
THEN
ClearOwnership(_RaftPart);

PROC
PROC_SpotPlayers_Spotted(S_UND_LoneDuergar_BoatGuard_8146788d-9d39-4cf2-99ca-03484deb0c55, "UND_LoneDuergar_BoatGuardSpotting", _Player)
AND
DB_GlobalFlag((FLAG)UND_LoneDuergar_State_StoleRaft_c73d9e72-1f2f-44c8-b7f3-edebe21bf34f)
AND
QRY_StartDialog((DIALOGRESOURCE)UND_LoneDuergar_GCB_ForbiddenRaft_a0ef86da-fc74-4059-8c49-2d6f3c214d9d, (CHARACTER)S_UND_LoneDuergar_BoatGuard_8146788d-9d39-4cf2-99ca-03484deb0c55, _Player)
THEN
DB_NOOP(1);

PROC
PROC_SpotPlayers_Spotted(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, "UND_LoneDuergar_GekhSpotting", _Player)
AND
DB_GlobalFlag((FLAG)UND_LoneDuergar_State_StoleRaft_c73d9e72-1f2f-44c8-b7f3-edebe21bf34f)
AND
QRY_StartDialog((DIALOGRESOURCE)UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b, S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _Player)
THEN
DB_NOOP(1);

PROC
PROC_OnDialogAttackRequested( S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _)
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_LoneDuergar_b83a7d7a-ee94-b12d-777d-360348d123a5, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
//END_REGION

//REGION Combat with players
IF
Resurrected(_Duergar)
AND
DB_UND_LoneDuergar_DeadMinions(_Duergar)
AND
GetRelation((FACTION)ACT1_UND_LoneDuergar_b83a7d7a-ee94-b12d-777d-360348d123a5,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,_relation)
AND
GetRelation((FACTION)ACT1_UND_LoneDuergar_b83a7d7a-ee94-b12d-777d-360348d123a5,(FACTION)ACT1_UND_Myconids_5a3114c3-1a49-4cd8-2b4e-92f536913e30,_relation2)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_UND_LoneDuergar_RaisedCorpse_0c750d24-4146-91cc-f94e-66ef6023e6be, _relation);
PROC_SetRelation((FACTION)ACT1_UND_LoneDuergar_RaisedCorpse_0c750d24-4146-91cc-f94e-66ef6023e6be,(FACTION)ACT1_UND_Myconids_5a3114c3-1a49-4cd8-2b4e-92f536913e30,_relation2);
DB_UND_LoneDuergar_CombatMinions(_Duergar);

IF
EnteredCombat((CHARACTER)_Duergar,_)
AND
DB_UND_LoneDuergar_DeadMinions(_Duergar)
THEN
SetEntityEvent(_Duergar,"GLO_BlockCombatFallbackAD", 1);

IF
Dying(_Minion)
AND
DB_UND_LoneDuergar_CombatMinions(_Minion)
THEN
NOT DB_UND_LoneDuergar_CombatMinions(_Minion);

//END_REGION

//REGION Enrage

IF
UsingSpell(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,"Shout_Enlarge_Duergar",_,_,_)
THEN
RequestSetBaseArchetype(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,"melee");
SetAiHint(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,NULL_00000000-0000-0000-0000-000000000000);
SetTag(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);

//END_REGION

//REGION journal
QRY
QRY_UND_LoneDuergar_BootsJournalCheck((CHARACTER)_Player) //checks if the player acquired the boots at any moment (may not have them anymore, but that's OK here)
AND
QuestUpdateIsUnlocked(_Player,"UND_LoneDuergar","PersuadedBoots",1)
THEN
DB_NOOP(1);

QRY
QRY_UND_LoneDuergar_BootsJournalCheck((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player,"UND_LoneDuergar","LootedBoots",1)
THEN
DB_NOOP(1);

QRY
QRY_UND_LoneDuergar_BootsJournalCheck((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player,"UND_LoneDuergar","StoleBoots",1)
THEN
DB_NOOP(1);


/*For visibility on diffs - below is  is where "DuergarDead" update is actually given.
I removed all the other excess code for same update, it was confusing and wans't working correctly anyway*/

IF
FlagSet(UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394,_,_)
AND
DB_Players(_Player)
AND
NOT QRY_UND_LoneDuergar_BootsJournalCheck((CHARACTER)_Player)
THEN
QuestUpdate(_Player,"UND_LoneDuergar","DuergarDead");

IF
FlagSet(UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394,_,_)
AND
DB_Players(_Player)
AND
QRY_UND_LoneDuergar_BootsJournalCheck((CHARACTER)_Player)
THEN
QuestUpdate(_Player,"UND_LoneDuergar","GotBoots_DuergarDead");

IF
Saw(_Player,S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,_)
AND
NOT DB_Dead(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "UND_LoneDuergar","FoundGnome");

IF
Saw(_Player,S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,_)
AND
DB_Dead(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
AND
DB_Players(_Player)
AND
NOT DB_UND_LoneDuergar_KilledGnome(1)
AND
NOT QRY_UND_LoneDuergar_BootsJournalCheck((CHARACTER)_Player)
THEN
QuestUpdate(_Player,"UND_LoneDuergar","GnomeDied");

IF
KilledBy(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,_Player,_,_int) // journal specifically refers to "killed gnome"
AND																							   //can't use permadefeated either, because Thulla can die without players involvement
DB_Players((CHARACTER)_Player)
AND
NOT QRY_UND_LoneDuergar_BootsJournalCheck((CHARACTER)_Player)
THEN
DB_UND_LoneDuergar_KilledGnome(1);
PROC_UND_LoneDuergar_CheckGiveKilledGnome(_Player);

PROC
PROC_UND_LoneDuergar_CheckGiveKilledGnome((CHARACTER)_Player)
AND
DB_QuestIsOpened("UND_LoneDuergar") //"KilledGnome" text is: "We killed Thulla to get the boots."
THEN						//only give this entry if the quest is started - otherwise you don't know that you are killing her for the boots 
QuestUpdate(_Player,"UND_LoneDuergar","KilledGnome");

PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Player,UND_DuergarGuardSergeant_GaveBoots_8dd74496-7a8c-fff8-5b26-f68b06991bf4)
AND
GetFlag((FLAG)UND_LoneDuergar_GotReward_b15634ee-abc4-4e35-a90b-de1902b667ed,_Player,0)
AND
IsInCombat(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,1)
THEN
QuestUpdate(_Player,"UND_LoneDuergar","GaveBoots_Attacked");

PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Player,UND_DuergarGuardSergeant_GaveBoots_8dd74496-7a8c-fff8-5b26-f68b06991bf4)
AND
GetFlag((FLAG)UND_LoneDuergar_GotReward_b15634ee-abc4-4e35-a90b-de1902b667ed,_Player,0)
THEN
QuestUpdate(_Player,"UND_LoneDuergar","GaveBoots_NoReward");

IF
FlagSet((FLAG)UND_MyconidCircle_InjuredGnome_GiveBoots_c917e56b-1335-481c-9062-6f46dfa90cea,_,_)
AND
DB_Players(_Player)
THEN
QuestUpdate((CHARACTER)_Player,"UND_LoneDuergar","PersuadedBoots");

IF
AddedTo(S_UND_MyconidCircle_BootsOfSpeed_fca76ec8-f3dd-446c-bd69-dc2f6ccca285,(CHARACTER)_PlayerSpecific, _)
AND
DB_Players(_PlayerSpecific)
AND
DB_PermaDefeated(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
AND
QuestUpdateIsUnlocked(_PlayerSpecific,"UND_LoneDuergar","PersuadedBoots",0)
THEN
QuestUpdate("UND_LoneDuergar","LootedBoots");

IF
AddedTo(S_UND_MyconidCircle_BootsOfSpeed_fca76ec8-f3dd-446c-bd69-dc2f6ccca285,(CHARACTER)_PlayerSpecific, _)
AND
DB_Players(_PlayerSpecific)
AND
NOT DB_PermaDefeated(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
AND
QuestUpdateIsUnlocked(_PlayerSpecific,"UND_LoneDuergar","PersuadedBoots",0)
THEN
QuestUpdate("UND_LoneDuergar","StoleBoots");

IF
FlagSet((FLAG)UND_LoneDuergar_Quest_ReadyToLeave_d75ec4ad-9311-30a1-aef6-64cb8ea338be,_,_)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player,"UND_LoneDuergar","ShownBoots");



IF
EnteredTrigger(_Player,S_UND_DuergarCamp_SUB_05c3bf1f-29a6-437c-9a98-c1ff0ec53a53)
AND
DB_Players(_Player)
AND
QRY_UND_LoneDuergar_BootsJournalCheck(_Player)
THEN
QuestUpdate(_Player,"UND_LoneDuergar","Report");


IF
FlagSet((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3,_,_)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player,"UND_LoneDuergar","PersuadedBoots",0)
AND
QuestUpdateIsUnlocked(_Player,"UND_LoneDuergar","LootedBoots",0)
THEN
QuestUpdate(_Player,"UND_LoneDuergar","Left_NoBoots");

IF
FlagSet((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3,_,_)
THEN
QuestUpdate("UND_LoneDuergar","Left_WithBoots");

PROC
PROC_UND_DuergarCamp_OnEnteredDesertedTrigger((CHARACTER)_Player)
THEN
QuestUpdate("UND_LoneDuergar","DuergarLeft");

//END_REGION

// PAD when player first finds camp
IF
DB_InRegion(_Player, (TRIGGER)S_UND_LoneDuergar_FoundCampTrigger_8624592b-6e5c-4a4b-aed4-1f05e14cd797)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("UND_LoneDuergar_NoticeCamp")
THEN
PROC_TryStartAD((DIALOGRESOURCE)UND_LoneDuergar_PAD_FoundCamp_68679f1a-0828-47a0-917d-92f381a7f723, _Player);

//REGION Met Lone Duergar Flag, required for Lake Event
IF
DialogEnded(UND_LoneDuergar_1485fbf6-692f-e5e6-ce95-f1ac78ee956b, _)
THEN
SetFlag(UND_LoneDuergar_Quest_DuergarMet_dd50525d-cb2a-f3be-d9a3-a18297af9ac1, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Met Lone Duergar Flag, required for Lake Event


//REGION Party Banter

PROC
PROC_LongRest()
AND
DB_PermaDefeated(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18)
AND
NOT DB_WorldGossipTrigger(S_PartyBanterTrigger_UND_GnomeCampCleared_70aafb19-6a86-40c5-9719-7b991c0a33a4,_,_)
THEN
PROC_RegisterWorldGossipTrigger(S_PartyBanterTrigger_UND_GnomeCampCleared_70aafb19-6a86-40c5-9719-7b991c0a33a4);
PROC_RegisterWorldGossipTrigger(S_PartyBanterTrigger_UND_GnomeQuarryCleared_b4baf73d-2f0a-42c4-9026-73459071da8d);
//END_REGION

//REGION Forbidden Raft
IF
DB_UND_LoneDuergar_ForbiddenRaft(_RaftPart)
THEN
SetOwner(_RaftPart, S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18);
DB_CustomForbiddenItemCrimes(_RaftPart, "UND_LoneDuergar_ForbiddenRaft", "UND_LoneDuergar_ForbiddenRaft");

// block the crime when Lone Duergar dies, to prevent him from reacting to it when he is resurrected by Glut
IF
Died((CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18)
THEN
PROC_CharacterDisableCrime((CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, "UND_LoneDuergar_ForbiddenRaft");
//END_REGION Forbidden Raft

//REGION Hidden stash

IF
TextEvent("UND_LoneDuergar_SecretGnomeStash_Marker")
THEN
PROC_UnlockPartyMarker("UND_LoneDuergar_SecretGnomeStash",(TRIGGER)S_UND_LoneDuergar_GnomeStash_Area_f1289b8d-6930-40f9-b1a4-4a4b5a6c63e0);
 
IF
FlagSet((FLAG)UND_LoneDuergar_Knows_GnomeStash_fb6800f1-1152-be60-104d-feb2aa501c83,_,_Id)
THEN
SetEntityEvent((ITEM)S_UND_LoneDuergar_SecretStash_802dc130-c82a-4dd2-ae3d-f9d983d1b2fb, "StoryReveal");
PROC_UnlockPartyMarker("UND_LoneDuergar_SecretGnomeStash",(TRIGGER)S_UND_LoneDuergar_GnomeStash_Area_f1289b8d-6930-40f9-b1a4-4a4b5a6c63e0);

/*
IF
UseFinished(_Player,S_UND_LoneDuergar_SecretStash_802dc130-c82a-4dd2-ae3d-f9d983d1b2fb)
AND
DB_ActivePlayerMarker(_Player,"UND_LoneDuergar_SecretGnomeStash")
THEN
PROC_HideMarker(_Player,"UND_LoneDuergar_SecretGnomeStash");*/

//END_REGION

//Gekh's Zombie Summons join swarm group
IF
StatusAttempt((CHARACTER)_Zombie,"UND_LONEDUERGAR_ZOMBIE",_,_)
THEN
RequestSetSwarmGroup(_Zombie,"UND_LoneDuergar_Zombies");
SetCombatGroupID(_Zombie, "147151c3-c960-029b-9505-e87a334fa0fc");

IF
TextEvent("testfadeout")
AND
GetHostCharacter(_Player)
THEN
ScreenFadeTo(_Player, 0.5, 0, "UND_LoneDuergar_Henchmen_Surprised_154adece-74de-535d-ea39-8dcbf4979308");

IF
TextEvent("clearfade")
AND
GetHostCharacter(_Player)
AND
GetReservedUserID(_Player,_UserID)
THEN
PROC_ClearScreenFadeTimelineForUser(_UserID, 0.5);

IF
TextEvent("testfadein")
AND
GetHostCharacter(_Player)
THEN
ScreenFadeTo(_Player, 0.5, 1, "UND_LoneDuergar_Henchmen_Surprised_154adece-74de-535d-ea39-8dcbf4979308");
EXITSECTION
SysClear("DB_UND_LoneDuergar_DuergarCamp",1);

NOT DB_GLO_DefeatCounter(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,"UND_BroodingSovereign_KillCounter_LoneDuergar");
ENDEXITSECTION
ParentTargetEdge "Act1"
