Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_UND_ConfusionMushroomsArea((TRIGGER)S_UND_ConfusionArea_001_93d0f9fc-0531-4497-ab6a-844494cd6b25, (TRIGGER)S_UND_ConfusionArea_003_ce4cfa45-a874-4238-9a90-bc343760e17d, (ITEM)S_UND_ConfusionArea_003_InvisibleHelper_d8c3aee3-fd50-4e2d-a733-8a68d7b3e6d2);
DB_UND_ConfusionMushroomsArea(S_UND_ConfusionArea_002_01b6b5cd-0b4b-4a3e-8ea3-c8639ab8fe6e, S_UND_ConfusionArea_004_327c4382-21fe-4206-b9d7-2ccde6b053ad, (ITEM)S_UND_ConfusionArea_004_InvisibleHelper_31a1bdbd-51f0-4f0d-bad8-9484b62d57dc);
DB_UND_ConfusionMushroomsArea(S_UND_ConfusionArea_003_ce4cfa45-a874-4238-9a90-bc343760e17d, S_UND_ConfusionArea_001_93d0f9fc-0531-4497-ab6a-844494cd6b25, (ITEM)S_UND_ConfusionArea_001_InvisibleHelper_18a08993-d23b-40bd-b708-7ffa535ddd3f);
DB_UND_ConfusionMushroomsArea(S_UND_ConfusionArea_004_327c4382-21fe-4206-b9d7-2ccde6b053ad, S_UND_ConfusionArea_001_93d0f9fc-0531-4497-ab6a-844494cd6b25, (ITEM)S_UND_ConfusionArea_001_InvisibleHelper_18a08993-d23b-40bd-b708-7ffa535ddd3f);
DB_UND_ConfusionMushroomsArea(S_UND_ConfusionArea_005_321a918e-a7a6-43b5-ba94-c87601bb2323, S_UND_ConfusionArea_004_327c4382-21fe-4206-b9d7-2ccde6b053ad, (ITEM)S_UND_ConfusionArea_004_InvisibleHelper_31a1bdbd-51f0-4f0d-bad8-9484b62d57dc);

DB_UND_ConfusionMushroomsArea(S_UND_TimmaskIntroArea_000_ConfusionAreaTrigger_3c5dd68e-ba8c-4141-96b5-e524d8ebecad, (TRIGGER)S_UND_TimmaskIntroArea_000_Destination_345fa3fe-6665-487f-a5c9-22cf948034df, (ITEM)S_UND_TimmaskIntroArea_000_InvisibleHelper_731c3581-4f41-4fcf-80b6-e458f2bf4f31);
DB_UND_ConfusionMushroomsArea(S_UND_TimmaskIntroArea_001_ConfusionAreaTrigger_dd8f0644-05f9-4278-a33d-50587eccbff3, (TRIGGER)S_UND_TimmaskIntroArea_001_Destination_319ce370-b973-4b95-8140-89f98d656dba, (ITEM)S_UND_TimmaskIntroArea_001_InvisibleHelper_3d0371e4-36a7-485b-9d29-2a17a8d2bfe7);

DB_UND_ConfusionMushrooms_KnowledgeTriggers((TRIGGER)S_UND_TimmaskIntroArea_000_ConfusionAreaTrigger_3c5dd68e-ba8c-4141-96b5-e524d8ebecad, (TRIGGER)S_UND_TimmaskIntroArea_000_KnowledgeCheckTrigger_308730ee-9514-4209-a564-03c492f00297);
DB_UND_ConfusionMushrooms_KnowledgeTriggers((TRIGGER)S_UND_TimmaskIntroArea_001_ConfusionAreaTrigger_dd8f0644-05f9-4278-a33d-50587eccbff3, (TRIGGER)S_UND_TimmaskIntroArea_001_KnowledgeCheckTrigger_8cb7f45c-c784-40f4-95cc-9bc4289773f5);

DB_UND_ConfusionMushrooms_MushroomsPerArea((TRIGGER)S_UND_TimmaskIntroArea_000_ConfusionAreaTrigger_3c5dd68e-ba8c-4141-96b5-e524d8ebecad, (ITEM)S_UND_TimmaskIntroArea_000_Timmask_000_29604fef-61fa-4521-9f7d-685b9e7a7338);
DB_UND_ConfusionMushrooms_MushroomsPerArea((TRIGGER)S_UND_TimmaskIntroArea_000_ConfusionAreaTrigger_3c5dd68e-ba8c-4141-96b5-e524d8ebecad, (ITEM)S_UND_TimmaskIntroArea_000_Timmask_001_6fd54a16-72a3-403f-ad17-e31eb3a02736);
DB_UND_ConfusionMushrooms_MushroomsPerArea((TRIGGER)S_UND_TimmaskIntroArea_000_ConfusionAreaTrigger_3c5dd68e-ba8c-4141-96b5-e524d8ebecad, (ITEM)S_UND_TimmaskIntroArea_000_Timmask_002_0a523ba4-7bdf-4e08-a7f7-af69fdd701a9);

DB_UND_ConfusionMushrooms_MushroomsPerArea((TRIGGER)S_UND_TimmaskIntroArea_001_ConfusionAreaTrigger_dd8f0644-05f9-4278-a33d-50587eccbff3, (ITEM)S_UND_TimmaskIntroArea_001_Timmask_001_aa1b5377-0c8e-47e5-946e-30704d4fc8e1);
DB_UND_ConfusionMushrooms_MushroomsPerArea((TRIGGER)S_UND_TimmaskIntroArea_001_ConfusionAreaTrigger_dd8f0644-05f9-4278-a33d-50587eccbff3, (ITEM)S_UND_TimmaskIntroArea_001_Timmask_002_b8b6a694-6fdb-4d4d-bf89-bea23a294c6b);
DB_UND_ConfusionMushrooms_MushroomsPerArea((TRIGGER)S_UND_TimmaskIntroArea_001_ConfusionAreaTrigger_dd8f0644-05f9-4278-a33d-50587eccbff3, (ITEM)S_UND_TimmaskIntroArea_001_Timmask_003_b797a2c6-9156-4f46-8ee9-aba156ef4fd6);

DB_KnowledgeCheckTrigger_AD("UND_TimmaskIntroArea_ConfusionMushrooms", S_UND_TimmaskIntroArea_000_KnowledgeCheckTrigger_308730ee-9514-4209-a564-03c492f00297, "Nature", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)UND_ConfusionMushroomsNatureCheck_bedabb90-54d4-b9df-bd95-09d263e461ee, UND_ConfusionMushrooms_Event_NatureCheckSuccess_0573df9a-3b68-4f60-a14d-bf92dd99bc12);
DB_KnowledgeCheckTrigger_AD("UND_TimmaskIntroArea_ConfusionMushrooms", S_UND_TimmaskIntroArea_001_KnowledgeCheckTrigger_8cb7f45c-c784-40f4-95cc-9bc4289773f5, "Nature", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)UND_ConfusionMushroomsNatureCheck_bedabb90-54d4-b9df-bd95-09d263e461ee, UND_ConfusionMushrooms_Event_NatureCheckSuccess_0573df9a-3b68-4f60-a14d-bf92dd99bc12);
DB_KnowledgeCheckTrigger_AD("UND_TimmaskIntroArea_BothMushrooms", S_UND_MushroomClearing_KnowledgeCheckArea_7dddf7da-985d-4164-b0ba-72488ede1b49, "Nature", (DIFFICULTYCLASS)DC_Legacy_20_881bda2f-b08b-4788-b0ec-e410b5bacc57, (DIALOGRESOURCE)UND_PAD_MushroomClearingNatureCheck_6a894f93-6d7c-f068-5d70-1d540dbfc486, UND_BothTypeOfMushrooms_Event_NatureCheckSuccess_80c272ad-64c9-4e9e-944b-9ce71bb4f214); 
KBSECTION
//REGION Confusion Mushrooms (Anubis)
IF
StatusApplied((CHARACTER)_Character, "TIMMASK_SPORES", _, _)
AND
DB_UND_ConfusionMushroomsArea(_ConfusionArea, _, _Source)
AND
IsInTrigger(_Character, _ConfusionArea, 1)
THEN
ApplyStatus(_Character, "TIMMASK_SPORES_HELPER", 6.0, 1, _Source);

IF
StatusRemoved((CHARACTER)_Character, "TIMMASK_SPORES", _, _)
THEN
RemoveStatus(_Character, "TIMMASK_SPORES_HELPER");

IF
EntityEvent((CHARACTER)_Character, "UND_TimmaskMushrooms_UpdateStatus")
AND
HasAppliedStatus(_Character, "TIMMASK_SPORES", 1)
AND
DB_UND_ConfusionMushroomsArea(_ConfusionArea, _, _Source)
AND
IsInTrigger(_Character, _ConfusionArea, 1)
THEN
RemoveStatus(_Character, "TIMMASK_SPORES_HELPER");
ApplyStatus(_Character, "TIMMASK_SPORES_HELPER", 6.0, 1, _Source);
//END_REGION Confusion Mushrooms (Anubis)

//REGION Mushroom Clearing Knowledge Check
// If already tried to recognize Timmasks then only need to reckognize Torchstalks, reducing the DC
IF
AutomatedDialogEnded((DIALOGRESOURCE)UND_AD_ConfusionMushroomsNatureCheck_bedabb90-54d4-b9df-bd95-09d263e461ee, _)
AND
DB_KnowledgeCheckTrigger_AD("UND_TimmaskIntroArea_BothMushrooms", _Trigger, "Nature", (DIFFICULTYCLASS)DC_Legacy_20_881bda2f-b08b-4788-b0ec-e410b5bacc57, _Dialog, UND_BothTypeOfMushrooms_Event_NatureCheckSuccess_80c272ad-64c9-4e9e-944b-9ce71bb4f214)
THEN
NOT DB_KnowledgeCheckTrigger_AD("UND_TimmaskIntroArea_BothMushrooms", _Trigger, "Nature", (DIFFICULTYCLASS)DC_Legacy_20_881bda2f-b08b-4788-b0ec-e410b5bacc57, _Dialog, UND_BothTypeOfMushrooms_Event_NatureCheckSuccess_80c272ad-64c9-4e9e-944b-9ce71bb4f214);
DB_KnowledgeCheckTrigger_AD("UND_TimmaskIntroArea_BothMushrooms", _Trigger, "Nature", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, _Dialog, UND_ExplosiveMushrooms_Event_NatureCheckSuccess_ff4df9e7-187f-49cb-b736-214b319d1813);

IF
FlagSet(UND_BothTypeOfMushrooms_Event_NatureCheckSuccess_80c272ad-64c9-4e9e-944b-9ce71bb4f214, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
SetFlag(UND_ConfusionMushrooms_Event_NatureCheckSuccess_0573df9a-3b68-4f60-a14d-bf92dd99bc12, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(UND_ExplosiveMushrooms_Event_NatureCheckSuccess_ff4df9e7-187f-49cb-b736-214b319d1813, NULL_00000000-0000-0000-0000-000000000000);

// if tried to recognize both types, then remove the check for Timmask only
IF
AutomatedDialogEnded(UND_PAD_MushroomClearingNatureCheck_6a894f93-6d7c-f068-5d70-1d540dbfc486, _)
AND
DB_KnowledgeCheckTrigger_AD("UND_TimmaskIntroArea_ConfusionMushrooms", _Trigger, _Check, _DC, _Dialog, UND_ConfusionMushrooms_Event_NatureCheckSuccess_0573df9a-3b68-4f60-a14d-bf92dd99bc12)
THEN
NOT DB_KnowledgeCheckTrigger_AD("UND_TimmaskIntroArea_ConfusionMushrooms", _Trigger, _Check, _DC, _Dialog, UND_ConfusionMushrooms_Event_NatureCheckSuccess_0573df9a-3b68-4f60-a14d-bf92dd99bc12);
//END_REGION Mushroom Clearing Knowledge Check

//REGION Destroying the mushrooms at the clearing
IF
DestroyedBy(_ConfusionMushroom, _, _, _)
AND
DB_UND_ConfusionMushrooms_MushroomsPerArea(_ConfusionAreaTrigger, _ConfusionMushroom)
THEN
NOT DB_UND_ConfusionMushrooms_MushroomsPerArea(_ConfusionAreaTrigger, _ConfusionMushroom);
PROC_UND_ConfusionMushrooms_CheckIfAnyLeft(_ConfusionAreaTrigger);

PROC
PROC_UND_ConfusionMushrooms_CheckIfAnyLeft((TRIGGER)_ConfusionAreaTrigger)
AND
NOT DB_UND_ConfusionMushrooms_MushroomsPerArea(_ConfusionAreaTrigger, _)
AND
DB_UND_ConfusionMushrooms_KnowledgeTriggers(_ConfusionAreaTrigger, _KnowledgeTrigger)
THEN
PROC_TriggerUnregisterForPlayers(_KnowledgeTrigger);
//END_REGION Destroying the mushrooms at the clearing

//REGION Spores item dropping
IF
EntityEvent((ITEM)_Mushroom, "UND_ConfusionMushrooms_Event_DropSpores")
AND
QRY_UND_ConfusionMushrooms_NotEnoughPickedForMushroom(_Mushroom)
AND
GetPosition(_Mushroom, _X, _Y, _Z)
AND
Random(2, _Random)
AND
IntegerSum(1, _Random, _N)
AND
QRY_DoNTimes(_N)
AND
DB_QRY_RTN_DoNTimes(_I)
AND
CreateAt(UNI_UND_SocietyOfBrilliance_TimmaskSpore_8e2dd06c-c62f-4235-b0f8-f353c6b1ec9d, _X, _Y, _Z, 0, 0, "", _SporesItem)
THEN
DB_UND_ConfusionMushrooms_SpawnedSporesItems(_Mushroom, (ITEM)_SporesItem);
ApplyStatus(_SporesItem, "UND_SPORES_SCATTER", 9.0, 1, _Mushroom);
ScatterAt((ITEM)_SporesItem, _X, _Y, _Z);

IF
StatusRemoved(_SporesItemm, "UND_SPORES_SCATTER", _, _)
AND
DB_UND_ConfusionMushrooms_SpawnedSporesItems(_Mushroom, _SporesItem)
AND
IsInInventory((ITEM)_SporesItem, 0)
AND
IsDestroyed((ITEM)_SporesItem, 0)
THEN
NOT DB_UND_ConfusionMushrooms_SpawnedSporesItems(_Mushroom, _SporesItem);
Die(_SporesItem);

IF
DestroyingBy(_SporesItem, _, _, _)
AND
DB_UND_ConfusionMushrooms_SpawnedSporesItems((ITEM)_Mushroom, _SporesItem)
THEN
NOT DB_UND_ConfusionMushrooms_SpawnedSporesItems((ITEM)_Mushroom, _SporesItem);

IF
AddedTo(_SporesItem, _, _)
AND
DB_UND_ConfusionMushrooms_SpawnedSporesItems(_Mushroom, (ITEM)_SporesItem)
THEN
NOT DB_UND_ConfusionMushrooms_SpawnedSporesItems(_Mushroom, _SporesItem);
PROC_UND_ConfusionMushrooms_PickedForMushroom(_Mushroom);
RemoveStatus(_SporesItem, "UND_SPORES_SCATTER");

PROC
PROC_UND_ConfusionMushrooms_PickedForMushroom((ITEM)_Mushroom)
AND
DB_UND_ConfusionMushrooms_PickedForMushroom(_Mushroom, _Count)
AND
IntegerSum(1, _Count, _NewCount)
THEN
NOT DB_UND_ConfusionMushrooms_PickedForMushroom(_Mushroom, _Count);
DB_UND_ConfusionMushrooms_PickedForMushroom(_Mushroom, _NewCount);

PROC
PROC_UND_ConfusionMushrooms_PickedForMushroom((ITEM)_Mushroom)
AND
NOT DB_UND_ConfusionMushrooms_PickedForMushroom(_Mushroom, _)
THEN
DB_UND_ConfusionMushrooms_PickedForMushroom(_Mushroom, 1);

QRY
QRY_UND_ConfusionMushrooms_NotEnoughPickedForMushroom((ITEM)_Mushroom)
AND
NOT DB_UND_ConfusionMushrooms_PickedForMushroom(_Mushroom, _)
THEN
DB_NOOP(1);

QRY
QRY_UND_ConfusionMushrooms_NotEnoughPickedForMushroom((ITEM)_Mushroom)
AND
DB_UND_ConfusionMushrooms_PickedForMushroom(_Mushroom, _Count)
AND
_Count < 2
THEN
DB_NOOP(1);
//END_REGION Spores item dropping
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
