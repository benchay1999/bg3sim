Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(
     S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,
    (DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c);

DB_HostileToPlayerGroupCancelFlag(UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8, ACT1_UND_Myconids_5a3114c3-1a49-4cd8-2b4e-92f536913e30);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)UND_Myconid_BroodingSovereign_Raft_f6f33683-5889-e6b0-e6a9-0810856ec3ea);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca);

DB_GlobalFlagReactionAfterDialog(
    (FLAG)UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210,
    (DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c);


DB_GlobalFlagReactionAfterDialog(
    (FLAG)UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210,
    (DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca);

DB_GlobalFlagReactionAfterDialog(
    (FLAG)UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210,
    (DIALOGRESOURCE)UND_Myconid_BroodingSovereign_Raft_f6f33683-5889-e6b0-e6a9-0810856ec3ea);

DB_GlobalFlagReactionAfterDialog(
    (FLAG)UND_MyconidCircle_BroodingSovereign_Event_BetrayGlut_bc02af6d-dc65-7322-a28c-9e68dc4ea875,
    (DIALOGRESOURCE)UND_MyconidSovereign_934d97d0-922c-7c31-05fe-054bcc630447);

DB_GlobalFlagReactionAfterDialog(
    (FLAG)UND_BroodingSovereign_State_RefusedCircle_d0237569-b266-24c9-60f8-06eda3131892,
    (DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c);

DB_UND_BroodingSovereign_Home((TRIGGER)S_UND_MyconidCircle_BroodingSovereign_Home_ad46b61d-35f3-40e7-a010-62a9d89b30e3);

DB_UND_BroodingSpovereign_FollowingRegions((TRIGGER)S_UND_MyconidCircle_UnderdarkRegion_Main_fdf3b75f-4488-449d-bced-a936b0590bf1);
DB_UND_BroodingSpovereign_FollowingRegions(S_UND_MyconidCircle_UnderdarkRegion_KuoToa_d5626641-d631-4983-b5a5-77d5c07c872a);

DB_UND_BroodingSpovereign_UnderdarkWaypoints("WAYP_UND_Beach");
DB_UND_BroodingSpovereign_UnderdarkWaypoints("WAYP_UND_Sussur");
DB_UND_BroodingSpovereign_UnderdarkWaypoints("WAYP_UND_Fort");
DB_UND_BroodingSpovereign_UnderdarkWaypoints("WAYP_UND_Myconid");

DB_UND_BroodingSovereign_ExitPoints((ITEM)S_SHA_TempleAccess_StairsDownstairs_3780fa8f-9257-4998-81c4-1b28c293b26e);
DB_UND_BroodingSovereign_ExitPoints(S_UND_Elevator_ToCaravanserai_b0bafa5b-ca00-4c94-af1c-12ced8562b4e);
DB_UND_BroodingSovereign_ExitPoints(S_UND_FairyRings_Main_MushroomRing_ToSwamp_b71a59f4-52c6-4ed2-9d91-8c76815280e6);

DB_UND_BroodingSovereign_ExitPoints_WithinUnderdark((ITEM)S_UND_EbonLake_RaftAtCave_FullRaft_a24aa852-9f72-48bc-8d94-7a92da7ca4c1);
DB_UND_BroodingSovereign_ExitPoints_WithinUnderdark(S_UND_DuergarCamp_BoatAtCave_f350ecc8-67ab-4ffa-ba0f-2ca6a4bc9845);


DB_GLO_DefeatCounter(S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265, "UND_BroodingSovereign_DefeatCounter_Spaw");
DB_GLO_DefeatCounter(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, "UND_BroodingSovereign_DefeatCounter_Glut");

TriggerRegisterForCharacter(S_UND_MyconidCircle_SUB_4b5cc8fc-88f4-465e-bf82-4c20b055c019, S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);

//REGION Journal

DB_UND_BroodingSovereign_LeftUNDEntries(0, "KillDuergar_LeftUND"); // before or after killing Gekh Coal - checks UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394
DB_UND_BroodingSovereign_LeftUNDEntries(1, "AfterKill_LeftUND");

DB_QuestDef_State(UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394, "UND_BroodingSovereign", "KilledDuergar");
	//These DB_QuestDef_State_ConditionalFlag are cleared when the lone duergar is defeated
DB_QuestDef_State_ConditionalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210, "UND_BroodingSovereign", "RefusedThenAccepted", 1, UND_MyconidCircle_State_DeclinedBroodingSovereign_a8d48927-5819-08af-fc29-502c5751e3c9);
DB_QuestDef_State_ConditionalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210, "UND_BroodingSovereign", "AcceptedJoin", 0, UND_MyconidCircle_State_DeclinedBroodingSovereign_a8d48927-5819-08af-fc29-502c5751e3c9);

DB_UND_BroodingSovereign_CantReachSuspectibleEntries("RefusedEscort");
DB_UND_BroodingSovereign_CantReachSuspectibleEntries("AcceptedEscort");
DB_UND_BroodingSovereign_CantReachSuspectibleEntries("AfterKill_LeftUND");

DB_QuestDef_State(UND_MyconidCircle_BroodingSovereign_State_PermaDefeated_da7ae2b1-fa67-0889-6003-48d6aef7271d, "UND_BroodingSovereign", "GlutDead");
DB_QuestDef_State((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3, "UND_BroodingSovereign", "Left");
//END_REGION


DB_DeadOnceFlag((CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,UND_MyconidCircle_BroodingSovereign_State_LoneDuergar_IsDead_5f622802-d6d9-48df-8cb2-8b5a3ec573c2);
DB_PermaDefeatedFlag(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,UND_MyconidCircle_BroodingSovereign_State_PermaDefeated_da7ae2b1-fa67-0889-6003-48d6aef7271d);
KBSECTION
//REGION Glut grows more powerful after confirming that the duegar has been wiped out.
IF
FlagSet((FLAG)UND_BroodingSovereign_Event_Enlarged_cab76d90-68b1-40d9-95ce-74274c425d85, NULL_00000000-0000-0000-0000-000000000000,_)
THEN
SetIsBoss(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,1);
ApplyStatus(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, "UND_GLUT_ENRAGE", -1.0, 0, S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);
//END_REGION

//REGION init
IF
DB_UND_BroodingSpovereign_FollowingRegions(_Trigger)
THEN
TriggerRegisterForCharacter(_Trigger,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);
//END_REGION

//REGION Following

// local object in world
QRY
QRY_UND_BroodingSovereign_StillUND((CHARACTER)_Object)
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_InCamp(_Object)
AND
DB_UND_BroodingSpovereign_FollowingRegions(_Trigger)
AND
IsInTrigger(_Object,_Trigger,1)
THEN
DB_NOOP(1);

QRY
QRY_UND_BroodingSovereign_StillUND((CHARACTER)_Object)
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_ActiveCamp("WLDUND")
AND
DB_InCamp(_Object)
THEN
DB_NOOP(1);

// waypoint
QRY
QRY_UND_BroodingSovereign_WaypointInUND((TRIGGER)_Waypoint)
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_WaypointInfo("Act1",_Id,_,_Waypoint)
AND
DB_UND_BroodingSpovereign_UnderdarkWaypoints(_Id)
THEN
DB_NOOP(1);


IF
DB_UND_BroodingSovereign_Leader(_Player)
AND
DB_UND_BroodingSovereign_Leader(_Player2)
AND
_Player!=_Player2
THEN
NOT DB_UND_BroodingSovereign_Leader(_Player2);

PROC
PROC_GlobalFlagReactionAfterDialog(
    UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210,
    _, _Id)
AND
NOT DB_UND_BroodingSoveign_PrepareLeave_Leader(_)
AND
DialogGetInvolvedPlayer(_Id,1,_Player)
THEN
PROC_UND_BroodingSovereign_Join((CHARACTER)_Player);

//if he rejoins during LeaveDialog he rejoins the same player
PROC
PROC_GlobalFlagReactionAfterDialog(
    UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210,
    _, _Id)
AND
DB_UND_BroodingSoveign_PrepareLeave_Leader(_Player)
THEN
PROC_UND_BroodingSovereign_Join((CHARACTER)_Player);

PROC
PROC_UND_BroodingSovereign_Join((CHARACTER)_Player)
THEN
AddPartyFollower(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,(CHARACTER)_Player);

PROC 
PROC_UND_BroodingSovereign_Join((CHARACTER)_Player)
AND
NOT DB_UND_BroodingSovereign_Leader((CHARACTER)_Player)
THEN
DB_UND_BroodingSovereign_Leader((CHARACTER)_Player);

PROC
PROC_UND_BroodingSovereign_Join((CHARACTER)_Player)
AND
DB_UND_NecroMushrooms_Corpse(_Corpse,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
NOT DB_PermaDefeated(_Corpse)
THEN
AddPartyFollower(_Corpse,(CHARACTER)_Player);

QRY
QRY_UND_BroodingSovereign_LeaveDialog((DIALOGRESOURCE)_Dialog,(CHARACTER)_Player,(CHARACTER)_Leader)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Player)
AND
QRY_StartDialog_Fixed(_Dialog,(CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_Player)
THEN
DB_UND_BroodingSoveign_PrepareLeave_Leader((CHARACTER)_Leader);

IF
DialogEnded(UND_Myconid_BroodingSovereign_Raft_f6f33683-5889-e6b0-e6a9-0810856ec3ea,_)
AND
DB_UND_BroodingSoveign_PrepareLeave_Leader(_Player)
THEN
NOT DB_UND_BroodingSoveign_PrepareLeave_Leader(_Player);

IF
DialogEnded(UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca,_)
AND
DB_UND_BroodingSoveign_PrepareLeave_Leader(_Player)
THEN
NOT DB_UND_BroodingSoveign_PrepareLeave_Leader(_Player);


QRY
QRY_UND_BroodingSovereign_GoHomeQRY((CHARACTER)_Leader)
THEN
PROC_UND_BroodingSovereign_GoHome(_Leader);

IF
DB_PermaDefeated(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_UND_BroodingSovereign_Leader(_Player)
THEN
PROC_UND_BroodingSovereign_GoHome(_Player);

IF
DB_PermaDefeated(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_UND_NecroMushrooms_Corpse(_Corpse,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
THEN
NOT DB_UND_NecroMushrooms_Corpse(_Corpse,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);

PROC
PROC_GLO_PostReassignFollowerHook(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, (CHARACTER)_OldLeader, (CHARACTER)_NewLeader)
THEN
DB_UND_BroodingSovereign_Leader(_NewLeader); // will replace DB (singleton) and register new leader for triggers
PROC_UND_BroodingSovereign_Triggers(_OldLeader, 0); // manually unregister old leader from triggers

IF
FlagCleared(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210,_,_)
AND
DB_UND_BroodingSovereign_Leader(_Player)
THEN
PROC_UND_BroodingSovereign_GoHome((CHARACTER)_Player);

PROC
PROC_UND_BroodingSovereign_GoHome((CHARACTER)_Player)
THEN
ClearFlag(
    UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210,
    _Player, 0);
NOT DB_UND_BroodingSovereign_Leader(_Player);
PROC_RemovePartyFollower(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);
PROC_UND_BroodingSovereign_Triggers(_Player,0);
ClearFlag(
    (FLAG)UND_MyconidCircle_BroodingSovereign_Event_Leave_60785a26-f4dd-4353-8963-4b44283bb7d3,
    NULL_00000000-0000-0000-0000-000000000000,0);

PROC
PROC_UND_BroodingSovereign_GoHome((CHARACTER)_Player)
AND
DB_UND_NecroMushrooms_Corpse(_Corpse,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
IsPartyMember(_Corpse,1,1)
THEN
PROC_RemovePartyFollower(_Corpse);

IF
DB_UND_BroodingSovereign_Leader(_Player)
THEN
PROC_UND_BroodingSovereign_Triggers(_Player,1);

PROC
PROC_GlobalFlagReactionAfterDialog(
    (FLAG)UND_MyconidCircle_BroodingSovereign_Event_Leave_60785a26-f4dd-4353-8963-4b44283bb7d3)
AND
DB_UND_BroodingSovereign_Leader((CHARACTER)_Player)
THEN
PROC_UND_BroodingSovereign_GoHome(_Player);

IF
EnteredTrigger(_Player,(TRIGGER)S_UND_BroodingSovereign_LeaveAreaLift_602be009-55bb-4b2a-a086-339169e3d4fd)
AND
IsPartyFollower(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,1)
AND
QRY_StartDialog_Fixed(
    (DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca,
    S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,
    _Player)
THEN
DB_NOOP(1);

PROC
PROC_UND_BroodingSovereign_Triggers((CHARACTER)_Player,1) // 0 to unregister, 1 to register
THEN
TriggerRegisterForCharacter(
    S_UND_BroodingSovereign_LeaveAreaLift_602be009-55bb-4b2a-a086-339169e3d4fd,
    _Player);

PROC
PROC_UND_BroodingSovereign_Triggers((CHARACTER)_Player,0) // 0 to unregister, 1 to register
THEN
TriggerUnregisterForCharacter(
    S_UND_BroodingSovereign_LeaveAreaLift_602be009-55bb-4b2a-a086-339169e3d4fd,
    _Player);


PROC
PROC_UND_BroodingSovereign_Triggers((CHARACTER)_Player,1) // 0 to unregister, 1 to register
AND
DB_UND_BroodingSpovereign_FollowingRegions(_Trigger)
THEN
TriggerRegisterForCharacter(
    _Trigger,
    _Player);

PROC
PROC_UND_BroodingSovereign_Triggers((CHARACTER)_Player,0) // 0 to unregister, 1 to register
AND
DB_UND_BroodingSpovereign_FollowingRegions(_Trigger)
THEN
TriggerUnregisterForCharacter(
    _Trigger,
    _Player);
//END_REGION

//REGION Leaving if left in a wrong region
//just in case
IF
LeftTrigger(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_)
AND
DB_UND_BroodingSovereign_Leader((CHARACTER)_Player)
AND
NOT QRY_UND_BroodingSovereign_StillUND(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
THEN
PROC_UND_BroodingSovereign_QuestUpdate_LeftUND(_Player);
PROC_UND_BroodingSovereign_GoHome(_Player);

// Swapping camps case
IF
LeftTrigger(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_)
AND
NOT DB_UND_BroodingSovereign_Leader(_)
AND
DB_UND_BroodingSovereign_WaitingForLeader(_Player)
AND
NOT QRY_UND_BroodingSovereign_StillUND(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
THEN
PROC_UND_BroodingSovereign_QuestUpdate_LeftUND(_Player);
PROC_UND_BroodingSovereign_GoHome(_Player); // shouldnt be needed, but at this point its better to do it anyway
ClearFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41,NULL_00000000-0000-0000-0000-000000000000,0);
NOT DB_UND_BroodingSovereign_WaitingForLeader(_Player);
PROC_BroodingSovereign_TeleportHome();

PROC
PROC_BroodingSovereign_TeleportHome()
AND
DB_UND_BroodingSovereign_Home(_HomePos)
AND
GetDistanceTo(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _HomePos, _Distance)
AND
_Distance > 10.0
AND
GetPosition(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _X, _Y, _Z)
THEN
PlayEffectAtPosition(VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416, _X, _Y, _Z);
TeleportTo(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _HomePos);
PlayEffect(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416);
//END_REGION

//REGION Corpses
IF
UsingSpellOnTarget(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,(CHARACTER)_Corpse,"Target_AnimatingSpores",_,_,_)
THEN
DB_UND_NecroMushrooms_Corpse(_Corpse,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);


IF
DB_UND_NecroMushrooms_Corpse(_Corpse,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210) // making sure that this AD is played only when BroodingMyconid is in the party.
AND
QRY_OnlyOnce("UND_BroodyngSovereign_CorpseAD")
THEN
PROC_TryStartAD(
    (DIALOGRESOURCE)UND_BroodingMyconid_AD_Resurrecting_573eb343-94fc-676e-699b-371c849659a8,
    S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);

IF
EntityEvent((CHARACTER)_Corpse,"UND_NecroMushrooms_Event_CorpseResurrected")
AND
DB_UND_NecroMushrooms_Corpse(_Corpse,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_UND_BroodingSovereign_Leader(_Player)
AND
IsInTrigger(_Player,S_UND_BroodingSovereign_FollowingRegion_fdf3b75f-4488-449d-bced-a936b0590bf1,1)
THEN
AddPartyFollower(_Corpse,_Player);

//Actual resurrections are done in Act1_UND_MyconidCircle_NecroMushrooms to have both Sovereigns revive consistenly
//END_REGION

//REGION first dialog


IF
DialogEnded(UND_MyconidSovereign_934d97d0-922c-7c31-05fe-054bcc630447,_ID)
AND
DB_GlobalFlag((FLAG)UND_MyconidCircle_AcceptedQuest_3aa48080-074b-457d-acbc-fcb970d9912b)
AND
NOT DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_AcceptedHelp_642e8dfe-867b-c408-bf0b-7b2392e44472)
THEN
DB_SpotPlayers(
	(CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,
	"UND_MyconidCircle_BroodingSovereignSpot",
	NULL_00000000-0000-0000-0000-000000000000,
	(FLAG)UND_MyconidCircle_BroodingSovereign_Spoke_b22db7e4-ee0f-4621-a242-c6f5cfbae1ce);


PROC
PROC_SpotPlayers_Spotted(_,"UND_MyconidCircle_BroodingSovereignSpot",_Player)
AND
DB_Players(_Player)
AND
QRY_StartDialog(
	(DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c,
	(CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_Player)
THEN
DB_NOOP(1);

IF
DialogStarted(UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c,_)
THEN
SetFlag(UND_MyconidCircle_BroodingSovereign_Spoke_b22db7e4-ee0f-4621-a242-c6f5cfbae1ce,NULL_00000000-0000-0000-0000-000000000000,0);
//END_REGION

//REGION Reacting to Lone Duergars death

//Regular situation - Gekh dies near his initial position

PROC
PROC_DialogFlagSetup(UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,(CHARACTER)_Player)
AND
DB_GlobalFlag(UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394)
AND
DB_UND_BroodingSovereign_Leader(_Player)
AND
IsInTrigger(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,S_UND_BroodingSovereign_LoneDuergarNoticeArea_1370c6a0-d6e6-4ca7-a64c-fc11829e6138,1)
THEN
SetFlag((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9,NULL_00000000-0000-0000-0000-000000000000,0);

//Edge case for when lone duergar is pulled away


IF
EnteredCombat(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_Guid)
AND
NOT DB_UND_BroodingSovereign_DuergarFight(_Guid)
AND
CombatGetGuidFor(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,_Guid2)
AND 
_Guid==_Guid2
THEN
DB_UND_BroodingSovereign_DuergarFight(_Guid);

IF
EnteredCombat(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,_Guid)
AND
NOT DB_UND_BroodingSovereign_DuergarFight(_Guid)
AND
CombatGetGuidFor(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_Guid2)
AND 
_Guid==_Guid2
THEN
DB_UND_BroodingSovereign_DuergarFight(_Guid);

PROC
PROC_StateSet_Defeated(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18)
AND
CombatGetGuidFor(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,_Guid)
AND
DB_UND_BroodingSovereign_DuergarFight(_Guid)
THEN
DB_UND_BroodingSovereign_DuergarFight_PrepareFlag(_Guid);
NOT DB_UND_BroodingSovereign_DuergarFight(_Guid);

IF
CombatEnded(_Guid)
AND
DB_UND_BroodingSovereign_DuergarFight_PrepareFlag(_Guid)
THEN
NOT DB_UND_BroodingSovereign_DuergarFight_PrepareFlag(_Guid);
SetFlag((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9,NULL_00000000-0000-0000-0000-000000000000,0);

IF
LeftCombat(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_Guid)
AND
DB_UND_BroodingSovereign_DuergarFight(_Guid)
THEN
NOT DB_UND_BroodingSovereign_DuergarFight(_Guid);

IF
LeftCombat(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,_Guid)
AND
DB_UND_BroodingSovereign_DuergarFight(_Guid)
THEN
NOT DB_UND_BroodingSovereign_DuergarFight(_Guid);

IF
FlagSet(UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394,_,_)
AND
GetDistanceTo(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,_dist)
AND
_dist<=20.0
THEN
SetFlag((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9,NULL_00000000-0000-0000-0000-000000000000,0);

IF
Saw((CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,(CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,_)
AND
DB_GlobalFlag(UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394)
THEN
SetFlag((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9,NULL_00000000-0000-0000-0000-000000000000,0);

//edge-case: becomes impossible to show the body to Glut
//TBD: it might be safer to use the trigger S_UND_BroodingSovereign_LoneDuergarNoticeArea_1370c6a0-d6e6-4ca7-a64c-fc11829e6138
	// if LoneDuergar leaves this trigger, then it's 'Can't Reach' and Glut automatically 'sees' it. 
IF
EnteredChasm(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _, _, _, _, _) // reported in #gen-help that we currently don't get this event when a dead character enters a chasm
THEN
SetFlag((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9,NULL_00000000-0000-0000-0000-000000000000,0);
SetFlag(UND_MyconidCircle_BroodingSovereign_State_CantReachDuergar_68069e1d-a9e5-4fdd-8664-22942b1afa96,NULL_00000000-0000-0000-0000-000000000000,0);

PROC
PROC_Surrender_Fled(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18)
THEN
SetFlag((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9,NULL_00000000-0000-0000-0000-000000000000,0);
SetFlag(UND_MyconidCircle_BroodingSovereign_State_CantReachDuergar_68069e1d-a9e5-4fdd-8664-22942b1afa96,NULL_00000000-0000-0000-0000-000000000000,0);

IF
DB_IronFlasked(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18)
THEN
SetFlag((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9,NULL_00000000-0000-0000-0000-000000000000,0);
SetFlag(UND_MyconidCircle_BroodingSovereign_State_CantReachDuergar_68069e1d-a9e5-4fdd-8664-22942b1afa96,NULL_00000000-0000-0000-0000-000000000000,0);

//dialog with glut
IF
FlagSet((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9,_,_)
AND
DB_UND_BroodingSovereign_Leader(_Player)
AND
IsInCombat(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,0)
AND
QRY_OnlyOnce("UND_BroodingSovereign_DuergarDead_Reaction")
THEN
PROC_TryStartAD(UND_BroodingMyconid_AD_DuergarDead_0e3153d0-7539-3e6f-9e8d-c442f877fba6, S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);

IF
LeftCombat(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_)
AND
DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9)
AND
QRY_OnlyOnce("UND_BroodingSovereign_DuergarDead_Reaction")
AND
DB_UND_BroodingSovereign_Leader(_Player)
THEN
PROC_TryStartAD(UND_BroodingMyconid_AD_DuergarDead_0e3153d0-7539-3e6f-9e8d-c442f877fba6, S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);

PROC
PROC_DialogFlagSetup(UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,(CHARACTER)_Player)
AND
DB_GlobalFlag(UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394)
AND
DB_UND_BroodingSovereign_Leader(_Player)
AND
GetDistanceTo(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,_dist)
AND
_dist<=25.0
THEN
SetFlag((FLAG)UND_MyconidCircle_BroodingSovereign_State_SawDuergar_3ed49391-a703-466c-819e-1c1a5c10c6d9,NULL_00000000-0000-0000-0000-000000000000,0);
//END_REGION

//REGION Killing Circle
//Wait until players actually attack circle - otherwise it's confusing
IF
AttackedBy(_Defender,_Player,_,_,_,_,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_Quest_AcceptedCircleWipe_279e0906-6562-4542-9799-8ca79175f2be)
AND
NOT DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8)
AND
DB_UND_MyconidCircle_Myconids((CHARACTER)_Defender)
AND
_Defender != S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46
THEN
SetFaction(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,ACT1_UND_BroodingSovereign_CircleEnemy_60b2534f-a05e-4768-8410-14d988201c5b);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_Myconids_5a3114c3-1a49-4cd8-2b4e-92f536913e30,0);

IF
AttackedBy(_Defender,_Player,_,_,_,_,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_UND_MyconidCircle_DuergarSlaves((CHARACTER)_Defender) 
AND
DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_Quest_AcceptedCircleWipe_279e0906-6562-4542-9799-8ca79175f2be)
AND
NOT DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8)
THEN
SetFaction(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,ACT1_UND_BroodingSovereign_CircleEnemy_60b2534f-a05e-4768-8410-14d988201c5b);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_Myconids_5a3114c3-1a49-4cd8-2b4e-92f536913e30,0);

IF
FlagSet((FLAG)UND_MyconidCircle_Event_CombatWithPlayers_0f8aee24-7971-4de4-9294-9ab91d63bb3c,_,_)
AND
DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_Quest_AcceptedCircleWipe_279e0906-6562-4542-9799-8ca79175f2be)
AND
NOT DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8)
THEN
SetFaction(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,ACT1_UND_BroodingSovereign_CircleEnemy_60b2534f-a05e-4768-8410-14d988201c5b);

// Killing the sovereign
IF
DB_PermaDefeated((CHARACTER)S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265)
AND
NOT DB_PermaDefeated((CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_Quest_AcceptedCircleWipe_279e0906-6562-4542-9799-8ca79175f2be)
AND
DB_InRegion((CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, (TRIGGER)S_UND_MyconidCircle_SUB_4b5cc8fc-88f4-465e-bf82-4c20b055c019)
THEN
SetFlag(UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8,NULL_00000000-0000-0000-0000-000000000000,0);

IF
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8)
THEN
SetFaction(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,(FACTION)ACT1_UND_Myconids_BroodingMyconid_d12b2d24-f7fe-43f6-b267-30082c324400);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_Myconids_5a3114c3-1a49-4cd8-2b4e-92f536913e30,50);
ClearFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8)
AND
NOT DB_PartyMembers(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
QRY_OnlyOnce("UND_BroodingSovereign_CelebrationSpotting_OnlyOnce")
THEN
DB_SpotPlayers((CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, "UND_BroodingSovereign_CelebrationSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

// betraying Glut
PROC
PROC_GlobalFlagReactionAfterDialog(UND_MyconidCircle_BroodingSovereign_Event_BetrayGlut_bc02af6d-dc65-7322-a28c-9e68dc4ea875, UND_MyconidSovereign_934d97d0-922c-7c31-05fe-054bcc630447)
THEN
SetFaction(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,ACT1_UND_BroodingSovereign_CircleEnemy_60b2534f-a05e-4768-8410-14d988201c5b);

IF
BaseFactionChanged(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_,ACT1_UND_BroodingSovereign_CircleEnemy_60b2534f-a05e-4768-8410-14d988201c5b)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_Event_BetrayGlut_bc02af6d-dc65-7322-a28c-9e68dc4ea875)
THEN
PROC_SetRelationToPlayers(ACT1_UND_BroodingSovereign_CircleEnemy_60b2534f-a05e-4768-8410-14d988201c5b,0);

// refuse helping Glut
PROC
PROC_GlobalFlagReactionAfterDialog(UND_BroodingSovereign_State_RefusedCircle_d0237569-b266-24c9-60f8-06eda3131892, UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c)
AND
NOT DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_Event_BetrayGlut_bc02af6d-dc65-7322-a28c-9e68dc4ea875)
THEN
SetFaction(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, Act1_UND_BroodingSovereign_Refused_25b89bcf-68ce-4327-820f-780d714b398f);

PROC
PROC_GlobalFlagReactionAfterDialog(UND_BroodingSovereign_State_RefusedCircle_d0237569-b266-24c9-60f8-06eda3131892, UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c)
AND
DB_UND_BroodingSovereign_Leader(_Player)
THEN
PROC_UND_BroodingSovereign_GoHome(_Player);

PROC
PROC_GlobalFlagReactionAfterDialog(UND_BroodingSovereign_State_RefusedCircle_d0237569-b266-24c9-60f8-06eda3131892, UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c)
AND
DB_UND_BroodingSovereign_WaitingForLeader(_Leader)
THEN
ClearFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41,NULL_00000000-0000-0000-0000-000000000000,0);
NOT DB_UND_BroodingSovereign_WaitingForLeader(_Leader);
//END_REGION

//REGION waypoints and preventing players from leaving und

//prevent players from leaving underdark
//custom dialog for raft
PROC
PROC_BlockUseOfItem(_Player, _Item)
AND
DB_UND_BroodingSovereign_ExitPoints_WithinUnderdark(_Item)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210)
AND
CharacterGetOwner(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Leader)
AND
QRY_UND_BroodingSovereign_NeedsToStopPlayer(_Player,_Leader)
AND
QRY_UND_BroodingSovereign_GoHomeQRY(_Leader)
AND
QRY_UND_BroodingSovereign_LeaveDialog(UND_Myconid_BroodingSovereign_Raft_f6f33683-5889-e6b0-e6a9-0810856ec3ea,_Player,_Leader)
THEN
DB_CustomUseItemResponse(_Player,_Item,0);

//multi-purpose dialog for other cases
PROC
PROC_BlockUseOfItem(_Player,_Item)
AND
DB_UND_BroodingSovereign_ExitPoints(_Item)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210)
AND
CharacterGetOwner(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Leader)
AND
QRY_UND_BroodingSovereign_NeedsToStopPlayer(_Player,_Leader)
AND
QRY_UND_BroodingSovereign_GoHomeQRY(_Leader)
AND
QRY_UND_BroodingSovereign_LeaveDialog(UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca,_Player,_Leader)
THEN
DB_CustomUseItemResponse(_Player,_Item,0);

// If Waypoint user is actually the BroodingSovereign humself, or another one of his Leader's minions.
QRY
QRY_GLO_BlockTeleportToWaypoint(_Player,_Waypoint)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210)
AND
NOT QRY_UND_BroodingSovereign_WaypointInUND(_Waypoint)
AND
CharacterGetOwner(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Leader)
AND
QRY_UND_BroodingSovereign_HimselfOrLeadersMinion(_Player, _Leader)
AND
QRY_UND_BroodingSovereign_NeedsToStopPlayer(NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)_Leader)
AND
QRY_UND_BroodingSovereign_GoHomeQRY(_Leader)
AND
QRY_UND_BroodingSovereign_LeaveDialog(UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca,_Leader,_Leader)
THEN
DB_NOOP(1);

//can't use QRY_REALLY_BlockFastTravel because I want sovereign to teleport around UND, but not out
QRY
QRY_GLO_BlockTeleportToWaypoint(_Player,_Waypoint)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210)
AND
NOT QRY_UND_BroodingSovereign_WaypointInUND(_Waypoint)
AND
CharacterGetOwner(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Leader)
AND
NOT QRY_UND_BroodingSovereign_HimselfOrLeadersMinion(_Player, _Leader)
AND
QRY_UND_BroodingSovereign_NeedsToStopPlayer((CHARACTER)_Player, (CHARACTER)_Leader)
AND
QRY_UND_BroodingSovereign_GoHomeQRY(_Leader)
AND
QRY_UND_BroodingSovereign_LeaveDialog(UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca,_Player,_Leader)
THEN
DB_NOOP(1);

// Teleporting to a new region without Glut being in the party
// we dont need this for WLD_Main_A because the IsInUND check will work there
PROC
PROC_RegionSwapReadyCheckPassed(_Player, _)
AND
DB_UND_BroodingSovereign_WaitingForLeader(_Player)
THEN
PROC_UND_BroodingSovereign_QuestUpdate_LeftUND(_Player);
PROC_UND_BroodingSovereign_GoHome(_Player); // shouldnt be needed, but at this point its better to do it anyway
ClearFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41,NULL_00000000-0000-0000-0000-000000000000,0);
NOT DB_UND_BroodingSovereign_WaitingForLeader(_Player);
PROC_BroodingSovereign_TeleportHome();

// Check to make sure its not himself or his own minion
QRY
QRY_UND_BroodingSovereign_HimselfOrLeadersMinion((CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, (CHARACTER)_Leader)
THEN
DB_NOOP(1);

// If its another of his leader's minions.
QRY
QRY_UND_BroodingSovereign_HimselfOrLeadersMinion((CHARACTER)_Player, (CHARACTER)_GlutLeader)
AND
CharacterGetOwner(_Player, _PlayerLeader)
AND
_GlutLeader == _PlayerLeader
THEN
DB_NOOP(1);


IF
TeleportedToCamp(_Leader)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210)
AND
CharacterGetOwner(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Leader)
THEN
SetFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41,NULL_00000000-0000-0000-0000-000000000000,0);
DB_UND_BroodingSovereign_WaitingForLeader(_Leader);
PROC_UND_BroodingSovereign_GoHome(_Leader);

IF
CharacterLeftParty(_Leader)
AND
DB_UND_BroodingSovereign_WaitingForLeader(_Leader)
THEN
ClearFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41,NULL_00000000-0000-0000-0000-000000000000,0);
NOT DB_UND_BroodingSovereign_WaitingForLeader(_Leader);

IF
DB_PermaDefeated(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_UND_BroodingSovereign_WaitingForLeader(_Leader)
THEN
ClearFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41,NULL_00000000-0000-0000-0000-000000000000,0);
NOT DB_UND_BroodingSovereign_WaitingForLeader(_Leader);

//Re-join after leaving the camp
PROC
PROC_CAMP_LeftCamp(_Player)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41)
AND
DB_UND_BroodingSovereign_WaitingForLeader(_Player)
AND
QRY_UND_BroodingSovereign_StillUND(_Player)
THEN
PROC_UND_BroodingSovereign_AfterCamp_Teleport(_Player);
PROC_UND_BroodingSovereign_Join(_Player);
SetFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210,NULL_00000000-0000-0000-0000-000000000000,0); 

PROC
PROC_UND_BroodingSovereign_AfterCamp_Teleport((CHARACTER)_Player)
AND
GetDistanceTo(_Player,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_dist)
AND
_dist>=10.0
THEN
PlayEffect(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416);
TeleportTo(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_Player,"UND_BroodingSovereign_Event_WaypointTeleport");
PlayEffect(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416);

PROC
PROC_CAMP_LeftCamp(_Player)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41)
AND
DB_UND_BroodingSovereign_WaitingForLeader(_Player)
AND
NOT QRY_UND_BroodingSovereign_StillUND(_Player)
THEN
PROC_UND_BroodingSovereign_QuestUpdate_LeftUND(_Player);

PROC
PROC_CAMP_LeftCamp(_Player)
AND
DB_UND_BroodingSovereign_WaitingForLeader(_Player)
THEN
ClearFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41,NULL_00000000-0000-0000-0000-000000000000,0);
NOT DB_UND_BroodingSovereign_WaitingForLeader(_Player);

QRY
QRY_UND_BroodingSovereign_NeedsToStopPlayer(NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)_BroodingLeader)
THEN
DB_NOOP(1);

QRY
QRY_UND_BroodingSovereign_NeedsToStopPlayer((CHARACTER)_Player, (CHARACTER)_BroodingLeader)
AND
_Player == _BroodingLeader
THEN
DB_NOOP(1);

QRY
QRY_UND_BroodingSovereign_NeedsToStopPlayer((CHARACTER)_Player, (CHARACTER)_BroodingLeader)
AND
_Player != _BroodingLeader
AND
IsInPartyWith(_BroodingLeader, _Player, 1)
AND
InSamePartyGroup(_BroodingLeader, _Player, 1)
THEN
DB_NOOP(1);

//END_REGION

//REGION Quest progression
IF
FlagSet(UND_MyconidCircle_Sovereign_State_PermaDefeated_bcfa3d32-7250-4c44-9eff-fbf30cef2b6e,_,_)
THEN
DB_UND_BroodingSovereign_Home((TRIGGER)S_UND_MyconidCircle_SovereignIdlePoint_304a2732-9882-4084-b7ad-4e38c3b4e989);

IF
DB_UND_BroodingSovereign_Home(_NewHome)
AND
DB_UND_BroodingSovereign_Home(_PrevHome)
AND
_NewHome!=_PrevHome
THEN
SetDualEntityEvent(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _NewHome, "UND_BroodingSovereign_NewHome", 1); //letting anubis know about the new trigger
NOT DB_UND_BroodingSovereign_Home(_PrevHome);

IF
EntityEvent(_,"UND_BroodingSovereign_GetHome")
AND
DB_UND_BroodingSovereign_Home(_NewHome)
THEN
SetDualEntityEvent(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _NewHome, "UND_BroodingSovereign_NewHome", 1); //letting anubis know about the new trigger

PROC
PROC_SpotPlayers_Spotted(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, "UND_BroodingSovereign_CelebrationSpotting", _Player)
AND
QRY_SpeakerIsInDialogRange((CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Player)
AND
QRY_StartDialog(UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_Player)
THEN
DB_NOOP(1);

IF
TextEvent("UND_BroodingSovereign_KillLoneDuergar")
THEN
PROC_UND_BroodingSovereign_Join((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
Die(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);
TeleportTo(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18,"",1,1,1);

IF
TextEvent("Debug_UND_GetGlut")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Player, "Debug_UND_GlutTeleportedToPlayer");

IF
EntityEvent(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, "Debug_UND_GlutTeleportedToPlayer")
AND
GetHostCharacter(_Player)
THEN
PROC_UND_BroodingSovereign_Join((CHARACTER)_Player);

//END_REGION

//REGION post-quest behavior
// He'll be walking around, playing fake revive spell on corpses

IF
TextEvent("UND_BroodingSovereign_AddSpell")
THEN
AddSpell(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,"Target_UND_MyconidSovereign_FakeAnimatingSpores",1,1);

IF
TextEvent("UND_BroodingSovereign_TestPostCircle")
THEN
SetEntityEvent((CHARACTER)S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09,"UND_BroodingSovereign_MyconidCorpse");
SetEntityEvent((CHARACTER)S_UND_MyconidCricle_Corpses_DuergarCorpse_000_ad1c88ec-9f08-405a-9b35-38f0e0b6da15,"UND_BroodingSovereign_MyconidCorpse_OnMushroom");
PROC_GlobalSetFlagAndCache((FLAG)UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8);

IF
TextEvent("UND_BroodingSovereign_TestPostCircle_Big")
AND
DB_UND_MyconidCircle_Myconids(_Myconid)
AND
_Myconid != S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46
THEN
Die(_Myconid,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);


IF
FlagSet(UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8,_,_)
THEN
IterateCharactersAround((TRIGGER)S_UND_BroodingSovereign_Mushroom_21e8275f-5bd9-4bf7-9dd2-0e0704f22067,25.0,"UND_BroodingSovereign_GetMushroomCorpses","UND_BroodingSovereign_GetMushroomCorpses_Done");

IF
EntityEvent((CHARACTER)_Char,"UND_BroodingSovereign_GetMushroomCorpses")
AND
NOT DB_Players(_Char)
AND
_Char != S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265
AND
_Char != S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30
AND
IsPartyMember(_Char,1,0)
AND
DB_PermaDefeated(_Char)
AND
DB_Dead(_Char)
THEN
PROC_BroodingSovereign_SendMyconidCorpseEvent(_Char);

PROC
PROC_BroodingSovereign_SendMyconidCorpseEvent((CHARACTER)_Char)
AND
GetDistanceTo(_Char, S_UND_BroodingSovereign_Mushroom_21e8275f-5bd9-4bf7-9dd2-0e0704f22067, _dist)
AND
_dist > 7.0
THEN
SetDualEntityEvent(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Char, "UND_BroodingSovereign_MyconidCorpse", 1);

PROC
PROC_BroodingSovereign_SendMyconidCorpseEvent((CHARACTER)_Char)
AND
GetDistanceTo(_Char, S_UND_BroodingSovereign_Mushroom_21e8275f-5bd9-4bf7-9dd2-0e0704f22067, _dist)
AND
_dist<=7.0
THEN
SetDualEntityEvent(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Char, "UND_BroodingSovereign_MyconidCorpse_OnMushroom", 1);

//END_REGION

//REGION journal
PROC
PROC_UND_BroodingSovereign_QuestUpdate_LeftUND((CHARACTER)_Player)
AND
GetFlag(UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394, NULL_00000000-0000-0000-0000-000000000000, _BeforeKillingDuergar)
AND
DB_UND_BroodingSovereign_LeftUNDEntries(_BeforeKillingDuergar, _Entry)
THEN
QuestUpdate(_Player, "UND_BroodingSovereign", _Entry);

IF
FlagSet((FLAG)UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394,_,_)
THEN
NOT DB_QuestDef_State_ConditionalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210, "UND_BroodingSovereign", "RefusedThenAccepted", 1, UND_MyconidCircle_State_DeclinedBroodingSovereign_a8d48927-5819-08af-fc29-502c5751e3c9);
NOT DB_QuestDef_State_ConditionalFlag(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210, "UND_BroodingSovereign", "AcceptedJoin", 0, UND_MyconidCircle_State_DeclinedBroodingSovereign_a8d48927-5819-08af-fc29-502c5751e3c9);
DB_QuestDef_State(UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210, "UND_BroodingSovereign", "AcceptedEscort");
DB_QuestDef_State(UND_MyconidCircle_Event_CombatWithPlayers_0f8aee24-7971-4de4-9294-9ab91d63bb3c, "UND_BroodingSovereign", "AttackedCircle");

IF
DB_PermaDefeated((CHARACTER)S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265)
AND
DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_Quest_AcceptedCircleWipe_279e0906-6562-4542-9799-8ca79175f2be)
THEN
QuestUpdate("UND_BroodingSovereign", "KilledCircle");

IF
QuestUpdateUnlocked(_, "UND_BroodingSovereign", _Entry)
AND
DB_UND_BroodingSovereign_CantReachSuspectibleEntries(_Entry)
THEN
DB_UND_BroodingSovereign_PossiblyCantReach(1);

IF
QuestUpdateUnlocked(_, "UND_BroodingSovereign", _Entry)
AND
DB_UND_BroodingSovereign_CantReachSuspectibleEntries(_Entry)
AND
DB_UND_BroodingSovereign_CantReachSuspectibleEntries(_ClearEntry)
THEN
NOT DB_UND_BroodingSovereign_CantReachSuspectibleEntries(_ClearEntry);

IF
DB_UND_BroodingSovereign_PossiblyCantReach(1)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_CantReachDuergar_68069e1d-a9e5-4fdd-8664-22942b1afa96)
THEN
NOT DB_UND_BroodingSovereign_PossiblyCantReach(1);
QuestUpdate("UND_BroodingSovereign", "CantReachDuergar");

IF
EnteredCombat(_Myconid,_id)
AND
NOT DB_UND_MyconidCircleCombat(_id)
AND
DB_UND_MyconidCircle_Myconids((CHARACTER)_Myconid)
AND
_Myconid != S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46
AND
CombatGetInvolvedPlayer(_id,1,_Player)
AND
IsEnemy(_Player,_Myconid,1)
THEN
SetFlag((FLAG)UND_MyconidCircle_Event_CombatWithPlayers_0f8aee24-7971-4de4-9294-9ab91d63bb3c,NULL_00000000-0000-0000-0000-000000000000,0);
DB_UND_MyconidCircleCombat(_id);

IF
CombatEnded(_id)
AND
DB_UND_MyconidCircleCombat(_id)
THEN
NOT DB_UND_MyconidCircleCombat(_id);
ClearFlag((FLAG)UND_MyconidCircle_Event_CombatWithPlayers_0f8aee24-7971-4de4-9294-9ab91d63bb3c,NULL_00000000-0000-0000-0000-000000000000,0);


IF
DB_PermaDefeated(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player,"UND_BroodingSoverign","GlutDead");

//END_REGION

//REGION Debug
IF
FlagSet((FLAG)Debug_Teleport_UND_MyconidCircle_854f7d8a-bd2f-4655-85ee-1e7244f2ed82,_,_)
AND
DB_Players(_Player)
THEN
TeleportTo(_Player,S_Debug_Teleport_UND_MyconidCircle_77d4a413-b784-45d1-92b5-324e52f709a5,"Debug_Teleport_MyconidCircle",1,1,1);
ClearFlag(Debug_Teleport_UND_MyconidCircle_854f7d8a-bd2f-4655-85ee-1e7244f2ed82,NULL_00000000-0000-0000-0000-000000000000,0);

IF
TextEvent("UND_BroodingSovereign_LoneDuergar_KO")
THEN
SetFlag(UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394,
	NULL_00000000-0000-0000-0000-000000000000,0);
PROC_GlobalSetFlagAndCache(UND_MyconidCircle_BroodingSovereign_State_LoneDuergar_IsDead_5f622802-d6d9-48df-8cb2-8b5a3ec573c2);
SetFlag((FLAG)UND_MyconidCircle_AcceptedQuest_3aa48080-074b-457d-acbc-fcb970d9912b,NULL_00000000-0000-0000-0000-000000000000,0);

//END_REGION

//REGION VB after Gluts death

PROC
PROC_GLO_DefeatCounter_AllDead("UND_BroodingSovereign_DefeatCounter_Glut")
AND
DB_GlobalFlag((FLAG)UND_BroodingSovereign_State_RefusedCircle_d0237569-b266-24c9-60f8-06eda3131892)
AND
GetClosestAlivePlayer(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,_Player,_dist)
AND
_dist <=20.0
THEN
StartVoiceBark((VOICEBARKRESOURCE)UND_MyconidCircle_VB_GlutDead_0b731b59-928b-83ac-36ee-68a2ad5d94b2,_Player);

//END_REGION

//REGION Spore Servant doesn't teleport to Brooding Sovereign after a long rest
// Brooding Sovereign leaves the party when we go to camp and joins back when we leave
// It's done in scripting, so we need to add custom scripting for his servant as well
IF
CharacterJoinedParty(_SporeServant)
AND
DB_CMB_SporeServantFollower(_SporeServant, _, (CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
GetDistanceTo(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _SporeServant, _Dist)
AND
_Dist >= 10.0
THEN
PlayEffect(_SporeServant, VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416);
TeleportTo(_SporeServant, S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, "");
PlayEffect(_SporeServant, VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416);
//END_REGION

//REGION
PROC
PROC_LevelBecameUnreachable("WLD_Main_A")
THEN
GoalCompleted;
//END_REGION
EXITSECTION
PROC_RemoveAllDialogEntriesForSpeaker(
     S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);

NOT DB_GlobalFlagReactionAfterDialog(
    (FLAG)UND_MyconidCircle_BroodingSovereign_State_InParty_a2571718-2bbd-48f7-8ea6-d3ef4c5b5210,
    (DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c);

NOT DB_GlobalFlagReactionAfterDialog(
    (FLAG)UND_MyconidCircle_BroodingSovereign_Event_Leave_60785a26-f4dd-4353-8963-4b44283bb7d3,
    (DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca);

NOT DB_GlobalFlagReactionAfterDialog(    
    (FLAG)UND_MyconidCircle_BroodingSovereign_State_PreparingArmy_d21dba46-e9c1-4332-8f97-350bd89dafcd,
    (DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c);

TriggerUnregisterForCharacter(S_UND_BroodingSovereign_FollowingRegion_fdf3b75f-4488-449d-bced-a936b0590bf1,S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46);

SysClear("DB_UND_BroodingSovereign_Home",1);
ENDEXITSECTION
ParentTargetEdge "Act1"
