Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Dialogs
DB_Dialogs(
	(CHARACTER)S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09,
	NULL_00000000-0000-0000-0000-000000000000,
	(DIALOGRESOURCE)UND_SocietyOfBrilliance_Scholar_5e63f803-689e-43b6-60ee-a1eb96800af9);

DB_Dialogs(
	(CHARACTER)S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53,
	NULL_00000000-0000-0000-0000-000000000000,
	(DIALOGRESOURCE)UND_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b);
DB_CustomDialogRange(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 5000);

DB_Inclusion_Object(
	S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53,
	(FLAG)UND_SocietyOfBrilliance_Inclusion_MindFlayer_a37ccbc2-a90f-4d42-9a0e-d2579e5e9504,
	(FLAG)UND_SocietyOfBrilliance_Inclusion_End_MindFlayer_d6f02f19-46b5-46d3-bafc-d26600398724);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_Scholar_5e63f803-689e-43b6-60ee-a1eb96800af9,S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);

DB_Inclusion_Object(
	S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09,
	(FLAG)UND_SocietyOfBrilliance_Inclusion_Scholar_618e55f4-4fbe-499e-8c5c-d40b4f484bfe,
	(FLAG)UND_SocietyOfBrilliance_Inclusion_End_Scholar_49428ecf-c1d1-474b-a16e-60e4757d164c);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_Scholar_5e63f803-689e-43b6-60ee-a1eb96800af9,S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b,S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09);

DB_UND_SocietyOfBrilliance_SummonMFAfterDialogue(0);

// Failing saving throws 
DB_FlagReactionAfterDialog(
	(FLAG)UND_SocietyOfBrilliance_Event_FailedPoisoned_55af4e7e-d11a-5fe3-4f20-ffbe8fb6e29c, 
	(DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b);
DB_FlagReactionAfterDialog(
	(FLAG)UND_SocietyOfBrilliance_Event_FailedDazed_7146883b-ae77-4659-358d-828737bca830, 
	(DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b);
DB_FlagReactionAfterDialog(
	(FLAG)UND_SocietyOfBrilliance_Event_FailedMadness_b9ab3d01-e224-7c5b-4bba-1e2c250e8d2e, 
	(DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b);

DB_FlagReactionAfterDialog(
	(FLAG)UND_SocietyOfBrilliance_Event_UnlockSkill_b2d82eef-aa74-a814-ab9e-3010b2526f51, 
	(DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b);

// The ring
DB_HasItemEvent(S_UND_SocietyOfBrilliance_RingOfMindShielding_000_1274d7b0-63e3-47b8-820d-4ead0e0976c7, (FLAG)UND_SocietyOfBrilliance_State_HasRing_034a892e-1bd6-4d07-9fb2-8d18096f2e73);
DB_GiveItemToEvent(S_UND_SocietyOfBrilliance_RingOfMindShielding_000_1274d7b0-63e3-47b8-820d-4ead0e0976c7, (FLAG)UND_SocietyOfBrilliance_Event_GiveRing_c87a6f39-e2c3-4b4a-9db1-1d95224995b2);

// The mushrooms
DB_HasItemTemplateScriptFlag(1, (DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b, CONS_Mushrooms_SporeTimmask_8e2dd06c-c62f-4235-b0f8-f353c6b1ec9d, 3, 1);
DB_HasItemTemplateScriptFlag(2, (DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b, CONS_Mushrooms_TongueOfMadness_714a8375-9eb4-438d-a191-f5b4b1e86cc3, 3, 1);

DB_UND_SocietyOfBrilliance_MushroomsToFind((ROOT)UNI_UND_SocietyOfBrilliance_TimmaskSpore_8e2dd06c-c62f-4235-b0f8-f353c6b1ec9d, "FoundSpore");
DB_UND_SocietyOfBrilliance_MushroomsToFind((ROOT)UNI_UND_SocietyOfBrilliance_TongueOfMadness_714a8375-9eb4-438d-a191-f5b4b1e86cc3, "FoundTongue");
DB_UND_SocietyOfBrilliance_MushroomsToFind((ROOT)ALCH_Extract_TongueOfMadness_50b5475a-7f63-45d5-8158-6cdc8c6de31c, "MadeExtract");
DB_UND_SocietyOfBrilliance_MushroomsToFind((ROOT)ALCH_Extract_MyconidSpore_Confusion_2ebad980-402d-4178-84dd-e41bb10155ce, "MadeExtract");
DB_UND_SocietyOfBrilliance_MushroomsToFind((ROOT)ALCH_Solution_Elixir_Tadpole_d44a454c-3a09-4b93-b982-79f7ee019703, "MadePotion");

// patched new mushrooms
DB_HasItemTemplateScriptFlag(3, (DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b, ALCH_Extract_MyconidSpore_Confusion_2ebad980-402d-4178-84dd-e41bb10155ce, 3, 1);
DB_HasItemTemplateScriptFlag(4, (DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b, ALCH_Extract_TongueOfMadness_50b5475a-7f63-45d5-8158-6cdc8c6de31c, 3, 1);
DB_HasItemTemplateScriptFlag(5, (DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b, ALCH_Solution_Elixir_Tadpole_d44a454c-3a09-4b93-b982-79f7ee019703, 3, 1);

// Facing
DB_DoNotFaceDialog(S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09, UND_SocietyOfBrilliance_Scholar_AD_37dc83b6-3c81-cf69-d776-a7a48596405a);
DB_DoNotFaceDialog(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, UND_SocietyOfBrilliance_Scholar_AD_37dc83b6-3c81-cf69-d776-a7a48596405a);
//END_REGION Dialogs

//REGION Scene
PROC_SceneDialogOnly("UND_SocietyOfBrilliance_SceneDialogOnly", S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09, S_UND_SocietyOfBrilliance_SceneDialogOnlyTrigger_a7fcd81c-a531-41a0-9088-fed7c99757be);
DB_SceneManager(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, "UND_SocietyOfBrilliance_SceneDialogOnly");
//END_REGION Scene

DB_UND_SocietyOfBrilliance_Members((CHARACTER)S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09, 1);
DB_UND_SocietyOfBrilliance_Members((CHARACTER)S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0);

SetCanTrade(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b);

DB_ItemOwnerShipTriggers("WLD_Main_A", (TRIGGER)S_UND_SocietyOfBrilliance_OwnershipTrigger_976200ce-2916-4e2b-a848-1259b443f12d, (CHARACTER)S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09);
DB_ItemShopTrigger((TRIGGER)S_UND_SocietyOfBrilliance_OwnershipTrigger_976200ce-2916-4e2b-a848-1259b443f12d, (CHARACTER)S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09);

DB_TadpolePower("Target_SurvivalInstinct");
KBSECTION
//REGION Dialogue events flags
IF
FlagSet((FLAG)UND_SocietyOfBrilliance_Event_SummonMindFlayer_cbbdb5c1-ce85-4f17-9a80-f832decd39f9, _, _)
AND
NOT DB_Defeated((CHARACTER)S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53)
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerWasSummoned_890cb41b-8831-4e4d-8fa7-f60958db6bc1)
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerPresent_75f84546-ec41-4e44-b274-dbb1e14be7fb)
AND 
DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0)
THEN
PROC_UND_SocietyOfBrilliance_SummonMF();

IF
FlagSet((FLAG)UND_SocietyOfBrilliance_Event_SummonMindFlayer_cbbdb5c1-ce85-4f17-9a80-f832decd39f9, _, _)
AND
NOT DB_Defeated((CHARACTER)S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53)
AND
NOT DB_Defeated((CHARACTER)S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09)
AND
DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerWasSummoned_890cb41b-8831-4e4d-8fa7-f60958db6bc1)
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerPresent_75f84546-ec41-4e44-b274-dbb1e14be7fb)
AND 
DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0)
THEN
DB_UND_SocietyOfBrilliance_SummonMFAfterDialogue(1);

IF
InstanceDialogChanged(_,(DIALOGRESOURCE)UND_SocietyOfBrilliance_Scholar_5e63f803-689e-43b6-60ee-a1eb96800af9,_,_)
THEN
PROC_SocietyOfBrilliance_Scholar_DialogEndedOrNested();

IF
DialogEnded((DIALOGRESOURCE)UND_SocietyOfBrilliance_Scholar_5e63f803-689e-43b6-60ee-a1eb96800af9, _)
THEN
PROC_SocietyOfBrilliance_Scholar_DialogEndedOrNested();

PROC
PROC_SocietyOfBrilliance_Scholar_DialogEndedOrNested()
AND
DB_UND_SocietyOfBrilliance_SummonMFAfterDialogue(1)
THEN
NOT DB_UND_SocietyOfBrilliance_SummonMFAfterDialogue(1);
PROC_UND_SocietyOfBrilliance_SummonMF();
TimerLaunch("UND_SocietyOfBrilliance_SummonAD_Timer", 1200);

IF
TimerFinished("UND_SocietyOfBrilliance_SummonAD_Timer")
THEN
PROC_TryStartAD(UND_SocietyOfBrilliance_MindFlayer_AD_AfterSummonedAgain_c72c7926-19ff-dac7-24e3-f4d70343549c, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09);

PROC
PROC_UND_SocietyOfBrilliance_SummonMF()
THEN
PROC_UND_SocietyOfBrilliance_TeleportMFIn();
AddSpell((CHARACTER)S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, "Shout_UND_SocietyOfBrilliance_Teleportation", 0, 0);
NOT DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0);
DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1);

PROC
PROC_UND_SocietyOfBrilliance_TeleportMFIn()
AND
DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerWasSummoned_890cb41b-8831-4e4d-8fa7-f60958db6bc1)
THEN
PlayEffect(S_GLO_SocietyOfBrilliance_MindFlayer_BasePos_d81cbad9-87ae-4693-a041-0aa99370ece1, VFX_Script_FairyRing_Teleport_01_4af1c68d-79ee-ced0-4484-8e2b3b1fc95c, "");
TeleportTo(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, S_GLO_SocietyOfBrilliance_MindFlayer_BasePos_d81cbad9-87ae-4693-a041-0aa99370ece1);

PROC
PROC_UND_SocietyOfBrilliance_TeleportMFIn()
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerWasSummoned_890cb41b-8831-4e4d-8fa7-f60958db6bc1)
THEN
PROC_GlobalSetFlagAndCache(UND_SocietyOfBrilliance_State_MindFlayerWasSummoned_890cb41b-8831-4e4d-8fa7-f60958db6bc1);
TeleportTo(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, S_GLO_SocietyOfBrilliance_MindFlayer_TeleportPos_481e8114-6dc0-4856-b9cc-cb9e2bed096d);
LookFromTrigger(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, S_GLO_SocietyOfBrilliance_MindFlayer_TeleportPos_481e8114-6dc0-4856-b9cc-cb9e2bed096d, 0);

PROC
PROC_SocietyOfBrilliance_Scholar_DialogEndedOrNested()
AND
DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerPresent_75f84546-ec41-4e44-b274-dbb1e14be7fb)
AND
DB_CustomDialogRange(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, _CustomRange)
THEN
NOT DB_CustomDialogRange(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, _CustomRange);

IF
FlagSet((FLAG)UND_SocietyOfBrilliance_Event_SummonMindFlayer_cbbdb5c1-ce85-4f17-9a80-f832decd39f9, _Speaker, _DialogueID)
THEN
ClearFlag((FLAG)UND_SocietyOfBrilliance_Event_SummonMindFlayer_cbbdb5c1-ce85-4f17-9a80-f832decd39f9, _Speaker, _DialogueID);

// Enabling trade for Scholar
IF
DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_Scholar_State_AllowedTrading_2d731287-bbd5-4788-80f0-c17f164b8e8e)
THEN
SetCanTrade(S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09, 1);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)_NPC, _Player)
AND
DB_UND_SocietyOfBrilliance_Members(_NPC, 1)
AND
GetFlag(UND_SocietyOfBrilliance_Event_AutoStartMindFlayerDialog_72cccf90-3242-af11-1d65-ae89e3b72073, _Player, 1)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09, _Player)
THEN
DB_SelectedDialog(
	(DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b, 
	(CHARACTER)S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 
	(CHARACTER)S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09, 
	_Player);
//END_REGION Dialogue events flags

//REGION Musrooms
// Timmask Spores
IF
FlagSet(UND_SocietyOfBrilliance_Event_GiveMushrooms_62743a4d-28ee-4da3-a4cf-2347cd08ab24, _Player, _)
AND
NOT DB_UND_SociectyOfBrilliance_GaveMushrooms("Timmask", _)
AND
TemplateGetCountInMagicPockets(UNI_UND_SocietyOfBrilliance_TimmaskSpore_8e2dd06c-c62f-4235-b0f8-f353c6b1ec9d, (CHARACTER)_Player, _Count)
AND
_Count > 0
THEN
DB_UND_SociectyOfBrilliance_GaveMushrooms("Timmask", (ROOT)UNI_UND_SocietyOfBrilliance_TimmaskSpore_8e2dd06c-c62f-4235-b0f8-f353c6b1ec9d);
MagicPocketsMoveToByTemplate(_Player, UNI_UND_SocietyOfBrilliance_TimmaskSpore_8e2dd06c-c62f-4235-b0f8-f353c6b1ec9d, 1, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1, 1);

IF
FlagSet(UND_SocietyOfBrilliance_Event_GiveMushrooms_62743a4d-28ee-4da3-a4cf-2347cd08ab24, _Player, _)
AND
NOT DB_UND_SociectyOfBrilliance_GaveMushrooms("Timmask", _)
AND
TemplateGetCountInMagicPockets(ALCH_Extract_MyconidSpore_Confusion_2ebad980-402d-4178-84dd-e41bb10155ce, (CHARACTER)_Player, _Count)
AND
_Count > 0
THEN
DB_UND_SociectyOfBrilliance_GaveMushrooms("Timmask", (ROOT)ALCH_Extract_MyconidSpore_Confusion_2ebad980-402d-4178-84dd-e41bb10155ce);
MagicPocketsMoveToByTemplate(_Player, ALCH_Extract_MyconidSpore_Confusion_2ebad980-402d-4178-84dd-e41bb10155ce, 1, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1, 1);

// Tongue of Madness
IF
FlagSet(UND_SocietyOfBrilliance_Event_GiveMushrooms_62743a4d-28ee-4da3-a4cf-2347cd08ab24, _Player, _)
AND
NOT DB_UND_SociectyOfBrilliance_GaveMushrooms("Tongue", _)
AND
TemplateGetCountInMagicPockets(UNI_UND_SocietyOfBrilliance_TongueOfMadness_714a8375-9eb4-438d-a191-f5b4b1e86cc3, (CHARACTER)_Player, _Count)
AND
_Count > 0
THEN
DB_UND_SociectyOfBrilliance_GaveMushrooms("Tongue", (ROOT)UNI_UND_SocietyOfBrilliance_TongueOfMadness_714a8375-9eb4-438d-a191-f5b4b1e86cc3);
MagicPocketsMoveToByTemplate(_Player, UNI_UND_SocietyOfBrilliance_TongueOfMadness_714a8375-9eb4-438d-a191-f5b4b1e86cc3, 1, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1, 1);

IF
FlagSet(UND_SocietyOfBrilliance_Event_GiveMushrooms_62743a4d-28ee-4da3-a4cf-2347cd08ab24, _Player, _)
AND
NOT DB_UND_SociectyOfBrilliance_GaveMushrooms("Tongue", _)
AND
TemplateGetCountInMagicPockets(ALCH_Extract_TongueOfMadness_50b5475a-7f63-45d5-8158-6cdc8c6de31c, (CHARACTER)_Player, _Count)
AND
_Count > 0
THEN
DB_UND_SociectyOfBrilliance_GaveMushrooms("Tongue", (ROOT)ALCH_Extract_TongueOfMadness_50b5475a-7f63-45d5-8158-6cdc8c6de31c);
MagicPocketsMoveToByTemplate(_Player, ALCH_Extract_TongueOfMadness_50b5475a-7f63-45d5-8158-6cdc8c6de31c, 1, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1, 1);

// Giving potion
IF
FlagSet((FLAG)UND_SocietyOfBrilliance_Event_GivePotion_e4852fca-36cd-21aa-41ab-fece3a6e6fe5, _Player, _)
AND
NOT DB_UND_SociectyOfBrilliance_GaveMushrooms("Potion", _)
AND
TemplateGetCountInMagicPockets(ALCH_Solution_Elixir_Tadpole_d44a454c-3a09-4b93-b982-79f7ee019703, (CHARACTER)_Player, _Count)
AND
_Count > 0
THEN
DB_UND_SociectyOfBrilliance_GaveMushrooms("Potion", (ROOT)ALCH_Solution_Elixir_Tadpole_d44a454c-3a09-4b93-b982-79f7ee019703);
MagicPocketsMoveToByTemplate(_Player, ALCH_Solution_Elixir_Tadpole_d44a454c-3a09-4b93-b982-79f7ee019703, 1, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1, 1);

// Removing the mushrooms as Omeluum "crafts" the potion - we dont have a fallback support for stealing it or ingredients
IF
TemplateAddedTo(_Template, _Item, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, _)
AND
DB_UND_SociectyOfBrilliance_GaveMushrooms(_Type, _Template)
AND
NOT DB_UND_SociectyOfBrilliance_MindFlayerProcessedIngredient(_Type)
AND
NOT DB_UND_SociectyOfBrilliance_MindFlayerGotIngredient(_Type, (ITEM)_Item)
THEN
DB_UND_SociectyOfBrilliance_MindFlayerGotIngredient(_Type, (ITEM)_Item);

IF
DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_GaveMushrooms_1457288d-4dfb-779f-5d4c-afdffcb79fc3)
AND
DB_UND_SociectyOfBrilliance_MindFlayerGotIngredient(_Type, _Item)
AND
NOT DB_UND_SociectyOfBrilliance_MindFlayerProcessedIngredient(_Type)
THEN
NOT DB_UND_SociectyOfBrilliance_MindFlayerGotIngredient(_Type, _Item);
DB_UND_SociectyOfBrilliance_MindFlayerProcessedIngredient(_Type);
RequestDelete(_Item);
//END_REGION

//REGION Failing saving throws after drinking potion
PROC
PROC_FlagReactionAfterDialog(
	(CHARACTER)_Player, 
	(FLAG)UND_SocietyOfBrilliance_Event_FailedPoisoned_55af4e7e-d11a-5fe3-4f20-ffbe8fb6e29c, 
	(DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b)
AND
DB_Players(_Player)
THEN
ApplyStatus(_Player, "POISONED", 60.0, 1);

PROC
PROC_FlagReactionAfterDialog(
	(CHARACTER)_Player, 
	(FLAG)UND_SocietyOfBrilliance_Event_FailedMadness_b9ab3d01-e224-7c5b-4bba-1e2c250e8d2e, 
	(DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b)
AND
DB_Players(_Player)
THEN
ApplyStatus(_Player, "TONGUE_OF_MADNESS", 30.0, 1);

PROC
PROC_FlagReactionAfterDialog(
	(CHARACTER)_Player, 
	(FLAG)UND_SocietyOfBrilliance_Event_FailedDazed_7146883b-ae77-4659-358d-828737bca830, 
	(DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b)
AND
DB_Players(_Player)
THEN
ApplyStatus(_Player, "UND_SOB_DAZED", 30.0, 1);

IF
FlagSet(UND_SocietyOfBrilliance_Event_FailedDazed_7146883b-ae77-4659-358d-828737bca830, (CHARACTER)_Character, _)
THEN
PROC_ApplyLimitedDamagePercent(_Character, 35.0, "Psychic", _Character);

IF
FlagSet(UND_SocietyOfBrilliance_Event_FailedMadness_b9ab3d01-e224-7c5b-4bba-1e2c250e8d2e, (CHARACTER)_Character, _)
THEN
PROC_ApplyLimitedDamagePercent(_Character, 15.0, "Psychic", _Character);

//END_REGION Failing saving throws after drinking potion

//REGION Learn tadpole skill
PROC
PROC_FlagReactionAfterDialog(
	(CHARACTER)_Player, 
	(FLAG)UND_SocietyOfBrilliance_Event_UnlockSkill_b2d82eef-aa74-a814-ab9e-3010b2526f51, 
	(DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b)
AND
DB_Players(_Player)
THEN
AddSpell(_Player, "Target_SurvivalInstinct", 1, 0);
//END_REGION Learn tadpole skill

//REGION The ring
IF
MovedFromTo(S_UND_SocietyOfBrilliance_RingOfMindShielding_000_1274d7b0-63e3-47b8-820d-4ead0e0976c7, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, _Player, 1)
AND
DB_Players((CHARACTER)_Player)
THEN
SetFlag(UND_SocietyOfBrilliance_Event_SoldRing_b9f9627c-f3c5-8bf5-933e-14ff6c2d199b, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0);

IF
FlagSet(UND_SocietyOfBrilliance_State_HasRing_034a892e-1bd6-4d07-9fb2-8d18096f2e73, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "GLO_Tadpole", "ToldAboutRing", 1)
THEN
QuestUpdate(_Player, "GLO_Tadpole", "GotTheRing");

IF
SubQuestUpdateUnlocked(_, "GLO_Tadpole_SUB_Society", "ToldAboutRing")
AND
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b)
THEN
SetCanTrade(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1);
NOT DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b);

IF
SubQuestUpdateUnlocked(_Player, "GLO_Tadpole_SUB_Society", "ToldAboutRing")
AND
DB_Players((CHARACTER)_Player)
AND
IsInMagicPockets(S_UND_SocietyOfBrilliance_RingOfMindShielding_000_1274d7b0-63e3-47b8-820d-4ead0e0976c7, _Player, 1)
THEN
QuestUpdate(_Player, "GLO_Tadpole", "GotTheRing");
//END_REGION The ring

//REGION Members statuses
IF
FlagSet((FLAG)UND_SocietyOfBrilliance_Scholar_HasMet_7af56c36-784f-2e86-c111-feb28a431f39,_,_)
THEN
SetFlag((FLAG)UND_SocietyOfBrilliance_State_PlayersMetBlurg_493ca853-174a-410a-b93c-a12b8788469c);

IF
DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)UND_SocietyOfBrilliance_State_MindFlayerPresent_75f84546-ec41-4e44-b274-dbb1e14be7fb);

IF
DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0)
THEN
ClearFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerPresent_75f84546-ec41-4e44-b274-dbb1e14be7fb, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_PermaDefeated(_Member)
AND
DB_UND_SocietyOfBrilliance_Members((CHARACTER)_Member, 1)
THEN
NOT DB_UND_SocietyOfBrilliance_Members((CHARACTER)_Member, 1);
DB_UND_SocietyOfBrilliance_Members((CHARACTER)_Member, 0);

IF
KilledBy(_Member, _AttackOwner, _,_)
AND
DB_UND_SocietyOfBrilliance_Members((CHARACTER)_Member, _)
AND
DB_PartyMembers((CHARACTER)_AttackOwner)
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_Hostile_610268dd-8c8e-7492-db38-b37f08c36685)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_UND_SocietyOfBrilliance_e367e82e-d7c3-40ad-ad92-bf59486af503, 0);

IF
RelationChanged((FACTION)ACT1_UND_SocietyOfBrilliance_e367e82e-d7c3-40ad-ad92-bf59486af503, (FACTION)_OtherFaction, _NewRelation, 1)
AND
_NewRelation < 50
AND
DB_Players((CHARACTER)_Player)
AND
GetFaction(_Player, (FACTION)_PlayerFaction)
AND
_OtherFaction == _PlayerFaction
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_Hostile_610268dd-8c8e-7492-db38-b37f08c36685)
THEN
PROC_GlobalSetFlagAndCache(UND_SocietyOfBrilliance_State_Hostile_610268dd-8c8e-7492-db38-b37f08c36685);
//END_REGION Members statuses

//REGION Custom teleportation if in danger
// after the combat 1) if other memeber already teleported
IF
DB_GlobalFlag(UND_SocietyOfBrilliance_State_Retreated_19eb5da8-b26b-470d-bc12-4e7df3ba2b77)
AND
DB_UND_SocietyOfBrilliance_Members((CHARACTER)_Member, 1)
AND
NOT DB_GlobalFlag((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9)
AND
NOT DB_CantAct(_Member)
THEN
UseSpell(_Member, "Shout_UND_SocietyOfBrilliance_Teleportation", _Member);

// after the combat 2) if other member died
IF
DB_PermaDefeated(_Member)
AND
DB_UND_SocietyOfBrilliance_Members((CHARACTER)_Member, _)
AND
NOT DB_GlobalFlag((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9)
AND
DB_UND_SocietyOfBrilliance_Members(_OtherMember, 1)
AND
_OtherMember != _Member
AND
NOT DB_CantAct(_OtherMember)
THEN
UseSpell(_OtherMember, "Shout_UND_SocietyOfBrilliance_Teleportation", _OtherMember);

// if attacked without provoking combat
IF
HitpointsChanged((CHARACTER)_Member, _HPPercent)
AND
DB_UND_SocietyOfBrilliance_Members(_Member, 1)
AND
NOT DB_GlobalFlag((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9)
AND
NOT DB_CantAct(_Member)
AND
_HPPercent < 25.0
THEN
UseSpell(_Member, "Shout_UND_SocietyOfBrilliance_Teleportation", _Member);

IF
CastedSpell(_Member,"Shout_UND_SocietyOfBrilliance_Teleportation",_,_,_)
AND
NOT DB_GlobalFlag((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9)
AND
_Member != NULL_00000000-0000-0000-0000-000000000000
AND
IsCharacter(_Member, 1)
THEN
PROC_UND_SocietyOfBrilliance_Teleportation((CHARACTER)_Member);

PROC
PROC_UND_SocietyOfBrilliance_Teleportation((CHARACTER)_Member)
AND
DB_UND_SocietyOfBrilliance_Members(_Member, 1)
AND
NOT DB_GlobalFlag(UND_SocietyOfBrilliance_State_Retreated_19eb5da8-b26b-470d-bc12-4e7df3ba2b77)
THEN
PROC_GlobalSetFlagAndCache(UND_SocietyOfBrilliance_State_Retreated_19eb5da8-b26b-470d-bc12-4e7df3ba2b77);

PROC
PROC_UND_SocietyOfBrilliance_Teleportation((CHARACTER)_Member)
AND
DB_UND_SocietyOfBrilliance_Members(_Member, 1)
THEN
NOT DB_UND_SocietyOfBrilliance_Members(_Member, 1);
DB_UND_SocietyOfBrilliance_Members(_Member, 0);

PROC
PROC_UND_SocietyOfBrilliance_Teleportation(_)
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_Hostile_610268dd-8c8e-7492-db38-b37f08c36685)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_UND_SocietyOfBrilliance_e367e82e-d7c3-40ad-ad92-bf59486af503, 0);
//END_REGION Custom teleportation if in danger

//REGION After long rest
// Mind Flayer will teleport back away 
PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerPresent_75f84546-ec41-4e44-b274-dbb1e14be7fb)
AND
QuestIsClosed("GLO_Tadpole_SUB_Society", 1)
AND 
DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1)
AND
DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_MindFlayer_State_ConnectionPerformed_804aadb8-783b-4d78-9b41-85030a0ba11e)
THEN
NOT DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1);
DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0);
SetHitpointsPercentage(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 100.0);
PROC_Helper_SafeTeleportTo(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, S_GLO_SocietyOfBrilliance_MindFlayer_OffPos_e8cd240d-7ea1-4edb-8678-e74387375c56);
//END_REGION After long rest

//REGION Journal
IF
TemplateAddedTo(_Template, _, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
DB_UND_SocietyOfBrilliance_MushroomsToFind(_Template, _StepUpdate)
AND
QuestUpdateIsUnlocked(_Player, "GLO_Tadpole", "AskedToFind", 1)
AND
QuestUpdateIsUnlocked(_Player, "GLO_Tadpole", "AskedToDrink", 0)
THEN
QuestUpdate(_Player, "GLO_Tadpole", _StepUpdate);

IF
QuestUpdateUnlocked(_Player, "GLO_Tadpole", "AskedToFind")
AND
QuestUpdateIsUnlocked(_Player, "GLO_Tadpole", "AskedToDrink", 0)
AND
DB_UND_SocietyOfBrilliance_MushroomsToFind(_Template, _StepUpdate)
AND
QRY_ItemTemplateInMagicPockets(_Player, (ITEMROOT)_Template)
THEN
QuestUpdate(_Player, "GLO_Tadpole", _StepUpdate);

IF
TemplateRemovedFrom(_Template, _, _Player)
AND
DB_Players((CHARACTER)_Player)
AND
DB_UND_SocietyOfBrilliance_MushroomsToFind(_Template, _StepUpdate)
AND
_StepUpdate != "MadePotion"
AND
NOT QRY_ItemTemplateInMagicPockets((CHARACTER)_Player, (ITEMROOT)_Template)
AND
QuestUpdateIsUnlocked(_Player, "GLO_Tadpole", "AskedToFind", 1)
AND
QuestUpdateIsUnlocked(_Player, "GLO_Tadpole", "AskedToDrink", 0)
THEN
QuestUpdate(_Player, "GLO_Tadpole", "LostOne");

IF
FlagSet(UND_SocietyOfBrilliance_State_Hostile_610268dd-8c8e-7492-db38-b37f08c36685, _, _)
AND
DB_Players((CHARACTER)_Player)
AND
QuestIsAccepted(_Player, "GLO_Tadpole_SUB_Society", 1)
THEN
QuestUpdate(_Player, "GLO_Tadpole", "Hostile");

IF
FlagSet((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3,_,_)
THEN
PROC_UND_SocietyOfBrilliance_LeftAct();

PROC
PROC_UND_SocietyOfBrilliance_LeftAct()
AND
DB_QuestIsAccepted("GLO_Tadpole_SUB_Society")
THEN
QuestUpdate("GLO_Tadpole", "LeftAct");
QuestUpdate("GLO_Tadpole", "Tadpole_PointOfNoReturn");

IF
DB_Dead(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53)
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_Hostile_610268dd-8c8e-7492-db38-b37f08c36685)
THEN
QuestUpdate("GLO_Tadpole", "Died"); // the journal update specifically mentions "died" atm

IF
DB_PermaDefeated(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53)
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_Hostile_610268dd-8c8e-7492-db38-b37f08c36685)
AND
IsDead(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0)
THEN
QuestUpdate("GLO_Tadpole", "Hostile"); // fallback, as we don't have "defeated" journal update (this is a very rare case anyway)
//END_REGION Additional journal

//REGION Debug
IF
TextEvent("UND_SocietyOfBrilliance_Unsummon")
AND
DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_MindFlayerPresent_75f84546-ec41-4e44-b274-dbb1e14be7fb)
AND 
DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1)
THEN
NOT DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1);
DB_UND_SocietyOfBrilliance_Members(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 0);
PROC_Helper_SafeTeleportTo(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, S_GLO_SocietyOfBrilliance_MindFlayer_OffPos_e8cd240d-7ea1-4edb-8678-e74387375c56);

IF
EntityEvent((CHARACTER)_Member, "UND_SocietyOfBrilliance_Event_Teleportation")
THEN
PROC_UND_SocietyOfBrilliance_Teleportation(_Member);

IF
TextEvent("UND_SocietyOfBrilliance_GiveMushrooms")
AND
GetHostCharacter((CHARACTER)_Player)
THEN
TemplateAddTo(UNI_UND_SocietyOfBrilliance_TimmaskSpore_8e2dd06c-c62f-4235-b0f8-f353c6b1ec9d, _Player, 1);
TemplateAddTo(UNI_UND_SocietyOfBrilliance_ChockingMushroom_714a8375-9eb4-438d-a191-f5b4b1e86cc3, _Player, 1);

IF
TextEvent("UND_SocietyOfBrilliance_CompleteConnection")
AND
GetHostCharacter((CHARACTER)_Player)
THEN
SetFlag((FLAG)UND_SocietyOfBrilliance_Event_SummonMindFlayer_cbbdb5c1-ce85-4f17-9a80-f832decd39f9, _Player, 0);
SetFlag((FLAG)UND_SocietyOfBrilliance_MindFlayer_HasMet_efdc8dc9-43bc-4ab3-8687-17ee10b7d11f, _Player, 0);
SetFlag((FLAG)UND_SocietyOfBrilliance_Scholar_HasMet_7af56c36-784f-2e86-c111-feb28a431f39, _Player, 0);
SetFlag((FLAG)UND_SocietyOfBrilliance_Scholar_State_AskedOurMission_4d5a55a3-6391-bef9-931a-d31799fb1e9a, _Player, 0);
SetFlag((FLAG)UND_SocietyOfBrilliance_AskedAboutExtraction_67659f25-1320-30c7-5ce9-b9c5257bad5e, _Player, 0);
PROC_GlobalSetFlagAndCache((FLAG)UND_SocietyOfBrilliance_MindFlayer_State_ConnectionAsked_bef930cb-d585-04ce-75da-f57cec81674c);
PROC_GlobalSetFlagAndCache((FLAG)UND_SocietyOfBrilliance_MindFlayer_State_ConnectionPerformed_804aadb8-783b-4d78-9b41-85030a0ba11e);
QuestUpdate("GLO_Tadpole", "WokeAtCrash");
QuestUpdate("GLO_Tadpole", "AskedToCheck");
QuestUpdate("GLO_Tadpole", "ToldAboutNullify");
QuestUpdate("GLO_Tadpole", "AskedToFind");
//END_REGION Debug

PROC
PROC_LevelBecameUnreachable("WLD_Main_A")
THEN
PROC_UND_SocietyOfBrilliance_LeftAct();
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
