Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Test Dialog - combining Vlaaktih versions into one file
DB_Inclusion_NPCDialog((DIALOGRESOURCE)TEST_CRE_ChainOfCommand_Vlaakith_Combined_ddbb8a73-d95d-124b-16ef-1d91e4eb687c, (CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)TEST_CRE_ChainOfCommand_Vlaakith_Combined_ddbb8a73-d95d-124b-16ef-1d91e4eb687c, S_CRE_SecurityOfficer01_64445697-2adc-4784-883e-392bae899892);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)TEST_CRE_ChainOfCommand_Vlaakith_Combined_ddbb8a73-d95d-124b-16ef-1d91e4eb687c, S_CRE_SecurityOfficer02_475367c4-aace-4884-af66-16097e2d2119);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)TEST_CRE_ChainOfCommand_Vlaakith_Combined_ddbb8a73-d95d-124b-16ef-1d91e4eb687c, S_CRE_IntelligenceOfficer01_c76d7d19-3d46-44e5-a914-80efc8cac4ea);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)TEST_CRE_ChainOfCommand_Vlaakith_Combined_ddbb8a73-d95d-124b-16ef-1d91e4eb687c, S_CRE_IntelligenceOfficer02_a17c356a-6e0c-4d2f-bcf6-58195d6c9edf);
//END_REGION

//REGION Monastery - Cultists getting captured
DB_CRE_ChainOfCommand_GithGuardsMonastery((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77);
DB_CRE_ChainOfCommand_GithGuardsMonastery((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21);

DB_CRE_ChainOfCommand_Cultists((CHARACTER)S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc);
DB_CRE_ChainOfCommand_Cultists((CHARACTER)S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8);
DB_CRE_ChainOfCommand_Cultists((CHARACTER)S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6);
SetHitpoints(S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6,1);
PROC_SelfHealing_Disable((CHARACTER)S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6);

DB_GLO_CharacterCorpseDialog((CHARACTER)S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6, (DIALOGRESOURCE)CRE_ChainOfCommand_Cultist03_Dead_43c3b807-01f9-6fa1-7c5c-c99867fb4e78);

DB_SceneManager(S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, "CRE_CultistsCapture");
DB_SceneManager(S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21, "CRE_CultistsCapture");
DB_SceneManager(S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc, "CRE_CultistsCapture");
DB_SceneManager(S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8, "CRE_CultistsCapture");
DB_SceneManager(S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6, "CRE_CultistsCapture");
DB_SceneTriggerManager("CRE_CultistsCapture", (TRIGGER)S_CRE_CultistsCaptureSceneManagerBox_027f728a-c8cb-4109-8edb-d37537ae1d69);
DB_SceneAllowAllDisturbances("CRE_CultistsCapture");

//If a player enters any of these triggers, the Gith start leading the cultists inside and the dialog scene will no longer play
DB_CRE_ChainOfCommand_CultistCaptureSkipSceneTriggers((TRIGGER)S_CRE_HiddenEntranceArea_a14398bb-31eb-4c48-8bfc-3ab753e1a9a5);
DB_CRE_ChainOfCommand_CultistCaptureSkipSceneTriggers((TRIGGER)S_CRE_MonasteryChapelArea_953d0b38-cbbe-44fa-a488-0df0eb303f24);

//If a player walks into any of these triggers, the dialog scene will start, unless it has been skipped
DB_CRE_ChainOfCommand_CultistCaptureStartTriggers((TRIGGER)S_CRE_CultistsCapture_CinematicIncludeZone_Main_73ce1fa9-babf-4bf0-bcac-ba6608cd1fc1);

DB_GLO_DefeatCounter(S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6, "CRE_ChainOfCommand_Cultist03_Killed");

PROC_TriggerRegisterForParty((TRIGGER)S_CRE_CultistCaptureProximityZone_e8dabda7-a8f3-499d-a784-98d075d62b1c);

DB_CRE_ChainOfCommand_GithEnteringMovementSpeed("Walk"); //Default movement speed for the Gith when entering the Creche. Can be overriden to Run if the scene is interrupted

DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_MonasteryGuardsStartWalkingDuringDialog_1f2f29ac-171e-4c13-b08d-341f9c1db1df, (DIALOGRESOURCE)CRE_ChainOfCommand_CultistsCapture_48a0ed58-27e9-8208-09cc-82725a497d0f);

DB_CRE_CultistCapture_Walkers((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77);
DB_CRE_CultistCapture_Walkers((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21);
DB_CRE_CultistCapture_Walkers((CHARACTER)S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc);
DB_CRE_CultistCapture_Walkers((CHARACTER)S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8);

DB_GLO_DieFlag((FLAG)CRE_ChainOfCommand_Event_CultistKilled_332e2299-7888-41ee-9569-a953d10ebcb7, (CHARACTER)S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6, DEATHTYPE.Physical,S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77);
//END_REGION

//REGION Creche Upper Level - Captain's Quarters
DB_DefeatedStateFlag(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, (FLAG)CRE_Captain_State_Defeated_893be13f-b4fc-4366-a4be-a5005a94b7ce);

///////////////Setup///////////////
//DB_CRE_ChainOfCommand_PatrollingGuards((CHARACTER)S_CRE_CaptainGuard_ea4643de-cc2c-42f0-949d-4968201ad2c7);
DB_CRE_ChainOfCommand_CaptainsBeasts((CHARACTER)S_CRE_CaptainsBeast01_82736dcd-8648-4795-a296-21aa1bcaf096);
DB_CRE_ChainOfCommand_CaptainsBeasts((CHARACTER)S_CRE_CaptainsBeast02_fcd64862-67ba-4358-9636-09ff9545177a);

DB_DoNotFaceDialog(S_CRE_CaptainsBeast01_82736dcd-8648-4795-a296-21aa1bcaf096, (DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa);
DB_DoNotFaceDialog(S_CRE_CaptainsBeast02_fcd64862-67ba-4358-9636-09ff9545177a, (DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa);
DB_DoNotFaceDialog(S_CRE_CaptainsBeast01_82736dcd-8648-4795-a296-21aa1bcaf096, (DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776);
DB_DoNotFaceDialog(S_CRE_CaptainsBeast02_fcd64862-67ba-4358-9636-09ff9545177a, (DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776);

//Gith Warrior Squad in the captain's office
DB_CRE_ChainOfCommand_GithSquad((CHARACTER)S_CRE_CaptainOfficeSquad01_705a1532-c8f8-40a2-8e9c-92870a482ad6);
DB_CRE_ChainOfCommand_GithSquad((CHARACTER)S_CRE_CaptainOfficeSquad02_f1aa11c8-9354-4f19-8cf8-29be654edbdb);
DB_CRE_ChainOfCommand_GithSquad((CHARACTER)S_CRE_CaptainOfficeSquad03_9c72cc0e-d0a7-4faf-977c-0aa042de48cd);
DB_CRE_ChainOfCommand_GithSquad((CHARACTER)S_CRE_CaptainOfficeSquad04_6b828722-2223-4927-9d7b-4ad487607965);
DB_CRE_ChainOfCommand_GithSquad((CHARACTER)S_CRE_CaptainOfficeSquad05_4fe3950a-f1c5-4d66-a974-97aa026b95b7);

//Placeholder until psionic barrier traps are implemented properly
DB_CRE_CrecheTraps_PsionicBarriers((ITEM)S_CRE_LathanderBarrier_CaptainsOffice_00f4e951-5514-43c7-8e45-4b1f77b2dba7, 
(ITEM)S_CRE_PsionicBarrierPlaceholder_Pipe_Captain_On_c9565fcb-1f02-40d6-9395-caf60c6f61e6, 
(ITEM)S_CRE_PsionicBarrierPlaceholder_Pipe_Captain_Off_59215bfd-1d1a-4262-adbc-065dae3f11d6, 
(ITEM)S_CRE_LathanderBarrier_Captain_VFXPos_f873391f-d751-40da-a3f3-0182baee5d71);
PROC_CRE_CrecheTraps_PsionicBarriers_Deactivate((ITEM)S_CRE_LathanderBarrier_CaptainsOffice_00f4e951-5514-43c7-8e45-4b1f77b2dba7);

DB_SceneManager((CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, "CRE_CaptainsQuarters");
//Captain's pet wolves also added
DB_SceneTriggerManager("CRE_CaptainsQuarters", (TRIGGER)S_CRE_CaptainQuartersSpottingArea_e05acf72-25b6-4cca-93d7-da8790fc9a51);

SetFlag((FLAG)CRE_ChainOfCommand_State_CaptainTalkingToTemplar_0b2b9e15-d9d4-4977-9cb9-bc81c63aa122); //Used for Anubis behaviour

PROC_TriggerRegisterForPlayers((TRIGGER)S_CRE_CaptainDialogTriggerArea_b7218282-a0f0-4e31-8d20-590cfe062ae8);

///////////////Dialog related///////////////
DB_Dialogs(S_CRE_CaptainGuard_ea4643de-cc2c-42f0-949d-4968201ad2c7, (DIALOGRESOURCE)CRE_CaptainGuard_c52f0671-ac21-542d-e232-0ebc78974a36);
DB_Dialogs(S_CRE_CaptainsBeast01_82736dcd-8648-4795-a296-21aa1bcaf096,(DIALOGRESOURCE)CRE_CaptainBeast01_cb4a6641-4d9f-c3f7-0054-6fd40ec28221);
DB_Dialogs(S_CRE_CaptainsBeast02_fcd64862-67ba-4358-9636-09ff9545177a,(DIALOGRESOURCE)CRE_CaptainBeast02_f610fa10-9bfb-07a7-150f-283c398f08ef);
DB_DoNotFaceDialog(S_CRE_CaptainsBeast01_82736dcd-8648-4795-a296-21aa1bcaf096,(DIALOGRESOURCE)CRE_CaptainBeast01_cb4a6641-4d9f-c3f7-0054-6fd40ec28221);
DB_DoNotFaceDialog(S_CRE_CaptainsBeast02_fcd64862-67ba-4358-9636-09ff9545177a,(DIALOGRESOURCE)CRE_CaptainBeast02_f610fa10-9bfb-07a7-150f-283c398f08ef);

DB_Dialogs((CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, (DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776);

///////////////Global flag reactions///////////////
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_TemplarLeavesCaptainDialog_c5263176-8df5-4e8d-a51e-e5bc35715f51,(DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa);

DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_CaptainCombatStarts_8057c0ff-7254-4dd9-a5e3-8782cb45af15,(DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_State_CaptainLeaves_0a9a9f3b-a833-41b2-a182-9bcb16304021,(DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776);

DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_State_CaptainBarrierDeactivated_fdfdbc4d-1713-495e-ad74-e969cfaf2b00,(DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776);
DB_GlobalFlagReactionAfterDialog(CRE_ChainOfCommand_Event_CaptainDeactivatesBarrier_df6f6bd2-63eb-4a96-9f06-2ed06a621a05, (DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_CaptainActivatesBarrier_1eea28d3-8058-4918-a94d-82e0ae57b46b, (DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa);

DB_DialogBlockAttackButton((DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa);
DB_DialogBlockTradeButton((DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa);

DB_DialogBlockTradeButton((DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776);

DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776, (TRIGGER)S_CRE_CaptainQuartersSpottingArea_e05acf72-25b6-4cca-93d7-da8790fc9a51, 1, 0, 0);
PROC_TriggerRegisterForPlayers((TRIGGER)S_CRE_CaptainQuartersSpottingArea_e05acf72-25b6-4cca-93d7-da8790fc9a51);

//Edge case handling - In case the player teleports straight through during Captain-Templar dialog
PROC_TriggerRegisterForPlayers(S_CRE_PastCaptinBarrierDetect_192a2f9e-56d7-45a2-a891-f5f57bc4ab18);
DB_CRE_CaptainsOffice_PassThroughForbidden(1);

DB_CRE_CaptainsOffice_PotentialFighters(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565);
DB_CRE_CaptainsOffice_PotentialFighters(S_CRE_IntelligenceOfficer01_c76d7d19-3d46-44e5-a914-80efc8cac4ea);
DB_CRE_CaptainsOffice_PotentialFighters(S_CRE_CaptainsBeast01_82736dcd-8648-4795-a296-21aa1bcaf096);
DB_CRE_CaptainsOffice_PotentialFighters(S_CRE_CaptainsBeast02_fcd64862-67ba-4358-9636-09ff9545177a);

DB_CombatReact_AD_OnTurn(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, (DIALOGRESOURCE)CRE_ChainOfCommand_AD_SecondTurn_789c3198-ae0c-4760-e257-4a898853c294, 2);
DB_CombatReact_AD_OnTurn(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, (DIALOGRESOURCE)CRE_ChainOfCommand_AD_ThirdTurn_d287ae6a-8e4b-9759-2128-568e6e3886eb, 3);
//END_REGION

//REGION Creche Lower Level - Security Office
DB_GLO_InfernalBox_ValidOwners(S_CRE_TempContainerOfPuzzlebox_6396399c-ce1e-48db-97e2-cbfd40b64dd7);
DB_DangerZone(S_CRE_SecurityOfficeArea_4f8819f5-4898-4db1-b3bd-92d24c51c80f,"CRE_ChainOfCommand_SecurityOffice");
DB_DangerZone(S_CRE_BridgeToSecOffice_3a8c9a1f-d9a8-4892-9717-b4634e0fc563,"CRE_ChainOfCommand_SecurityOffice");
DB_DangerZone(S_CRE_CaptainsQuarters_SUB_db13ba17-5fdf-4684-9c12-d84648d542ab,"CRE_ChainOfCommand_SecurityOffice");

DB_CRE_ChainOfCommand_SecurityOfficers((CHARACTER)S_CRE_SecurityOfficer01_64445697-2adc-4784-883e-392bae899892);
DB_CRE_ChainOfCommand_SecurityOfficers((CHARACTER)S_CRE_SecurityOfficer02_475367c4-aace-4884-af66-16097e2d2119);
/*
DB_CRE_ChainOfCommand_SecurityIntelligenceGuards((CHARACTER)S_CRE_IntelligenceOfficer03_266e49a3-83f8-40aa-baff-5ffe2a1a35db);
DB_CRE_ChainOfCommand_SecurityIntelligenceGuards((CHARACTER)S_CRE_IntelligenceOfficer04_f51854ec-5dbc-4686-bb4a-b2f8b4c5341b);
*/
DB_SceneManager((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, "CRE_SecurityOffice");
DB_SceneManager((CHARACTER)S_CRE_SecurityOfficer01_64445697-2adc-4784-883e-392bae899892, "CRE_SecurityOffice");
DB_SceneManager((CHARACTER)S_CRE_SecurityOfficer02_475367c4-aace-4884-af66-16097e2d2119, "CRE_SecurityOffice");
DB_SceneManager((CHARACTER)S_CRE_IntelligenceOfficer03_266e49a3-83f8-40aa-baff-5ffe2a1a35db, "CRE_SecurityOffice");
DB_SceneManager((CHARACTER)S_CRE_IntelligenceOfficer04_f51854ec-5dbc-4686-bb4a-b2f8b4c5341b, "CRE_SecurityOffice");
DB_SceneTriggerManager("CRE_SecurityOffice", (TRIGGER)S_CRE_SecurityOfficeSpottingArea_de03f3aa-3dd2-4c3b-82f7-40af185a4d23);
DB_SceneAllowAllDisturbances("CRE_SecurityOffice");

//ToDo: update trigger logic for dialog to only trigger on Captain and add other actors if available
SetHasDialog(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, 1);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c,(DIALOGRESOURCE)CRE_ChainOfCommand_SWD_Templar_4be39322-cd68-ab00-460b-06183c6d8bea);

//Templar Dialog NPC inclusions (if they are present)
DB_Inclusion_NPCDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, (CHARACTER)S_CRE_SecurityOfficer01_64445697-2adc-4784-883e-392bae899892);
DB_Inclusion_Object(S_CRE_SecurityOfficer01_64445697-2adc-4784-883e-392bae899892, (FLAG)CRE_ChainOfCommand_SecurityOfficer01_StartInclusion_95e2fc44-12d0-4744-b80b-68cd4741af43, (FLAG)CRE_ChainOfCommand_SecurityOfficer01_EndInclusion_c7de9c3b-44a7-42c5-9acb-1f1bf388f9cc);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, (CHARACTER)S_CRE_SecurityOfficer02_475367c4-aace-4884-af66-16097e2d2119);
DB_Inclusion_Object(S_CRE_SecurityOfficer02_475367c4-aace-4884-af66-16097e2d2119, (FLAG)CRE_ChainOfCommand_SecurityOfficer02_StartInclusion_051b26b4-6fbf-4fa1-b9ac-c57ab842b710, (FLAG)CRE_ChainOfCommand_SecurityOfficer02_EndInclusion_f6a5cc8d-b32b-480e-af73-dac52d712ea1);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, S_CRE_IntelligenceOfficer01_c76d7d19-3d46-44e5-a914-80efc8cac4ea);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, S_CRE_IntelligenceOfficer02_a17c356a-6e0c-4d2f-bcf6-58195d6c9edf);

//Vlaakith Dialog NPC inclusions (if they are present)
DB_Inclusion_NPCDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d, (CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c);
DB_Inclusion_Object(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (FLAG)CRE_ChainOfCommand_Templar_StartInclusion_3225efb3-d256-4666-997b-ece440bcf153, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d, S_CRE_SecurityOfficer01_64445697-2adc-4784-883e-392bae899892);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d, S_CRE_SecurityOfficer02_475367c4-aace-4884-af66-16097e2d2119);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d, S_CRE_IntelligenceOfficer01_c76d7d19-3d46-44e5-a914-80efc8cac4ea);
DB_Inclusion_Object(S_CRE_IntelligenceOfficer01_c76d7d19-3d46-44e5-a914-80efc8cac4ea, (FLAG)CRE_ChainOfCommand_IntelligenceOfficer01_StartInclusion_8dc359b1-38fd-429d-afb0-ffc21b6c962f, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d, S_CRE_IntelligenceOfficer02_a17c356a-6e0c-4d2f-bcf6-58195d6c9edf);
DB_Inclusion_Object(S_CRE_IntelligenceOfficer02_a17c356a-6e0c-4d2f-bcf6-58195d6c9edf, (FLAG)CRE_ChainOfCommand_IntelligenceOfficer02_StartInclusion_234f0a3b-4ccd-4802-a867-2d63a612183c, NULL_00000000-0000-0000-0000-000000000000);

DB_CustomDialogRange((CHARACTER)S_CRE_IntelligenceOfficer03_266e49a3-83f8-40aa-baff-5ffe2a1a35db, 20); //Added since the room is quite big and we want the dialog to trigger when players enter
DB_CustomDialogRange((CHARACTER)S_CRE_IntelligenceOfficer04_f51854ec-5dbc-4686-bb4a-b2f8b4c5341b, 20); //Added since the room is quite big and we want the dialog to trigger when players enter

PROC_TriggerRegisterForParty((TRIGGER)S_CRE_TemplarDialog_MainCinematicIncludeZone_0ffda93f-bbf3-47b0-9fce-ed099c04d45f);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, (TRIGGER)S_CRE_TemplarDialog_MainCinematicIncludeZone_0ffda93f-bbf3-47b0-9fce-ed099c04d45f ,1, 0, 0);

DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_State_SecurityOfficeHostile_04a08ea2-98de-4711-8cd1-9fa6e145a841,(DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_State_SecurityOfficeHostile_04a08ea2-98de-4711-8cd1-9fa6e145a841, (DIALOGRESOURCE)CRE_ChainOfCommand_TemplarStartsFight_ab5ddb04-eece-e8c0-9b5a-69c8ee8534ac);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_State_SecurityOfficeHostile_04a08ea2-98de-4711-8cd1-9fa6e145a841, (DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_State_SecurityOfficeHostile_04a08ea2-98de-4711-8cd1-9fa6e145a841, (DIALOGRESOURCE)CRE_AstralPrison_Entering_a84e5d45-33be-b325-08cf-41acdb848ce2);

DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_EnteredAstralPrisonWithTemplar_cdb2f604-80b0-48f4-bbbc-2835ae89a6f8,(DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856);
DB_FlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_ShowedArtifactToTemplar_14e19375-1dfc-4b50-9f32-732bda87a19c, (DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856);

DB_GlobalFlagReactionAfterDialog((FLAG)CRE_AstralPrison_State_BoxUnlocked_07e04b03-e958-461c-bda9-b4131da6884b, (DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_State_PlanecasterActive_5e5e9cb6-41d8-4a93-942d-3dca4d357561, (DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_VlaakithWish_cbcac30e-421f-4cb3-a715-e5d047306fbc, (DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d);

DB_DialogBlockTradeButton((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)CRE_AstralPrison_Entering_a84e5d45-33be-b325-08cf-41acdb848ce2);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d);
DB_DialogBlockAttackButton((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d);
DB_DialogBlockTradeButton((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d,(TRIGGER)S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_OM_Laezel_AOM_OOM_8a12a3a7-d7bf-4398-8770-ed2d17e257d6, (TRIGGER)S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_OM_Laezel_COM_d2bacdeb-9d4e-af99-8f92-b2e19d1b85aa, (TRIGGER)S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f, 1);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)CRE_ChainOfCommand_TemplarStartsFight_ab5ddb04-eece-e8c0-9b5a-69c8ee8534ac);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Betrayal_OM_Laezel_COM_37646009-a3de-b772-d063-0d85c053ed88,(TRIGGER)S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)CRE_ChainOfCommand_TemplarStartsFight_ab5ddb04-eece-e8c0-9b5a-69c8ee8534ac, (TRIGGER)S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f, 1);

DB_DialogBlockTradeButton((DIALOGRESOURCE)CRE_ChainOfCommand_TemplarStartsFight_ab5ddb04-eece-e8c0-9b5a-69c8ee8534ac);

DB_PermaDefeatedFlag(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (FLAG)CRE_Templar_State_Permadefeated_4d8321fe-ec33-4598-927a-c4fc0812ae3a);
DB_DefeatedStateFlag(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (FLAG)CRE_Templar_State_Defeated_72fed344-b60d-44f3-a895-4bfb3fee7426);
DB_DeadOnceFlag(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (FLAG)CRE_Templar_State_Dead_a9546cba-cbcd-4776-9a5e-09d2f30bb004);

DB_CustomDialogRange(S_GLO_Vlaakith_6b00f9fb-b932-4ac9-8ed8-1ca89dd7d247, 5000);
PROC_TriggerRegisterForPlayers(S_CRE_SecurityOfficeArea_4f8819f5-4898-4db1-b3bd-92d24c51c80f);
SetOnStage(S_CRE_AstralPrisonEntrance_c8295f70-f69a-4a49-961f-309141d98bc0, 0);

DB_CRE_ChainOfCommand_Planecaster((ITEM)S_CRE_SecurtiyOfficePlanecaster_9144098a-c9c7-4425-a99d-d7375069e7b7);

DB_DropMutingStatussesDialog(CRE_ChainOfCommand_TemplarStartsFight_ab5ddb04-eece-e8c0-9b5a-69c8ee8534ac);
DB_DropMutingStatussesDialog(CRE_ChainOfCommand_Betrayal_OM_Laezel_COM_37646009-a3de-b772-d063-0d85c053ed88);

DB_GlobalFlagReactionAfterDialog((FLAG)CRE_AstralPrison_State_AstralPrisonWasEntered_2203e87a-6c7b-4aba-b2e8-e22ed96b9762, (DIALOGRESOURCE)CRE_AstralPrison_Entering_a84e5d45-33be-b325-08cf-41acdb848ce2);

DB_GLO_DefeatCounter(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, "CRE_ChainOfCommand_InquisitorCombat");
DB_GLO_DefeatCounter(S_CRE_IntelligenceOfficer03_266e49a3-83f8-40aa-baff-5ffe2a1a35db, "CRE_ChainOfCommand_InquisitorCombat");
DB_GLO_DefeatCounter(S_CRE_IntelligenceOfficer04_f51854ec-5dbc-4686-bb4a-b2f8b4c5341b, "CRE_ChainOfCommand_InquisitorCombat");
DB_GLO_DefeatCounter(S_CRE_SecurityOfficer01_64445697-2adc-4784-883e-392bae899892, "CRE_ChainOfCommand_InquisitorCombat");
DB_GLO_DefeatCounter(S_CRE_SecurityOfficer02_475367c4-aace-4884-af66-16097e2d2119, "CRE_ChainOfCommand_InquisitorCombat");
//END_REGION

//REGION Inquisitor AD
DB_CRE_ChainOfCommand_TemplarADsPlayed(0);

DB_CombatReact_AD_OnEntered(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarTurnsCreacheHostile_318a7dda-c19e-fbdf-7fb3-ff9887063116);
DB_CombatReact_AD_OnTurn(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarCombatThirdLine_4a94a362-cd9a-8abe-5e8f-e44fa0f39791, 2);
DB_CombatReact_AD_OnTurn(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarCombatSecondLine_7f992f5b-b0b9-1282-ae38-14d0468d9cbf, 3);
DB_CombatReact_AD_OnCast(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarCombatFirstLine_ec898b4b-7313-7758-5346-5bdc7bc2c4ba, "Shout_CRE_GithyankiInquisitor_Mindsteal_Tempest");
//END_REGION

//REGION Inquisitor combat setup
// Add the inquisitor minions (ardents and creche guards) to a DefeatCounter DB
DB_GLO_DefeatCounter(S_CRE_IntelligenceOfficer03_266e49a3-83f8-40aa-baff-5ffe2a1a35db, "CRE_InquisitorCombat_KillCounter_Minion");
DB_GLO_DefeatCounter(S_CRE_IntelligenceOfficer04_f51854ec-5dbc-4686-bb4a-b2f8b4c5341b, "CRE_InquisitorCombat_KillCounter_Minion");
DB_GLO_DefeatCounter(S_CRE_SecurityOfficer01_64445697-2adc-4784-883e-392bae899892, "CRE_InquisitorCombat_KillCounter_Minion");
DB_GLO_DefeatCounter(S_CRE_SecurityOfficer02_475367c4-aace-4884-af66-16097e2d2119, "CRE_InquisitorCombat_KillCounter_Minion");
//END_REGION

//REGION Guards closing doors system
PROC_TriggerRegisterForPlayers(S_CRE_CaptainJustOutsideDoorArea_29a0099a-4d92-4018-aa7c-0ca5ebe27e87);
PROC_TriggerRegisterForPlayers(S_CRE_SecurityOfficeJustOutsideDoorArea_15d77415-84dd-4dca-a446-ed7f755b1070);

DB_CRE_ChainOfCommand_DoorAreas((ITEM)DOOR_GEN_DoubleBig_Metal_A_000_dbe0ccb4-7eeb-4388-88d1-a5571b6f5175, S_CRE_SecurityOfficeJustOutsideDoorArea_15d77415-84dd-4dca-a446-ed7f755b1070);
DB_CRE_ChainOfCommand_DoorAreas((ITEM)S_CRE_CaptainsRoomDoor_4086aa49-b44b-462e-9c4b-8e27bdf3edcb, S_CRE_CaptainJustOutsideDoorArea_29a0099a-4d92-4018-aa7c-0ca5ebe27e87);
//END_REGION

KBSECTION
//REGION Debug commands
IF
TextEvent("cre_gotocaptain")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player, S_CRE_DebugPos_CaptainQuarters_96105be8-e699-48dd-9574-388ee320e8de, "", 1, 1, 1, 1, 1);

IF
TextEvent("cre_captaincombat")
THEN
PROC_CRE_ChainOfCommand_CaptainCombatStart();

IF
TextEvent("cre_setboxtemplar")
THEN
SetFlag(CRE_ChainOfCommand_State_ShowedBoxToTemplar_9c52fb50-caa1-4039-b8df-3d43c9734de7, NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("cre_gotosecurity")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player, S_CRE_DebugPos_SecurityOffice_a3ef5651-deb1-47b3-8700-f23c2a836a57, "", 1, 1, 1, 1, 1);

IF
TextEvent("cre_securitycombat")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player, S_CRE_TemplarHostilePos_34b2a7e6-5743-48d8-aa53-26850a5e3e83, "", 1, 1, 1, 1, 1);
TeleportTo(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, S_CRE_TemplarSecurityOfficePos_4c46984d-d512-4b35-9df9-9c7ed50c49c4, "", 0, 0, 0, 1, 1);
PROC_CRE_ChainOfCommand_StartSecurityOfficeCombat();

IF
TextEvent("cre_officersleave")
THEN
PROC_CRE_ChainOfCommand_OfficersLeave();
SetFlag((FLAG)CRE_ChainOfCommand_Event_OfficersLeave_23e1ccb8-12fd-44f2-bc20-f1ffa1bb6563);

IF
TextEvent("cre_crechehostile")
THEN
PROC_CRE_CrecheHostile();

IF
TextEvent("cre_givepuzzlebox")
AND
GetHostCharacter(_Player)
THEN
SetFlag(GLO_InfernalBox_Event_ForceGiveBox_7addbb64-502f-48aa-9b71-da1b8d6c28eb, _Player, 0);

PROC
PROC_CRE_SkipToInquisitor()
THEN
NOT DB_CRE_CaptainsOffice_PassThroughForbidden(1);
PROC_CRE_ChainOfCommand_TemplarGoesToSecurityOffice();
PROC_SceneOver("CRE_CaptainsQuarters");
SetFlag((FLAG)CRE_ChainOfCommand_State_CaptainBarrierDeactivated_fdfdbc4d-1713-495e-ad74-e969cfaf2b00);
TeleportTo(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, S_CRE_TemplarSecurityOfficePos_4c46984d-d512-4b35-9df9-9c7ed50c49c4);
DB_OnlyOnce("CRE_ChainOfCommand_CaptainsQuarters_DialogStarted");
PROC_CRE_ChainOfCommand_GithSquadLeavesCaptainsOffice();
PROC_SetRelationToPlayers((FACTION)Act1B_CRE_Gith_ba6e076b-44ee-4a20-abee-86a56473bf49, 49);

IF
LevelLoaded("CRE_Main_A")
AND
DB_CRE_SkipToInquisitor(1)
THEN
PROC_CRE_SkipToInquisitor();
//END_REGION

//REGION Helpers
PROC
PROC_CRE_ChainOfCommand_TeleportToAndDie((CHARACTER)_Character, (GUIDSTRING)_TeleportTrigger)
THEN
TeleportTo(_Character, _TeleportTrigger, "", 0, 0, 0, 1, 1);
//Die(_Character, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
PROC_DieImmediate(_Character, DEATHTYPE.Physical, 1);

//Guards closing doors, but avoiding shutting it in the player's face. So if no players are just outside the door close it only then
IF
DB_CRE_ChainOfCommand_GuardClosesDoor(_Guard, _Door)
AND
IsOpened((ITEM)_Door, 1)
AND
DB_CRE_ChainOfCommand_DoorAreas(_Door, _Trigger)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)_Trigger)
THEN
Use((CHARACTER)_Guard, _Door, 1, 1, "");
NOT DB_CRE_ChainOfCommand_GuardClosesDoor(_Guard, _Door);

//If they couldn't close it before because a player was just outside, but that player leaves the area, close it now
IF
LeftTrigger(_, _Trigger)
AND
DB_CRE_ChainOfCommand_DoorAreas(_Door, _Trigger)
AND
DB_CRE_ChainOfCommand_GuardClosesDoor(_Guard, _Door)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)_Trigger)
THEN
Use((CHARACTER)_Guard, (ITEM)_Door, 1, 1, "");
NOT DB_CRE_ChainOfCommand_GuardClosesDoor(_Guard, _Door);
//END_REGION

//REGION Monastery - Cultists getting captured
///////////////Setup///////////////
IF
DB_CRE_ChainOfCommand_CultistCaptureStartTriggers(_Trigger)
THEN
PROC_TriggerRegisterForParty(_Trigger);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)CRE_ChainOfCommand_CultistsCapture_48a0ed58-27e9-8208-09cc-82725a497d0f, _Trigger, 1, 0, 0);

IF
DB_CRE_ChainOfCommand_CultistCaptureSkipSceneTriggers(_Trigger)
THEN
PROC_TriggerRegisterForParty(_Trigger);

IF
DB_CRE_ChainOfCommand_GithGuardsMonastery(_Guard)
THEN
DB_SpotPlayers(_Guard, "CRE_CultistsCapture", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotterIgnoreCantTalk(_Guard, "CRE_CultistsCapture"); //If the guards spot the player during the dialog, the dialog should end and combat would start

///////////////Dialog trigger///////////////
//Dialog starts if player enters any of the triggers
//A flag is set if a character is in the Terrace trigger which the dialog uses to set different greeting nodes
IF
DB_InRegion(_Player, _Trigger)
AND
DB_CRE_ChainOfCommand_CultistCaptureStartTriggers(_Trigger)
AND
DB_Players(_Player)
AND
NOT DB_CantTalk(_Player)
AND
NOT DB_CantTalk(S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77)
AND
NOT DB_CantTalk(S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21)
AND
NOT DB_CantTalk(S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc)
AND
NOT DB_CantTalk(S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8)
AND
NOT DB_CantTalk(S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_StartCultistsCaptureDialog")
AND
QRY_StartDialog((DIALOGRESOURCE)CRE_ChainOfCommand_CultistsCapture_48a0ed58-27e9-8208-09cc-82725a497d0f, 
				(CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, 
				(CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21,
				(CHARACTER)S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc, 
				(CHARACTER)S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8,
				(CHARACTER)S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6,
				_Player)
THEN
DB_NOOP(1);

PROC
PROC_CRE_ChainOfCommand_CultistCaptureScene_ClearFlagsAndTriggers()
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_CRE_CultistsCapture_CinematicIncludeZone_Main_73ce1fa9-babf-4bf0-bcac-ba6608cd1fc1);

IF
DialogEnded(CRE_ChainOfCommand_CultistsCapture_48a0ed58-27e9-8208-09cc-82725a497d0f, _)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_MonasteryGithGoInside")
THEN
PROC_CRE_ChainOfCommand_GithAndCultistsStartTransition();

//After the dialog ends play a party banter VB reacting to the scene
IF
DialogEnded(CRE_ChainOfCommand_CultistsCapture_48a0ed58-27e9-8208-09cc-82725a497d0f, _)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, _Trigger)
AND
DB_CRE_ChainOfCommand_CultistCaptureStartTriggers(_Trigger)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_PlayerBatnerAfterCultistCapture")
THEN
StartVoiceBark((VOICEBARKRESOURCE)CRE_ChainOfCommand_VB_ShouldGoToMainDoor_a030951c-71cf-c74b-1c19-b19a64f2f738, _Player);
PROC_SceneOver("CRE_CultistsCapture");

///////////////Scene interruptions///////////////
PROC
PROC_SceneInterrupted(_, _PartyMember, "CRE_CultistsCapture", _)
AND
DB_PartyMembers(_PartyMember)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_MonasteryGithGoInside")
THEN
PROC_ForceStopDialog(S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77);
PROC_ForceStopDialog(S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21);
NOT DB_CRE_ChainOfCommand_GithEnteringMovementSpeed("Walk");
DB_CRE_ChainOfCommand_GithEnteringMovementSpeed("Run");
PROC_CRE_ChainOfCommand_GithAndCultistsStartTransition();
PROC_SceneOver("CRE_CultistsCapture");

PROC
PROC_SceneInterrupted(_, _PartyMember, "CRE_CultistsCapture", _)
AND
DB_PartyMembers(_PartyMember)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_SceneInterruptedAD")
THEN
RealtimeObjectTimerLaunch(S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, "CRE_ChainOfCommand_SceneInterruptedAD_Delay", 600); //Added since the AD doesn't play otherwise, probably due to combat starting at the same time

IF
ObjectTimerFinished(_Guard, "CRE_ChainOfCommand_CRE_ChainOfCommand_SceneInterruptedAD_Delay")
THEN
PROC_TryStartAD((DIALOGRESOURCE)CRE_ChainOfCommand_AD_CultistsSceneInterrupted_6f189cbb-6a08-b2f8-f968-3cb05429c45e, _Guard);

//If player enters the area behind the locked doors or the hidden creche entrance
IF
DB_InRegion(_Player, _Trigger)
AND
DB_CRE_ChainOfCommand_CultistCaptureSkipSceneTriggers(_Trigger)
AND
NOT DB_DialogName((DIALOGRESOURCE)CRE_ChainOfCommand_CultistsCapture_48a0ed58-27e9-8208-09cc-82725a497d0f, _)
AND
NOT DB_GlobalFlag((FLAG)CRE_ChainOfCommand_Event_MonasteryGuardsStartWalkingDuringDialog_1f2f29ac-171e-4c13-b08d-341f9c1db1df)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_SkipCultistScene")
THEN
PROC_CRE_ChainOfCommand_GithAndCultistsStartTransition();

PROC
PROC_CRE_ChainOfCommand_GithAndCultistsStartTransition()
AND
QRY_OnlyOnce("CRE_CultistCapture_TransitionToInside")
THEN
PROC_CRE_ChainOfCommand_GithAndCultistsStartTransition_Execute();

PROC
PROC_CRE_ChainOfCommand_GithAndCultistsStartTransition_Execute()
THEN
PROC_SceneOver("CRE_CultistsCapture");
PROC_CRE_ChainOfCommand_CultistCaptureScene_ClearFlagsAndTriggers();

PROC
PROC_CRE_ChainOfCommand_GithAndCultistsStartTransition_Execute()
AND
QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)S_CRE_CultistCaptureProximityZone_e8dabda7-a8f3-499d-a784-98d075d62b1c)
THEN
SetFaction((CHARACTER)S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6, (FACTION)Act1B_CRE_CultistEscapee_e93c571e-abe5-4ca9-9062-a9d00041841a);

PROC
PROC_CRE_ChainOfCommand_GithAndCultistsStartTransition_Execute()
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)S_CRE_CultistCaptureProximityZone_e8dabda7-a8f3-499d-a784-98d075d62b1c)
THEN
NOT DB_GLO_DefeatCounter(S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6, "CRE_ChainOfCommand_Cultist03_Killed");
Die(S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6);
PROC_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_Start();

//The flag is set to kill the cultits, she is teleported to the kill location.
IF
FlagSet(CRE_ChainOfCommand_Event_CultistKilled_332e2299-7888-41ee-9569-a953d10ebcb7, _, _)
THEN
TeleportTo(S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6, S_CRE_CultistDieSpot_d317ccab-e8d9-49a9-aadc-3b3f31c0d21a, "CRE_ChainOfCommand_Cultist03_Teleported", 0, 0, 0, 1, 1);

IF
DialogStarted((DIALOGRESOURCE)CRE_ChainOfCommand_CultistsCapture_48a0ed58-27e9-8208-09cc-82725a497d0f, _)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_CRE_MonasteryMainDoor_b50ee98d-848b-45f6-a4cb-335d28092aa7);

///////////////Guards Walk Inside///////////////
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_MonasteryGuardsStartWalkingDuringDialog_1f2f29ac-171e-4c13-b08d-341f9c1db1df)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_MonasteryGithGoInside")
AND
QRY_OnlyOnce("CRE_ChainOfCommand_Cultist03_Dead")
AND
DB_CRE_ChainOfCommand_GithEnteringMovementSpeed(_Speed)
THEN
PROC_CRE_TeleportCultistCapture();
PROC_ItemCloseAndLock((ITEM)S_CRE_MonasteryMainDoor_b50ee98d-848b-45f6-a4cb-335d28092aa7, "CRE_ChainOfCommand_MonasteryGuardKey");
PROC_CharacterMoveTo((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, (TRIGGER)S_CRE_CultistsCaptureGuardsMoveDestinationCreche_721bb357-f845-4b96-98c7-a6e539713db8, _Speed, "CRE_ChainOfCommand_Guard01_EnterCreche");
PROC_Follow((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21, (CHARACTER)S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8);
PROC_Follow((CHARACTER)S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc, (CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77);
PROC_Follow((CHARACTER)S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8, (CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77);
PROC_NotifyWhenReadyToMoveOn(S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, "CRE_CultistCapture_ReadyToAD");

PROC
PROC_CRE_TeleportCultistCapture()
AND
DB_CRE_CultistCapture_Walkers(_Walker)
THEN
TeleportTo(_Walker, S_CRE_CultistCapture_WalkStart_b0a88251-c275-4a8f-a6e5-edaffc9c0f36, "", 0,0,0);

PROC
PROC_GLO_DefeatCounter_AllDefeated("CRE_ChainOfCommand_Cultist03_Killed")
AND
NOT DB_DialogName((DIALOGRESOURCE)CRE_ChainOfCommand_CultistsCapture_48a0ed58-27e9-8208-09cc-82725a497d0f, _)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_Cultist03_Dead")
THEN
PROC_CRE_ChainOfCommand_GithAndCultistsStartWalking();

//ToDo: Make guards react to crimes accordingly
//ToDo: Change this to anubis behaviour and shield it from failing
//This behaviour starts during the final nodes of the CultistsCapture dialog and continues in gameplay. The full behaviour can happen during the dialog.
//The guards and cultists walk in a chain towards the creche. 
//The first guard unlocks the main gates, then they all go inside. 
//The second guard goes to the lever, closes the gates and follows the cultists from behind.
//Once all characters are at the Creche entrance and the dialog is over, they teleport inside.

PROC
PROC_CRE_ChainOfCommand_GithAndCultistsStartWalking()
AND
DB_CRE_ChainOfCommand_GithEnteringMovementSpeed(_Speed)
THEN
PROC_CharacterMoveTo((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, (TRIGGER)S_CRE_CultistsCaptureGuardsMoveDestinationDoor_9f1d7016-b311-46d6-9cff-374a1133d53c, _Speed, "CRE_CultistsCapture_ReachDoor");
PROC_NotifyWhenReadyToMoveOn(S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, "CRE_CultistCapture_ReadyToAD");

PROC
PROC_ReadyToMoveOn(S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, "CRE_CultistCapture_ReadyToAD")
THEN
DB_CRE_ChainOfCommand_GithEscortInProgress(1);
PROC_CRE_ChainOfCommand_PlayGithEscortAD();

PROC
PROC_CRE_ChainOfCommand_PlayGithEscortAD()
AND
DB_CRE_ChainOfCommand_GithEscortInProgress(1)
AND
QRY_StartDialog((DIALOGRESOURCE)CRE_ChainOfCommand_AD_EscortingCultistsChatter_bac703c8-7502-4870-f692-582f8c08f7a9, 
S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc,
S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8,
NULL_00000000-0000-0000-0000-000000000000,
S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77,
S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21)
THEN
DB_NOOP(1);

IF
AutomatedDialogEnded(CRE_ChainOfCommand_AD_EscortingCultistsChatter_bac703c8-7502-4870-f692-582f8c08f7a9, _ID)
AND
DB_CRE_ChainOfCommand_GithEscortInProgress(1)
THEN
TimerLaunch("CRE_ChainOfCommand_EscortingAD_Delay", 3000);

IF
TimerFinished("CRE_ChainOfCommand_EscortingAD_Delay")
AND
DB_CRE_ChainOfCommand_GithEscortInProgress(1)
THEN
PROC_CRE_ChainOfCommand_PlayGithEscortAD();

IF
EntityEvent(_Guard01, "CRE_CultistsCapture_ReachDoor")
AND
DB_CRE_ChainOfCommand_GithEnteringMovementSpeed(_Speed)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_CRE_MonasteryMainDoor_b50ee98d-848b-45f6-a4cb-335d28092aa7);
PROC_CharacterMoveTo((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, (TRIGGER)S_CRE_CultistsCaptureGuardsMoveDestinationCreche_721bb357-f845-4b96-98c7-a6e539713db8, _Speed, "CRE_ChainOfCommand_Guard01_EnterCreche");
PROC_Follow((CHARACTER)S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc, (CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77);
PROC_Follow((CHARACTER)S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8, (CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77);
PROC_CharacterMoveTo((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21, (TRIGGER)S_CRE_MainGateLeverPos_b67dce9e-a3e2-43e7-9c17-0f38b047d9f9, _Speed, "CRE_CultistsCapture_ReachLever");

IF
EntityEvent(_Guard02, "CRE_CultistsCapture_ReachLever")
THEN
PROC_ItemCloseAndLock((ITEM)S_CRE_MonasteryMainDoor_b50ee98d-848b-45f6-a4cb-335d28092aa7, "CRE_ChainOfCommand_MonasteryGuardKey");
PROC_Follow((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21, (CHARACTER)S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8);

IF
EntityEvent((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, "CRE_ChainOfCommand_Guard01_EnterCreche")
AND
NOT DB_DialogName((DIALOGRESOURCE)CRE_ChainOfCommand_CultistsCapture_48a0ed58-27e9-8208-09cc-82725a497d0f, _) //Wait for the cultists dialog to end before teleporting them in
THEN
PROC_SetOnStage(S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, 0);
PROC_CRE_ChainOfCommand_CharacterEntersCreche((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21);
PROC_CRE_ChainOfCommand_CharacterEntersCreche((CHARACTER)S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc);
PROC_CRE_ChainOfCommand_CharacterEntersCreche((CHARACTER)S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8);
NOT DB_CRE_ChainOfCommand_GithEscortInProgress(1);

PROC
PROC_CRE_ChainOfCommand_CharacterEntersCreche((CHARACTER) _Char)
AND
DB_CRE_ChainOfCommand_GithEnteringMovementSpeed(_Speed)
THEN
PROC_ClearStoryMove(_Char);
PROC_StopFollow(_Char);
PROC_CharacterMoveTo(_Char, (TRIGGER)S_CRE_CultistsCaptureGuardsMoveDestinationCreche_721bb357-f845-4b96-98c7-a6e539713db8, _Speed, "CRE_ChainOfCommand_EnterCreche");
DB_CRE_ChainOfCommand_EnterCrecheList((CHARACTER)_Char);

IF
EntityEvent(_Char, "CRE_ChainOfCommand_EnterCreche")
THEN
PROC_SetOnStage(_Char, 0);
NOT DB_CRE_ChainOfCommand_EnterCrecheList((CHARACTER)_Char);
PROC_CRE_ChainOfCommand_EnterCrecheList_CheckRemaining();

PROC
PROC_CRE_ChainOfCommand_EnterCrecheList_CheckRemaining()
AND 
NOT DB_CRE_ChainOfCommand_EnterCrecheList(_)
THEN
PROC_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_Start();

PROC
PROC_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_Start()
AND
DB_CRE_ChainOfCommand_GithGuardsMonastery(_Guard)
THEN
PROC_SpotPlayers_StopSpotting(_Guard, "CRE_ChainOfCommand_CultistsCapture");

//Once the GithGuards enter the creche, they will appear in front of the captain's office when there are no players in the UpperCreche area
PROC
PROC_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_Start()
AND
QRY_OnlyOnce("CRE_ChainOfCommand_CultistsCaptureSceneCompleted")
THEN
SetFaction((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, (FACTION)Act1B_CRE_Gith_QuarterMistress_b097d106-3d22-4582-9e2a-847269236f6a);
SetFaction((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21, (FACTION)Act1B_CRE_Gith_QuarterMistress_b097d106-3d22-4582-9e2a-847269236f6a);
DB_TriggerEvents_AllPartyMembersLeft((TRIGGER)S_CRE_CultistsCaptureLeaveArea_38d10485-f8a4-477c-8245-7606459825c3, "CRE_ChainOfCommand_GuardsAndCultistsGoInside");
DB_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_PendingMove(1);

//ToDo: Also add checks for whether the captain situation is resolved, in which case there should be some variation to this
//They appear immediately if there are no players inside the CultistCaptureLeaveArea
IF
DB_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_PendingMove(1)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger((TRIGGER)S_CRE_CultistsCaptureLeaveArea_38d10485-f8a4-477c-8245-7606459825c3)
THEN
NOT DB_TriggerEvents_AllPartyMembersLeft((TRIGGER)S_CRE_CultistsCaptureLeaveArea_38d10485-f8a4-477c-8245-7606459825c3, "CRE_ChainOfCommand_GuardsAndCultistsGoInside");
PROC_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_Finish();

//If there are players inside, they appear when all players have left the CultistCaptureLeaveArea
IF
EntityEvent(_, "CRE_ChainOfCommand_GuardsAndCultistsGoInside")
AND
DB_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_PendingMove(1)
THEN
PROC_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_Finish();

PROC
PROC_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_Finish()
THEN
SetFlag(CRE_ChainOfCommand_Event_MonasteryGuardsStartWalkingDuringDialog_1f2f29ac-171e-4c13-b08d-341f9c1db1df);
NOT DB_CRE_ChainOfCommand_GithEscortInProgress(1);
SetFlag(CRE_ChainOfCommand_State_GatesSceneCompleted_1f2666fd-f8b1-4a4c-8dc9-1a7e948e00d7, NULL_00000000-0000-0000-0000-000000000000);
PROC_SetOnStage(S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc, 1);
PROC_SetOnStage(S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8, 1);
PROC_CRE_ChainOfCommand_TeleportToAndDie((CHARACTER)S_CRE_Cultist01_58fb7ff5-6eff-4746-ba78-0f143fd251bc, (TRIGGER)S_CRE_DeadCultistCaptainOffice01_f5932644-afb2-40e8-8c36-a2f2d86cfae8);
PROC_CRE_ChainOfCommand_TeleportToAndDie((CHARACTER)S_CRE_Cultist02_700a3d8e-c955-4fbb-9b55-e73053a5acb8, (TRIGGER)S_CRE_DeadCultistCaptainOffice02_04da512d-1c69-4f1a-8f66-4bb7be75182b);
PROC_SetOnStage((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, 1);
PROC_SetOnStage((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21, 1);
PROC_AppearOutOfSightTo((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, S_CRE_GithGuardMonastery01InsidePos_1a9ab130-d35b-41d8-8dbb-4c93bf5dbdeb, S_CRE_MainDoorPassArea_9edb8b4e-4f2d-4255-b4a2-fb4fa3b609fd, "");
PROC_AppearOutOfSightTo((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21, S_CRE_GithGuardMonastery02InsidePos_cc2e9833-8f12-499e-85e9-fba63ab607ee, S_CRE_MainDoorPassArea_9edb8b4e-4f2d-4255-b4a2-fb4fa3b609fd, "");
DB_Dialogs((CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, (DIALOGRESOURCE)CRE_ChainOfCommand_GithGuardMonastery01_ce97afe6-1f6e-92d6-bdf6-2cf9665ee898);
DB_Dialogs((CHARACTER)S_CRE_GithGuardMonastery02_606c0555-d7c3-41a8-9018-14ede3d52e21, (DIALOGRESOURCE)CRE_ChainOfCommand_GithGuardMonastery02_e84a4897-3d76-8c27-018f-bb9ae9f5e553);
NOT DB_CRE_ChainOfCommand_GithAndCultistsGoInsideCreche_PendingMove(1);

///////////////Combat starts///////////////
IF
DB_Is_InCombat(S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77, _Id)
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember, _Id)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_GithCultistsCombatStarted")
THEN
PROC_CRE_ChainOfCommand_StartGithCultistsCombat();

PROC
PROC_CRE_ChainOfCommand_StartGithCultistsCombat()
THEN
SetFlag((FLAG)CRE_ChainOfCommand_State_MonasteryGuardsSpottedPlayer_8e2a2706-873a-471f-88af-1fe46710bc22);
PROC_CRE_CultistsCapture_CultistsRunForIt();

PROC
PROC_CRE_ChainOfCommand_StartGithCultistsCombat()
AND
QRY_OnlyOnce("CRE_ChainOfCommand_SceneInterruptedAD")
THEN
PROC_TryStartAD((DIALOGRESOURCE)CRE_ChainOfCommand_AD_CultistsSceneInterrupted_6f189cbb-6a08-b2f8-f968-3cb05429c45e, (CHARACTER)S_CRE_GithGuardMonastery01_fd348f90-dbc9-41a8-8abc-b6e212e9ff77);

//ToDo: Move this logic to Anubis
//ToDo: Ensure that they can escape even if this triggers when they are inside the monastery with the main doors closed (use lever -> escape)
PROC
PROC_CRE_CultistsCapture_CultistsRunForIt()
AND
DB_CRE_ChainOfCommand_Cultists(_Cultist)
THEN
PROC_ForceStopDialog(_Cultist);
PROC_StopFollow(_Cultist);
PROC_DisappearOutOfSight((CHARACTER)_Cultist, "Run", 1, "");

///////////////Misc///////////////
//Dead body VB
//The trigger gets teleported to the body's position when the cultist dies. He can potentially die in gameplay.
PROC
PROC_StateSet_Defeated((CHARACTER)S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6)
THEN
TeleportTo((TRIGGER)S_CRE_DeadBodyArea_9443ac91-6839-4aa9-bedf-55eddce96382, S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6, "", 0, 0, 0, 0, 1);
PROC_TriggerRegisterForPlayers((TRIGGER)S_CRE_DeadBodyArea_9443ac91-6839-4aa9-bedf-55eddce96382);

IF
DB_InRegion(_Player, (TRIGGER)S_CRE_DeadBodyArea_9443ac91-6839-4aa9-bedf-55eddce96382)
AND
DB_Sees(_Player, (CHARACTER)S_CRE_Cultist03_1953f136-1e57-4cfe-801a-9bde5c5344b6) //In case he's dead near a wall and the players walks close to the other side of it
AND
QRY_OnlyOnce("CRE_DeadCultistVB")
THEN
StartVoiceBark((VOICEBARKRESOURCE)CRE_ChainOfCommand_VB_NearDeadBody_520c9d5c-7ad0-902a-d536-14ca026b034e, _Player);

//END_REGION

//REGION Creche Upper Level - Captain's Quarters
///////////////Setup///////////////
IF
DB_CRE_ChainOfCommand_CaptainsBeasts(_Beast)
THEN
DB_SceneManager(_Beast, "CRE_CaptainsQuarters");

///////////////Captain quarters dialogs///////////////
//Initiate Captain-Templar dialog when a player enters the room
IF
UseFinished(_Player,(ITEM)S_CRE_CaptainsRoomDoor_4086aa49-b44b-462e-9c4b-8e27bdf3edcb, 1)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_CaptainsQuarters_DialogStarted")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa,(CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c,_Player)
THEN
DB_NOOP(1);

IF
DB_InRegion(_Player, (TRIGGER)S_CRE_CaptainDialogTriggerArea_b7218282-a0f0-4e31-8d20-590cfe062ae8)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_CaptainsQuarters_DialogStarted")
AND
QRY_StartDialog((DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa,(CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c,_Player)
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa, _ID)
AND
DB_CRE_ChainOfCommand_GithSquad(_GithSquad)
THEN
PROC_DialogAddSpeakingActor(_ID, _GithSquad);

//Add latecomers to the ongoing captain-templar dialog
IF
DB_InRegion(_Player ,S_CRE_CaptainDialogTriggerArea_b7218282-a0f0-4e31-8d20-590cfe062ae8)
AND
DB_Players(_Player)
AND
DB_DialogName((DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa,_Inst)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
PROC_DialogAddListeningActor(_Inst,_Player);

//Edge case handling - In case the player teleports straight through during Captain-Templar dialog, the creche is turned hostile
//TODO: In polish, replace this with more systemic edge case handling
IF
DialogEnded((DIALOGRESOURCE)CRE_ChainOfCommand_CaptainSpeaksToTemplar_5235a97c-2857-3ba4-aae2-12aeba0a71fa, _)
THEN
NOT DB_CRE_CaptainsOffice_PassThroughForbidden(1);
ClearFlag(CRE_ChainOfCommand_State_CaptainTalkingToTemplar_0b2b9e15-d9d4-4977-9cb9-bc81c63aa122);

IF
DB_InRegion(_Player, S_CRE_PastCaptinBarrierDetect_192a2f9e-56d7-45a2-a891-f5f57bc4ab18)
AND
DB_CRE_CaptainsOffice_PassThroughForbidden(1)
THEN
PROC_ForceStopDialog((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c);
PROC_CRE_CrecheHostile();

IF
AutomatedDialogEnded(CRE_ChainOfCommand_AD_TemplarTurnsCreacheHostile_318a7dda-c19e-fbdf-7fb3-ff9887063116, _)
THEN
PROC_CRE_CrecheHostile();

IF
AutomatedDialogRequestFailed(CRE_ChainOfCommand_AD_TemplarTurnsCreacheHostile_318a7dda-c19e-fbdf-7fb3-ff9887063116, _)
THEN
PROC_CRE_CrecheHostile();

PROC
PROC_StateSet_Defeated(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c)
THEN
PROC_CRE_CrecheHostile();

///////////////Captain spotting///////////////
//After the Captain-Templar dialog, the templar leaves and sets up the barriers
PROC
PROC_GlobalFlagReactionAfterDialog(CRE_ChainOfCommand_Event_TemplarLeavesCaptainDialog_c5263176-8df5-4e8d-a51e-e5bc35715f51)
THEN
PROC_SceneOver("CRE_CaptainsQuarters");
PROC_TryStartAD((DIALOGRESOURCE)CRE_ChainOfCommand_AD_CaptainOrdersToCloseDoor_233fa55b-3c78-582c-a8e3-e14bf6c762af, S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565);
PROC_CRE_ChainOfCommand_TemplarGoesToSecurityOffice();
PROC_CRE_ChainOfCommand_GithSquadLeavesCaptainsOffice();

PROC
PROC_CRE_ChainOfCommand_TemplarGoesToSecurityOffice()
THEN
DB_SpotPlayers((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, "CRE_ChainOfCommand_SecurityOffice", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, "CRE_ChainOfCommand_SecurityOffice", (TRIGGER)S_CRE_SecurityOfficeSpottingArea_de03f3aa-3dd2-4c3b-82f7-40af185a4d23);
PROC_TriggerRegisterForPlayers((TRIGGER)S_CRE_SecurityRoomEntranceArea_a174b833-5179-4931-8b97-8cf2988c5618);
DB_InRegionFlag((TRIGGER)S_CRE_SecurityRoomEntranceArea_a174b833-5179-4931-8b97-8cf2988c5618, (FLAG)CRE_ChainOfCommand_State_PlayerAtSecurityRoomEntrance_527519dd-5ebf-4011-a908-eadf9aaabe12);
PROC_DisappearOutOfSightTo((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, S_CRE_TemplarSecurityOfficePos_4c46984d-d512-4b35-9df9-9c7ed50c49c4, "Walk", 1, "CRE_ChainOfCommand_TemplarInSecurityOffice");

IF
EntityEvent(_Templar, "CRE_ChainOfCommand_TemplarInSecurityOffice")
THEN
TeleportTo((CHARACTER)_Templar, S_CRE_TemplarSecurityOfficePos_4c46984d-d512-4b35-9df9-9c7ed50c49c4, "", 0, 0, 0, 0, 1);
PROC_SetOnStage(_Templar, 1);
DB_OneShot_VoiceBarkTrigger(S_CRE_TemplarCorridorArea_5978a740-4711-46d3-b845-27bcf7e1f123, (VOICEBARKRESOURCE)CRE_ChainOfCommand_VB_OnTheWayToTemplar_377d1a3f-c1f6-864c-6fd9-d034aec9ff8b);

//The Gith squad leaves the Captain's office, goes to the secret entrance of the creche and disappears
//TODO: Move this to Anubis in behaviour pass
PROC
PROC_CRE_ChainOfCommand_GithSquadLeavesCaptainsOffice()
AND
DB_CRE_ChainOfCommand_GithSquad(_Gith)
THEN
CharacterMoveTo(_Gith, S_CRE_SquadExitPoint_a283c0d4-558e-48c9-86d9-b198e4e4b6a1, "Run", "CRE_GithSquadArrivedAtExit");

IF
EntityEvent(_Gith, "CRE_GithSquadArrivedAtExit")
THEN
PROC_SetOnStage(_Gith, 0);

//During the dialog the captain has to walk a short distance, and look at the barrier device
IF
FlagSet((FLAG)CRE_ChainOfCommand_Event_CaptainWalkToBarrierControl_0b31c560-4c1a-4460-943c-557b92dbbe62, _, _)
THEN
CharacterMoveTo((CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, S_CRE_CaptainBackDoorPos_c6ad6b9f-423e-4928-87f6-dc6431bf1fe0, "Walk", "CRE_ChainOfCommand_CaptainAtBarrierToActivate");

IF
EntityEvent(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, "CRE_ChainOfCommand_CaptainAtBarrierToActivate")
THEN
LookAtEntity(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d, 4.0);

//Flag is set in captain dialog to turn barrier on, turn it on after dialog ends
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_CaptainActivatesBarrier_1eea28d3-8058-4918-a94d-82e0ae57b46b)
THEN
PROC_CRE_CrecheTraps_PsionicBarriers_Activate((ITEM)S_CRE_LathanderBarrier_CaptainsOffice_00f4e951-5514-43c7-8e45-4b1f77b2dba7);

//The guard will close the door either when the Captain's AD plays out, or every time the player starts the Captain dialog, if the door is open
IF
AutomatedDialogEnded((DIALOGRESOURCE)CRE_ChainOfCommand_AD_CaptainOrdersToCloseDoor_233fa55b-3c78-582c-a8e3-e14bf6c762af, _)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_GuardClosesDoor")
THEN
DB_CRE_ChainOfCommand_GuardClosesDoor(S_CRE_CaptainGuard_ea4643de-cc2c-42f0-949d-4968201ad2c7, S_CRE_CaptainsRoomDoor_4086aa49-b44b-462e-9c4b-8e27bdf3edcb);

PROC
PROC_StartDialog_AddExtraSpeakers(CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776, _ID)
THEN
PROC_DialogAddSpeakingActorAt(_ID, S_CRE_CaptainsBeast01_82736dcd-8648-4795-a296-21aa1bcaf096,7);
PROC_DialogAddSpeakingActorAt(_ID, S_CRE_CaptainsBeast02_fcd64862-67ba-4358-9636-09ff9545177a,8);

IF
DialogStarted((DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776, _)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_GuardClosesDoor")
THEN
DB_CRE_ChainOfCommand_GuardClosesDoor(S_CRE_CaptainGuard_ea4643de-cc2c-42f0-949d-4968201ad2c7, S_CRE_CaptainsRoomDoor_4086aa49-b44b-462e-9c4b-8e27bdf3edcb);
NOT DB_OnlyOnce("CRE_ChainOfCommand_GuardClosesDoor");

IF
DialogEnded((DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776,_Inst)
AND
NOT DB_DialogRequestFailed((DIALOGRESOURCE)CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776,_Inst)
AND
DB_SpotPlayers_Continuous(_AllSpotters,"CRE_ChainOfCommand_CaptainsQuarters")
THEN
PROC_SpotPlayers_StopSpotting(_AllSpotters,"CRE_ChainOfCommand_CaptainsQuarters");

///////////////Planecaster dialog///////////////
//Player deactivates the barrier
IF
Combined(S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d, S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, _, _, _, _Player, _)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)CRE_ChainOfCommand_BarrierDeviceDialog_10957920-8094-b484-41fe-8f749bda5fd3, S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d, _Player)
THEN
DB_NOOP(1);

IF
Combined(S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d, S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, _, _, _, _Player, _NewKey)
THEN
TeleportTo(_NewKey, S_CRE_CaptainsOffice_KeyInsertedPosition_27b32656-24fd-4932-9e9c-f646c962553c, "", 0, 0, 0, 0, 0);
SetGravity(_NewKey, GRAVITYTYPE.Disabled, NULL_00000000-0000-0000-0000-000000000000);
SetCanPickUp(_NewKey, 0);

IF
Combined(S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d, S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, _, _, _, _Player, _NewKey)
THEN
PROC_CRE_CaptainsOffice_PeacefulResolveIfAlive();
DB_CRE_ChainOfCommand_BlockGithShardCrimeReact(1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CRE_ChainOfCommand_BarrierDeviceDialog_10957920-8094-b484-41fe-8f749bda5fd3, _ID)
AND
QRY_SpeakerIsAvailable(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565)
THEN
PROC_DialogAddSpeakingActorAt(_ID, S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, 3);

//Captain won't start a crime dialog about the key after the barrier has been unlocked 
QRY
QRY_CRIME_BlockRegisterCrime(_, _, S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, _, _CrimeId) 
AND
DB_CRE_ChainOfCommand_BlockGithShardCrimeReact(1)
THEN
DB_NOOP(1);

IF
DB_CRE_ChainOfCommand_BlockGithShardCrimeReact(1)
AND
DB_CRIME_HandlingCrime(_ID, (CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565)
AND
CrimeHasEvidence(_ID, S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, 1)
THEN
PROC_CRIME_StopForAllCriminals(_ID);

//Player interacts with the door device when already deactivated
PROC
PROC_BlockUseOfItem(_Player, (ITEM)S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d)
AND
DB_GlobalFlag((FLAG)CRE_ChainOfCommand_State_CaptainBarrierDeactivated_fdfdbc4d-1713-495e-ad74-e969cfaf2b00)
THEN
DB_CustomUseItemResponse(_Player, (ITEM)S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d, 0);
StartVoiceBark((VOICEBARKRESOURCE)CRE_ChainOfCommand_VB_DoorDeviceInteraction_c664ca47-6548-d7a7-45ad-bf8d5e543298, _Player);

//Player interacts with the device after the barrier *should be* down, but isn't (probably due to the dialog being interrupted
PROC
PROC_BlockUseOfItem(_Player, (ITEM)S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d)
AND
Exists(S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, 0)
AND
IsOnStage(S_CRE_LathanderBarrier_CaptainsOffice_00f4e951-5514-43c7-8e45-4b1f77b2dba7, 1)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)CRE_ChainOfCommand_BarrierDeviceDialog_10957920-8094-b484-41fe-8f749bda5fd3, S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d, _Player)
THEN
DB_CustomUseItemResponse(_Player, (ITEM)S_CRE_CaptainQuartersPlanecaster_Placeholder_042cc28c-cbdd-4fe2-9e65-9f144fef1e3d, 0);

//If the Captain agrees to deactivate the barreir she walks to the barrier to open it.
//TODO: Move this Anubis behaviour
PROC
PROC_GlobalFlagReactionAfterDialog(CRE_ChainOfCommand_Event_CaptainDeactivatesBarrier_df6f6bd2-63eb-4a96-9f06-2ed06a621a05)
AND
NOT QRY_IsInDangerousSurfaceFor(S_CRE_CaptainBackDoorPos_c6ad6b9f-423e-4928-87f6-dc6431bf1fe0, S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565)
THEN
CharacterMoveTo((CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, S_CRE_CaptainBackDoorPos_c6ad6b9f-423e-4928-87f6-dc6431bf1fe0, "Walk", "CRE_ChainOfCommand_CaptainWalkToBarrier");

//When Captain arrives to the back of the room, and still has the key trigger AD and open barrier
IF
EntityEvent((CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, "CRE_ChainOfCommand_CaptainWalkToBarrier")
AND
IsInInventoryOf((ITEM)S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, (CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, 1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)CRE_ChainOfCommand_AD_CaptainSendsPlayerToInquisitior_4b1be372-c9d3-d294-6edc-931969bee354, S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565);
SetFlag((FLAG)CRE_ChainOfCommand_State_CaptainBarrierDeactivated_fdfdbc4d-1713-495e-ad74-e969cfaf2b00, NULL_00000000-0000-0000-0000-000000000000, 0);
TeleportTo(S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, S_CRE_CaptainsOffice_KeyInsertedPosition_27b32656-24fd-4932-9e9c-f646c962553c, "", 0, 0, 0, 0, 0);
SetGravity(S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, GRAVITYTYPE.Disabled, NULL_00000000-0000-0000-0000-000000000000);
SetCanPickUp(S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, 0);
PROC_CRE_CaptainsOffice_PeacefulResolveIfAlive();

PROC
PROC_CRE_CaptainsOffice_PeacefulResolveIfAlive()
AND
DB_CRE_CaptainsOffice_PotentialFighters(_Character)
AND
NOT DB_Defeated(_Character)
THEN
PROC_PeacefulResolve(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565);


//Handling edge case of having stolen the key and then convincing the captain to let you in
IF
EntityEvent((CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, "CRE_ChainOfCommand_CaptainWalkToBarrier")
AND
NOT IsInInventoryOf((ITEM)S_CRE_CaptainBarrierKey_c3270804-062d-4550-8eed-e9bc415cc9f3, (CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, 1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)CRE_ChainOfCommand_AD_CaptainRealizesTheft_6ad4b02b-3975-d455-a279-028d8315e2db, S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565);

IF
AutomatedDialogEnded((DIALOGRESOURCE)CRE_ChainOfCommand_AD_CaptainRealizesTheft_6ad4b02b-3975-d455-a279-028d8315e2db, _)
THEN
PROC_CRE_ChainOfCommand_CaptainCombatStart();

//Flag set from dialogs to deactivate the Barrier
IF
DB_GlobalFlag((FLAG)CRE_ChainOfCommand_State_CaptainBarrierDeactivated_fdfdbc4d-1713-495e-ad74-e969cfaf2b00)
THEN
PROC_CRE_CrecheTraps_PsionicBarriers_Deactivate((ITEM)S_CRE_LathanderBarrier_CaptainsOffice_00f4e951-5514-43c7-8e45-4b1f77b2dba7);

//TODO: React to noticing a sneaking/invisible character turn off the barrier

///////////////Dialog interruption///////////////
PROC
PROC_SceneInterrupted(_, _Player, "CRE_CaptainsQuarters", _Interruption)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Interruption)
THEN
PROC_SceneOver("CRE_CaptainsQuarters");
PROC_ForceStopDialog((CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565);
DB_CRE_ChainOfCommand_CaptainDialogInterrupted(1);

//Added since otherwise two timers try to start at the same time (one from the AD that playes from CaptainCombatStart())
IF
DialogEnded(CRE_ChainOfCommand_Captain_5863baff-1617-644c-b023-efad34c63776, _)
AND
DB_CRE_ChainOfCommand_CaptainDialogInterrupted(1)
THEN
PROC_CRE_ChainOfCommand_CaptainCombatStart();

///////////////Combat starts///////////////
//Debug oe command: "cre_captaincombat"

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_CaptainCombatStarts_8057c0ff-7254-4dd9-a5e3-8782cb45af15)
THEN
PROC_CRE_ChainOfCommand_CaptainCombatStart();

PROC
PROC_CRE_ChainOfCommand_CaptainCombatStart()
THEN
PROC_RemoveDialog((CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565);
PROC_SetRelationToPlayers((FACTION)Act1B_CRE_Gith_CaptainsQuarters_27e5030c-794e-4270-8ad0-de541d9311b6, 0);

IF
TurnStarted(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565)
AND
DB_Is_InCombat(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, _)
AND
NOT DB_CantTalk_IgnoreCombat(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_CaptainCallsGuards")
THEN
PROC_TryStartAD((DIALOGRESOURCE)CRE_ChainOfCommand_AD_CaptainCallsGuards_f85bd7e1-778c-bee7-085e-fa762bf1ad8f, (CHARACTER)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565);

IF
AutomatedDialogEnded(CRE_ChainOfCommand_AD_CaptainCallsGuards_f85bd7e1-778c-bee7-085e-fa762bf1ad8f, _)
AND
NOT DB_PermaDefeated((CHARACTER)S_CRE_CaptainGuard_ea4643de-cc2c-42f0-949d-4968201ad2c7)
THEN
PROC_CharacterMoveTo((CHARACTER)S_CRE_CaptainGuard_ea4643de-cc2c-42f0-949d-4968201ad2c7, (GUIDSTRING)S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, "Run", "");
SetFaction((CHARACTER)S_CRE_CaptainGuard_ea4643de-cc2c-42f0-949d-4968201ad2c7, Act1B_CRE_Gith_CaptainsQuarters_27e5030c-794e-4270-8ad0-de541d9311b6);

//Play VB after defeating the captain
IF
EnteredCombat(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, _CombatID)
THEN
DB_CRE_CaptainCombatID(_CombatID);

IF
CombatEnded(_CombatID)
AND
DB_CRE_CaptainCombatID(_CombatID)
AND
DB_Defeated(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565)
AND
NOT DB_Defeated(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c)
AND
DB_Players(_Player)
AND
QRY_GLO_IsOrWasInCombat(_Player, _CombatID)
AND
QRY_OnlyOnce("CRE_CaptainDeath_ReactionAD")
THEN
StartVoiceBark((VOICEBARKRESOURCE)CRE_ChainOfCommand_VB_DefeatCaptain_b9523166-e6e8-5907-41fa-cec14039cbbb, _Player);

IF
SwitchedCombat(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565, _OldCombatID, _NewCombatID)
AND
DB_CRE_CaptainCombatID(_OldCombatID)
THEN
NOT DB_CRE_CaptainCombatID(_OldCombatID);
DB_CRE_CaptainCombatID(_NewCombatID);
//END_REGION

//REGION Creche Lower Level - Security Office
//Triggering Templar Dialog - Priority: User Avatar -> Orphaned User Laezel Companion -> Other Orphaned Companion
//Start on user's avatar
QRY
QRY_SelectCustomDialog(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (CHARACTER)_Player)
AND
QRY_GetClosestAvailableCharacterTo(_Player, 0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar, _Player, _Dist, 1)
AND
_Dist <= 15.0
AND
QRY_SameUser(_Player, _ClosestAvatar)
AND
NOT DB_OnlyOnce("CRE_ChainOfCommand_Templar_LaezelOM")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, _ClosestAvatar)
THEN
DB_OnlyOnce("CRE_ChainOfCommand_Templar_LaezelOM");
DB_Dialogs(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856); //Adds the Templar dialog on him for HasMets that no longer need custom triggering logic

//Start on user's Laezel companion
QRY
QRY_SelectCustomDialog(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (CHARACTER)_Player)
AND
DB_Players(_LaezelCompanion)
AND
NOT DB_Avatars(_LaezelCompanion)
AND
IsTagged(_LaezelCompanion, (TAG)REALLY_LAEZEL_b5682d1d-c395-489c-9675-1f9b0c328ea5, 1)
AND
QRY_SameUser(_Player, _LaezelCompanion)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_LaezelCompanion, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c)
AND
NOT DB_OnlyOnce("CRE_ChainOfCommand_Templar_LaezelOM")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, _LaezelCompanion)
THEN
DB_OnlyOnce("CRE_ChainOfCommand_Templar_LaezelOM");
DB_Dialogs(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856); //Adds the Templar dialog on him for HasMets that no longer need custom triggering logic

//Start on whoever clicked on the Templar
QRY
QRY_SelectCustomDialog(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (CHARACTER)_Player)
AND
NOT DB_OnlyOnce("CRE_ChainOfCommand_Templar_LaezelOM")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, _Player)
THEN
DB_OnlyOnce("CRE_ChainOfCommand_Templar_LaezelOM");
DB_Dialogs(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856); //Adds the Templar dialog on him for HasMets that no longer need custom triggering logic

//Once the battle with the templar starts, the situation with him should be treated as resolved.
//Whether the player picks up the Key and unlocks the prison is tracked in the AstralPrison situation
IF
EnteredCombat(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, _)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_TemplarBattleStarted")
THEN
PROC_CRE_ChainOfCommand_TemplarResolved(); 

PROC
PROC_CRE_ChainOfCommand_TemplarResolved()
AND
NOT DB_GlobalFlag((FLAG)CRE_ChainOfCommand_State_TemplarResolved_c6eea22b-b5dc-4797-b202-9a6f5ab18100)
THEN
SetFlag((FLAG)CRE_ChainOfCommand_State_TemplarResolved_c6eea22b-b5dc-4797-b202-9a6f5ab18100);
//Journal update

///////////////Dialog trigger///////////////
//If player is spotted sneaking around, the Templar AD starts
PROC
PROC_SpotPlayers_Spotted(_, "CRE_ChainOfCommand_SecurityOffice", _)
THEN
PROC_TryStartAD((DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarGreeting_4fd15927-7600-9f7a-5c9b-1fd469af9dee,S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c);
DB_CRE_ChainOfCommand_GuardClosesDoor(S_CRE_SecurityOfficer01_64445697-2adc-4784-883e-392bae899892, DOOR_GEN_DoubleBig_Metal_A_000_dbe0ccb4-7eeb-4388-88d1-a5571b6f5175);

//Counting the number of ADs the Templar has played
IF
AutomatedDialogEnded((DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarGreeting_4fd15927-7600-9f7a-5c9b-1fd469af9dee, _)
AND
DB_CRE_ChainOfCommand_TemplarADsPlayed(_NumOfADs)
AND
IntegerSum(_NumOfADs, 1, _NewNumOfADs)
THEN
NOT DB_CRE_ChainOfCommand_TemplarADsPlayed(_NumOfADs);
DB_CRE_ChainOfCommand_TemplarADsPlayed(_NewNumOfADs);

//If the Templar hasn't played 3 ADs, start countdown to next AD
IF
AutomatedDialogEnded((DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarGreeting_4fd15927-7600-9f7a-5c9b-1fd469af9dee, _)
AND
NOT DB_CRE_ChainOfCommand_TemplarADsPlayed(3)
THEN
ObjectTimerLaunch(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, "CRE_ChainOfCommand_TemplarADRepeatTimer", 10000, 1);

//When the timer is finished, restart the spotting logic that will start the AD next time the Templar spots the player
IF
ObjectTimerFinished(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, "CRE_ChainOfCommand_TemplarADRepeatTimer")
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, "CRE_ChainOfCommand_SecurityOffice");

IF
DialogStarted((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, _)
THEN
ObjectTimerCancel(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, "CRE_ChainOfCommand_TemplarADRepeatTimer");
PROC_RemoveOneShotVoiceBarkTrigger(S_CRE_TemplarCorridorArea_5978a740-4711-46d3-b845-27bcf7e1f123, (VOICEBARKRESOURCE)CRE_ChainOfCommand_VB_OnTheWayToTemplar_377d1a3f-c1f6-864c-6fd9-d034aec9ff8b);

///////////////Dialog interruptions///////////////

//If scene is interrupted by a violent interruption, the room will become permanently hostile as they have been compromised
PROC
PROC_SceneInterrupted(_, _, "CRE_SecurityOffice", _Interruption)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Interruption)
THEN
PROC_SceneOver("CRE_SecurityOffice");
PROC_CRE_ChainOfCommand_StartSecurityOfficeCombat();

PROC
PROC_SceneInterrupted(_, _, "CRE_SecurityOffice", _Interruption)
THEN
ObjectTimerCancel(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, "CRE_ChainOfCommand_TemplarADRepeatTimer");

///////////////Turning the Creche hostile///////////////
PROC
PROC_CRE_CrecheHostile()
THEN
PROC_CRE_BattleStations();
PROC_SetRelationToPlayers((FACTION)Act1B_CRE_Gith_ba6e076b-44ee-4a20-abee-86a56473bf49, 0);
SetFlag((FLAG)CRE_General_State_CrecheTurnedHostile_e183e7dc-c07a-4093-91dc-7814375c9582);
//PROC_DangerZone_Safe("CRE_ChainOfCommand_SecurityOffice"); //Might re-enable if the current configuration doesn't work out.

///////////////Dialog outcome: fight///////////////
//Debug oe command: "cre_securitycombat"
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_State_SecurityOfficeHostile_04a08ea2-98de-4711-8cd1-9fa6e145a841, _, _Id)
THEN
PROC_CRE_ChainOfCommand_StartSecurityOfficeCombat();

PROC
PROC_CRE_ChainOfCommand_StartSecurityOfficeCombat()
THEN
PROC_SetRelationToPlayers((FACTION)Act1B_CRE_Gith_SecurityOffice_6a8d9c32-b2ba-49e6-9ce8-8cc745bc015e, 0);
PROC_RemoveDialog((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c);

///////////////Dialog outcome: officers leave during dialog///////////////
//Debug oe command: "cre_officersleave"
//Leaving logic is in Anubis
IF
FlagSet(CRE_ChainOfCommand_Event_OfficersLeave_23e1ccb8-12fd-44f2-bc20-f1ffa1bb6563, _, _)
THEN
PROC_CRE_ChainOfCommand_OfficersLeave(); //Added so that this can be easily triggered by a TextEvent

PROC
PROC_CRE_ChainOfCommand_OfficersLeave()
AND
DB_CRE_ChainOfCommand_SecurityOfficers(_Officer)
THEN
SetCombatGroupID(_Officer, "");
SetFaction(_Officer, Act1B_CRE_Gith_SecuirtyOffice_Dismissed_15dd6417-255c-4305-846a-e98984d72371);

///////////////Situation outcome: enter Astral Plane during dialog///////////////
IF
DB_GlobalFlag((FLAG)CRE_AstralPrison_State_BoxUnlocked_07e04b03-e958-461c-bda9-b4131da6884b)
THEN
PROC_SceneOver("CRE_SecurityOffice");

//When player has left the Astral Prison
IF
EntityEvent(_Player, "CRE_AstralPrison_Returned")
AND
QRY_OnlyOnce("CRE_ChainOfCommand_StartBetrayalOM_AfterAstral")
THEN
ObjectTimerLaunch(_Player, "CRE_ChainOfCommand_BackFromAstralPlane", 6000);
RealtimeObjectTimerLaunch(_Player, "CRE_ChainOfCommand_ReturnAnim", 500);
DB_DangerZone(S_CRE_SecurityOfficeArea_4f8819f5-4898-4db1-b3bd-92d24c51c80f, "CRE_SecOffice_AfterAstral2seconds");

IF
ObjectTimerFinished(_Player, "CRE_ChainOfCommand_ReturnAnim")
THEN
PlayAnimation(_Player, CUST_Exiting_Astral_Plane_01_4043d9a9-8692-469b-9e7d-691ccfba8c3a, "CRE_AstralPrism_ReturnAnimFinished");

IF
ObjectTimerFinished(_Player, "CRE_ChainOfCommand_BackFromAstralPlane")
AND
NOT QRY_CRE_ChainOfCommand_StartPostAstralPrisonDialog((CHARACTER)_Player)
THEN
PROC_CRE_CrecheHostile();
SetFlag((FLAG)CRE_ChainOfCommand_State_InquisitorSituationFinished_acc50a19-c0f3-425b-b1a1-ac5bbd466b8f);

IF
ObjectTimerFinished(_Player, "CRE_ChainOfCommand_BackFromAstralPlane")
THEN
PROC_DangerZone_Safe("CRE_SecOffice_AfterAstral2seconds");

//Laezel is not available as Companion or Avatar. Speakers are different for those dialogs, so they don't use the generic OM pipeline
QRY
QRY_CRE_ChainOfCommand_StartPostAstralPrisonDialog((CHARACTER)_Player)
AND
NOT QRY_CRE_ChainOfCommand_TemplarStartsFight_ShouldOverrideWithLaezelOM()
AND
QRY_SpeakerIsAvailable(_Player)
AND
QRY_SpeakerIsAvailable(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c)
AND
NOT DB_OnlyOnce("CRE_AstralPrison_TemplarDialogStarted")
AND
QRY_StartDialog((DIALOGRESOURCE)CRE_ChainOfCommand_TemplarStartsFight_ab5ddb04-eece-e8c0-9b5a-69c8ee8534ac, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (CHARACTER)S_GLO_Vlaakith_6b00f9fb-b932-4ac9-8ed8-1ca89dd7d247 ,_Player)
THEN
DB_OnlyOnce("CRE_AstralPrison_TemplarDialogStarted");

//Laezel Avatar is available
QRY
QRY_CRE_ChainOfCommand_StartPostAstralPrisonDialog(_)
AND
QRY_OnlyOnce("CRE_ChainOfCommand_StartBetrayalOM")
AND
QRY_CRE_ChainOfCommand_TemplarStartsFight_ShouldOverrideWithLaezelOM()
AND
QRY_CRE_ChainOfCommand_StartBetrayalOM()
THEN
DB_NOOP(1);

//Laezel Companion is available
QRY
QRY_CRE_ChainOfCommand_StartBetrayalOM()
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Avatar)
AND
NOT DB_OnlyOnce("CRE_AstralPrison_TemplarDialogStarted")
AND
QRY_SpeakerIsAvailable(_Avatar)
AND
QRY_SpeakerIsAvailable(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)CRE_ChainOfCommand_Betrayal_OM_Laezel_COM_37646009-a3de-b772-d063-0d85c053ed88, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Avatar)
THEN
DB_OnlyOnce("CRE_AstralPrison_TemplarDialogStarted");

//Checks if Laezel is present in the party and available when the players arrive from Astral prison
QRY
QRY_CRE_ChainOfCommand_TemplarStartsFight_ShouldOverrideWithLaezelOM()
AND
DB_Players(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_SpeakerIsAvailable(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)CRE_ChainOfCommand_TemplarStartsFight_ab5ddb04-eece-e8c0-9b5a-69c8ee8534ac, _)
THEN
PROC_CRE_CrecheHostile();
SetFlag((FLAG)CRE_ChainOfCommand_State_InquisitorSituationFinished_acc50a19-c0f3-425b-b1a1-ac5bbd466b8f);

IF
DialogEnded((DIALOGRESOURCE)CRE_ChainOfCommand_Betrayal_OM_Laezel_COM_37646009-a3de-b772-d063-0d85c053ed88, _)
THEN
PROC_CRE_CrecheHostile();
SetFlag((FLAG)CRE_ChainOfCommand_State_InquisitorSituationFinished_acc50a19-c0f3-425b-b1a1-ac5bbd466b8f);

IF
DialogRequestFailed((DIALOGRESOURCE)CRE_ChainOfCommand_TemplarStartsFight_ab5ddb04-eece-e8c0-9b5a-69c8ee8534ac, _)
THEN
PROC_CRE_CrecheHostile();
SetFlag((FLAG)CRE_ChainOfCommand_State_InquisitorSituationFinished_acc50a19-c0f3-425b-b1a1-ac5bbd466b8f);

IF
DialogRequestFailed((DIALOGRESOURCE)CRE_ChainOfCommand_Betrayal_OM_Laezel_COM_37646009-a3de-b772-d063-0d85c053ed88, _)
THEN
PROC_CRE_CrecheHostile();
SetFlag((FLAG)CRE_ChainOfCommand_State_InquisitorSituationFinished_acc50a19-c0f3-425b-b1a1-ac5bbd466b8f);

IF
EntityEvent(_, "CRE_AstralPrison_Returned")
AND
DB_PermaDefeated(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c)
AND
NOT DB_GlobalFlag((FLAG)CRE_ChainOfCommand_State_InquisitorSituationFinished_acc50a19-c0f3-425b-b1a1-ac5bbd466b8f)
THEN
SetFlag((FLAG)CRE_ChainOfCommand_State_InquisitorSituationFinished_acc50a19-c0f3-425b-b1a1-ac5bbd466b8f);

///////////////Starting Vlaakith dialog///////////////
//Start the Vlaakith dialog if the Templar dialog ends with showing the artifact
PROC
PROC_FlagReactionAfterDialog(_Player,(FLAG)CRE_ChainOfCommand_Event_ShowedArtifactToTemplar_14e19375-1dfc-4b50-9f32-732bda87a19c)
THEN
DB_CRE_ChainOfCommand_StartVlaakithDialog(1);


//Start the Vlaakith dialog after the inquisitor office enemies are all defeated
PROC
PROC_GLO_DefeatCounter_AllDefeated("CRE_ChainOfCommand_InquisitorCombat")
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_Knows_MetVlaakith_c93015c2-6ae4-4013-b439-433b588f881c)
THEN
PROC_CRE_ChainOfCommand_WaitBeforeVlaakithDialog();

PROC
PROC_CRE_ChainOfCommand_WaitBeforeVlaakithDialog()
THEN
TimerLaunch("CRE_ChainOfCommand_WaitBeforeVlaakithDialog", 1000);

IF
TimerFinished("CRE_ChainOfCommand_WaitBeforeVlaakithDialog")
THEN
DB_CRE_ChainOfCommand_StartVlaakithDialog(1);

//Prefer Avatar Laezel if she's available and nearby
IF
DB_CRE_ChainOfCommand_StartVlaakithDialog(1)
AND
DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_InRegion(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f)
AND
NOT DB_GlobalFlag((FLAG)CRE_Lance_State_ExplosionCountdoSwnActive_8b52ae9e-0cf3-46e5-924d-64e11aefa0e3)
AND
NOT DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
AND
NOT DB_Defeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
THEN
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

//Otherwise, prefer Laezel's avatar if Laezel and her Avatar are both available and nearby
IF
DB_CRE_ChainOfCommand_StartVlaakithDialog(1)
AND
DB_Avatars(_Avatar)
AND
DB_InRegion(_Avatar, S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f)
AND
NOT DB_GlobalFlag((FLAG)CRE_Lance_State_ExplosionCountdoSwnActive_8b52ae9e-0cf3-46e5-924d-64e11aefa0e3)
AND
NOT DB_Is_InCombat(_Avatar, _)
AND
NOT DB_Defeated(_Avatar)
AND
DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_InRegion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f)
AND
QRY_CRE_ChainOfCommand_AvatarIsBestForLaezel(_Avatar)
AND
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(_Avatar)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
THEN
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog(_Avatar);

QRY
QRY_CRE_ChainOfCommand_AvatarIsBestForLaezel((CHARACTER)_Avatar)
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Avatar)
THEN
DB_NOOP(1);

//Otherwise, prefer the Avatar who talked during the Inquisitor Dialog
IF
DialogEnded((DIALOGRESOURCE)CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, _Id)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_Knows_MetVlaakith_c93015c2-6ae4-4013-b439-433b588f881c) //Only the first time, before meeting Vlaakith
AND
DB_DialogPlayers(_Id, _Player, 1)
THEN
DB_CRE_ChainOfCommand_PlayerWhoSpokeToInquisitor(_Player);

IF
DB_CRE_ChainOfCommand_StartVlaakithDialog(1)
AND
DB_Avatars(_Avatar)
AND
DB_InRegion(_Avatar, S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f)
AND
NOT DB_GlobalFlag((FLAG)CRE_Lance_State_ExplosionCountdoSwnActive_8b52ae9e-0cf3-46e5-924d-64e11aefa0e3)
AND
NOT DB_Is_InCombat(_Avatar, _)
AND
NOT DB_Defeated(_Avatar)
AND
DB_CRE_ChainOfCommand_PlayerWhoSpokeToInquisitor(_Avatar)
AND
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(_Avatar)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
THEN
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog(_Avatar);

//Otherwise, prefer any available avatar
IF
DB_CRE_ChainOfCommand_StartVlaakithDialog(1)
AND
DB_Avatars(_Avatar)
AND
DB_InRegion(_Avatar, S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f)
AND
NOT DB_GlobalFlag((FLAG)CRE_Lance_State_ExplosionCountdoSwnActive_8b52ae9e-0cf3-46e5-924d-64e11aefa0e3)
AND
NOT DB_Is_InCombat(_Avatar, _)
AND
NOT DB_Defeated(_Avatar)
AND
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(_Avatar)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
THEN
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog(_Avatar);

//Otherwise, prefer Companion Laezel
IF
DB_CRE_ChainOfCommand_StartVlaakithDialog(1)
AND
DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_InRegion(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f)
AND
NOT DB_GlobalFlag((FLAG)CRE_Lance_State_ExplosionCountdoSwnActive_8b52ae9e-0cf3-46e5-924d-64e11aefa0e3)
AND
NOT DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
AND
NOT DB_Defeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
THEN
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

//Otherwise, prefer player who spoke to Inquisitor
IF
DB_CRE_ChainOfCommand_StartVlaakithDialog(1)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f)
AND
NOT DB_GlobalFlag((FLAG)CRE_Lance_State_ExplosionCountdoSwnActive_8b52ae9e-0cf3-46e5-924d-64e11aefa0e3)
AND
NOT DB_Is_InCombat(_Player, _)
AND
NOT DB_Defeated(_Player)
AND
DB_CRE_ChainOfCommand_PlayerWhoSpokeToInquisitor(_Player)
AND
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(_Player)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
THEN
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog(_Player);

//Otherwise, prefer any available player
IF
DB_CRE_ChainOfCommand_StartVlaakithDialog(1)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_CRE_VlaakithDialog_LaezelOMArea_9ee53aad-fc64-4ac7-93d6-4f098273bd4f)
AND
NOT DB_GlobalFlag((FLAG)CRE_Lance_State_ExplosionCountdoSwnActive_8b52ae9e-0cf3-46e5-924d-64e11aefa0e3)
AND
NOT DB_Is_InCombat(_Player, _)
AND
NOT DB_Defeated(_Player)
AND
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(_Player)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
THEN
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog(_Player);

PROC
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog((CHARACTER)_Player)
THEN
DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(_Player);

PROC
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog((CHARACTER)_Player)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
AND
QRY_StartDialog((DIALOGRESOURCE)CRE_ChainOfCommand_Vlaakith_8ca0aac9-c46a-8d02-00ff-c61e6ec77c8d, S_GLO_Vlaakith_6b00f9fb-b932-4ac9-8ed8-1ca89dd7d247, _Player)
THEN
DB_OnlyOnce("CRE_StartVlaakithDialog");
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(_Player);

PROC
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog((CHARACTER)_Player)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
AND
DB_QRYRTN_StartDialog_FailReason("OriginMomentOverride")
THEN
DB_OnlyOnce("CRE_StartVlaakithDialog");
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog(_Player);

PROC
PROC_CRE_ChainOfCommand_TryStartVlaakithDialog((CHARACTER)_Player)
AND
NOT DB_OnlyOnce("CRE_StartVlaakithDialog")
THEN
RealtimeObjectTimerLaunch(_Player, "CRE_ChainOfCommand_RetryVlaakithDialogDelay", 2000);

IF
ObjectTimerFinished(_Player, "CRE_ChainOfCommand_RetryVlaakithDialogDelay")
AND
DB_CRE_ChainOfCommand_AttemptingVlaakithDialog((CHARACTER)_Player)
THEN
NOT DB_CRE_ChainOfCommand_AttemptingVlaakithDialog((CHARACTER)_Player);

IF
DB_GlobalFlag(CRE_AstralPrison_Event_LeftAstralPlane_58ec28f6-be1a-4044-8fbf-4229d8482bac)
AND
DB_Players(_Player)
AND
DB_Defeated(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c)
AND
QRY_OnlyOnce("CRE_KilledInquisitorAD")
THEN
PROC_DaisyAD(_Player, (DIALOGRESOURCE)CRE_ChainOfCommand_DaisyAD_KilledInquisitor_04070412-20a2-0799-ec62-a3736e6d4c94);

//Vlaakith casting wish to kill the players
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_Event_VlaakithWish_cbcac30e-421f-4cb3-a715-e5d047306fbc)
AND
DB_Players(_Player)
THEN
Die(_Player, DEATHTYPE.Radiant, S_GLO_Vlaakith_6b00f9fb-b932-4ac9-8ed8-1ca89dd7d247, 0, 1, 0.0);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CRE_ChainOfCommand_State_PlanecasterActive_5e5e9cb6-41d8-4a93-942d-3dca4d357561)
THEN
PROC_LoopEffect(VFX_Script_CRE_HoloDeck_Planecaster_Activated_01_434a632f-1f52-361f-18dd-0b3ffdd77afa, S_CRE_SecurtiyOfficePlanecaster_9144098a-c9c7-4425-a99d-d7375069e7b7, "CRE_AstralPlanecaster_VFX", "CRE_Main_A", "", 1.0);
//END_REGION

//REGION Inquisitor Combat
// HARD MODE: When one of his minions are downed, the Inquisitor starts his second phase
PROC
PROC_GLO_DefeatCounter_Notify("CRE_InquisitorCombat_KillCounter_Minion",_,_,1)
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,"HARD",1)
THEN
SetTag(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, ACT1B_CRE_INQUISITOR_TRIGGERMINDSTEALTEMPEST_1271938d-b5a2-4321-9cae-f681045981b2);

// NORMAL MODE: When two of his minions are downed, the Inquisitor starts his second phase
PROC
PROC_GLO_DefeatCounter_Notify("CRE_InquisitorCombat_KillCounter_Minion",_,_,2)
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,"MEDIUM",1)
THEN
SetTag(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, ACT1B_CRE_INQUISITOR_TRIGGERMINDSTEALTEMPEST_1271938d-b5a2-4321-9cae-f681045981b2);
//END_REGION

//REGION Combining the Artefact with the Planecaster
//Ensuring the player has the box when they go to interact with the planecaster
IF
UseStarted(_Player, _PlaneCaster)
AND
DB_CRE_ChainOfCommand_Planecaster(_Planecaster)
AND
DB_Players(_Player)
AND
IsInInventoryOf(QUEST_Mysterious_Puzzlebox_3301071e-be9c-4473-92c0-4eb1c51b66e3, _Player, 0)
THEN
SetFlag(GLO_InfernalBox_Event_ForceGiveBox_7addbb64-502f-48aa-9b71-da1b8d6c28eb, _Player, 0);


IF
UseStarted(_Player, _PlaneCaster)
AND
DB_CRE_ChainOfCommand_Planecaster(_Planecaster)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("CRE_UsePlanecasterAD")
THEN
PROC_DaisyAD(_Player, (DIALOGRESOURCE)CRE_ChainOfCommand_DaisyAD_UsePlanecaster_0d2c8ece-f389-4aca-5074-62bf25931f26);


//Say a voicebark while while the planecaster is not activated
PROC
PROC_BlockUseOfItem(_Player, _Planecaster)
AND
DB_CRE_ChainOfCommand_Planecaster(_Planecaster)
AND
NOT DB_GlobalFlag(CRE_ChainOfCommand_State_PlanecasterActive_5e5e9cb6-41d8-4a93-942d-3dca4d357561)
THEN
DB_CustomUseItemResponse(_Player, _Planecaster, 0);
StartVoiceBark((VOICEBARKRESOURCE)CRE_ChainOfCommand_VB_InactivePlanecasterComment_aafda489-7e64-0ae9-7aea-1b455ffad8c1, _Player);

IF
UseStarted(_Player, _PlaneCaster)
AND
DB_CRE_ChainOfCommand_Planecaster(_Planecaster)
AND
DB_GlobalFlag(CRE_ChainOfCommand_State_PlanecasterActive_5e5e9cb6-41d8-4a93-942d-3dca4d357561)
THEN
RealtimeObjectTimerLaunch(_Player, "CRE_ChainOfCommand_DeviceDelay", 1200); //Gives the Daisy warning AD time to play

IF
ObjectTimerFinished(_Player, "CRE_ChainOfCommand_DeviceDelay")
THEN
DB_CRE_ChainOfCommand_EnterAstralReadyCheck_Initiator((CHARACTER)_Player);
ReadyCheckGlobal("CRE_ChainOfCommand_EnterAstralPrison", "CRE_AstralPrison_Entering_ReadyCheck", 1, _Player);

IF
ReadyCheckPassed("CRE_ChainOfCommand_EnterAstralPrison")
AND
DB_Players(_Player)
AND
DB_Defeated(_Player)
THEN
PROC_CRE_AstralPrison_ResurrectWith1HP(_Player);

PROC
PROC_CRE_AstralPrison_ResurrectWith1HP((CHARACTER)_Player)
THEN
PROC_SetHitpointsMinimum(_Player,1);
RemoveHarmfulStatuses(_Player);
ResetCooldowns(_Player);

IF
ReadyCheckPassed("CRE_ChainOfCommand_EnterAstralPrison")
AND
DB_CRE_ChainOfCommand_EnterAstralReadyCheck_Initiator((CHARACTER)_Player)
AND
QRY_ORI_Laezel_CheckAddToParty()
AND
NOT QRY_CRE_StartEnteringAstralPrisonDialog((CHARACTER)_Player)
THEN
//SetFlag((FLAG)CRE_AstralPrison_State_AstralPrisonWasEntered_2203e87a-6c7b-4aba-b2e8-e22ed96b9762);
SetFlag((FLAG)GLO_InfernalBox_Event_ForceGiveBox_7addbb64-502f-48aa-9b71-da1b8d6c28eb, S_CRE_TempContainerOfPuzzlebox_6396399c-ce1e-48db-97e2-cbfd40b64dd7, 0);
SetFlag((FLAG)CRE_AstralPrison_State_BoxUnlocked_07e04b03-e958-461c-bda9-b4131da6884b, NULL_00000000-0000-0000-0000-000000000000, 0);
NOT DB_CRE_ChainOfCommand_EnterAstralReadyCheck_Initiator(_Player);

QRY
QRY_CRE_StartEnteringAstralPrisonDialog((CHARACTER)_Player)
AND
QRY_StartDialogCustom((DIALOGRESOURCE)CRE_AstralPrison_Entering_a84e5d45-33be-b325-08cf-41acdb848ce2, _Player, 0, 0, 0, 0) //ToDo: Fix the speakers in this dialog and fix this call after, also rename the dialog
THEN
//SetFlag((FLAG)CRE_AstralPrison_State_AstralPrisonWasEntered_2203e87a-6c7b-4aba-b2e8-e22ed96b9762);
SetFlag((FLAG)GLO_InfernalBox_Event_ForceGiveBox_7addbb64-502f-48aa-9b71-da1b8d6c28eb, S_CRE_TempContainerOfPuzzlebox_6396399c-ce1e-48db-97e2-cbfd40b64dd7, 0);
SetFlag((FLAG)CRE_AstralPrison_State_BoxUnlocked_07e04b03-e958-461c-bda9-b4131da6884b, NULL_00000000-0000-0000-0000-000000000000, 0);
NOT DB_CRE_ChainOfCommand_EnterAstralReadyCheck_Initiator(_Player);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CRE_AstralPrison_Entering_a84e5d45-33be-b325-08cf-41acdb848ce2, _Id)
AND
DB_Players(_Player)
THEN
PROC_DialogAddSpeakingActor(_Id, _Player);

IF
ReadyCheckFailed("CRE_ChainOfCommand_EnterAstralPrison")
AND
DB_CRE_ChainOfCommand_EnterAstralReadyCheck_Initiator(_Player)
THEN
NOT DB_CRE_ChainOfCommand_EnterAstralReadyCheck_Initiator(_Player);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CRE_AstralPrison_State_AstralPrisonWasEntered_2203e87a-6c7b-4aba-b2e8-e22ed96b9762)
AND
NOT QRY_Debug_RestoringState()
THEN
PROC_TeleportPartiesTo(S_CRE_AstralPlaneEntrance_b73922c5-5ac4-4551-b492-ce85e01175d1, "");
PROC_RemoveDialog(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c);
SetFlag((FLAG)ORI_Laezel_State_BetrayedByVlaakith_175d8487-99dc-4009-9b45-6e9f29708cd7);
SetJoinBlock(JOINBLOCKTYPE.BlockNew);

IF
FlagSet((FLAG)GEN_MaxPlayerCountReached_823b5064-8aa4-c0b7-1b8c-657b46987ccd, _, _)
AND
DB_GlobalFlag((FLAG)CRE_ChainOfCommand_State_LaezelWaitsAtPlanecaster_e25eb1e0-739e-489e-a1df-d2468682e9b3)
THEN
PROC_CRE_CrecheHostile();

//Making the inquisitor hostile if the player leaves the room after the planecaster is activated - changed to any player leaving - players can enter, but cannot leave
IF
LeftTrigger(_Player, S_CRE_SecurityOfficeArea_4f8819f5-4898-4db1-b3bd-92d24c51c80f)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)CRE_ChainOfCommand_State_PlanecasterActive_5e5e9cb6-41d8-4a93-942d-3dca4d357561)
AND
NOT DB_GlobalFlag((FLAG)CRE_ChainOfCommand_State_LeftInquisitorOfficeBeforeEnteringAstral_f4049c49-d505-4ddf-a790-45cc29eafabb)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_BetrayedByVlaakith_175d8487-99dc-4009-9b45-6e9f29708cd7)
THEN
PROC_CRE_CrecheHostile();
SetFlag((FLAG)CRE_ChainOfCommand_State_LeftInquisitorOfficeBeforeEnteringAstral_f4049c49-d505-4ddf-a790-45cc29eafabb);

IF
EnteredTrigger(_Player, (TRIGGER)S_CRE_AstralPlane_SUB_3f383c9a-fbe1-479e-a7ed-de86f65e93d9)
AND
DB_Players(_Player)
THEN
SetFlag((FLAG)CRE_AstralPrison_State_PlayerEnteredAstralPrison_889725f7-2635-462b-8062-97b5d8c91112, _Player);
PlayAnimation(_Player, CUST_Exiting_Astral_Plane_01_4043d9a9-8692-469b-9e7d-691ccfba8c3a, "");

IF
EnteredTrigger(_Player, (TRIGGER)S_CRE_AstralPlane_SUB_3f383c9a-fbe1-479e-a7ed-de86f65e93d9)
THEN
PROC_StopLoopEffect(S_CRE_SecurtiyOfficePlanecaster_9144098a-c9c7-4425-a99d-d7375069e7b7, "CRE_AstralPlanecaster_VFX");
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1b"
