Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_CRE_UpperGuards_LockedDoors((ITEM)S_CRE_MainCheckPointRightDoor1_5a64e966-df7a-49cb-9afc-960ffd77fd19);
DB_CRE_UpperGuards_LockedDoors(S_CRE_MainCheckPointRightDoor2_09c338db-2d30-4d8a-a924-61ec603d8c9a);
DB_CRE_UpperGuards_LockedDoors(S_CRE_MainCheckPointLeftDoor1_37d19dac-98e8-41bc-a6f9-649d789bdab7);
DB_CRE_UpperGuards_LockedDoors(S_CRE_MainCheckPointLeftDoor2_a8407f32-fc6d-4bfa-a093-4f4e951476bc);

DB_CustomDialogRange((CHARACTER)S_CRE_MainCheckpointMainGuard_161701af-17b7-4def-b378-5f24e95d667f, 20);
DB_CustomDialogRange((CHARACTER)S_CRE_HiddenCheckpointMainGuard_3bcbf8fb-5a90-4439-bd81-d9113d74f27e, 20);

DB_Dialogs((CHARACTER)S_CRE_MainCheckpointMainGuard_161701af-17b7-4def-b378-5f24e95d667f, (DIALOGRESOURCE)CRE_UpperGuards_MainCheckpointTrespassing_11a44b75-14a3-cca7-5c4d-f3a11eb279c1);
DB_Dialogs((CHARACTER)S_CRE_MainCheckpointWarningGuard_a6c0d21e-ce59-4dbb-9f64-1ec80b95c838, (DIALOGRESOURCE)CRE_UpperGuards_MainCheckpointWarning_33c13028-b3af-e22c-b30d-65fb0ad9059a);
DB_Dialogs((CHARACTER)S_CRE_HiddenCheckpointMainGuard_3bcbf8fb-5a90-4439-bd81-d9113d74f27e, (DIALOGRESOURCE)CRE_UpperGuards_HiddenCheckpointTrespassing_85f9aee8-7002-4806-92da-65a90a36a303);
DB_Dialogs((CHARACTER)S_CRE_HiddenCheckpointWarningGuard_970d10ed-8092-463b-8446-223fe4cf2d68, (DIALOGRESOURCE)CRE_UpperGuards_HiddenCheckpointWarning_6603da13-ea21-4491-b60a-0c0e5d68e215);

DB_CustomDialogRange(S_CRE_MainCheckpointWarningGuard_a6c0d21e-ce59-4dbb-9f64-1ec80b95c838, 15);

DB_GlobalFlagReactionAfterDialog((FLAG)CRE_UpperGuards_Event_MainCheckpointHostile_8d001430-ca7b-4f65-b44e-1fe8eabb27fa, (DIALOGRESOURCE)CRE_UpperGuards_MainCheckpointTrespassing_11a44b75-14a3-cca7-5c4d-f3a11eb279c1);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_UpperGuards_Event_MainCheckpointHostile_8d001430-ca7b-4f65-b44e-1fe8eabb27fa, (DIALOGRESOURCE)CRE_UpperGuards_MainCheckpointWarning_33c13028-b3af-e22c-b30d-65fb0ad9059a);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_UpperGuards_Event_HiddenCheckpointHostile_b3f528af-c1fc-4501-94f9-e3c0ce9246d9, (DIALOGRESOURCE)CRE_UpperGuards_HiddenCheckpointTrespassing_85f9aee8-7002-4806-92da-65a90a36a303);
DB_GlobalFlagReactionAfterDialog((FLAG)CRE_UpperGuards_Event_HiddenCheckpointHostile_b3f528af-c1fc-4501-94f9-e3c0ce9246d9, (DIALOGRESOURCE)CRE_UpperGuards_HiddenCheckpointWarning_6603da13-ea21-4491-b60a-0c0e5d68e215);

DB_CheckPoint((CHARACTER)S_CRE_MainCheckpointMainGuard_161701af-17b7-4def-b378-5f24e95d667f, (CHARACTER)S_CRE_MainCheckpointWarningGuard_a6c0d21e-ce59-4dbb-9f64-1ec80b95c838,
				(TRIGGER)S_CRE_MainCheckpointPrimaryArea_a2b8ea90-32d4-45a1-9685-814ee6a44792, (TRIGGER)S_CRE_MainCheckpointWarningArea_d302a664-8967-4a5e-a47e-13d7d0381f7b,
				(TRIGGER)S_CRE_MainCheckpointTrespassingArea_14c6bc39-9832-43fc-b29d-009e4c93a190,
				"CRE_UpperGuards_MainCheckpoint", (FLAG)CRE_UpperGuards_State_GainedAccess_764df691-d1f0-4bde-ba36-73c4abe6a4e7,
				"Trespassing", (TRIGGER)S_CRE_MainCheckpointTrespassingTeleport_9a06a7e6-c02f-4b75-9998-e01aa7b1c571);
DB_CheckPointPassTrigger("CRE_UpperGuards_MainCheckpoint", "CRE_UpperGuards_PassTrigger", (TRIGGER)S_CRE_CheckpointsPassArea_559fdadd-15ef-4953-8adb-7fb5ffe72d42);
DB_CheckPointPassTrigger("CRE_UpperGuards_MainCheckpoint", "CRE_UpperGuards_PassTrigger", (TRIGGER)S_CRE_MainDoorPassArea_9edb8b4e-4f2d-4255-b4a2-fb4fa3b609fd);

DB_CheckPoint((CHARACTER)S_CRE_HiddenCheckpointMainGuard_3bcbf8fb-5a90-4439-bd81-d9113d74f27e, (CHARACTER)S_CRE_HiddenCheckpointWarningGuard_970d10ed-8092-463b-8446-223fe4cf2d68,
				(TRIGGER)S_CRE_HiddenCheckpointPrimaryArea_e1dc957b-13c0-4fd6-9ec4-cdf76951e11d, (TRIGGER)S_CRE_HiddenCheckpointWarningArea_6285c661-f4a3-474e-9c2f-fc34bff3a6a6,
				(TRIGGER)S_CRE_HiddenCheckpointTrespassingArea_28e68e21-784f-47b8-9e99-b698368a56c7,
				"CRE_UpperGuards_HiddenCheckpoint", (FLAG)CRE_UpperGuards_State_GainedAccess_764df691-d1f0-4bde-ba36-73c4abe6a4e7,
				"Trespassing", (TRIGGER)S_CRE_HiddenCheckpointTrespassingTeleport_a0a74141-9729-4cad-9c21-9d3a9f261aa9);
DB_CheckPointPassTrigger("CRE_UpperGuards_HiddenCheckpoint", "CRE_UpperGuards_PassTrigger", (TRIGGER)S_CRE_CheckpointsPassArea_559fdadd-15ef-4953-8adb-7fb5ffe72d42);

DB_DefeatedStateFlag((CHARACTER)S_CRE_MainCheckpointMainGuard_161701af-17b7-4def-b378-5f24e95d667f, (FLAG)CRE_UpperGuards_State_MainPrimaryGuardDefeated_82345f32-d1a3-4edb-b092-1e1c1fc7314f);
DB_DefeatedStateFlag((CHARACTER)S_CRE_HiddenCheckpointMainGuard_3bcbf8fb-5a90-4439-bd81-d9113d74f27e, (FLAG)CRE_UpperGuards_State_HiddenPrimaryGuardDefeated_5a839660-5dc0-4002-93c1-c3a4b4c211b3);

DB_CRE_UpperGuards_MainCheckpointGuards((CHARACTER)S_CRE_MainCheckpointMainGuard_161701af-17b7-4def-b378-5f24e95d667f);
DB_CRE_UpperGuards_MainCheckpointGuards((CHARACTER)S_CRE_CrecheGuard01_5a5c5878-fd9f-41c0-9c8c-b74cea0e3fd9);
DB_CRE_UpperGuards_MainCheckpointGuards((CHARACTER)S_CRE_CrecheGuard02_99439816-fcaa-4167-a20a-8f3dfff4e345);
DB_CRE_UpperGuards_MainCheckpointGuards((CHARACTER)S_CRE_MainCheckpointWarningGuard_a6c0d21e-ce59-4dbb-9f64-1ec80b95c838);

DB_CRE_UpperGuards_HiddenCheckpointGuards((CHARACTER)S_CRE_HiddenCheckpointWarningGuard_970d10ed-8092-463b-8446-223fe4cf2d68);
DB_CRE_UpperGuards_HiddenCheckpointGuards((CHARACTER)S_CRE_HiddenCheckpointMainGuard_3bcbf8fb-5a90-4439-bd81-d9113d74f27e);

DB_CRE_UpperGuards_CheckpointWarningDialogPairs("CRE_UpperGuards_MainCheckpoint", (CHARACTER)S_CRE_MainCheckpointMainGuard_161701af-17b7-4def-b378-5f24e95d667f, CRE_UpperGuards_MainCheckpointTrespassing_11a44b75-14a3-cca7-5c4d-f3a11eb279c1);
DB_CRE_UpperGuards_CheckpointWarningDialogPairs("CRE_UpperGuards_MainCheckpoint", (CHARACTER)S_CRE_MainCheckpointWarningGuard_a6c0d21e-ce59-4dbb-9f64-1ec80b95c838, CRE_UpperGuards_MainCheckpointWarning_33c13028-b3af-e22c-b30d-65fb0ad9059a);
DB_CRE_UpperGuards_CheckpointWarningDialogPairs("CRE_UpperGuards_HiddenCheckpoint", (CHARACTER)S_CRE_HiddenCheckpointMainGuard_3bcbf8fb-5a90-4439-bd81-d9113d74f27e, CRE_UpperGuards_HiddenCheckpointTrespassing_85f9aee8-7002-4806-92da-65a90a36a303);
DB_CRE_UpperGuards_CheckpointWarningDialogPairs("CRE_UpperGuards_HiddenCheckpoint", (CHARACTER)S_CRE_HiddenCheckpointWarningGuard_970d10ed-8092-463b-8446-223fe4cf2d68, CRE_UpperGuards_HiddenCheckpointWarning_6603da13-ea21-4491-b60a-0c0e5d68e215);
KBSECTION
//REGION Main Checkpoint
///////////////Checkpoint///////////////
PROC
PROC_CheckPointDialogue(_Player, (CHARACTER)_Guard)
AND
DB_CRE_UpperGuards_CheckpointWarningDialogPairs("CRE_UpperGuards_MainCheckpoint", _Guard, _)
AND
QRY_CRE_UpperGuards_SelectMostSuitablePlayer(_Player, _Guard)
AND
DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _MostSuitablePlayer)
THEN
TeleportTo(_Player, _Player, "", 0, 0, 0, 0, 1); //Used to stop queued movement to prevent the player from walking through as the dialog might start on a different character
PROC_CRE_UpperGuards_StartCheckpointWarningDialog(_Guard, (CHARACTER)_MostSuitablePlayer);
NOT DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _MostSuitablePlayer);

//Companion Laezel and a suitable avatar are nearby and available
QRY
QRY_CRE_UpperGuards_SelectMostSuitablePlayer((CHARACTER)_,(CHARACTER)_Guard)
AND
DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Guard)
AND
QRY_GetBestAvatarForCompanion(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1, 1)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _BestAvatar)
AND
NOT DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _)
THEN
DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _BestAvatar);

//Companion Laezel and another avatar are nearby and available
QRY
QRY_CRE_UpperGuards_SelectMostSuitablePlayer((CHARACTER)_,(CHARACTER)_Guard)
AND
DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Guard)
AND
DB_Avatars(_OtherAvatar)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_OtherAvatar, _Guard)
AND
NOT DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _)
THEN
DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _OtherAvatar);

//Companion Laezel is nearby and available without any avatars
QRY
QRY_CRE_UpperGuards_SelectMostSuitablePlayer((CHARACTER)_,(CHARACTER)_Guard)
AND
DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Guard)
AND
NOT DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _)
THEN
DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

//Companion Laezel is not nearby or isn't available - play on whoever walked in (fallback)
QRY
QRY_CRE_UpperGuards_SelectMostSuitablePlayer((CHARACTER)_Player,(CHARACTER)_Guard)
AND
NOT DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _)
THEN
DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _Player);

PROC
PROC_CRE_UpperGuards_StartCheckpointWarningDialog((CHARACTER)_Guard, (CHARACTER)_MostSuitablePlayer)
AND
DB_CRE_UpperGuards_CheckpointWarningDialogPairs(_CheckpointId, _Guard, _WarningDialog)
AND
QRY_StartCheckpointWarningDialog(_CheckpointId, (DIALOGRESOURCE)_WarningDialog, (CHARACTER)_Guard, _MostSuitablePlayer)
THEN
DB_NOOP(1);

//Try to add Laezel to all checkpoint dialogs
PROC
PROC_StartDialog_AddExtraSpeakers(_Dialog, _Id)
AND
DB_CRE_UpperGuards_CheckpointWarningDialogPairs(_, _Guard, _Dialog)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Guard)
THEN
PROC_DialogAddSpeakingActor(_Id, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

///////////////Guards turn hostile///////////////
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CRE_UpperGuards_Event_MainCheckpointHostile_8d001430-ca7b-4f65-b44e-1fe8eabb27fa)
THEN
PROC_SetRelationToPlayers((FACTION)Act1B_CRE_Gith_MainCheckpoint_a51f68a3-e53a-4784-ba02-8d465b781646, 0);

//Handling special greeting node for secondary guard referencing ongoing dialog with Primary guard
IF
DB_InteractiveDialogSpeaker(_ID, S_CRE_MainCheckpointMainGuard_161701af-17b7-4def-b378-5f24e95d667f)
THEN
SetFlag(CRE_UpperGuards_State_MainPrimaryGuardInDialog_c284610e-a4e7-4c60-b4f4-e195efee30dc);
DB_CRE_UpperGuards_MainGuardOngoingDialog(_ID);

IF
DialogEnded(_, _ID)
AND
DB_CRE_UpperGuards_MainGuardOngoingDialog(_ID)
THEN
ClearFlag(CRE_UpperGuards_State_MainPrimaryGuardInDialog_c284610e-a4e7-4c60-b4f4-e195efee30dc);
//END_REGION

//REGION Hidden entrance Checkpoint
///////////////Checkpoint///////////////
PROC
PROC_CheckPointDialogue(_Player, (CHARACTER)_Guard)
AND
DB_CRE_UpperGuards_CheckpointWarningDialogPairs("CRE_UpperGuards_HiddenCheckpoint", _Guard, _)
THEN
TeleportTo(_Player, _Player, "", 0, 0, 0, 0, 1); //Used to stop queued movement to prevent the player from walking through as the dialog might start on a different character
PROC_CRE_UpperGuards_StartCheckpointWarningDialog(_Guard, (CHARACTER)_Player);
NOT DB_QRYRTN_CRE_UpperGuards_SelectMostSuitablePlayer(_Guard, _Player);

///////////////Guards turn hostile///////////////
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CRE_UpperGuards_Event_HiddenCheckpointHostile_b3f528af-c1fc-4501-94f9-e3c0ce9246d9)
THEN
PROC_SetRelationToPlayers((FACTION)Act1B_CRE_Gith_HiddenCheckpoint_5a532d4a-4eb5-4969-8fc8-9c12bf956c06, 0);

///////////////Back to patrolling///////////////

//If the player leaves through the hidden door, the outside counterpart of the door should unlock
IF
UseStarted(_, DOOR_Double_Small_Dungeon_Abbey_A_Teleporter_000_b45b688b-c3d3-4620-a518-0396ea88f2be)
AND
IsLocked(DOOR_Single_Dungeon_Abbey_A_005_5ef5ae07-a39b-4d7f-b913-7c7d2df595cc, 1)
THEN
Unlock(DOOR_Single_Dungeon_Abbey_A_005_5ef5ae07-a39b-4d7f-b913-7c7d2df595cc);
//END_REGION

//REGION Misc
///////////////Locked door ownership///////////////
//Transfer door ownership if main guard is perma-defeated
PROC
PROC_StateSet_PermaDefeated((CHARACTER)S_CRE_MainCheckpointMainGuard_161701af-17b7-4def-b378-5f24e95d667f)
AND
NOT DB_PermaDefeated((CHARACTER)S_CRE_MainCheckpointWarningGuard_a6c0d21e-ce59-4dbb-9f64-1ec80b95c838)
AND
DB_CRE_UpperGuards_LockedDoors(_Door)
THEN
SetOwner(_Door, S_CRE_MainCheckpointWarningGuard_a6c0d21e-ce59-4dbb-9f64-1ec80b95c838);

//END_REGION

//REGION Peaceful Resolution
//Main checkpoint peaceful resolution
IF
FlagSet((FLAG)CRE_UpperGuards_State_GainedAccess_764df691-d1f0-4bde-ba36-73c4abe6a4e7, _, _DialogID)
AND
DB_DialogName(CRE_UpperGuards_MainCheckpointTrespassing_11a44b75-14a3-cca7-5c4d-f3a11eb279c1, _DialogID)
THEN
PROC_CRE_UpperGuards_MainCheckpoint_PeacefulResolve();

IF
FlagSet((FLAG)CRE_UpperGuards_State_GainedAccess_764df691-d1f0-4bde-ba36-73c4abe6a4e7, _, _DialogID)
AND
DB_DialogName(CRE_UpperGuards_MainCheckpointWarning_33c13028-b3af-e22c-b30d-65fb0ad9059a, _DialogID)
THEN
PROC_CRE_UpperGuards_MainCheckpoint_PeacefulResolve();

//Hidden checkpoint peaceful resolution
IF
FlagSet((FLAG)CRE_UpperGuards_State_GainedAccess_764df691-d1f0-4bde-ba36-73c4abe6a4e7, _, _DialogID)
AND
DB_DialogName(CRE_UpperGuards_HiddenCheckpointTrespassing_85f9aee8-7002-4806-92da-65a90a36a303, _DialogID)
THEN
PROC_CRE_UpperGuards_HiddenCheckpoint_PeacefulResolve();

IF
FlagSet((FLAG)CRE_UpperGuards_State_GainedAccess_764df691-d1f0-4bde-ba36-73c4abe6a4e7, _, _DialogID)
AND
DB_DialogName(CRE_UpperGuards_HiddenCheckpointWarning_6603da13-ea21-4491-b60a-0c0e5d68e215, _DialogID)
THEN
PROC_CRE_UpperGuards_HiddenCheckpoint_PeacefulResolve();

//Sneaking in will count as if you resolved the main checkpoint
IF
FlagSet((FLAG)CRE_UpperGuards_State_GainedAccess_764df691-d1f0-4bde-ba36-73c4abe6a4e7, _, _DialogID)
AND
NOT DB_DialogName(CRE_UpperGuards_MainCheckpointTrespassing_11a44b75-14a3-cca7-5c4d-f3a11eb279c1, _DialogID)
AND
NOT DB_DialogName(CRE_UpperGuards_MainCheckpointWarning_33c13028-b3af-e22c-b30d-65fb0ad9059a, _DialogID)
AND
NOT DB_DialogName(CRE_UpperGuards_HiddenCheckpointTrespassing_85f9aee8-7002-4806-92da-65a90a36a303, _DialogID)
AND
NOT DB_DialogName(CRE_UpperGuards_HiddenCheckpointWarning_6603da13-ea21-4491-b60a-0c0e5d68e215, _DialogID)
AND
NOT QRY_AnyCREEntranceGuardsDefeated()
THEN
PROC_CRE_UpperGuards_MainCheckpoint_PeacefulResolve();

PROC
PROC_CRE_UpperGuards_MainCheckpoint_PeacefulResolve()
AND
DB_CRE_UpperGuards_MainCheckpointGuards(_Guard)
THEN
PROC_PeacefulResolve(_Guard);

PROC
PROC_CRE_UpperGuards_HiddenCheckpoint_PeacefulResolve()
AND
DB_CRE_UpperGuards_HiddenCheckpointGuards(_Guard)
THEN
PROC_PeacefulResolve(_Guard);

//Detecting if the player defeats any guard
QRY
QRY_AnyCREEntranceGuardsDefeated()
AND
DB_CRE_UpperGuards_HiddenCheckpointGuards(_Guard)
AND
DB_Defeated(_Guard)
THEN
DB_NOOP(1);

QRY
QRY_AnyCREEntranceGuardsDefeated()
AND
DB_CRE_UpperGuards_MainCheckpointGuards(_Guard)
AND
DB_Defeated(_Guard)
THEN
DB_NOOP(1);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1b"
