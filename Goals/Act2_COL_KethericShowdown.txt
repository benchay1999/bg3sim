Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_HasItemEvent(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,COL_KethericShowdown_State_HasNetherstone_0243527e-408f-4711-97a0-7759847bb00a);
DB_GiveItemToEventWithClear(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, (FLAG)COL_KethericShowdown_State_GiveNetherstone_43fda06c-4deb-4e2e-955b-96fe9f3c759d);
SetOnStage(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,0);

//Logic for the Ketheric Boss Encounter at the bottom of Colony

//Keeping track of Ketheric's Allies
//DB_GLO_DefeatCounter(_Minion,"COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter((CHARACTER)S_COL_ShowdownNecromite_01_9499f6fb-6cd7-4e7e-a954-d4c7ffa0e6a4,"COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter((CHARACTER)S_COL_ShowdownNecromite_02_ceb7b3cb-8a7b-4cd0-b531-99fae0e67473,"COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter((CHARACTER)S_COL_ShowdownNecromite_03_c1db9cf0-4d8a-4e91-8611-3fd826b5e207,"COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter((CHARACTER)S_COL_ShowdownNecromite_04_bdf2c1a8-6438-454d-a957-4538b714b5fe,"COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter((CHARACTER)S_COL_ShowdownMindflayer_01_614345f7-8420-4d09-a233-744087eb0af7,"COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter((CHARACTER)S_COL_ShowdownIntDev_01_3ade155b-2ee8-41ba-9710-ca8e043ee5a1,"COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter((CHARACTER)S_COL_ShowdownIntDev_02_7460ee43-9fb9-47d4-ae1d-a09d75a85640,"COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter((CHARACTER)S_COL_ShowdownIntDev_03_9425d831-ef6e-4915-99b9-0a381f7435d2,"COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter((CHARACTER)S_COL_ShowdownIntDev_04_09ad9993-a279-4aa9-89cf-6d9b7a51ebad,"COL_KethericShowdown_KillCounter_Minion");

//Tracks Ketheric's current phase in the combat
DB_COL_KethericShowdown_CurrentPhase(1);

//Ketheric character DB, used in prototype to quickly swap out between placeholder char and the real one
DB_DeadOnceFlag(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,GLO_Ketheric_State_Dead_668558ed-0052-0777-64f7-a8a197c40cc5);

//Death Blooms
DB_COL_KethericShowdown_DeathBloomSpawnTrigger((TRIGGER)S_COL_ShowdownDeathBloomSpawnBox_01_cb73c1b8-bd68-4fd1-9e8f-dc94d23f8dc3);
DB_COL_KethericShowdown_DeathBloomSpawnTrigger((TRIGGER)S_COL_ShowdownDeathBloomSpawnBox_02_93495963-1b9f-4c59-8231-fda3a1b59ceb);
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(2);
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(6);

PROC_TriggerRegisterForParty(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf);
TriggerRegisterForCharacter(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TriggerRegisterForCharacter(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_TriggerRegisterForParty(S_COL_KethericShowdown_ReadyTrigger_873b22c0-98b0-455c-95f0-b85ef6dcf1b6);

//REGION DIALOG

//INCLUSIONS
DB_Inclusion_NPCDialog((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,(CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,(CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f,(CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

DB_AddCharactersInTriggerToDialog(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391,S_COL_KethericShowdown_ReadyTrigger_873b22c0-98b0-455c-95f0-b85ef6dcf1b6,1,1,1,1);
DB_AddCharactersInTriggerToDialog(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,1,1,1,1);
DB_AddCharactersInTriggerToDialog(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,1,1,1,1);
DB_AddCharactersInTriggerToDialog(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,1,1,1,1);

DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f);

SetOnStage(S_COL_KethericShowdown_Apostle_Helper_57017856-e080-405b-a849-f5fdc3d3827b,0);
SetOnStage(S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d,0);
PROC_SetOnStage(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32,0);

//END_REGION

//Nightsong prefers attacking Ketheric
AddPreferredAiTargetTag((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(TAG)ACT2_MOO_KETHERIC_01d32285-432f-4430-a85b-c50ddf98d9d2);
AddPreferredAiTargetTag((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(TAG)APOSTLE_OF_MYRKUL_7fb75b00-68b1-4217-874e-6ce1812d20e8);

DB_COL_ChosenThreeOverrides((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_COL_ChosenThreeOverrides((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_COL_ChosenThreeOverrides((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

//position flags
DB_GLO_Cinematic_PositionedDialog((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,"COL_KethericIntro");
DB_GLO_Cinematic_PositionFlags("COL_KethericIntro",(TRIGGER)S_COL_KethericShowdown_KethericIntro_Backside_Trigger_c48f3c83-0dd2-4651-a4bb-ccf1b6a5a0e4,(FLAG)COL_KethericShowdown_Event_KethericIntro_BacksideApproach_193a69b5-be17-435b-8174-9258ec67a87a);
PROC_TriggerRegisterForPlayers((TRIGGER)S_COL_KethericShowdown_KethericIntro_Backside_Trigger_c48f3c83-0dd2-4651-a4bb-ccf1b6a5a0e4);

//Spell cast ADs always available
DB_COL_KethericShowdown_ADs((GUIDSTRING)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,(DIALOGRESOURCE)COL_KethericShowdown_AD_KethericCommandTroops_3426bfa3-8900-a6fb-982a-f796562f56e8,0,"",2.0,(GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,COL_KethericShowdown_AD_KethericFingerOfDeath_f9fdab91-a4c4-5b9e-1cf2-6ce5830149ae,0,"",0.0,NULL_00000000-0000-0000-0000-000000000000);

//Entrance door
DB_FlagReactionAfterDialog(COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33,COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391);
PROC_TriggerRegisterForParty(S_COL_KethericShowdown_Door_InsideTrigger_f15f508f-d81e-4903-ad1d-9cc96ef952bb);

DB_GlobalFlagReactionAfterDialog((FLAG)COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0,(DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d);
DB_GlobalFlagReactionAfterDialog((FLAG)ORI_Gale_Event_ColonyExplosion_7ff2626a-c1ff-829a-8bcf-90d763e8b2e9,(DIALOGRESOURCE)COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f);
DB_FlagReactionAfterDialog((FLAG)COL_EntranceDoor_State_Open_437c3db8-2383-326c-37af-0ae96cb7fb71,(DIALOGRESOURCE)COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391);

DB_COL_KethericShowdown_IntellectDevourers((CHARACTER)S_COL_ShowdownIntDev_01_3ade155b-2ee8-41ba-9710-ca8e043ee5a1);
DB_COL_KethericShowdown_IntellectDevourers((CHARACTER)S_COL_ShowdownIntDev_02_7460ee43-9fb9-47d4-ae1d-a09d75a85640);
DB_COL_KethericShowdown_IntellectDevourers((CHARACTER)S_COL_ShowdownIntDev_03_9425d831-ef6e-4915-99b9-0a381f7435d2);
DB_COL_KethericShowdown_IntellectDevourers((CHARACTER)S_COL_ShowdownIntDev_04_09ad9993-a279-4aa9-89cf-6d9b7a51ebad);

DB_COL_KethericShowdown_CineOnlyCharacters((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac);
DB_COL_KethericShowdown_CineOnlyCharacters((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
DB_COL_KethericShowdown_CineOnlyCharacters((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

DB_PartyDialogSuppressionZone(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf);

PROC_COL_KethericShowdown_PreInit();
KBSECTION
//REGION Debug Hooks

IF
FlagSet((FLAG)COL_KethericShowdown_Debug_Start_96d49abf-d7c7-e4c0-d699-f7d6045848f3,_,_)
THEN
PROC_COL_KethericShowdown_Debug_Start();
ClearFlag((FLAG)COL_KethericShowdown_Debug_Start_96d49abf-d7c7-e4c0-d699-f7d6045848f3);

IF
TextEvent("KethericShowdown_Start")
THEN
PROC_COL_KethericShowdown_Debug_Start();

PROC
PROC_COL_KethericShowdown_Debug_Start()
THEN
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");
DB_OnlyOnce("COL_KethericShowdown_ChosenThree");
PROC_TeleportPartiesTo((TRIGGER)S_COL_ShowdownStartPoint_cd12947b-cd64-4985-9dbb-b8dcb2cd2155,"");
PROC_COL_KethericShowdown_ChosenThree_CleanUp();
PROC_COL_KethericShowdown_Init();

IF
TextEvent("KethericShowdown_ChosenThree")
THEN
NOT DB_OnlyOnce("COL_KethericShowdown_ChosenThree");
PROC_TeleportPartiesTo((TRIGGER)S_COL_ShowdownStartPoint_cd12947b-cd64-4985-9dbb-b8dcb2cd2155,"");

IF
TextEvent("KethericShowdown_FreeNightsong")
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);

IF
TextEvent("KethericShowdown_NightsongDowned")
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(1);

IF
TextEvent("KethericShowdown_KillNightsong")
AND
GetHostCharacter(_Player)
THEN
NOT DB_PreventPermaDefeated(S_SHA_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SHA_Nightsong_PermaKill(_Player);
Die(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
TimerLaunch("COL_KethericShowdown_NightsongCheck",1000);

IF
TimerFinished("COL_KethericShowdown_NightsongCheck")
THEN
PROC_COL_KethericShowdown_NightsongPresentCheck();

IF
TextEvent("KethericShowdown_IsobelPresent")
THEN
SetFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce);
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_AtMoonrise");
TimerLaunch("COL_KethericShowdown_IsobelCheck",1000);

IF
FlagSet((FLAG)COL_KethericShowdown_Debug_AudienceRoute_e09091b7-25d9-9c24-409c-ef463acb966e,_,_)
THEN
PROC_COL_KethericShowdown_Debug_AudienceRoute();
ClearFlag((FLAG)COL_KethericShowdown_Debug_AudienceRoute_e09091b7-25d9-9c24-409c-ef463acb966e);

IF
TextEvent("KethericShowdown_AudienceRoute")
THEN
PROC_COL_KethericShowdown_Debug_AudienceRoute();

IF
TimerFinished("COL_KethericShowdown_IsobelCheck")
THEN
PROC_COL_KethericShowdown_IsobelPresentCheck();

IF
FlagSet((FLAG)COL_KethericShowdown_Debug_AssaultRoute_b30dbb8d-122f-2553-dedb-1691f455c4d5,_,_)
THEN
PROC_COL_KethericShowdown_Debug_AssaultRoute();
ClearFlag((FLAG)COL_KethericShowdown_Debug_AssaultRoute_b30dbb8d-122f-2553-dedb-1691f455c4d5);

IF
TextEvent("KethericShowdown_AssaultRoute")
THEN
PROC_COL_KethericShowdown_Debug_AssaultRoute();

PROC
PROC_COL_KethericShowdown_Debug_AudienceRoute()
AND
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
Resurrect(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

PROC
PROC_COL_KethericShowdown_Debug_AudienceRoute()
THEN
SetFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce);
SetFlag(MOO_Audience_Event_PassTeleporter_3115b554-2e0e-cbdc-6166-5fa7586cae45);
ClearFlag(MOO_Assault_State_ConvincedKetheric_dffdf447-f3d6-32ad-2bbb-8f87402fef74);
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_AtMoonrise");
TimerLaunch("COL_KethericShowdown_IsobelCheck",1000);

PROC
PROC_COL_KethericShowdown_Debug_AssaultRoute()
AND
DB_Dead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
Resurrect(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

PROC
PROC_COL_KethericShowdown_Debug_AssaultRoute()
THEN
ClearFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce);
ClearFlag(MOO_Audience_Event_PassTeleporter_3115b554-2e0e-cbdc-6166-5fa7586cae45);
SetFlag(MOO_Assault_State_ConvincedKetheric_dffdf447-f3d6-32ad-2bbb-8f87402fef74);
PROC_COL_KethericShowdown_Init();

IF
FlagSet((FLAG)COL_KethericShowdown_Debug_Transform_c1e2755b-3ce0-cbf9-3a08-74c00d342b2b,_,_)
THEN
PROC_COL_KethericShowdown_Debug_Transform();
ClearFlag((FLAG)COL_KethericShowdown_Debug_Transform_c1e2755b-3ce0-cbf9-3a08-74c00d342b2b);

IF
TextEvent("KethericShowdown_Transform")
THEN
PROC_COL_KethericShowdown_Debug_Transform();

PROC
PROC_COL_KethericShowdown_Debug_Transform()
AND
NOT DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();
PROC_COL_KethericShowdown_Init();

PROC
PROC_COL_KethericShowdown_Debug_Transform()
THEN
DB_OnlyOnce("COL_KethericShowdown_ChosenThree");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");
PROC_COL_KethericShowdown_SetPhase(1);
TimerLaunch("COL_KethericShowdown_Transform",2000);
PROC_TeleportPartiesTo(S_COL_Showdown_KethericDeath_Point_21ab3fb3-f5dd-417f-ab4f-d752219ab7d2,"");

IF
TimerFinished("COL_KethericShowdown_Transform")
AND
DB_Players(_Player)
THEN
PROC_ForceStopDialog(_Player);

IF
TimerFinished("COL_KethericShowdown_Transform")
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);
PROC_ForceStopDialog(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
SetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0);

IF
TextEvent("KethericShowdown_Phase2")
THEN
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_PHASE3_NECROMITE_HELPER");
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Phase2_FadeOut");

IF
TextEvent("KethericShowdown_Phase3")
THEN
PROC_COL_KethericShowdown_EnterPhase_3();

IF
FlagSet((FLAG)COL_KethericShowdown_Debug_Defeat_5d42b035-661c-c1e4-7668-3230745c2894,_,_)
THEN
PROC_COL_KethericShowdown_Debug_Defeat();
ClearFlag((FLAG)COL_KethericShowdown_Debug_Defeat_5d42b035-661c-c1e4-7668-3230745c2894);

IF
TextEvent("KethericShowdown_Defeat")
THEN
PROC_COL_KethericShowdown_Debug_Defeat();

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
AND
DB_GLO_DefeatCounter(_Char, "COL_KethericShowdown_KillCounter_Minion")
THEN
Die(_Char, DEATHTYPE.DoT, 1);

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
AND
GetEquippedItem((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"Breast",(ITEM)_Armor)
THEN
DB_COL_KethericShowdown_KethericArmor((ITEM)_Armor);
PROC_TeleportToAndOffStage(_Armor,S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8,"",0,0,0,0,1); //teleports to asylum character

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
AND
IsDead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0)
THEN
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"INVULNERABLE_NOT_SHOWN");
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"PARALYZED");
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"STUNNED");
PROC_EnterCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
SetFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415,NULL_00000000-0000-0000-0000-000000000000,0);
PROC_TeleportPartiesTo(S_COL_Showdown_KethericDeath_Point_21ab3fb3-f5dd-417f-ab4f-d752219ab7d2,"");

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
AND
NOT DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();
PROC_COL_KethericShowdown_Init();

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
THEN
DB_OnlyOnce("COL_KethericShowdown_ChosenThree");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_INVULNERABLE");
PROC_SetRelationMutual(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,0);
PROC_SetRelationMutual(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd,(FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4,0);
DB_COL_KethericShowdown_ForcePlayersEnterCombat(1);
SetImmortal(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0);
PROC_COL_KethericShowdown_SetPhase(3);
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM",-1.0,1);
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_COL_ShowdownKethericPhase3_Pos_6ec38505-b588-4ea0-8b33-8deec08c2eff);
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_PHASE3_NECROMITE_HELPER",-1.0,1);
TimerLaunch("COL_KethericShowdown_Defeat",1000);

IF
TimerFinished("COL_KethericShowdown_Defeat")
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);
Die(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,DEATHTYPE.None,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1,1);

//END_REGION

//REGION Helper PROCs

PROC
PROC_COL_KethericShowdown_SetPhase((INTEGER)_)
AND
DB_COL_KethericShowdown_CurrentPhase(_Phase)
THEN
NOT DB_COL_KethericShowdown_CurrentPhase(_Phase);

PROC
PROC_COL_KethericShowdown_SetPhase((INTEGER)_Phase)
THEN
DB_COL_KethericShowdown_CurrentPhase(_Phase);

//Cue cinematic procedure
PROC
PROC_COL_KethericShowdown_CueCinematic((STRING)_FadeId)
AND
DB_InRegion(_Player,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
DB_Players(_Player)
AND
NOT DB_COL_KethericShowdown_FadeEvents(_Player,_FadeId)
THEN
SetEntityEventReal(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"GLO_CombatWait",4.0);
ScreenFadeTo(_Player,2.0,0,_FadeId);
TimerCancel(_FadeId);
TimerLaunch(_FadeId,2000);
DB_COL_KethericShowdown_FadeEvents(_Player,_FadeId);

//Fade in after fade out
IF
ScreenFadeDone(_,_FadeId)
AND
DB_COL_KethericShowdown_FadeEvents(_Character,_FadeId)
THEN
ClearScreenFade(_Character, 2.0, _FadeId);
SetEntityEvent(_Character,_FadeId);

IF
EntityEvent(_Character,_FadeId)
AND
DB_COL_KethericShowdown_FadeEvents((CHARACTER)_Character,_FadeId)
THEN
NOT DB_COL_KethericShowdown_FadeEvents((CHARACTER)_Character, _FadeId);

//END_REGION

//REGION BEFORE COMBAT

//REGION Map marker directions

IF
FlagSet(COL_NecromancerLab_Knows_KethericLocation_fccb0429-b0dd-670a-659a-3584fbb5ab22,_,_)
AND
NOT DB_GlobalFlag((FLAG)COL_KethericShowdown_Knows_ToldKethericLocation_73c66afd-6ffa-a08c-0230-71cfd7513aad)
THEN
SetFlag(COL_KethericShowdown_Knows_ToldKethericLocation_73c66afd-6ffa-a08c-0230-71cfd7513aad);

IF
FlagSet((FLAG)COL_KethericShowdown_State_ToldKethericLocation_73c66afd-6ffa-a08c-0230-71cfd7513aad,_,_)
AND
NOT DB_GlobalFlag((FLAG)MOO_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
DB_Players(_Player)
THEN
PROC_ShowMarker(_Player,"COL_KethericShowdown_EntranceDoor");

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_Players(_Player)
THEN
PROC_HideMarker(_Player,"COL_KethericShowdown_EntranceDoor");

//END_REGION

//REGION Setup (boss room enter)

PROC
PROC_COL_KethericShowdown_PreInit()
AND
DB_COL_KethericShowdown_CineOnlyCharacters(_Character)
THEN
SetImmortal((CHARACTER)_Character,1);

//Initialize all states at the point of entering the boss chamber
PROC
PROC_COL_KethericShowdown_Init()
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03);
PROC_GlobalSetFlagAndCache(HAV_Siege_State_NoMoreSiege_2129857a-bfa2-49c4-a853-c7e08a2fa632);
PROC_COL_KethericShowdown_IsobelPresentCheck();
PROC_COL_KethericShowdown_NightsongPresentCheck();

//KETHERIC SETUP
//Remember health but cap at minimum percentage
PROC
PROC_COL_KethericShowdown_Init()
AND
GetHitpointsPercentage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Percentage)
THEN
DB_COL_KethericShowdown_KethericHealth(_Percentage);

PROC
PROC_COL_KethericShowdown_Init()
THEN
PROC_CharacterFullRestore(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
RealtimeObjectTimerLaunch(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"COL_KethericShowdown_RememberHealth",1000);

IF
ObjectTimerFinished(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"COL_KethericShowdown_RememberHealth")
AND
NOT QRY_COL_KethericShowdown_RememberedKethericHealth_IsInvulnerable()
THEN
PROC_COL_KethericShowdown_SetRememberedKethericHealth();

QRY
QRY_COL_KethericShowdown_RememberedKethericHealth_IsInvulnerable()
AND
HasActiveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_INVULNERABLE",1)
THEN
DB_COL_KethericShowdown_RememberedKethericHealth_HandleInvulnerability(1);
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_INVULNERABLE",NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_INVULNERABLE",_,_)
AND
DB_COL_KethericShowdown_RememberedKethericHealth_HandleInvulnerability(1)
THEN
PROC_COL_KethericShowdown_SetRememberedKethericHealth();
NOT DB_COL_KethericShowdown_RememberedKethericHealth_HandleInvulnerability(1);
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_INVULNERABLE",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_COL_KethericShowdown_SetRememberedKethericHealth()
AND
DB_COL_KethericShowdown_KethericHealth(_Percentage)
AND
_Percentage > 60.0
THEN
SetHitpointsPercentage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Percentage);
NOT DB_COL_KethericShowdown_KethericHealth(_Percentage);

PROC
PROC_COL_KethericShowdown_SetRememberedKethericHealth()
AND
DB_COL_KethericShowdown_KethericHealth(_Percentage)
AND
_Percentage < 60.00001
THEN
SetHitpointsPercentage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,60.0);
NOT DB_COL_KethericShowdown_KethericHealth(_Percentage);

PROC
PROC_COL_KethericShowdown_Init()
AND
NOT GetEquippedItem((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"Melee Main Weapon",_)
AND
CreateAtObject(WPN_HUM_Flail_Myrkul_A_0_4c86f6ac-5829-41f2-a3f0-d3e893334961,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0,0,"",0,_Weapon)
THEN
Equip((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,(ITEM)_Weapon,1,0,1);

PROC
PROC_COL_KethericShowdown_Init()
THEN
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
PROC_SetOnStage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1);
SetFaction(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,(FACTION)ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd);
SetCanJoinCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1);
PROC_SetCanFight(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1);
ClearTag(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,ACT2_MOO_KETHERIC_BLOCKCOMMAND_e97caba7-e96d-46d6-a1ac-01bade846aeb);
SetAiHint(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,(TAG)AI_HINT_UNIQUE_1902723d-dd16-4e7a-87d6-7b07f63add79);
SetStayInAiHints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1);
SetImmortal(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1);
PROC_COL_KethericShowdown_SetSpotting(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_COL_Showdown_KethericInitial_Pos_320a0b2e-5bd4-49ca-aed9-2f2e88fde2c4);
SetCombatGroupID(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"775a7162-7b0d-aa73-4d6d-3fd0a1cdecc7");
PROC_SceneOver("MOO_Execution");

PROC
PROC_CharacterRegisterCrime_Success((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_,_,_,_,_CrimeId)
AND
DB_GlobalFlag((FLAG)COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
THEN
DB_CRIME_InvestigationNoWalkingTalking(_CrimeId);

QRY
QRY_CRIME_BlockGenericInvestigation((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
DB_GlobalFlag((FLAG)COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
THEN
DB_NOOP(1);

//NIGHTSONG SETUP
PROC
PROC_COL_KethericShowdown_NightsongPresentCheck()
AND
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_INVULNERABLE");

PROC
PROC_COL_KethericShowdown_NightsongPresentCheck()
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
HasAppliedStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_NIGHTSONG_SOULCAGE",1)
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_NIGHTSONG_SOULCAGE",NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_COL_KethericShowdown_NightsongPresentCheck()
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");
PROC_SetRelationToPlayers(ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4,100);
PROC_SetHitpointsPercentageMinimum(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,50.0);
SetForceUpdate(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
PROC_SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"MOO_NIGHTSONG_MOONBEAM",NULL_00000000-0000-0000-0000-000000000000);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_COL_Showdown_NightsongInitial_Pos_a86ed251-ef22-4bab-8e64-97d13425eb55);
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0); // this gets undone once Ketheric enters combat
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0); // --------------------------------------------
SetFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4);
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol");
PROC_COL_KethericShowdown_SetNightsongCaged(1);

//ISOBEL SETUP

PROC
PROC_COL_KethericShowdown_IsobelPresentCheck()
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce)
AND
DB_Dead((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
SetTag(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(TAG)UNDEAD_33c625aa-6982-4c27-904f-e47029a9b140);

//Sets Isobel (tadpoled) present at showdown if she needs to be here
PROC
PROC_COL_KethericShowdown_IsobelPresentCheck()
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce)
THEN
PROC_CharacterFullRestore(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_SetOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,1);
SetCanJoinCombat(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,1);
RemoveStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"HAV_ISOBEL_MOONRITUAL",NULL_00000000-0000-0000-0000-000000000000);
TeleportTo(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,S_COL_KethericShowdown_Isobel_Point_c5737105-0262-4323-911c-8954bc86888a);
SetFaction(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(FACTION)ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd);
PROC_COL_KethericShowdown_SetSpotting(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
SetCombatGroupID(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"775a7162-7b0d-aa73-4d6d-3fd0a1cdecc7");
SetTag(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed);
ApplyStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"COL_ISOBEL_ENEMY_VFX",-1.0,0,NULL_00000000-0000-0000-0000-000000000000);

IF
Dying((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
DB_InRegion((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(TRIGGER)S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
THEN
SetFlag(COL_KethericShowdown_State_IsobelDiedInCOL_59810510-848e-46f3-2a7f-3f490407d954);

//MINION SETUP
PROC
PROC_COL_KethericShowdown_Init()
AND
DB_GLO_DefeatCounter(_Enemy,"COL_KethericShowdown_KillCounter_Minion")
THEN
PROC_COL_KethericShowdown_SetSpotting((CHARACTER)_Enemy);

//SPOTTING PROC
PROC
PROC_COL_KethericShowdown_SetSpotting((CHARACTER)_Character)
THEN
DB_SpotPlayers(_Character, "COL_KethericShowdown", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeWildshapedPlayers(_Character, "COL_KethericShowdown");
DB_SpotPlayers_IncludeSummons(_Character, "COL_KethericShowdown");

PROC
PROC_COL_KethericShowdown_StopSpotting()
AND
DB_SpotPlayers(_Character, "COL_KethericShowdown", _,_)
THEN
NOT DB_SpotPlayers(_Character, "COL_KethericShowdown", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SpotPlayers_IncludeWildshapedPlayers(_Character, "COL_KethericShowdown");
NOT DB_SpotPlayers_IncludeSummons(_Character, "COL_KethericShowdown");

//END_REGION

//REGION Entrance door ready check

//Try boss door
//Players not ready
IF
UseFinished(_Character,(ITEM)S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc,1)
AND
NOT DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
NOT DB_InRegion(_Character,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
QRY_KethericShowdown_DoReadyCheck(_Character)
THEN
OpenMessageBox(_Character, "ReadyCheck_PartyMemberNotReady");

//Showdown has already started
IF
UseFinished(_Character,(ITEM)S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc,1)
AND
NOT DB_InRegion(_Character,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
THEN
PROC_COL_KethericShowdown_StartEntry(_Character);

IF
UseFinished(_Character,(ITEM)S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc,1)
AND
DB_Players(_Character)
AND
QRY_COL_KethericShowdown_Entrance_CanInteract(_Character)
THEN
TimerLaunch("COL_TadpoleDoors_Interaction",50);
DB_COL_TadpoleDoors_Interaction(_Character,S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc);

//Showdown has not started, players ready
QRY
QRY_COL_KethericShowdown_Entrance_CanInteract((CHARACTER)_Character)
AND
NOT DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
NOT DB_InRegion(_Character,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
NOT QRY_KethericShowdown_DoReadyCheck(_Character)
THEN
DB_NOOP(1);

//Other side of the door
QRY
QRY_COL_KethericShowdown_Entrance_CanInteract((CHARACTER)_Character)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
DB_InRegion(_Character,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
THEN
DB_NOOP(1);

//This delay is necessary for the Ketheric Showdown ready check to work correctly
//TODO: fix timer dependency, rely on events
IF
TimerFinished("COL_TadpoleDoors_Interaction")
AND
DB_COL_TadpoleDoors_Interaction(_Character,_Door)
AND
QRY_StartDialog_Fixed(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391,_Door,_Character)
THEN
DB_COL_Entrance_Speaker(_Character);
NOT DB_COL_TadpoleDoors_Interaction(_Character,_Door);

IF
DialogStarted(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391,_)
AND
DB_COL_Entrance_Speaker(_Speaker)
THEN
NOT DB_COL_Entrance_Speaker(_Speaker);

PROC
PROC_DialogFlagSetup(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391, S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc, _Character)
AND
DB_InRegion((CHARACTER)_Character,S_COL_KethericShowdown_Door_InsideTrigger_f15f508f-d81e-4903-ad1d-9cc96ef952bb)
THEN
SetFlag((FLAG)COL_EntranceDoor_State_Inside_c84cd9d6-c62f-87f3-e644-9d2c99c7ab64, _Character, 1);

PROC
PROC_DialogFlagSetup(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391, S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc, _Character)
AND
NOT DB_InRegion((CHARACTER)_Character,S_COL_KethericShowdown_Door_InsideTrigger_f15f508f-d81e-4903-ad1d-9cc96ef952bb)
THEN
ClearFlag((FLAG)COL_EntranceDoor_State_Inside_c84cd9d6-c62f-87f3-e644-9d2c99c7ab64, _Character, 1);

IF
DialogEnded((DIALOGRESOURCE)COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,1)
AND
GetFlag(COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33,_Player,0)
THEN
ClearScreenFade((CHARACTER)_Player,1.0,"COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391",1);

IF
DialogEnded((DIALOGRESOURCE)COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,1)
AND
GetFlag(COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33,_Player,1)
THEN
ClearFlag(COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33,_Player);

PROC
PROC_FlagReactionAfterDialog(S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc,(FLAG)COL_EntranceDoor_State_Open_437c3db8-2383-326c-37af-0ae96cb7fb71)
THEN
SetOnStage(S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d,1);
Unlock((ITEM)S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d);
Open((ITEM)S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d);
SetCanInteract((ITEM)S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d,0);

IF
WentOnStage(S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d,1)
THEN
SetOnStage(S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc,0);

PROC
PROC_FlagReactionAfterDialog(_Character,COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33)
THEN
PROC_COL_KethericShowdown_StartEntry((CHARACTER)_Character);
DB_COL_KethericShowdown_EntryInitiator(_Character);

PROC
PROC_COL_KethericShowdown_StartEntry((CHARACTER)_Character)
AND
DB_InRegion(_Player,S_COL_KethericShowdown_ReadyTrigger_873b22c0-98b0-455c-95f0-b85ef6dcf1b6)
AND
DB_Players(_Player)
AND
NOT DB_COL_KethericShowdown_FadeEntry(_Player)
THEN
RealtimeObjectTimerLaunch(_Player,"COL_KethericShowdown_Entrance",1000);
DB_COL_KethericShowdown_FadeEntry(_Player);

//Ready check
QRY
QRY_KethericShowdown_DoReadyCheck((CHARACTER)_Character)
AND
DB_Players(_Player)
AND
_Player!=_Character
AND
DB_CantTalk_IgnoreStatusesDead(_Player)
THEN
DB_NOOP(1);

//Fade in and enter chamber
IF
ObjectTimerFinished(_Player,"COL_KethericShowdown_Entrance")
AND
DB_COL_KethericShowdown_FadeEntry((CHARACTER)_Player)
THEN
RealtimeObjectTimerLaunch(_Player,"COL_KethericShowdown_Entrance_FadeIn",5000);
PROC_COL_KethericShowdown_TeleportPlayerToEntrance(_Player);

IF
ObjectTimerFinished(_Player,"COL_KethericShowdown_Entrance_FadeIn")
THEN
ClearScreenFade((CHARACTER)_Player,2.0,"COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391",1);
NOT DB_COL_KethericShowdown_FadeEntry((CHARACTER)_Player);

PROC
PROC_COL_KethericShowdown_TeleportPlayerToEntrance((CHARACTER)_Player)
AND
DB_InRegion(_Player,S_COL_KethericShowdown_ReadyTrigger_873b22c0-98b0-455c-95f0-b85ef6dcf1b6)
THEN
TeleportTo(_Player, S_DEBUG_COL_ShowdownStartPoint_cd12947b-cd64-4985-9dbb-b8dcb2cd2155,"",1,1,1,1,1);

PROC
PROC_COL_KethericShowdown_TeleportPlayerToEntrance((CHARACTER)_Player)
AND
DB_PartyMembers(_Follower)
AND
NOT DB_Players(_Follower)
AND
NOT DB_COL_KethericShowdown_FadeEntry((CHARACTER)_Follower)
AND
CharacterGetOwner(_Follower,_Player)
AND
IsInTrigger(_Follower,(TRIGGER)S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,0)
THEN
TeleportTo(_Follower, S_DEBUG_COL_ShowdownStartPoint_cd12947b-cd64-4985-9dbb-b8dcb2cd2155,"",1,1,1,1,1);

//END_REGION

//REGION Ketheric Showdown dialog inclusions (helpers/overrides)

//Speaker availability overrides
QRY
QRY_SpeakerIsInDialogRange((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _)
AND
DB_InRegion(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
QRY_COL_KethericShowdown_AnyPlayerInChamber()
THEN
DB_NOOP(1);

QRY
QRY_SpeakerIsInDialogRange((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _)
AND
DB_InRegion(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
QRY_COL_KethericShowdown_AnyPlayerInChamber()
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_AnyPlayerInChamber()
AND
DB_Players(_Player)
AND
DB_InRegion(_Player,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
THEN
DB_NOOP(1);

//END_REGION

//REGION Chosen Three intro cinematic

IF
DB_InRegion(_Character,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
DB_Players(_Character)
AND
QRY_OnlyOnce("COL_KethericShowdown_ChosenThree")
THEN
PROC_COL_KethericShowdown_EnteredChamber();

PROC
PROC_COL_KethericShowdown_EnteredChamber()
THEN
PROC_COL_KethericShowdown_Init();
//Init needs to happen before start dialog

PROC
PROC_COL_KethericShowdown_EnteredChamber()
AND
NOT DB_COL_KethericShowdown_EntryInitiator(_)
AND
QRY_GetClosestAvailableCharacterTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Player,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_,1)
AND
NOT DB_COL_KethericShowdown_EntryInitiator(_) //to "break" out of the DB loop
THEN
DB_COL_KethericShowdown_EntryInitiator(_Player);

PROC
PROC_COL_KethericShowdown_EnteredChamber()
AND
NOT DB_COL_KethericShowdown_EntryInitiator(_)
AND
DB_ClosestAvailableCharacterTo(_Player,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_)
AND
NOT DB_COL_KethericShowdown_EntryInitiator(_) //to "break" out of the DB loop
THEN
DB_COL_KethericShowdown_EntryInitiator(_Player);

//Entry initiator as primary GROUP_Players speaker
PROC
PROC_COL_KethericShowdown_EnteredChamber()
AND
DB_COL_KethericShowdown_EntryInitiator(_Char)
AND
QRY_COL_KethericShowdown_EntryInitiatorOverride(_Char)
AND
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Override)
AND
NOT QRY_StartDialogCustom_Fixed(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac,
S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,S_COL_ElderBrain_f0747a7b-1ed8-479a-bf44-a809de84364e,S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,_Override,0,0,0,0)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();

PROC
PROC_COL_KethericShowdown_EnteredChamber()
AND
NOT DB_COL_KethericShowdown_EntryInitiator(_)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();

//All players must see the dialog
//Followers and summons are also included so they cannot act during the dialog
PROC
PROC_StartDialog_AddExtraSpeakers(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_DialogId)
AND
DB_PartyMembers(_Char)
AND
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char)
AND
QRY_SpeakerIsAvailable(_Char)
AND
IsInTrigger(_Char, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1)
THEN
PROC_DialogAddSpeakingActor(_DialogID, _Char,0,1); //add speakers to dedicated slots
PROC_COL_KethericShowdown_ChosenThree_CheckIfLinkedToAvatar((CHARACTER)_Char, _DialogId);

IF
DB_DialogName(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_DialogId)
AND
NOT DB_DialogEnding(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_DialogId)
AND
DB_PartyMembers(_Char)
AND
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char)
THEN
PROC_DialogAddSpeakingActor(_DialogId,_Char,1,0); //add listener

//Track party member speakers for ChosenThree to avoid a double add
//Adding speakers to a dialog twice may take them out of the dialog instead
PROC
PROC_DialogAddSpeakingActor(_DialogId,(GUIDSTRING)_Char,_,_)
AND
DB_DialogName((DIALOGRESOURCE)COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_DialogId)
AND
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char)
THEN
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char);

IF
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Char)
AND
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char)
THEN
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char);

IF
DialogActorJoinFailed((DIALOGRESOURCE)COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_,_Char)
AND
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char)
THEN
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char);

IF
DialogActorLeft((DIALOGRESOURCE)COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_,_Char,_)
AND
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char)
THEN
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char);

IF
DialogEnded((DIALOGRESOURCE)COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_)
AND
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char)
THEN
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers((GUIDSTRING)_Char);

QRY
QRY_DialogShouldIgnoreMutingStatusses((DIALOGRESOURCE)COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_,_)
AND
DB_QRYRTN_DialogShouldIgnoreMutingStatusses(0)
THEN
NOT DB_QRYRTN_DialogShouldIgnoreMutingStatusses(0);
DB_QRYRTN_DialogShouldIgnoreMutingStatusses(1);

//REGION Chosen Three OMs

PROC
PROC_COL_KethericShowdown_ChosenThree_CheckIfLinkedToAvatar((CHARACTER)_Char, (INTEGER)_DialogId)
THEN
ClearFlag(COL_KethericShowdown_State_ControlledByActiveSpeakerAvatar_668e06c3-f61a-a58b-b31e-e7cbcb07883d, _Char, 0);

PROC
PROC_COL_KethericShowdown_ChosenThree_CheckIfLinkedToAvatar((CHARACTER)_Char, (INTEGER)_DialogId)
AND
DB_DialogRequestCache_SpeakerList_Players(_, _DialogId, _Speaker, 1)
AND
DB_Avatars((CHARACTER)_Speaker)
AND
NOT DB_Avatars(_Char)
AND
QRY_SameUser(_Char, _Speaker)
THEN
SetFlag(COL_KethericShowdown_State_ControlledByActiveSpeakerAvatar_668e06c3-f61a-a58b-b31e-e7cbcb07883d, _Char, 0);

PROC
PROC_COL_KethericShowdown_ChosenThree_CheckIfLinkedToAvatar((CHARACTER)_Char, (INTEGER)_DialogId)
AND
DB_DialogPlayers(_DialogId, _Speaker, 1)
AND
DB_Avatars((CHARACTER)_Speaker)
AND
NOT DB_Avatars(_Char)
AND
QRY_SameUser(_Char, _Speaker)
THEN
SetFlag(COL_KethericShowdown_State_ControlledByActiveSpeakerAvatar_668e06c3-f61a-a58b-b31e-e7cbcb07883d, _Char, 0);

PROC
PROC_GlobalFlagReactionAfterDialog(ORI_Gale_Event_ColonyExplosion_7ff2626a-c1ff-829a-8bcf-90d763e8b2e9)
THEN
DB_COL_KethericShowdown_GaleExplosionCredits(1);
PROC_StartMovie("Credits");

IF
CreditsEnded()
AND
DB_COL_KethericShowdown_GaleExplosionCredits(1)
THEN
NOT DB_COL_KethericShowdown_GaleExplosionCredits(1);
PROC_GameEndWithMovie("");

//END_REGION

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_COL_KethericShowdown_EntryInitiator(_Player)
THEN
PROC_COL_MizorasRescue_PlayerEnteredShowdown((CHARACTER)_Player);
NOT DB_COL_KethericShowdown_EntryInitiator(_Player);

IF
DialogEnded(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_COL_KethericShowdown_CineOnlyCharacters(_Character)
THEN
SetOnStage(_Character,0);
PROC_COL_KethericShowdown_CleanUpCineCharacter(_Character);

IF
LeftLevel(_Character,"SCL_Main_A")
AND
DB_COL_KethericShowdown_CineOnlyCharacters((CHARACTER)_Character)
THEN
PROC_COL_KethericShowdown_CleanUpCineCharacter((CHARACTER)_Character);

PROC
PROC_COL_KethericShowdown_CleanUpCineCharacter((CHARACTER)_Character)
THEN
SetImmortal(_Character,0);
NOT DB_COL_KethericShowdown_CineOnlyCharacters(_Character);

//END_REGION

//REGION Select correct speaker for the Chosen Three dialogue

//Clear database
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_)
AND
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Character)
THEN
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Character);

//Prefer Gale user's avatar or avatar Gale
//Initiator is avatar Gale
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_)
AND
DB_COL_ChosenThreeOverrides(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_COL_KethericShowdown_EntryInitiator((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SpeakerIsAvailable(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

//Initiator is avatar of the same user as Gale
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_)
AND
DB_COL_ChosenThreeOverrides(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_COL_KethericShowdown_EntryInitiator((CHARACTER)_Avatar)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SpeakerIsAvailable(_Avatar)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Avatar);

//Initiator is not avatar of same user as Gale nor avatar Gale - so try to use avatar Gale (if he is here)
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_)
AND
DB_COL_ChosenThreeOverrides(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
IsInTrigger(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,1)
AND
QRY_SpeakerIsAvailable(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

//Initiator is not avatar of same user as Gale nor avatar Gale, nor is avatar Gale here - so try to use avatar of same user as Gale (if Gale is here)
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_)
AND
DB_COL_ChosenThreeOverrides(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
IsInTrigger(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,1)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_) //breaks out of avatar loop
AND
QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
IsInTrigger(_Avatar,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,1)
AND
QRY_SpeakerIsAvailable(_Avatar)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Avatar);

//If the active player is already a relevant Avatar - use him.
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Speaker)
AND
DB_COL_ChosenThreeOverrides(_Speaker)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_)
AND
DB_Avatars((CHARACTER)_Speaker)
AND
QRY_SpeakerIsAvailable(_Speaker)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Speaker);


//If the active player has a relevant Avatar present, switch to them.
//The other guy goes in the other slot and, if a Companion or Orphan, will do their line.
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Character)
AND
DB_COL_ChosenThreeOverrides(_Speaker)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_)
AND
DB_Avatars(_Speaker)
AND
QRY_SameUser(_Speaker, _Character)
AND
IsInTrigger(_Speaker, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1)
AND
QRY_SpeakerIsAvailable(_Speaker)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Speaker);

//If the Avatar is present but controlled by someone else, switch the control to them.
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Character)
AND
DB_COL_ChosenThreeOverrides(_Speaker)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_)
AND
DB_Avatars(_Speaker)
AND
IsInTrigger(_Speaker, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1)
AND
QRY_SpeakerIsAvailable(_Speaker)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Speaker);

//If the player has one of the relevant Origins and a (different) Avatar, take them, so the Origin Moment can progress as a COM rather than an OOM.
//Try with the best Avatar first, then with any Avatar
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Character)
AND
DB_COL_ChosenThreeOverrides(_Override)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_)
AND
QRY_SameUser(_Override, _Character)
AND
QRY_GetBestAvatarForCompanion(_Override)
AND
DB_QRYRTN_GetBestAvatarForCompanion(_Override, _Avatar)
AND
IsInTrigger(_Avatar, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1)
AND
QRY_SpeakerIsAvailable(_Avatar)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Avatar);

QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Character)
AND
DB_COL_ChosenThreeOverrides(_Override)
AND
DB_Avatars(_Avatar)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_)
AND
QRY_SameUser(_Override, _Character)
AND
QRY_SameUser(_Avatar, _Character)
AND
IsInTrigger(_Avatar, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1)
AND
QRY_SpeakerIsAvailable(_Avatar)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Avatar);

//In other cases, go with whoever started it. Companion Gale or Wyll will either go in their Companion slots (and do their Companion flow) or
//in the main slot (if they were the initiator) and do their Orphan-staged-as-Avatar flow.
QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Character)
AND
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Character);


//END_REGION

//REGION Mizora Rescue: Wyll death

PROC
PROC_COL_MizorasRescue_PlayerEnteredShowdown((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Event_ColonyExplosion_7ff2626a-c1ff-829a-8bcf-90d763e8b2e9)
AND
NOT DB_GlobalFlag((FLAG)COL_MizorasRescue_State_SavedMizora_148bcec2-5367-2b72-3c93-29fb32fc0181)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
PROC_COL_MizoraRescue_StartWyllDeath(_Player);

PROC
PROC_COL_MizoraRescue_StartWyllDeath((CHARACTER)_)
THEN
DB_COL_MizoraRescue_WyllDeath(1);
PROC_ClearOriginMoment((DIALOGRESOURCE)COL_MizorasRescue_OM_Wyll_COM_AOM_OOM_a988e571-00eb-904b-f8f5-0d767dd1aacb);
RealtimeObjectTimerLaunch(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,"COL_MizoraRescue_WyllDeath_FadeTimeout",2000);

PROC
PROC_COL_MizoraRescue_StartWyllDeath((CHARACTER)_Player)
AND
QRY_StartDialog((DIALOGRESOURCE)COL_WyllDeath_cc3747c9-7160-cb21-fb1b-a578192d2c3b,S_COL_TadpoleChamber_Thralls_Pod_003_b051e95c-8a5d-4cf3-badd-5c9112cb5739,S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,_Player)
THEN
DB_NOOP(1);

PROC
PROC_COL_MizorasRescue_PlayerEnteredShowdown((CHARACTER)_)
AND
NOT DB_COL_MizoraRescue_WyllDeath(1)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Event_ColonyExplosion_7ff2626a-c1ff-829a-8bcf-90d763e8b2e9)
AND
DB_Players(_Player)
THEN
ClearScreenFade((CHARACTER)_Player,1.0,"COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f",1);

//End fade for anyone not added to the Wyll death dialogue at this point
IF
ObjectTimerFinished(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,"COL_MizoraRescue_WyllDeath_FadeTimeout")
AND
DB_DialogPlayers(_DialogId,S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,_)
AND
DB_Players(_Player)
AND
NOT DB_DialogPlayers(_DialogId,_Player,_)
THEN
ClearScreenFade((CHARACTER)_Player,1.0,"COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f",1);

IF
ObjectTimerFinished(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,"COL_MizoraRescue_WyllDeath_FadeTimeout")
AND
NOT DB_DialogPlayers(_,S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,_)
AND
DB_Players(_Player)
THEN
ClearScreenFade((CHARACTER)_Player,1.0,"COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f",1);

PROC
PROC_COL_MizorasRescue_PlayerEnteredShowdown((CHARACTER)_)
AND
DB_COL_MizoraRescue_WyllDeath(1)
THEN
NOT DB_COL_MizoraRescue_WyllDeath(1);

//END_REGION

//REGION Ketheric combat intro cinematic

//REGION Ketheric Intro: dialog trigger conditions

//SPOTTED CONDITION
PROC
PROC_SpotPlayers_Spotted(_NPC, "COL_KethericShowdown", _Character)
AND
NOT DB_COL_KethericShowdown_PrimarySpeaker(_)
AND
DB_Players(_Character)
AND
QRY_COL_KethericShowdown_KethericIntro_GetAvailableSpeaker(_Character)
AND
DB_QRYRTN_COL_KethericShowdown_KethericIntro_AvailableSpeaker((CHARACTER)_Speaker)
THEN
DB_COL_KethericShowdown_PrimarySpeaker((CHARACTER)_Speaker);
DB_COL_KethericShowdown_CheckKethericIntroTrigger(1);
PROC_COL_KethericShowdown_StopSpotting();

PROC
PROC_SpotPlayers_Spotted(_NPC, "COL_KethericShowdown", _Character)
AND
NOT DB_COL_KethericShowdown_CheckKethericIntroTrigger(1)
THEN
PROC_COL_KethericShowdown_StopSpotting();
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");
PROC_SetRelationToPlayers((FACTION)ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd,0);

//ASSAULT CRIME CONDITION
PROC
PROC_CharacterRegisterCrime_Success(_PartyMember,_CrimeType,_,_,(CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_)
AND
DB_CRIME_AssaultType(_,_,_CrimeType)
AND
DB_PartyMembers(_PartyMember)
AND
DB_OnlyOnce("COL_KethericShowdown_ChosenThree")
THEN
PROC_SetRelationToPlayers((FACTION)ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd,0);
DB_COL_KethericShowdown_PrimarySpeaker((CHARACTER)_PartyMember);
DB_COL_KethericShowdown_CheckKethericIntroTrigger(1);
PROC_COL_KethericShowdown_StopSpotting();

IF
DB_COL_KethericShowdown_PrimarySpeaker((CHARACTER)_Speaker)
AND
NOT DB_Players(_Speaker)
AND
DB_PartyMembers(_Speaker)
AND
CharacterGetOwner(_Speaker,_Owner)
AND
DB_Players(_Owner)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Speaker);
DB_COL_KethericShowdown_PrimarySpeaker(_Owner);

IF
DB_COL_KethericShowdown_PrimarySpeaker((CHARACTER)_Speaker)
AND
NOT DB_Players(_Speaker)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Speaker);

QRY
QRY_COL_KethericShowdown_KethericIntro_GetAvailableSpeaker((CHARACTER)_Spotted)
AND
DB_QRYRTN_COL_KethericShowdown_KethericIntro_AvailableSpeaker(_Speaker)
THEN
NOT DB_QRYRTN_COL_KethericShowdown_KethericIntro_AvailableSpeaker(_Speaker);

QRY
QRY_COL_KethericShowdown_KethericIntro_GetAvailableSpeaker((CHARACTER)_Spotted)
AND
NOT DB_QRYRTN_COL_KethericShowdown_KethericIntro_AvailableSpeaker(_)
AND
QRY_SpeakerIsAvailable(_Spotted,1)//ignores combat
THEN
DB_QRYRTN_COL_KethericShowdown_KethericIntro_AvailableSpeaker(_Spotted);

QRY
QRY_COL_KethericShowdown_KethericIntro_GetAvailableSpeaker((CHARACTER)_Spotted)
AND
DB_Players(_Player)
AND
_Player != _Spotted
AND
NOT DB_QRYRTN_COL_KethericShowdown_KethericIntro_AvailableSpeaker(_)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player,_Spotted,1,0)//ignores combat
THEN
DB_QRYRTN_COL_KethericShowdown_KethericIntro_AvailableSpeaker(_Player);

IF
DB_COL_KethericShowdown_CheckKethericIntroTrigger(_)
AND
QRY_COL_KethericShowdown_NotPastPhase1()
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Character)
AND
NOT DB_COL_KethericShowdown_CheckKethericIntroTrigger(_)
THEN
DB_COL_KethericShowdown_CheckKethericIntroTrigger(1);

//Ensures Ketheric intro plays after being spotted while in Chosen Three cinematic
IF
DB_COL_KethericShowdown_CheckKethericIntroTrigger(_)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Character)
AND
NOT DB_DialogName(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f,_)
AND
NOT DB_OnlyOnce("COL_KethericShowdown_KethericIntro")
THEN
PROC_COL_KethericShowdown_TryStartIntroDialog(_Character);

IF
DialogStarted(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,_)
AND
DB_COL_KethericShowdown_CheckKethericIntroTrigger(_Value)
THEN
NOT DB_COL_KethericShowdown_CheckKethericIntroTrigger(_Value);

//COMBAT STARTED CONDITION
IF
CombatRoundStarted(_CombatId, 1)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_CombatId)
AND
QRY_COL_KethericShowdown_NotPastPhase1()
AND
QRY_COL_KethericShowdown_GetKethericIntroPrimarySpeaker(_CombatId)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Player)
THEN
PROC_COL_KethericShowdown_TryStartIntroDialog(_Player);

//If KethericIntro is skipped, make sure the DB_OnlyOnce facts are set
IF
CombatRoundStarted(_CombatId,1)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_CombatId)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
NOT DB_OnlyOnce("COL_KethericShowdown_KethericIntro")
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");

QRY
QRY_COL_KethericShowdown_NotPastPhase1()
AND
NOT DB_COL_KethericShowdown_CurrentPhase(_)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_NotPastPhase1()
AND
DB_COL_KethericShowdown_CurrentPhase(_Phase)
AND
_Phase<2
THEN
DB_NOOP(1);

//END_REGION

//TRY START KETHERIC INTRO DIALOG
PROC
PROC_COL_KethericShowdown_TryStartIntroDialog((CHARACTER)_Player)
AND
NOT QRY_COL_KethericShowdown_KethericPhase1Defeated() //dialog will not play if Ketheric was one-shotted
AND
NOT DB_OnlyOnce("COL_KethericShowdown_KethericIntro")
AND
QRY_StartDialogCustom(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Player,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8,S_GLO_Myrkul_9061c1d3-5965-4251-9c07-bcebe53d0660,0,0,0,0)
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");

PROC
PROC_COL_KethericShowdown_TryStartIntroDialog((CHARACTER)_)
AND
NOT DB_OnlyOnce("COL_KethericShowdown_KethericIntro")
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");
PROC_SetRelationToPlayers((FACTION)ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd,0);

IF
DialogEnded((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,_)
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");

IF
DialogEnded((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,_DialogId)
AND
NOT DB_GlobalFlag((FLAG)COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0)
AND
DB_DialogPlayers(_DialogId,_Player,_)
THEN
ClearScreenFade((CHARACTER)_Player,1.0,"COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d",1);

IF
DialogRequestFailed((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,_)
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");
PROC_SetRelationToPlayers((FACTION)ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd,0);

//Get best speaker for showdown combat dialogs
//Try already defined primary speaker
QRY
QRY_COL_KethericShowdown_GetKethericIntroPrimarySpeaker((GUIDSTRING)_CombatId)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Speaker)
AND
NOT QRY_COL_KethericShowdown_IsKethericIntroSpeakerAvailable(_Speaker)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Speaker);

QRY
QRY_COL_KethericShowdown_GetKethericIntroPrimarySpeaker((GUIDSTRING)_CombatId)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Speaker)
AND
NOT DB_Is_InCombat(_Speaker,_CombatId)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Speaker);

//Succeed if there is already an available defined speaker
QRY
QRY_COL_KethericShowdown_GetKethericIntroPrimarySpeaker((GUIDSTRING)_)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Speaker)
THEN
DB_NOOP(1);

//Try avatars
QRY
QRY_COL_KethericShowdown_GetKethericIntroPrimarySpeaker((GUIDSTRING)_CombatId)
AND
DB_Avatars(_Player)
AND
NOT DB_COL_KethericShowdown_PrimarySpeaker(_)
AND
DB_Is_InCombat(_Player,_CombatId)
AND
QRY_COL_KethericShowdown_IsKethericIntroSpeakerAvailable(_Player)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Player);

//Try companions
QRY
QRY_COL_KethericShowdown_GetKethericIntroPrimarySpeaker((GUIDSTRING)_CombatId)
AND
DB_Players(_Player)
AND
NOT DB_Avatars(_Player)
AND
NOT DB_COL_KethericShowdown_PrimarySpeaker(_)
AND
DB_Is_InCombat(_Player,_CombatId)
AND
QRY_COL_KethericShowdown_IsKethericIntroSpeakerAvailable(_Player)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Player);

//Check availability
QRY
QRY_COL_KethericShowdown_IsKethericIntroSpeakerAvailable((CHARACTER)_Speaker) //allow muted speakers
AND
DB_InRegion(_Speaker,(TRIGGER)S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
NOT DB_CantTalk_IgnoreStatusesCombat(_Speaker)
AND
NOT DB_Defeated(_Speaker)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Speaker);

//SKIP TO PHASE 2 IF PERSUASION SUCCEEDS
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0)
AND
DB_COL_KethericShowdown_CurrentPhase(1)
AND
NOT DB_COL_KethericShowdown_PrimarySpeaker(_)
AND
DB_DialogName((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,_)
THEN
DB_COL_KethericShowdown_PrimarySpeaker((CHARACTER)_Player);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0)
AND
DB_COL_KethericShowdown_CurrentPhase(1)
THEN
TimerLaunch("COL_KethericShowdown_Phase2_FadeOut",0);
SetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0);

//DIALOG START/END
IF
DialogEnded(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,_)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Player)
AND
NOT DB_GlobalFlag(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Player);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, (INTEGER)_ID)
AND
DB_Inclusion_NPCDialog((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,(CHARACTER)_Character)
AND
DB_InRegion(_Character,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
QRY_SpeakerIsAvailable(_Character,1,0,0)
THEN
PROC_DialogAddSpeakingActor(_ID, _Character);

//END_REGION

//REGION Idle behaviours

PROC
PROC_COL_KethericShowdown_Init()
AND
NOT DB_COL_KethericShowdown_IntDevLeader(_)
THEN
PROC_COL_KethericShowdown_DetermineIntDevLeader();

//Select new follow leader
PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND
DB_COL_KethericShowdown_IntDevLeader(_Devourer)
THEN
NOT DB_COL_KethericShowdown_IntDevLeader(_Devourer);

//First intdev in sequence that can move will become leader
PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND
DB_COL_KethericShowdown_IntellectDevourers(_Devourer)
AND
NOT DB_COL_KethericShowdown_IntDevLeader(_)
AND
NOT DB_CantMove(_Devourer)
THEN
DB_COL_KethericShowdown_IntDevLeader((CHARACTER)_Devourer);

//Leader determined -> start following
PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND
DB_COL_KethericShowdown_IntDevLeader(_Leader)
AND
DB_COL_KethericShowdown_IntellectDevourers(_Devourer)
AND
_Devourer != _Leader
THEN
PROC_Follow(_Devourer,_Leader);

PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND
DB_COL_KethericShowdown_IntDevLeader(_Leader)
THEN
PROC_StopFollow(_Leader);

//No more leader -> stop following
PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND
NOT DB_COL_KethericShowdown_IntDevLeader(_)
AND
DB_COL_KethericShowdown_IntellectDevourers(_Devourer)
THEN
PROC_StopFollow(_Devourer);

//Check if new intdev follow leader is required
//Don't do this calculation yet if in combat
IF
DB_CantMove(_Devourer)
AND
DB_COL_KethericShowdown_IntDevLeader((CHARACTER)_Devourer)
AND
NOT DB_Is_InCombat(_Devourer,_)
THEN
PROC_COL_KethericShowdown_DetermineIntDevLeader();

//TODO: if leader could not be determined but then an int dev leaves DB_CantMove -> Redetermine leader

//END_REGION

//END_REGION

//REGION DURING COMBAT

//REGION Combat ADs

//REGION Priority AD automation
//Setup AD database during combat
//DB_COL_KethericShowdown_ADs((GUIDSTRING)_Speaker,(DIALOGRESOURCE)_Dialog,(INTEGER)_Priority,(STRING)_OnlyOnceIdentifier,(INTEGER)_WaitTime,(GUIDSTRING)_SecondSpeaker)
PROC
PROC_COL_KethericShowdown_Init()
THEN
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,COL_KethericShowdown_AD_IsobelKilled_3f65db66-f4b4-0b3c-fd9c-f3647cd08521,3,"COL_KethericShowdown_AD_IsobelKilled",2.0,NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,COL_KethericShowdown_AD_NightsongApostle_c6aed62f-17f9-dd2f-ea7f-f4247b6d2a18,1,"COL_KethericShowdown_AD_NightsongApostle",2.0,NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,COL_KethericShowdown_AD_NightsongTransform_29ec745e-0dd1-4883-28c4-a79d0aed8be9,5,"COL_KethericShowdown_AD_NightsongTransform",0.0,NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,COL_KethericShowdown_AD_Phase3Transition_15c196f5-b6f3-4b9e-4237-c9c71d0c42e3,6,"COL_KethericShowdown_AD_Phase3Transition",2.0,NULL_00000000-0000-0000-0000-000000000000);
//Dual human Ketheric or Apostle Ketheric speaker ADs (XOR)
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,COL_KethericShowdown_AD_NightsongFreed_ab8246f1-5568-7e63-adb8-4deeb3f8f78b,4,"COL_KethericShowdown_NightsongFreed",0.0,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,COL_KethericShowdown_AD_NightsongFreed_Apostle_a53aec87-5053-30ec-d18c-dba146bc089b,4,"COL_KethericShowdown_NightsongFreed",0.0,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,COL_KethericShowdown_AD_KethericInvulnerable_24563361-f5fe-f8a4-c8ea-93888c13d2f4,2,"COL_KethericShowdown_AD_KethericInvulnerable",2.0,NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,COL_KethericShowdown_AD_KethericInvulnerable_Apostle_dc07379c-81c8-14f1-fd40-f5ea309392a1,2,"COL_KethericShowdown_AD_KethericInvulnerable",2.0,NULL_00000000-0000-0000-0000-000000000000);
//If dialog should play despite the speaker being charmed
DB_COL_KethericShowdown_ADs_IgnoreCharmed(COL_KethericShowdown_AD_KethericCommandTroops_3426bfa3-8900-a6fb-982a-f796562f56e8);
DB_COL_KethericShowdown_ADs_IgnoreCharmed(COL_KethericShowdown_AD_KethericFingerOfDeath_f9fdab91-a4c4-5b9e-1cf2-6ce5830149ae);
DB_COL_KethericShowdown_ADs_IgnoreCharmed(COL_KethericShowdown_AD_KethericInvulnerable_24563361-f5fe-f8a4-c8ea-93888c13d2f4);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_ADs(_Speaker,_Dialog,_Priority,_OnlyOnceIdentifier,_WaitTime,_SecondSpeaker)
THEN
NOT DB_COL_KethericShowdown_ADs(_Speaker,_Dialog,_Priority,_OnlyOnceIdentifier,_WaitTime,_SecondSpeaker);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_ADs_IgnoreCharmed(_Dialog)
THEN
NOT DB_COL_KethericShowdown_ADs_IgnoreCharmed(_Dialog);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_ADs_KethericApostleSpeakers(_Dialog)
THEN
NOT DB_COL_KethericShowdown_ADs_KethericApostleSpeakers(_Dialog);

//Try AD if conditions are met
PROC
PROC_COL_KethericShowdown_TryAD((DIALOGRESOURCE)_Dialog)
AND
DB_COL_KethericShowdown_ADs(_Speaker,_Dialog,_,_OnlyOnceIdentifier,_,_)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_OnlyOnceIdentifier)
AND
QRY_COL_KethericShowdown_TryPlayAD(_Speaker,_Dialog)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce("")
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce((STRING)_Identifier)
AND
_Identifier != ""
AND
QRY_OnlyOnce(_Identifier)
THEN
DB_NOOP(1);

//REGION Play AD

QRY
QRY_COL_KethericShowdown_TryPlayAD((GUIDSTRING)_Speaker,(DIALOGRESOURCE)_Dialog)
AND
NOT DB_COL_KethericShowdown_ADs_KethericApostleSpeakers(_Dialog)
AND
DB_COL_KethericShowdown_ADs(_Speaker,_Dialog,_,_OnlyOnceIdentifier,_WaitTime,NULL_00000000-0000-0000-0000-000000000000)
AND
NOT QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable(_Speaker,_Dialog)
AND
QRY_StartDialogCustom_Fixed(_Dialog,_Speaker,0,0,0,0)
THEN
PROC_COL_KethericShowdown_ProcessWaitTime(_Speaker,_WaitTime);

QRY
QRY_COL_KethericShowdown_TryPlayAD((GUIDSTRING)_Speaker,(DIALOGRESOURCE)_Dialog)
AND
NOT DB_COL_KethericShowdown_ADs_KethericApostleSpeakers(_Dialog)
AND
DB_COL_KethericShowdown_ADs(_Speaker,_Dialog,_,_OnlyOnceIdentifier,_WaitTime,_SecondSpeaker)
AND
NOT QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable(_SecondSpeaker,_Dialog)
AND
NOT QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable(_Speaker,_Dialog)
AND
QRY_StartDialogCustom_Fixed(_Dialog,_Speaker,_SecondSpeaker,0,0,0,0)
THEN
PROC_COL_KethericShowdown_ProcessWaitTime(_Speaker,_WaitTime);
PROC_COL_KethericShowdown_ProcessWaitTime(_SecondSpeaker,_WaitTime);

PROC
PROC_COL_KethericShowdown_ProcessWaitTime((GUIDSTRING)_Speaker,(REAL)_WaitTime)
AND
_WaitTime>0.0001
THEN
SetEntityEventReal(_Speaker,"GLO_CombatWait",_WaitTime);

//Speaker availability
QRY
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000,(DIALOGRESOURCE)_)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable((GUIDSTRING)_Speaker,(DIALOGRESOURCE)_Dialog)
AND
_Speaker != NULL_00000000-0000-0000-0000-000000000000
AND
HasActiveStatusWithGroup(_Speaker,"SG_Charmed",1)
AND
DB_COL_KethericShowdown_ADs_IgnoreCharmed(_Dialog)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable((GUIDSTRING)_Speaker,(DIALOGRESOURCE)_Dialog)
AND
_Speaker != NULL_00000000-0000-0000-0000-000000000000
AND
HasActiveStatus(_Speaker,"COL_NIGHTSONG_SOULCAGE",1)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable((GUIDSTRING)_Speaker,(DIALOGRESOURCE)_)
AND
DB_COL_KethericShowdown_ADs_Playing(_Speaker,_)
THEN
DB_NOOP(1);

//Add only once if not added by QRY_OnlyOnce
IF
DB_COL_KethericShowdown_ADs_Playing(_Speaker,_Dialog)
AND
DB_COL_KethericShowdown_ADs(_Speaker,_Dialog,_,_OnlyOnceIdentifier,_,_)
AND
_OnlyOnceIdentifier != ""
AND
QRY_OnlyOnce(_OnlyOnceIdentifier)
THEN
DB_NOOP(1);

//End dialog
IF
AutomatedDialogEnded(_Dialog,_)
AND
DB_COL_KethericShowdown_ADs_Playing(_Speaker,_Dialog)
THEN
NOT DB_COL_KethericShowdown_ADs_Playing(_Speaker,_Dialog);

//END_REGION

//REGION Priority algorithm
//No AD selected
PROC
PROC_COL_KethericShowdown_AD_SelectAD()
AND
DB_COL_KethericShowdown_ADs_Trying(_Dialog)
AND
DB_COL_KethericShowdown_ADs(_Speaker,_Dialog,_,_,_,_)
AND
NOT DB_COL_KethericShowdown_ADs_Selected(_Speaker,_)
THEN
DB_COL_KethericShowdown_ADs_Selected(_Speaker,_Dialog);

//Select highest priority AD
PROC
PROC_COL_KethericShowdown_AD_SelectAD()
AND
DB_COL_KethericShowdown_ADs_Trying(_Dialog)
AND
DB_COL_KethericShowdown_ADs(_Speaker,_Dialog,_Priority,_,_,_)
AND
DB_COL_KethericShowdown_ADs_Selected(_Speaker,_SelDialog)
AND
DB_COL_KethericShowdown_ADs(_Speaker,_SelDialog,_SelPriority,_,_,_)
AND
_Priority > _SelPriority
THEN
NOT DB_COL_KethericShowdown_ADs_Selected(_Speaker,_SelDialog);
DB_COL_KethericShowdown_ADs_Selected(_Speaker,_Dialog);

//Play selected AD
PROC
PROC_COL_KethericShowdown_AD_PlaySelectedAD()
AND
DB_COL_KethericShowdown_ADs_Selected(_Speaker,_Dialog)
AND
QRY_COL_KethericShowdown_TryPlayAD(_Speaker,_Dialog)
THEN
DB_COL_KethericShowdown_ADs_Playing(_Speaker,_Dialog);
NOT DB_COL_KethericShowdown_ADs_Selected(_Speaker,_Dialog);

PROC
PROC_COL_KethericShowdown_AD_PlaySelectedAD()
AND
DB_COL_KethericShowdown_ADs_Trying((DIALOGRESOURCE)_Dialog)
THEN
NOT DB_COL_KethericShowdown_ADs_Trying(_Dialog);

//END_REGION

//END_REGION

//Nightsong freed during combat
IF
DB_GlobalFlag((FLAG)COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415)
AND
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished")
AND
NOT DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
THEN
RealtimeObjectTimerLaunch(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_KethericShowdown_NightsongTransform",2000);

IF
ObjectTimerFinished(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_KethericShowdown_NightsongTransform")
AND
NOT DB_Dead((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
PROC_COL_KethericShowdown_DoNightsongTransform(0);

//Command Spell AD: COL_KethericShowdown_AD_KethericCommandTroops (KETHERIC SPEAKER)
IF
CastedSpell(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"Target_MOO_Ketheric_CommandTroops",_,_,_)
THEN
PROC_COL_KethericShowdown_TryAD(COL_KethericShowdown_AD_KethericCommandTroops_3426bfa3-8900-a6fb-982a-f796562f56e8);

//Finger of Death AD: COL_KethericShowdown_AD_KethericFingerOfDeath (KETHERIC SPEAKER)
IF
UsingSpell(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"Projectile_FingerOfDeath_Apostle",_,_,_)
THEN
PROC_COL_KethericShowdown_TryAD(COL_KethericShowdown_AD_KethericFingerOfDeath_f9fdab91-a4c4-5b9e-1cf2-6ce5830149ae);

//COL_KethericShowdown_PAD_NightsongCaged (PLAYER SPEAKER)
PROC
PROC_COL_KethericShowdown_TryPlayerNightsongFirstTurn((CHARACTER)_Player)
AND
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished")
AND
NOT DB_OnlyOnce("COL_KethericShowdown_PAD_NightsongCaged")
AND
DB_Is_InCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,_CombatId)
AND
DB_Is_InCombat(_Player,_CombatId)
AND
QRY_SpeakerIsAvailable(_Player,1)
AND
QRY_StartDialogCustom_Fixed(COL_KethericShowdown_PAD_NightsongCaged_4bfa0c3e-1a0d-1388-f229-37433e185905,_Player,0,0,0,0)
THEN
DB_OnlyOnce("COL_KethericShowdown_PAD_NightsongCaged");

//COL_KethericShowdown_AD_KethericInvulnerable (KETHERIC SPEAKER)
IF
AttackedBy(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_,_Attacker,_,_,_,_)
AND
DB_PartyMembers((CHARACTER)_Attacker)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
HasActiveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_INVULNERABLE",1)
AND
QRY_COL_KethericShowdown_ADs_SelectKethericDialog(COL_KethericShowdown_AD_KethericInvulnerable_24563361-f5fe-f8a4-c8ea-93888c13d2f4,COL_KethericShowdown_AD_KethericInvulnerable_Apostle_dc07379c-81c8-14f1-fd40-f5ea309392a1)
AND
DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Dialog)
THEN
PROC_COL_KethericShowdown_TryAD(_Dialog);
NOT DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Dialog);

//REGION Ketheric turn started ADs
//COL_KethericShowdown_AD_IsobelKilled (KETHERIC SPEAKER)
IF
KilledBy(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_,_)
THEN
DB_COL_KethericShowdown_KethericKilledIsobel(1);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_KethericKilledIsobel(_Value)
THEN
NOT DB_COL_KethericShowdown_KethericKilledIsobel(_Value);

PROC
PROC_COL_KethericShowdown_AD_Check_IsobelKilled()
AND
GetFlag(COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0)
AND
DB_Dead(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
DB_GlobalFlag((FLAG)COL_KethericShowdown_State_IsobelDiedInCOL_59810510-848e-46f3-2a7f-3f490407d954)
AND
NOT DB_COL_KethericShowdown_KethericKilledIsobel(1)
AND
NOT DB_COL_KethericShowdown_ADs_Trying(COL_KethericShowdown_AD_IsobelKilled_3f65db66-f4b4-0b3c-fd9c-f3647cd08521)
AND
DB_COL_KethericShowdown_ADs(_,COL_KethericShowdown_AD_IsobelKilled_3f65db66-f4b4-0b3c-fd9c-f3647cd08521,_,_OnlyOnceIdentifier,_,_)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_OnlyOnceIdentifier)
THEN
DB_COL_KethericShowdown_ADs_Trying((DIALOGRESOURCE)COL_KethericShowdown_AD_IsobelKilled_3f65db66-f4b4-0b3c-fd9c-f3647cd08521);

//COL_KethericShowdown_AD_Phase3Transition (KETHERIC SPEAKER)
PROC
PROC_COL_KethericShowdown_AD_Check_Phase3Transition()
AND
DB_COL_KethericShowdown_CurrentPhase(3)
AND
NOT DB_COL_KethericShowdown_ADs_Trying(COL_KethericShowdown_AD_Phase3Transition_15c196f5-b6f3-4b9e-4237-c9c71d0c42e3)
AND
DB_COL_KethericShowdown_ADs(_,COL_KethericShowdown_AD_Phase3Transition_15c196f5-b6f3-4b9e-4237-c9c71d0c42e3,_,_OnlyOnceIdentifier,_,_)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_OnlyOnceIdentifier)
THEN
DB_COL_KethericShowdown_ADs_Trying((DIALOGRESOURCE)COL_KethericShowdown_AD_Phase3Transition_15c196f5-b6f3-4b9e-4237-c9c71d0c42e3);

//KETHERIC SELECTION
IF
TurnStarted(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
THEN
PROC_COL_KethericShowdown_AD_Check_IsobelKilled();
PROC_COL_KethericShowdown_AD_Check_Phase3Transition();
PROC_COL_KethericShowdown_AD_SelectAD();
PROC_COL_KethericShowdown_AD_PlaySelectedAD();

//END_REGION

//REGION Nightsong turn started ADs
//COL_KethericShowdown_AD_NightsongApostle (NIGHTSONG SPEAKER)
PROC
PROC_COL_KethericShowdown_AD_Check_NightsongApostle()
AND
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
AND
GetFlag(COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1)
AND
DB_COL_KethericShowdown_ADs(_,COL_KethericShowdown_AD_NightsongApostle_c6aed62f-17f9-dd2f-ea7f-f4247b6d2a18,_,_OnlyOnceIdentifier,_,_)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_OnlyOnceIdentifier)
THEN
DB_COL_KethericShowdown_ADs_Trying(COL_KethericShowdown_AD_NightsongApostle_c6aed62f-17f9-dd2f-ea7f-f4247b6d2a18);

//COL_KethericShowdown_AD_NightsongFreed (NIGHTSONG SPEAKER)
PROC
PROC_COL_KethericShowdown_AD_Check_NightsongFreed()
AND
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
AND
QRY_COL_KethericShowdown_ADs_SelectKethericDialog(COL_KethericShowdown_AD_NightsongFreed_ab8246f1-5568-7e63-adb8-4deeb3f8f78b,COL_KethericShowdown_AD_NightsongFreed_Apostle_a53aec87-5053-30ec-d18c-dba146bc089b)
AND
DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Dialog)
AND
DB_COL_KethericShowdown_ADs(_,_Dialog,_,_OnlyOnceIdentifier,_,_)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_OnlyOnceIdentifier)
THEN
DB_COL_KethericShowdown_ADs_Trying(_Dialog);
NOT DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Dialog);

//NIGHTSONG SELECTION
IF
TurnStarted(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
THEN
PROC_COL_KethericShowdown_AD_Check_NightsongFreed();
PROC_COL_KethericShowdown_AD_Check_NightsongApostle();
PROC_COL_KethericShowdown_AD_SelectAD();
PROC_COL_KethericShowdown_AD_PlaySelectedAD();

//END_REGION

//Select Ketheric human/Apostle dialog
QRY
QRY_COL_KethericShowdown_ADs_SelectKethericDialog((DIALOGRESOURCE)_,(DIALOGRESOURCE)_ApostleDialog)
AND
GetFlag(COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1)
THEN
DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_ApostleDialog);

QRY
QRY_COL_KethericShowdown_ADs_SelectKethericDialog((DIALOGRESOURCE)_HumanDialog,(DIALOGRESOURCE)_)
AND
GetFlag(COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0)
THEN
DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_HumanDialog);

//END_REGION

//REGION Freeing Nightsong

//Helping Downed Characters tutorial
IF
TurnStarted(_Player)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
NOT DB_GlobalFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415)
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
PROC_COL_KethericShowdown_TryPlayerNightsongFirstTurn((CHARACTER)_Player);

IF
DialogEnded((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,_)
AND
DB_COL_KethericShowdown_PlayerHavingCombatTurn((CHARACTER)_Player)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
NOT DB_GlobalFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415)
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
PROC_COL_KethericShowdown_TryPlayerNightsongFirstTurn((CHARACTER)_Player);

IF
TurnStarted(_Player)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
DB_Is_InCombat(_Player,_CombatId)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_CombatId)
THEN
DB_COL_KethericShowdown_PlayerHavingCombatTurn(_Player);

IF
TurnEnded(_Player)
AND
DB_COL_KethericShowdown_PlayerHavingCombatTurn((CHARACTER)_Player)
THEN
NOT DB_COL_KethericShowdown_PlayerHavingCombatTurn(_Player);

PROC
PROC_COL_KethericShowdown_TryPlayerNightsongFirstTurn((CHARACTER)_Player)
AND
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished")
AND
DB_Is_InCombat(_Player,_CombatId)
AND
DB_Is_InCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,_CombatId)
AND
CanShowSpellForCharacter((CHARACTER)_Player, "Target_Help", 1)
THEN
PROC_ShowUnifiedTutorialForPlayer(_Player, (UNIFIEDTUTORIAL)Helping_Downed_Characters__Nightsong__3a552454-f61f-4d02-aac5-6619699882f0);

IF
FlagSet((FLAG)COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415,_,_)
AND
DB_Players(_Player)
THEN
HideTutorial((CHARACTER)_Player, (UNIFIEDTUTORIAL)Helping_Downed_Characters__Nightsong__3a552454-f61f-4d02-aac5-6619699882f0);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
DB_Players(_Player)
THEN
HideTutorial((CHARACTER)_Player, (UNIFIEDTUTORIAL)Helping_Downed_Characters__Nightsong__3a552454-f61f-4d02-aac5-6619699882f0);

//Puts Nightsong in Ketheric Showdown combat,
//even if she's paralyzed
IF
EnteredCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_CombatId)
AND
QRY_COL_KethericShowdown_AnyPlayerInChamber()
THEN
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
PROC_EnterCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

PROC
PROC_COL_KethericShowdown_NightsongGotCaged(0)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
QRY_OnlyOnce("COL_KethericShowdown_NightsongFreedInitial")
THEN
SetForceUpdate(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0);
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
PROC_SetRelationMutual(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd,(FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4,0);
PROC_SetRelationToPlayers(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd,0);
PROC_SetRelationToPlayers(ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4,100);
PROC_EnterCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_COL_KethericShowdown_ForcePlayersEnterCombat(1);

PROC
PROC_COL_KethericShowdown_SetNightsongCaged(0)
AND
HasAppliedStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_NIGHTSONG_SOULCAGE",1)
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_NIGHTSONG_SOULCAGE",NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_NIGHTSONG_SOULCAGE",_,_)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
THEN
PROC_COL_KethericShowdown_NightsongGotCaged(0);

PROC
PROC_COL_KethericShowdown_NightsongGotCaged(0)
THEN
MusicPlayGeneral("Music_KethericFight_NightsongFree");
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_INVULNERABLE");
SetFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415);
ClearTag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);

PROC
PROC_COL_KethericShowdown_SetNightsongCaged(1)
AND
HasAppliedStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_NIGHTSONG_SOULCAGE",0)
THEN
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_NIGHTSONG_SOULCAGE",-1.0,1);

IF
StatusApplied(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_NIGHTSONG_SOULCAGE",_,_)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
THEN
PROC_COL_KethericShowdown_NightsongGotCaged(1);

PROC
PROC_COL_KethericShowdown_NightsongGotCaged(1)
THEN
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_INVULNERABLE",-1.0);
ClearFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415);
SetTag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);

IF
DB_Dead((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
AND
NOT DB_Defeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_SHARSPEAR_MORTALWOUND", 0)
AND
GetFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 100);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION", 6.0, 0, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

//Transform into paladin form on first turn
IF
TurnStarted(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
AND
NOT DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
AND
DB_GlobalFlag((FLAG)COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415)
THEN
PROC_COL_KethericShowdown_DoNightsongTransform(1);

//Do transform outside of combat turn
PROC
PROC_COL_KethericShowdown_DoNightsongTransform(0)
THEN
TimerLaunch("COL_KethericShowdown_NightsongTransform_DelayAD",500);

IF
TimerFinished("COL_KethericShowdown_NightsongTransform_DelayAD")
THEN
PROC_COL_KethericShowdown_TryAD(COL_KethericShowdown_AD_NightsongTransform_29ec745e-0dd1-4883-28c4-a79d0aed8be9);
UseSpell((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"Shout_MOO_Nightsong_RadiantConsumption",S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

//Do transform during combat turn
PROC
PROC_COL_KethericShowdown_DoNightsongTransform(1)
THEN
UseSpell((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"Shout_MOO_Nightsong_RadiantConsumption",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

IF
UsingSpell(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"Shout_MOO_Nightsong_RadiantConsumption",_,_,_)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
AND
NOT DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
THEN
PROC_COL_KethericShowdown_TryAD(COL_KethericShowdown_AD_NightsongTransform_29ec745e-0dd1-4883-28c4-a79d0aed8be9);

IF
CastSpellFailed(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"Shout_MOO_Nightsong_RadiantConsumption",_,_,_)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
AND
NOT DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
THEN
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"MOO_NIGHTSONG_MOONBEAM",60.0,1,NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"MOO_NIGHTSONG_MOONBEAM",_,_)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
AND
NOT DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
THEN
SetEntityEventReal(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"GLO_CombatWait",3.0);
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed");

IF
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
AND
HasAppliedStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_NIGHTSONG_SOULCAGE",1)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);

IF
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa)
THEN
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed");

IF
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
AND
NOT DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa)
THEN
PROC_Foop(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
Transform(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, Humans_Female_Strong_NightSong_9671ecbb-4030-48ff-b63e-f138e988835f, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
RealtimeObjectTimerLaunch(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_KethericShowdown_NightsongTransformed_EquipWeapon", 2520);

IF
ObjectTimerFinished(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_KethericShowdown_NightsongTransformed_EquipWeapon")
THEN
PROC_GLO_Nightsong_GiveNightsongEquipment();

IF
TemplateAddedTo(WPN_HUM_Greatsword_A_1_1a2a58b7-4bd5-44d5-b1fe-8cd7e5b53def,_Sword,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,_)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
THEN
Equip((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(ITEM)_Sword);

IF
TimerFinished("Nightsong_PostResurrection")
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol")
AND
NOT DB_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
THEN
PROC_EnterCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

//END_REGION

//Death Bloom Logic in goal 'Act2_MOO_KethericMisc'

//REGION Phase 1

IF
RelationChanged(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,0,_)
AND
DB_COL_KethericShowdown_ForcePlayersEnterCombat(1)
AND
DB_Players(_Player)
THEN
NOT DB_COL_KethericShowdown_ForcePlayersEnterCombat(1);
RemoveStatus(_Player,"SNEAKING",S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
PROC_EnterCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Player);

IF
DB_GLO_DefeatCounter(_Minion,"COL_KethericShowdown_KillCounter_Minion")
THEN
AddPreferredAiTargetTag((CHARACTER)_Minion,(TAG)ACT2_MOO_KETHERIC_TAUNT_34ccbf00-621b-4cb2-a3e7-daef32df9146);

//Don't use Command Spell if too many allies are dead
PROC
PROC_GLO_DefeatCounter_Notify("COL_KethericShowdown_KillCounter_Minion",_,_,6)
THEN
SetTag(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,ACT2_MOO_KETHERIC_BLOCKCOMMAND_e97caba7-e96d-46d6-a1ac-01bade846aeb);

//END_REGION

//REGION Phase 2 / Transformation

//Transition if HP threshold is reached
IF
HitpointsChanged(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_)
AND
QRY_COL_KethericShowdown_KethericPhase1Defeated()
AND
NOT DB_GlobalFlag(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0)
THEN
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Phase2_FadeOut");

QRY
QRY_COL_KethericShowdown_KethericPhase1Defeated()
AND
DB_COL_KethericShowdown_CurrentPhase(1)
AND
GetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0)
THEN
DB_NOOP(1);

PROC
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Phase2_FadeOut")
THEN
MusicPlayGeneral("Music_KethericFight_Dead");

//PHASE 2 CINEMATIC DIALOG
IF
TimerFinished("COL_KethericShowdown_Phase2_FadeOut")
AND
QRY_COL_KethericShowdown_GetKethericApostlePrimarySpeaker()
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Player)
AND
NOT QRY_COL_KethericShowdown_TryApostleDialog(_Player)
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2);

IF
TimerFinished("COL_KethericShowdown_Phase2_FadeOut")
AND
DB_GlobalFlag(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Player) //set in flag reaction after dialog of the flag above
AND
NOT QRY_COL_KethericShowdown_TryApostleDialog(_Player)
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2);

IF
DialogRequestFailed((DIALOGRESOURCE)COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0,_)
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2);

QRY
QRY_COL_KethericShowdown_TryApostleDialog((CHARACTER)_Player)
AND
QRY_StartDialogCustom(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0,S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8,S_GLO_Myrkul_9061c1d3-5965-4251-9c07-bcebe53d0660,_Player,0,0,0,0)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Player);
DB_COL_KethericShowdown_StartedApostleTransform(1);

QRY
QRY_DialogShouldDropMutingStatussesForSpeaker((DIALOGRESOURCE)COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, (GUIDSTRING)_Speaker)
AND
DB_PartyMembers((CHARACTER)_Speaker)
THEN
DB_NOOP(1);

IF
DB_COL_KethericShowdown_CurrentPhase(2)
AND
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished")
AND
NOT DB_DialogName((DIALOGRESOURCE)COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0,_)
AND
QRY_OnlyOnce("Music_MyrkulFight_Start")
THEN
PROC_MusicPlayGeneral("Music_MyrkulFight_Start");

//Get best speaker for showdown combat dialogs
//Try already defined primary speaker
QRY
QRY_COL_KethericShowdown_GetKethericApostlePrimarySpeaker()
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Speaker)
AND
NOT QRY_COL_KethericShowdown_IsKethericApostlePrimarySpeakerAvailable(_Speaker)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Speaker);

//Succeed if there is already an available defined speaker
QRY
QRY_COL_KethericShowdown_GetKethericApostlePrimarySpeaker()
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Speaker)
THEN
DB_NOOP(1);

//Try avatars
QRY
QRY_COL_KethericShowdown_GetKethericApostlePrimarySpeaker()
AND
DB_Avatars(_Player)
AND
NOT DB_COL_KethericShowdown_PrimarySpeaker(_)
AND
QRY_COL_KethericShowdown_IsKethericApostlePrimarySpeakerAvailable(_Player)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Player);

//Try companions
QRY
QRY_COL_KethericShowdown_GetKethericApostlePrimarySpeaker()
AND
DB_Players(_Player)
AND
NOT DB_Avatars(_Player)
AND
NOT DB_COL_KethericShowdown_PrimarySpeaker(_)
AND
QRY_COL_KethericShowdown_IsKethericApostlePrimarySpeakerAvailable(_Player)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Player);

//Check availability
QRY
QRY_COL_KethericShowdown_IsKethericApostlePrimarySpeakerAvailable((CHARACTER)_Speaker) //do not allow muted speakers
AND
DB_InRegion(_Speaker,(TRIGGER)S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
NOT DB_CantTalk_IgnoreCombat(_Speaker)
AND
NOT DB_Is_WildShaped(_Speaker)
AND
NOT DB_Defeated(_Speaker)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Speaker);

//REGION KethericApostle inclusions

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, (INTEGER)_ID)
THEN
PROC_DialogAddSpeakingActor(_ID, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

IF
DialogStarted((DIALOGRESOURCE)COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d,_DialogId) //may nest into KethericApostle
THEN
PROC_COL_KethericShowdown_KethericApostle_DetermineRandomInclusion(_DialogId);

IF
DialogStarted((DIALOGRESOURCE)COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0,_DialogId)
THEN
PROC_COL_KethericShowdown_KethericApostle_DetermineRandomInclusion(_DialogId);

PROC
PROC_COL_KethericShowdown_KethericApostle_DetermineRandomInclusion((INTEGER)_DialogId)
AND
NOT DB_COL_KethericShowdown_Apostle_SelectedInclusion((GUIDSTRING)_)
AND
DB_DialogPlayers(_DialogId,_Player,_Slot)
AND
_Slot > 1
AND
_Player != S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b //no inclusion for Minthara unfortunately.
AND
NOT DB_CantTalk_IgnoreDialogsCombat(_Player)
THEN
DB_COL_KethericShowdown_Apostle_RandomInclusionOptions(_Player);

PROC
PROC_COL_KethericShowdown_KethericApostle_DetermineRandomInclusion((INTEGER)_DialogId)
AND
NOT DB_COL_KethericShowdown_Apostle_SelectedInclusion((GUIDSTRING)_)
AND
QRY_GetRandom("DB_COL_KethericShowdown_Apostle_RandomInclusionOptions",1,"DB_COL_KethericShowdown_Apostle_SelectedInclusion")
AND
DB_COL_KethericShowdown_Apostle_SelectedInclusion((GUIDSTRING)_Player)
THEN
SetFlag(COL_KethericShowdown_Event_Apostle_Inclusion_Selected_b07324ee-a2d7-f560-26af-1c28e43f44eb,_Player);

PROC
PROC_COL_KethericShowdown_KethericApostle_DetermineRandomInclusion((INTEGER)_DialogId)
AND
DB_COL_KethericShowdown_Apostle_RandomInclusionOptions(_Option)
THEN
NOT DB_COL_KethericShowdown_Apostle_RandomInclusionOptions(_Option);

IF
DB_COL_KethericShowdown_CurrentPhase(2)
AND
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished")
AND
DB_COL_KethericShowdown_Apostle_SelectedInclusion((GUIDSTRING)_Player)
AND
NOT DB_DialogName((DIALOGRESOURCE)COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0,_)
THEN
ClearFlag(COL_KethericShowdown_Event_Apostle_Inclusion_Selected_b07324ee-a2d7-f560-26af-1c28e43f44eb,_Player);
NOT DB_COL_KethericShowdown_Apostle_SelectedInclusion((GUIDSTRING)_Player);

//END_REGION

IF
TimerFinished("COL_KethericShowdown_Phase2_FadeOut")
AND
NOT DB_COL_KethericShowdown_StartedApostleTransform(1)
AND
NOT DB_GlobalFlag(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2)
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2);

IF
TimerFinished("COL_KethericShowdown_Phase2_FadeOut")
AND
DB_COL_KethericShowdown_StartedApostleTransform(1)
THEN
NOT DB_COL_KethericShowdown_StartedApostleTransform(1);

IF
FlagSet(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2,_,_)
THEN
PROC_COL_KethericShowdown_EnterPhase_2();

PROC
PROC_COL_KethericShowdown_EnterPhase_2()
AND
GetEquippedItem((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"Breast",(ITEM)_Armor)
THEN
DB_COL_KethericShowdown_KethericArmor((ITEM)_Armor);
PROC_TeleportToAndOffStage(_Armor,S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8,"",0,0,0,0,1); //teleports to asylum character
SetFlag((FLAG)COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0);

PROC
PROC_COL_KethericShowdown_EnterPhase_2()
AND
GetEquippedWeapon(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Weapon)
THEN
Unequip(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Weapon);

//Enter Phase 2 Procedure
PROC
PROC_COL_KethericShowdown_EnterPhase_2()
THEN
PROC_SetOnStage((ITEM)S_COL_ShowdownApostleStandBox_5b08724c-e510-4b87-a7e8-42de9f0a909e,0);
TimerLaunch("COL_KethericShowdown_Phase2_TransformFrameDelay",250);

IF
TimerFinished("COL_KethericShowdown_Phase2_TransformFrameDelay")
THEN
RemoveHarmfulStatuses(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
SetImmortal(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0);
SetHitpointsPercentage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,100.0);
PROC_COL_KethericShowdown_SetPhase(2);
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"AURA_OF_PROTECTION");
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"AURA_OF_HATE");
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM",-1.0,1);
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_COL_ShowdownKethericPhase3_Pos_6ec38505-b588-4ea0-8b33-8deec08c2eff,"COL_ApostleTeleportFinished");

IF
EntityEvent(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"COL_ApostleTeleportFinished")
THEN
PROC_SetOnStage((ITEM)S_COL_ShowdownApostleStandBox_5b08724c-e510-4b87-a7e8-42de9f0a909e,1);

IF
StatusApplied((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM",_,_)
THEN
PROC_ToInventoryAndOnStage((ITEM)S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

IF
StatusApplied((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM",_,_)
AND
IsInInventoryOf(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,(ITEM)S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32,1)
THEN
Equip(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,(ITEM)S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32);

IF
AddedTo(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_)
AND
HasActiveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM",1)
THEN
Equip(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,(ITEM)S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32);

//REGION Difficulty changes in phase 2/3

//Check difficulty mode on phase start
IF
StatusApplied((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM",_,_)
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,"HARD",1)
THEN
PROC_COL_KethericShowdown_SetHardMode(1);

//Enable hardmode when changed during the fight
PROC
PROC_Hardcore_Enable("SCL_Main_A")
AND
HasActiveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM",1)
THEN
PROC_COL_KethericShowdown_SetHardMode(1);

//Disable hardmode when changed during the fight
PROC
PROC_Hardcore_Disable("SCL_Main_A")
AND
HasActiveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM",1)
THEN
PROC_COL_KethericShowdown_SetHardMode(0);

PROC
PROC_COL_KethericShowdown_SetHardMode(_)
AND
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(_SpawnPerRound)
THEN
NOT DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(_SpawnPerRound);

PROC
PROC_COL_KethericShowdown_SetHardMode(_)
AND
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(_SpawnLimit)
THEN
NOT DB_COL_KethericShowdown_DeathBloom_SpawnLimit(_SpawnLimit);

PROC
PROC_COL_KethericShowdown_SetHardMode(0)
THEN
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM_HARDCORE");
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"LEGENDARY_RESISTANCE_CROWD_CONTROL");
NOT DB_COL_KethericShowdown_DeathBloomSpawnTrigger((TRIGGER)S_COL_ShowdownDeathBloomSpawnBox_Hardcore_01_8d36cc0a-a0a9-46ca-83d0-65c33c74d1de);
NOT DB_COL_KethericShowdown_DeathBloomSpawnTrigger((TRIGGER)S_COL_ShowdownDeathBloomSpawnBox_Hardcore_02_593a1e49-d315-4eb4-b3b0-16ae45d68ecf);
PROC_TriggerUnregisterForParty((TRIGGER)S_COL_ShowdownDeathBloomSpawnBox_Hardcore_01_8d36cc0a-a0a9-46ca-83d0-65c33c74d1de);
PROC_TriggerUnregisterForParty((TRIGGER)S_COL_ShowdownDeathBloomSpawnBox_Hardcore_02_593a1e49-d315-4eb4-b3b0-16ae45d68ecf);
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(2);
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(6);

PROC
PROC_COL_KethericShowdown_SetHardMode(1)
THEN
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM_HARDCORE",-1.0,1);
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"LEGENDARY_RESISTANCE_CROWD_CONTROL",-1.0,1);
DB_COL_KethericShowdown_DeathBloomSpawnTrigger((TRIGGER)S_COL_ShowdownDeathBloomSpawnBox_Hardcore_01_8d36cc0a-a0a9-46ca-83d0-65c33c74d1de);
DB_COL_KethericShowdown_DeathBloomSpawnTrigger((TRIGGER)S_COL_ShowdownDeathBloomSpawnBox_Hardcore_02_593a1e49-d315-4eb4-b3b0-16ae45d68ecf);
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(4);
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(8);

//END_REGION

//REGION Death Blooms

IF
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_Trigger)
THEN
PROC_TriggerRegisterForParty(_Trigger);

IF
CombatRoundStarted(_CombatId,_)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _CombatId)
AND
DB_COL_KethericShowdown_CurrentPhase(_Int)
AND
_Int > 1
THEN
PROC_COL_KethericShowdown_SpawnDeathBlooms();

PROC
PROC_COL_KethericShowdown_SpawnDeathBlooms()
AND
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(_SpawnLimit)
AND
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(_SpawnPerRound)
AND
QRY_DoNTimes(_SpawnPerRound)
AND
DB_QRY_RTN_DoNTimes(_)
AND
SysCount("DB_COL_KethericShowdown_ExistingDeathBloomNecromite",2,_DeathBloomCount)
AND
_DeathBloomCount < _SpawnLimit
AND
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_SpawnTrigger)
AND
TriggerGetRandomPosition(_SpawnTrigger,_X,_Y,_Z)
AND
FindValidPosition(_X,_Y,_Z,10.0,S_COL_ShowdownDeathBloomSpawnHelper_00f374a9-5284-4dbb-baa7-1a211ae2ac9c,0,_NewX,_NewY,_NewZ)
AND
CreateAt(Quest_COL_Ketheric_DeathBloom_47d0ac01-b412-44f6-9fcf-fe6888764c1d,_NewX,_NewY,_NewZ,0,1,"",_DeathBloom)
AND
GetFaction(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Faction)
AND
GetCombatGroupID(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_CombatGroupID)
THEN
NOT DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_SpawnTrigger);
DB_COL_KethericShowdown_DeathBloomSpawned(_DeathBloom,(TRIGGER)_SpawnTrigger);
DB_COL_KethericShowdown_ExistingDeathBloomNecromite((GUIDSTRING)_DeathBloom,(TRIGGER)_SpawnTrigger);
DB_Combat_DeathBloom(_DeathBloom,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Faction,_CombatGroupID);
//Ties into GLO_CombatNPCs_PostEA - Death Bloom Logic region

//FindValidPosition Fallback
PROC
PROC_COL_KethericShowdown_SpawnDeathBlooms()
AND
DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_)
AND
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(_SpawnLimit)
AND
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(_SpawnPerRound)
AND
QRY_DoNTimes(_SpawnPerRound)
AND
DB_QRY_RTN_DoNTimes(_)
AND
SysCount("DB_COL_KethericShowdown_ExistingDeathBloomNecromite",2,_DeathBloomCount)
AND
_DeathBloomCount < _SpawnLimit
AND
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_SpawnTrigger)
AND
TriggerGetRandomPosition(_SpawnTrigger,_X,_Y,_Z)
AND
CreateAt(Quest_COL_Ketheric_DeathBloom_47d0ac01-b412-44f6-9fcf-fe6888764c1d,_X,_Y,_Z,0,1,"",_DeathBloom)
AND
GetFaction(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Faction)
AND
GetCombatGroupID(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_CombatGroupID)
THEN
NOT DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_SpawnTrigger);
DB_COL_KethericShowdown_DeathBloomSpawned(_DeathBloom,(TRIGGER)_SpawnTrigger);
DB_COL_KethericShowdown_ExistingDeathBloomNecromite((GUIDSTRING)_DeathBloom,(TRIGGER)_SpawnTrigger);
DB_Combat_DeathBloom(_DeathBloom,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Faction,_CombatGroupID);

//Cleanup if spawning went wrong somehow
PROC
PROC_COL_KethericShowdown_SpawnDeathBlooms()
AND
DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_SpawnTrigger)
THEN
NOT DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_SpawnTrigger);

//First fill with preferred triggers - player and no deathblooms in trigger
QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_SpawnTrigger)
AND
QRY_AnyPlayerInTrigger(_SpawnTrigger) //Preferred if player is in trigger
AND
NOT DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_,_SpawnTrigger) //NOT preferred if already a Deathbloom in trigger
THEN
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions((TRIGGER)_SpawnTrigger);

//No preferred triggers? Any party member and no deathblooms in trigger
QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
NOT DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions((TRIGGER)_)
AND
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_SpawnTrigger)
AND
QRY_AnyCharacterInTrigger(_SpawnTrigger) //Preferred if party member is in trigger
AND
NOT DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_,_SpawnTrigger) //NOT preferred if already a Deathbloom in trigger
THEN
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions((TRIGGER)_SpawnTrigger);

DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_SpawnTrigger);

//No preferred triggers? No deathblooms in trigger
QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
NOT DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions((TRIGGER)_)
AND
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_SpawnTrigger)
AND
NOT DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_,_SpawnTrigger) //NOT preferred if already a Deathbloom in trigger
THEN
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions((TRIGGER)_SpawnTrigger);

//No preferred triggers? Any deathbloom spawn trigger
QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
NOT DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions((TRIGGER)_)
AND
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_SpawnTrigger)
THEN
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions((TRIGGER)_SpawnTrigger);

//Select random trigger from options
QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
QRY_GetRandom("DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions",1,"DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger")
AND
DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger((TRIGGER)_)
THEN
DB_NOOP(1);

//Clean up options
QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions((TRIGGER)_SpawnTrigger)
THEN
NOT DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_SpawnTrigger);

IF
EnteredLevel((ITEM)_DeathBloom,_,_)
AND
DB_COL_KethericShowdown_DeathBloomSpawned(_DeathBloom,_)
AND
GetCombatGroupID(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_CombatGroup)
THEN
SetCombatGroupID(_DeathBloom,_CombatGroup);
PROC_EnterCombat(_DeathBloom,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

//Links spawned necromite with Ketheric Showdown Death Bloom, adds to DB
IF
DB_Combat_DeathBloom_SpawnedNecromite(_Necromite,_DeathBloom)
AND
DB_COL_KethericShowdown_DeathBloomSpawned(_DeathBloom,_SpawnTrigger)
THEN
DB_COL_KethericShowdown_ExistingDeathBloomNecromite((GUIDSTRING)_Necromite,(TRIGGER)_SpawnTrigger);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_DeathBloomSpawned(_DeathBloom,_SpawnTrigger)
THEN
NOT DB_COL_KethericShowdown_DeathBloomSpawned(_DeathBloom,_SpawnTrigger);

IF
DestroyedBy(_DeathBloom,_,_,_)
AND
DB_COL_KethericShowdown_ExistingDeathBloomNecromite((GUIDSTRING)_DeathBloom,_SpawnTrigger)
THEN
NOT DB_COL_KethericShowdown_ExistingDeathBloomNecromite((GUIDSTRING)_DeathBloom,_SpawnTrigger);

IF
KilledBy(_Necromite,_,_,_)
AND
DB_COL_KethericShowdown_ExistingDeathBloomNecromite((GUIDSTRING)_Necromite,_SpawnTrigger)
THEN
NOT DB_COL_KethericShowdown_ExistingDeathBloomNecromite((GUIDSTRING)_Necromite,_SpawnTrigger);

//END_REGION

//REGION Disarming

IF
CharacterDisarmed(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,(ITEM)S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32,_)
THEN
PROC_TeleportToAndOffStage(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32,S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8); //teleport to asylum

//END_REGION

//END_REGION

//REGION Phase 3 / Defeat fade

//Transition if HP threshold is hit
IF
ShapeshiftedHitpointsChanged(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Percentage)
AND
DB_COL_KethericShowdown_CurrentPhase(2)
AND
_Percentage < 70
THEN
PROC_COL_KethericShowdown_EnterPhase_3();

//Enter Phase 3 Procedure
PROC
PROC_COL_KethericShowdown_EnterPhase_3()
AND
GetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Hitpoints)
AND
_Hitpoints > 0
THEN
PROC_COL_KethericShowdown_SetPhase(3);
DebugText(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"PHASE 3 ACTIVE");
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_PHASE3_NECROMITE_HELPER",-1.0,1); //TODO add to it's own block, play an AD on turn start
//TODO On net turn, do AD calling Necromites to me

//Remove necromites from Swarm when phase 3 starts
IF
StatusApplied(_Necromite,"MOO_NECROMITE_OFFERSELF",_,_)
THEN
RequestSetSwarmGroup(_Necromite,"");

//If Apostle was one-shot
PROC
PROC_COL_KethericShowdown_EnterPhase_3()
AND
GetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0)
THEN
PROC_COL_KethericShowdown_SetPhase(3);
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Death_FadeOut");

//Consume Mechanic
IF
StatusApplied(_Char,"MYRKULS_BOON_HELPER",_Caster,_)
THEN
SetEntityEventReal(_Char,"GLO_CombatWait",1.5);
RealtimeObjectTimerLaunch(_Char,"NecromiteOfferSelf_Killdelay",2250);

//Delay death so animation and FX can do cool stuff
IF
ObjectTimerFinished(_Char,"NecromiteOfferSelf_Killdelay")
THEN
Die(_Char,DEATHTYPE.Physical,NULL_00000000-0000-0000-0000-000000000000,1,0);
DB_NecromiteOfferSelf_OffstageDelay(_Char);

//Set off stage after death
IF
Died(_Char)
AND
DB_NecromiteOfferSelf_OffstageDelay(_Char)
THEN
NOT DB_NecromiteOfferSelf_OffstageDelay(_Char);
PROC_SetOnStage(_Char,0);

//Transition if HP threshold is reached
IF
DB_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
NOT DB_COL_KethericShowdown_CurrentPhase(1)
AND
GetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0)
THEN
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Death_FadeOut");

//This only triggers when Ctrl+Shift+K'ing Ketheric in debug flows
PROC
PROC_StateSet_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"COL_NIGHTSONG_SOULCAGE",1)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);

//Force Nightsong transformation if still not transformed when Apostle dies
PROC
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Death_FadeOut")
AND
NOT DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed")
THEN
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed");
//Transformation done in "Freeing Nightsong" region after the fact above is added

PROC
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Death_FadeOut")
THEN
MusicPlayGeneral("Music_KethericFight_MyrkulDefeated");
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"GROUNDED_APPLYTODEAD",-1.0,0,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Death_FadeOut")
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_Downed((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
SetHitpoints(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"GLO_NIGHTSONGRESURRECTION_DOWNED");

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
THEN
DB_DialogDeath((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
PROC_TeleportToAndOffStage(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32,S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8); //teleport to asylum
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_COL_Showdown_KethericDeath_Point_21ab3fb3-f5dd-417f-ab4f-d752219ab7d2,"",0,0,0,0,1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
NOT DB_Dead(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
THEN
Die(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);

//END_REGION

//END_REGION

//REGION AFTER COMBAT

//REGION Ketheric Defeated dialog/post-combat cleanup

//REGION Clean up (kill hostile combat NPCs)

//Add combat characters to DB
IF
DB_Is_InCombat(_Combatant,_CombatId)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_CombatId)
AND
QRY_COL_KethericShowdown_AnyPlayerInChamber()
AND
NOT DB_COL_KethericShowdown_Combatants(_Combatant)
THEN
DB_COL_KethericShowdown_Combatants(_Combatant);

//Remove charmed statuses
IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
DB_COL_KethericShowdown_Combatants((GUIDSTRING)_Combatant)
AND
NOT DB_PermaDefeated(_Combatant)
THEN
RemoveStatusesWithGroup(_Combatant,"SG_Charmed",NULL_00000000-0000-0000-0000-000000000000);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
DB_COL_KethericShowdown_Combatants(_Character)
THEN
NOT DB_COL_KethericShowdown_Combatants(_Character);

//Kill all enemies
IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
DB_GLO_DefeatCounter(_Character,"COL_KethericShowdown_KillCounter_Minion")
AND
NOT DB_Dead((CHARACTER)_Character)
THEN
Die(_Character,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Necromite,_)
AND
NOT DB_Dead((CHARACTER)_Necromite)
THEN
Die(_Necromite,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Deathbloom,_)
AND
NOT DB_Destroyed((ITEM)_Deathbloom)
THEN
Die(_Deathbloom,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce)
AND
NOT DB_Dead(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
Die(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);

//END_REGION

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Combatant)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Combatant);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
DB_InRegion(_Player,S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
DB_Players(_Player)
THEN
RemoveHarmfulStatuses(_Player);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
THEN
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"MOO_KETHERIC_APOSTLEFORM",NULL_00000000-0000-0000-0000-000000000000);
SetOnStage(S_COL_KethericShowdown_Apostle_Helper_57017856-e080-405b-a849-f5fdc3d3827b,1);
PROC_ToInventoryAndOnStage(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1,0,1);
DB_DialogDeath(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut")
AND
QRY_OnlyOnce("COL_KethericShowdown_DefeatedDialog")
AND
NOT QRY_COL_KethericShowdown_StartKethericDefeatedDialog()
THEN
PROC_COL_KethericShowdown_AfterDefeat();

//Fix for a bug where Ketheric still has hitpoints after the Apostle transform is cleared
//Apostle dies with 0 hitpoints, its transform is cleared and turns into Ketheric's normal form
//this resets his hitpoints and resurrects him
IF
Resurrected((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
DB_OnlyOnce("COL_KethericShowdown_DefeatedDialog")
THEN
DB_DialogDeath((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
Die(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1,0.0);

QRY
QRY_COL_KethericShowdown_StartKethericDefeatedDialog()
AND
QRY_COL_KethericShowdown_SetClosestPlayerSpeaker(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Player)
AND
QRY_StartDialogCustom(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_COL_KethericShowdown_Apostle_Helper_57017856-e080-405b-a849-f5fdc3d3827b,_Player,0,0,0,0)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_SetClosestPlayerSpeaker((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_SetClosestPlayerSpeaker((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
NOT DB_COL_KethericShowdown_PrimarySpeaker(_)
AND
QRY_GetClosestAvailableCharacterTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0,0,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1)
AND
DB_ClosestAvailableCharacterTo(_Player,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Player);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f, (INTEGER)_ID)
AND
QRY_SpeakerIsAvailable(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1,0,0)
THEN
PROC_DialogAddSpeakingActor(_ID, (CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

IF
FlagSet(COL_Nightsong_Event_Resurrect_99786514-3577-1f2b-ae66-5d8b779a5017,_,_)
THEN
Resurrect(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

IF
DialogEnded(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f,_)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Player)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Player);

IF
DialogEnded(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f,_)
THEN
PROC_COL_KethericShowdown_AfterDefeat();

PROC
PROC_COL_KethericShowdown_AfterDefeat()
THEN
SetOnStage(S_COL_KethericShowdown_Apostle_Helper_57017856-e080-405b-a849-f5fdc3d3827b,0);
DB_AD_Dialog((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,COL_KethericShowdown_AD_NightsongAfterCombat_d2060999-5499-e1a1-1a45-2f917b2a15f7);
TimerLaunch("COL_KethericShowdown_VB_AfterCombatComment",3000);
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"MOO_NIGHTSONG_MOONBEAM",NULL_00000000-0000-0000-0000-000000000000);
NOT DB_PartyDialogSuppressionZone(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf);

IF
TimerFinished("COL_KethericShowdown_VB_AfterCombatComment")
AND
DB_Players(_Player)
AND
DB_InRegion(_Player,(TRIGGER)S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
AND
NOT DB_DialogPlayers(_,_Player,_)
AND
IsControlled(_Player,1)
AND
QRY_OnlyOnce("COL_KethericShowdown_VB_AfterCombatComment")
THEN
StartVoiceBark(COL_KethericShowdown_VB_AfterCombatComment_bbdeca5b-e15b-c197-e558-2b52078a5381,_Player);

IF
AutomatedDialogEnded(COL_KethericShowdown_PAD_AfterCombatComment_a4364c67-075a-5e70-d118-2308008770a9,_DialogId)
AND
NOT DB_OnlyOnce("KethericShowdown_CrownController")
AND
DB_DialogPlayers(_DialogId,_Player,1)
THEN
PROC_DaisyAD((CHARACTER)_Player,COL_KethericShowdown_DaisyAD_GrabNetherstone_cc5e8113-97b6-64f5-4109-87b6bfaadfc9);

QRY
QRY_DialogShouldDropMutingStatussesForSpeaker((DIALOGRESOURCE)COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f, (GUIDSTRING)_Speaker)
AND
DB_PartyMembers((CHARACTER)_Speaker)
THEN
DB_NOOP(1);

QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
THEN
DB_NOOP(1);

QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
DB_GlobalFlag((FLAG)MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce)
THEN
DB_NOOP(1);

QRY
QRY_Tadpole_BlockShowCorpseAD((CHARACTER)_Player,(CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
DB_NOOP(1);

//END_REGION

//REGION Karlach avatar saw Gortash follow-up

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_ORI_Karlach_TriggerGortashAvatarDialogAtCOL(1);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_Players(_Player)
AND
_Player != S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c
THEN
ClearScreenFade((CHARACTER)_Player,1.0,"COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f",1);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
NOT DB_ORI_Karlach_TriggerGortashAvatarDialogAtCOL(1)
THEN
ClearScreenFade((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,1.0,"COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f",1);

//END_REGION

//REGION Ketheric armour visuals

//After crown controller dialog, transform into visual of Netherstone-less armour
PROC
PROC_SCE_StartSetupDebrief()
AND
NOT DB_OnlyOnce("KethericShowdown_ReplaceArmor")
AND
NOT DB_COL_KethericShowdown_KethericArmor((ITEM)_)
AND
GetEquippedItem((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"Breast",(ITEM)_Armor)
THEN
DB_COL_KethericShowdown_KethericArmor((ITEM)_Armor);

PROC
PROC_SCE_StartSetupDebrief()
AND
NOT DB_OnlyOnce("KethericShowdown_ReplaceArmor")
AND
DB_COL_KethericShowdown_KethericArmor((ITEM)_Armor)
THEN
SetOnStage(_Armor,1);
Equip((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_Armor,1,0,1);
Transform(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,MOO_Ketheric_NoNetherstone_621e229c-e0b1-4861-9bbe-5f00cdb4d808,(SHAPESHIFTRULE)DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);

//If armour was looted, transform into armourless visual
IF
AddedTo(_Armor,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_COL_KethericShowdown_KethericArmor((ITEM)_Armor)
AND
DB_GlobalFlag((FLAG)GLO_Ketheric_State_Dead_668558ed-0052-0777-64f7-a8a197c40cc5)
THEN
Transform(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,MOO_Ketheric_Dead_6950c3cc-af39-4cbd-94e6-233bf55ae536,(SHAPESHIFTRULE)DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);
NOT DB_COL_KethericShowdown_KethericArmor((ITEM)_Armor);

IF
TextEvent("KethericShowdown_RemoveTransform")
THEN
RemoveTransforms(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

//END_REGION

//REGION Crown Controller pickup dialog

PROC
PROC_BlockLootCorpse(_Player,(CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("KethericShowdown_CrownController")
AND
IsInInventoryOf(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,1)
THEN
ToInventory(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,_Player,1,1,1);
DB_CustomLootCorpseResponse(_Player,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0);
DB_COL_KethericShowdown_DelayLootCorpse((CHARACTER)_Player);

PROC
PROC_SCE_StartSetupDebrief()
AND
DB_COL_KethericShowdown_DelayLootCorpse((CHARACTER)_Player)
AND
OpenCharacterLootUI(_Player,(CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_)
THEN
NOT DB_COL_KethericShowdown_DelayLootCorpse((CHARACTER)_Player);

IF
AddedTo(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("KethericShowdown_CrownController")
AND
DB_InRegion(_Player,(TRIGGER)S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b)
AND
NOT QRY_StartDialogCustom_Fixed(COL_KethericShowdown_CrownController_1bcd7cc6-6b38-3cf7-ca60-686d4eadc2b2,_Player,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,0,0,0,0)
THEN
PROC_SCE_StartSetupDebrief();

IF
DialogEnded((DIALOGRESOURCE)COL_KethericShowdown_CrownController_1bcd7cc6-6b38-3cf7-ca60-686d4eadc2b2,_DialogId)
THEN
PROC_SCE_StartSetupDebrief();

//Nightsong should use portal if in Colony
QRY
QRY_SCE_Debrief_BlockCharacter(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_InRegion(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(TRIGGER)S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf)
THEN
PROC_SCE_SendCharacterToDebrief((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0);

//END_REGION

PROC
PROC_SCE_StartSetupDebrief()
THEN
PROC_TriggerRegisterForPlayers(S_SCE_NoStoneThrallDialogBox_a93cb754-abab-4901-83f1-65be16c80166);
DB_AddCharactersInTriggerToDialog(GLO_ThrallOfTheAbsolute_LeaveWithoutKethericStone_e89ef423-ba39-2243-4383-dd28eef77c74, S_SCE_NoStoneThrallDialogBox_a93cb754-abab-4901-83f1-65be16c80166, 1, 1, 1, 1);
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"MOO_NIGHTSONG_MOONBEAM",NULL_00000000-0000-0000-0000-000000000000);

//Don't leave if there are downed players in the Colony
PROC
PROC_BlockUseOfItem(_Player, S_SCE_Portal_ce5f1b20-6e3b-4fe9-9137-8c4ea3d025af)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_COL_KethericShowdown_AnyPlayerDownedInColony()
THEN
DB_CustomUseItemResponse(_Player, S_SCE_Portal_ce5f1b20-6e3b-4fe9-9137-8c4ea3d025af, 0);
OpenMessageBox(_Player,"ReadyCheck_PartyMemberNotReady");

//Fallback: kill stabilized downed characters
IF
LeftTrigger(_PlayerLeft,(TRIGGER)S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b)
AND
DB_Players(_PlayerLeft)
THEN
PROC_COL_KethericShowdown_CheckDownedPlayers();

IF
DB_Downed(_NewlyDowned)
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_Players(_NewlyDowned)
AND
IsInTrigger(_NewlyDowned,(TRIGGER)S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b,1)
THEN
PROC_COL_KethericShowdown_CheckDownedPlayers();

IF
Died(_Died)
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_Players(_Died)
AND
IsInTrigger(_Died,(TRIGGER)S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b,1)
THEN
PROC_COL_KethericShowdown_CheckDownedPlayers();

IF
DB_Petrified(_Died)
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_Players((CHARACTER)_Died)
THEN
PROC_COL_KethericShowdown_CheckDownedPlayers();

PROC
PROC_COL_KethericShowdown_CheckDownedPlayers()
AND
NOT QRY_COL_KethericShowdown_AnyPlayerCanHelpDownedInColony()
AND
DB_Players(_PlayerDowned)
AND
DB_Downed(_PlayerDowned)
AND
DB_InRegion(_PlayerDowned,(TRIGGER)S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b)
THEN
Die(_PlayerDowned,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,0,0);

QRY
QRY_COL_KethericShowdown_AnyPlayerDownedInColony()
AND
DB_Players(_Player)
AND
DB_Downed(_Player)
AND
DB_InRegion(_Player,(TRIGGER)S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b)
AND
NOT DB_OffStage(_Player) //make sure they can be helped up
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_AnyPlayerCanHelpDownedInColony()
AND
DB_Players(_Player)
AND
NOT DB_Downed(_Player)
AND
//make sure they can help up downed players
NOT DB_Petrified(_Player)
AND
DB_InRegion(_Player,(TRIGGER)S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b)
AND
NOT DB_OffStage(_Player)
THEN
DB_NOOP(1);

PROC
PROC_BlockUseOfItem(_Player, S_SCE_Portal_ce5f1b20-6e3b-4fe9-9137-8c4ea3d025af)
AND
DB_Players((CHARACTER)_Player)
AND
NOT QRY_GLO_EmperorPrelude_NetherstoneIsInMagicPocketsOrCamp((ITEM)S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d)
AND
IsInTrigger(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, S_COL_Colony_SUB_c72269e5-0719-4379-a8ea-ca2ca199d0a3, 1)
THEN
DB_CustomUseItemResponse(_Player, S_SCE_Portal_ce5f1b20-6e3b-4fe9-9137-8c4ea3d025af, 0);
PROC_COL_KethericShowdown_WithoutKethericStoneWarning(_Player);

PROC
PROC_COL_KethericShowdown_WithoutKethericStoneWarning((CHARACTER)_Player)
AND
NOT QRY_StartDialog_Fixed(GLO_ThrallOfTheAbsolute_LeaveWithoutKethericStone_e89ef423-ba39-2243-4383-dd28eef77c74, NULL_00000000-0000-0000-0000-000000000000, _Player)
THEN
PROC_PlayCantUseItemAD(_Player);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
