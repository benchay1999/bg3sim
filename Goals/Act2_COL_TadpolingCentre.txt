Version 1
SubGoalCombiner SGC_AND
INITSECTION
PROC_TriggerRegisterForPlayers(S_COL_TadpolingCentre_DaisyAD_Box_254c466d-ba73-4de6-bd0d-42ea29e232fb);
DB_COL_TadpolingCentre_DaisyAD_Registered(1);

//DB_COL_TadpolingCentre_PodCharacters(_Character,_Bed,_BedPointTrigger,_ReleasePointTrigger,_IsInnocent)
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)S_COL_TadpolingCentre_Mindflayer_001_08d7a7f5-4d33-4000-b2f7-7c0cf6053a89,(ITEM)S_COL_TadpolingCentre_Pod_Bed_001_77e94085-b231-41df-9a4c-5917b957205e,
(TRIGGER)S_COL_TadpolingCentre_Pod_Bed_Point_001_9a8bafaf-10c0-4ff4-b827-6a7e439e69c5,(TRIGGER)S_COL_TadpolingCentre_Pod_Release_Point_001_3e5c90b0-c778-4a6d-bea3-b535f69ca55b,0);
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)S_COL_TadpolingCentre_Mindflayer_002_6929f244-2aec-49d7-8c2d-2d5de934b2a0,(ITEM)S_COL_TadpolingCentre_Pod_Bed_003_4ddf793f-3f72-48c3-b75b-fe22c82539d2,
(TRIGGER)S_COL_TadpolingCentre_Pod_Bed_Point_003_3e5d66fb-6070-4317-9d85-f5cdc692cf96,(TRIGGER)S_COL_TadpolingCentre_Pod_Release_Point_003_e21d1121-a0e1-4335-8c15-6fc1ca5f3d7d,0);
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)S_COL_TadpolingCentre_Mindflayer_004_5f7a197f-2d85-4fa0-a5a0-8b72138cf3b9,(ITEM)S_COL_TadpolingCentre_Pod_Bed_005_ba31d4a8-4fbb-4877-a1a5-5fe241ab0dc2,
(TRIGGER)S_COL_TadpolingCentre_Pod_Bed_Point_005_ceb0d67d-2814-4be6-a9da-11e127ba3a2a,(TRIGGER)S_COL_TadpolingCentre_Pod_Release_Point_005_f5676fc3-3e90-46ad-aadf-a8de31504ab4,0);
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)S_COL_TadpolingCentre_Mindflayer_005_6686b60f-2614-4eef-ad04-7e3faa4efacd,(ITEM)S_COL_TadpolingCentre_Pod_Bed_007_e7b01478-94a1-4bfc-82db-2fda65908a6a,
(TRIGGER)S_COL_TadpolingCentre_Pod_Bed_Point_007_4063b77e-19b4-4169-915a-de071016b511,(TRIGGER)S_COL_TadpolingCentre_Pod_Release_Point_007_7f026cce-fc3e-4205-a9bc-b872dd7dda61,0);

DB_COL_TadpolingCentre_PodCharacters((CHARACTER)S_COL_TadpolingCentre_Manip_6e52b75e-4e1d-46d7-b324-f08551475960,(ITEM)S_COL_TadpolingCentre_Pod_Bed_002_9039e2c4-17c7-4d76-aeaf-9b6fd4fc166d,
(TRIGGER)S_COL_TadpolingCentre_Pod_Bed_Point_002_5f478215-723b-4a78-b55e-fab7e812a8b1,(TRIGGER)S_COL_TadpolingCentre_Pod_Release_Point_002_d947bb61-51c9-49dc-9607-e362ab7da840,1);
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a,(ITEM)S_COL_TadpolingCentre_Pod_Bed_006_af227055-7c56-462a-ad35-6ae5844d3172,
(TRIGGER)S_COL_TadpolingCentre_Pod_Bed_Point_006_948faab5-dcb1-4280-b650-78d5c9a2ccd8,(TRIGGER)S_COL_TadpolingCentre_Pod_Release_Point_006_4f4c1ba9-2ac2-4d5a-928d-3afede0d8430,1);
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911,(ITEM)S_COL_TadpolingCentre_Pod_Bed_008_c17b2084-4f2e-4740-b62a-70f85364f6ec,
(TRIGGER)S_COL_TadpolingCentre_Pod_Bed_Point_008_48bd5fb6-73fa-47c2-b583-60b0ffb50c9c,(TRIGGER)S_COL_TadpolingCentre_Pod_Release_Point_008_a7e66b36-b6bf-44df-926e-776854580947,1);

DB_COL_TadpolingCentre_PodCharacters_FreedDialog((CHARACTER)S_COL_TadpolingCentre_Manip_6e52b75e-4e1d-46d7-b324-f08551475960,(DIALOGRESOURCE)COL_TadpolingCentre_PostCombat_Manip_8343c8a5-31d4-b83b-274c-dd8108c4483c);
DB_COL_TadpolingCentre_PodCharacters_FreedDialog((CHARACTER)S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a,(DIALOGRESOURCE)COL_TadpolingCentre_PostCombat_Zevlor_5a2d0fdb-a603-b6a9-ff5e-10b57900b957);
DB_COL_TadpolingCentre_PodCharacters_FreedDialog((CHARACTER)S_PLA_FlamingFist1_646a4195-4091-4dc9-81e1-cff2604f3911,(DIALOGRESOURCE)COL_TadpolingCentre_PostCombat_Yeva_5a274bce-6d5f-0c36-e4d4-36b2d7b7a7f1);

DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_001_319b5453-0e9a-4cbe-abef-51eea70205fe,(ITEM)S_COL_TadpolingCentre_Pod_Bed_001_77e94085-b231-41df-9a4c-5917b957205e,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_001_Mindflayer_1aff4696-dcd3-c719-13ee-ed51c6afb141,(ITEM)S_COL_TadpolingCentre_MemoryImprint_001_aaf9bca7-87d9-410e-930d-14c83dd4de87);
DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_002_bb625337-9692-42d8-a31f-280afb3ce1c5,(ITEM)S_COL_TadpolingCentre_Pod_Bed_002_9039e2c4-17c7-4d76-aeaf-9b6fd4fc166d,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_002_Manip_f68643ad-ee99-c7f1-70e1-7bd8b7296935,(ITEM)S_COL_TadpolingCentre_MemoryImprint_002_47c6ba7b-bc6b-4ed3-80bc-5bb90d169464);
DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_003_2862cdaa-3574-4d16-a5e0-27798fac91a4,(ITEM)S_COL_TadpolingCentre_Pod_Bed_003_4ddf793f-3f72-48c3-b75b-fe22c82539d2,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_003_Mindflayer_fb0b609d-faea-8206-ebf8-bdc5e6a3958a,(ITEM)S_COL_TadpolingCentre_MemoryImprint_003_a49d018f-eede-4b58-932b-c3122881c689);
DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_004_d325b090-9ea0-4f07-8aec-98e7e024d297,(ITEM)NULL_00000000-0000-0000-0000-000000000000,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_004_Mindflayer_b67282e8-a764-0f2a-8206-2320ee166136,(ITEM)S_COL_TadpolingCentre_MemoryImprint_004_e49beb7e-4a8c-4889-99f5-d09091b38860);
DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_005_15f4d4e8-9e82-4e0a-bf07-309d82429446,(ITEM)S_COL_TadpolingCentre_Pod_Bed_005_ba31d4a8-4fbb-4877-a1a5-5fe241ab0dc2,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_005_Mindflayer_f8f221b2-aee2-f047-cf4e-d8bcc9f3e6c7,(ITEM)S_COL_TadpolingCentre_MemoryImprint_005_aefdd6a6-f1c7-429f-8e9d-5a89cc31c960);
DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_006_bb18964f-e683-4832-a592-4d4f8cac5436,(ITEM)S_COL_TadpolingCentre_Pod_Bed_006_af227055-7c56-462a-ad35-6ae5844d3172,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_006_Zevlor_94b9204f-3d65-d155-f6ac-efc65a6f0527,(ITEM)S_COL_TadpolingCentre_MemoryImprint_006_ae82f0d7-6b72-43e9-a48e-0bdc184f4113);
DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_007_dc912083-944d-4252-ba68-e77407e19e6e,(ITEM)S_COL_TadpolingCentre_Pod_Bed_007_e7b01478-94a1-4bfc-82db-2fda65908a6a,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_007_Mindflayer_5037042e-319b-6497-3196-d941834d6327,(ITEM)S_COL_TadpolingCentre_MemoryImprint_007_1047a667-89ed-40c7-b7d0-e43779f57702);
DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_008_9f850947-aabf-4811-af7f-edc09fcdfebd,(ITEM)S_COL_TadpolingCentre_Pod_Bed_008_c17b2084-4f2e-4740-b62a-70f85364f6ec,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_008_Yeva_a9560fa7-18ff-7153-3380-ccce01b8e83c,(ITEM)S_COL_TadpolingCentre_MemoryImprint_008_5789f178-a7ce-4c2b-a104-598e9a711f28);
DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_009_869e84ac-e413-4b85-b07f-b502d62faf12,(ITEM)NULL_00000000-0000-0000-0000-000000000000,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_009_Empty_9a675708-e1ff-64a3-c927-af58505729ed,(ITEM)S_COL_TadpolingCentre_MemoryImprint_009_1270e8ed-ca6e-4f0b-a801-b58dcd20c802);//no current occupant
DB_COL_TadpolingCentre_Pods((ITEM)S_COL_TadpolingCentre_Pod_010_8b17710c-cda4-4b4b-9fbd-ef8ffd236a9d,(ITEM)NULL_00000000-0000-0000-0000-000000000000,
(DIALOGRESOURCE)COL_TadpolingCentre_AD_MemoryImprint_010_Empty_Ravengard_e90ca02b-9ec8-1668-6424-f349ec5c0a89,(ITEM)S_COL_TadpolingCentre_MemoryImprint_010_6f296af9-d391-414b-b62b-bb4bd961b91d);//no current occupant, formerly Ravengard


DB_GlobalFlagReactionAfterDialog(COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868,(DIALOGRESOURCE)COL_TadpolingCentre_Pods_21ea92f4-2578-eefc-6499-1f41f0620296);
DB_GlobalFlagReactionAfterDialog(COL_TadpolingCentre_Event_PurgePods_e9c700a3-5ba8-07e9-e13f-c2e081a3a1c5,(DIALOGRESOURCE)COL_TadpolingCentre_Pods_21ea92f4-2578-eefc-6499-1f41f0620296);

DB_COL_TadpolingCentre_IntDevs((CHARACTER)S_COL_TadpolingCentre_IntDev_001_ebae9a30-e165-4d91-ac5e-a28a4e8e4c62);
DB_COL_TadpolingCentre_IntDevs((CHARACTER)S_COL_TadpolingCentre_IntDev_002_2dee72de-7be2-462f-8df2-41f9f373d4c2);
DB_COL_TadpolingCentre_IntDevs((CHARACTER)S_COL_TadpolingCentre_IntDev_003_4e94030d-9607-4d6b-80c3-8b682f985e29);
DB_COL_TadpolingCentre_IntDevs((CHARACTER)S_COL_TadpolingCentre_IntDev_004_fa9e28bc-85e1-4e42-8377-1b205fd858e6);
DB_COL_TadpolingCentre_IntDevs((CHARACTER)S_COL_TadpolingCentre_IntDev_005_3519da9f-22b7-4753-b9f7-3d3dcd93fd22);
DB_COL_TadpolingCentre_IntDevs((CHARACTER)S_COL_TadpolingCentre_IntDev_006_d28b294c-bcd2-4d66-a823-550809356c85);

SetOnStage(S_COL_TadpolingCentre_TadpolePowerJar_dac897b8-1c53-49c5-aef3-b6017fe75fd5,0);
DB_DialogBlockAttackButton((DIALOGRESOURCE)COL_TadpolingCentre_Pods_21ea92f4-2578-eefc-6499-1f41f0620296);
DB_DialogBlockTradeButton((DIALOGRESOURCE)COL_TadpolingCentre_Pods_21ea92f4-2578-eefc-6499-1f41f0620296);

//PROC_COL_TadpolingCentre_InitMindflayers();

DB_OneShotPlayerTrigger((TRIGGER)S_COL_TadpolingCentre_Brine_Daisy_afd607e5-3912-4236-b4dd-074f76495047);

NOT DB_COL_TadpolingCentre_ReceiveTadpole((CHARACTER)NULL_00000000-0000-0000-0000-000000000000); //DB no longer in use but kept for patching
KBSECTION
//REGION Debug

IF
TextEvent("tc_teleport")
THEN
PROC_TeleportPartiesTo(S_COL_TadpolingCentre_Lever_Point_6a3b6141-70b7-4db6-9166-5c9e679d16d1,"");

IF
TextEvent("tc_resall")
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_,(TRIGGER)_,(TRIGGER)_Trigger,(INTEGER)_)
THEN
PROC_CharacterFullRestore(_Character);
TeleportTo(_Character,_Trigger,"",0,0,0,0,0);
SetOnStage(_Character,1);

IF
FlagSet(COL_TadpolingCentre_Debug_ResurrectAll_ec029cba-652a-4812-894b-79ebc4f4ad28,_,_)
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_,(TRIGGER)_,(TRIGGER)_Trigger,(INTEGER)_)
THEN
PROC_CharacterFullRestore(_Character);
TeleportTo(_Character,_Trigger,"",0,0,0,0,0);
SetOnStage(_Character,1);

IF
FlagSet(COL_TadpolingCentre_Debug_ResurrectAll_ec029cba-652a-4812-894b-79ebc4f4ad28,_,_)
THEN
ClearFlag(COL_TadpolingCentre_Debug_ResurrectAll_ec029cba-652a-4812-894b-79ebc4f4ad28);

IF
TextEvent("tc_resetpods")
THEN
PROC_COL_TadpolingCentre_ResetPods();

PROC
PROC_COL_TadpolingCentre_ResetPods()
AND
DB_COL_TadpolingCentre_Pods((ITEM)_Pod,(ITEM)_,(DIALOGRESOURCE)_,(ITEM)_Imprint)
THEN
RemoveTransforms(_Imprint);
Close(_Pod);
ClearFlag(COL_TadpolingCentre_State_PodEmpty_e6f46eda-913a-47ce-8248-70177ee4ecfc,_Imprint);

PROC
PROC_COL_TadpolingCentre_ResetPods()
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Bed,(TRIGGER)_,(TRIGGER)_,(INTEGER)_)
THEN
SetOnStage(_Bed,1);
SetVisible(_Bed,1);

PROC
PROC_COL_TadpolingCentre_ResetPods()
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Bed,(TRIGGER)_,(TRIGGER)_ReleaseTrigger,(INTEGER)_)
THEN
RemoveStatus(_Character,"COL_TADPOLINGCENTRE_INPOD",NULL_00000000-0000-0000-0000-000000000000);
TeleportTo(_Bed,_ReleaseTrigger,"",0,0,0,0,1);
TeleportTo(_Character,_ReleaseTrigger,"",0,0,0,0,1);

PROC
PROC_COL_TadpolingCentre_ResetPods()
THEN
ClearFlag((FLAG)COL_TadpolingCentre_Event_PurgePods_e9c700a3-5ba8-07e9-e13f-c2e081a3a1c5);
ClearFlag((FLAG)COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868);
TimerLaunch("COL_TadpolingCentre_PodReset",1000);

IF
TimerFinished("COL_TadpolingCentre_PodReset")
THEN
PROC_COL_TadpolingCentre_InitMindflayers();
PROC_COL_TadpolingCentre_HandleTeleports();

IF
FlagSet(COL_TadpolingCentre_Debug_ResetPods_add13946-a5f9-4d49-9685-833702fbd617,_,_)
THEN
ClearFlag(COL_TadpolingCentre_Debug_ResetPods_add13946-a5f9-4d49-9685-833702fbd617);
PROC_COL_TadpolingCentre_ResetPods();

IF
TextEvent("tc_releasepods")
THEN
SetFlag(COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868);

IF
FlagSet(COL_TadpolingCentre_Debug_ReleaseAll_252f1add-b79f-42b9-a679-a4dc05abff6b,_,_)
THEN
ClearFlag(COL_TadpolingCentre_Debug_ReleaseAll_252f1add-b79f-42b9-a679-a4dc05abff6b);
SetFlag(COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868);

IF
TextEvent("tc_brine")
THEN
PROC_TeleportPartiesTo(S_COL_TadpolingCentre_DEBUG_BrinePool_Point_415eb3e2-e318-4cc6-9b1a-55dc4476d23c,"");
DB_GLO_DaisyUnlocked(1);

IF
FlagSet(COL_TadpolingCentre_Debug_BrinePool_b39585c0-15a3-4e63-8f73-2eb479749bfc,_Player,_)
THEN
ClearFlag(COL_TadpolingCentre_Debug_BrinePool_b39585c0-15a3-4e63-8f73-2eb479749bfc,_Player);
TeleportTo(_Player,S_COL_TadpolingCentre_DEBUG_BrinePool_Point_415eb3e2-e318-4cc6-9b1a-55dc4476d23c,"");
DB_GLO_DaisyUnlocked(1);

//END_REGION

//REGION Post-Chosen Three cleanup

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Bed,(TRIGGER)_,(TRIGGER)_,(INTEGER)_)
AND
NOT DB_COL_TadpolingCentre_EmptyPod(_Bed)
THEN
SetOnStage(_Character,0);
DB_COL_TadpolingCentre_EmptyPod(_Bed);

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_COL_TadpolingCentre_IntDevs(_Character)
AND
NOT DB_Defeated(_Character)
THEN
SetOnStage(_Character,0);

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_COL_TadpolingCentre_ZevlorInColony(1)
THEN
PROC_COL_TadpolingCentre_ZevlorPodFinished();

//END_REGION

//REGION Pods fill/release

PROC
PROC_COL_OnFirstEntry()
THEN
PROC_COL_TadpolingCentre_InitMindflayers();

PROC
PROC_COL_TadpolingCentre_InitMindflayers()
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Bed,(TRIGGER)_,(TRIGGER)_,0)
THEN
Use(_Character,_Bed,1,1,"");
DB_COL_TadpolingCentre_EmptyPod((ITEM)_Bed);
SetCombatGroupID(_Character,"COL_TadpolingCentre_Mindflayers");

IF
UseFinished(_Character,_Bed,_)
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Bed,(TRIGGER)_BedTrigger,(TRIGGER)_,(INTEGER)_)
THEN
TeleportTo(_Bed,_BedTrigger,"",0,0,0,0,0);
SetVisible(_Bed,0);
SetCanJoinCombat(_Character,0);
SetCanFight(_Character,0);
PROC_CharacterDisableAllCrimes(_Character);
NOT DB_COL_TadpolingCentre_EmptyPod((ITEM)_Bed);

IF
UseFinished(_Character,_Bed,_)
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Bed,(TRIGGER)_,(TRIGGER)_,(INTEGER)_)
AND
DB_COL_TadpolingCentre_Pods(_,_Bed,_,_Imprint)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Character);
RemoveTransforms(_Imprint);
ClearFlag(COL_TadpolingCentre_State_PodEmpty_e6f46eda-913a-47ce-8248-70177ee4ecfc,_Imprint);
PROC_COL_TadpolingCentre_CharacterEnteredPod(_Character);
//SetDetached(_Character,1);
ApplyStatus(_Character,"COL_TADPOLINGCENTRE_INPOD",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

IF
DB_InRegion(_PartyMember,(TRIGGER)S_COL_Colony_SUB_c72269e5-0719-4379-a8ea-ca2ca199d0a3)
AND
DB_PartyMembers(_PartyMember)
AND
QRY_OnlyOnce("COL_TadpolingCentre_HandledTeleports")
THEN
PROC_COL_TadpolingCentre_HandleTeleports();

PROC
PROC_COL_TadpolingCentre_HandleTeleports()
AND
DB_COL_TadpolingCentre_PodCharacters(_Character,_Bed,_,_,1)
AND
NOT QRY_COL_TadpolingCentre_HandlePodTeleport(_Character,_Bed)
THEN
SetOnStage(_Bed,0);
DebugText(_Bed,"Intended occupant defeated");
DB_COL_TadpolingCentre_EmptyPod(_Bed);

QRY
QRY_COL_TadpolingCentre_HandlePodTeleport((CHARACTER)_Character,(ITEM)_Bed)
AND
DB_COL_TadpolingCentre_Pods(_,_Bed,_,_Imprint)
AND
NOT DB_PermaDefeated(_Character)
THEN
PROC_CharacterFullRestore(_Character);
SetOnStage(_Character,1);
TeleportTo(_Character,_Bed,"COL_TadpolingCentre_TeleportedCharacters",0,0,0,1,1);
SetFaction(_Character,(FACTION)ACT2_COL_TadpolingCentre_Prisoners_064f9b52-e5b7-4b2e-8c21-a44b08d94aac);
SetCombatGroupID(_Character,"COL_TadpolingCentre_Prisoners");
NOT DB_COL_TadpolingCentre_EmptyPod(_Bed);
RemoveTransforms(_Imprint);
ClearFlag(COL_TadpolingCentre_State_PodEmpty_e6f46eda-913a-47ce-8248-70177ee4ecfc,_Imprint);

PROC
PROC_COL_TadpolingCentre_HandleTeleports()
AND
NOT QRY_COL_TadpolingCentre_AnyInnocentOccupants()
THEN
SetFlag(COL_TadpolingCentre_State_NoInnocentOccupants_04462b73-768d-a59f-0d90-ff55a048090f);

QRY
QRY_COL_TadpolingCentre_AnyInnocentOccupants()
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Pod,(TRIGGER)_,(TRIGGER)_,1)
AND
NOT DB_COL_TadpolingCentre_EmptyPod(_Pod)
THEN
PROC_GlobalClearFlagAndCache(COL_TadpolingCentre_State_NoInnocentOccupants_04462b73-768d-a59f-0d90-ff55a048090f);

IF
EntityEvent(_Character,"COL_TadpolingCentre_TeleportedCharacters")
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Bed,(TRIGGER)_,(TRIGGER)_,(INTEGER)_)
THEN
Use(_Character,_Bed,1,1,"");

PROC
PROC_COL_TadpolingCentre_PodsReleaseAll()
THEN
PROC_SetRelationToPlayers((FACTION)ACT2_COL_TadpolingCentre_Prisoners_064f9b52-e5b7-4b2e-8c21-a44b08d94aac,100);

PROC
PROC_COL_TadpolingCentre_PodsReleaseAll()
AND
DB_COL_TadpolingCentre_Pods(_Pod,_,_,_)
THEN
Open(_Pod);

//We have no clean way of getting these characters out of their pods
//If the dialog ends before the pods opening is finished, empty the pods now
IF
DialogEnded((DIALOGRESOURCE)COL_TadpolingCentre_Pods_21ea92f4-2578-eefc-6499-1f41f0620296,_)
AND
DB_GlobalFlag(COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868)
AND
DB_COL_TadpolingCentre_Pods(_Pod,_,_,_)
THEN
PROC_COL_TadpolingCentre_EmptyPod(_Pod);

IF
Opened(_Pod)
AND
DB_COL_TadpolingCentre_Pods(_Pod,_,_,_)
THEN
PROC_COL_TadpolingCentre_EmptyPod(_Pod);

PROC
PROC_COL_TadpolingCentre_EmptyPod((ITEM)_Pod)
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Bed,(TRIGGER)_,(TRIGGER)_ReleaseTrigger,(INTEGER)_)
AND
NOT DB_COL_TadpolingCentre_EmptyPod(_Bed)
THEN
TeleportTo(_Character,_ReleaseTrigger,"",0,0,0,0,1);
SetCanJoinCombat(_Character,1);
SetCanFight(_Character,1);
PROC_CharacterEnableAllCrimes(_Character);
DB_COL_TadpolingCentre_EmptyPod(_Bed);
RemoveStatus(_Character,"COL_TADPOLINGCENTRE_INPOD",NULL_00000000-0000-0000-0000-000000000000);
PROC_COL_TadpolingCentre_OnReleased((CHARACTER)_Character);

PROC
PROC_COL_TadpolingCentre_PodsPurgeAll((CHARACTER)_Player)
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_Bed,(TRIGGER)_,(TRIGGER)_,(INTEGER)_)
AND
DB_COL_TadpolingCentre_Pods((ITEM)_Pod,(ITEM)_Bed,(DIALOGRESOURCE)_Dialog,(ITEM)_Imprint)
AND
NOT DB_COL_TadpolingCentre_EmptyPod(_Bed)
THEN
Die(_Character,DEATHTYPE.Psychic,_Player,1,1,0.0);
RemoveTransforms(_Imprint);
ClearFlag(COL_TadpolingCentre_State_PodEmpty_e6f46eda-913a-47ce-8248-70177ee4ecfc,_Imprint);
DB_COL_TadpolingCentre_EmptyPod(_Bed);
PROC_COL_TadpolingCentre_PurgeCleanUp(_Character);

PROC
PROC_COL_TadpolingCentre_PurgeCleanUp((GUIDSTRING)_Character)
THEN
DB_COL_TadpolingCentre_PurgeCleanUp(_Character);
PROC_Poof(_Character,VFX_Script_Tentacle_Teleport_01_3f4d2a5d-1772-9550-6ea6-05d733d102c0);
//Character should still be on stage at this point!

//Scatter corpses into the Oubliette with a random offset
IF
WentOnStage(_Character,0)
AND
DB_COL_TadpolingCentre_PurgeCleanUp((GUIDSTRING)_Character)
AND
GetPosition(S_MOO_OublietteAppearPos_da5c04d6-6b54-43ac-b171-4c8157f1c9d4,_OX,_Y,_OZ)
AND
Random(10,_RX)
AND
Random(10,_RZ)
AND
IntegerSubtract(_RX,5,_SX) //should be half the random value max
AND
IntegerSubtract(_RZ,5,_SZ)
AND
IntegerToReal(_SX,_RealX)
AND
IntegerToReal(_SZ,_RealZ)
AND
RealSum(_OX,_RealX,_X)
AND
RealSum(_OZ,_RealZ,_Z)
THEN
TeleportToPosition(_Character,_X,_Y,_Z,"COL_TadpolingCentre_PurgeTeleported",0,0,0,1,1);
NOT DB_COL_TadpolingCentre_PurgeCleanUp((GUIDSTRING)_Character);

IF
EntityEvent(_Character,"COL_TadpolingCentre_PurgeTeleported")
THEN
PROC_Foop(_Character,VFX_Script_Tentacle_Teleport_01_3f4d2a5d-1772-9550-6ea6-05d733d102c0);

//END_REGION

//REGION ADs (pods, Zevlor, Daisy)

//Memory imprint ADs
IF
DB_COL_TadpolingCentre_Pods((ITEM)_Pod,(ITEM)_,(DIALOGRESOURCE)_Dialog,(ITEM)_Imprint)
THEN
SetCanInteract(_Pod,0);
DB_AD_Dialog(_Imprint,_Dialog);

IF
DB_COL_TadpolingCentre_EmptyPod(_Bed)
AND
DB_COL_TadpolingCentre_Pods((ITEM)_Pod,(ITEM)_Bed,(DIALOGRESOURCE)_Dialog,(ITEM)_Imprint)
THEN
Transform(_Imprint,PUZ_MF_Nautiloid_Mind_Draining_Device_Button_A_Red_8e973459-c0ef-44e2-b118-e967ab018731,(SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
SetFlag(COL_TadpolingCentre_State_PodEmpty_e6f46eda-913a-47ce-8248-70177ee4ecfc,_Imprint);

//Zevlor pod
PROC
PROC_COL_TadpolingCentre_CharacterEnteredPod((CHARACTER)S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a)
AND
DB_InternScene_Exists("DEN_RaidingParty_PleaAtGate")
THEN
PROC_SceneOver("DEN_RaidingParty_PleaAtGate");

PROC
PROC_COL_TadpolingCentre_CharacterEnteredPod((CHARACTER)S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a)
THEN
DB_COL_TadpolingCentre_ZevlorInColony(1);
PROC_TriggerRegisterForParty(S_COL_TadpolingCentre_ZevlorAD_Box_d8931927-0343-41ac-ade4-e2c40f69e9fd);
PROC_TriggerRegisterForPlayers(S_COL_TadpolingCentre_ZevlorAD_BlockElderBrainAD_Box_2767eac5-cefb-413a-987c-53fbe0bad018);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a,COL_TadpolingCentre_Zevlor_Dead_0f08ef28-7b17-97a5-3f0b-001a12e42b2c);

IF
LevelUnloading("SCL_Main_A")
AND
DB_GLO_CharacterCorpseDialog((CHARACTER)S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a,COL_TadpolingCentre_Zevlor_Dead_0f08ef28-7b17-97a5-3f0b-001a12e42b2c)
THEN
NOT DB_GLO_CharacterCorpseDialog((CHARACTER)S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a,COL_TadpolingCentre_Zevlor_Dead_0f08ef28-7b17-97a5-3f0b-001a12e42b2c);

IF
DB_InRegion(_,S_COL_TadpolingCentre_ZevlorAD_Box_d8931927-0343-41ac-ade4-e2c40f69e9fd)
AND
NOT DB_COL_TadpolingCentre_DoingZevlorAD(1)
THEN
DB_COL_TadpolingCentre_DoingZevlorAD(1);
TimerCancel("COL_TadpolingCentre_AD_Zevlor_Pod");
TimerLaunch("COL_TadpolingCentre_AD_Zevlor_Pod",4000);

IF
DB_COL_TadpolingCentre_DoingZevlorAD(1)
AND
NOT DB_InRegion(_,S_COL_TadpolingCentre_ZevlorAD_Box_d8931927-0343-41ac-ade4-e2c40f69e9fd)
THEN
NOT DB_COL_TadpolingCentre_DoingZevlorAD(1);
TimerCancel("COL_TadpolingCentre_AD_Zevlor_Pod");

IF
TimerFinished("COL_TadpolingCentre_AD_Zevlor_Pod")
AND
NOT DB_Offstage(S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a)
THEN
TimerLaunch("COL_TadpolingCentre_AD_Zevlor_Pod",16000);
PROC_TryStartAD(COL_TadpolingCentre_AD_Zevlor_Pod_53603a3f-c657-2d06-dc5e-9ae2570699ea,S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a);

PROC
PROC_COL_TadpolingCentre_OnReleased((CHARACTER)S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a)
THEN
PROC_COL_TadpolingCentre_ZevlorPodFinished();

IF
DB_CantTalk(S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a)
AND
DB_COL_TadpolingCentre_ZevlorInColony(1)
THEN
PROC_COL_TadpolingCentre_ZevlorPodFinished();

PROC
PROC_COL_TadpolingCentre_ZevlorPodFinished()
THEN
PROC_TriggerUnregisterForParty(S_COL_TadpolingCentre_ZevlorAD_Box_d8931927-0343-41ac-ade4-e2c40f69e9fd);
PROC_TriggerUnregisterForPlayers(S_COL_TadpolingCentre_ZevlorAD_BlockElderBrainAD_Box_2767eac5-cefb-413a-987c-53fbe0bad018);
NOT DB_COL_TadpolingCentre_DoingZevlorAD(1);
TimerCancel("COL_TadpolingCentre_AD_Zevlor_Pod");

//Zevlor combat AD
IF
TurnStarted(S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a)
AND
DB_COL_TadpolingCentre_ZevlorInColony(1)
AND
DB_Is_InCombat(S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a,_CombatId)
AND
DB_COL_TadpolingCentre_ReleaseCombatId(_CombatId)
AND
QRY_OnlyOnce("COL_TadpolingCentre_AD_Zevlor_Combat")
THEN
PROC_TryStartAD(COL_TadpolingCentre_AD_Zevlor_Combat_9f00148e-34ad-ea1c-0665-793da422b7f6,S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a);

//Daisy AD
IF
DB_InRegion(_Player,S_COL_TadpolingCentre_DaisyAD_Box_254c466d-ba73-4de6-bd0d-42ea29e232fb)
AND
NOT DB_Is_InCombat(_Player,_)
THEN
PROC_DaisyAD(_Player,COL_TadpolingCentre_DaisyAD_PodsComment_f573ff77-91fa-ac75-068b-9b3068492202);
PROC_TriggerUnregisterForPlayers(S_COL_TadpolingCentre_DaisyAD_Box_254c466d-ba73-4de6-bd0d-42ea29e232fb);

IF
DB_GlobalFlag((FLAG)COL_TadpolingCentre_Event_PurgePods_e9c700a3-5ba8-07e9-e13f-c2e081a3a1c5)
AND
DB_COL_TadpolingCentre_DaisyAD_Registered(1)
THEN
PROC_TriggerUnregisterForPlayers(S_COL_TadpolingCentre_DaisyAD_Box_254c466d-ba73-4de6-bd0d-42ea29e232fb);

IF
DB_GlobalFlag((FLAG)COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868)
AND
DB_COL_TadpolingCentre_DaisyAD_Registered(1)
THEN
PROC_TriggerUnregisterForPlayers(S_COL_TadpolingCentre_DaisyAD_Box_254c466d-ba73-4de6-bd0d-42ea29e232fb);

PROC
PROC_TriggerUnregisterForPlayers(S_COL_TadpolingCentre_DaisyAD_Box_254c466d-ba73-4de6-bd0d-42ea29e232fb)
THEN
NOT DB_COL_TadpolingCentre_DaisyAD_Registered(1);

//Mizora pod PAD
IF
DB_COL_Mizora_CaptureSetupDone(_)
THEN
PROC_TriggerRegisterForPlayers(S_COL_Mizora_PodApproach_Box_ab898639-200e-4cf5-a693-dcb27d3a4fcc);
DB_COL_TadpolingCentre_PAD_PodApproach_Registered(1);

IF
EnteredTrigger(_Player,S_COL_Mizora_PodApproach_Box_ab898639-200e-4cf5-a693-dcb27d3a4fcc)
AND
NOT DB_CantTalk(_Player)
THEN
PROC_TryStartAD(COL_TadpolingCentre_PAD_MizoraPodComment_d61399ca-e470-b0c0-cb7c-423678408118,_Player);
PROC_TriggerUnregisterForPlayers(S_COL_Mizora_PodApproach_Box_ab898639-200e-4cf5-a693-dcb27d3a4fcc);

IF
DB_GlobalFlag((FLAG)COL_MizorasRescue_State_SavedMizora_148bcec2-5367-2b72-3c93-29fb32fc0181)
AND
DB_COL_TadpolingCentre_PAD_PodApproach_Registered(1)
THEN
PROC_TriggerUnregisterForPlayers(S_COL_Mizora_PodApproach_Box_ab898639-200e-4cf5-a693-dcb27d3a4fcc);

IF
DB_GlobalFlag((FLAG)COL_MizorasRescue_State_KilledMizora_55d5833a-c07d-3461-8c88-a98da5207674)
AND
DB_COL_TadpolingCentre_PAD_PodApproach_Registered(1)
THEN
PROC_TriggerUnregisterForPlayers(S_COL_Mizora_PodApproach_Box_ab898639-200e-4cf5-a693-dcb27d3a4fcc);

PROC
PROC_TriggerUnregisterForPlayers(S_COL_Mizora_PodApproach_Box_ab898639-200e-4cf5-a693-dcb27d3a4fcc)
THEN
NOT DB_COL_TadpolingCentre_PAD_PodApproach_Registered(1);

//END_REGION

//REGION Pods lever

PROC
PROC_BlockUseOfItem(_Player,(ITEM)S_COL_TadpolingCentre_Lever_Pods_91cb4e30-4490-41a3-b347-987d43ee8e53)
AND
DB_OnlyOnce("COL_KethericShowdown_ChosenThree")
AND
NOT DB_GlobalFlag((FLAG)COL_TadpolingCentre_Event_PurgePods_e9c700a3-5ba8-07e9-e13f-c2e081a3a1c5)
AND
NOT DB_GlobalFlag((FLAG)COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868)
THEN
DB_CustomUseItemResponse(_Player, S_COL_TadpolingCentre_Lever_Pods_91cb4e30-4490-41a3-b347-987d43ee8e53, 0);
PROC_PlayCantUseItemAD(_Player);

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_COL_TadpolingCentre_DaisyAD_Registered(1)
THEN
PROC_TriggerUnregisterForPlayers(S_COL_TadpolingCentre_DaisyAD_Box_254c466d-ba73-4de6-bd0d-42ea29e232fb);

IF
UseFinished(_Player,(ITEM)S_COL_TadpolingCentre_Lever_Pods_91cb4e30-4490-41a3-b347-987d43ee8e53,1)
AND
DB_Players(_Player)
AND
QRY_StartDialogCustom_Fixed(COL_TadpolingCentre_Pods_21ea92f4-2578-eefc-6499-1f41f0620296,S_COL_TadpolingCentre_Lever_Pods_91cb4e30-4490-41a3-b347-987d43ee8e53,_Player,0,0,0,1)
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers(COL_TadpolingCentre_Pods_21ea92f4-2578-eefc-6499-1f41f0620296,_DialogId)
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_,(TRIGGER)_,(TRIGGER)_ReleaseTrigger,(INTEGER)_)
AND
QRY_SpeakerIsAvailable(_Character)
THEN
PROC_DialogAddSpeakingActor(_DialogId,_Character);

IF
FlagSet(COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868,_,_)
THEN
PROC_COL_TadpolingCentre_PodsReleaseAll();

PROC
PROC_GlobalFlagReactionAfterDialog(COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868)
THEN
PROC_COL_TadpolingCentre_InitReleaseCombat();

PROC
PROC_GlobalFlagReactionAfterDialog(COL_TadpolingCentre_Event_PurgePods_e9c700a3-5ba8-07e9-e13f-c2e081a3a1c5,_,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,_)
THEN
PROC_COL_TadpolingCentre_PodsPurgeAll((CHARACTER)_Player);

//END_REGION

//REGION Mind flayer combat

PROC
PROC_COL_TadpolingCentre_InitReleaseCombat()
THEN
PROC_SetRelationToPlayers((FACTION)ACT2_COL_TadpolingCentre_Mindflayers_633d2d0f-5f50-41c3-bc41-831fc8bdd1c2,0);
PROC_SetRelationToPlayers((FACTION)ACT2_COL_TadpolingCentre_IntDevourers_ae10677b-e394-4bb3-84aa-5b37418d8c75,0);
PROC_SetRelationMutual((FACTION)ACT2_COL_TadpolingCentre_Mindflayers_633d2d0f-5f50-41c3-bc41-831fc8bdd1c2,(FACTION)ACT2_COL_TadpolingCentre_IntDevourers_ae10677b-e394-4bb3-84aa-5b37418d8c75,100);
PROC_SetRelationMutual((FACTION)ACT2_COL_TadpolingCentre_Prisoners_064f9b52-e5b7-4b2e-8c21-a44b08d94aac,(FACTION)ACT2_COL_TadpolingCentre_Mindflayers_633d2d0f-5f50-41c3-bc41-831fc8bdd1c2,0);
PROC_SetRelationMutual((FACTION)ACT2_COL_TadpolingCentre_Prisoners_064f9b52-e5b7-4b2e-8c21-a44b08d94aac,(FACTION)ACT2_COL_TadpolingCentre_IntDevourers_ae10677b-e394-4bb3-84aa-5b37418d8c75,0);

PROC
PROC_COL_TadpolingCentre_InitReleaseCombat()
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Mindflayer,(ITEM)_,(TRIGGER)_,(TRIGGER)_,0)
THEN
DB_GLO_DefeatCounter(_Mindflayer,"COL_TadpolingCentre");

IF
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Mindflayer,(ITEM)_,(TRIGGER)_,(TRIGGER)_,0)
AND
DB_Is_InCombat(_Mindflayer,_CombatId)
AND
NOT DB_COL_TadpolingCentre_ReleaseCombatId(_CombatId)
THEN
DB_COL_TadpolingCentre_ReleaseCombatId(_CombatId);

//Party members entering/leaving the combat
//Add party members to combat DB
IF
DB_Is_InCombat(_PartyMember,_CombatId)
AND
DB_COL_TadpolingCentre_ReleaseCombatId(_CombatId)
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
NOT DB_COL_TadpolingCentre_CombatPartyMembers(_PartyMember,_CombatId)
THEN
PROC_COL_TadpolingCentre_AddCombatPartyMember(_PartyMember,_CombatId);

//PROC Add: First party member entered -> apply tag
PROC
PROC_COL_TadpolingCentre_AddCombatPartyMember((CHARACTER)_,(GUIDSTRING)_CombatId)
AND
NOT DB_COL_TadpolingCentre_CombatPartyMembers(_,_CombatId)
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_,(TRIGGER)_,(TRIGGER)_,1)
THEN
SetTag(_Character,(TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);

//PROC Add: Add to DB
PROC
PROC_COL_TadpolingCentre_AddCombatPartyMember((CHARACTER)_PartyMember,(GUIDSTRING)_CombatId)
THEN
DB_COL_TadpolingCentre_CombatPartyMembers(_PartyMember,_CombatId);

//Remove party members from combat DB
IF
DB_COL_TadpolingCentre_CombatPartyMembers(_PartyMember,_CombatId)
AND
NOT DB_Is_InCombat(_PartyMember,_CombatId)
THEN
PROC_COL_TadpolingCentre_RemoveCombatPartyMember(_PartyMember,_CombatId);

//PROC Remove: Remove from DB
PROC
PROC_COL_TadpolingCentre_RemoveCombatPartyMember((CHARACTER)_PartyMember,(GUIDSTRING)_CombatId)
AND
DB_COL_TadpolingCentre_CombatPartyMembers(_PartyMember,_CombatId)
THEN
NOT DB_COL_TadpolingCentre_CombatPartyMembers(_PartyMember,_CombatId);

//PROC Remove: Last party member left -> clear tag
PROC
PROC_COL_TadpolingCentre_RemoveCombatPartyMember((CHARACTER)_,(GUIDSTRING)_CombatId)
AND
NOT DB_COL_TadpolingCentre_CombatPartyMembers(_,_CombatId)
AND
NOT QRY_COL_TadpolingCentre_AnyPartyMemberInAnyCombat()
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_,(TRIGGER)_,(TRIGGER)_,1)
THEN
ClearTag(_Character,(TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);

QRY
QRY_COL_TadpolingCentre_AnyPartyMemberInAnyCombat()
AND
DB_COL_TadpolingCentre_ReleaseCombatId(_CombatId)
AND
DB_COL_TadpolingCentre_CombatPartyMembers(_,_CombatId)
THEN
DB_NOOP(1);

IF
TurnStarted(_Character)
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,_,_,_,0)
AND
NOT DB_OnlyOnce("COL_TadpolingCentre_AD_Mindflayers_EnterCombat")
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Mindflayer,_,_,_,0)
THEN
PROC_TryStartAD(COL_TadpolingCentre_AD_Mindflayers_EnterCombat_4fe200b7-ccf4-9c51-cba3-22fd29d91d8b,_Mindflayer);

IF
AutomatedDialogStarted(COL_TadpolingCentre_AD_Mindflayers_EnterCombat_4fe200b7-ccf4-9c51-cba3-22fd29d91d8b,_)
AND
NOT DB_OnlyOnce("COL_TadpolingCentre_AD_Mindflayers_EnterCombat")
THEN
DB_OnlyOnce("COL_TadpolingCentre_AD_Mindflayers_EnterCombat");

//END_REGION

//REGION Post combat dialog

PROC
PROC_COL_TadpolingCentre_OnReleased((CHARACTER)_Character)
AND
DB_COL_TadpolingCentre_PodCharacters_FreedDialog(_Character,_Dialog)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Character);
DB_Dialogs(_Character,_Dialog);

IF
CombatEnded(_CombatId)
AND
DB_COL_TadpolingCentre_ReleaseCombatId(_CombatId)
THEN
NOT DB_COL_TadpolingCentre_ReleaseCombatId(_CombatId);
PROC_COL_TadpolingCentre_CheckCharactersInCombat();

PROC
PROC_COL_TadpolingCentre_CheckCharactersInCombat()
AND
NOT QRY_COL_TadpolingCentre_AnyPartyMemberInAnyCombat()
AND
DB_COL_TadpolingCentre_PodCharacters((CHARACTER)_Character,(ITEM)_,(TRIGGER)_,(TRIGGER)_,1)
THEN
ClearTag(_Character,(TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("COL_TadpolingCentre")
AND
DB_COL_TadpolingCentre_ReleaseCombatId(_CombatId)
THEN
NOT DB_COL_TadpolingCentre_ReleaseCombatId(_CombatId);

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("COL_TadpolingCentre")
THEN
PROC_COL_TadpolingCentre_CheckCharactersInCombat();

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("COL_TadpolingCentre")
AND
NOT DB_OnlyOnce("COL_TadpolingCentre_ZevlorAfterCombat_DialogStarted")
THEN
DB_SpotPlayers((CHARACTER)S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a,"COL_TadpolingCentre_ZevlorAfterCombat",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a,"COL_TadpolingCentre_ZevlorAfterCombat",_Player)
AND
QRY_StartDialog((DIALOGRESOURCE)COL_TadpolingCentre_PostCombat_Zevlor_5a2d0fdb-a603-b6a9-ff5e-10b57900b957,S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a,_Player)
THEN
DB_NOOP(1);

IF
DialogStarted((DIALOGRESOURCE)COL_TadpolingCentre_PostCombat_Zevlor_5a2d0fdb-a603-b6a9-ff5e-10b57900b957,_)
THEN
PROC_SpotPlayers_StopSpotting("COL_TadpolingCentre_ZevlorAfterCombat");
DB_OnlyOnce("COL_TadpolingCentre_ZevlorAfterCombat_DialogStarted");

//END_REGION

//REGION Brine pools

IF
UseFinished(_Player,S_COL_BrinePool_Interact_68ba6c98-9e45-4521-b2ab-19b75fe03d69,1)
AND
DB_Players(_Player)
AND
NOT DB_CantTalk(_Player)
AND
NOT QRY_COL_TadpolingCentre_BrinePools_TryPerception(_Player)
THEN
PROC_TryStartAD((DIALOGRESOURCE)COL_TadpoleChamber_PAD_BrinePool_0a396b23-e7c7-5877-c5c6-ee0523a9db8a,_Player);

//Do perception check, otherwise play default PAD
QRY
QRY_COL_TadpolingCentre_BrinePools_TryPerception((CHARACTER)_Player)
AND
NOT DB_GlobalFlag(COL_TadpolingCentre_State_BrinePoolEmpty_af7d6534-ab6e-46eb-9de6-ecf5235993cd)
AND
NOT DB_OnlyOncePerPlayer(_Player,"COL_TadpolingCentre_DidPerceptionCheck")
THEN
PROC_KnowledgeCheck((CHARACTER)_Player,"COL_TadpolingCentre_PerceptionCheck",(GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000,"Perception",
(DIFFICULTYCLASS)Act2_Challenging_c44bfd7d-84de-4568-9c57-a059b8df5435,(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_OnlyOncePerPlayer(_Player,"COL_TadpolingCentre_DidPerceptionCheck");

//Success
PROC
PROC_GLO_KnowledgeCheckEnded(_Player,"COL_TadpolingCentre_PerceptionCheck",_,_,1)
THEN
SetFlag(COL_TadpolingCentre_State_BrinePoolEmpty_af7d6534-ab6e-46eb-9de6-ecf5235993cd);
PROC_ToInventoryAndOnStage((ITEM)S_COL_TadpolingCentre_TadpolePowerJar_dac897b8-1c53-49c5-aef3-b6017fe75fd5,_Player,1,1,1);
PROC_Tadpole_TadpoleInJarAD((CHARACTER)_Player,(ITEM)S_COL_TadpolingCentre_TadpolePowerJar_dac897b8-1c53-49c5-aef3-b6017fe75fd5);

//Keeping this in for people saving during the PAD
IF
AutomatedDialogEnded(COL_TadpolingCentre_PAD_BrinePool_Tadpole_c35c45b4-4294-87b6-6c4b-7ebef10a502b,_)
AND
DB_COL_TadpolingCentre_ReceiveTadpole(_Player)
THEN
NOT DB_COL_TadpolingCentre_ReceiveTadpole(_Player);
PROC_ToInventoryAndOnStage((ITEM)S_COL_TadpolingCentre_TadpolePowerJar_dac897b8-1c53-49c5-aef3-b6017fe75fd5,_Player,1,1,1);

//Fail
PROC
PROC_GLO_KnowledgeCheckEnded(_Player,"COL_TadpolingCentre_PerceptionCheck",_,_,0)
THEN
PROC_TryStartAD((DIALOGRESOURCE)COL_TadpoleChamber_PAD_BrinePool_0a396b23-e7c7-5877-c5c6-ee0523a9db8a,_Player);

PROC
PROC_OneShotTriggerEntered(_Player,(TRIGGER)S_COL_TadpolingCentre_Brine_Daisy_afd607e5-3912-4236-b4dd-074f76495047)
THEN
PROC_DaisyAD(_Player,(DIALOGRESOURCE)COL_TadpolingCentre_DaisyAD_BrinePool_56f3a2e4-7423-edd0-43ca-d32a619ca7b8);

//END_REGION

//REGION Dark Urge pod

PROC
PROC_COL_TeleportPartiesToColony(_)
AND
NOT DB_GlobalFlag((FLAG)GLO_Origin_PartOfTheTeam_DarkUrge_fbf4c4a8-99bb-4e62-a78c-cc9c115bd938)
THEN
SetCanInteract(S_COL_TadpolingCentre_DarkUrgePod_1c7028d3-bb96-4bc5-8fb6-8b6e1d6a5e27,0);

IF
UseFinished(_Player,S_COL_TadpolingCentre_DarkUrgePod_1c7028d3-bb96-4bc5-8fb6-8b6e1d6a5e27,1)
AND
DB_Players(_Player)
AND
QRY_StartDialog_Fixed(COL_TadpolingCentre_DarkUrgePod_b26c028e-3a2e-a31d-75c9-e7ba6810c4ed,S_COL_TadpolingCentre_DarkUrgePod_1c7028d3-bb96-4bc5-8fb6-8b6e1d6a5e27,_Player)
THEN
DB_NOOP(1);

//For debug purposes - normally this wouldn't happen in gameplay
IF
FlagSet((FLAG)GLO_Origin_PartOfTheTeam_DarkUrge_fbf4c4a8-99bb-4e62-a78c-cc9c115bd938,_,_)
THEN
SetCanInteract(S_COL_TadpolingCentre_DarkUrgePod_1c7028d3-bb96-4bc5-8fb6-8b6e1d6a5e27,1);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
