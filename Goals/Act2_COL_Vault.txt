Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Puzzle 3

DB_COL_Vault_Nodes((ITEM)S_COL_VaultPuzzle_3_001_1b1e8d22-d864-4315-9ca0-fe6ebd8c3909);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_002_e8d259c5-e35e-46a8-ba49-22134098be96);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_003_05fed984-c1b3-4d36-8447-13773b9ee4ac);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_004_fbcf50f3-107d-414a-b34e-4597310f6b41);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_007_4d15cd66-85d1-4fd3-8e74-5a49a3492954);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_008_8ac59cf1-e943-4c6d-98c7-c579f98ba4bb);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_010_18ad4767-41bc-4626-8e74-0286a931c882);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_011_648279eb-2c62-40a0-9300-34e91f72ba5a);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_012_6c45fdbb-246d-493f-8eeb-cddb7c80e7d2);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_018_7813ea37-ab44-452c-829b-9958676c132c);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_019_ced78d50-108d-4a1e-9ef3-148227ae6659);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_020_ec12aa5f-c015-4e74-96b0-2d8fedfe1c32);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_022_d23e6cef-9b8f-4149-b80b-ef0a339b9823);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_023_5f85bfdb-7c3f-4626-b102-47ec5909ba55);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_024_34a63e20-b77c-4edc-a4db-5126f8291988);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_025_ec80ce07-b6db-4d34-94c6-f699487552a4);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_028_fcbcd5df-9644-457c-8e0c-ca492eb68e2d);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_029_057893cc-7dc6-4115-ac1f-aae0912d8f0b);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_027_f0d51c10-d717-4fa1-b376-a9b5d0eb2197);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_030_e937168b-02fb-4e8b-bfba-a323ec54cdd5);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_032_20fc783d-137b-422f-906c-2856ae8057a4);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_033_8e2d7b54-7d3c-4a32-afcd-0aebf8021cc4);
DB_COL_Vault_Nodes(S_COL_VaultPuzzle_3_035_9a418aaa-7cd9-4643-ba92-bc020a5b8fe9);

PROC_COL_Vault_DefineNeighbourDirections();

DB_COL_Vault_SourceNodes((ITEM)S_COL_VaultPuzzle_3_001_1b1e8d22-d864-4315-9ca0-fe6ebd8c3909, 1);
DB_COL_Vault_SourceNodes((ITEM)S_COL_VaultPuzzle_3_002_e8d259c5-e35e-46a8-ba49-22134098be96, 2);
DB_COL_Vault_SourceNodes((ITEM)S_COL_VaultPuzzle_3_003_05fed984-c1b3-4d36-8447-13773b9ee4ac, 3);
DB_COL_Vault_SourceNodes((ITEM)S_COL_VaultPuzzle_3_004_fbcf50f3-107d-414a-b34e-4597310f6b41, 4);

DB_COL_Vault_LockedNodes((ITEM)S_COL_VaultPuzzle_3_022_d23e6cef-9b8f-4149-b80b-ef0a339b9823, 1, (FLAG)COL_Vault_State_Node1Unlocked_e43e0029-c025-40d1-a408-5bdc06c0079b);
DB_COL_Vault_LockedNodes((ITEM)S_COL_VaultPuzzle_3_025_ec80ce07-b6db-4d34-94c6-f699487552a4, 2, COL_Vault_State_Node2Unlocked_185e999c-3fcf-413d-8dd8-aaef803e41d3);
DB_COL_Vault_LockedNodes((ITEM)S_COL_VaultPuzzle_3_023_5f85bfdb-7c3f-4626-b102-47ec5909ba55, 3, COL_Vault_State_Node3Unlocked_97168bc6-f935-4c6a-9f91-ca25a05c10fb);
DB_COL_Vault_LockedNodes((ITEM)S_COL_VaultPuzzle_3_024_34a63e20-b77c-4edc-a4db-5126f8291988, 4, COL_Vault_State_Node4Unlocked_f6717b7b-4359-4b0c-8096-f59d81a2ca5d);

//END_REGION

DB_COL_Vault_Node_ChargeVFX(-1, (EFFECTRESOURCE)VFX_Script_SCL_BrainPuzzle_Default_Node_Deactivated_01_41208251-6c82-c2f9-8b60-392d12b99716,(ROOT)NULL_00000000-0000-0000-0000-000000000000);//NoCharge_NotConnected
DB_COL_Vault_Node_ChargeVFX(0, VFX_Script_SCL_BrainPuzzle_Untyped_Node_Activated_01_7c5c72fb-3b94-fee7-912a-5227261ff9ad,(ROOT)NULL_00000000-0000-0000-0000-000000000000);//NoCharge_Connected
DB_COL_Vault_Node_ChargeVFX(1, VFX_Script_SCL_BrainPuzzle_Emotion_Node_Activated_01_31f0a6a3-18b1-ccd5-9c9d-48e63a87241d,(ROOT)PUZ_MF_Brain_Part_F_eff790b4-d9a6-4164-b71c-6017990f8a6b);
DB_COL_Vault_Node_ChargeVFX(2, VFX_Script_SCL_BrainPuzzle_Memory_Node_Activated_01_e6d290c8-e0bd-819e-7be6-ba69e7cbfbc9,(ROOT)PUZ_MF_Brain_Part_G_d5a0e7c5-0f2e-4d43-9694-61635fe852d1);
DB_COL_Vault_Node_ChargeVFX(3, VFX_Script_SCL_BrainPuzzle_Speech_Node_Activated_01_d8b09dc6-5944-aa35-6b5d-99f9901ac8da,(ROOT)PUZ_MF_Brain_Part_H_9fcd7906-d14e-4f42-acbc-1f9e2330a804);
DB_COL_Vault_Node_ChargeVFX(4, VFX_Script_SCL_BrainPuzzle_Reason_Node_Activated_01_42e46374-7087-524e-a0ff-64ecaa59823b,(ROOT)PUZ_MF_Brain_Part_I_026de73b-38bc-4131-bbc0-0cc13ba826af);

DB_COL_Vault_Brain_ChargeVFX(-1, (EFFECTRESOURCE)VFX_Script_SCL_BrainPuzzle_Default_Brain_Deactivated_01_e254c4d2-1f4b-6ac9-72c5-12506195e5b1);//NoCharge_NotConnected
DB_COL_Vault_Brain_ChargeVFX(1, VFX_Script_SCL_BrainPuzzle_Emotion_Brain_Activated_01_61ee2d0c-d9d7-2001-b4ef-bb8a481989ed);
DB_COL_Vault_Brain_ChargeVFX(2, VFX_Script_SCL_BrainPuzzle_Memory_Brain_Activated_01_aaa41f83-8e61-3708-61ac-e183eff09f4c);
DB_COL_Vault_Brain_ChargeVFX(3, VFX_Script_SCL_BrainPuzzle_Speech_Brain_Activated_01_66f47c93-1c42-d5bd-567b-0ea88807ca2d);
DB_COL_Vault_Brain_ChargeVFX(4, VFX_Script_SCL_BrainPuzzle_Reason_Brain_Activated_01_e67610d2-76b2-ea20-73f2-bff1dbc51d97);

DB_COL_Vault_Beam_ChargeVFX(-1, (EFFECTRESOURCE)VFX_Script_SCL_BrainPuzzle_Default_Beam_01_c397eeae-7eb1-61f9-ca09-158a5d42a3e3);
DB_COL_Vault_Beam_ChargeVFX(0, VFX_Script_SCL_BrainPuzzle_Untyped_Beam_01_5d83ff09-90a0-1743-67bd-edfe72068bff);
DB_COL_Vault_Beam_ChargeVFX(1, VFX_Script_SCL_BrainPuzzle_Emotion_Beam_01_c805a1cc-df4d-8aa1-94a8-76a22bf2dd32);
DB_COL_Vault_Beam_ChargeVFX(2, VFX_Script_SCL_BrainPuzzle_Memory_Beam_01_911fc739-b328-531c-aa53-d3b4314bc9b4);
DB_COL_Vault_Beam_ChargeVFX(3, VFX_Script_SCL_BrainPuzzle_Speech_Beam_01_5e969f6e-ed23-a1d8-11f3-fd3657aa5027);
DB_COL_Vault_Beam_ChargeVFX(4, VFX_Script_SCL_BrainPuzzle_Reason_Beam_01_7324cd83-d789-f479-bbb6-2a45c546967c);

DB_Dialogs((ITEM)S_COL_Vault_PuzzleButton3_0f07d5be-159d-48f4-94c4-4c9ee0234423, (DIALOGRESOURCE)COL_Vault_Puzzle_df526505-b938-8ac6-e127-5ec1dd9c5adf);

DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_001_1b1e8d22-d864-4315-9ca0-fe6ebd8c3909, (ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4, (ITEM)S_COL_VaultPuzzle_3_035_9a418aaa-7cd9-4643-ba92-bc020a5b8fe9);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_035_9a418aaa-7cd9-4643-ba92-bc020a5b8fe9, (ITEM)S_COL_VaultPuzzle_3_033_8e2d7b54-7d3c-4a32-afcd-0aebf8021cc4);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_033_8e2d7b54-7d3c-4a32-afcd-0aebf8021cc4, (ITEM)S_COL_VaultPuzzle_3_027_f0d51c10-d717-4fa1-b376-a9b5d0eb2197);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_027_f0d51c10-d717-4fa1-b376-a9b5d0eb2197, (ITEM)S_COL_VaultPuzzle_3_022_d23e6cef-9b8f-4149-b80b-ef0a339b9823);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_002_e8d259c5-e35e-46a8-ba49-22134098be96, (ITEM)S_COL_VaultPuzzle_3_008_8ac59cf1-e943-4c6d-98c7-c579f98ba4bb);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_008_8ac59cf1-e943-4c6d-98c7-c579f98ba4bb, (ITEM)S_COL_VaultPuzzle_3_010_18ad4767-41bc-4626-8e74-0286a931c882);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_010_18ad4767-41bc-4626-8e74-0286a931c882, (ITEM)S_COL_VaultPuzzle_3_018_7813ea37-ab44-452c-829b-9958676c132c);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_018_7813ea37-ab44-452c-829b-9958676c132c, (ITEM)S_COL_VaultPuzzle_3_029_057893cc-7dc6-4115-ac1f-aae0912d8f0b);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_029_057893cc-7dc6-4115-ac1f-aae0912d8f0b, (ITEM)S_COL_VaultPuzzle_3_025_ec80ce07-b6db-4d34-94c6-f699487552a4);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_004_fbcf50f3-107d-414a-b34e-4597310f6b41, (ITEM)S_COL_VaultPuzzle_3_007_4d15cd66-85d1-4fd3-8e74-5a49a3492954);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_007_4d15cd66-85d1-4fd3-8e74-5a49a3492954, (ITEM)S_COL_VaultPuzzle_3_011_648279eb-2c62-40a0-9300-34e91f72ba5a);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_011_648279eb-2c62-40a0-9300-34e91f72ba5a, (ITEM)S_COL_VaultPuzzle_3_032_20fc783d-137b-422f-906c-2856ae8057a4);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_032_20fc783d-137b-422f-906c-2856ae8057a4, (ITEM)S_COL_VaultPuzzle_3_028_fcbcd5df-9644-457c-8e0c-ca492eb68e2d);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_028_fcbcd5df-9644-457c-8e0c-ca492eb68e2d, (ITEM)S_COL_VaultPuzzle_3_024_34a63e20-b77c-4edc-a4db-5126f8291988);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_003_05fed984-c1b3-4d36-8447-13773b9ee4ac, (ITEM)S_COL_VaultPuzzle_3_012_6c45fdbb-246d-493f-8eeb-cddb7c80e7d2);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_012_6c45fdbb-246d-493f-8eeb-cddb7c80e7d2, (ITEM)S_COL_VaultPuzzle_3_019_ced78d50-108d-4a1e-9ef3-148227ae6659);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_019_ced78d50-108d-4a1e-9ef3-148227ae6659, (ITEM)S_COL_VaultPuzzle_3_030_e937168b-02fb-4e8b-bfba-a323ec54cdd5);
DB_COL_Vault_Solution((ITEM)S_COL_VaultPuzzle_3_030_e937168b-02fb-4e8b-bfba-a323ec54cdd5, (ITEM)S_COL_VaultPuzzle_3_023_5f85bfdb-7c3f-4626-b102-47ec5909ba55);

PROC_DeclareCounter("COL_Vault_UnlockedNodes");
DB_COL_Vault_CounterFlags(1, (FLAG)COL_Vault_State_1NodeUnlocked_8199dc4f-2fb0-40ff-aa5a-bcce6e7a7643);
DB_COL_Vault_CounterFlags(2, (FLAG)COL_Vault_State_2NodeUnlocked_e36176d7-6bc9-400b-8917-ff541858ee63);
DB_COL_Vault_CounterFlags(3, (FLAG)COL_Vault_State_3NodeUnlocked_d830ff7b-efcc-4389-be44-8f427d5c40da);
KBSECTION
//REGION Setup

IF
DB_COL_Vault_Nodes(_Item)
THEN
SetOnStage(_Item, 0);

IF
DB_COL_Vault_Neighbours((ITEM)_A, (ITEM)_B)
THEN
DB_COL_Vault_Neighbours(_B, _A);

IF
DB_COL_Vault_Neighbours_Direction((ITEM)_A,(ITEM)_B)
THEN
DB_COL_Vault_Neighbours(_A, _B);

PROC
PROC_COL_Vault_DefineNeighbourDirections()
THEN
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_001_1b1e8d22-d864-4315-9ca0-fe6ebd8c3909, (ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_002_e8d259c5-e35e-46a8-ba49-22134098be96, (ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_002_e8d259c5-e35e-46a8-ba49-22134098be96, (ITEM)S_COL_VaultPuzzle_3_008_8ac59cf1-e943-4c6d-98c7-c579f98ba4bb);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_003_05fed984-c1b3-4d36-8447-13773b9ee4ac, (ITEM)S_COL_VaultPuzzle_3_012_6c45fdbb-246d-493f-8eeb-cddb7c80e7d2);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_003_05fed984-c1b3-4d36-8447-13773b9ee4ac, (ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_003_05fed984-c1b3-4d36-8447-13773b9ee4ac, (ITEM)S_COL_VaultPuzzle_3_035_9a418aaa-7cd9-4643-ba92-bc020a5b8fe9);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_004_fbcf50f3-107d-414a-b34e-4597310f6b41, (ITEM)S_COL_VaultPuzzle_3_007_4d15cd66-85d1-4fd3-8e74-5a49a3492954);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_004_fbcf50f3-107d-414a-b34e-4597310f6b41, (ITEM)S_COL_VaultPuzzle_3_012_6c45fdbb-246d-493f-8eeb-cddb7c80e7d2);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_004_fbcf50f3-107d-414a-b34e-4597310f6b41, (ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_004_fbcf50f3-107d-414a-b34e-4597310f6b41, (ITEM)S_COL_VaultPuzzle_3_035_9a418aaa-7cd9-4643-ba92-bc020a5b8fe9);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_007_4d15cd66-85d1-4fd3-8e74-5a49a3492954, (ITEM)S_COL_VaultPuzzle_3_011_648279eb-2c62-40a0-9300-34e91f72ba5a);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_008_8ac59cf1-e943-4c6d-98c7-c579f98ba4bb, (ITEM)S_COL_VaultPuzzle_3_010_18ad4767-41bc-4626-8e74-0286a931c882);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_010_18ad4767-41bc-4626-8e74-0286a931c882, (ITEM)S_COL_VaultPuzzle_3_018_7813ea37-ab44-452c-829b-9958676c132c);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_010_18ad4767-41bc-4626-8e74-0286a931c882, (ITEM)S_COL_VaultPuzzle_3_019_ced78d50-108d-4a1e-9ef3-148227ae6659);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_011_648279eb-2c62-40a0-9300-34e91f72ba5a, (ITEM)S_COL_VaultPuzzle_3_019_ced78d50-108d-4a1e-9ef3-148227ae6659);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_011_648279eb-2c62-40a0-9300-34e91f72ba5a, (ITEM)S_COL_VaultPuzzle_3_032_20fc783d-137b-422f-906c-2856ae8057a4);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_012_6c45fdbb-246d-493f-8eeb-cddb7c80e7d2, (ITEM)S_COL_VaultPuzzle_3_019_ced78d50-108d-4a1e-9ef3-148227ae6659);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_012_6c45fdbb-246d-493f-8eeb-cddb7c80e7d2, (ITEM)S_COL_VaultPuzzle_3_033_8e2d7b54-7d3c-4a32-afcd-0aebf8021cc4);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_012_6c45fdbb-246d-493f-8eeb-cddb7c80e7d2, (ITEM)S_COL_VaultPuzzle_3_035_9a418aaa-7cd9-4643-ba92-bc020a5b8fe9);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_018_7813ea37-ab44-452c-829b-9958676c132c, (ITEM)S_COL_VaultPuzzle_3_020_ec12aa5f-c015-4e74-96b0-2d8fedfe1c32);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_018_7813ea37-ab44-452c-829b-9958676c132c, (ITEM)S_COL_VaultPuzzle_3_029_057893cc-7dc6-4115-ac1f-aae0912d8f0b);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_019_ced78d50-108d-4a1e-9ef3-148227ae6659, (ITEM)S_COL_VaultPuzzle_3_020_ec12aa5f-c015-4e74-96b0-2d8fedfe1c32);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_019_ced78d50-108d-4a1e-9ef3-148227ae6659, (ITEM)S_COL_VaultPuzzle_3_027_f0d51c10-d717-4fa1-b376-a9b5d0eb2197);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_019_ced78d50-108d-4a1e-9ef3-148227ae6659, (ITEM)S_COL_VaultPuzzle_3_030_e937168b-02fb-4e8b-bfba-a323ec54cdd5);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_020_ec12aa5f-c015-4e74-96b0-2d8fedfe1c32, (ITEM)S_COL_VaultPuzzle_3_033_8e2d7b54-7d3c-4a32-afcd-0aebf8021cc4);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4, (ITEM)S_COL_VaultPuzzle_3_007_4d15cd66-85d1-4fd3-8e74-5a49a3492954);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4, (ITEM)S_COL_VaultPuzzle_3_010_18ad4767-41bc-4626-8e74-0286a931c882);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4, (ITEM)S_COL_VaultPuzzle_3_011_648279eb-2c62-40a0-9300-34e91f72ba5a);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_026_c8408263-9ca4-4c61-938c-266765a232b4, (ITEM)S_COL_VaultPuzzle_3_035_9a418aaa-7cd9-4643-ba92-bc020a5b8fe9);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_027_f0d51c10-d717-4fa1-b376-a9b5d0eb2197, (ITEM)S_COL_VaultPuzzle_3_022_d23e6cef-9b8f-4149-b80b-ef0a339b9823);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_027_f0d51c10-d717-4fa1-b376-a9b5d0eb2197, (ITEM)S_COL_VaultPuzzle_3_025_ec80ce07-b6db-4d34-94c6-f699487552a4);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_027_f0d51c10-d717-4fa1-b376-a9b5d0eb2197, (ITEM)S_COL_VaultPuzzle_3_029_057893cc-7dc6-4115-ac1f-aae0912d8f0b);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_028_fcbcd5df-9644-457c-8e0c-ca492eb68e2d, (ITEM)S_COL_VaultPuzzle_3_024_34a63e20-b77c-4edc-a4db-5126f8291988);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_028_fcbcd5df-9644-457c-8e0c-ca492eb68e2d, (ITEM)S_COL_VaultPuzzle_3_029_057893cc-7dc6-4115-ac1f-aae0912d8f0b);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_029_057893cc-7dc6-4115-ac1f-aae0912d8f0b, (ITEM)S_COL_VaultPuzzle_3_025_ec80ce07-b6db-4d34-94c6-f699487552a4);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_030_e937168b-02fb-4e8b-bfba-a323ec54cdd5, (ITEM)S_COL_VaultPuzzle_3_023_5f85bfdb-7c3f-4626-b102-47ec5909ba55);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_032_20fc783d-137b-422f-906c-2856ae8057a4, (ITEM)S_COL_VaultPuzzle_3_028_fcbcd5df-9644-457c-8e0c-ca492eb68e2d);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_033_8e2d7b54-7d3c-4a32-afcd-0aebf8021cc4, (ITEM)S_COL_VaultPuzzle_3_027_f0d51c10-d717-4fa1-b376-a9b5d0eb2197);
DB_COL_Vault_Neighbours_Direction((ITEM)S_COL_VaultPuzzle_3_035_9a418aaa-7cd9-4643-ba92-bc020a5b8fe9, (ITEM)S_COL_VaultPuzzle_3_033_8e2d7b54-7d3c-4a32-afcd-0aebf8021cc4);

//END_REGION

//REGION Debug

IF
TextEvent("COL_Vault_TestOn")
THEN
PROC_COL_VaultPuzzle_OnStage(1);

IF
TextEvent("COL_Vault_TestOff")
THEN
PROC_COL_VaultPuzzle_OnStage(0);

IF
TextEvent("COL_Vault_TestOff")
AND
DB_COL_Vault_Neighbours(_A, _B)
AND
GUIDToString(_B, _GUID)
AND
Concatenate("COL_Vault_ConnectionTo_", _GUID, _Name)
THEN
PROC_StopLoopBeamEffect(_A, _Name);

IF
TextEvent("COL_Vault_AllConnections")
AND
DB_COL_Vault_NeighbourConnectionName(_A, _B, _)
THEN
PROC_COL_Vault_ShowConnection(_A, _B);

IF
TextEvent("COL_Vault_Off")
AND
DB_COL_Vault_Neighbours(_A, _B)
AND
GUIDToString(_B, _GUID)
AND
Concatenate("COL_Vault_PotentialConnectionTo_", _GUID, _Name)
THEN
PROC_StopLoopBeamEffect(_A, _Name);

IF
TextEvent("COL_Vault_AutoSolve")
AND
DB_COL_Vault_Connected(_Node, _OtherNode)
THEN
NOT DB_COL_Vault_Connected(_Node, _OtherNode);
NOT DB_COL_Vault_Connected(_OtherNode, _Node);

IF
TextEvent("COL_Vault_AutoSolve")
THEN
PROC_COL_Vault_RecalculateCharges();

IF
TextEvent("COL_Vault_AutoSolve")
AND
DB_InRegion(_, S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
THEN
DB_COL_Debug_AutoSolve_SolverReady(1);

IF
TextEvent("COL_Vault_AutoSolve")
AND
NOT DB_InRegion(_, S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
AND
GetHostCharacter(_Character)
THEN
TeleportTo(_Character, S_COL_Vault_PuzzleTrigger3_6cb3b28d-0f8d-4460-b103-f4a9d04d501d, "COL_Vault_AutoSolve", 1, 1, 1, 1, 1);

IF
EntityEvent(_Character, "COL_Vault_AutoSolve")
THEN
DB_COL_Debug_AutoSolve_SolverReady(1);
PROC_COL_Vault_StartSolve((CHARACTER)_Character);

IF
DB_InRegion(_Character, S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
AND
DB_COL_Debug_AutoSolve_SolverReady(1)
AND
DB_COL_Vault_Solution(_A, _B)
THEN
PROC_COL_Vault_EstablishConnection(_A, _B);

IF
DB_InRegion(_Character, S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
AND
DB_COL_Debug_AutoSolve_SolverReady(1)
THEN
NOT DB_COL_Debug_AutoSolve_SolverReady(1);

//END_REGION


//REGION Pre-create a list of potential connection names.
IF
DB_COL_Vault_Neighbours_Direction(_A, _B)
AND
NOT DB_COL_Vault_NeighbourConnectionName(_B, _A, _)
AND
GUIDToString(_B, _GUID)
AND
Concatenate("COL_Vault_ConnectionTo_", _GUID, _Name)
THEN
DB_COL_Vault_NeighbourConnectionName(_A, _B, _Name);

//END_REGION

//REGION Set puzzle on- or offstage.

PROC
PROC_COL_VaultPuzzle_OnStage(1)
AND
DB_COL_Vault_Nodes(_Item)
THEN
SetOnStage(_Item, 1);

PROC
PROC_COL_VaultPuzzle_OnStage(0)
AND
NOT DB_GlobalFlag((FLAG)COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
AND
DB_COL_Vault_Nodes(_Item)
THEN
SetOnStage(_Item, 0);

PROC
PROC_COL_VaultPuzzle_OnStage(1)
AND
DB_COL_Vault_NeighbourConnectionName(_A, _B, _)
THEN
PROC_COL_Vault_ShowConnection((ITEM)_A, (ITEM)_B);

PROC
PROC_COL_VaultPuzzle_OnStage(1)
AND
DB_COL_Vault_LockedNodes(_Node,_,_)
AND
NOT DB_COL_Vault_Charge(_Node,_)
AND
NOT DB_COL_Vault_Connected(_Node,_)
THEN
PROC_COL_Vault_ApplyVisualEffect(_Node,-1);

PROC
PROC_COL_VaultPuzzle_OnStage(1)
AND
DB_COL_Vault_LockedNodes(_Node,_,_)
AND
NOT DB_COL_Vault_Charge(_Node,_)
AND
DB_COL_Vault_Connected(_Node,_)
THEN
PROC_COL_Vault_ApplyVisualEffect(_Node,0);

IF
DB_InRegion(_Player, S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
AND
NOT DB_DialogName((DIALOGRESOURCE)COL_Vault_Puzzle_df526505-b938-8ac6-e127-5ec1dd9c5adf, _)
THEN
SetFlag(COL_Vault_State_BeingSolved_13bf708f-bc7c-45ff-bbc2-a44fd8fd438f, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_COL_VaultPuzzle_OnStage(1)
THEN
PROC_COL_Vault_RecalculateCharges();

PROC
PROC_COL_VaultPuzzle_OnStage(_)
AND
DB_COL_Vault_SelectedNode(_Node)
THEN
PROC_COL_Vault_UnselectNode(_Node);

IF
EnteredTrigger(_Character, (TRIGGER)S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
THEN
PROC_LoopBeamEffect(VFX_Script_SCL_BrainPuzzle_Untyped_Beam_01_5d83ff09-90a0-1743-67bd-edfe72068bff, S_COL_VaultPuzzle_3_001_1b1e8d22-d864-4315-9ca0-fe6ebd8c3909, _Character, "", "Dummy_HeadFX", "COL_Vault_SolverBrainLink", "SCL_Main_A");
PROC_LoopBeamEffect(VFX_Script_SCL_BrainPuzzle_Untyped_Beam_01_5d83ff09-90a0-1743-67bd-edfe72068bff, S_COL_VaultPuzzle_3_002_e8d259c5-e35e-46a8-ba49-22134098be96, _Character, "", "Dummy_HeadFX", "COL_Vault_SolverBrainLink", "SCL_Main_A");
PROC_LoopBeamEffect(VFX_Script_SCL_BrainPuzzle_Untyped_Beam_01_5d83ff09-90a0-1743-67bd-edfe72068bff, S_COL_VaultPuzzle_3_003_05fed984-c1b3-4d36-8447-13773b9ee4ac, _Character, "", "Dummy_HeadFX", "COL_Vault_SolverBrainLink", "SCL_Main_A");
PROC_LoopBeamEffect(VFX_Script_SCL_BrainPuzzle_Untyped_Beam_01_5d83ff09-90a0-1743-67bd-edfe72068bff, S_COL_VaultPuzzle_3_004_fbcf50f3-107d-414a-b34e-4597310f6b41, _Character, "", "Dummy_HeadFX", "COL_Vault_SolverBrainLink", "SCL_Main_A");

PROC
PROC_COL_VaultPuzzle_OnStage(1)
AND
DB_COL_Vault_LockedNodes(_Node, _, _)
THEN
PROC_LoopBeamEffect(VFX_Script_SCL_BrainPuzzle_Untyped_Beam_01_5d83ff09-90a0-1743-67bd-edfe72068bff, _Node, S_COL_VaultPuzzle_3_BrainCentreHelper_80814814-6735-4228-a9e2-cfaa35dbf08a, "", "", "COL_Vault_PodConnection", "SCL_Main_A");

PROC
PROC_COL_VaultPuzzle_OnStage(1)
THEN
PROC_LoopBeamEffect(VFX_Script_SCL_BrainPuzzle_Untyped_Beam_01_5d83ff09-90a0-1743-67bd-edfe72068bff, S_COL_Vault_DoorTarget_Point_17f25ba8-65e7-4c87-9522-cffe877b77cc, S_COL_VaultPuzzle_3_BrainCentreHelper_80814814-6735-4228-a9e2-cfaa35dbf08a, "", "", "COL_Vault_PodConnection", "SCL_Main_A");

PROC
PROC_COL_VaultPuzzle_OnStage(0)
AND
NOT DB_GlobalFlag((FLAG)COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
AND
DB_COL_Vault_NeighbourConnectionName(_A, _B, _Name)
THEN
PROC_StopLoopBeamEffect(_A, _Name);

PROC
PROC_COL_VaultPuzzle_OnStage(0)
AND
DB_COL_Vault_SourceNodes(_Node, _)
THEN
PROC_StopLoopBeamEffect(_Node, "COL_Vault_SolverBrainLink");

PROC
PROC_COL_VaultPuzzle_OnStage(0)
AND
NOT DB_GlobalFlag((FLAG)COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
THEN
PROC_StopLoopBeamEffect(S_COL_Vault_DoorTarget_Point_17f25ba8-65e7-4c87-9522-cffe877b77cc, "COL_Vault_PodConnection");

PROC
PROC_COL_VaultPuzzle_OnStage(0)
AND
NOT DB_GlobalFlag((FLAG)COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
AND
DB_COL_Vault_LockedNodes(_Node, _, _)
THEN
PROC_StopLoopBeamEffect(_Node, "COL_Vault_PodConnection");

PROC
PROC_COL_VaultPuzzle_OnStage(0)
THEN
ClearFlag(COL_Vault_State_BeingSolved_13bf708f-bc7c-45ff-bbc2-a44fd8fd438f, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_COL_Vault_StartSolve((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
THEN
PROC_COL_VaultPuzzle_OnStage(1);
TriggerRegisterForCharacter(S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c, _Player);
PROC_LoopEffect(VFX_Script_SCL_BrainPuzzle_AreaMarker_01_a002e6f2-c441-b2ba-7466-1470ccd2bb31,S_COL_Vault_PuzzleTrigger3_6cb3b28d-0f8d-4460-b103-f4a9d04d501d,"COL_Vault_AreaMarker","SCL_Main_A","");
SetTag(_Player, (TAG)COL_VAULT_SOLVING_50d2cab2-7636-43c7-be04-a76ee83829a4);

PROC
PROC_COL_Vault_StopSolve((CHARACTER)_Player)
THEN
PROC_COL_VaultPuzzle_OnStage(0);
TriggerUnregisterForCharacter(S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c, _Player);
PROC_StopLoopEffect(S_COL_Vault_PuzzleTrigger3_6cb3b28d-0f8d-4460-b103-f4a9d04d501d,"COL_Vault_AreaMarker");
ClearTag(_Player, (TAG)COL_VAULT_SOLVING_50d2cab2-7636-43c7-be04-a76ee83829a4);

//END_REGION

//REGION Puzzle - Creating connections

IF
UseFinished(_, _Node, 1)
AND
DB_COL_Vault_Nodes(_Node)
THEN
NOT DB_COL_Vault_NodeUseProcessed(1);

IF
UseFinished(_, _Node, 1)
AND
DB_COL_Vault_Nodes(_Node)
AND
DB_COL_Vault_SelectedNode(_Node)
THEN
PROC_COL_Vault_UnselectNode(_Node);
DB_COL_Vault_NodeUseProcessed(1);

IF
UseFinished(_, _Node, 1)
AND
DB_COL_Vault_Nodes(_Node)
AND
NOT DB_COL_Vault_NodeUseProcessed(1)
AND
NOT DB_COL_Vault_SelectedNode(_)
THEN
PROC_COL_Vault_SelectNode(_Node);
DB_COL_Vault_NodeUseProcessed(1);

IF
UseFinished(_, _Node, 1)
AND
DB_COL_Vault_Nodes(_Node)
AND
NOT DB_COL_Vault_NodeUseProcessed(1)
AND
DB_COL_Vault_SelectedNode(_OtherNode)
AND
_OtherNode != _Node
THEN
DB_COL_Vault_NodeUseProcessed(1);
PROC_COL_Vault_UnselectNode(_OtherNode);
PROC_COL_Vault_SelectNode(_Node);
PROC_COL_Vault_TryFlipConnection(_OtherNode, _Node);

PROC
PROC_COL_Vault_UnselectNode((ITEM)_Node)
THEN
NOT DB_COL_Vault_SelectedNode(_Node);
PROC_StopLoopEffect(_Node, "COL_Vault_Selected");

PROC
PROC_COL_Vault_UnselectNode((ITEM)_Node)
AND
DB_COL_Vault_Neighbours(_Node, _Neighbour)
THEN
PROC_StopLoopEffect(_Neighbour, "COL_Vault_Option");

PROC
PROC_COL_Vault_SelectNode((ITEM)_Node)
THEN
DB_COL_Vault_SelectedNode(_Node);
PROC_LoopEffect((EFFECTRESOURCE)VFX_Script_SCL_BrainPuzzle_Selected_01_1f751d19-57c5-233a-392f-8ce51b2144e3, _Node, "COL_Vault_Selected", "SCL_Main_A", "");

PROC
PROC_COL_Vault_SelectNode((ITEM)_Node)
AND
DB_COL_Vault_Neighbours(_Node, _Neighbour)
THEN
PROC_LoopEffect(VFX_Script_SCL_BrainPuzzle_PotentialConnection_01_ab1ca3db-4dd0-1c81-18cf-28a5d77ab4bf, _Neighbour, "COL_Vault_Option", "SCL_Main_A", "");

PROC
PROC_COL_Vault_TryFlipConnection((ITEM)_Destination, (ITEM)_Source)
AND
DB_COL_Vault_Neighbours(_Destination, _Source)
THEN
PROC_COL_Vault_FlipConnection((ITEM)_Destination, (ITEM)_Source);

PROC
PROC_COL_Vault_FlipConnection((ITEM)_Destination, (ITEM)_Source)
AND
NOT QRY_COL_Vault_SeverConnection(_Destination, _Source)
AND
NOT QRY_COL_Vault_BlockConnection(_Destination, _Source)
THEN
PROC_COL_Vault_EstablishConnection(_Destination, _Source);

PROC
PROC_COL_Vault_EstablishConnection((ITEM)_Destination, (ITEM)_Source)
THEN
DB_COL_Vault_Connected(_Destination, _Source);
DB_COL_Vault_Connected(_Source, _Destination);
DB_COL_Vault_ChangedNodes(_Source); //Force beam recalculation -- Necessary if e.g. both are already charged - charges don't change but the beam needs to.
DB_COL_Vault_ChangedNodes(_Destination);
PROC_COL_Vault_RecalculateCharges();

PROC
PROC_COL_Vault_EstablishConnection((ITEM)_Destination, (ITEM)_Source)
AND
NOT QRY_COL_Vault_IsUnlockingConnection(_Destination, _Source)
THEN
PROC_COL_Vault_SelectNode(_Source);

QRY
QRY_COL_Vault_SeverConnection((ITEM)_Destination, (ITEM)_Source)
AND
DB_COL_Vault_Connected(_Destination, _Source)
THEN
PROC_COL_Vault_SelectNode(_Source);
PROC_COL_Vault_SeverConnection(_Destination, _Source);

PROC
PROC_COL_Vault_SeverConnection((ITEM)_Destination, (ITEM)_Source)
THEN
NOT DB_COL_Vault_Connected(_Destination, _Source);
NOT DB_COL_Vault_Connected(_Source, _Destination);
DB_COL_Vault_ChangedNodes(_Source); //Force beam recalculation -- Necessary if e.g. both are already charged - charges don't change but the beam needs to.
DB_COL_Vault_ChangedNodes(_Destination);
PROC_COL_Vault_RecalculateCharges();

PROC
PROC_COL_Vault_SeverConnection(_Node, _)
AND
NOT QRY_COL_Vault_AnyConnectionInPuzzle()
THEN
ClearFlag((FLAG)COL_Vault_State_HasConnections_fb090a27-1597-4937-9ca7-9fa6c89a2516, S_COL_Vault_PuzzleButton3_0f07d5be-159d-48f4-94c4-4c9ee0234423, 0);

QRY
QRY_COL_Vault_AnyConnectionInPuzzle()
AND
DB_COL_Vault_Connected(_Node, _)
THEN
DB_NOOP(1);

IF
DB_COL_Vault_Connected(_Node, _)
THEN
SetFlag((FLAG)COL_Vault_State_HasConnections_fb090a27-1597-4937-9ca7-9fa6c89a2516, S_COL_Vault_PuzzleButton3_0f07d5be-159d-48f4-94c4-4c9ee0234423, 0);

QRY
QRY_COL_Vault_BlockConnection((ITEM)_Destination, (ITEM)_Source)
AND
DB_COL_Vault_Charge(_Destination, _Charge)
AND
DB_COL_Vault_Charge(_Source, _OtherCharge)
AND
_Charge != _OtherCharge
THEN
PROC_COL_Vault_ConnectionError();

PROC
PROC_COL_Vault_ConnectionError()
AND
DB_InRegion(_Character, S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
THEN
ShowError(_Character, "InvalidTarget");

PROC
PROC_COL_Vault_ShowConnection((ITEM)_A, (ITEM)_B)
AND
DB_COL_Vault_NeighbourConnectionName(_A, _B, _Name)
THEN
PROC_COL_Vault_ShowConnectionBeam(_A, _B, _Name);

PROC
PROC_COL_Vault_ShowConnection((ITEM)_B, (ITEM)_A)
AND
DB_COL_Vault_NeighbourConnectionName(_A, _B, _Name)
THEN
PROC_COL_Vault_ShowConnectionBeam(_A, _B, _Name);

PROC
PROC_COL_Vault_ShowConnectionBeam((ITEM)_A, (ITEM)_B, (STRING)_Name)
THEN
PROC_StopLoopBeamEffect(_A, _Name);

//Show uncharged beam (default)
PROC
PROC_COL_Vault_ShowConnectionBeam((ITEM)_A, (ITEM)_B, (STRING)_Name)
AND
NOT DB_COL_Vault_Connected(_A, _B)
AND
DB_COL_Vault_Beam_ChargeVFX(-1,_VFX)
THEN
PROC_LoopBeamEffect(_VFX, _A, _B, "", "", _Name, "SCL_Main_A");

//Show charged beam connected to a brain part
PROC
PROC_COL_Vault_ShowConnectionBeam((ITEM)_A, (ITEM)_B, (STRING)_Name)
AND
DB_COL_Vault_Connected(_A, _B)
AND
DB_COL_Vault_Charge(_A,_Charge)
AND
DB_COL_Vault_Beam_ChargeVFX(_Charge,_VFX)
THEN
PROC_LoopBeamEffect(_VFX, _A, _B, "", "", _Name, "SCL_Main_A");

//Show charged beam not connected to a brain part
PROC
PROC_COL_Vault_ShowConnectionBeam((ITEM)_A, (ITEM)_B, (STRING)_Name)
AND
DB_COL_Vault_Connected(_A, _B)
AND
NOT DB_COL_Vault_Charge(_A,_)
AND
DB_COL_Vault_Beam_ChargeVFX(0,_VFX)
THEN
PROC_LoopBeamEffect(_VFX, _A, _B, "", "", _Name, "SCL_Main_A");

//END_REGION

//REGION Puzzle - Calculate charges

PROC
PROC_COL_Vault_RecalculateCharges()
THEN
NOT DB_COL_Vault_StructureChanged(1);

PROC
PROC_COL_Vault_RecalculateCharges()
AND
DB_COL_Vault_Charge(_Node, _Charge)
THEN
NOT DB_COL_Vault_Charge(_Node, _Charge);

PROC
PROC_COL_Vault_RecalculateCharges()
AND
DB_COL_Vault_UnlockedNodes(_Node)
THEN
NOT DB_COL_Vault_UnlockedNodes(_Node);

/* 1. Re-lock all locked nodes.
   2. Propagate all charges (not through to locked nodes)
   3. Evaluate connection conflicts. Sever connections.
	  NOTE: Sever connection immediately.
   4. If any connection conflicts ran: take it from the top, until no conflicts.
   5. If, after this there are any unlocked nodes, go to 6.
   6. Evaluate again.
*/

PROC
PROC_COL_Vault_RecalculateCharges()
THEN
DB_COL_Vault_RecalculatingCharges(1);

//Start from the sources.
PROC
PROC_COL_Vault_RecalculateCharges()
AND
DB_COL_Vault_SourceNodes(_Node, _Charge)
THEN
DB_COL_Vault_Charge(_Node, _Charge);

IF
DB_COL_Vault_Charge(_Node, _Charge)
AND
DB_COL_Vault_Connected(_Node, _OtherNode)
AND
NOT DB_COL_Vault_Charge(_OtherNode, _Charge)
AND
DB_COL_Vault_RecalculatingCharges(1)
AND
NOT QRY_COL_Vault_DoubleChargeConnection(_Node, _OtherNode)
THEN
DB_COL_Vault_Charge(_OtherNode, _Charge);

IF
DB_COL_Vault_LockedNodes(_Node, _Charge, _)
AND
DB_COL_Vault_Charge(_Node, _Charge)
THEN
DB_COL_Vault_UnlockedNodes(_Node);

IF
DB_COL_Vault_LockedNodes(_Node, _Charge, _)
AND
DB_COL_Vault_UnlockedNodes(_Node)
AND
NOT DB_COL_Vault_Charge(_Node, _Charge)
THEN
NOT DB_COL_Vault_UnlockedNodes(_Node);

PROC
PROC_COL_Vault_UnlockNodes()
AND
DB_COL_Vault_NewUnlockedNodes(1)
THEN
NOT DB_COL_Vault_NewUnlockedNodes(1);

PROC
PROC_COL_Vault_UnlockNodes()
AND
DB_COL_Vault_NewUnlockedNodes(1)
AND
NOT DB_COL_Vault_StructureChanged(1)
THEN
NOT DB_COL_Vault_NewUnlockedNodes(1);
PROC_COL_Vault_UnlockNodes();

PROC
PROC_COL_Vault_RecalculateCharges()
AND
DB_COL_Vault_RecalculatingCharges(1)
THEN
NOT DB_COL_Vault_RecalculatingCharges(1);

/*If, during the calculation, any connections had to be severed, we need to recalculate.
This may lead to a failure cascade if one of the severed connections was necessary to keep a locked node unlocked.
Otherwise, we can update visuals.*/
PROC
PROC_COL_Vault_RecalculateCharges()
AND
NOT DB_COL_Vault_StructureChanged(1)
THEN
PROC_COL_Vault_CheckPuzzleSolved();
PROC_COL_Vault_MatchVisualsToCharges();

PROC
PROC_COL_Vault_RecalculateCharges()
AND
DB_COL_Vault_StructureChanged(1)
THEN
PROC_COL_Vault_RecalculateCharges();

QRY
QRY_COL_Vault_DoubleChargeConnection((ITEM)_Node, (ITEM)_OtherNode)
AND
NOT QRY_COL_Vault_IsUnlockingConnection((ITEM)_Node, (ITEM)_OtherNode)
AND
DB_COL_Vault_Charge(_Node, _Charge)
AND
DB_COL_Vault_Charge(_OtherNode, _OtherCharge)
AND
_Charge != _OtherCharge
THEN
PROC_COL_Vault_SeverConnection((ITEM)_OtherNode, (ITEM)_Node);
DB_COL_Vault_StructureChanged(1);

//END_REGION

//REGION Locked nodes

QRY
QRY_COL_Vault_IsUnlockingConnection((ITEM)_Node, (ITEM)_OtherNode)
AND
DB_COL_Vault_LockedNodes(_Node, _Charge, _)
AND
DB_COL_Vault_Charge(_OtherNode, _Charge)
THEN
DB_NOOP(1);

QRY
QRY_COL_Vault_IsUnlockingConnection((ITEM)_Node, (ITEM)_OtherNode)
AND
DB_COL_Vault_LockedNodes(_OtherNode, _Charge, _)
AND
DB_COL_Vault_Charge(_Node, _Charge)
THEN
DB_NOOP(1);

IF
DB_COL_Vault_UnlockedNodes((ITEM)_Node)
AND
DB_COL_Vault_LockedNodes(_Node, _, _)
THEN
PROC_StopLoopEffect(_Node, "COL_Vault_LockedVFX");

IF
DB_COL_Vault_LockedNodes(_Node, _Charge, _)
AND
NOT DB_COL_Vault_UnlockedNodes(_Node)
THEN
PROC_LoopEffect(VFX_Script_SCL_BrainPuzzle_Default_Brain_Deactivated_01_e254c4d2-1f4b-6ac9-72c5-12506195e5b1, _Node, "COL_Vault_LockedVFX", "SCL_Main_A", "");

PROC
PROC_COL_Vault_CheckPuzzleSolved()
AND
DB_GlobalFlag(COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
AND
QRY_COL_Vault_PuzzleUnsolved()
THEN
ClearFlag(COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072);
ClearFlag(COL_Vault_State_Open_c78a0329-2ff1-8a4f-7130-04f4425a3dab);
PROC_TriggerUnregisterForPlayers(S_COL_Vault_GrandDesign_Interaction_Trigger_491fc660-d74c-40bb-a547-6efab19a4eee);

PROC
PROC_COL_Vault_CheckPuzzleSolved()
AND
NOT DB_GlobalFlag(COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
AND
NOT QRY_COL_Vault_PuzzleUnsolved()
THEN
SetFlag(COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072);
SetFlag(COL_Vault_State_Open_c78a0329-2ff1-8a4f-7130-04f4425a3dab);
PROC_TriggerRegisterForPlayers(S_COL_Vault_GrandDesign_Interaction_Trigger_491fc660-d74c-40bb-a547-6efab19a4eee);
PROC_ItemUnlockAndOpen(S_COL_Vault_Door_79a34731-3a47-4a1a-83ef-d6ccb46e9590);
SetCanInteract(S_COL_Vault_Door_79a34731-3a47-4a1a-83ef-d6ccb46e9590,0);
PROC_StopLoopBeamEffect(S_COL_Vault_DoorTarget_Point_17f25ba8-65e7-4c87-9522-cffe877b77cc,"COL_Vault_PodConnection");

IF
DB_GlobalFlag(COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
AND
DB_InRegion(_Player, (TRIGGER)S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
AND
QRY_OnlyOnce("COL_Vault_PAD_PuzzleSolved")
AND
DB_Players(_Player)
THEN
PROC_TryStartAD(COL_Vault_PAD_PuzzleSolved_3faa2628-8e89-9b49-5527-b394b08f440b,_Player);

IF
DB_GlobalFlag(COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
AND
DB_InRegion(_Player, (TRIGGER)S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
THEN
PROC_COL_Vault_StopSolve(_Player);

QRY
QRY_COL_Vault_PuzzleUnsolved()
AND
DB_COL_Vault_LockedNodes(_Node, _Charge, _)
AND
NOT DB_COL_Vault_UnlockedNodes(_Node)
THEN
DB_NOOP(1);

//END_REGION

//REGION VFX application.

PROC
PROC_COL_Vault_SetChargeVisual((ITEM)_Node,(INTEGER)_)
AND
DB_COL_Vault_Charge_Visual(_Node,_OldCharge)
THEN
NOT DB_COL_Vault_Charge_Visual(_Node,_OldCharge);
PROC_StopLoopEffect(_Node, "COL_Vault_Node_Charge");
DB_COL_Vault_ChangedNodes(_Node);

PROC
PROC_COL_Vault_SetChargeVisual((ITEM)_Node,(INTEGER)_Charge)
THEN
DB_COL_Vault_Charge_Visual((ITEM)_Node,_Charge);
PROC_COL_Vault_ApplyVisualEffect(_Node,_Charge);

//Default nodes - unconnected
PROC
PROC_COL_Vault_MatchVisualsToCharges()
AND
DB_COL_Vault_Nodes(_Node)
AND
NOT DB_COL_Vault_Charge(_Node,_)
AND
NOT DB_COL_Vault_Connected(_Node,_)
AND
NOT DB_COL_Vault_Charge_Visual(_Node,-1)
THEN
PROC_COL_Vault_SetChargeVisual((ITEM)_Node,-1);

//Default nodes - connected
PROC
PROC_COL_Vault_MatchVisualsToCharges()
AND
DB_COL_Vault_Nodes(_Node)
AND
NOT DB_COL_Vault_Charge(_Node,_)
AND
DB_COL_Vault_Connected(_Node,_)
AND
NOT DB_COL_Vault_Charge_Visual(_Node,0)
THEN
PROC_COL_Vault_SetChargeVisual((ITEM)_Node,0);

//Charged nodes
PROC
PROC_COL_Vault_MatchVisualsToCharges()
AND
DB_COL_Vault_Charge(_Node, _Charge)
AND
NOT DB_COL_Vault_Charge_Visual(_Node, _Charge)
THEN
PROC_COL_Vault_SetChargeVisual((ITEM)_Node,_Charge);

//Process beam visuals
PROC
PROC_COL_Vault_MatchVisualsToCharges()
AND
DB_COL_Vault_ChangedNodes(_A)
AND
DB_COL_Vault_NeighbourConnectionName(_A, _B, _Name)
AND
NOT DB_COL_Vault_ProcessedBeams(_A,_B)
THEN
DB_COL_Vault_ProcessedBeams(_A,_B);
PROC_COL_Vault_ShowConnectionBeam(_A,_B,_Name);

PROC
PROC_COL_Vault_MatchVisualsToCharges()
AND
DB_COL_Vault_ChangedNodes(_B)
AND
DB_COL_Vault_NeighbourConnectionName(_A, _B, _Name)
AND
NOT DB_COL_Vault_ProcessedBeams(_A,_B)
THEN
DB_COL_Vault_ProcessedBeams(_A,_B);
PROC_COL_Vault_ShowConnectionBeam(_A,_B,_Name);

/*IF
DB_COL_Vault_ChangedNodes(_Node)
THEN
DebugText(_Node,"Changed");*/

PROC
PROC_COL_Vault_MatchVisualsToCharges()
AND
DB_COL_Vault_ChangedNodes(_Node)
THEN
NOT DB_COL_Vault_ChangedNodes(_Node);

PROC
PROC_COL_Vault_MatchVisualsToCharges()
AND
DB_COL_Vault_ProcessedBeams(_A,_B)
THEN
NOT DB_COL_Vault_ProcessedBeams(_A,_B);

//Normal nodes
PROC
PROC_COL_Vault_ApplyVisualEffect((ITEM)_Node,(INTEGER)_Charge)
AND
NOT DB_COL_Vault_SourceNodes(_Node,_)
AND
NOT DB_COL_Vault_LockedNodes(_Node,_,_)
AND
DB_COL_Vault_Node_ChargeVFX(_Charge, _VFX, _Root)
THEN
PROC_COL_Vault_ApplyNodeTransform(_Node,_Root);
PROC_LoopEffect(_VFX, _Node, "COL_Vault_Node_Charge", "SCL_Main_A", "");

PROC
PROC_COL_Vault_ApplyNodeTransform((ITEM)_Node,(ROOT)_Root)
AND
_Root != NULL_00000000-0000-0000-0000-000000000000
THEN
Transform(_Node,_Root,(SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

PROC
PROC_COL_Vault_ApplyNodeTransform((ITEM)_Node,(ROOT)NULL_00000000-0000-0000-0000-000000000000)
THEN
RemoveTransforms(_Node);

//Brain nodes
PROC
PROC_COL_Vault_ApplyVisualEffect((ITEM)_Node,(INTEGER)_Charge)
AND
DB_COL_Vault_SourceNodes(_Node,_)
AND
DB_COL_Vault_Brain_ChargeVFX(_Charge, _VFX)
THEN
PROC_LoopEffect(_VFX, _Node, "COL_Vault_Node_Charge", "SCL_Main_A", "");

PROC
PROC_COL_Vault_ApplyVisualEffect((ITEM)_Node,(INTEGER)_Charge)
AND
DB_COL_Vault_LockedNodes(_Node,_,_)
AND
DB_COL_Vault_Brain_ChargeVFX(_Charge, _VFX)
THEN
PROC_LoopEffect(_VFX, _Node, "COL_Vault_Node_Charge", "SCL_Main_A", "");

//END_REGION

//REGION End brain parts reject wrong charge

PROC
PROC_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_,(INTEGER)_,(INTEGER)_)
AND
DB_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_TimerName)
THEN
NOT DB_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_TimerName);

PROC
PROC_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_TimerName,(INTEGER)_TimerDuration,(INTEGER)_)
AND
_TimerName != ""
THEN
DB_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_TimerName);
RealtimeObjectTimerLaunch(_Node,_TimerName,_TimerDuration);

PROC
PROC_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_,(INTEGER)_,1)
THEN
PlayEffect(_Node,VFX_Cinematic_Sparks_Burst_01_bccd5b9b-f84e-8162-0c50-ee63dbb58405,"",1.0);
PlaySoundResource(_Node,Spell_Projectile_Damage_Lightning_ChromaticOrbLightning_L1to3_48184440-6a4a-9565-c96b-43598c02610a);

//Start wrong charge sequence
IF
DB_COL_Vault_Charge_Visual(_Node,_Charge)
AND
DB_COL_Vault_LockedNodes(_Node,_DesiredCharge,_)
AND
_Charge != _DesiredCharge
AND
_Charge > 0
THEN
PROC_COL_Vault_LockedNodeWrongCharge(_Node,"COL_Vault_WrongCharge_Spark1",1000,0);

IF
ObjectTimerFinished(_Node,"COL_Vault_WrongCharge_Spark1")
THEN
PROC_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,"COL_Vault_WrongCharge_Spark2",4000,1);

IF
ObjectTimerFinished(_Node,"COL_Vault_WrongCharge_Spark2")
THEN
PROC_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,"COL_Vault_WrongCharge_Sever",4000,1);

IF
ObjectTimerFinished(_Node,"COL_Vault_WrongCharge_Sever")
THEN
PROC_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,"",0,1); //only spark

IF
ObjectTimerFinished(_Node,"COL_Vault_WrongCharge_Sever")
AND
DB_COL_Vault_Connected((ITEM)_Node,(ITEM)_OtherNode)
THEN
PlayEffect(_Node,VFX_Cinematic_Sparks_Burst_01_bccd5b9b-f84e-8162-0c50-ee63dbb58405,"",1.0);
PROC_COL_Vault_SeverConnection((ITEM)_Node,(ITEM)_OtherNode);

//End wrong charge sequence if the charge was changed for the better
IF
DB_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_TimerName)
AND
DB_COL_Vault_Charge_Visual(_Node,_Charge)
AND
DB_COL_Vault_LockedNodes(_Node,_DesiredCharge,_)
AND
_Charge < 1
THEN
NOT DB_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_TimerName);
ObjectTimerCancel(_Node,_TimerName);

IF
DB_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_TimerName)
AND
DB_COL_Vault_Charge_Visual(_Node,_DesiredCharge)
AND
DB_COL_Vault_LockedNodes(_Node,_DesiredCharge,_)
THEN
NOT DB_COL_Vault_LockedNodeWrongCharge((ITEM)_Node,(STRING)_TimerName);
ObjectTimerCancel(_Node,_TimerName);

//END_REGION

//REGION Start Solving

IF
DialogStarted(COL_Vault_Puzzle_df526505-b938-8ac6-e127-5ec1dd9c5adf, _ID)
AND
NOT DB_GlobalFlag((FLAG)COL_Vault_State_Unlocked_d712a88e-1946-4f9d-8096-697254963072)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
IsTagged(_Player,(TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed,1)
AND
IsTagged(_Player,(TAG)COL_VAULT_SOLVING_50d2cab2-7636-43c7-be04-a76ee83829a4,0)
THEN
PROC_CharacterMoveTo((CHARACTER)_Player, S_COL_Vault_PuzzleTrigger3_6cb3b28d-0f8d-4460-b103-f4a9d04d501d, "Walk", "");
PROC_COL_VaultPuzzle_OnStage(1);

IF
DialogEnded(COL_Vault_Puzzle_df526505-b938-8ac6-e127-5ec1dd9c5adf, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
DB_InRegion((CHARACTER)_Player,S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c) //is solving player
AND
GetFlag(COL_Vault_Event_Start_d29a54ae-0371-f0b9-483b-c3e67d754a81, _Player, 0)
AND
IsTagged(_Player,(TAG)COL_VAULT_SOLVING_50d2cab2-7636-43c7-be04-a76ee83829a4,0)
THEN
PROC_COL_Vault_StopSolve((CHARACTER)_Player);

IF
DialogEnded(COL_Vault_Puzzle_df526505-b938-8ac6-e127-5ec1dd9c5adf, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
NOT DB_InRegion(_,S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c) //no solving player in trigger
AND
GetFlag(COL_Vault_Event_Start_d29a54ae-0371-f0b9-483b-c3e67d754a81, _Player, 0)
AND
IsTagged(_Player,(TAG)COL_VAULT_SOLVING_50d2cab2-7636-43c7-be04-a76ee83829a4,0)
THEN
PROC_COL_Vault_StopSolve((CHARACTER)_Player);

IF
DialogEnded(COL_Vault_Puzzle_df526505-b938-8ac6-e127-5ec1dd9c5adf, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
GetFlag(COL_Vault_Event_Start_d29a54ae-0371-f0b9-483b-c3e67d754a81, _Player, 1)
THEN
PROC_COL_Vault_StartSolve((CHARACTER)_Player);
ClearFlag(COL_Vault_Event_Start_d29a54ae-0371-f0b9-483b-c3e67d754a81,_Player,0);
TeleportTo(_Player, S_COL_Vault_PuzzleTrigger3_6cb3b28d-0f8d-4460-b103-f4a9d04d501d, "", 1, 1, 1, 1, 1);

//Dialogue is all-psychic, so we can ignore the Silenced status, but not other statuses as
//those may have cinematic consequences (e.g. wildshape).
//Ignore Silenced specifically because it's an aura (see also above, where we drop the puzzle if
//the player is muted for non-Silenced reasons while solving the puzzle).
QRY
QRY_DropMutingStatusses(COL_Vault_Puzzle_df526505-b938-8ac6-e127-5ec1dd9c5adf, _Player)
AND
DB_Players((CHARACTER)_Player)
AND
NOT QRY_COL_HasNonSilencedMutingStatus(_Player)
THEN
DB_NOOP(1);

QRY
QRY_COL_HasNonSilencedMutingStatus((CHARACTER)_Player)
AND
DB_CurrentMutingStatuses(_Player, _Status, _)
AND
_Status != "SILENCED"
THEN
DB_NOOP(1);

IF
LeftTrigger(_Player, (TRIGGER)S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
THEN
PROC_COL_Vault_StopSolve(_Player);

//END_REGION

//REGION Reset puzzle

IF
FlagSet((FLAG)COL_Vault_Event_Restart_36ca57d8-ef95-c547-b014-590345dc5d95,_,_)
AND
DB_InRegion(_Player, S_COL_Vault_PuzzleBox3_caf88561-fad9-41b6-8963-4c612578695c)
THEN
DB_COL_Vault_Solving((CHARACTER)_Player);
PROC_COL_Vault_StopSolve(_Player);

IF
FlagSet((FLAG)COL_Vault_Event_Restart_36ca57d8-ef95-c547-b014-590345dc5d95,_,_)
AND
DB_COL_Vault_Connected(_Node, _OtherNode)
THEN
NOT DB_COL_Vault_Connected(_Node, _OtherNode);
NOT DB_COL_Vault_Connected(_OtherNode, _Node);

IF
FlagSet((FLAG)COL_Vault_Event_Restart_36ca57d8-ef95-c547-b014-590345dc5d95,_,_)
AND
DB_COL_Vault_Charge(_Node,_Charge)
THEN
NOT DB_COL_Vault_Charge(_Node,_Charge);

IF
FlagSet((FLAG)COL_Vault_Event_Restart_36ca57d8-ef95-c547-b014-590345dc5d95,_,_)
AND
DB_COL_Vault_Charge_Visual(_Node,_Charge)
THEN
NOT DB_COL_Vault_Charge_Visual(_Node,_Charge);
PROC_StopLoopEffect(_Node, "COL_Vault_Node_Charge");

IF
FlagSet((FLAG)COL_Vault_Event_Restart_36ca57d8-ef95-c547-b014-590345dc5d95,_,_)
THEN
TimerLaunch("COL_VaultPuzzle_Restart",600);
ClearFlag((FLAG)COL_Vault_Event_Restart_36ca57d8-ef95-c547-b014-590345dc5d95, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
TimerFinished("COL_VaultPuzzle_Restart")
AND
DB_COL_Vault_Solving(_Player)
THEN
PROC_COL_Vault_StartSolve(_Player);
NOT DB_COL_Vault_Solving(_Player);

//END_REGION

//REGION ADs

IF
DB_COL_Vault_LockedNodes(_Node, _, _Flag)
AND
DB_COL_Vault_UnlockedNodes(_Node)
THEN
SetFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_IncreaseCounter("COL_Vault_UnlockedNodes");

IF
DB_COL_Vault_LockedNodes(_Node, _, _Flag)
AND
NOT DB_COL_Vault_UnlockedNodes(_Node)
AND
DB_GlobalFlag(_Flag)
THEN
ClearFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_DecreaseCounter("COL_Vault_UnlockedNodes");

IF
DB_GlobalCounter("COL_Vault_UnlockedNodes", _Num)
AND
DB_GlobalFlag(_Flag)
AND
DB_COL_Vault_CounterFlags(_OtherNum, _Flag)
AND
_Num != _OtherNum
THEN
ClearFlag(_Flag);

IF
DB_GlobalCounter("COL_Vault_UnlockedNodes", _Num)
AND
DB_COL_Vault_CounterFlags(_Num, _Flag)
AND
NOT DB_GlobalFlag(_Flag)
THEN
SetFlag(_Flag);

//Every few connection changes, the vault mind, if there's enough of a mind to form even
//rudimentary thoughts, expresses them in an AD.
//The ADS are randomly distributed, with none sequential and playing close together being
//very unlikely.
PROC
PROC_COL_Vault_EstablishConnection(_, _Source)
THEN
PROC_COL_Vault_TryConnectionAD(_Source);

PROC
PROC_COL_Vault_SeverConnection(_, _Source)
THEN
PROC_COL_Vault_TryConnectionAD(_Source);

PROC
PROC_COL_Vault_TryConnectionAD((ITEM)_Source)
AND
QRY_COL_Vault_CanSpeak()
AND
QRY_IncreaseCounter("COL_Vault_ConnectionsSinceLastAD")
AND
DB_GlobalCounter("COL_Vault_ConnectionsSinceLastAD", _Count)
AND
_Count >= 2
AND
IntegerSubtract(6, _Count, _Diff)
AND
IntegerMax(_Diff, 1, _MinCount)
AND
IntegerProduct(_MinCount, _MinCount, _Squared)
AND
Random(_Squared, 0)
THEN
PROC_COL_Vault_ConnectionAD(_Source);

PROC
PROC_COL_Vault_ConnectionAD((ITEM)_Source)
THEN
PROC_DeclareCounter("COL_Vault_ConnectionsSinceLastAD");

//When doing an AD, reset the counter and put a helper some 1.5-3 metres away from
//where the player clicked (should be somewhere in mid-air but close enough to the player's
//point of attention to see).
PROC
PROC_COL_Vault_ConnectionAD((ITEM)_Source)
AND
Random(15, _Xr)
AND
Random(15, _Zr)
AND
Random(10, _Yi)
AND
IntegerSum(15, _Xr, _Xi)
AND
IntegerSum(15, _Zr, _Zi)
AND
IntegerToReal(_Xi, _Xm)
AND
IntegerToReal(_Yi, _Ym)
AND
IntegerToReal(_Zi, _Zm)
AND
RealDivide(_Xm, 10.0, _Xd)
AND
RealDivide(_Ym, 10.0, _Yd)
AND
RealDivide(_Zm, 10.0, _Zd)
AND
GetPosition(_Source, _Xs, _Ys, _Zs)
AND
RealSum(_Xd, _Xs, _X)
AND
RealSum(_Yd, _Ys, _Y)
AND
RealSum(_Zd, _Zs, _Z)
THEN
TeleportToPosition(S_COL_Vault_MindHelper_bcbf3462-05ce-4400-96fd-00c0bb215520, _X, _Y, _Z, "COL_Vault_MindHelperTeleported", 0, 0, 0, 0, 0);

IF
EntityEvent(S_COL_Vault_MindHelper_bcbf3462-05ce-4400-96fd-00c0bb215520, "COL_Vault_MindHelperTeleported")
THEN
PROC_TryStartAD((DIALOGRESOURCE)COL_Vault_AD_Solving_88fddace-8a27-2165-8edb-963ae01f0920, S_COL_Vault_MindHelper_bcbf3462-05ce-4400-96fd-00c0bb215520);

QRY
QRY_COL_Vault_CanSpeak()
AND
NOT DB_GlobalCounter("COL_Vault_UnlockedNodes", 0)
AND
NOT DB_DialogName((DIALOGRESOURCE)COL_Vault_AD_Solving_88fddace-8a27-2165-8edb-963ae01f0920,_)
THEN
DB_NOOP(1);


//END_REGION

//REGION Grand Design bas relief

IF
TemplateUseFinished(_Player,(ITEMROOT)QUEST_COL_MF_BasRelief_A_26b29e36-7f64-422c-8513-4109d356ba4a,_Relief,1)
AND
DB_Players(_Player)
AND
QRY_StartDialogCustom_Fixed(COL_NecroLab_GrandDesignSculpture_25c4347c-923c-ffea-03de-a293893a81ed,_Relief,_Player,0,0,1,0)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)COL_NecroLab_GrandDesignSculpture_25c4347c-923c-ffea-03de-a293893a81ed,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,_)
AND
QRY_OnlyOncePerUser((CHARACTER)_Player,"COL_Vault_DaisyAD_GrandDesignReaction")
THEN
PROC_DaisyAD(_Player,(DIALOGRESOURCE)COL_Vault_DaisyAD_GrandDesignReaction_0f53beca-230e-42cf-3130-492f9f14a3b2);

IF
AutomatedDialogEnded(COL_Vault_DaisyAD_GrandDesignReaction_0f53beca-230e-42cf-3130-492f9f14a3b2, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
IsInTrigger(_Player, S_COL_Vault_VB_GrandDesign_49dafcbc-aa48-4af8-a838-de785705b368, 1)
THEN
StartVoiceBark((VOICEBARKRESOURCE)COL_Vault_VB_GrandDesign_7d1f0d19-6214-5066-b564-3d292ff01cbe, (CHARACTER)_Player);

IF
EnteredTrigger(_Character,S_COL_Vault_GrandDesign_Interaction_Trigger_491fc660-d74c-40bb-a547-6efab19a4eee)
THEN
SetTag(_Character,ACT2_COL_VAULT_ATGRANDDESIGNSCULPTURE_40eb3c03-0dec-4244-a8d5-83b89af32727);

IF
LeftTrigger(_Character,S_COL_Vault_GrandDesign_Interaction_Trigger_491fc660-d74c-40bb-a547-6efab19a4eee)
THEN
ClearTag(_Character,ACT2_COL_VAULT_ATGRANDDESIGNSCULPTURE_40eb3c03-0dec-4244-a8d5-83b89af32727);

//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
