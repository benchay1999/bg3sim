Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Lifting the Curse - States
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinWaiting", 0);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinInAct2", 100);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtCamp", 200);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtHaven", 300);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtPortal", 400);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinInShadowFell", 500);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtPostPortal", 600);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtCampWithSpirit", 700);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinLookingForOliver", 800);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinWaitingForBreath", 900);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HuntingForBreath", 1000);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_OliverFledToTown", 1050);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_ThanielRestored", 1100);
DB_State_Priority(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtEpilogue", 1200);
DB_State_Current(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinWaiting");

DB_State_Flags(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtHaven", (FLAG)HAV_LiftingTheCurse_State_HalsinAtHaven_5bb65571-a6ad-4c34-abd3-b1f407a9cafc);
DB_State_Flags(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtHaven", (FLAG)HAV_LiftingTheCurse_State_HalsinAvailableForFist_38bd3ada-29d4-4a1d-900b-c58799aad3df);
DB_State_Flags(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtPortal", (FLAG)HAV_LiftingTheCurse_State_HalsinAtLakeside_0bb942dc-420d-45f9-9594-83805760fd29);
DB_State_Flags(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinInShadowFell", (FLAG)HAV_LiftingTheCurse_State_HalsinInShadowfell_480305fb-7b0b-4267-aab6-0090ddc12322);
DB_State_Flags(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtCampWithSpirit", (FLAG)HAV_LiftingTheCurse_State_HalsinWaitingInCamp_0bce2b56-183d-475e-8a61-9053952e3673);
DB_State_Flags(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_OliverFledToTown", (FLAG)SCL_LiftingTheCurse_State_OliverFledToTown_47018478-a3ef-42cc-8334-1516c6ed40f7);
//END_REGION

PROC_GLO_LiftingTheCurse_CheckHalsin();
KBSECTION
//REGION Debug

IF
FlagSet((FLAG)GLO_LiftingTheCurse_Debug_HalsinAvailable_3cef8942-ddb5-47d6-95b9-78322aa4f7f5, _, _)
THEN
PROC_GLO_LiftingTheCurse_Debug_HalsinSetUp("GLO_LiftingTheCurse_Debug_Entry");

PROC
PROC_GLO_LiftingTheCurse_Debug_HalsinSetUp((STRING)_StateName)
AND
DB_State_Current(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", _State)
THEN
PROC_GLO_LiftingTheCurse_Debug_HandleWorgPens();
NOT DB_State_Current(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", _State);
DB_State_Current(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinWaiting");
PROC_GLO_LiftingTheCurse_Debug_HalsinSetUp_State((STRING)_StateName);

PROC
PROC_GLO_LiftingTheCurse_Debug_HandleWorgPens()
AND
QRY_OnlyOnce("GLO_LiftingTheCurse_Debug_HandleWorgPens")
THEN
PROC_SceneOver("GOB_WolfPens");
ApplyStatus(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "HAV_SELUNEOINTMENT", -1.0, 1);
PROC_GLO_Halsin_RemoveWildshape();
SetHasDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
SetCanFight(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
SetCanJoinCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
PROC_RemoveDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);

PROC
PROC_GLO_LiftingTheCurse_Debug_HalsinSetUp_State("GLO_LiftingTheCurse_Debug_Entry")
THEN
PROC_GlobalClearFlagAndCache((FLAG)GLO_LiftingTheCurse_Debug_HalsinAvailable_3cef8942-ddb5-47d6-95b9-78322aa4f7f5);
SetEntityEvent(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "DebugTeleportedToCamp");


IF
FlagSet((FLAG)GLO_LiftingTheCurse_Debug_HalsinAvailable_3cef8942-ddb5-47d6-95b9-78322aa4f7f5, _, _)
THEN
PROC_GLO_LiftingTheCurse_Debug_HalsinSetUp("GLO_LiftingTheCurse_Debug_Entry");

PROC
PROC_GLO_LiftingTheCurse_Debug_HalsinSetUp((STRING)_State)
AND
DB_State_Current(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", _State)
THEN
ApplyStatus(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "HAV_SELUNEOINTMENT", -1.0, 1);
PROC_GLO_Halsin_RemoveWildshape();
SetHasDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
SetCanFight(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
SetCanJoinCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
PROC_RemoveDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
NOT DB_State_Current(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", _State);
DB_State_Current(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinWaiting");
PROC_GLO_LiftingTheCurse_Debug_HalsinSetUp_State("GLO_LiftingTheCurse_Debug_Entry");

PROC
PROC_GLO_LiftingTheCurse_Debug_HalsinSetUp_State("GLO_LiftingTheCurse_Debug_Entry")
THEN
PROC_GlobalClearFlagAndCache((FLAG)GLO_LiftingTheCurse_Debug_HalsinAvailable_3cef8942-ddb5-47d6-95b9-78322aa4f7f5);
SetEntityEvent(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "DebugTeleportedToCamp");

IF
TextEvent("HalsinSCLBrief")
AND
DB_Avatars(_Avatar)
THEN
PROC_RemoveDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, CAMP_Halsin2_c0ab0f6f-3ffc-d06d-0d6d-d1aaef70dfe4);
SetHasDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
PROC_GlobalSetFlagAndCache((FLAG)CAMP_Halsin_Knows_ShadowCurseMotivation_ed848f84-6bba-5523-d4c5-67a3b7eeb46c);
SetFlag((FLAG)CAMP_Halsin_Event_DeferredShadowCurseDiscussion_b931f2ef-2e74-f4be-be16-8ab1580ec2e1, _Avatar, 0);
//END_REGION

PROC
PROC_GLO_LiftingTheCurse_CheckHalsin()
AND
DB_InCamp((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
PROC_State_Progress(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinInAct2");

IF
DB_InCamp((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_GLO_LiftingTheCurse_HalsinAvailable(1)
THEN
PROC_State_Progress(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinInAct2");

PROC
PROC_State_Changed(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinInAct2")
THEN
PROC_GLO_Halsin_RemoveWildshape();
ApplyStatus(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "HAV_SELUNEOINTMENT", -1.0, 1);
PROC_GlobalSetFlagAndCache((FLAG)GLO_LiftingTheCurse_State_HalsinIsInAct2_dd398e58-f86f-4676-affd-390d4acc615e);
SetCanFight(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
SetCanJoinCombat(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
DB_GLO_LiftingTheCurse_HalsinAvailable(1);

IF
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_PermaDefeated(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_GlobalFlag(DEN_AttackOnDen_State_RaiderVictory_abe1bce8-c234-4afe-a490-76210d98a078)
AND
QRY_OnlyOnce("SCL_EntryPointHalsin_Entered")
THEN
PROC_RemoveDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, CAMP_Halsin2_c0ab0f6f-3ffc-d06d-0d6d-d1aaef70dfe4);
SetHasDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
PROC_ORI_Halsin_RestoreToSCLCamp();

PROC
PROC_ORI_Halsin_RestoreToSCLCamp()
THEN
TeleportTo(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, S_CAMP_SCLMAIN_Entrance_ad4708c7-b4a6-456b-9e3e-a70c25d01a64, "HalsinFallbackTeleportToCamp", 0, 0, 0, 1, 1);
PROC_ORI_SetupCamp((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);

PROC
PROC_ORI_Halsin_RestoreToSCLCamp()
AND
DB_Avatars(_Avatar)
THEN
QuestUpdate(_Avatar, "GLO_Tadpole", "GoToMoonrise_NoIntro");

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
