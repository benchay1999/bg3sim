Version 1
SubGoalCombiner SGC_AND
INITSECTION
// Barricade runners and repairman
DB_Dialogs(S_HAV_HavenOutcasts_BarricadeRunners_Caster_ff70f59a-7d50-4e69-a768-60a97c6fb57d, HAV_HavenOutcasts_BarricadeRunners_Caster_301619d0-9487-061d-783a-350ccdf8e5eb);
DB_Dialogs(S_HAV_HavenOutcasts_BarricadeRunners_Ranger_572690b6-68f5-4e7b-807b-b9376b658b65, HAV_HavenOutcasts_BarricadeRunners_Ranger_6e417eef-de3c-4fe9-aed8-9e42ee677987);
DB_Dialogs(S_HAV_HavenOutcasts_BarricadeYeller_Ranger_b612ef5f-3381-4486-8959-84dd399fb1ae, HAV_HavenOutcasts_BarricadeYeller_Ranger_a7ea51ea-0304-9c3b-a706-404e49fcd72a);

//Dock patrollers
DB_Dialogs(S_HAV_HavenOutcasts_DockGuard_Left_Ranger_3a856945-e4a5-4214-89af-84a2b50789d8, HAV_HavenOutcasts_DockGuard_Left_Ranger_0c46acb9-b844-b924-943f-d21f4cc453c4);
DB_Dialogs(S_HAV_HavenOutcasts_DockGuard_Left_Melee_bd46130e-1c2c-4888-9e9c-6dd58965ab4f, HAV_HavenOutcasts_DockGuard_Left_Melee_b2e7c466-f04c-ebd9-845f-f59203b05d9d);
DB_Dialogs(S_HAV_HavenOutcasts_DockGuard_Melee_f1f837ad-8e6a-442d-bba4-46f665c47675, HAV_HavenOutcasts_DockGuard_Melee_0908aa4a-1e0d-66f3-3666-a75d2c420c5e);
DB_Dialogs(S_HAV_HavenOutcasts_DockGuard_Ranger_a0f9d7cb-d87c-4af8-87fa-d273a8ecba93, HAV_HavenOutcasts_DockGuard_Ranger_3d05e85c-db5e-07ed-777d-a13d476c45da);

//Barricade guards
DB_Dialogs(S_HAV_HavenOutcasts_BarricadeGuards_Melee_Dwarf_b1d8b327-1f27-4921-aa2b-dd18a9d67fc8, HAV_HavenOutcasts_BarricadeGuards_Melee_Dwarf_30499cfb-635b-e5f2-418d-6345e93876b5);
DB_Dialogs(S_HAV_HavenOutcasts_BarricadeGuards_Caster_WoodElf_f48078e6-ec51-49a2-a244-9d0a72af5257, HAV_HavenOutcasts_BarricadeGuards_Caster_WoodElf_ad5a87d8-ed7f-333c-07e7-4e1dd9e6e56e);


//Roof watcher
DB_Dialogs(S_HAV_HavenOutcasts_RoofWatcher_Caster_d44b6aee-7737-4961-bb2b-e7920b003107, HAV_HavenOutcasts_RoofWatcher_Caster_4ba8f4f4-9e73-784f-657e-4e8b32229daa);

//Fountain three way

DB_Dialogs(S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85,HAV_HavenOutcasts_FountainGuards_Melee_2_052ea105-2e43-5923-0fc4-75d42cce4be0);
DB_Dialogs(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5,HAV_HavenOutcasts_FountainGuards_Melee_1_5778162c-dec8-1cb1-4726-3f993c4a507f);

DB_HAV_HavenOutcasts_ThreeWaySpeakers(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5);
DB_HAV_HavenOutcasts_ThreeWaySpeakers(S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85);

//Entrance guards


DB_Dialogs(S_HAV_HavenOutcasts_EntranceGuards_Halfling_Melee_c8bc8f03-c91c-42d4-829c-d16bb1df4a67, HAV_HavenOutcasts_EntranceGuards_Halfling_Melee_7362e46c-0893-1dfe-1739-39adfd34ce25);
DB_Dialogs(S_HAV_HavenOutcasts_EntranceGuards_Caster_HighElf_825714dd-7df9-4cd1-aecb-edf577baa487, HAV_HavenOutcasts_EntranceGuards_Caster_HighElf_beb0f0f2-a9a5-44d5-e604-6d5cdd73a3bb);


//quartermaster
DB_Dialogs(S_HAV_HavenOutcasts_HarperQuartermaster_f769815c-d437-4a45-9ae4-aebd53ec8f7c, HAV_HavenOutcasts_HarperQuartermaster_40f88c35-224b-27d4-a38b-a98fed321808);

DB_HasItemTemplateScriptFlag(1, (DIALOGRESOURCE)HAV_HavenOutcasts_HarperQuartermaster_40f88c35-224b-27d4-a38b-a98fed321808, (ITEMROOT)LOOT_Camp_Pack_398e7328-ce90-4c02-94a2-93341fac499a, 1);
DB_GiveTemplateFromNpcToPlayerDialogEvent((ITEMROOT)LOOT_Camp_Pack_398e7328-ce90-4c02-94a2-93341fac499a, (FLAG)HAV_HavenOutcasts_HarperQuartermaster_Event_GiveSupplies_275735a2-5ef8-4a89-8736-8062ff346ff7, NULL_00000000-0000-0000-0000-000000000000, 2);

//Prison

DB_RegionPrison("SCL_Main_A_HAV",(TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, S_HAV_PrisonSpawnPoint_5624ee3e-654c-41ec-affc-1697e2180d40);
DB_PlayerPrison((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,"PrisonEscape","PrisonEscape_AD","GB_FUGITIVE_HAV");
DB_FugitiveArea((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, (TRIGGER)S_HAV_FugitiveTravelBlockArea_f70c44f6-3abc-4cc9-bcd5-f57a95709118);
DB_PrisonReactionTrigger((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,(TRIGGER)S_HAV_CrimeRegionTrigger_1df96345-f975-40fd-a185-5716619f8d7e);
DB_PlayerPrison_Door((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,(ITEM)S_HAV_Prison_PlayerCell_Door_00b11d90-2545-493f-8347-d11757185d2b,"HAV_Prison_Key");
DB_PrisonChest((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,(ITEM)S_HAV_Prison_PlayerEquipmentChest_3b8f965f-b320-4575-88cc-9bde9ff86fb0);
DB_PrisonEvidenceChest((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,(ITEM)S_HAV_Prison_EvidenceChest_5c1db440-790b-4a02-a3a2-bf06c3c12524);

KBSECTION
//REGION Debug
IF
TextEvent("hav_imprison")
AND
GetHostCharacter(_Player)
AND
DB_RegionPrison("SCL_Main_A_HAV", _PrisonCell, _PrisonSpawnPoint)
AND
DB_PlayerPrison(_PrisonTrigger, _, _, _FugitiveStatus)
THEN
PROC_CrimeTeleportCharacterToPrison((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player, _PrisonCell, _PrisonSpawnPoint, _FugitiveStatus);

//END_REGION Debug

//REGION Jailbreak

PROC
PROC_HAV_Prison_SwitchToAltCell()
THEN
NOT DB_RegionPrison("SCL_Main_A_HAV",(TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, S_HAV_PrisonSpawnPoint_5624ee3e-654c-41ec-affc-1697e2180d40);
NOT DB_PlayerPrison((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,"PrisonEscape","PrisonEscape_AD","GB_FUGITIVE_HAV");
NOT DB_PrisonReactionTrigger((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,(TRIGGER)S_HAV_CrimeRegionTrigger_1df96345-f975-40fd-a185-5716619f8d7e);
NOT DB_PlayerPrison_Door((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,(ITEM)S_HAV_Prison_PlayerCell_Door_00b11d90-2545-493f-8347-d11757185d2b,"HAV_Prison_Key");
NOT DB_PrisonChest((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,(ITEM)S_HAV_Prison_PlayerEquipmentChest_3b8f965f-b320-4575-88cc-9bde9ff86fb0);
NOT DB_PrisonEvidenceChest((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,(ITEM)S_HAV_Prison_EvidenceChest_5c1db440-790b-4a02-a3a2-bf06c3c12524);
NOT DB_FugitiveArea((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, (TRIGGER)S_HAV_FugitiveTravelBlockArea_f70c44f6-3abc-4cc9-bcd5-f57a95709118);
DB_RegionPrison("SCL_Main_A_HAV",(TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a, (TRIGGER)S_HAV_AltPrisonSpawnPoint_cc75ca8e-a382-493a-b032-451394574b32);
DB_PlayerPrison((TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a,"PrisonEscape","PrisonEscape_AD","GB_FUGITIVE_HAV");
DB_PrisonReactionTrigger((TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a,(TRIGGER)S_HAV_CrimeRegionTrigger_1df96345-f975-40fd-a185-5716619f8d7e);
DB_PlayerPrison_Door((TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a,(ITEM)S_HAV_Prison_PlayerCell_AltDoor_ec6921d4-24b5-4aa3-91ab-9187aa2afcb1,"HAV_Prison_Key");
DB_PrisonChest((TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a,(ITEM)S_HAV_Prison_PlayerEquipmentChest_3b8f965f-b320-4575-88cc-9bde9ff86fb0);
DB_PrisonEvidenceChest((TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a,(ITEM)S_HAV_Prison_EvidenceChest_5c1db440-790b-4a02-a3a2-bf06c3c12524);
DB_FugitiveArea((TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a, (TRIGGER)S_HAV_FugitiveTravelBlockArea_f70c44f6-3abc-4cc9-bcd5-f57a95709118);

// when we swtich to the alternative cell it's possible that we have some internal prison DBs referencing the previous player cell
// instead of trying to update them manually we remove the Fugitive status (which clears everything for us) and then re-register it again with the new player cell
PROC
PROC_HAV_Prison_SwitchToAltCell()
AND
DB_PlayerEscapedPrison(_Player, _Arrester, (TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, _ArrestedNotShapeshifted, _PrisonCrimeName, _PrisonCrimeNameAD, _EscapeID, _EscapeADID, _FugitiveStatus)
THEN
DB_HAV_Prison_SwitchEscapedCrimeToAltCell((CHARACTER)_Player, (CHARACTER)_Arrester, (INTEGER)_ArrestedNotShapeshifted, (STRING)_PrisonCrimeName, (STRING)_PrisonCrimeNameAD, (STRING)_FugitiveStatus);

// case #1 status is applied after DB has been defined
IF
StatusApplied(_Player, "GB_FUGITIVE_HAV", _, _)
AND
DB_HAV_Prison_SwitchEscapedCrimeToAltCell((CHARACTER)_Player, (CHARACTER)_Arrester, (INTEGER)_ArrestedNotShapeshifted, (STRING)_PrisonCrimeName, (STRING)_PrisonCrimeNameAD, (STRING)_FugitiveStatus)
THEN
RemoveStatus(_Player, _FugitiveStatus, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusAttemptFailed(_Player, "GB_FUGITIVE_HAV", _, _)
AND
DB_HAV_Prison_SwitchEscapedCrimeToAltCell((CHARACTER)_Player, (CHARACTER)_Arrester, (INTEGER)_ArrestedNotShapeshifted, (STRING)_PrisonCrimeName, (STRING)_PrisonCrimeNameAD, (STRING)_FugitiveStatus)
THEN
NOT DB_HAV_Prison_SwitchEscapedCrimeToAltCell((CHARACTER)_Player, (CHARACTER)_Arrester, (INTEGER)_ArrestedNotShapeshifted, (STRING)_PrisonCrimeName, (STRING)_PrisonCrimeNameAD, (STRING)_FugitiveStatus);
PROC_CRIME_Prison_Escaped(_Player, _Arrester, (TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a, _ArrestedNotShapeshifted, _PrisonCrimeName, _PrisonCrimeNameAD, _FugitiveStatus);

// case #2 DB is defined after status has been applied
IF
DB_HAV_Prison_SwitchEscapedCrimeToAltCell((CHARACTER)_Player, (CHARACTER)_Arrester, (INTEGER)_ArrestedNotShapeshifted, (STRING)_PrisonCrimeName, (STRING)_PrisonCrimeNameAD, (STRING)_FugitiveStatus)
AND
HasAppliedStatus(_Player, "GB_FUGITIVE_HAV", 1) 
THEN
RemoveStatus(_Player, _FugitiveStatus, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved((CHARACTER)_Player, _FugitiveStatus, _, _)
AND
DB_HAV_Prison_SwitchEscapedCrimeToAltCell((CHARACTER)_Player, (CHARACTER)_Arrester, (INTEGER)_ArrestedNotShapeshifted, (STRING)_PrisonCrimeName, (STRING)_PrisonCrimeNameAD, (STRING)_FugitiveStatus)
THEN
NOT DB_HAV_Prison_SwitchEscapedCrimeToAltCell((CHARACTER)_Player, (CHARACTER)_Arrester, (INTEGER)_ArrestedNotShapeshifted, (STRING)_PrisonCrimeName, (STRING)_PrisonCrimeNameAD, (STRING)_FugitiveStatus);
PROC_CRIME_Prison_Escaped(_Player, _Arrester, (TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a, _ArrestedNotShapeshifted, _PrisonCrimeName, _PrisonCrimeNameAD, _FugitiveStatus);

IF
DestroyedBy((ITEM)S_HavenCellar_BreakableWall2_ac192e61-52e4-404f-a5b4-49fe0fb237cd, _, _, _)
AND
DB_IsArrested(_Arrester,_Player)
AND
DB_Players(_Player)
AND
DB_PlayerPrison((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,(STRING)_PrisonCrimeName,(STRING)_PrisonCrimeNameAD,(STRING)_FugitiveStatus)
AND
DB_CRIME_PrisonArrestedNonShapeshifted(_Player, (TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, _ArrestedNotShapeshifted)
THEN
NOT DB_CRIME_PrisonArrestedNonShapeshifted(_Player,(TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00,_ArrestedNotShapeshifted);
PROC_CRIME_Prison_Escaped(_Player, _Arrester, (TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, _ArrestedNotShapeshifted, _PrisonCrimeName, _PrisonCrimeNameAD, _FugitiveStatus);

PROC
PROC_CRIME_Prison_Escaped(_, _, (TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, _, _, _, _)
AND
NOT QRY_HAV_Prison_PrisonersLeft()
AND
DB_RegionPrison("SCL_Main_A_HAV",(TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, S_HAV_PrisonSpawnPoint_5624ee3e-654c-41ec-affc-1697e2180d40)
AND
IsDestroyed((ITEM)S_HavenCellar_BreakableWall2_ac192e61-52e4-404f-a5b4-49fe0fb237cd, 1)
THEN
PROC_HAV_Prison_SwitchToAltCell();

IF
DestroyedBy((ITEM)S_HavenCellar_BreakableWall2_ac192e61-52e4-404f-a5b4-49fe0fb237cd, _, _, _)
AND
NOT QRY_HAV_Prison_PrisonersLeft()
THEN
PROC_HAV_Prison_SwitchToAltCell();

QRY
QRY_HAV_Prison_PrisonersLeft()
AND
DB_InRegion(_Player, (TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00)
AND
DB_IsArrested(_, _Player)
THEN
DB_NOOP(1);

//END_REGION

IF
LevelLoaded("SCL_Main_A")
AND
NOT DB_InRegion((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_ShadowCurse_SafeZone_Haven_f4f81c2b-5428-4d06-a65e-3ba21e105cba)
THEN
PROC_HAV_HavenOutcasts_FountainGuards_ReplaceDialogs();


PROC
PROC_HAV_HavenOutcasts_FountainGuards_ReplaceDialogs()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5);
PROC_RemoveAllDialogEntriesForSpeaker(S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85);
DB_Dialogs(S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85,HAV_HavenOutcasts_FountainGuards_Melee_2_052ea105-2e43-5923-0fc4-75d42cce4be0);
DB_Dialogs(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5,HAV_HavenOutcasts_FountainGuards_Melee_1_5778162c-dec8-1cb1-4726-3f993c4a507f);


QRY
QRY_SelectCustomDialog(_Speaker, _Player)
AND
QRY_State_IsBeforeState(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_Assault") //Both characters are part of the assault
AND
DB_Players((CHARACTER)_Player)
AND
DB_HAV_HavenOutcasts_ThreeWaySpeakers(_Speaker)
AND
DB_GlobalFlag((FLAG)PLA_Desire_State_Freed2_46dbc8ef-61fa-42c4-bc89-4a8f53d53e5b)
AND
NOT DB_GlobalFlag((FLAG)HAV_Florrick_State_LeaveForCity_28f9ed3b-83e0-da1c-595d-2dcb8ffdafc4)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85, _Player)
AND
IsOnStage(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5, 1)
AND
QRY_OnlyOnce("HAV_HavenOutcasts_ThreewayDialog")
THEN
DB_SelectedDialog(HAV_HavenOutcasts_FountainGuards_ThreeWay_7fb392c1-45c7-0026-9870-bf8a4d3bde99, S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85, 
	S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5, _Player);

IF
DialogEnded(HAV_HavenOutcasts_FountainGuards_ThreeWay_7fb392c1-45c7-0026-9870-bf8a4d3bde99,_)
THEN
PROC_HAV_HavenOutcasts_FountainGuards_ReplaceDialogs();

IF
Dying(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5)
THEN
PROC_HAV_HavenOutcasts_FountainGuards_ReplaceDialogs();

IF
Dying(S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85)
THEN
PROC_HAV_HavenOutcasts_FountainGuards_ReplaceDialogs();

PROC
PROC_State_Changed(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege")
THEN
PROC_HAV_HavenOutcasts_FountainGuards_ReplaceDialogs();
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
