Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Gnomes
DB_DialogBlockTradeButton(MOO_Jailbreak_Wulbren_70298fcd-3a9f-7bdb-b740-0fa46ea09902);

DB_Dialogs((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, (DIALOGRESOURCE)MOO_Jailbreak_GnomePrisoner_001_fec6ff03-708e-b279-075b-643d48198dbb);
DB_Dialogs((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (DIALOGRESOURCE)MOO_Jailbreak_Wulbren_70298fcd-3a9f-7bdb-b740-0fa46ea09902);
DB_Dialogs((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, (DIALOGRESOURCE)MOO_Jailbreak_GnomePrisoner_002_10025a36-6e51-a7c7-7061-f471e75f05fa);

DB_MOO_Jailbreak_Cell("Gnomes", (ITEM)S_MOO_CellGate_002_35fbdc57-b803-4edb-879f-f678bad6c446, (FLAG)MOO_Jailbreak_State_GnomeCellOpen_a557455c-0cb4-4859-96a7-cd99131af5cd, (ITEM)S_MOO_GnomeDestructibleWall_001_918242db-699a-4886-9cd7-433c62b920a9, (FLAG)MOO_Jailbreak_State_GnomePathOpen_ef0aa614-2a18-7bd1-0f79-c3aca59ec3ab);

PROC_TriggerRegisterForPlayers(S_MOO_CloseToGnomesArea_ce80db02-4f1d-4d3a-91fc-1fbb92f07866);
PROC_TriggerRegisterForPlayers(S_MOO_CloseToGnomesArea_001_bb9032ca-6a7c-40b5-acff-eb0d3a9cb129);
PROC_TriggerRegisterForPlayers(S_MOO_MoonriseTowerNoRoof_SUB_54d40f5d-34e6-42fd-829b-bb2f5facfcda);
PROC_TriggerRegisterForPlayers(S_MOO_PrisonJailbreak_SUB_d066ff4c-bc01-4e46-97ad-f641ccd61929);

SetFlag(MOO_Jailbreak_State_GnomesInJail_acbdd0cf-8b58-460c-adb6-fe883d886deb, NULL_00000000-0000-0000-0000-000000000000, 0);
TriggerRegisterForItems(S_MOO_GnomeCell_25f1be2f-5203-4100-bc47-e286cd3f13b0);

DB_MOO_Jailbreak_Prisoner((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, "Gnomes");
DB_MOO_Jailbreak_Prisoner((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "Gnomes");
DB_MOO_Jailbreak_Prisoner((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, "Gnomes");

DB_PermaDefeatedFlag(S_MOO_GnomeDestructibleWall_918242db-699a-4886-9cd7-433c62b920a9, MOO_Jailbreak_State_TunnelPathOpen_ef0aa614-2a18-7bd1-0f79-c3aca59ec3ab);

DB_HasItemEvent(S_MOO_JailbreakHammer_b6925b99-4b14-48a1-89ca-eb328bb746df, MOO_Jailbreak_State_HasWulbrenHammer_32474e94-de18-1860-b66e-100dac52b9e4);
//END_REGION

//REGION Guards

DB_Dialogs((CHARACTER)S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7, (DIALOGRESOURCE)MOO_Jailbreak_Warden_4eb7970b-14df-5faa-f25c-8e9360fd280b);
DB_Dialogs((CHARACTER)S_MOO_PrisonGuard_002_0cf357ec-268c-4779-92ad-8d6c7de437d1, (DIALOGRESOURCE)MOO_Jailbreak_Guard_002_7c32a61a-20e2-6492-08cf-9aed1f6777f5);
DB_Dialogs((CHARACTER)S_MOO_PrisonGuard_004_107c72ca-2a4f-477d-a315-deeea3eea49e, (DIALOGRESOURCE)MOO_Jailbreak_Guard_004_37e932d6-554f-7edb-b1a7-47cad0bff37e);

DB_MOO_Jailbreak_PendingGuards((CHARACTER)S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7);
DB_MOO_Jailbreak_PendingGuards((CHARACTER)S_MOO_PrisonGuard_002_0cf357ec-268c-4779-92ad-8d6c7de437d1);
DB_MOO_Jailbreak_PendingGuards((CHARACTER)S_MOO_PrisonGuard_004_107c72ca-2a4f-477d-a315-deeea3eea49e);
DB_MOO_Jailbreak_PendingGuards((CHARACTER)S_MOO_WarehouseGuard_000_d161fc7f-801c-463c-bdbd-f638c8499361);
DB_MOO_Jailbreak_PendingGuards((CHARACTER)S_MOO_WarehouseGuard_001_30de3349-7bcb-4a6e-be2e-3ae7a4c89e6a);
DB_MOO_Jailbreak_PendingGuards((CHARACTER)S_MOO_WarehouseGuard_002_8360ec17-f888-4745-8b22-351feadb86d1);
DB_MOO_Jailbreak_PendingGuards((CHARACTER)S_MOO_PrisonEye_A_fe9333ab-2bbe-4624-978e-56ca9b4c58da);
DB_MOO_Jailbreak_PendingGuards((CHARACTER)S_MOO_PrisonEye_B_9bea6db5-8e9a-4277-9813-823b45248022);
DB_MOO_Jailbreak_PendingGuards((CHARACTER)S_MOO_PrisonEye_C_89e223c3-52e8-4bbf-9a75-47cbb0b6b65e);

DB_MOO_Jailbreak_EscapedPrisonerCheck((TRIGGER)S_MOO_CloseToGnomesArea_001_bb9032ca-6a7c-40b5-acff-eb0d3a9cb129, (FLAG)MOO_Jailbreak_State_GnomePathOpen_ef0aa614-2a18-7bd1-0f79-c3aca59ec3ab);
DB_MOO_Jailbreak_EscapedPrisonerCheck((TRIGGER)S_MOO_CloseToTieflingsArea_002_00eaf664-f945-467a-8c63-9c8961d544c3, (FLAG)MOO_Jailbreak_State_TieflingPathOpen_7ac02a54-0147-f8fc-778a-88af57f9030d);

DB_MOO_Jailbreak_TunnelInvestigatePos((ITEM)S_MOO_CellGate_002_35fbdc57-b803-4edb-879f-f678bad6c446, (TRIGGER)S_MOO_GoToTunnelsPos_001_d4f41fbc-fecd-47d8-878e-886aca322921);
DB_MOO_Jailbreak_TunnelInvestigatePos(S_MOO_CellGate_004_9758a245-c314-4099-94a5-506267cf2a1d, S_MOO_GoToTunnelsPos_002_c471ee14-6458-4b43-aa35-73abfd6ff8fc);

PROC_TriggerRegisterForPlayers(S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab);
PROC_TriggerRegisterForPlayers(S_MOO_ByCellsArea_6871bc1b-742f-4677-82ab-069d6a35cd5a);
PROC_TriggerRegisterForPlayers(S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff);
DB_SpotPlayers_SpotTrigger(S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7, "MOO_Jailbreak_EntryWarning", S_MOO_PrisonEntryArea_ed458e58-37ee-4293-b554-8084bf79bd38);
DB_SpotPlayers(S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7, "MOO_Jailbreak_EntryWarning", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION Tieflings

DB_MOO_Jailbreak_PotentialTiefling((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (TRIGGER)S_MOO_PrisonerTieflingPos_001_9c279042-4963-490c-8f2e-6476c2aea716, (DIALOGRESOURCE)MOO_Jailbreak_ProdigySister_2f6d3c1c-f580-453a-8828-e0a8ec3cd9ff, "MOO_ProdigySister");
DB_MOO_Jailbreak_PotentialTiefling((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, S_MOO_PrisonerTieflingPos_002_8bc30a20-b491-4d4a-990c-615fc851564a, (DIALOGRESOURCE)MOO_Jailbreak_ProdigyBrother_58346860-9653-c355-d12e-0642a7610bb9, "MOO_ProdigyBrother");
DB_MOO_Jailbreak_PotentialTiefling((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, S_MOO_PrisonerTieflingPos_003_b5142de2-140d-4ea1-b5b6-8b9d351585ed, (DIALOGRESOURCE)MOO_Jailbreak_FlirtyTiefling_6e0eb4fb-89a5-4202-7985-745e932913f9, "MOO_FlirtyTiefling");
DB_MOO_Jailbreak_PotentialTiefling((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, S_MOO_PrisonerTieflingPos_004_78192c52-3382-44b6-9fb2-480919139632, (DIALOGRESOURCE)MOO_Jailbreak_Lover_e78e1cce-b7fe-76bf-9110-d4e3e009e1a4, "MOO_TieflingLover");

PROC_TriggerRegisterForPlayers(S_MOO_CloseToTieflingsArea_6139cf6a-9e00-4ccb-8b92-733437a35e57);
PROC_TriggerRegisterForPlayers(S_MOO_CloseToTieflingsArea_002_00eaf664-f945-467a-8c63-9c8961d544c3);
//END_REGION

//REGION Getaway Boat

SetCanInteract(S_MOO_EscapeBoatSeats_b1f641f2-a0b0-4f04-a76f-63d08d48ccdb, 0);

DB_IgnoreMutingStatussesDialog(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3);

PROC_TriggerRegisterForPlayers(S_MOO_GetawayBoatDialogArea_030094d9-ec6f-4717-903a-0cb27c5cea2f);
PROC_TriggerRegisterForPlayers(S_MOO_GetawayBoatPlayerArea_02e5e8aa-6987-4988-971f-315d0b489ec3);

DB_MOO_Jailbreak_BoatParts((ITEM)S_MOO_EscapeBoat_dd67802b-bb74-474c-a670-87d04a784db7);
DB_MOO_Jailbreak_BoatParts(S_MOO_EscapeBoatRope_001_a12aa575-b72c-4f6a-b86d-8fc305b0d4ba);
DB_MOO_Jailbreak_BoatParts(S_MOO_EscapeBoatRope_002_cf0a7c1e-9f46-418f-8cbb-1696de3bc8d4);
DB_MOO_Jailbreak_BoatParts(S_MOO_EscapeBoatSeats_b1f641f2-a0b0-4f04-a76f-63d08d48ccdb);


DB_MOO_Jailbreak_BoatInMOO(1);

DB_MOO_Jailbreak_Chains((ITEM)S_MOO_EscapeBoatRope_001_a12aa575-b72c-4f6a-b86d-8fc305b0d4ba);
DB_MOO_Jailbreak_Chains(S_MOO_EscapeBoatRope_002_cf0a7c1e-9f46-418f-8cbb-1696de3bc8d4);

DB_MOO_Jailbreak_ChainPositions((ITEM)S_MOO_EscapeBoatRope_001_a12aa575-b72c-4f6a-b86d-8fc305b0d4ba, (TRIGGER)S_MOO_ChainPosition_001_8bda9f9d-5b04-4274-8f8c-b6b40d7fac12, (CHARACTER)NULL_00000000-0000-0000-0000-000000000000);
DB_MOO_Jailbreak_ChainPositions((ITEM)S_MOO_EscapeBoatRope_001_a12aa575-b72c-4f6a-b86d-8fc305b0d4ba, (TRIGGER)S_MOO_ChainPosition_002_5c2f7460-8bb4-4159-9ad8-64f87738a8bd, (CHARACTER)NULL_00000000-0000-0000-0000-000000000000);
DB_MOO_Jailbreak_ChainPositions((ITEM)S_MOO_EscapeBoatRope_002_cf0a7c1e-9f46-418f-8cbb-1696de3bc8d4, (TRIGGER)S_MOO_ChainPosition_003_c8862c34-ab00-45c6-8696-4a97e8d28d3a, (CHARACTER)NULL_00000000-0000-0000-0000-000000000000);
DB_MOO_Jailbreak_ChainPositions((ITEM)S_MOO_EscapeBoatRope_002_cf0a7c1e-9f46-418f-8cbb-1696de3bc8d4, (TRIGGER)S_MOO_ChainPosition_004_d020f501-3bc5-4d20-98b8-3a9b593ad334, (CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

DB_MOO_Jailbreak_ChainWeapons((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (ITEM)S_MOO_JailbreakWeapon_001_089cebb7-cfe7-43c9-933a-93c792c7d1e4);
DB_MOO_Jailbreak_ChainWeapons(S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, (ITEM)S_MOO_JailbreakWeapon_002_27b5ff48-d456-4b96-ae3a-e34268feafa9);
DB_MOO_Jailbreak_ChainWeapons(S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, (ITEM)S_MOO_JailbreakWeapon_003_ba0d3372-ca79-4e32-9057-5b458aabca11);
DB_MOO_Jailbreak_ChainWeapons(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (ITEM)S_MOO_JailbreakWeapon_004_a9207f73-15a9-4dfa-829d-69148ee83b06);
DB_MOO_Jailbreak_ChainWeapons(S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, (ITEM)S_MOO_JailbreakWeapon_005_f06e2585-0109-4e67-a974-bbff9cfe8492);
DB_MOO_Jailbreak_ChainWeapons(S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, (ITEM)S_MOO_JailbreakWeapon_006_95bc170e-c74c-42fd-8150-1c384fa71d4c);
DB_MOO_Jailbreak_ChainWeapons(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (ITEM)S_MOO_JailbreakWeapon_007_72c0516c-f66d-4fbc-858f-c5914ae31b07);

DB_MOO_Jailbreak_CanCombatChainBreakAD(1);
//END_REGION

//REGION Jailbreak escape splines

//Gnomes
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (FLAG)MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee, (SPLINE)S_MOO_GnomeBoatSpline_001_e32d1011-7b8c-4ee6-8432-cbffc18b7f6e);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (FLAG)MOO_Jailbreak_State_BackupEscape_c2f1053d-c56e-d34d-c200-82d7c8267e7f, (SPLINE)S_MOO_BackupEscapeSpline_001_367cde76-d4ab-4860-9eab-9bb829dabf8f);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (FLAG)MOO_Jailbreak_State_DockEscape_7621f16f-7820-26c3-4ab0-1288dc5b26e4, (SPLINE)S_MOO_DockEscapeSpline_001_285cf7c8-65a3-448d-a2bc-a633b722cb8b);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (FLAG)MOO_Jailbreak_State_PrisonEscape_3cc56692-47ac-453a-8748-9c140dbee06f, (SPLINE)S_MOO_GnomePrisonEscapeSpline_001_ba8f4861-b908-4e85-8e9b-3f1090e0bf05);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (FLAG)MOO_Jailbreak_State_TieflingEscape_957c68da-c432-44af-a69d-a7b44da4b344, (SPLINE)S_MOO_SaveTieflingsSpline_001_617ad006-0123-47b2-8c1b-f18c361b9cf0);

DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, (FLAG)MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee, (SPLINE)S_MOO_GnomeBoatSpline_002_e398dd3b-3dd2-4791-832c-00b58ad4ccbc);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, (FLAG)MOO_Jailbreak_State_BackupEscape_c2f1053d-c56e-d34d-c200-82d7c8267e7f, (SPLINE)S_MOO_BackupEscapeSpline_001_367cde76-d4ab-4860-9eab-9bb829dabf8f);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, (FLAG)MOO_Jailbreak_State_DockEscape_7621f16f-7820-26c3-4ab0-1288dc5b26e4, (SPLINE)S_MOO_DockEscapeSpline_001_285cf7c8-65a3-448d-a2bc-a633b722cb8b);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, (FLAG)MOO_Jailbreak_State_PrisonEscape_3cc56692-47ac-453a-8748-9c140dbee06f, (SPLINE)S_MOO_GnomePrisonEscapeSpline_002_4d0ca2d5-0c1e-4393-9e40-642177cb8804);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, (FLAG)MOO_Jailbreak_State_TieflingEscape_957c68da-c432-44af-a69d-a7b44da4b344, (SPLINE)S_MOO_SaveTieflingsSpline_002_dd361711-dd9f-4f04-bb0e-67becf536460);

DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, (FLAG)MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee, (SPLINE)S_MOO_GnomeBoatSpline_003_a850ecbb-081a-4301-8147-aa93e4fb81c3);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, (FLAG)MOO_Jailbreak_State_BackupEscape_c2f1053d-c56e-d34d-c200-82d7c8267e7f, (SPLINE)S_MOO_BackupEscapeSpline_001_367cde76-d4ab-4860-9eab-9bb829dabf8f);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, (FLAG)MOO_Jailbreak_State_DockEscape_7621f16f-7820-26c3-4ab0-1288dc5b26e4, (SPLINE)S_MOO_DockEscapeSpline_001_285cf7c8-65a3-448d-a2bc-a633b722cb8b);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, (FLAG)MOO_Jailbreak_State_PrisonEscape_3cc56692-47ac-453a-8748-9c140dbee06f, (SPLINE)S_MOO_GnomePrisonEscapeSpline_003_2a8c313d-4cc6-4d43-951b-ef356b963cee);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, (FLAG)MOO_Jailbreak_State_TieflingEscape_957c68da-c432-44af-a69d-a7b44da4b344, (SPLINE)S_MOO_SaveTieflingsSpline_003_f1c9c7f4-3bb1-417a-a98c-2c961b8dc48a);

//Tieflings

DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, (FLAG)MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee, (SPLINE)S_MOO_TieflingBoatSpline_001_7573550f-a219-4a62-9596-8e523d9d17fa);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, (FLAG)MOO_Jailbreak_State_BackupEscape_c2f1053d-c56e-d34d-c200-82d7c8267e7f, (SPLINE)S_MOO_BackupEscapeSpline_001_367cde76-d4ab-4860-9eab-9bb829dabf8f);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, (FLAG)MOO_Jailbreak_State_DockEscape_7621f16f-7820-26c3-4ab0-1288dc5b26e4, (SPLINE)S_MOO_DockEscapeSpline_001_285cf7c8-65a3-448d-a2bc-a633b722cb8b);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, (FLAG)MOO_Jailbreak_State_PrisonEscape_3cc56692-47ac-453a-8748-9c140dbee06f, (SPLINE)S_MOO_TieflingPrisonEscapeSpline_001_0bf11977-f44b-4d86-8f74-f1b234fc2f3c);

DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (FLAG)MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee, (SPLINE)S_MOO_TieflingBoatSpline_002_cd7c528b-918e-436e-b81a-dbe9ce01d33d);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (FLAG)MOO_Jailbreak_State_BackupEscape_c2f1053d-c56e-d34d-c200-82d7c8267e7f, (SPLINE)S_MOO_BackupEscapeSpline_001_367cde76-d4ab-4860-9eab-9bb829dabf8f);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (FLAG)MOO_Jailbreak_State_DockEscape_7621f16f-7820-26c3-4ab0-1288dc5b26e4, (SPLINE)S_MOO_DockEscapeSpline_001_285cf7c8-65a3-448d-a2bc-a633b722cb8b);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (FLAG)MOO_Jailbreak_State_PrisonEscape_3cc56692-47ac-453a-8748-9c140dbee06f, (SPLINE)S_MOO_TieflingPrisonEscapeSpline_002_cc8b5040-db6e-4b41-8c69-cfa65ccac9cf);

DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, (FLAG)MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee, (SPLINE)S_MOO_TieflingBoatSpline_003_588bc0ea-30a8-4c08-bbbc-753afda26110);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, (FLAG)MOO_Jailbreak_State_BackupEscape_c2f1053d-c56e-d34d-c200-82d7c8267e7f, (SPLINE)S_MOO_BackupEscapeSpline_001_367cde76-d4ab-4860-9eab-9bb829dabf8f);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, (FLAG)MOO_Jailbreak_State_DockEscape_7621f16f-7820-26c3-4ab0-1288dc5b26e4, (SPLINE)S_MOO_DockEscapeSpline_001_285cf7c8-65a3-448d-a2bc-a633b722cb8b);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, (FLAG)MOO_Jailbreak_State_PrisonEscape_3cc56692-47ac-453a-8748-9c140dbee06f, (SPLINE)S_MOO_TieflingPrisonEscapeSpline_003_ecbc3e46-1eef-403a-ae9c-5a3cacbd50cf);

DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (FLAG)MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee, (SPLINE)S_MOO_TieflingBoatSpline_004_228ac4a3-daa3-42aa-a5af-6889668d1557);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (FLAG)MOO_Jailbreak_State_BackupEscape_c2f1053d-c56e-d34d-c200-82d7c8267e7f, (SPLINE)S_MOO_BackupEscapeSpline_001_367cde76-d4ab-4860-9eab-9bb829dabf8f);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (FLAG)MOO_Jailbreak_State_DockEscape_7621f16f-7820-26c3-4ab0-1288dc5b26e4, (SPLINE)S_MOO_DockEscapeSpline_001_285cf7c8-65a3-448d-a2bc-a633b722cb8b);
DB_MOO_Jailbreak_EscapeSpline((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (FLAG)MOO_Jailbreak_State_PrisonEscape_3cc56692-47ac-453a-8748-9c140dbee06f, (SPLINE)S_MOO_TieflingPrisonEscapeSpline_004_2c210111-b652-4167-ab56-ce819cfc9eae);

//END_REGION

//REGION ADs

DB_MOO_Jailbreak_ADs((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (DIALOGRESOURCE)MOO_Jailbreak_AD_Wulbren_e0c2afa6-8580-f353-bf14-7dd1496a0527);
DB_MOO_Jailbreak_ADs((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, (DIALOGRESOURCE)MOO_Jailbreak_AD_Gnome01_73cb0f8b-001a-01d7-26b1-b94ec669fedd);
DB_MOO_Jailbreak_ADs((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, (DIALOGRESOURCE)MOO_Jailbreak_AD_Gnome02_354429e5-bad7-5d99-d521-856df6fe2c5a);
DB_MOO_Jailbreak_ADs((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (DIALOGRESOURCE)MOO_Jailbreak_AD_FlirtyTiefling_35aeb3bf-aa75-8d78-2a61-8c0b2384978d);
DB_MOO_Jailbreak_ADs((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, (DIALOGRESOURCE)MOO_Jailbreak_AD_TieflingLover_ce6a2b21-707d-88fb-9a0a-d72a3f0d919b);
DB_MOO_Jailbreak_ADs((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, (DIALOGRESOURCE)MOO_Jailbreak_AD_ProdigyBrother_58cabccd-ba3d-7f9d-07ae-5ba66f0b4ea8);
DB_MOO_Jailbreak_ADs((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (DIALOGRESOURCE)MOO_Jailbreak_AD_ProdigySister_36aeb2a9-90d8-6aac-f167-42827c6a3cfd);

//END_REGION

//REGION Boat Leader

DB_MOO_Jailbreak_BoatLeaderPriority((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, 1);
DB_MOO_Jailbreak_BoatLeaderPriority((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, 2);
DB_MOO_Jailbreak_BoatLeaderPriority((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, 3);
DB_MOO_Jailbreak_BoatLeaderPriority((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, 4);
DB_MOO_Jailbreak_BoatLeaderPriority((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, 5);
DB_MOO_Jailbreak_BoatLeaderPriority((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, 6);
DB_MOO_Jailbreak_BoatLeaderPriority((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, 7);

//END_REGION

//REGION Freed Characters

DB_MOO_Jailbreak_FreedFlag((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (FLAG)MOO_Jailbreak_State_WulbrenFreed_f2b40211-ba53-43c1-a0a1-9827c5910018);
DB_MOO_Jailbreak_FreedFlag((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (FLAG)MOO_Jailbreak_State_SisterFreed_9c16b011-8adb-4049-9036-c530eae8795c);
DB_MOO_Jailbreak_FreedFlag((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, (FLAG)MOO_Jailbreak_State_BrotherFreed_9313203f-2e50-4069-b0b9-808ca58d759b);
DB_MOO_Jailbreak_FreedFlag((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (FLAG)MOO_Jailbreak_State_FlirtyFreed_637f73fa-c9fa-4114-ac13-8b05c495cce0);
DB_MOO_Jailbreak_FreedFlag((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, (FLAG)MOO_Jailbreak_State_LoverFreed_75a39abf-b7db-452d-991d-b158a4ea7d05);
DB_MOO_Jailbreak_FreedFlag((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, (FLAG)MOO_Jailbreak_State_Gnome01Freed_1a3c3868-a614-43d3-a4f1-3b8e9857e8a5);
DB_MOO_Jailbreak_FreedFlag((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, (FLAG)MOO_Jailbreak_State_Gnome02Freed_e97448ba-b0f6-457a-ba74-4cdb43964cb5);


//END_REGION

//REGION ADs

DB_MOO_Jailbreak_TieflingAD((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (DIALOGRESOURCE)MOO_Jailbreak_AD_ProdigySister_36aeb2a9-90d8-6aac-f167-42827c6a3cfd);
DB_MOO_Jailbreak_TieflingAD((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, (DIALOGRESOURCE)MOO_Jailbreak_AD_ProdigyBrother_58cabccd-ba3d-7f9d-07ae-5ba66f0b4ea8);
DB_MOO_Jailbreak_TieflingAD((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (DIALOGRESOURCE)MOO_Jailbreak_AD_FlirtyTiefling_35aeb3bf-aa75-8d78-2a61-8c0b2384978d);
DB_MOO_Jailbreak_TieflingAD((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, (DIALOGRESOURCE)MOO_Jailbreak_AD_TieflingLover_ce6a2b21-707d-88fb-9a0a-d72a3f0d919b);

//END_REGION

//REGION DEBUG (REMOVE)

DB_Dialogs(S_MOO_JailbreakToolDebug_63c509fd-0bf0-4da2-8434-3731e58a5502, DEBUG_MOO_Jailbreak_ToolInstructions_ff22f241-5f92-1fc7-f06b-346634ee8a2b);

//END_REGION

PROC_MOO_Jailbreak_Init();

SetFlag(MOO_Jailbreak_State_PlayersCanUseBoat_f3b7858e-8dc7-0e25-df9a-8147ce6894a9, NULL_00000000-0000-0000-0000-000000000000, 0);	//DEBUG: Seeing if this flow works
KBSECTION
//REGION INIT

PROC
PROC_MOO_Jailbreak_Init()
AND
DB_MOO_Jailbreak_SetupTieflings(1)
THEN
PROC_MOO_Jailbreak_SetupTieflings();

PROC
PROC_MOO_Jailbreak_SetupTieflings()
AND
NOT DB_HAV_SavingPrisoners_InHaven(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
NOT DB_MOO_Jailbreak_PotentialTiefling((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, (TRIGGER)S_MOO_PrisonerTieflingPos_001_9c279042-4963-490c-8f2e-6476c2aea716, (DIALOGRESOURCE)MOO_Jailbreak_ProdigySister_2f6d3c1c-f580-453a-8828-e0a8ec3cd9ff, "MOO_ProdigySister");
NOT DB_MOO_Jailbreak_PotentialTiefling((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, S_MOO_PrisonerTieflingPos_002_8bc30a20-b491-4d4a-990c-615fc851564a, (DIALOGRESOURCE)MOO_Jailbreak_ProdigyBrother_58346860-9653-c355-d12e-0642a7610bb9, "MOO_ProdigyBrother");

PROC
PROC_MOO_Jailbreak_SetupTieflings()
AND
DB_MOO_Jailbreak_PotentialTiefling(_Tiefling, _Position, _Dialog, _Config)
AND
NOT DB_PermaDefeated(_Tiefling)
THEN
PROC_GLO_DeleteAllWeapons(_Tiefling);
PROC_RemoveAllDialogEntriesForSpeaker(_Tiefling);
PROC_SetAnubisConfig(_Tiefling, _Config);
TeleportTo(_Tiefling, _Position, "");
SetOnStage(_Tiefling, 1);
LookFromTrigger(_Tiefling, _Position, 0);
SetFaction(_Tiefling, ACT2_MOO_Prisoners_415c10db-9541-4d9b-aaff-5c77f98a1189);
DB_Dialogs(_Tiefling, _Dialog);
PROC_MOO_Jailbreak_AddToPrison(_Tiefling, "Tieflings");
TriggerRegisterForCharacter(S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab, _Tiefling);

PROC
PROC_MOO_Jailbreak_SetupTieflings()
AND
DB_MOO_Jailbreak_Prisoner(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _)
THEN
SetFlag(MOO_Jailbreak_State_TieflingLeader_fa806828-c5a4-2691-ad46-be5e2ced9d67, S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, 0);

//Decide who's the leader of the tiefling cell
PROC
PROC_MOO_Jailbreak_SetupTieflings()
AND
NOT DB_MOO_Jailbreak_Prisoner(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _)
AND
NOT DB_MOO_Jailbreak_Prisoner(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, _)
AND
DB_MOO_Jailbreak_Prisoner(S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, _)
THEN
PROC_SetAnubisConfig(S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, "MOO_ProdigySister");
SetFlag(MOO_Jailbreak_State_TieflingLeader_fa806828-c5a4-2691-ad46-be5e2ced9d67, S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, 0);

PROC
PROC_MOO_Jailbreak_SetupTieflings()
AND
NOT DB_MOO_Jailbreak_Prisoner(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _)
AND
DB_MOO_Jailbreak_Prisoner(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, _)
THEN
PROC_SetAnubisConfig(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, "MOO_ProdigySister");
SetFlag(MOO_Jailbreak_State_TieflingLeader_fa806828-c5a4-2691-ad46-be5e2ced9d67, S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, 0);

IF
FlagSet((FLAG)MOO_Jailbreak_State_TieflingLeader_fa806828-c5a4-2691-ad46-be5e2ced9d67, _Tiefling, _)
THEN
SetEntityEventGuid(S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7, "MOO_PrisonBreak_SetTieflingLeader", _Tiefling, 1);

IF
DB_MOO_Jailbreak_Guards(_Guard)
THEN
DB_GLO_DefeatCounter(_Guard, "MOO_Jailbreak_Guards");
DB_CRIME_Guards_BlockPrisonerDialog((CHARACTER)_Guard);
//Guards won't talk to you if you're in jail

IF
DB_MOO_Jailbreak_Prisoner(_Character, _)
THEN
RequestSetSwarmGroup(_Character, "");
SetTag(_Character, ACT2_SHADOW_CURSE_IMMUNE_b47643e0-583c-4808-b108-f6d3b605b0a9);
TriggerRegisterForCharacter(S_MOO_Prison_SUB_b262cbea-f40c-47da-9f34-ba8ce5bf782b, _Character);

//Delaying registering the jailbreak guards DB for editor testing purposes.
IF
EnteredTrigger(_Guard, (TRIGGER)S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
DB_MOO_Jailbreak_PendingGuards(_Guard)
THEN
DB_MOO_Jailbreak_Guards(_Guard);

IF
DB_InRegion(_Guard, S_MOO_DisableEscapeArea_130ffe26-5c2c-4f5d-95a8-5b3e5480475c)
AND
NOT DB_GlobalFlag((FLAG)MOO_Jailbreak_State_GuardsCloseToGnomes_f5ed9e52-0804-4b3f-8b98-92a05b654c8a)
THEN
SetFlag(MOO_Jailbreak_State_GuardsCloseToGnomes_f5ed9e52-0804-4b3f-8b98-92a05b654c8a, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(MOO_Jailbreak_State_GuardsCloseToGnomes_f5ed9e52-0804-4b3f-8b98-92a05b654c8a)
AND
NOT DB_InRegion(_, S_MOO_DisableEscapeArea_130ffe26-5c2c-4f5d-95a8-5b3e5480475c)
THEN
ClearFlag(MOO_Jailbreak_State_GuardsCloseToGnomes_f5ed9e52-0804-4b3f-8b98-92a05b654c8a, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_StateSet_Defeated(_Guard)
AND
DB_MOO_Jailbreak_PendingGuards((CHARACTER)_Guard)
THEN
TriggerUnregisterForCharacter(S_MOO_DisableEscapeArea_130ffe26-5c2c-4f5d-95a8-5b3e5480475c, _Guard);

PROC
PROC_StateCleared_Defeated(_Guard)
AND
DB_MOO_Jailbreak_PendingGuards((CHARACTER)_Guard)
THEN
TriggerRegisterForCharacter(S_MOO_DisableEscapeArea_130ffe26-5c2c-4f5d-95a8-5b3e5480475c, _Guard);

IF
DB_MOO_Jailbreak_Prisoner(_Character, _)
THEN
PROC_MOO_Jailbreak_DisarmPrisoner(_Character);

PROC
PROC_MOO_Jailbreak_DisarmPrisoner((CHARACTER)_Character)
AND
GetEquippedWeapon(_Character, _Item)
THEN
RequestDelete(_Item);

PROC
PROC_MOO_Jailbreak_DisarmPrisoner((CHARACTER)_Character)
AND
GetEquippedShield(_Character, _Item)
THEN
RequestDelete(_Item);
//END_REGION

//REGION Prison group management

PROC
PROC_MOO_Jailbreak_AddToPrison((CHARACTER)_Character, (STRING)_Group)
THEN
DB_MOO_Jailbreak_Prisoner(_Character, _Group);

PROC
PROC_MOO_Jailbreak_AddToPrison(_Tiefling, "Tieflings")
AND
QRY_OnlyOnce("MOO_Jailbreak_TieflingsAdded")
THEN
DB_MOO_Jailbreak_Cell("Tieflings", (ITEM)S_MOO_CellGate_004_9758a245-c314-4099-94a5-506267cf2a1d, (FLAG)MOO_Jailbreak_State_TieflingCellOpen_3cd17384-b469-4922-99ab-97154f0e4f85, (ITEM)S_MOO_GnomeDestructibleWall_002_eb404040-7b2b-4542-8faa-dd119ff5e763, (FLAG)MOO_Jailbreak_State_TieflingPathOpen_7ac02a54-0147-f8fc-778a-88af57f9030d);
SetFlag(MOO_Jailbreak_State_TieflingsInJail_c00d4fef-f2d6-4308-9dda-19d34b6cbf3c, NULL_00000000-0000-0000-0000-000000000000, 0);
TriggerRegisterForItems(S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab);

IF
DB_MOO_Jailbreak_Prisoner(_Character, _Group)
THEN
DB_MOO_Jailbreak_TrackedPrisoner((CHARACTER)_Character, _Group);	//For journal tracking purposes
PROC_CharacterDisableAllCrimes(_Character, 1);
TriggerRegisterForCharacter(S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff, _Character);

IF
DB_MOO_Jailbreak_PendingGuards(_Guard)
THEN
TriggerRegisterForCharacter(S_MOO_ByCellsArea_6871bc1b-742f-4677-82ab-069d6a35cd5a, _Guard);
TriggerRegisterForCharacter(S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff, _Guard);
TriggerRegisterForCharacter(S_MOO_DisableEscapeArea_130ffe26-5c2c-4f5d-95a8-5b3e5480475c, _Guard);

PROC
PROC_StateSet_PermaDefeated(_Prisoner)
AND
DB_MOO_Jailbreak_Prisoner((CHARACTER)_Prisoner, _Group)
THEN
NOT DB_MOO_Jailbreak_Prisoner((CHARACTER)_Prisoner, _Group);
DB_MOO_Jailbreak_KilledPrisoner((CHARACTER)_Prisoner);
PROC_HAV_SavingPrisoners_PrisonerPermaDefeated(_Group);
PROC_MOO_Jailbreak_CheckEnd();

PROC
PROC_StateSet_PermaDefeated(_Prisoner)
AND
DB_MOO_Jailbreak_TrackedPrisoner((CHARACTER)_Prisoner, _Group)
THEN
NOT DB_MOO_Jailbreak_TrackedPrisoner((CHARACTER)_Prisoner, _Group);
PROC_HAV_SavingPrisoners_PrisonerPermaDefeated(_Group);

PROC
PROC_StateSet_PermaDefeated(_Prisoner)
AND
DB_MOO_Jailbreak_Escaping((CHARACTER)_Prisoner, _Plan)
THEN
NOT DB_MOO_Jailbreak_Escaping((CHARACTER)_Prisoner, _Plan);
PROC_MOO_Jailbreak_CheckEnd();

PROC
PROC_StateSet_PermaDefeated(_Guard)
AND
DB_MOO_Jailbreak_Guards((CHARACTER)_Guard)
THEN
NOT DB_MOO_Jailbreak_Guards((CHARACTER)_Guard);

//END_REGION

//REGION Prodigies 3-way dialog

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _Player)
AND
DB_MOO_Jailbreak_Prisoner((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _)
AND
NOT DB_GlobalFlag((FLAG)MOO_Jailbreak_Event_ProdigyIntro_69799630-8919-7518-a027-91295fe51eee)
AND
NOT DB_CantTalk((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b)
THEN
DB_SelectedDialog((DIALOGRESOURCE)MOO_Jailbreak_ProdigySister_2f6d3c1c-f580-453a-8828-e0a8ec3cd9ff, (CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _Player, (CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, _Player)
AND
DB_MOO_Jailbreak_Prisoner((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _)
AND
NOT DB_GlobalFlag((FLAG)MOO_Jailbreak_Event_ProdigyIntro_69799630-8919-7518-a027-91295fe51eee)
AND
NOT DB_CantTalk((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d)
THEN
DB_SelectedDialog((DIALOGRESOURCE)MOO_Jailbreak_ProdigySister_2f6d3c1c-f580-453a-8828-e0a8ec3cd9ff, (CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _Player, (CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b);


//END_REGION

//REGION Giving tools to gnomes.

IF
ItemEnteredTrigger(_Item, S_MOO_GnomeCell_25f1be2f-5203-4100-bc47-e286cd3f13b0, _)
AND
Exists(_Item,1)
AND
IsInInventory(_Item, 0)
THEN
PROC_MOO_Jailbreak_CheckValidTool(_Item);

PROC
PROC_MOO_Jailbreak_CheckValidTool((ITEM)_Item)
AND
IsWeapon(_Item,1)
AND
GetBaseWeaponDamageType(_Item, "Bludgeoning")
THEN
DB_MOO_Jailbreak_ToolOnGround(_Item);

PROC
PROC_MOO_Jailbreak_CheckValidTool((ITEM)_Item)
AND
IsWeapon(_Item,1)
AND
GetBaseWeaponDamageType(_Item, _Type)
AND
_Type != "Bludgeoning"
THEN
PROC_MOO_Jailbreak_TryWrongItemAD();

PROC
PROC_MOO_Jailbreak_TryWrongItemAD()
AND
NOT DB_MOO_Jailbreak_WrongItemCooldown(1)
THEN
PROC_TryStartAD(MOO_Jailbreak_AD_ToolRefused_7be83c11-0bdf-f711-be76-04193645e702, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
DB_MOO_Jailbreak_WrongItemCooldown(1);
ObjectTimerLaunch(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "MOO_Jailbreak_WrongItemTimer", 5000);

IF
ObjectTimerFinished(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "MOO_Jailbreak_WrongItemTimer")
THEN
NOT DB_MOO_Jailbreak_WrongItemCooldown(1);

IF
ItemLeftTrigger(_Tool, S_MOO_GnomeCell_25f1be2f-5203-4100-bc47-e286cd3f13b0, _)
AND
DB_MOO_Jailbreak_ToolOnGround(_Tool)
THEN
NOT DB_MOO_Jailbreak_ToolOnGround(_Tool);
SetEntityEvent(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "S_MOO_Jailbreak_ClearPickup");
PROC_MOO_Jailbreak_CheckForOtherToolOnGround();

IF
AddedTo(_Tool, _InventoryHolder, _)
AND
DB_MOO_Jailbreak_ToolOnGround((ITEM)_Tool)
AND
_InventoryHolder != S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf
THEN
NOT DB_MOO_Jailbreak_ToolOnGround(_Tool);
SetEntityEvent(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "S_MOO_Jailbreak_ClearPickup");
PROC_MOO_Jailbreak_CheckForOtherToolOnGround();

IF
DB_MOO_Jailbreak_ToolOnGround(_Tool)
THEN
SetDualEntityEvent(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _Tool, "MOO_Jailbreak_PickupTool");

PROC
PROC_MOO_Jailbreak_CheckForOtherToolOnGround()
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)MOO_Jailbreak_Event_GiveHammer_d77eec74-6db4-26d6-633a-313fb84b3fd8, _Player, _)
THEN
DB_MOO_Jailbreak_NoSpotPlayers(1);
ToInventory((ITEM)S_MOO_JailbreakHammer_b6925b99-4b14-48a1-89ca-eb328bb746df, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, 1, 0, 1);


IF
AddedTo((ITEM)_Item, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,_)
AND
IsWeapon(_Item, 1)
AND
GetBaseWeaponDamageType(_Item, "Bludgeoning")
THEN
PROC_TryStartAD((DIALOGRESOURCE)MOO_Jailbreak_AD_ToolAccepted_73267ee0-75fe-9520-7420-6f8b36017901, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
Equip(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _Item);
SetFlag(MOO_Jailbreak_State_GnomesHaveTools_740c0cea-1876-d336-7601-2418455692b1, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(MOO_Jailbreak_State_GnomesHaveTools_740c0cea-1876-d336-7601-2418455692b1, _, _)
AND
NOT DB_DialogNPCs(_, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _)
AND
NOT DB_MOO_Jailbreak_NoSpotPlayers(1)
AND
NOT DB_MOO_Jailbreak_Escaping(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _)
THEN
DB_SpotPlayers(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "MOO_Jailbreak_GotTools", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_MOO_Jailbreak_Escaping(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _)
THEN
PROC_SpotPlayers_StopSpotting(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "MOO_Jailbreak_GotTools");

PROC
PROC_SpotPlayers_Spotted(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "MOO_Jailbreak_GotTools", _Player)
AND
QRY_StartDialog((DIALOGRESOURCE)MOO_Jailbreak_Wulbren_70298fcd-3a9f-7bdb-b740-0fa46ea09902, (CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _Player)
THEN
DB_NOOP(1);


//END_REGION

//REGION A wall gets broken down

IF
DestroyedBy(_CellWall, _, _, _)
AND
DB_MOO_Jailbreak_Cell(_, _, _, _CellWall, _WallFlag)
THEN
SetFlag(_WallFlag, NULL_00000000-0000-0000-0000-000000000000, 0);

//Cancel the gnome's save tieflings route if that happens while they're saving tieflings.
IF
DestroyedBy(S_MOO_GnomeDestructibleWall_002_eb404040-7b2b-4542-8faa-dd119ff5e763, _, _, _)
AND
DB_MOO_Jailbreak_Escaping(_Gnome, MOO_Jailbreak_State_TieflingEscape_957c68da-c432-44af-a69d-a7b44da4b344)
THEN
PROC_MOO_Jailbreak_SetEscapeRoute(_Gnome, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee);

IF
FlagSet(_WallFlag, _, _)
AND
DB_MOO_Jailbreak_Cell(_Group, _, _, _, _WallFlag)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Group)
AND
NOT DB_MOO_Jailbreak_Escaping(_Prisoner, _)
THEN
PROC_MOO_Jailbreak_SetEscapeRoute(_Prisoner, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee);

//END_REGION

//REGION A prisoner cell is opened 

IF
Opened(_PrisonCellDoor)
AND
DB_MOO_Jailbreak_Cell(_, _PrisonCellDoor, _DoorFlag, _, _)
THEN
SetFlag(_DoorFlag, NULL_00000000-0000-0000-0000-000000000000, 0);

//Consider cell open if its door is destroyed
IF
DestroyedBy(_PrisonCellDoor, _, _, _)
AND
DB_MOO_Jailbreak_Cell(_, _PrisonCellDoor, _DoorFlag, _, _)
THEN
SetFlag(_DoorFlag, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(_DoorFlag, _, _)
AND
DB_MOO_Jailbreak_Cell(_Group, _, _DoorFlag, _, _)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Group)
AND
NOT DB_MOO_Jailbreak_Escaping(_Prisoner, _)
THEN
PROC_MOO_Jailbreak_SetEscapeRoute(_Prisoner, MOO_Jailbreak_State_PrisonEscape_3cc56692-47ac-453a-8748-9c140dbee06f);

//END_REGION

//REGION Escaping

IF
DB_MOO_Jailbreak_Escaping(_Character, _)
AND
DB_Is_InCombat(_Character, _)
THEN
SetFlag(MOO_Jailbreak_State_EscapingInCombat_50e87b8b-ff96-4855-bd99-b690ac937277, _Character, 0);

IF
DB_MOO_Jailbreak_Escaping(_Character, _)
AND
NOT DB_Is_InCombat(_Character, _)
THEN
ClearFlag(MOO_Jailbreak_State_EscapingInCombat_50e87b8b-ff96-4855-bd99-b690ac937277, _Character, 0);

IF
DB_MOO_Jailbreak_Escaping(_Character, _)
AND
DB_Is_InCombat(_Character, _)
THEN
SetEntityEvent(_Character, "ClearPeaceReturn", 1);

//Check if Gnomes have to save tieflings before making them escape to the boat.
PROC
PROC_MOO_Jailbreak_SetEscapeRoute(_Gnome, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee)
AND
DB_MOO_Jailbreak_Prisoner(_Gnome, "Gnomes")
AND
DB_GlobalFlag(MOO_Jailbreak_State_TieflingsInJail_c00d4fef-f2d6-4308-9dda-19d34b6cbf3c)
AND
DB_GlobalFlag(MOO_Jailbreak_State_GnomesHaveTools_740c0cea-1876-d336-7601-2418455692b1)
AND
IsDestroyed(S_MOO_GnomeDestructibleWall_002_eb404040-7b2b-4542-8faa-dd119ff5e763, 0)
THEN
PROC_MOO_Jailbreak_SetEscapeRoute(_Gnome, MOO_Jailbreak_State_TieflingEscape_957c68da-c432-44af-a69d-a7b44da4b344);
DB_MOO_Jailbreak_BlockSetEscapeRoute(_Gnome);

PROC
PROC_MOO_Jailbreak_SetEscapeRoute((CHARACTER)_Prisoner, (FLAG)_NewEscapeFlag)
AND
DB_MOO_Jailbreak_Escaping(_Prisoner, _EscapeFlag)
AND
_NewEscapeFlag != _EscapeFlag
AND
NOT DB_MOO_Jailbreak_BlockSetEscapeRoute(_Prisoner)
THEN
ClearFlag(_EscapeFlag, _Prisoner, 0);
SetEntityEvent(_Prisoner, "MOO_Jailbreak_CancelRoute");
NOT DB_MOO_Jailbreak_Escaping(_Prisoner, _EscapeFlag);

//A single gnome escaping means they are not in jail anymore.
PROC
PROC_MOO_Jailbreak_SetEscapeRoute(_Gnome, _EscapeFlag)
AND
DB_MOO_Jailbreak_Prisoner(_Gnome, "Gnomes")
AND
DB_GlobalFlag(MOO_Jailbreak_State_GnomesInJail_acbdd0cf-8b58-460c-adb6-fe883d886deb)
THEN
ClearFlag(MOO_Jailbreak_State_GnomesInJail_acbdd0cf-8b58-460c-adb6-fe883d886deb, NULL_00000000-0000-0000-0000-000000000000, 0);
TriggerUnregisterForItems(S_MOO_GnomeCell_25f1be2f-5203-4100-bc47-e286cd3f13b0);

//Tieflings leave jail if NOT on the boat escape route.
PROC
PROC_MOO_Jailbreak_SetEscapeRoute(_Tiefling, _EscapeFlag)
AND
DB_MOO_Jailbreak_Prisoner(_Tiefling, "Tieflings")
AND
_EscapeFlag != MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee
AND
DB_GlobalFlag(MOO_Jailbreak_State_TieflingsInJail_c00d4fef-f2d6-4308-9dda-19d34b6cbf3c)
THEN
ClearFlag(MOO_Jailbreak_State_TieflingsInJail_c00d4fef-f2d6-4308-9dda-19d34b6cbf3c, NULL_00000000-0000-0000-0000-000000000000, 0);
TriggerUnregisterForItems(S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab);

//Tieflings leave jail if on the boat escape route AND their back wall is open
PROC
PROC_MOO_Jailbreak_SetEscapeRoute(_Tiefling, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee)
AND
DB_MOO_Jailbreak_Prisoner(_Tiefling, "Tieflings")
AND
DB_GlobalFlag(MOO_Jailbreak_State_TieflingsInJail_c00d4fef-f2d6-4308-9dda-19d34b6cbf3c)
AND
DB_GlobalFlag(MOO_Jailbreak_State_TieflingPathOpen_7ac02a54-0147-f8fc-778a-88af57f9030d)
THEN
ClearFlag(MOO_Jailbreak_State_TieflingsInJail_c00d4fef-f2d6-4308-9dda-19d34b6cbf3c, NULL_00000000-0000-0000-0000-000000000000, 0);
TriggerUnregisterForItems(S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab);

//Tieflings will default to go to boat if gnomes are on their way to save them. Anubis will make them wait 
PROC
PROC_MOO_Jailbreak_SetEscapeRoute(_Gnome, MOO_Jailbreak_State_TieflingEscape_957c68da-c432-44af-a69d-a7b44da4b344)
AND
DB_MOO_Jailbreak_Prisoner(_Tiefling, "Tieflings")
AND
NOT DB_MOO_Jailbreak_Escaping(_Tiefling, _)
THEN
PROC_MOO_Jailbreak_SetEscapeRoute(_Tiefling, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee);

//Tieflings will leave their cell if it is open, are waiting for their wall to break but Wulbren is defeated.
IF
DB_MOO_Jailbreak_Escaping(_Tiefling, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee)
AND
DB_GlobalFlag(MOO_Jailbreak_State_TieflingCellOpen_3cd17384-b469-4922-99ab-97154f0e4f85)
AND
DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
IsDestroyed(S_MOO_GnomeDestructibleWall_002_eb404040-7b2b-4542-8faa-dd119ff5e763, 0)
THEN
PROC_MOO_Jailbreak_SetEscapeRoute(_Tiefling, MOO_Jailbreak_State_PrisonEscape_3cc56692-47ac-453a-8748-9c140dbee06f);

//Gnomes will abandon the tieflings if they are on their way to help them, but they have left without going to the boat.
IF
DB_MOO_Jailbreak_Escaping(_Gnome, MOO_Jailbreak_State_TieflingEscape_957c68da-c432-44af-a69d-a7b44da4b344)
AND
NOT DB_GlobalFlag((FLAG)MOO_Jailbreak_State_TieflingsInJail_c00d4fef-f2d6-4308-9dda-19d34b6cbf3c) //Only gets cleared in a way that would make it ok for Gnomes to abandon breaking their wall.
THEN
PROC_MOO_Jailbreak_SetEscapeRoute(_Gnome, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee);

PROC
PROC_MOO_Jailbreak_SetEscapeRoute(_Prisoner, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee)
THEN
SetFlag(MOO_Jailbreak_State_WaitingForBoat_a649ff0e-8456-4718-905d-966ba37999a8, _Prisoner, 0);

PROC
PROC_MOO_Jailbreak_SetEscapeRoute((CHARACTER)_Prisoner, (FLAG)_EscapeFlag)
AND
NOT DB_MOO_Jailbreak_Escaping(_Prisoner, _)
THEN
DB_MOO_Jailbreak_Escaping(_Prisoner, _EscapeFlag);

PROC
PROC_MOO_Jailbreak_SetEscapeRoute((CHARACTER)_Prisoner, (FLAG)_NewEscapeFlag)
AND
DB_MOO_Jailbreak_BlockSetEscapeRoute(_Prisoner)
THEN
NOT DB_MOO_Jailbreak_BlockSetEscapeRoute(_Prisoner);

IF
DB_MOO_Jailbreak_Escaping(_Prisoner, _)
AND
NOT DB_MOO_Jailbreak_Started(1)
AND
QRY_OnlyOnce("MOO_Jailbreak_Start")
THEN
PROC_SetRelationToPlayers((FACTION)ACT2_MOO_Prisoners_415c10db-9541-4d9b-aaff-5c77f98a1189, 100);
DB_MOO_Jailbreak_Started(1);
SetFlag(MOO_Jailbreak_Event_StartedJailbreak_4f376a54-949f-433c-b079-4ec14239ee6d, NULL_00000000-0000-0000-0000-000000000000, 0);


IF
DB_MOO_Jailbreak_Escaping(_Prisoner, _EscapeFlag)
THEN
SetFlag(MOO_Jailbreak_State_Escaping_139ced4b-4340-eb70-4a33-14279f87b2be, _Prisoner, 0);
SetFlag(_EscapeFlag, _Prisoner, 0);
PROC_MOO_Jailbreak_EscapeMove(_Prisoner, _EscapeFlag);

IF
FlagSet(MOO_Jailbreak_State_Escaping_139ced4b-4340-eb70-4a33-14279f87b2be, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, 0)
AND
QRY_OnlyOnce("MOO_Jailbreak_WulbrenEscapeAD")
THEN
ObjectTimerLaunch(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "MOO_Jailbreak_WulbrenEscapeADTimer", 1500);

IF
ObjectTimerFinished(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "MOO_Jailbreak_WulbrenEscapeADTimer")
THEN
SetFlag((FLAG)MOO_Jailbreak_Event_ADEscaping_7fede5d9-9619-7fc9-4e3c-94d8650a1180, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, 0);

IF
FlagSet((FLAG)MOO_Jailbreak_Event_ADEscaping_7fede5d9-9619-7fc9-4e3c-94d8650a1180, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, 0)
THEN
PROC_TryStartAD((DIALOGRESOURCE)MOO_Jailbreak_AD_Wulbren_e0c2afa6-8580-f353-bf14-7dd1496a0527, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);

IF
FlagSet(MOO_Jailbreak_State_Escaping_139ced4b-4340-eb70-4a33-14279f87b2be, _Tiefling, 0)
AND
GetFlag(MOO_Jailbreak_State_TieflingLeader_fa806828-c5a4-2691-ad46-be5e2ced9d67, _Tiefling, 1)
AND
QRY_OnlyOnce("MOO_Jailbreak_TieflingEscapeAD")
THEN
ObjectTimerLaunch(_Tiefling, "MOO_Jailbreak_TieflingEscapeADTimer", 1500);

IF
ObjectTimerFinished(_Tiefling, "MOO_Jailbreak_TieflingEscapeADTimer")
THEN
SetFlag(MOO_Jailbreak_Event_ADEscaping_7fede5d9-9619-7fc9-4e3c-94d8650a1180, _Tiefling, 0);

IF
FlagSet((FLAG)MOO_Jailbreak_Event_ADEscaping_7fede5d9-9619-7fc9-4e3c-94d8650a1180, _Tiefling, _)
AND
DB_MOO_Jailbreak_TieflingAD((CHARACTER)_Tiefling, _AD)
THEN
PROC_TryStartAD(_AD, _Tiefling);

IF
DB_MOO_Jailbreak_Escaping(_Prisoner, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee)
THEN
TriggerRegisterForCharacter(S_MOO_GetawayBoatArea_e5fc26b4-a348-4369-9cc2-ddbdeebfbf92, _Prisoner);

PROC
PROC_MOO_Jailbreak_EscapeMove((CHARACTER)_Prisoner, (FLAG)_EscapeFlag)
AND
DB_MOO_Jailbreak_EscapeSpline(_Prisoner, _EscapeFlag, _Spline)
THEN
SetEntityEventGuid(_Prisoner, "MOO_Jailbreak_SetRoute", _Spline);

IF
DB_MOO_Jailbreak_Escaping(_Prisoner, _Plan)
THEN
SetHasDialog(_Prisoner, 0);
DB_MOO_Jailbreak_BlockDialog(_Prisoner);

IF
DB_MOO_Jailbreak_BlockDialog(_Prisoner)
AND
NOT DB_MOO_Jailbreak_Escaping(_Prisoner, _)
THEN
SetHasDialog(_Prisoner, 1);
NOT DB_MOO_Jailbreak_BlockDialog(_Prisoner);

IF
DB_MOO_Jailbreak_BlockDialog(_Prisoner)
AND
DB_MOO_Jailbreak_AtBoat((CHARACTER)_Prisoner)
THEN
SetHasDialog(_Prisoner, 1);
NOT DB_MOO_Jailbreak_BlockDialog(_Prisoner);

//END_REGION

//REGION Guards spotting

PROC
PROC_GLO_DefeatCounter_AllDefeated("MOO_Jailbreak_Guards")
THEN
SetFlag(MOO_Jailbreak_State_GuardsCleanedOut_d7ca2c67-8eb1-db4d-a16c-2bc3c17deeb7, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION Guards ignore crimes done to prisoners and vice versa.

PROC
PROC_CharacterRegisterCrime_Success(_Char, _CrimeType, _StoryActionID, _Evidence, _Victim, _CrimeID)
AND
DB_MOO_Jailbreak_Prisoner(_Victim, _)
AND
DB_MOO_Jailbreak_Guards(_Guard)
THEN
CrimeIgnoreCrime(_CrimeID, _Guard);

PROC
PROC_CharacterRegisterCrime_Success(_Char, _CrimeType, _StoryActionID, _Evidence, _Victim, _CrimeID)
AND
DB_MOO_Jailbreak_Guards(_Victim)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _)
THEN
CrimeIgnoreCrime(_CrimeID, _Prisoner);

QRY
QRY_CRIME_Guards_GuardKillerExcludeWitness(_Prisoner)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _)
THEN
DB_NOOP(1);

//END_REGION

//REGION Talking and trading to prisoners is a crime

IF
DB_DialogPlayers(_ID, _Player, _)
AND
NOT DB_MOO_Jailbreak_SpeakingWithPrisoner((CHARACTER)_Player, _)
AND
DB_DialogNPCs(_ID, _Prisoner, _)
AND
DB_MOO_Jailbreak_Prisoner((CHARACTER)_Prisoner, _)
AND
NOT DB_GlobalFlag((FLAG)MOO_Jailbreak_State_PrisonerInterogationAllowed_ec463b99-d941-2f57-3c5c-de8f4b0db1e2)
AND
DB_InRegion((CHARACTER)_Player, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
NOT DB_InRegion((CHARACTER)_Player, (TRIGGER)S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7)
THEN
DB_MOO_Jailbreak_SpeakingWithPrisoner((CHARACTER)_Player, (CHARACTER)_Prisoner);

//Register crime normally if the prisoner is NOT Wulbren.
IF
DB_MOO_Jailbreak_SpeakingWithPrisoner(_Player, _Prisoner)
AND
_Prisoner != S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf
THEN
PROC_CharacterRegisterCrime((CHARACTER)_Player, "MOO_Jailbreak_SpokeWithPrisoner", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0);

//If prisoner is Wulbren, filter depending on tool status. If he has a tool, and you are caught speaking with him, guards will assume you gave it to him and start combat.
IF
DB_MOO_Jailbreak_SpeakingWithPrisoner(_Player, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
NOT DB_GlobalFlag((FLAG)MOO_Jailbreak_State_GnomesHaveTools_740c0cea-1876-d336-7601-2418455692b1)
THEN
PROC_CharacterRegisterCrime((CHARACTER)_Player, "MOO_Jailbreak_SpokeWithPrisoner", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_MOO_Jailbreak_SpeakingWithPrisoner(_Player, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_GlobalFlag((FLAG)MOO_Jailbreak_State_GnomesHaveTools_740c0cea-1876-d336-7601-2418455692b1)
THEN
PROC_CharacterRegisterCrime((CHARACTER)_Player, "MOO_Jailbreak_SpokeWithPrisonerAfterTrade", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_MOO_Jailbreak_SpeakingWithPrisoner(_Player, _Prisoner)
AND
NOT DB_DialogPlayers(_, _Player, _)
THEN
NOT DB_MOO_Jailbreak_SpeakingWithPrisoner(_Player, _Prisoner);
CharacterStopCrime(_Player, "MOO_Jailbreak_SpokeWithPrisoner", NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_Player, "MOO_Jailbreak_SpokeWithPrisonerAfterTrade", NULL_00000000-0000-0000-0000-000000000000);

//TODO: Expand to tiefling cell, too. Add flags to make sure prisoners are actually in cells.
QRY
QRY_MOO_Jailbreak_PosInPrisonerCell((REAL)_X, (REAL)_Y, (REAL)_Z)
AND
PositionIsInTrigger(_X, _Y, _Z, (TRIGGER)S_MOO_GnomeCell_25f1be2f-5203-4100-bc47-e286cd3f13b0, 1)
THEN
DB_NOOP(1);

//The only way an item enters the cell is if a player dropped it or threw it in there.
IF
ItemEnteredTrigger(_Item, S_MOO_GnomeCell_25f1be2f-5203-4100-bc47-e286cd3f13b0, (CHARACTER)_Player)
AND
DB_GlobalFlag(MOO_Jailbreak_State_GnomesInJail_acbdd0cf-8b58-460c-adb6-fe883d886deb)
AND
Exists(_Item,1)
AND
IsInInventory(_Item, 0)
AND
DB_Players(_Player)
AND
DB_InRegion((CHARACTER)_Player, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
IsInTrigger(_Player, S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7, 0)
THEN
PROC_CharacterRegisterCrime((CHARACTER)_Player, "MOO_Jailbreak_TradedWithPrisoner", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
ItemEnteredTrigger(_Item, S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab, (CHARACTER)_Player)
AND
DB_GlobalFlag(MOO_Jailbreak_State_TieflingsInJail_c00d4fef-f2d6-4308-9dda-19d34b6cbf3c)
AND
Exists(_Item,1)
AND
IsInInventory(_Item, 0)
AND
DB_Players(_Player)
AND
DB_InRegion((CHARACTER)_Player, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
IsInTrigger(_Player, S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7, 0)
THEN
PROC_CharacterRegisterCrime((CHARACTER)_Player, "MOO_Jailbreak_TradedWithPrisoner", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
CharacterOnCrimeSensibleActionNotification(_Guard, "SCL_Main_A_MOO", _ID, "CRIME_AttackNoDialog", _, _Criminal, _, _, _, 1)
AND
CrimeGetType(_ID, "MOO_Jailbreak_SpokeWithPrisonerAfterTrade")
THEN
PROC_ForceStopDialog(_Criminal);
//END_REGION

//REGION Guards looking out for escapees

IF
FlagSet(_Flag, _, _)
AND
DB_MOO_Jailbreak_EscapedPrisonerCheck(_CheckArea, _Flag)
AND
DB_MOO_Jailbreak_Guards(_Guard)
THEN
TriggerRegisterForCharacter(_CheckArea, _Guard);
TriggerRegisterForCharacter(S_MOO_CombatMissingPrisonerArea_daa78ec4-e946-4b9a-9d6e-da3ac3d6a5e5, _Guard);

//Out of combat
IF
DB_InRegion(_Guard, _OutOfJailArea)
AND
DB_MOO_Jailbreak_Guards(_Guard)
AND
NOT DB_Is_InCombat(_Guard, _)
AND
DB_MOO_Jailbreak_EscapedPrisonerCheck(_OutOfJailArea, _Flag)
AND
DB_GlobalFlag(_Flag)
AND
DB_MOO_Jailbreak_Cell(_, _Cell, _, _, _)
AND
NOT DB_MOO_Jailbreak_LeadInvestigatingGuard(_, _, _)
THEN
DebugText(_Guard, "Try Play AD! The Prisoners have escaped!");
PROC_MOO_Jailbreak_LookForPrisoners(_Guard, _Cell, _Flag);

//Caret spline movement.
IF
EntityEvent((CHARACTER)_Guard, "MOO_Jailbreak_CheckGnomeCell")
AND
DB_MOO_Jailbreak_Guards(_Guard)
AND
NOT DB_Is_InCombat(_Guard, _)
AND
DB_GlobalFlag(MOO_Jailbreak_State_GnomePathOpen_ef0aa614-2a18-7bd1-0f79-c3aca59ec3ab)
AND
DB_MOO_Jailbreak_Cell(_, _Cell, _, _, _)
AND
NOT DB_MOO_Jailbreak_LeadInvestigatingGuard(_, _, _)
THEN
DebugText(_Guard, "Try Play AD! The Prisoners have escaped!");
PROC_MOO_Jailbreak_LookForPrisoners(_Guard, _Cell, MOO_Jailbreak_State_GnomePathOpen_ef0aa614-2a18-7bd1-0f79-c3aca59ec3ab);

IF
EntityEvent((CHARACTER)_Guard, "MOO_Jailbreak_CheckGnomeCell")
AND
DB_MOO_Jailbreak_Guards(_Guard)
AND
NOT DB_Is_InCombat(_Guard, _)
AND
DB_GlobalFlag(MOO_Jailbreak_State_TieflingPathOpen_7ac02a54-0147-f8fc-778a-88af57f9030d)
AND
DB_MOO_Jailbreak_Cell(_, _Cell, _, _, _)
AND
NOT DB_MOO_Jailbreak_LeadInvestigatingGuard(_, _, _)
THEN
DebugText(_Guard, "Try Play AD! The Prisoners have escaped!");
PROC_MOO_Jailbreak_LookForPrisoners(_Guard, _Cell, MOO_Jailbreak_State_TieflingPathOpen_7ac02a54-0147-f8fc-778a-88af57f9030d);

//In Combat
IF
TurnStarted((CHARACTER)_Guard)
AND
DB_MOO_Jailbreak_Guards(_Guard)
AND
DB_MOO_Jailbreak_EscapedPrisonerCheck(_, _Flag)
AND
DB_InRegion(_Guard, S_MOO_CombatMissingPrisonerArea_daa78ec4-e946-4b9a-9d6e-da3ac3d6a5e5)
AND
DB_GlobalFlag(_Flag)
AND
DB_MOO_Jailbreak_Cell(_, _Cell, _, _, _)
AND
NOT DB_MOO_Jailbreak_LeadInvestigatingGuard(_, _, _)
THEN
DebugText(_Guard, "Try Play AD! The Prisoners have escaped!");
PROC_MOO_Jailbreak_LookForPrisoners(_Guard, _Cell, _Flag);

PROC
PROC_MOO_Jailbreak_LookForPrisoners((CHARACTER)_Eye,  (ITEM)_Cell, (FLAG)_Flag)
AND
DB_MOO_Alarm_ScryingEyes(_Eye)
THEN
PROC_MOO_Jailbreak_FindInvestigatingGuard(_Eye, _Cell, _Flag);

PROC
PROC_MOO_Jailbreak_LookForPrisoners((CHARACTER)_Guard,  (ITEM)_Cell, (FLAG)_Flag)
AND
NOT DB_MOO_Alarm_ScryingEyes(_Guard)
THEN
PROC_ForceStopDialog(_Guard);
PurgeOsirisQueue(_Guard, 0);
PROC_MOO_Jailbreak_FindInvestigatingGuard(_Guard, _Cell, _Flag);

PROC
PROC_MOO_Jailbreak_SendEyeToInvestigate((CHARACTER)_Guard)
AND
DB_MOO_Jailbreak_Guards(_Eye)
AND
DB_MOO_Alarm_ScryingEyes(_Eye)
AND
QRY_OnlyOnce("MOO_Jailbreak_EyeFollow")
THEN
TriggerRegisterForCharacter(S_MOO_GuardAndEyeDestinationArea_536666cb-c218-4388-a195-2881647a0d14, _Guard);
TriggerRegisterForCharacter(S_MOO_GuardAndEyeDestinationArea_536666cb-c218-4388-a195-2881647a0d14, _Eye);
PROC_Follow(_Eye, _Guard);

PROC
PROC_MOO_Jailbreak_FindInvestigatingGuard((CHARACTER)_Eye,  (ITEM)_Cell, (FLAG)_Flag)
AND
DB_MOO_Alarm_ScryingEyes(_Eye)
AND
DB_MOO_Jailbreak_Guards(S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7)
AND
NOT DB_MOO_Jailbreak_LeadInvestigatingGuard(_, _, _)
THEN
PROC_MOO_Jailbreak_TryForceUpdateGuard(S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7);
PROC_ForceStopDialog(S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7);
PurgeOsirisQueue(S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7);
DB_MOO_Jailbreak_LeadInvestigatingGuard((CHARACTER)S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7, _Cell, _Flag);
TriggerRegisterForCharacter(S_MOO_GuardAndEyeDestinationArea_536666cb-c218-4388-a195-2881647a0d14, S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7);
TriggerRegisterForCharacter(S_MOO_GuardAndEyeDestinationArea_536666cb-c218-4388-a195-2881647a0d14, _Eye);
PROC_Follow(_Eye, S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7);

PROC
PROC_MOO_Jailbreak_FindInvestigatingGuard((CHARACTER)_Eye,  (ITEM)_Cell, (FLAG)_Flag)
AND
DB_MOO_Alarm_ScryingEyes(_Eye)
AND
DB_MOO_Jailbreak_Guards(_Guard)
AND
NOT DB_MOO_Alarm_ScryingEyes(_Guard)
AND
NOT DB_MOO_Jailbreak_LeadInvestigatingGuard(_, _, _)
THEN
PROC_MOO_Jailbreak_TryForceUpdateGuard(_Guard);
PROC_ForceStopDialog(_Guard);
PurgeOsirisQueue(_Guard);
DB_MOO_Jailbreak_LeadInvestigatingGuard(_Guard, _Cell, _Flag);
TriggerRegisterForCharacter(S_MOO_GuardAndEyeDestinationArea_536666cb-c218-4388-a195-2881647a0d14, _Guard);
TriggerRegisterForCharacter(S_MOO_GuardAndEyeDestinationArea_536666cb-c218-4388-a195-2881647a0d14, _Eye);
PROC_Follow(_Eye, _Guard);

PROC
PROC_MOO_Jailbreak_FindInvestigatingGuard((CHARACTER)_Guard, (ITEM)_Cell, (FLAG)_Flag)
AND
DB_MOO_Jailbreak_Guards(_Guard)
AND
NOT DB_MOO_Alarm_ScryingEyes(_Guard)
AND
NOT DB_MOO_Jailbreak_LeadInvestigatingGuard(_, _, _)
THEN
PROC_MOO_Jailbreak_TryForceUpdateGuard(_Guard);
PROC_MOO_Jailbreak_TryAddWardenToInvestigation(_Guard);
PROC_ForceStopDialog(_Guard);
PurgeOsirisQueue(_Guard);
DB_MOO_Jailbreak_LeadInvestigatingGuard(_Guard, _Cell, _Flag);
PROC_MOO_Jailbreak_SendEyeToInvestigate(_Guard);

PROC
PROC_MOO_Jailbreak_TryAddWardenToInvestigation((CHARACTER)_Guard)
AND
_Guard != S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7
AND
DB_MOO_Jailbreak_Guards(S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7)
THEN
DB_MOO_Jailbreak_PriorityAccompanyingGuard(S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7);

IF
DB_InRegion(_Guard, S_MOO_GuardAndEyeDestinationArea_536666cb-c218-4388-a195-2881647a0d14)
AND
DB_InRegion(_Eye, S_MOO_GuardAndEyeDestinationArea_536666cb-c218-4388-a195-2881647a0d14)
AND
DB_Following(_Eye, _Guard)
THEN
PROC_StopFollow(_Eye);

IF
DB_MOO_Jailbreak_LeadInvestigatingGuard(_Guard, _Cell, _Flag)
AND
DB_MOO_Jailbreak_PriorityAccompanyingGuard(_Guard)
THEN
NOT DB_MOO_Jailbreak_PriorityAccompanyingGuard(_Guard);

IF
DB_MOO_Jailbreak_LeadInvestigatingGuard(_Guard, _Cell, _Flag)
THEN
SetEntityEvent(_Guard, "MOO_Jailbreak_GoToEmergencyLever");

IF
EntityEvent((CHARACTER)_Guard, "MOO_Jailbreak_GuardStartsEmergency")
THEN
DB_MOO_Jailbreak_EmergencyStarted(1);

IF
EntityEvent((CHARACTER)_Guard, "MOO_Jailbreak_GuardStartsEmergency")
AND
NOT DB_MOO_Prison_DisabledLever(S_MOO_EmergencyLever_976d70e4-edec-4a03-a004-a8e1a6ac86c1)
THEN
Use(_Guard, S_MOO_EmergencyLever_976d70e4-edec-4a03-a004-a8e1a6ac86c1, "");

IF
DB_MOO_Jailbreak_EmergencyStarted(1)
AND
DB_MOO_Jailbreak_LeadInvestigatingGuard(_Guard, _Cell, _Flag)
THEN
PROC_MOO_Jailbreak_GoInvestigateBoat(_Guard, _Cell);

PROC
PROC_MOO_Jailbreak_GoInvestigateBoat((CHARACTER)_Guard, (ITEM)_Cell)
AND
DB_MOO_Jailbreak_TunnelInvestigatePos(_Cell, _Pos)
THEN
SetDualEntityEvent(_Guard, _Pos, "MOO_Jailbreak_GoToCell");
PROC_MOO_Jailbreak_GetAccompanyingInvestigators(_Pos);

IF
EntityEvent((CHARACTER)_Guard, "MOO_Jailbreak_AtCell")
THEN
SetEntityEvent(_Guard, "MOO_Jailbreak_GoToDocks");

PROC
PROC_MOO_Jailbreak_GetAccompanyingInvestigators((TRIGGER)_Pos)
AND
DB_MOO_Jailbreak_PriorityAccompanyingGuard(_Guard)
THEN
DB_MOO_Jailbreak_AccompanyingInvestigatingGuard(_Guard, _Pos);
NOT DB_MOO_Jailbreak_PriorityAccompanyingGuard(_Guard);

//TODO: Randomize this
PROC
PROC_MOO_Jailbreak_GetAccompanyingInvestigators((TRIGGER)_Pos)
AND
DB_MOO_Jailbreak_Guards(_Guard)
AND
NOT DB_MOO_Alarm_ScryingEyes(_Guard)
AND
SysCount("DB_MOO_Jailbreak_AccompanyingInvestigatingGuard", 2, _FollowerSize)
AND
_FollowerSize < 3
AND
NOT DB_MOO_Jailbreak_LeadInvestigatingGuard(_Guard, _, _)
THEN
DB_MOO_Jailbreak_AccompanyingInvestigatingGuard(_Guard, _Pos);

IF
DB_MOO_Jailbreak_AccompanyingInvestigatingGuard(_Guard, _Pos)
THEN
PROC_MOO_Jailbreak_TryForceUpdateGuard((CHARACTER)_Guard);
SetDualEntityEvent(_Guard, _Pos, "MOO_Jailbreak_GoToCell");

IF
LeftTrigger(_Guard, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
DB_MOO_Jailbreak_Guards(_Guard)
AND
IsInTrigger(_Guard, S_MOO_Prison_SUB_b262cbea-f40c-47da-9f34-ba8ce5bf782b, 1)
THEN
DB_MOO_Jailbreak_GuardsInTunnel(1);

//Escape was not stealthy, guards relocate to tunnels permanently for behaviours.
IF
DB_MOO_Jailbreak_GuardsInTunnel(1)
AND
DB_OnlyOnce("MOO_Jailbreak_HostileToPlayers")
AND
NOT DB_GlobalFlag(MOO_Jailbreak_State_GuardsToTunnels_f58a2f57-252c-407c-ad51-e117961b3cbe)
THEN
SetFlag(MOO_Jailbreak_State_GuardsToTunnels_f58a2f57-252c-407c-ad51-e117961b3cbe, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_MOO_Jailbreak_TryForceUpdateGuard((CHARACTER)_Guard)
AND
IsForceUpdate(_Guard, 0)
THEN
DB_MOO_Jailbreak_ForceUpdatedGuard(_Guard);
SetForceUpdate(_Guard, 1);

PROC
PROC_MOO_Jailbreak_End()
AND
DB_MOO_Jailbreak_ForceUpdatedGuard(_Guard)
AND
IsForceUpdate(_Guard, 1)
THEN
NOT DB_MOO_Jailbreak_ForceUpdatedGuard(_Guard);
SetForceUpdate(_Guard, 0);

PROC
PROC_StateSet_PermaDefeated(_Guard)
AND
DB_MOO_Jailbreak_ForceUpdatedGuard((CHARACTER)_Guard)
AND
IsForceUpdate(_Guard, 1)
THEN
SetForceUpdate(_Guard, 0);
NOT DB_MOO_Jailbreak_ForceUpdatedGuard(_Guard);

//END_REGION

//REGION Adjusting relations and joining combat on sight

//A guard seeing a prisoner makes the factions permanently hostile to each other
IF
DB_Sees(_Guard, _Prisoner)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Group)
AND
DB_MOO_Jailbreak_Escaping(_Prisoner, _)
AND
DB_MOO_Jailbreak_Guards((CHARACTER)_Guard)
AND
DB_InRegion(_Guard, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
DB_InRegion(_Prisoner, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_AttackPrisoners")
THEN
PROC_MOO_Jailbreak_PrisonerHostility();
PROC_MOO_Jailbreak_ForceCharacterToCombatGuard(_Prisoner, _Guard);

//Same, but this occurs when both guards and prisoners are in the tunnels. Block this from happening in tiefling cell specifically.
IF
DB_Sees(_Guard, _Prisoner)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Group)
AND
DB_MOO_Jailbreak_Escaping(_Prisoner, _)
AND
DB_MOO_Jailbreak_Guards((CHARACTER)_Guard)
AND
NOT DB_InRegion(_Guard, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
NOT DB_InRegion(_Prisoner, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
NOT DB_InRegion(_Prisoner, S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_AttackPrisoners")
THEN
PROC_MOO_Jailbreak_PrisonerHostility();
PROC_MOO_Jailbreak_ForceCharacterToCombatGuard(_Prisoner, _Guard);

//A guard in tunnels that sees players in cells/tunnels make them hostile towards players.
IF
DB_MOO_Jailbreak_Guards(_Guard)
AND
DB_Sees(_Guard, _Player)
AND
DB_Players(_Player)
AND
NOT DB_InRegion(_Guard, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
NOT DB_InRegion(_Player, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_HostileToPlayers")
THEN
PROC_MOO_Jailbreak_PlayerHostility();
PROC_MOO_Jailbreak_ForceCharacterToCombatGuard(_Player, _Guard);

//A guard that sees players in front of cells/tunnels when they are about to go into tunnels goes hostile
IF
DB_MOO_Jailbreak_Guards(_Guard)
AND
DB_Sees(_Guard, _Player)
AND
DB_Players(_Player)
AND
DB_MOO_Jailbreak_Started(1)
AND
DB_MOO_Jailbreak_EmergencyStarted(1)
AND
DB_InRegion(_Player, S_MOO_ByCellsArea_6871bc1b-742f-4677-82ab-069d6a35cd5a)
AND
DB_InRegion(_Guard, S_MOO_ByCellsArea_6871bc1b-742f-4677-82ab-069d6a35cd5a)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_HostileToPlayers")
THEN
PROC_MOO_Jailbreak_PlayerHostility();
PROC_MOO_Jailbreak_ForceCharacterToCombatGuard(_Player, _Guard);

//A guard that sees players in front of cells/tunnels when they are in the tunnels goes hostile
IF
DB_MOO_Jailbreak_Guards(_Guard)
AND
DB_Sees(_Guard, _Player)
AND
DB_Players(_Player)
AND
DB_MOO_Jailbreak_Started(1)
AND
DB_MOO_Jailbreak_EmergencyStarted(1)
AND
DB_InRegion(_Player, S_MOO_ByCellsArea_6871bc1b-742f-4677-82ab-069d6a35cd5a)
AND
NOT DB_InRegion(_Guard, S_MOO_ByCellsArea_6871bc1b-742f-4677-82ab-069d6a35cd5a)
AND
NOT DB_InRegion(_Guard, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_HostileToPlayers")
THEN
PROC_MOO_Jailbreak_PlayerHostility();
PROC_MOO_Jailbreak_ForceCharacterToCombatGuard(_Player, _Guard);

//A guard in combat with a prisoner that sees a player will make guards hostile to players
IF
DB_MOO_Jailbreak_Guards(_Guard)
AND
DB_Is_InCombat(_Guard, _ID)
AND
DB_MOO_Jailbreak_Escaping(_Prisoner, _)
AND
DB_Is_InCombat(_Prisoner, _ID)
AND
DB_Sees((CHARACTER)_Guard, _Player)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_HostileToPlayers")
THEN
PROC_MOO_Jailbreak_PlayerHostility();
PROC_MOO_Jailbreak_ForceCharacterToCombatGuard(_Player, _Guard);

//A prisoner in combat with a guard that sees a player will make the player try to join combat.
IF
DB_MOO_Jailbreak_Guards(_Guard)
AND
DB_Is_InCombat(_Guard, _ID)
AND
DB_MOO_Jailbreak_Escaping(_Prisoner, _)
AND
DB_Is_InCombat(_Prisoner, _ID)
AND
DB_Sees(_Prisoner, _Player)
AND
DB_Players(_Player)
AND
NOT DB_Is_InCombat(_Player, _ID)
THEN
PROC_MOO_Jailbreak_PlayerHostility();
PROC_MOO_Jailbreak_ForceCharacterToCombatGuard(_Player, _Guard);


//A prisoner not in combat with a guard that sees a player in combat with a guard will try to join combat.
IF
DB_MOO_Jailbreak_Guards(_Guard)
AND
DB_Is_InCombat(_Guard, _ID)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _ID)
AND
DB_MOO_Jailbreak_Escaping((CHARACTER)_Prisoner, _)
AND
NOT DB_InRegion(_Guard, (TRIGGER)S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
NOT DB_InRegion(_Player, (TRIGGER)S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
DB_Sees((CHARACTER)_Prisoner, _Player)
AND
NOT DB_Is_InCombat(_Prisoner, _ID)
THEN
PROC_MOO_Jailbreak_PrisonerHostility();
PROC_MOO_Jailbreak_ForceCharacterToCombatGuard(_Prisoner, _Guard);

PROC
PROC_MOO_Jailbreak_ForceCharacterToCombatGuard((CHARACTER)_Character, (CHARACTER)_Guard)
AND
NOT DB_EnterCombatRequested(_Character)
THEN
PROC_TryStopDialogFor(_Character);
PROC_EnterCombat(_Character, _Guard);

PROC
PROC_MOO_Jailbreak_PlayerHostility()
AND
NOT DB_OnlyOnce("MOO_Jailbreak_HostileToPlayers")
THEN
DB_OnlyOnce("MOO_Jailbreak_HostileToPlayers");
PROC_SetRelationToPlayers(ACT2_MOO_Jailers_81d21487-9f41-4280-8e21-44495cdc762e, 0);

PROC
PROC_MOO_Jailbreak_PrisonerHostility()
AND
NOT DB_OnlyOnce("MOO_Jailbreak_AttackPrisoners")
THEN
PROC_SetRelationMutual(ACT2_MOO_Jailers_81d21487-9f41-4280-8e21-44495cdc762e, ACT2_MOO_Prisoners_415c10db-9541-4d9b-aaff-5c77f98a1189, 0);
DB_OnlyOnce("MOO_Jailbreak_AttackPrisoners");

//If a dock guard sees a prisoner and a player, become hostile to players.
//A guard seeing a prisoner makes the factions permanently hostile to each other
IF
DB_Sees(_Guard, _Prisoner)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Group)
AND
DB_MOO_Docks_Guards(_Guard)
AND
DB_Sees(_Guard, _PartyMember)
AND
DB_PartyMembers(_PartyMember)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_HostileDocks")
THEN
DB_OnlyOnce("MOO_Jailbreak_HostileDocks");
PROC_SetRelationToPlayers(ACT2_MOO_Docks_18e130ab-2ddb-a467-839e-8c0e388c6122, 0);

//END_REGION

//REGION Special Case: Gnomes have tools, players are fighting guards outside cell.

//Force Wulbren to enter combat if he can break out of cell but isn't hostile to guards yet.
IF
DB_MOO_Jailbreak_Guards(_Guard)
AND
DB_Is_InCombat(_Guard, _ID)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _ID)
AND
DB_Sees(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _Player)
AND
DB_MOO_Jailbreak_Prisoner(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "Gnomes")
AND
NOT DB_Is_InCombat(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _ID)
AND
NOT DB_MOO_Jailbreak_Escaping(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _)
AND
DB_GlobalFlag(MOO_Jailbreak_State_GnomesHaveTools_740c0cea-1876-d336-7601-2418455692b1)
THEN
SetCombatGroupID(_Guard, "MOO_Jailbreak_Guards");
SetCombatGroupID(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "MOO_Jailbreak_Guards");

//END_REGION

//REGION Emergency Lever Activate

PROC
PROC_MOO_Jailbreak_EmergencyLeverUsed()
THEN
DB_NOOP(1);	//Todo: play sound.

//END_REGION

//REGION Getaway Boat

IF
DB_MOO_Jailbreak_Escaping(_Prisoner, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee)
AND
NOT DB_MOO_Jailbreak_AtBoat(_Prisoner)
AND
NOT DB_MOO_Jailbreak_OnTheWayToBoat(_Prisoner)
AND
NOT DB_MOO_Jailbreak_BoatPrisoners(_Prisoner)
THEN
DB_MOO_Jailbreak_BoatPrisoners(_Prisoner);
DB_MOO_Jailbreak_OnTheWayToBoat(_Prisoner);

IF
DB_MOO_Jailbreak_OnTheWayToBoat(_Prisoner)
AND
NOT DB_MOO_Jailbreak_Escaping(_Prisoner, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee)
THEN
NOT DB_MOO_Jailbreak_OnTheWayToBoat(_Prisoner);

IF
EnteredTrigger(_Prisoner, S_MOO_GetawayBoatArea_e5fc26b4-a348-4369-9cc2-ddbdeebfbf92)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _)
AND
DB_MOO_Jailbreak_BoatInMOO(1)
THEN
DB_MOO_Jailbreak_AtBoat((CHARACTER)_Prisoner);
NOT DB_MOO_Jailbreak_OnTheWayToBoat((CHARACTER)_Prisoner);
SetEntityEvent(_Prisoner, "MOO_Jailbreak_AtBoat");

IF
DB_MOO_Jailbreak_Escaping(_Prisoner, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee)
THEN
DB_MOO_Jailbreak_StayInBoatAiTrigger(_Prisoner);
SetAiHint(_Prisoner, AI_HINT_UNIQUE_1902723d-dd16-4e7a-87d6-7b07f63add79);
SetStayInAiHints(_Prisoner, 1);

IF
DB_MOO_Jailbreak_StayInBoatAiTrigger(_Prisoner)
AND
NOT DB_MOO_Jailbreak_Escaping(_Prisoner, MOO_Jailbreak_State_BoatEscape_d55f6999-9f49-b742-95d9-12b6526ae5ee)
THEN
SetAiHint(_Prisoner, NULL_00000000-0000-0000-0000-000000000000);
SetStayInAiHints(_Prisoner, 0);

IF
EnteredTrigger(_Prisoner, S_MOO_GetawayBoatArea_e5fc26b4-a348-4369-9cc2-ddbdeebfbf92)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _)
AND
NOT DB_MOO_Jailbreak_BoatInMOO(1)
THEN
PROC_MOO_Jailbreak_SetEscapeRoute(_Prisoner, MOO_Jailbreak_State_BackupEscape_c2f1053d-c56e-d34d-c200-82d7c8267e7f);

//END_REGION

//REGION Breaking chains

//A prisoner at the boat tries to fill one of the chain breaking spots.
IF
DB_MOO_Jailbreak_AtBoat(_Prisoner)
AND
DB_MOO_Jailbreak_ChainPositions(_Chain, _Position, NULL_00000000-0000-0000-0000-000000000000)
AND
DB_MOO_Jailbreak_Chains(_Chain)
AND
NOT DB_MOO_Jailbreak_ChainPositions(_, _, _Prisoner)
AND
NOT QRY_MOO_Jailbreak_IsOnChains(_Prisoner)
THEN
TriggerRegisterForCharacter(S_MOO_BreakingChainsArea_5c1358d1-21e8-485b-a6f3-10acedb72bd7, _Prisoner);
DB_MOO_Jailbreak_ChainPositions(_Chain, _Position, _Prisoner);
ClearFlag(MOO_Jailbreak_State_WaitingForBoat_a649ff0e-8456-4718-905d-966ba37999a8, _Prisoner, 0);
NOT DB_MOO_Jailbreak_ChainPositions(_Chain, _Position, NULL_00000000-0000-0000-0000-000000000000);
PROC_MOO_Jailbreak_TryFindWeapon(_Prisoner);
SetDualEntityEvent(_Prisoner, _Chain, "MOO_Jailbreak_SetChainAttackTarget");
SetDualEntityEvent(_Prisoner, _Position, "MOO_Jailbreak_SetChainPos");

PROC
PROC_MOO_Jailbreak_TryFindWeapon((CHARACTER)_Prisoner)
AND
DB_MOO_Jailbreak_ChainWeapons(_Prisoner, _Weapon)
AND
IsInInventory(_Weapon, 0)
THEN
SetDualEntityEvent(_Prisoner, _Weapon, "MOO_Jailbreak_SetWeapon");

IF
AddedTo(_Weapon, _Prisoner, _)
AND
DB_MOO_Jailbreak_ChainWeapons((CHARACTER)_Prisoner, (ITEM)_Weapon)
THEN
Equip((CHARACTER)_Prisoner, (ITEM)_Weapon);


QRY
QRY_MOO_Jailbreak_IsOnChains((CHARACTER)_Prisoner)
AND
DB_MOO_Jailbreak_ChainPositions(_, _, _Prisoner)
THEN
DB_NOOP(1);

PROC
PROC_StateSet_PermaDefeated(_Prisoner)
AND
DB_MOO_Jailbreak_BoatPrisoners((CHARACTER)_Prisoner)
THEN
NOT DB_MOO_Jailbreak_BoatPrisoners((CHARACTER)_Prisoner);

PROC
PROC_StateSet_Defeated(_Prisoner)
AND
DB_MOO_Jailbreak_ChainPositions(_Chain, _Position, (CHARACTER)_Prisoner)
THEN
NOT DB_MOO_Jailbreak_ChainPositions(_Chain, _Position, (CHARACTER)_Prisoner);
DB_MOO_Jailbreak_ChainPositions(_Chain, _Position, (CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_MOO_Jailbreak_ClearChain((ITEM)_Chain)
THEN
NOT DB_MOO_Jailbreak_Chains(_Chain);

PROC
PROC_MOO_Jailbreak_ClearChain((ITEM)_Chain)
AND
DB_MOO_Jailbreak_ChainPositions(_Chain, _Position, _Prisoner)
AND
_Prisoner != NULL_00000000-0000-0000-0000-000000000000
THEN
NOT DB_MOO_Jailbreak_ChainPositions(_Chain, _Position, _Prisoner);

IF
DestroyedBy(_Chain, _, _, _)
AND
DB_MOO_Jailbreak_Chains(_Chain)
THEN
NOT DB_MOO_Jailbreak_Chains(_Chain);
PROC_MOO_Jailbreak_ClearChain(_Chain);
PROC_MOO_Jailbreak_CheckBoatReady();

//Boat becomes ready when chains are broken.
PROC
PROC_MOO_Jailbreak_CheckBoatReady()
AND
NOT DB_MOO_Jailbreak_Chains(_)
THEN
SetFlag(MOO_Jailbreak_State_BoatReady_8fb4753f-14fc-8477-9dbf-26b606830bcb, NULL_00000000-0000-0000-0000-000000000000, 0);

//Evaluate boat leader when a new prisoner arrives at the boat.
IF
DB_MOO_Jailbreak_AtBoat(_Prisoner)
AND
DB_GlobalFlag((FLAG)MOO_Jailbreak_State_BoatReady_8fb4753f-14fc-8477-9dbf-26b606830bcb)
THEN
PROC_MOO_Jailbreak_FindBoatLeader();

IF
TurnStarted((CHARACTER)_Prisoner)
AND
DB_MOO_Jailbreak_ChainPositions(_Chain, _Position, _Prisoner)
AND
NOT DB_MOO_Jailbreak_ChainBreakAD(_Prisoner)
AND
DB_MOO_Jailbreak_CanCombatChainBreakAD(1)
THEN
NOT DB_MOO_Jailbreak_CanCombatChainBreakAD(1);
DB_MOO_Jailbreak_ChainBreakAD(_Prisoner);
SetFlag(MOO_Jailbreak_Event_ADPrepareBoatCombat_97f4eb38-63ac-fb09-83bb-6945216ecfaa, _Prisoner, 0);

IF
CombatRoundStarted(_ID, _)
AND
DB_Is_InCombat(_Prisoner, _ID)
AND
DB_MOO_Jailbreak_ChainPositions(_, _, (CHARACTER)_Prisoner)
AND
NOT DB_MOO_Jailbreak_CanCombatChainBreakAD(1)
THEN
DB_MOO_Jailbreak_CanCombatChainBreakAD(1);

//END_REGION

//REGION Boat leader

PROC
PROC_MOO_Jailbreak_FindBoatLeader()
THEN
DB_MOO_Jailbreak_TempBoatLeader((CHARACTER)NULL_00000000-0000-0000-0000-000000000000, 1000);

PROC
PROC_MOO_Jailbreak_FindBoatLeader()
AND
DB_MOO_Jailbreak_BoatPrisoners(_Prisoner)
AND
NOT DB_Defeated(_Prisoner)
AND
DB_MOO_Jailbreak_BoatLeaderPriority(_Prisoner, _NewPriority)
AND
DB_MOO_Jailbreak_TempBoatLeader(_Leader, _CurrentPriority)
AND
_NewPriority < _CurrentPriority
THEN
NOT DB_MOO_Jailbreak_TempBoatLeader(_Leader, _CurrentPriority);
DB_MOO_Jailbreak_TempBoatLeader(_Prisoner, _NewPriority);

PROC
PROC_MOO_Jailbreak_FindBoatLeader()
AND
DB_MOO_Jailbreak_TempBoatLeader(_Leader, _Priority)
AND
_Leader != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_MOO_Jailbreak_BoatLeader(_Leader, _Priority);
NOT DB_MOO_Jailbreak_TempBoatLeader(_Leader, _Priority);

PROC
PROC_MOO_Jailbreak_FindBoatLeader()
AND
DB_MOO_Jailbreak_BoatLeader(_Prisoner, _)
THEN
SetFlag(MOO_Jailbreak_State_BoatLeader_6d868d94-d360-6638-6dd6-6c34b25c07c8, _Prisoner, 0);

PROC
PROC_StateSet_Defeated(_Prisoner)
AND
DB_MOO_Jailbreak_BoatLeader((CHARACTER)_Prisoner, _Priority)
THEN
ClearFlag(MOO_Jailbreak_State_BoatLeader_6d868d94-d360-6638-6dd6-6c34b25c07c8, _Prisoner, 0);
NOT DB_MOO_Jailbreak_BoatLeader((CHARACTER)_Prisoner, _Priority);
PROC_MOO_Jailbreak_FindBoatLeader();

PROC
PROC_StateSet_PermaDefeated(_Character)
AND
DB_MOO_Jailbreak_BoatLeaderPriority((CHARACTER)_Character, _Priority)
THEN
NOT DB_MOO_Jailbreak_BoatLeaderPriority((CHARACTER)_Character, _Priority);

IF
EntityEvent((CHARACTER)_Character, "MOO_Jailbreak_BecomeBoatLeader")
THEN
PROC_MOO_Jailbreak_ForceBoatLeader(_Character);

//Force a character to be the boat leader in script. This is to ensure last character that breaks chains in script is boat leader.
PROC
PROC_MOO_Jailbreak_ForceBoatLeader((CHARACTER)_Character)
AND
DB_MOO_Jailbreak_BoatLeader((CHARACTER)_Leader, _Priority)
THEN
ClearFlag(MOO_Jailbreak_State_BoatLeader_6d868d94-d360-6638-6dd6-6c34b25c07c8, _Leader, 0);
NOT DB_MOO_Jailbreak_BoatLeader(_Leader, _Priority);
SetFlag(MOO_Jailbreak_State_BoatLeader_6d868d94-d360-6638-6dd6-6c34b25c07c8, _Character, 0);
DB_MOO_Jailbreak_BoatLeader(_Character, -1);

//TODO: Currently the escape is AD driven, which is fine assuming the character needs to actively work on the boat for it to leave.
//However, should still establish some fallbacks and track turns manually and make the boat leave anyway if it takes too long.
IF
TurnStarted((CHARACTER)_BoatLeader)
AND
DB_MOO_Jailbreak_BoatLeader(_BoatLeader, _)
THEN
PROC_MOO_Jailbreak_BoatLeaderTurn();

PROC
PROC_MOO_Jailbreak_BoatLeaderTurn()
THEN
DB_NOOP(1);

//END_REGION

//REGION Force start boat dialog PEACE

IF
DB_GlobalFlag((FLAG)MOO_Jailbreak_State_BoatReady_8fb4753f-14fc-8477-9dbf-26b606830bcb)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_MOO_GetawayBoatDialogArea_030094d9-ec6f-4717-903a-0cb27c5cea2f)
AND
NOT DB_CantTalk(_Player)
AND
DB_MOO_Jailbreak_BoatLeader(_Leader, _)
AND
NOT DB_DialogNPCs(_, _Leader, _)
AND
NOT DB_Is_InCombat(_Leader, _)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_BoatDialog")
THEN
DB_OnlyOnce("MOO_Jailbreak_BoatDialog");
DB_MOO_Jailbreak_AddTriggerPlayersToBoatDialog(1);	//Only players close enough should see this dialog
PROC_MOO_Jailbreak_StartBoatDialogForPlayer(_Player);

IF
EnteredCombat((CHARACTER)_Leader, _)
AND
DB_MOO_Jailbreak_BoatLeader(_Leader, _)
AND
DB_OnlyOnce("MOO_Jailbreak_BoatDialog")
THEN
NOT DB_OnlyOnce("MOO_Jailbreak_BoatDialog");

//END_REGION

//REGION Force start boat dialog COMBAT

IF
EnteredCombat((CHARACTER)_Leader, _ID)
AND
DB_MOO_Jailbreak_BoatLeader(_Leader, _)
AND
DB_GlobalFlag(MOO_Jailbreak_State_BoatReady_8fb4753f-14fc-8477-9dbf-26b606830bcb)
THEN
DB_MOO_Jailbreak_ChangeLeaderToFirstTurner(1);

IF
TurnStarted((CHARACTER)_Prisoner)
AND
NOT DB_MOO_Jailbreak_BoatLeader(_Prisoner, _)
AND
DB_MOO_Jailbreak_AtBoat(_Prisoner)
AND
DB_MOO_Jailbreak_ChangeLeaderToFirstTurner(1)
THEN
PROC_MOO_Jailbreak_ForceBoatLeader(_Prisoner);

//Start the dialog once the leader has finished saying that the boat is ready to leave (or that they are leaving without players).
IF
AutomatedDialogEnded(_AD, _)
AND
DB_MOO_Jailbreak_ADs(_Leader, _AD)
AND
DB_MOO_Jailbreak_BoatLeader(_Leader, _)
AND
DB_GlobalFlag(MOO_Jailbreak_Event_ForceBoatLeave_f97b9312-f1ec-735a-3dba-558fe6a976b0)
THEN
DB_MOO_Jailbreak_AddAllPlayersToBoatDialog(1);	//Everyone in prison should get to see this.
PROC_MOO_Jailbreak_StartBoatCombatDialog();

//This is a version of the dialog where all players must see the boat leave, regardless of where they are in prison.
//Start dialog with any player in prison. Prioritize those close enough.
PROC
PROC_MOO_Jailbreak_StartBoatCombatDialog()
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_MOO_Prison_SUB_b262cbea-f40c-47da-9f34-ba8ce5bf782b)
AND
NOT DB_InRegion(_Player, S_MOO_OutOfJailArea_fd04d6ad-9d59-4904-933b-e61e44fec1ff)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_BoatDialog")
THEN
DB_OnlyOnce("MOO_Jailbreak_BoatDialog");
PROC_MOO_Jailbreak_StartBoatDialogForPlayer(_Player);

PROC
PROC_MOO_Jailbreak_StartBoatCombatDialog()
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_MOO_Prison_SUB_b262cbea-f40c-47da-9f34-ba8ce5bf782b)
AND
NOT DB_OnlyOnce("MOO_Jailbreak_BoatDialog")
THEN
DB_OnlyOnce("MOO_Jailbreak_BoatDialog");
PROC_MOO_Jailbreak_StartBoatDialogForPlayer(_Player);
//END_REGION

//REGION Clicking on boat

IF
UseStarted(_Player, S_MOO_EscapeBoat_dd67802b-bb74-474c-a670-87d04a784db7)
AND
DB_GlobalFlag(MOO_Jailbreak_State_BoatReady_8fb4753f-14fc-8477-9dbf-26b606830bcb)
AND
DB_MOO_Jailbreak_BoatLeader(_, _)
THEN
SetFlag(MOO_Jailbreak_Event_PlayerClickedOnBoat_d80f8a4b-643c-369e-b10f-425055d7b4aa, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_MOO_Jailbreak_StartBoatDialogForPlayer(_Player);

IF
UseStarted(_Player, S_MOO_EscapeBoat_dd67802b-bb74-474c-a670-87d04a784db7)
AND
DB_GlobalFlag(MOO_Jailbreak_State_BoatReady_8fb4753f-14fc-8477-9dbf-26b606830bcb)
AND
NOT DB_MOO_Jailbreak_BoatLeader(_, _)
THEN
SetFlag(MOO_Jailbreak_Event_PlayerClickedOnBoat_d80f8a4b-643c-369e-b10f-425055d7b4aa, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_MOO_Jailbreak_StartBoatDialogForPlayer(_Player);

IF
UseStarted(_Player, S_MOO_EscapeBoat_dd67802b-bb74-474c-a670-87d04a784db7)
AND
NOT DB_GlobalFlag(MOO_Jailbreak_State_BoatReady_8fb4753f-14fc-8477-9dbf-26b606830bcb)
AND
NOT DB_MOO_Jailbreak_BoatPAD(1)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)MOO_Jailbreak_PAD_CheckingOutBoat_144e2801-126a-524c-e5c2-2e1160f0edf3, _Player)
THEN
DB_MOO_Jailbreak_BoatPAD(1);

IF
AutomatedDialogEnded(MOO_Jailbreak_PAD_CheckingOutBoat_144e2801-126a-524c-e5c2-2e1160f0edf3,_)
AND
DB_MOO_Jailbreak_BoatPAD(1)
THEN
NOT DB_MOO_Jailbreak_BoatPAD(1);
//END_REGION

//REGION Boat dialog

PROC
PROC_MOO_Jailbreak_StartBoatDialogForPlayer((CHARACTER)_Player)
AND
NOT DB_GlobalFlag(MOO_Jailbreak_State_BoatLeavesPier_d0727183-7ab9-410e-8d2b-4f28afe544be)
AND
NOT QRY_StartDialogCustom_Fixed(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3, _Player, 0, 0, 0, 0)
THEN
SetFlag(MOO_Jailbreak_State_BoatLeavesPier_d0727183-7ab9-410e-8d2b-4f28afe544be, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_MOO_Jailbreak_BoatLeaves();

PROC
PROC_StartDialog_AddExtraSpeakers(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3, _ID)
THEN
PROC_MOO_Jailbreak_FindBoatLeader();

PROC
PROC_StartDialog_AddExtraSpeakers(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3, _ID)
THEN
PROC_MOO_Jailbreak_AddExtrasToBoatDialog(_ID);

//Add all other players in prison to boat leave dialog. 
//TODO: Differentiate between players close enough to leave with boat and players that are not???
//Presumably players that are too far away should see the scene and their combats paused, but they shouldn't be shown on the boat. They may need different speaker slots.
IF
DB_DialogName(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3, _ID)
AND
DB_MOO_Jailbreak_AddAllPlayersToBoatDialog(1)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_MOO_Prison_SUB_b262cbea-f40c-47da-9f34-ba8ce5bf782b)
AND
NOT DB_DialogPlayers(_ID, _Player, _)
THEN
DialogAddActor(_ID, _Player);

IF
DB_DialogName(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3, _ID)
AND
DB_MOO_Jailbreak_AddTriggerPlayersToBoatDialog(1)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_MOO_GetawayBoatDialogArea_030094d9-ec6f-4717-903a-0cb27c5cea2f)
AND
NOT DB_DialogPlayers(_ID, _Player, _)
THEN
DialogAddActor(_ID, _Player);

//Add all leaving prisoners close to boat dialog.
PROC
PROC_MOO_Jailbreak_AddExtrasToBoatDialog((INTEGER)_ID)
AND
DB_MOO_Jailbreak_BoatPrisoners(_Prisoner)
AND
NOT DB_Defeated(_Prisoner)
THEN
PROC_DialogAddSpeakingActor(_ID, _Prisoner, 1);

PROC
PROC_MOO_Jailbreak_AddExtrasToBoatDialog((INTEGER)_ID)
AND
DB_DialogRequestCache_SpeakerList_Players(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3, _ID, _Player, _)
AND
CharacterGetOwner(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (CHARACTER)_Player)
THEN
PROC_DialogAddSpeakingActor(_ID, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1);

//Track instigating player. Used for follow-up dialog in HAV.
IF
FlagSet(MOO_Jailbreak_State_BoatPlayer_cd3bbc8e-1b23-045d-1e02-be25c3a8de6c, _Player, _ID)
THEN
DB_MOO_Jailbreak_BoatPlayer((CHARACTER)_Player);

IF
DialogEnded(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3, 0)
AND
DB_MOO_Jailbreak_BoatPlayer(_Player)
THEN
ClearFlag(MOO_Jailbreak_State_BoatPlayer_cd3bbc8e-1b23-045d-1e02-be25c3a8de6c, _Player, 0);

//END_REGION

//REGION Combat pausing

IF
DB_DialogPlayers(_ID, _Player, _)
AND
DB_DialogName(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3, _ID)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
QRY_OnlyOnce("MOO_Jailbreak_PauseBoatCombat")
THEN
PauseCombat(_CombatID);
DB_MOO_Jailbreak_PausedCombat(_CombatID);

PROC
PROC_MOO_Jailbreak_ResumeCombats()
AND
DB_MOO_Jailbreak_PausedCombat(_CombatID)
THEN
NOT DB_MOO_Jailbreak_PausedCombat(_CombatID);
ResumeCombat(_CombatID);

//END_REGION

//REGION Player boat control

IF
FlagSet(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958, _, _)
THEN
ClearFlag(MOO_Jailbreak_State_PlayersCanUseBoat_f3b7858e-8dc7-0e25-df9a-8147ce6894a9, NULL_00000000-0000-0000-0000-000000000000, 0);
//END_REGION

//REGION Actual boat leaving

IF
DialogEnded(MOO_Jailbreak_Boat_f006e87e-8b07-d6d8-0b3b-cff42b4129f3, _)
AND
DB_GlobalFlag(MOO_Jailbreak_State_BoatLeavesPier_d0727183-7ab9-410e-8d2b-4f28afe544be)
THEN
NOT DB_MOO_Jailbreak_AddAllPlayersToBoatDialog(1);
NOT DB_MOO_Jailbreak_AddTriggerPlayersToBoatDialog(1);
PROC_MOO_Jailbreak_CheckBoatDeparture();
PROC_MOO_Jailbreak_ResumeCombats();

PROC
PROC_MOO_Jailbreak_CheckBoatDeparture()
AND
NOT DB_GlobalFlag(MOO_Jailbreak_Event_BoatLeavesWithoutPlayers_c39e9bb8-6270-ed21-240b-00dda1d5edfc)
THEN
PROC_MOO_Jailbreak_BoatLeaves();
PROC_MOO_Jailbreak_BoatBringsNearbyPlayers();

PROC
PROC_MOO_Jailbreak_CheckBoatDeparture()
AND
DB_GlobalFlag(MOO_Jailbreak_Event_BoatLeavesWithoutPlayers_c39e9bb8-6270-ed21-240b-00dda1d5edfc)
THEN
PROC_MOO_Jailbreak_BoatLeaves();

PROC
PROC_MOO_Jailbreak_BoatLeaves()
AND
NOT DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
AND
DB_MOO_Jailbreak_BoatPrisoners(_Prisoner)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Group)
AND
NOT DB_Defeated(_Prisoner)
AND
NOT QRY_MOO_Jailbreak_CantEscapeWithBoat(_Prisoner)
THEN
LeaveCombat(_Prisoner);
ClearFlag(MOO_Jailbreak_State_Escaping_139ced4b-4340-eb70-4a33-14279f87b2be, _Prisoner, 0);
PROC_MOO_Jailbreak_ClearPrisoner(_Prisoner, "Boat", 0);
SetEntityEvent(_Prisoner, "MOO_Jailbreak_GoToHaven_Boat");
SetOnStage(_Prisoner, 0);

PROC
PROC_MOO_Jailbreak_BoatLeaves()
AND
DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
AND
DB_MOO_Jailbreak_BoatPrisoners(_Prisoner)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Group)
AND
NOT DB_Defeated(_Prisoner)
AND
NOT QRY_MOO_Jailbreak_CantEscapeWithBoat(_Prisoner)
THEN
LeaveCombat(_Prisoner);
ClearFlag(MOO_Jailbreak_State_Escaping_139ced4b-4340-eb70-4a33-14279f87b2be, _Prisoner, 0);
PROC_MOO_Jailbreak_ClearPrisoner(_Prisoner, "Boat", 1);
SetEntityEvent(_Prisoner, "MOO_Jailbreak_WaitForEpilogue");
SetOnStage(_Prisoner, 0);

//Tieflings on boat escape are supposed to wait for their wall to crumble by gnomes. If the wall is still up and they're on boat escape it means there was a problem, they can't leave.
QRY
QRY_MOO_Jailbreak_CantEscapeWithBoat((CHARACTER)_Prisoner)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, "Tieflings")
AND
IsDestroyed(S_MOO_GnomeDestructibleWall_002_eb404040-7b2b-4542-8faa-dd119ff5e763, 0)
THEN
DB_NOOP(1);

PROC
PROC_MOO_Jailbreak_BoatLeaves()
THEN
NOT DB_MOO_Jailbreak_BoatInMOO(1);

PROC
PROC_MOO_Jailbreak_BoatLeaves()
AND
DB_MOO_Jailbreak_BoatParts(_BoatPart)
THEN
SetOnStage(_BoatPart, 0);

//END_REGION

//REGION Backup route leads into dock escape

IF
EntityEvent(_Prisoner, "MOO_Jailbreak_ToDocks")
THEN
PROC_CharacterMoveTo((CHARACTER)_Prisoner, S_MOO_Jailbreak_GroundEscapePos_001_374e15c2-38d4-49a5-b957-5aab360fe39c, "Run", "MOO_Jailbreak_AtDocks");

IF
EntityEvent(_Prisoner, "MOO_Jailbreak_AtDocks")
THEN
PROC_MOO_Jailbreak_SetEscapeRoute((CHARACTER)_Prisoner, MOO_Jailbreak_State_DockEscape_7621f16f-7820-26c3-4ab0-1288dc5b26e4);

//END_REGION

//REGION Escape through the docks

IF
EntityEvent((CHARACTER)_Prisoner, "MOO_Jailbreak_LeaveMoonriseOutOfCombat")
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Group)
THEN
PROC_MOO_Jailbreak_RoadEscape(_Prisoner, _Group);

//Actual escaping
IF
EntityEvent((CHARACTER)_Prisoner, "MOO_Jailbreak_LeaveMoonrise")
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Group)
THEN
PROC_MOO_Jailbreak_RoadEscape(_Prisoner, _Group);

PROC
PROC_MOO_Jailbreak_RoadEscape((CHARACTER)_Prisoner, (STRING)_Group)
AND
NOT DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
THEN
ClearFlag(MOO_Jailbreak_State_Escaping_139ced4b-4340-eb70-4a33-14279f87b2be, _Prisoner, 0);
SetCanJoinCombat(_Prisoner, 0);
SetCanFight(_Prisoner, 0);
LeaveCombat(_Prisoner);
PROC_MOO_Jailbreak_ClearPrisoner(_Prisoner, "Road", 0);
SetEntityEvent(_Prisoner, "MOO_Jailbreak_GoToHaven_Road");
PROC_DisappearOutOfSightTo(_Prisoner, S_MOO_Jailbreak_DocksDisappearPos_76867b84-034c-4f9b-bfe2-b06181877df7, "Run", 1, "");

PROC
PROC_MOO_Jailbreak_RoadEscape((CHARACTER)_Prisoner, (STRING)_Group)
AND
DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
THEN
ClearFlag(MOO_Jailbreak_State_Escaping_139ced4b-4340-eb70-4a33-14279f87b2be, _Prisoner, 0);
SetCanJoinCombat(_Prisoner, 0);
SetCanFight(_Prisoner, 0);
LeaveCombat(_Prisoner);
PROC_MOO_Jailbreak_ClearPrisoner(_Prisoner, "Road", 1);
SetEntityEvent(_Prisoner, "MOO_Jailbreak_WaitForEpilogue");
PROC_DisappearOutOfSightTo(_Prisoner, S_MOO_Jailbreak_DocksDisappearPos_76867b84-034c-4f9b-bfe2-b06181877df7, "Run", 1, "");

IF
EntityEvent((CHARACTER)_Prisoner, "MOO_Jailbreak_TryLeaveAD")
THEN
PROC_MOO_Jailbreak_TryLeaveAD(_Prisoner);

PROC
PROC_MOO_Jailbreak_TryLeaveAD((CHARACTER)_Prisoner)
AND
NOT DB_MOO_Jailbreak_BlockLeaveAD(1)
THEN
//PROC_TryStartAD(_AD, _Prisoner);
DB_MOO_Jailbreak_BlockLeaveAD(1);
TimerLaunch("MOO_Jailbreak_LeaveADTimer", 5000);

IF
TimerFinished("MOO_Jailbreak_LeaveADTimer")
THEN
NOT DB_MOO_Jailbreak_BlockLeaveAD(1);

//END_REGION

//REGION Combat groups

PROC
PROC_MOO_Jailbreak_ClearPrisoner((CHARACTER)_Prisoner, (STRING)_ReturnType, (INTEGER)_IsEpilogue)
THEN
SetCombatGroupID(_Prisoner, "");

IF
LeftCombat((CHARACTER)_Character, _)
AND
DB_PartyMembers(_Character)
AND
GetCombatGroupID(_Character, "MOO_Jailbreak_Guards")
THEN
SetCombatGroupID(_Character, "");

PROC
PROC_MOO_Jailbreak_End()
AND
DB_PartyMembers(_Character)
AND
GetCombatGroupID(_Character, "MOO_Jailbreak_Guards")
THEN
SetCombatGroupID(_Character, "");

IF
DB_MOO_Jailbreak_Escaping(_Character, _Route)
AND
DB_InRegion(_Character, S_MOO_Prison_SUB_b262cbea-f40c-47da-9f34-ba8ce5bf782b)
THEN
DB_MOO_Jailbreak_InCombatGroup(_Character);
SetCombatGroupID(_Character, "MOO_Jailbreak_Guards");

IF
DB_MOO_Jailbreak_InCombatGroup(_Character)
AND
NOT DB_MOO_Jailbreak_Escaping(_Character, _)
THEN
NOT DB_MOO_Jailbreak_InCombatGroup(_Character);
SetCombatGroupID(_Character, "");

IF
DB_MOO_Jailbreak_InCombatGroup(_Character)
AND
NOT DB_InRegion(_Character, S_MOO_Prison_SUB_b262cbea-f40c-47da-9f34-ba8ce5bf782b)
THEN
NOT DB_MOO_Jailbreak_InCombatGroup(_Character);
SetCombatGroupID(_Character, "");

//Guards that enter combat during jailbreak sequence are all in the same combat group
IF
DB_MOO_Jailbreak_Started(1)
AND
DB_MOO_Jailbreak_Guards(_Guard)
AND
DB_Is_InCombat(_Guard, _)
THEN
SetCombatGroupID(_Guard, "MOO_Jailbreak_Guards");

IF
DB_MOO_Jailbreak_Guards(_Guard)
AND
NOT DB_Is_InCombat(_Guard, _)
THEN
SetCombatGroupID(_Guard, "");

IF
Saw(_Player, _Prisoner, _)
AND
DB_Players(_Player)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _)
AND
DB_Is_InCombat(_Prisoner, _)
AND
GetCombatGroupID(_Prisoner, "MOO_Jailbreak_Guards")
THEN
SetCombatGroupID(_Player, "MOO_Jailbreak_Guards");

IF
LostSightOf(_Player, _Prisoner)
AND
DB_Players(_Player)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _)
AND
NOT QRY_MOO_Jailbreak_SeeAnyPrisonerInCombat(_Player)
THEN
SetCombatGroupID(_Player, "");

QRY
QRY_MOO_Jailbreak_SeeAnyPrisonerInCombat((CHARACTER)_Player)
AND
DB_MOO_Jailbreak_Escaping(_Prisoner, _)
AND
DB_Is_InCombat(_Prisoner, _)
AND
GetCombatGroupID(_Prisoner, "MOO_Jailbreak_Guards")
AND
DB_Sees(_Player, _Prisoner)
THEN
DB_NOOP(1);

//END_REGION

//REGION Transition out of Prison

PROC
PROC_MOO_Jailbreak_ClearPrisoner((CHARACTER)_Prisoner, (STRING)_ReturnType, (INTEGER)_IsEpilogue)
THEN
PROC_CharacterEnableAllCrimes(_Prisoner);
DB_MOO_Jailbreak_QueueEscape(_Prisoner);

//One character has to go to the epilogue, so HAV is unavailable. Adapt accordingly for journal.
PROC
PROC_MOO_Jailbreak_ClearPrisoner((CHARACTER)_Prisoner, (STRING)_ReturnType, 1)
THEN
NOT DB_HAV_SavingPrisoners_JournalEpilogueReturn(0);
DB_HAV_SavingPrisoners_JournalEpilogueReturn(1);

PROC
PROC_MOO_Jailbreak_ClearPrisoner((CHARACTER)_Prisoner, (STRING)_ReturnType, 1)
THEN
DB_MOO_Jailbreak_EpilogueReturn(_Prisoner, _ReturnType);

PROC
PROC_MOO_Jailbreak_ClearPrisoner((CHARACTER)_Prisoner, (STRING)_ReturnType, 0)
THEN
DB_HAV_SavingPrisoners_PendingReturn(_Prisoner, _ReturnType);

//Haven invalidated while characters are waiting to return.
IF
DB_HAV_SavingPrisoners_PendingReturn(_Prisoner, _ReturnType)
AND
DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
THEN
NOT DB_HAV_SavingPrisoners_PendingReturn(_Prisoner, _ReturnType);
DB_MOO_Jailbreak_EpilogueReturn(_Prisoner, _ReturnType);

PROC
PROC_MOO_Jailbreak_ClearPrisoner((CHARACTER)_Prisoner, (STRING)_ReturnType, (INTEGER)_IsEpilogue)
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _Type)
THEN
NOT DB_MOO_Jailbreak_Prisoner(_Prisoner, _Type);

PROC
PROC_MOO_Jailbreak_ClearPrisoner((CHARACTER)_Prisoner, (STRING)_ReturnType, (INTEGER)_IsEpilogue)
AND
DB_MOO_Jailbreak_Escaping(_Prisoner, _Flag)
THEN
SetTag(_Prisoner, CIVILIAN_71120d5d-3853-46e4-9762-33f59aa6b4ae);
ClearFlag(_Flag, _Prisoner, 0);
NOT DB_MOO_Jailbreak_Escaping(_Prisoner, _Flag);

IF
WentOnStage(_Prisoner, 0)
AND
DB_MOO_Jailbreak_QueueEscape((CHARACTER)_Prisoner)
THEN
NOT DB_MOO_Jailbreak_QueueEscape((CHARACTER)_Prisoner);
PROC_MOO_Jailbreak_Escaped(_Prisoner);

PROC
PROC_HAV_SavingPrisoners_CharacterReturns((CHARACTER)_Prisoner, (STRING)_Type)
AND
DB_MOO_Jailbreak_QueueEscape((CHARACTER)_Prisoner)
THEN
PROC_MOO_Jailbreak_Escaped(_Prisoner);
NOT DB_MOO_Jailbreak_QueueEscape((CHARACTER)_Prisoner);

PROC
PROC_MOO_Jailbreak_Escaped((CHARACTER)_Prisoner)
AND
DB_MOO_Jailbreak_FreedFlag(_Prisoner, _Flag)
THEN
SetFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_MOO_Jailbreak_Escaped((CHARACTER)_Prisoner)
THEN
ClearTag(_Prisoner, ACT2_SHADOW_CURSE_IMMUNE_b47643e0-583c-4808-b108-f6d3b605b0a9);
SetCanJoinCombat((CHARACTER)_Prisoner, 1);
SetCanFight((CHARACTER)_Prisoner, 1);

PROC
PROC_MOO_Jailbreak_Escaped((CHARACTER)_Prisoner)
THEN
PROC_MOO_Jailbreak_CheckEnd();

//END_REGION

//REGION Leaders walk to visible players close to their cell

IF
DB_InRegion(_Player, S_MOO_CloseToTieflingsArea_6139cf6a-9e00-4ccb-8b92-733437a35e57)
AND
NOT DB_GlobalFlag(MOO_Jailbreak_State_PlayerCloseToTieflings_1ec918a4-f07b-4750-96a1-7e27d78298d2)
AND
DB_Players(_Player)
AND
NOT DB_HiddenCharacters(_Player, _)
AND
NOT DB_InRegion(_, S_MOO_CloseToTieflingsArea_002_00eaf664-f945-467a-8c63-9c8961d544c3)
THEN
SetFlag(MOO_Jailbreak_State_PlayerCloseToTieflings_1ec918a4-f07b-4750-96a1-7e27d78298d2, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(MOO_Jailbreak_State_PlayerCloseToTieflings_1ec918a4-f07b-4750-96a1-7e27d78298d2)
AND
NOT DB_InRegion(_, S_MOO_CloseToTieflingsArea_6139cf6a-9e00-4ccb-8b92-733437a35e57)
THEN
ClearFlag(MOO_Jailbreak_State_PlayerCloseToTieflings_1ec918a4-f07b-4750-96a1-7e27d78298d2, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_InRegion(_Player, S_MOO_CloseToGnomesArea_ce80db02-4f1d-4d3a-91fc-1fbb92f07866)
AND
NOT DB_GlobalFlag(MOO_Jailbreak_State_PlayerCloseToGnomes_50174da0-77e4-44d6-98c7-66c444672eb2)
AND
DB_Players(_Player)
AND
NOT DB_HiddenCharacters(_Player, _)
AND
NOT DB_InRegion(_, S_MOO_CloseToGnomesArea_001_bb9032ca-6a7c-40b5-acff-eb0d3a9cb129)
THEN
SetFlag(MOO_Jailbreak_State_PlayerCloseToGnomes_50174da0-77e4-44d6-98c7-66c444672eb2, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(MOO_Jailbreak_State_PlayerCloseToGnomes_50174da0-77e4-44d6-98c7-66c444672eb2)
AND
NOT DB_InRegion(_, S_MOO_CloseToGnomesArea_ce80db02-4f1d-4d3a-91fc-1fbb92f07866)
THEN
ClearFlag(MOO_Jailbreak_State_PlayerCloseToGnomes_50174da0-77e4-44d6-98c7-66c444672eb2, NULL_00000000-0000-0000-0000-000000000000, 0);
//END_REGION

//REGION End of Jailbreak

//Prisoners get left behind and Jailbreak ends when all characters leave
IF
LeftTrigger(_Player, S_MOO_MoonriseTowerNoRoof_SUB_54d40f5d-34e6-42fd-829b-bb2f5facfcda)
AND
DB_Players(_Player)
AND
DB_MOO_Jailbreak_Started(1)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_MOO_MoonriseTowerNoRoof_SUB_54d40f5d-34e6-42fd-829b-bb2f5facfcda)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_MOO_PrisonJailbreak_SUB_d066ff4c-bc01-4e46-97ad-f641ccd61929)
THEN
SetFlag(MOO_Jailbreak_State_BoatLeavesPier_d0727183-7ab9-410e-8d2b-4f28afe544be, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_MOO_Jailbreak_BoatLeaves();
PROC_MOO_Jailbreak_LeftPrisonersBehind();

IF
LeftTrigger(_Player, S_MOO_PrisonJailbreak_SUB_d066ff4c-bc01-4e46-97ad-f641ccd61929)
AND
DB_Players(_Player)
AND
DB_MOO_Jailbreak_Started(1)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_MOO_MoonriseTowerNoRoof_SUB_54d40f5d-34e6-42fd-829b-bb2f5facfcda)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_MOO_PrisonJailbreak_SUB_d066ff4c-bc01-4e46-97ad-f641ccd61929)
THEN
SetFlag(MOO_Jailbreak_State_BoatLeavesPier_d0727183-7ab9-410e-8d2b-4f28afe544be, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_MOO_Jailbreak_BoatLeaves();
PROC_MOO_Jailbreak_LeftPrisonersBehind();

PROC
PROC_MOO_Jailbreak_LeftPrisonersBehind()
THEN
PROC_MOO_Jailbreak_KillRemainingPrisoners();

PROC
PROC_MOO_Jailbreak_KillRemainingPrisoners()
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _)
AND
NOT DB_COL_NecromancerLab_AllZombies(_Prisoner)
THEN
Die(_Prisoner, DEATHTYPE.DoT, 1);
DB_MOO_Jailbreak_QueueOubliettePrisonerMove(_Prisoner);

PROC
PROC_MOO_Jailbreak_KillRemainingPrisoners()
AND
DB_PartyMembers(_PartyMember)
AND
IsInTrigger(_PartyMember, S_MOO_Oubliette_SUB_c6f54de0-1c8f-4cf8-bcf9-b13c8f53b05b, 1)
THEN
DB_MOO_Jailbreak_WaitForEmptyOubliette(1);

PROC
PROC_MOO_Jailbreak_KillRemainingPrisoners()
AND
NOT DB_MOO_Jailbreak_WaitForEmptyOubliette(1)
AND
DB_MOO_Jailbreak_QueueOubliettePrisonerMove(_Prisoner)
THEN
PROC_COL_TadpolingCentre_PurgeCleanUp(_Prisoner);
NOT DB_MOO_Jailbreak_QueueOubliettePrisonerMove(_Prisoner);

IF
LeftTrigger(_Player, S_MOO_Oubliette_SUB_c6f54de0-1c8f-4cf8-bcf9-b13c8f53b05b)
AND
DB_MOO_Jailbreak_WaitForEmptyOubliette(1)
AND
NOT QRY_CheckOtherPlayersInTrigger(_Player, S_MOO_Oubliette_SUB_c6f54de0-1c8f-4cf8-bcf9-b13c8f53b05b)
AND
DB_MOO_Jailbreak_QueueOubliettePrisonerMove(_Prisoner)
THEN
PROC_COL_TadpolingCentre_PurgeCleanUp(_Prisoner);
NOT DB_MOO_Jailbreak_QueueOubliettePrisonerMove(_Prisoner);

PROC
PROC_MOO_Jailbreak_End()
THEN
SetFlag(MOO_Jailbreak_State_Over_ce186cbb-3c45-8cb1-cc4a-b64196290ec3, NULL_00000000-0000-0000-0000-000000000000, 0);
NOT DB_MOO_Jailbreak_Started(1);

PROC
PROC_MOO_Jailbreak_CheckEnd()
AND
DB_MOO_Jailbreak_Started(1)
AND
NOT DB_MOO_Jailbreak_Prisoner(_, _)
AND
NOT DB_MOO_Jailbreak_Escaping(_, _)
THEN
PROC_MOO_Jailbreak_End();
PROC_HAV_SavingPrisoners_ReturnPendingEscapees();

//END_REGION

//REGION Being in tiefling cell

IF
EnteredTrigger(_Player, S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab)
AND
DB_Players(_Player)
THEN
SetFlag((FLAG)MOO_Jailbreak_State_PlayerInTieflingCell_35945fbb-3ce5-0ea7-dc83-2dbf0befa985, _Player, 0);

IF
LeftTrigger(_Player, S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab)
AND
DB_Players(_Player)
THEN
ClearFlag((FLAG)MOO_Jailbreak_State_PlayerInTieflingCell_35945fbb-3ce5-0ea7-dc83-2dbf0befa985, _Player, 0);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
