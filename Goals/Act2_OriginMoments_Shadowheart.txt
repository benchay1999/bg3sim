Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION SCL - Night Orchid Picking

DB_PlayerHasTemplateItem((ITEMROOT)QUEST_SCL_NightOrchid_11f6de17-4682-419c-808f-8a328d2cce15, (FLAG)ORI_Shadowheart_State_HasNightOrchid_94f3d032-ebb0-4cf3-9774-4bf01bf587dd);
DB_GiveTemplateFromPlayerDialogEvent((ITEMROOT)QUEST_SCL_NightOrchid_11f6de17-4682-419c-808f-8a328d2cce15, (FLAG)ORI_Shadowheart_Event_GiveNightOrchid_b732f49f-880c-4d51-bc11-2358c04b8b10, NULL_00000000-0000-0000-0000-000000000000, 1);

//END_REGION

//REGION TWN - STATUE SIGHT

DB_OneShot_ADTrigger((TRIGGER)S_TWN_StatueSight_d6f840e7-f481-456a-b71d-056b1b85eb04, (DIALOGRESOURCE)TWN_Shadowheart_PAD_StatueSight_d02ee9e4-2763-3e49-363b-a56c61dfab38, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
PROC_TriggerRegisterForParty((TRIGGER)S_TWN_StatueSight_d6f840e7-f481-456a-b71d-056b1b85eb04);

//END_REGION

//REGION Selune Graves

DB_KnowledgeCheckItem_AD("TWN_SeluneGrave_GraveCheck", S_TWN_SeluneMarker_000_f53ccf5b-9159-43bf-a7d4-d4c1132837b2, "Religion", (DIFFICULTYCLASS)Act2_Medium_89f0acd4-346f-479d-8b7a-1a3eb5382f6d, (DIALOGRESOURCE)TWN_SeluneGrave_PAD_IdentifiedGrave_78bab1b5-4557-888f-ae6d-388d4858b3e9, (FLAG)TWN_SeluneGrave_State_PassedCheck_b3849b04-8f5b-4c9c-aa69-e566e8758ce8);
DB_KnowledgeCheckItem_AD("TWN_SeluneGrave_GraveCheck", S_TWN_SeluneMarker_001_493f620f-afb1-49c8-a234-8ee579edc617, "Religion", (DIFFICULTYCLASS)Act2_Medium_89f0acd4-346f-479d-8b7a-1a3eb5382f6d, (DIALOGRESOURCE)TWN_SeluneGrave_PAD_IdentifiedGrave_78bab1b5-4557-888f-ae6d-388d4858b3e9, (FLAG)TWN_SeluneGrave_State_PassedCheck_b3849b04-8f5b-4c9c-aa69-e566e8758ce8);
DB_KnowledgeCheckItem_AD("TWN_SeluneGrave_GraveCheck", S_TWN_SeluneMarker_002_febe2494-58fc-4f7d-bda6-2bb22b6df15d, "Religion", (DIFFICULTYCLASS)Act2_Medium_89f0acd4-346f-479d-8b7a-1a3eb5382f6d, (DIALOGRESOURCE)TWN_SeluneGrave_PAD_IdentifiedGrave_78bab1b5-4557-888f-ae6d-388d4858b3e9, (FLAG)TWN_SeluneGrave_State_PassedCheck_b3849b04-8f5b-4c9c-aa69-e566e8758ce8);
DB_KnowledgeCheckItem_AD("TWN_SeluneGrave_GraveCheck", S_TWN_SeluneMarker_003_37834cda-72ae-4c76-b8a7-804c463dd581, "Religion", (DIFFICULTYCLASS)Act2_Medium_89f0acd4-346f-479d-8b7a-1a3eb5382f6d, (DIALOGRESOURCE)TWN_SeluneGrave_PAD_IdentifiedGrave_78bab1b5-4557-888f-ae6d-388d4858b3e9, (FLAG)TWN_SeluneGrave_State_PassedCheck_b3849b04-8f5b-4c9c-aa69-e566e8758ce8);
DB_KnowledgeCheckItem_AD("TWN_SeluneGrave_GraveCheck", S_TWN_SeluneMarker_004_df56e4f4-b114-46cd-8ecf-a2966445619a, "Religion", (DIFFICULTYCLASS)Act2_Medium_89f0acd4-346f-479d-8b7a-1a3eb5382f6d, (DIALOGRESOURCE)TWN_SeluneGrave_PAD_IdentifiedGrave_78bab1b5-4557-888f-ae6d-388d4858b3e9, (FLAG)TWN_SeluneGrave_State_PassedCheck_b3849b04-8f5b-4c9c-aa69-e566e8758ce8);
DB_KnowledgeCheckItem_AD("TWN_SeluneGrave_GraveCheck", S_TWN_SeluneMarker_005_cb6d3ab9-c8bc-4d81-a06a-2df53a9ec43d, "Religion", (DIFFICULTYCLASS)Act2_Medium_89f0acd4-346f-479d-8b7a-1a3eb5382f6d, (DIALOGRESOURCE)TWN_SeluneGrave_PAD_IdentifiedGrave_78bab1b5-4557-888f-ae6d-388d4858b3e9, (FLAG)TWN_SeluneGrave_State_PassedCheck_b3849b04-8f5b-4c9c-aa69-e566e8758ce8);

//END_REGION

//REGION TWN - Temple Approach

DB_TWN_DarkJusticiarHints_Skeleton(0, (ITEM)S_TWN_DarkJusticiarSkeleton_000_ef62cde7-306a-4890-95ed-f243634577cc);
DB_TWN_DarkJusticiarHints_Skeleton(0, (ITEM)S_TWN_DarkJusticiarSkeleton_001_41e26b32-b5ba-4c82-91cf-9f85bac4dc2b);

DB_TWN_DarkJusticiarHints_Skeleton(1, (ITEM)S_TWN_DarkJusticiarSkeleton_002_ec3ee84b-9cd9-4a15-b77c-3aeb36eab91e);
DB_TWN_DarkJusticiarHints_Skeleton(1, (ITEM)S_TWN_DarkJusticiarSkeleton_003_7c4c817d-dbd5-470e-a1c1-7b991cfea4b2);
DB_TWN_DarkJusticiarHints_Skeleton(1, (ITEM)S_TWN_DarkJusticiarSkeleton_004_66138c61-37da-477b-8f00-8e833d631ec3);

DB_TWN_DarkJusticiarHints_Skeleton(2, (ITEM)S_TWN_DarkJusticiarSkeleton_005_d737a0a3-9356-4018-bdb9-510048a0e4ac);
//END_REGION

//REGION SHA - Temple ADs

DB_OneShot_VoiceBarkTrigger((TRIGGER)S_TWN_TempleApproach_de7c42f2-8173-481f-9299-e8a210de3e07, (VOICEBARKRESOURCE)TWN_TempleEntrance_VB_TempleApproach_d4e77afa-6cb2-3b3a-b120-ed68a346f1dd);
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_SHA_ShadowheartSuspicion_368ad904-e8b6-44c0-9480-d1d3cd203632, (VOICEBARKRESOURCE)SHA_Mausoleum_VB_TempleSuspicion_1a160d02-3b8f-90c9-de4d-bfb30d512f16);
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_SHA_ShadowheartTrials_2b8eb04f-0136-4231-ae3c-eb6aa5f2b9fc, (VOICEBARKRESOURCE)SHA_Trials_VB_DarkJusticiar_987dd6bb-e714-c5a9-ec31-ece854f9555c);

PROC_TriggerRegisterForParty((TRIGGER)S_TWN_TempleApproach_de7c42f2-8173-481f-9299-e8a210de3e07);
PROC_TriggerRegisterForParty((TRIGGER)S_SHA_ShadowheartSuspicion_368ad904-e8b6-44c0-9480-d1d3cd203632);
PROC_TriggerRegisterForParty((TRIGGER)S_SHA_ShadowheartTrials_2b8eb04f-0136-4231-ae3c-eb6aa5f2b9fc);
PROC_TriggerRegisterForParty((TRIGGER)S_SHA_AcademyAltar_Bounds_5ff6b0f7-310a-4676-88c9-d7a1992090d6);
PROC_TriggerRegisterForParty((TRIGGER)S_SHA_SharVista_fd6c2470-901a-4681-b3b5-615e8bc83066);

//END_REGION

//REGION SHA - Shadowfell Entrance
DB_GlobalFlagReactionAfterDialog((FLAG)SHA_NightsongPrison_Event_RegisterShadowheartOM_f419739a-b614-f3f1-fd51-c3c022e8156a, (DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_COM_594af605-3732-b2ee-bddc-e92a6b80b279);
DB_GlobalFlagReactionAfterDialog((FLAG)SHA_NightsongPrison_Event_RegisterShadowheartOM_f419739a-b614-f3f1-fd51-c3c022e8156a, (DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_AOM_OOM_62d859bc-9ee0-3a6a-19c8-444a8ceb9f44);

PROC_SHA_Shadowheart_RegisterNightsongPrisonOM();
//END_REGION

//REGION SHA - Shadowfell

DB_SHA_NightsongPrison_PrayerTriggers((TRIGGER)S_SHA_NightsongPrison_VanishTrigger_001_a9964896-1d09-48f8-8aa6-0edf5cac79e9, 0);
DB_SHA_NightsongPrison_PrayerTriggers((TRIGGER)S_SHA_NightsongPrison_VanishTrigger_002_8273c3c1-e69e-48f4-8c02-b1921839f838, 0);
DB_SHA_NightsongPrison_PrayerTriggers((TRIGGER)S_SHA_NightsongPrison_VanishTrigger_005_5786948b-e948-4bb2-b482-56860524fcce, 0);
DB_SHA_NightsongPrison_PrayerTriggers((TRIGGER)S_SHA_NightsongPrison_VanishTrigger_009_4d08ca2c-2999-4318-a549-058106b497c4, 0);
DB_SHA_NightsongPrison_PrayerTriggers((TRIGGER)S_SHA_NightsongPrison_VanishTrigger_007_83dbd3a3-e1bd-4ad9-88b5-9c967304da74, 0);
DB_SHA_NightsongPrison_PrayerTriggers((TRIGGER)S_SHA_NightsongPrison_VanishTrigger_008_5739d4af-fb63-4145-b8f6-b1e968119f8b, 0);
DB_SHA_NightsongPrison_PrayerTriggers((TRIGGER)S_SHA_PrayerTrigger_000_e6438d52-f8fb-4479-8380-f304ddd11de6, 1);
DB_SHA_NightsongPrison_PrayerTriggers((TRIGGER)S_SHA_PrayerTrigger_001_29ccf465-b8a0-46b0-a2cf-eae24082ca8d, 1);

//END_REGION 

//REGION SHA - Nightsong's Fate
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c, 
	(TAG)REALLY_SHADOWHEART_642d2aee-e3df-47e3-9f47-bbcd441bb9e0, 
	(DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db);

DB_GLO_FavouredSpeakerConditions("SHA_NightsongPrison_NightsongFateOM", (TAG)AVATAR_306b9b05-1057-4770-aa17-01af21acd650, "Tag", 1);
DB_OriginMoment_ExtraNPCs((DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db, S_SHA_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee);
DB_OriginMoment_ExtraNPCs((DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db, S_ORI_SharPathDummy_42997c97-e449-4629-93a0-eb9d81e81382);
DB_OriginMayLeaveDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c);
DB_OriginMayLeaveDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db);
DB_OriginMayLeaveDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db, 500.0);
DB_DialogBlockAttackButton((DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db);

DB_GlobalFlagReactionAfterDialog((FLAG)SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, (DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db);
DB_GlobalFlagReactionAfterDialog((FLAG)SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169, (DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db);
DB_FlagReactionAfterDialog((FLAG)SHA_NightsongPrison_Event_StartNightsongFreedDialog_737d8c1e-7970-2c6c-06ec-8ccb3a9bf25e, (DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db);

DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)SHA_Nightsong_CINE_NightsongsDeath_7c9548d5-b719-60f0-43af-1b963a5e4c6e);
DB_DialogBlockAttackButton((DIALOGRESOURCE)SHA_Nightsong_CINE_NightsongsDeath_7c9548d5-b719-60f0-43af-1b963a5e4c6e);

DB_SHA_NightsongsFate_HavenFireSources((ITEM)S_HAV_WoodStacked_Burning_000_423e03d5-4b38-4844-9f5c-360eecbbc118);
DB_SHA_NightsongsFate_HavenFireSources((ITEM)S_HAV_WoodStacked_Burning_001_b7e548f0-6bb5-4546-9f4f-83b037d20e5c);

//END_REGION

//REGION Shadowheart Appearance

DB_ORI_Shadowheart_HairChange((CHARACTER)S_ORI_SharPathDummy_42997c97-e449-4629-93a0-eb9d81e81382, 0);

DB_ORI_DarkJusticiarOutfit((ITEM)S_ORI_Shadowheart_SharBlessing_Spear_16ac4f7f-f069-49a8-a8e0-8b76d9f63532);
DB_ORI_DarkJusticiarOutfit((ITEM)S_ORI_Shadowheart_DarkJusticiarPiece_000_726cf542-6c80-4902-8e2d-0d7678f505fe);
DB_ORI_DarkJusticiarOutfit((ITEM)S_ORI_Shadowheart_DarkJusticiarPiece_001_113460a1-f4ab-4e14-9c88-76c1c06bca0b);
DB_ORI_DarkJusticiarOutfit((ITEM)S_ORI_Shadowheart_DarkJusticiarPiece_002_a98aa8d4-b7f6-4bae-b82e-af982ce07dc8);

DB_GlobalFlagReactionAfterDialog((FLAG)ORI_Shadowheart_Event_NightsongFate_ChangeAppearance_8be2b10c-aedd-4290-bd84-0d5803deb86e, (DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db);

//END_REGION

//REGION Shadowheart TGs

DB_TopicalGreeting((FLAG)TG_ORI_Shadowheart_TempleLeftParty_e5a8262e-26bc-4349-ac30-1ecb45733642);
DB_TopicalGreeting((FLAG)TG_ORI_Shadowheart_KilledNightsong_177a47d0-1464-46f5-ac18-ba56a07b1d21);
DB_TopicalGreeting((FLAG)TG_ORI_Shadowheart_SparedNightsong_5a629694-9b0f-47ec-b5f9-31deffeba9aa);
DB_TopicalGreeting((FLAG)TG_ORI_Shadowheart_SharWrath_6486fd50-45cc-4cdd-abf7-24c5f8b8e29c);
DB_TopicalGreeting((FLAG)TG_ORI_Shadowheart_NightsongMeeting_b5281f81-60b9-4dea-87ed-f3b8b95e4364);
DB_TopicalGreeting((FLAG)TG_ORI_Shadowheart_NewHair_9c47966b-cfdb-4d16-9cd1-7cb3c6f56096);

//END_REGION
KBSECTION
//REGION SCL - Shadow Curse

//FIRST TIME CURSE TRIGGER
IF
DB_SCL_ShadowCurse_InCursedArea(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_SCL_ShadowCurse_InSafeZone(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_SCL_ShadowCurse_InBlightedArea(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_CantTalk(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_Knows_CurseResistant_1c40f83c-99d1-4777-a8f7-95377f6561b8)
THEN
ObjectTimerLaunch(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SCL_Shadowheart_VBDelay", 2000);

IF
ObjectTimerFinished(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SCL_Shadowheart_VBDelay")
AND
NOT DB_SCL_ShadowCurse_InSafeZone(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_SCL_ShadowCurse_InBlightedArea(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_CantTalk(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
StartVoiceBark((VOICEBARKRESOURCE)SCL_ShadowCurse_VB_ShadowheartResistant_c45307ad-ab36-2a97-8941-3191fe4cbde1, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
ObjectTimerFinished(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SCL_Shadowheart_VBDelay")
AND
NOT DB_GlobalFlag((FLAG)SHA_PartyProgress_EnteredSharTemple_d212e499-d006-4043-9dee-8aac504098e5)
AND
NOT DB_SCL_ShadowCurse_InSafeZone(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_SCL_ShadowCurse_InBlightedArea(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_CantTalk(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
VoiceBarkEnded(SCL_EntryPoint_VB_Curse_829b5e47-510f-4445-60c5-f95b5fd12e8d, _ID)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_Knows_CurseResistant_1c40f83c-99d1-4777-a8f7-95377f6561b8)
AND
DB_DialogPlayers(_ID, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_Knows_CurseResistant_1c40f83c-99d1-4777-a8f7-95377f6561b8);

//CURSE PROTECTION STATUS EFFECT
IF
DB_SCL_ShadowCurse_EnvironmentalConditions(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_SCL_ShadowCurse_InCursedArea(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c)
AND
NOT DB_SCL_ShadowCurse_InBlightedArea(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_SCL_ShadowCurse_InSafeZone(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_SCL_ShadowCurse_Resistant_Through_Status(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_SCL_ShadowCurse_ShadowheartBlessing(1)
THEN
DB_SCL_ShadowCurse_ShadowheartBlessing(1);

IF
DB_SCL_ShadowCurse_Resistant_Through_Status(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_SCL_ShadowCurse_ShadowheartBlessing(1)
THEN
NOT DB_SCL_ShadowCurse_ShadowheartBlessing(1);
RemoveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SCL_SHARBLESSING");

IF
DB_SCL_ShadowCurse_InSafeZone(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_SCL_ShadowCurse_ShadowheartBlessing(1)
THEN
NOT DB_SCL_ShadowCurse_ShadowheartBlessing(1);
RemoveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SCL_SHARBLESSING");

IF
DB_SCL_ShadowCurse_InBlightedArea(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_SCL_ShadowCurse_ShadowheartBlessing(1)
THEN
NOT DB_SCL_ShadowCurse_ShadowheartBlessing(1);
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_EnteredDeepCurse_0181f5bb-8692-4e6a-a4de-0f28a6f135a9);
RemoveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SCL_SHARBLESSING");
PROC_SCL_ShadowCurse_PlayPAD((DIALOGRESOURCE)SCL_ShadowCurse_PAD_ShadowheartBlight_1ea73688-9045-4cc9-77d5-83cae1e0688c, "SCL_ShadowCurse_ShadowheartBlight");

IF
DB_SCL_ShadowCurse_InCursedArea(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_SCL_ShadowCurse_EnvironmentalConditions(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_SCL_ShadowCurse_ShadowheartBlessing(1)
THEN
NOT DB_SCL_ShadowCurse_ShadowheartBlessing(1);
RemoveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SCL_SHARBLESSING");

IF
DB_SCL_ShadowCurse_ShadowheartBlessing(1)
AND
HasActiveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SCL_SHARBLESSING", 0)
THEN
ApplyStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SCL_SHARBLESSING", -1.0, 1);
PROC_SCL_ShadowCurse_PlayPAD((DIALOGRESOURCE)SCL_ShadowCurse_PAD_ShadowheartBlessed_390743a5-627d-e4b9-fbe6-60768c647b19, "SCL_ShadowCurse_ShadowheartBlessing");

PROC
PROC_SCL_ShadowCurse_PlayPAD((DIALOGRESOURCE)_PAD, (STRING)_ID)
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_Knows_CurseResistant_1c40f83c-99d1-4777-a8f7-95377f6561b8)
AND
QRY_SpeakerIsAvailable(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_OnlyOnce(_ID)
THEN
PROC_TryStartAD(_PAD, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);



//END_REGION

//REGION SCL - Night Orchid Picking

IF
TemplateUseFinished(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (ITEMROOT)QUEST_SCL_NightOrchid_11f6de17-4682-419c-808f-8a328d2cce15, _, 1)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_State_PickedOrchidHerself_b7f91cd7-f9bc-4789-9398-284f587ced22)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_PickedOrchidHerself_b7f91cd7-f9bc-4789-9398-284f587ced22);


//END_REGION

//REGION HAV - Met Isobel

IF
FlagSet((FLAG)GLO_HAV_BriefAtLake_MetIsobel_8b59b707-41fe-10fe-2264-68c4108fb3a6, _, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c)
AND
DB_Players((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

//END_REGION

//REGION HAV - Haven Destroyed

IF
EnteredTrigger((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_DestroyedHaven_18d01d70-2da6-44cb-9b94-a22f1d6aa1ce)
AND
QRY_OnlyOnce("ORI_Shadowheart_HavenDestroyedRD")
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

//END_REGION

//REGION SHA - Orthon

IF
DialogEnded(SHA_Orthon_e06c8c4b-4931-391e-1c51-5b8f9b820430, _)
AND
DB_GlobalFlag((FLAG)SHA_Orthon_State_ContractEnded_26c35edd-3617-82b3-b4d7-1b7bb6410485)
AND
QRY_OnlyOnce("ORI_Shadowheart_OrthonFlare")
THEN
PROC_ORI_Shadowheart_IncurableWound_QueueAutomatedFlareUp("SHA_Shadowheart_FreedOrthon");


//END_REGION

//REGION TWN - Temple Approach

IF
UseFinished(_Player, _Skeleton, _)
AND
DB_TWN_DarkJusticiarHints_Skeleton(_Index, _Skeleton)
AND
NOT DB_GlobalFlag((FLAG)SHA_PartyProgress_EnteredSharTemple_d212e499-d006-4043-9dee-8aac504098e5)
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Skeleton)
AND
DB_TWN_DarkJusticiarHints_Skeleton(_Index, _Group)
THEN
NOT DB_TWN_DarkJusticiarHints_Skeleton(_Index, _Group);
PROC_TryStartAD((DIALOGRESOURCE)SCL_Shadowheart_PAD_DarkJusticiarRemains_4e52f25c-31c9-c021-62f7-8c8b3c191386, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
FlagSet((FLAG)SHA_PartyProgress_EnteredSharTemple_d212e499-d006-4043-9dee-8aac504098e5, _, _)
AND
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_TWN_TempleApproach_de7c42f2-8173-481f-9299-e8a210de3e07, (VOICEBARKRESOURCE)TWN_TempleEntrance_VB_TempleApproach_d4e77afa-6cb2-3b3a-b120-ed68a346f1dd)
THEN
NOT DB_OneShot_VoiceBarkTrigger((TRIGGER)S_TWN_TempleApproach_de7c42f2-8173-481f-9299-e8a210de3e07, (VOICEBARKRESOURCE)TWN_TempleEntrance_VB_TempleApproach_d4e77afa-6cb2-3b3a-b120-ed68a346f1dd);

//END_REGION

//REGION SHA - Temple ADs

//SHAR DARKNESS TRIAL

IF
AutomatedDialogEnded((DIALOGRESOURCE)SHA_VoiceOfShar_AD_Welcome_567d6c0e-44a8-7af9-6a99-650d06ffa3e0, _)
AND
DB_InRegion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_VoiceOfShar_WelcomeTrigger_bf302b1f-19c1-4d27-bd8f-2268cde2012e)
AND
DB_OnlyOnce("SHA_VoiceOfShar_NotedVoice")
AND
QRY_OnlyOnce("SHA_VoiceOfShar_ShadowheartWelcomed")
THEN
PROC_TryStartAD((DIALOGRESOURCE)SHA_Crypt_PAD_Welcomed_3fb37c66-90b6-0143-fb3d-d247d4a25600, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);


//SHAR ALTAR

IF
EnteredTrigger((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_AcademyAltar_Bounds_5ff6b0f7-310a-4676-88c9-d7a1992090d6)
AND
NOT DB_PermaDefeated((CHARACTER)S_SHA_LastJusticiar_Rat_Worshipper_005_a2160aea-9581-4be4-aa84-da15209779c9)
AND
QRY_State_IsBeforeState(S_SHA_LastJusticiar_594ba359-ce55-4b54-9efc-94eca306c540, "SHA_LastJusticiar", "SHA_LastJusticiar_State_RatsNegotiation")
AND
QRY_OnlyOnce("SHA_AcademyAltar_SeenAltar")
THEN
PROC_TriggerUnregisterForParty((TRIGGER)S_SHA_AcademyAltar_Bounds_5ff6b0f7-310a-4676-88c9-d7a1992090d6);
PROC_TryStartAD((DIALOGRESOURCE)SHA_AcademyAltar_PAD_RatsAltar_87a8800a-16cb-89c4-dbb5-9819a90b8eca, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);


//SHAR TEMPLE VISTA

IF
EnteredTrigger((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_SharVista_fd6c2470-901a-4681-b3b5-615e8bc83066)
AND
QRY_OnlyOnce("SHA_SharDisc_SeenVista")
THEN
PROC_TriggerUnregisterForParty((TRIGGER)S_SHA_SharVista_fd6c2470-901a-4681-b3b5-615e8bc83066);
PROC_TryStartAD((DIALOGRESOURCE)SHA_Disc_PAD_ShadowheartVista_70c35da9-be15-1dd0-60c9-fbbaa71314d6, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);


//DARK JUSTICIAR COMBAT REACTIVITY
IF
DB_Is_InCombat(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _ID)
AND
DB_Is_InCombat(S_SHA_TadpoledSkeletons_ShadowQuake_1_185be763-f4f1-474c-b810-5efecaff3485, _ID)
AND
QRY_OnlyOnce("SHA_TadpoledSkeletons_ShadowheartCombat")
THEN
DB_CombatReact_AD_OnTurn(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_TadpoledSkeletons_PAD_OnTurn_24a5414e-886c-1d6f-f3d1-dfbf01ccdc68, 1);

IF
LeftCombat(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _ID)
AND
DB_CombatReact_AD_OnTurn(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_TadpoledSkeletons_PAD_OnTurn_24a5414e-886c-1d6f-f3d1-dfbf01ccdc68, 1)
THEN
NOT DB_CombatReact_AD_OnTurn(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_TadpoledSkeletons_PAD_OnTurn_24a5414e-886c-1d6f-f3d1-dfbf01ccdc68, 1);

//RESPONSE TO TRIAL GREETER
IF
AutomatedDialogEnded((DIALOGRESOURCE)SHA_VoiceOfShar_AD_TrialIntro_b151a489-8520-db59-8d6c-b3c782e8a11c, _)
AND
DB_InRegion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_VoiceOfShar_TrialGreeterTrigger_2c25a000-293b-471c-93cc-168e7b247800)
AND
DB_OnlyOnce("SHA_VoiceOfShar_NotedVoice")
AND
QRY_OnlyOnce("SHA_VoiceOfShar_ShadowheartGreeted")
THEN
PROC_TryStartAD((DIALOGRESOURCE)SHA_Trials_PAD_ShadowheartIntro_4fd7f4a5-9b74-9bb7-a7a9-bbd1203e92cf, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

//HAS ALL GEMS

IF
AddedTo(_Gem, _Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_SHA_Trials_GemsNotTaken((ITEM)_Gem)
AND
DB_GlobalCounter("SHA_Trials_GemsTaken", _Count)
AND
_Count == 3
AND
GetDistanceTo(_Player, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Dist)
AND
_Dist <= 8.0
THEN
PROC_TryStartAD((DIALOGRESOURCE)SHA_Trials_PAD_HaveAllGems_87338d0d-b26a-fa48-938b-68418c5b8941, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);


//PICKING UP SPEAR OF THE NIGHT
IF
AddedTo(S_SHA_NightSpear_b2454f89-dc53-48a6-a8cd-92c7a380a6a8, _Char, _)
AND
DB_Players((CHARACTER)_Char)
AND
QRY_OnlyOnce("SHA_SilentLibrary_FoundSpear")
THEN
StartVoiceBark((VOICEBARKRESOURCE)SHA_SilentLibrary_VB_SpearLoot_28d9fcd8-0161-eeff-7db2-d73fcdabb40a, _Char);

//REACTING TO SHADOWFELL POOL
IF
AutomatedDialogEnded((DIALOGRESOURCE)SHA_VoiceOfShar_AD_Baptism_6fac169a-ef5a-1586-5f9d-1e729abb91ba, _)
AND
DB_InRegion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_NightsongPrison_SafeBubble_8e7d954d-9291-433d-87d2-8401a856020d)
AND
DB_OnlyOnce("SHA_VoiceOfShar_NotedVoice")
AND
QRY_OnlyOnce("SHA_VoiceOfShar_ShadowheartBaptism")
THEN
PROC_TryStartAD((DIALOGRESOURCE)SHA_NightsongPrison_PAD_ShadowheartBaptism_5160345d-b6c8-1915-e8de-1ca6a26e0e5e, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);


//END_REGION

//REGION SHA - Trial Fail Wound Flare

IF
AutomatedDialogEnded((DIALOGRESOURCE)SHA_VoiceOfShar_AD_ProgressionCommentary_267670e8-2eba-f75b-7f9a-22143a4e74f5, _ID)
AND
DB_DialogNPCs(_ID, _Statue, _)
AND
QRY_SpeakerIsInDialogRange(_Statue, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_OnlyOnce("SHA_Shadowheart_FailedTrials")
THEN
PROC_ORI_Shadowheart_IncurableWound_QueueAutomatedFlareUp("SHA_Shadowheart_FailedTrial");

//END_REGION

//REGION SHA - Unlocked Elevator
IF
DB_GlobalFlag((FLAG)SHA_Upper_State_DiscUnlocked_4b056ce5-e145-4d90-8451-0ff502e11898)
THEN
TimerLaunch("SHA_ClaimingNightsong_OM_Shadowheart_StartOMTimer", 4000);

IF
TimerFinished("SHA_ClaimingNightsong_OM_Shadowheart_StartOMTimer")
THEN
DB_ORI_Shadowheart_ClaimingNightsongOM(1);

IF
DB_ORI_Shadowheart_ClaimingNightsongOM(1)
AND
NOT DB_CantTalk(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
NOT DB_ORI_Shadowheart_ClaimingNightsongOM(1);
PROC_StartPartyOriginMoment((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 
							(DIALOGRESOURCE)SHA_ClaimingNightsong_OM_Shadowheart_ACM_AOM_OOM_91ef4453-531e-1ba5-efa1-d8bb8c69faf4, 
							(DIALOGRESOURCE)SHA_ClaimingNightsong_OM_Shadowheart_ACM_AOM_OOM_91ef4453-531e-1ba5-efa1-d8bb8c69faf4, 
							(DIALOGRESOURCE)SHA_ClaimingNightsong_OM_Shadowheart_COM_24481013-f15a-e07f-92c8-f3c596810b74, 
							(DIALOGRESOURCE)SHA_ClaimingNightsong_OM_Shadowheart_ACM_AOM_OOM_91ef4453-531e-1ba5-efa1-d8bb8c69faf4);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)SHA_ClaimingNightsong_OM_Shadowheart_COM_24481013-f15a-e07f-92c8-f3c596810b74, _Inst)
AND
QRY_SpeakerIsAvailable(S_SHA_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee)
THEN
PROC_DialogAddSpeakingActor(_Inst, S_SHA_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)SHA_ClaimingNightsong_OM_Shadowheart_ACM_AOM_OOM_91ef4453-531e-1ba5-efa1-d8bb8c69faf4, _Inst)
AND
QRY_SpeakerIsAvailable(S_SHA_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee)
THEN
PROC_DialogAddSpeakingActor(_Inst, S_SHA_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee);
//END_REGION

//REGION SHA - Shadowfell Entrance
// Register the OM if the player triggered the OM without the Spear and then agreed to look for the spear
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)SHA_NightsongPrison_Event_RegisterShadowheartOM_f419739a-b614-f3f1-fd51-c3c022e8156a)
AND
NOT QRY_ORI_Shadowheart_HasNightSpear()
THEN
DB_ORI_Shadowheart_SpearOMDefined(1);
PROC_GlobalClearFlagAndCache((FLAG)SHA_NightsongPrison_Event_RegisterShadowheartOM_f419739a-b614-f3f1-fd51-c3c022e8156a);
PROC_SHA_Shadowheart_RegisterNightsongPrisonOM();

QRY
QRY_ORI_Shadowheart_HasNightSpear()
AND
DB_Players(_Player)
AND
GetFlag((FLAG)SHA_NightsongPrison_State_HasSpear_08b1de4b-9f5c-41aa-93ec-9bf4376754b6, _Player, 1)
THEN
DB_NOOP(1);


PROC
PROC_SHA_Shadowheart_RegisterNightsongPrisonOM()
THEN
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)SHA_NightsongPrison_GatherYourParty_29530c19-2d81-2a03-53ac-8f96304f4a87,
	(TAG)REALLY_SHADOWHEART_642d2aee-e3df-47e3-9f47-bbcd441bb9e0,
	(DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_AOM_OOM_62d859bc-9ee0-3a6a-19c8-444a8ceb9f44,
	(DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_COM_594af605-3732-b2ee-bddc-e92a6b80b279,
	(DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_AOM_OOM_62d859bc-9ee0-3a6a-19c8-444a8ceb9f44);
DB_OriginMoment_ExtraNPCs((DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_AOM_OOM_62d859bc-9ee0-3a6a-19c8-444a8ceb9f44, S_SHA_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee);
DB_OriginMoment_ExtraNPCs((DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_COM_594af605-3732-b2ee-bddc-e92a6b80b279, S_SHA_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee);
DB_OriginMayLeaveDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_COM_594af605-3732-b2ee-bddc-e92a6b80b279);

IF
FlagSet((FLAG)SHA_NightsongPrison_State_HasSpear_08b1de4b-9f5c-41aa-93ec-9bf4376754b6, _Player, _)
AND
DB_ORI_Shadowheart_SpearOMDefined(1)
AND
DB_Players((CHARACTER)_Player)
THEN
NOT DB_ORI_Shadowheart_SpearOMDefined(1);
PROC_ClearOriginMoment((DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_AOM_OOM_62d859bc-9ee0-3a6a-19c8-444a8ceb9f44);
PROC_ClearOriginMoment((DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_COM_594af605-3732-b2ee-bddc-e92a6b80b279);

//END_REGION

//REGION SHA - Shadowfell

IF
DB_SHA_NightsongPrison_PrayerTriggers(_Trigger, 1)
THEN
PROC_TriggerRegisterForParty(_Trigger);

IF
EnteredTrigger((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _PrayerTrigger)
AND
DB_SHA_NightsongPrison_PrayerTriggers(_PrayerTrigger, _)
THEN
PROC_TriggerUnregisterForParty(_PrayerTrigger);
PROC_TryStartAD((DIALOGRESOURCE)SHA_NightsongPrison_PAD_Prayer_b08c02c8-7812-2a32-c717-2733e31c1367, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
EnteredTrigger((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_NightsongPrison_VanishTrigger_008_5739d4af-fb63-4145-b8f6-b1e968119f8b)
THEN
PROC_GlobalSetFlagAndCache((FLAG)SHA_NightsongPrison_State_FinalPrayer_e44dbbca-996d-4b4f-bebd-903aad9be5f1);

IF
EnteredTrigger((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _PrayerTrigger)
AND
DB_SHA_NightsongPrison_PrayerTriggers(_PrayerTrigger, 1)
AND
DB_SHA_NightsongPrison_PrayerTriggers(_Trigger, _)
THEN
PROC_TriggerUnregisterForParty(_Trigger);

//END_REGION

//REGION SHA - Nightsong's Fate
QRY
QRY_UsersValidForOM((DIALOGRESOURCE)SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c,(CHARACTER)_Player1,(CHARACTER)_Player2)
AND
QRY_SameUser(_Player1, _Player2)
AND
QRY_OnlyOnce("ORI_Shadowheart_NightsongFateStart")
THEN
DB_NOOP(1);

QRY
QRY_UsersValidForOM((DIALOGRESOURCE)SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c,(CHARACTER)_Player1,(CHARACTER)_Player2)
AND
NOT DB_OnlyOnce("ORI_Shadowheart_NightsongFateStart")
AND
DB_Players(_Player1)
AND
DB_Players(_Player2)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_PreventRelaunchDialog((DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db, _, _)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db, _)
AND
NOT DB_GlobalFlag((FLAG)SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3)
AND
NOT DB_GlobalFlag((FLAG)SHA_Shadowheart_State_PlayerDeniedNightsongKill_ee41e498-2566-ce3b-46f1-93db913e1694)
THEN
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c, 
	(TAG)REALLY_SHADOWHEART_642d2aee-e3df-47e3-9f47-bbcd441bb9e0, 
	(DIALOGRESOURCE)SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db);

IF
DB_GlobalFlag((FLAG)SHA_NightsongsFate_OM_Shadowheart_COM_Event_ThrewAwaySpear_286dfa77-9bdf-2186-9612-61281188f710)
THEN
Drop((ITEM)S_SHA_NightSpear_b2454f89-dc53-48a6-a8cd-92c7a380a6a8);
SetOnStage(S_SHA_NightSpear_b2454f89-dc53-48a6-a8cd-92c7a380a6a8, 0);

IF
FlagSet((FLAG)SHA_NightsongPrison_Event_PermanentlyKillNightsong_097792de-6bd1-e7c9-77d3-fe6419e3170a, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _)
THEN
SetFlag((FLAG)SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169);
SetTag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_SHARPATH_9624a3fe-bb9e-47c5-b9ab-417e6da6f84b);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)SHA_Nightsong_CINE_NightsongsDeath_7c9548d5-b719-60f0-43af-1b963a5e4c6e, _Inst)
AND
QRY_SpeakerIsAvailable(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_DialogAddSpeakingActor(_Inst, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)SHA_Nightsong_CINE_NightsongsDeath_7c9548d5-b719-60f0-43af-1b963a5e4c6e, _Inst)
AND
QRY_SpeakerIsAvailable(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
PROC_DialogAddSpeakingActor(_Inst, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)SHA_Nightsong_CINE_NightsongsDeath_7c9548d5-b719-60f0-43af-1b963a5e4c6e, _Inst)
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
PROC_DialogAddSpeakingActor(_Inst, _Player);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169)
AND
DB_GlobalFlag((FLAG)HAV_Area_State_BarrierIsOn_b7e135d1-8f49-4510-b17b-df7eb258658c)
AND
NOT DB_OnlyOnce("SHA_NightsongPrison_StartedNightsongDeathCinematic")
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailable(_Player, 0, 1) //Ignoring muting statuses for this availability check
AND
NOT QRY_StartDialog((DIALOGRESOURCE)SHA_Nightsong_CINE_NightsongsDeath_7c9548d5-b719-60f0-43af-1b963a5e4c6e, _Player)
THEN
PROC_SHA_Nightsong_HavenDestruction();

IF
DialogEnded((DIALOGRESOURCE)SHA_Nightsong_CINE_NightsongsDeath_7c9548d5-b719-60f0-43af-1b963a5e4c6e, _)
THEN
PROC_SHA_Nightsong_HavenDestruction();

PROC
PROC_SHA_Nightsong_HavenDestruction()
THEN
DB_OnlyOnce("SHA_NightsongPrison_StartedNightsongDeathCinematic");

PROC
PROC_SHA_Nightsong_HavenDestruction()
AND
QRY_State_IsBeforeState(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege")
THEN
PROC_State_Progress(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege");
PROC_State_Progress(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Area", "HAV_Area_State_BarrierIsOff");
PROC_HAV_Siege_PrepareForSiege();

PROC
PROC_SHA_Nightsong_HavenDestruction()
AND
QRY_State_IsBeforeState(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_AtMoonrise")
THEN
SetOnStage(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, 0);

PROC
PROC_SHA_Nightsong_HavenDestruction()
AND
QRY_State_IsBeforeState(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_DefeatedInHaven")
THEN
Die(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, DEATHTYPE.Necrotic,1);

IF
DialogStarted((DIALOGRESOURCE)SHA_Nightsong_CINE_NightsongsDeath_7c9548d5-b719-60f0-43af-1b963a5e4c6e, _)
THEN
PROC_HAV_Torches_Off();
PROC_HAV_FiresOut();
PROC_HAV_ProtectionFX_Off();


IF
ItemEnteredTrigger(_Light,_Trigger,_)
AND
DB_HAV_TorchZones(_Trigger)
AND
Exists(_Light,1)
AND
HasActiveStatus(_Light, "BURNING", 1)
THEN
DB_SHA_NightsongsFate_HavenFireSources((ITEM)_Light);

PROC
PROC_HAV_FiresOut()
AND
DB_SHA_NightsongsFate_HavenFireSources((ITEM)_FireSource)
AND
NOT DB_HAV_Torches(_FireSource)
THEN
RemoveStatus(_FireSource, "BURNING");

IF
TextEvent("HavenTorchesOffTest")
AND
DB_SHA_NightsongsFate_HavenFireSources(_FireSource)
THEN
PROC_HAV_FiresOut();
PROC_GlobalSetFlagAndCache(SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169);
PROC_HAV_Torches_Off();

IF
TagSet(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_SHARPATH_9624a3fe-bb9e-47c5-b9ab-417e6da6f84b)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_OnlyOnce("ORI_Shadowheart_SharPathRD")
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);


//END_REGION

//REGION SHA - Shar's Wrath



//LEAVING NIGHTSONG PRISON
IF
LeftTrigger((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
IsTagged(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_SHARPATH_9624a3fe-bb9e-47c5-b9ab-417e6da6f84b, 0)
AND
IsInInventory(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT QRY_SHA_SharWrath_IsDead()
THEN
PROC_SHA_Shadowheart_SharWrath_Start();

IF
LeftTrigger((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
IsTagged(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_SHARPATH_9624a3fe-bb9e-47c5-b9ab-417e6da6f84b, 0)
AND
IsInInventory(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0)
AND
DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT QRY_SHA_SharWrath_IsDead()
THEN
TeleportTo(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_WrathDimension_4fa0aded-3b49-4d1b-894b-afdc9a4871e8, "SHA_SharWrath_SharSummon", 0, 0, 0, 1, 1);

//Rezzing SH if she is in someones inventory when they leave the Shadowfell and then starting Wrath; the HP percentage stuff is to prevent false positives from other corpses being manipulated
IF
LeftTrigger((CHARACTER)_Character, (TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0)
AND
_Character != S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679
AND
DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_Players(_Character)
AND
NOT DB_Dead(_Character)
AND
IsTagged(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_SHARPATH_9624a3fe-bb9e-47c5-b9ab-417e6da6f84b, 0)
AND
IsInInventory(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
AND
GetInventoryOwner(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Character)
AND
QRY_SHA_SharWrath_IsDead()
THEN
PROC_SHA_Shadowheart_SharWrath_Start();

IF
Resurrected(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_SHA_SharWrath_DialogStart(1)
THEN
TeleportTo(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_WrathDimension_4fa0aded-3b49-4d1b-894b-afdc9a4871e8, "SHA_SharWrath_SharSummon", 0, 0, 0, 1, 1);
NOT DB_SHA_SharWrath_DialogStart(1);

IF
Resurrected(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_SHA_SharWrath_Resurrected(1)
THEN
PROC_SHA_Shadowheart_SharWrath_Start();
NOT DB_SHA_SharWrath_Resurrected(1);

IF
EntityEvent(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_SharWrath_SharSummon")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_SHA_Shadowheart_SharWrath_Start();


QRY
QRY_SHA_SharWrath_IsDead()
AND
DB_Dead((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa)
AND
DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
DB_SHA_SharWrath_DialogStart(1);

QRY
QRY_SHA_SharWrath_IsDead()
AND
DB_Dead((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa)
THEN
Resurrect((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_SHA_SharWrath_Resurrected(1);

//AVATAR FLOW
PROC //OM only has an AOM and does not override an existing dialog
PROC_SHA_Shadowheart_SharWrath_Start()
AND
DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_OnlyOnce("SHA_SharWrath_OM_Started")
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)SHA_SharWrath_OM_Shadowheart_AOM_6194acbf-2694-b9b4-e16c-94ac491157f9, S_GLO_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_SHA_Shadowheart_SharWrath_ReturnOutside();

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)SHA_SharWrath_OM_Shadowheart_AOM_6194acbf-2694-b9b4-e16c-94ac491157f9, _Inst)
AND
QRY_SpeakerIsAvailable(S_ORI_EnemyOfSharPathDummy_99d8ee48-1ec9-48b5-acea-8c5e4f5ce834)
THEN
PROC_DialogAddSpeakingActor(_Inst, S_ORI_EnemyOfSharPathDummy_99d8ee48-1ec9-48b5-acea-8c5e4f5ce834);

IF
DialogEnded((DIALOGRESOURCE)SHA_SharWrath_OM_Shadowheart_AOM_6194acbf-2694-b9b4-e16c-94ac491157f9, _)
THEN
PROC_SHA_Shadowheart_SharWrath_ReturnOutside();

//COMPANION FLOW
PROC
PROC_SHA_Shadowheart_SharWrath_Start()
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_OnlyOnce("SHA_SharWrath_OM_Started")
THEN
Freeze((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
SetVisible((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0);
TimerLaunch("SHA_Shadowheart_SharWrath_Return", 5000);

IF
TimerFinished("SHA_Shadowheart_SharWrath_Return")
THEN
PROC_SHA_Shadowheart_SharWrath_ReturnOutside();

//RETURN OUTSIDE
PROC
PROC_SHA_Shadowheart_SharWrath_ReturnOutside()
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
Unfreeze((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
SetTag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_ENEMYOFSHARPATH_8eca8027-996c-4c61-bec6-77f853de295b);
SetVisible((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);
PlayEffect(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (EFFECTRESOURCE)VFX_Projectile_Shadowblend_Start_01_f6d40dd6-1306-3fbf-2a74-d621a876eb10);
ApplyStatus((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "CRA_KNOCKEDOUT", 2.0, 1);
StartVoiceBark((VOICEBARKRESOURCE)SHA_SharWrath_VB_ShadowheartReturns_625b1b95-8ae7-dbef-1ba2-35f39b615ace, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

PROC
PROC_SHA_Shadowheart_SharWrath_ReturnOutside()
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag((FLAG)SHA_NightsongsFate_State_ShadowheartFailedShar_6ece6afb-e764-744c-11ae-8710b87bcf8d)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);


IF
VoiceBarkEnded((VOICEBARKRESOURCE)SHA_SharWrath_VB_ShadowheartReturns_625b1b95-8ae7-dbef-1ba2-35f39b615ace, _)
AND
NOT DB_GlobalFlag((FLAG)SHA_TempleLeave_State_ChoiceDenied_548b0dbe-c0bd-4dbf-9b40-c5d3b66d19a9)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1, 1)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Avatar)
AND
QRY_SpeakerIsInDialogRange((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Avatar)
AND
QRY_SpeakerIsAvailable((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_StartDialog_Fixed(ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Avatar)
THEN
DB_NOOP(1);


PROC
PROC_SHA_Shadowheart_SharWrath_ReturnOutside()
AND
DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
SetTag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_ENEMYOFSHARPATH_8eca8027-996c-4c61-bec6-77f853de295b);
TeleportTo(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)TeleportTrigger_MausoleumEntry_7e4e660b-ffb9-4a02-b25f-95ae91cbce96, "SHA_SharWrath_SharBanish", 0, 0, 0, 1, 1);

IF
EntityEvent(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_SharWrath_SharBanish")
THEN
PlayEffect(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (EFFECTRESOURCE)VFX_Projectile_Shadowblend_Start_01_f6d40dd6-1306-3fbf-2a74-d621a876eb10);
ApplyStatus((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "CRA_KNOCKEDOUT", 2.0, 1);
StartVoiceBark((VOICEBARKRESOURCE)SHA_SharWrath_VB_ShadowheartReturns_625b1b95-8ae7-dbef-1ba2-35f39b615ace, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);


//END_REGION

//REGION MOO - PAD

IF
DB_GlobalFlag((FLAG)GLO_HAV_IsobelGaveMission_4f0dd500-6de8-08ce-7db9-083c891e67e7)
AND
DB_GlobalFlag((FLAG)ShadowHeart_InParty_Knows_SharWorshipper_634f858d-9b54-0711-e31f-075d304422ab)
AND
IsTagged(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_ENEMYOFSHARPATH_8eca8027-996c-4c61-bec6-77f853de295b, 0)
AND
QRY_OnlyOnce("MOO_Shadowheart_KethericSharranPAD")
THEN
DB_OneShot_ADTrigger((TRIGGER)S_MOO_SharranSpot_f49553c8-59f1-4f91-bf89-c6c587045e6b, (DIALOGRESOURCE)MOO_Bazaar_PAD_SharranObservation_ab5dc554-0138-7b0b-cf11-dcb2e7f68107, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
TriggerRegisterForCharacter((TRIGGER)S_MOO_SharranSpot_f49553c8-59f1-4f91-bf89-c6c587045e6b, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
TagSet(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_ENEMYOFSHARPATH_8eca8027-996c-4c61-bec6-77f853de295b)
AND
DB_OneShot_ADTrigger((TRIGGER)S_MOO_SharranSpot_f49553c8-59f1-4f91-bf89-c6c587045e6b, (DIALOGRESOURCE)MOO_Bazaar_PAD_SharranObservation_ab5dc554-0138-7b0b-cf11-dcb2e7f68107, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_RemoveOneShotAD((TRIGGER)S_MOO_SharranSpot_f49553c8-59f1-4f91-bf89-c6c587045e6b);
TriggerUnregisterForCharacter((TRIGGER)S_MOO_SharranSpot_f49553c8-59f1-4f91-bf89-c6c587045e6b, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

//END_REGION

//REGION Shadowheart Not In Party for Shar Temple

IF
FlagSet((FLAG)SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, _, _)
AND
DB_GlobalFlag(SHA_NightsongPrison_State_PlayerEnteredPrison_f2cbe7cf-5223-4522-a649-879d08638282)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_SHA_ShadowheartConfrontCheck();

IF
FlagSet(SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731, _, _)
AND
DB_GlobalFlag(SHA_NightsongPrison_State_PlayerEnteredPrison_f2cbe7cf-5223-4522-a649-879d08638282)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_SHA_ShadowheartConfrontCheck();

PROC
PROC_SHA_ShadowheartConfrontCheck()
AND
NOT DB_GlobalFlag((FLAG)SHA_NightsongsFate_State_ShadowheartFailedShar_6ece6afb-e764-744c-11ae-8710b87bcf8d)
AND
IsTagged(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_ENEMYOFSHARPATH_8eca8027-996c-4c61-bec6-77f853de295b, 0)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_Players((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
DB_OriginMayLeaveDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_TempleLeave_OM_Shadowheart_COM_ea962e1d-e403-a23b-3aa0-fd7d9a6745b3);
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_TempleLeave_5ab52fa9-6f29-4a16-8333-851af045fab1);
TeleportTo(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_ShadowheartConfront_249d698b-75f0-496f-b80b-de871d54fb80, "SHA_ShadowheartConfront_Appear", 0, 0, 0, 1, 1);

IF
EntityEvent(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_ShadowheartConfront_Appear")
THEN
PROC_RemoveDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_Dialogs(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_TempleLeave_OM_Shadowheart_COM_ea962e1d-e403-a23b-3aa0-fd7d9a6745b3);
DB_SpotPlayers((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_TempleLeave_ShadowheartSpot", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeWildshapedPlayers((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_TempleLeave_ShadowheartSpot");
DB_SpotPlayers_TargetIgnoreCantTalk((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_TempleLeave_ShadowheartSpot");
DB_SpotPlayers_IgnoreCombat((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,  "SHA_TempleLeave_ShadowheartSpot");

PROC
PROC_SpotPlayers_Spotted(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_TempleLeave_ShadowheartSpot", _Player)
AND
NOT DB_CantTalk(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_StartDialog((DIALOGRESOURCE)SHA_TempleLeave_OM_Shadowheart_COM_ea962e1d-e403-a23b-3aa0-fd7d9a6745b3, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Player)
THEN
PROC_SpotPlayers_StopSpotting("SHA_TempleLeave_ShadowheartSpot");

IF
DialogStarted((DIALOGRESOURCE)SHA_TempleLeave_OM_Shadowheart_COM_ea962e1d-e403-a23b-3aa0-fd7d9a6745b3, _)
THEN
PROC_SpotPlayers_StopSpotting("SHA_TempleLeave_ShadowheartSpot");

PROC //Fallback in case players manage to not trigger the dialog and ignore Shadowheart.
PROC_Camp_EnterNightMode()
AND
DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_TempleLeave_5ab52fa9-6f29-4a16-8333-851af045fab1)
THEN
PROC_ORI_SetupCamp((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);

IF //Final fallback if player never returned to camp
DialogEnded((DIALOGRESOURCE)TWN_Finale_LeavingAct_06d434ac-008b-1994-5dc5-f8fcd681553d, _)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_TempleLeave_5ab52fa9-6f29-4a16-8333-851af045fab1)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_Shadowheart_Denied");

//REGION Shadowheart was in Shadowfell but didn't experience OM and tries to confront player. 

IF
TagSet(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_ENEMYOFSHARPATH_8eca8027-996c-4c61-bec6-77f853de295b)
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
IsTagged(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_SHARPATH_9624a3fe-bb9e-47c5-b9ab-417e6da6f84b, 0)
AND
DB_GlobalFlag((FLAG)SHA_PartyProgress_EnteredSharTemple_d212e499-d006-4043-9dee-8aac504098e5)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_GlobalFlag((FLAG)SHA_NightsongsFate_State_ShadowheartFailedShar_6ece6afb-e764-744c-11ae-8710b87bcf8d)
THEN
DB_OriginMayLeaveDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_TempleLeave_OM_Shadowheart_COM_ea962e1d-e403-a23b-3aa0-fd7d9a6745b3);
PROC_GlobalSetFlagAndCache((FLAG)SHA_TempleLeave_State_ChoiceDenied_548b0dbe-c0bd-4dbf-9b40-c5d3b66d19a9);
DB_SpotPlayers((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_TempleLeave_ShadowheartSpot_RefusedChoice", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeWildshapedPlayers((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_TempleLeave_ShadowheartSpot_RefusedChoice");
DB_SpotPlayers_TargetIgnoreCantTalk((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_TempleLeave_ShadowheartSpot_RefusedChoice");
DB_SpotPlayers_IgnoreCombat((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_TempleLeave_ShadowheartSpot_RefusedChoice");

PROC
PROC_SpotPlayers_Spotted(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "SHA_TempleLeave_ShadowheartSpot_RefusedChoice", _Player)
AND
NOT DB_CantTalk(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_StartDialog((DIALOGRESOURCE)SHA_TempleLeave_OM_Shadowheart_COM_ea962e1d-e403-a23b-3aa0-fd7d9a6745b3, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Player)
THEN
PROC_SpotPlayers_StopSpotting("SHA_TempleLeave_ShadowheartSpot_RefusedChoice");

PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)SHA_TempleLeave_State_ChoiceDenied_548b0dbe-c0bd-4dbf-9b40-c5d3b66d19a9)
THEN
PROC_SpotPlayers_StopSpotting("SHA_TempleLeave_ShadowheartSpot_RefusedChoice");
PROC_RemoveDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_Dialogs((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)SHA_TempleLeave_OM_Shadowheart_COM_ea962e1d-e403-a23b-3aa0-fd7d9a6745b3);
PROC_GLO_PartyMembers_MakeNPC((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

//END_REGION

//END_REGION

//REGION Change Shadowheart Appearance

PROC
PROC_SHA_NightsongPrison_Entrance((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_ORI_Shadowheart_PrepareNightsongDummy();

IF
TextEvent("sh_dummy")
THEN
PROC_ORI_Shadowheart_PrepareNightsongDummy();

PROC
PROC_ORI_Shadowheart_PrepareNightsongDummy()
AND
DB_ORI_Shadowheart_HairChange(_Dummy, _)
THEN
Transform(_Dummy, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (SHAPESHIFTRULE)Physical_4acc6277-6dcd-4110-9450-b9379beaedac);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)ORI_Shadowheart_Event_NightsongFate_ChangeAppearance_8be2b10c-aedd-4290-bd84-0d5803deb86e)
AND
DB_ORI_DarkJusticiarOutfit(_Set)
THEN
RequestDelete((ITEM)S_SHA_NightSpear_b2454f89-dc53-48a6-a8cd-92c7a380a6a8);
Equip((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Set, 1, 1, 1);


//END_REGION

//REGION Shadowheart TGs

//TG - 158 - Left Party After Shar Temple
IF
DB_GlobalFlag((FLAG)SHA_TempleLeave_State_ChoiceDenied_548b0dbe-c0bd-4dbf-9b40-c5d3b66d19a9)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_OnlyOnce("TG_ORI_ShadowheartLeft")
AND
DB_Avatars(_Avatar)
THEN
SetFlag((FLAG)TG_ORI_Shadowheart_TempleLeftParty_e5a8262e-26bc-4349-ac30-1ecb45733642, _Avatar);

//TG - 159 - Killed Nightsong
IF
FlagSet((FLAG)ORI_Shadowheart_State_SharPath_bf9ae334-ff6a-458d-b898-3074bca0bdfb, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_Avatars(_Avatar)
THEN
SetFlag((FLAG)TG_ORI_Shadowheart_KilledNightsong_177a47d0-1464-46f5-ac18-ba56a07b1d21, _Avatar);

//TG - 160 - Spared Nightsong
IF
FlagSet((FLAG)SHA_NightsongsFate_State_ShadowheartFailedShar_6ece6afb-e764-744c-11ae-8710b87bcf8d, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_Avatars(_Avatar)
THEN
SetFlag((FLAG)TG_ORI_Shadowheart_SparedNightsong_5a629694-9b0f-47ec-b5f9-31deffeba9aa, _Avatar);

//TG - 161 - Shar Punished SH
IF
FlagSet((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_Avatars(_Avatar)
THEN
SetFlag((FLAG)TG_ORI_Shadowheart_SharWrath_6486fd50-45cc-4cdd-abf7-24c5f8b8e29c, _Avatar);

//TG - 162 - Had Nightsong Meeting
IF
FlagSet((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_Avatars(_Avatar)
THEN
SetFlag((FLAG)TG_ORI_Shadowheart_NightsongMeeting_b5281f81-60b9-4dea-87ed-f3b8b95e4364, _Avatar);

//TG - 163 - Got new hair
IF
FlagSet((FLAG)ORI_Shadowheart_State_HairChange_2abcff91-1f1e-4853-98e2-ad7d2020158c, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c)
AND
DB_Avatars(_Avatar)
THEN
SetFlag((FLAG)TG_ORI_Shadowheart_NewHair_9c47966b-cfdb-4d16-9cd1-7cb3c6f56096, _Avatar);



//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
