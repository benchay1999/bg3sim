Version 1
SubGoalCombiner SGC_AND
INITSECTION
SetOnStage(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,1);
SetOnStage(S_WYR_Axe_DoppelgangerAssassin_001_7867564d-583d-4558-a927-1508ea61cf75,1);
SetOnStage(S_WYR_Axe_DoppelgangerAssassin_002_ba5b21ad-bcc4-407c-85a3-f0448a7094b5,1);
SetOnStage(S_WYR_Axe_DoppelgangerAssassin_003_b3ebb78f-2102-496a-b277-27ac214a88ca,1);
SetOnStage(S_WYR_Axe_DoppelgangerAssassin_004_d2d5409c-4196-42b1-b641-b32db6ac04e7,1);

DB_Dialogs(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427);
DB_GLO_CharacterCorpseDialog(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, WYR_Axe_RealHarper_Dead_ae4208e7-2718-5f4d-d497-65a15546dee8);
DB_PermaDefeatedFlag(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,WYR_Axe_State_RealHarper_PermaDefeated_4ed87bc4-685c-49f1-bcbd-6717c04f7465);

TriggerRegisterForCharacter(S_WYR_DanthelonShop_MainFloor_Zone_a61c9e4f-b541-4f87-81af-ca7558cc50e1,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

DB_GlobalFlagReactionAfterDialog(WYR_Knows_LookingForRashemaar_558b2edb-6ac1-4fab-977f-03d055c4bf2d, WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427);


PROC_WYR_Axe_StartAmbushScene();
DB_WYR_Axe_HostileInterrupts("Attacked");
DB_WYR_Axe_HostileInterrupts("Died");
DB_WYR_Axe_HostileInterrupts("EnteredCombat");

DB_WYR_Axe_PlayerSurprised(1);

DB_WYR_Axe_HarpersDialogs((DIALOGRESOURCE)WYR_Axe_Harpers_6cb365c4-7ef5-5b0d-1b7a-ec06a0e0e21a);
DB_WYR_Axe_HarpersDialogs((DIALOGRESOURCE)WYR_Axe_Harpers_OM_Jaheira_OOM_e9ce25c9-e78c-9e22-5712-ba9b28e503e5);

// Assassin, Shapeshifting Status
DB_WYR_Axe_Assassin((CHARACTER)S_WYR_Axe_DoppelgangerAssassin_001_7867564d-583d-4558-a927-1508ea61cf75);
DB_WYR_Axe_Assassin((CHARACTER)S_WYR_Axe_DoppelgangerAssassin_002_ba5b21ad-bcc4-407c-85a3-f0448a7094b5);
DB_WYR_Axe_Assassin((CHARACTER)S_WYR_Axe_DoppelgangerAssassin_003_b3ebb78f-2102-496a-b277-27ac214a88ca);
DB_WYR_Axe_Assassin((CHARACTER)S_WYR_Axe_DoppelgangerAssassin_004_d2d5409c-4196-42b1-b641-b32db6ac04e7);

DB_WYR_Axe_AmbushDialogParticipants((CHARACTER)S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7);
DB_WYR_Axe_AmbushDialogParticipants(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

TriggerRegisterForCharacter(S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e,S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7);
TriggerRegisterForCharacter(S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC_TriggerRegisterForPlayers(S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e);

//Commenting out for now, as we're testing out a flow where Jaheira doesn't go to Danthelon's Dancing Axe, and instead stays in the camp until recruited (Or leaves when you get to Baldur's Gate)
//PROC_WYR_Axe_IfJaheiraIsNotPartOfTeam();

DB_WYR_Axe_JaheiraDropPolymorphDialogs((DIALOGRESOURCE)WYR_Axe_Danthelon_2944db0f-3292-aee9-cc2f-ddc3e43c66ca);
DB_WYR_Axe_JaheiraDropPolymorphDialogs((DIALOGRESOURCE)WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427);

ClearOwnership(S_WYR_Axe_OpenDoorButton_01_d52a3860-6236-4b3a-a425-488ad30d617b);
ClearOwnership(S_WYR_Axe_OpenDoorButton_02_f3d37c6f-b925-4bf6-9a97-179322499992);

// Nearshop PAD
DB_OneShot_VoiceBarkTrigger(S_WYR_Axe_NearShopPADArea_3a2d4c7b-2602-425c-9dcb-8efe7e95fbfa, WYR_Axe_VB_NearShop_97199c35-fa75-c65f-2ba7-76783853446c);
PROC_TriggerRegisterForPlayers(S_WYR_DanthelonShop_MainFloor_Zone_a61c9e4f-b541-4f87-81af-ca7558cc50e1);
PROC_TriggerRegisterForPlayers(S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e);
// Ownership
DB_ItemOwnerShipTriggers("BGO_Main_A",S_WYR_DanthelonShop_Basement_OwnershipTrigger_000_111b67e9-17d6-4ccb-b0ec-db5ee28ceec2,S_WYR_Axe_DoppelgangerAssassin_001_7867564d-583d-4558-a927-1508ea61cf75);
DB_ItemOwnerShipTriggers("BGO_Main_A",S_WYR_DanthelonShop_Basement_OwnershipTrigger_001_94f27f1a-b0c5-4945-8da5-73b27a61aa61,S_WYR_Axe_DoppelgangerAssassin_001_7867564d-583d-4558-a927-1508ea61cf75);

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("WYR_Axe_Assassins",WYR_Axe_State_DoppelgangersDead_416b80ee-d87d-4980-90e4-bee004151544);
KBSECTION
//REGION Debug

IF
TextEvent("wyr_axe_leave")
THEN
PROC_WYR_Danthelon_JaheiraCheckLeave();

//END_REGION Debug

//REGION Harpers scene dialog Setup
IF
DB_WYR_Axe_HarpersDialogs(_Dialog)
THEN
DB_DialogBlockAttackButton(_Dialog);
DB_WYR_Axe_JaheiraDropPolymorphDialogs(_Dialog);
DB_DialogBlockTradeButton(_Dialog);
//END_REGION

//REGION When Jaheira is not part of the team - this is outdated
/*
PROC
PROC_WYR_Axe_IfJaheiraIsNotPartOfTeam()
AND
NOT DB_GlobalFlag(GLO_Origin_PartOfTheTeam_Jaheira_d7d29efe-70bb-47c2-9db3-bc8a10347bc6)
THEN
TeleportTo(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,S_WYR_Axe_Jaheira_ScenePos_8d8424e0-ebac-4290-8a63-ebda533a855d);
SetOnStage(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,1);
DB_SceneManager(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,"WYR_Axe_Ambush");
PROC_RemoveAllDialogEntriesForSpeaker(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
PROC_WYR_Axe_StartSpotting();

// HACK for editor story reloading
IF
TextEvent("WYR_Danthelons_JaheiraDialogSetup")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_WYR_Axe_StartSpotting()
AND
DB_SceneManager(_NPC,"WYR_Axe_Ambush")
THEN
DB_SpotPlayers(_NPC,"WYR_Axe_Ambush",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(_NPC,"WYR_Axe_Ambush",S_WYR_DoppelgangersSpotArea_f2fbc636-998b-41b0-935b-d2e096c860fd);

IF
DB_SceneManager(_NPC,"WYR_Axe_Ambush")
AND
NOT DB_SpotPlayers(_NPC,"WYR_Axe_Ambush",_,_)
AND
DB_SpotPlayers(_OtherNPC,"WYR_Axe_Ambush",_F1,_F2)
THEN
DB_SpotPlayers(_NPC,"WYR_Axe_Ambush",_F1,_F2);
DB_SpotPlayers_SpotTrigger(_NPC,"WYR_Axe_Ambush",S_WYR_DoppelgangersSpotArea_f2fbc636-998b-41b0-935b-d2e096c860fd);

PROC
PROC_SceneInterrupted(_,_,"WYR_Axe_Ambush","Spotted")
THEN
PROC_SceneOver("WYR_Axe_Ambush");

PROC
PROC_SceneInterrupted(_NPC,_Player,"WYR_Axe_Ambush","Spotted")
AND
QRY_SelectAndStartDialog(_NPC,_Player)
THEN
DB_NOOP(1);
*/
//END_REGION When Jaheira is not part of the team


//REGION Auto-start Harper ambush dialog

PROC
PROC_WYR_Axe_StartAmbushScene()
AND
NOT DB_SpotPlayers(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_Ambush", _,_)
THEN
DB_SpotPlayers(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_Ambush", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_Ambush", S_WYR_DoppelgangersSpotArea_f2fbc636-998b-41b0-935b-d2e096c860fd);

PROC
PROC_WYR_Axe_StartAmbushScene()
AND
DB_SpotPlayers(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_Ambush", _,_)
THEN
PROC_SpotPlayers_RestartSpotting(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_Ambush");

PROC
PROC_SpotPlayers_Spotted(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_Ambush", _Player)
AND
QRY_GetClosestAvailableCharacterTo(_Player, 1)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar, _Player, _Dist, 1)
AND
DB_InRegion(_ClosestAvatar, S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
AND
QRY_OnlyOnce("WYR_Axe_Ambush_SpottingDialogStarting")
AND
QRY_SelectAndStartDialog(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, _ClosestAvatar)
THEN
DB_NOOP(1);

PROC
PROC_SpotPlayers_Spotted(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_Ambush", _Player)
AND
QRY_OnlyOnce("WYR_Axe_Ambush_SpottingDialogStarting")
AND
QRY_SelectAndStartDialog(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, _Player)
THEN
DB_NOOP(1);

IF
DB_WYR_Axe_AmbushDialogEnded(1)
THEN
PROC_SpotPlayers_StopSpotting("WYR_Axe_Ambush");
PROC_SceneOver("WYR_Axe_Ambush");

//END_REGION

//REGION 3-way dialog with Danthelon

IF
FlagSet(WYR_Axe_State_AllowedDownstairs_07bcb1b4-9318-45c8-b1b2-81fd9083cf17,_,_)
THEN
ClearOwnership(S_WYR_Axe_Backdoor_Door_01_e41570db-5b81-4536-a8ef-84cac5263802);

// Starting with player: COM for OM1 / no OM
QRY
QRY_SelectCustomDialog_AfterGenerics(S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456, _Player)
AND
_Player != S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a
THEN
PROC_WYR_Axe_StartDanthelonDialogByPlayer((CHARACTER)_Player);

// COM 1
PROC
PROC_WYR_Axe_StartDanthelonDialogByPlayer((CHARACTER)_Player)
AND
NOT QRY_WYR_Axe_JaheiraNeedsReportDoppelgangers()
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456)
THEN
DB_SelectedDialog(WYR_Axe_Danthelon_2944db0f-3292-aee9-cc2f-ddc3e43c66ca, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456, _Player, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

// OM 2: OOM with player
PROC
PROC_WYR_Axe_StartDanthelonDialogByPlayer((CHARACTER)_Player)
AND
QRY_WYR_Axe_JaheiraNeedsReportDoppelgangers()
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456)
THEN
DB_SelectedDialog(WYR_Axe_Danthelon_Jaheira_OOM_ab309b92-ab47-11a4-be8f-bc3d30b80feb, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player);

// No OM: switching back to the normal dialog
PROC
PROC_WYR_Axe_StartDanthelonDialogByPlayer((CHARACTER)_Player)
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456)
THEN
DB_SelectedDialog(WYR_Axe_Danthelon_2944db0f-3292-aee9-cc2f-ddc3e43c66ca, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456, _Player);


// Jaheira initiated the dialog
QRY
QRY_SelectCustomDialog_AfterGenerics(S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
QRY_WYR_Axe_ShouldPlayJaheiraOMAtDanthelon()
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_QRYRTN_GetBestAvatarForCompanion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Avatar)
THEN
PROC_WYR_Axe_StartDanthelonDialogByJaheira(_Avatar);

// OM 1: Switching to COM
PROC
PROC_WYR_Axe_StartDanthelonDialogByJaheira((CHARACTER)_Avatar)
AND
NOT QRY_WYR_Axe_JaheiraNeedsReportDoppelgangers()
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Avatar, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456)
THEN
DB_SelectedDialog(WYR_Axe_Danthelon_2944db0f-3292-aee9-cc2f-ddc3e43c66ca, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456, _Avatar, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

// OM 2: OOM dialog with player as peanut (we don't have COM version)
PROC
PROC_WYR_Axe_StartDanthelonDialogByJaheira((CHARACTER)_Avatar)
AND
QRY_WYR_Axe_JaheiraNeedsReportDoppelgangers()
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Avatar, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456)
THEN
DB_SelectedDialog(WYR_Axe_Danthelon_Jaheira_OOM_ab309b92-ab47-11a4-be8f-bc3d30b80feb, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Avatar);

// OM 1 or 2: she's alone (OOM)
PROC
PROC_WYR_Axe_StartDanthelonDialogByJaheira((CHARACTER)_Avatar)
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(_Avatar, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456)
THEN
DB_SelectedDialog(WYR_Axe_Danthelon_Jaheira_OOM_ab309b92-ab47-11a4-be8f-bc3d30b80feb, S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

QRY
QRY_WYR_Axe_ShouldPlayJaheiraOMAtDanthelon()
AND
NOT DB_GlobalFlag(WYR_Axe_State_TalkedToDanthelon_35490580-d4e8-44e1-a726-45ed781cb5a8)
AND
NOT DB_GlobalFlag(WYR_Axe_Knows_HarpersAreDoppelgangers_3e31c252-d7f7-463d-9e58-f48dc9d13fac)
AND
NOT DB_GlobalFlag(WYR_Axe_Event_JaheiraInformedDanthelon_413f311e-2dc9-4487-b65b-ce79bcbf3315)
THEN
DB_NOOP(1);

QRY
QRY_WYR_Axe_ShouldPlayJaheiraOMAtDanthelon()
AND
QRY_WYR_Axe_JaheiraNeedsReportDoppelgangers()
THEN
DB_NOOP(1);

QRY
QRY_WYR_Axe_JaheiraNeedsReportDoppelgangers()
AND
DB_GlobalFlag(WYR_Axe_State_DoppelgangersDead_416b80ee-d87d-4980-90e4-bee004151544)
AND
NOT DB_GlobalFlag(WYR_Axe_DanthelonKnowsHappened_2768db4a-cd46-4bef-88a0-81b0a8842b9c)
AND
NOT DB_GlobalFlag(WYR_Axe_Event_JaheiraInformedDanthelon_413f311e-2dc9-4487-b65b-ce79bcbf3315)
THEN
DB_NOOP(1);
//END_REGION 3-way dialog with Danthelon


//REGION Assassins setup

IF
DB_WYR_Axe_Assassin(_Assassin)
THEN
SetHasDialog(_Assassin,1);
//DB_Dialogs(_Assassin,WYR_Axe_DoppelgangerFakeDialog_2011d3f8-b6ec-7e25-e23f-496c46ff5325);
DB_WYR_Axe_AmbushDialogParticipants(_Assassin);
TriggerRegisterForCharacter(S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e,_Assassin);
DB_GLO_DefeatCounter(_Assassin,"WYR_Axe_Assassins");
DB_SceneManager(_Assassin,"WYR_Axe_Ambush");

QRY
QRY_CorpseLooting_BlockMakeOwned(_Assassin)
AND
DB_WYR_Axe_Assassin(_Assassin)
THEN
DB_NOOP(1);

//END_REGION Assassins setup


//REGION Scene manager

PROC
PROC_WYR_Axe_StartAmbushScene()
THEN
DB_SceneManager(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_Ambush");
DB_SceneNoHostileContinuousDisturbance("WYR_Axe_Ambush");

PROC
PROC_SceneInterrupted(_Assassin,_,"WYR_Axe_Ambush",_InterruptType)
AND
DB_WYR_Axe_HostileInterrupts(_InterruptType)
AND
NOT DB_GlobalFlag(WYR_Axe_Event_PlayerAttacksDoppelgangers_743295e7-f8ed-4abb-a490-9edcb0fe50bc)
AND
DB_WYR_Axe_Assassin((CHARACTER)_Assassin)
AND
QRY_OnlyOnce("WYR_Axe_AD_DoppelgangersUnderAttack")
THEN
PROC_TryStartAD(WYR_Axe_AD_DoppelgangersUnderAttack_272bba50-a6dd-c32e-d22c-05a38b0e3831,_Assassin);

PROC
PROC_SceneInterrupted(_NPC,_,"WYR_Axe_Ambush",_InterruptType)
AND
DB_WYR_Axe_HostileInterrupts(_InterruptType)
AND
NOT DB_GlobalFlag(WYR_Axe_Event_PlayerAttacksDoppelgangers_743295e7-f8ed-4abb-a490-9edcb0fe50bc)
THEN
PROC_GlobalSetFlagAndCache(WYR_Axe_Event_PlayerAttacksDoppelgangers_743295e7-f8ed-4abb-a490-9edcb0fe50bc);
PROC_SceneOver("WYR_Axe_Ambush");

IF
DB_Is_InCombat(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,_CombatID)
AND
DB_Is_InCombat(_Player,_CombatID)
AND
DB_Players((CHARACTER)_Player)
AND
IsEnemy(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, _Player, 1)
THEN
PROC_WYR_Axe_MakeAssassinsHostile();

IF
FlagSet(WYR_Axe_Event_PlayerAttacksDoppelgangers_743295e7-f8ed-4abb-a490-9edcb0fe50bc,_,_)
THEN
PROC_WYR_Axe_MakeAssassinsHostile();

PROC
PROC_WYR_Axe_MakeAssassinsHostile()
AND
GetFaction(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,_JahFaction)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_WYR_Axe_Assassins_7b18665b-768c-483e-b819-d14f4cdd6cbb, 0);
PROC_SetRelationMutual((FACTION)Act3_WYR_Axe_Assassins_7b18665b-768c-483e-b819-d14f4cdd6cbb,_JahFaction,0);
PROC_SetRelationMutual((FACTION)Act3_WYR_Axe_Assassins_7b18665b-768c-483e-b819-d14f4cdd6cbb,Act3_WYR_Harpers_04d4c9dc-4ccc-4121-b1cf-cf598ec84469,0);

PROC
PROC_WYR_Axe_MakeAssassinsHostile()
THEN
NOT DB_ItemOwnerShipTriggers("BGO_Main_A",S_WYR_DanthelonShop_Basement_OwnershipTrigger_000_111b67e9-17d6-4ccb-b0ec-db5ee28ceec2,S_WYR_Axe_DoppelgangerAssassin_001_7867564d-583d-4558-a927-1508ea61cf75);
NOT DB_ItemOwnerShipTriggers("BGO_Main_A",S_WYR_DanthelonShop_Basement_OwnershipTrigger_001_94f27f1a-b0c5-4945-8da5-73b27a61aa61,S_WYR_Axe_DoppelgangerAssassin_001_7867564d-583d-4558-a927-1508ea61cf75);
TriggerClearItemsOwner(S_WYR_DanthelonShop_Basement_OwnershipTrigger_000_111b67e9-17d6-4ccb-b0ec-db5ee28ceec2);
TriggerClearItemsOwner(S_WYR_DanthelonShop_Basement_OwnershipTrigger_001_94f27f1a-b0c5-4945-8da5-73b27a61aa61);

IF
FlagSet(WYR_Axe_Knows_HarpersAreDoppelgangers_3e31c252-d7f7-463d-9e58-f48dc9d13fac,_,_)
THEN
NOT DB_WYR_Axe_PlayerSurprised(1);

IF
FlagSet(WYR_Axe_Harpers_UnderstoodSignal_6c2cd219-e1e0-365a-9ba2-2959b96a16f3,_,_)
THEN
NOT DB_WYR_Axe_PlayerSurprised(1);

IF
FlagSet(WYR_Axe_Event_PlayerAttacksDoppelgangers_743295e7-f8ed-4abb-a490-9edcb0fe50bc,_,_)
THEN
DB_WYR_Axe_DoppelgangersSurprised(1);

IF
DialogEnded(_Dialog,_)
AND
DB_WYR_Axe_HarpersDialogs(_Dialog)
THEN
PROC_WYR_Axe_MakeAssassinsHostile();

IF
DialogEnded(_Dialog,_DialogID)
AND
DB_WYR_Axe_HarpersDialogs(_Dialog)
AND
DB_WYR_Axe_PlayerSurprised(1)
AND
DB_DialogPlayers(_DialogID,_Player,1)
THEN
PROC_WYR_MakeSurprised_ExceptJaheira((CHARACTER)_Player);

// but if Jaheira was the only player in dialog and failed roll, she is surprised
IF
DialogEnded(_Dialog,_DialogID)
AND
DB_WYR_Axe_HarpersDialogs(_Dialog)
AND
DB_WYR_Axe_PlayerSurprised(1)
AND
DB_DialogPlayers(_DialogID,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,1)
AND
NOT DB_GlobalFlag(WYR_Axe_Harpers_JaheiraUnderstoodSignal_af5a24ae-c718-4f66-8a17-d521a4a2e033)
THEN
PROC_MakeSurprised(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

IF
DialogEnded(_Dialog,_DialogID)
AND
DB_WYR_Axe_HarpersDialogs(_Dialog)
AND
DB_WYR_Axe_DoppelgangersSurprised(1)
AND
DB_WYR_Axe_Assassin(_Assassin)
THEN
PROC_MakeSurprised(_Assassin);

IF
DB_Is_InCombat(_Assassin,_CombatID)
AND
DB_WYR_Axe_Assassin((CHARACTER)_Assassin)
AND
DB_Is_InCombat(_Player,_CombatID)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("WYR_Axe_DoppelgangersFight_OnlyOnce")
THEN
PROC_GlobalSetFlagAndCache(WYR_Axe_State_DoppelgangersFight_4e94de74-bb48-44c5-ac00-0d453a5ac32b);
PROC_GlobalSetFlagAndCache(WYR_Axe_Knows_HarpersAreDoppelgangers_3e31c252-d7f7-463d-9e58-f48dc9d13fac);

IF
StatusRemoved((CHARACTER)_Doppelganger, _DoppelgangerStatus, _, _)
AND
DB_WYR_Axe_Assassin(_Doppelganger)
AND
NOT DB_GlobalFlag(WYR_Axe_Knows_HarpersAreDoppelgangers_3e31c252-d7f7-463d-9e58-f48dc9d13fac)
AND
IsStatusFromGroup(_DoppelgangerStatus, "SG_Doppelganger", 1)
AND
DB_Players(_Player)
AND
CanSee(_Player, _Doppelganger, 1)
THEN
PROC_GlobalSetFlagAndCache(WYR_Axe_Knows_HarpersAreDoppelgangers_3e31c252-d7f7-463d-9e58-f48dc9d13fac);

// TODO: set WYR_Axe_Knows_HarpersAreDoppelgangers_3e31c252-d7f7-463d-9e58-f48dc9d13fac on True Sight or other means to detect doppelgangers

IF
DB_Is_InCombat(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,_CombatID)
AND
DB_Is_InCombat(_Assassin,_CombatID)
AND
DB_WYR_Axe_Assassin((CHARACTER)_Assassin)
AND
QRY_OnlyOnce("WYR_Axe_AD_Ambush_RealHarper_6aa62583-094c-293c-ec76-137287cbb6b6")
THEN
PROC_TryStartAD(WYR_Axe_AD_Ambush_RealHarper_6aa62583-094c-293c-ec76-137287cbb6b6,S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7);

IF
DB_Is_InCombat(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,_CombatID)
AND
DB_Is_InCombat(_Assassin,_CombatID)
AND
DB_WYR_Axe_Assassin((CHARACTER)_Assassin)
AND
GetFaction(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,_JahFaction)
AND
GetFaction(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,_HarFaction)
THEN
PROC_SetRelationMutual(_HarFaction,_JahFaction,100);

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("WYR_Axe_Assassins")
AND
DB_Was_InCombat(S_WYR_Axe_DoppelgangerAssassin_001_7867564d-583d-4558-a927-1508ea61cf75,_CombatID)
AND
DB_Avatars(_Player)
AND
DB_Was_InCombat(_Player,_CombatID)
AND
QRY_OnlyOnce("WYR_Axe_AD_AssassinsDefeated")
THEN
DB_WYR_Axe_JaheiraWaitPlayerVBEnd(1);
PROC_TryStartAD(WYR_Axe_PAD_AssassinsDefeated_ec9860c6-a0aa-82ba-f83c-19e8821acc0d,_Player);

QRY
QRY_GLO_Doppelgangers_BlockGenericReactionPAD(_Doppelganger)
AND
DB_WYR_Axe_Assassin(_Doppelganger)
THEN
DB_NOOP(1);

IF
CustomBookUIClosed(_Player,"WYR_Danthelon_KillOrders")
AND
DB_Players(_Player)
THEN
PROC_GlobalSetFlagAndCache(GLO_Gortash_Knows_AttackedByOrin_3dbc99c9-06c2-4471-88dd-ecc7537eeee9);

//END_REGION Scene manager


//REGION Multi-way dialog with harpers before ambush

IF
DialogEnded(_Dialog,_DialogID)
AND
DB_WYR_Axe_HarpersDialogs(_Dialog)
THEN
DB_WYR_Axe_AmbushDialogEnded(1);

// COM or Default dialog
QRY
QRY_SelectCustomDialog_AfterGenerics(_Speaker,_Player)
AND
NOT DB_WYR_Axe_AmbushDialogEnded(1)
AND
_Player != S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a
AND
DB_WYR_Axe_AmbushDialogParticipants((CHARACTER)_Speaker)
AND
DB_InRegion(_Speaker,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
AND
DB_InRegion(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
THEN
DB_WYR_Axe_HarpersDialogStarted((DIALOGRESOURCE)WYR_Axe_Harpers_6cb365c4-7ef5-5b0d-1b7a-ec06a0e0e21a);
DB_SelectedDialog(WYR_Axe_Harpers_6cb365c4-7ef5-5b0d-1b7a-ec06a0e0e21a,S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,_Player);

// Jaheira initiated the dialog
QRY
QRY_SelectCustomDialog_AfterGenerics(_Speaker,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_WYR_Axe_HarpersDialogStarted(_)
AND
NOT DB_WYR_Axe_AmbushDialogEnded(1)
AND
DB_WYR_Axe_AmbushDialogParticipants((CHARACTER)_Speaker)
AND
DB_InRegion(_Speaker,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
AND
DB_InRegion(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_QRYRTN_GetBestAvatarForCompanion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Avatar)
THEN
PROC_WYR_Axe_StartHarpersDialogByJaheira(_Avatar);

// switch to COM
PROC
PROC_WYR_Axe_StartHarpersDialogByJaheira((CHARACTER)_Avatar)
AND
DB_InRegion(_Avatar,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
THEN
DB_WYR_Axe_HarpersDialogStarted((DIALOGRESOURCE)WYR_Axe_Harpers_6cb365c4-7ef5-5b0d-1b7a-ec06a0e0e21a);
DB_SelectedDialog((DIALOGRESOURCE)WYR_Axe_Harpers_6cb365c4-7ef5-5b0d-1b7a-ec06a0e0e21a,S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,_Avatar,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

// she's alone (OOM)
PROC
PROC_WYR_Axe_StartHarpersDialogByJaheira((CHARACTER)_Avatar)
AND
NOT DB_InRegion(_Avatar,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
THEN
DB_WYR_Axe_HarpersDialogStarted((DIALOGRESOURCE)WYR_Axe_Harpers_OM_Jaheira_OOM_e9ce25c9-e78c-9e22-5712-ba9b28e503e5);
DB_SelectedDialog(WYR_Axe_Harpers_OM_Jaheira_OOM_e9ce25c9-e78c-9e22-5712-ba9b28e503e5,S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,NULL_00000000-0000-0000-0000-000000000000,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

// adding assassins to the dialog as extras
PROC
PROC_StartDialog_AddExtraSpeakers(_Dialog,_DialogID)
AND
DB_WYR_Axe_HarpersDialogStarted(_Dialog)
AND
DB_WYR_Axe_AmbushDialogParticipants(_Speaker)
AND
NOT DB_DialogRequestCache_SpeakerList_Players(_Dialog,_DialogID,_Speaker,1) // don't add Jaheira twice
AND
DB_InRegion(_Speaker,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
THEN
PROC_DialogAddSpeakingActor(_DialogID,_Speaker);

//END_REGION Multi-way dialog with harpers before ambush


//REGION Jaheira after ambush

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("WYR_Axe_Assassins")
AND
NOT DB_WYR_Axe_JaheiraWaitPlayerVBEnd(1)
AND
DB_InRegion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
THEN
PROC_TryStartAD(WYR_Axe_AD_JaheiraAfterAmbush_9046ce82-b87f-7925-0810-1f4ef768f8e8,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

IF
AutomatedDialogEnded(WYR_Axe_PAD_AssassinsDefeated_ec9860c6-a0aa-82ba-f83c-19e8821acc0d,_)
AND
DB_WYR_Axe_JaheiraWaitPlayerVBEnd(1)
AND
DB_InRegion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
THEN
NOT DB_WYR_Axe_JaheiraWaitPlayerVBEnd(1);
PROC_TryStartAD(WYR_Axe_AD_JaheiraAfterAmbush_9046ce82-b87f-7925-0810-1f4ef768f8e8,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

//END_REGION Jaheira after ambush


//REGION Harper dialogs after ambush

QRY
QRY_SelectCustomDialog_AfterGenerics(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,_Player)
AND
_Player != S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a
THEN
DB_SelectedDialog(WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427,S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,_Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
DB_SelectedDialog(WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427,S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,NULL_00000000-0000-0000-0000-000000000000,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_StartDialog_AddExtraSpeakers(WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427,_DialogID)
AND
NOT DB_DialogRequestCache_SpeakerList_Players(_,_DialogID,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,_) // don't add Jaheira twice
AND
DB_InRegion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7)
THEN
PROC_DialogAddSpeakingActor(_DialogID,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);


PROC
PROC_DialogFlagSetup(WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427,_RealHarper,_Player)
AND
_Player != S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a
AND
DB_Players((CHARACTER)_Player)
THEN
SetFlag(WYR_Axe_PlayerInDialog_eab7d2d2-8a14-41ff-a0bc-a970d4279692,_Player,0);

PROC
PROC_DialogFlagSetup(WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427,_RealHarper,_Player,_Jaheira)
AND
_Player != S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a
AND
DB_Players((CHARACTER)_Player)
THEN
SetFlag(WYR_Axe_PlayerInDialog_eab7d2d2-8a14-41ff-a0bc-a970d4279692,_Player,0);

IF
DialogActorLeft(WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427,_,_Player,_)
AND
DB_Players((CHARACTER)_Player)
THEN
ClearFlag(WYR_Axe_PlayerInDialog_eab7d2d2-8a14-41ff-a0bc-a970d4279692,_Player,0);

QRY
QRY_CorpseLooting_BlockMakeOwned(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7)
THEN
DB_NOOP(1);

PROC
PROC_GlobalFlagReactionAfterDialog(WYR_Knows_LookingForRashemaar_558b2edb-6ac1-4fab-977f-03d055c4bf2d,WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427)
THEN
PROC_WYR_Axe_HarperRunAway();

PROC
PROC_WYR_Axe_HarperRunAway()
THEN
PROC_NotifyWhenReadyToMoveOn(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_HarperRunningAway");

PROC
PROC_ReadyToMoveOn(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, "WYR_Axe_HarperRunningAway")
THEN
PROC_CharacterMoveTo(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,S_WYR_Axe_HarperRunTo_427a9276-2b13-471d-b338-c61d04ef4990,"Run","WYR_Axe_HarperRunAway");

IF
EntityEvent(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,"WYR_Axe_HarperRunAway")
THEN
Unlock(S_WYR_Axe_Backdoor_Door_02_4f22b49d-b77f-47bf-b7ac-1025ac387a0a);
PROC_DisappearOutOfSight(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,"Run",1,"");

//END_REGION Harper dialogs after ambush


//REGION Jaheira leaves if not recruited

IF
LevelUnloading("BGO_Main_A")
THEN
PROC_WYR_Danthelon_JaheiraCheckLeave();

PROC
PROC_WYR_Danthelon_JaheiraCheckLeave()
AND
DB_GlobalFlag(WYR_Axe_State_DoppelgangersDead_416b80ee-d87d-4980-90e4-bee004151544)
AND
NOT DB_GlobalFlag(GLO_Origin_PartOfTheTeam_Jaheira_d7d29efe-70bb-47c2-9db3-bc8a10347bc6)
AND
GetRegion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,"BGO_Main_A")
THEN
PROC_WYR_Danthelon_JaheiraLeave();

PROC
PROC_WYR_Danthelon_JaheiraLeave()
THEN
DB_WYR_Danthelon_JaheiraLeaves(1);
SetOnStage(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,0);
SetOnStage(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,0);

IF
WentOnStage(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,0)
AND
DB_WYR_Danthelon_JaheiraLeaves(1)
THEN
NOT DB_WYR_Danthelon_JaheiraLeaves(1);
PROC_WYR_Danthelon_JaheiraLeft();

PROC
PROC_WYR_Danthelon_JaheiraLeft()
THEN
DB_NOOP(1);


// player never went to Danthelon
PROC
PROC_WYR_Danthelon_JaheiraCheckLeave()
AND
NOT DB_GlobalFlag(WYR_Axe_State_DoppelgangersDead_416b80ee-d87d-4980-90e4-bee004151544)
THEN
PROC_WYR_Axe_Clear();

PROC
PROC_WYR_Axe_Clear()
AND
NOT DB_GlobalFlag(GLO_Origin_PartOfTheTeam_Jaheira_d7d29efe-70bb-47c2-9db3-bc8a10347bc6)
THEN
SetOnStage(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,0);

PROC
PROC_WYR_Axe_Clear()
THEN
SetOnStage(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,0);

PROC
PROC_WYR_Axe_Clear()
AND
NOT DB_PermaDefeated(S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456)
THEN
SetOwner(S_WYR_Axe_Backdoor_Door_01_e41570db-5b81-4536-a8ef-84cac5263802,S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456);
SetOwner(S_WYR_Axe_OpenDoorButton_01_d52a3860-6236-4b3a-a425-488ad30d617b,S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456);
SetOwner(S_WYR_Axe_OpenDoorButton_02_f3d37c6f-b925-4bf6-9a97-179322499992,S_WYR_Danthelon_3570c049-effb-4839-aaae-c628b5d01456);

PROC
PROC_WYR_Axe_Clear()
AND
QRY_GLO_Jaheira_PreCityQuestChecker()
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "ORI_HighHarper", "EnteredCity"); 

PROC
PROC_WYR_Axe_Clear()
AND
DB_WYR_Axe_Assassin(_Assassin)
THEN
SetOnStage(_Assassin,0);
SetFlag(WYR_Axe_State_Cleared_6f752da0-a985-4fe2-ae9c-d5989042cfcb,NULL_00000000-0000-0000-0000-000000000000,0);
GoalCompleted;

//END_REGION Jaheira leaves if not recruited


//REGION Aux

PROC
PROC_WYR_MakeSurprised_ExceptJaheira((CHARACTER)_Player)
AND
DB_PartyMembers(_OtherPlayer)
AND
_OtherPlayer != S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a
AND
DB_InRegion(_OtherPlayer,S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
THEN
PROC_MakeSurprised(_OtherPlayer);

IF
DialogActorJoined(_Dialog,_,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,_)
AND
DB_WYR_Axe_JaheiraDropPolymorphDialogs(_Dialog)
THEN
PROC_RemoveAllPolymorphs(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

//END_REGION Aux

//REGION Near Shop PAD
IF
EnteredTrigger(_Player, S_WYR_DanthelonShop_MainFloor_Zone_a61c9e4f-b541-4f87-81af-ca7558cc50e1)
AND
DB_Players(_Player)
THEN
PROC_WYR_Axe_DisableNearShopPAD();

IF
EnteredTrigger(_Player, S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e)
AND
DB_Players(_Player)
THEN
PROC_WYR_Axe_DisableNearShopPAD();

PROC
PROC_WYR_Axe_DisableNearShopPAD()
THEN
PROC_RemoveOneShotVoiceBarkTrigger(S_WYR_Axe_NearShopPADArea_3a2d4c7b-2602-425c-9dcb-8efe7e95fbfa, WYR_Axe_VB_NearShop_97199c35-fa75-c65f-2ba7-76783853446c);

//END_REGION
EXITSECTION
PROC_SceneOver("WYR_Axe_Ambush");

PROC_RemoveAllDialogEntriesForSpeaker(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7);
NOT DB_GLO_CharacterCorpseDialog(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7, WYR_Axe_RealHarper_Dead_ae4208e7-2718-5f4d-d497-65a15546dee8);
NOT DB_PermaDefeatedFlag(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,WYR_Axe_State_RealHarper_PermaDefeated_4ed87bc4-685c-49f1-bcbd-6717c04f7465);

TriggerUnregisterForCharacter(S_WYR_DanthelonShop_MainFloor_Zone_a61c9e4f-b541-4f87-81af-ca7558cc50e1,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
TriggerUnregisterForCharacter(S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e,S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7);
TriggerUnregisterForCharacter(S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
PROC_TriggerRegisterForPlayers(S_WYR_DanthelonShop_Basement_Zone_fb7fae60-7373-4d66-b793-fc8d3240194e);

NOT DB_GlobalFlagReactionAfterDialog(WYR_Knows_MinscDisappeared_819a8b67-554c-4cf1-96ae-14834b873b3e,WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427);

NOT DB_WYR_Axe_HostileInterrupts("Attacked");
NOT DB_WYR_Axe_HostileInterrupts("Died");
NOT DB_WYR_Axe_HostileInterrupts("EnteredCombat");
NOT DB_SceneNoHostileContinuousDisturbance("WYR_Axe_Ambush");
NOT DB_SceneManager(S_WYR_Axe_RealHarper_76b789cf-7d4f-431a-abba-90b12de21ec7,"WYR_Axe_Ambush");

NOT DB_WYR_Axe_PlayerSurprised(1);
NOT DB_WYR_Axe_DoppelgangersSurprised(1);

// Assassin, Shapeshifting Status
NOT DB_WYR_Axe_Assassin((CHARACTER)S_WYR_Axe_DoppelgangerAssassin_001_7867564d-583d-4558-a927-1508ea61cf75);
NOT DB_WYR_Axe_Assassin((CHARACTER)S_WYR_Axe_DoppelgangerAssassin_002_ba5b21ad-bcc4-407c-85a3-f0448a7094b5);
NOT DB_WYR_Axe_Assassin((CHARACTER)S_WYR_Axe_DoppelgangerAssassin_003_b3ebb78f-2102-496a-b277-27ac214a88ca);
NOT DB_WYR_Axe_Assassin((CHARACTER)S_WYR_Axe_DoppelgangerAssassin_004_d2d5409c-4196-42b1-b641-b32db6ac04e7);

ENDEXITSECTION
ParentTargetEdge "Act3_WYR_Danthelon"
