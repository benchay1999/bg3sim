Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Debug_WYR_WelcomeDialogRepro((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5,(FLAG)Debug_WYR_Ironhand_WelcomeDialog_GnomePrisoner_001_00b1d993-21f7-4d10-93cf-a03cf8ee1738);
DB_Debug_WYR_WelcomeDialogRepro((CHARACTER)S_WYR_Ironhand_Artificer_001_627b5b4d-51df-416a-800a-ddf357c96995,(FLAG)Debug_WYR_Ironhand_WelcomeDialog_Artificer_001_09219fa2-4ff6-4f3e-b44a-09fd466a208e);
DB_Debug_WYR_WelcomeDialogRepro((CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,(FLAG)Debug_WYR_Ironhand_WelcomeDialog_GnomeWorkerDaffy_a86e1e39-669f-447c-9633-2ed5b715278f);
DB_Debug_WYR_WelcomeDialogRepro((CHARACTER)S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,(FLAG)Debug_WYR_Ironhand_WelcomeDialog_InjuredGnome_ae767dd2-bb22-40c2-8a04-4d95ea4f9c1b);
DB_Debug_WYR_WelcomeDialogRepro((CHARACTER)S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e,(FLAG)Debug_WYR_Ironhand_WelcomeDialog_HiddenGnome_c487fc3b-086f-41f7-88f2-4b28d227222d);

DB_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_RemoveGnomes_ec2ad676-b6fc-4236-a6a7-d8d60be59db9);
DB_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_SetupAllGnomes_7024b82b-15e4-473a-9cf3-6d16f40d290a);
DB_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_SetupBarcusNoAct2Gnomes_40c3e0bb-0bb3-4ae2-aaec-954afe93c38e);
DB_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_SetupOnlyAct2Gnomes_91d859ce-9f32-4f16-91c1-692d44488ed0);
DB_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_SetupAllButBarcus_c7389112-74fb-437f-8a87-8bfb2c7874fb);
DB_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_RerunSceneSetup_db316b86-c86d-4eb4-a033-0783a4c65c83);

DB_Debug_WYR_Ironhand_SetupGnome((FLAG)Debug_WYR_Ironhand_SetupWulbren_d429a03c-2373-4356-accb-1b82823ec959,
    (CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
DB_Debug_WYR_Ironhand_SetupGnome((FLAG)Debug_WYR_Ironhand_SetupUnfortunateGnome_902317ce-1794-4203-a3c5-acb685884f5b,
    (CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
DB_Debug_WYR_Ironhand_SetupGnome((FLAG)Debug_WYR_Ironhand_SetupInjuredGnome_61b9da09-f0df-4781-b850-fcaa1b41f376,
    (CHARACTER)S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96);
DB_Debug_WYR_Ironhand_SetupGnome((FLAG)Debug_WYR_Ironhand_SetupGnomeWorkerDaffy_a609b101-2def-48b0-a606-a70b2bdd30cb,
    (CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d);
DB_Debug_WYR_Ironhand_SetupGnome((FLAG)Debug_WYR_Ironhand_SetupGnomePrisoner_001_514fbabf-2733-4eb3-9e4b-289a9643556e,
    (CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5);
DB_Debug_WYR_Ironhand_SetupGnome((FLAG)Debug_WYR_Ironhand_SetupGnomePrisoner_002_f153de51-f694-4bd4-8d5f-f526156a864d,
    (CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5);
DB_Debug_WYR_Ironhand_SetupGnome((FLAG)Debug_WYR_Ironhand_SetupHiddenGnome_81139587-e353-4d78-8640-2221d0d5ce60,
    (CHARACTER)S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e);

// Wulbren
DB_WYR_SetupForAct_FlagChecks((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,(FLAG)HAV_SavingPrisoners_State_WulbrenReturned_73a0c737-a7d1-9945-01d3-003fde6ed946,1);
DB_GLO_SetupForAct_Character("BGO_Main_A",(CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
// Thulla (note that order is important! she requires a Healed flag to be set before LeaderFreedGnomes flag is!)
DB_WYR_SetupForAct_FlagChecks((CHARACTER)S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, (FLAG)UND_InjuredGnome_State_Healed_6dd9c64e-a6b0-47d5-87f6-b1a1c49d3ab4, 1);
DB_WYR_SetupForAct_FlagChecks(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, UND_InjuredGnome_State_WasPermaDefeated_b73fbcdc-e526-4c1e-b236-4e2ea49a1c27,0);
DB_WYR_SetupForAct_FlagChecks(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, (FLAG)UND_InjuredGnome_State_SporeServant_4a1d7911-e00d-4e32-8dff-3352a0a7af63, 0);
DB_GLO_SetupForAct_Character("BGO_Main_A",S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96);
// Barcus
DB_WYR_SetupForAct_FlagChecks(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,UND_State_LeaderFreedGnomes_49acb531-d0c4-d3d1-6af4-c79e246e4327,1);
DB_WYR_SetupForAct_FlagChecks(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,GLO_UnfortunateGnome_State_InHaven_a5673d70-d182-4dee-a93b-a2d7715856dc,1);
DB_GLO_SetupForAct_Character("BGO_Main_A",S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
// Laridda
DB_WYR_SetupForAct_FlagChecks(S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,UND_State_LeaderFreedGnomes_49acb531-d0c4-d3d1-6af4-c79e246e4327,1);
DB_WYR_SetupForAct_FlagChecks(S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,UND_GnomeWorkerDaffy_Dead_92f4d092-e94e-4b31-ab50-e8cb404fe908,0);
DB_GLO_SetupForAct_Character("BGO_Main_A",S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d);
// Nimble
DB_WYR_SetupForAct_FlagChecks(S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5,HAV_SavingPrisoners_State_Gnome001Returned_d9df5c72-356e-4649-8eda-3f844d084371,1);
DB_GLO_SetupForAct_Character("BGO_Main_A",S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5);
// Nickels
DB_WYR_SetupForAct_FlagChecks(S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5,HAV_SavingPrisoners_State_Gnome002Returned_60ef28ec-9557-4c00-b3be-41982550e228,1);
DB_GLO_SetupForAct_Character("BGO_Main_A",S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5);
// Philomeen
DB_WYR_SetupForAct_FlagChecks(S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e,UND_EscapedGnome_State_GnomeSaved_c5fe7588-a178-3d13-7303-332689b4941a,1);
DB_WYR_SetupForAct_FlagChecks(S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e,UND_PanicRoom_Event_GnomeSuicide_b230716c-ca7d-4a41-9980-e0c8b8655a72,0);
DB_GLO_SetupForAct_Character("BGO_Main_A",S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e);

DB_WYR_Ironhand_Init((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,
    (TRIGGER)S_WYR_Ironhand_InitPos_Wulbren_871e4d40-bf0b-4222-b1df-223172782023,
    (DIALOGRESOURCE)WYR_Wulbren_fcd8ff87-7c42-9748-9a31-e9b8568f1a58,
    (FLAG)WYR_Ironhand_InAct3_Wulbren_3097cdd8-33eb-4ca0-956b-b2826bb01f8a);
DB_WYR_Ironhand_Init(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,
    S_WYR_Ironhand_InitPos_Unfortunate_8a9604a3-8937-4ce2-ad94-d06aaf8af704,
    WYR_UnfortunateGnome_4897143a-f55e-123f-2fed-8a7c7dfd96a6,
    WYR_Ironhand_InAct3_UnfortunateGnome_ac1b779a-401d-4119-bebd-3efb70a697ee);
DB_WYR_Ironhand_Init(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,
    S_WYR_Ironhand_InitPos_Injured_d4207fa3-c6c3-4723-92cc-df53003f4024,
    WYR_InjuredGnome_1432cbff-0a3a-d4a8-7acd-637aa3fe7ffc,
    WYR_Ironhand_InAct3_InjuredGnome_aeaf0ee1-6537-4003-b51b-5d88e2ead0c8);
DB_WYR_Ironhand_Init(S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,
    S_WYR_Ironhand_InitPos_GnomeWorkerDaffy_f7941cf0-cb0f-4c1c-b02a-7526b7078adc,
    WYR_GnomeWorkerDaffy_eefef09a-9f79-0a39-decd-4a19343f1ff6,
    WYR_Ironhand_InAct3_GnomeWorkerDaffy_4ccd5763-ff87-4893-9d90-1c187c2ac065);
DB_WYR_Ironhand_Init(S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5,
    S_WYR_Ironhand_InitPos_Prisoner_001_a1d7dfe0-f80f-4b53-8f3d-c2056b933f14,
    WYR_GnomePrisoner_001_326f7ca8-1dae-f0d6-5801-abab9b8af111,
    WYR_Ironhand_InAct3_GnomePrisoner_001_abde3a6c-f009-42a7-a967-f374b88e7dc2);
DB_WYR_Ironhand_Init(S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5,
    S_WYR_Ironhand_InitPos_Prisoner_002_74fa871a-6ed1-4a86-96b6-5f8eccb43fcf,
    WYR_GnomePrisoner_002_7787b2b4-4ef3-0032-86c8-88beae256f49,
    WYR_Ironhand_InAct3_GnomePrisoner_002_772e4743-7f87-47dc-a2d7-38f612327e1e);
DB_WYR_Ironhand_Init(S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e,
    S_WYR_Ironhand_InitPos_HiddenGnome_e850b71b-9dba-4677-8b87-48020f3bedbd,
    WYR_HiddenGnome_7380caae-ac94-0eeb-db80-d3d862737591,
    WYR_Ironhand_InAct3_HiddenGnome_a2450e42-adbf-4ade-b784-47e217ae6378);
DB_WYR_Ironhand_Init(S_WYR_Ironhand_Merchant_6fbabd70-2f22-47aa-8def-78459e662ca6,
    S_WYR_Ironhand_InitPos_Merchant_bbfe7f9d-2c11-47ec-a59d-27ff6b1a47b9,
    WYR_Ironhand_Merchant_7cce34f7-8cd3-9a32-1e91-7b9eed621c04,
    NULL_00000000-0000-0000-0000-000000000000);
DB_WYR_Ironhand_Init(S_WYR_Ironhand_Artificer_001_627b5b4d-51df-416a-800a-ddf357c96995,
    S_WYR_Ironhand_InitPos_Artificer_001_dced96be-14e4-4a00-8916-b381c7599e5e,
    WYR_Ironhand_Artificer_001_faa8393d-fa81-55a4-9f05-989813c76c87,
    NULL_00000000-0000-0000-0000-000000000000);
DB_WYR_Ironhand_Init(S_WYR_Ironhand_Artificer_002_8e9bf995-3c1d-4404-afe5-7bdfdc43bc35,
    S_WYR_Ironhand_InitPos_Artificer_002_4d5ab559-0c9f-470a-a050-1088ec153927,
    WYR_Ironhand_Artificer_002_42ae6f92-5274-b48a-c201-a1b01b9be17c,
    NULL_00000000-0000-0000-0000-000000000000);

DB_WYR_Ironhand_NewGnomeRoots((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,(CHARACTERROOT)WYR_Wulbren_c7bd0d1e-65d7-4ed1-b7c5-228690895da8);
DB_WYR_Ironhand_NewGnomeRoots((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,(CHARACTERROOT)WYR_UnfortunateGnome_febf6225-9355-45a9-84ff-40ee4e927fb3);
DB_WYR_Ironhand_NewGnomeRoots((CHARACTER)S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,(CHARACTERROOT)WYR_InjuredGnome_2fd0db85-e353-4754-ae86-c3f41042a3eb);
DB_WYR_Ironhand_NewGnomeRoots((CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,(CHARACTERROOT)WYR_GnomeWorkerDaffy_e4ce2419-e0bd-4b64-a939-2a2b4b9e471a);
DB_WYR_Ironhand_NewGnomeRoots((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5,(CHARACTERROOT)WYR_GnomePrisoner_001_a183843e-0b4f-4a08-9ff0-71942c080a8c);
DB_WYR_Ironhand_NewGnomeRoots((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5,(CHARACTERROOT)WYR_GnomePrisoner_002_1447a624-08a0-4971-b50c-3f25a000a203);
DB_WYR_Ironhand_NewGnomeRoots((CHARACTER)S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e,(CHARACTERROOT)WYR_HiddenGnome_e0dc09f2-9193-4af2-b578-ddf44b97aca9);

DB_WYR_Ironhand_TradeTreasure((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,"WYR_Ironhand_Worker");
DB_WYR_Ironhand_TradeTreasure((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,"WYR_UnfortunateGnome");
DB_WYR_Ironhand_TradeTreasure((CHARACTER)S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,"WYR_Ironhand_Worker");
DB_WYR_Ironhand_TradeTreasure((CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d,"WYR_Ironhand_Worker");
DB_WYR_Ironhand_TradeTreasure((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5,"WYR_Ironhand_Worker");
DB_WYR_Ironhand_TradeTreasure((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5,"WYR_Ironhand_Worker");
DB_WYR_Ironhand_TradeTreasure((CHARACTER)S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e,"WYR_Ironhand_Worker");

DB_WYR_Ironhand_Extra((CHARACTER)S_WYR_Ironhand_Merchant_6fbabd70-2f22-47aa-8def-78459e662ca6);
DB_WYR_Ironhand_Extra((CHARACTER)S_WYR_Ironhand_Artificer_001_627b5b4d-51df-416a-800a-ddf357c96995);
DB_WYR_Ironhand_Extra((CHARACTER)S_WYR_Ironhand_Artificer_002_8e9bf995-3c1d-4404-afe5-7bdfdc43bc35);

DB_WYR_Ironhand_ExtraExtra((CHARACTER)S_WYR_Ironhand_ArtificerExtra_001_a47370d5-d3f6-4acb-9d87-5d13a1f7e83c);
DB_WYR_Ironhand_ExtraExtra((CHARACTER)S_WYR_Ironhand_ArtificerExtra_002_18f98c7f-0c7d-42b1-9ff2-acbcfd764e60);

DB_Dialogs(S_WYR_Ironhand_ArtificerExtra_001_a47370d5-d3f6-4acb-9d87-5d13a1f7e83c,WYR_Ironhand_ArtificerExtra_001_9688af0c-f507-ff0a-bdab-3b8d938d74d2);
DB_Dialogs(S_WYR_Ironhand_ArtificerExtra_002_18f98c7f-0c7d-42b1-9ff2-acbcfd764e60,WYR_Ironhand_ArtificerExtra_002_4edb7e85-e497-3650-2c91-74a4bd96ca66);

DB_WYR_Ironhand_ExtraExtra_Pos((CHARACTER)S_WYR_Ironhand_ArtificerExtra_001_a47370d5-d3f6-4acb-9d87-5d13a1f7e83c,(TRIGGER)S_WYR_Ironhand_InitPos_HiddenGnome_e850b71b-9dba-4677-8b87-48020f3bedbd);
DB_WYR_Ironhand_ExtraExtra_Pos((CHARACTER)S_WYR_Ironhand_ArtificerExtra_001_a47370d5-d3f6-4acb-9d87-5d13a1f7e83c,(TRIGGER)S_WYR_Ironhand_InitPos_GnomeWorkerDaffy_f7941cf0-cb0f-4c1c-b02a-7526b7078adc);
DB_WYR_Ironhand_ExtraExtra_Pos((CHARACTER)S_WYR_Ironhand_ArtificerExtra_002_18f98c7f-0c7d-42b1-9ff2-acbcfd764e60,(TRIGGER)S_WYR_Ironhand_InitPos_Injured_d4207fa3-c6c3-4723-92cc-df53003f4024);
DB_WYR_Ironhand_ExtraExtra_Pos((CHARACTER)S_WYR_Ironhand_ArtificerExtra_002_18f98c7f-0c7d-42b1-9ff2-acbcfd764e60,(TRIGGER)S_WYR_Ironhand_InitPos_Prisoner_001_a1d7dfe0-f80f-4b53-8f3d-c2056b933f14);

DB_WYR_Ironhand_ExtraExtra_RoleFlag((CHARACTER)S_WYR_Ironhand_ArtificerExtra_001_a47370d5-d3f6-4acb-9d87-5d13a1f7e83c,
	(TRIGGER)S_WYR_Ironhand_InitPos_HiddenGnome_e850b71b-9dba-4677-8b87-48020f3bedbd,
	(FLAG)WYR_Ironhand_ReplaceGnome_1_ef6260ad-61c0-4dd3-b505-1a30bf773b4f);
DB_WYR_Ironhand_ExtraExtra_RoleFlag((CHARACTER)S_WYR_Ironhand_ArtificerExtra_002_18f98c7f-0c7d-42b1-9ff2-acbcfd764e60,
	(TRIGGER)S_WYR_Ironhand_InitPos_Injured_d4207fa3-c6c3-4723-92cc-df53003f4024,
	(FLAG)WYR_Ironhand_ReplaceGnome_1_ef6260ad-61c0-4dd3-b505-1a30bf773b4f);

DB_WYR_Ironhand_Checkpoint_Candidate(1,(CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5);
DB_WYR_Ironhand_Checkpoint_Candidate(1,S_WYR_Ironhand_Artificer_001_627b5b4d-51df-416a-800a-ddf357c96995);

DB_WYR_Ironhand_Checkpoint_Candidate(2,(CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d);
DB_WYR_Ironhand_Checkpoint_Candidate(2,S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96);
DB_WYR_Ironhand_Checkpoint_Candidate(2,S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e);

DB_WYR_Ironhand_WelcomeGnome((CHARACTER)S_WYR_Ironhand_Artificer_002_8e9bf995-3c1d-4404-afe5-7bdfdc43bc35);

NOT DB_WYR_Ironhand_SceneGnomes(0,(CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

DB_WYR_Ironhand_Pos_BeforeCheckpoint(1,(TRIGGER)S_WYR_Ironhand_Gnome1PosBeforeCheckpoint_eb85ad60-7958-45ab-ab56-211f13c7bf25);
DB_WYR_Ironhand_Pos_BeforeCheckpoint(2,(TRIGGER)S_WYR_Ironhand_Gnome2PosBeforeCheckpoint_81d426f8-821d-4537-bda1-edcfbb23d938);
DB_WYR_Ironhand_Pos_BridgeCheckpointDialog(1,(TRIGGER)S_WYR_Ironhand_GnomeBridgePos_1_9493a470-c1ed-40b4-9f75-818a217359dc);
DB_WYR_Ironhand_Pos_BridgeCheckpointDialog(2,(TRIGGER)S_WYR_Ironhand_GnomeBridgePos_2_fa2ebb46-3d07-4b5d-b2e0-8ffeb967591f);
DB_WYR_Ironhand_Pos_TpInsideCave(1,(TRIGGER)S_WYR_Ironhand_EscapeCheckpoint_Pos4_de334604-9b30-4315-bdfc-7e2f3083bda3);
DB_WYR_Ironhand_Pos_TpInsideCave(2,(TRIGGER)S_WYR_Ironhand_EscapeCheckpoint_Pos4_de334604-9b30-4315-bdfc-7e2f3083bda3);
DB_WYR_Ironhand_Pos_ReturnToRoom(1,(TRIGGER)S_WYR_Ironhand_EscapeCheckpoint_InRoom_0_370a47ab-dd55-4040-acbb-19660816c6d8);
DB_WYR_Ironhand_Pos_ReturnToRoom(2,(TRIGGER)S_WYR_Ironhand_EscapeCheckpoint_InRoom_1_41dfef6e-1a9f-404e-a17c-d8e8dbd64ccb);

DB_ItemOwnerShipClearItem("BGO_Main_A",S_WYR_DOOR_Single_Dungeon_Abbey_B_001_ac8f8d4e-2442-46b9-91b2-9a88dad2d5bf);
DB_ItemOwnerShipTriggers("BGO_Main_A",S_WYR_Ironhand_OwnershipZone_69edc17a-4c40-474e-abb9-89ef1bbd18c4,S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);

DB_ItemOwnerShipClearItem("BGO_Main_A",DOOR_Single_Dungeon_Abbey_B_001_ac8f8d4e-2442-46b9-91b2-9a88dad2d5bf);
DB_ItemOwnerShipClearItem("BGO_Main_A",S_WYR_Ironhand_CaveExitLadder_31e6d8a9-aaa8-4e9f-bec1-394f597b2500);
DB_ItemOwnerShipClearItem("BGO_Main_A",S_WYR_Ironhand_HatchLever_7b551707-c332-4acd-8b4e-5da47cac1ca6);


DB_WYR_Ironhand_SplatterStatuses((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "CUST_SPLATTER_GLO_Wulbren");
DB_WYR_Ironhand_SplatterStatuses((CHARACTER)S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, "CUST_SPLATTER_GLO_InjuredGnome");
DB_WYR_Ironhand_SplatterStatuses((CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d, "CUST_SPLATTER_GLO_GnomeWorkerDaffy");
DB_WYR_Ironhand_SplatterStatuses((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5, "CUST_SPLATTER_GLO_GnomePrisoner_001");
DB_WYR_Ironhand_SplatterStatuses((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5, "CUST_SPLATTER_GLO_GnomePrisoner_002");
DB_WYR_Ironhand_SplatterStatuses((CHARACTER)S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e, "CUST_SPLATTER_GLO_HiddenGnome");

DB_GLO_CompoundFlag(WYR_Ironhand_BombDestroyed_8ed705b5-6f86-4cff-8c14-cc1c7b87ad9c, (FLAG)LOW_SteelWatchFoundry_State_WastedRunePowderBomb_4cbe2c62-5a28-431d-8f09-43f4c0e92ab6);
KBSECTION
//REGION Debug

// TODO: remove later
IF
DB_IsEditor(1)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_Flag,_Gnome)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

IF
DB_IsEditor(1)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_DebugFlag,_Gnome)
AND
DB_WYR_SetupForAct_FlagChecks(_Gnome,_Flag,1)
AND
NOT DB_GlobalFlag(_DebugFlag)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

IF
DB_IsEditor(1)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_DebugFlag,_Gnome)
AND
DB_GlobalFlag(_DebugFlag)
AND
DB_WYR_SetupForAct_FlagChecks(_Gnome,_Flag,0)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

QRY
QRY_GLO_SetupForAct_CustomBlock("BGO_Main_A",(CHARACTER)_Gnome)
AND
DB_IsEditor(1)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_Flag,_Gnome)
AND
NOT DB_GlobalFlag(_Flag)
THEN
DB_NOOP(1);


PROC
PROC_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_RemoveGnomes_ec2ad676-b6fc-4236-a6a7-d8d60be59db9)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_Flag,_Gnome)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

PROC
PROC_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_RemoveGnomes_ec2ad676-b6fc-4236-a6a7-d8d60be59db9)
THEN
PROC_GLO_SetupForAct_DebugRerun();

PROC
PROC_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_SetupAllGnomes_7024b82b-15e4-473a-9cf3-6d16f40d290a)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_Flag,_Gnome)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

PROC
PROC_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_SetupAllGnomes_7024b82b-15e4-473a-9cf3-6d16f40d290a)
THEN
PROC_GLO_SetupForAct_DebugRerun();


PROC
PROC_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_SetupOnlyAct2Gnomes_91d859ce-9f32-4f16-91c1-692d44488ed0)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_Flag,_Gnome)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

PROC
PROC_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_SetupOnlyAct2Gnomes_91d859ce-9f32-4f16-91c1-692d44488ed0)
THEN
PROC_GlobalSetFlagAndCache(Debug_WYR_Ironhand_SetupWulbren_d429a03c-2373-4356-accb-1b82823ec959);
PROC_GlobalSetFlagAndCache(Debug_WYR_Ironhand_SetupGnomePrisoner_001_514fbabf-2733-4eb3-9e4b-289a9643556e);
PROC_GlobalSetFlagAndCache(Debug_WYR_Ironhand_SetupGnomePrisoner_002_f153de51-f694-4bd4-8d5f-f526156a864d);
PROC_GLO_SetupForAct_DebugRerun();


PROC
PROC_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_SetupAllButBarcus_c7389112-74fb-437f-8a87-8bfb2c7874fb)
THEN
PROC_GlobalSetFlagAndCache(Debug_WYR_Ironhand_SetupWulbren_d429a03c-2373-4356-accb-1b82823ec959);
PROC_GlobalClearFlagAndCache(Debug_WYR_Ironhand_SetupUnfortunateGnome_902317ce-1794-4203-a3c5-acb685884f5b);
PROC_GlobalSetFlagAndCache(Debug_WYR_Ironhand_SetupInjuredGnome_61b9da09-f0df-4781-b850-fcaa1b41f376);
PROC_GlobalSetFlagAndCache(Debug_WYR_Ironhand_SetupGnomeWorkerDaffy_a609b101-2def-48b0-a606-a70b2bdd30cb);
PROC_GlobalSetFlagAndCache(Debug_WYR_Ironhand_SetupGnomePrisoner_001_514fbabf-2733-4eb3-9e4b-289a9643556e);
PROC_GlobalSetFlagAndCache(Debug_WYR_Ironhand_SetupGnomePrisoner_002_f153de51-f694-4bd4-8d5f-f526156a864d);
PROC_GlobalSetFlagAndCache(Debug_WYR_Ironhand_SetupHiddenGnome_81139587-e353-4d78-8640-2221d0d5ce60);
PROC_GLO_SetupForAct_DebugRerun();


PROC
PROC_OneTimeEventFlag((FLAG)Debug_WYR_Ironhand_RerunSceneSetup_db316b86-c86d-4eb4-a033-0783a4c65c83)
THEN
PROC_GLO_SetupForAct_DebugRerun();

PROC
PROC_GLO_SetupForAct_DebugRerun()
AND
DB_WYR_SetupForAct_FlagChecks(_Gnome,_Flag,1)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_,_Gnome)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

PROC
PROC_GLO_SetupForAct_DebugRerun()
AND
DB_WYR_SetupForAct_FlagChecks(_Gnome,_Flag,0)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_,_Gnome)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

PROC
PROC_GLO_SetupForAct_DebugRerun()
AND
DB_WYR_Ironhand_Gnomes((CHARACTER)_Gnome)
THEN
PROC_SetOnStage(_Gnome,0);
ClearFlag(WYR_Ironhand_FromPrecedingAct_f2edcf6f-22cf-423d-ab56-8a968b681f58,_Gnome,0);
NOT DB_WYR_Ironhand_Gnomes(_Gnome);

PROC
PROC_GLO_SetupForAct_DebugRerun()
AND
DB_WYR_Ironhand_Init(_Gnome,_,_,_Flag)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

PROC
PROC_GLO_SetupForAct_DebugRerun()
AND
DB_GlobalFlag(_DebugFlag)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_DebugFlag,_Gnome)
AND
DB_WYR_SetupForAct_FlagChecks(_Gnome,_Flag,1)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

PROC
PROC_GLO_SetupForAct_DebugRerun()
AND
DB_GlobalFlag(_DebugFlag)
AND
DB_Debug_WYR_Ironhand_SetupGnome(_DebugFlag,_Gnome)
AND
DB_WYR_SetupForAct_FlagChecks(_Gnome,_Flag,0)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

PROC
PROC_GLO_SetupForAct_DebugRerun()
AND
DB_WYR_Ironhand_ExtraExtra_Placed(_ExtraGnome,_Pos)
THEN
NOT DB_WYR_Ironhand_ExtraExtra_Placed(_ExtraGnome,_Pos);


IF
FlagSet(_Flag,NULL_00000000-0000-0000-0000-000000000000,_DialogID)
AND
DB_Debug_WYR_WelcomeDialogRepro(_Gnome,_Flag)
AND
DB_DialogPlayers(_DialogID,_Player,_)
THEN
PROC_ForceStopDialog(_Player);

IF
FlagSet(_Flag,NULL_00000000-0000-0000-0000-000000000000,_)
AND
DB_Debug_WYR_WelcomeDialogRepro(_Gnome,_Flag)
THEN
ClearFlag(_Flag,NULL_00000000-0000-0000-0000-000000000000,0);
DB_WYR_Ironhand_SceneGnomes(3,_Gnome);
PROC_SetOnStage(_Gnome,1);
TeleportTo(_Gnome,S_Debug_WYR_Ironhand_WelcomeDialogTPG_8b25879d-b135-4475-bc16-947abfa13a3e,"DB_Debug_WYR_WelcomeDialogRepro");

IF
EntityEvent(_Gnome,"DB_Debug_WYR_WelcomeDialogRepro")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player,S_Debug_WYR_Ironhand_WelcomeDialogTP_e402f075-0c77-4e69-ae2c-38374eae97a0,"DB_Debug_WYR_WelcomeDialogRepro");

IF
TextEvent("wyr_iron_skipscene")
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
AND
DB_WYR_Ironhand_Init(_Gnome,_Pos,_,_)
THEN
SetFlag(WYR_Ironhand_State_GnomesReturned_a082d5cd-8360-429b-a77a-124e11ec99e8);
TeleportTo(_Gnome,_Pos,"");
ClearFlag(WYR_Ironhand_State_AtCheckpoint_fbba9492-5888-4f04-8be7-b6af11ab5463,_Gnome);

//END_REGION Debug


//REGION Act3 setup

PROC
PROC_LevelLoadedOnce("BGO_Main_A")
THEN
PROC_SetOnStage(S_WYR_Ironhands_UnfortunateGnomeDiary_736f4dc4-7755-44a8-85b5-ac5ad77e175d, 0);
PROC_TriggerRegisterForPlayers(S_WYR_Ironhand_SpotOnEntry_Off_ee352681-79ca-49e4-bdeb-3199be15b068);
PROC_SetOnStage(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, 0);
PROC_SetOnStage(S_WYR_Ironhand_GnomeHideoutRubble_ee2a91be-7fe6-48cb-9b46-63c75eea3e1d, 0);
Open(DOOR_Single_Dungeon_Abbey_B_001_ac8f8d4e-2442-46b9-91b2-9a88dad2d5bf);

PROC
PROC_LevelLoadedOnce("BGO_Main_A")
AND
DB_WYR_Ironhand_Extra(_Gnome)
THEN
PROC_SetOnStage(_Gnome,0);

PROC
PROC_LevelLoadedOnce("BGO_Main_A")
AND
DB_WYR_Ironhand_ExtraExtra(_Gnome)
THEN
PROC_SetOnStage(_Gnome,0);

// only place other gnomes if Wulbren is here
QRY
QRY_GLO_SetupForAct_CustomBlock("BGO_Main_A",(CHARACTER)_Gnome)
AND
DB_WYR_Ironhand_Init(_Gnome,_,_,_)
AND
_Gnome != S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf
AND
NOT DB_GlobalFlag(WYR_Ironhand_InAct3_Wulbren_3097cdd8-33eb-4ca0-956b-b2826bb01f8a)
THEN
DB_NOOP(1); 

//check flags
QRY
QRY_GLO_SetupForAct_CustomBlock("BGO_Main_A",(CHARACTER)_Gnome)
AND
DB_WYR_SetupForAct_FlagChecks(_Gnome,_Flag,_State)
AND
_Gnome != S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf
AND
DB_Negate(_State,_NotState)
AND
GetFlag(_Flag,NULL_00000000-0000-0000-0000-000000000000,_NotState)
THEN
DB_NOOP(1);

PROC
PROC_GLO_SetupForAct("BGO_Main_A",(CHARACTER)_Gnome,1)
AND
DB_WYR_Ironhand_SplatterStatuses(_Gnome,_SplatterStatus)
THEN
RemoveStatus(_Gnome,_SplatterStatus,NULL_00000000-0000-0000-0000-000000000000);
RemoveSplatters(_Gnome);
SetHitpointsPercentage(_Gnome, 100.0);
PROC_SelfHealing_Enable(_Gnome);


// Thulla has DB_PreventPermaDefeated in Act1 - so that when she dies and resurrected as SporeServant, she can still be in a SporeServant dialog. In case it wasn't removed in Act1, we should remove it in Act 3 to be sure.
PROC
PROC_GLO_SetupForAct("BGO_Main_A",(CHARACTER)S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,_)
THEN
NOT DB_PreventPermaDefeated(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96);

PROC
PROC_GLO_SetupForAct("BGO_Main_A",(CHARACTER)S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,1)
THEN
PROC_CharacterEnableAllCrimes(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96);
PROC_SceneOver("UND_InjuredGnome_SceneDialogOnly");

PROC
PROC_GLO_SetupForAct("BGO_Main_A",(CHARACTER)S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,0)
AND
NOT DB_PermaDefeated(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
AND
DB_GlobalFlag((FLAG)UND_InjuredGnome_State_SporeServant_4a1d7911-e00d-4e32-8dff-3352a0a7af63)
THEN
PROC_DieImmediate(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,DEATHTYPE.None,0);

PROC
PROC_GLO_SetupForAct("BGO_Main_A",(CHARACTER)_Gnome,1)
AND
DB_WYR_Ironhand_Init(_Gnome,_,_,_)
THEN
SetTag(_Gnome,BADASSCIVILIAN_91f4b379-63a2-40e9-a509-7b9b2f90e4c8);
PROC_SetOnStage(_Gnome,1);
SetFlag(WYR_Ironhand_FromPrecedingAct_f2edcf6f-22cf-423d-ab56-8a968b681f58,_Gnome,0);
DB_WYR_Ironhand_Gnomes(_Gnome);

// Setup is done
PROC
PROC_GLO_SetupForActComplete("BGO_Main_A")
AND
NOT QRY_IsEmptyDB("DB_WYR_Ironhand_Gnomes",1)
AND
DB_WYR_Ironhand_Extra(_Gnome)
THEN
PROC_SetOnStage(_Gnome,1);
DB_WYR_Ironhand_Gnomes(_Gnome);

PROC
PROC_GLO_SetupForActComplete("BGO_Main_A")
AND
NOT QRY_IsEmptyDB("DB_WYR_Ironhand_Gnomes",1)
AND
SysCount("DB_WYR_Ironhand_Gnomes",1,_Count)
AND
_Count <= 5
AND
DB_WYR_Ironhand_ExtraExtra(_Gnome)
THEN
PROC_SetOnStage(_Gnome,1);
DB_WYR_Ironhand_Gnomes(_Gnome);
PROC_WYR_Ironhand_ExtraExtra_PutInPlace(_Gnome);

PROC
PROC_GLO_SetupForActComplete("BGO_Main_A")
THEN
ClearFlag(WYR_Ironhand_State_NotAllGnomesInAct3_1e57a8b5-0f36-489c-8dd4-a401dea8d3e9);

PROC
PROC_GLO_SetupForActComplete("BGO_Main_A")
AND
DB_WYR_Ironhand_Init(_Gnome,_,_,_)
AND
NOT DB_WYR_Ironhand_Gnomes(_Gnome)
THEN
SetFlag(WYR_Ironhand_State_NotAllGnomesInAct3_1e57a8b5-0f36-489c-8dd4-a401dea8d3e9);

PROC
PROC_GLO_SetupForActComplete("BGO_Main_A")
AND
DB_WYR_Ironhand_Gnomes(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
PROC_WYR_Ironhand_GnomesAddedToAct(); // this means keys npcs are here in Act3


PROC
PROC_GLO_SetupForActComplete("BGO_Main_A")
AND
NOT DB_WYR_Ironhand_Gnomes(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
PROC_WYR_Ironhand_NoGnomesInAct();

IF
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_WYR_Ironhand_Gnomes(_Gnome)
AND
DB_WYR_Ironhand_Init(_Gnome,_Pos,_Dialog,_Flag)
THEN
PROC_WYR_IronHand_DoInit((CHARACTER)_Gnome,(TRIGGER)_Pos,(DIALOGRESOURCE)_Dialog,(FLAG)_Flag);

PROC
PROC_WYR_IronHand_DoInit((CHARACTER)_Gnome,(TRIGGER)_Pos,(DIALOGRESOURCE)_Dialog,(FLAG)_Flag)
AND
_Pos != NULL_00000000-0000-0000-0000-000000000000
THEN
TeleportTo(_Gnome,_Pos,"WYR_Ironhand_InitTP");
LookFromTrigger(_Gnome,_Pos,0);

PROC
PROC_WYR_IronHand_DoInit((CHARACTER)_Gnome,(TRIGGER)_Pos,(DIALOGRESOURCE)_Dialog,(FLAG)_Flag)
AND
_Dialog != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Gnome);
DB_Dialogs(_Gnome,_Dialog);

PROC
PROC_WYR_IronHand_DoInit((CHARACTER)_Gnome,(TRIGGER)_Pos,(DIALOGRESOURCE)_Dialog,(FLAG)_Flag)
AND
_Flag != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_GlobalSetFlagAndCache(_Flag);

IF
DB_WYR_Ironhand_Gnomes(_Gnome)
THEN
SetFaction(_Gnome,ACT3_WYR_IronhandGnomes_9e36c2d3-a13f-4d4e-bc5b-8ac237f84159);

IF
DB_WYR_Ironhand_Gnomes(_Gnome)
THEN
TriggerRegisterForCharacter(S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0, _Gnome);

IF
DB_InRegion(_Gnome, S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
AND
DB_WYR_Ironhand_Gnomes(_Gnome)
THEN
SetCombatGroupID(_Gnome, "WYR_IronhandHideoutGnomes");

IF
LeftTrigger(_Gnome, S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
AND
DB_WYR_Ironhand_Gnomes(_Gnome)
THEN
SetCombatGroupID(_Gnome, "WYR_IronhandOutsideGnomes");

// Transform
IF
DB_WYR_Ironhand_Gnomes(_Gnome)
AND
NOT DB_OffStage(_Gnome)
AND
DB_WYR_Ironhand_NewGnomeRoots(_Gnome,_Root)
THEN
Transform(_Gnome, _Root, LevelTraveler_9453ac5e-5ad4-429a-9743-dbf3e1d641cf);

IF
DB_WYR_Ironhand_Gnomes(_Gnome)
AND
DB_WYR_Ironhand_TradeTreasure(_Gnome,_TradeTreasure)
THEN
PROC_SetCustomTradeTreasure(_Gnome,_TradeTreasure);
SetCanTrade(_Gnome,1);

IF
DB_WYR_Ironhand_Gnomes((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
PROC_ToInventoryAndOnStage(S_WYR_Ironhands_UnfortunateGnomeDiary_736f4dc4-7755-44a8-85b5-ac5ad77e175d, S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);

// Extra gnomes
PROC
PROC_WYR_Ironhand_ExtraExtra_PutInPlace((CHARACTER)_ExtraGnome)
AND
DB_WYR_Ironhand_ExtraExtra_Pos(_ExtraGnome,_Pos)
AND
DB_WYR_Ironhand_Init(_Gnome,_Pos,_,_)
AND
NOT DB_WYR_Ironhand_Gnomes(_Gnome)
AND
NOT DB_WYR_Ironhand_ExtraExtra_Placed(_ExtraGnome,_)
THEN
DB_WYR_Ironhand_ExtraExtra_Placed(_ExtraGnome,_Pos);
TeleportTo(_ExtraGnome,_Pos,"WYR_Ironhand_InitTP");
LookFromTrigger(_ExtraGnome,_Pos,0);

IF
DB_WYR_Ironhand_ExtraExtra_Placed(_ExtraGnome,_Pos)
AND
DB_WYR_Ironhand_ExtraExtra_RoleFlag(_ExtraGnome,_Pos,_Flag)
THEN
SetFlag(_Flag,_ExtraGnome,0);

// Dialog with Wulbren
PROC
PROC_StartDialog_AddExtraSpeakers(WYR_Wulbren_fcd8ff87-7c42-9748-9a31-e9b8568f1a58,_DialogID)
AND
QRY_SpeakerIsAvailable(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
AND
QRY_IsInRange(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,15.0)
THEN
PROC_DialogAddSpeakingActor(_DialogID,S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);

//END_REGION Act3 setup


//REGION Gnomes at checkpoint setup

PROC
PROC_WYR_Ironhand_GnomesAddedToAct()
THEN
PROC_WYR_Ironhand_SetupCheckpointScene();

PROC
PROC_WYR_Ironhand_SetupCheckpointScene()
THEN
SysClear("DB_WYR_Ironhand_SceneGnomes",2);

PROC
PROC_WYR_Ironhand_SetupCheckpointScene()
THEN
PROC_WYR_Ironhand_SetupSceneGnome(1);
PROC_WYR_Ironhand_SetupSceneGnome(2);

PROC
PROC_WYR_Ironhand_SetupSceneGnome((INTEGER)_Idx)
AND
DB_WYR_Ironhand_Checkpoint_Candidate(_Idx,_Gnome) // iterate candidates
AND
DB_WYR_Ironhand_Gnomes(_Gnome) // it's in this Act
AND
NOT DB_WYR_Ironhand_SceneGnomes(_Idx,_) // we haven't chosen speaker yet
THEN
DB_WYR_Ironhand_SceneGnomes(_Idx,_Gnome);
DB_CustomDialogRange(_Gnome,9999);

PROC
PROC_WYR_Ironhand_SetupCheckpointScene()
AND
DB_WYR_Ironhand_SceneGnomes(_Id,_Gnome)
AND
DB_WYR_Ironhand_Pos_BeforeCheckpoint(_Id,_Pos)
AND
GetFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb,_Gnome,_NoCower)
THEN
TeleportTo(_Gnome,_Pos);
DB_WYR_Ironhand_HadNoCower(_Gnome,_NoCower);
SetFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb,_Gnome);
SetFlag(WYR_Ironhand_State_AtCheckpoint_fbba9492-5888-4f04-8be7-b6af11ab5463,_Gnome);

//REGION SUB Combat during scene and running home

IF
DB_Is_InCombat(_Gnome,_CombatID)
AND
DB_WYR_Ironhand_SceneGnomes(_,(CHARACTER)_Gnome)
AND
DB_Is_InCombat(_Player,_CombatID)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_WYR_Ironhand_GnomesReturned(2)
AND
IsEnemy(_Gnome,_Player,1)
THEN
PROC_GlobalSetFlagAndCache(WYR_Ironhand_PlayerAttackedGnomesAtBridge_4b131584-19f8-4917-858b-495ae70d67cf);

IF
KilledBy(_Gnome,_Player,_,_)
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_WYR_Ironhand_GnomesReturned(2)
THEN
PROC_GlobalSetFlagAndCache(WYR_Ironhand_PlayerAttackedGnomesAtBridge_4b131584-19f8-4917-858b-495ae70d67cf);

//END_REGION SUB Combat during scene and running home
//END_REGION Gnomes at checkpoint setup


//REGION Gnomes intervent

PROC
PROC_WYR_Ironhand_GnomesIntervent((CHARACTER)_SteelWatch)
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
THEN
SetFlag(WYR_Ironhand_WasAtBridge_593d213b-ab66-490b-98af-d9f7243c5afc,_Gnome);

PROC
PROC_WYR_Ironhand_GnomesIntervent((CHARACTER)_SteelWatch)
AND
DB_WYR_Ironhand_SceneGnomes(1,_Gnome)
THEN
DB_WYR_Ironhand_SteelWatchSunflashed(_SteelWatch, _Gnome);
CreateExplosion(_SteelWatch,"Projectile_Sunflash",-1,_Gnome);
PROC_CharacterDisableCrime(_SteelWatch, "EnemyOfAbsolute");
//ApplyStatus(_SteelWatch,"SUNFLASHED",12.0,1,NULL_00000000-0000-0000-0000-000000000000);
PROC_WYR_Ironhand_GnomesRun();

PROC
PROC_WYR_Ironhand_GnomesRun()
THEN
SetFlag(WYR_Ironhand_Event_GnomesRanAway_f7bd298c-ac5d-4654-8368-c1022172272f);

//END_REGION Gnomes intervent


//REGION Checkpoint without issues => no scene, send gnomes home

IF
DialogEnded(WYR_South_Primary_f03a1685-b148-b70e-b773-b62404525308,_DialogID)
AND
DB_GlobalFlag(WYR_South_State_AccessGranted_3339af4f-3214-4d10-aaab-3d3511b9ab74)
AND
DB_DialogPlayers(_DialogID,_Player,1)
AND
NOT DB_GlobalFlag((FLAG)WYR_Ironhand_Event_GnomesIntervent_06ad5471-b210-4ea0-a390-09bc7afdd332)
THEN
PROC_WYR_Ironhand_SkipScene();

PROC
PROC_WYR_Ironhand_SkipScene()
AND
NOT DB_GlobalFlag(WYR_Ironhand_State_GnomesReturned_a082d5cd-8360-429b-a77a-124e11ec99e8)
AND
DB_WYR_Ironhand_SceneGnomes(_Id,_Gnome)
AND
DB_WYR_Ironhand_Pos_TpInsideCave(_Id,_Pos)
THEN
TeleportTo(_Gnome,_Pos,"WYR_Ironhand_EscapeCheckpoint_ToPos4");

//END_REGION Checkpoint without issues => no scene, send gnomes home


//REGION Entrances

IF
EnteredTrigger(_Char,S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
THEN
SetFlag(WYR_Ironhand_State_InBasement_d9bdb8db-e34d-4263-8b21-6fc21643d963,_Char);


IF
LeftTrigger(_Char,S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
THEN
ClearFlag(WYR_Ironhand_State_InBasement_d9bdb8db-e34d-4263-8b21-6fc21643d963,_Char);

IF
UseFinished(_,S_WYR_Ironhand_HatchLever_7b551707-c332-4acd-8b4e-5da47cac1ca6, 1)
THEN
DB_WYR_Ironhand_HatchUnlocked(1);

PROC
PROC_BlockUseOfItem(_Player,S_WYR_Ironhand_CaveExitLadder_31e6d8a9-aaa8-4e9f-bec1-394f597b2500)
AND
DB_Players(_Player)
AND
NOT DB_WYR_Ironhand_HatchUnlocked(1)
THEN
DB_CustomUseItemResponse(_Player,S_WYR_Ironhand_CaveExitLadder_31e6d8a9-aaa8-4e9f-bec1-394f597b2500,0);
PROC_TryStartAD(WYR_Ironhand_AD_HatchLocked_1e01d78e-a000-8a71-25a6-7581c362de94,_Player);

PROC
PROC_BlockUseOfItem(_Player,S_WYR_Ironhand_CaveEntranceHatch_a3e607db-91b0-42fe-bf3e-3ff82026659b)
AND
DB_Players(_Player)
AND
NOT DB_WYR_Ironhand_HatchUnlocked(1)
THEN
DB_CustomUseItemResponse(_Player,S_WYR_Ironhand_CaveEntranceHatch_a3e607db-91b0-42fe-bf3e-3ff82026659b,0);
PROC_TryStartAD(WYR_Ironhand_AD_HatchLocked_1e01d78e-a000-8a71-25a6-7581c362de94,_Player);

IF
DB_Sees(_Player,_Gnome)
AND
DB_Players(_Player)
AND
DB_WYR_Ironhand_Gnomes(_Gnome)
AND
DB_InRegion(_Player,S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
AND
NOT DB_GlobalFlag(WYR_Ironhand_State_PlayerSawGnomes_d2378ff6-22b2-4f31-aa4e-947408de5cdc)
THEN
SetFlag(WYR_Ironhand_State_PlayerSawGnomes_d2378ff6-22b2-4f31-aa4e-947408de5cdc,NULL_00000000-0000-0000-0000-000000000000,0);

//END_REGION Entrances


//REGION Trespassing crime and welcoming dialog

PROC
PROC_WYR_Ironhand_GnomesAddedToAct()
THEN
PROC_WYR_Ironhand_TrespassOn();

PROC
PROC_WYR_Ironhand_TrespassOn()
THEN
DB_TrespassTrigger(S_WYR_Ironhand_TrespassZone_a4d4730d-7706-457c-9585-e5f5e46282e0,TeleportTrigger_Bedroom_a6f18a3c-bab8-48d2-95dd-5acf1c88ec6a,"WYR_Ironhand_Trespass");

PROC
PROC_WYR_Ironhand_TrespassOff()
THEN
PROC_RemoveDBTrespassTrigger(S_WYR_Ironhand_TrespassZone_a4d4730d-7706-457c-9585-e5f5e46282e0);

IF
FlagSet((FLAG)WYR_Ironhand_Event_TrespassAllowed_f8e792be-ac01-4360-8ee9-29430cf6ee56,_,_)
THEN
PROC_WYR_Ironhand_TrespassOff();

IF
DialogActorLeft(WYR_NGB_Ironhand_Trespass_e36ee768-2cd1-6763-b1cc-46699d5d4b03,_Inst,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
GetFlag(WYR_Ironhand_Event_TrespassAllowed_f8e792be-ac01-4360-8ee9-29430cf6ee56,NULL_00000000-0000-0000-0000-000000000000,1)
THEN
PROC_WYR_Ironhand_TrespassOff();

IF
DialogStarted(WYR_Wulbren_fcd8ff87-7c42-9748-9a31-e9b8568f1a58,_)
THEN
PROC_WYR_Ironhand_TrespassOff();

IF
DialogStarted(WYR_UnfortunateGnome_4897143a-f55e-123f-2fed-8a7c7dfd96a6,_)
THEN
PROC_WYR_Ironhand_TrespassOff();

IF
DialogStarted((DIALOGRESOURCE)WYR_Ironhand_Welcome_bcba96a2-7cbb-9ea7-76b0-8b189c47388f, _)
THEN
PROC_WYR_Ironhand_TrespassOff();


IF
DB_WYR_Ironhand_WelcomeGnome((CHARACTER)_Gnome)
THEN
DB_CrimeType_CustomWarning(_Gnome,"WYR_Ironhand_Trespass",WYR_Ironhand_Welcome_bcba96a2-7cbb-9ea7-76b0-8b189c47388f);

PROC
PROC_WYR_Ironhand_WelcomeDialogOn()
AND
NOT DB_GlobalFlag((FLAG)WYR_Ironhand_Event_TrespassAllowed_f8e792be-ac01-4360-8ee9-29430cf6ee56) // the player already had this dialog
AND
DB_WYR_Ironhand_WelcomeGnome(_Gnome)
THEN
DB_WYR_Ironhand_WelcomeDialogExpected(1);
DB_SpotPlayers(_Gnome,"WYR_Ironhand_Welcome",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(_Gnome,"WYR_Ironhand_Welcome",S_WYR_Ironhand_SpotOnEntry_9d644be3-a2f5-4e65-a23a-79bc9cff8ae3);

PROC
PROC_SpotPlayers_Spotted(_Gnome,"WYR_Ironhand_Welcome",_Player)
AND
DB_WYR_Ironhand_WelcomeGnome(_Gnome)
AND
DB_Players(_Player)
AND
DB_WYR_Ironhand_WelcomeDialogExpected(1)
AND
QRY_StartDialog(WYR_Ironhand_Welcome_bcba96a2-7cbb-9ea7-76b0-8b189c47388f,_Gnome,_Player)
THEN
NOT DB_WYR_Ironhand_WelcomeDialogExpected(1);

PROC
PROC_StartDialog_AddExtraSpeakers(WYR_Ironhand_Welcome_bcba96a2-7cbb-9ea7-76b0-8b189c47388f,_DialogID)
AND
DB_WYR_Ironhand_WelcomeGnome(_WelcomeGnome)
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
AND
QRY_SpeakerIsAvailable(_Gnome)
AND
// must do this manually because gnomes have custom dialog range for checkpoint scene
QRY_IsInRange(_Gnome,_WelcomeGnome,25.0)
THEN
PROC_DialogAddSpeakingActor(_DialogID,_Gnome);
PROC_Purge_CancelMovement(_Gnome);

IF
DialogActorLeft(WYR_Ironhand_Welcome_bcba96a2-7cbb-9ea7-76b0-8b189c47388f,_,_Gnome,_)
AND
DB_WYR_Ironhand_SceneGnomes(_ID,(CHARACTER)_Gnome)
AND
NOT DB_WYR_Ironhand_GnomesReturned(2)
THEN
PROC_WYR_Ironhand_FromEntranceToWulbren(_Gnome);

IF
EnteredTrigger(_Player,S_WYR_Ironhand_SpotOnEntry_Off_ee352681-79ca-49e4-bdeb-3199be15b068)
AND
DB_Players(_Player)
AND
DB_WYR_Ironhand_WelcomeGnome(_Gnome)
AND
DB_WYR_Ironhand_WelcomeDialogExpected(1)
THEN
PROC_SpotPlayers_StopSpotting(_Gnome,"WYR_Ironhand_Welcome");
PROC_TriggerUnregisterForPlayers(S_WYR_Ironhand_SpotOnEntry_Off_ee352681-79ca-49e4-bdeb-3199be15b068);
NOT DB_WYR_Ironhand_WelcomeDialogExpected(1);

QRY
QRY_SelectCustomDialog_AfterGenerics(_Gnome, _Player)
AND
DB_Players((CHARACTER)_Player)
AND
DB_WYR_Ironhand_WelcomeGnome((CHARACTER)_Gnome)
AND
DB_WYR_Ironhand_WelcomeDialogExpected(1)
AND
QRY_StartDialog_Fixed(WYR_Ironhand_Welcome_bcba96a2-7cbb-9ea7-76b0-8b189c47388f,_Gnome,_Player)
THEN
NOT DB_WYR_Ironhand_WelcomeDialogExpected(1);
PROC_SpotPlayers_StopSpotting("WYR_Ironhand_Welcome");
PROC_TriggerUnregisterForPlayers(S_WYR_Ironhand_SpotOnEntry_Off_ee352681-79ca-49e4-bdeb-3199be15b068);

//END_REGION Trespassing crime and welcoming dialog


//REGION Gnomes escape checkpoint

PROC
PROC_WYR_Ironhand_GnomesRun()
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
THEN
PROC_WYR_Ironhand_TrespassOff();
PROC_WYR_Ironhand_WelcomeDialogOn();
PROC_WYR_Ironhand_RunGnomeRun(_Gnome);

PROC
PROC_WYR_Ironhand_RunGnomeRun((CHARACTER)_Gnome)
THEN
LeaveCombat(_Gnome);
//AddSpell(_Gnome,"Projectile_WYR_Ironhand_GnomeJump",0,0);
PROC_CharacterMoveTo(_Gnome,S_WYR_Ironhand_EscapeCheckpoint_Pos0_889ee973-40b8-4eb4-9344-ff500bd30278,"Run","WYR_Ironhand_EscapeCheckpoint_ToPos0");

PROC
PROC_WYR_Ironhand_RunGnomeRun((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5)
THEN
PROC_TryStartAD(WYR_Ironhand_AD_RunRunRun_4233f3d0-69d8-8384-86b3-2fc619ac6d0d,S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5);

PROC
PROC_WYR_Ironhand_RunGnomeRun((CHARACTER)S_WYR_Ironhand_Artificer_001_627b5b4d-51df-416a-800a-ddf357c96995)
THEN
PROC_TryStartAD(WYR_Ironhand_AD_RunRunRun_4233f3d0-69d8-8384-86b3-2fc619ac6d0d,NULL_00000000-0000-0000-0000-000000000000,
	S_WYR_Ironhand_Artificer_001_627b5b4d-51df-416a-800a-ddf357c96995);

IF
EntityEvent(_Gnome,"WYR_Ironhand_EscapeCheckpoint_ToPos0")
THEN
PROC_CharacterMoveTo((CHARACTER)_Gnome,S_WYR_Ironhand_EscapeCheckpoint_Pos1_4889d1de-5dd2-43d1-95d5-588f9d306e30,"Run","WYR_Ironhand_EscapeCheckpoint_ToPos1");

IF
EntityEvent(_Gnome,"WYR_Ironhand_EscapeCheckpoint_ToPos1")
THEN
// TODO: jump fails for some reason
//UseSpell((CHARACTER)_Gnome,"Projectile_WYR_Ironhand_GnomeJump",S_WYR_Ironhand_EscapeCheckpoint_Pos2_79bb89da-c591-4439-970c-f4a488da4104);
TeleportTo(_Gnome,S_WYR_Ironhand_EscapeCheckpoint_Pos2_79bb89da-c591-4439-970c-f4a488da4104,"Projectile_WYR_Ironhand_GnomeJump");

IF
CastedSpell(_Gnome,"Projectile_WYR_Ironhand_GnomeJump",_,_,_)
THEN
//RemoveSpell((CHARACTER)_Gnome,"Projectile_WYR_Ironhand_GnomeJump",0);
PROC_CharacterMoveTo((CHARACTER)_Gnome,S_WYR_Ironhand_EscapeCheckpoint_Pos3_2cef84ee-8de1-4635-806f-36d8c54c5076,"Run","WYR_Ironhand_EscapeCheckpoint_ToPos3");

// TODO: jump fails for some reason
IF
EntityEvent(_Gnome,"Projectile_WYR_Ironhand_GnomeJump")
THEN
RemoveSpell((CHARACTER)_Gnome,"Projectile_WYR_Ironhand_GnomeJump",0);
PROC_CharacterMoveTo((CHARACTER)_Gnome,S_WYR_Ironhand_EscapeCheckpoint_Pos3_2cef84ee-8de1-4635-806f-36d8c54c5076,"Run","WYR_Ironhand_EscapeCheckpoint_ToPos3");

IF
EntityEvent(_Gnome,"WYR_Ironhand_EscapeCheckpoint_ToPos3")
THEN
TeleportTo(_Gnome,S_WYR_Ironhand_EscapeCheckpoint_Pos4_de334604-9b30-4315-bdfc-7e2f3083bda3,"WYR_Ironhand_EscapeCheckpoint_ToPos4");

IF
EntityEvent(_Gnome,"WYR_Ironhand_EscapeCheckpoint_ToPos4")
AND
DB_InRegion(_Player,S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
AND
DB_Players(_Player)
AND
NOT DB_WYR_Ironhand_FromEntranceToWulbren((CHARACTER)_Gnome)
THEN
PROC_WYR_Ironhand_FromEntranceToWulbren(_Gnome);

IF
EntityEvent(_Gnome,"WYR_Ironhand_EscapeCheckpoint_ToPos4")
AND
NOT DB_WYR_Ironhand_FromEntranceToWulbren((CHARACTER)_Gnome)
THEN
DB_WYR_Ironhand_WaitForPlayerToRun(1);

IF
DB_WYR_Ironhand_WaitForPlayerToRun(1)
AND
DB_InRegion(_Player,S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
AND
DB_Players(_Player)
AND
DB_WYR_Ironhand_SceneGnomes(_Id,_Gnome)
AND
NOT DB_WYR_Ironhand_FromEntranceToWulbren(_Gnome)
THEN
SetFlag(WYR_Ironhand_PlayerFollowsGnomes_6f09d846-7838-4815-9f73-f154c104ace2);
PROC_WYR_Ironhand_FromEntranceToWulbren(_Gnome);

PROC
PROC_WYR_Ironhand_FromEntranceToWulbren((CHARACTER)_Gnome)
AND
DB_WYR_Ironhand_SceneGnomes(_Id,_Gnome)
AND
DB_WYR_Ironhand_Pos_ReturnToRoom(_Id,_Pos)
THEN
DB_WYR_Ironhand_FromEntranceToWulbren(_Gnome);
PROC_CharacterMoveTo((CHARACTER)_Gnome,_Pos,"Run","WYR_Ironhand_ReturnedHome");

//END_REGION Gnomes escape checkpoint


//REGION ADs getting home
/*
IF
Saw(_WelcomeGnome,_Gnome,_)
AND
DB_WYR_Ironhand_WelcomeGnome(_WelcomeGnome)
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
AND
NOT DB_WYR_Ironhand_GnomesReturned(_)
THEN
LookAtEntity(S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e,_Gnome,1.0);
PROC_TryStartAD(WYR_Ironhand_AD_CommentGnomesBackHome_d72390db-b86f-c786-7caf-3dbc231c225d,_WelcomeGnome);
*/

IF
EntityEvent(_Gnome,"WYR_Ironhand_EscapeCheckpoint_ToPos4")
AND
DB_WYR_Ironhand_SceneGnomes(_,(CHARACTER)_Gnome)
THEN
DB_WYR_Ironhand_ReturnHomeCanAD(1);

IF
DB_WYR_Ironhand_ReturnHomeCanAD(1)
AND
DB_InRegion(_Player,S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
AND
DB_WYR_Ironhand_SceneGnomes(1,_Gnome)
AND
QRY_OnlyOnce("WYR_Ironhand_AD_FollowMe")
THEN
PROC_TryStartAD(WYR_Ironhand_AD_FollowMe_ac78df67-f6a2-782d-7544-1e08bb50ac39,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_StartDialog_AddExtraSpeakers(WYR_Ironhand_AD_FollowMe_ac78df67-f6a2-782d-7544-1e08bb50ac39,_DialogID)
AND
DB_WYR_Ironhand_SceneGnomes(1,_Gnome)
THEN
PROC_DialogAddSpeakingActor(_DialogID,_Gnome);


IF
DB_WYR_Ironhand_ReturnHomeCanAD(1)
AND
DB_WYR_Ironhand_HadNoCower(_Gnome,0)
THEN
ClearFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb,_Gnome);

IF
AutomatedDialogStarted(WYR_Ironhand_AD_FollowMe_ac78df67-f6a2-782d-7544-1e08bb50ac39,_)
THEN
NOT DB_WYR_Ironhand_ReturnHomeCanAD(1);

IF
AutomatedDialogEnded(WYR_Ironhand_AD_FollowMe_ac78df67-f6a2-782d-7544-1e08bb50ac39,_)
THEN
NOT DB_WYR_Ironhand_ReturnHomeCanAD(1);

IF
EntityEvent(_,"WYR_Ironhand_ReturnedHome")
AND
DB_WYR_Ironhand_GnomesReturned(1)
THEN
NOT DB_WYR_Ironhand_GnomesReturned(1);
DB_WYR_Ironhand_GnomesReturned(2);

IF
EntityEvent(_,"WYR_Ironhand_ReturnedHome")
AND
NOT DB_WYR_Ironhand_GnomesReturned(_)
THEN
DB_WYR_Ironhand_GnomesReturned(1);


IF
DB_WYR_Ironhand_GnomesReturned(2)
AND
DB_WYR_Ironhand_SceneGnomes(1,_Gnome1)
AND
DB_WYR_Ironhand_SceneGnomes(2,_Gnome2)
AND
NOT DB_GlobalFlag(WYR_Ironhand_State_WulbrenPermaDefeated_b837a5cd-31f9-4cfc-b341-dee71e93a067)
THEN
SetFlag(WYR_Ironhand_State_GnomesReturned_a082d5cd-8360-429b-a77a-124e11ec99e8);
PROC_TryStartAD(WYR_Ironhand_AD_GnomesBackHome_854368fc-651d-ab2a-01ab-2c20c665b0cd,
	S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,
	S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,
	_Gnome1,_Gnome2);

IF
DB_WYR_Ironhand_GnomesReturned(1)
AND
DB_WYR_Ironhand_SceneGnomes(1,_Gnome1)
AND
NOT DB_WYR_Ironhand_SceneGnomes(2,_)
AND
NOT DB_GlobalFlag(WYR_Ironhand_State_WulbrenPermaDefeated_b837a5cd-31f9-4cfc-b341-dee71e93a067)
THEN
SetFlag(WYR_Ironhand_State_GnomesReturned_a082d5cd-8360-429b-a77a-124e11ec99e8);
PROC_TryStartAD(WYR_Ironhand_AD_GnomesBackHome_854368fc-651d-ab2a-01ab-2c20c665b0cd,
	S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,
	S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,
	_Gnome1,NULL_00000000-0000-0000-0000-000000000000);


QRY
QRY_StartDialogFailed(WYR_Ironhand_AD_GnomesBackHome_854368fc-651d-ab2a-01ab-2c20c665b0cd,_,_,_,_,_,_)
THEN
PROC_WYR_Ironhand_GnomesToBasePos();

IF
AutomatedDialogEnded(WYR_Ironhand_AD_GnomesBackHome_854368fc-651d-ab2a-01ab-2c20c665b0cd,_)
THEN
PROC_WYR_Ironhand_GnomesToBasePos();

PROC
PROC_WYR_Ironhand_GnomesToBasePos()
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
AND
DB_WYR_Ironhand_Init(_Gnome,_Pos,_,_)
THEN
ClearFlag(WYR_Ironhand_State_AtCheckpoint_fbba9492-5888-4f04-8be7-b6af11ab5463,_Gnome);
PROC_CharacterMoveTo((CHARACTER)_Gnome,_Pos,"Walk","");

//END_REGION ADs getting home


//REGION Perception check for hideout entrance

//IF
//UseStarted(_,S_WYR_Ironhand_CaveExitDoor_3c710f49-3d3e-42ad-803b-d02c8e0bdc16)
//THEN
//SetEntityEvent(S_WYR_Ironhand_CaveEntranceDoor_bdcadf43-35e5-421e-8fa4-7d5456b825e6,"RevealFromStory",1);
//PROC_TriggerUnregisterForPlayers(S_WYR_Ironhand_FootprintsVB_Zone_59ab580b-995b-4a80-b20f-4a2a4b2f4fe6);

//IF
//EntityEvent(_Gnome,"WYR_Ironhand_EscapeCheckpoint_ToPos4")
//THEN
//SetEntityEvent(S_WYR_Ironhand_CaveEntranceDoor_bdcadf43-35e5-421e-8fa4-7d5456b825e6,"RevealFromStory",1);
//PROC_TriggerUnregisterForPlayers(S_WYR_Ironhand_FootprintsVB_Zone_59ab580b-995b-4a80-b20f-4a2a4b2f4fe6);


IF
EnteredTrigger(_Player,S_WYR_Ironhand_FootprintsVB_Zone_59ab580b-995b-4a80-b20f-4a2a4b2f4fe6)
AND
DB_Players(_Player)
AND
NOT DB_WYR_Ironhand_Footprint_Checks(_Player)
AND
NOT DB_WYR_Ironhand_Footprint_Result(_Player,_)
THEN
PROC_WYR_Ironhand_FootprintsCheck(_Player);

PROC
PROC_WYR_Ironhand_FootprintsCheck((CHARACTER)_Player)
AND
DB_Players(_OtherPlayer)
AND
NOT DB_WYR_Ironhand_Footprint_Checks(_OtherPlayer)
AND
NOT DB_WYR_Ironhand_Footprint_Result(_OtherPlayer,_)
AND
QRY_IsInRange(_OtherPlayer,_Player,11.0)
THEN
PROC_TrySkillCheck(_OtherPlayer,NULL_00000000-0000-0000-0000-000000000000,"Survival",(DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57,"WYR_Ironhand_Footprints");
DB_WYR_Ironhand_Footprint_Checks(_OtherPlayer);

QRY
QRY_GLO_SkillCheck_CheckAdvantage(_Player,_,"WYR_Ironhand_Footprints")
AND
IsTagged(_Player,REALLY_DEEPGNOME_17d29357-beba-4096-accc-c28bdea88fda,1)
THEN
DB_QRYRTN_GLO_Skillcheck_CheckAdvantage(2);

QRY
QRY_GLO_SkillCheck_CheckAdvantage(_Player,_,"WYR_Ironhand_Footprints")
AND
NOT DB_QRYRTN_GLO_Skillcheck_CheckAdvantage(2)
AND
IsTagged(_Player,REALLY_UNDERDARK_2d0a73b9-f113-4d35-bdee-a31ab9163d74,1)
THEN
DB_QRYRTN_GLO_Skillcheck_CheckAdvantage(1);

PROC
PROC_RollResult("WYR_Ironhand_Footprints",_Player,_Reference,1)
THEN
SetFlag((FLAG)WYR_Ironhand_State_HideoutRollSuccess_64e6e13a-21bb-408b-ae0e-a6e063a86bad,_Player,0);

PROC
PROC_RollResult("WYR_Ironhand_Footprints",_Player,_Reference,_Result)
AND
_Result != 2
AND
DB_WYR_Ironhand_Footprint_Checks(_Player)
THEN
DB_WYR_Ironhand_Footprint_Result(_Player,_Result);

PROC
PROC_RollResult("WYR_Ironhand_Footprints",_Player,_Reference,_Result)
AND
DB_WYR_Ironhand_Footprint_Checks(_Player)
THEN
NOT DB_WYR_Ironhand_Footprint_Checks(_Player);

PROC
PROC_RollResult("WYR_Ironhand_Footprints",_Player,_Reference,_)
AND
NOT DB_WYR_Ironhand_Footprint_Checks(_)
THEN
PROC_WYR_Ironhand_Footprint_ChooseOne();

// REALLY_DEEPGNOME priority 1
PROC
PROC_WYR_Ironhand_Footprint_ChooseOne()
AND
DB_WYR_Ironhand_Footprint_Result(_Player,1)
AND
NOT DB_WYR_Ironhand_Footprint_ChosenOne(_)
AND
IsTagged(_Player,REALLY_DEEPGNOME_17d29357-beba-4096-accc-c28bdea88fda,1)
THEN
DB_WYR_Ironhand_Footprint_ChosenOne(_Player);

// REALLY_UNDERDARK priority 2
PROC
PROC_WYR_Ironhand_Footprint_ChooseOne()
AND
DB_WYR_Ironhand_Footprint_Result(_Player,1)
AND
NOT DB_WYR_Ironhand_Footprint_ChosenOne(_)
AND
IsTagged(_Player,REALLY_UNDERDARK_2d0a73b9-f113-4d35-bdee-a31ab9163d74,1)
THEN
DB_WYR_Ironhand_Footprint_ChosenOne(_Player);

// Anyone with success priority 3
PROC
PROC_WYR_Ironhand_Footprint_ChooseOne()
AND
DB_WYR_Ironhand_Footprint_Result(_Player,1)
AND
NOT DB_WYR_Ironhand_Footprint_ChosenOne(_)
THEN
DB_WYR_Ironhand_Footprint_ChosenOne(_Player);

// Anyone else priority 4
PROC
PROC_WYR_Ironhand_Footprint_ChooseOne()
AND
DB_WYR_Ironhand_Footprint_Result(_Player,_)
AND
NOT DB_WYR_Ironhand_Footprint_ChosenOne(_)
THEN
DB_WYR_Ironhand_Footprint_ChosenOne(_Player);

IF
DB_WYR_Ironhand_Footprint_ChosenOne(_Player)
THEN
PROC_TryStartAD(WYR_Ironhand_PAD_Footprints_486dff09-7f85-b134-3083-d2ca1836c3e7,_Player);

IF
DB_WYR_Ironhand_Footprint_Result(_Player,1)
THEN
PROC_PlayPerceptionRevealEffect(S_WYR_Ironhand_CaveEntranceDoor_bdcadf43-35e5-421e-8fa4-7d5456b825e6, "WYR_Ironhand_CaveVFX");
PROC_TriggerUnregisterForPlayers(S_WYR_Ironhand_FootprintsVB_Zone_59ab580b-995b-4a80-b20f-4a2a4b2f4fe6);

// Disabling interaction and rolls on the hole
PROC
PROC_WYR_Ironhand_GnomesAddedToAct()
THEN
DB_WYR_Ironhand_EntranceInteractible(1);

PROC
PROC_WYR_Ironhand_NoGnomesInAct()
THEN
DB_WYR_Ironhand_EntranceInteractible(0);

IF
DB_WYR_Ironhand_EntranceInteractible(_NewValue)
AND
DB_WYR_Ironhand_EntranceInteractible(_OldValue)
AND
_NewValue != _OldValue
THEN
NOT DB_WYR_Ironhand_EntranceInteractible(_OldValue);

IF
DB_WYR_Ironhand_EntranceInteractible(_Value)
THEN
SetCanInteract(S_WYR_Ironhand_CaveEntranceDoor_bdcadf43-35e5-421e-8fa4-7d5456b825e6, _Value);
PROC_SetOnStage(S_WYR_Ironhand_Footprints_16ea3bbf-2b03-4b45-9f48-cf4f0bf0e7ee, _Value);

IF
DB_WYR_Ironhand_EntranceInteractible(_Value)
AND
DB_Negate(_Value, _Negate)
THEN
PROC_SetOnStage(S_WYR_Ironhand_GnomeHideoutRubble_ee2a91be-7fe6-48cb-9b46-63c75eea3e1d, _Negate);

IF
DB_WYR_Ironhand_EntranceInteractible(1)
THEN
PROC_TriggerRegisterForPlayers(S_WYR_Ironhand_FootprintsVB_Zone_59ab580b-995b-4a80-b20f-4a2a4b2f4fe6);

IF
DB_WYR_Ironhand_EntranceInteractible(0)
THEN
PROC_TriggerUnregisterForPlayers(S_WYR_Ironhand_FootprintsVB_Zone_59ab580b-995b-4a80-b20f-4a2a4b2f4fe6);
//END_REGION Perception check for hideout entrance


//REGION Gnomes leaving basement

PROC
PROC_WYR_Ironhand_GnomesAddedToAct()
THEN
DB_PermaDefeatedFlag(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,WYR_Ironhand_State_WulbrenPermaDefeated_b837a5cd-31f9-4cfc-b341-dee71e93a067);

IF
DB_Sees(_Gnome,S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
AND
DB_GlobalFlag(WYR_Ironhand_State_WulbrenPermaDefeated_b837a5cd-31f9-4cfc-b341-dee71e93a067)
THEN
PROC_WYR_Ironhand_ReturnedAndRunAway();

IF
DB_WYR_Ironhand_GnomesReturned(2)
AND
DB_GlobalFlag(WYR_Ironhand_State_WulbrenPermaDefeated_b837a5cd-31f9-4cfc-b341-dee71e93a067)
THEN
PROC_WYR_Ironhand_ReturnedAndRunAway();

IF
DB_WYR_Ironhand_GnomesReturned(1)
AND
NOT DB_WYR_Ironhand_SceneGnomes(2,_)
AND
DB_GlobalFlag(WYR_Ironhand_State_WulbrenPermaDefeated_b837a5cd-31f9-4cfc-b341-dee71e93a067)
THEN
PROC_WYR_Ironhand_ReturnedAndRunAway();

PROC
PROC_WYR_Ironhand_ReturnedAndRunAway()
THEN
PROC_GlobalSetFlagAndCache(WYR_Ironhand_State_GnomesReturned_a082d5cd-8360-429b-a77a-124e11ec99e8);

PROC
PROC_WYR_Ironhand_ReturnedAndRunAway()
AND
QRY_OnlyOnce("WYR_Ironhand_AD_GnomesBackHome_WulbrenDead")
THEN
PROC_TryStartAD(WYR_Ironhand_AD_GnomesBackHome_WulbrenDead_8dd4ec5a-0405-8a9e-4c48-573172e59e20,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_StartDialog_AddExtraSpeakers(WYR_Ironhand_AD_GnomesBackHome_WulbrenDead_8dd4ec5a-0405-8a9e-4c48-573172e59e20,_DialogID)
AND
DB_WYR_Ironhand_SceneGnomes(1,_Gnome1)
THEN
PROC_DialogAddSpeakingActor(_DialogID,_Gnome1);

PROC
PROC_StartDialog_AddExtraSpeakers(WYR_Ironhand_AD_GnomesBackHome_WulbrenDead_8dd4ec5a-0405-8a9e-4c48-573172e59e20,_DialogID)
AND
DB_WYR_Ironhand_SceneGnomes(2,_Gnome2)
THEN
PROC_DialogAddSpeakingActor(_DialogID,_Gnome2);

QRY
QRY_StartDialogFailed(WYR_Ironhand_AD_GnomesBackHome_WulbrenDead_8dd4ec5a-0405-8a9e-4c48-573172e59e20,_,_,_,_,_,_)
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
THEN
PROC_WYR_Ironhand_GnomesLeavesBasement(_Gnome);

IF
AutomatedDialogEnded(WYR_Ironhand_AD_GnomesBackHome_WulbrenDead_8dd4ec5a-0405-8a9e-4c48-573172e59e20,_)
AND
DB_WYR_Ironhand_SceneGnomes(_,_Gnome)
THEN
PROC_WYR_Ironhand_GnomesLeavesBasement(_Gnome);


IF
DB_GlobalFlag(WYR_Ironhand_State_WulbrenPermaDefeated_b837a5cd-31f9-4cfc-b341-dee71e93a067)
AND
DB_CurrentLevel("BGO_Main_A")
AND
QRY_OnlyOnce("WYR_Ironhand_AllIronhandGnomesLeave")
THEN
PROC_WYR_Ironhand_AllGnomesLeave();

PROC
PROC_WYR_Ironhand_AllGnomesLeave()
AND
NOT DB_InRegion(_,S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
AND
DB_WYR_Ironhand_Gnomes(_Gnome)
AND
NOT DB_PermaDefeated(_Gnome)
THEN
SetOnStage(_Gnome,0);

PROC
PROC_WYR_Ironhand_AllGnomesLeave()
AND
QRY_AnyCharacterInTrigger(S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
THEN
TimerLaunch("WYR_Ironhand_GnomeWaitBeforeLeaving", 6000);

IF
TimerFinished("WYR_Ironhand_GnomeWaitBeforeLeaving")
AND
DB_WYR_Ironhand_Gnomes(_Gnome)
AND
NOT DB_PermaDefeated(_Gnome)
AND
IsInTrigger(_Gnome,S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0,1)
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)_Gnome,"WYR_Ironhand_GnomeReadyToLeaveBasement");

PROC
PROC_ReadyToMoveOn(_Gnome,"WYR_Ironhand_GnomeReadyToLeaveBasement")
THEN
PROC_WYR_Ironhand_GnomesLeavesBasement((CHARACTER)_Gnome);

PROC
PROC_WYR_Ironhand_GnomesLeavesBasement((CHARACTER)_Gnome)
THEN
PROC_CharacterMoveTo((CHARACTER)_Gnome,S_TeleportTrigger_BlackSmithCave_002_55b78fdb-f4dc-41c4-8926-68ff27d94ebe,"Run","WYR_Ironhand_GnomeLeaveBasement");

IF
EntityEvent(_Gnome,"WYR_Ironhand_GnomeLeaveBasement")
THEN
SetOnStage(_Gnome,0);

//END_REGION Gnomes leaving basement

//REGION Runepowder bomb
PROC
PROC_WYR_Ironhand_GnomesAddedToAct()
THEN
PROC_SetOnStage(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, 1);

PROC
PROC_WYR_Ironhand_NoGnomesInAct()
THEN
PROC_SetOnStage(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, 0);

IF
FlagSet((FLAG)WYR_Ironhand_Event_TerroristQuest_Offered_681451d3-6186-4c59-aba7-94ef8fdef701,_,_)
THEN
ClearOwnership(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f);

IF
FlagSet((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306, _, _DialogInstance)
AND
DB_DialogPlayers(_DialogInstance, _Player, 1)
AND
IsInInventory(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, 0)
AND
IsInTrigger(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, S_WYR_Ironhand_BombArea_47fbcaee-7fcb-4f07-a536-9f110d4db7a5, 1)
AND
IsDestroyed(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, 0)
THEN
ToInventory(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, _Player, 1, 1, 1);

// picking up the bomb manually
IF
AddedTo(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag(WYR_Ironhand_Event_TerroristQuest_Offered_681451d3-6186-4c59-aba7-94ef8fdef701)
THEN
PROC_WYR_Ironhand_PlayerTookBomb(_Player);

PROC
PROC_WYR_Ironhand_PlayerTookBomb((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306)
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_Ironhand_Event_PlayerTookBomb_103ee3a7-83b8-3d83-9fea-b6d2fe84898d);

PROC
PROC_WYR_Ironhand_PlayerTookBomb((CHARACTER)_Player)
AND
DB_GlobalFlag(WYR_Ironhand_Event_PlayerTookBomb_103ee3a7-83b8-3d83-9fea-b6d2fe84898d)
AND
NOT DB_GlobalFlag((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306)
AND
DB_Sees((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)WYR_Wulbren_fcd8ff87-7c42-9748-9a31-e9b8568f1a58, S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _Player)
THEN
DB_NOOP(1);

PROC
PROC_WYR_Ironhand_PlayerTookBomb((CHARACTER)_Player)
AND
DB_Sees(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96,_Player)
AND
DB_GlobalFlag((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306)
AND
QRY_OnlyOnce("WYR_Ironhand_AD_PlayerPicksBomb")
THEN
PROC_TryStartAD(WYR_Ironhand_AD_PlayerPicksBomb_a40e6e57-34d9-6cbc-501a-1d9d327856f7, S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_WYR_Ironhand_PlayerTookBomb((CHARACTER)_Player)
AND
DB_Sees(S_WYR_Ironhand_ArtificerExtra_002_18f98c7f-0c7d-42b1-9ff2-acbcfd764e60,_Player)
AND
DB_GlobalFlag((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306)
AND
QRY_OnlyOnce("WYR_Ironhand_AD_PlayerPicksBomb")
THEN
PROC_TryStartAD(WYR_Ironhand_AD_PlayerPicksBomb_a40e6e57-34d9-6cbc-501a-1d9d327856f7,NULL_00000000-0000-0000-0000-000000000000,S_WYR_Ironhand_ArtificerExtra_002_18f98c7f-0c7d-42b1-9ff2-acbcfd764e60);

/*
IF
CastedSpell(_Player,"Shout_WYR_Runepowder_Bomb_Detonate",_,_,_)
AND
Exists(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f,1)
AND
GetInventoryOwner(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f,_Holder)
THEN
RequestDelete(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f);
CreateExplosion(_Player,"Projectile_UND_Runepowder_Barrel_Explosion",0,_Holder);
PROC_WYR_Ironhand_CheckExplosionLocAndSetFlag(_Holder);

IF
CastedSpell(_Player,"Shout_WYR_Runepowder_Bomb_Detonate",_,_,_)
AND
Exists(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f,1)
AND
IsInInventory(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f,0)
THEN
Die(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,0,1,0.0);
PROC_WYR_Ironhand_CheckExplosionLocAndSetFlag(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f);

PROC
PROC_WYR_Ironhand_CheckExplosionLocAndSetFlag((GUIDSTRING)_Location)
AND
IsInTrigger(_Location,S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0,1)
THEN
PROC_SetRelationToPlayers(ACT3_WYR_IronhandGnomes_9e36c2d3-a13f-4d4e-bc5b-8ac237f84159,0);

PROC
PROC_WYR_Ironhand_CheckExplosionLocAndSetFlag((GUIDSTRING)_Location)
THEN
SetFlag(WYR_Ironhand_BombDestroyed_8ed705b5-6f86-4cff-8c14-cc1c7b87ad9c,NULL_00000000-0000-0000-0000-000000000000,0);
*/
//END_REGION Runepowder bomb

//REGION Gortash dies
IF
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
NOT DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_GlobalFlag(WYR_Ironhand_InAct3_Wulbren_3097cdd8-33eb-4ca0-956b-b2826bb01f8a)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
THEN
DB_NotifyWhenReadyToMoveOn((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "WYR_Ironhand_GortashDead_WulbrenReadyToGo");

PROC
PROC_ReadyToMoveOn((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "WYR_Ironhand_GortashDead_WulbrenReadyToGo")
THEN
PROC_DisappearOutOfSight((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "Walk", 1, "WYR_Ironhand_GortashDead_WulbrenWentToFoundry");
DB_WYR_IronHand_WulbrenWaitingToTeleport(1);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_WYR_IronHand_WulbrenWaitingToTeleport(1)
THEN
NOT DB_WYR_IronHand_WulbrenWaitingToTeleport(1);
TeleportTo(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, S_LOW_SteelWatchOutcomeLocation_672c319c-ecc6-4797-8447-16eeca161146, "", 0, 0, 0, 1, 1);
SetOnStage(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, 1);
SetFaction(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (FACTION)ACT3_LOW_SteelWatchFoundry_Ironhands_64aaa374-aa33-4866-8780-6e1472f215d8);
PROC_RemoveDialog(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
DB_Dialogs(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (DIALOGRESOURCE)LOW_SteelWatchFoundry_WulbrenThanks_23985c4f-1b42-5820-f757-e56ea3957746);
DB_WYR_IronHand_WulbrenWaitingAtFoundry(1);

IF
DialogEnded(LOW_SteelWatchFoundry_WulbrenThanks_23985c4f-1b42-5820-f757-e56ea3957746, _)
THEN
DB_LOW_SteelWatchFoundry_DisappearAfterLongRest(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3_GEN"
