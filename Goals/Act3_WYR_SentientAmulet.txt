Version 1
SubGoalCombiner SGC_AND
INITSECTION
PROC_TriggerRegisterForParty(S_WYR_SentientAmulet_Crypt_Area_Trigger_94be7aaf-ebf9-4517-9553-74453e3d0d38);
PROC_TriggerRegisterForPlayers(S_WYR_SentientAmulet_Crypt_VB_Trigger_a9599746-2bb4-4b77-9298-024263aaad89);

DB_GLO_MonkAmuletBanters((TRIGGER)S_WYR_SentientAmulet_OpenHandTemple_Trigger_e913a308-a398-4b64-ab10-8423c0518dff, (DIALOGRESOURCE)WYR_SentientAmulet_AD_OpenHandTempleComment_ae7d95ca-0196-b0ce-5237-fd6034a6e092);
DB_GLO_MonkAmuletBanters((TRIGGER)S_WYR_SentientAmulet_Banter_Circus_Trigger_6f605103-66d3-4eaa-ad44-37b87b3f2b44, (DIALOGRESOURCE)WYR_SentientAmulet_AD_CircusComment_4ee5b284-327e-c259-5129-254b974e8530);

//Not using DB_AD_Dialog because that doesn't add the player as a second speaker
DB_WYR_SentientAmulet_Plaques((ITEM)S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae,(DIALOGRESOURCE)WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f,(CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,"WYR_SentientAmulet_Corpse_000");
DB_WYR_SentientAmulet_Plaques((ITEM)S_WYR_SentientAmulet_Tomb_Plaque_001_1e5e7950-6908-492a-93c4-856c04c83368,(DIALOGRESOURCE)WYR_SentientAmulet_AD_Tomb_Plaque_01_b6617136-05cf-4e0c-7d53-03cb31703246,(CHARACTER)S_WYR_SentientAmulet_Zombie_001_d985482f-3f1a-4fea-ba83-58fe5862841a,"WYR_SentientAmulet_Corpse_001");
DB_WYR_SentientAmulet_Plaques((ITEM)S_WYR_SentientAmulet_Tomb_Plaque_002_80c5321b-de4f-4c8c-853b-e10b2d40de14,(DIALOGRESOURCE)WYR_SentientAmulet_AD_Tomb_Plaque_02_7dcd5857-c25a-06b1-882f-21f27cf8f9e9,(CHARACTER)S_WYR_SentientAmulet_Zombie_002_022ee3da-672b-4961-9cdf-89283878d3dd,"WYR_SentientAmulet_Corpse_002");
DB_WYR_SentientAmulet_Plaques((ITEM)S_WYR_SentientAmulet_Tomb_Plaque_003_2d7269f8-084a-463e-93dd-f0d5b28c812f,(DIALOGRESOURCE)WYR_SentientAmulet_AD_Tomb_Plaque_03_469bb6e6-4ad6-1736-853f-b93099d78499,(CHARACTER)S_WYR_SentientAmulet_Zombie_003_372d7242-975d-4eea-b7a5-a7e71cdb6f9e,"WYR_SentientAmulet_Corpse_003");

DB_HasItemEvent((ITEM)S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178,WYR_SentientAmulet_State_HasAmulet_f4bbc9de-b75a-491a-9e80-52a3c8bbce62);

DB_FlagReactionAfterDialog(WYR_SentientAmulet_Event_MonkPossessPlayer_564d44f7-20af-478f-a4a0-7442adafc0ca,(DIALOGRESOURCE)WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed);
DB_GlobalFlagReactionAfterDialog(WYR_SentientAmulet_Event_SurprisePlayersInCombat_8ccbee09-c0fb-a542-8909-aea7b1980ddb,(DIALOGRESOURCE)WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed);

TeleportTo(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,S_TeleportTrigger_Asylum_c46ad6e3-e21a-41fc-83e5-0c36db324408,"",0,0,0,1,1);
SetOnStage((CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,1);
SetImmortal((CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,1);
ApplyStatus(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,"INVULNERABLE_NOT_SHOWN",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
PROC_CharacterDisableAllCrimes((CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

DB_WYR_SentientAmulet_Zombies((CHARACTER)S_WYR_SentientAmulet_Zombie_001_d985482f-3f1a-4fea-ba83-58fe5862841a);
DB_WYR_SentientAmulet_Zombies(S_WYR_SentientAmulet_Zombie_002_022ee3da-672b-4961-9cdf-89283878d3dd);
DB_WYR_SentientAmulet_Zombies(S_WYR_SentientAmulet_Zombie_003_372d7242-975d-4eea-b7a5-a7e71cdb6f9e);
DB_WYR_SentientAmulet_Zombies(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);

DB_WYR_SentientAmulet_Zombies_Tombs((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,(ITEM)S_WYR_SentientAmulet_Tomb_Bed_b42a3db9-38dd-4532-b623-7d2bb50a0f63,
(ITEM)S_WYR_SentientAmulet_Tomb_Lid_97f1280f-f052-4988-b59d-5f972c9651d6,(TRIGGER)S_WYR_SentientAmulet_Tomb_Lid_Open_Point_3700ab31-4cb1-4e5e-ad1b-18fc7bef07bc);
DB_WYR_SentientAmulet_Zombies_Tombs((CHARACTER)S_WYR_SentientAmulet_Zombie_001_d985482f-3f1a-4fea-ba83-58fe5862841a,(ITEM)S_WYR_SentientAmulet_Tomb_Bed_001_02d59fb5-a6a6-4586-8f98-b7615a320c65,
(ITEM)S_WYR_SentientAmulet_Tomb_Lid_001_d14f3ec7-58f8-40d8-94f5-dd8d829d4669,(TRIGGER)S_WYR_SentientAmulet_Tomb_Lid_Open_Point_001_f387c4d5-f702-4824-b7ce-4bbc8f90ae67);
DB_WYR_SentientAmulet_Zombies_Tombs((CHARACTER)S_WYR_SentientAmulet_Zombie_002_022ee3da-672b-4961-9cdf-89283878d3dd,(ITEM)S_WYR_SentientAmulet_Tomb_Bed_002_b5bc8fa5-3827-4674-886b-90b03635a182,
(ITEM)S_WYR_SentientAmulet_Tomb_Lid_002_4192aede-79ae-4f70-ba9b-f708195ff6fa,(TRIGGER)S_WYR_SentientAmulet_Tomb_Lid_Open_Point_002_27836500-a773-4d49-b24c-84b63ed60ab2);
DB_WYR_SentientAmulet_Zombies_Tombs((CHARACTER)S_WYR_SentientAmulet_Zombie_003_372d7242-975d-4eea-b7a5-a7e71cdb6f9e,(ITEM)S_WYR_SentientAmulet_Tomb_Bed_003_b599dcbb-aff0-4948-a3d3-1f5f76643570,
(ITEM)S_WYR_SentientAmulet_Tomb_Lid_003_c1607ce8-6952-4220-ac26-2436c1624a47,(TRIGGER)S_WYR_SentientAmulet_Tomb_Lid_Open_Point_003_50fe605e-3fcb-4351-b4a7-cebd9aea1628);

DB_HostileToPlayerGroupCancelFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055,(FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999);
KBSECTION
//REGION Debug

IF
TextEvent("SAM_Reset")
THEN
Resurrect((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
DB_WYR_SentientAmulet_ZombieReposing((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, (ITEM)BASE_DEC_Sittable_Immovable_000_b42a3db9-38dd-4532-b623-7d2bb50a0f63);
ClearFlag(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);
ClearFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78);
ClearFlag(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616);
ClearFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055);
TeleportTo(S_WYR_SentientAmulet_Tomb_Lid_97f1280f-f052-4988-b59d-5f972c9651d6,S_WYR_SentientAmulet_DEBUG_Lid_Reset_Point_6212026c-703c-4dae-9099-34bb50eb5d13);
TeleportTo(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,S_TeleportTrigger_Asylum_c46ad6e3-e21a-41fc-83e5-0c36db324408,"",0,0,0,1,1);
PROC_SetRelationToPlayers((FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999,50);
NOT DB_OnlyOnce("WYR_SentientAmulet_StartedCombat");

IF
TextEvent("SAM_Reset")
AND
DB_HostileToPlayerGroup((FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999,_Character)
THEN
NOT DB_HostileToPlayerGroup((FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999,_Character);

IF
FlagSet(WYR_SentientAmulet_Debug_GetAmulet_87df7be7-10b6-393a-45be-a6a86cf64c5e,_Player,_)
THEN
ClearFlag(WYR_SentientAmulet_Debug_GetAmulet_87df7be7-10b6-393a-45be-a6a86cf64c5e,_Player);
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);

IF
TextEvent("SAM_Get")
AND
NOT GetTextEventParamInteger(1,_)
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);

IF
TextEvent("SAM_Get")
AND
GetTextEventParamInteger(1,_Integer)
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(_Integer);

IF
FlagSet(WYR_SentientAmulet_Debug_Start_a59158ae-5568-39b9-cd80-4dc80d4e7535,_Player,_)
THEN
ClearFlag(WYR_SentientAmulet_Debug_Start_a59158ae-5568-39b9-cd80-4dc80d4e7535,_Player);
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_TeleportPartiesTo(S_Debug_Teleport_WYR_OpenHand_562fedbf-e567-424b-b474-daf7f27ceb9e,"");
PROC_WYR_Brainquakes_UnregisterAllEventTriggers();

IF
TextEvent("SAM_Start")
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_TeleportPartiesTo(S_Debug_Teleport_WYR_OpenHand_562fedbf-e567-424b-b474-daf7f27ceb9e,"");
PROC_WYR_Brainquakes_UnregisterAllEventTriggers();

IF
FlagSet(WYR_SentientAmulet_Debug_Crypt_5cee1010-2be4-9fef-356f-1633143ed2e8,_Player,_)
THEN
ClearFlag(WYR_SentientAmulet_Debug_Crypt_5cee1010-2be4-9fef-356f-1633143ed2e8,_Player);
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_TeleportPartiesTo(S_WYR_SentientAmulet_DEBUG_Crypt_Point_d7e7114c-eb29-4632-a373-4aa16a0f806c,"");
TimerLaunch("WYR_SentientAmulet_DEBUG_DelayOnStage",1000);

IF
TimerFinished("WYR_SentientAmulet_DEBUG_DelayOnStage")
THEN
SetOnStage((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,1);

IF
TextEvent("SAM_Crypt")
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_TeleportPartiesTo(S_WYR_SentientAmulet_DEBUG_Crypt_Point_d7e7114c-eb29-4632-a373-4aa16a0f806c,"");
TimerLaunch("WYR_SentientAmulet_DEBUG_DelayOnStage",1000);

PROC
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1)
THEN
SetFlag(UND_MonkAmulet_State_FoundAmulet_843c2dc4-0066-47f7-a23b-8eef3965ffd3);
SetFlag(UND_MonkAmulet_State_PlayerSpokeWithAmulet_5614945a-6d08-d67e-2606-99d4f87ea51a);
SetFlag(UND_MonkAmulet_Event_OfferedQuest_1226f854-c4f6-af9f-6863-e7c3d013647f);

PROC
PROC_WYR_SentientAmulet_DEBUG_GetAmulet((INTEGER)_)
AND
GetHostCharacter(_Player)
THEN
Equip(_Player,S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178,1,1,1);

IF
TextEvent("SAM_Banter")
AND
GetTextEventParamUUID(1,_Banter)
THEN
PROC_TryStartAD((DIALOGRESOURCE)_Banter, (ITEM)S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178);

IF
FlagSet(WYR_SentientAmulet_Debug_CryptCombat_67c56326-266c-ed39-c2ad-e04a9fee5298,_Player,_)
THEN
ClearFlag(WYR_SentientAmulet_Debug_CryptCombat_67c56326-266c-ed39-c2ad-e04a9fee5298,_Player);
PROC_WYR_SentientAmulet_DEBUG_StartCombat();

IF
TextEvent("SAM_Combat")
THEN
PROC_WYR_SentientAmulet_DEBUG_StartCombat();

PROC
PROC_WYR_SentientAmulet_DEBUG_StartCombat()
AND
GetHostCharacter(_Player)
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_WYR_SentientAmulet_PrepareCombat();
PROC_TeleportPartiesTo(S_WYR_SentientAmulet_DEBUG_Crypt_Point_d7e7114c-eb29-4632-a373-4aa16a0f806c,"");
DB_WYR_SentientAmulet_InteractingPlayer((CHARACTER)_Player);
SetFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78);
SetFlag(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);
PROC_SetRelationToPlayers((FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999,0);
TimerLaunch("WYR_SentientAmulet_DEBUG_Combat",2000);

IF
TimerFinished("WYR_SentientAmulet_DEBUG_Combat")
AND
IsOnStage(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,1)
THEN
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

//Party preset fallback
IF
TemplateAddedTo((ROOT)UNI_UND_MonkAmulet_086ae8fd-c44e-43a7-b8be-777b551a06d6,_Amulet,_Player,_)
AND
_Amulet != S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("WYR_SentientAmulet_DEBUG_GaveAmuletFallback")
THEN
ToInventory(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178,_Player,1,1,1);

//END_REGION

//REGION Crypt

IF
FlagSet(WYR_SentientAmulet_Knows_ShirraIsInCrypt_7d8201db-b5d8-9792-a1e3-3c75622b7f58,_,_)
AND
NOT DB_GlobalFlag((FLAG)WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78)
AND
DB_GlobalFlag((FLAG)UND_MonkAmulet_Event_OfferedQuest_1226f854-c4f6-af9f-6863-e7c3d013647f)
AND
//VB will only play if no party member is already in or near the crypt
NOT DB_InRegion(_,(TRIGGER)S_WYR_SentientAmulet_Crypt_Area_Trigger_94be7aaf-ebf9-4517-9553-74453e3d0d38)
THEN
DB_OneShot_VoiceBarkTrigger(S_WYR_SentientAmulet_Crypt_VB_Trigger_a9599746-2bb4-4b77-9298-024263aaad89,WYR_SentientAmulet_VB_EnteredCrypt_5843ff68-de37-e484-1b83-ee00d776ea91);

//END_REGION

//REGION Tomb interaction/dialog

//REGION Crypt interaction/zombie possession

//Plaques
IF
DB_WYR_SentientAmulet_Plaques(_Plaque,_Dialog,_Zombie,_)
THEN
DB_Dialogs(_Plaque,_Dialog);
SetStoryDisplayName(_Zombie,"WYR_SentientAmulet_Corpse_Unidentified");

IF
UseFinished(_,_Plaque,1)
AND
DB_WYR_SentientAmulet_Plaques(_Plaque,_,_Corpse,_)
AND
NOT DB_WYR_SentientAmulet_IdentifiedCorpse(_Corpse)
THEN
PROC_WYR_SentientAmulet_IdentifyCorpse((CHARACTER)_Corpse);

PROC
PROC_WYR_SentientAmulet_IdentifyCorpse((CHARACTER)_Corpse)
AND
DB_WYR_SentientAmulet_Plaques(_,_,(CHARACTER)_Corpse,(STRING)_Name)
THEN
DB_WYR_SentientAmulet_IdentifiedCorpse(_Corpse);
SetStoryDisplayName(_Corpse,_Name);

//Identify Shirra's tomb
IF
UseFinished(_,S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae,1)
THEN
DB_WYR_SentientAmulet_IdentifiedCorpse((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);

IF
AutomatedDialogEnded(WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f,_DialogId)
AND
DB_GlobalFlag((FLAG)UND_MonkAmulet_Event_OfferedQuest_1226f854-c4f6-af9f-6863-e7c3d013647f)
AND
DB_WYR_SentientAmulet_IdentifiedCorpse((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c)
AND
DB_WYR_SentientAmulet_OpenTomb(S_WYR_SentientAmulet_Tomb_Lid_97f1280f-f052-4988-b59d-5f972c9651d6)
AND
DB_DialogPlayers(_DialogId,_Player,1)
THEN
PROC_WYR_SentientAmulet_TryStartShirraPossession((CHARACTER)_Player);

QRY
QRY_SelectCustomDialog(S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae,_Player)
AND
DB_Dialogs(S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae,WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f)
AND
DB_CantTalk(_Player)
THEN
DB_SelectedDialog(NULL_00000000-0000-0000-0000-000000000000,_Player);
PROC_TryStartAD(WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f,S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae);

//Interact with tomb lids
IF
EntityEvent(_,"WYR_SentientAmulet_GhostFadeIn_TombOpened")
AND
QRY_StartDialog_Fixed(WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95,S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c)
THEN
DB_NOOP(1);

IF
AutomatedDialogStarted((DIALOGRESOURCE)WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95,_)
AND
DB_DialogName((DIALOGRESOURCE)WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f,_DialogId)
THEN
PROC_ForceStopDialog(S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae);

IF
AutomatedDialogEnded((DIALOGRESOURCE)WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95,_)
AND
NOT DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c)
THEN
SetFlag(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);

IF
UseFinished(_Player,_Tomb,1)
AND
DB_Players(_Player)
AND
DB_WYR_SentientAmulet_Zombies_Tombs(_,_,_Tomb,_)
AND
NOT DB_WYR_SentientAmulet_OpenTomb(_Tomb)
THEN
PROC_WYR_SentientAmulet_OpenTomb(_Tomb);

PROC
PROC_WYR_SentientAmulet_OpenTomb((ITEM)_Tomb)
AND
NOT DB_WYR_SentientAmulet_OpenTomb(_Tomb)
AND
DB_WYR_SentientAmulet_Zombies_Tombs(_Zombie,_,_Tomb,_Target)
THEN
SetOnStage(_Zombie,1);
ItemMoveTo(_Tomb,_Target,1.0,0.0,1,"WYR_SentientAmulet_OpenTomb",0);
SetCanInteract(_Tomb,0);

IF
UseFinished(_Player,S_WYR_SentientAmulet_Tomb_Lid_97f1280f-f052-4988-b59d-5f972c9651d6,1)
AND
DB_Players(_Player)
AND
DB_WYR_SentientAmulet_IdentifiedCorpse((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c)
THEN
PROC_WYR_SentientAmulet_TryStartShirraPossession((CHARACTER)_Player);

PROC
PROC_ProcessLootCorpse((CHARACTER)_Player,(CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c)
AND
DB_Players(_Player)
AND
DB_WYR_SentientAmulet_IdentifiedCorpse((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c)
AND
NOT DB_GlobalFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78)
THEN
PROC_WYR_SentientAmulet_TryStartShirraPossession((CHARACTER)_Player);
DB_CustomLootCorpseResponse((CHARACTER)_Player,(CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,0);

PROC
PROC_WYR_SentientAmulet_TryStartShirraPossession((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)UND_MonkAmulet_Event_OfferedQuest_1226f854-c4f6-af9f-6863-e7c3d013647f)
AND
NOT DB_GlobalFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78)
AND
GetFlag(WYR_SentientAmulet_State_HasAmulet_f4bbc9de-b75a-491a-9e80-52a3c8bbce62,_Player,0)
AND
NOT DB_DialogName((DIALOGRESOURCE)WYR_SentientAmulet_PAD_TombNoAmulet_da7da320-7fbf-6a2c-786b-d71c6e40373b,_)
AND
NOT QRY_EntityIsCurrentlyUnreachable(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178)
THEN
PROC_TryStartAD(WYR_SentientAmulet_PAD_TombNoAmulet_da7da320-7fbf-6a2c-786b-d71c6e40373b,_Player);

PROC
PROC_WYR_SentientAmulet_TryStartShirraPossession((CHARACTER)_Player)
AND
NOT DB_GlobalFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78)
AND
GetFlag(WYR_SentientAmulet_State_HasAmulet_f4bbc9de-b75a-491a-9e80-52a3c8bbce62,_Player,1)
THEN
DB_WYR_SentientAmulet_InteractingPlayer((CHARACTER)_Player);
PROC_GlobalSetFlagAndCache(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78);
SetFaction((CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,(FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999);
TeleportTo(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,S_WYR_SentientAmulet_Zombie_Point_f09ed71a-f93e-4bfd-bd3e-197aedde8fd9,"WYR_SentientAmulet_GhostTeleport",0,0,0,1,1);

IF
EntityEvent(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,"WYR_SentientAmulet_GhostTeleport")
THEN
PROC_ForceStopDialog(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30); //if a player is in a dialogue with the Mad Monk at this moment, stop it
DB_Dialogs(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,(DIALOGRESOURCE)WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95);
PROC_FadeInEntity((CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,"WYR_SentientAmulet_GhostFadeIn_TombOpened");
PROC_GlobalSetFlagAndCache(WYR_SentientAmulet_State_GhostLeftAmulet_752d02d4-0a40-405e-946c-58475b3493a5);
LookAtEntity((CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,3.0);

IF
FlagSet(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e,_,_)
AND
NOT DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c)
AND
IsOnStage((CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,1)
THEN
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
FlagSet(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e,_,_)
AND
NOT DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c)
THEN
DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
Resurrect(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,NULL_00000000-0000-0000-0000-000000000000,1);
SetHitpointsPercentage(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,100.0);
EndRepose(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
FlagSet(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e,_,_)
THEN
ClearFlag((FLAG)WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);

IF
Resurrected((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c)
AND
DB_GlobalFlag(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616)
THEN
PROC_CharacterMoveTo((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,S_WYR_SentientAmulet_Zombie_Point_f09ed71a-f93e-4bfd-bd3e-197aedde8fd9,"Walk","WYR_SentientAmulet_ZombieWalk");
ClearFlag(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616);

//END_REGION

//REGION Zombie dialog

IF
EntityEvent((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,"WYR_SentientAmulet_ZombieWalk")
THEN
DB_WYR_SentientAmulet_TryZombieDialog(1);
TimerLaunch("WYR_SentientAmulet_ZombieDialogFallback",15000);

IF
DialogStarted((DIALOGRESOURCE)WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed,_)
THEN
TimerCancel("WYR_SentientAmulet_ZombieDialogFallback");

IF
TimerFinished("WYR_SentientAmulet_ZombieDialogFallback")
AND
DB_DialogName((DIALOGRESOURCE)WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95,_DialogId)
AND
DB_DialogSpeakers(_DialogId,S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,_)
AND
IsSpeakerReserved(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,0)
THEN
PROC_ForceStopDialog(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);

IF
DB_WYR_SentientAmulet_TryZombieDialog(1)
AND
NOT DB_DialogName(WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95,_)
THEN
NOT DB_WYR_SentientAmulet_TryZombieDialog(1);
SetEntityEvent((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,"WYR_SentientAmulet_TryZombieDialog");

IF
EntityEvent((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,"WYR_SentientAmulet_TryZombieDialog")
THEN
DB_Dialogs(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed);

//If not seeing player that interacted, start spotting for another player
IF
EntityEvent((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,"WYR_SentientAmulet_TryZombieDialog")
AND
NOT QRY_WYR_SentientAmulet_TryZombieTalkWithInteractingPlayer()
THEN
DB_SpotPlayers((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,"WYR_SentientAmulet_Zombie",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_WYR_SentientAmulet_TryZombieTalkWithInteractingPlayer()
AND
DB_WYR_SentientAmulet_InteractingPlayer((CHARACTER)_Player)
AND
DB_Sees(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,_Player)
AND
QRY_WYR_SentientAmulet_StartZombieDialog(_Player)
THEN
NOT DB_WYR_SentientAmulet_InteractingPlayer(_Player);

PROC
PROC_SpotPlayers_Spotted(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,"WYR_SentientAmulet_Zombie",_Player)
AND
QRY_WYR_SentientAmulet_StartZombieDialog(_Player)
THEN
DB_NOOP(1); //Spotting stopped at DialogStarted event

QRY
QRY_WYR_SentientAmulet_StartZombieDialog((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
QRY_StartDialog(WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed,S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_Player)
THEN
DB_NOOP(1);

IF
DialogStarted((DIALOGRESOURCE)WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed,_)
AND
DB_SpotPlayers(_Spotter,"WYR_SentientAmulet_Zombie",_,_)
THEN
PROC_SpotPlayers_StopSpotting(_Spotter,"WYR_SentientAmulet_Zombie");

IF
FlagSet(WYR_SentientAmulet_Event_MonkPossessPlayer_564d44f7-20af-478f-a4a0-7442adafc0ca,_Player,_)
THEN
NOT DB_WYR_SentientAmulet_MonkPossessing(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)_Player);
RemoveStatus(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c,"WYR_AMULET_POSSESSION",S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
DB_DialogDeath((CHARACTER)S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
Die(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 0.0);

PROC
PROC_FlagReactionAfterDialog(_Player,WYR_SentientAmulet_Event_MonkPossessPlayer_564d44f7-20af-478f-a4a0-7442adafc0ca)
THEN
RemoveStatus(_Player,"WYR_AMULET_POSSESSION",S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
FlagSet(WYR_SentientAmulet_Event_LoseWisdomPoint_6fde50af-67eb-4f4e-8d64-f3e111a8880f,_Player,_)
THEN
ClearFlag(WYR_SentientAmulet_Event_LoseWisdomPoint_6fde50af-67eb-4f4e-8d64-f3e111a8880f,_Player);

IF
FlagSet(WYR_SentientAmulet_Event_LoseWisdomPoint_6fde50af-67eb-4f4e-8d64-f3e111a8880f,_Player,_)
AND
HasPassive(_Player,"MAG_MonkAmulet_WisdomDebuff_Passive",1)
THEN
RemovePassive(_Player,"MAG_MonkAmulet_WisdomDebuff_Passive");
AddPassive(_Player,"MAG_MonkAmulet_WisdomDebuff_2_Passive");

IF
FlagSet(WYR_SentientAmulet_Event_LoseWisdomPoint_6fde50af-67eb-4f4e-8d64-f3e111a8880f,_Player,_)
AND
HasPassive(_Player,"MAG_MonkAmulet_WisdomDebuff_2_Passive",0)
AND
HasPassive(_Player,"MAG_MonkAmulet_WisdomDebuff_Passive",0)
THEN
AddPassive(_Player,"MAG_MonkAmulet_WisdomDebuff_Passive");

IF
FlagSet(WYR_SentientAmulet_Event_GetMonkReward_93f52b5c-5f1f-4163-b76f-ab6cec9a6767,_Player,_)
THEN
RemoveStatus(_Player,"WYR_AMULET_POSSESSION",S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
AddSpell((CHARACTER)_Player,"Target_WYR_SentientAmulet_HideousLaughter",1,1);

//END_REGION

//END_REGION

//REGION Zombie combat. Zombat.

IF
DB_Is_InCombat(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_)
THEN
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

//REGION Combat setup

//Surprise if attacked after refusal to cooperate in dialog
PROC
PROC_GlobalFlagReactionAfterDialog(WYR_SentientAmulet_Event_SurprisePlayersInCombat_8ccbee09-c0fb-a542-8909-aea7b1980ddb)
AND
DB_InRegion(_PartyMember,S_WYR_SentientAmulet_Crypt_Area_Trigger_94be7aaf-ebf9-4517-9553-74453e3d0d38)
THEN
PROC_MakeSurprised(_PartyMember);

IF
AttackedBy(_Zombie,_Attacker,_,_,_,_,_)
AND
DB_WYR_SentientAmulet_Zombies((CHARACTER)_Zombie)
AND
NOT DB_Dead(_Zombie)
THEN
DB_HostileToPlayerGroup((FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999,(CHARACTER)_Attacker);

IF
AttackedBy(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_Player,_,_,_,_,_)
AND
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat")
AND
DB_Players((CHARACTER)_Player)
AND
QRY_StartDialogCustom_Fixed(WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7,S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_Player,0,0,0,0)
THEN
LookAtEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_Player,3.0);

IF
AttackedBy(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_Attacker,_,_,_,_,_)
AND
NOT DB_OnlyOnce("WYR_SentientAmulet_StartedCombat")
THEN
SetFlag(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);

IF
AttackedBy(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_Attacker,_,_,_,_,_)
AND
NOT DB_OnlyOnce("WYR_SentientAmulet_StartedCombat")
THEN
DB_HostileToPlayerGroup((FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999,(CHARACTER)_Attacker);
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
PROC_ForceStopDialog(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
DB_Is_InCombat(_Zombie,_)
AND
DB_WYR_SentientAmulet_Zombies((CHARACTER)_Zombie)
AND
DB_GlobalFlag(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616)
THEN
PROC_GlobalClearFlagAndCache(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616);

IF
DB_Is_InCombat(_Zombie,_)
AND
DB_WYR_SentientAmulet_Zombies((CHARACTER)_Zombie)
AND
NOT DB_OnlyOnce("WYR_SentientAmulet_StartedCombat")
THEN
PROC_WYR_SentientAmulet_PrepareCombat();

IF
DB_WYR_SentientAmulet_Zombies(_Zombie)
THEN
DB_PreventPermaDefeated(_Zombie);

IF
DB_WYR_SentientAmulet_Zombies_Tombs((CHARACTER)_Zombie,_Bed,_,_)
THEN
SetVisible(_Bed,0);
DB_WYR_SentientAmulet_ZombieReposing((CHARACTER)_Zombie,(ITEM)_Bed);

IF
DB_WYR_SentientAmulet_ZombieReposing((CHARACTER)_Zombie,(ITEM)_Bed)
THEN
Use(_Zombie,_Bed, 1, 0, "");

IF
UseFinished(_Zombie,_Bed,_)
AND
DB_WYR_SentientAmulet_ZombieReposing(_Zombie,(ITEM)_Bed)
THEN
Die(_Zombie, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);

IF
Died(_Zombie)
AND
DB_WYR_SentientAmulet_ZombieReposing(_Zombie,(ITEM)_Bed)
THEN
NOT DB_WYR_SentientAmulet_ZombieReposing(_Zombie,_Bed);
SetOnStage(_Zombie,0);
SetFlag(WYR_SentientAmulet_State_InCoffin_5044f3aa-9901-4266-8bb4-0924d30d917f,_Zombie);
ApplyStatus(_Zombie,"GROUNDED_APPLYTODEAD",-1.0,0,NULL_00000000-0000-0000-0000-000000000000);

IF
Resurrected(_Zombie)
AND
GetFlag(WYR_SentientAmulet_State_InCoffin_5044f3aa-9901-4266-8bb4-0924d30d917f,_Zombie,1)
THEN
ClearFlag(WYR_SentientAmulet_State_InCoffin_5044f3aa-9901-4266-8bb4-0924d30d917f,_Zombie);
RemoveStatus(_Zombie,"GROUNDED_APPLYTODEAD",NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_WYR_SentientAmulet_PrepareCombat()
AND
DB_WYR_SentientAmulet_MonkPossessing(_Zombie)
THEN
PROC_TryStartAD(WYR_SentientAmulet_AD_MonkCombatStart_566204b2-9506-c16e-4f7b-024a5e7ab54c,_Zombie);

PROC
PROC_WYR_SentientAmulet_PrepareCombat()
AND
DB_WYR_SentientAmulet_Plaques(_,_,_Corpse,_)
AND
NOT DB_WYR_SentientAmulet_IdentifiedCorpse((CHARACTER)_Corpse)
THEN
PROC_WYR_SentientAmulet_IdentifyCorpse((CHARACTER)_Corpse);

PROC
PROC_WYR_SentientAmulet_PrepareCombat()
AND
DB_WYR_SentientAmulet_Zombies_Tombs((CHARACTER)_Zombie,_,_Tomb,_)
AND
DB_Dead(_Zombie)
THEN
DB_WYR_SentientAmulet_ShouldResurrect(_Zombie,_Tomb);

IF
DB_WYR_SentientAmulet_ShouldResurrect((CHARACTER)_Zombie,(ITEM)_Tomb)
AND
NOT DB_WYR_SentientAmulet_OpenTomb(_Tomb)
THEN
PROC_WYR_SentientAmulet_OpenTomb(_Tomb);

IF
DB_WYR_SentientAmulet_ShouldResurrect((CHARACTER)_Zombie,(ITEM)_Tomb)
AND
DB_WYR_SentientAmulet_OpenTomb(_Tomb)
THEN
NOT DB_WYR_SentientAmulet_ShouldResurrect((CHARACTER)_Zombie,(ITEM)_Tomb);
Resurrect(_Zombie,NULL_00000000-0000-0000-0000-000000000000,1);
SetHitpointsPercentage(_Zombie,100.0);
EndRepose(_Zombie);

IF
EntityEvent(_Tomb,"WYR_SentientAmulet_OpenTomb")
AND
DB_WYR_SentientAmulet_Zombies_Tombs(_,_,(ITEM)_Tomb,_)
THEN
DB_WYR_SentientAmulet_OpenTomb((ITEM)_Tomb);

PROC
PROC_WYR_SentientAmulet_PrepareCombat()
THEN
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat");

//END_REGION

//REGION Possess other zombie

IF
DB_WYR_SentientAmulet_MonkPossessing(_Character)
AND
NOT DB_Dead(_Character)
THEN
ApplyStatus(_Character,"WYR_AMULET_POSSESSION",-1.0,1,S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
StatusRemoved(_Character,"WYR_AMULET_POSSESSION",_,_)
AND
DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)_Character)
THEN
NOT DB_WYR_SentientAmulet_MonkPossessing(_Character);

IF
TurnStarted(_Monk)
AND
DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)_Monk)
AND
GetHitpointsPercentage(_Monk,_Percentage)
AND
_Percentage <= 50.0
AND
NOT QRY_WYR_SentientAmulet_PossessNewZombie()
AND
QRY_OnlyOnce("WYR_SentientAmulet_AD_MonkNoMoreZombies")
THEN
PROC_TryStartAD(WYR_SentientAmulet_AD_MonkNoMoreZombies_7d61535f-6599-32bd-060a-5efa422398b3,_Monk);

IF
TurnStarted(_Monk)
AND
DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)_Monk)
AND
DB_WYR_SentientAmulet_PossessionCandidates(_Zombie)
THEN
NOT DB_WYR_SentientAmulet_PossessionCandidates(_Zombie);

QRY
QRY_WYR_SentientAmulet_PossessNewZombie()
AND
DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)_Monk)
AND
QRY_WYR_SentientAmulet_InitPossessionCandidates()
AND
QRY_GetRandom("DB_WYR_SentientAmulet_PossessionCandidates",1,"DB_WYR_SentientAmulet_PossessionTarget")
AND
DB_WYR_SentientAmulet_PossessionTarget(_)
THEN
PROC_TryStartAD(WYR_SentientAmulet_AD_MonkLeavesZombie_4d87caef-34f2-ada2-e76e-f9824b5c12d5,_Monk);
RealtimeObjectTimerLaunch(_Monk,"WYR_SentientAmulet_Possess",5000);
RealtimeObjectTimerLaunch(_Monk,"WYR_SentientAmulet_EndTurn",7000);
SetEntityEventReal(_Monk,"GLO_CombatWait",7.0);

QRY
QRY_WYR_SentientAmulet_InitPossessionCandidates()
AND
DB_WYR_SentientAmulet_Zombies(_Zombie)
AND
NOT DB_WYR_SentientAmulet_MonkPossessing(_Zombie)
AND
NOT DB_Defeated(_Zombie) //TODO: also include some immunity statuses?
THEN
DB_WYR_SentientAmulet_PossessionCandidates(_Zombie);

IF
ObjectTimerFinished(_Monk,"WYR_SentientAmulet_Possess")
AND
DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)_Monk)
AND
DB_WYR_SentientAmulet_PossessionTarget((CHARACTER)_Zombie)
THEN
RemoveStatus(_Monk,"WYR_AMULET_POSSESSION",S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
NOT DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)_Monk);
DB_WYR_SentientAmulet_MonkPossessing(_Zombie);
NOT DB_WYR_SentientAmulet_PossessionTarget(_Zombie);
UseSpell(_Zombie,"Target_WYR_SentientAmulet_MonkHeal",_Zombie,NULL_00000000-0000-0000-0000-000000000000);
PROC_TryStartAD(WYR_SentientAmulet_AD_MonkEntersZombie_b76bda62-0e29-4ba7-fd81-0638b7ea2b5c,_Zombie);

IF
ObjectTimerFinished(_Monk,"WYR_SentientAmulet_EndTurn")
THEN
EndTurn(_Monk);

//END_REGION

//REGION Defeat

IF
Dying((CHARACTER)_Monk)
AND
DB_WYR_SentientAmulet_MonkPossessing(_Monk)
AND
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat")
AND
DB_WYR_SentientAmulet_Zombies(_Zombie)
AND
NOT DB_Dead(_Zombie)
THEN
NOT DB_PreventPermaDefeated(_Zombie);
Die(_Zombie, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);

IF
Dying((CHARACTER)_Monk)
AND
DB_WYR_SentientAmulet_MonkPossessing((CHARACTER)_Monk)
AND
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat")
THEN
NOT DB_PreventPermaDefeated(_Monk);
DB_WYR_SentientAmulet_LastPossessed(_Monk);
NOT DB_WYR_SentientAmulet_MonkPossessing(_Monk);
PROC_GlobalSetFlagAndCache(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055);
PROC_SetRelationToPlayers((FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999,50);

IF
Resurrected(_Zombie)
AND
DB_WYR_SentientAmulet_Zombies(_Zombie)
AND
DB_GlobalFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055)
THEN
ClearFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055);

IF
Died((CHARACTER)_Monk)
AND
DB_WYR_SentientAmulet_LastPossessed(_Monk)
THEN
NOT DB_WYR_SentientAmulet_LastPossessed(_Monk);
PROC_WYR_SentientAmulet_MonkAppearAfterCombat(_Monk);

PROC
PROC_WYR_SentientAmulet_MonkAppearAfterCombat((GUIDSTRING)_Zombie)
THEN
SetCanJoinCombat(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,0);
SetCanFight(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,0);
PROC_SetRelationToPlayers((FACTION)ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999,50);
TriggerRegisterForCharacter(S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d,(CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
RealtimeObjectTimerLaunch(_Zombie,"WYR_SentientAmulet_AfterCombatTeleport_Delay",2000);

IF
ObjectTimerFinished(_Monk,"WYR_SentientAmulet_AfterCombatTeleport_Delay")
THEN
TeleportTo(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_Monk,"WYR_SentientAmulet_AfterCombatTeleport",0,0,0,1,1);

IF
EntityEvent(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,"WYR_SentientAmulet_AfterCombatTeleport")
THEN
PROC_FadeInEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,"WYR_SentientAmulet_GhostFadeIn_AfterCombat");

IF
EntityEvent(_,"WYR_SentientAmulet_GhostFadeIn_AfterCombat")
THEN
TimerLaunch("WYR_SentientAmulet_WrapUp_StartSpot",1000);

IF
TimerFinished("WYR_SentientAmulet_WrapUp_StartSpot")
THEN
DB_SpotPlayers((CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,"WYR_SentientAmulet_WrapUp",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

IF
DB_WYR_SentientAmulet_LastPossessed(_Monk)
AND
DB_InRegion(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d)
THEN
TriggerUnregisterForCharacter(S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d,(CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
PROC_TriggerRegisterForPlayers(S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d);
DB_AddCharactersInTriggerToDialog(WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7,S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d,1,1,0);

PROC
PROC_SpotPlayers_Spotted(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,"WYR_SentientAmulet_WrapUp",_Player)
AND
DB_Players(_Player)
AND
QRY_StartDialogCustom(WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7,S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_Player,0,0,0,0)
THEN
LookAtEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30,_Player,3.0);
//Spotting stopped at DialogStarted event

IF
DialogStarted((DIALOGRESOURCE)WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7,_)
AND
DB_SpotPlayers(_Spotter,"WYR_SentientAmulet_WrapUp",_,_)
THEN
PROC_SpotPlayers_StopSpotting(_Spotter,"WYR_SentientAmulet_WrapUp");

IF
DialogEnded((DIALOGRESOURCE)WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7,_)
THEN
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

//END_REGION

//END_REGION

//REGION Replace amulet

//Replace Sentient Amulet with NoGhost amulet
IF
DB_GlobalFlag(WYR_SentientAmulet_State_GhostLeftAmulet_752d02d4-0a40-405e-946c-58475b3493a5)
AND
IsEquipped(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178,1)
THEN
DB_WYR_SentientAmulet_Equipped(1);

IF
DB_GlobalFlag(WYR_SentientAmulet_State_GhostLeftAmulet_752d02d4-0a40-405e-946c-58475b3493a5)
AND
GetInventoryOwner((ITEM)S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178,_Owner)
THEN
PROC_TeleportToAndOffStage(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178,S_TeleportTrigger_Asylum_c46ad6e3-e21a-41fc-83e5-0c36db324408,"",0,0,0,0,1);
ToInventory(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2,_Owner,1,0,1);

IF
AddedTo(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2,_Owner,_)
AND
DB_WYR_SentientAmulet_Equipped(1)
THEN
NOT DB_WYR_SentientAmulet_Equipped(1);
Equip((CHARACTER)_Owner,(ITEM)S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2);

//Replace NoGhost amulet with AfterCombat amulet
IF
DB_GlobalFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055)
AND
IsEquipped(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2,1)
THEN
DB_WYR_SentientAmulet_Equipped(1);

IF
DB_GlobalFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055)
AND
GetInventoryOwner((ITEM)S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2,_Owner)
THEN
PROC_TeleportToAndOffStage(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2,S_TeleportTrigger_Asylum_c46ad6e3-e21a-41fc-83e5-0c36db324408,"",0,0,0,0,1);
ToInventory(S_WYR_SentientAmulet_Amulet_AfterCombat_c037dd05-5001-4e44-a6fb-fcd866da4371,_Owner,1,0,1);

IF
AddedTo(S_WYR_SentientAmulet_Amulet_AfterCombat_c037dd05-5001-4e44-a6fb-fcd866da4371,_Owner,_)
AND
DB_WYR_SentientAmulet_Equipped(1)
THEN
NOT DB_WYR_SentientAmulet_Equipped(1);
Equip((CHARACTER)_Owner,(ITEM)S_WYR_SentientAmulet_Amulet_AfterCombat_c037dd05-5001-4e44-a6fb-fcd866da4371);

//END_REGION

//REGION Wrap up PAD

IF
FlagSet(WYR_SentientAmulet_Event_GetMonkReward_93f52b5c-5f1f-4163-b76f-ab6cec9a6767,_Player,_)
THEN
DB_WYR_SentientAmulet_ResolutionPlayer(_Player);

//Peaceful resolution XP
IF
FlagSet(WYR_SentientAmulet_Event_GetMonkReward_93f52b5c-5f1f-4163-b76f-ab6cec9a6767,_Player,_)
THEN
PROC_PeacefulResolve((CHARACTER)S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
DialogEnded((DIALOGRESOURCE)WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,_)
AND
NOT DB_WYR_SentientAmulet_ResolutionPlayer(_)
THEN
DB_WYR_SentientAmulet_ResolutionPlayer(_Player);

IF
DB_WYR_SentientAmulet_ResolutionPlayer(_Player)
AND
NOT DB_DialogPlayers(_,_Player,_)
THEN
NOT DB_WYR_SentientAmulet_ResolutionPlayer(_Player);
ObjectTimerLaunch(_Player,"WYR_SentientAmulet_DelayResolutionPAD",2000);

IF
ObjectTimerFinished(_Player,"WYR_SentientAmulet_DelayResolutionPAD")
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_TryStartAD(WYR_SentientAmulet_PAD_PostResolutionComment_f5451b97-a4bf-9dea-9a20-a22393055ac3,_Player);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3"
