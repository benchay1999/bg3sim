Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(S_LOW_BasiliskGate_Sergeant_eadf119c-6484-4a76-994f-6702d7b18f3c,(DIALOGRESOURCE)LOW_BasiliskGate_Sergeant_3355ba3b-78e6-70a0-f82f-c52d84c0fee9);
DB_Dialogs(S_LOW_BasiliskGate_Corporal_0da3b234-d224-4b02-a95e-5449c2596f2a,(DIALOGRESOURCE)LOW_BasiliskGate_Corporal_6a6670d2-9da0-2d95-8ac4-9471af6a4b2b);
DB_Dialogs(S_LOW_BasiliskGate_Private_01_1871ea12-8341-4092-828e-fbc7fd464608,(DIALOGRESOURCE)LOW_BasiliskGate_Private01_4c450caa-d2e9-50e9-baa6-36306fac6b26);
DB_Dialogs(S_LOW_BasiliskGate_Private_02_62735f12-f693-4508-b802-0e90671218a9,(DIALOGRESOURCE)LOW_BasiliskGate_Private02_730be073-0753-589a-3584-65d904d5cd3f);
DB_Dialogs(S_LOW_BasiliskGate_Cook_5cfa4dfb-ffd1-40e1-96fe-a01457936c14,(DIALOGRESOURCE)LOW_BasiliskGate_Cook_344b1c89-aaea-ac1a-76b2-da3b2489631e);
DB_Dialogs(S_LOW_BasiliskGate_CrimeComplainer_001_461ce028-4293-4028-951b-a2c267b67216,(DIALOGRESOURCE)LOW_BasiliskGate_CrimeComplainer001_320e1314-d5c4-a9fd-52a3-6f8a0186e880);
DB_Dialogs(S_LOW_BasiliskGate_CrimeComplainer_002_b8cf8f7d-29f2-4184-8df4-eb91572c1a46,(DIALOGRESOURCE)LOW_BasiliskGate_CrimeComplainer002_e009f168-bcac-ecc5-64b6-d81a48bfacf2);
DB_Dialogs(S_LOW_BasiliskGate_CrimeComplainer_003_3316e2ce-fbb2-4a19-8231-7ef77116ad47,(DIALOGRESOURCE)LOW_BasiliskGate_CrimeComplainer003_00ca2c66-cda3-55da-9d8c-e9beda21c963);
DB_Dialogs(S_LOW_BasiliskGate_ExecutionGuard_01_3ba6de48-0ff8-4290-8942-f6329f16d5f5,(DIALOGRESOURCE)LOW_BasiliskGate_ExecutionGuard_01_2ccd850a-2aea-4526-13ab-0216aed09972);
DB_Dialogs(S_LOW_BasiliskGate_ExecutionGuard_02_5491ace0-6d6b-483e-ac7e-4130eddae063,(DIALOGRESOURCE)LOW_BasiliskGate_ExecutionGuard_02_f65367b2-b2e0-f481-25a5-74b583e67889);
DB_Dialogs(S_LOW_BasiliskGate_Sentinel_6080d533-820b-4802-bf0b-fd27066a4a9b,(DIALOGRESOURCE)LOW_BasiliskGate_Sentinel_6da117ec-12ef-b412-d4f1-c1ebb878c30a);
DB_Dialogs(S_LOW_BasiliskGate_Caster_163798ab-ea5f-4934-b215-b6061b576d05,(DIALOGRESOURCE)LOW_BasiliskGate_Caster_218c0ec9-1764-5ff4-1e11-b636fdccedfd);
DB_Dialogs(S_LOW_BasiliskGate_DoorGuard_c14b2865-fd6f-4d52-8e41-b5f8aad97583,(DIALOGRESOURCE)LOW_BasiliskGate_DoorGuard_6a3a8342-aa92-3534-6cc8-47af857ebb17);
DB_Dialogs(S_LOW_BasiliskGate_GateGuard_b5479421-003e-4b14-bc19-569cb8be1abb,(DIALOGRESOURCE)LOW_BasiliskGate_GateGuard_d7b83ed0-4b92-0d71-f04e-f75220240fa4);
DB_Dialogs(S_LOW_Prison_Rat01_7ec18c86-b069-4e60-82dd-61a0263d46f0,(DIALOGRESOURCE)LOW_Prison_Rat01_72c99115-3161-53b2-51a7-c7a9fbe0ebac);

//override prisoner-to-guard dialogs
DB_CRIME_Guards_BlockPrisonerDialog((CHARACTER)S_LOW_PrisonGuard01_6dd2049c-413c-4c68-b58f-2a0cf5094053);
DB_CRIME_Guards_BlockPrisonerDialog(S_LOW_PrisonGuard02_f7773813-75fe-4aae-99cb-7160f64f630d);
DB_CRIME_Guards_BlockPrisonerDialog(S_LOW_PrisonGuard03_aebea090-1245-4d27-a105-46e37c5852b0);

DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_BasiliskGate_Ownership_854f8d5b-ea3d-4ade-8eb1-321e45ae9d62,(CHARACTER)S_LOW_BasiliskGate_Lieutenant_915d074c-8f6f-4f5a-ae18-fb333ce6dc29);
DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_BasiliskGate_Square_Ownership_1a5a3d95-79c1-43c8-89a9-c846adbfcfef,(CHARACTER)S_LOW_BasiliskGate_Lieutenant_915d074c-8f6f-4f5a-ae18-fb333ce6dc29);
DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_BasiliskGate_Alleys_Ownership_23d43071-1280-4903-b53d-999a405d6473,(CHARACTER)S_LOW_BasiliskGate_Lieutenant_915d074c-8f6f-4f5a-ae18-fb333ce6dc29);

DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors((ITEM)S_LOW_BasiliskGate_Florrick_ExecutionNotice_01_242797b7-5418-43a5-98ad-b59f44d4f7a7);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_02_6eb10fd7-8a8f-4a5c-9cdf-003464fe225f);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_03_7c476c5c-3b7f-4076-850b-2af9edace9c3);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_04_14b951e2-b5b4-4432-9073-5d385ff19148);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_05_e97244b2-c305-4b1a-a375-58896887996b);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_06_ea2d8677-d275-416a-8d01-da159933749b);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_07_bd6d396a-f8da-4a45-b14f-6de39d9b6896);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_08_0b93f3a1-7153-4758-ad2c-7185dbe69533);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_09_405e0540-557d-4690-a4c8-769220681637);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_10_8939392d-5bd9-44b4-933d-1614c05adf27);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_11_e693f93c-f542-4ffe-b576-fc1f1b763a49);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_12_fb57f118-e951-4317-b1b1-bb43c1f438ec);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_13_70a7c961-db58-4bf0-8afb-91e93c0ea90d);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_14_a6877bde-26e9-49a8-ad7c-7dfdeb5e807c);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_15_f1180b4d-abb8-46ee-b959-b9cfcd2c06c6);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_16_0dfc037d-17b2-4adb-962e-4a1f9cd3b24b);
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(S_LOW_BasiliskGate_Florrick_ExecutionNotice_17_aeeaa7b8-c19e-452e-af6f-979db63fcdc4);
PROC_LOW_BasiliskGate_FlorrickExecutionInitializePosters();

DB_LOW_BasiliskGate_FlorrickExecution_BodyGuards((GUIDSTRING)S_LOW_BasiliskGate_ExecutionGuard_01_3ba6de48-0ff8-4290-8942-f6329f16d5f5);
DB_LOW_BasiliskGate_FlorrickExecution_BodyGuards(S_LOW_BasiliskGate_ExecutionGuard_02_5491ace0-6d6b-483e-ac7e-4130eddae063);

//The rat possesses some useful items for lone wolf players, though for a higher price. The rat unresponsive to crime through generics, instead it has a "scene" of just existing and chilling. Once attacked it will attempt to disappear into its burrow
DB_SceneManager((CHARACTER)S_LOW_Prison_Rat01_7ec18c86-b069-4e60-82dd-61a0263d46f0,"LOW_Prison_VendorRat");
DB_LOW_Prison_RatScene_RelevantInterrupts("Attacked");
DB_LOW_Prison_RatScene_RelevantInterrupts("EnteredCombat");
 

DB_LOW_BasiliskGate_SteelWatchersNotes((ITEM)S_LOW_BasiliskGate_FoundryLocation_01_7c92488f-6b43-4fff-a97b-3324aea69b2e);
DB_LOW_BasiliskGate_SteelWatchersNotes((ITEM)S_LOW_BasiliskGate_FoundryLocation_02_f3516285-3d70-4a9c-b861-963e07e55571);

DB_DoNotFaceDialog(S_LOW_BasiliskGate_GateGuard_b5479421-003e-4b14-bc19-569cb8be1abb, (DIALOGRESOURCE)LOW_BasiliskGate_GateGuard_d7b83ed0-4b92-0d71-f04e-f75220240fa4);
DB_DoNotFaceDialog(S_LOW_BasiliskGate_GateGuard_b5479421-003e-4b14-bc19-569cb8be1abb, (DIALOGRESOURCE)LOW_BasiliskGate_Sentinel_AD_WithGateGuard_95e58c0c-ee24-599d-259c-2d706531f08d);
DB_DoNotFaceDialog(S_LOW_BasiliskGate_Sentinel_6080d533-820b-4802-bf0b-fd27066a4a9b, (DIALOGRESOURCE)LOW_BasiliskGate_Sentinel_AD_WithGateGuard_95e58c0c-ee24-599d-259c-2d706531f08d);

DB_GLO_FireBowls((ITEM)S_HEA_PrisonBrazier2_1b99d67b-ebd2-4713-98ac-843d7e322306,S_HEA_PrisonBrazier2_Hinge_70756990-8ee4-4ad0-8322-bb6eaa48cb8c);

// Allows to buy the key off the rat
SetStoryItem((ITEM)LOW_CountingHouse_MediumSafe02_Key_186ecca4-3023-4433-9716-8f1752513afa,0);

DB_HasItemEvent(S_LOW_BasiliskGate_CrimeComplainer_001_Dagger_059e43bb-de23-401a-bb48-2e45f12c6774,LOW_BasiliskGate_State_HasItem_CrimeComplainer001_Dagger_f8189ccd-e091-c59a-d65b-07084d2a68ad);
Equip((CHARACTER)S_LOW_BasiliskGate_CrimeComplainer_001_461ce028-4293-4028-951b-a2c267b67216,S_LOW_BasiliskGate_CrimeComplainer_001_Dagger_059e43bb-de23-401a-bb48-2e45f12c6774,1,0,1);
KBSECTION
//REGION Flaming Fists barracks boosters - civilians complaining about crime
//------dwarf NPC reacting to player character being hurt------
IF
DialogStarted((DIALOGRESOURCE)LOW_BasiliskGate_CrimeComplainer002_e009f168-bcac-ecc5-64b6-d81a48bfacf2,_DlgInst)
AND
DB_DialogPlayers(_DlgInst, _Speaker, _)
THEN
ClearFlag(LOW_BasiliskGate_CrimeComplainer002_State_PlayerHealthIsLow_068a0c20-9114-965b-35e4-ac8a68f643f4,_Speaker);
PROC_BasiliskGate_CheckPlayerHealth((CHARACTER)_Speaker);

PROC
PROC_BasiliskGate_CheckPlayerHealth((CHARACTER)_Speaker)
AND
GetHitpointsPercentage(_Speaker,(REAL)_playerHealthPercentage)
AND
_playerHealthPercentage < 70
THEN
SetFlag(LOW_BasiliskGate_CrimeComplainer002_State_PlayerHealthIsLow_068a0c20-9114-965b-35e4-ac8a68f643f4,_Speaker);
//END_REGION

//REGION Florrick execution - inits
IF //init - hide poster anchors
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(_Anchor)
THEN
SetOnStage((GUIDSTRING)_Anchor, 0);

PROC //init - spawn interactable destructible posters
PROC_LOW_BasiliskGate_FlorrickExecutionInitializePosters()
AND
NOT DB_PermaDefeated(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9)
AND
NOT DB_GlobalFlag(WYR_WyrmRockPrison_State_FlorrickEscaped_a84a5b16-ca29-43c3-91bf-17def670ba07)
AND
DB_LOW_BasiliskGate_FlorrickExecutionPosterAnchors(_Anchor)
AND
CreateAtObject(Quest_BasiliskGate_Florrick_ExecutionNotice_435685c4-f7ec-4720-8d3c-c297b75267ea, (GUIDSTRING)_Anchor, 0, 0, "", 1, _NewPoster)
THEN
DB_LOW_BasiliskGate_FlorrickExecution_Posters(_Anchor, (ITEM)_NewPoster, 0); //@signature DB_LOW_BasiliskGate_FlorrickExecution_Posters((item) _PositionAnchor, (item) _Item, (bool) _ToBeReplaced)

IF //init - hiding guards on gallows
DB_LOW_BasiliskGate_FlorrickExecution_BodyGuards(_Guard)
AND
NOT DB_GlobalFlag(LOW_BasiliskGate_State_FlorrickExecuted_32a5fd87-95c0-255a-3473-ac288c798df8)
THEN
SetOnStage(_Guard, 0);
//END_REGION


//REGION Florrick execution - re-checks on travelling to WYR or IRN and back to LOW again
IF //if execution still not done
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_GlobalFlag(LOW_BasiliskGate_State_FlorrickExecuted_32a5fd87-95c0-255a-3473-ac288c798df8)
THEN
PROC_FlorrickExecution_ReinstatePosters();

IF //if execution triggered in another level
DB_CurrentLevel("CTY_Main_A")
AND
DB_GlobalFlag(LOW_BasiliskGate_State_FlorrickExecuted_32a5fd87-95c0-255a-3473-ac288c798df8)
AND
NOT DB_LOW_BasiliskGate_FlorrickExecution_CitySetToExecutionState(1)
THEN
PROC_BasiliskGate_FlorrickExecution_FlorrickExecuted();
DB_LOW_BasiliskGate_FlorrickExecution_CitySetToExecutionState(1);
//END_REGION

//REGION Florrick execution - posters
PROC
PROC_FlorrickExecution_ReinstatePosters()
AND
DB_LOW_BasiliskGate_FlorrickExecution_Posters(_Anchor, _Item, 1) //1 = needs replacement
AND
CreateAtObject(Quest_BasiliskGate_Florrick_ExecutionNotice_435685c4-f7ec-4720-8d3c-c297b75267ea, (GUIDSTRING)_Anchor, 0, 0, "", 1, _NewPoster)
THEN
NOT DB_LOW_BasiliskGate_FlorrickExecution_Posters(_Anchor, _Item, 1);
DB_LOW_BasiliskGate_FlorrickExecution_Posters(_Anchor, (ITEM)_NewPoster, 0);

//interaction with any poster -> start AD
IF 
TemplateUseFinished(_Player, (ITEMROOT)Quest_BasiliskGate_Florrick_ExecutionNotice_435685c4-f7ec-4720-8d3c-c297b75267ea, _Item, 1)
AND
NOT DB_Is_InCombat(_Player, _)
AND
DB_LOW_BasiliskGate_FlorrickExecution_CountDownDays(_Days)
THEN
DialogSetVariableInt((DIALOGRESOURCE)LOW_BasiliskGate_FlorrickExecutionNoticeAD_094d7e48-7c6d-02e4-f289-aa326250beaa,"LOW_BasiliskGate_FlorrickExecutionCountdownDays_55b150cf-4040-e2b3-89e4-ba2737fbbe01",_Days);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BasiliskGate_FlorrickExecutionNoticeAD_094d7e48-7c6d-02e4-f289-aa326250beaa, _Item, _Player);

// no days left -> florrick escaped, a different node that doesn't require days will be triggered
IF
TemplateUseFinished(_Player, (ITEMROOT)Quest_BasiliskGate_Florrick_ExecutionNotice_435685c4-f7ec-4720-8d3c-c297b75267ea, _Item, 1)
AND
NOT DB_Is_InCombat(_Player, _)
AND
NOT DB_LOW_BasiliskGate_FlorrickExecution_CountDownDays(_)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BasiliskGate_FlorrickExecutionNoticeAD_094d7e48-7c6d-02e4-f289-aa326250beaa, _Item, _Player);

IF //marking a poster as destroyed
DestroyedBy(_Item, _, _, _)
AND
DB_LOW_BasiliskGate_FlorrickExecution_Posters(_Anchor, _Item, 0)
THEN
NOT DB_LOW_BasiliskGate_FlorrickExecution_Posters(_Anchor, _Item, 0);
DB_LOW_BasiliskGate_FlorrickExecution_Posters(_Anchor, _Item, 1);

PROC //consequences of executing Florrick on non-global entities
PROC_BasiliskGate_FlorrickExecution_FlorrickExecuted()
AND
DB_LOW_BasiliskGate_FlorrickExecution_BodyGuards(_Guard)
THEN
SetOnStage(_Guard, 1);

PROC
PROC_BasiliskGate_FlorrickExecution_FlorrickExecuted()
THEN
PROC_BasiliskGate_HideExecutionPosters();

PROC
PROC_BasiliskGate_HideExecutionPosters()
AND 
DB_LOW_BasiliskGate_FlorrickExecution_Posters(_, _Item, 0)
THEN
SetOnStage((GUIDSTRING)_Item, 0);

PROC
PROC_BasiliskGate_HideExecutionPosters()
AND 
DB_LOW_BasiliskGate_FlorrickExecution_Posters(_Anchor, _Item, _State)
THEN
NOT DB_LOW_BasiliskGate_FlorrickExecution_Posters(_Anchor, _Item, _State);

IF //if killed via other means than execution
DB_PermaDefeated(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9)
THEN
PROC_BasiliskGate_HideExecutionPosters();
//END_REGION

//REGION Prison Rat
IF //hide all rat's items when it turns lootable
CanBeLootedCapabilityChanged((GUIDSTRING)S_LOW_Prison_Rat01_7ec18c86-b069-4e60-82dd-61a0263d46f0,1)
THEN
ClearTradeGeneratedItems((CHARACTER)S_LOW_Prison_Rat01_7ec18c86-b069-4e60-82dd-61a0263d46f0);

PROC //rat should attempt fleeing to the wall pipe when it is attacked
PROC_SceneInterrupted(_SceneNPC, _, "LOW_Prison_VendorRat", _InterruptType)
AND
DB_LOW_Prison_RatScene_RelevantInterrupts(_InterruptType)
THEN
SetFlag((FLAG)LOW_Prison_Rat01_Event_GoToHole_dc64e547-bbd1-c4d0-a7ed-cfedf3f10c85); //will trigger a reaction in anubis behavior

PROC
PROC_LongRest()
AND
DB_SceneManager(_SceneNPC, "LOW_Prison_VendorRat")
AND
DB_GlobalFlag(LOW_Prison_Rat01_Event_GoToHole_dc64e547-bbd1-c4d0-a7ed-cfedf3f10c85)
THEN
ClearFlag((FLAG)LOW_Prison_Rat01_Event_GoToHole_dc64e547-bbd1-c4d0-a7ed-cfedf3f10c85);
PROC_SetOnStage(_SceneNPC, 1);

IF
RemovedFrom(LOW_CountingHouse_MediumSafe02_Key_186ecca4-3023-4433-9716-8f1752513afa,S_LOW_Prison_Rat01_7ec18c86-b069-4e60-82dd-61a0263d46f0)
THEN
SetStoryItem((ITEM)LOW_CountingHouse_MediumSafe02_Key_186ecca4-3023-4433-9716-8f1752513afa,1);
//END_REGION


//REGION Misc
IF
UseFinished(_Char, _Item, 1)
AND
DB_Players(_Char)
AND
DB_LOW_BasiliskGate_SteelWatchersNotes(_Item)
THEN
SetFlag((FLAG)WYR_KillDirectorGortash_State_LearnedFoundryLocation_56e0ff1b-8cc9-4996-be5c-9cb4724c611d);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
