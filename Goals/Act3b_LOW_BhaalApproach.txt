Version 1
SubGoalCombiner SGC_AND
INITSECTION
// Chasm Entrance ambush
DB_AmbushTrigger((TRIGGER)S_LOW_Undercity_BhaalCultists_ChasmEntrance_AmbushTrigger_ad0013f4-a4cc-48b3-bb83-89c419b35bbf, (TRIGGER)S_LOW_Undercity_BhaalCultists_ChasmEntrance_AmbushPerceptionTrigger_14cdd695-2767-4a9c-bdd3-8d292c857c6e, (DIFFICULTYCLASS)Act3_Challenging_7bf230a0-b68a-4c79-a785-79b498d6c36b);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_ChasmEntrance_AmbushTrigger_ad0013f4-a4cc-48b3-bb83-89c419b35bbf, (CHARACTER)S_LOW_UndercityChasmEntrance_Cultist_000_295deabe-d83c-4b5b-8ea2-016fa719b547, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_ChasmEntrance_AmbushTrigger_ad0013f4-a4cc-48b3-bb83-89c419b35bbf, (CHARACTER)S_LOW_UndercityChasmEntrance_Cultist_001_4a7e35c3-27b3-4b58-9ef4-6330b907c2a1, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_ChasmEntrance_AmbushTrigger_ad0013f4-a4cc-48b3-bb83-89c419b35bbf, (CHARACTER)S_LOW_UndercityChasmEntrance_Cultist_002_b1426ca0-e120-4e26-a0d6-d03625e4b5c8, 1);

// Patrol 1 ambush
DB_AmbushTrigger((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb, (TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushPerceptionTrigger_1caac616-6808-4a19-84af-8f6d87485841, (DIFFICULTYCLASS)Act3_Challenging_7bf230a0-b68a-4c79-a785-79b498d6c36b);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb, (CHARACTER)S_LOW_UndercityPatrol1_Cultist_000_0d291d3e-bf25-49ab-a15e-ed7a8b115a13, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb, (CHARACTER)S_LOW_UndercityPatrol1_Cultist_001_470999a2-58be-49cd-a50e-415b6e5a15fb, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb, (CHARACTER)S_LOW_UndercityPatrol1_Cultist_002_507919b5-2090-4a13-bcca-56e5a5f1c64b, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb, (CHARACTER)S_LOW_UndercityPatrol1_Cultist_003_da80e468-cadb-49da-934c-903ba912b7cf, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb, (CHARACTER)S_LOW_UndercityPatrol1_Cultist_Strangler_29ba6894-5a2b-4f81-b756-c5ebdafbbb74, 1);

// Patrol 2 ambush
DB_AmbushTrigger((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol2_AmbushTrigger_5c2b12e7-69e5-4ce8-a264-6d1804f7b588, (TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol2_AmbushPerceptionTrigger_ffbc2daf-b667-4d75-938d-e0074d63e02b, (DIFFICULTYCLASS)Act3_Challenging_7bf230a0-b68a-4c79-a785-79b498d6c36b);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol2_AmbushTrigger_5c2b12e7-69e5-4ce8-a264-6d1804f7b588, (CHARACTER)S_LOW_UndercityPatrol2_Cultist_001_ff5760cf-edab-482a-91bc-73e4e811eb57, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol2_AmbushTrigger_5c2b12e7-69e5-4ce8-a264-6d1804f7b588, (CHARACTER)S_LOW_UndercityPatrol2_Cultist_002_0e27e169-ee1e-4e56-93ba-3b86feafd252, 1);

// Chasm ambush
DB_AmbushTrigger((TRIGGER)S_LOW_RangedCultistAmbushTrigger_2aba7da4-9fc6-4f82-b6d8-34f3eb151505, (TRIGGER)S_LOW_RangedCultistAmbushPerceptionTrigger_3fd0481f-f2c4-40f5-b7f7-20fe72892aff, (DIFFICULTYCLASS)Act3_Challenging_7bf230a0-b68a-4c79-a785-79b498d6c36b);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_CultistAmbushTrigger_2aba7da4-9fc6-4f82-b6d8-34f3eb151505, (CHARACTER)S_LOW_RangedCultistAmbusher001_94ad0109-2c78-43f8-b7dd-0d056b742a23, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_CultistAmbushTrigger_2aba7da4-9fc6-4f82-b6d8-34f3eb151505, (CHARACTER)S_LOW_RangedCultistAmbusher002_61d478ae-72e6-44de-8bb1-0272c83fb85e, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_CultistAmbushTrigger_2aba7da4-9fc6-4f82-b6d8-34f3eb151505, (CHARACTER)S_LOW_RangedCultistAmbusher003_8d058eb7-2b2c-4504-9656-ec014b7b9872, 1);

DB_AmbushTrigger((TRIGGER)S_LOW_GroundCultistAmbushTrigger_a7bd5032-39eb-4e76-a60d-fbe49435ad75, (TRIGGER)S_LOW_GroundCultistAmbushPerceptionTrigger_708ef65e-eee8-4bb1-8a43-34a7219cbd4d, (DIFFICULTYCLASS)Act3_Challenging_7bf230a0-b68a-4c79-a785-79b498d6c36b);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_GroundCultistAmbushTrigger_a7bd5032-39eb-4e76-a60d-fbe49435ad75, (CHARACTER)S_LOW_GroundCultistAmbusher001_d81275b5-bff3-4799-8118-e7aa5df575b1, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_GroundCultistAmbushTrigger_a7bd5032-39eb-4e76-a60d-fbe49435ad75, (CHARACTER)S_LOW_GroundCultistAmbusher002_369cfca3-d282-4e73-ba40-670fb62f5fc5, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_GroundCultistAmbushTrigger_a7bd5032-39eb-4e76-a60d-fbe49435ad75, (CHARACTER)S_LOW_GroundCultistAmbusher003_7446d348-4741-42b4-a43b-1cbbfacacb6e, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_GroundCultistAmbushTrigger_a7bd5032-39eb-4e76-a60d-fbe49435ad75, (CHARACTER)S_LOW_GroundCultistAmbusher004_b6fcf8fd-fd3f-4cb5-a25e-d520762c56fc, 1);

//Ambushers for Combat Groups
DB_LOW_UndercityRuins_AmbushGroupTarget((TRIGGER)S_LOW_GroundCultistAmbushTrigger_a7bd5032-39eb-4e76-a60d-fbe49435ad75, (CHARACTER)S_LOW_GroundCultistAmbusher001_d81275b5-bff3-4799-8118-e7aa5df575b1);
DB_LOW_UndercityRuins_AmbushGroupTarget((TRIGGER)S_LOW_CultistAmbushTrigger_2aba7da4-9fc6-4f82-b6d8-34f3eb151505, (CHARACTER)S_LOW_RangedCultistAmbusher001_94ad0109-2c78-43f8-b7dd-0d056b742a23);
DB_LOW_UndercityRuins_AmbushGroupTarget((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol2_AmbushTrigger_5c2b12e7-69e5-4ce8-a264-6d1804f7b588, (CHARACTER)S_LOW_UndercityPatrol2_Cultist_001_ff5760cf-edab-482a-91bc-73e4e811eb57);
DB_LOW_UndercityRuins_AmbushGroupTarget((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb, (CHARACTER)S_LOW_UndercityPatrol1_Cultist_000_0d291d3e-bf25-49ab-a15e-ed7a8b115a13);
DB_LOW_UndercityRuins_AmbushGroupTarget((TRIGGER)S_LOW_Undercity_BhaalCultists_ChasmEntrance_AmbushTrigger_ad0013f4-a4cc-48b3-bb83-89c419b35bbf, (CHARACTER)S_LOW_UndercityChasmEntrance_Cultist_000_295deabe-d83c-4b5b-8ea2-016fa719b547);

// Cultist ambushers distinction for the obelisk ambush
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityChasmEntrance_Cultist_000_295deabe-d83c-4b5b-8ea2-016fa719b547, "Entrance");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityChasmEntrance_Cultist_001_4a7e35c3-27b3-4b58-9ef4-6330b907c2a1, "Entrance");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityChasmEntrance_Cultist_002_b1426ca0-e120-4e26-a0d6-d03625e4b5c8, "Entrance");

DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityPatrol1_Cultist_000_0d291d3e-bf25-49ab-a15e-ed7a8b115a13, "Patrol1");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityPatrol1_Cultist_001_470999a2-58be-49cd-a50e-415b6e5a15fb, "Patrol1");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityPatrol1_Cultist_002_507919b5-2090-4a13-bcca-56e5a5f1c64b, "Patrol1");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityPatrol1_Cultist_003_da80e468-cadb-49da-934c-903ba912b7cf, "Patrol1");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityPatrol1_Cultist_Strangler_29ba6894-5a2b-4f81-b756-c5ebdafbbb74, "Strangler");

DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityPatrol2_Cultist_001_ff5760cf-edab-482a-91bc-73e4e811eb57, "Patrol2");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_UndercityPatrol2_Cultist_002_0e27e169-ee1e-4e56-93ba-3b86feafd252, "Patrol2");

DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_RangedCultistAmbusher001_94ad0109-2c78-43f8-b7dd-0d056b742a23, "Ranged");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_RangedCultistAmbusher002_61d478ae-72e6-44de-8bb1-0272c83fb85e, "Ranged");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_RangedCultistAmbusher003_8d058eb7-2b2c-4504-9656-ec014b7b9872, "Ranged");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_GroundCultistAmbusher001_d81275b5-bff3-4799-8118-e7aa5df575b1, "Ground");

DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_GroundCultistAmbusher002_369cfca3-d282-4e73-ba40-670fb62f5fc5, "Ground");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_GroundCultistAmbusher003_7446d348-4741-42b4-a43b-1cbbfacacb6e, "Ground");
DB_LOW_UndercityRuins_CultistAmbushCombatants(S_LOW_GroundCultistAmbusher004_b6fcf8fd-fd3f-4cb5-a25e-d520762c56fc, "Ground");

DB_LOW_UndercityRuins_AmbushTypes(S_LOW_GroundCultistAmbushTrigger_72f164aa-7848-47fb-b09d-6a4b93ed4080, "Ground");
DB_LOW_UndercityRuins_AmbushTypes(S_LOW_GroundCultistAmbushTrigger_72f164aa-7848-47fb-b09d-6a4b93ed4080, "Ground");
DB_LOW_UndercityRuins_AmbushTypes(S_LOW_RangedCultistAmbushTrigger_2aba7da4-9fc6-4f82-b6d8-34f3eb151505, "Ranged");

// All ambush triggers
// DB_LOW_UndercityRuins_AmbushTriggers(_Trigger, _TriggerName, _DropCombatDistance)
DB_LOW_UndercityRuins_AmbushTriggers((TRIGGER)S_LOW_Undercity_BhaalCultists_ChasmEntrance_AmbushTrigger_ad0013f4-a4cc-48b3-bb83-89c419b35bbf, "Entrance",30);
DB_LOW_UndercityRuins_AmbushTriggers((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb, "Patrol1",25);
DB_LOW_UndercityRuins_AmbushTriggers((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol2_AmbushTrigger_5c2b12e7-69e5-4ce8-a264-6d1804f7b588, "Patrol2",30);
DB_LOW_UndercityRuins_AmbushTriggers((TRIGGER)S_LOW_CultistAmbushTrigger_2aba7da4-9fc6-4f82-b6d8-34f3eb151505, "Ranged",20);
DB_LOW_UndercityRuins_AmbushTriggers((TRIGGER)S_LOW_GroundCultistAmbushTrigger_a7bd5032-39eb-4e76-a60d-fbe49435ad75, "Ground",20);
DB_LOW_UndercityRuins_AmbushTriggers((TRIGGER)S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb, "Strangler",20);

// The sniper cultist can spot players
DB_SpotPlayers(Humans_Male_Cultist_Bhaal_DeathsHead_000_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_SniperSpotting",NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeSummons(Humans_Male_Cultist_Bhaal_DeathsHead_000_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_SniperSpotting");
DB_SpotPlayers_TargetIgnoreCantTalk(Humans_Male_Cultist_Bhaal_DeathsHead_000_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_SniperSpotting");
DB_SpotPlayers_IncludeWildshapedPlayers(Humans_Male_Cultist_Bhaal_DeathsHead_000_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_SniperSpotting");
DB_SpotPlayers_IncludeFollowers(Humans_Male_Cultist_Bhaal_DeathsHead_000_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_SniperSpotting");
DB_SpotPlayers_IgnoreCombat(Humans_Male_Cultist_Bhaal_DeathsHead_000_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_SniperSpotting");

// Register the sniper "In Sight" trigger and proximity trigger for all party members
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_Undercity_BhaalCultists_SniperTrigger_df116af6-46b0-46f2-b7e5-aae00aa22f6f);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_Undercity_BhaalCultists_SniperProximityTrigger_77031f02-4e6b-458f-bbb0-1f5006a8e28d);

// Trigger for the chasm entrance ambushers to rejoin if players dropped them before
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_Undercity_BhaalCultists_ChasmEntrace_RejoinCombatTrigger_716433cf-874e-429e-9a64-9d65ff3adcfa);

//Player triggers, where combat ends that need to check for party members
PROC_TriggerRegisterForPlayers(S_LOW_BhaalVoiceStunRange_2ec6dcf0-4f65-436d-8cf4-5c676a48921e);
PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproachPrepRoom_4871c302-99a8-4401-8392-63200dbb71b1);

// List of Melee cultist that will follow the players in the chasm ambush situation. When one of the is killed, check if drop combat with other cultists there
DB_LOW_UndercityRuins_MeleeAmbushers((CHARACTER)S_LOW_UndercityPatrol1_Cultist_Strangler_29ba6894-5a2b-4f81-b756-c5ebdafbbb74);
DB_LOW_UndercityRuins_MeleeAmbushers((CHARACTER)S_LOW_GroundCultistAmbusher004_b6fcf8fd-fd3f-4cb5-a25e-d520762c56fc);
DB_LOW_UndercityRuins_MeleeAmbushers((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093);
DB_LOW_UndercityRuins_MeleeAmbushers((CHARACTER)S_LOW_GroundCultistAmbusher001_d81275b5-bff3-4799-8118-e7aa5df575b1);
DB_LOW_UndercityRuins_MeleeAmbushers((CHARACTER)S_LOW_GroundCultistAmbusher002_369cfca3-d282-4e73-ba40-670fb62f5fc5);
DB_LOW_UndercityRuins_MeleeAmbushers((CHARACTER)S_LOW_GroundCultistAmbusher003_7446d348-4741-42b4-a43b-1cbbfacacb6e);

DB_UndercityRuins_SafetyTrigger(S_LOW_BhaalVoiceStunRange_2ec6dcf0-4f65-436d-8cf4-5c676a48921e);
DB_UndercityRuins_SafetyTrigger(S_LOW_BhaalApproachPrepRoom_4871c302-99a8-4401-8392-63200dbb71b1);

PROC_TriggerRegisterForParty(S_LOW_Undercity_BhaalCultists_DropCombatTrigger_00_3cff792b-c147-41e6-b48d-5f8ce314403f);
PROC_TriggerRegisterForParty(S_LOW_Undercity_BhaalCultists_DropCombatTrigger_01_5e7cee3f-f1b6-4dfd-bab8-c1695ce2732b);

DB_UndercityRuins_DropCombatTrigger(S_LOW_Undercity_BhaalCultists_DropCombatTrigger_00_3cff792b-c147-41e6-b48d-5f8ce314403f);
DB_UndercityRuins_DropCombatTrigger(S_LOW_Undercity_BhaalCultists_DropCombatTrigger_01_5e7cee3f-f1b6-4dfd-bab8-c1695ce2732b);

DB_OneShot_VoiceBarkTrigger(S_LOW_BhaalTemple_OneShotVB_ScaryStairs_Trigger_ac4fb1a0-1deb-40f2-b091-8969af8cb8a8,LOW_BhaalTemple_VB_ScaryStairs_b33ff4dd-4da9-0953-e072-c40ae589b543);
DB_OneShot_VoiceBarkTrigger(S_LOW_BhaalTemple_OneShotVB_ScaryViconia_Trigger_285f2ea5-2c14-44c9-a957-1f53e7d3d457,LOW_BhaalTemple_VB_ScaryViconia_692b2d09-0acf-41a5-805c-9948ba039342);

DB_UndercityRuins_HangingBodies(S_LOW_UndercityRuins_HangingCorpse001_b52d358a-f3de-4898-918b-4477908f62b3);
DB_UndercityRuins_HangingBodies(S_LOW_UndercityRuins_HangingCorpse002_0e4b527f-4aa9-4fee-859d-51d7ae13ad12);

//Here to hide the cultists - Currently a decision hasn't been made on if we're keeping/disposing them so for now we're just hiding them offstage
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel008_d8dfa504-e30c-4717-9af6-471c5bc8fc72);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel010_acf9ad51-68b1-4695-9ce6-d506c4de7670);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel004_a8792d5f-2814-4588-abc8-069fc916d313);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel006_f226da83-e229-4b94-8e76-7d0b674b963c);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel002_714ffa7b-81f3-4637-b5e3-7a5a560135de);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel007_d345b213-e393-46f2-ade1-8084e8b0345b);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel005_6e24ff8f-875f-40c0-a43b-c7b7f2e52368);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel009_dbe51b4f-c46c-4ded-a9d2-6bb4e0a92f22);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel003_0fca4b4d-775d-46ff-97cc-539f07ecae0d);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_BhaalTemple_Lieutenant_d23da937-a6aa-4b91-8631-57314792fd9e);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_CultistSentinel001_2aa53835-a143-4435-9794-1ec6a949eed8);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_BhaalTemple_Doppelganger_002_22d5547f-d8e5-4ee6-b017-db937520bdd4);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_BhaalTemple_Doppelganger_001_7ba6f82f-2132-4139-9b99-4f4a1b305edf);
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(S_LOW_BhaalTemple_Doppelganger_000_5ff9ea60-f48b-4880-a06f-35cacc680e66);

//VFX Walls to indicate the area were the Farslayer can target you with his spell
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_01_Red_002_bbc268ba-5a30-4165-bd02-731ce6769cbf);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_01_Red_003_3b4703af-94b0-4731-bb51-9da9f4a68523);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_01_Red_004_ff655eba-2663-4a07-8e69-0587fbb2d016);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_01_Red_005_c3c9d305-c445-42e9-ab3b-4acbc89975bf);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Big_Curve_Deep_02_Red_000_4e14308d-e8c8-4cf0-bc25-c6673d603020);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Big_Single_01_Red_000_fffd0c07-fb64-4a40-a964-200a060198d7);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Big_Single_01_Red_001_2b7cac6d-591e-4997-82f3-92963404645f);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Deep_01_Red_000_58de67f3-ab6d-4c2a-88d8-aeadfa94bb47);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Deep_01_Red_001_8b3adc08-1e4e-44b0-9610-a9211d9841c0);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Small_01_Red_000_6ea4e930-be61-4a01-8c9e-6e433ace8eb5);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Small_01_Red_001_03e079b5-1f00-475f-b4f3-d2ea9283249f);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Small_01_Red_002_35e97627-f705-416e-9ad9-8a1453343314);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Tall_01_Red_000_c8627cc3-56d2-4fea-915a-7cd3c2f179a2);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Tall_01_Red_001_adbdb286-1261-4f42-ae76-87a4f0a482e4);

//For the Lighting Braziers

DB_UndercityRuins_BhaalBraziers(S_LOW_BhaalApproach_BhaalBrazier_000_6b4b6460-74b0-4e78-8a8b-71531b0c0756, 1);
DB_UndercityRuins_BhaalBraziers(S_LOW_BhaalApproach_BhaalBrazier_001_e6d6c7fb-350a-4c5f-8e18-8b421044961a, 2);
DB_UndercityRuins_BhaalBraziers(S_LOW_BhaalApproach_BhaalBrazier_002_d735753d-3b32-480f-956f-530c58dff5c0, 3);
DB_UndercityRuins_BhaalBraziers(S_LOW_BhaalApproach_BhaalBrazier_003_6b45e9da-a69e-4118-a8ac-b921a13db36a, 4);
DB_UndercityRuins_BhaalBraziers(S_LOW_BhaalApproach_BhaalBrazier_004_45fcae73-6b0a-4a84-a979-187457aed370, 5);
DB_UndercityRuins_BhaalBraziers(S_LOW_BhaalApproach_BhaalBrazier_005_f095b186-6d57-4eae-9fbe-ecd9e7a15c67, 6);
DB_UndercityRuins_BhaalBraziers(S_LOW_BhaalApproach_BhaalBrazier_006_437c547d-cff1-45ce-bb65-b41761c9c2f1, 7);

//For the Whispering Statues

DB_UndercityRuins_BhaalStatues(S_LOW_BhaalApproach_WhisperingStatue_000_e8ed6e9b-1bf8-4218-a5e0-8a1215d7e5da, 1);
DB_UndercityRuins_BhaalStatues(S_LOW_BhaalApproach_WhisperingStatue_001_7117bda8-2088-449f-a682-113757483063, 2);
DB_UndercityRuins_BhaalStatues(S_LOW_BhaalApproach_WhisperingStatue_002_17471548-b386-4098-bbdd-853c7d8d09ef, 3);
DB_UndercityRuins_BhaalStatues(S_LOW_BhaalApproach_WhisperingStatue_003_0bc86ee9-cae5-426c-9287-c96ccc43df45, 4);
DB_UndercityRuins_BhaalStatues(S_LOW_BhaalApproach_WhisperingStatue_004_aa0a8ffc-4ab3-4aae-8216-6d61f1619fdc, 5);
DB_UndercityRuins_BhaalStatues(S_LOW_BhaalApproach_WhisperingStatue_005_9887f2c2-c10d-4e7f-ad02-424f68ff5352, 6);
DB_UndercityRuins_BhaalStatues(S_LOW_BhaalApproach_WhisperingStatue_006_a8d1f95d-8058-42cf-b74b-172b4f6309c3, 7);

//The relevant triggers

DB_UndercityRuins_BhaalHorrorTriggers(S_LOW_BhaalApproach_TriggerBox_000_f41d28f4-91b5-4e59-b72a-5aaf671880a4, 1);
DB_UndercityRuins_BhaalHorrorTriggers(S_LOW_BhaalApproach_TriggerBox_001_3c619322-8828-4095-a4c0-90c4714938bc, 2);
DB_UndercityRuins_BhaalHorrorTriggers(S_LOW_BhaalApproach_TriggerBox_002_09875c80-b606-4b99-bbf0-54a9e8a5bed8, 3);
DB_UndercityRuins_BhaalHorrorTriggers(S_LOW_BhaalApproach_TriggerBox_003_95af46b8-0d4c-4856-ab4e-d2c687c0093c, 4);
DB_UndercityRuins_BhaalHorrorTriggers(S_LOW_BhaalApproach_TriggerBox_004_0c49d2ed-3baf-4e61-837d-31e4d519adae, 5);
DB_UndercityRuins_BhaalHorrorTriggers(S_LOW_BhaalApproach_TriggerBox_005_99051adc-e886-41a4-9d82-63af1cb8fda3, 6);
DB_UndercityRuins_BhaalHorrorTriggers(S_LOW_BhaalApproach_TriggerBox_006_1f0a7254-2521-4558-be97-55f3740bbd84, 7);

//Appearing Candles on the bridge

PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_CandleSpawnTrigger001_e2dcf425-89a2-438e-a55b-ab4cc4705a55);
PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_CandleSpawnTrigger002_2be44e32-f2ad-41a0-9445-3c8aef55f7a4);
PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_CandleSpawnTrigger003_84e2152f-a9c9-444f-b88f-a59f24ab044e);

DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger001_e2dcf425-89a2-438e-a55b-ab4cc4705a55, S_LOW_BhaalApproach_Candle001_a4bfc5cb-f811-4b51-8621-a199d145174f);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger001_e2dcf425-89a2-438e-a55b-ab4cc4705a55, S_LOW_BhaalApproach_Candle002_e4176bcd-e165-4684-9572-04cb1ea76ddd);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger002_2be44e32-f2ad-41a0-9445-3c8aef55f7a4, S_LOW_BhaalApproach_Candle003_0b6afde4-0d84-4d71-8c34-753bc3761dd4);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger002_2be44e32-f2ad-41a0-9445-3c8aef55f7a4, S_LOW_BhaalApproach_Candle004_4084f302-bf41-44b4-86e5-2693e6fd4ab6);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger003_84e2152f-a9c9-444f-b88f-a59f24ab044e, S_LOW_BhaalApproach_Candle005_944e05f8-a8b7-4839-a73e-21596e7ba507);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger003_84e2152f-a9c9-444f-b88f-a59f24ab044e, S_LOW_BhaalApproach_Candle006_04e73c9d-bcde-4964-ab70-d6514af7feb2);

DB_UndercityRuins_CandleTeleportLocations(S_LOW_BhaalApproach_Candle005_944e05f8-a8b7-4839-a73e-21596e7ba507, S_LOW_BhaalApproach_Candle005Trigger_dd9d1b69-4c58-417f-b4be-763527fa8c5a);
DB_UndercityRuins_CandleTeleportLocations(S_LOW_BhaalApproach_Candle006_04e73c9d-bcde-4964-ab70-d6514af7feb2, S_LOW_BhaalApproach_Candle006Trigger_85020b2c-f460-44d5-925e-7cf0ee0d0960);

//For debug - So the UseStarted has a DB it can change from and to

DB_UndercityRuins_BhaalStatuesNormal(1);

//Sniper Setup 
ApplyStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"AMBUSHING",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"INVISIBLE",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

DB_CombatReact_AD_OnNextTurn(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, LOW_UndercityRuins_AD_Farslayer_e4ade190-0136-a72f-92bb-fed93ecc6301);

DB_LOW_BhaalApproach_AmbushBreaker(S_LOW_BhaalApproach_AmbushEnder_001_75ba19bf-3e9c-47ce-9311-13a8ed49fb7c, S_LOW_RangedCultistAmbushTrigger_2aba7da4-9fc6-4f82-b6d8-34f3eb151505);
DB_LOW_BhaalApproach_AmbushBreaker(S_LOW_BhaalApproach_AmbushEnder_000_b98cba8f-b9ea-411a-95a9-d87d7952005d, S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb);

PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_AmbushEnder_000_b98cba8f-b9ea-411a-95a9-d87d7952005d);
PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_AmbushEnder_001_75ba19bf-3e9c-47ce-9311-13a8ed49fb7c);


DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_BackGasTrap_001_99382cb8-fee1-4a79-b4ce-b2a798f56fbf, "LOW_BhaalApproach_ActivateBackTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_BackGasTrap_000_c1b68f93-947d-42e1-bbb5-b33223c08e13, "LOW_BhaalApproach_ActivateBackTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_MiddleGasTrap_002_2e0d41d8-3e70-4ec1-a5ae-d0207c4206b3, "LOW_BhaalApproach_ActivateMiddleTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_MiddleGasTrap_001_66de5d1c-33ec-439a-a93f-d57b19009a83, "LOW_BhaalApproach_ActivateMiddleTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_MiddleGasTrap_000_d7d3c4aa-ca76-4c5f-ab61-845a657af743, "LOW_BhaalApproach_ActivateMiddleTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_FrontGasTrap_000_9a052728-d0ac-4c7c-bff9-f836d790b10d, "LOW_BhaalApproach_ActivateFrontTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_FrontGasTrap_001_50abc78e-d242-4989-bb1f-ba2497b6ece9, "LOW_BhaalApproach_ActivateFrontTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_FrontGasTrap_002_6a27af16-dd11-4c78-a6a8-29c8d952b463, "LOW_BhaalApproach_ActivateFrontTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_FrontGasTrap_003_ba5e5003-f18c-4c9d-a6c9-6dbd8d9b2fd4, "LOW_BhaalApproach_ActivateFrontTraps");

DB_State_Priority(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatStarted", 0);
DB_State_Priority(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CastingStarted", 50);
DB_State_Priority(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOver", 100);
DB_State_Priority(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOverPlayed", 150);

DB_State_Flags(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatStarted", (FLAG)LOW_UndercityRuins_State_CombatStarted_95940e63-9ee8-4903-8223-9848b4cea764);
DB_State_Flags(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CastingStarted", (FLAG)LOW_UndercityRuins_State_CastingStarted_ef010a65-57c5-4433-be88-81611c5d1f22);
DB_State_Flags(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOver", (FLAG)LOW_UndercityRuins_State_CombatEnded_380ee479-d611-450f-a083-4d3e14b07bd6);
KBSECTION
IF
TextEvent("AmbushersLeave")
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _String)
AND
IsOnStage(_Ambusher, 1)
AND
NOT DB_Is_InCombat(_Ambusher, _)
THEN
PROC_Poof(_Ambusher);

IF
TextEvent("AmbushersComeBack")
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _String)
AND
NOT DB_PermaDefeated(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093)
AND
IsOnStage(_Ambusher, 0)
THEN
SetOnStage(_Ambusher, 1);


//If players cross them, cancel the ambush

IF
EnteredTrigger(_Player, _Trigger)
AND
DB_LOW_BhaalApproach_AmbushBreaker(_Trigger, _AmbushTrigger)
AND
DB_Players(_Player)
THEN
PROC_CancelAmbush((TRIGGER)_AmbushTrigger);

IF
EnteredCombat(_Enemy, _ID)
AND
DB_LOW_UndercityRuins_AmbushGroupTarget(_Ambush, (CHARACTER)_Enemy)
AND
QRY_OnlyOnce("LOW_BhaalApproach_SniperJoining")
AND
IsInCombat(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, 0)
THEN
PROC_LOW_BhaalApproach_SniperSetup(_Ambush);

//Catch all for the sniper removing his ambushing
IF
EnteredCombat(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, _ID)
AND
HasActiveStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "AMBUSHING", 1)
THEN
RemoveStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "AMBUSHING");

//Same for invisible, though this shouldn't ever happen, worth protecting

IF
EnteredCombat(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, _ID)
AND
HasActiveStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "INVISIBLE", 1)
THEN
RemoveStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "INVISIBLE");

//Tidies up the sniper being part of the other ambushes
PROC
PROC_LOW_BhaalApproach_SniperSetup((TRIGGER)_Ambush)
AND
DB_LOW_UndercityRuins_AmbushGroupTarget(_Ambush, _Ambusher)
AND
GetCombatGroupID(_Ambusher, _ID)
AND
CombatGetGuidFor(_Ambusher, _GUID)
AND
CombatGetInvolvedPartyMember(_GUID, 1, _Player)
THEN
RemoveStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "AMBUSHING");
RemoveStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "INVISIBLE");
SetCombatGroupAndEnterCombat(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, _ID, _Ambusher);

//To hide the cultists
IF
DB_UndercityRuins_HideCultistsInCaseWeNeedThem(_Cultist)
THEN
SetOnStage(_Cultist, 0);

//To hide the Sniper Ritual Walls
IF
DB_UndercityRuins_SniperRitualWalls(_Wall)
THEN
SetOnStage(_Wall, 0);

//To hide the braziers
IF
DB_UndercityRuins_BhaalBraziers(_Brazier, _Int)
THEN
SetOnStage(_Brazier, 0);

//To register all the triggers we need for players
IF
DB_UndercityRuins_BhaalHorrorTriggers(_Trigger, _Int)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)_Trigger);

//To hide the candles
IF
DB_UndercityRuins_AppearingCandles(_, _Candle)
THEN
SetOnStage(_Candle, 0);


//REGION Door trigger 
IF
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Cultist, _)
AND
DB_UndercityRuins_SafetyTrigger(_Trigger)
THEN
TriggerRegisterForCharacter((TRIGGER)_Trigger, (CHARACTER)_Cultist);

// If players reach specific areas, check to drop combat with ambushers that are too far to attack
IF
EnteredTrigger(_Player, _Trigger)
AND
DB_UndercityRuins_DropCombatTrigger(_Trigger)
AND
DB_LOW_UndercityRuins_AmbushTriggers(_,_Ambush,_DropCombatDistance)
AND
NOT QRY_LOW_UndercityRuins_AreAmbushersInDropCombatDistance(_Ambush,_DropCombatDistance)
THEN
PROC_UndercityRuins_AmbushersDropCombat((STRING)_Ambush);

QRY
QRY_LOW_UndercityRuins_AreAmbushersInDropCombatDistance((STRING)_Ambush,(INTEGER)_DropCombatDistance)
AND
DB_PartyMembers(_Player)
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _Ambush)
AND
GetDistanceTo(_Ambusher,_Player,_Dist)
AND
_Dist < _DropCombatDistance
THEN
DebugText(_Player,_Ambush);
DB_NOOP(1);

PROC
PROC_UndercityRuins_AmbushersDropCombat((STRING)_Ambush)
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _Ambush)
AND
IsInCombat(_Ambusher,1)
THEN
LeaveCombat(_Ambusher);

// If a melee ambusher gets killed, check to drop combat with other ambushers 
IF
KilledBy(_Ambusher, _, _, _)
AND
DB_LOW_UndercityRuins_MeleeAmbushers(_Ambusher)
AND
DB_LOW_UndercityRuins_AmbushTriggers(_,_Ambush,_DropCombatDistance)
AND
NOT QRY_LOW_UndercityRuins_AreAmbushersInDropCombatDistance(_Ambush,_DropCombatDistance)
THEN
PROC_UndercityRuins_AmbushersDropCombat((STRING)_Ambush);

//END_REGION

//REGION Cultist Ambushes
//Exterior Ambushes - There's some weird range at play with these, but interior ambushes should in theory go ahead as intended without this.
PROC
PROC_LaunchAmbush(_Ambush, _Player)
AND
DB_LOW_UndercityRuins_AmbushTypes(_Ambush, _AmbushType)
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Enemy, _AmbushType)
AND
DB_Players(_Player)
THEN
EnterCombat(_Enemy, _Player);

IF
EnteredTrigger(_Player,S_LOW_Undercity_BhaalCultists_ChasmEntrace_RejoinCombatTrigger_716433cf-874e-429e-9a64-9d65ff3adcfa)
AND
DB_Is_InCombat(_Player, _Combat) 
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher,_)
AND
DB_Is_InCombat(_Ambusher, _Combat) 
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_EntranceAmbusher, "Entrance")
AND
NOT DB_Is_InCombat(_EntranceAmbusher, _Combat) 
THEN
EnterCombat(_EntranceAmbusher, _Player);

//Player AD's

IF
TurnStarted(_Player)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_State_Current(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOverPlayed") //Here purely to make sure that once it's reached this stage it never bothers trying again
AND
DB_State_Current(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", _StateAD)
AND
NOT DB_OnlyOnce(_StateAD) 
AND
QRY_IsInCombatWith(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,_Player)
THEN
PROC_TryStartAD(LOW_BhaalApproach_PAD_FarslayerReaction_c26c80c4-8d48-f53b-b55c-baec1915ae2f, _Player);

IF
AutomatedDialogEnded(LOW_BhaalApproach_PAD_FarslayerReaction_c26c80c4-8d48-f53b-b55c-baec1915ae2f, _)
AND
DB_GlobalFlag(LOW_UndercityRuins_State_CombatEnded_380ee479-d611-450f-a083-4d3e14b07bd6)
THEN
PROC_State_Progress(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOverPlayed");

//END_REGION

//REGION Cultist Sniper
// When any ambush starts, make the sniper join combat with the players
IF
EnteredCombat(_Enemy, _ID)
AND
DB_LOW_UndercityRuins_AmbushGroupTarget(_Ambush, (CHARACTER)_Enemy)
AND
QRY_OnlyOnce("LOW_BhaalApproach_SniperJoining")
AND
IsInCombat(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, 0)
THEN
PROC_LOW_BhaalApproach_SniperSetup(_Ambush);
PROC_State_Progress(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatStarted");


//Tidies up the sniper being part of the other ambushes
PROC
PROC_LOW_BhaalApproach_SniperSetup((TRIGGER)_Ambush)
AND
DB_LOW_UndercityRuins_AmbushGroupTarget(_Ambush, _Ambusher)
AND
GetCombatGroupID(_Ambusher, _ID)
AND
CombatGetGuidFor(_Ambusher, _GUID)
AND
CombatGetInvolvedPartyMember(_GUID, 1, _Player)
THEN
RemoveStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "AMBUSHING");
RemoveStatus(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "INVISIBLE");
SetCombatGroupAndEnterCombat(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, _ID, _Ambusher);

// When the cultists starts his ritual, check for players to target
IF
StatusApplied(_Cultist,"LOW_BHAALCULTIST_SNIPING_AIMING",_,_)
THEN
PROC_LOW_UndercityRuins_UpdateSnipingStatus();
PROC_LOW_UndercityRuins_AddEntrancedStatusToAmbushers();
PROC_LOW_UndercityRuins_BlockExitDoor();
PROC_LOW_SetRitualWalls(1);

// At the start of the sniper turn, he gets a status to trigger the check for player to mark
IF
StatusApplied(_Char,"LOW_BHAALCULTIST_SNIPING_TECHNICAL",_,_)
THEN
PROC_LOW_UndercityRuins_UpdateSnipingStatus();

// Check wich players should be marked as inside the sniper sight
PROC
PROC_LOW_UndercityRuins_UpdateSnipingStatus()
AND
HasActiveStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_SNIPING_AIMING",1)
AND
GetStatusCurrentLifetime((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_SNIPING_AIMING",_Duration)
AND
DB_PartyMembers(_Player)
AND
IsInTrigger(_Player,(TRIGGER)LOW_Undercity_BhaalCultists_SniperTrigger_df116af6-46b0-46f2-b7e5-aae00aa22f6f,1)
AND
HasActiveStatus(_Player,"LOW_BHAALCULTIST_SNIPING_TARGET",0)
THEN
ApplyStatus(_Player,"LOW_BHAALCULTIST_SNIPING_TARGET",_Duration,0,(CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093);
PROC_State_Progress(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CastingStarted");


// Add the Entranced Status to all the ambushers when the Farslayer starts his ritual
PROC
PROC_LOW_UndercityRuins_AddEntrancedStatusToAmbushers()
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _)
AND
NOT DB_Defeated(_Ambusher)
AND
HasActiveStatus(_Ambusher, "LOW_BHAALCULTIST_ENTRANCEDAMBUSHER", 0)
THEN
ApplyStatus(_Ambusher, "LOW_BHAALCULTIST_ENTRANCEDAMBUSHER", -1.0, 0, (CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093);

//If the ritual starts, block the exit door until the farslayer dies
PROC
PROC_LOW_UndercityRuins_BlockExitDoor()
AND
HasActiveStatus(DOOR_GEN_Metal_Single_A_000_9f0792eb-b139-4aff-b741-f195f5a97786, "LOW_BHAALCULTIST_BLOCKEDDOOR", 0)
THEN
ApplyStatus(DOOR_GEN_Metal_Single_A_000_9f0792eb-b139-4aff-b741-f195f5a97786, "LOW_BHAALCULTIST_BLOCKEDDOOR", 600.0, 0, (CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093);

// Activate/Deactivate the ritual VFX walls

PROC
PROC_LOW_SetRitualWalls((INTEGER)_Bool)
AND
DB_UndercityRuins_SniperRitualWalls(_Wall)
THEN
SetOnStage(_Wall,_Bool);

// When the ritual ends, check if there's any player marked. If so, cast the ritual spell
IF
StatusRemoved((CHARACTER)_Cultist,"LOW_BHAALCULTIST_SNIPING_AIMING",_,_)
AND
QRY_LOW_UndercityRuins_PartyMemberIsInRitualSight()
THEN
UseSpell(_Cultist,"Shout_LOW_BhaalCultist_PowerWordKill_Ritual", _Cultist);
// Check if there's at least a party member with the techincal status. The status is applied through stats if a player was marked when the ritual ended
QRY
QRY_LOW_UndercityRuins_PartyMemberIsInRitualSight()
AND
DB_PartyMembers(_Player)
AND
HasActiveStatus(_Player,"LOW_BHAALCULTIST_SNIPING_TARGET_TECHNICAL",1)
THEN
DB_NOOP(1);

// Players inside the sniper trigger are marked as "in vision" of the sniper
IF
EnteredTrigger(_Player, (TRIGGER)LOW_Undercity_BhaalCultists_SniperTrigger_df116af6-46b0-46f2-b7e5-aae00aa22f6f)
AND
IsActive((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, 1)
AND
HasActiveStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_SNIPING_AIMING",1)
AND
HasActiveStatus(_Player,"LOW_BHAALCULTIST_SNIPING_TARGET",0)
AND
GetStatusCurrentLifetime((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_SNIPING_AIMING",_Duration)
THEN
ApplyStatus(_Player,"LOW_BHAALCULTIST_SNIPING_TARGET",_Duration,0,(CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093);

IF
Deactivated((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093)
AND
HasActiveStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_SNIPING_AIMING",1)
THEN
RemoveStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_SNIPING_AIMING");
IF
LeftTrigger(_Player, (TRIGGER)LOW_Undercity_BhaalCultists_SniperTrigger_df116af6-46b0-46f2-b7e5-aae00aa22f6f)
AND
HasActiveStatus(_Player,"LOW_BHAALCULTIST_SNIPING_TARGET",1)
THEN
RemoveStatus(_Player,"LOW_BHAALCULTIST_SNIPING_TARGET");

// The Sniper teleports to the portcullis room when he sees an attacker close to him
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_Undercity_BhaalCultists_SniperProximityTrigger_77031f02-4e6b-458f-bbb0-1f5006a8e28d)
AND
CanSee((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,_Player,1)
AND
HasActiveStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_PLAYERINRANGE",0)
THEN
ApplyStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_PLAYERINRANGE",-1.0,0,(CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093);
PROC_SpotPlayers_StopSpotting(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_SniperSpotting");

// If the cultist sees a player or is attacked by one, unlock the status that gives him the TP spell
IF
TurnStarted((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093)
AND
HasActiveStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_PLAYERINRANGE",0)
AND
DB_PartyMembers(_Player)
AND
IsInTrigger(_Player,(TRIGGER)S_LOW_Undercity_BhaalCultists_SniperTPPoint_c42223ce-9556-4de1-857b-8009ce94051d,1)
AND
CanSee((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,_Player,1)
THEN
ApplyStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_PLAYERINRANGE",-1.0,0,(CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093);
PROC_SpotPlayers_StopSpotting(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_SniperSpotting");

IF
AttackedBy((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,_AttackerOwner,(CHARACTER)_Player,_,_,_,_)
AND
HasActiveStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_PLAYERINRANGE",0)
AND
DB_PartyMembers(_Player)
THEN
ApplyStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_PLAYERINRANGE",-1.0,0,(CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093);
PROC_SpotPlayers_StopSpotting(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_SniperSpotting");

// Teleport the cultist through Osiris 
IF
CastSpell((CHARACTER)_Cultist,"Shout_LOW_BhaalCultist_Teleport",_,_,_)
THEN
TeleportTo(_Cultist,(TRIGGER)S_LOW_Undercity_BhaalCultists_SniperTPPoint_c42223ce-9556-4de1-857b-8009ce94051d);

//END_REGION

//REGION Cultist cleanups
IF
DB_GlobalFlag(GLO_Orin_State_PermaDefeated_c716e4d9-e6ed-445c-a710-ee4d91c67298)
THEN
PROC_LOW_UndercityRuins_TryToOffstage();

PROC
PROC_LOW_UndercityRuins_TryToOffstage()
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Enemy, _)
AND
IsInCombat(_Enemy, 0)
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)_Enemy, "LOW_UndercityRuins_CultistReadyToLeave");

PROC
PROC_LOW_UndercityRuins_TryToOffstage()
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Enemy, _)
AND
IsInCombat(_Enemy, 1)
THEN
DB_LOW_BhaalApproach_CleanupCultistsAfterCombat(_Enemy);

//Test
IF
DB_LOW_BhaalApproach_CleanupCultistsAfterCombat(_Enemy)
AND
NOT DB_Is_InCombat(_Enemy, _)
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)_Enemy, "LOW_UndercityRuins_CultistReadyToLeave");

//Once ready, the cultists leave. If something interrupts it, we should do this anyway - The flag for this is Orin's death, which should mean none of them are doing anything with the party at all.
PROC
PROC_ReadyToMoveOn(_Enemy, "LOW_UndercityRuins_CultistReadyToLeave")
THEN
PROC_Poof((CHARACTER)_Enemy);

PROC
PROC_ReadyToMoveOn(_Enemy, "LOW_UndercityRuins_CultistReadyToLeave")
AND
DB_LOW_BhaalApproach_CleanupCultistsAfterCombat(_Enemy)
THEN
PROC_Poof((CHARACTER)_Enemy);

IF
EntityEvent(_Enemy, "LOW_UndercityRuins_CultistLeft")
AND
DB_LOW_BhaalApproach_CleanupCultistsAfterCombat(_Enemy)
THEN
NOT DB_LOW_BhaalApproach_CleanupCultistsAfterCombat(_Enemy);

PROC
PROC_ReadyToMoveOn_Failed(_Enemy, "LOW_UndercityRuins_CultistReadyToLeave")
THEN
SetOnStage(_Enemy, 0);

//END_REGION

//REGION Bhaal Blood stuff
IF
AttackedBy(_Body, (CHARACTER)_, _, _, _, _, _)
AND
DB_UndercityRuins_HangingBodies(_Body)
THEN
CreateSurface(S_LOW_UndercityRuins_BloodTrigger_2275e72c-8e2e-4df3-b918-562ffe541ec0, "SurfaceBlood", 2.0, -1.0, _Body);

//Door trigger

IF
StatusApplied(S_LOW_UndercityRuins_BloodlessSkull_9aac2241-492c-4a6b-9b22-89a523089512,"INSURFACE", _,_)
AND
GetSurfaceGroundAt(S_LOW_UndercityRuins_BloodTrigger_2275e72c-8e2e-4df3-b918-562ffe541ec0, "SurfaceBlood")
THEN
PROC_PlayPerceptionRevealEffect(S_LOW_UndercityRuins_BloodlessSkull_9aac2241-492c-4a6b-9b22-89a523089512, "LOW_UndercityRuins_SkullBloodied");
TimerLaunch("LOW_UndercityRuins_BloodTimer", 3000);

IF
TimerFinished("LOW_UndercityRuins_BloodTimer")
AND
GetSurfaceGroundAt(S_LOW_UndercityRuins_BloodTrigger_2275e72c-8e2e-4df3-b918-562ffe541ec0, "SurfaceBlood")
THEN
RemoveSurfaceLayer(S_LOW_UndercityRuins_BloodTrigger_2275e72c-8e2e-4df3-b918-562ffe541ec0, "Ground", 3.0);
Transform(S_LOW_UndercityRuins_BloodiedSkull_beda28ca-e571-47ed-ab53-7e646d92c337, DEC_Dungeon_Skeleton_Skull_A_Bloody_A_568d8985-9dde-4338-ad40-58e515af7d4b, POLYMORPH_a0ddddc8-255f-4014-9f63-d7608eb1c2a0);
PROC_LOW_UndercityRuins_BhaalDoorOpens();

PROC
PROC_LOW_UndercityRuins_BhaalDoorOpens()
THEN
Unlock(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f);
Open(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f);
//END_REGION

//REGION Trap FTB

//Bhaal statue/brazier reactivity
IF
EnteredTrigger(_Player, _Trigger)
AND
DB_Players(_Player)
AND
DB_UndercityRuins_BhaalHorrorTriggers(_Trigger, _TriggerNumber)
THEN
PROC_UndercityRuins_ActivateBraziers(_TriggerNumber);
PROC_UndercityRuins_ActivateStatues(_TriggerNumber);
NOT DB_UndercityRuins_BhaalHorrorTriggers(_Trigger, _TriggerNumber);

PROC
PROC_UndercityRuins_ActivateBraziers((INTEGER)_TriggerNumber)
AND
DB_UndercityRuins_BhaalBraziers(_Brazier, _TriggerNumber)
THEN
PROC_Foop(_Brazier);
NOT DB_UndercityRuins_BhaalBraziers(_Brazier, _TriggerNumber);

PROC
PROC_UndercityRuins_ActivateStatues((INTEGER)_TriggerNumber)
AND
DB_UndercityRuins_BhaalStatues(_Statue, _TriggerNumber)
AND
DB_UndercityRuins_BhaalStatuesNormal(1)
THEN
PROC_TryStartAD(LOW_UndercityRuins_AD_WhisperingStatueBhaalChant_3f3c93a1-8d29-d873-5e67-2ba59e0b6a57, _Statue);
NOT DB_UndercityRuins_BhaalStatues(_Statue, _TriggerNumber);

PROC
PROC_UndercityRuins_ActivateStatues((INTEGER)_TriggerNumber)
AND
DB_UndercityRuins_BhaalStatues(_Statue, _TriggerNumber)
AND
NOT DB_UndercityRuins_BhaalStatuesNormal(1)
THEN
PROC_LOW_UndercityRuins_StatueADChecker(_Statue);
NOT DB_UndercityRuins_BhaalStatues(_Statue, _TriggerNumber);

PROC
PROC_LOW_UndercityRuins_StatueADChecker((GUIDSTRING)_Statue)
AND
GetFlag(LOW_UndercityRuins_Event_HeardStatue5_ae72345c-6311-4ced-8f3a-78a2cd8ade43, _Statue,  0)
THEN
PROC_TryStartAD(LOW_UndercityRuins_AD_WhisperingStatueBhaalChant_3f3c93a1-8d29-d873-5e67-2ba59e0b6a57, _Statue);


PROC
PROC_LOW_UndercityRuins_StatueADChecker((GUIDSTRING)_Statue)
AND
GetFlag(LOW_UndercityRuins_Event_HeardStatue5_ae72345c-6311-4ced-8f3a-78a2cd8ade43, _Statue, 1)
THEN
PROC_TryStartAD(LOW_UndercityRuins_AD_WhisperingStatue_52e23b43-abd2-9905-4a1e-02fc60f8ec7b, _Statue);

IF
EnteredTrigger(_Player, _Trigger)
AND
DB_Players(_Player)
AND
DB_UndercityRuins_AppearingCandles(_Trigger, _Candle)
AND
_Trigger != S_LOW_BhaalApproach_CandleSpawnTrigger003_84e2152f-a9c9-444f-b88f-a59f24ab044e
THEN
PROC_Foop(_Candle);
NOT DB_UndercityRuins_AppearingCandles(_Trigger, _Candle);

IF
EnteredTrigger(_Player, S_LOW_BhaalApproach_CandleSpawnTrigger003_84e2152f-a9c9-444f-b88f-a59f24ab044e)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_BhaalApproach_CandleTeleportTimer")
AND
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger003_84e2152f-a9c9-444f-b88f-a59f24ab044e, _Candle)
THEN
ObjectTimerLaunch(_Candle, "LOW_BhaalApproach_CandleTeleportTimer", 1800, 1);

IF
ObjectTimerFinished(_Candle, "LOW_BhaalApproach_CandleTeleportTimer")
AND
DB_UndercityRuins_CandleTeleportLocations(_Candle, _PointTrigger)
AND
DB_UndercityRuins_AppearingCandles(_Trigger, _Candle)
THEN
TeleportTo(_Candle, _PointTrigger, "LOW_BhaalApproach_LastCandleTeleport", 0,0,0,0,1);
PROC_Foop(_Candle);
NOT DB_UndercityRuins_AppearingCandles(_Trigger, _Candle);
NOT DB_UndercityRuins_CandleTeleportLocations(_Candle, _PointTrigger);
PROC_TriggerUnregisterForPlayers((TRIGGER)_Trigger);

IF
DualEntityEvent(_Player, S_LOW_UndercityRuins_BhaalBloodDoorBackup_c77fa54e-9c2c-4a50-9956-9b2eecb44dd2, "S_LOW_UndercityRuins_MoveBloodDoor")
AND
DB_Players((CHARACTER)_Player)
AND
IsClosed(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f, 0)
AND
IsClosing(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f, 0)
THEN
Close(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f);


IF
DualEntityEvent(_Player, S_LOW_UndercityRuins_BhaalBloodDoorBackup_c77fa54e-9c2c-4a50-9956-9b2eecb44dd2, "S_LOW_UndercityRuins_MoveBloodDoor")
AND
DB_Players((CHARACTER)_Player)
AND
IsOpened(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f, 0)
AND
IsOpening(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f, 0)
THEN
Open(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f);

PROC
PROC_BlockUseOfItem(_Player, S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f)
AND
IsLocked(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f, 1)
AND
QRY_StartDialog_Fixed(LOW_UndercityRuins_TalkingSkull_e3d3e639-01e6-330e-8b4b-c51ffec6e917, S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f, _Player)
THEN
DB_CustomUseItemResponse(_Player, S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55, 0);

IF
DB_GlobalFlag(LOW_UndercityRuins_State_BloodDoorOpened_dc7425db-e119-46d5-99ed-4285d2fa0e3f)
THEN
Open(S_LOW_UndercityRuins_BhaalBloodDoor_577c1fbe-d641-461a-b00e-784d5d24d27f);


//END_REGION

//REGION Wrap up combat
 
IF
Died((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093)
THEN
PROC_LOW_UndercityRuins_TidyCombat();
PROC_LOW_UndercityRuins_TidyTriggers();
PROC_LOW_SetRitualWalls(0);
PROC_State_Progress(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOverPlayed"); //Using this instead of CombatOver for now, as we're still mulling over whether we want the combat over line to play

// Setup the ambushers to offstage next turn
PROC
PROC_LOW_UndercityRuins_TidyCombat()
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _String)
AND
DB_Is_InCombat(_Ambusher, _GUID)
THEN
DB_LOW_UndercityRuins_AmbusherOffstageNextTurn(_Ambusher);

//If their turn started, and they aren't otherwise incapacitated, start the process of offstaging them
IF
TurnStarted(_Ambusher)
AND
DB_LOW_UndercityRuins_AmbusherOffstageNextTurn(_Ambusher)
AND
NOT DB_CantMove((CHARACTER)_Ambusher)
THEN
SetEntityEventReal(_Ambusher, "GLO_CombatWait", 5.0);
PROC_LOW_UndercityRuins_AmbusherOffstage((CHARACTER)_Ambusher);

//If nobody else has (and they aren't silenced) then they AD
PROC
PROC_LOW_UndercityRuins_AmbusherOffstage((CHARACTER)_Ambusher)
AND
NOT QRY_TemporarilyMuted(_Ambusher)
AND
QRY_OnlyOnce("LOW_UndercityRuins_FirstAmbusherLeaving")
THEN
PROC_TryStartAD(LOW_UndercityRuins_AD_CombatOver_097c61e4-264e-a03f-05ab-bd28d344a511, (GUIDSTRING)_Ambusher);

//Give them a couple of seconds for the camera to move and them to sheathe
PROC
PROC_LOW_UndercityRuins_AmbusherOffstage((CHARACTER)_Ambusher)
THEN
RealtimeObjectTimerLaunch((CHARACTER)_Ambusher, "LOW_UndercityRuins_AmbusherLeaving", 1500);
SetWeaponUnsheathed((CHARACTER)_Ambusher, 0, 0);

IF
ObjectTimerFinished((CHARACTER)_Ambusher, "LOW_UndercityRuins_AmbusherLeaving")
THEN
PROC_Poof(_Ambusher);


//Any not in combat can just offstage normally
PROC
PROC_LOW_UndercityRuins_TidyCombat()
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _String)
AND
NOT DB_Is_InCombat(_Ambusher, _)
THEN
PROC_Poof((CHARACTER)_Ambusher);

//Cancels any remaining onstage ambushes
PROC
PROC_LOW_UndercityRuins_TidyTriggers()
AND
DB_LOW_UndercityRuins_AmbushTriggers(_Trigger, _String, _Int)
THEN
PROC_CancelAmbush((TRIGGER)_Trigger);
//END_REGION

//REGION Bridge Traps

IF
DualEntityEvent(_Player, _, _Event)
AND
DB_Players((CHARACTER)_Player)
AND
DB_LOW_BhaalApproach_BridgeTraps(_Trap, _Event)
THEN
SetTrapArmed((ITEM)_Trap, 1);

IF
DualEntityEvent(_Player, _, "LOW_BhaalApproach_ActivateBackTraps")
AND
DB_Players((CHARACTER)_Player)
AND
DB_LOW_BhaalApproach_BridgeTraps(_Trap, _Event)
THEN
SetTrapArmed((ITEM)_Trap, 1);
PROC_LOW_BhaalApproach_CheatOtherTraps();

//Orin is a cheater, so if the last trap (which is a simple fire surface) activates and the rest haven't been deactivated, we also trigger the other two as well because otherwise the chain reaction doesn't happen.

PROC
PROC_LOW_BhaalApproach_CheatOtherTraps()
AND
DB_LOW_BhaalApproach_BridgeTraps(_Trap, "LOW_BhaalApproach_ActivateMiddleTraps")
AND
IsTrapArmed((ITEM)_Trap, 0)
THEN
SetTrapArmed((ITEM)_Trap, 1);

PROC
PROC_LOW_BhaalApproach_CheatOtherTraps()
AND
DB_LOW_BhaalApproach_BridgeTraps(_Trap, "LOW_BhaalApproach_ActivateFrontTraps")
AND
IsTrapArmed((ITEM)_Trap, 0)
THEN
SetTrapArmed((ITEM)_Trap, 1);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
