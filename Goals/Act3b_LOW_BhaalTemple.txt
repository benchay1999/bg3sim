Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Dark Urge Origin moment in Bhaal Temple
PROC_DefineSingleOriginMoment(
	(DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718, 
	(TAG)REALLY_DARK_URGE_cd611d7d-b67d-42b4-a75c-a0c6091ef8a2, 
	(DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b, 50.0);

PROC_DefineSingleOriginMoment(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_DarkUrgeGetStoneFirst_5a302a8f-9d78-a450-2070-cf7a09c4ad9f, 
	(TAG)REALLY_DARK_URGE_cd611d7d-b67d-42b4-a75c-a0c6091ef8a2, 
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_DarkUrgeGetStoneFirst_5a302a8f-9d78-a450-2070-cf7a09c4ad9f);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_DarkUrgeGetStoneFirst_5a302a8f-9d78-a450-2070-cf7a09c4ad9f, 50.0);

PROC_DefineSingleOriginMoment(
	(DIALOGRESOURCE)LOW_BhaalTemple_AD_ButlerDarkUrge_030a7706-e808-9a3a-3ed2-cc4467c50c31, 
	(TAG)REALLY_DARK_URGE_cd611d7d-b67d-42b4-a75c-a0c6091ef8a2, 
	(DIALOGRESOURCE)LOW_BhaalTemple_AD_ButlerDarkUrge_030a7706-e808-9a3a-3ed2-cc4467c50c31);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)LOW_BhaalTemple_AD_ButlerDarkUrge_030a7706-e808-9a3a-3ed2-cc4467c50c31, 30.0);

//END_REGION

//REGION For use with the Bhaal Amulet to open the Bhaal Temple Door.
DB_HasItemEvent((ITEM)S_LOW_MurderTribunal_BhaalAmulet_Sarevok_305049b2-b725-4e84-8f47-84fac8ea51f1, (FLAG)LOW_BhaalTemple_State_HasBhaalAmulet_66796361-3cf6-476a-8c09-a076dfa6a172);
DB_HasItemEvent((ITEM)S_LOW_BhaalTemple_BhaalAmulet_Lieutenant_843a9a25-8b22-48a6-9039-5cd829732818, (FLAG)LOW_BhaalTemple_State_HasBhaalAmulet_66796361-3cf6-476a-8c09-a076dfa6a172);
//END_REGION

//REGION For use with the AltarKey to unlock the victim on the Bhaal Altar.
DB_HasItemEvent((ITEM)S_LOW_BhaalTemple_AltarKey_c817c1c6-fd0e-41d8-9750-93dfe0e85c92, (FLAG)LOW_BhaalTemple_State_HasAltarKey_b28652b9-bf05-4fa3-91f5-45d8d0e049ae);
//END_REGION

//REGION Harper Confrontation DBs
DB_LOW_BhaalTemple_Harpers((CHARACTER)S_LOW_BhaalTemple_HarperCaptain_8600e330-fa15-471e-ab67-958f0543ee9f);
DB_LOW_BhaalTemple_Harpers((CHARACTER)S_LOW_BhaalTemple_Harper_01_a1909c71-b870-49d9-827b-2fad3b6e91bc);
DB_LOW_BhaalTemple_Harpers((CHARACTER)S_LOW_BhaalTemple_Harper_02_60a4b43e-80c4-4af6-a932-68c37aa99cb5);
DB_LOW_BhaalTemple_Harpers((CHARACTER)S_LOW_BhaalTemple_Harper_03_a5964a5e-8086-445e-989f-d9c7f32e32b6);
DB_LOW_BhaalTemple_Harpers((CHARACTER)S_LOW_BhaalTemple_Harper_04_bc18267f-baeb-4d49-9de0-3c8518529762);
//END_REGION

//REGION Temple Denizens Dialogs
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_UnholyAssassin_001_d00763c7-cac6-47b8-86be-a13ddd346861, 	(DIALOGRESOURCE)LOW_BhaalTemple_UnholyAssassin_01_588fcf28-69d7-4182-198a-fc5abba07dd4);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_UnholyAssassin_002_cec194b2-0e8d-4d38-a136-0e9b1c38c684, 	(DIALOGRESOURCE)LOW_BhaalTemple_UnholyAssassin_02_51203168-913d-2560-0f8c-64a21faf4a77);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Cultist_01_9f7607e0-abae-4722-921a-e18ee01b8984, 			(DIALOGRESOURCE)LOW_BhaalTemple_Cultist_01_d68ad153-98f9-7383-a56e-5c0a13390a8c);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Cultist_02_b69fe2eb-20ec-4d32-a146-ade9dc4df5eb, 			(DIALOGRESOURCE)LOW_BhaalTemple_Cultist_02_1f2fa5dd-f348-bcbf-3cad-bc73f4311539);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Cultist_03_09b965d0-49f7-4b00-a8ab-20f19e4a563b, 			(DIALOGRESOURCE)LOW_BhaalTemple_Cultist_03_90c2f88c-d68b-45a9-adfd-eb53618b6f5a);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Cultist_04_92e27323-35e8-41ce-9644-76d668295c10, 			(DIALOGRESOURCE)LOW_BhaalTemple_Cultist_04_d371d1e5-3911-9531-6272-49686f3b4abf);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Cultist_05_e20ee46e-ea8e-4781-95fd-5f1f72211703, 			(DIALOGRESOURCE)LOW_BhaalTemple_Cultist_05_478751c9-10cd-2c75-4842-26125a4cf7c7);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Cultist_06_692c037a-b660-4461-abb5-7599b1d12702, 			(DIALOGRESOURCE)LOW_BhaalTemple_Cultist_06_3509b9ff-622d-33b4-c050-72d5c5d5f5c5);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_DeathsHead_01_dc5d659c-8703-4e41-bf3e-0eeae60d919b, 		(DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_01_02e2b5a7-b80d-8ef8-887d-4809388a2f3d);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2, 		(DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_02_d6f3dd6d-32f0-c4cc-d741-4940afa51834);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_DeathsHead_03_1f0a7364-4893-4066-b188-907a51a75bd8, 		(DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_03_fe915ed1-e297-8df2-f6a1-e3eeda113e77);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_DeathsHead_04_db8e11fc-5f93-4dae-9abb-a8223317fa29, 		(DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_04_c1e3de46-6ad1-3170-6c49-72d9bd24ab1e);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab, 			(DIALOGRESOURCE)LOW_BhaalTemple_Reaper_01_b6fcdf7f-5483-1b28-f46e-d5ea2c85f1c0);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2, 			(DIALOGRESOURCE)LOW_BhaalTemple_Reaper_02_02dfcd29-6838-5288-f358-92b2834edf41);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a, 			(DIALOGRESOURCE)LOW_BhaalTemple_Reaper_03_a0cbadb8-f366-7ac7-ce92-65a13bf45bc2);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a, 			(DIALOGRESOURCE)LOW_BhaalTemple_Reaper_04_3fcd4d15-f82c-90fe-c34c-c9817ddacf49);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8, 			(DIALOGRESOURCE)LOW_BhaalTemple_Reaper_05_ff7c2a19-4463-909c-5514-2748f2198c27);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066, 			(DIALOGRESOURCE)LOW_BhaalTemple_Reaper_06_e6d0265e-efa9-96e5-b664-cdcc6fb116c3);
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)S_LOW_BhaalTemple_NightBlade_01_7a82cf11-57a2-4796-8b3a-d3409c0cbe9e, 		(DIALOGRESOURCE)LOW_BhaalTemple_NightBlade_01_be988e51-e3b3-020e-81c5-2e1e7b4f60be);
//END_REGION

//REGION Temple Denizens (Hostile when Non-DU, but Non-Hostile when Duel with DU, and if DU accepts Bhaal, they permanently non-hostile)
//DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_DeathsHead_01_dc5d659c-8703-4e41-bf3e-0eeae60d919b);
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2);
//DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_DeathsHead_03_1f0a7364-4893-4066-b188-907a51a75bd8);
//DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_DeathsHead_04_db8e11fc-5f93-4dae-9abb-a8223317fa29);
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab);
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2);
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a);
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a);
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8);
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066);
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)S_LOW_BhaalTemple_NightBlade_01_7a82cf11-57a2-4796-8b3a-d3409c0cbe9e);
//END_REGION

//REGION Temple Denizen Observation Position (for duel and non-duel)
DB_LOW_BhaalTemple_Denizens_ObservationPos((CHARACTER)S_LOW_BhaalTemple_UnholyAssassin_001_d00763c7-cac6-47b8-86be-a13ddd346861, 	(TRIGGER)S_LOW_BhaalTemple_ObservePos_05_4d44232d-cfde-4c66-b1a6-8aded5bc160c);
DB_LOW_BhaalTemple_Denizens_ObservationPos((CHARACTER)S_LOW_BhaalTemple_UnholyAssassin_002_cec194b2-0e8d-4d38-a136-0e9b1c38c684, 	(TRIGGER)S_LOW_BhaalTemple_ObservePos_01_0bd75d21-f145-42aa-9129-57a4b0d9ff8d);
DB_LOW_BhaalTemple_Denizens_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Cultist_01_9f7607e0-abae-4722-921a-e18ee01b8984, 			(TRIGGER)S_LOW_BhaalTemple_ObservePos_03_42b97128-4b0e-4642-b410-5303d8abca1a);
DB_LOW_BhaalTemple_Denizens_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Cultist_02_b69fe2eb-20ec-4d32-a146-ade9dc4df5eb, 			(TRIGGER)S_LOW_BhaalTemple_ObservePos_04_f78f2336-6a30-4161-bae0-21380acac05b);
DB_LOW_BhaalTemple_Denizens_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Cultist_03_09b965d0-49f7-4b00-a8ab-20f19e4a563b, 			(TRIGGER)S_LOW_BhaalTemple_ObservePos_07_65d8bbde-8ca7-45cb-930c-016ef796037a);
DB_LOW_BhaalTemple_Denizens_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Cultist_04_92e27323-35e8-41ce-9644-76d668295c10, 			(TRIGGER)S_LOW_BhaalTemple_ObservePos_08_cdb302d2-f6a5-4459-92a5-7082708ed8fb);
DB_LOW_BhaalTemple_Denizens_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Cultist_05_e20ee46e-ea8e-4781-95fd-5f1f72211703, 			(TRIGGER)S_LOW_BhaalTemple_ObservePos_06_80c9f6d2-4207-40af-b5e2-86ad3721aebb);
DB_LOW_BhaalTemple_Denizens_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Cultist_06_692c037a-b660-4461-abb5-7599b1d12702, 			(TRIGGER)S_LOW_BhaalTemple_ObservePos_02_37ccaf8e-bedf-4110-ba79-f83d5ad74bc9);

//DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_DeathsHead_01_dc5d659c-8703-4e41-bf3e-0eeae60d919b, 		(TRIGGER)NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2, 		(TRIGGER)S_LOW_BhaalTemple_Duel_ObservePos_07_04d2bdef-a409-44f1-8261-cec77474cc0d);
//DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_DeathsHead_03_1f0a7364-4893-4066-b188-907a51a75bd8, 		(TRIGGER)NULL_00000000-0000-0000-0000-000000000000);
//DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_DeathsHead_04_db8e11fc-5f93-4dae-9abb-a8223317fa29, 		(TRIGGER)NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab, 			(TRIGGER)S_LOW_BhaalTemple_Duel_ObservePos_01_6e48c5c0-4004-4ff4-89e5-dc07bf164a45);
DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2, 			(TRIGGER)S_LOW_BhaalTemple_Duel_ObservePos_02_85259fa2-16dd-4631-878f-ecd59ab374fc);
DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a, 			(TRIGGER)S_LOW_BhaalTemple_Duel_ObservePos_03_79e44b0c-a941-45e1-82fd-35bbd5f9ae2d);
DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a, 			(TRIGGER)S_LOW_BhaalTemple_Duel_ObservePos_04_3b036165-e4c3-438b-a1f8-5c5e68967b2b);
DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8, 			(TRIGGER)S_LOW_BhaalTemple_Duel_ObservePos_05_aebd29f3-8266-498f-9f5e-f141aef557e7);
DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066, 			(TRIGGER)S_LOW_BhaalTemple_Duel_ObservePos_06_3ead01a6-1d23-4bf7-8283-850c0999d967);
DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos((CHARACTER)S_LOW_BhaalTemple_NightBlade_01_7a82cf11-57a2-4796-8b3a-d3409c0cbe9e, 		(TRIGGER)S_LOW_BhaalTemple_Duel_ObservePos_08_b5d6768e-a0ef-47ee-a216-ccadfe1a3606);

DB_LOW_BhaalTemple_Denizens_Reinforcements(1, (CHARACTER)S_LOW_BhaalTemple_DeathsHead_01_dc5d659c-8703-4e41-bf3e-0eeae60d919b);
DB_LOW_BhaalTemple_Denizens_Reinforcements(2, (CHARACTER)S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2);
DB_LOW_BhaalTemple_Denizens_Reinforcements(3, (CHARACTER)S_LOW_BhaalTemple_DeathsHead_03_1f0a7364-4893-4066-b188-907a51a75bd8);
//DB_LOW_BhaalTemple_Denizens_Reinforcements(4, (CHARACTER)S_LOW_BhaalTemple_DeathsHead_04_db8e11fc-5f93-4dae-9abb-a8223317fa29);

//END_REGION


//REGION Used by In-World Abductions
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList("Laezel",		S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,		LOW_BhaalTemple_InWorldAbduction_Laezel_62709722-9dcd-893f-e0ae-0d36405237ca);
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList("Halsin",		S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,			LOW_BhaalTemple_InWorldAbduction_Halsin_b09fb417-6f49-6019-c647-cab6a8662f63);
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList("Gale",		S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,			LOW_BhaalTemple_InWorldAbduction_Gale_acc1013d-05c6-57b7-307e-e608115b7ec9);
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList("Minthara",	S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,	LOW_BhaalTemple_InWorldAbduction_Minthara_b3e9630b-c791-3d59-9319-35511eed2d5f);
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList("Yenna",		S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f,			LOW_BhaalTemple_InWorldAbduction_Yenna_60f5fcc6-df7a-f0d6-1f58-3f46630f7233);

//DB_LOW_BhaalTemple_AbductionAreas((TRIGGER)S_LOW_BhaalTemple_AbductionArea_01_4ac47f4d-e8e3-43f6-915b-817e7332dd09,		(TRIGGER)S_LOW_BhaalTemple_AbductionPos_01_e33feb90-f643-4863-bf7d-0cc2b6f2f4c5);
DB_LOW_BhaalTemple_AbductionAreas((TRIGGER)S_LOW_BhaalTemple_AbductionArea_02_fb4c231b-abbc-4f4c-b1b2-953c95135373,		(TRIGGER)S_LOW_BhaalTemple_AbductionPos_02_86d6cb8f-5de1-4518-93e7-80e6515330e7);
DB_LOW_BhaalTemple_AbductionAreas((TRIGGER)S_LOW_BhaalTemple_AbductionArea_03_2c3f9155-0e21-4a1c-935d-cd605e6c71b2,		(TRIGGER)S_LOW_BhaalTemple_AbductionPos_03_6ad8590e-ff71-462c-bd66-bfcfa731df3b);
DB_LOW_BhaalTemple_AbductionAreas((TRIGGER)S_LOW_BhaalTemple_AbductionArea_04_665389b1-cc49-48cd-8024-a4923f7851d9,		(TRIGGER)S_LOW_BhaalTemple_AbductionPos_04_ef36c26e-f20d-44b7-90ca-b88f8880cb59);

NOT DB_LOW_BhaalTemple_ChosenInWorldAbductionPos((TRIGGER)NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION Side-altar DBs for the default victims on Orin's altar.
DB_LOW_BhaalTemple_VictimList(1, (CHARACTER)S_LOW_BhaalTemple_OrinsVictim_01_736ffcb2-31b2-4c2b-9187-15296583e461, (TRIGGER)S_LOW_BhaalTemple_KilledImpersonation_Pos_01_5d0d63a7-94cc-4e96-b586-ebfc6733e645);
DB_LOW_BhaalTemple_VictimList(2, (CHARACTER)S_LOW_BhaalTemple_OrinsVictim_02_c5c49334-6c87-4ed7-acce-b77935cca031, (TRIGGER)S_LOW_BhaalTemple_KilledImpersonation_Pos_02_6956eebe-c11b-46a9-b5f2-244a14c13a89);

DB_LOW_BhaalTemple_AdmireKillADList((TRIGGER)S_LOW_BhaalTemple_AdmireKillADArea_01_ac9593fb-9276-4b70-a962-b5abc507fab3, (DIALOGRESOURCE)LOW_BhaalTemple_AD_AdmiringKill_01_225a8302-a751-e9ea-d954-bbf8556c38ee, (CHARACTER)S_LOW_BhaalTemple_Cultist_06_692c037a-b660-4461-abb5-7599b1d12702, S_LOW_BhaalTemple_UnholyAssassin_02_cec194b2-0e8d-4d38-a136-0e9b1c38c684);
DB_LOW_BhaalTemple_AdmireKillADList((TRIGGER)S_LOW_BhaalTemple_AdmireKillADArea_02_188e3d00-bc5a-4ace-8800-f1f9056d33c5, (DIALOGRESOURCE)LOW_BhaalTemple_AD_AdmiringKill_02_80eac312-050d-76d7-b641-a1e35f20e881, (CHARACTER)S_LOW_BhaalTemple_Cultist_03_09b965d0-49f7-4b00-a8ab-20f19e4a563b, S_LOW_BhaalTemple_Cultist_04_92e27323-35e8-41ce-9644-76d668295c10);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_BhaalTemple_AdmireKillADArea_01_ac9593fb-9276-4b70-a962-b5abc507fab3);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_BhaalTemple_AdmireKillADArea_02_188e3d00-bc5a-4ace-8800-f1f9056d33c5);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104);
//END_REGION

//REGION Duel related
DB_LOW_BhaalTemple_Allies_DuelPos((TRIGGER)S_LOW_BhaalTemple_Duel_Companion1_Pos_bde96a47-c724-4c6f-a237-e5a283d08a09, 0); // integer used to indicte if its used or not.
DB_LOW_BhaalTemple_Allies_DuelPos((TRIGGER)S_LOW_BhaalTemple_Duel_Companion2_Pos_3486f7c9-090d-427d-bd01-16142a6c3d50, 0);
DB_LOW_BhaalTemple_Allies_DuelPos((TRIGGER)S_LOW_BhaalTemple_Duel_Companion3_Pos_7babb553-989b-4687-a090-56a93cd223ed, 0);
//END_REGION 

//REGION Init Bhaal Temple
// Bhaal Avatar setup for Dark Urge.
TeleportTo(S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, S_LOW_BhaalAvatar_Home_f0835274-40ce-405a-905f-8c025ad9c77e);
SetVisible(S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 1);
SetDetached(S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 0);
//(TRIGGER)S_LOW_BhaalTemple_BhaalAvatar_TemplePos_21451bec-8274-445c-aab7-9b7d7d662590
DB_DangerZone((TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113, "LOW_BhaalTemple_DangerZone");
DB_DangerZone((TRIGGER)S_LOW_BhaalTemple_Dangerzone_Bridge_24294a7a-06c4-4258-a9c9-fec3c195ab86, "LOW_BhaalTemple_DangerZone_Bridge");


NOT DB_LOW_BhaalTemple_AbducteeRescuer((CHARACTER)NULL_00000000-0000-0000-0000-000000000000); // used to track who rescued the abductee.

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_TransformToSlayer_25508b93-831f-449b-92ef-d3baa32ae964, (DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_TransformToSlayer_25508b93-831f-449b-92ef-d3baa32ae964, (DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_State_OrinForcedSlayer_af3603a6-7114-4752-aa91-6c2a269d8c58, (DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_State_OrinForcedSlayer_af3603a6-7114-4752-aa91-6c2a269d8c58, (DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_PlayerTurnsIntoSlayerInDialog_4915ebb2-6d2c-41d0-baa0-b57d6a6df67f, (DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_PlayerTurnsIntoSlayerInDialog_4915ebb2-6d2c-41d0-baa0-b57d6a6df67f, (DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_Confrontation_Leaving_Wyll_e282515e-5415-4134-adbe-c70839deafb3, 	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_Confrontation_Leaving_Gale_20844e0e-fb68-4050-a947-cebf996b262b, 	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_Confrontation_Leaving_Karlach_f93d0bd8-5f3e-40c0-8174-88610dd8208d,(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);

DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e, (DIALOGRESOURCE)LOW_BhaalTemple_OrinsMother_Dead_d96d66d3-b2e5-658f-a112-8b9c3b90580b);

PROC_LOW_BhaalTemple_MainDoor_Init();
PROC_LOW_BhaalTemple_Lieutenant_Init();
PROC_LOW_BhaalTemple_Orin_Init();
PROC_LOW_BhaalTemple_Confrontation_Init();
PROC_LOW_BhaalTemple_Books_Init();
PROC_LOW_BhaalTemple_ArenaIndicator_Disable();
PROC_LOW_BhaalTemple_NarrativeItems_Setup();

PROC_LOW_BhaalTemple_DarkUrge_Setup(); // sets up Dark Urge options in Bhaal Temple if origin is present in team.
PROC_LOW_BhaalTemple_DarkUrgeClone_Setup();
PROC_LOW_BhaalTemple_Denizens_Dialogs_Setup();
PROC_LOW_BhaalTemple_Denizens_Combat_Setup();
PROC_LOW_BhaalTemple_Denizens_IgnoreShapeshiftReactions();
PROC_GEN_OrinsAbduction_InWorldAbductions_Init(); // enables world abduction only if an abduction hasn't occured
PROC_LOW_BhaalTemple_InWorldAbductionTriggers_Init(); // enables the triggers only if InWorld abduction flag was set to true in Init.
//END_REGION

//REGION Voice Bark
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_LOW_BhaalTemple_RuinsWyllVB_Trigger_e913a9b2-351f-47fd-9712-e799186863a6,(VOICEBARKRESOURCE)LOW_BhaalTemple_VB_WyllRuinsComment_2410babe-08a4-3f2e-efc7-7335205a6bd7);
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_LOW_BhaalTemple_VB_ArrivalBridge_8553d251-51c9-4afc-babd-7b4e3387ac67,(VOICEBARKRESOURCE)LOW_BhaalTemple_VB_ArrivingBhaalTemple_e9f26edf-90ed-9cb9-fd54-777bae067f5e, "PerUserAndNearbyPlayers");
DB_OneShot_VoiceBarkTrigger(S_ORI_DarkUrge_VB_ChosenRoom_b3d6a7f1-f99b-4c10-98d7-c72017005aa9, ORI_DarkUrge_VB_ChosenRoom_c0a1db6d-c39b-1d26-1510-c7737e5e1a4b);
//END_REGION

//REGION Topical greetings
DB_TopicalGreeting(TG_DarkUrge_FailedBhaal_b5a1847d-9d89-4df2-978d-dddcb4780e6b);
DB_TopicalGreeting(TG_DarkUrge_DefiedBhaal_885a6052-a198-4e01-b153-72e3867e4faa);
DB_TopicalGreeting(TG_DarkUrge_AcceptedBhaal_3e081f26-3eb2-43c8-8c86-6200e464e8a9);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_UndercityRuins_SUB_0ede416b-b162-462c-98a1-02e35f558773);				// Trigger used to set TG when players entered the Undercity
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_BhaalTemple_SewersBhaalDomain_e0628477-b5a3-4006-8b73-c382ce5f5431);	// Trigger used to set TG when players entered the Bhaal Domain of the Sewers.

DB_TopicalGreeting((FLAG)TG_LOW_Undercity_713b505c-952a-46ad-9358-f4494592ad23);		// TG 61
DB_TopicalGreetingEndCondition_LeaveTrigger((FLAG)TG_LOW_Undercity_713b505c-952a-46ad-9358-f4494592ad23, (TRIGGER)S_LOW_UndercityRuins_SUB_0ede416b-b162-462c-98a1-02e35f558773);

DB_TopicalGreeting((FLAG)TG_LOW_SewersBhaal_a0d35534-d2d3-4e2c-880e-b83e6dc4473d);		// TG 62
DB_TopicalGreetingEndCondition_LeaveTrigger((FLAG)TG_LOW_SewersBhaal_a0d35534-d2d3-4e2c-880e-b83e6dc4473d, (TRIGGER)S_LOW_BhaalTemple_SewersBhaalDomain_e0628477-b5a3-4006-8b73-c382ce5f5431);
//END_REGION

/*
//REGION Temple Denizen (Reapers)
DB_LOW_BhaalTemple_Denizens_Reaper((CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab);
DB_LOW_BhaalTemple_Denizens_Reaper((CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2);
DB_LOW_BhaalTemple_Denizens_Reaper((CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a);
DB_LOW_BhaalTemple_Denizens_Reaper((CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a);
DB_LOW_BhaalTemple_Denizens_Reaper((CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8);
DB_LOW_BhaalTemple_Denizens_Reaper((CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066);
//END_REGION
*/
/*
//REGION Temple Denizen (Cultists)
DB_LOW_BhaalTemple_Denizens_Cultist((CHARACTER)S_LOW_BhaalTemple_Cultist_01_9f7607e0-abae-4722-921a-e18ee01b8984);
DB_LOW_BhaalTemple_Denizens_Cultist((CHARACTER)S_LOW_BhaalTemple_Cultist_02_b69fe2eb-20ec-4d32-a146-ade9dc4df5eb);
DB_LOW_BhaalTemple_Denizens_Cultist((CHARACTER)S_LOW_BhaalTemple_Cultist_03_09b965d0-49f7-4b00-a8ab-20f19e4a563b);
DB_LOW_BhaalTemple_Denizens_Cultist((CHARACTER)S_LOW_BhaalTemple_Cultist_04_92e27323-35e8-41ce-9644-76d668295c10);
DB_LOW_BhaalTemple_Denizens_Cultist((CHARACTER)S_LOW_BhaalTemple_Cultist_05_e20ee46e-ea8e-4781-95fd-5f1f72211703);
DB_LOW_BhaalTemple_Denizens_Cultist((CHARACTER)S_LOW_BhaalTemple_Cultist_06_692c037a-b660-4461-abb5-7599b1d12702);
//END_REGION
*/

//REGION Combat ADs
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_01_078484d1-7d7f-2445-433c-deaf5b7d7c89, (CHARACTER)S_LOW_BhaalTemple_Cultist_01_9f7607e0-abae-4722-921a-e18ee01b8984, 1);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_03_04d05425-a36b-092c-f8ae-2684744cde3a, (CHARACTER)S_LOW_BhaalTemple_Cultist_01_9f7607e0-abae-4722-921a-e18ee01b8984, 3);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_02_19dc8500-4003-9ac5-ccee-48ca2258aa67, (CHARACTER)S_LOW_BhaalTemple_Cultist_01_9f7607e0-abae-4722-921a-e18ee01b8984, 5);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_02_19dc8500-4003-9ac5-ccee-48ca2258aa67, (CHARACTER)S_LOW_BhaalTemple_Cultist_02_b69fe2eb-20ec-4d32-a146-ade9dc4df5eb, 1);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_01_078484d1-7d7f-2445-433c-deaf5b7d7c89, (CHARACTER)S_LOW_BhaalTemple_Cultist_02_b69fe2eb-20ec-4d32-a146-ade9dc4df5eb, 2);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_03_04d05425-a36b-092c-f8ae-2684744cde3a, (CHARACTER)S_LOW_BhaalTemple_Cultist_02_b69fe2eb-20ec-4d32-a146-ade9dc4df5eb, 4);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_01_078484d1-7d7f-2445-433c-deaf5b7d7c89, (CHARACTER)S_LOW_BhaalTemple_Cultist_03_09b965d0-49f7-4b00-a8ab-20f19e4a563b, 3);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_03_04d05425-a36b-092c-f8ae-2684744cde3a, (CHARACTER)S_LOW_BhaalTemple_Cultist_03_09b965d0-49f7-4b00-a8ab-20f19e4a563b, 5);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_02_19dc8500-4003-9ac5-ccee-48ca2258aa67, (CHARACTER)S_LOW_BhaalTemple_Cultist_04_92e27323-35e8-41ce-9644-76d668295c10, 2);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_03_04d05425-a36b-092c-f8ae-2684744cde3a, (CHARACTER)S_LOW_BhaalTemple_Cultist_04_92e27323-35e8-41ce-9644-76d668295c10, 4);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_01_078484d1-7d7f-2445-433c-deaf5b7d7c89, (CHARACTER)S_LOW_BhaalTemple_Cultist_04_92e27323-35e8-41ce-9644-76d668295c10, 3);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_01_078484d1-7d7f-2445-433c-deaf5b7d7c89, (CHARACTER)S_LOW_BhaalTemple_Cultist_05_e20ee46e-ea8e-4781-95fd-5f1f72211703, 2);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_03_04d05425-a36b-092c-f8ae-2684744cde3a, (CHARACTER)S_LOW_BhaalTemple_Cultist_05_e20ee46e-ea8e-4781-95fd-5f1f72211703, 3);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_02_19dc8500-4003-9ac5-ccee-48ca2258aa67, (CHARACTER)S_LOW_BhaalTemple_Cultist_06_692c037a-b660-4461-abb5-7599b1d12702, 5);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_01_078484d1-7d7f-2445-433c-deaf5b7d7c89, (CHARACTER)S_LOW_BhaalTemple_Cultist_06_692c037a-b660-4461-abb5-7599b1d12702, 3);
DB_LOW_BhaalTemple_CombatAD_Cultists((DIALOGRESOURCE)LOW_BhaalCultist_AD_TakeTurn_Combat_03_04d05425-a36b-092c-f8ae-2684744cde3a, (CHARACTER)S_LOW_BhaalTemple_Cultist_06_692c037a-b660-4461-abb5-7599b1d12702, 4);

DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab, 1);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2, 1);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a, 2);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a, 2);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_03_950651f7-0cd2-7a53-cec9-0e53356f801b, (CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8, 3);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_03_950651f7-0cd2-7a53-cec9-0e53356f801b, (CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066, 3);

DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_04_5d7cde43-364c-8ca2-bb40-503f27733705, (CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab, 4);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_04_5d7cde43-364c-8ca2-bb40-503f27733705, (CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2, 4);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a, 5);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a, 5);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8, 6);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066, 6);

DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_03_950651f7-0cd2-7a53-cec9-0e53356f801b, (CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab, 7);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_03_950651f7-0cd2-7a53-cec9-0e53356f801b, (CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2, 7);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a, 8);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a, 8);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_04_5d7cde43-364c-8ca2-bb40-503f27733705, (CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8, 9);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_04_5d7cde43-364c-8ca2-bb40-503f27733705, (CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066, 9);

DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab, 10);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2, 10);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_04_5d7cde43-364c-8ca2-bb40-503f27733705, (CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a, 11);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_04_5d7cde43-364c-8ca2-bb40-503f27733705, (CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a, 11);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8, 12);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066, 12);

DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab, 13);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2, 13);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a, 14);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a, 14);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_03_950651f7-0cd2-7a53-cec9-0e53356f801b, (CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8, 15);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_03_950651f7-0cd2-7a53-cec9-0e53356f801b, (CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066, 15);

DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_04_5d7cde43-364c-8ca2-bb40-503f27733705, (CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab, 16);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_04_5d7cde43-364c-8ca2-bb40-503f27733705, (CHARACTER)S_LOW_BhaalTemple_Reaper_02_ef16770b-0590-457f-8475-712f2c491be2, 16);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_03_97c90688-1181-4893-a497-141e816a4c4a, 17);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_02_3ab1e569-b4a9-7693-3d33-e4ec523e08d4, (CHARACTER)S_LOW_BhaalTemple_Reaper_04_c01e3dc3-4323-4a50-a378-ae6c0b8a062a, 17);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_05_a2bcb302-7a7b-4206-ac93-54b755bcb4d8, 18);
DB_LOW_BhaalTemple_CombatAD_Reapers((DIALOGRESOURCE)LOW_BhaalReaper_AD_Incantation_Combat_01_e4aad5de-e7ca-5c7f-b4e7-b11a6faa5920, (CHARACTER)S_LOW_BhaalTemple_Reaper_06_646eaea2-2329-4d75-acc7-feddad951066, 18);
//END_REGION
KBSECTION
//REGION Combat ADs
// Cultists on their turn
IF
DB_LOW_BhaalTemple_CombatAD_Cultists(_CombatAD, _Cultist, _Turn)
THEN
DB_CombatReact_AD_OnTurn((GUIDSTRING)_Cultist, (DIALOGRESOURCE)_CombatAD, _Turn);

// Reaper casting Murderous Incantation
IF
DB_LOW_BhaalTemple_CombatAD_Reapers(_CombatAD, _Reaper, _Turn)
THEN
DB_CombatReact_AD_OnTurn((GUIDSTRING)_Reaper, (DIALOGRESOURCE)_CombatAD, _Turn);
//DB_CombatReact_AD_OnCast((GUIDSTRING)_Reaper, (DIALOGRESOURCE)_CombatAD, "LOW_MurderPrayer_ReaperOfBhaal");
//DB_CombatReact_AD_AppliedStatusToPlayerByOthers((GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (DIALOGRESOURCE)_CombatAD, "MARKEDFORBHALL_SLAYER", (GUIDSTRING)_Reaper);


// Orin's Combat AD, we set it up only when she's in the temple, else she might end up triggering it at other encounters of hers.
PROC
PROC_LOW_BhaalTemple_Orin_CombatAD_Setup()
THEN
DB_CombatReact_AD_OnTurn((GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (DIALOGRESOURCE)LOW_Orin_AD_TakeTurn_Combat_01_2a255b32-868f-bec8-3a00-b68a004c1834, 2);
DB_CombatReact_AD_OnTurn((GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (DIALOGRESOURCE)LOW_Orin_AD_TakeTurn_Combat_02_b1fd2091-ff7c-dc48-ad00-ad3e3f0489ec, 6);
DB_CombatReact_AD_OnTurn((GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (DIALOGRESOURCE)LOW_Orin_AD_MurderMark_Combat_01_a6da324c-cc80-28c6-2097-1a1282ec4e1c, 4);
DB_CombatReact_AD_OnTurn((GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (DIALOGRESOURCE)LOW_Orin_AD_MurderMark_Combat_02_2800dde1-68b9-138e-696f-2f8e50b89970, 8); 

DB_CombatReact_AD_OnCast((GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (DIALOGRESOURCE)LOW_Orin_AD_DeathBringerAssault_Combat_01_83d0972a-79b9-222d-5640-6dc7520dd178, "LOW_DeathbringerAssault_Orin");
DB_CombatReact_AD_OnCast((GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (DIALOGRESOURCE)LOW_Orin_AD_DeathBringerAssault_Combat_02_03b062f2-647c-4359-5555-a93532026fe4, "LOW_DeathbringerAssault_Orin");
//DB_LOW_BhaalTemple_CombatAD_Orin_Murder((DIALOGRESOURCE)LOW_Orin_AD_MurderMark_Combat_01_a6da324c-cc80-28c6-2097-1a1282ec4e1c);
//DB_LOW_BhaalTemple_CombatAD_Orin_Murder((DIALOGRESOURCE)LOW_Orin_AD_MurderMark_Combat_02_2800dde1-68b9-138e-696f-2f8e50b89970);

/*
IF
DB_LOW_BhaalTemple_CombatAD_Orin_Murder(_CombatAD)
AND
DB_LOW_BhaalTemple_Denizens_Reaper(_Reaper)
THEN
DB_CombatReact_AD_OnCastOther((GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _Reaper, _CombatAD, "MARKEDFORBHALL_SLAYER");
*/
//END_REGION


//REGION Init Lieutenant
PROC
PROC_LOW_BhaalTemple_Lieutenant_Init()
THEN
// remarked for now after review - with caveat that it might still be needed in the future.
//SetOnStage((CHARACTER)S_LOW_BhaalTemple_Lieutenant_d23da937-a6aa-4b91-8631-57314792fd9e, 1);
//SetVisible((CHARACTER)S_LOW_BhaalTemple_Lieutenant_d23da937-a6aa-4b91-8631-57314792fd9e, 1);
//ToInventory((ITEM)S_LOW_BhaalTemple_BhaalAmulet_Lieutenant_843a9a25-8b22-48a6-9039-5cd829732818, S_LOW_BhaalTemple_Lieutenant_d23da937-a6aa-4b91-8631-57314792fd9e);
SetOnStage((ITEM)S_LOW_BhaalTemple_BhaalAmulet_Lieutenant_843a9a25-8b22-48a6-9039-5cd829732818, 0);
//END_REGION

//REGION Init Dark Urge Clone for lore reasons
// if there's noDU in the game, then make this clone DU appear as the default DU
PROC
PROC_LOW_BhaalTemple_DarkUrgeClone_Setup()
AND
NOT QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
DB_GEN_OrinsAbduction_OrinTransformRule_DarkUrge(_TransformRule)
THEN
SetOnStage((CHARACTER)S_LOW_BhaalTemple_DarkUrgeClone_5a96d12a-f7b4-4628-8257-8a463b49852c, 1);
//Transform((CHARACTER)S_LOW_BhaalTemple_DarkUrgeClone_5a96d12a-f7b4-4628-8257-8a463b49852c, S_Player_DarkUrge_c66bc36f-7cb0-41fa-92f0-6d81d7d17ba3, _TransformRule); // No longer need to transform since the visual resource has been applied directly on the character.
PROC_GEN_OrinsAbduction_BloodiedChar_Apply((CHARACTER)S_LOW_BhaalTemple_DarkUrgeClone_5a96d12a-f7b4-4628-8257-8a463b49852c);
//CreateSurface(S_LOW_BhaalTemple_DarkUrgeClone_5a96d12a-f7b4-4628-8257-8a463b49852c, "SurfaceBlood", 1.0, -1.0); // create blood where smith used to be.
PROC_LoopEffectAtPositionAndRotation(VFX_Script_Bhaals_Blood_Droplets_Root_01_437788a3-d32b-1b63-26d7-0ae76c67daa2, S_LOW_BhaalTemple_DarkUrgeClone_5a96d12a-f7b4-4628-8257-8a463b49852c, "LOW_BhaalTemple_DarkUrgeSacrificeSign","CTY_Main_A", 0.60);

// if there's DU in the game, then offstage this NPC.
PROC
PROC_LOW_BhaalTemple_DarkUrgeClone_Setup()
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
THEN
SetOnStage((CHARACTER)S_LOW_BhaalTemple_DarkUrgeClone_5a96d12a-f7b4-4628-8257-8a463b49852c, 0);

IF
CharacterLootedCharacter(_Player, (CHARACTER)S_LOW_BhaalTemple_DarkUrgeClone_5a96d12a-f7b4-4628-8257-8a463b49852c)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_BhaalTemple_FoundDarkUrgeClone")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_PAD_FindDarkUrgeBody_471d4a29-b0c3-0466-01c0-eebbd5550030, _Player);
//END_REGION 

//REGION Init Orin
PROC
PROC_LOW_BhaalTemple_Orin_Init()
THEN
SetOnStage((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 1);
SetVisible((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 1);
PROC_GlobalClearFlagAndCache(LOW_BhaalTemple_Event_TransformToOrin_9280b884-9f8e-41f4-bd49-dbfcb2827fe5); // making sure flag is reset to false
PROC_GlobalClearFlagAndCache(LOW_BhaalTemple_Event_TransformToSlayer_25508b93-831f-449b-92ef-d3baa32ae964); // making sure flag is reset to false
//END_REGION

//REGION Orin's Mother handling
IF
LevelLoaded("CTY_Main_A") // If Undercity was loaded.
AND
NOT DB_LOW_BhaalTemple_OrinsMother_InPlace(1)
THEN
DB_LOW_BhaalTemple_OrinsMother_InPlace(1);
PROC_LOW_BhaalTemple_OrinsMother_Enable();

PROC
PROC_LOW_BhaalTemple_OrinsMother_Enable()
THEN
SetOnStage((CHARACTER)S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e, 1);
SetOnStage((ITEM)S_LOW_BhaalTemple_OrinsMotherBed_641b0657-91de-4ce2-8b9c-b9ce33967f3b, 1);
PROC_LOW_BhaalTemple_OrinsMother_UseBed();

PROC
PROC_LOW_BhaalTemple_OrinsMother_UseBed()
THEN
Use((CHARACTER)S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e, (ITEM)S_LOW_BhaalTemple_OrinsMotherBed_641b0657-91de-4ce2-8b9c-b9ce33967f3b, "");

IF
UseFinished((CHARACTER)S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e, (ITEM)S_LOW_BhaalTemple_OrinsMotherBed_641b0657-91de-4ce2-8b9c-b9ce33967f3b, 1)
THEN
PROC_LOW_BhaalTemple_OrinsMother_TeleportBed();

PROC
PROC_LOW_BhaalTemple_OrinsMother_TeleportBed()
THEN
TeleportTo((ITEM)S_LOW_BhaalTemple_OrinsMotherBed_641b0657-91de-4ce2-8b9c-b9ce33967f3b, (TRIGGER)S_LOW_BhaalTemple_OrinMotherBedPos_d4289963-a2f5-4932-b2c3-df057d71cc7b, "LOW_BhaalTemple_OrinsMother_UsedBed", 0, 0, 0, 0, 0);
SetVisible((ITEM)S_LOW_BhaalTemple_OrinsMotherBed_641b0657-91de-4ce2-8b9c-b9ce33967f3b, 0);


IF
EntityEvent(_, "LOW_BhaalTemple_OrinsMother_UsedBed")
THEN
SetOnStage((ITEM)S_LOW_BhaalTemple_OrinsMotherBed_641b0657-91de-4ce2-8b9c-b9ce33967f3b, 0);
PROC_LOW_BhaalTemple_OrinsMother_Kill();


PROC
PROC_LOW_BhaalTemple_OrinsMother_Kill()
THEN
PROC_DieImmediate((CHARACTER)S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e, DEATHTYPE.None, 0);
ApplyStatus((CHARACTER)S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e, "LOW_BHAALTEMPLE_ORINSMOTHER_DEAD_LOCKINPLACE", -1.0, 1, S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e); // testing.

// for debugging
PROC
PROC_LOW_BhaalTemple_OrinsMother_Resurrect()
THEN
Resurrect((CHARACTER)S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e);

PROC
PROC_LOW_BhaalTemple_OrinsMother_PlayDeadAnim()
THEN
PROC_PlayLoopingAnimation(S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e,(ANIMATION)CUST_Deathpose_Orin_Mother_01_d0d57381-b2cd-4e0a-9f4d-a16af3629367,(ANIMATION)CUST_Deathpose_Orin_Mother_01_d0d57381-b2cd-4e0a-9f4d-a16af3629367,(ANIMATION)NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_LOW_BhaalTemple_OrinsMother_ApplyStatus()
THEN
ApplyStatus((CHARACTER)S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e, "LOW_BHAALTEMPLE_ORINSMOTHER_DEAD_LOCKINPLACE", -1.0, 1, S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e);

//END_REGION

//REGION Butler's AD when players approach Bhaal Temple door.
// Butler START spotting at the temple door
PROC
PROC_LOW_BhaalTemple_ButlerSpotting_Started()
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, "LOW_BhaalTemple_Spotting_ButlerAtDoor");
DB_SpotPlayers((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, "LOW_BhaalTemple_Spotting_ButlerAtDoor", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

// Butler spots a player
PROC
PROC_SpotPlayers_Spotted(_,"LOW_BhaalTemple_Spotting_ButlerAtDoor",_Player)
THEN
PROC_LOW_BhaalTemple_Butler_StartDialog(_Player);

// If player spotted isn't the Dark Urge, but dark urge is nearby, the SingleOriginMoment will start it with the Dark Urge instead.
PROC
PROC_LOW_BhaalTemple_Butler_StartDialog((CHARACTER)_Player) // OM pipeline will decide whether to start Orin dialog or OrinDarkUrge dialog.
AND
QRY_StartDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_AD_ButlerDarkUrge_030a7706-e808-9a3a-3ed2-cc4467c50c31,
	(CHARACTER) S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10,
				_Player)
THEN
DB_NOOP(1);

//END_REGION

//REGION Init LoreFlag Books
PROC
PROC_LOW_BhaalTemple_Books_Init()
THEN
DB_BookFlags((ITEM)S_LOW_BhaalTemple_OrinsManifesto_c173f028-6da8-4bb6-bde1-c5b863f7c780, (FLAG)LOW_MurderTribunal_Knows_Sarevok_OrinGranddaughter_5a46b659-d27f-06c1-ab73-0911d2b63c23);
//END_REGION

//REGION Narrative Items
// non-DU flow
PROC
PROC_LOW_BhaalTemple_NarrativeItems_Setup()
AND
NOT QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
THEN
ToInventory((ITEM)S_LOW_BhaalTemple_BloodEnvyForTheUnworthyV1_02_d8c403d6-f5cc-4bfc-be0f-51f3163db684, (ITEM)S_LOW_BhaalTemple_Narrative_Chest_ChosenRoom_01_8d7d7944-ec50-4467-8740-e672ff04c323, 1, 0, 0);
ToInventory((ITEM)S_LOW_BhaalTemple_Book_APlanForChaos_01_e729109b-e25e-4eaa-a8cc-52badf9a787d, (ITEM)S_LOW_BhaalTemple_Narrative_Wardrobe_Wood_Rich_A_ChosenRoom_01_1f66cd01-7368-4a82-aa4a-acdb0902330e, 1, 0, 0);

// DU flow
PROC
PROC_LOW_BhaalTemple_NarrativeItems_Setup()
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
THEN
ToInventory((ITEM)S_LOW_BhaalTemple_BloodEnvyForTheUnworthyV1_01_c8c13f25-24de-4991-b822-87f2940283a8, (ITEM)S_LOW_BhaalTemple_Narrative_Chest_ChosenRoom_01_8d7d7944-ec50-4467-8740-e672ff04c323, 1, 0, 0);
ToInventory((ITEM)S_LOW_BhaalTemple_Book_TestMissionWithGortash_01_785eee09-ee31-44f9-b888-53b1c84b1538, (ITEM)S_LOW_BhaalTemple_Narrative_Wardrobe_Wood_Rich_A_ChosenRoom_01_1f66cd01-7368-4a82-aa4a-acdb0902330e, 1, 0, 0);
ToInventory((ITEM)S_LOW_BhaalTemple_Book_BhaalButlersChecklist_01_5aa2559b-20e6-408f-a3b7-626e85a996fa, (ITEM)S_LOW_BhaalTemple_Narrative_Vase_Large_A_Glazed_01_a0887209-1317-4ab0-a365-2913ab119157, 1, 0, 0);

// Either flow.
PROC
PROC_LOW_BhaalTemple_NarrativeItems_Setup()
THEN
ToInventory((ITEM)S_LOW_BhaalTemple_Book_ConcerningOrinTheRed_000_6e1c9d3b-174e-4bde-915d-a838856ed5f6, (ITEM)S_LOW_BhaalTemple_Narrative_Wardrobe_A_ChosenRoom_01_30a14814-27e4-45f3-9e01-d3ad25d1a553, 1, 0, 0);
ToInventory((ITEM)S_LOW_BhaalTemple_Book_WealthOfferingToBhaal_01_33749b63-fe11-4377-88e4-dfba53686817, (ITEM)S_LOW_BhaalTemple_Narrative_Chest_CorpseNiche_01_d99f4359-64ee-48e9-b888-5f610ad7cbcb, 1, 0, 0);

//END_REGION

//REGION Handling for Topical Greetings
// Entering Undercity
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_UndercityRuins_SUB_0ede416b-b162-462c-98a1-02e35f558773)
AND
DB_Avatars(_Player)
THEN
PROC_TopicalGreeting_UnlockTopic((FLAG)TG_LOW_Undercity_713b505c-952a-46ad-9358-f4494592ad23);

// Entering Bhaal Domain's of the Sewers
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_SewersBhaalDomain_e0628477-b5a3-4006-8b73-c382ce5f5431)
AND
DB_Avatars(_Player)
THEN
PROC_TopicalGreeting_UnlockTopic((FLAG)TG_LOW_SewersBhaal_a0d35534-d2d3-4e2c-880e-b83e6dc4473d);
//END_REGION


//REGION TODO Reaction to when players failed pickpocketing Orin's key. 
// event CharacterPickpocketFailed((CHARACTER)_Player, (CHARACTER)_NPC)
//END_REGION

//REGION Orin setup in at the temple
PROC
PROC_LOW_BhaalTemple_SetupOrinInTemple()
THEN
RemoveHarmfulStatuses((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
PROC_SelfHealing_Enable(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
SetImmortal(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0); // remove her immortality incase she came from an immpersonation that makes her immortal. shouldn't be needed normally, but needed when reviewers jump flow.
NOT DB_PreventPermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); 
DB_DoNotRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2);
TeleportTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, S_GLO_BhaalTemple_OrinTemple_TriggerPos_810e97df-6e10-4ff3-94d4-2a466a3ec7c7, "", 0, 0, 0, 0, 0);
DB_SceneManager((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BhaalTemple_CombatDenizens_Scene");
RemoveTransforms((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
NOT DB_GEN_OrinsAbduction_IsTransformed(1);
PROC_GEN_OrinsAbduction_OrinTransformsBack();
PROC_GEN_OrinsAbduction_Orin_RestoreTitle();
PROC_LOW_BhaalTemple_Orin_Inventory_Setup();
PROC_LOW_BhaalTemple_OrinSpotting_Started();
PROC_LOW_BhaalTemple_Orin_CombatAD_Setup();
PROC_WYR_OrinsImpersonation_FlamingFist_RemoveFaction(); // if Orin was impersonating the Flaming Fist, make sure she clears her faction first. Should already have been done, but can't be too sure.
PROC_LOW_BhaalTemple_Orin_Difficulty_Setup();
//END_REGION

//REGION Orin Handling of her stats depending on game difficulty
// Some stats (depending on difficult level) needs to only be applied when Orin is in the temple.
// If we set it on her before this, it'll also appear on her while she's doing her impersonations.

// Apply difficult Hard stats on Orin when she's placed in the temple if difficulty is set to hard.
PROC
PROC_LOW_BhaalTemple_Orin_Difficulty_Setup()
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521, "HARD", 1)
THEN
PROC_LOW_BhaalTemple_Orin_Difficulty_Hardmode(1);

// If difficulty level was changed to hard, enable Hard-Orin if she's already in the temple.
PROC
PROC_Hardcore_Enable("CTY_Main_A")
THEN
PROC_LOW_BhaalTemple_Orin_Difficulty_Hardmode(1);

// If difficulty level was changed to Not-hard, disable Hard-Orin if she's already in the temple.
PROC
PROC_Hardcore_Disable("CTY_Main_A")
THEN
PROC_LOW_BhaalTemple_Orin_Difficulty_Hardmode(0);

PROC
PROC_LOW_BhaalTemple_Orin_Difficulty_Hardmode(1)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
AND
NOT DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
HasActiveStatus(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,"LEGENDARY_RESISTANCE_CROWD_CONTROL", 0)
THEN
ApplyStatus(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,"LEGENDARY_RESISTANCE_CROWD_CONTROL", -1.0, 0, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);

PROC
PROC_LOW_BhaalTemple_Orin_Difficulty_Hardmode(0)
AND
HasActiveStatus(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,"LEGENDARY_RESISTANCE_CROWD_CONTROL", 1)
THEN
RemoveStatus(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,"LEGENDARY_RESISTANCE_CROWD_CONTROL", S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//END_REGION

//REGION Orin Equipment Handling
PROC
PROC_LOW_BhaalTemple_Orin_Inventory_Setup()
THEN
CharacterGiveEquipmentSet((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "EQP_LOW_Orin");
Equip((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55);
Equip((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (ITEM)S_GLO_Orin_OffhandDagger_675b8dd2-b6df-44f6-8978-b4ad340e0959);
ToInventory((ITEM)S_LOW_BhaalTemple_AltarKey_c817c1c6-fd0e-41d8-9750-93dfe0e85c92, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // give her the key to the altar.
PROC_GEN_OrinsAbduction_GiveOrinRing(); // Give her, her ring.

// moves all to a chest
PROC
PROC_LOW_BhaalTemple_Orin_Inventory_Save()
THEN
DB_LOW_BhaalTemple_SavedOrinsInventory(1);
Unequip((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (ITEM)S_GLO_Orin_OffhandDagger_675b8dd2-b6df-44f6-8978-b4ad340e0959);
Unequip((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55);
IterateInventory(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BhaalTemple_Orin_Inventory_Save", "LOW_BhaalTemple_Orin_Inventory_Save_Finished");

IF
EntityEvent((ITEM)_Item, "LOW_BhaalTemple_Orin_Inventory_Save")
THEN
ToInventory((ITEM)_Item, (ITEM)S_LOW_BhaalTemple_Orin_Chest_ImpersonationItems_38c55a73-1f33-4aa9-a208-2a0882b26f85);

// moves back to Orin's inventory.
PROC
PROC_LOW_BhaalTemple_Orin_Inventory_Restore()
AND
DB_LOW_BhaalTemple_SavedOrinsInventory(1)
THEN
NOT DB_LOW_BhaalTemple_SavedOrinsInventory(1);
IterateInventory(S_LOW_BhaalTemple_Orin_Chest_ImpersonationItems_38c55a73-1f33-4aa9-a208-2a0882b26f85, "LOW_BhaalTemple_Orin_Inventory_Restore", "LOW_BhaalTemple_Orin_Inventory_Restore_Finished");

IF
EntityEvent((ITEM)_Item, "LOW_BhaalTemple_Orin_Inventory_Restore")
AND
QRY_LOW_BhaalTemple_Orin_Inventory_CheckEquip((ITEM)_Item) // equip the item if its equippable, if not, move to inventory
THEN
DB_NOOP(1);

// If item is equippable, move to Orin's inventory and equip it
QRY
QRY_LOW_BhaalTemple_Orin_Inventory_CheckEquip((ITEM)_Item)
AND
IsEquipable((ITEM)_Item, 1)
AND
IsEquipped((ITEM)_Item, 0)
THEN
Equip((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (ITEM)_Item);

// If item isn't equippable, just move back to Orin's inventory.
QRY
QRY_LOW_BhaalTemple_Orin_Inventory_CheckEquip((ITEM)_Item)
AND
IsEquipable((ITEM)_Item, 0)
THEN
ToInventory((ITEM)_Item, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);


// When Orin dies, we will listen to event of when players pick up the Bhaal Dagger Netherstone to replace it with Bhaal Dagger w/o Netherstone. And give the player the netherstone.
IF
AddedTo((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_BhaalTemple_SwapNetherstoneDagger")
THEN
DB_GEN_OrinsAbduction_GaveDagger(1);
RequestDelete((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55);
PROC_GEN_OrinsAbduction_GiveDagger_WithoutNetherstone((CHARACTER)_Player);
PROC_GEN_OrinsAbduction_GiveStone((CHARACTER)_Player);

// Speculative Fix from one bugged player savegame GUS-320117
// If Equip should somehow fail, we should try to transfer the Netherstone dagger to Orin's character anyways.
// Combat AI should still equip it, or at the very least when Orin is defeated the dagger is still accessible.
IF
EquipFailed((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
THEN
ToInventory((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); 
//END_REGION

//REGION Orin's Controller Gem Handling for Dark Urge getting Orin stone before Gortash stone
IF
AddedTo(S_LOW_CrownController_Orin_360b0dfd-8e0b-48d2-a079-fcf68c104d6b, (CHARACTER)_Player, _)
AND
DB_Players(_Player)
AND
QRY_GLO_EmperorPrelude_NotLastNetherstone((ITEM)S_LOW_CrownController_Orin_360b0dfd-8e0b-48d2-a079-fcf68c104d6b)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575)
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
QRY_OnlyOnce("LOW_BhaalTemple_PostBattle_DarkUrgeGetStoneFirst")
THEN
PROC_LOW_BhaalTemple_PostBattle_DarkUrgeGetStoneFirst_StartDialog(_Player);

PROC
PROC_LOW_BhaalTemple_PostBattle_DarkUrgeGetStoneFirst_StartDialog((CHARACTER)_Player) // OM pipeline will decide whether to start Orin dialog or OrinDarkUrge dialog.
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0)
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_MissedTempleFinale_640cb288-0b40-434a-b13c-0c871d931bcc)
AND
QRY_StartDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_DarkUrgeGetStoneFirst_5a302a8f-9d78-a450-2070-cf7a09c4ad9f,
	(CHARACTER) _Player)
THEN
DB_NOOP(1);

//END_REGION

//REGION Setup Dark Urge options in Bhaal Temple if the origin is present in the team.
PROC
PROC_LOW_BhaalTemple_DarkUrge_Setup()
THEN
PROC_LOW_BhaalTemple_BhaalAvatar_Setup(); // checks to see if there is a DU part of the team. If there is, sets up bhaal avatar, else do not.
PROC_LOW_BhaalTemple_Butler_Setup(); // sets up Orin's butler. If DU is part of the team, also sets up DU Butler.
//END_REGION

//REGION Setup Bhaal Avatar at the temple.
PROC // if there is NOT a DarkUrge character part of the team.
PROC_LOW_BhaalTemple_BhaalAvatar_Setup()
AND  
NOT QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
THEN
SetOnStage((CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 0);
SetVisible((CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 0);

PROC // if there is a DarkUrge character part of the team.
PROC_LOW_BhaalTemple_BhaalAvatar_Setup()
AND  
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
THEN
TeleportTo((CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, S_LOW_BhaalAvatar_Home_f0835274-40ce-405a-905f-8c025ad9c77e, "", 0, 0, 0, 0, 0);
SetOnStage((CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 1);
SetVisible((CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 1);

PROC
PROC_LOW_BhaalTemple_BhaalAvatar_SetupInTemple()
THEN
SetVisible((CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 0);
SetOnStage((CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 0);
TeleportTo(S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, (TRIGGER)S_LOW_BhaalTemple_BhaalAvatar_TemplePos_21451bec-8274-445c-aab7-9b7d7d662590);

PROC
PROC_LOW_BhaalTemple_BhaalAvatar_RemoveFromTemple()
THEN
SetVisible((CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 1);
SetOnStage((CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 1);
TeleportTo(S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, (TRIGGER)S_LOW_BhaalAvatar_Home_f0835274-40ce-405a-905f-8c025ad9c77e);
//END_REGION

//REGION Setup Dark Urge's Butler.
PROC 
PROC_LOW_BhaalTemple_Butler_Setup()
AND  
NOT QRY_GEN_OrinsAbduction_HasDarkUrgeChar() // if there is NOT a DarkUrge character part of the team.
THEN
DB_NOOP(1);

PROC // if there is a DarkUrge character part of the team.
PROC_LOW_BhaalTemple_Butler_Setup()
AND
NOT DB_PartOfTheTeam((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10)
AND  
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
THEN
SetVisible((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 1);
SetDetached(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 0);
TeleportTo((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, S_LOW_BhaalTemple_ButlerDarkUrge_Home_TriggerPos_8d6f75fa-85f9-4a79-aaa8-a7af1a8bfbe5, "", 0, 0, 0, 0, 0);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355); // trigger used to replace the butler back at the door if he was taken away elsewhere for other camp nights.
TriggerRegisterForCharacter((TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355, (CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10);
DB_Dialogs((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, (DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000); // add fake dialog for butler so players can click on him to start dialog with door.
PROC_SetHasDialogIfChar(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 1);
PROC_LOW_BhaalTemple_ButlerSpotting_Started();

// if DU exists in the game, players can click on the butler, we start the dialog with the door.
QRY
QRY_SelectCustomDialog_AfterGenerics(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, _Player)
AND  
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575) // make sure this doesn't trigger beyond bhaal temple.
THEN
DB_SelectedDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_MainDoor_6879d3df-5c9c-6cd6-78ca-340aadfbd989,
	(CHARACTER)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2,
	_Player,
	S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10);
//END_REGION

//REGION Butler handling for when to place him infront of the temple door, since he might have been pulled away to campnights after he's already been placed at the door.
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83)
AND
DB_Players(_Player)
AND
NOT DB_InRegion((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, (TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355)
THEN
TeleportTo((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, S_LOW_BhaalTemple_ButlerDarkUrge_Home_TriggerPos_8d6f75fa-85f9-4a79-aaa8-a7af1a8bfbe5, "", 0, 0, 0, 0, 0);
SetVisible((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 1);
SetOnStage((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 1);
SetDetached(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 0);
PROC_GEN_OrinsAbduction_PlayEffect_TeleportOnCharPoof((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10);
PROC_LOW_BhaalTemple_ButlerSpotting_Started();

// if the last players left the trigger, restart his spotting.
IF
LeftTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83)
AND
DB_Players(_Player)
AND
NOT QRY_LOW_BhaalTemple_Butler_OtherPlayerInTrigger()
AND
DB_InRegion((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, (TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355)
THEN
PROC_LOW_BhaalTemple_ButlerSpotting_Started();

QRY
QRY_LOW_BhaalTemple_Butler_OtherPlayerInTrigger()
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355)
THEN
DB_NOOP(1);
//END_REGION

//REGION Butler handling
PROC
PROC_LOW_BhaalTemple_Butler_ResurrectInTemple()
THEN
PROC_CharacterFullRestore((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10);
TeleportTo(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, (TRIGGER)S_LOW_BhaalTemple_ButlerDarkUrge_ObservePos_95b134c2-d4ae-42b1-a824-0657b52365fd);
SetOnStage((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 1);

PROC
PROC_LOW_BhaalTemple_Butler_FinalState()
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_Butler_State_PermaDead_d2f18c09-105a-7cbd-8c44-9a323ca0ce28);
TeleportTo(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, (TRIGGER)S_LOW_BhaalTemple_ButlerDarkUrge_AltarPos_88d5c5e8-8612-4eff-9904-ff167e686915);
PROC_DieImmediate((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, DEATHTYPE.Physical, 0);
CreateSurface(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, "SurfaceBlood", 2.0, -1.0); // create blood where body is.
ToInventory((ITEM)S_LOW_BhaalTemple_Butler_Hat_9e56a94e-cc96-4393-ad2e-db05ffd5e974, S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10);


// send butler to camp so he can play his CAMP_DarkUrge_SkippedTempleFinale_SD_8b5bb777-741d-401b-23bb-106ca61b2d59
PROC
PROC_LOW_BhaalTemple_Butler_SendToCampAndHide()
THEN
PROC_ORI_SetupCamp((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 1); // setup in camp again because players could move camps before campnight kicks in.
SetOnStage((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 0);
//END_REGION

//REGION Setup Temple Denizens (Dialogs and combat counters)
// setup the dialogs of all denizens.
PROC
PROC_LOW_BhaalTemple_Denizens_Dialogs_Setup() 
AND
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)_Char, (DIALOGRESOURCE)_Dialog)
THEN
DB_Dialogs(_Char, _Dialog);

PROC
PROC_LOW_BhaalTemple_Denizens_PostBattleDU_Resistance_Dialog_Setup()
AND
DB_LOW_BhaalTemple_Denizens_Combat(_Denizen)
AND
NOT DB_PermaDefeated(_Denizen)
THEN
DB_NOOP(1);
//PROC_RemoveAllDialogEntriesForSpeaker(_Denizen);
//DB_Dialogs(_Denizen, (DIALOGRESOURCE)LOW_BhaalTemple_AD_IgnoringPlayers_d66d829a-5efe-6524-d50d-d012e5428842);

// setup the Defeat Counters for Temple Combat
PROC
PROC_LOW_BhaalTemple_Denizens_Combat_Setup() 
AND
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)_Char)
THEN
//DB_GLO_DefeatCounter(_Char, "LOW_BhaalTemple_Denizens_Hostile_Counter");
DB_SceneManager((CHARACTER)_Char, "LOW_BhaalTemple_CombatDenizens_Scene");

PROC
PROC_LOW_BhaalTemple_Denizens_Combat_AddToCounter() 
AND
DB_LOW_BhaalTemple_Denizens_Combat((CHARACTER)_Char)
AND
NOT DB_PermaDefeated(_Char)
THEN
DB_GLO_DefeatCounter(_Char, "LOW_BhaalTemple_CombatWin_Counter");

PROC
PROC_LOW_BhaalTemple_Denizens_IgnoreShapeshiftReactions()
AND
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)_Char, _)
THEN
PROC_CRIME_DisableDangerousShapeshiftReactions(_Char);
//END_REGION

//REGION Setup Yenna as default
PROC
PROC_LOW_BhaalTemple_SetupDefaultVictim()
AND
NOT QRY_LOW_BhaalTemple_AbductionHasOccured() // as long as abduction hasn't occurred, setup Yenna as the abductee.
THEN
PROC_GEN_OrinsAbduction_SetupVictimInTemple((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (FLAG)LOW_BhaalTemple_State_AbducteeIsYenna_fa8d1e59-26d5-4ad6-9706-1cb15a5cdb0a);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_WasAbductedYenna_ff8e1e49-dcb0-4671-a747-dce5c704207b); // to set the flag of who was actually abductee for use in dialogs.
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_AbducteeIsFemale_844c25f6-51f5-a806-8e41-9a97942a6e0a); // to set the gender flag for writers to use in dialogs - specifically the Nested dialog that wouldn't have access to the original victim.
PROC_GlobalSetFlagAndCache((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d);
PROC_GEN_OrinsAbduction_ClearDB_ChosenChar();
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
DB_GEN_OrinsAbduction_ChosenName("Yenna");
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
DB_GEN_OrinsAbduction_ChosenCharRelationship((FLAG)LOW_BhaalTemple_State_AbducteeIsYenna_fa8d1e59-26d5-4ad6-9706-1cb15a5cdb0a);
//END_REGION

//REGION Query to check if abduction has occured.
// if both in-camp and in-world abduction is false, abduction has already occurred - as opposed to only one is off but that could be because we disable it by default to not interrupt other scripters work.
// final version should by default both be on.
QRY 
QRY_LOW_BhaalTemple_AbductionHasOccured() 
AND
DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d)
THEN
DB_NOOP(1);
//END_REGION

//REGION Remove Yenna from altar if a companion was abducted instead.
PROC
PROC_LOW_BhaalTemple_RemoveDefaultVictim() // if the target is already Yenna, don't need to reset some flags.
AND
DB_GEN_OrinsAbduction_ChosenName(_TargetName)
AND
_TargetName != "Yenna"
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_AbducteeIsYenna_fa8d1e59-26d5-4ad6-9706-1cb15a5cdb0a);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_WasAbductedYenna_ff8e1e49-dcb0-4671-a747-dce5c704207b); // to set the flag of who was actually abductee for use in dialogs.
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
//END_REGION

//REGION Main Door Init
PROC
PROC_LOW_BhaalTemple_MainDoor_Init() // reset certain things for easier reloadStory
THEN
//SetCanInteract(S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, 1);
//PROC_ItemCloseAndLock(S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, "NeedBhaalAmulet");
PROC_LoopEffect(VFX_Environment_CTY_Main_BhaalTemple_Door_01_def4232e-eec8-f5d9-2ea2-03bfccb1bbbd, S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2,"LOW_BhaalTemple_MainDoorVFX", "CTY_Main_A", "");
//END_REGION

//REGION Main Door Handling
PROC
PROC_BlockUseOfItem(_Player, S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_Enabled_103a9b67-e2bb-4823-8262-e0d97aaca769)
AND
QRY_LOW_BhaalTemple_MainDoor_StartDialog(_Player)
THEN
DB_CustomUseItemResponse(_Player, S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, 0);

QRY
QRY_LOW_BhaalTemple_MainDoor_StartDialog((CHARACTER)_Player)
AND
QRY_StartDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_MainDoor_6879d3df-5c9c-6cd6-78ca-340aadfbd989, 
					S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, 
					_Player)
THEN
DB_NOOP(1);

PROC
PROC_LOW_BhaalTemple_MainDoor_StartDialog((CHARACTER)_Player)
AND
QRY_LOW_BhaalTemple_MainDoor_StartDialog(_Player)
THEN
DB_NOOP(1);

// if Dark Urge exists, and players clicked on the door, add the butler to the dialog - if he can talk.
PROC
PROC_StartDialog_AddExtraSpeakers(LOW_BhaalTemple_MainDoor_6879d3df-5c9c-6cd6-78ca-340aadfbd989, _DialogID)
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
NOT DB_CantTalk(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10)
THEN
PROC_DialogAddSpeakingActor(_DialogID, S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 0, 1);


// door is opened in dialog.
IF
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83)
THEN
PROC_LOW_BhaalTemple_OpenDoor();

PROC
PROC_LOW_BhaalTemple_OpenDoor()
AND
NOT DB_LOW_BhaalTemple_OpenedMainDoorFirstTime(_)
THEN
PROC_StopLoopEffect(S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, "LOW_BhaalTemple_MainDoorVFX");
PROC_ItemUnlockAndOpen((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2); // opens the door.
SetCanInteract((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, 0); // disable the interaction on the door
PROC_LOW_BhaalTemple_SetupOrinInTemple(); // setup Orin in the temple form wherever else she was from.
PROC_LOW_BhaalTemple_SetupDefaultVictim(); // Yenna is now locked in as abductee if no abduction has already occured.
PROC_LOW_BhaalTemple_SetupOrinsVictimsOnAltar(); // takes the victims from Orin's Impersonation (if any) and set them up at the side altars.
PROC_GEN_OrinsAbduction_DisableAllImpersonations(); // disappear all other impersonations/abduction now that the door is opened.
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355);
DB_LOW_BhaalTemple_CurrentState("PreCombat");
DB_LOW_BhaalTemple_OpenedMainDoorFirstTime(1);
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Start();

// Open the door like normal
PROC
PROC_LOW_BhaalTemple_OpenDoor()
AND
DB_LOW_BhaalTemple_OpenedMainDoorFirstTime(_)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_Enabled_103a9b67-e2bb-4823-8262-e0d97aaca769)
THEN
Open((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2);
SetCanInteract((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, 0); // enable the interaction on the door

// Close back the main door for the Confrontation scene.
PROC
PROC_LOW_BhaalTemple_CloseDoor()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_Enabled_103a9b67-e2bb-4823-8262-e0d97aaca769)
THEN
Close((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2);
SetCanInteract((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, 1); // enable the interaction on the door


//END_REGION

//REGION SIDE-ALTARS If Orin had impersonated anyone in Orin's Impersonation, setup their body in Bhaal Temple side altar
PROC
PROC_LOW_BhaalTemple_SetupOrinsVictimsOnAltar()
THEN
PROC_LOW_BhaalTemple_GetOrinsVictims(); // grabs info from Orin's Impersonation on who was fully impersonated in WYR, and place it in current goal DB_LOW_BhaalTemple_VictimsOnAltar
DB_LOW_BhaalTemple_VictimSpotFound("No");
PROC_LOW_BhaalTemple_ClearDB_VictimSpotFound();
PROC_LOW_BhaalTemple_PlaceVictimsOnAltar(1); // based on the DB grabbed above, set them up on the altar. 
PROC_LOW_BhaalTemple_ClearDB_VictimSpotFound();
PROC_LOW_BhaalTemple_PlaceVictimsOnAltar(2); // based on the DB grabbed above, set them up on the altar. 

PROC
PROC_LOW_BhaalTemple_GetOrinsVictims()
AND
DB_WYR_OrinsImpersonation_WorldImpersonationDeathFlag(_ImpName, (FLAG)_DeathFlag)
AND
DB_GlobalFlag(_DeathFlag)
AND
DB_WYR_OrinsImpersonation_WorldImpersonationList(_ImpName, _, _, _ImpChar)
AND
_ImpName != "Dryad" // Dryad's body won't be found, so ignore the case when its her.
THEN
DB_LOW_BhaalTemple_VictimsOnAltar(_ImpChar);


PROC
PROC_LOW_BhaalTemple_PlaceVictimsOnAltar((INTEGER)_Index)
AND
DB_LOW_BhaalTemple_VictimList(_Index, _VictimChar, _VictimTrigger)
AND
DB_LOW_BhaalTemple_VictimsOnAltar(_ImpChar)
AND
NOT DB_LOW_BhaalTemple_VictimSpotFound(_)
THEN
PROC_SetOnStage(_VictimChar, 0);
TeleportTo((CHARACTER)_ImpChar, (TRIGGER)_VictimTrigger, "", 0, 0, 0, 0, 0); // this location is at the door just inside of the house 
NOT DB_LOW_BhaalTemple_VictimsOnAltar(_ImpChar);
DB_LOW_BhaalTemple_VictimSpotFound("Yes");
//END_REGION

//REGION SIDE-ALTAR, Play an AD if players enter the trigger area.
IF
EnteredTrigger((CHARACTER)_Player, (TRIGGER)_AdmireTrig)
AND
DB_Players(_Player)
AND
DB_LOW_BhaalTemple_AdmireKillADList(_AdmireTrig, _AdmireAD, _AdmireSpeaker1, _AdmireSpeaker2)
THEN
PROC_TryStartAD((DIALOGRESOURCE)_AdmireAD, _AdmireSpeaker1, _AdmireSpeaker2);

PROC
PROC_LOW_BhaalTemple_AdmireKill_Disable()
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_BhaalTemple_AdmireKillADArea_01_ac9593fb-9276-4b70-a962-b5abc507fab3);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_BhaalTemple_AdmireKillADArea_02_188e3d00-bc5a-4ace-8800-f1f9056d33c5);
//END_REGION

//REGION On CTY level is loaded, and if Smith is still alive after impersonation, kill him.
IF
LevelLoaded("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)WYR_OrinsImpersonation_State_Impersonated_Smith_97b39a81-b28b-4228-b59d-18db921aef0a)
AND
DB_WYR_OrinsImpersonation_WorldImpersonationList("Smith", _, _, (CHARACTER)_ImpChar)
AND
NOT DB_PermaDefeated((CHARACTER)_ImpChar) // make sure he's not already dead due to some other circumstances
//AND
//NOT DB_WYR_OrinsImpersonation_Smith_KilledByPlayer(_)
AND
DB_WYR_OrinsImpersonation_PostOrinDeathPos("Smith", _ImpTemplePos)
THEN
TeleportTo((CHARACTER)_ImpChar, (TRIGGER)_ImpTemplePos, "", 0, 0, 0, 0, 0);
SetVisible((CHARACTER)_ImpChar, 1);
Die(_ImpChar,DEATHTYPE.DoT, 1);
//END_REGION


//REGION Dialog override to start Examine Abductee dialog when they are on the altar unconcious still.
QRY
QRY_SelectCustomDialog_AfterGenerics(_ImpersonatedChar, _Player)
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_ImpersonatedChar)
AND
DB_GEN_OrinsAbduction_Abductee_ExamineAbducteeDialog("Enabled")
AND
NOT DB_PermaDefeated(_ImpersonatedChar)
THEN
DB_SelectedDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_ExamineAbductee_7e7974f1-fbaa-a19b-b9bf-73980a0b3503,
	(CHARACTER)	_ImpersonatedChar,
				_Player);
//END_REGION

//REGION Bhaal Temple Altar
PROC
PROC_LOW_BhaalTemple_Altar_Enable()
THEN
SetCanInteract(S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, 1);
SetCanInteract(S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, 1);

PROC
PROC_LOW_BhaalTemple_Altar_Disable()
THEN
SetCanInteract(S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, 0);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
AND
NOT DB_LOW_BhaalTemple_State_SeenAltar(_)
THEN
DB_LOW_BhaalTemple_State_SeenAltar(1);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_SeenBhaalAltar_9a6db3ce-ddb0-4288-b419-a521b6a63004);
//END_REGION

//REGION Force Update Altar area
PROC
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Start()
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_ImpersonatedChar)
AND
IsForceUpdate(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0)
THEN
SetForceUpdate(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 1);
SetForceUpdate(_ImpersonatedChar, 1);

PROC
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Start()
AND
DB_LOW_BhaalTemple_Denizens_Combat(_Cultist)
AND
IsForceUpdate(_Cultist, 0)
THEN
SetForceUpdate(_Cultist, 1);

PROC
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Stop()
AND
IsForceUpdate(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 1)
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_ImpersonatedChar)
THEN
SetForceUpdate(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0);
SetForceUpdate(_ImpersonatedChar, 0);

PROC
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Stop()
AND
DB_LOW_BhaalTemple_Denizens_Combat(_Cultist)
AND
IsForceUpdate(_Cultist, 1)
THEN
SetForceUpdate(_Cultist, 0);

// if door was already opened, but Orin hasn't been defeated yet, re-enable the ForcedUpdate
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83) // temple door has been opened.
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // and combat hasn't begun yet.
THEN
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Start();

// when last player exits the temple dangerzone, stop the ForceUpdate
IF
LeftTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
AND
DB_Players(_Player)
AND
NOT QRY_AnyPlayerInTrigger((TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
THEN
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Stop();
//END_REGION

//REGION Dark Urge leaving the temple after killing Orin but not the rest of the combat NPCs required - counts as Bhaal Disappointed or missed finale.
IF
LeftTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
AND
DB_Players(_Player)
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar() // Dark Urge exist in this playthrough
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // after battle with Orin has already started.
AND
NOT QRY_AnyPlayerInTrigger((TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113) // last player left the temple
AND
DB_GlobalFlag((FLAG)GLO_Orin_State_PermaDefeated_c716e4d9-e6ed-445c-a710-ee4d91c67298) // Orin is dead already
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575) // Orin's gang was not wiped out yet or postBattle haven't triggered
THEN
// Dark Urge will be counted as abandoning the duel Bhaal expects.
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_MissedTempleFinale_640cb288-0b40-434a-b13c-0c871d931bcc); 
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0); 
//END_REGION

//REGION Altar Unlocked Out-of-Combat - Before Orin Dialog
// if victim is unlocked out of combat, we start Orin dialog and set abductee unlocked (but not yet awakened - this happens after the dialog with Orin). Sequence is :-
// 1) Start Orin dialog
// 2) End of dialog, waken the abductee with AD, set hostilities based on non-DU or DU.
// 3) Setup awaken abductee - Yenna runs away and will need to return post combat, companion joins as follower.
// 4) And Orin Combat hasn't begun already. This is to avoid the case where a player that isn't in combat and unlocks the altar.
IF
Unlocked((ITEM)S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, _Player, _)
AND
NOT DB_Is_InCombat(_Player, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235)
THEN
DB_LOW_BhaalTemple_AbducteeRescuer(_Player);
PROC_LOW_BhaalTemple_Abductee_Unlock();
PROC_LOW_BhaalTemple_DropInvisibility(_Player); // drop the player's invisibility since Orin detected them.
PROC_LOW_BhaalTemple_OrinSpotting_Stopped();
PROC_LOW_BhaalTemple_Orin_PreDialogSetup();
PROC_LOW_BhaalTemple_Orin_StartDialog(_Player); // start the Orin dialog.
//END_REGION

//REGION Altar Unlocked Out-of-Combat - After combat with Orin has already begun.
// if victim is unlocked out of combat, we start Orin dialog and set abductee unlocked (but not yet awakened - this happens after the dialog with Orin). Sequence is :-
// 1) Start Orin dialog
// 2) End of dialog, waken the abductee with AD, set hostilities based on non-DU or DU.
// 3) Setup awaken abductee - Yenna runs away and will need to return post combat, companion joins as follower.
// 4) And Orin Combat has already begun. This is to cover the case where a player that's still out of combat tries to save the abductee while rest of the party is in combat.
IF
Unlocked((ITEM)S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, _Player, _)
AND
NOT DB_Is_InCombat(_Player, _)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235)
THEN
DB_LOW_BhaalTemple_AbducteeRescuer(_Player);
PROC_LOW_BhaalTemple_Orin_SeeInvisibility_Apply(); // give Orin ability to see invisibility for a few rounds.
PROC_LOW_BhaalTemple_Abductee_Unlock();
PROC_LOW_BhaalTemple_Abductee_WakeUp();
PROC_LOW_BhaalTemple_DropInvisibility(_Player); // drop the player's invisibility since Orin detected them.
//END_REGION

//REGION Drop the invisibility of the person who unlocked the altar since Orin detected them.
PROC
PROC_LOW_BhaalTemple_DropInvisibility((CHARACTER)_Player)
AND
HasActiveStatusWithGroup(_Player, "SG_Invisible", 1)
THEN
RemoveStatusesWithGroup(_Player, "SG_Invisible");

// justify why she could see invisibility.
PROC
PROC_LOW_BhaalTemple_Orin_SeeInvisibility_Apply()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_VictimUnlocked_6fd6bf7c-dee2-4987-8469-ba8dacd18231)
THEN
ApplyStatus(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "SEE_INVISIBILITY", 6.0, 0, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//END_REGION


//REGION Altar Unlocked Out-of-Combat - After Orin Defeated
// this happens when Orin was defeated, but abductee is still on the altar knocked out.
// wakeup happens immediately.
IF
Unlocked((ITEM)S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, _Player, _)
AND
NOT DB_Is_InCombat(_Player, _)
AND
DB_PermaDefeated((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_GEN_OrinsAbduction_ChosenChar(_ImpersonatedChar)
THEN
DB_LOW_BhaalTemple_AbducteeRescuer(_Player);
PROC_LOW_BhaalTemple_Abductee_Unlock();
PROC_LOW_BhaalTemple_Abductee_WakeUp();
//END_REGION

//REGION Altar Unlocked During-Combat
// if victim is unlocked in combat, we start AD dialog with players to rescue
// wakeup happens immediately.
IF
Unlocked((ITEM)S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, _Player, _)
AND
DB_Is_InCombat(_Player, _)
THEN
DB_LOW_BhaalTemple_AbducteeRescuer(_Player);
PROC_LOW_BhaalTemple_Abductee_Unlock();
PROC_LOW_BhaalTemple_Abductee_WakeUp();
//END_REGION

//REGION Unlock Abductee, disabling the altar and nearby AdmireKill behavior.
PROC
PROC_LOW_BhaalTemple_Abductee_Unlock()
THEN
PROC_LOW_BhaalTemple_Altar_Disable();
PROC_LOW_BhaalTemple_AdmireKill_Disable();
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_VictimUnlocked_6fd6bf7c-dee2-4987-8469-ba8dacd18231); // unlocks the companion from the altar.
//END_REGION

//REGION Wake up the Abductee when Altar was unlocked. They wake up immediately for During and Post Combat, but delayed a bit for Pre Combat since players are in dialog with Orin.
PROC
PROC_LOW_BhaalTemple_Abductee_WakeUp() // wakes up the abductee and removes the KNOCKOUT status
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_VictimUnlocked_6fd6bf7c-dee2-4987-8469-ba8dacd18231)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9)
THEN
PROC_LOW_BhaalTemple_Abductee_Awakened();
//END_REGION

//REGION Awaken the Abductee and remove Knockout
// Prior to this current flow, unlocking and awakening the companion were 2 different player action, but now unlocking also means automatically awakening.
// The old follow remains though since Pre-Combat Unlocking has a delayed Awakening - as opposed to During-Combat and Post-Combat which Unlocking+Awakening happen back2back.
PROC
PROC_LOW_BhaalTemple_Abductee_Awakened()
AND
DB_GEN_OrinsAbduction_ChosenChar(_ImpersonatedChar)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565);
PROC_GEN_OrinsAbduction_Temple_KnockedOut_Remove((CHARACTER)_ImpersonatedChar);
PROC_LOW_BhaalTemple_AbducteeAwaken_AD_StartDialog();
PROC_LOW_BhaalTemple_AbducteeAwaken_Setup();
//END_REGION

//REGION Start AD with Abductee on the altar when they are awakened.
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_AD_StartDialog()
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
THEN
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_AD_AwakenAbductee_e190e3b3-1cfe-ee65-a3ff-c5b594489ad4);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_AD_AwakenAbductee_e190e3b3-1cfe-ee65-a3ff-c5b594489ad4, 
				(CHARACTER)	_TargetVictim);
//END_REGION

//REGION Setup the awakened Abductee - Yenna
// if abductee is Yenna, and its PreCombat or DuringCombat, make her run away.
PROC 
PROC_LOW_BhaalTemple_AbducteeAwaken_Setup() 
AND
DB_GEN_OrinsAbduction_ChosenName(_TargetName)
AND
_TargetName == "Yenna"
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
QRY_LOW_BhaalTemple_IsPreOrDuringCombat()
THEN
PROC_DisappearOutOfSightTo((CHARACTER)_TargetVictim, S_LOW_BhaalTemple_MapMarker_Door_1fbd7ac6-c15d-4c3e-93e8-f9bff39ed7c0, "Sprint", 0, "LOW_BhaalTemple_YennaFlee");
DB_LOW_BhaalTemple_State_YennaWentToHide("Yes");

// if abductee is Yenna, and its PostCombat, make her stand up and wait for dialog with player.
PROC 
PROC_LOW_BhaalTemple_AbducteeAwaken_Setup() 
AND
DB_GEN_OrinsAbduction_ChosenName(_TargetName)
AND
_TargetName == "Yenna"
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
NOT QRY_LOW_BhaalTemple_IsPreOrDuringCombat()
THEN
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby();
//END_REGION

//REGION QRY to check if its Pre or During Combat
QRY
QRY_LOW_BhaalTemple_IsPreOrDuringCombat()
AND
DB_LOW_BhaalTemple_CurrentState("PreCombat")
THEN
DB_NOOP(1);

QRY
QRY_LOW_BhaalTemple_IsPreOrDuringCombat()
AND
DB_LOW_BhaalTemple_CurrentState("DuringCombat")
THEN
DB_NOOP(1);
//END_REGION

//REGION Setup the awakened Abductee - Companions
// if abductee is a Companion, and its PreCombat or DuringCombat, make them join the fight as a Follower
PROC 
PROC_LOW_BhaalTemple_AbducteeAwaken_Setup() 
AND
DB_GEN_OrinsAbduction_ChosenName(_TargetName)
AND
_TargetName != "Yenna"
AND
QRY_LOW_BhaalTemple_IsPreOrDuringCombat()
THEN
PROC_LOW_BhaalTemple_AbducteeAwaken_Joins();

// if abductee is a Companion, and its PostCombat, make her stand up and wait for dialog with player.
PROC 
PROC_LOW_BhaalTemple_AbducteeAwaken_Setup() 
AND
DB_GEN_OrinsAbduction_ChosenName(_TargetName)
AND
_TargetName != "Yenna"
AND
NOT QRY_LOW_BhaalTemple_IsPreOrDuringCombat()
THEN
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby();

// add the awaken companion as a follower to the person who unlocked the altar
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_Joins()
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_ChosenChar)
AND
NOT DB_PermaDefeated(_ChosenChar) // knocked out char is permaDefeated.
AND
DB_LOW_BhaalTemple_AbducteeRescuer((CHARACTER)_Player)
THEN
AddPartyFollower((CHARACTER)_ChosenChar, (CHARACTER)_Player); // add the companion as a follower

PROC
PROC_GLO_PostReassignFollowerHook((CHARACTER)_Abductee, (CHARACTER)_OldLeader, (CHARACTER)_NewLeader)
AND
DB_GEN_OrinsAbduction_ChosenChar(_Abductee)
THEN
NOT DB_LOW_BhaalTemple_AbducteeRescuer(_OldLeader);
DB_LOW_BhaalTemple_AbducteeRescuer(_NewLeader);

// remove the companion as follower so that they take up a temporary position awaiting conversation with players post-combat.
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_LeavesParty()
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
QRY_IsPartyFollower(_TargetVictim)
THEN
PROC_RemovePartyFollower(_TargetVictim);
PROC_CharacterMoveTo(_TargetVictim, (TRIGGER)S_BhaalTemple_PostBattle_AbducteePos_bee54c03-3701-4937-8698-36a1a1aed229, "Walk", "LOW_BhaalTemple_PostBattleAbducteePos");

// upon reaching the appropriate 'waiting for dialog with player' position, wait for player dialog. Also start event to make them disappear anyways if players never bothered to speak to them (longrest=return to camp anyways).
IF
EntityEvent(_TargetVictim, "LOW_BhaalTemple_PostBattleAbducteePos")
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_TargetVictim)
THEN
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby();
//END_REGION

//REGION Post battle, the abductees are in Standby to wait for player dialog, if players don't talk to them and left the bhaal temple, make them go home themselves without dialog with player.
// For companions (NOT Yenna), since only they can be a follower
IF
LeftTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113) // players left the temple
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // after battle with Orin has already started.
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // companion was awakened already
AND
NOT QRY_AnyPlayerInTrigger((TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_PartyFollowers(_TargetVictim) // but is still a follower
AND
IsPartyFollower(_TargetVictim, 1)
AND
CharacterGetOwner(_TargetVictim, _Owner)
THEN
RemovePartyFollower(_TargetVictim, _Owner);
DB_LOW_BhaalTemple_State_WaitForLongRest("No"); // to stop from checking long rest anymore.
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Yes"); // to disable the dialog override of the companion
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_SpokenToAbducteePostCombat_8dca8ba2-f2ca-44ca-b966-75ff7d839075);
NOT DB_Dialogs(_TargetVictim, (DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
PROC_LOW_BhaalTemple_AbducteeAwaken_SendToCamp(_TargetVictim, _Owner);

// For companions (NOT Yenna), since only they can be a follower
IF
LeftTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113) // players left the temple
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // after battle with Orin has already started.
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // companion was awakened already
AND
NOT QRY_AnyPlayerInTrigger((TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_GLO_Follower_Reassigning(_Follower, _OldChar, _Owner)
THEN
NOT DB_GLO_Follower_Reassigning(_Follower, _OldChar, _Owner);
DB_LOW_BhaalTemple_State_WaitForLongRest("No"); // to stop from checking long rest anymore.
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Yes"); // to disable the dialog override of the companion
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_SpokenToAbducteePostCombat_8dca8ba2-f2ca-44ca-b966-75ff7d839075);
NOT DB_Dialogs(_TargetVictim, (DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
PROC_LOW_BhaalTemple_AbducteeAwaken_SendToCamp(_TargetVictim, _Owner);

// if it is NOT Yenna.
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_SendToCamp((CHARACTER)_TargetVictim, (CHARACTER)_Owner)
AND
_TargetVictim != S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f
THEN
PROC_ORI_SendToCampAfterDialog(_TargetVictim, 0, "Sprint", (CHARACTER)_Owner);

// if its Yenna.
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_SendToCamp((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (CHARACTER)_Owner)
THEN
PROC_DisappearOutOfSightTo((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, S_LOW_BhaalTemple_MapMarker_Door_1fbd7ac6-c15d-4c3e-93e8-f9bff39ed7c0, "Sprint", 0, "LOW_BhaalTemple_YennaArrivesInCamp");

IF
EntityEvent((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, "LOW_BhaalTemple_YennaArrivesInCamp")
AND
NOT DB_PermaDefeated(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
THEN
PROC_GlobalSetFlagAndCache((FLAG)CAMP_Yenna_State_PostAbductionCampChat_d30c5b6a-eada-4c8c-927d-a50de178ec29);
PROC_ORI_SetupCamp(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
//END_REGION

//REGION Post Battle, the adbuctees are still on the altar, but player just left them on the altar and left the temple. We assume the remaining cultists killed the abductee.
IF
LeftTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113) // players left the temple
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // after battle with Orin has already started.
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_VictimUnlocked_6fd6bf7c-dee2-4987-8469-ba8dacd18231) // abductee was not even unlocked
AND
NOT QRY_AnyPlayerInTrigger((TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
THEN
PROC_LOW_BhaalTemple_Abductee_Abandoned();

// if its Yenna, she needs to have her immortality removed first.
PROC
PROC_LOW_BhaalTemple_Abductee_Abandoned()
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
THEN
PROC_GEN_OrinsAbduction_YennaImmortality_Remove(); 

// kill the abductee
PROC
PROC_LOW_BhaalTemple_Abductee_Abandoned()
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9); // we consider it as Orin killing the victim.
//END_REGION

//REGION Post battle, the abductees are in Standby to wait for player dialog, if players don't talk to them then and did a long rest, they go home themselves.
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_GoCampOnLongRest()
THEN
DB_LOW_BhaalTemple_State_WaitForLongRest("Yes");

PROC
PROC_LongRest()
AND
DB_LOW_BhaalTemple_State_WaitForLongRest("Yes")
AND
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("No")
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
THEN
DB_LOW_BhaalTemple_State_WaitForLongRest("No"); // to stop from checking this long rest anymore.
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Yes"); // to disable the dialog override of the companion
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_SpokenToAbducteePostCombat_8dca8ba2-f2ca-44ca-b966-75ff7d839075);
NOT DB_Dialogs(_TargetVictim, (DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
PROC_LOW_BhaalTemple_AbducteeAwaken_GoCamp();

PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_GoCamp()
AND
DB_GEN_OrinsAbduction_ChosenName("Yenna")
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
NOT DB_PermaDefeated(_TargetVictim)
AND
DB_LOW_BhaalTemple_AbducteeRescuer(_Player)
THEN
PROC_GlobalSetFlagAndCache((FLAG)CAMP_Yenna_State_PostAbductionCampChat_d30c5b6a-eada-4c8c-927d-a50de178ec29);
PROC_ORI_SetupCamp(_TargetVictim);

PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_GoCamp()
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName != "Yenna"
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
NOT DB_PermaDefeated(_TargetVictim)
AND
DB_LOW_BhaalTemple_AbducteeRescuer(_Player)
THEN
RegisterAsCompanion(_TargetVictim, _Player);
PROC_ORI_SetupCamp(_TargetVictim);

PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_GoCamp()
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
NOT DB_PermaDefeated(_TargetVictim)
AND
DB_OriginInPartyDialog(_TargetVictim, _Dialog)
THEN
DB_RelationshipDialog_WRD_TriggerInCamp(_Dialog, WYR_Orin_IPRD_CompanionReturned_8d7f983e-864d-2209-64d9-49416d4a0d3b);
PROC_RelationshipDialog(_TargetVictim, _Dialog, (FLAG)WYR_Orin_IPRD_CompanionReturned_8d7f983e-864d-2209-64d9-49416d4a0d3b, _TargetVictim, 0);
PROC_LOW_BhaalTemple_RestoreAbducteeRelationshipDialogs();

//END_REGION

//REGION After Orin has died, abductee will go into a STANDBY state to wait for player input.
// for companions
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby() 
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName != "Yenna"
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
THEN
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("No");
PROC_LOW_BhaalTemple_StoreAbducteeRelationshipDialogs(_TargetVictim);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
DB_Dialogs(_TargetVictim, (DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
PROC_LOW_BhaalTemple_AbducteeAwaken_GoCampOnLongRest();
SteerTo(_TargetVictim, S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, 0);

PROC
PROC_LOW_BhaalTemple_StoreAbducteeRelationshipDialogs((CHARACTER)_TargetVictim)
AND
DB_HandlingRelationshipDialog(_TargetVictim, _QueuedDialog, _Flag, _String, _PartnerDateOnly, _MinApproval)
THEN
DB_LOW_BhaalTemple_AbducteeStoredRelationshipDialogs(_TargetVictim, _QueuedDialog, _Flag, _String, _PartnerDateOnly, _MinApproval);

PROC
PROC_LOW_BhaalTemple_StoreAbducteeRelationshipDialogs((CHARACTER)_TargetVictim)
AND
DB_RelationshipDialog_Queue(_TargetVictim, _QueuedDialog, _Flag, _String, _PartnerDateOnly, _MinApproval)
THEN
DB_LOW_BhaalTemple_AbducteeStoredRelationshipDialogs(_TargetVictim, _QueuedDialog, _Flag, _String, _PartnerDateOnly, _MinApproval);

PROC
PROC_LOW_BhaalTemple_StoreAbducteeRelationshipDialogs((CHARACTER)_TargetVictim)
THEN
PROC_CancelAllRelationshipDialogs(_TargetVictim);

// for Yenna, if she hadn't run away (Because she was awakened AFTER the battle had ended, just wake get up and wait for dialog from players.
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby() 
AND
DB_GEN_OrinsAbduction_ChosenName("Yenna")
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_LOW_BhaalTemple_AbducteeRescuer(_Rescuer)
THEN
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("No");
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
DB_Dialogs(_TargetVictim, (DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
PROC_LOW_BhaalTemple_AbducteeAwaken_GoCampOnLongRest();
SteerTo(_TargetVictim, _Rescuer, 0);

// for Yenna, if she had already run away, make her reappear from her hiding spot and come back to talk to the players.
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby() 
AND
DB_GEN_OrinsAbduction_ChosenName("Yenna")
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_LOW_BhaalTemple_State_YennaWentToHide("Yes")
THEN
DB_LOW_BhaalTemple_State_YennaWentToHide("Done");
PROC_AppearOutOfSightTo(_TargetVictim, S_BhaalTemple_PostBattle_AbducteePos_bee54c03-3701-4937-8698-36a1a1aed229, S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, "LOW_BhaalTemple_PostBattle_YennaReappears");
PROC_LOW_BhaalTemple_AbducteeAwaken_GoCampOnLongRest();

IF
EntityEvent(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, "LOW_BhaalTemple_PostBattle_YennaReappears")
THEN
PROC_CharacterMoveTo(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (TRIGGER)S_BhaalTemple_PostBattle_AbducteePos_bee54c03-3701-4937-8698-36a1a1aed229, "Run", "LOW_BhaalTemple_PostBattle_YennaStandby");

IF
EntityEvent(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, "LOW_BhaalTemple_PostBattle_YennaStandby")
THEN
SteerTo(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, 0);
//END_REGION

//REGION Abductee Awakened moved next to altar
PROC
PROC_LOW_BhaalTemple_AbducteeAwaken_TeleportToPos()
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
NOT DB_PermaDefeated(_TargetVictim)
THEN
TeleportTo((CHARACTER)_TargetVictim, (TRIGGER)S_LOW_BhaalTemple_PostBattle_AbducteePos_bee54c03-3701-4937-8698-36a1a1aed229);
//END_REGION

//REGION Dialog Override of the default companion dialog temporarily.
// needed to play the custom dialog of the companion, without it, it'll play the default recruitment dialog.
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)_TargetVictim, _Player)
AND
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("No")
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_LOW_BhaalTemple_CurrentState("PostCombat")
THEN
DB_SelectedDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef,
	(CHARACTER) _TargetVictim,
				_Player);
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Yes");
//END_REGION

//REGION After dialog with abductee post battle, send them on their way home
// for Yenna, some special setup is required - might need some changes depending on Yenna's goal
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef, _ID)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName == "Yenna"
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_SpokenToAbducteePostCombat_8dca8ba2-f2ca-44ca-b966-75ff7d839075);
NOT DB_Dialogs(_TargetVictim, (DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Yes");
PROC_GlobalSetFlagAndCache((FLAG)CAMP_Yenna_State_PostAbductionCampChat_d30c5b6a-eada-4c8c-927d-a50de178ec29);
PROC_LOW_BhaalTemple_AbducteeAwaken_SendToCamp(_TargetVictim, (CHARACTER)_Player);

// for companions, send them off back to camp.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef, _ID)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName != "Yenna"
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_SpokenToAbducteePostCombat_8dca8ba2-f2ca-44ca-b966-75ff7d839075);
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Yes");
PROC_ORI_SendToCampAfterDialog(_TargetVictim, _ID, "Walk", (CHARACTER)_Player);

// for Yenna, when she reaches back to camp, reset her default dialog. 
IF
EntityEvent(_TargetVictim, "LOW_BhaalTemple_YennaArrivesInCamp")
AND
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Yes")
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName == "Yenna"
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_TargetVictim)
THEN
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)_TargetVictim);
DB_Dialogs((CHARACTER)_TargetVictim, (DIALOGRESOURCE)CAMP_MeetingYenna_InviteYenna_dc450528-d148-fdf9-35c7-de3b8851c860);
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Done");

// for origin characters, add OrinAbduction IPRD and restore previous RDs
IF
EntityEvent(_TargetVictim, "ORI_ToCamp")
AND
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Yes")
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName != "Yenna"
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_TargetVictim)
AND
DB_OriginInPartyDialog(_TargetVictim, _Dialog)
THEN
DB_RelationshipDialog_WRD_TriggerInCamp(_Dialog, (FLAG)WYR_Orin_IPRD_CompanionReturned_8d7f983e-864d-2209-64d9-49416d4a0d3b);
PROC_RelationshipDialog(_TargetVictim, _Dialog, (FLAG)WYR_Orin_IPRD_CompanionReturned_8d7f983e-864d-2209-64d9-49416d4a0d3b, _TargetVictim, 0);
PROC_LOW_BhaalTemple_RestoreAbducteeRelationshipDialogs();
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Done");

PROC
PROC_LOW_BhaalTemple_RestoreAbducteeRelationshipDialogs()
AND
DB_LOW_BhaalTemple_AbducteeStoredRelationshipDialogs(_TargetVictim, _QueuedDialog, _Flag, "WORLD", _PartnerDateOnly, _MinApproval)
THEN
NOT DB_LOW_BhaalTemple_AbducteeStoredRelationshipDialogs(_TargetVictim, _QueuedDialog, _Flag, "WORLD", _PartnerDateOnly, _MinApproval);
PROC_RelationshipDialog(_TargetVictim, _QueuedDialog, _Flag, _TargetVictim, _PartnerDateOnly, _MinApproval);

PROC
PROC_LOW_BhaalTemple_RestoreAbducteeRelationshipDialogs()
AND
DB_LOW_BhaalTemple_AbducteeStoredRelationshipDialogs(_TargetVictim, _QueuedDialog, _Flag, "WORLDORCAMP", _PartnerDateOnly, _MinApproval)
THEN
NOT DB_LOW_BhaalTemple_AbducteeStoredRelationshipDialogs(_TargetVictim, _QueuedDialog, _Flag, "WORLDORCAMP", _PartnerDateOnly, _MinApproval);
DB_RelationshipDialog_WRD_TriggerInCamp(_QueuedDialog, _Flag);
PROC_RelationshipDialog(_TargetVictim, _QueuedDialog, _Flag, _TargetVictim, _PartnerDateOnly, _MinApproval);

PROC
PROC_LOW_BhaalTemple_RestoreAbducteeRelationshipDialogs()
AND
DB_LOW_BhaalTemple_AbducteeStoredRelationshipDialogs(_TargetVictim, _QueuedDialog, _Flag, _FallbackString, _PartnerDateOnly, _MinApproval)
THEN
NOT DB_LOW_BhaalTemple_AbducteeStoredRelationshipDialogs(_TargetVictim, _QueuedDialog, _Flag, _FallbackString, _PartnerDateOnly, _MinApproval);

//END_REGION







//REGION Orin START spotting in the Temple
PROC
PROC_LOW_BhaalTemple_OrinSpotting_Started()
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BhaalTemple_Spotting_OrinInTemple");
DB_LOW_BhaalTemple_OrinSpotting((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);

IF
DB_LOW_BhaalTemple_OrinSpotting(_Character) 
THEN
DB_SpotPlayers(_Character,"LOW_BhaalTemple_Spotting_OrinInTemple",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeWildshapedPlayers(_Character,"LOW_BhaalTemple_Spotting_OrinInTemple"); // wildshape fix
DB_SpotPlayers_TargetIgnoreCantTalk(_Character,"LOW_BhaalTemple_Spotting_OrinInTemple");  // wildshape fix
//END_REGION

//REGION Orin STOP spotting (because she's used in another instance that isn't in the Bhaal Temple and doesn't need this spotting.
PROC
PROC_LOW_BhaalTemple_OrinSpotting_Stopped()
THEN
PROC_SpotPlayers_StopSpotting((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BhaalTemple_Spotting_OrinInTemple");
NOT DB_LOW_BhaalTemple_OrinSpotting((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // remove spotting.
//END_REGION

//REGION Orin SPOTTED players while in temple gameplay.
// to check if players are sneaking or not.
IF
Saw((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)_Player, 1)
AND
DB_LOW_BhaalTemple_OrinSpotting((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_Players(_Player)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_SpottedSneaking_e5a6fb52-171f-4c43-9eb7-a29199adbf2d);

PROC
PROC_SpotPlayers_Spotted(_,"LOW_BhaalTemple_Spotting_OrinInTemple",_Player)
THEN
PROC_LOW_BhaalTemple_OrinSpotting_Stopped();
PROC_LOW_BhaalTemple_Orin_PreDialogSetup();
PROC_LOW_BhaalTemple_Orin_StartDialog(_Player); // start the Orin dialog.
//END_REGION

//REGION Setup before starting dialog with Orin
PROC
PROC_LOW_BhaalTemple_Orin_PreDialogSetup()
THEN
PROC_LOW_BhaalTemple_OrinDarkUrgeDummy_Setup();
PROC_LOW_BhaalTemple_AdmireKill_Disable(); // disables the trigger area for playing ADs for the admiring the kills NPC
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718); // Victim is knocked out, need this or else dialog will fail to start.
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b); // Victim is knocked out, need this or else dialog will fail to start.
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_018ab395-a061-9b69-d053-df796c294c5e);
PROC_GEN_OrinsAbduction_YennaImmortality_Remove(); // remove Yenna's immortality in case she gets killed in dialog.
PROC_LOW_BhaalTemple_CheckDarkUrgeInSlayerForm();
PROC_LOW_BhaalTemple_NonDuelPos_Setup("Minions"); // we move her 2 minions quickly out of the way so it doesn't block cinematics.
//END_REGION

//REGION Check if Dark Urge is already in slayer form, if we check later, the DropMutingStatuses would have cleared it already.
PROC
PROC_LOW_BhaalTemple_CheckDarkUrgeInSlayerForm()
AND
DB_ORI_DarkUrge(_DarkUrge)
AND
GetFlag((FLAG)ORI_DarkUrge_State_SlayerForm_88b450d5-3815-4f5d-0c6f-0de221513d64, _DarkUrge, 1)
THEN
DB_LOW_BhaalTemple_DarkUrgeIsSlayerForm(1);

//END_REGION

//REGION Orin START DIALOG to start once players are spotted by her, or after unlocking the abductee.
PROC
PROC_LOW_BhaalTemple_Orin_StartDialog((CHARACTER)_Player) // OM pipeline will decide whether to start Orin dialog or OrinDarkUrge dialog.
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
QRY_StartDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718,
	(CHARACTER) S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,
				_Player)
THEN
DB_NOOP(1);
//END_REGION

//REGION Extra Speakers Setup For DU and non-DU for Orin/OrinDarkUrge dialogs
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718, (INTEGER)_Inst)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
THEN
PROC_DialogAddSpeakingActor(_Inst, _TargetChar, 0, 1);
PROC_DialogAddSpeakingActor(_Inst, S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 0, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718, (TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104, 1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b,(INTEGER)_Inst)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
THEN
PROC_DialogAddSpeakingActor(_Inst, _TargetChar, 0, 1); // the abductee altar victim
PROC_DialogAddSpeakingActor(_Inst, S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 0, 1); //the butler
PROC_DialogAddSpeakingActor(_Inst, S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c, 0, 1);
//PROC_DialogAddSpeakingActor(_Inst, S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, 0, 1); // the dummy that's copying the DU's visual for cinematics to use.
PROC_DialogAddSpeakingActorAt(_Inst, S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, 6); // the dummy that's copying the DU's visual for cinematics to use.

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b, (TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104, 1);
//END_REGION

//REGION At end of dialog with Orin, she/denizens turns hostile.
IF // if dialog ending was with non-Dark Urge
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718, _)
AND
NOT DB_LOW_BhaalTemple_CombatStartedPrematurely(_)
THEN
PROC_LOW_BhaalTemple_OrinNonDuel_Start();
PROC_LOW_BhaalTemple_Abductee_WakeUp(); // wakes up the abductee and removes the KNOCKOUT status
PROC_GEN_OrinsAbduction_YennaImmortality_Reset(); // reset her immortality - assuming she's still alive
PROC_LOW_BhaalTemple_Orin_SeeInvisibility_Apply();

IF // if dialog ending was with Dark Urge
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b, _)
AND
NOT DB_LOW_BhaalTemple_CombatStartedPrematurely(_)
THEN
PROC_LOW_BhaalTemple_OrinDuel_Start();
PROC_LOW_BhaalTemple_Abductee_WakeUp(); // wakes up the abductee and removes the KNOCKOUT status
PROC_GEN_OrinsAbduction_YennaImmortality_Reset(); // reset her immortality - assuming she's still alive
PROC_LOW_BhaalTemple_Orin_SeeInvisibility_Apply();
//END_REGION


//REGION Combat & Non-Combat Denizens go observation spot
PROC
PROC_LOW_BhaalTemple_ObservationSpot_NonCombat()
AND
DB_LOW_BhaalTemple_Denizens_ObservationPos(_Denizen, _Pos)
THEN
PROC_CharacterMoveTo((CHARACTER)_Denizen, (GUIDSTRING)_Pos, "Run", "LOW_BhaalTemple_Observe_NonCombat");

PROC
PROC_LOW_BhaalTemple_ObservationSpot_Combat()
AND
DB_LOW_BhaalTemple_Denizens_Combat_ObservationPos(_Denizen, _Pos)
THEN
PROC_CharacterMoveTo((CHARACTER)_Denizen, (GUIDSTRING)_Pos, "Run", "LOW_BhaalTemple_Observe_NonCombat");

IF
EntityEvent((CHARACTER)_Char, "LOW_BhaalTemple_Observe_NonCombat")
THEN
SteerTo((CHARACTER)_Char, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0);
//END_REGION


//REGION DUEL Arena Indicator Handling
PROC
PROC_LOW_BhaalTemple_ArenaIndicator_Enable()
THEN
SetCanInteract((ITEM)S_LOW_BhaalTemple_ArenaIndicator_64d2b4cc-d0af-4267-9e78-48d922842f71, 0);
PROC_SetOnStage((ITEM)S_LOW_BhaalTemple_ArenaIndicator_64d2b4cc-d0af-4267-9e78-48d922842f71, 1);

PROC
PROC_LOW_BhaalTemple_ArenaIndicator_Disable()
THEN
PROC_SetOnStage((ITEM)S_LOW_BhaalTemple_ArenaIndicator_64d2b4cc-d0af-4267-9e78-48d922842f71, 0);
//END_REGION

//REGION DUEL Setup Positions
PROC
PROC_LOW_BhaalTemple_Duel_Orin_Setup()
THEN
ApplyStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BHAALTEMPLE_DUEL_NOTIFICATION", -1.0, 1, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
ApplyStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "GROUNDED", -1.0, 1, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
ApplyStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "PERMANENTLY_HOSTILE_MANUAL", -1.0, 1, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
TeleportTo(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, S_LOW_BhaalTemple_Duel_Orin_Pos_cc5d5884-403a-4cae-8b13-365d55f37a2e);
NOT DB_SceneManager((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BhaalTemple_CombatDenizens_Scene");

PROC
PROC_LOW_BhaalTemple_Duel_Orin_RemoveStatus()
AND
HasActiveStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BHAALTEMPLE_DUEL_NOTIFICATION", 1)
THEN
RemoveStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BHAALTEMPLE_DUEL_NOTIFICATION", (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
RemoveStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "GROUNDED", (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
RemoveStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "PERMANENTLY_HOSTILE_MANUAL", (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
SetFaction((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e); // change Orin's faction to the other cultists so her attacks won't hit them.

PROC
PROC_LOW_BhaalTemple_Duel_DarkUrge_Setup()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
DB_DialogDeath(_DarkUrge);
DetachFromPartyGroup((CHARACTER)_DarkUrge);
PROC_LOW_BhaalTemple_Duel_DarkUrgeFaction_Apply();
PROC_LOW_BhaalTemple_Duel_DarkUrgeBlockFearMovement_Apply();
TeleportTo(_DarkUrge, S_LOW_BhaalTemple_Duel_DarkUrge_Pos_e56bc6fe-690b-4098-825e-a260cbf4bfef, "LOW_BHAALTEMPLE_DUEL_INPOSITION", 0, 1, 1, 0, 1);

IF
EntityEvent(_, "LOW_BHAALTEMPLE_DUEL_INPOSITION")
THEN
PROC_LOW_BhaalTemple_PlayerTransformIntoSlayer();

PROC
PROC_LOW_BhaalTemple_Duel_DarkUrgeFaction_Apply()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
ApplyStatus((CHARACTER)_DarkUrge, "LOW_BHAALTEMPLE_DUEL_DARKURGE_FACTION", -1.0, 1, _DarkUrge);

PROC
PROC_LOW_BhaalTemple_Duel_DarkUrgeFaction_RemoveStatus()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
HasActiveStatus((CHARACTER)_DarkUrge, "LOW_BHAALTEMPLE_DUEL_DARKURGE_FACTION", 1)
THEN
RemoveStatus((CHARACTER)_DarkUrge, "LOW_BHAALTEMPLE_DUEL_DARKURGE_FACTION", (CHARACTER)_DarkUrge);

// move companions outside of Arena
// algorithm is to get next available trigger Pos that isn't occupied yet.
PROC
PROC_LOW_BhaalTemple_Duel_Allies_Setup()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_Players(_Player)
AND
_Player != _DarkUrge
AND
QRY_LOW_BhaalTemple_Duel_GetNextPosForAlly()
AND
DB_QRYRTN_LOW_BhaalTemple_Duel_Allies_GetNextPosForAlly(_Pos)
THEN
PROC_LOW_BhaalTemple_Duel_Ally_Setup(_Player, _Pos);

// if the abductee was woken up by someone aside from the Dark Urge, move the abductee out of the duel arena as well or else they'll break the duel.
PROC
PROC_LOW_BhaalTemple_Duel_Allies_Setup()
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_TargetVictim)
AND
_TargetVictim != S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f // make sure its not Yenna, she would have run away by now.
AND
NOT DB_PermaDefeated(_TargetVictim) // make sure they're not already dead.
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_VictimUnlocked_6fd6bf7c-dee2-4987-8469-ba8dacd18231) // if they are unlocked.
AND
DB_LOW_BhaalTemple_AbducteeRescuer(_CharOwner) // the character that unlocked the altar.
AND
DB_ORI_DarkUrge(_DarkUrge) 
AND
_CharOwner != _DarkUrge // if its the Dark Urge himself that rescued, then don't need to teleport them next to the dark urge.
THEN
ApplyStatus((CHARACTER)_TargetVictim, "LOW_BHAALTEMPLE_DUEL_NOTIFICATION", -1.0, 1, _TargetVictim);
TeleportTo(_TargetVictim, _CharOwner, "", 0, 0, 0, 0, 1);

PROC
PROC_LOW_BhaalTemple_Duel_Ally_Setup((CHARACTER)_Player, (TRIGGER)_Pos)
THEN
ApplyStatus((CHARACTER)_Player, "LOW_BHAALTEMPLE_DUEL_NOTIFICATION", -1.0, 1, _Player);
TeleportTo(_Player, _Pos, "LOW_BhaalTemple_ObservePosArrived", 0, 1, 1, 0, 1);
NOT DB_LOW_BhaalTemple_Allies_DuelPos_Found(1);
PROC_LOW_BhaalTemple_Duel_Ally_BlockOrinsHitReaction_Apply(_Player);

PROC
PROC_LOW_BhaalTemple_Duel_Allies_RemoveStatus()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_Players(_Player)
AND
_Player != _DarkUrge
AND
HasActiveStatus((CHARACTER)_Player, "LOW_BHAALTEMPLE_DUEL_NOTIFICATION", 1)
THEN
RemoveStatus((CHARACTER)_Player, "LOW_BHAALTEMPLE_DUEL_NOTIFICATION", (CHARACTER)_Player);
PROC_LOW_BhaalTemple_Duel_Ally_BlockOrinsHitReaction_Restore(_Player);

IF
EntityEvent((CHARACTER)_Char, "LOW_BhaalTemple_ObservePosArrived")
THEN
SteerTo((CHARACTER)_Char, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0);

// clear the DB
QRY
QRY_LOW_BhaalTemple_Duel_GetNextPosForAlly()
AND
DB_QRYRTN_LOW_BhaalTemple_Duel_Allies_GetNextPosForAlly(_Pos)
THEN
NOT DB_QRYRTN_LOW_BhaalTemple_Duel_Allies_GetNextPosForAlly(_Pos);

// used to find next available spot to put player.
QRY
QRY_LOW_BhaalTemple_Duel_GetNextPosForAlly()
AND
DB_LOW_BhaalTemple_Allies_DuelPos(_Pos, 0)
AND
NOT DB_LOW_BhaalTemple_Allies_DuelPos_Found(_)
THEN
DB_LOW_BhaalTemple_Allies_DuelPos_Found(1); 					// stopping the iteration
NOT DB_LOW_BhaalTemple_Allies_DuelPos(_Pos, 0); 				// removing this trigger in the DB.
DB_LOW_BhaalTemple_Allies_DuelPos(_Pos, 1);						// setting this trigger as 'used'.
DB_QRYRTN_LOW_BhaalTemple_Duel_Allies_GetNextPosForAlly(_Pos); 	// returning the DB.
//END_REGION

//REGION DUEL Fallback to check if duel was broken during setup.
// During setup of the duel, its possible the duel would fail before it was fully setup.
// This could happen when the player has a large number of followers and we have no place to put all their followers outside of the arena.
// Forcing code to have to place it at the only available spot which is within the arena and breaking the duel as the remaining companions are still being setup.
IF 
StatusApplied(_Player,"LOW_BHAALTEMPLE_DUEL_NOTIFICATION",_,_) // status was just applied, but double check if the duel is even still ongoing. if not, remove the status.
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e)
THEN
PROC_LOW_BhaalTemple_Duel_StartFailFallback(_Player);

PROC
PROC_LOW_BhaalTemple_Duel_StartFailFallback((CHARACTER)_Player)
THEN
RemoveStatus((CHARACTER)_Player, "LOW_BHAALTEMPLE_DUEL_NOTIFICATION", (CHARACTER)_Player);
PROC_LOW_BhaalTemple_Duel_Ally_BlockOrinsHitReaction_Restore(_Player);
PROC_LOW_BhaalTemple_Duel_DarkUrgeFaction_RemoveStatus(); // try to remove the status on Dark Urge.
PROC_LOW_BhaalTemple_Duel_DarkUrgeBlockFearMovement_Remove();
PROC_LOW_BhaalTemple_Duel_Orin_RemoveStatus(); // Orin should also have her duel statuses removed.
//END_REGION

//REGION DUEL Setup Block Fear Movement and Disable JoinCombat
// For the Dark Urge
PROC
PROC_LOW_BhaalTemple_Duel_DarkUrgeBlockFearMovement_Apply()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
SetFlag(GLO_StatusOverrides_NoFleeMove_ec2e86bc-fcb9-4e1c-871b-f7a696a717e1, _DarkUrge);

PROC
PROC_LOW_BhaalTemple_Duel_DarkUrgeBlockFearMovement_Remove()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
ClearFlag(GLO_StatusOverrides_NoFleeMove_ec2e86bc-fcb9-4e1c-871b-f7a696a717e1, _DarkUrge);

// Orin can accidentally hit non-DU players during duel, causing them to enter combat. So we prevent this.
// For the non-Dark Urge allies
PROC
PROC_LOW_BhaalTemple_Duel_Ally_BlockOrinsHitReaction_Apply((CHARACTER)_Player)
AND
NOT DB_LOW_BhaalTemple_BlockOrinsHitReaction_CanJoinCombat(_Player, _) // make sure there isn't already another entry in there.
AND
CanJoinCombat(_Player, _OriginalState)
THEN
DB_LOW_BhaalTemple_BlockOrinsHitReaction_CanJoinCombat(_Player, _OriginalState); 
SetCanJoinCombat(_Player, 0); // allies don't join combat, this is to avoid situation where Orin does something that accidentally hits the ally and causes them to join combat by code.
SetFlag(GLO_StatusOverrides_NoFleeMove_ec2e86bc-fcb9-4e1c-871b-f7a696a717e1, _Player); // Orin could accidentally hit the companions with a Fear spell, causing them to run randomly and into the arena, breaking the duel. This blocks the movement from fear.

PROC
PROC_LOW_BhaalTemple_Duel_Ally_BlockOrinsHitReaction_Restore((CHARACTER)_Player)
AND
DB_LOW_BhaalTemple_BlockOrinsHitReaction_CanJoinCombat(_Player, _OriginalState)
THEN
NOT DB_LOW_BhaalTemple_BlockOrinsHitReaction_CanJoinCombat(_Player, _OriginalState);
SetCanJoinCombat(_Player, _OriginalState); // whatever causes the Duel to end, re-enable ally's ability to join combat.
ClearFlag(GLO_StatusOverrides_NoFleeMove_ec2e86bc-fcb9-4e1c-871b-f7a696a717e1, _Player);

// If allies move out of the Bhaal Temple's area during the duel, restore their CanJoinCombat state and BlockFearMovement state.
IF
LeftTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // dark urge is currently in a duel. Flag is only set if a duel is ongoing. Gets unset when duel is over/broken.
AND
DB_Players(_Player)
AND
NOT DB_ORI_DarkUrge(_Player)
THEN
PROC_LOW_BhaalTemple_Duel_Ally_BlockOrinsHitReaction_Restore(_Player);

// If allies move back into Bhaal Temple's area during the duel, restore their CanJoinCombat state and BlockFearMovement state.
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // dark urge is currently in a duel. Flag is only set if a duel is ongoing. Gets unset when duel is over/broken.
AND
DB_Players(_Player)
AND
NOT DB_ORI_DarkUrge(_Player)
THEN
PROC_LOW_BhaalTemple_Duel_Ally_BlockOrinsHitReaction_Apply(_Player);
//END_REGION

//REGION DUEL Arena Handling
PROC
PROC_LOW_BhaalTemple_Duel_Start()
THEN
PROC_LOW_BhaalTemple_Duel_Orin_Setup();
PROC_LOW_BhaalTemple_Duel_DarkUrge_Setup();
PROC_LOW_BhaalTemple_Duel_Allies_Setup();
PROC_LOW_BhaalTemple_Duel_Arena_Setup();
PROC_LOW_BhaalTemple_Duel_NonCombat_Setup();
PROC_LOW_BhaalTemple_ObservationSpot_NonCombat();
PROC_LOW_BhaalTemple_ObservationSpot_Combat();
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b);

PROC
PROC_LOW_BhaalTemple_Duel_End() 
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b)
THEN
PROC_LOW_BhaalTemple_Duel_Orin_RemoveStatus();
PROC_LOW_BhaalTemple_Duel_DarkUrgeFaction_RemoveStatus(); // remove the status after the duel.
PROC_LOW_BhaalTemple_Duel_DarkUrgeBlockFearMovement_Remove();
PROC_LOW_BhaalTemple_Duel_Allies_RemoveStatus(); // remove status on allies.
PROC_LOW_BhaalTemple_Duel_Arena_Remove();
PROC_LOW_BhaalTemple_Duel_NonCombat_Remove();
PROC_LOW_BhaalTemple_PostBattleDarkUrge_AttachToParty(); // re-attach Dark Urge to rest of the party since start of the duel he was detatched. 
PROC_LOW_BhaalTemple_ArenaIndicator_Disable();
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b);

PROC
PROC_LOW_BhaalTemple_Duel_Arena_Setup()
THEN
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_BhaalTemple_Duel_ArenaArea_16865414-0aea-45c8-9584-c1af399f4f9c);
PROC_LOW_BhaalTemple_ArenaIndicator_Enable();

PROC
PROC_LOW_BhaalTemple_Duel_Arena_Remove()
THEN
PROC_TriggerUnregisterForParty((TRIGGER)S_LOW_BhaalTemple_Duel_ArenaArea_16865414-0aea-45c8-9584-c1af399f4f9c);
PROC_LOW_BhaalTemple_ArenaIndicator_Disable();
//END_REGION

//REGION DUEL SceneManager to track the non-hostile temple denizens if players attack them during the duel. 
// During duel non-DU players have SetCanJoin disabled on them to avoid Orin accidentally hitting them. 
// But if players intentionally attack the non-hostile denizens, this should be disabled.
PROC
PROC_LOW_BhaalTemple_Duel_NonCombat_Setup()
AND
DB_LOW_BhaalTemple_Denizens_ObservationPos(_Cultist, _)
THEN
DB_SceneManager((CHARACTER)_Cultist, "LOW_BhaalTemple_CombatDenizens_Scene");

PROC
PROC_LOW_BhaalTemple_Duel_NonCombat_Remove()
AND
DB_LOW_BhaalTemple_Denizens_ObservationPos(_Cultist, _)
THEN
NOT DB_SceneManager((CHARACTER)_Cultist, "LOW_BhaalTemple_CombatDenizens_Scene");
//END_REGION

//REGION DUEL Breaking Conditions
// If its not the Dark Urge or his own followers
QRY
QRY_LOW_BhaalTemple_IsNotDarkUrgeOrFollower((CHARACTER)_Player)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
_Player != _DarkUrge
AND
NOT CharacterGetOwner((CHARACTER)_Player, _DarkUrge)
THEN
DB_NOOP(1);

// if other players aside from DU (or his followers) entered the arena during duel.
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_BhaalTemple_Duel_ArenaArea_16865414-0aea-45c8-9584-c1af399f4f9c)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b)
AND
QRY_LOW_BhaalTemple_IsNotDarkUrgeOrFollower(_Player) // is not the dark urge or a follower of his
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e);

// if DU exited the Arena area
IF
LeftTrigger(_DarkUrge, (TRIGGER)S_LOW_BhaalTemple_Duel_ArenaArea_16865414-0aea-45c8-9584-c1af399f4f9c)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b)
AND
NOT DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e);

// if players aside from the Dark Urge(or his followers) attacked other denizens during duel.
PROC
PROC_SceneInterrupted(_, _AttackOwner, "LOW_BhaalTemple_CombatDenizens_Scene", _Reason)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e)
AND
QRY_LOW_BhaalTemple_IsNotDarkUrgeOrFollower((CHARACTER)_AttackOwner)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b)
AND
DB_PartyMembers(_AttackOwner)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e);

// if Dark Urge or his followers attack others outside of the duel with direct-fire harmful spells
IF
UsingSpellOnTarget(_AttackOwner, _Target, _Spell,_,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // make sure duel is running
AND
NOT QRY_LOW_BhaalTemple_IsNotDarkUrgeOrFollower((CHARACTER)_AttackOwner) // if it is DU or his followers
AND
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)_Target, _) // if it attacked any of the other temple denizens
AND
SpellHasSpellFlag(_Spell,"IsHarmful", 1) // check if spell is harmful.
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e);

// if Dark Urge or his followers attack others outside of the duel with non-direct-fire harmful spells that caused damage
IF
AttackedBy(_Target, _AttackOwner, _, _DamageType, _DamageAmount, _DamageCause, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e)
AND
DB_LOW_BhaalTemple_Denizens_Dialogs((CHARACTER)_Target, _) // if it attacked any of the other temple denizens
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // make sure duel is running
AND
NOT QRY_LOW_BhaalTemple_IsNotDarkUrgeOrFollower((CHARACTER)_AttackOwner) // if it is DU or his followers
AND
_DamageAmount != 0
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e);


// if Non-Dark Urge players casted a spell within Arena. Dark Urge and his followers casting inside the arena is ignored.
IF
UsingSpellInTrigger(_Char, _Spell, _, _, (TRIGGER)S_LOW_BhaalTemple_Duel_ArenaArea_16865414-0aea-45c8-9584-c1af399f4f9c, _ID)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // make sure duel is ongoing.
AND
DB_PartyMembers((CHARACTER)_Char) // we're checking for players only, don't care about other non-PC.
AND
QRY_LOW_BhaalTemple_IsNotDarkUrgeOrFollower((CHARACTER)_Char) // if it is NOT DU or his followers
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e);

//END_REGION

//REGION DUEL was broken by player.
IF
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e)
THEN
PROC_LOW_BhaalTemple_Duel_End();
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_02_AD_DarkUrgeDuel_64b28fd5-33e9-87ab-db2a-7d8dd40be23f);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_02_AD_DarkUrgeDuel_64b28fd5-33e9-87ab-db2a-7d8dd40be23f, (CHARACTER)S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2);
PROC_LOW_BhaalTemple_Duel_TurnsHostileCultists();
//DB_LOW_BhaalTemple_Denizen_Reinforcements_Enabled(1);
//END_REGION

//REGION DUEL Dark Urge used feign death on themselves, counts as being defeated by Orin
IF
StatusApplied((CHARACTER)_DarkUrge, "FEIGN_DEATH", _DarkUrge, _ID)
AND
DB_ORI_DarkUrge(_DarkUrge)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // make sure duel is ongoing.
THEN
PROC_LOW_BhaalTemple_DarkUrgeDefeated_Setup();
//END_REGION

//REGION Dark Urge died during battle with Orin
IF
Dying((CHARACTER)_DarkUrge)
//DB_Downed((CHARACTER)_DarkUrge)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // make sure duel is ongoing.
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
PROC_LOW_BhaalTemple_DarkUrgeDefeated_Setup();

PROC
PROC_LOW_BhaalTemple_DarkUrgeDefeated_Setup()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_Is_InCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CombatID)
THEN
SetFlag(TG_DarkUrge_FailedBhaal_b5a1847d-9d89-4df2-978d-dddcb4780e6b, _DarkUrge, 0);
PauseCombat(_CombatID);
DB_LOW_BhaalTemple_CombatID(_CombatID);
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_MissedTempleFinale_640cb288-0b40-434a-b13c-0c871d931bcc); // need to enable the camp night so it'll trigger.
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_DUDefeatedByOrin_a09d2272-853e-4d46-a7de-27c8f2f9895c);
PROC_LOW_BhaalTemple_Duel_End();
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_LINE_DarkUrgeDefeated_5b24f91c-cb36-043c-3c8b-45399248a9a5);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BhaalTemple_LINE_DarkUrgeDefeated_5b24f91c-cb36-043c-3c8b-45399248a9a5, (TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104, 1);
PROC_LOW_BhaalTemple_DarkUrgeDefeated_StartDialog();

PROC
PROC_LOW_BhaalTemple_DarkUrgeDefeated_StartDialog()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_LOW_BhaalTemple_CombatID(_CombatID)
AND
NOT QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_LINE_DarkUrgeDefeated_5b24f91c-cb36-043c-3c8b-45399248a9a5,
	(CHARACTER) S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10,
				S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,
				_DarkUrge,
				NULL_00000000-0000-0000-0000-000000000000)
THEN
ResumeCombat(_CombatID);


// exception for Dark Urge being able to be DOWNED and still be in dialog
QRY
QRY_DialogStarted_CheckPlayerForStopConditions_IgnoreDowned((INTEGER)_Inst,(CHARACTER)_DarkUrge)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_DialogName(LOW_BhaalTemple_LINE_DarkUrgeDefeated_5b24f91c-cb36-043c-3c8b-45399248a9a5, _Inst)
THEN
DB_NOOP(1);


// end of dialog, Orin wants the rest of the party killed.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_LINE_DarkUrgeDefeated_5b24f91c-cb36-043c-3c8b-45399248a9a5, _)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_LOW_BhaalTemple_CombatID(_CombatID)
THEN
NOT DB_DialogDeath(_DarkUrge);
ResumeCombat(_CombatID);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_02_AD_DarkUrgeDuel_64b28fd5-33e9-87ab-db2a-7d8dd40be23f, (CHARACTER)S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2);
PROC_LOW_BhaalTemple_Duel_TurnsHostileCultists();
//DB_LOW_BhaalTemple_Denizen_Reinforcements_Enabled(1);
//END_REGION

//REGION Bhaal is disappointed with the Dark Urge, and makes him 1 HP and insane.
IF
FlagSet((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0, _, _)
AND
NOT DB_CurrentLevel("END_Main")
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
Resurrect(_DarkUrge);
RemoveHarmfulStatuses(_DarkUrge);
ApplyStatus(_DarkUrge, "DAZED", 12.0, 0, (CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c);
ApplyStatus(_DarkUrge, "STUNNED", 12.0, 0, (CHARACTER)S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c);
SetHitpoints(_DarkUrge, 1);
//END_REGION

//REGION Prepare Orin for Combat
PROC
PROC_LOW_BhaalTemple_OrinNonDuel_Start() // For all non-DU, as well as DU that break the DUEL conditions.
THEN
PROC_LOW_BhaalTemple_NonDuelPos_Setup("Orin");
PROC_LOW_BhaalTemple_TurnsHostileOrin();
PROC_LOW_BhaalTemple_TurnsHostileCultists();
PROC_LOW_BhaalTemple_ObservationSpot_NonCombat();
//DB_LOW_BhaalTemple_Denizen_Reinforcements_Enabled(1);
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Stop();

PROC
PROC_LOW_BhaalTemple_OrinDuel_Start()
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_02_AD_DarkUrgeDuel_64b28fd5-33e9-87ab-db2a-7d8dd40be23f, (CHARACTER)S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2);
PROC_LOW_BhaalTemple_Duel_Start();
PROC_LOW_BhaalTemple_TurnsHostileOrinDuel();
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Stop();

// set flag if Orin is going to fight as Humanoid
PROC
PROC_LOW_BhaalTemple_OrinDuel_Start()
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_OrinFightAsHuman_61556db9-9a53-4098-b333-70f8565d6cc4);


//END_REGION

//REGION Non-Duel Position Setup
// Position Orin to her combat position
PROC
PROC_LOW_BhaalTemple_NonDuelPos_Setup("Orin")
THEN
TeleportTo(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (TRIGGER)S_LOW_BhaalTemple_NonDuel_Orin_Pos_dd0e2e0f-a5ce-4dc4-a69d-15e8fa5df336); 

// Position her nearby 2 minions to their flanking position of Orin, walk there to look more natural.
// This only happens in flows that goes through the dialogs. Pre-mature attacks/combat will not have them move into position.
PROC
PROC_LOW_BhaalTemple_NonDuelPos_Setup("Minions")
THEN
PROC_CharacterMoveTo((CHARACTER)S_LOW_BhaalTemple_NightBlade_01_7a82cf11-57a2-4796-8b3a-d3409c0cbe9e, (GUIDSTRING)S_LOW_BhaalTemple_NonDuel_Pos_01_7153d087-1505-4ee7-943f-3914375fcb17, "Walk", "LOW_BhaalTemple_Minions_CombatPosition");
PROC_CharacterMoveTo((CHARACTER)S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2, (GUIDSTRING)S_LOW_BhaalTemple_NonDuel_Pos_02_7d5bcef0-dfa2-4a03-89d8-b04e068d3bdd, "Walk", "LOW_BhaalTemple_Minions_CombatPosition");

// upon arrival of the position, make them turn to face the altar.
IF
EntityEvent(_Char, "LOW_BhaalTemple_Minions_CombatPosition")
THEN
SteerTo((CHARACTER)_Char, S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, 0);
//END_REGION

//REGION Orin's Hostilility and Relations handling
PROC
PROC_LOW_BhaalTemple_TurnsHostileOrin()
AND
GetClosestAlivePlayer(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _Player, _)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235);
//PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BhaalTemple_Cultists_Orin_cee859bf-01fe-4a21-ad1d-0c0bbc910acf, 0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e, 0);
SetHostileAndEnterCombat(
	(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 
	(FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e, 
	(CHARACTER)_Player, 
	(CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer();
DB_LOW_BhaalTemple_CurrentState("DuringCombat");

PROC
PROC_LOW_BhaalTemple_TurnsHostileCultists()
AND
GetClosestAlivePlayer(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _Player, _)
THEN
PROC_LOW_BhaalTemple_Denizens_Combat_AddToCounter();
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e, 0);
PROC_SetRelationMutual((FACTION)ACT3_LOW_BhaalTemple_Cultists_Orin_cee859bf-01fe-4a21-ad1d-0c0bbc910acf, (FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e, 100); // make Orin and Cultists allies so they join the same fight.
SetHostileAndEnterCombat(
	(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 
	(FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e, 
	(CHARACTER)_Player, 
	(CHARACTER)S_LOW_BhaalTemple_Reaper_01_72d472ba-5e32-4922-ab0b-b5a554c6dcab);
DB_LOW_BhaalTemple_CurrentState("DuringCombat");
PROC_SceneOver("LOW_BhaalTemple_CombatDenizens_Scene");

PROC
PROC_LOW_BhaalTemple_Duel_TurnsHostileCultists()
THEN
PROC_LOW_BhaalTemple_Duel_Orin_RemoveStatus();
PROC_LOW_BhaalTemple_Duel_DarkUrgeFaction_RemoveStatus(); // remove temp status - if needed - since its no longer a duel..
PROC_LOW_BhaalTemple_Duel_Allies_RemoveStatus();
PROC_LOW_BhaalTemple_Denizens_Combat_AddToCounter();
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e, 0);
PROC_SetRelationMutual((FACTION)ACT3_LOW_BhaalTemple_Cultists_Orin_cee859bf-01fe-4a21-ad1d-0c0bbc910acf, (FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e, 100); // make Orin and Cultists allies so they join the same fight.
DB_LOW_BhaalTemple_CurrentState("DuringCombat");
PROC_SceneOver("LOW_BhaalTemple_CombatDenizens_Scene");



PROC
PROC_LOW_BhaalTemple_TurnsHostileOrinDuel()
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235);
SetFaction((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (FACTION)ACT3_LOW_BhaalTemple_Cultists_Orin_cee859bf-01fe-4a21-ad1d-0c0bbc910acf); // set a faction on her own since she wants wants to duel DU players
PROC_SetRelationMutual((FACTION)ACT3_LOW_BhaalTemple_Cultists_Orin_cee859bf-01fe-4a21-ad1d-0c0bbc910acf, (FACTION)ACT3_LOW_BhaalTemple_Duel_DarkUrge_56443c8e-d76b-49ec-bdb2-e436e2b48c36, 0);
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer();
DB_LOW_BhaalTemple_CurrentState("DuringCombat");

/* 15-03-23 Removing the reinforcement system after review with combat team.
PROC
PROC_GLO_DefeatCounter_Notify("LOW_BhaalTemple_CombatWin_Counter", _, _, _ReinforcementID)
AND
DB_LOW_BhaalTemple_Denizen_Reinforcements_Enabled(1)
AND
DB_LOW_BhaalTemple_Denizens_Reinforcements(_ReinforcementID, _Char)
THEN
SetWeaponUnsheathed(_Char, 1, 0);
PROC_CharacterMoveTo((CHARACTER)_Char, (GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "Run", "LOW_BhaalTemple_ReinforceOrin");
*/
//END_REGION

//REGION Start combat with Orin prematurely by attacking her directly
// since it was abnormal start - even if it was DU, it would be considered a break of Duel rules, so start combat as non-DU path.
PROC
PROC_SceneInterrupted(_, _AttackOwner, "LOW_BhaalTemple_CombatDenizens_Scene", _Reason)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2) // if Orin is in the temple and therefore where the real battle takes place, then don't react
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // make sure combat hasn't already begun.
AND
QRY_GEN_OrinsAbduction_PlayerTeam(_AttackOwner)
AND
DB_ActiveLevel("CTY_Main_A")
THEN
PROC_LOW_BhaalTemple_OrinNonDuel_StartPrematurely();
//END_REGION

//REGION Start combat with Orin with DialogAttack button
QRY
QRY_DialogAttackRequested_CustomResponse((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)_Player)
AND
DB_DialogPlayers(_DialogID, _Player, _)
AND
DB_DialogName((DIALOGRESOURCE)LOW_BhaalTemple_OM_OrinDarkUrge_AOM_0abe133f-0f13-4d72-0f18-e6c390d1148b, _DialogID)
THEN
PROC_LOW_BhaalTemple_DialogCombat_Start(_Player);

QRY
QRY_DialogAttackRequested_CustomResponse((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)_Player)
AND
DB_DialogPlayers(_DialogID, _Player, _)
AND
DB_DialogName((DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718, _DialogID)
THEN
PROC_LOW_BhaalTemple_DialogCombat_Start(_Player);


PROC
PROC_LOW_BhaalTemple_DialogCombat_Start((CHARACTER)_Player)
THEN
PROC_TryStopDialogFor(_Player); // stop the player's dialog
PROC_LOW_BhaalTemple_OrinNonDuel_StartPrematurely();
PROC_LOW_BhaalTemple_Abductee_WakeUp(); // wakes up the abductee and removes the KNOCKOUT status
PROC_GEN_OrinsAbduction_YennaImmortality_Reset(); // reset her immortality - assuming she's still alive
//END_REGION




//REGION If combat started prematurely.
PROC
PROC_LOW_BhaalTemple_OrinNonDuel_StartPrematurely()
AND
GetClosestAlivePlayer(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _Player, _)
THEN
PROC_GEN_OrinsAbduction_OrinTransformsBack();
DB_LOW_BhaalTemple_CombatStartedPrematurely(1);
PROC_LOW_BhaalTemple_DarkUrge_IsPresent_PreCombat();
//PROC_LOW_BhaalTemple_NonDuelPos_Setup();
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235);
SetHostileAndEnterCombat(
	(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 
	//(FACTION)ACT3_LOW_BhaalTemple_Cultists_Orin_cee859bf, 
	(FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e, 
	(CHARACTER)_Player, 
	(CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
DB_LOW_BhaalTemple_CurrentState("DuringCombat");
PROC_LOW_BhaalTemple_TurnsHostileCultists();
//DB_LOW_BhaalTemple_Denizen_Reinforcements_Enabled(1);
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Stop();

IF
TurnStarted(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_LOW_BhaalTemple_CombatStartedPrematurely(1)
AND
NOT DB_LOW_BhaalTemple_CombatFirstTurn(_)
THEN
DB_LOW_BhaalTemple_CombatFirstTurn(1);
PROC_LOW_BhaalTemple_CombatStartedPrematurely_StartAD();


// upon start of her turn, she should try to AD. If she can AD, the combat is paused. And at the end of her AD she turns into the slayer - combat resumes.
PROC
PROC_LOW_BhaalTemple_CombatStartedPrematurely_StartAD()
AND
DB_Is_InCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CombatID)
AND
NOT DB_CantTalk_IgnoreCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_BhaalTemple_AD_CombatStart_22ff4636-83d2-6c7f-ffce-70c9fc03ae6a, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
PauseCombat(_CombatID);


// for when Orin is somehow unable to AD, she should still transform into Slayer (if she has the ability to).
PROC
PROC_LOW_BhaalTemple_CombatStartedPrematurely_StartAD()
AND
DB_Is_InCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CombatID)
AND
DB_CantTalk_IgnoreCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
//ResumeCombat(_CombatID);
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer();	// see if she can transform into the slayer


// if the AD triggered, resume combat and have Orin transformed into the Slayer
IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_AD_CombatStart_22ff4636-83d2-6c7f-ffce-70c9fc03ae6a, _)
AND
DB_LOW_BhaalTemple_CombatStartedPrematurely(1)
AND
DB_Is_InCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CombatID)
THEN
ResumeCombat(_CombatID);
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer();	// see if she can transform into the slayer

/*
// if the AD failed to trigger, maybe because Orin was silenced, just make her transformed into Slayer
IF
AutomatedDialogRequestFailed((DIALOGRESOURCE)LOW_BhaalTemple_AD_CombatStart_22ff4636-83d2-6c7f-ffce-70c9fc03ae6a, _)
AND
DB_LOW_BhaalTemple_CombatStartedPrematurely(1)
AND
DB_Is_InCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CombatID)
THEN
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer();	// see if she can transform into the slayer

IF
AutomatedDialogForceStopping((DIALOGRESOURCE)LOW_BhaalTemple_AD_CombatStart_22ff4636-83d2-6c7f-ffce-70c9fc03ae6a, _)
AND
DB_LOW_BhaalTemple_CombatStartedPrematurely(1)
AND
DB_Is_InCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CombatID)
THEN
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer();	// see if she can transform into the slayer
*/

//END_REGION

//REGION Add Orin's Skeletons to DefeatCounter when she summons them
IF
CastedSpell(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "Shout_LOW_LivingSacrifice_Slayer", _, _, _)
THEN
DB_LOW_BhaalTemple_Skeletons_AddToCombatCounter(1);

IF
EnteredLevel(_SkeletonSpawn, Undead_Skeleton_Blood_46056850-5aa7-461b-a49e-6599b9c286f9, "CTY_Main_A")
AND
DB_LOW_BhaalTemple_Skeletons_AddToCombatCounter(1)
THEN
DB_GLO_DefeatCounter(_SkeletonSpawn, "LOW_BhaalTemple_CombatWin_Counter");
//END_REGION


//REGION End of Combat handling
// When combat ends for Non Dark Urge.
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_BhaalTemple_CombatWin_Counter")
AND
NOT QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
QRY_GetClosestAvailableCharacterTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 1)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _Distance, _)
AND
DB_InRegion((CHARACTER)_ClosestAvatar, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
THEN
DB_LOW_BhaalTemple_CurrentState("PostCombat");
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_018ab395-a061-9b69-d053-df796c294c5e);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_018ab395-a061-9b69-d053-df796c294c5e, (TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104, 1);
PROC_LOW_BhaalTemple_PostBattle_StartDialog(_ClosestAvatar);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575); // set the flag to indicate that players have defeated Orin and her combat minions
PROC_LOW_BhaalTemple_OrinsRoom_ClearNPC();
NOT DB_LOW_BhaalTemple_Skeletons_AddToCombatCounter(1); // stop listening for more skeletons.

// When combat ends for Dark Urge in a duel or non-duel.
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_BhaalTemple_CombatWin_Counter")
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
DB_LOW_BhaalTemple_CurrentState("PostCombat");
PROC_LOW_BhaalTemple_DarkUrge_IsPresent_PostCombat();
DB_DialogDeath(_DarkUrge);
PROC_LOW_BhaalTemple_Duel_End();
PROC_LOW_BhaalTemple_BhaalAvatar_SetupInTemple();
PROC_LOW_BhaalTemple_Butler_ResurrectInTemple();
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466);
PROC_LOW_BhaalTemple_DarkUrge_DropSlayerform();
PROC_RemoveMutingPolymorphs(_DarkUrge);
PROC_RemoveMutingStatusses(_DarkUrge);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466, (TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104, 1);
PROC_LOW_BhaalTemple_PostBattleDarkUrge_StartDialog();
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575); // set the flag to indicate that players have defeated Orin and her combat minions
NOT DB_LOW_BhaalTemple_Skeletons_AddToCombatCounter(1); // stop listening for more skeletons.
//END_REGION

//REGION Dialog starts for PostBattle
PROC
PROC_LOW_BhaalTemple_PostBattle_StartDialog((CHARACTER)_Player)
AND
NOT QRY_StartDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_018ab395-a061-9b69-d053-df796c294c5e,
	(CHARACTER) _Player)
AND
QRY_OnlyOnce("LOW_BhaalTemple_PostBattle_WaitForDialog")
THEN
DB_LOW_BhaalTemple_PostBattle_WaitForDialog(_Player);

// wait for players to be able to talk then try dialog again.
IF
DB_LOW_BhaalTemple_PostBattle_WaitForDialog(_Player)
AND
NOT DB_CantTalk(_Player)
THEN
PROC_LOW_BhaalTemple_PostBattle_StartDialog(_Player);

// dialog started so clear WaitForDialog DB.
IF
DialogStarted((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_018ab395-a061-9b69-d053-df796c294c5e, _DialogID)
AND
DB_LOW_BhaalTemple_PostBattle_WaitForDialog(_Player)
THEN
NOT DB_LOW_BhaalTemple_PostBattle_WaitForDialog(_Player);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_018ab395-a061-9b69-d053-df796c294c5e, _DialogID)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // companion was not awakened
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, _TargetChar, 13);
//END_REGION

//REGION Dialog start for PostBattleDarkUrge
// if the Dark Urge wasn't present at the end of the battle, it leads to the Dark Urge Bhaal Disappointed flow. So we play non-DU PostBattle.
PROC
PROC_LOW_BhaalTemple_PostBattleDarkUrge_StartDialog()
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DUDefeatedByOrin_a09d2272-853e-4d46-a7de-27c8f2f9895c)
AND
DB_ORI_DarkUrge(_DarkUrge)
AND
NOT DB_InRegion((CHARACTER)_DarkUrge, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113) // dark urge must not be in the region, else we'd want to play the Dark Urge flow.
AND
QRY_GetClosestAvailableCharacterTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0, 0, NULL_00000000-0000-0000-0000-000000000000, _DarkUrge, 0, 0, 1) // get closest avatar that isn't the Dark Urge
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _Distance, _) // returns an Avatar or closest companion
AND
DB_InRegion((CHARACTER)_ClosestAvatar, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113) // make sure that character is in the temple.
AND
QRY_OnlyOnce("LOW_BhaalTemple_PostBattleDarkUrge_WaitForDialog") // block further execution of PROC override in case somehow it could trigger the one below.
THEN
PROC_LOW_BhaalTemple_PostBattle_StartDialog(_ClosestAvatar);

// if the Dark Urge was present at the end of the battle.
PROC
PROC_LOW_BhaalTemple_PostBattleDarkUrge_StartDialog()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
QRY_OnlyOnce("LOW_BhaalTemple_PostBattleDarkUrge_WaitForDialog")
AND
NOT QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466,
	(CHARACTER) S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c,								
				S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10,
				_DarkUrge)
THEN
DB_LOW_BhaalTemple_PostBattleDarkUrge_WaitForDialog(1);

// wait for players to be able to talk then try dialog again.
IF
DB_LOW_BhaalTemple_PostBattleDarkUrge_WaitForDialog(1)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
NOT DB_CantTalk(_DarkUrge)
AND
NOT DB_CantTalk(S_GLO_BhaalAvatar_2737cdb7-19b0-483c-bd35-eb1e5da5579c) // shouldn't be killable at all, but couldn't hurt to make sure he's available.
//AND
//NOT DB_CantTalk(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10) // don't need to check for this, because even if he's dead/can't talk or somehow somewhere far away we'll FullRestore him and teleport him to the temple.
THEN
PROC_LOW_BhaalTemple_Butler_ResurrectInTemple(); // resurrect the butler again in case he was murdered yet again before DarkUrge was available.
NOT DB_OnlyOnce("LOW_BhaalTemple_PostBattleDarkUrge_WaitForDialog");
PROC_LOW_BhaalTemple_PostBattleDarkUrge_StartDialog();

// dialog started so clear WaitForDialog DB.
IF
DialogStarted((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466, _DialogID)
AND
DB_LOW_BhaalTemple_PostBattleDarkUrge_WaitForDialog(1)
THEN
NOT DB_LOW_BhaalTemple_PostBattleDarkUrge_WaitForDialog(1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466, _DialogID)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // companion was not awakened
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, _TargetChar, 4);
//END_REGION

//REGION Orin Dies
// when Orin dies, zero her HP
IF
DB_PermaDefeated((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
SetHitpointsPercentage(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0.0);
RemoveStatus(S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, "MAG_WEAPON_BOND"); // removes the Bond status on her.
Unequip((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55);
NOT DB_LOW_BhaalTemple_Skeletons_AddToCombatCounter(1); // stop listening for more skeletons.
//END_REGION

//REGION End of PostBattle dialog
// In PostBattle for non-DU, players will pick up Orin's Dagger and therefore netherstone automatically in the cinematics.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_018ab395-a061-9b69-d053-df796c294c5e, _DialogID)
AND
DB_DialogPlayers(_DialogID, _Player, 1)
THEN
// give players the dagger with netherstone, another script will remove this dagger and replace it with the one without the stone.
// streamlined this way because players could still pickup the dagger in another way.
PROC_GEN_OrinsAbduction_GiveDagger_WithNetherstone((CHARACTER)_Player); 


// only at end of dialog PostBattle dialog, do we remove companion as follower (if they were awakened.)
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_018ab395-a061-9b69-d053-df796c294c5e, _)
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName != "Yenna"
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // companion was awakened and joined as follower
THEN
PROC_LOW_BhaalTemple_AbducteeAwaken_LeavesParty(); // now remove them as follower, then make them standby for dialog.


// or if it was Yenna, get her to reappear and standby for dialog.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_018ab395-a061-9b69-d053-df796c294c5e, _)
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName == "Yenna"
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
THEN
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby();
//END_REGION

//REGION End of PostBattleDarkUrge dialog
// Dark Urge fell in battle, in LOW_BhaalTemple_PostBattleDarkUrge, Bhaal will appear and express his disappointment, we hide the butler and enable his disappointed campnight.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466, _)
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DUDefeatedByOrin_a09d2272-853e-4d46-a7de-27c8f2f9895c)
THEN
PROC_LOW_BhaalTemple_Butler_DisappointedCampNight_Enable(); // enable the camp night
PROC_LOW_BhaalTemple_Butler_SendToCampAndHide(); // send him to camp and offstage him for the camp night or else he'll still be in the temple awkwardly

// Remove the dialog death for Dark Urge after this dialog.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466, _)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
NOT DB_DialogDeath(_DarkUrge);
PROC_LOW_BhaalTemple_PostBattleDarkUrge_AttachToParty();

// only at end of dialog PostBattleDarkUrge dialog, do we remove companion as follower (if they were awakened.)
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466, _)
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName != "Yenna"
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // companion was awakened and joined as follower
THEN
PROC_LOW_BhaalTemple_AbducteeAwaken_LeavesParty(); // now remove them as follower, then make them standby for dialog.

// or if it was Yenna, get her to reappear and standby for dialog.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466, _)
AND
DB_GEN_OrinsAbduction_ChosenName(_ChosenName)
AND
_ChosenName == "Yenna"
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
THEN
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby();
//END_REGION



//REGION RESISTANCE - Dark Urge RESISTED Bhaal and decides that they'd rather die themselves.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DUDefeatedByOrin_a09d2272-853e-4d46-a7de-27c8f2f9895c) 
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalResisted_74944ac3-1ea0-4eae-9653-1f1319f8646b)
AND
DB_ORI_DarkUrge(_DarkUrge)
THEN
QuestUpdate(_DarkUrge, "ORI_Avatar_DarkUrge", "BhaalResisted");
SetFlag(TG_DarkUrge_DefiedBhaal_885a6052-a198-4e01-b153-72e3867e4faa, _DarkUrge, 0);
PROC_LOW_BhaalTemple_BhaalAvatar_RemoveFromTemple();
PROC_LOW_BhaalTemple_Withers_AwakensAbductee();
PROC_LOW_BhaalTemple_DarkUrge_MoveToAltar();
PROC_GLO_Jergal_Appear();
PROC_LOW_BhaalTemple_Withers_ResurrectsPlayers();
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351, (TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104, 1);
PROC_LOW_BhaalTemple_Denizens_PostBattleDU_Resistance_Dialog_Setup();
DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351);
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351);
PROC_LOW_BhaalTemple_Butler_FinalState(); // butler dies a permanent death.
PROC_LOW_BhaalTemple_DarkUrgeResisted_StartDialog();

PROC
PROC_LOW_BhaalTemple_DarkUrge_MoveToAltar()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
TeleportTo(_DarkUrge, (TRIGGER)S_LOW_BhaalTemple_DarkUrge_Resistance_RevivePos_d187739c-f9ae-459d-b7c9-c01a394f7cbd);

PROC
PROC_LOW_BhaalTemple_DarkUrgeResisted_StartDialog()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
NOT QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351,
	(CHARACTER)	S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,
				_DarkUrge)
THEN
DB_NOOP(1);

// adding victim to the speaker list.
PROC
PROC_StartDialog_AddExtraSpeakers(LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351, _DialogID)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, _TargetChar, 13);

// Withers teleports back to camp after a few seconds.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351, _)
THEN
PROC_LOW_BhaalTemple_Withers_ReturnToCamp_StartTimer();
//END_REGION

// speculative fix for a possible bug where Equip failed much earlier on and the Netherstone dagger is somehow not transferred to Orin.
// we only do it for Bhaal Resistance/Disappointed flow because its the only flow where the dagger isn't automatically picked up.
//REGION RESISTANCE - Moving the netherstone dagger to OrinCorpse or altar depending if OrinCorpse is in the chasm or not.
// If NetherstoneDagger was somehow still in the scripting asylum
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351, _)
AND
GetPosition(S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, -1542.474, 0.0, 262.979) // its still in its default location in asylum
THEN
PROC_LOW_BhaalTemple_MoveDaggerToSafeLocation();

// If NetherstoneDagger was somehow still stuck in OrinDummy inventory when she turned into DarkUrge
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351, _)
AND
IsInInventoryOf(S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 1) // dagger is still in the inventory of OrinDummy, most likely due to Bond returning it to her body after an NPC threw it.
THEN
PROC_LOW_BhaalTemple_MoveDaggerToSafeLocation();

// Move to OrinCorpse if its NOT in the Chasm.
PROC
PROC_LOW_BhaalTemple_MoveDaggerToSafeLocation()
AND
IsInTrigger(S_LOW_BhaalTemple_OrinCorpse_502e7d05-9f67-4092-a6ad-c349750720c9, (TRIGGER)S_LOW_BhaalTemple_ChasmArea_45fb4540-66ad-4eaa-bf88-94d49af6d7ee, 0)
THEN
ToInventory((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, S_LOW_BhaalTemple_OrinCorpse_502e7d05-9f67-4092-a6ad-c349750720c9, 1, 0, 0);

// Move to near Altar if OrinCorpse is in the Chasm.
PROC
PROC_LOW_BhaalTemple_MoveDaggerToSafeLocation()
AND
IsInTrigger(S_LOW_BhaalTemple_OrinCorpse_502e7d05-9f67-4092-a6ad-c349750720c9, (TRIGGER)S_LOW_BhaalTemple_ChasmArea_45fb4540-66ad-4eaa-bf88-94d49af6d7ee, 1)
THEN
TeleportTo((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, (TRIGGER)S_LOW_BhaalTemple_NonDuel_Orin_Pos_dd0e2e0f-a5ce-4dc4-a69d-15e8fa5df336); // move it onto the altar platform.
PROC_SetOnStage((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, 1); // need to put it on stage again just in case it was offstaged for some reason.
//END_REGION

//REGION RESISTANCE - Withers Handling
PROC
PROC_LOW_BhaalTemple_Withers_ResurrectsPlayers()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
// similar to TextEvent("JergalRes")
TeleportTo(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _DarkUrge);
PROC_GLO_Jergal_SetDeadPlayers();
DB_Debug_InJergalRes(1);
PROC_GLO_Jergal_PrepareAllPlayersResurrection();
NOT DB_Debug_InJergalRes(1);
PROC_GLO_Jergal_ResurrectPlayers();
TeleportTo(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, S_LOW_BhaalTemple_BhaalAvatar_TemplePos_21451bec-8274-445c-aab7-9b7d7d662590);

// remove all harmful status on all players since Withers cured them - helps clear out whatever status might still remain from the combat.
PROC
PROC_LOW_BhaalTemple_Withers_ResurrectsPlayers()
AND
DB_PartyMembers(_Char)
THEN
RemoveHarmfulStatuses(_Char);

PROC
PROC_LOW_BhaalTemple_Withers_ReturnToCamp_StartTimer()
THEN
TimerLaunch("LOW_BhaalTemple_Withers_ReturnToCamp_Timer", 5000);

// Timer is temp fix for the animation
IF
TimerFinished("LOW_BhaalTemple_Withers_ReturnToCamp_Timer")
THEN
PROC_GLO_Jergal_MoveToCamp(); // move Withers back to camp too.

//END_REGION

//REGION RESISTANCE - Withers Awaken Abductee
PROC
PROC_LOW_BhaalTemple_Withers_AwakensAbductee()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_GEN_OrinsAbduction_ChosenChar(_ImpersonatedChar)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_WithersAwakenedVictim_985bbeec-3d2b-4e0f-9bc4-1e12410a758a);
DB_LOW_BhaalTemple_AbducteeRescuer(_DarkUrge);
PROC_LOW_BhaalTemple_Abductee_Unlock();
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565);
PROC_GEN_OrinsAbduction_Temple_KnockedOut_Remove((CHARACTER)_ImpersonatedChar);
//PROC_LOW_BhaalTemple_AbducteeAwaken_AD_StartDialog();
//PROC_LOW_BhaalTemple_AbducteeAwaken_Setup();
PROC_LOW_BhaalTemple_AbducteeAwaken_TeleportToPos();
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby();
DB_DialogDeath(_ImpersonatedChar);

// Remove dialog death once resistance ends.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Resistance_b05e4a6a-ce3b-41e5-3d4d-bc1ef68db351, _)
AND
DB_GEN_OrinsAbduction_ChosenChar(_ImpersonatedChar)
THEN
NOT DB_DialogDeath(_ImpersonatedChar);
//END_REGION


//REGION ACCEPTANCE - End of Dialog after Dark Urge ACCEPTED Bhaal and decides to become his chosen.
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_94891e15-1541-a5e4-c50e-b74d543cb466, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DUDefeatedByOrin_a09d2272-853e-4d46-a7de-27c8f2f9895c) 
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalAccepted_904c45e0-bb06-40ed-b5d7-4f1c851b9d86)
AND
DB_ORI_DarkUrge(_DarkUrge)
THEN
SetFlag(TG_DarkUrge_AcceptedBhaal_3e081f26-3eb2-43c8-8c86-6200e464e8a9, _DarkUrge, 0);
QuestUpdate(_DarkUrge, "ORI_Avatar_DarkUrge", "BhaalWon");
PROC_LOW_BhaalTemple_BhaalAvatar_RemoveFromTemple();
PROC_LOW_BhaalTemple_DarkUrgeAcceptance_JaheiraMinscInParty(); // check if they are in the current party
// Start dialog for Jaheira or Minsc to leave party, or if they are both unavailable, just go with the no JM flow.
//DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, (TRIGGER)S_LOW_BhaalTemple_AltarArea_DialogTrigger_0a93c977-cdc9-40bf-b433-854084739104, 1);
DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
DB_LOW_BhaalTemple_DarkUrgeAcceptance_PreConfrontation(1);
PROC_LOW_BhaalTemple_DarkUrgeAcceptance_PreConfrontation_SelectDialogFlow();

PROC
PROC_LOW_BhaalTemple_DarkUrgeAcceptance_PreConfrontation_SelectDialogFlow()
AND
QRY_LOW_BhaalTemple_DarkUrgeAcceptance_PreConfrontation_StartDialog()
THEN
DB_NOOP(1);

// JM leaving flow.
// Jaheira must be alive.
// Jaheira and in Party.
// Don't care about Minsc since he's an inclusion. 
QRY
QRY_LOW_BhaalTemple_DarkUrgeAcceptance_PreConfrontation_StartDialog()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_GlobalFlag((FLAG)ORI_Jaheira_State_IsInParty_1b86aa78-a2db-4faa-b4a6-c5591c03bac9)
AND
NOT QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741,
	(CHARACTER)	S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,
				_DarkUrge)
AND
QRY_OnlyOnce("LOW_BhaalTemple_Acceptance_Dialog")
THEN
DB_NOOP(1);

// Minsc leaving only flow.
// Jaheira is in Party or not. 
// Jaheira is alive or not.
// Minsc is in party.
// Minsc is NOT PermaDefeated.
QRY
QRY_LOW_BhaalTemple_DarkUrgeAcceptance_PreConfrontation_StartDialog()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_GlobalFlag((FLAG)ORI_Minsc_State_IsInParty_aeb58e60-562a-4e20-8cb2-0deb03b010fc)
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741,
	(CHARACTER)	NULL_00000000-0000-0000-0000-000000000000,
				_DarkUrge)
AND
QRY_OnlyOnce("LOW_BhaalTemple_Acceptance_Dialog")
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, _DialogID)
AND
DB_GlobalFlag((FLAG)ORI_Minsc_State_IsInParty_aeb58e60-562a-4e20-8cb2-0deb03b010fc)
//AND
//DB_GlobalFlag((FLAG)ORI_Minsc_State_SawDarkUrgeAccept_35a4bf9a-9efb-ef19-50e7-8ac2c251f5e5)
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, 4);

// No JM flow.
// Jaheira is in Party or not - we don't care.
// Jaheira is but is dead. Don't care about Minsc since he's an inclusion. 
QRY
QRY_LOW_BhaalTemple_DarkUrgeAcceptance_PreConfrontation_StartDialog()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
//AND
//DB_PermaDefeated((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741,
	(CHARACTER)	NULL_00000000-0000-0000-0000-000000000000,
				_DarkUrge)
AND
QRY_OnlyOnce("LOW_BhaalTemple_Acceptance_Dialog")
THEN
DB_NOOP(1);

/*
IF
DialogStarted((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, _ID)
AND
DB_Avatars(_PlayerAvatar)
THEN
PROC_DialogAddListeningActor(_ID, (CHARACTER)_PlayerAvatar);
*/
//END_REGION 

//REGION ACCEPTANCE - End of the ACCEPTANCE dialog first triggering immediately after PostBattleDarkUrge
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DUDefeatedByOrin_a09d2272-853e-4d46-a7de-27c8f2f9895c)
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalAccepted_904c45e0-bb06-40ed-b5d7-4f1c851b9d86)
AND
DB_LOW_BhaalTemple_DarkUrgeAcceptance_PreConfrontation(1)
AND
DB_ORI_DarkUrge(_DarkUrge)
THEN
PROC_GEN_OrinsAbduction_GiveDagger_WithNetherstone((CHARACTER)_DarkUrge);
NOT DB_LOW_BhaalTemple_DarkUrgeAcceptance_PreConfrontation(1);
//END_REGION

//REGION ACCEPTANCE - Dark Urge ACCEPTED setup to check if Jaheira or Minsc is in current party.
PROC
PROC_LOW_BhaalTemple_DarkUrgeAcceptance_JaheiraMinscInParty()
AND
DB_GlobalFlag((FLAG)ORI_Jaheira_State_IsInParty_1b86aa78-a2db-4faa-b4a6-c5591c03bac9)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Jaheira_State_SawDarkUrgeAccept_0456dcfb-f691-3368-d6c5-8935d15b5019);

PROC
PROC_LOW_BhaalTemple_DarkUrgeAcceptance_JaheiraMinscInParty()
AND
DB_GlobalFlag((FLAG)ORI_Minsc_State_IsInParty_aeb58e60-562a-4e20-8cb2-0deb03b010fc)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Minsc_State_SawDarkUrgeAccept_35a4bf9a-9efb-ef19-50e7-8ac2c251f5e5);
//END_REGION

//REGION ACCEPTANCE - Dark Urge ACCEPTED Jaheira or Minsc leaves the party after the dialog.
IF // Jaheira leave party.
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, _)
AND
DB_GlobalFlag((FLAG)ORI_Jaheira_State_IsInParty_1b86aa78-a2db-4faa-b4a6-c5591c03bac9)
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_LOW_BhaalTemple_JaheiraLeaves(_)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_BhaalTemple_Confrontation_DarkUrge");
PROC_DisappearOutOfSightTo((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_LOW_BhaalTemple_MapMarker_Door_1fbd7ac6-c15d-4c3e-93e8-f9bff39ed7c0, "Sprint", 0, "LOW_BhaalTemple_JaheiraLeave");
DB_LOW_BhaalTemple_JaheiraLeaves(1);

IF // Minsc leaves party.
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, _)
AND
DB_GlobalFlag((FLAG)ORI_Minsc_State_IsInParty_aeb58e60-562a-4e20-8cb2-0deb03b010fc)
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_LOW_BhaalTemple_MinscLeaves(_)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "LOW_BhaalTemple_Confrontation_DarkUrge");
PROC_DisappearOutOfSightTo((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, S_LOW_BhaalTemple_MapMarker_Door_1fbd7ac6-c15d-4c3e-93e8-f9bff39ed7c0, "Sprint", 0, "LOW_BhaalTemple_MinscLeave");
DB_LOW_BhaalTemple_MinscLeaves(1);

IF // If dialog ended, but Minsc and Jaheira are not in the current party, still setup confrontation if needed.
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, _)
AND
NOT DB_LOW_BhaalTemple_JaheiraLeaves(_)
AND
NOT DB_LOW_BhaalTemple_MinscLeaves(_)
THEN
PROC_LOW_BhaalTemple_Confrontation_Setup();

IF // setup the Confrontation once Jaheira has completely left the scene.
EntityEvent(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_BhaalTemple_JaheiraLeave")
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_LOW_BhaalTemple_Confrontation_Setup();

IF // setup the Confrontation once Minsc has completely left the scene when he was in party alone with Jaheira back in camp.
EntityEvent(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "LOW_BhaalTemple_MinscLeave")
AND
NOT DB_LOW_BhaalTemple_JaheiraLeaves(1) // Minsc was alone in leaving the party.
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_LOW_BhaalTemple_Confrontation_Setup();
//END_REGION


//REGION CONFRONTATION - Setup
PROC
PROC_LOW_BhaalTemple_Confrontation_Init()
AND
DB_LOW_BhaalTemple_Harpers(_Harper)
THEN
PROC_SetOnStage((CHARACTER)_Harper, 0); // hide the Harpers for now.

PROC
PROC_LOW_BhaalTemple_Confrontation_Setup()
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
//PROC_LOW_BhaalTemple_CloseDoor(); Door state seems to be very unreliable visually (shown as closed when its opened and vice versa). remarking this until its properly fixed by code.
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, (TRIGGER)S_LOW_BhaalTemple_Confrontation_SpottingArea_dd62aa17-aa35-442b-9e6b-e8d5f9d47138, 1);

PROC_LOW_BhaalTemple_Confrontation_Jaheira_Setup(); // setup Jaheira for the confrontation if she's available.
PROC_LOW_BhaalTemple_Confrontation_Minsc_Setup(); // setup Minsc for the confrontation if she's available.
PROC_LOW_BhaalTemple_Confrontation_Harper_Setup();
PROC_LOW_BhaalTemple_Confrontation_SpottingTrigger_Setup(); // setup the trigger for players only if Jaheira is available.
PROC_LOW_BhaalTemple_Confrontation_Spotting_Setup();

PROC
PROC_LOW_BhaalTemple_Confrontation_SpottingTrigger_Setup()
AND
DB_LOW_BhaalTemple_JaheiraConfrontation(1)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_BhaalTemple_Confrontation_SpottingArea_dd62aa17-aa35-442b-9e6b-e8d5f9d47138);

PROC
PROC_LOW_BhaalTemple_Confrontation_SpottingTrigger_Remove()
AND
DB_LOW_BhaalTemple_JaheiraConfrontation(1)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_BhaalTemple_Confrontation_SpottingArea_dd62aa17-aa35-442b-9e6b-e8d5f9d47138);
//END_REGION

//REGION CONFRONTATION - Harper Setup
PROC // Jaheira must be present for Harpers to be setup.
PROC_LOW_BhaalTemple_Confrontation_Harper_Setup()
AND
DB_LOW_BhaalTemple_JaheiraConfrontation(1)
AND
DB_LOW_BhaalTemple_Harpers(_Harper)
THEN
PROC_SetOnStage((CHARACTER)_Harper, 1); // put the Harpers into position
DB_SceneManager((CHARACTER)_Harper, "LOW_BhaalTemple_Confrontation_Scene");
DB_GLO_DefeatCounter(_Harper, "LOW_BhaalTemple_Confrontation_CombatWin_Counter");
SetCombatGroupID(_Harper, "LOW_BhaalTemple_Confrontation_Harpers");

IF
WentOnStage((CHARACTER)_Harper,1)
AND
DB_LOW_BhaalTemple_Harpers(_Harper)
AND
HasSpell(_Harper,"Target_ConjureWoodlandBeings",1)
AND
GetPosition(_Harper,_X,_Y,_Z)
AND
FindValidPosition(_X,_Y,_Z,6.0,_Harper,1,_CastX,_CastY,_CastZ)
THEN
DB_LOW_BhaalTemple_HarpersWoodlandSpellUsed(_Harper);
UseSpellAtPosition(_Harper,"Target_ConjureWoodlandBeings",_CastX,_CastY,_CastZ);

//FindValidPosition fallback
IF
WentOnStage((CHARACTER)_Harper,1)
AND
NOT DB_LOW_BhaalTemple_HarpersWoodlandSpellUsed(_Harper)
AND
DB_LOW_BhaalTemple_Harpers(_Harper)
AND
HasSpell(_Harper,"Target_ConjureWoodlandBeings",1)
AND
GetPosition(_Harper,_X,_Y,_Z)
THEN
DB_LOW_BhaalTemple_HarpersWoodlandSpellUsed(_Harper);
UseSpellAtPosition(_Harper,"Target_ConjureWoodlandBeings",_X,_Y,_Z);

IF
WentOnStage((CHARACTER)_Harper,1)
AND
DB_LOW_BhaalTemple_Harpers(_Harper)
AND
HasSpell(_Harper,"Target_RangersCompanion_Wolf",1)
AND
GetPosition(_Harper,_X,_Y,_Z)
AND
FindValidPosition(_X,_Y,_Z,6.0,_Harper,1,_CastX,_CastY,_CastZ)
THEN
DB_LOW_BhaalTemple_HarpersWolfSpellUsed(_Harper);
UseSpellAtPosition(_Harper,"Target_RangersCompanion_Wolf",_CastX,_CastY,_CastZ);

//FindValidPosition fallback
IF
WentOnStage((CHARACTER)_Harper,1)
AND
NOT DB_LOW_BhaalTemple_HarpersWolfSpellUsed(_Harper)
AND
DB_LOW_BhaalTemple_Harpers(_Harper)
AND
HasSpell(_Harper,"Target_RangersCompanion_Wolf",1)
AND
GetPosition(_Harper,_X,_Y,_Z)
THEN
DB_LOW_BhaalTemple_HarpersWolfSpellUsed(_Harper);
UseSpellAtPosition(_Harper,"Target_RangersCompanion_Wolf",_X,_Y,_Z);

PROC
PROC_LOW_BhaalTemple_Confrontation_Harper_Setup()
AND
DB_LOW_BhaalTemple_HarpersWolfSpellUsed(_Harper)
THEN
NOT DB_LOW_BhaalTemple_HarpersWolfSpellUsed(_Harper);

PROC
PROC_LOW_BhaalTemple_Confrontation_Harper_Setup()
AND
DB_LOW_BhaalTemple_HarpersWoodlandSpellUsed(_Harper)
THEN
NOT DB_LOW_BhaalTemple_HarpersWoodlandSpellUsed(_Harper);
//END_REGION

//REGION CONFRONTATION - Jaheira Setup
PROC
PROC_LOW_BhaalTemple_Confrontation_Jaheira_Setup()
AND
QRY_LOW_BhaalTemple_Confrontation_CheckJaheiraJoin()
THEN
TeleportTo((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (TRIGGER)S_LOW_BhaalTemple_Confrontation_Jaheira_Pos_5729d3ef-e25e-484a-af72-8b41706b5ca6, "", 0, 0, 0, 0, 0);		
PROC_SetOnStage((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 1); 
DB_SceneManager((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_BhaalTemple_Confrontation_Scene");
DB_GLO_DefeatCounter(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_BhaalTemple_Confrontation_CombatWin_Counter");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_Enabled_103a9b67-e2bb-4823-8262-e0d97aaca769);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_StartCombat_05b66d87-1271-48a5-92bc-b226aedb79a6, (DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
DB_LOW_BhaalTemple_JaheiraConfrontation(1);

IF
DB_LOW_BhaalTemple_JaheiraConfrontation(1)
THEN
DB_Origins_BlockTransferReasons("LOW_BhaalTemple_Confrontation_DarkUrge");
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_BhaalTemple_Confrontation_DarkUrge");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_JaheiraPresent_33f7a59c-37c6-426e-a76e-fa44178eff11);
SetFaction((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (FACTION)ACT3_LOW_BhaalTemple_Harpers_3819e5ff-4733-49e7-94e1-eb8e4dd073ab);
SetLevel(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,12);
ApplyStatus(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,"FREEDOM_OF_MOVEMENT",-1.0,1,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
ApplyStatus(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,"MIRROR_IMAGE_3",-1.0,1,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
ApplyStatus(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,"MIRROR_IMAGE_2",-1.0,1,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
ApplyStatus(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,"MIRROR_IMAGE_1",-1.0,1,S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
SetCombatGroupID(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_BhaalTemple_Confrontation_Harpers");

//REGION Jaheira availability
// Jaheira is alive, and have left the party earlier.
QRY
QRY_LOW_BhaalTemple_Confrontation_CheckJaheiraJoin()
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_LOW_BhaalTemple_JaheiraLeaves(1)
THEN
DB_NOOP(1);

// Jaheira is alive, but was just back in camp.
QRY
QRY_LOW_BhaalTemple_Confrontation_CheckJaheiraJoin()
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_GlobalFlag((FLAG)GLO_Origin_PartOfTheTeam_Jaheira_d7d29efe-70bb-47c2-9db3-bc8a10347bc6)
THEN
DB_NOOP(1);
//END_REGION
//END_REGION

//REGION CONFRONTATION - Minsc Setup
PROC
PROC_LOW_BhaalTemple_Confrontation_Minsc_Setup()
AND
DB_LOW_BhaalTemple_JaheiraConfrontation(1) // make sure that Jaheira is at least available for the confrontation.
AND
QRY_LOW_BhaalTemple_Confrontation_CheckMinscJoin()
THEN
TeleportTo((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (TRIGGER)S_LOW_BhaalTemple_Confrontation_Minsc_Pos_63e1dcf1-273b-4fd4-ba9d-8b56a02bfcda, "", 0, 0, 0, 0, 0);		
PROC_SetOnStage((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, 1);
DB_SceneManager((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "LOW_BhaalTemple_Confrontation_Scene");
DB_GLO_DefeatCounter(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "LOW_BhaalTemple_Confrontation_CombatWin_Counter");
DB_GLO_DieFlag(
	(FLAG)LOW_BhaalTemple_Event_Confrontation_MinscKillsJaheira_f1e861f2-9cf7-45b9-9497-c435e66c40a6, 
	(CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 
	DEATHTYPE.DoT, 
	(CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba); // for when Minsc might kill Jaheira in dialog.
DB_LOW_BhaalTemple_MinscConfrontation(1);

IF
DB_LOW_BhaalTemple_MinscConfrontation(1)
THEN
DB_Origins_BlockTransferReasons("LOW_BhaalTemple_Confrontation_DarkUrge");
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "LOW_BhaalTemple_Confrontation_DarkUrge");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_MinscPresent_8b77181d-8340-4b11-93b7-c3e54e52b4ab);
SetFaction((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (FACTION)ACT3_LOW_BhaalTemple_Harpers_3819e5ff-4733-49e7-94e1-eb8e4dd073ab);
SetLevel(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,12);
SetCombatGroupID(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,"LOW_BhaalTemple_Confrontation_Harpers");
TemplateAddTo((ITEMROOT)CONS_Potion_Speed_ad9f3f24-d755-48b6-aa7b-c34da068209f,S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,1,0);

//REGION Minsc availability
// Minsc is alive, and have left the party earlier.
QRY
QRY_LOW_BhaalTemple_Confrontation_CheckMinscJoin()
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_LOW_BhaalTemple_MinscLeaves(1)
THEN
DB_NOOP(1);

// Minsc is alive, but was just back in camp.
QRY
QRY_LOW_BhaalTemple_Confrontation_CheckMinscJoin()
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_GlobalFlag((FLAG)GLO_Origin_PartOfTheTeam_Minsc_3510cd49-7ff6-475c-829b-d4d68a07b085)
THEN
DB_NOOP(1);

// Minsc is alive, but was rescued, but left the party.
QRY
QRY_LOW_BhaalTemple_Confrontation_CheckMinscJoin()
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_GlobalFlag((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20) // he was saved from the absolute, but left the party already.
THEN
DB_NOOP(1);
//END_REGION
//END_REGION

//REGION CONFRONTATION - Spotting setup/remove

PROC // for Harpers
PROC_LOW_BhaalTemple_Confrontation_Spotting_Setup()
AND
DB_LOW_BhaalTemple_Harpers(_Harper)
THEN
DB_SpotPlayers(_Harper, "LOW_BhaalTemple_ConfrontationSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeWildshapedPlayers(_Harper, "LOW_BhaalTemple_ConfrontationSpotting");

PROC // for Jaheira
PROC_LOW_BhaalTemple_Confrontation_Spotting_Setup()
AND
DB_LOW_BhaalTemple_JaheiraConfrontation(1)
THEN
DB_SpotPlayers((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_BhaalTemple_ConfrontationSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeWildshapedPlayers(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_BhaalTemple_ConfrontationSpotting");

PROC // for Minsc
PROC_LOW_BhaalTemple_Confrontation_Spotting_Setup()
AND
DB_LOW_BhaalTemple_MinscConfrontation(1)
THEN
DB_SpotPlayers((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "LOW_BhaalTemple_ConfrontationSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeWildshapedPlayers(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "LOW_BhaalTemple_ConfrontationSpotting");

PROC 
PROC_LOW_BhaalTemple_Confrontation_Spotting_Remove()
THEN
PROC_LOW_BhaalTemple_Confrontation_SpottingTrigger_Remove();
PROC_LOW_BhaalTemple_Confrontation_Spotting_Harper_Remove();
NOT DB_SpotPlayers((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_BhaalTemple_ConfrontationSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SpotPlayers((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "LOW_BhaalTemple_ConfrontationSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC 
PROC_LOW_BhaalTemple_Confrontation_Spotting_Harper_Remove()
AND
DB_LOW_BhaalTemple_Harpers(_Harper)
THEN
NOT DB_SpotPlayers(_Harper, "LOW_BhaalTemple_ConfrontationSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION CONFRONTATION - Spotted
// if a player was spotted, but Jaheira is somehow dead after she witnessed DU accepting Bhaal - assumption is players killed her or left her dead.
PROC
PROC_SpotPlayers_Spotted(_, "LOW_BhaalTemple_ConfrontationSpotting", _Player)
AND
DB_Players(_Player)
AND
DB_PermaDefeated((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
QRY_OnlyOnce("LOW_BhaalTemple_ConfrontationSpotting")
THEN
PROC_LOW_BhaalTemple_Confrontation_Spotting_Remove();
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_WithoutJaheira_ad77de2a-eac2-4e3d-a2b1-df6f56c8a580);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
PROC_LOW_BhaalTemple_Confrontation_StartDialogCaptain(_Player);
// TODO: force her to leave party as she's dead?


// if a player was spotted, check if the Dark Urge is in the area.
PROC
PROC_SpotPlayers_Spotted(_, "LOW_BhaalTemple_ConfrontationSpotting", _Player)
AND
DB_Players(_Player)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_InRegion((CHARACTER)_DarkUrge, (TRIGGER)S_LOW_BhaalTemple_Confrontation_SpottingArea_dd62aa17-aa35-442b-9e6b-e8d5f9d47138)
AND
QRY_OnlyOnce("LOW_BhaalTemple_ConfrontationSpotting")
THEN
PROC_LOW_BhaalTemple_Confrontation_Spotting_Remove();
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
PROC_LOW_BhaalTemple_Confrontation_StartDialogDU(_DarkUrge);


// if a player was spotted, but DU is not in the area.
PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_BhaalTemple_ConfrontationSpotting", _Player)
AND
DB_Players(_Player)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
NOT DB_InRegion((CHARACTER)_DarkUrge, (TRIGGER)S_LOW_BhaalTemple_Confrontation_SpottingArea_dd62aa17-aa35-442b-9e6b-e8d5f9d47138)
AND
QRY_OnlyOnce("LOW_BhaalTemple_ConfrontationSpotting")
THEN
PROC_LOW_BhaalTemple_Confrontation_Spotting_Remove();
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Event_Confrontation_NotDarkUrge_b48d71c0-8b2e-49b0-b686-02eb7e0e30e5);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741);
PROC_LOW_BhaalTemple_Confrontation_StartDialogNonDU(_Player);
//END_REGION 

//REGION CONFRONTATION - Dialog starts
// if the player spotted was DU
PROC 
PROC_LOW_BhaalTemple_Confrontation_StartDialogDU((CHARACTER)_DarkUrge)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741,
	(CHARACTER) S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,
				_DarkUrge)
THEN
DB_NOOP(1);


// if the player spotted was not DU, but he's nearby anyways
PROC 
PROC_LOW_BhaalTemple_Confrontation_StartDialogDU((CHARACTER)_Player)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
_DarkUrge != _Player
AND
QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741,
	(CHARACTER) S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,
				_DarkUrge,
				_Player)
THEN
DB_NOOP(1);



// if player spotted was nonDU, and DU isn't anywhere nearby.
PROC 
PROC_LOW_BhaalTemple_Confrontation_StartDialogNonDU((CHARACTER)_Player)
AND
QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741,
	(CHARACTER) S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,				
				_Player)
THEN
DB_NOOP(1);


// if Jaheira is somehow left dead in temple despite witnessing player accepting Bhaal, then harper captain takes over.
PROC 
PROC_LOW_BhaalTemple_Confrontation_StartDialogCaptain((CHARACTER)_Player)
AND
QRY_StartDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741,
	(CHARACTER) NULL_00000000-0000-0000-0000-000000000000,
				_Player)
THEN
DB_NOOP(1);

// if Minsc is available
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, _DialogID)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_Enabled_103a9b67-e2bb-4823-8262-e0d97aaca769)
AND
DB_LOW_BhaalTemple_MinscConfrontation(1)
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, 4);

// if Jaheira witnessed the DU accepting Bhaal but somehow still died - players murdered her most likely.
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleDarkUrge_Acceptance_dd5794c1-8fd4-d91a-6899-edd9b3bef741, _DialogID)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_WithoutJaheira_ad77de2a-eac2-4e3d-a2b1-df6f56c8a580)
AND
DB_PermaDefeated((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, S_LOW_BhaalTemple_HarperCaptain_8600e330-fa15-471e-ab67-958f0543ee9f, 12);
//END_REGION 

//REGION CONFRONTATION - Dialog Ends - more companions leave if approval is too low
// Wyll leaves regardless of approval
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_Confrontation_Leaving_Wyll_e282515e-5415-4134-adbe-c70839deafb3, _, _DialogID)
AND
NOT DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
DB_Origins_BlockTransferReasons("LOW_BhaalTemple_Confrontation_DarkUrge");
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "LOW_BhaalTemple_Confrontation_DarkUrge");
SetFaction((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (FACTION)ACT3_LOW_BhaalTemple_Harpers_3819e5ff-4733-49e7-94e1-eb8e4dd073ab); // set faction to Harpers
SetCombatGroupID(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "LOW_BhaalTemple_Confrontation_Harpers");

// Gale leaves if approval with Dark Urge is below 20
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_Confrontation_Leaving_Gale_20844e0e-fb68-4050-a947-cebf996b262b, _, _DialogID)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_Origins_BlockTransferReasons("LOW_BhaalTemple_Confrontation_DarkUrge");
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "LOW_BhaalTemple_Confrontation_DarkUrge");
SetFaction((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (FACTION)ACT3_LOW_BhaalTemple_Harpers_3819e5ff-4733-49e7-94e1-eb8e4dd073ab); // set faction to Harpers
SetCombatGroupID(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "LOW_BhaalTemple_Confrontation_Harpers");

// Karlach leaves if approval with Dark Urge is below 40
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_Confrontation_Leaving_Karlach_f93d0bd8-5f3e-40c0-8174-88610dd8208d, _, _DialogID)
AND
NOT DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_Origins_BlockTransferReasons("LOW_BhaalTemple_Confrontation_DarkUrge");
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "LOW_BhaalTemple_Confrontation_DarkUrge");
SetFaction((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (FACTION)ACT3_LOW_BhaalTemple_Harpers_3819e5ff-4733-49e7-94e1-eb8e4dd073ab); // set faction to Harpers
SetCombatGroupID(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "LOW_BhaalTemple_Confrontation_Harpers");
//END_REGION


//REGION CONFRONTATION - Dialog Ends (and combat begins)
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_StartCombat_05b66d87-1271-48a5-92bc-b226aedb79a6, _, _DialogID)
AND
DB_DialogPlayers(_DialogID, _Player, 1)
THEN
PROC_SceneOver("LOW_BhaalTemple_Confrontation_Scene");
PROC_LOW_BhaalTemple_Confrontation_Allies_Setup();
PROC_TryStopDialogFor((CHARACTER)_Player); // stop the player's dialog
PROC_LOW_BhaalTemple_Confrontation_StartCombat((CHARACTER)_Player);

PROC
PROC_LOW_BhaalTemple_Confrontation_StartCombat((CHARACTER)_Player)
THEN
SetHostileAndEnterCombat(
	(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 
	(FACTION)ACT3_LOW_BhaalTemple_Harpers_3819e5ff-4733-49e7-94e1-eb8e4dd073ab, 
	(CHARACTER)_Player, 
	(CHARACTER)S_LOW_BhaalTemple_HarperCaptain_8600e330-fa15-471e-ab67-958f0543ee9f);
//END_REGION

//REGION CONFRONTATION - Scene Interrupted
PROC
PROC_SceneInterrupted(_, _AttackOwner, "LOW_BhaalTemple_Confrontation_Scene", _Reason)
AND
NOT DB_LOW_BhaalTemple_Confrontation_MinscKillsJaheira(1)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
THEN
PROC_SceneOver("LOW_BhaalTemple_Confrontation_Scene");
PROC_LOW_BhaalTemple_Confrontation_Spotting_Remove();
PROC_LOW_BhaalTemple_Confrontation_Allies_Setup();
PROC_TryStopDialogFor((CHARACTER)_AttackOwner); // stop the player's dialog
PROC_LOW_BhaalTemple_Confrontation_StartCombat((CHARACTER)_AttackOwner);

// If Minsc kills Jaheira in the dialog, intercept the interruption and ignore it.
// This is to avoid situation where Minsc kills Jaheira, and other players who are not in dialog will then be able to attack rest of party without any reaction.
PROC
PROC_SceneInterrupted(_, _AttackOwner, "LOW_BhaalTemple_Confrontation_Scene", _Reason)
AND
DB_LOW_BhaalTemple_Confrontation_MinscKillsJaheira(1)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
THEN
NOT DB_LOW_BhaalTemple_Confrontation_MinscKillsJaheira(1);
//END_REGION

//REGION CONFRONTATION - Cultist Allies Join
PROC
PROC_LOW_BhaalTemple_Confrontation_Allies_Setup()
AND
DB_LOW_BhaalTemple_Denizens_Reinforcements(_, _Char)
AND
NOT DB_PermaDefeated(_Char)
THEN
//PROC_RemoveAllDialogEntriesForSpeaker(_Char);
SetFaction(_Char, (FACTION)ACT3_LOW_BhaalTemple_Cultists_AcceptanceAllies_f72b2677-b706-4341-85be-f111cbdf02ee);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BhaalTemple_Cultists_AcceptanceAllies_f72b2677-b706-4341-85be-f111cbdf02ee, 100);
PROC_AppearOutOfSightTo(_Char, S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, "LOW_BhaalTemple_AcceptanceAllies_AppearedOutOfSight");

// set hostilities already when they appear out of sight, and move towards the DU.
IF
EntityEvent(_Char, "LOW_BhaalTemple_AcceptanceAllies_AppearedOutOfSight")
AND
DB_LOW_BhaalTemple_Denizens_Reinforcements(_, (CHARACTER)_Char)
AND
DB_ORI_DarkUrge(_DarkUrge)
THEN
PROC_CharacterMoveTo((CHARACTER)_Char, (GUIDSTRING)_DarkUrge, "Run", "LOW_BhaalTemple_AcceptanceAllies");
PROC_SetRelationMutual((FACTION)ACT3_LOW_BhaalTemple_Cultists_AcceptanceAllies_f72b2677-b706-4341-85be-f111cbdf02ee, (FACTION)ACT3_LOW_BhaalTemple_Harpers_3819e5ff-4733-49e7-94e1-eb8e4dd073ab, 0);

// start combat upon arriving near the DU.
IF
EntityEvent(_Char, "LOW_BhaalTemple_AcceptanceAllies")
AND
DB_LOW_BhaalTemple_Denizens_Reinforcements(_, (CHARACTER)_Char)
AND
QRY_OnlyOnce("LOW_BhaalTemple_AcceptanceAllies")
THEN
SetHostileAndEnterCombat(
	(FACTION)ACT3_LOW_BhaalTemple_Cultists_AcceptanceAllies_f72b2677-b706-4341-85be-f111cbdf02ee, 
	(FACTION)ACT3_LOW_BhaalTemple_Harpers_3819e5ff-4733-49e7-94e1-eb8e4dd073ab, 
	(CHARACTER)_Char, 
	(CHARACTER)S_LOW_BhaalTemple_HarperCaptain_8600e330-fa15-471e-ab67-958f0543ee9f);

IF
TurnStarted(S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_BhaalAccepted_Confrontation_Enabled_103a9b67-e2bb-4823-8262-e0d97aaca769)
AND
NOT DB_LOW_BhaalTemple_AcceptanceAllies_CombatFirstTurn(_)
THEN
DB_LOW_BhaalTemple_AcceptanceAllies_CombatFirstTurn(1);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_02_AD_DarkUrgeDuel_64b28fd5-33e9-87ab-db2a-7d8dd40be23f, S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2);
//END_REGION

//REGION CONFRONTATION - End of Confrontation Handling
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_BhaalTemple_Confrontation_CombatWin_Counter")
AND
DB_LOW_BhaalTemple_Denizens_Reinforcements(_, (CHARACTER)_Char)
AND
NOT DB_PermaDefeated(_Char)
AND
DB_LOW_BhaalTemple_Denizens_Dialogs(_Char, _CharDialog)
THEN
PROC_ClearStoryMove(_Char); // their PROC_CharacterMoveTo might still be running and tries to resume after combat. If its still running, it has disabled ability to talk to these NPCs.
//DB_Dialogs(_Char, (DIALOGRESOURCE)_CharDialog);
//END_REGION

//REGION CONFRONTATION - Global flag setting when Minsc kills Jaheira
IF
FlagSet((FLAG)LOW_BhaalTemple_Event_Confrontation_MinscKillsJaheira_f1e861f2-9cf7-45b9-9497-c435e66c40a6, _, _)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_MinscKilledJaheira_fe1c4255-b8ba-4b0b-88e8-93177aed26f6);
DB_LOW_BhaalTemple_Confrontation_MinscKillsJaheira(1); // DB set so that SceneInterrupted will be skipped for this event
//END_REGION




//REGION IN-WORLD ABDUCTION World Abduction triggers.
PROC
PROC_LOW_BhaalTemple_InWorldAbductionTriggers_Init()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_InWorldAbductionEnabled_efddef72-84c2-4a44-b5a4-5d82ce887010)
AND
DB_LOW_BhaalTemple_AbductionAreas(_AbductionTrigger, _)
THEN
PROC_TriggerRegisterForPlayers(_AbductionTrigger);

PROC
PROC_LOW_BhaalTemple_InWorldAbductionTriggers_Remove()
AND
DB_LOW_BhaalTemple_AbductionAreas(_AbductionTrigger, _)
THEN
PROC_TriggerUnregisterForPlayers(_AbductionTrigger);
//END_REGION

//REGION IN-WORLD ABDUCTION Check if any World Abduction triggers were Entered or Left.
IF
EnteredTrigger(_Player, _AbductionArea)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_InWorldAbductionEnabled_efddef72-84c2-4a44-b5a4-5d82ce887010)
AND
NOT DB_LOW_BhaalTemple_ChosenInWorldAbductionPos(_)
AND
DB_Players(_Player)
AND
DB_LOW_BhaalTemple_AbductionAreas(_AbductionArea, _AbductionPos)
AND
NOT QRY_LOW_BhaalTemple_CheckGuildHallDuringCoup(_AbductionArea)
THEN
DB_LOW_BhaalTemple_AbductionPossibleArea(_Player, _AbductionArea, _AbductionPos);
PROC_LOW_BhaalTemple_CheckIfAbductionCanOccur();

IF
LeftTrigger(_Player, _AbductionArea)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_InWorldAbductionEnabled_efddef72-84c2-4a44-b5a4-5d82ce887010)
AND
DB_Players(_Player)
AND
DB_LOW_BhaalTemple_AbductionAreas(_AbductionArea, _AbductionPos)
THEN
NOT DB_LOW_BhaalTemple_AbductionPossibleArea(_Player, _AbductionArea, _AbductionPos);

QRY
QRY_LOW_BhaalTemple_CheckGuildHallDuringCoup(S_LOW_BhaalTemple_AbductionArea_01_4ac47f4d-e8e3-43f6-915b-817e7332dd09)
AND
DB_GlobalFlag((FLAG)LOW_Guildhall_State_DuringCoup_6dba56a5-8220-41f4-8849-085e38b80d4e)
THEN
DB_NOOP(1);



//END_REGION

//REGION IN-WORLD ABDUCTION Disable InWorld Abductions
PROC
PROC_LOW_BhaalTemple_InWorldAbductions_Disable()
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_InWorldAbductionEnabled_efddef72-84c2-4a44-b5a4-5d82ce887010); // Disable in-world abductions
PROC_LOW_BhaalTemple_InWorldAbductionTriggers_Remove();
//END_REGION

//REGION IN-WORLD ABDUCTEE Step 0) World Abduction Checks
PROC
PROC_LOW_BhaalTemple_CheckIfAbductionCanOccur()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_InWorldAbductionEnabled_efddef72-84c2-4a44-b5a4-5d82ce887010)
THEN
PROC_GEN_OrinsAbduction_ClearDB_ChosenName();
PROC_LOW_BhaalTemple_InWorldAbduction_FindBest();
PROC_GEN_OrinsAbduction_ClearDB_ChosenChar();
PROC_LOW_BhaalTemple_InWorldAbduction_SetupBest();
PROC_LOW_BhaalTemple_InWorldAbduction_SetupOrin();
PROC_LOW_BhaalTemple_InWorldAbduction_AbductCompanion();
//END_REGION

//REGION IN-WORLD ABDUCTEE Step 1) Find best In-World Abductee
// Try to find romance partner first.
PROC
PROC_LOW_BhaalTemple_InWorldAbduction_FindBest()						// Looking for first possible romance friend.
AND
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList(_TargetName, _TargetChar, _)	// Iterate through the candidate lists
AND
NOT DB_GEN_OrinsAbduction_ChosenName(_)							// we haven't chosen anyone yet. After we choose one this line will prevent further iteration
AND
QRY_LOW_BhaalTemple_InWorldAbduction_CheckBasicReq((CHARACTER)_TargetChar)
AND
QRY_GEN_OrinsAbduction_CheckValidFriend()
THEN
//PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
//DB_GEN_OrinsAbduction_ChosenCharRelationship((FLAG)LOW_BhaalTemple_State_AbducteeIsRomance_115d7115-c924-485f-8b76-3e13d661f4e5);
//DB_GEN_OrinsAbduction_ChosenName(_TargetName); 					// save the chosen
DB_NOOP(1);

// Check to see if the target is partnered with any avatar - except for Minthara
QRY
QRY_LOW_BhaalTemple_InWorldAbduction_CheckRomance((STRING)_TargetName)
AND
_TargetName != "Minthara"
AND
DB_GEN_OrinsAbduction_PartneredList(_TargetName, _TargetFlag)
AND
DB_Avatars(_Player)
AND
GetFlag((FLAG)_TargetFlag, _Player, 1)
THEN
DB_NOOP(1);

// If its Minthara, ignore the romance check since she's definitely a romance partner when she's part of the party.
QRY
QRY_LOW_BhaalTemple_InWorldAbduction_CheckRomance("Minthara")
THEN
DB_NOOP(1);

// Looking for first possible friend.
PROC
PROC_LOW_BhaalTemple_InWorldAbduction_FindBest()							
AND
QRY_LOW_BhaalTemple_InWorldAbduction_CheckValidFriend()
AND
DB_GEN_OrinsAbduction_ChosenName(_TargetName)
THEN
DB_NOOP(1);


// Check through possible abduction candidates and see if they are valid.
QRY
QRY_LOW_BhaalTemple_InWorldAbduction_CheckValidFriend()
AND
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList(_TargetName, _TargetChar, _)	// Iterate through the candidate lists
AND
NOT DB_GEN_OrinsAbduction_ChosenName(_)							// Romance must not have already been chosen.
AND
QRY_LOW_BhaalTemple_InWorldAbduction_CheckFriendConditions(_TargetName, (CHARACTER)_TargetChar)
THEN
DB_GEN_OrinsAbduction_ChosenName(_TargetName); 					// save the chosen


// If normal companion (as opposed to the Yenna), check if they are available.
QRY
QRY_LOW_BhaalTemple_InWorldAbduction_CheckFriendConditions((STRING)_TargetName, (CHARACTER)_TargetChar) 
AND
QRY_LOW_BhaalTemple_InWorldAbduction_CheckBasicReq(_TargetChar)
AND
NOT QRY_LOW_BhaalTemple_InWorldAbduction_CheckRomance(_TargetName)					// Check to see if target has a partnered flag
THEN
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
DB_GEN_OrinsAbduction_ChosenCharRelationship((FLAG)LOW_BhaalTemple_State_AbducteeIsFriend_dd552cb0-4429-4bc9-849c-85fb611124bd);


// If we are down in the list and reached Yenna, then no companions are available and we will do the Atrocity scene.
QRY
QRY_LOW_BhaalTemple_InWorldAbduction_CheckFriendConditions("Yenna", _)
THEN
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
DB_GEN_OrinsAbduction_ChosenCharRelationship((FLAG)LOW_BhaalTemple_State_AbducteeIsYenna_fa8d1e59-26d5-4ad6-9706-1cb15a5cdb0a);
//DB_NOOP(1);

// Basic check for validity of choice.
QRY
QRY_LOW_BhaalTemple_InWorldAbduction_CheckBasicReq((CHARACTER)_TargetChar)
AND
DB_InCamp((CHARACTER)_TargetChar)								// Must be in camp
AND
NOT DB_Avatars((CHARACTER)_TargetChar)							// Must NOT be an avatar.
AND
NOT DB_DismissedAvatar(_TargetChar)
AND
NOT DB_CantTalk((CHARACTER)_TargetChar)							// Must be able to talk.
THEN
DB_NOOP(1);
//END_REGION

//REGION IN-WORLD ABDUCTEE Step 3) Setup Best In-World Abductee DBs
PROC
PROC_LOW_BhaalTemple_InWorldAbduction_SetupBest()
AND
DB_GEN_OrinsAbduction_ChosenName(_TargetName)
AND
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList(_TargetName, _TargetChar, _TargetDialog)
AND
DB_GEN_OrinsAbduction_AbducteeFlagList(_TargetName, _TargetFlag)
AND
DB_GEN_OrinsAbduction_AbducteeGender(_TargetName, _TargetGenderFlag)
THEN
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_TargetChar);
DB_GEN_OrinsAbduction_ChosenCharFlag((FLAG)_TargetFlag);
PROC_GlobalSetFlagAndCache(_TargetFlag); // to set the flag of who was actually abductee for use in dialogs.
PROC_GlobalSetFlagAndCache(_TargetGenderFlag); // to set the gender flag for writers to use in dialogs - specifically the Nested dialog that wouldn't have access to the original victim.
PROC_LOW_BhaalTemple_ClearDB_ChosenInWorldAbductionPos();
PROC_LOW_BhaalTemple_InWorldAbduction_SetupPos();

PROC
PROC_LOW_BhaalTemple_InWorldAbduction_SetupPos()
AND
DB_GEN_OrinsAbduction_ChosenName(_)
AND
DB_LOW_BhaalTemple_AbductionPossibleArea(_, _AbductionArea, _AbductionPos)
THEN
DB_LOW_BhaalTemple_ChosenInWorldAbductionArea(_AbductionArea);
DB_LOW_BhaalTemple_ChosenInWorldAbductionPos(_AbductionPos);

// if its the Elfsong location, unlock the door there if it hasn't already been unlocked.
IF
DB_LOW_BhaalTemple_ChosenInWorldAbductionPos(S_LOW_BhaalTemple_AbductionPos_02_86d6cb8f-5de1-4518-93e7-80e6515330e7) 
THEN
PROC_LOW_BhaalTemple_InWorldAbduction_UnlockDoor();

PROC
PROC_LOW_BhaalTemple_InWorldAbduction_UnlockDoor()
AND
IsDestroyed((ITEM)DOOR_Double_Slim_City_House_B_013_ed6c6209-e2eb-4124-a48d-a78de97970b3, 0)
AND
IsLocked((ITEM)DOOR_Double_Slim_City_House_B_013_ed6c6209-e2eb-4124-a48d-a78de97970b3, 1)
THEN
PROC_ItemUnlockAndOpen((ITEM)DOOR_Double_Slim_City_House_B_013_ed6c6209-e2eb-4124-a48d-a78de97970b3);

//END_REGION

//REGION IN-WORLD ABDUCTEE Step 5) Setup Orin for the impersonation of the abductee
PROC
PROC_LOW_BhaalTemple_InWorldAbduction_SetupOrin()
AND
DB_GEN_OrinsAbduction_ChosenName(_ImpersonatedName)
AND
DB_GEN_OrinsAbduction_ChosenChar(_ImpersonatedChar)
AND
DB_LOW_BhaalTemple_ChosenInWorldAbductionPos(_ChosenInWorldPos)
AND
DB_GEN_OrinsAbduction_OrinTransformRule_Common(_TransformRule)
THEN
PROC_LOW_BhaalTemple_OrinSpotting_Stopped();
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_Event_TransformToOrin_9280b884-9f8e-41f4-bd49-dbfcb2827fe5); // flag will be used to check her transformation state in dialogs
DB_PreventPermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // prevent her permadeath in Impersonation encounters
TeleportTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _ChosenInWorldPos, "GEN_OrinsAbduction_OrinTeleported", 0, 0, 0, 0, 0);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2);
DB_GEN_OrinsAbduction_IsTransformed(1);
Transform((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)_ImpersonatedChar, (SHAPESHIFTRULE)_TransformRule);
CopyCharacterEquipment((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)_ImpersonatedChar);
PROC_GEN_OrinsAbduction_BloodiedChar_Apply((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);

PROC_LOW_BhaalTemple_InWorldAbduction_OrinRunsToPlayers(_ImpersonatedName);
PROC_LOW_BhaalTemple_InWorldAbduction_WaitForPlayersFallback();
DB_SceneManager((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101 ,"GEN_OrinsAbduction_Scene");

PROC
PROC_LOW_BhaalTemple_InWorldAbduction_OrinRunsToPlayers((STRING)_ImpersonatedName)
AND
GetClosestPlayer(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _Player, _Distance)
//DB_LOW_BhaalTemple_AbductionPossibleArea(_Player, _AbductionArea, _)
AND
_Distance < 30.0 // Only play if there's a player close
AND
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList(_ImpersonatedName, _, _ImpersonatedCharDialog)
THEN
PROC_CharacterMoveToAndTalk((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _Player, (DIALOGRESOURCE)_ImpersonatedCharDialog, "LOW_BhaalTemple_InWorldAbduction", "Run", 15.0);


// adding the dummy to the dialog.
PROC
PROC_StartDialog_AddExtraSpeakers(_ImpersonatedCharDialog, _DialogID)
AND
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList(_ImpersonatedName, _, _ImpersonatedCharDialog)
AND
DB_LOW_BhaalTemple_ChosenInWorldAbductionArea(_AbductionArea)
//DB_LOW_BhaalTemple_AbductionPossibleArea(_Player, _AbductionArea, _)
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, S_LOW_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, 3);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)_ImpersonatedCharDialog, (TRIGGER)_AbductionArea, 1);

PROC
PROC_LOW_BhaalTemple_InWorldAbduction_WaitForPlayersFallback()
AND
DB_GEN_OrinsAbduction_ChosenName(_ImpersonatedName)
AND
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList(_ImpersonatedName, _, _ImpersonatedCharDialog)
THEN
DB_DialogBlockAttackButton((DIALOGRESOURCE)_ImpersonatedCharDialog);
DB_DialogBlockTradeButton((DIALOGRESOURCE)_ImpersonatedCharDialog);
DB_Dialogs((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (DIALOGRESOURCE)_ImpersonatedCharDialog);
//END_REGION

//REGION IN-WORLD ABDUCTEE Step 6) Abduct targeted companion
PROC
PROC_LOW_BhaalTemple_InWorldAbduction_AbductCompanion()
AND
DB_GEN_OrinsAbduction_ChosenChar(_ImpersonatedChar)
AND
DB_GEN_OrinsAbduction_ChosenName(_ImpersonatedName)
AND
DB_GEN_OrinsAbduction_ChosenCharRelationship(_ImpersonatedCharRelationship)
THEN
PROC_LOW_BhaalTemple_RemoveDefaultVictim(); 
PROC_GEN_OrinsAbduction_SetupVictimInTemple((CHARACTER)_ImpersonatedChar, (FLAG)_ImpersonatedCharRelationship);
PROC_GlobalSetFlagAndCache((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d);
// PROC_Origins_CompanionLeaveTemporarily((CHARACTER)_ImpersonatedChar, "LOW_BhaalTemple_Abducted"); //moved to the end of the dialog since a popup will occur when companion leaves.
DB_GEN_OrinsAbduction_AbductionPlace("InWorld");


// if Yenna was the victim, kill the poor cat. Not just because in camp abduction it's Kebab'ed which should already be handled. But also In-World Abduction, due to the possibility of Yenna dying in the temple and the cat haven't no reactivity in camp. And her dialog always assumes cat died.
PROC
PROC_LOW_BhaalTemple_InWorldAbduction_AbductCompanion()
AND
DB_GEN_OrinsAbduction_ChosenName("Yenna")
THEN
PROC_GEN_OrinsAbduction_Yenna_Killcat();
NOT DB_YennaDismissedFromCamp(1); // to make sure Yenna doesn't reappear in camp.
//END_REGION

//REGION IN-WORLD ABDUCTEE Step 7) End of dialog Orin InWorldAbduction
IF
DialogEnded((DIALOGRESOURCE)_ImpersonatedCharDialog, _DialogID)
AND
DB_GEN_OrinsAbduction_ChosenName((STRING)_ImpersonatedName)
AND
DB_LOW_BhaalTemple_InWorldAbduction_AbducteeList(_ImpersonatedName, _, _ImpersonatedCharDialog)
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_LOW_BhaalTemple_ChosenInWorldAbductionArea(_AbductionArea)
//AND
//NOT DB_GlobalFlag((FLAG)WYR_OrinsImpersonation_State_OrinAttacked_Undercity_0f699205-494c-41b4-a1cc-8af69b168672)
THEN
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BhaalTemple_InWorldAbduction_Nested_a1504daf-2fb7-7cc7-9165-b749c2bcd115, (TRIGGER)_AbductionArea, 1);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_Event_TransformToGortash_aca677a0-c532-44df-ac77-3156f0c06925);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_Event_TransformToOrin_9280b884-9f8e-41f4-bd49-dbfcb2827fe5);
PROC_GEN_OrinsAbduction_SetupOrinGortash();
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_BhaalTemple_InWorldAbduction_Nested_a1504daf-2fb7-7cc7-9165-b749c2bcd115);
PROC_GEN_OrinsAbduction_NestedDialog_Start(_DialogID);
//END_REGION

//REGION IN-WORLD ABDUCTEE Step 8) End of Nested Dialog for InWorld
// If end of nested dialog
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_InWorldAbduction_Nested_a1504daf-2fb7-7cc7-9165-b749c2bcd115, _)
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InWorld")
//AND
//NOT DB_GlobalFlag((FLAG)WYR_OrinsImpersonation_State_OrinAttacked_Undercity_0f699205-494c-41b4-a1cc-8af69b168672)
THEN
PROC_LOW_BhaalTemple_InWorldAbduction_Completed();

PROC
PROC_LOW_BhaalTemple_InWorldAbduction_Completed()
THEN
PROC_GEN_OrinsAbduction_CompanionLeaves();
NOT DB_GEN_OrinsAbduction_AbductionPlace("InWorld");
PROC_SceneOver("GEN_OrinsAbduction_Scene");
PROC_GEN_OrinsAbduction_DisableAllImpersonations();
PROC_GEN_OrinsAbduction_OrinTeleportOut();
PROC_GEN_OrinsMessages_Setup();
//END_REGION

//REGION Clear Orin's room of NPC upon defeating Orin
PROC
PROC_LOW_BhaalTemple_OrinsRoom_ClearNPC()
THEN
PROC_DieImmediate((CHARACTER)S_LOW_BhaalTemple_DeathsHead_01_dc5d659c-8703-4e41-bf3e-0eeae60d919b, DEATHTYPE.DoT, 1);
PROC_DieImmediate((CHARACTER)S_LOW_BhaalTemple_DeathsHead_03_1f0a7364-4893-4066-b188-907a51a75bd8, DEATHTYPE.DoT, 1);
PROC_DieImmediate((CHARACTER)S_LOW_BhaalTemple_DeathsHead_04_db8e11fc-5f93-4dae-9abb-a8223317fa29, DEATHTYPE.DoT, 1);
//END_REGION

//REGION Orin kills the victim on the altar.
// Victim was killed at the altar, bloody it.
IF
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
THEN
PROC_LOW_BhaalTemple_KillVictim(_TargetChar);

PROC
PROC_LOW_BhaalTemple_KillVictim((CHARACTER)_Victim)
THEN
Die(_Victim, DEATHTYPE.None, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0, 1);
PROC_GEN_OrinsAbduction_Altar_PlayEffect_Bloodied();

PROC
PROC_LOW_BhaalTemple_KillVictim((CHARACTER)_Victim)
AND
DB_Origins(_Victim)
THEN
PROC_Origins_CompanionLeavePermanently(_Victim, "CompanionMurdered");

IF
CharacterLootedCharacter(_Player, (CHARACTER)_TargetChar)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9)
AND
DB_Players(_Player)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
AND
QRY_OnlyOnce("GEN_OrinsAbduction_AbducteeDeadBody")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_PAD_AbducteeKilled_e009fffc-1479-6522-f2db-4106ddd3ba4a, _Player);
//END_REGION 

//REGION Victim died on the altar before awakened, most likely through gameplay combat.
IF
CharacterLootedCharacter(_Player, (CHARACTER)_TargetChar)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // combat has already begun in the temple.
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // victim was not awakened yet.
AND
DB_Dead(_TargetChar) // but was killed during the battle.
AND
DB_PermaDefeated(_TargetChar) // cannot be resurrected
AND
DB_InRegion((CHARACTER)_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113) // we trigger this only in Bhaal Temple, so outside of the temple this AD won't play for whatever reason.
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GEN_OrinsAbduction_AbducteeDeadBody")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_PostBattle_PAD_AbducteeKilled_e009fffc-1479-6522-f2db-4106ddd3ba4a, _Player);
//END_REGION

//REGION Attach other companions to Dark Urge
PROC
PROC_LOW_BhaalTemple_PostBattleDarkUrge_AttachToParty()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_PartyMembers(_PartyMember)
THEN
AttachToPartyGroup(_PartyMember, _DarkUrge);
//END_REGION 

//REGION Dark Urge players choosing to turn into slayer in dialog
/*
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_PlayerTurnsIntoSlayerInDialog_4915ebb2-6d2c-41d0-baa0-b57d6a6df67f, _, _DialogID)
THEN
PROC_LOW_BhaalTemple_PlayerTransformIntoSlayer();
*/

PROC
PROC_LOW_BhaalTemple_PlayerTransformIntoSlayer()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_PlayerTurnsIntoSlayerInDialog_4915ebb2-6d2c-41d0-baa0-b57d6a6df67f)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
HasSpell(_DarkUrge, "Shout_DarkUrge_Slayer", 1)
AND
NOT DB_LOW_BhaalTemple_DarkUrgeIsSlayerForm(1) // can't check for status or flag, since DropMutingStatuses had already removed it. So this DB was set before dialog begun if DU was in slayer form or not, so we won't be fight with DropMutingStatuses.
THEN
SetFlag((FLAG)ORI_DarkUrge_State_SlayerForm_88b450d5-3815-4f5d-0c6f-0de221513d64, _DarkUrge, 0);

PROC
PROC_LOW_BhaalTemple_DarkUrge_DropSlayerform()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
HasAppliedStatus((CHARACTER)_DarkUrge, "SLAYER_PLAYER", 1) 
THEN
ClearFlag((FLAG)ORI_DarkUrge_State_SlayerForm_88b450d5-3815-4f5d-0c6f-0de221513d64, _DarkUrge, 0);

PROC
PROC_LOW_BhaalTemple_DarkUrge_DropSlayerform()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
HasAppliedStatus((CHARACTER)_DarkUrge, "SLAYER_PLAYER_10", 1) 
THEN
ClearFlag((FLAG)ORI_DarkUrge_State_SlayerForm_88b450d5-3815-4f5d-0c6f-0de221513d64, _DarkUrge, 0);

//END_REGION

//REGION Turn Orin into the Slayer (if its possible)
// Orin turning to slayer as normal circumstances
PROC
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer()
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinForcedSlayer_af3603a6-7114-4752-aa91-6c2a269d8c58)
THEN
ApplyStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BHAALTEMPLE_ORINSLAYER", -1.0, 1, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);

// Orin turning to slayer when she's forced.
PROC
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinForcedSlayer_af3603a6-7114-4752-aa91-6c2a269d8c58)
THEN
ApplyStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BHAALTEMPLE_ORINSLAYER", -1.0, 1, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
ApplyStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BHAALTEMPLE_ORINSLAYER_ENRAGE", -1.0, 1, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//END_REGION

//REGION Orin was ignored during an In-World Abduction (Players were invisible or Orin was unable to start dialog with them automatically. And players didn't click on her to start the dialog with her as the fallback)
IF
Deactivated((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InWorld")
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
PROC_LOW_BhaalTemple_InWorldAbduction_Completed();
//END_REGION

//REGION Setup Orin Dummy Dark Urge character to look like the DarkUrge avatar for a couple of nodes in dialog.
PROC
PROC_LOW_BhaalTemple_OrinDarkUrgeDummy_Setup()
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_GEN_OrinsAbduction_OrinTransformRule_DarkUrge(_TransformRule)
THEN
Transform(S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, _DarkUrge, _TransformRule);
CopyCharacterEquipment(S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, _DarkUrge);
//END_REGION

//REGION When in dialog, Orin transforms into the Slayer. Gameplay must reflect her transformation as well.
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_Event_TransformToSlayer_25508b93-831f-449b-92ef-d3baa32ae964, _, _DialogID)
THEN
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer();
//END_REGION

//REGION When in dialog, Orin transforms into the DarkUrge. Gameplay must reflect her transformation as well.
IF
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_TransformToDarkUrge_61007916-a8ef-47c9-9d44-b3e1c2d21ba8)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_GEN_OrinsAbduction_OrinTransformRule_DarkUrge(_TransformRule)
THEN
DB_NOOP(1);
//END_REGION

//REGION Check if Dark Urge is present in the Bhaal Temple at that point in time.
// DU was missing at the start of the battle. Matters when combat starts prematurely, AD needs to know if DU is within the temple.
PROC
PROC_LOW_BhaalTemple_DarkUrge_IsPresent_PreCombat()
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
DB_ORI_DarkUrge(_DarkUrge)
AND
NOT DB_InRegion(_DarkUrge, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_DUMissingInTemplePrecombat_76e9fee8-c9f1-42b0-82b5-1b00d91788d0); 

// DU was missing at the end of the battle.
PROC
PROC_LOW_BhaalTemple_DarkUrge_IsPresent_PostCombat()
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
DB_ORI_DarkUrge(_DarkUrge)
AND
NOT DB_InRegion(_DarkUrge, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
THEN
PROC_LOW_BhaalTemple_Butler_DisappointedCampNight_Enable();
//END_REGION

//REGION Enable the CAMP_DarkUrge_SkippedTempleFinale_SD camp night.
PROC
PROC_LOW_BhaalTemple_Butler_DisappointedCampNight_Enable()
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_MissedTempleFinale_640cb288-0b40-434a-b13c-0c871d931bcc); 
//END_REGION

//REGION Clear DBs
// Singleton for tracking Bhaal Temple state
IF
DB_LOW_BhaalTemple_CurrentState(_NewState)
AND
DB_LOW_BhaalTemple_CurrentState(_OldState)
AND
_NewState != _OldState
THEN
NOT DB_LOW_BhaalTemple_CurrentState(_OldState);

// Singleton for tracking if players have spoken to abductee post combat with Orin
IF
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat(_NewState)
AND
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat(_OldState)
AND
_NewState != _OldState
THEN
NOT DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat(_OldState);

// Singleton for tracking if we are waiting for LongRest to send companion home
IF
DB_LOW_BhaalTemple_State_WaitForLongRest(_NewState)
AND
DB_LOW_BhaalTemple_State_WaitForLongRest(_OldState)
AND
_NewState != _OldState
THEN
NOT DB_LOW_BhaalTemple_State_WaitForLongRest(_OldState);

// Singleton for tracking if Yenna went to hide already.
IF
DB_LOW_BhaalTemple_State_YennaWentToHide(_NewState)
AND
DB_LOW_BhaalTemple_State_YennaWentToHide(_OldState)
AND
_NewState != _OldState
THEN
NOT DB_LOW_BhaalTemple_State_YennaWentToHide(_OldState);

// Singleton for tracking which abduction area was chosen
IF
DB_LOW_BhaalTemple_ChosenInWorldAbductionArea(_NewState)
AND
DB_LOW_BhaalTemple_ChosenInWorldAbductionArea(_OldState)
AND
_NewState != _OldState
THEN
NOT DB_LOW_BhaalTemple_ChosenInWorldAbductionArea(_OldState);




PROC
PROC_LOW_BhaalTemple_ClearDB_ChosenInWorldAbductionPos()
AND
DB_LOW_BhaalTemple_ChosenInWorldAbductionPos(_PrevVal)
THEN
NOT DB_LOW_BhaalTemple_ChosenInWorldAbductionPos(_PrevVal);


PROC
PROC_LOW_BhaalTemple_ClearDB_VictimSpotFound()
AND
DB_LOW_BhaalTemple_VictimSpotFound(_PrevVal)
THEN
NOT DB_LOW_BhaalTemple_VictimSpotFound(_PrevVal);


PROC
PROC_LOW_BhaalTemple_ClearDB_Allies_DuelPos()
AND
DB_LOW_BhaalTemple_Allies_DuelPos(_Pos, 1)
THEN
NOT DB_LOW_BhaalTemple_Allies_DuelPos(_Pos, 1);
DB_LOW_BhaalTemple_Allies_DuelPos(_Pos, 0);

//END_REGION


//REGION DEBUG Misc OEs
IF
TextEvent("BTResetMainDoor")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTResetMainDoor");
PROC_LOW_BhaalTemple_MainDoor_Init();


IF
TextEvent("BTOrinSpottingStart")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTOrinSpottingStart");
PROC_LOW_BhaalTemple_OrinSpotting_Started();

IF
TextEvent("BTOrinSpottingStop")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTOrinSpottingStop");
PROC_LOW_BhaalTemple_OrinSpotting_Stopped();

IF
TextEvent("BTForceOpenDoor")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTForceOpenDoor");
PROC_LOW_BhaalTemple_OpenDoor();
//Open((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2);

IF
TextEvent("BTForceOpenDoor2")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTForceOpenDoor2");
//SetCanInteract((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, 0);
Open((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2);

IF
TextEvent("BTForceCloseDoor")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTForceCloseDoor");
//SetCanInteract((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, 1);
Close((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2);

IF
TextEvent("BTForceCloseDoor2")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTForceCloseDoor2");
PROC_LOW_BhaalTemple_CloseDoor();


IF
TextEvent("BTAltarEnable")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTAltarEnable");
PROC_ItemCloseAndLock(S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2, "NeedBhaalAmulet");
PROC_LOW_BhaalTemple_Altar_Enable();

IF
TextEvent("BTAbducteeAwakenStandby")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTAbducteeAwakenStandby");
PROC_LOW_BhaalTemple_AbducteeAwaken_Standby();

IF
TextEvent("BTSetupDefaultVictim")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTSetupDefaultVictim");
PROC_LOW_BhaalTemple_SetupDefaultVictim();
PROC_GEN_OrinsAbduction_DisableAllImpersonations(); // disappear all other impersonations/abduction now that the door is opened.

IF
TextEvent("BTConfrontationWyll")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTConfrontationWyll");
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_SparedIsobelWithWyll_150efcb9-0b87-4fbf-af6c-44fa3292fab7);

IF
TextEvent("BTConfrontationGale")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTConfrontationGale");
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_SparedIsobelWithGale_a318c0cd-f261-41c9-88c9-3cddceb477b7);

IF
TextEvent("BTConfrontationKarlach")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTConfrontationKarlach");
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_SparedIsobelWithKarlach_40ad195b-2fa2-492d-9fc5-359fb363c65d);
//END_REGION

//REGION DEBUG checking DBs.
IF
TextEvent("BTCheckAvatarsDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "Check Avatars DB");
PROC_LOW_BhaalTemple_CheckAvatarsDB();

PROC
PROC_LOW_BhaalTemple_CheckAvatarsDB()
AND
DB_Avatars(_Char)
AND
GUIDToString(_Char, _ReturnString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _ReturnString);



IF
TextEvent("BTCheckAbductionPossibleAreaDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "Check AbductionPossibleArea DB");
PROC_LOW_BhaalTemple_CheckAbductionPossibleAreaDB();

PROC
PROC_LOW_BhaalTemple_CheckAbductionPossibleAreaDB()
AND
DB_LOW_BhaalTemple_AbductionPossibleArea(_Player, _AbductionArea, _AbductionPos)
AND
GUIDToString(_Player, _ToString)
AND
Concatenate(": ", _ToString, _ReturnString)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, _ReturnString);


IF
TextEvent("BTCheckAbducteeFlag")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "Check BTCheckAbducteeFlag DB");
PROC_LOW_BhaalTemple_CheckBTCheckAbducteeFlagDB();

PROC
PROC_LOW_BhaalTemple_CheckBTCheckAbducteeFlagDB()
AND
DB_GEN_OrinsAbduction_ChosenCharFlag(_CharFlag)
AND
GUIDToString(_CharFlag, _FlagString)
AND
Concatenate(": ", _FlagString, _ReturnString)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, _ReturnString);



IF
TextEvent("BTCheckAbducteeRescuer")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "Check BTCheckAbducteeRescuer DB");
PROC_LOW_BhaalTemple_CheckBTCheckAbducteeRescuer();

PROC
PROC_LOW_BhaalTemple_CheckBTCheckAbducteeRescuer()
AND
DB_LOW_BhaalTemple_AbducteeRescuer(_Char)
AND
GUIDToString(_Char, _CharString)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, _CharString);


IF
TextEvent("BTCheckStateDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTCheckStateDB");
PROC_LOW_BhaalTemple_BTCheckStateDB();

PROC
PROC_LOW_BhaalTemple_BTCheckStateDB()
AND
DB_LOW_BhaalTemple_CurrentState(_String)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _String);


IF
TextEvent("BTCheckVictimsOnAltarDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTCheckVictimsOnAltarDB");
PROC_LOW_BhaalTemple_CheckVictimsOnAltarDB();

PROC
PROC_LOW_BhaalTemple_CheckVictimsOnAltarDB()
AND
DB_LOW_BhaalTemple_VictimsOnAltar(_Char)
AND
GUIDToString(_Char, _ReturnString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _ReturnString);


IF
TextEvent("BTCheckChosenInWorldAbductionAreaDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTCheckChosenInWorldAbductionAreaDB");
PROC_LOW_BhaalTemple_CheckChosenInWorldAbductionAreaDB();

PROC
PROC_LOW_BhaalTemple_CheckChosenInWorldAbductionAreaDB()
AND
DB_LOW_BhaalTemple_ChosenInWorldAbductionArea(_Char)
AND
GUIDToString(_Char, _ReturnString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _ReturnString);


IF
TextEvent("BTCheckDuelPos_OriDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "Check BTCheckDuelPos DB");
PROC_LOW_BhaalTemple_CheckAllies_DuelPosDB();

PROC
PROC_LOW_BhaalTemple_CheckAllies_DuelPosDB()
AND
DB_LOW_BhaalTemple_Allies_DuelPos(_Pos, _Int)
AND
GUIDToString(_Pos, _PosReturnString)
AND
IntegerToString(_Int, _IntReturnString)
AND
Concatenate(_PosReturnString, _IntReturnString, _ReturnString)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, _ReturnString);


//END_REGION

//REGION DEBUG flag settings.
IF
TextEvent("BTSetAllFlags")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTSetAllFlags");
PROC_GlobalSetFlagAndCache(LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729);
PROC_GlobalSetFlagAndCache(LOW_MurderTribunal_Sarevok_State_Dead_e9d30711-af25-4ba9-813e-cc7c131b17b6);
PROC_GlobalSetFlagAndCache(GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769);
//PROC_GlobalSetFlagAndCache(LOW_UndercityRuins_State_WarnedOrin_b0c28b3f-e8e7-44ab-8bcd-81691bfb089a);
PROC_GlobalSetFlagAndCache(ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3); 

IF
TextEvent("BTSetAbducteeYenna")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTSetAbducteeYenna");
PROC_GlobalSetFlagAndCache(LOW_BhaalTemple_State_AbducteeIsYenna_fa8d1e59-26d5-4ad6-9706-1cb15a5cdb0a);

IF
TextEvent("BTSetAbducteeFriend")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTSetAbducteeFriend");
PROC_GlobalSetFlagAndCache(LOW_BhaalTemple_State_AbducteeIsFriend_dd552cb0-4429-4bc9-849c-85fb611124bd);

IF
TextEvent("BTSetAbducteeRomance")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTSetAbducteeRomance");
PROC_GlobalSetFlagAndCache(LOW_BhaalTemple_State_AbducteeIsRomance_115d7115-c924-485f-8b76-3e13d661f4e5);


//END_REGION

//REGION DEBUG PROCs
IF
TextEvent("BTEnableAbduction") // same as OAEnableAbduction in Ac3_GEN_OrinsAbduction, but keeping it for backward compatibility since people might already be familar with it.
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTEnableAbduction");
PROC_GEN_OrinsAbduction_Debug_EnableAbduction();

IF
TextEvent("BTStartDefault")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTStartDefault");
PROC_LOW_BhaalTemple_Debug_StartDefault();

PROC
PROC_LOW_BhaalTemple_Debug_StartDefault()
AND
GetHostCharacter(_Player)
THEN
PROC_GEN_OrinsAbduction_Debug_EnableAbduction();
//PROC_LOW_BhaalTemple_Debug_SetWarnedOrin();
PROC_LOW_BhaalTemple_Debug_GiveBhaalAmulet();
//PROC_LOW_BhaalTemple_Debug_EnableWithers();
PROC_GEN_OrinsAbduction_Debug_SetKilledGortash();


IF
TextEvent("BTEnableWithers") // Put Withers in Camp in case Dark Urge needs to resurrect players who choose to resist Bhaal and therefore die.
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTEnableWithers");
PROC_LOW_BhaalTemple_Debug_EnableWithers();

PROC
PROC_LOW_BhaalTemple_Debug_EnableWithers()
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_BhaalTemple_Withers_ResurrectsPlayers();
// this is suppose to be similar to TextEvent("CAMP_JergalToCamp") in GLO_Jergal for debugging purposes.
//PROC_GLO_Jergal_MoveToCamp();
//PROC_GLO_Jergal_Appear();

IF
TextEvent("BTGiveBhaalAmulet") // Grab the Bhaal Amulet from Sarevok, and give to players for debugging purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTGiveBhaalAmulet");
PROC_LOW_BhaalTemple_Debug_GiveBhaalAmulet();

PROC
PROC_LOW_BhaalTemple_Debug_GiveBhaalAmulet()
AND
GetHostCharacter(_Player)
THEN
//Unequip((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6, S_LOW_MurderTribunal_BhaalAmulet_Sarevok_305049b2-b725-4e84-8f47-84fac8ea51f1);
ToInventory((ITEM)S_LOW_MurderTribunal_BhaalAmulet_Sarevok_305049b2-b725-4e84-8f47-84fac8ea51f1, _Player);


IF
TextEvent("BTGiveAltarKey") // Grab the Bhaal Amulet from Sarevok, and give to players for debugging purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTGiveAltarKey");
PROC_LOW_BhaalTemple_Debug_GiveAltarKey();

PROC
PROC_LOW_BhaalTemple_Debug_GiveAltarKey()
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_LOW_BhaalTemple_AltarKey_c817c1c6-fd0e-41d8-9750-93dfe0e85c92, _Player);

IF
TextEvent("BTGiveNetherstone") // Give Orin the netherstone.
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTGiveNetherstone");
PROC_GEN_OrinsAbduction_GiveStone((CHARACTER)_Player);


IF
TextEvent("BTGiveDUSlayerForm")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTGiveDUSlayerForm");
PROC_LOW_BhaalTemple_Debug_DUGivenSlayerForm();

PROC
PROC_LOW_BhaalTemple_Debug_DUGivenSlayerForm()
THEN
PROC_GlobalSetFlagAndCache(ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3); 

IF
TextEvent("BTRemoveSlayerForm")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTRemoveSlayerForm");
PROC_GlobalClearFlagAndCache((FLAG)ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3);



IF
TextEvent("BTSetWarnedOrin")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTSetWarnedOrin");
PROC_LOW_BhaalTemple_Debug_SetWarnedOrin();

PROC
PROC_LOW_BhaalTemple_Debug_SetWarnedOrin()
THEN
DB_NOOP(1);
//PROC_GlobalSetFlagAndCache(LOW_UndercityRuins_State_WarnedOrin_b0c28b3f-e8e7-44ab-8bcd-81691bfb089a);


IF
TextEvent("BTSetKilledGortash") // kept for backward compatibility
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTSetKilledGortash");
PROC_GEN_OrinsAbduction_Debug_SetKilledGortash();



IF
TextEvent("BTSetKilledSarevok")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTSetKilledSarevok");
PROC_LOW_BhaalTemple_Debug_SetKilledSarevok();

PROC
PROC_LOW_BhaalTemple_Debug_SetKilledSarevok()
THEN
PROC_GlobalSetFlagAndCache(LOW_MurderTribunal_Sarevok_State_Dead_e9d30711-af25-4ba9-813e-cc7c131b17b6);


IF
TextEvent("BTSetUnholyAssassin")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTUnholyAssassin");
PROC_LOW_BhaalTemple_Debug_SetUnholyAssassin();

PROC
PROC_LOW_BhaalTemple_Debug_SetUnholyAssassin()
THEN
PROC_GlobalSetFlagAndCache(LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729);


IF
TextEvent("BTGoAbductionArea1")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction1();

PROC
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction1()
THEN
PROC_TeleportPartiesTo(S_Debug_Teleport_LOW_Guildhall_f9341da6-8022-448d-b886-47a6560d0b54, ""); // trigger is already global.

IF
TextEvent("BTGoAbductionArea2")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction2();

PROC
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction2()
THEN
PROC_TeleportPartiesTo(S_Teleport_SewerToKots_087bb1f2-8178-4c6e-aeef-b48dc204bd72, ""); // made it global.

IF
TextEvent("BTGoAbductionArea3")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction3();

PROC
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction3()
THEN
PROC_TeleportPartiesTo(TeleportTrigger_Sewer_CazadorSecret_1e3afc1e-b3ff-488d-8517-5941a61c5a9a, ""); // made it global.

IF
TextEvent("BTGoAbductionArea4")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction4();

PROC
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction4()
THEN
PROC_TeleportPartiesTo(S_Debug_LOW_AbandonedCisternInterior_a22cef19-7eaa-4611-b5cc-79b6b95bc90e, ""); // trigger is already global.


IF
TextEvent("BTJumpToOrinHumanCombat")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTJumpToOrinHumanCombat");
PROC_LOW_BhaalTemple_Debug_DUGivenSlayerForm();
PROC_Debug_LOW_BhaalTemple_JumpToOrinCombat();

IF
TextEvent("BTJumpToOrinCombat")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTJumpToOrinCombat");
PROC_Debug_LOW_BhaalTemple_JumpToOrinCombat();

PROC
PROC_Debug_LOW_BhaalTemple_JumpToOrinCombat()
THEN
PROC_LOW_BhaalTemple_Debug_StartDefault();
PROC_LOW_BhaalTemple_OpenDoor();
PROC_LOW_BhaalTemple_OrinSpotting_Stopped();
PROC_LOW_BhaalTemple_AdmireKill_Disable(); // disables the trigger area for playing ADs for the admiring the kills NPC
PROC_TeleportPartiesTo(S_Debug_Teleport_LOW_BhaalTemple_Inner_86321aa0-40d0-4244-982d-f1da2709726d, "LOW_BhaalTemple_Debug_ArrivedInTemple");

IF
EntityEvent(_, "LOW_BhaalTemple_Debug_ArrivedInTemple")
AND
QRY_OnlyOnce("LOW_BhaalTemple_Debug_ArrivedInTemple")
THEN
PROC_Debug_LOW_BhaalTemple_StartBattle();

PROC
PROC_Debug_LOW_BhaalTemple_StartBattle()
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
THEN
PROC_LOW_BhaalTemple_OrinDuel_Start();
PROC_LOW_BhaalTemple_Abductee_WakeUp(); // wakes up the abductee and removes the KNOCKOUT status
PROC_GEN_OrinsAbduction_YennaImmortality_Reset(); // reset her immortality - assuming she's still alive

PROC
PROC_Debug_LOW_BhaalTemple_StartBattle()
AND
NOT QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
THEN
PROC_LOW_BhaalTemple_OrinNonDuel_Start();
PROC_LOW_BhaalTemple_Abductee_WakeUp(); // wakes up the abductee and removes the KNOCKOUT status
PROC_GEN_OrinsAbduction_YennaImmortality_Reset(); // reset her immortality - assuming she's still alive

IF
TextEvent("BTRemoveOrinSlayerFormCombat")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTRemoveOrinSlayerFormCombat");
PROC_LOW_BhaalTemple_Debug_RemoveOrinSlayerForm();

PROC
PROC_LOW_BhaalTemple_Debug_RemoveOrinSlayerForm()
AND
HasActiveStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BHAALTEMPLE_ORINSLAYER", 1)
THEN
RemoveStatus((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BHAALTEMPLE_ORINSLAYER", (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);


IF
TextEvent("BTJumpToConfrontationFight")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTJumpToConfrontationFight");
PROC_LOW_BhaalTemple_Debug_StartDefault();
PROC_LOW_BhaalTemple_OpenDoor();
PROC_LOW_BhaalTemple_OrinSpotting_Stopped();
PROC_LOW_BhaalTemple_AdmireKill_Disable(); // disables the trigger area for playing ADs for the admiring the kills NPC
PROC_TeleportPartiesTo(S_Debug_Teleport_LOW_BhaalTemple_Inner_86321aa0-40d0-4244-982d-f1da2709726d, "LOW_BhaalTemple_Debug_ArrivedInTemple_Combat");

IF
EntityEvent(_, "LOW_BhaalTemple_Debug_ArrivedInTemple_Combat")
AND
QRY_OnlyOnce("LOW_BhaalTemple_Debug_ArrivedInTemple_Combat")
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
//PROC_LOW_BhaalTemple_OrinDuel_Start();

//PROC_LOW_BhaalTemple_Duel_Orin_Setup();
//PROC_LOW_BhaalTemple_Duel_DarkUrge_Setup();
//PROC_LOW_BhaalTemple_Duel_Allies_Setup();
//PROC_LOW_BhaalTemple_Duel_Arena_Setup();
PROC_LOW_BhaalTemple_ObservationSpot_NonCombat();
PROC_LOW_BhaalTemple_ObservationSpot_Combat();
PROC_LOW_BhaalTemple_Abductee_WakeUp(); // wakes up the abductee and removes the KNOCKOUT status
PROC_GEN_OrinsAbduction_YennaImmortality_Reset(); // reset her immortality - assuming she's still alive

PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235);

//Die(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, DEATHTYPE.DoT, _DarkUrge, 1, 0);

DB_LOW_BhaalTemple_CurrentState("PostCombat");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575); // set the flag to indicate that players have defeated Orin and her combat minions

PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_BhaalAccepted_904c45e0-bb06-40ed-b5d7-4f1c851b9d86);

PROC_LOW_BhaalTemple_Confrontation_Setup();

PROC_TeleportPartiesTo((TRIGGER)S_LOW_BhaalTemple_MapMarker_Door_1fbd7ac6-c15d-4c3e-93e8-f9bff39ed7c0, "LOW_BhaalTemple_Debug_JumpToConfrontation_Combat");

IF
EntityEvent(_, "LOW_BhaalTemple_Debug_JumpToConfrontation_Combat")
AND
QRY_OnlyOnce("LOW_BhaalTemple_Debug_JumpToConfrontation_Combat")
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
PROC_LOW_BhaalTemple_OpenDoor();
//PROC_LOW_BhaalTemple_Confrontation_StartCombat((CHARACTER)_DarkUrge);
//DB_NOOP(1);

//END_REGION

//REGION DEBUG book
IF // Path Resist Orin
FlagSet((FLAG)Debug_LOW_BhaalTemple_PathResistOrin_26e6310f-420f-4544-8206-a08484c6306f,_,_)
THEN
ClearFlag((FLAG)Debug_LOW_BhaalTemple_PathResistOrin_26e6310f-420f-4544-8206-a08484c6306f);
PROC_GEN_OrinsAbduction_Debug_EnableAbduction();
//PROC_LOW_BhaalTemple_Debug_SetWarnedOrin();
PROC_LOW_BhaalTemple_Debug_GiveBhaalAmulet();
//PROC_LOW_BhaalTemple_Debug_EnableWithers();

IF // Path Evil/Violent
FlagSet((FLAG)Debug_LOW_BhaalTemple_PathEvilViolent_360527e0-921d-4f84-af20-2bd89c777eba,_,_)
THEN
ClearFlag((FLAG)Debug_LOW_BhaalTemple_PathEvilViolent_360527e0-921d-4f84-af20-2bd89c777eba);
PROC_Debug_LOW_BhaalTemple_PathEvilViolent();

PROC
PROC_Debug_LOW_BhaalTemple_PathEvilViolent()
THEN
PROC_GEN_OrinsAbduction_Debug_EnableAbduction();
PROC_GEN_OrinsAbduction_Debug_SetKilledGortash();
PROC_LOW_BhaalTemple_Debug_SetKilledSarevok();
PROC_LOW_BhaalTemple_Debug_SetUnholyAssassin();
//PROC_LOW_BhaalTemple_Debug_EnableWithers();


IF // Enable Abduction
FlagSet((FLAG)Debug_LOW_BhaalTemple_EnableAbduction_0eb49187-311c-4fdd-866a-9901f35926c6,_,_)
THEN
ClearFlag((FLAG)Debug_LOW_BhaalTemple_EnableAbduction_0eb49187-311c-4fdd-866a-9901f35926c6);
PROC_GEN_OrinsAbduction_Debug_EnableAbduction();

IF // Sentinels warned
FlagSet((FLAG)Debug_LOW_BhaalTemple_SentinelsWarnedOrin_6e6e5e58-0d23-4924-948f-7b9fc3a832e0,_,_)
THEN
DB_NOOP(1);
//ClearFlag((FLAG)Debug_LOW_BhaalTemple_SentinelsWarnedOrin_6e6e5e58-0d23-4924-948f-7b9fc3a832e0);
//PROC_LOW_BhaalTemple_Debug_SetWarnedOrin();

IF // Killed Gortash
FlagSet((FLAG)Debug_LOW_BhaalTemple_KilledGortash_ee1d03d6-5bf0-461e-a3d9-7c0af674029f,_,_)
THEN
ClearFlag((FLAG)Debug_LOW_BhaalTemple_KilledGortash_ee1d03d6-5bf0-461e-a3d9-7c0af674029f);
PROC_GEN_OrinsAbduction_Debug_SetKilledGortash();

IF // Killed Sarevok
FlagSet((FLAG)Debug_LOW_BhaalTemple_KilledSarevok_240e212c-81bd-4b75-9bcf-449c119b2d73,_,_)
THEN
ClearFlag((FLAG)Debug_LOW_BhaalTemple_KilledSarevok_240e212c-81bd-4b75-9bcf-449c119b2d73);
PROC_LOW_BhaalTemple_Debug_SetKilledSarevok();

IF // Became Unholy Assassin
FlagSet((FLAG)Debug_LOW_BhaalTemple_BecameUnholyAssasin_f66442bf-6e74-468a-9e64-c754293b62f0,_,_)
THEN
ClearFlag((FLAG)Debug_LOW_BhaalTemple_BecameUnholyAssasin_f66442bf-6e74-468a-9e64-c754293b62f0);
PROC_LOW_BhaalTemple_Debug_SetUnholyAssassin();

IF // Orin doesn't have Slayer form
FlagSet((FLAG)Debug_LOW_BhaalTemple_DUGivenSlayerForm_969ddf4a-a062-41a1-88c2-0bcfee3b3c1b,_,_)
THEN
ClearFlag((FLAG)Debug_LOW_BhaalTemple_DUGivenSlayerForm_969ddf4a-a062-41a1-88c2-0bcfee3b3c1b);
PROC_LOW_BhaalTemple_Debug_DUGivenSlayerForm();

IF // Give players Bhaal Amulet
FlagSet((FLAG)Debug_LOW_BhaalTemple_GiveBhaalAmulet_7e06357c-a95e-4bec-8804-347cb0fb841a,_,_)
THEN
ClearFlag((FLAG)Debug_LOW_BhaalTemple_GiveBhaalAmulet_7e06357c-a95e-4bec-8804-347cb0fb841a);
PROC_LOW_BhaalTemple_Debug_GiveBhaalAmulet();

IF // Reset all flags above.
FlagSet((FLAG)Debug_LOW_BhaalTemple_ResetFlags_3eb8c782-175b-4687-870d-fe1875ce2931,_,_)
THEN
ClearFlag((FLAG)Debug_LOW_BhaalTemple_ResetFlags_3eb8c782-175b-4687-870d-fe1875ce2931);
PROC_GlobalClearFlagAndCache(LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75);
//PROC_GlobalClearFlagAndCache(LOW_UndercityRuins_State_WarnedOrin_b0c28b3f-e8e7-44ab-8bcd-81691bfb089a);
PROC_GlobalClearFlagAndCache(GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769);
PROC_GlobalClearFlagAndCache(LOW_MurderTribunal_Sarevok_State_Dead_e9d30711-af25-4ba9-813e-cc7c131b17b6);
PROC_GlobalClearFlagAndCache(LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729);
PROC_GlobalClearFlagAndCache(ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3);

IF
FlagSet((FLAG)Debug_LOW_BhaalTemple_InWorldAbduction_1_47426717-bfab-4644-99cf-d1533cfe9c5b,_,_)
THEN
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction1();

IF
FlagSet((FLAG)Debug_LOW_BhaalTemple_InWorldAbduction_2_88f4d536-e819-44f1-a355-3149fdb15396,_,_)
THEN
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction2();

IF
FlagSet((FLAG)Debug_LOW_BhaalTemple_InWorldAbduction_3_ce6ef184-c164-44e6-9a20-8a8203f81aa0,_,_)
THEN
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction3();

IF
FlagSet((FLAG)Debug_LOW_BhaalTemple_InWorldAbduction_4_24a9d7c2-7467-44cf-846a-aa68d8918f4a,_,_)
THEN
PROC_LOW_BhaalTemple_Debug_GoInWorldAbduction4();


//END_REGION

//REGION DEBUG For testing stuff
IF
TextEvent("BTOrinMotherAnim1")
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTOrinMotherAnim1");
PROC_PlayLoopingAnimation(S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e,(ANIMATION)NULL_00000000-0000-0000-0000-000000000000,(ANIMATION)DIE_Generic_Deathpose_01_eecf9fb5-6669-4ed0-8a44-d5e3762d0a05,(ANIMATION)NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("BTOrinMotherAnim2")
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTOrinMotherAnim2");
PROC_PlayLoopingAnimation(S_LOW_BhaalTemple_OrinsMother_178bc423-a543-4cf9-99cb-ef4e93a1056e,(ANIMATION)NULL_00000000-0000-0000-0000-000000000000,(ANIMATION)DIE_Generic_KO_01_8145f891-e1f3-4510-b166-d974ef1c3896,(ANIMATION)NULL_00000000-0000-0000-0000-000000000000);


// Debugging the DU transform bug.
IF
TextEvent("BTForceTransformOrinToDU")
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTForceTransformOrinToDU");
PROC_LOW_BhaalTemple_Orin_Inventory_Save();
DB_GEN_OrinsAbduction_IsTransformed(1);
Transform(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _DarkUrge, DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);
CopyCharacterEquipment(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _DarkUrge);

IF
TextEvent("BTForceTransformOrinToHerself")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTForceTransformOrinToHerself");
PROC_GEN_OrinsAbduction_Orin_RemoveAllItems();
PROC_LOW_BhaalTemple_Orin_Inventory_Restore();
RemoveTransforms(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);


// Debugging the DU transform bug.
IF
TextEvent("BTTransformDummy1")
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_Players((CHARACTER)_DarkUrge)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTTransformDummy1");
TeleportTo(S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, _Char,"",0,0,0,1,1);
Transform(S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, (CHARACTER)_DarkUrge, DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);
CopyCharacterEquipment(S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, (CHARACTER)_DarkUrge);

IF
TextEvent("BTTransformDummy2")
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_Players((CHARACTER)_DarkUrge)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTTransformDummy2");
TeleportTo(S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, _Char,"",0,0,0,1,1);
Transform(S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, (CHARACTER)_DarkUrge, DISGUISE_WITH_CUSTOM_LOOKS_8194cfb6-4199-46d2-9027-613c302352aa);
CopyCharacterEquipment(S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4, (CHARACTER)_DarkUrge);

IF
TextEvent("BTRemoveTransformDummy")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTRemoveTransformDummy");
RemoveTransforms(S_LOW_BhaalTemple_OrinDarkUrgeDummy_34bec6b6-80e9-47f6-9735-5bc1525241b4);

IF
TextEvent("BTInTempleFlagSet")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTInTempleFlagSet");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2);

IF
TextEvent("BTInTempleFlagClear")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTInTempleFlagClear");
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2);

IF
TextEvent("BTForceVictimRunAway")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTForceVictimRunAway");
PROC_LOW_BhaalTemple_AbducteeAwaken_Setup();

IF
TextEvent("BTForceVictimJoin")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTForceVictimJoin");
PROC_LOW_BhaalTemple_AbducteeAwaken_Joins();

IF
TextEvent("BTForceRepeatPostCombatDialog")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTForceRepeatPostCombatDialog");
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("No");

IF
TextEvent("BTGetOrinsVictims") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTGetOrinsVictims");
PROC_LOW_BhaalTemple_GetOrinsVictims();

IF
TextEvent("BTForceConfrontationDialogDU") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTForceConfrontationDialogDU");
//PROC_LOW_BhaalTemple_Confrontation_StartDialogDU(_Player);

IF
TextEvent("BTOrinInvSave") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTOrinInvSave");
PROC_LOW_BhaalTemple_Orin_Inventory_Save();

IF
TextEvent("BTOrinInvRestore") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTOrinInvRestore");
PROC_LOW_BhaalTemple_Orin_Inventory_Restore();

IF
TextEvent("BTClearAlliesDuelPosDB") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTClearAlliesDuelPosDB");
PROC_LOW_BhaalTemple_ClearDB_Allies_DuelPos();

IF
TextEvent("BTTestQRYPos")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTTestQRYPos");
PROC_LOW_BhaalTemple_Duel_Allies_Setup();

IF
TextEvent("BTDuelStatusApply")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTDuelStatusApply");
PROC_LOW_BhaalTemple_Duel_DarkUrgeFaction_Apply();

IF
TextEvent("BTDuelStatusRemove")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTDuelStatusRemove");
PROC_LOW_BhaalTemple_Duel_DarkUrgeFaction_RemoveStatus();

IF
TextEvent("BTTryBreakDuelAD")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTTryBreakDuelAD");
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_02_AD_DarkUrgeDuel_64b28fd5-33e9-87ab-db2a-7d8dd40be23f);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_DeathsHead_02_AD_DarkUrgeDuel_64b28fd5-33e9-87ab-db2a-7d8dd40be23f, (CHARACTER)S_LOW_BhaalTemple_DeathsHead_02_adf3d591-4442-4543-86fd-9ca5b1cb73d2);

IF
TextEvent("BTResumeOrinCombat")
AND
DB_Is_InCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CombatID)
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTResumeOrinCombat");
ResumeCombat(_CombatID);
PROC_LOW_BhaalTemple_OrinTransformIntoSlayer();	// see if she can transform into the slayer

IF
TextEvent("BTGuildHallDuringCoupSet")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTGuildHallDuringCoupSet");
PROC_GlobalSetFlagAndCache(LOW_Guildhall_State_DuringCoup_6dba56a5-8220-41f4-8849-085e38b80d4e);

IF
TextEvent("BTGuildHallDuringCoupClear")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTGuildHallDuringCoupClear");
PROC_GlobalClearFlagAndCache(LOW_Guildhall_State_DuringCoup_6dba56a5-8220-41f4-8849-085e38b80d4e);

IF
TextEvent("BTButlerSpottingStart")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTButlerSpottingStart");
PROC_LOW_BhaalTemple_ButlerSpotting_Started();

IF
TextEvent("OACheckOwner")
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_PartyMembers(_Member)
AND
GUIDToString(_Member, _MemberStr)
AND
CharacterGetOwner((CHARACTER)_Member, _DarkUrge)
THEN
DebugText(_DarkUrge, _MemberStr);

IF
TextEvent("OASteerTo")
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_PartyMembers(_Member)
AND
GUIDToString(_Member, _MemberStr)
AND
CharacterGetOwner((CHARACTER)_Member, _DarkUrge)
THEN
DebugText(_DarkUrge, _MemberStr);

IF
TextEvent("BTForceUpdateStart")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTForceUpdateStart");
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Start();

IF
TextEvent("BTForceUpdateStop")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTForceUpdateStop");
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Stop();
//END_REGION

EXITSECTION
PROC_StopLoopEffect(VFX_Script_Bhaals_Blood_Droplets_Root_01_437788a3-d32b-1b63-26d7-0ae76c67daa2, "LOW_BhaalTemple_DarkUrgeSacrificeSign");
ENDEXITSECTION
ParentTargetEdge "Act3b"
