Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Tadpole Transport

DB_LOW_TadpoleTransport_IllusionCrates((ITEM)S_LOW_TadpoleTransport_SolidCrate01_9c036c50-d32e-4e32-8ccd-eaec2dac7620, (ITEM)S_LOW_TadpoleTransport_IllusionCrate01_cb6fff7f-d315-444c-a5cb-893ac108d400, "LOW_TadpoleTransport_Illusion01");
DB_LOW_TadpoleTransport_IllusionCrates((ITEM)S_LOW_TadpoleTransport_SolidCrate02_c45b7032-f2c8-4754-81f5-a279d26f2268, (ITEM)S_LOW_TadpoleTransport_IllusionCrate02_ef9ed584-09c0-4c64-95ea-b0a24720ac39, "LOW_TadpoleTransport_Illusion02");

PROC_SetOnStage((ITEM)S_LOW_TadpoleTransport_Nursery_0dceaf04-93ff-41dd-8497-3dd833f30527, 0);

DB_KnowledgeCheckTrigger("LOW_TadpoleTransport_IllusionCrate", (TRIGGER)S_LOW_TadpoleTransport_RevealTrigger_d5033d7f-bde4-4d4d-a748-da0ef4ff5c5a, "Investigation", (DIFFICULTYCLASS)Act3_Hard_6298329e-255c-4826-9209-e911873b64e7);

DB_LOW_TadpoleTransport_Steelwatch((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab);
DB_LOW_TadpoleTransport_Steelwatch((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7);

DB_LOW_TadpoleTransport_TrespassingArea((TRIGGER)S_LOW_TadpoleTransport_TrespassingArea_77dfa551-a69f-4080-9b2a-fbb053ae026e);
DB_LOW_TadpoleTransport_TrespassingArea((TRIGGER)S_LOW_TadpoleTransport_TrespassingArea01_a0d2034e-05fe-4693-9561-fc07e01d62ab);

PROC_LOW_TadpoleTransport_GetTadpoles();

DB_SpotPlayers((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab,  "LOW_TadpoleTransport_Warning01", (TRIGGER)S_LOW_TadpoleTransport_Steelwatch01WarningTrigger_d126257c-f206-45de-ab87-b0eb0acab775);
DB_SpotPlayers_Continuous((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01");
DB_SpotPlayers_SpotterIgnoreCantTalk((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01");
DB_SpotPlayers_TargetIgnoreCantTalk((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01");

DB_LOW_TadpoleTransport_SpottingEvents("LOW_TadpoleTransport_Warning01");
DB_LOW_TadpoleTransport_SpottingEvents("LOW_TadpoleTransport_Warning02");

DB_ItemDialog_NarratorAD((ITEM)S_LOW_TadpoleTransport_WarningBoard01_a0b442a4-f3a0-424f-9d9d-045ca36a188e, LOW_TadpoleTransport_AD_WarningMessage_806352da-b7f9-e521-736f-8c6eec8f5d56);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_TadpoleTransport_WarningBoard02_0170544a-a3e3-4000-9437-07f50c091c5e, LOW_TadpoleTransport_AD_WarningMessage_806352da-b7f9-e521-736f-8c6eec8f5d56);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_TadpoleTransport_WarningBoard03_dce8e4ca-c2bd-4c0d-873c-3335b7c0bd83, LOW_TadpoleTransport_AD_WarningMessage_806352da-b7f9-e521-736f-8c6eec8f5d56);

DB_GLO_SteelWatchers_CustomDialog((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab);
DB_GLO_SteelWatchers_CustomDialog((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7);

DB_Dialogs((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, LOW_TadpoleTransport_SteelwatchGuard_3aa5043d-a64f-cff9-6621-267ee5d47763);
DB_Dialogs((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7, LOW_TadpoleTransport_SteelwatchGuard_3aa5043d-a64f-cff9-6621-267ee5d47763);

DB_FlagReactionAfterDialog(LOW_TadpoleTransport_TeleportOut_9fe0eaf6-ebe9-ae9e-789b-1378925ec2df, (DIALOGRESOURCE)LOW_TadpoleTransport_SteelwatchGuard_3aa5043d-a64f-cff9-6621-267ee5d47763);
//END_REGION

//REGION Plague Ship

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_PlagueShip_PlagueTrigger_5809f660-a69c-4df2-9496-e313dfba2387);

DB_ItemDialog_NarratorAD((ITEM)S_LOW_PlagueShip_WarningBoard_03339d31-e5e8-4f29-89a2-e308841b5aec, LOW_PlagueShip_AD_WarningMessage_223e7f74-a60c-22e8-accf-33efd1a161c3);

PROC_SetOnStage((CHARACTER)S_LOW_PlagueShip_CursedImp_008b019e-5e7d-456a-8697-656f8ca8f241, 0);

PROC_ClearCorpseOwner((CHARACTER)S_LOW_PlagueShip_Sailor01_37851910-ea52-443c-9fad-695730890756);
PROC_ClearCorpseOwner((CHARACTER)S_LOW_PlagueShip_Sailor02_a9d746ea-8ad6-49c2-b764-807fd0bd13ee);
PROC_ClearCorpseOwner((CHARACTER)S_LOW_PlagueShip_Sailor03_038269e1-3ad8-4af4-8d42-2b1654049b32);
PROC_ClearCorpseOwner((CHARACTER)S_LOW_PlagueShip_Sailor04_178b3c97-ac8c-41b2-8f0c-c1135534af6c);

//END_REGION
KBSECTION
//REGION Tadpole Transport

// Illusion crates handling
IF
DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate, _IllusionCrate,_)
THEN
PROC_SetOnStage(_IllusionCrate, 0);
PROC_SetOnStage(_SolidCrate, 1);

PROC
PROC_BlockUseOfItem(_Character, _SolidCrate)
AND
DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate, _,_)
THEN
DB_CustomUseItemResponse(_Character, _SolidCrate, 0);
PROC_LOW_TadpoleTransport_RevealIllusion();

PROC
PROC_BlockPickupOfItem(_Character, _SolidCrate)
AND
DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate, _,_)
THEN
DB_CustomPickupItemResponse(_Character, _SolidCrate, 0);
PROC_LOW_TadpoleTransport_RevealIllusion();

PROC
PROC_BlockMoveOfItem(_Character, _SolidCrate)
AND
DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate, _,_)
THEN
DB_CustomMoveItemResponse(_Character, _SolidCrate, 0);
PROC_LOW_TadpoleTransport_RevealIllusion();

IF
AttackedBy((ITEM)_SolidCrate,_Attacker,_,_DamageType,_DamageAmount,_,_)
AND
DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate, _,_)
THEN
PROC_LOW_TadpoleTransport_RevealIllusion();
ApplyDamage(S_LOW_TadpoleTransport_Nursery_0dceaf04-93ff-41dd-8497-3dd833f30527, _DamageAmount, _DamageType, _Attacker);

IF
Moved(_SolidCrate)
AND
DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate, _,_)
THEN
PROC_LOW_TadpoleTransport_RevealIllusion();

IF
FlagSet((FLAG)LOW_TadpoleTransport_State_IllusionRevealed_79733a0f-1f9a-bb96-7ca6-f88fd948bbfe,_,_)
THEN
PROC_LOW_TadpoleTransport_RevealIllusion();

PROC
PROC_LOW_TadpoleTransport_RevealIllusion()
AND
DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate, _IllusionCrate, _Name)
THEN
PROC_SetOnStage(_IllusionCrate, 1);
PROC_SetOnStage(_SolidCrate, 0);
SetCanInteract(_IllusionCrate, 0);
PROC_LoopEffect(VFX_Script_Hag_IllusionWall_01_c226465e-3aeb-c02a-b8e3-65684210e1c0, _IllusionCrate, _Name, "CTY_Main_A", "");

PROC
PROC_LOW_TadpoleTransport_RevealIllusion()
THEN
PROC_SetOnStage((ITEM)S_LOW_TadpoleTransport_Nursery_0dceaf04-93ff-41dd-8497-3dd833f30527, 1);

PROC
PROC_LOW_TadpoleTransport_RevealIllusion()
THEN
NOT DB_KnowledgeCheckTrigger_AD("LOW_TadpoleTransport_IllusionCrate", (TRIGGER)S_LOW_TadpoleTransport_RevealTrigger_d5033d7f-bde4-4d4d-a748-da0ef4ff5c5a, "Investigation", (DIFFICULTYCLASS)Act3_Hard_6298329e-255c-4826-9209-e911873b64e7, (DIALOGRESOURCE)LOW_TadpoleTransport_AD_NoticedIllusion_a5d2b6e2-311c-89ad-f44e-dfac6ec6d50e, (FLAG)LOW_TadpoleTransport_State_IllusionRevealed_79733a0f-1f9a-bb96-7ca6-f88fd948bbfe);

IF
UseStarted(_,(ITEM)S_LOW_TadpoleTransport_Nursery_0dceaf04-93ff-41dd-8497-3dd833f30527)
AND
DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate,_IllusionCrate,_Name)
THEN
NOT DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate,_IllusionCrate,_Name);
PROC_Poof(_IllusionCrate);

IF
DestroyedBy((ITEM)S_LOW_TadpoleTransport_Nursery_0dceaf04-93ff-41dd-8497-3dd833f30527, _,_,_)
AND
DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate,_IllusionCrate,_Name)
THEN
NOT DB_LOW_TadpoleTransport_IllusionCrates(_SolidCrate,_IllusionCrate,_Name);
PROC_Poof(_IllusionCrate);

//Tadpoles handling

PROC
PROC_LOW_TadpoleTransport_GetTadpoles()
THEN
IterateInventoryByTemplate(S_LOW_TadpoleTransport_Nursery_0dceaf04-93ff-41dd-8497-3dd833f30527, (ITEMROOT)UNI_TadpolePowerJar_1ec327be-3b7f-4502-9586-860e057e09ae, "LOW_TadpoleTransport_Tadpole","");

IF
EntityEvent((ITEM)_Item,"LOW_TadpoleTransport_Tadpole")
AND
GetStackAmount(_Item, _Amount, _)
THEN
DB_LOW_TadpoleTransport_TadpoleItem(_Item, _Amount);

IF
DestroyedBy((ITEM)S_LOW_TadpoleTransport_Nursery_0dceaf04-93ff-41dd-8497-3dd833f30527, _,_,_)
AND
DB_LOW_TadpoleTransport_TadpoleItem(_Item, _Amount)
AND
CreateAtObject((ITEMROOT)UNI_TadpolePowerJar_Broken_1c725b47-184b-4906-a891-c67a7dbc57c2, _Item, 0, 0, "", 1, _NewItem)
THEN
SetStackAmount((ITEM)_NewItem, _Amount);
Die(_Item, DEATHTYPE.Explode, NULL_00000000-0000-0000-0000-000000000000, 0, 0);


// Steelwatch handling

IF
DB_LOW_TadpoleTransport_Steelwatch(_Steelwatcher)
AND
DB_LOW_TadpoleTransport_TrespassingArea(_Trigger)
THEN
DB_SpotPlayers(_Steelwatcher, "LOW_TadpoleTransport_Spotted", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(_Steelwatcher, "LOW_TadpoleTransport_Spotted", _Trigger);

PROC
PROC_FlagReactionAfterDialog(_Player,(FLAG)LOW_TadpoleTransport_TeleportOut_9fe0eaf6-ebe9-ae9e-789b-1378925ec2df)
THEN
TeleportTo(_Player, S_LOW_TadpoleTransport_OutTrigger_7a0a4256-b9e8-4573-a751-312cc0864471, "", 1, 1);

PROC
PROC_SpotPlayers_Spotted(_Steelwatcher, _SpottingEvent, _Player)
AND
DB_LOW_TadpoleTransport_SpottingEvents(_SpottingEvent)
AND
QRY_SpeakerIsAvailable(_Steelwatcher)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_TadpoleTransport_SteelwatchGuard_3aa5043d-a64f-cff9-6621-267ee5d47763, _Steelwatcher, _Player)
THEN
DB_LOW_TadpoleTransport_PlayerWasWarned(_Player);

PROC
PROC_SpotPlayers_Spotted(_Steelwatcher, "LOW_TadpoleTransport_Spotted", _Player)
AND
DB_LOW_TadpoleTransport_Steelwatch(_Steelwatcher)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_TadpoleTransport_Steelwatch_8b9df0e8-e392-4e84-a565-866bb9ad65a0, 0);

// Make the steelwatchers not reacting after Gortash's death

IF
DB_PermaDefeated((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
THEN
NOT DB_SpotPlayers((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab,  "LOW_TadpoleTransport_Warning01", (TRIGGER)S_LOW_TadpoleTransport_Steelwatch01WarningTrigger_d126257c-f206-45de-ab87-b0eb0acab775);
NOT DB_SpotPlayers_Continuous((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01");
NOT DB_SpotPlayers_SpotterIgnoreCantTalk((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01");
NOT DB_SpotPlayers_TargetIgnoreCantTalk((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01");
NOT DB_SpotPlayers((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7, "LOW_TadpoleTransport_Warning02", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7,  "LOW_TadpoleTransport_Warning02", (TRIGGER)S_LOW_TadpoleTransport_Steelwatch02WarningTrigger_03fe7822-0b51-4290-a35d-b9d442df9e14);
NOT DB_SpotPlayers_Continuous((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7, "LOW_TadpoleTransport_Warning02");

IF
DB_PermaDefeated((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
DB_LOW_TadpoleTransport_Steelwatch(_Steelwatcher)
AND
DB_LOW_TadpoleTransport_TrespassingArea(_Trigger)
THEN
NOT DB_SpotPlayers(_Steelwatcher, "LOW_TadpoleTransport_Spotted", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SpotPlayers_SpotTrigger(_Steelwatcher, "LOW_TadpoleTransport_Spotted", _Trigger);


//END_REGION

//REGION Plague Ship

//Plague logic
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_PlagueShip_PlagueTrigger_5809f660-a69c-4df2-9496-e313dfba2387)
AND
NOT DB_LOW_PlagueShip_HadSavingThrow(_Player)
THEN
DB_LOW_PlagueShip_HadSavingThrow(_Player);
RequestPassiveRoll(_Player, _Player, "SavingThrow", "Constitution", (DIFFICULTYCLASS)Act3_Hard_6298329e-255c-4826-9209-e911873b64e7, 0, "LOW_PlagueShip_PlagueRoll");

IF
RollResult("LOW_PlagueShip_PlagueRoll", _Player, _Player, _Result, _, _)
AND
_Result != 1
THEN
PROC_LOW_PlagueShip_ApplyPlague(_Player);

PROC
PROC_LOW_PlagueShip_ApplyPlague((CHARACTER)_Player)
THEN
ApplyStatus(_Player, "LOW_PLAGUESHIP_SEAPLAGUE", -1.0);

// Cursed imp


IF
UseStarted(_,(ITEM)S_LOW_PlagueShip_CursedChest_c8785704-814a-4c3b-8236-9f22f2d90c37)
THEN
PROC_LOW_PlagueShip_SpawnImp();

IF
DestroyedBy((ITEM)S_LOW_PlagueShip_CursedChest_c8785704-814a-4c3b-8236-9f22f2d90c37, _,_,_)
THEN
PROC_LOW_PlagueShip_SpawnImp();

PROC
PROC_LOW_PlagueShip_SpawnImp()
AND
QRY_OnlyOnce("LOW_PlagueShip_ImpAppeared")
THEN
PROC_Foop((CHARACTER)S_LOW_PlagueShip_CursedImp_008b019e-5e7d-456a-8697-656f8ca8f241);

// Remove curse
IF
DB_PermaDefeated((CHARACTER)S_LOW_PlagueShip_CursedImp_008b019e-5e7d-456a-8697-656f8ca8f241)
THEN
PROC_LOW_PlagueShip_RemovePlague();

PROC
PROC_LOW_PlagueShip_RemovePlague()
AND
DB_Players(_Player)
AND
HasAppliedStatus(_Player, "LOW_PLAGUESHIP_SEAPLAGUE", 1)
THEN
RemoveStatus(_Player, "LOW_PLAGUESHIP_SEAPLAGUE", S_LOW_PlagueShip_CursedImp_008b019e-5e7d-456a-8697-656f8ca8f241);

PROC
PROC_LOW_PlagueShip_RemovePlague()
THEN
PROC_TriggerUnregisterForPlayers(S_LOW_PlagueShip_PlagueTrigger_5809f660-a69c-4df2-9496-e313dfba2387);

//END_REGION


PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-311772");
DB_FlagReactionAfterDialog(LOW_TadpoleTransport_TeleportOut_9fe0eaf6-ebe9-ae9e-789b-1378925ec2df, (DIALOGRESOURCE)LOW_TadpoleTransport_SteelwatchGuard_3aa5043d-a64f-cff9-6621-267ee5d47763);

PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_LOW_TadpoleTransport_PlayerWasWarned(_Player)
THEN
SetFlag((FLAG)LOW_TadpoleTransport_HasMet_SteelwatchGuard_2b6c748c-c053-8a86-d26f-a586e5c731b5, _Player);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
