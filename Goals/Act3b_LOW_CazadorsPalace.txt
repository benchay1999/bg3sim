Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION General Ground Area
DB_DangerZone((TRIGGER)S_LOW_CazadorsPalace_GroundLevelArea_ee9690f0-fa9a-4d39-b467-d12c28bf6e19, "LOW_CazadorsPalace_GroundLevelArea");
DB_PartyProgress_Trigger(S_LOW_CazadorsPalace_GroundLevelArea_ee9690f0-fa9a-4d39-b467-d12c28bf6e19, (FLAG)LOW_CazadorsPalace_State_EnteredMansion_97df5c27-5740-4277-96e1-5fdd4c5e6699);

// Teleporter, Dialog, FlagToTeleport, Destination
DB_LOW_CazadorsPalace_Teleporters((ITEM)S_LOW_CazadorsPalace_ElevatorDown_aeaa018b-5f69-450a-a35d-bf725f990eff, (DIALOGRESOURCE)LOW_CazadorsPalace_ElevatorDown_2add5a33-f335-075a-1470-93072370c45c, (FLAG)LOW_CazadorsPalace_Event_TeleportToDungeonLevel_edece03f-595c-47ef-aebd-3eb516277956, (TRIGGER)S_LOW_CazadorsPalace_ElevatorDungeonPos_46c7a5b4-ffcf-4349-9406-c71e665d9de8);
DB_LOW_CazadorsPalace_Teleporters((ITEM)S_LOW_CazadorsPalace_ElevatorUp_95723962-8ecf-4199-8448-248f4dad8834, (DIALOGRESOURCE)LOW_CazadorsPalace_ElevatorUp_4f82b103-5fd3-f2f0-cb43-c78197f576a8, (FLAG)LOW_CazadorsPalace_Event_TeleportToGroundLevel_6f56e45a-603d-4fdf-98bf-6a88869966bb, (TRIGGER)S_LOW_CazadorsPalace_ElevatorGroundPos_e0f45407-e100-4982-a6ca-c0d40f713789);

// Servant, Dialog
DB_LOW_CazadorsPalace_Servants((CHARACTER)S_LOW_CazadorsPalace_Servant_001_61564290-a0f8-457e-aba1-3697ad9ea0d4, (DIALOGRESOURCE)LOW_CazadorsPalace_Servant_001_14b18941-466f-3587-7cd7-4c8fb6f38ac1);
DB_LOW_CazadorsPalace_Servants((CHARACTER)S_LOW_CazadorsPalace_Servant_002_8d5fb663-c039-4330-b832-5c6e584cb11b, (DIALOGRESOURCE)LOW_CazadorsPalace_Servant_002_b15037c0-973f-2ec9-fee7-ee3dac821df7);
DB_LOW_CazadorsPalace_Servants((CHARACTER)S_LOW_CazadorsPalace_Servant_003_b8109954-bc78-4fbd-ac69-ba22cf4775fa, (DIALOGRESOURCE)LOW_CazadorsPalace_Servant_003_9c65051c-4ad6-4793-dfba-740c9a1b0a96);
DB_LOW_CazadorsPalace_Servants((CHARACTER)S_LOW_CazadorsPalace_Servant_004_2776a0f5-def2-4714-a830-6561cc96eb53, (DIALOGRESOURCE)LOW_CazadorsPalace_Servant_004_7e53e7f5-f46f-28bb-7a13-e377522f05cf);
//END_REGION General Ground Area

//REGION Guard Tower
// All guards have custom LOW_CAZADORSPALACE_CHARM status on them. They are charmed by Cazador. Removing this status makes them flee (they leave combat if they are fighting you)
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_GuardTower_AstarionsCommentArea_0c3834b1-2982-4064-b7cb-7c98f6a243be);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_Ramparts_DoorTrigger_bfb68933-7e6f-4d84-9722-093675564d70);

// guard, main dialog, AD when uncharmed and fleeing
DB_LOW_CazadorsPalace_GuardTower_Guards((CHARACTER)S_LOW_CazadorsPalace_GuardTower_Guard_001_e0f6ebdc-e19a-4ae4-a487-f192b9edcfac, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Guard_001_b835f36a-648e-ba20-0b04-bd73bb2ce72a, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Guard_001_AD_Fleeing_dd7a1e19-c49e-f883-af85-5b66d39cb0f5);
DB_LOW_CazadorsPalace_GuardTower_Guards((CHARACTER)S_LOW_CazadorsPalace_GuardTower_Guard_002_a97a18f4-3dd9-4af9-84df-028ca82e41c5, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Guard_002_ff06b629-a5af-e3c2-8422-c70db2ec7d4f, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Guard_002_AD_Fleeing_385cc861-54fd-9b66-d38c-bab14ad7491e);
DB_LOW_CazadorsPalace_GuardTower_Guards((CHARACTER)S_LOW_CazadorsPalace_GuardTower_Guard_003_d7c92c82-e297-41ce-bc08-ca36217d850e, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Guard_003_a5b2b1db-1366-d221-ed62-be8a90b234dc, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Guard_003_AD_Fleeing_ff8b1b99-8b32-d34e-c56a-7b30343d4e87);

DB_LOW_CazadorsPalace_GuardTower_Rats((CHARACTER)S_LOW_CazadorsPalace_GuardTower_Rat_001_ba3e956a-fe8c-424d-b491-7fc557729d6a, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Rat_001_SwA_22bf36a1-d43f-37fe-641f-8bfee52dadb8);
DB_LOW_CazadorsPalace_GuardTower_Rats((CHARACTER)S_LOW_CazadorsPalace_GuardTower_Rat_002_3dba64f8-5bb7-48eb-a88c-24643926bb5f, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Rat_002_SwA_54dfc76c-3d74-7980-b01f-4d632e40fe36);
DB_LOW_CazadorsPalace_GuardTower_Rats((CHARACTER)S_LOW_CazadorsPalace_GuardTower_Rat_003_c2d24548-56d4-45e7-a1ac-4928941b7642, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Rat_003_SwA_731c42dd-b4e6-38bf-773f-9451298b8958);
DB_LOW_CazadorsPalace_GuardTower_Rats((CHARACTER)S_LOW_CazadorsPalace_GuardTower_Rat_004_49b253e0-cbf2-48b7-b70f-87b186325cb5, (DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Rat_004_SwA_1cc8a7c9-a307-5f9c-4d5a-52d6c6cbade7);

DB_TrespassTrigger((TRIGGER)S_LOW_CazadorsPalace_GuardTower_ThirdFloor_889f0da2-5ce7-4f28-924e-abfa178a306b, S_LOW_CazadorsPalace_GuardTower_OutTrigger_2c2ab6f6-415d-4866-b1c3-48b437a3fdc7, "LOW_CazadorsPalace_GuardTowerTrespassing");

DB_HasItemEvent((ITEM)S_LOW_CazadorsPalace_GuardTower_BackHallKey_ffb0b58c-38a0-49da-af14-39bafa2406cc, (FLAG)LOW_CazadorsPalace_GuardTower_State_HasKey_4e322824-1cab-4a5f-89e5-32c9cbe401ed);
DB_GiveItemToEvent(S_LOW_CazadorsPalace_GuardTower_BackHallKey_ffb0b58c-38a0-49da-af14-39bafa2406cc, (FLAG)LOW_CazadorsPalace_GuardTower_Event_GiveKey_e8e26cd0-5d12-482f-b7cd-d6b2b9f8f482);

DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_CazadorsPalace_GuardTower_OwnershipTrigger_9c544705-c92c-4473-a621-a70c47a43025, (CHARACTER)S_LOW_CazadorsPalace_GuardTower_Guard_001_e0f6ebdc-e19a-4ae4-a487-f192b9edcfac);
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_CazadorsPalace_GuardTower2_OwnershipTrigger_56c9c1b7-38af-457f-bf58-3e9bd4a2620f, (CHARACTER)S_LOW_CazadorsPalace_GuardTower_Guard_001_e0f6ebdc-e19a-4ae4-a487-f192b9edcfac);

//END_REGION Guard Tower

//REGION Dormitory
TriggerRegisterForCharacter((TRIGGER)S_LOW_CazadorsPalace_Dormitory_AstarionCommentTrigger_52bd7ce0-10c5-42ca-9392-3d3285d74fd2, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
//END_REGION

//REGION Kennel
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_Kennel_IllusionCheckAreaForAstarion_7e4e539b-7ebe-414c-ba07-c562e8284cb1);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88);

SetCanInteract((ITEM)S_LOW_CazadorsPalace_Kennel_Door_b52934e3-1be1-4073-afae-38caeed0d584, 0);

PROC_TriggerRegisterForParty((TRIGGER)S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88);

DB_AmbushTrigger((TRIGGER)S_LOW_CazadorsPalace_Kennel_AmbushArea_b1f8c8a7-7029-4752-8ce7-f9381bcc82bc, (TRIGGER)S_LOW_CazadorsPalace_Kennel_AmbushDetectionArea_3da53ce5-16fb-4182-9a59-54b8ab6b798b, (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57);
DB_AmbushTrigger_AdditionalAmbushTrigger((TRIGGER)S_LOW_CazadorsPalace_Kennel_AmbushArea_b1f8c8a7-7029-4752-8ce7-f9381bcc82bc, (TRIGGER)S_LOW_CazadorsPalace_Kennel_AmbushLaunchArea_961e77ac-258b-4390-ad1a-91848e215274);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_CazadorsPalace_Kennel_AmbushArea_b1f8c8a7-7029-4752-8ce7-f9381bcc82bc, S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f, 1);

DB_Dialogs((CHARACTER)S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f, (DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_Skeleton_3b9f7512-fe9e-29d4-797d-af07d97a36b6);
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_Skeleton_3b9f7512-fe9e-29d4-797d-af07d97a36b6, 
	(TAG)ASTARION_23a46e79-e73c-4043-940f-cb0aace9ab2e,
	(DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_OM_Astarion_AOM_OOM_1661dcc6-b196-3797-9d1e-07dbeebd1d2a,
	(DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_OM_Astarion_COM_000d3cad-251b-69db-6ec4-7e39f859466a,
	(DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_OM_Astarion_AOM_OOM_1661dcc6-b196-3797-9d1e-07dbeebd1d2a);

DB_PlayerHasTemplateItem((ITEMROOT)UNI_LOW_SzarrRing_846d27b5-c247-4049-9872-86171c172015, LOW_CazadorsPalace_State_HasAnySzarrRing_653dfec2-00c6-47f9-a962-e6ff24b7dd40);
DB_HasItemEvent(S_LOW_CazadorsPalace_Kennel_SzarrRing_9fd82243-7e92-4fd1-847c-f4fe215c583f, (FLAG)LOW_CazadorsPalace_Kennel_State_HasSzarrRing_98b11c1c-e774-4a1e-9704-7e72f7f4a8d8);
DB_GiveItemToEvent(S_LOW_CazadorsPalace_Kennel_SzarrRing_9fd82243-7e92-4fd1-847c-f4fe215c583f, (FLAG)LOW_CazadorsPalace_Kennel_Event_GiveSzarrRing_0b897260-2193-4ec1-b1b0-397cb11c315c);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_Kennel_State_ConvincedSkeleton_3f7c5b5a-1ae3-4cab-811e-9280c0d9bb14, (DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_Skeleton_3b9f7512-fe9e-29d4-797d-af07d97a36b6);
//END_REGION Kennel

//REGION Bedrooms
TriggerRegisterForCharacter((TRIGGER)S_LOW_CazadorsPalace_Bedrooms_Area_7bc9f477-7dcd-433b-a2e1-4c41d3285fc5, (CHARACTER)S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_Bedrooms_AstarionsCommentArea_937c6027-ae2c-477f-99dd-2a9f3a923f75);

ApplyStatus(S_LOW_CazadorsPalace_Bedrooms_DeadGirlsDoor_46d0a1fb-3740-4c8d-9705-1ad571efccbf, "LOW_CAZADORSPALACE_DEADGIRL_DOOR", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
Die(S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 1.0);

DB_KnowledgeCheckTrigger_AD("LOW_CazadorsPalace_Bedrooms_DeadGirlsDoor", S_LOW_CazadorsPalace_Bedrooms_DeadGirlsDoorKnowledgeCheckArea_7b33021f-2cfa-424c-b4e5-8bd792cd3b5e, "Arcana", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)LOW_CazadorsPalace_Bedrooms_PAD_DeadGirlsDoor_9d550567-c988-73ad-3cc9-eb6929edea57, (FLAG)LOW_CazadorsPalace_Bedrooms_State_DoorCheckSuccess_6124eca9-0903-467d-81c2-cd232878024d);
//END_REGION Bedrooms

//REGION Ballroom
DB_PartyProgress_Trigger(S_LOW_CazadorsPalace_Ballroom_Area_4a2fbdeb-b311-4b83-b8d9-051c33ef6b91, LOW_CazadorsPalace_Ballroom_State_Visited_9816b1d4-c234-44af-8917-8b9ee9b17061);

DB_LOW_CazadorsPalace_Ballroom_Werewolves((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Werewolf_001_59ee488e-b73a-4501-8a2d-4cb2a079e4d6);
DB_LOW_CazadorsPalace_Ballroom_Werewolves((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Werewolf_002_278ba30a-5902-4802-a569-89da39d3ab3a);
DB_LOW_CazadorsPalace_Ballroom_Werewolves((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Werewolf_003_f21aa31f-4b01-405d-a54e-4fa1ca0b64ab);

// minion, swarm group
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Wolf_001_faa297b1-c4c4-40fc-978a-420656b78771);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Wolf_002_92a49cfd-1ddf-485d-b885-44d2c611258a);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Rat_001_12cfe1fe-7140-4bd4-8aa0-06feb78f8980);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Rat_002_82b3703b-7069-41ea-9310-e33addb19bc8);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Rat_004_55d3d35f-4e0b-4dfe-af6e-ff2fc133d9a4);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Rat_005_222691ba-d70c-45de-8906-a8eb1ba0f6e9);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Rat_003_c3fdee4f-3692-437a-997e-c31580affad8);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Bat_001_978c17c1-af29-4d7c-b37b-513e3dd11d95);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Bat_002_0779b83e-4dc8-48d2-a91c-240247da6975);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Bat_003_5ff8e5a9-ae15-4858-927d-7ef6d623cada);
DB_LOW_CazadorsPalace_Ballroom_Minions((CHARACTER)S_LOW_CazadorsPalace_Ballroom_Bat_004_4d19da60-7bd5-40cf-81d7-2b88049ff46e);

DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_CazadorsPalace_Ballroom_DeadGuest_002_4a870fc7-2e02-42f7-99b1-dac86c65157a, (DIALOGRESOURCE)LOW_CazadorsPalace_Ballroom_Guest_002_Dead_c9ce8ecc-3d0c-3efd-51d8-6066f6eed895);

DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_CazadorsPalace_Ballroom_WerewolvesAttack_1aabceef-f4cb-651c-445a-1f9145547abb);
//END_REGION Ballroom

//REGION General Dungeon Area
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_Dungeon_AstarionsCommentArea_92c0d5a8-9545-44ee-a35b-1f70afea5b50);
PROC_TriggerRegisterForPlayers(S_LOW_CazadorsPalace_DungeonArea_1d0aed1e-824c-4604-ab04-8e0a33827df0);

DB_DangerZone((TRIGGER)S_LOW_CazadorsPalace_DungeonArea_1d0aed1e-824c-4604-ab04-8e0a33827df0, "LOW_CazadorsPalace_DungeonArea");
DB_PartyProgress_Trigger((TRIGGER)S_LOW_CazadorsPalace_DungeonArea_1d0aed1e-824c-4604-ab04-8e0a33827df0, LOW_CazadorsPalace_EnteredDungeon_740ea5cd-7ada-4610-aadb-f52026782700);

// Doors with magical protection that require Szarr Ring to pass
// Door, FlagToOpenDoor
DB_LOW_CazadorsPalace_DoorsWithMagicalProtection((ITEM)S_LOW_CazadorsPalace_Cells_EntranceDoor_197240c8-d485-4e84-aede-ba1fed46b2fa, (FLAG)LOW_CazadorsPalace_Dungeon_Event_OpenDoorToCells_86b7569a-04e9-486a-a90d-989d80807731);
DB_LOW_CazadorsPalace_DoorsWithMagicalProtection((ITEM)S_LOW_CazadorsPalace_Crypt_EntranceDoor_5a1fccda-99bd-4c8d-befa-eec0b55e36b2, (FLAG)LOW_CazadorsPalace_Dungeon_Event_OpenDoorToCrypt_2cf4ad43-788d-463f-b0bf-5683ec14168e);

// Door, Dialog, Speaker
DB_LOW_CazadorsPalace_CellsDoors((ITEM)S_LOW_CazadorsPalace_Cells_AdultDoor_aa404054-9dae-4684-82aa-48c948295e6c, 
	(DIALOGRESOURCE)LOW_CazadorsPalace_Cells_NoAstarion_85cd0c84-7814-69b4-a58e-e98c94f9bdc3,
	(CHARACTER)S_LOW_CazadorsPalace_Cells_Prisoner_001_5f39e17d-28dc-4d48-8370-91bb41098c44);
DB_LOW_CazadorsPalace_CellsDoors((ITEM)S_LOW_CazadorsPalace_Cells_ChildrenDoor_6bca442f-383d-46a6-be5b-a5e046aa853e,
	(DIALOGRESOURCE)LOW_CazadorsPalace_Cells_Child_001_3908edc3-d951-575f-24fd-a118a96b91f8,
	(CHARACTER)S_LOW_CazadorsPalace_Cells_Child_001_1fe747aa-f154-4507-b678-d51b3fffd20c);

DB_GLO_Cinematic_PositionedDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Dungeon_DoorWithProtection_cdb1cf92-9479-e71a-45a8-6e2a627f200b, "LOW_CazadorsPalace_DoorWithProtection");
DB_GLO_Cinematic_PositionFlags("LOW_CazadorsPalace_DoorWithProtection", (TRIGGER)S_LOW_CazadorsPalace_Dungeon_DoorToCells_CinematicTrigger_d683747b-b973-4875-bc1b-3e5bee30130d, (FLAG)LOW_CazadorsPalace_Dungeon_State_InFrontOfDoorToCells_8164582f-a50c-4545-8235-c649ea48db25);

SetAmbushing(S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, 1);
SetDetached(S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, 1);
//END_REGION General Dungeon Area

//REGION Preparation Room
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_CazadorsPalace_PreparationRoom_76487cf9-ce60-23fa-0a9b-be8d3fb84ea5);
DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_CazadorsPalace_PreparationRoom_76487cf9-ce60-23fa-0a9b-be8d3fb84ea5);

PROC_SetOnStage((ITEM)S_LOW_CazadorsPalace_PreparationRoom_Rune_abd791db-152e-4915-afad-166fc087950c, 0);
//END_REGION Preparation Room

//REGION Crypt
// Cazador's Journal contains several entries. New entries added based on the player's actions & state of Astarion (spotted by Dalyria, kidnapped etc)
AddEntryToCustomBook("LOW_CazadorsPalace_CazadorsJournal", "LOW_CazadorsPalace_CazadorsJournal");
DB_LOW_CazadorsPalace_CazadorsJournalEntries((FLAG)CAMP_Astarion_TheHungerC_Leave_0e36d357-fd68-2e42-7ba6-b69efd57eb90, "LOW_CazadorsPalace_CazadorsJournal_AstarionNecroZombie");
DB_LOW_CazadorsPalace_CazadorsJournalEntries((FLAG)CAMP_Astarion_TheHungerC_Kill_0cf812a4-59c0-564a-8825-95885d78d208, "LOW_CazadorsPalace_CazadorsJournal_AstarionNecroZombie");
DB_LOW_CazadorsPalace_CazadorsJournalEntries((FLAG)ORI_Astarion_State_GurGotAstarion_cd1687b8-3282-4121-aaa1-6de5eda6a9a4, "LOW_CazadorsPalace_CazadorsJournal_GurEntry");
DB_LOW_CazadorsPalace_CazadorsJournalEntries((FLAG)WYR_VampireSpawns_Knows_AstarionInCity_d8b89f75-b06f-bc60-684c-6010a061b6c8, "LOW_CazadorsPalace_CazadorsJournal_DalyriaAndPetraReport");
DB_LOW_CazadorsPalace_CazadorsJournalEntries((FLAG)LOW_VampireAmbush_State_AmbushFailed_c7ad2cf7-59de-4310-aac1-2635d66474bf, "LOW_CazadorsPalace_CazadorsJournal_KidnappingFailed");
DB_LOW_CazadorsPalace_CazadorsJournalEntries((FLAG)LOW_VampireAmbush_State_AstarionKidnapped_b52d681f-4722-4f43-ba95-ac9f49c173d8, "LOW_CazadorsPalace_CazadorsJournal_KidnappingSucceeded");

DB_LOW_CazadorsPalace_Crypt_BooksReactions((ITEM)S_LOW_CazadorsPalace_Crypt_CazadorsJournal_74b8042a-2392-40af-a5c1-abaaa14da7cb, (DIALOGRESOURCE)LOW_CazadorsPalace_Crypt_PAD_CazadorsJournalComment_1f8d7fd5-f1c3-adaa-26b8-538d05a90189);
DB_LOW_CazadorsPalace_Crypt_BooksReactions((ITEM)S_LOW_CazadorsPalace_Crypt_PowerStructureOfBadlursGate_002e3c2d-8f13-4400-8b5f-a03059aabe1b, (DIALOGRESOURCE)LOW_CazadorsPalace_Crypt_PAD_CazadorsPlansComment_360e9b74-0d5b-c1da-6b0f-f3cec1b62347);
DB_LOW_CazadorsPalace_Crypt_BooksReactions((ITEM)S_LOW_CazadorsPalace_Crypt_ScrollOfNames_da5e9241-31d7-4b93-a65b-a521f3c1385d, (DIALOGRESOURCE)LOW_CazadorsPalace_Crypt_PAD_ScrollOfNames_686b6f76-0141-c33e-37e6-61cb8b0fb9cb);

DB_GLO_CompoundFlag((FLAG)LOW_CazadorsPalace_Crypt_Knows_FirstRule_bf5e8876-343c-4503-8e4d-924d27f93691, (FLAG)LOW_CazadorsPalace_Crypt_Knows_AtLeastOneRule_700cd979-560c-4944-a176-213210ff5625);
DB_GLO_CompoundFlag((FLAG)LOW_CazadorsPalace_Crypt_Knows_SecondRule_4bb5ae01-941d-497c-baf8-927d3df135b9, (FLAG)LOW_CazadorsPalace_Crypt_Knows_AtLeastOneRule_700cd979-560c-4944-a176-213210ff5625);
DB_GLO_CompoundFlag((FLAG)LOW_CazadorsPalace_Crypt_Knows_ThirdRule_cd11c90c-96fb-46c2-98c9-cd902878b9b6, (FLAG)LOW_CazadorsPalace_Crypt_Knows_AtLeastOneRule_700cd979-560c-4944-a176-213210ff5625);

DB_BookFlags(S_LOW_CazadorsPalace_Crypt_Scroll_591d390d-68b7-4937-9103-3772493ab132, (FLAG)ORI_Astarion_Knows_RitualsPurpose_d1dc0f8a-b77d-4e40-a501-a66e163b8376);
//END_REGION Crypt

//REGION Cells
// Prisoner, Dialog, IsChild
DB_LOW_CazadorsPalace_Cells_Prisoners((CHARACTER)S_LOW_CazadorsPalace_Cells_Prisoner_001_5f39e17d-28dc-4d48-8370-91bb41098c44, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_NoAstarion_85cd0c84-7814-69b4-a58e-e98c94f9bdc3, 0);
DB_LOW_CazadorsPalace_Cells_Prisoners((CHARACTER)S_LOW_CazadorsPalace_Cells_Prisoner_002_4f062990-71e8-4c38-a66c-f5b623d5c0b8, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_Prisoner_002_dbf52213-fd6c-d5e9-1a11-28c282f4de3b, 0);
DB_LOW_CazadorsPalace_Cells_Prisoners((CHARACTER)S_LOW_CazadorsPalace_Cells_Prisoner_003_bf2bc6f6-3fad-4b81-848d-f60a32852c9e, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_Prisoner_003_c00ee88b-d538-bbfb-25ea-8694bed31e8c, 0);
DB_LOW_CazadorsPalace_Cells_Prisoners((CHARACTER)S_LOW_CazadorsPalace_Cells_Prisoner_004_98b38439-05d9-4e25-a270-5005222869b9, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_Prisoner_004_f172f6df-b823-a461-ef6e-7443bb85aa18, 0);
DB_LOW_CazadorsPalace_Cells_Prisoners((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_001_1fe747aa-f154-4507-b678-d51b3fffd20c, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_Child_001_3908edc3-d951-575f-24fd-a118a96b91f8, 1);
DB_LOW_CazadorsPalace_Cells_Prisoners((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_002_5086decf-b8f4-420d-84e0-487338a90f20, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_Child_002_97d07056-f76f-925e-fd0a-2b39eb133406, 1);
DB_LOW_CazadorsPalace_Cells_Prisoners((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_003_19237587-8dad-447d-b532-3800418162b1, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_Child_003_0d964d6d-497e-9aab-eaaa-3adbb1f707dc, 1);
DB_LOW_CazadorsPalace_Cells_Prisoners((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_004_0ca9863f-7dd6-4713-bdda-efc1ad78cd2a, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_Child_004_784f2005-14d8-a914-5a33-7e6ca066a412, 1);
DB_LOW_CazadorsPalace_Cells_Prisoners((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_005_84e1b0d5-cf46-4309-820d-1860d89ecde3, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_Child_005_bab46049-4068-7c44-d2ac-418d0a2dec4a, 1);

PROC_DefineSingleOriginMoment((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_NoAstarion_85cd0c84-7814-69b4-a58e-e98c94f9bdc3, 
	(TAG)ASTARION_23a46e79-e73c-4043-940f-cb0aace9ab2e, 
	(DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48,
	(DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d,
	(DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48);

DB_OriginMoment_ExtraNPCs(LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48, S_LOW_CazadorsPalace_Cells_Prisoner_002_4f062990-71e8-4c38-a66c-f5b623d5c0b8);
DB_OriginMoment_ExtraNPCs(LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48, S_LOW_CazadorsPalace_Cells_Prisoner_003_bf2bc6f6-3fad-4b81-848d-f60a32852c9e);
DB_OriginMoment_ExtraNPCs(LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48, S_LOW_CazadorsPalace_Cells_Prisoner_004_98b38439-05d9-4e25-a270-5005222869b9);
DB_OriginMoment_ExtraNPCs(LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d, S_LOW_CazadorsPalace_Cells_Prisoner_002_4f062990-71e8-4c38-a66c-f5b623d5c0b8);
DB_OriginMoment_ExtraNPCs(LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d, S_LOW_CazadorsPalace_Cells_Prisoner_003_bf2bc6f6-3fad-4b81-848d-f60a32852c9e);
DB_OriginMoment_ExtraNPCs(LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d, S_LOW_CazadorsPalace_Cells_Prisoner_004_98b38439-05d9-4e25-a270-5005222869b9);

DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_NoAstarion_85cd0c84-7814-69b4-a58e-e98c94f9bdc3);
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48);
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d);
DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_NoAstarion_85cd0c84-7814-69b4-a58e-e98c94f9bdc3);
DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48);
DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d);

DB_SpotPlayers_SpotTrigger(S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, "LOW_CazadorsPalace_Cells",(TRIGGER)S_LOW_CazadorsPalace_Cells_SpotArea_5812e0df-8af3-4f80-b67f-a4d4a187273c);
DB_SpotPlayers((CHARACTER)S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, "LOW_CazadorsPalace_Cells", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_Cells_State_HostileToAstarion_29824693-4f15-4d4a-a288-18ee9d42dea5, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_Cells_State_HostileToAstarion_29824693-4f15-4d4a-a288-18ee9d42dea5, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_Cells_State_OMHappened_58ce1207-c80e-462d-8a6a-48e1cd0b2fd4, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_Cells_State_OMHappened_58ce1207-c80e-462d-8a6a-48e1cd0b2fd4, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d);

DB_GLO_CompoundFlag((FLAG)LOW_CazadorsPalace_Cells_Knows_GurChildren_0e263a7e-5d16-3753-c5ba-ae39e4cc16b6, (FLAG)GLO_Gur_Knows_GurChildren_f7bb3881-6ef4-4f0d-a7de-8cf6219a7406);
//END_REGION Cells

//REGION Flags for Astarion's In Party dialog
DB_InRegionFlag(S_LOW_CazadorsPalace_Mansion_SUB_7cb45c54-bc3f-4277-8563-d3aaf6c1e74a, (FLAG)ORI_Astarion_State_InCazadorMansion_d8e93477-3d50-436a-a017-0d2fd75eab65);
DB_InRegionFlag(S_LOW_CazadorsPalace_Dungeon_SUB_53359780-8f59-4aff-9694-566ade37f56a, (FLAG)ORI_Astarion_State_InCazadorDungeon_777cf5a6-5006-4d3c-ba9e-2d3507681544);
//END_REGION

//REGION Secret Entrance
PROC_SetOnStage(S_Button_CazadorSecretStair_9cbcd8af-53bc-48f4-ab19-3fae31838201, 0);
SetCanInteract((ITEM)S_DOOR_Invisible_A_CazadorSecret_toDungeon_61cebd40-b770-4f29-9090-fa0b6777b1e4, 0);
SetCanInteract((ITEM)S_CazadorSlidingWall_5ac0b737-66ef-45bd-b17a-e246724e2f2e, 0);
//END_REGION

//REGION Vases and Bed
DB_LOW_CazadorsPalace_Dungeon_Vases((ITEM)S_LOW_CazadorsPalace_CrystalVaseLeft_58ce8a47-4a91-4d2f-ad11-09d3ef7e4802, (DIALOGRESOURCE)LOW_CazadorsPalace_AD_CrystalVaseLeft_5c78e1d9-0183-a107-10f5-a4a355e8f993, "LOW_CazadorsPalace_CrystalVaseLeft");
DB_LOW_CazadorsPalace_Dungeon_Vases((ITEM)S_LOW_CazadorsPalace_CrystalVaseRight_8e6ce2be-a1f7-45b9-b035-4a60fd03eaca, (DIALOGRESOURCE)LOW_CazadorsPalace_AD_CrystalVaseRight_1f0b271a-2245-d6c3-20c2-50da53db5683, "LOW_CazadorsPalace_CrystalVaseRight");

DB_LOW_CazadorsPalace_Dungeon_Candlesticks((ITEM)S_LOW_CazadorsPalace_Dungeon_Candlestick_001_ceadd9fe-0cea-4520-bc64-058b6225db92);
DB_LOW_CazadorsPalace_Dungeon_Candlesticks((ITEM)S_LOW_CazadorsPalace_Dungeon_Candlestick_002_bfab4de0-8edd-48d2-934e-01ed4781f98a);
DB_LOW_CazadorsPalace_Dungeon_Candlesticks((ITEM)S_LOW_CazadorsPalace_Dungeon_Candlestick_003_0d5f81df-fc9e-4fb2-97f4-87426c5caf2d);
DB_LOW_CazadorsPalace_Dungeon_Candlesticks((ITEM)S_LOW_CazadorsPalace_Dungeon_Candlestick_004_a24e1e20-ffad-44cc-a481-610a11e86094);
DB_LOW_CazadorsPalace_Dungeon_Candlesticks((ITEM)S_LOW_CazadorsPalace_Dungeon_Candlestick_005_2303c6a0-05a1-431a-8ee4-a2f82c3f57ba);
//END_REGION

PROC_SetOnStage((ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoorLever_17db95e4-5f30-468a-bbb4-b7fa60d609c3, 0);
//REGION
PROC_LOW_CazadorsPalace_RemoveOldTrap();
//END_REGION

//REGION Chamberlain
Die(S_LOW_CazadorsPalace_Chamberlain_aa866491-2cd2-4959-92de-df45d3039d40, DEATHTYPE.Acid, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 1.0);
//END_REGION

//REGION Danger Zones for the attic & basement
DB_DangerZone((TRIGGER)S_LOW_CazadorsPalace_AtticDangerZone_5a4a9581-4960-48ce-82da-b552f8a568ec, "LOW_CazadorsPalace_AtticArea");
DB_DangerZone((TRIGGER)S_LOW_CazadorsPalace_BasementDangerZone_c11bf16c-9944-4cc7-999d-7c34a7cba2ea, "LOW_CazadorsPalace_BasementArea");
//END_REGION
KBSECTION
//REGION General Ground Area
IF
DB_LOW_CazadorsPalace_Servants(_Servant, _Dialog)
THEN
DB_Dialogs(_Servant, _Dialog);
DB_CRIME_Guards_NoSummonBy(_Servant);

QRY
QRY_CrimeBribes_GetEludedMethodAvailability_Custom("Bribe", _, (CHARACTER)_Servant, _, _, _)
AND
DB_LOW_CazadorsPalace_Servants(_Servant, _)
THEN
DB_QRYRTN_CrimeBribes_GetEludedMethodAvailability_Custom("no");
//END_REGION

//REGION Elevators
IF
DB_LOW_CazadorsPalace_Teleporters(_Teleporter, _Dialog, _TeleportFlag, _)
THEN
DB_FlagReactionAfterDialog(_TeleportFlag, _Dialog);
DB_Dialogs(_Teleporter, _Dialog);

PROC
PROC_FlagReactionAfterDialog(_Player, _TeleportFlag)
AND
DB_LOW_CazadorsPalace_Teleporters(_, _Dialog, _TeleportFlag, _Destination)
THEN
ClearFlag(_TeleportFlag, _Player);
TeleportTo(_Player, _Destination, "", 1, 1, 1, 0, 1);
//END_REGION

//REGION Guard Tower
IF
DB_LOW_CazadorsPalace_GuardTower_Guards(_Guard, _Dialog, _FleeingAD)
THEN
DB_Dialogs(_Guard, _Dialog);
ApplyStatus(_Guard, "LOW_CAZADORSPALACE_CHARM", -1.0); // easier to track the status here rather than in the Default Status field
DB_CRIME_Guards_NoSummonBy(_Guard);

IF
DialogStarted((DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_Guard_001_b835f36a-648e-ba20-0b04-bd73bb2ce72a, _)
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_GuardTower_State_Met_bc621a57-c901-40c7-a81a-00d2daf59653)
THEN
PROC_GlobalSetFlagAndCache(LOW_CazadorsPalace_GuardTower_State_Met_bc621a57-c901-40c7-a81a-00d2daf59653);

IF
DB_LOW_CazadorsPalace_GuardTower_Rats(_Rat, _Dialog)
THEN
DB_Dialogs(_Rat, _Dialog);
RequestSetSwarmGroup(_Rat, "LOW_CazadorsPalace_Rats_GuardTower");

IF
EnteredTrigger(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_LOW_CazadorsPalace_GuardTower_ThirdFloor_889f0da2-5ce7-4f28-924e-abfa178a306b)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_GuardTower_AstarionsCommentArea_0c3834b1-2982-4064-b7cb-7c98f6a243be);

IF
EnteredTrigger((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_LOW_CazadorsPalace_GuardTower_AstarionsCommentArea_0c3834b1-2982-4064-b7cb-7c98f6a243be)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_GuardTower_AstarionsCommentArea_0c3834b1-2982-4064-b7cb-7c98f6a243be);
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_GuardTower_PAD_AstarionsComment_4faffb41-b98a-1f85-16a9-ab4785affa8b, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
SetFlag((FLAG)LOW_CazadorsPalace_GuardTower_State_AstarionMentionedCharm_afff495c-0910-4b2b-806f-8d2d90e91217);

IF
FlagSet((FLAG)LOW_CazadorsPalace_GuardTower_State_GainedAccess_02559dde-4560-4244-8d18-ccde95a19ade, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
PROC_RemoveDBTrespassTrigger((TRIGGER)S_LOW_CazadorsPalace_GuardTower_ThirdFloor_889f0da2-5ce7-4f28-924e-abfa178a306b);

QRY
QRY_CRIME_KeepingAnEyeOut_Block(_, _ID)
AND
CrimeGetType(_ID, "LOW_CazadorsPalace_GuardTowerTrespassing")
THEN
DB_NOOP(1);

IF
DB_PermaDefeated((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
DB_LOW_CazadorsPalace_GuardTower_Guards(_Guard, _, _)
AND
NOT DB_PermaDefeated(_Guard)
AND
HasActiveStatus(_Guard, "LOW_CAZADORSPALACE_CHARM", 1)
THEN
RemoveStatus(_Guard, "LOW_CAZADORSPALACE_CHARM");

IF
FlagSet((FLAG)LOW_CazadorsPalace_GuardTower_Knows_Charmed_c59d126f-b3ce-4e00-8449-b0ad589a8ad8, _, _)
AND
DB_LOW_CazadorsPalace_GuardTower_Guards(_Guard, _, _)
AND
HasActiveStatus(_Guard, "LOW_CAZADORSPALACE_CHARM", 1)
THEN
ApplyStatus(_Guard, "LOW_CAZADORSPALACE_CHARM_VFX", -1.0);

IF
StatusRemoved(_Guard, "LOW_CAZADORSPALACE_CHARM", _, _)
AND
DB_Is_InCombat(_Guard, _CombatID)
THEN
SetFlag((FLAG)LOW_CazadorsPalace_GuardTower_State_UncharmedInCombat_e0c99613-f399-47c4-a4bd-aac218e921a4, _Guard);
LeaveCombat(_Guard);

IF
StatusRemoved((CHARACTER)_Guard, "LOW_CAZADORSPALACE_CHARM", _, _)
THEN
PROC_CharacterDisableCrime(_Guard, "LOW_CazadorsPalace_GuardTowerTrespassing");
SetFlag((FLAG)LOW_CazadorsPalace_GuardTower_State_Fleeing_5643879c-21ba-4940-bd37-e4eac255eb60, _Guard);
SetFaction(_Guard, (FACTION)Act3_LOW_CazadorsPalace_Fleeing_bf322172-17fe-45b1-91e2-22b95c00ddbf);
PROC_NotifyWhenReadyToMoveOn(_Guard, "LOW_CAZADORSPALACE_FLEE");

PROC
PROC_ReadyToMoveOn(_Guard, "LOW_CAZADORSPALACE_FLEE")
AND
DB_LOW_CazadorsPalace_GuardTower_Guards(_Guard, _, _FleeingAD)
THEN
PROC_TryStartAD(_FleeingAD, _Guard);

IF
AutomatedDialogEnded(_FleeingAD, _)
AND
DB_LOW_CazadorsPalace_GuardTower_Guards(_Guard, _, _FleeingAD)
THEN
PROC_CharacterMoveTo(_Guard, S_LOW_CazadorsPalace_GuardTower_OutTrigger_2c2ab6f6-415d-4866-b1c3-48b437a3fdc7, "Run", "LOW_CazadorsPalace_GuardTower_GuardLeft");

IF
EntityEvent(_Guard, "LOW_CazadorsPalace_GuardTower_GuardLeft")
THEN
PROC_SetOnStage(_Guard, 0);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_CazadorsPalace_Mansion_SUB_7cb45c54-bc3f-4277-8563-d3aaf6c1e74a)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_GuardTower_State_GainedAccess_02559dde-4560-4244-8d18-ccde95a19ade)
AND
NOT QRY_LOW_CazadorsPalace_KidnappedAstarion(_Player)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_GuardTower_State_GainedAccess_02559dde-4560-4244-8d18-ccde95a19ade);

// if Astarion was kidnapped, he can no longer unlock
// GainedAccess flag just by entering the mansion
QRY
QRY_LOW_CazadorsPalace_KidnappedAstarion((CHARACTER)_Player)
AND
_Player == S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
DB_GlobalFlag((FLAG)LOW_VampireAmbush_State_AmbushSucceded_6cf85531-c098-475c-9dba-528c039125ad)
THEN
DB_NOOP(1);
//END_REGION

//REGION Ramparts
IF
EnteredTrigger((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_LOW_CazadorsPalace_Ramparts_DoorTrigger_bfb68933-7e6f-4d84-9722-093675564d70)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Ramparts_AstarionPAD")
AND
IsLocked((ITEM)S_LOW_CazadorsPalace_BackHallDoor_5021c572-3a48-4fc4-ad7e-40e48fc3f8ed, 1)
THEN
Unlock(S_LOW_CazadorsPalace_BackHallDoor_5021c572-3a48-4fc4-ad7e-40e48fc3f8ed);
PROC_TryStartAD(GLO_AD_MechanicalClick_fc8d3dc5-b947-6354-3aa9-d1f02fd51af4, S_LOW_CazadorsPalace_BackHallDoor_5021c572-3a48-4fc4-ad7e-40e48fc3f8ed);
PROC_TryStartAD(LOW_CazadorsPalace_PAD_DoorOpens_44eaa6ec-b0fd-4f8b-54bb-0bbe911e31e8, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

IF
Unlocked((ITEM)S_LOW_CazadorsPalace_BackHallDoor_5021c572-3a48-4fc4-ad7e-40e48fc3f8ed, _, _)
AND
IsLocked((ITEM)S_LOW_CazadorsPalace_InteriorDoor_7955d456-bd48-4491-a0d2-49b98d660a7e, 1)
THEN
Unlock(S_LOW_CazadorsPalace_InteriorDoor_7955d456-bd48-4491-a0d2-49b98d660a7e);

IF
Unlocked((ITEM)S_LOW_CazadorsPalace_InteriorDoor_7955d456-bd48-4491-a0d2-49b98d660a7e, _, _)
AND
IsLocked((ITEM)S_LOW_CazadorsPalace_BackHallDoor_5021c572-3a48-4fc4-ad7e-40e48fc3f8ed, 1)
THEN
Unlock(S_LOW_CazadorsPalace_BackHallDoor_5021c572-3a48-4fc4-ad7e-40e48fc3f8ed);
//END_REGION

//REGION Chamberlain Wing
IF
Died((CHARACTER)S_LOW_CazadorsPalace_Chamberlain_aa866491-2cd2-4959-92de-df45d3039d40)
AND
NOT DB_LOW_CazadorsPalace_ChamberlainNotPatched(1)
THEN
ToInventory(S_LOW_CazadorsPalace_Chamberlain_aa866491-2cd2-4959-92de-df45d3039d40, S_LOW_CazadorsPalace_ChamberlainCoffin_69999bb4-59fd-4a7d-9491-df55dca1d83d, 1, 0, 0);

PROC
PROC_BlockUseOfItem(_Player, S_LOW_CazadorsPalace_ChamberlainCoffin_69999bb4-59fd-4a7d-9491-df55dca1d83d)
AND
DB_LOW_CazadorsPalace_ChamberlainNotPatched(1)
THEN
DB_CustomUseItemResponse(_Player, S_LOW_CazadorsPalace_ChamberlainCoffin_69999bb4-59fd-4a7d-9491-df55dca1d83d, 0);
PROC_LOW_CazadorsPalace_DestroyChamberlainCoffin();

IF
PreMovedBy(S_LOW_CazadorsPalace_ChamberlainCoffin_69999bb4-59fd-4a7d-9491-df55dca1d83d, _)
AND
DB_LOW_CazadorsPalace_ChamberlainNotPatched(1)
THEN
PROC_LOW_CazadorsPalace_DestroyChamberlainCoffin();

PROC
PROC_LOW_CazadorsPalace_DestroyChamberlainCoffin()
AND
DB_LOW_CazadorsPalace_ChamberlainNotPatched(1)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_DestroyChamberlainCoffin")
THEN
Die(S_LOW_CazadorsPalace_ChamberlainCoffin_69999bb4-59fd-4a7d-9491-df55dca1d83d);

IF
DestroyingBy(S_LOW_CazadorsPalace_ChamberlainCoffin_69999bb4-59fd-4a7d-9491-df55dca1d83d, _, _, _)
AND
DB_LOW_CazadorsPalace_ChamberlainNotPatched(1)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_RevealChamberlain")
THEN
PROC_Foop(S_LOW_CazadorsPalace_Chamberlain_aa866491-2cd2-4959-92de-df45d3039d40);

IF
CharacterLootedCharacter(_Player, (CHARACTER)S_LOW_CazadorsPalace_DeadWerewolf_5d1dd933-3180-47d6-99e9-ded336ebf08e)
AND
QRY_OncePerUserAndNearbyPlayers(_Player, "LOW_CazadorsPalace_Mansion_AD_DeadWerewolf")
THEN
PROC_TryStartAD(LOW_CazadorsPalace_Mansion_AD_DeadWerewolf_c3a7ee2a-532c-f66f-4ad9-758adfefa909, _Player);
//END_REGION

//REGION Dormitory
IF
EnteredTrigger((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_LOW_CazadorsPalace_Dormitory_AstarionCommentTrigger_52bd7ce0-10c5-42ca-9392-3d3285d74fd2)
THEN
PROC_TryStartAD(LOW_CazadorsPalace_Dormitory_PAD_AstarionComment_18ca33bf-53f6-e421-8f27-1e4769cdc1bb, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
TriggerUnregisterForCharacter((TRIGGER)S_LOW_CazadorsPalace_Dormitory_AstarionCommentTrigger_52bd7ce0-10c5-42ca-9392-3d3285d74fd2, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
//END_REGION

//REGION Kennel - Astarion kidnapped
// First, we cancel the default flow of the Kennel
// Second, we teleport Astarion to the Kennel
// Godey plays an AD
// After the AD we force a long rest
// After the long rest we start an interactive dialog
PROC
PROC_LOW_CazadorsPalace_Kennel_KidnapAstarion()
THEN
PROC_SetOnStage((ITEM)S_LOW_CazadorsPalace_Kennel_Pentagram_abd791db-152e-4915-afad-166fc087950c, 1);
PROC_CancelAmbush(S_LOW_CazadorsPalace_Kennel_AmbushArea_b1f8c8a7-7029-4752-8ce7-f9381bcc82bc);
PROC_LOW_CazadorsPalace_Kennel_RevealIllusion();
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_GuardTower_AstarionsCommentArea_0c3834b1-2982-4064-b7cb-7c98f6a243be);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_Ramparts_DoorTrigger_bfb68933-7e6f-4d84-9722-093675564d70);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_Kennel_IllusionCheckAreaForAstarion_7e4e539b-7ebe-414c-ba07-c562e8284cb1);
PROC_TriggerUnregisterForParty((TRIGGER)S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88);
TriggerRegisterForCharacter((TRIGGER)S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_DangerZone_SafeBubble((TRIGGER)S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88);
TeleportTo(S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f, S_LOW_CazadorsPalace_Kennel_RitualPos_c51b4ab8-37cb-45dd-a844-30a7429eb753);

PROC
PROC_LOW_CazadorsPalace_Kennel_KidnapAstarion()
THEN
DB_LOW_CazadorsPalace_Kennel_AstarionKidnapped(1);
SetCanFight(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0);
SetCanJoinCombat(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0);
LeaveCombat((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
RemoveHarmfulStatuses(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
PlayEffect(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, VFX_Script_VampireSpawn_Disappearing_BodyFX_01_a65c2389-2ab4-1ec4-57b6-84087d529d1e);
TeleportTo(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, S_LOW_CazadorsPalace_Kennel_AstarionKidnapPos_00e51e06-7221-4c0b-939f-dbea993ed26e, "LOW_CazadorsPalace_Kennel_AstarionKidnapped", 0, 0, 0, 1, 1);

IF
EntityEvent(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CazadorsPalace_Kennel_AstarionKidnapped")
AND
IsDead((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0)
THEN
PROC_LOW_CazadorsPalace_Kennel_AstarionTeleported();

IF
EntityEvent(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CazadorsPalace_Kennel_AstarionKidnapped")
AND
IsDead((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
THEN
Resurrect((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

IF
Resurrected((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_LOW_CazadorsPalace_Kennel_AstarionKidnapped(1)
THEN
PROC_LOW_CazadorsPalace_Kennel_AstarionTeleported();

PROC
PROC_LOW_CazadorsPalace_Kennel_AstarionTeleported()
THEN
SetHitpointsPercentage(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 100.0);
ApplyStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_KIDNAPPED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
SetCanFight(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1);
SetCanJoinCombat(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1);
PROC_LOW_CazadorsPalace_Kennel_SetCustomDefeatedState();
PROC_LOW_CazadorsPalace_Kennel_AstarionArrived();

// fallback in case the status failed to get applied
IF
StatusAttemptFailed(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_KIDNAPPED", _, _)
THEN
Freeze(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

// if we are playing solo Astarion, then it's fine to be kidnapped - we force the long rest after kidnapping and let the player continue
// otherwise - the party needs to defeat the spawns & take a long rest, loosing to the spawns == game over
PROC
PROC_LOW_CazadorsPalace_Kennel_SetCustomDefeatedState()
AND
NOT QRY_IsSoloAvatar(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
DB_CustomDefeatedState(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_KIDNAPPED");

PROC
PROC_LOW_CazadorsPalace_Kennel_AstarionArrived()
AND
IsControlled((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0)
THEN
MakePlayerActive((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255); // switch to Astarion and show the AD from Godey

PROC
PROC_LOW_CazadorsPalace_Kennel_AstarionArrived()
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_PreparationRoom_AD_Ritualist_139ad770-36ab-1eb5-57e3-cfcff8793739, S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f);

//REGION Solo Astarion - Forced Camp Rest with manual fading
IF
AutomatedDialogEnded(LOW_CazadorsPalace_PreparationRoom_AD_Ritualist_139ad770-36ab-1eb5-57e3-cfcff8793739, _)
AND
DB_LOW_CazadorsPalace_Kennel_AstarionKidnapped(1)
AND
QRY_IsSoloAvatar(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
ScreenFadeTo((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1.0, 0, "LOW_CazadorsPalace_Kennel_Rest");

IF
ScreenFadeDone(_, "LOW_CazadorsPalace_Kennel_Rest")
THEN
DB_LOW_CazadorsPalace_Kennel_LongRestForced(1);
PROC_Camp_InstantLongRest();
TimerLaunch("LOW_CazadorsPalace_Kennel_Rest", 1000);

IF
TimerFinished("LOW_CazadorsPalace_Kennel_Rest")
THEN
ClearScreenFade((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1.5, "LOW_CazadorsPalace_Kennel_Rest");

IF
ScreenFadeCleared(_, "LOW_CazadorsPalace_Kennel_Rest")
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_CazadorsPalace_PreparationRoom_76487cf9-ce60-23fa-0a9b-be8d3fb84ea5, (CHARACTER)S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
PROC_LOW_CazadorsPalace_Kennel_ReleaseKidnappedAstarion();

IF
ScreenFadeCleared(_, "LOW_CazadorsPalace_Kennel_Rest")
THEN
NOT DB_LOW_CazadorsPalace_Kennel_AstarionKidnapped(1); // we need to clean this DB even if the dialog failed to start
NOT DB_LOW_CazadorsPalace_Kennel_LongRestForced(1);
//END_REGION

//REGION Non-solo Astarion - waiting till the player finishes the long rest
PROC
PROC_Camp_EveryoneWakeupEndHook()
AND
DB_LOW_CazadorsPalace_Kennel_AstarionKidnapped(1)
AND
NOT DB_LOW_CazadorsPalace_Kennel_LongRestForced(1)
AND
QRY_MakePlayerActive((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_CazadorsPalace_PreparationRoom_76487cf9-ce60-23fa-0a9b-be8d3fb84ea5, (CHARACTER)S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
PROC_LOW_CazadorsPalace_Kennel_ReleaseKidnappedAstarion();

PROC
PROC_Camp_EveryoneWakeupEndHook()
AND
DB_LOW_CazadorsPalace_Kennel_AstarionKidnapped(1)
AND
NOT DB_LOW_CazadorsPalace_Kennel_LongRestForced(1)
THEN
NOT DB_LOW_CazadorsPalace_Kennel_AstarionKidnapped(1); // we need to clean this DB even if the dialog failed to start
//END_REGION

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_PreparationRoom_76487cf9-ce60-23fa-0a9b-be8d3fb84ea5, _)
THEN
PROC_LOW_CazadorsPalace_Kennel_ReleaseKidnappedAstarion();

PROC
PROC_LOW_CazadorsPalace_Kennel_ReleaseKidnappedAstarion()
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Kennel_ReleaseKidnappedAstarion")
THEN
NOT DB_CustomDefeatedState(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_KIDNAPPED");
Unfreeze(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
RemoveStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_KIDNAPPED");
PROC_SetRelationToPlayers((FACTION)Act3_LOW_CazadorsPalace_Kennel_60569cd9-fb2b-4d2b-968a-42a6ac7dd579, 0);
NOT DB_DangerZone_SafeBubble((TRIGGER)S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88);

IF
LeftTrigger((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88)
AND
DB_GlobalFlag((FLAG)LOW_VampireAmbush_State_AmbushSucceded_6cf85531-c098-475c-9dba-528c039125ad)
AND
QRY_OnlyOnce("ORI_Astarion_LeftKennelAfterKidnapping")
THEN
SetFlag((FLAG)ORI_Astarion_State_LeftKennelAfterKidnapping_378e24eb-7b5b-43f4-8662-1a7f4ffed5ed);
TriggerUnregisterForCharacter((TRIGGER)S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
//END_REGION

//REGION Kennel - default flow
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_CazadorsPalace_Kennel_IllusionCheckAreaForAstarion_7e4e539b-7ebe-414c-ba07-c562e8284cb1)
AND
QRY_LOW_CazadorsPlace_Kennel_AstarionNearby(_Player)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Kennel_IllusionCheckAreaForAstarion")
THEN
SetEntityEvent(S_LOW_CazadorsPalace_Kennel_Illusion_d78f1997-209e-46c7-a2f0-66bfd72f9ecf, "StoryReveal");
SetFlag(LOW_CazadorsPalace_Kennel_State_RevealedIllusion_71b4b37b-47d0-4ac8-9767-168a215a42c1, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_PAD_AstarionsComment_24e4c7c8-97c2-ce46-d973-791f7ba5a98a, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_Kennel_IllusionCheckAreaForAstarion_7e4e539b-7ebe-414c-ba07-c562e8284cb1);

IF
AutomatedDialogEnded(LOW_CazadorsPalace_Kennel_PAD_AstarionsComment_24e4c7c8-97c2-ce46-d973-791f7ba5a98a, _)
THEN
ClearFlag(LOW_CazadorsPalace_Kennel_State_RevealedIllusion_71b4b37b-47d0-4ac8-9767-168a215a42c1, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

QRY
QRY_LOW_CazadorsPlace_Kennel_AstarionNearby((CHARACTER)_Player)
AND
_Player == S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
THEN
DB_NOOP(1);

QRY
QRY_LOW_CazadorsPlace_Kennel_AstarionNearby((CHARACTER)_Player)
AND
QRY_SpeakerIsInDialogRange(_Player, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
DB_NOOP(1);

IF
EntityEvent(S_LOW_CazadorsPalace_Kennel_Illusion_d78f1997-209e-46c7-a2f0-66bfd72f9ecf, "StoryReveal")
THEN
PROC_LOW_CazadorsPalace_Kennel_RevealIllusion();

IF
StatusApplied((ITEM)S_LOW_CazadorsPalace_Kennel_Sconce_001_d16522e2-897d-46a9-ab05-62ca6d4dae47, "BURNING", _, _)
AND
HasActiveStatus(S_LOW_CazadorsPalace_Kennel_Sconce_002_6a1e8432-0086-47f9-96fa-ca815dbb54a7, "BURNING", 1)
THEN
PROC_LOW_CazadorsPalace_Kennel_RevealIllusion();

IF
StatusApplied((ITEM)S_LOW_CazadorsPalace_Kennel_Sconce_002_6a1e8432-0086-47f9-96fa-ca815dbb54a7, "BURNING", _, _)
AND
HasActiveStatus(S_LOW_CazadorsPalace_Kennel_Sconce_001_d16522e2-897d-46a9-ab05-62ca6d4dae47, "BURNING", 1)
THEN
PROC_LOW_CazadorsPalace_Kennel_RevealIllusion();

// in case the player somehow entered the room without discovering the door
IF
EnteredTrigger(_PartyMember, (TRIGGER)S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88)
AND
DB_PartyMembers(_PartyMember)
THEN
PROC_TriggerUnregisterForParty((TRIGGER)S_LOW_CazadorsPalace_Kennel_RoomArea_e58b56b6-c7ad-458f-bc10-8ca1b90e0d88);
PROC_LOW_CazadorsPalace_Kennel_RevealIllusion();

PROC
PROC_LOW_CazadorsPalace_Kennel_RevealIllusion()
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Kennel_RevealIllusion")
THEN
PlayEffect((ITEM)S_LOW_CazadorsPalace_Kennel_Illusion_d78f1997-209e-46c7-a2f0-66bfd72f9ecf, (EFFECTRESOURCE)VFX_Script_Illusion_Perception_Check_Overlay_01_b8fe40e4-b49b-f7b1-25ba-f5b97341a16d);
RealtimeObjectTimerLaunch((ITEM)S_LOW_CazadorsPalace_Kennel_Illusion_d78f1997-209e-46c7-a2f0-66bfd72f9ecf, "LOW_CazadorsPalace_Kennel_RevealIllusion", 600);

IF
ObjectTimerFinished(S_LOW_CazadorsPalace_Kennel_Illusion_d78f1997-209e-46c7-a2f0-66bfd72f9ecf, "LOW_CazadorsPalace_Kennel_RevealIllusion")
THEN
PROC_SetOnStage(S_LOW_CazadorsPalace_Kennel_Illusion_d78f1997-209e-46c7-a2f0-66bfd72f9ecf, 0);
SetCanInteract((ITEM)S_LOW_CazadorsPalace_Kennel_Door_b52934e3-1be1-4073-afae-38caeed0d584, 1);
Unlock((ITEM)S_LOW_CazadorsPalace_Kennel_Door_b52934e3-1be1-4073-afae-38caeed0d584);

IF
DB_GlobalFlag((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438)
AND
NOT DB_PermaDefeated(S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f)
AND
GetFaction(S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f, _SkeletonFaction)
THEN
PROC_CancelAmbush(S_LOW_CazadorsPalace_Kennel_AmbushArea_b1f8c8a7-7029-4752-8ce7-f9381bcc82bc);
PROC_SetRelationToPlayers(_SkeletonFaction, 0);

PROC
PROC_LaunchAmbush((TRIGGER)S_LOW_CazadorsPalace_Kennel_AmbushArea_b1f8c8a7-7029-4752-8ce7-f9381bcc82bc, _Player)
THEN
SetFlag((FLAG)LOW_CazadorsPalace_Kennel_State_SkeletonSurprisedPlayer_a220fa00-e9bb-461b-8578-3eea131c9aa1, NULL_00000000-0000-0000-0000-000000000000);
PROC_ItemCloseAndLock((ITEM)S_LOW_CazadorsPalace_Kennel_Door_b52934e3-1be1-4073-afae-38caeed0d584, "LOW_CazadorsPalace_Kennel_Door");

PROC
PROC_LaunchAmbush((TRIGGER)S_LOW_CazadorsPalace_Kennel_AmbushArea_b1f8c8a7-7029-4752-8ce7-f9381bcc82bc, _Player)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Kennel_AmbushDialog")
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_Skeleton_3b9f7512-fe9e-29d4-797d-af07d97a36b6, S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f, _Player)
AND
NOT DB_QRYRTN_StartDialog_FailReason("OriginMomentOverride")
THEN
PROC_LOW_CazadorsPalace_Kennel_InitiateFight();

PROC
PROC_LaunchAmbush((TRIGGER)S_LOW_CazadorsPalace_Kennel_AmbushArea_b1f8c8a7-7029-4752-8ce7-f9381bcc82bc, _PartyMember)
AND
NOT DB_Players(_PartyMember)
AND
DB_PartyMembers(_PartyMember)
AND
CharacterGetOwner(_PartyMember, _Owner)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_Skeleton_3b9f7512-fe9e-29d4-797d-af07d97a36b6, S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f, _Owner)
AND
NOT DB_QRYRTN_StartDialog_FailReason("OriginMomentOverride")
THEN
PROC_LOW_CazadorsPalace_Kennel_InitiateFight();

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_Skeleton_3b9f7512-fe9e-29d4-797d-af07d97a36b6, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_Kennel_State_ConvincedSkeleton_3f7c5b5a-1ae3-4cab-811e-9280c0d9bb14)
THEN
PROC_LOW_CazadorsPalace_Kennel_InitiateFight();

PROC
PROC_LOW_CazadorsPalace_Kennel_InitiateFight()
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_CazadorsPalace_Kennel_60569cd9-fb2b-4d2b-968a-42a6ac7dd579, 0);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_Kennel_State_ConvincedSkeleton_3f7c5b5a-1ae3-4cab-811e-9280c0d9bb14)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_LOW_CazadorsPalace_Kennel_Door_b52934e3-1be1-4073-afae-38caeed0d584);

// if the skeleton gives us the ring in the dialog,
// then we play PAD about the ring and book after the dialog is over
IF
FlagSet((FLAG)LOW_CazadorsPalace_Kennel_State_HasSzarrRing_98b11c1c-e774-4a1e-9704-7e72f7f4a8d8, (CHARACTER)_Player, _ID)
AND
DB_Players(_Player)
AND
DB_DialogPlayers(_ID, _Player, _)
THEN
DB_LOW_CazadorsPalace_Kennel_CommentOnRingAfterDialog(_ID, _Player);

IF
DialogEnded(_Dialog, _ID)
AND
DB_LOW_CazadorsPalace_Kennel_CommentOnRingAfterDialog(_ID, _Player)
THEN
NOT DB_LOW_CazadorsPalace_Kennel_CommentOnRingAfterDialog(_ID, _Player);
PROC_LOW_CazadorsPalace_Kennel_FoundRing(_Player);

// if you looted the ring from the body or stole it with another player that is not in the dialog
// then we play the PAD about the ring and book immediately
IF
FlagSet((FLAG)LOW_CazadorsPalace_Kennel_State_HasSzarrRing_98b11c1c-e774-4a1e-9704-7e72f7f4a8d8, (CHARACTER)_Player, _ID)
AND
DB_Players(_Player)
AND
NOT DB_DialogPlayers(_ID, _Player, _)
THEN
PROC_LOW_CazadorsPalace_Kennel_FoundRing(_Player);

PROC
PROC_LOW_CazadorsPalace_Kennel_FoundRing((CHARACTER)_Player)
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_State_FoundRing_c2115fec-139c-4250-8330-0dcb08766238)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_State_FoundRing_c2115fec-139c-4250-8330-0dcb08766238);
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_PAD_RingAndBook_92cf2ac0-1c5c-5f37-2d82-41ffda5299ee, _Player);

QRY
QRY_OriginMoment_PreventRelaunchDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_OM_Astarion_AOM_OOM_1661dcc6-b196-3797-9d1e-07dbeebd1d2a, _, _)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_PreventRelaunchDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Kennel_OM_Astarion_COM_000d3cad-251b-69db-6ec4-7e39f859466a, _, _)
THEN
DB_NOOP(1);
//END_REGION

//REGION Bedrooms
IF
EnteredTrigger((CHARACTER)S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, (TRIGGER)S_LOW_CazadorsPalace_Bedrooms_Area_7bc9f477-7dcd-433b-a2e1-4c41d3285fc5)
THEN
SetFlag(LOW_CazadorsPalace_Bedrooms_State_CorpseInside_0a2da1f2-1140-4f59-8b08-386e70ed9d3a);

IF
LeftTrigger((CHARACTER)S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, (TRIGGER)S_LOW_CazadorsPalace_Bedrooms_Area_7bc9f477-7dcd-433b-a2e1-4c41d3285fc5)
THEN
ClearFlag(LOW_CazadorsPalace_Bedrooms_State_CorpseInside_0a2da1f2-1140-4f59-8b08-386e70ed9d3a);

IF
EnteredTrigger((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, S_LOW_CazadorsPalace_Bedrooms_AstarionsCommentArea_937c6027-ae2c-477f-99dd-2a9f3a923f75)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_Bedrooms_PAD_AstarionsComment_150ca38c-9628-cd09-307d-e6da3dc1f058, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
PROC_TriggerUnregisterForPlayers(S_LOW_CazadorsPalace_Bedrooms_AstarionsCommentArea_937c6027-ae2c-477f-99dd-2a9f3a923f75);

IF
Died((CHARACTER)S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74)
THEN
ApplyStatus(S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, "LOW_CAZADORSPALACE_DEADGIRL_AURA", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
AddedTo(S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, (CHARACTER)_InventoryHolder, _)
AND
DB_Players(_InventoryHolder)
THEN
PROC_SetCorpseOwner((CHARACTER)S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, _InventoryHolder);
SetCharacterLootOwned(S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, 0);

IF
StatusRemoved(S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, "LOW_CAZADORSPALACE_DEADGIRL_AURA", _, _)
THEN
SetFlag(LOW_CazadorsPalace_Bedrooms_State_CurseRemoved_0fa27064-6ece-45e6-bd21-fb3f01b711d5);

IF
DB_PermaDefeated(S_LOW_CazadorsPalace_Bedrooms_DeadGirlsDoor_46d0a1fb-3740-4c8d-9705-1ad571efccbf)
THEN
PROC_KnowledgeCheck_Clear(S_LOW_CazadorsPalace_Bedrooms_DeadGirlsDoorKnowledgeCheckArea_7b33021f-2cfa-424c-b4e5-8bd792cd3b5e);

IF
UseFinished(_Character, (ITEM)S_LOW_CazadorsPalace_Bedrooms_DeadGirlsDoor_46d0a1fb-3740-4c8d-9705-1ad571efccbf, 1)
AND
HasActiveStatus(S_LOW_CazadorsPalace_Bedrooms_DeadGirlsDoor_46d0a1fb-3740-4c8d-9705-1ad571efccbf, "LOW_CAZADORSPALACE_DEADGIRL_DOOR", 1)
THEN
RemoveStatus(S_LOW_CazadorsPalace_Bedrooms_DeadGirlsDoor_46d0a1fb-3740-4c8d-9705-1ad571efccbf, "LOW_CAZADORSPALACE_DEADGIRL_DOOR", _Character);
ApplyStatus(_Character, "LOW_CAZADORSPALACE_DEADGIRL_STATUS", 6.0, 1, S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74);
PROC_LOW_CazadorsPalace_Bedrooms_DamagedByDeadGirl(_Character);

IF
StatusApplied((CHARACTER)_PartyMember, "LOW_CAZADORSPALACE_DEADGIRL_STATUS", _, _)
AND
DB_PartyMembers(_PartyMember)
AND
IsInForceTurnBasedMode(_PartyMember, 0)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Bedrooms_DeadGirlsAuraStatus")
THEN
ForceTurnBasedMode(_PartyMember, 1);
PROC_LOW_CazadorsPalace_Bedrooms_DamagedByDeadGirl(_PartyMember);

PROC
PROC_LOW_CazadorsPalace_Bedrooms_DamagedByDeadGirl((CHARACTER)_Character)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Bedrooms_DamagedByDeadGirl")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_Bedrooms_PAD_DamagedBySinisterEnergy_76c5a30e-7afa-f5d1-9715-3f2841f02ad1, _Character);

IF
GameBookInterfaceClosed((ITEM)S_LOW_CazadorsPalace_Bedrooms_AncientLanguageBook_7d0f3b3d-afcf-49a7-af68-b51fbb83a01f, _Player)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_State_ReadBook_c5709b91-cd0f-4a8a-9400-777234670180)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_State_ReadBook_c5709b91-cd0f-4a8a-9400-777234670180);
PROC_TryStartAD(LOW_CazadorsPalace_Bedrooms_PAD_BookAndRing_d38ad444-2bc4-cf94-643a-7a399b2ad49e, _Player);

QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74)
THEN
DB_NOOP(1);
//END_REGION

//REGION Ballroom
PROC
PROC_BlockUseOfItem(_Player, (ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_Ballroom_State_DoorOpenedOnce_ce614a26-b07b-4c51-a493-436c65281e8c)
AND
IsInTrigger(_Player, (TRIGGER)S_LOW_CazadorsPalace_Ballroom_MainDoorBackTrigger_f188e07d-c045-4e69-98b8-af2f9d7f5655, 0)
AND
IsOpened((ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, 0)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_CazadorsPalace_Ballroom_MainDoor_393218c1-e909-e035-6291-30dfa67d3622, S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, _Player)
THEN
DB_CustomUseItemResponse(_Player, (ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, 0);

IF
FlagSet((FLAG)LOW_CazadorsPalace_Ballroom_Event_OpenDoor_5c450f44-1c79-47d1-944a-66cf07003abc, _, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_Ballroom_State_DoorOpenedOnce_ce614a26-b07b-4c51-a493-436c65281e8c)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_Ballroom_State_DoorOpenedOnce_ce614a26-b07b-4c51-a493-436c65281e8c);

IF
FlagSet((FLAG)LOW_CazadorsPalace_Ballroom_Event_OpenDoor_5c450f44-1c79-47d1-944a-66cf07003abc, _, _)
THEN
ClearFlag((FLAG)LOW_CazadorsPalace_Ballroom_Event_OpenDoor_5c450f44-1c79-47d1-944a-66cf07003abc);
RemoveStatus(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, "LOW_CAZADORSPALACE_SINISTERDOOR_ARCANE_LOCK");

IF
DualEntityEvent(_, S_LOW_CazadorsPalace_Ballroom_MainDoorLever_New_31e2b0ca-4a0a-4c1c-a678-cffe89ad8bac, "LOW_CazadorsPalace_Ballroom_DoorEvent")
AND
HasActiveStatus(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, "LOW_CAZADORSPALACE_SINISTERDOOR_ARCANE_LOCK", 0)
AND
IsClosed((ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, 1)
THEN
Open(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37);

IF
DualEntityEvent(_, S_LOW_CazadorsPalace_Ballroom_MainDoorLever_New_31e2b0ca-4a0a-4c1c-a678-cffe89ad8bac, "LOW_CazadorsPalace_Ballroom_DoorEvent")
AND
HasActiveStatus(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, "LOW_CAZADORSPALACE_SINISTERDOOR_ARCANE_LOCK", 0)
AND
IsOpened((ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, 1)
THEN
Close(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37);

IF
DualEntityEvent(_, S_LOW_CazadorsPalace_Ballroom_MainDoorLever_New_31e2b0ca-4a0a-4c1c-a678-cffe89ad8bac, "LOW_CazadorsPalace_Ballroom_DoorEvent")
AND
HasActiveStatus(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, "LOW_CAZADORSPALACE_SINISTERDOOR_ARCANE_LOCK", 1)
THEN
RemoveStatus(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, "LOW_CAZADORSPALACE_SINISTERDOOR_ARCANE_LOCK");

IF
StatusRemoved(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, "LOW_CAZADORSPALACE_SINISTERDOOR_ARCANE_LOCK", _, _)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37);

IF
Opened((ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_Ballroom_State_DoorOpenedOnce_ce614a26-b07b-4c51-a493-436c65281e8c);

IF
DB_LOW_CazadorsPalace_Ballroom_Werewolves(_Werewolf)
THEN
DB_SpotPlayers_SpotTrigger(_Werewolf, "LOW_CazadorsPalace_Ballroom", (TRIGGER)S_LOW_CazadorsPalace_Ballroom_SpotTrigger_0f7315e6-d0f2-4a6e-844f-8378b63f5292);
DB_SpotPlayers(_Werewolf, "LOW_CazadorsPalace_Ballroom", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_CazadorsPalace_Ballroom", _Player)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Ballroom_Spotted")
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Ballroom_WerewolvesAttack_1aabceef-f4cb-651c-445a-1f9145547abb, S_LOW_CazadorsPalace_Ballroom_Werewolf_003_f21aa31f-4b01-405d-a54e-4fa1ca0b64ab, _Player)
THEN
PROC_LOW_CazadorsPalace_MakeBallroomHostile();

IF
DB_PermaDefeated(S_LOW_CazadorsPalace_Ballroom_Werewolf_003_f21aa31f-4b01-405d-a54e-4fa1ca0b64ab)
THEN
PROC_LOW_CazadorsPalace_MakeBallroomHostile();

PROC
PROC_LOW_CazadorsPalace_MakeBallroomHostile()
AND
QRY_OnlyOnce("LOW_CazadorsPalace_MakeBallroomHostile")
AND
GetFaction(S_LOW_CazadorsPalace_Ballroom_Werewolf_003_f21aa31f-4b01-405d-a54e-4fa1ca0b64ab, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 0);

// if we click on an NPC from invisibility then
// 	if another player in WerewolvesAttack dialog - we are added to that dialog as ListeningActor
// 	otherwise we start the dialog
IF
DB_LOW_CazadorsPalace_Ballroom_Werewolves(_NPC)
THEN
SetHasDialog(_NPC, 1);
DB_LOW_CazadorsPalace_Ballroom_NPCs((CHARACTER)_NPC);

IF
DB_LOW_CazadorsPalace_Ballroom_Minions(_NPC)
THEN
SetHasDialog(_NPC, 1);
DB_LOW_CazadorsPalace_Ballroom_NPCs((CHARACTER)_NPC);

QRY
QRY_SelectCustomDialog_AfterGenerics(_NPC, _Player)
AND
DB_LOW_CazadorsPalace_Ballroom_NPCs((CHARACTER)_NPC)
AND
DB_DialogName((DIALOGRESOURCE)LOW_CazadorsPalace_Ballroom_WerewolvesAttack_1aabceef-f4cb-651c-445a-1f9145547abb, _ID)
THEN
PROC_DialogAddListeningActor(_ID, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(_NPC, _Player)
AND
DB_LOW_CazadorsPalace_Ballroom_NPCs((CHARACTER)_NPC)
AND
NOT DB_DialogName((DIALOGRESOURCE)LOW_CazadorsPalace_Ballroom_WerewolvesAttack_1aabceef-f4cb-651c-445a-1f9145547abb, _)
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Ballroom_WerewolvesAttack_1aabceef-f4cb-651c-445a-1f9145547abb, S_LOW_CazadorsPalace_Ballroom_Werewolf_003_f21aa31f-4b01-405d-a54e-4fa1ca0b64ab, _Player);	

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_Ballroom_WerewolvesAttack_1aabceef-f4cb-651c-445a-1f9145547abb, _)
AND
GetFaction(S_LOW_CazadorsPalace_Ballroom_Werewolf_003_f21aa31f-4b01-405d-a54e-4fa1ca0b64ab, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 0);

QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)S_LOW_CazadorsPalace_Ballroom_DeadGuest_001_ec3f0cbe-94fc-43dd-87b3-dc175209c3e0)
THEN
DB_NOOP(1);

QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)S_LOW_CazadorsPalace_Ballroom_DeadGuest_002_4a870fc7-2e02-42f7-99b1-dac86c65157a)
THEN
DB_NOOP(1);
//END_REGION

//REGION General Dungeon Area
IF
EnteredTrigger((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_LOW_CazadorsPalace_Dungeon_AstarionsCommentArea_92c0d5a8-9545-44ee-a35b-1f70afea5b50)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_Dungeon_PAD_AstarionsComment_51d187e3-b1f2-d1ab-4ef3-d6ea9c651b96, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_Dungeon_AstarionsCommentArea_92c0d5a8-9545-44ee-a35b-1f70afea5b50);

IF
DB_LOW_CazadorsPalace_DoorsWithMagicalProtection(_Door, _)
THEN
ApplyStatus(_Door, "LOW_CAZADORSPALACE_RINGDOOR_BARRIER", -1.0);
DB_LOW_CazadorsPalace_DoorsWithStatuses(_Door, "LOW_CAZADORSPALACE_RINGDOOR_BARRIER");
PROC_LoopEffect(VFX_Script_BLD_Cazador_Grating_Gate_A_Door_Ring_01_7d508b78-9583-e23c-281f-2f7ac0284c46, _Door, "LOW_CazadorsPalace_DoorVFX", "CTY_Main_A", "");

IF
DB_LOW_CazadorsPalace_CellsDoors(_Door, _, _)
THEN
ApplyStatus(_Door, "LOW_CAZADORSPALACE_CELLSDOOR_BARRIER", -1.0);
DB_LOW_CazadorsPalace_DoorsWithStatuses(_Door, "LOW_CAZADORSPALACE_CELLSDOOR_BARRIER");
PROC_LoopEffect(VFX_Script_BLD_Cazador_Grating_Gate_A_Door_01_78a8d5a6-9598-7673-0d77-ecd94719fd8a, _Door, "LOW_CazadorsPalace_DoorVFX", "CTY_Main_A", "");

PROC
PROC_BlockUseOfItem(_Player, _Door)
AND
DB_Players(_Player)
AND
DB_LOW_CazadorsPalace_DoorsWithMagicalProtection(_Door, _Flag)
AND
NOT DB_GlobalFlag(_Flag)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_CazadorsPalace_Dungeon_DoorWithProtection_cdb1cf92-9479-e71a-45a8-6e2a627f200b, _Door, _Player)
THEN
DB_CustomUseItemResponse(_Player, (ITEM)_Door, 0);

IF
FlagSet((FLAG)LOW_CazadorsPalace_Dungeon_Event_OpenSpecialDoor_c8c056bc-77d9-48d9-87db-4e3a28052b38, _, _ID)
AND
DB_DialogNPCs(_ID, _Door, _)
AND
DB_LOW_CazadorsPalace_DoorsWithMagicalProtection((ITEM)_Door, _Flag)
THEN
ClearFlag(LOW_CazadorsPalace_Dungeon_Event_OpenSpecialDoor_c8c056bc-77d9-48d9-87db-4e3a28052b38);
SetFlag(_Flag);
PROC_LOW_CazadorsPalace_Dungeon_OpenDoor(_Door);

PROC
PROC_LOW_CazadorsPalace_Dungeon_OpenDoor((ITEM)_Door)
AND
DB_LOW_CazadorsPalace_DoorsWithStatuses(_Door, _Status)
THEN
RemoveStatus(_Door, _Status);
PROC_StopLoopEffect(_Door, "LOW_CazadorsPalace_DoorVFX");
NOT DB_LOW_CazadorsPalace_DoorsWithStatuses(_Door, _Status);

PROC
PROC_LOW_CazadorsPalace_Dungeon_OpenDoor((ITEM)_Door)
THEN
PROC_ItemUnlockAndOpen(_Door);
//END_REGION

//REGION Crypt
PROC
PROC_BlockUseOfItem(_Player, (ITEM)S_LOW_CazadorsPalace_Crypt_Skull_72104d6e-365a-4ccf-8ad1-c7d448c9e403)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("LOW_CazadorsPalace_Crypt_SkullToPlayer")
AND
QRY_StartDialog_Fixed(LOW_CazadorsPalace_Crypt_Skull_eebdd5aa-cb4d-4a97-3be8-c8956437476b, S_LOW_CazadorsPalace_Crypt_Skull_72104d6e-365a-4ccf-8ad1-c7d448c9e403, _Player)
THEN
DB_CustomUseItemResponse(_Player, (ITEM)S_LOW_CazadorsPalace_Crypt_Skull_72104d6e-365a-4ccf-8ad1-c7d448c9e403, 0);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_Crypt_Skull_eebdd5aa-cb4d-4a97-3be8-c8956437476b, _ID)
AND
DB_GlobalFlag(LOW_CazadorsPalace_Crypt_State_NoScroll_663377b5-ff20-4909-b5da-75c996d9a5fa)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Crypt_SkullToPlayer")
THEN
Transform(S_LOW_CazadorsPalace_Crypt_Skull_72104d6e-365a-4ccf-8ad1-c7d448c9e403, (ITEMROOT)PUZ_Cazador_Skull_Ancient_A_0cc92889-414e-4dc9-9fba-f900325c3d64, POLYMORPH_a0ddddc8-255f-4014-9f63-d7608eb1c2a0);
ToInventory((ITEM)S_LOW_CazadorsPalace_Crypt_Scroll_591d390d-68b7-4937-9103-3772493ab132, _Player, 1, 1, 1);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_Crypt_Skull_eebdd5aa-cb4d-4a97-3be8-c8956437476b, _ID)
AND
DB_GlobalFlag(LOW_CazadorsPalace_Crypt_State_NoScroll_663377b5-ff20-4909-b5da-75c996d9a5fa)
AND
QRY_IsInRange(S_LOW_CazadorsPalace_Crypt_Skull_72104d6e-365a-4ccf-8ad1-c7d448c9e403, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 20.0)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_Crypt_SkullComment")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_Crypt_PAD_CazadorsSkullComment_ba997a6f-41e2-e5ce-4301-a53e00cb8b25, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

IF
DB_GlobalFlag(_Flag)
AND
DB_LOW_CazadorsPalace_CazadorsJournalEntries(_Flag, _CazadorsJournalEntry)
AND
NOT DB_LOW_CazadorsPalace_AddedJournalEntries(_CazadorsJournalEntry)
THEN
DB_LOW_CazadorsPalace_AddedJournalEntries(_CazadorsJournalEntry);
AddEntryToCustomBook("LOW_CazadorsPalace_CazadorsJournal", _CazadorsJournalEntry);

IF
UseStarted(_Player, (ITEM)S_LOW_CazadorsPalace_Crypt_CazadorsJournal_74b8042a-2392-40af-a5c1-abaaa14da7cb)
THEN
OpenReferencedBookUI(_Player, "LOW_CazadorsPalace_CazadorsJournal", S_LOW_CazadorsPalace_Crypt_CazadorsJournal_74b8042a-2392-40af-a5c1-abaaa14da7cb);

IF
CustomBookUIClosed(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "LOW_CazadorsPalace_CazadorsJournal")
AND
DB_LOW_CazadorsPalace_Crypt_BooksReactions((ITEM)S_LOW_CazadorsPalace_Crypt_CazadorsJournal_74b8042a-2392-40af-a5c1-abaaa14da7cb, _ReactionPAD)
AND
NOT DB_LOW_CazadorsPalace_Crypt_BookReactionTried(_ReactionPAD)
AND
QRY_IsInRange((ITEM)S_LOW_CazadorsPalace_Crypt_CazadorsJournal_74b8042a-2392-40af-a5c1-abaaa14da7cb, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 20.0)
THEN
PROC_TryStartAD(_ReactionPAD, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_LOW_CazadorsPalace_Crypt_BookReactionTried((DIALOGRESOURCE)_ReactionPAD);

IF
GameBookInterfaceClosed(_Book, _)
AND
DB_LOW_CazadorsPalace_Crypt_BooksReactions(_Book, _ReactionPAD)
AND
NOT DB_LOW_CazadorsPalace_Crypt_BookReactionTried(_ReactionPAD)
AND
QRY_IsInRange(_Book, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 20.0)
THEN
PROC_TryStartAD(_ReactionPAD, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_LOW_CazadorsPalace_Crypt_BookReactionTried((DIALOGRESOURCE)_ReactionPAD);
//END_REGION

//REGION Cells
IF
DB_LOW_CazadorsPalace_Cells_Prisoners(_Prisoner, _Dialog, _)
THEN
PROC_CharacterDisableAllCrimes(_Prisoner);
DB_Dialogs(_Prisoner, _Dialog);
DB_DialogBlockAttackButton(_Dialog);
DB_DialogBlockTradeButton(_Dialog);
DB_CRIME_Guards_NoSummonBy(_Prisoner);
SetCanJoinCombat(_Prisoner, 0);
PROC_SetCanFight(_Prisoner, 0);
ApplyStatus(_Prisoner, "LOW_CAZADORSPALACE_PRISONER_INVULNERABILITY", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
SetTag(_Prisoner, (TAG)IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);

IF
DB_LOW_CazadorsPalace_Cells_Prisoners(_Prisoner, _Dialog, 1)
THEN
DB_Children(_Prisoner);

PROC
PROC_SpotPlayers_Spotted(_, "LOW_CazadorsPalace_Cells", _Player)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_NoAstarion_85cd0c84-7814-69b4-a58e-e98c94f9bdc3, S_LOW_CazadorsPalace_Cells_Prisoner_001_5f39e17d-28dc-4d48-8370-91bb41098c44, _Player)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_NoAstarion_85cd0c84-7814-69b4-a58e-e98c94f9bdc3, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_Cells_State_OMHappened_58ce1207-c80e-462d-8a6a-48e1cd0b2fd4)
AND
NOT QRY_SpotPlayers_IsSpotting(S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, "LOW_CazadorsPalace_Cells")
THEN
DB_SpotPlayers_HasTag((CHARACTER)S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, "LOW_CazadorsPalace_Cells", (TAG)ASTARION_23a46e79-e73c-4043-940f-cb0aace9ab2e, 1);
PROC_SpotPlayers_RestartSpotting(S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, "LOW_CazadorsPalace_Cells");

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_CazadorsPalace_Cells_State_OMHappened_58ce1207-c80e-462d-8a6a-48e1cd0b2fd4, (DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d, _ID)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, ORI_Astarion_IPRD_Sebastian_91e624ec-578f-4b14-a294-0fcdc91dd875, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0);

PROC
PROC_BlockUseOfItem(_Player, _Door)
AND
DB_Players(_Player)
AND
DB_LOW_CazadorsPalace_CellsDoors(_Door, _Dialog, _Speaker)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_KilledPrisoners_a138792f-04ae-410b-afce-1bf661e9c868)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240)
AND
QRY_StartDialog_Fixed(_Dialog, _Speaker, _Player)
THEN
DB_CustomUseItemResponse(_Player, (ITEM)_Door, 0);

QRY
QRY_OriginMoment_PreventRelaunchDialog(LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48, _, _)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_PreventRelaunchDialog(LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d, _, _)
THEN
DB_NOOP(1);

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_CazadorsPalace_Cells_State_HostileToAstarion_29824693-4f15-4d4a-a288-18ee9d42dea5)
THEN
ApplyStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_PRISONERSCURSE", -1.0);
//END_REGION

//REGION Exit to the sewers
IF
UseFinished(_Player, S_DOOR_Invisible_A_CazadorSecret_toSewer_fab6923e-6e2f-4ae3-8427-e0a2d1a4a471, 1)
AND
IsLocked((ITEM)S_DOOR_Invisible_A_CazadorSecret_toDungeon_61cebd40-b770-4f29-9090-fa0b6777b1e4, 1)
THEN
Unlock((ITEM)S_DOOR_Invisible_A_CazadorSecret_toDungeon_61cebd40-b770-4f29-9090-fa0b6777b1e4);
//END_REGION

//REGION Behavior Support
IF
Moved(S_LOW_CazadorsPalace_Candelabra_3e0cb0ff-0efa-4472-a1c6-cec321431117)
THEN
SetFlag(LOW_CazadorsPalace_State_CandelabraMoved_29918a98-9c4f-4910-9675-1e8bf8eea925);

IF
DestroyingBy(S_LOW_CazadorsPalace_Candelabra_3e0cb0ff-0efa-4472-a1c6-cec321431117, _, _, _)
THEN
SetFlag(LOW_CazadorsPalace_State_CandelabraDestroyed_b5d6921b-2e99-4183-8768-2373719c1d9b);
//END_REGION

//REGION Debug
IF
TextEvent("kidnapastarion")
THEN
PROC_LOW_CazadorsPalace_Kennel_KidnapAstarion();

IF
TextEvent("cp_givering")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_LOW_CazadorsPalace_Kennel_SzarrRing_9fd82243-7e92-4fd1-847c-f4fe215c583f, _Player, 1, 1, 1);

IF
TextEvent("cp_givebook")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_LOW_CazadorsPalace_Bedrooms_AncientLanguageBook_7d0f3b3d-afcf-49a7-af68-b51fbb83a01f, _Player, 1, 1, 1);

IF
TextEvent("cp_openbr")
THEN
PROC_ItemUnlockAndOpen((ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37);

IF
TextEvent("cp_closebr")
THEN
PROC_ItemCloseAndLock((ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, "NO_KEY");

IF
TextEvent("cp_openaddoor")
THEN
PROC_LOW_CazadorsPalace_Dungeon_OpenDoor((ITEM)S_LOW_CazadorsPalace_Cells_AdultDoor_aa404054-9dae-4684-82aa-48c948295e6c);

IF
TextEvent("cp_openchdoor")
THEN
PROC_LOW_CazadorsPalace_Dungeon_OpenDoor((ITEM)S_LOW_CazadorsPalace_Cells_ChildrenDoor_6bca442f-383d-46a6-be5b-a5e046aa853e);

IF
TextEvent("cp_opencrdoor")
THEN
PROC_LOW_CazadorsPalace_Dungeon_OpenDoor((ITEM)S_LOW_CazadorsPalace_Crypt_EntranceDoor_5a1fccda-99bd-4c8d-befa-eec0b55e36b2);

IF
TextEvent("cp_openrrdoor")
THEN
PROC_LOW_CazadorsPalace_Dungeon_OpenDoor((ITEM)S_LOW_CazadorsPalace_Cells_EntranceDoor_197240c8-d485-4e84-aede-ba1fed46b2fa);
//END_REGION

//REGION Danger Zone
// Dungeon & Mansion become safe zones when one of the two conditions is fullfilled:
// 1. Cazador & Ulma dead;
// 2. Cazador is dead, Ulma is peaceful;
IF
DB_PermaDefeated(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
DB_PermaDefeated(S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890)
THEN
PROC_LOW_CazadorsPalace_MakeSafe();

// Gur only appear if Cazador is dead, so only one flag needs to be checked
IF
FlagSet(LOW_GurFollowUp_State_PeacefulResolution_260836ee-6f67-4ea4-9e2c-ccae94a75035, _, _)
THEN
PROC_LOW_CazadorsPalace_MakeSafe();

PROC
PROC_LOW_CazadorsPalace_MakeSafe()
THEN
PROC_DangerZone_Safe("LOW_CazadorsPalace_GroundLevelArea");
PROC_DangerZone_Safe("LOW_CazadorsPalace_DungeonArea");
PROC_DangerZone_Safe("LOW_CazadorsPalace_AtticArea");
PROC_DangerZone_Safe("LOW_CazadorsPalace_BasementArea");

QRY
QRY_LOW_CazadorsPalace_IsSafe()
AND
DB_GlobalFlag((FLAG)LOW_GurFollowUp_State_PeacefulResolution_260836ee-6f67-4ea4-9e2c-ccae94a75035)
THEN
DB_NOOP(1);

QRY
QRY_LOW_CazadorsPalace_IsSafe()
AND
DB_PermaDefeated(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
DB_PermaDefeated(S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890)
THEN
DB_NOOP(1);
//END_REGION Danger Zone

//REGION Secret Entrance
IF
UseFinished(_, (ITEM)S_DOOR_Invisible_A_CazadorSecret_toSewer_fab6923e-6e2f-4ae3-8427-e0a2d1a4a471, 1)
THEN
PROC_LOW_CazadorsPalace_UnlockEntranceFromSewers();

PROC
PROC_LOW_GurFollowUp_GurTribeLeftDungeon()
AND
IsLocked((ITEM)S_DOOR_CazExit_91150b94-1ae4-420e-af0f-804c11f85737, 1)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_DOOR_CazExit_91150b94-1ae4-420e-af0f-804c11f85737);
PROC_LOW_CazadorsPalace_UnlockEntranceFromSewers();

PROC
PROC_LOW_CazadorsPalace_UnlockEntranceFromSewers()
AND
QRY_OnlyOnce("LOW_CazadorsPalace_UnlockEntranceFromSewers")
THEN
SetCanInteract((ITEM)S_DOOR_Invisible_A_CazadorSecret_toDungeon_61cebd40-b770-4f29-9090-fa0b6777b1e4, 1);
SetCanInteract((ITEM)S_CazadorSlidingWall_5ac0b737-66ef-45bd-b17a-e246724e2f2e, 1);
PROC_ItemUnlockAndOpen((ITEM)S_CazadorSlidingWall_5ac0b737-66ef-45bd-b17a-e246724e2f2e);
//END_REGION

//REGION Vases and Bed
IF
AutomatedDialogStarted(_VaseDialog, _)
AND
DB_LOW_CazadorsPalace_Dungeon_Vases(_Vase, _VaseDialog, _ID)
AND
QRY_OnlyOnce(_ID)
THEN
PROC_LoopEffect(VFX_Script_Light_Green_01_21d9c555-b8f1-5f33-97a1-31bfa48e107e, _Vase, _ID, "__ANY__", "");
RealtimeObjectTimerLaunch(_Vase, _ID, 500);
DB_LOW_CazadorsPalace_Dungeon_VaseActivated(_ID);

IF
ObjectTimerFinished((ITEM)_Vase, _ID)
AND
DB_LOW_CazadorsPalace_Dungeon_Vases(_Vase, _, _ID)
THEN
PROC_StopLoopEffect(_Vase, _ID);

IF
UseFinished(_Player, (ITEM)S_LOW_CazadorsPalace_CazadorsBed_37988b31-ebad-4079-ab06-068270f62f0f, 1)
AND
DB_Players(_Player)
AND
DB_LOW_CazadorsPalace_Dungeon_VaseActivated("LOW_CazadorsPalace_CrystalVaseLeft")
AND
DB_LOW_CazadorsPalace_Dungeon_VaseActivated("LOW_CazadorsPalace_CrystalVaseRight")
AND
NOT DB_OnlyOncePerPlayer(_Player, "LOW_CazadorsPalace_Dungeon_CazadorsBedUsed")
THEN
DB_OnlyOncePerPlayer(_Player, "LOW_CazadorsPalace_Dungeon_CazadorsBedUsed");
PROC_LOW_CazadorsPalace_Dungeon_CazadorsBedUsed((CHARACTER)_Player);

PROC
PROC_LOW_CazadorsPalace_Dungeon_CazadorsBedUsed((CHARACTER)_Player)
AND
DB_LOW_CazadorsPalace_Dungeon_Candlesticks(_Candlestick)
AND
NOT DB_Destroyed(_Candlestick)
THEN
SetEntityEvent(_Candlestick, "turnOff", 1);

PROC
PROC_LOW_CazadorsPalace_Dungeon_CazadorsBedUsed((CHARACTER)_Player)
THEN
ApplyStatus(_Player, "FALSE_LIFE_3", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_LongRest()
THEN
DB_ExecuteInLevel("LOW_CazadorsPalace_TurnOnCandles","CTY_Main_A");

PROC
PROC_ExecuteInLevel("LOW_CazadorsPalace_TurnOnCandles","CTY_Main_A")
AND
DB_LOW_CazadorsPalace_Dungeon_Candlesticks(_Candlestick)
AND
NOT DB_Destroyed(_Candlestick)
THEN
SetEntityEvent(_Candlestick, "turnOn", 1);

PROC
PROC_LongRest()
AND
DB_OnlyOncePerPlayer(_Player, "LOW_CazadorsPalace_Dungeon_CazadorsBedUsed")
THEN
NOT DB_OnlyOncePerPlayer(_Player, "LOW_CazadorsPalace_Dungeon_CazadorsBedUsed");
//END_REGION

//REGION
PROC
PROC_LOW_CazadorsPalace_RemoveOldTrap()
THEN
PROC_SetOnStage(PUZ_GEN_CONST_Pressure_Plate_Marble_Square_NonTrap_A_Black_000_a5d827f8-fdd8-449b-a5fc-0178a761d06d, 0);
PROC_SetOnStage(PUZ_GEN_CONST_Pressure_Plate_Marble_Square_NonTrap_A_Black_001_7109726c-0c47-4905-9e89-a25c2bc2c897, 0);
PROC_SetOnStage(PUZ_GEN_CONST_Pressure_Plate_Marble_Square_NonTrap_A_Black_002_6b021bc6-aacf-4b8b-a30c-fed6ccc6c027, 0);
PROC_SetOnStage(PUZ_GEN_CONST_Pressure_Plate_Marble_Square_NonTrap_A_Black_003_dbf442df-cb6d-42df-9a65-8494460674c3, 0);
PROC_SetOnStage(PUZ_GEN_CONST_Pressure_Plate_Marble_Square_NonTrap_A_Black_004_9fbbb9d4-d5e7-42c1-8e90-2eb820583eda, 0);
PROC_SetOnStage(PUZ_GEN_CONST_Pressure_Plate_Marble_Square_NonTrap_A_Black_005_682cb78c-8b18-47c1-90aa-f0db846aa36f, 0);
PROC_SetOnStage(PUZ_GEN_Trap_Gargoyle_Statue_Turret_Head_C_000_2cf15903-ede6-4772-8830-97ebb8ca9085, 0);
PROC_SetOnStage(PUZ_GEN_Trap_Gargoyle_Statue_Turret_Head_C_001_fc09e1d4-932b-47ac-a822-d4e6ee9dc5e5, 0);
PROC_SetOnStage(PUZ_GEN_Trap_Gaspit_Temple_A_001_15f03c41-2c45-44bd-a1ed-510b97b040c0, 0);
PROC_SetOnStage(PUZ_GEN_Trap_Gaspit_Temple_A_002_e882dd49-1b96-454d-830e-b3ab9cd4e851, 0);
PROC_SetOnStage(S_DOOR_Cazador_UnderChamberA_000_46ec143e-3403-4c27-840f-613d9458b22a, 0);
PROC_SetOnStage(S_DOOR_Cazador_UnderChamberA_001_c0860abf-5a4d-4c17-9e45-e4972f5d2dcb, 0);
PROC_SetOnStage(DEC_GEN_Chain_Metal_Big_A_65m_A_Interactive_000_4c52ea78-f47d-4080-b71a-a0a00a6609d7, 0);
PROC_SetOnStage(S_Cazador_Underchamber_DamagedLever_a2805824-c37c-4105-a7c4-4e99de44d45a, 0);
PROC_SetOnStage(LOOT_GEN_Lever_Floor_Metal_A_Broken_Base_A_002_3f2b095a-bd70-4219-a640-46736400643a, 0);
PROC_SetOnStage(LOOT_GEN_Lever_Floor_Metal_A_Broken_Base_A_000_a27ea9f3-cdfc-4365-bda4-8b358da0d1c2, 0);
PROC_SetOnStage(LOOT_GEN_Lever_Floor_Metal_A_Broken_Handle_A_000_0a5e553d-163b-4912-b176-e19c13ed1513, 0);
PROC_SetOnStage(LOOT_GEN_Lever_Floor_Metal_A_Broken_Handle_A_001_f0ad61ee-271a-4ecf-ab40-fd1dadc21455, 0);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
