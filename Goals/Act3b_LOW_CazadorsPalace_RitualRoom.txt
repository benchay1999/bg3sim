Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Init
DB_GLO_SetupForAct_Character("CTY_Main_A", (CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

DB_GLO_ExclusiveFlag("LOW_CazadorsPalace_Ritual", (FLAG)LOW_CazadorsPalace_RitualRoom_State_BeforeRitual_540f9932-f058-48a3-8fa2-21254b7f830e);
DB_GLO_ExclusiveFlag("LOW_CazadorsPalace_Ritual", (FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a);
DB_GLO_ExclusiveFlag("LOW_CazadorsPalace_Ritual", (FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCompleted_7edf33ff-b185-46ed-b4d8-546c8a016387);
DB_GLO_ExclusiveFlag("LOW_CazadorsPalace_Ritual", (FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCancelled_989b59f6-b4e3-4236-a8d0-a694fddde5d4);

// Spawn, Position, Pentagram, Pentagram Trigger
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_001_062ff971-d709-4f54-bb03-51c02844eacb, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_001_94ca69d7-2184-47cc-92fe-4cd89a7df7d6, (ITEM)S_LOW_CazadorsPalace_RitualRoom_Rune_001_9a8d7873-f550-4c1f-a4fd-dba3262422e8, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_001_1cc54c07-d989-454f-9700-4bf3c4843a69);
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_002_a612de01-a750-491a-bacd-e09a67fc0de3, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_002_6e1aa083-e518-49ec-ae68-d17333d3a284, (ITEM)S_LOW_CazadorsPalace_RitualRoom_Rune_002_d74fd7a1-cbac-43e3-bfa6-cbbb5796b8c8, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_002_f6ee4605-b6f9-4f12-b058-ef4ebeca7706);
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_003_5f0fba13-103c-4ddc-81ff-de07a52f77f7, (ITEM)S_LOW_CazadorsPalace_RitualRoom_Rune_003_ef4c37eb-fa8a-465b-9539-873b033a09de, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_003_36f6edae-2f39-4b0a-ac03-43645307c9c2);
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_004_737c59cc-e0ec-4821-b059-d8f0c05089a6, (ITEM)S_LOW_CazadorsPalace_RitualRoom_Rune_004_a018ef7f-e269-4026-96b6-32fdc6e38d77, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_004_c3556707-6c0c-492c-b8a7-d1a984fd90f3);
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_004_a4dc8e21-833c-4469-a72b-1969c688b8a4, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_005_9dcf4fb4-1d87-4d26-a8d8-3e446e3311ec, (ITEM)S_LOW_CazadorsPalace_RitualRoom_Rune_005_975cefe4-5a3c-408e-a0f5-7011093e32a5, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_005_2c41eb0c-584c-4d31-993f-15f4fe76de6c);
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)S_WYR_VampireSpawns_Dalyria_204a74d2-e6ad-4e9b-a275-f03cb5f3d975, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_006_8b7d28df-342d-42f0-ab87-2642a9daa6c4, (ITEM)S_LOW_CazadorsPalace_RitualRoom_Rune_006_fe538d66-a34b-47b3-952d-7d238354e850, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_006_01d5245a-3ef3-4057-8e88-04c762046518);
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)S_WYR_VampireSpawns_Petra_6fb6e85e-ccd0-42ef-a37d-1e256a433f3b, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_007_d3d5f06b-d255-4523-94c6-2e4c59089a6e, (ITEM)S_LOW_CazadorsPalace_RitualRoom_Rune_007_58209a8c-4c92-4dc1-857e-c5f26ef9498d, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_007_2687f607-eaee-406a-90c0-9b5d3afe782a);

// pentagram trigger, connected grating
DB_LOW_CazadorsPalace_RitualRoom_Gratings((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_001_1cc54c07-d989-454f-9700-4bf3c4843a69, (ITEM)S_LOW_CazadorsPalace_RitualRoom_GlowingGratingHelper_001_6d5acf2c-19b2-410c-b54c-ebad87b41a00);
DB_LOW_CazadorsPalace_RitualRoom_Gratings((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_002_f6ee4605-b6f9-4f12-b058-ef4ebeca7706, (ITEM)S_LOW_CazadorsPalace_RitualRoom_GlowingGratingHelper_002_58ecf93f-529f-45ff-8ec1-0685cb5e15e0);
DB_LOW_CazadorsPalace_RitualRoom_Gratings((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_003_36f6edae-2f39-4b0a-ac03-43645307c9c2, (ITEM)S_LOW_CazadorsPalace_RitualRoom_GlowingGratingHelper_003_3886ee94-256c-4be3-ba70-a7ca5a0593d2);
DB_LOW_CazadorsPalace_RitualRoom_Gratings((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_004_c3556707-6c0c-492c-b8a7-d1a984fd90f3, (ITEM)S_LOW_CazadorsPalace_RitualRoom_GlowingGratingHelper_004_353ced4d-0cf5-4f74-8184-64f1b5eeb147);
DB_LOW_CazadorsPalace_RitualRoom_Gratings((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_005_2c41eb0c-584c-4d31-993f-15f4fe76de6c, (ITEM)S_LOW_CazadorsPalace_RitualRoom_GlowingGratingHelper_005_eba2f518-47cd-4aa6-ad40-b36539242a2a);
DB_LOW_CazadorsPalace_RitualRoom_Gratings((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_006_01d5245a-3ef3-4057-8e88-04c762046518, (ITEM)S_LOW_CazadorsPalace_RitualRoom_GlowingGratingHelper_006_6103fbee-0a0f-4b54-bf05-b7b9e4ac9fb2);
DB_LOW_CazadorsPalace_RitualRoom_Gratings((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_007_2687f607-eaee-406a-90c0-9b5d3afe782a, (ITEM)S_LOW_CazadorsPalace_RitualRoom_GlowingGratingHelper_007_93c453d7-ec4a-42e0-ba55-ff311aa8df79);

DB_LOW_CazadorsPalace_RitualRoom_Buffs(1, "LOW_CAZADORSPALACE_SPAWNBUFF_001", "LOW_CAZADORSPALACE_SARCOPHAGUS_BEAM_001");
DB_LOW_CazadorsPalace_RitualRoom_Buffs(2, "LOW_CAZADORSPALACE_SPAWNBUFF_002", "LOW_CAZADORSPALACE_SARCOPHAGUS_BEAM_002");
DB_LOW_CazadorsPalace_RitualRoom_Buffs(3, "LOW_CAZADORSPALACE_SPAWNBUFF_003", "LOW_CAZADORSPALACE_SARCOPHAGUS_BEAM_003");
DB_LOW_CazadorsPalace_RitualRoom_Buffs(4, "LOW_CAZADORSPALACE_SPAWNBUFF_004", "LOW_CAZADORSPALACE_SARCOPHAGUS_BEAM_004");
DB_LOW_CazadorsPalace_RitualRoom_Buffs(5, "LOW_CAZADORSPALACE_SPAWNBUFF_005", "LOW_CAZADORSPALACE_SARCOPHAGUS_BEAM_005");
DB_LOW_CazadorsPalace_RitualRoom_Buffs(6, "LOW_CAZADORSPALACE_SPAWNBUFF_006", "LOW_CAZADORSPALACE_SARCOPHAGUS_BEAM_006");
DB_LOW_CazadorsPalace_RitualRoom_Buffs(7, "LOW_CAZADORSPALACE_SPAWNBUFF_007", "LOW_CAZADORSPALACE_SARCOPHAGUS_BEAM_007");

// pentagram trigger, extra buff
DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffs((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_003_36f6edae-2f39-4b0a-ac03-43645307c9c2, "LOW_CAZADORSPALACE_SPAWNBUFF_YOUSEN");
DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffs((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_004_c3556707-6c0c-492c-b8a7-d1a984fd90f3, "LOW_CAZADORSPALACE_SPAWNBUFF_ASTARION");
DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffs((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RuneTrigger_005_2c41eb0c-584c-4d31-993f-15f4fe76de6c, "LOW_CAZADORSPALACE_SPAWNBUFF_VIOLET");

// once per turn only
DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffsHelpers("LOW_CAZADORSPALACE_SPAWNBUFF_ASTARION", "LOW_CAZADORSPALACE_SPAWNBUFF_ASTARION_TECHNICAL");

DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_001_062ff971-d709-4f54-bb03-51c02844eacb, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Spawn_001_ddc84f02-7cf7-744f-e0ae-6ee090b0aad4);
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_002_a612de01-a750-491a-bacd-e09a67fc0de3, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Spawn_002_fc7c5cf5-3213-5044-8e7f-7b441391f75d);
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Spawn_003_d8b67abb-828e-8c61-4579-3bd7fac37e11);
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_004_a4dc8e21-833c-4469-a72b-1969c688b8a4, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Spawn_004_102b7d1b-f43d-9240-7784-c34918621c75);
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs((CHARACTER)S_WYR_VampireSpawns_Dalyria_204a74d2-e6ad-4e9b-a275-f03cb5f3d975, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Dalyria_c417651b-a4a7-8a00-d20a-481969b2f4fb);
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs((CHARACTER)S_WYR_VampireSpawns_Petra_6fb6e85e-ccd0-42ef-a37d-1e256a433f3b, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Petras_b1c83f95-aa53-c830-a411-9e2c5577942a);

DB_LOW_CazadorsPalace_RitualRoom_RitualForms((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_001_062ff971-d709-4f54-bb03-51c02844eacb, (CHARACTERROOT)S_LOW_CazadorsPalace_RitualRoom_Spawn_001_Ritual_88f2b674-5e09-4819-8ac7-04b1be422dec);
DB_LOW_CazadorsPalace_RitualRoom_RitualForms((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_002_a612de01-a750-491a-bacd-e09a67fc0de3, (CHARACTERROOT)S_LOW_CazadorsPalace_RitualRoom_Spawn_002_Ritual_9c85d82a-819f-4aed-8d70-abe45875b7b1);
DB_LOW_CazadorsPalace_RitualRoom_RitualForms((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf, (CHARACTERROOT)S_LOW_CazadorsPalace_RitualRoom_Spawn_003_Ritual_bc89115e-94ea-4dcd-98ec-864ba29303d4);
DB_LOW_CazadorsPalace_RitualRoom_RitualForms((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_004_a4dc8e21-833c-4469-a72b-1969c688b8a4, (CHARACTERROOT)S_LOW_CazadorsPalace_RitualRoom_Spawn_004_Ritual_6c2d5b8b-a582-4e3c-af28-4d5c7255c98d);
DB_LOW_CazadorsPalace_RitualRoom_RitualForms((CHARACTER)S_WYR_VampireSpawns_Dalyria_204a74d2-e6ad-4e9b-a275-f03cb5f3d975, (CHARACTERROOT)S_WYR_VampireSpawns_Dalyria_Ritual_d53769c4-02b7-4a1c-af0b-d27c5e0391bf);
DB_LOW_CazadorsPalace_RitualRoom_RitualForms((CHARACTER)S_WYR_VampireSpawns_Petra_6fb6e85e-ccd0-42ef-a37d-1e256a433f3b, (CHARACTERROOT)S_WYR_VampireSpawns_Petra_Ritual_874214ac-dceb-45de-8120-f77fe8c8069c);

DB_LOW_CazadorsPalace_RitualRoom_Spotters((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Zombie_01_0692451b-3093-4cf8-9370-55783a45d3d1);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Zombie_02_24880c17-853e-4d0d-9243-1da4d1f32cb9);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Zombie_04_978c53cd-db10-4eb0-81c3-7afac4344f39);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Ritualist_01_e98c8ed5-1d3e-4b92-a05a-3b90107905c3);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Bat_01_02bbc7ca-66c8-4a8f-b518-c599506442e5);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Bat_02_6cc1a7ea-611c-40d7-b4b5-f1a2c9819644);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Bat_03_a8290645-9301-4ec0-b481-a7c49844a2aa);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Bat_04_d4f70089-3956-4ed5-8aa1-c231b9bb23ab);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Bat_05_ea827be9-8e09-4331-9abe-d08d4c690f45);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Bat_06_341fc0da-f6c4-4540-aeed-5b2cae43e5f4);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Werewolf_01_20ff3b11-d07a-4ecc-ae23-41fc09966ba5);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Werewolf_02_79138f67-ed4a-4d3a-8fb7-1e4c4d6c8620);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Werewolf_03_471eff9e-66df-468c-919a-d7160f02e46e);
DB_LOW_CazadorsPalace_RitualRoom_Minions((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Werewolf_04_f8eb826d-9071-4fc4-aeee-9383fab42bac);

// template, round, position
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 3, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_01_e11cde2a-a76e-4607-8633-fb2bf87cdd6d);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 3, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_02_5409a339-ec8d-4887-a951-cd1ec06a5619);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 3, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_03_e5bf5f1c-d081-497d-a230-0e10b77a2aa5);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 3, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_04_15749af3-c8f8-4b44-bac5-4bbfff2dd85f);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 3, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_05_f71ccb5a-f493-4455-93e1-25bf25469ddb);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 3, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_06_54158d74-d2ac-4092-8367-d163167e373c);

DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 6, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_01_e11cde2a-a76e-4607-8633-fb2bf87cdd6d);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 6, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_02_5409a339-ec8d-4887-a951-cd1ec06a5619);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 6, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_03_e5bf5f1c-d081-497d-a230-0e10b77a2aa5);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 6, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_04_15749af3-c8f8-4b44-bac5-4bbfff2dd85f);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 6, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_05_f71ccb5a-f493-4455-93e1-25bf25469ddb);
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions((CHARACTERROOT)LOW_Bat_Cazador_Ritual_Swarmed_52081abb-e6ad-40aa-acd1-46ce81340400, 6, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_BatPoint_06_54158d74-d2ac-4092-8367-d163167e373c);
//END_REGION Init

//REGION Approaching the Ritual Room
PROC_TriggerRegisterForPlayers(S_LOW_CazadorsPalace_RitualRoom_LoneAstarionWarning_fd2a64a4-5d0b-4e96-b6d2-2d40a62c3ac0);
//END_REGION Approaching the Ritual Room

//REGION Before the combat
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6, 
	(TAG)ASTARION_23a46e79-e73c-4043-940f-cb0aace9ab2e, 
	(DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212,
	(DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212,
	(DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, 30.0);

PROC_TriggerRegisterForParty(S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03);

DB_AddCharactersInTriggerToDialog(LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03, 1, 1, 0);
DB_AddCharactersInTriggerToDialog_IgnoreHidden((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6);
DB_AddCharactersInTriggerToDialog(LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03, 1, 1, 0);
DB_AddCharactersInTriggerToDialog_IgnoreHidden((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212);

DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6);
DB_DialogBlockTradeButton((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212);
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212);
//END_REGION Before the combat

//REGION Combat
// scriptures start glowing from the outer ring to the inner ring
DB_LOW_CazadorsPalace_RitualRoom_RitualIndicators((ITEM)S_LOW_CazadorsPalace_RitualRoom_RoundIndicator_003_a695ea65-f76c-44e5-a1eb-a553c533c276, 1);
DB_LOW_CazadorsPalace_RitualRoom_RitualIndicators((ITEM)S_LOW_CazadorsPalace_RitualRoom_RoundIndicator_002_442f7c8a-2282-419d-9de3-8b15175046ed, 2);
DB_LOW_CazadorsPalace_RitualRoom_RitualIndicators((ITEM)S_LOW_CazadorsPalace_RitualRoom_RoundIndicator_001_09f0b7a5-3b7b-4bc1-b844-3e7e07db9e6a, 3);

AddPreferredAiTargetTag((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, ASTARION_23a46e79-e73c-4043-940f-cb0aace9ab2e);
//END_REGION Combat

//REGION After the combat
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09,
	(TAG)ASTARION_23a46e79-e73c-4043-940f-cb0aace9ab2e,
	(DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b,
	(DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b,
	(DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);
DB_OriginMoment_DontAutoClearOriginMoment(LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);

DB_DialogBlockAttackButton(LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09);
DB_DialogBlockTradeButton(LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09);

DB_DialogBlockAttackButton(LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);
DB_DialogBlockTradeButton(LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);

DB_OriginMoment_ExtraNPCs(LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03, 1, 1, 0);

DB_PermaDefeatedFlag(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, (FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438);
DB_GLO_ExclusiveFlag("LOW_CazadorsPalace_RitualRoom_CazadorState", (FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c);
DB_GLO_ExclusiveFlag("LOW_CazadorsPalace_RitualRoom_CazadorState", (FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438);
DB_OriginMayLeaveDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);

DB_Inclusion_Object(S_WYR_VampireSpawns_Dalyria_204a74d2-e6ad-4e9b-a275-f03cb5f3d975, (FLAG)LOW_CazadorsPalace_Dalyria_StartInclusion_e56cf5a6-7438-420f-9bce-72a9bd3fe700, (FLAG)LOW_CazadorsPalace_Dalyria_EndInclusion_35f6bcb7-0019-4233-9cb9-30bc020c0bd5);
DB_Inclusion_Object(S_WYR_VampireSpawns_Petra_6fb6e85e-ccd0-42ef-a37d-1e256a433f3b, (FLAG)LOW_CazadorsPalace_Petra_StartInclusion_950d720a-809b-4552-a107-2bd99c623e63, (FLAG)LOW_CazadorsPalace_Petra_EndInclusion_b2db88f5-762a-4491-8daf-df3004fa7707);
DB_Inclusion_NPCDialog(LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, (CHARACTER)S_WYR_VampireSpawns_Dalyria_204a74d2-e6ad-4e9b-a275-f03cb5f3d975);
DB_Inclusion_NPCDialog(LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, (CHARACTER)S_WYR_VampireSpawns_Petra_6fb6e85e-ccd0-42ef-a37d-1e256a433f3b);
DB_Inclusion_NPCDialog(LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, (CHARACTER)S_WYR_VampireSpawns_Dalyria_204a74d2-e6ad-4e9b-a275-f03cb5f3d975);
DB_Inclusion_NPCDialog(LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, (CHARACTER)S_WYR_VampireSpawns_Petra_6fb6e85e-ccd0-42ef-a37d-1e256a433f3b);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611, (DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);

// Astarion knows that Cazador is dead if he kills him himself
DB_GLO_CompoundFlag((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546, (FLAG)ORI_Astarion_Knows_CazadorDead_5f891b0c-a2d8-4d6c-9f99-3012ab00b54e);
DB_GLO_CompoundFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, (FLAG)ORI_Astarion_Knows_CazadorDead_5f891b0c-a2d8-4d6c-9f99-3012ab00b54e);
//END_REGION

//REGION Combat Reactivity
DB_CombatReact_AD_StatusRemoved(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, LOW_CazadorsPalace_RitualRoom_AD_BuffRemoved_001_Combat_ee4a186e-2009-f47a-be12-cfd4462a4219, "LOW_CAZADORSPALACE_SPAWNBUFF_007");
DB_CombatReact_AD_StatusRemoved(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, LOW_CazadorsPalace_RitualRoom_AD_BuffRemoved_002_Combat_2c442107-0d6c-1133-344e-f8fb1e304d00, "LOW_CAZADORSPALACE_SPAWNBUFF_006");
//END_REGION

//REGION Cinematic support for additional speakers in dialogs
DB_LOW_CazadorsPalace_RitualRoom_PostCombatAdditionalSpeakers((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_001_062ff971-d709-4f54-bb03-51c02844eacb);
DB_LOW_CazadorsPalace_RitualRoom_PostCombatAdditionalSpeakers((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_002_a612de01-a750-491a-bacd-e09a67fc0de3);
DB_LOW_CazadorsPalace_RitualRoom_PostCombatAdditionalSpeakers((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf);
DB_LOW_CazadorsPalace_RitualRoom_PostCombatAdditionalSpeakers((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_004_a4dc8e21-833c-4469-a72b-1969c688b8a4);
//END_REGION
KBSECTION
//REGION Init
PROC
PROC_GLO_SetupForAct("CTY_Main_A", S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1)
THEN
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3,
	(TRIGGER)S_LOW_CazadorsPalace_RitualRoom_CazadorsDefaultPos_a3a70d4c-8ab8-4835-9a72-9b0eefb1b1e3,
	(FACTION)Act3_LOW_CazadorsPalace_RitualRoom_0aa59526-0d5a-4db1-be35-10df64686385,
	(DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6,
	"LOW_CazadorsPalace_RitualRoom_CazadorTeleported");
PROC_SetOnStage(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1);
SetCombatGroupID(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_RitualRoom");
SetImmortal((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1);
DB_CustomDialogRange(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 50);
DB_NoLowAttitudeDialog((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
SetCanTrade((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0);

IF
DB_LOW_CazadorsPalace_RitualRoom_RitualIndicators(_Indicator, _)
THEN
SetDetached(_Indicator, 0);

// Flag LOW_CazadorsPalace_RitualRoom_State_CazadorGotAstarion needs to be set
// before flag LOW_CazadorsPalace_RitualRoom_State_BeforeRitual
IF
FlagSet(LOW_CazadorsPalace_EnteredDungeon_740ea5cd-7ada-4610-aadb-f52026782700, _, _)
THEN
PROC_LOW_CazadorsPalace_CheckAstarionAndProceed();

PROC
PROC_LOW_CazadorsPalace_CheckAstarionAndProceed()
AND
DB_GlobalFlag((FLAG)GLO_Origin_PartOfTheTeam_Astarion_24ae9cee-0516-47c6-8291-cb143256264d)
THEN
PROC_LOW_CazadorsPalace_PlayerEnteredDungeon();

PROC
PROC_LOW_CazadorsPalace_CheckAstarionAndProceed()
AND
NOT DB_GlobalFlag((FLAG)GLO_Origin_PartOfTheTeam_Astarion_24ae9cee-0516-47c6-8291-cb143256264d)
AND
IsDead((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0)
THEN
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorGotAstarion_f353a103-3a5e-489e-ab3c-4520f835e24c);
PROC_LOW_CazadorsPalace_PlayerEnteredDungeon();

PROC
PROC_LOW_CazadorsPalace_CheckAstarionAndProceed()
AND
NOT DB_GlobalFlag((FLAG)GLO_Origin_PartOfTheTeam_Astarion_24ae9cee-0516-47c6-8291-cb143256264d)
AND
IsDead((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
AND
IsInInventory(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0)
THEN
TeleportTo(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, S_LOW_CazadorsPalace_RitualRoom_AsylumPos_5a9de1d3-dbfa-4796-96f5-973cee523b32, "LOW_CazadorsPalace_DeadAstarionTeleportedToAsylum", 0, 0, 0, 0, 1);

PROC
PROC_LOW_CazadorsPalace_CheckAstarionAndProceed()
AND
NOT DB_GlobalFlag((FLAG)GLO_Origin_PartOfTheTeam_Astarion_24ae9cee-0516-47c6-8291-cb143256264d)
AND
IsDead((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
AND
IsInInventory(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
THEN
PROC_LOW_CazadorsPalace_PlayerEnteredDungeon();

IF
EntityEvent(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CazadorsPalace_DeadAstarionTeleportedToAsylum")
THEN
DB_LOW_CazadorsPalace_RitualRoom_AstarionIsBeingResurrected(1);
Resurrect((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

IF
Resurrected((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_LOW_CazadorsPalace_RitualRoom_AstarionIsBeingResurrected(1)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_AstarionIsBeingResurrected(1);
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorGotAstarion_f353a103-3a5e-489e-ab3c-4520f835e24c);
PROC_LOW_CazadorsPalace_PlayerEnteredDungeon(); // the rest of the setup will be below with all the other spawns

PROC
PROC_LOW_CazadorsPalace_PlayerEnteredDungeon()
THEN
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_BeforeRitual_540f9932-f058-48a3-8fa2-21254b7f830e);
//END_REGION

//REGION Warning for the players not to enter the ritual room with Astarion only
IF
EnteredTrigger((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_LoneAstarionWarning_fd2a64a4-5d0b-4e96-b6d2-2d40a62c3ac0)
AND
GetClosestAlivePlayer(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _OtherPlayer, _Dist)
AND
_Dist > 30.0
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_LoneAstarionWarning_fd2a64a4-5d0b-4e96-b6d2-2d40a62c3ac0);
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_AD_LoneAstarionWarning_bc57d57b-fc43-1670-6fab-0401fe3224be, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

IF
EnteredTrigger(_PartyMember, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03)
AND
DB_PartyMembers(_PartyMember)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CazadorsPalace_RitualRoom_LoneAstarionWarning_fd2a64a4-5d0b-4e96-b6d2-2d40a62c3ac0);
//END_REGION

//REGION Before the ritual
IF
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_BeforeRitual_540f9932-f058-48a3-8fa2-21254b7f830e)
THEN
DB_SceneManager((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_RitualRoom_BeforeRitual");
DB_SceneNoHostileContinuousDisturbance("LOW_CazadorsPalace_RitualRoom_BeforeRitual");
SetCombatGroupID(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_RitualRoom");

IF
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_BeforeRitual_540f9932-f058-48a3-8fa2-21254b7f830e)
AND
DB_LOW_CazadorsPalace_RitualRoom_Minions(_Minion)
THEN
DB_SceneManager(_Minion, "LOW_CazadorsPalace_RitualRoom_BeforeRitual");
SetCombatGroupID(_Minion, "LOW_CazadorsPalace_RitualRoom");
SetHasDialog(_Minion, 1);

IF
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_BeforeRitual_540f9932-f058-48a3-8fa2-21254b7f830e)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_, _, _, _PentagramTrigger)
THEN
PROC_TriggerRegisterForParty(_PentagramTrigger);
TriggerRegisterForCharacter(_PentagramTrigger, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

IF
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_BeforeRitual_540f9932-f058-48a3-8fa2-21254b7f830e)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spotters(_Spotter)
THEN
DB_SpotPlayers(_Spotter, "LOW_CazadorsPalace_RitualRoom", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(_Spotter, "LOW_CazadorsPalace_RitualRoom", (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpotArea_b736e33e-8875-4193-be94-275de35805bd);

IF
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_BeforeRitual_540f9932-f058-48a3-8fa2-21254b7f830e)
AND
DB_LOW_CazadorsPalace_RitualRoom_Minions(_Minion)
THEN
DB_SpotPlayers(_Minion, "LOW_CazadorsPalace_RitualRoom", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(_Minion, "LOW_CazadorsPalace_RitualRoom", (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpotArea_b736e33e-8875-4193-be94-275de35805bd);

IF
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_BeforeRitual_540f9932-f058-48a3-8fa2-21254b7f830e)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _Trigger, _, _)
AND
QRY_LOW_CazadorsPalace_RitualRoom_SpawnCanBeTeleported(_Spawn)
THEN
TeleportTo(_Spawn, _Trigger, "LOW_CazadorsPalace_RitualRoom_SpawnTeleported", 0, 0, 0, 1, 1);
SetCombatGroupID(_Spawn, "LOW_CazadorsPalace_RitualRoom");

QRY
QRY_LOW_CazadorsPalace_RitualRoom_SpawnCanBeTeleported((CHARACTER)_Spawn)
AND
_Spawn != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
THEN
DB_NOOP(1);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_SpawnCanBeTeleported((CHARACTER)_Spawn)
AND
_Spawn == S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorGotAstarion_f353a103-3a5e-489e-ab3c-4520f835e24c)
THEN
DB_NOOP(1);

IF
EntityEvent((CHARACTER)_Spawn, "LOW_CazadorsPalace_RitualRoom_SpawnTeleported")
THEN
PROC_Foop(_Spawn);
RemoveHarmfulStatuses(_Spawn);
SetHitpointsPercentage(_Spawn, 100.0);
SetImmortal(_Spawn, 0);
ApplyStatus(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
SetFaction(_Spawn, (FACTION)Act3_LOW_CazadorsPalace_RitualRoom_Spawns_128ae9fe-23a3-4fb3-bb67-24b925290f8d);
SetCanFight(_Spawn, 0); // they still have CanJoinCombat enabled since we want the statuses to tick in FTB
DB_DoNotChangeAttitudeAfterCombat(_Spawn);
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants((CHARACTER)_Spawn);
DB_SceneManager(_Spawn, "LOW_CazadorsPalace_RitualRoom_BeforeRitual");

// Spawns don't participate in combat while crystalized, but we need them in the turn order
// to ensure the statuses on them tick in turn-based mode and not in real time
// We give them a swarm group to prevent the camera constantly go through each spawn
// when it's their turn
IF
StatusApplied(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED", _, _)
THEN
RequestSetSwarmGroup(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED");

IF
StatusRemoved(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED", _, _)
THEN
RequestSetSwarmGroup(_Spawn, "");

IF
EntityEvent((CHARACTER)_Spawn, "LOW_CazadorsPalace_RitualRoom_SpawnTeleported")
AND
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs(_Spawn, _)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Spawn);
SetHasDialog(_Spawn, 0);

IF
EntityEvent((CHARACTER)_Spawn, "LOW_CazadorsPalace_RitualRoom_SpawnTeleported")
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualForms(_Spawn, _RitualForm)
THEN
Transform(_Spawn, _RitualForm, (SHAPESHIFTRULE)DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);

IF
EntityEvent(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CazadorsPalace_RitualRoom_SpawnTeleported")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
PROC_GlobalSetFlagAndCache(ORI_Astarion_State_NecroZombie_273d5473-cfd1-4fec-b1f5-a4db0ac4f4ed);
Transform(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, Undead_Zombie_Melee_5b2827cb-1cf9-4cd5-9b58-0f7eb4657f0c, (SHAPESHIFTRULE)LOW_AstarionZombie_32b73660-dd8e-46ce-9b07-81dd8581b918);
SetStoryDisplayName(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CazadorsPalace_ZombieAstarion");
PROC_GLO_UnequipAllWeapons((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

PROC
PROC_SceneInterrupted(_, _Player, "LOW_CazadorsPalace_RitualRoom_BeforeRitual", _Reason)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
THEN
DB_SceneManager_AllowViolenceDisturbanceRegistration("LOW_CazadorsPalace_RitualRoom_BeforeRitual");
PROC_SceneOver("LOW_CazadorsPalace_RitualRoom_BeforeRitual");
PROC_LOW_CazadorsPalace_RitualRoom_MakeRitualRoomHostile();

PROC
PROC_SceneInterrupted(_, _Player, "LOW_CazadorsPalace_RitualRoom_BeforeRitual", "DisturbanceRegistering")
AND
DB_SceneManager_DisturbanceRegistering(_Player, "Assault_Monster_Sunlight", _, _, _, _CrimeID)
THEN
DB_SceneManager_AllowDisturbance(_CrimeID);
PROC_SceneOver("LOW_CazadorsPalace_RitualRoom_BeforeRitual");

PROC
PROC_LOW_CazadorsPalace_RitualRoom_MakeRitualRoomHostile()
AND
GetFaction(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _CazadorFaction)
THEN
PROC_SetRelationToPlayers(_CazadorFaction, 0);

// edge-case - the player attacked Cazador without Astarion in the party
// then Astarion entered the room during the fight
// we'd want Cazador to start the OM dialog
IF
EnteredCombat(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _)
AND
NOT DB_LOW_CazadorsPalace_PreCombatOMHappened(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCannotBeCompleted_71cb0aae-aea2-4304-9932-4c57bf6669a8)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_PreCombat_LookingForAstarion")
THEN
PROC_LOW_CazadorsPalace_RitualRoom_StartSpottingAstarion();

IF
FlagSet((FLAG)LOW_CazadorsPalace_Cazador_State_FetchingAstarion_a2d019a4-164c-1028-e2ae-8651b3e4cf08, _, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_StartSpottingAstarion();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_StartSpottingAstarion()
THEN
PROC_SpotPlayers_StopSpotting("LOW_CazadorsPalace_RitualRoom");
DB_OriginMoment_IgnoreCombat((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212);
DB_SpotPlayers_HasTag((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_PreCombat_LookingForAstarion", (TAG)ASTARION_23a46e79-e73c-4043-940f-cb0aace9ab2e, 1);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_PreCombat_LookingForAstarion", (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_SpotArea_b736e33e-8875-4193-be94-275de35805bd);
DB_SpotPlayers_IgnoreCombat((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_PreCombat_LookingForAstarion");
DB_SpotPlayers_TargetIgnoreCantTalk(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_PreCombat_LookingForAstarion");
DB_SpotPlayers((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_PreCombat_LookingForAstarion", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_CazadorsPalace_RitualRoom", _Player)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_RitualRoom_PreCombatOM")
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Player)
AND
NOT DB_QRYRTN_StartDialog_FailReason("OriginMomentOverride")
AND
GetFaction(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 0);

PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_CazadorsPalace_PreCombat_LookingForAstarion", _Player)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_RitualRoom_PreCombatOM_LookingForAstarion")
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Player)
AND
NOT DB_QRYRTN_StartDialog_FailReason("OriginMomentOverride")
AND
NOT DB_Is_InCombat(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _)
AND
GetFaction(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 0);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)_Minion, _Player)
AND
DB_LOW_CazadorsPalace_RitualRoom_Minions(_Minion)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Player)
AND
GetFaction(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 0);

PROC
PROC_DialogFlagSetup(LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, _, _)
AND
DB_Players(_Player)
AND
_Player != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
GetDistanceTo(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Player, _Dist)
AND
_Dist < 20.0
THEN
PROC_GlobalSetFlagAndCache(LOW_CazadorsPalace_RitualRoom_State_AnotherPartyMemberPresent_fcfad818-3f62-493b-a03a-bbc28f4b370e);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, _)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_AnotherPartyMemberPresent_fcfad818-3f62-493b-a03a-bbc28f4b370e)
THEN
PROC_GlobalClearFlagAndCache(LOW_CazadorsPalace_RitualRoom_State_AnotherPartyMemberPresent_fcfad818-3f62-493b-a03a-bbc28f4b370e);


QRY
QRY_OriginMoment_PreventRelaunchDialog((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, _, _)
THEN
DB_NOOP(1);

// Cazador teleports Astarion to the ritual position during PreCombat dialog
IF
FlagSet(LOW_CazadorsPalace_RitualRoom_Event_TeleportAstarion_1318f561-8b32-4ac2-bb85-a4f2b93f53d4, _, _)
THEN
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255); // can't wait till we are actually teleported
TeleportTo(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_004_737c59cc-e0ec-4821-b059-d8f0c05089a6, "LOW_CazadorsPalace_RitualRoom_AstarionTeleportedDuringDialog", 0, 0, 0, 1, 1);

IF
EntityEvent(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CazadorsPalace_RitualRoom_AstarionTeleportedDuringDialog")
THEN
ApplyStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", -1.0, 1, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

// Cazador teleports Astarion to the ritual position during combat
IF
CastedSpell(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "Target_LOW_RitualCapture_Cazador", _, _, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_CaptureAstarion();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CaptureAstarion()
THEN
SetFlag((FLAG)ORI_Astarion_State_CapturedInCombat_705422ce-924a-4267-a16e-067aed0f3089);
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_AD_TeleportingAstarionToRitualPosition_7fa32da3-0c9d-a859-bc1c-08d7be9eb0a0, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
DB_LOW_CazadorsPalace_RitualRoom_AstarionCapturedInCombat(1);
RemoveStatusesWithType(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "DOWNED", NULL_00000000-0000-0000-0000-000000000000);
RemoveHarmfulStatuses(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
SetHitpoints(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1);
TeleportTo(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_004_737c59cc-e0ec-4821-b059-d8f0c05089a6, "LOW_CazadorsPalace_RitualRoom_AstarionTeleportedDuringCombat", 0, 0, 0, 1, 1);

IF
EntityEvent(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CazadorsPalace_RitualRoom_AstarionTeleportedDuringCombat")
THEN
Freeze((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
RealtimeObjectTimerLaunch(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CazadorsPalace_RitualRoom_IncapacitateAstarion", 2000);

IF
ObjectTimerFinished(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CazadorsPalace_RitualRoom_IncapacitateAstarion")
THEN
Unfreeze((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
ApplyStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", -1.0, 1, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

IF
StatusApplied(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", _, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_AstarionCapturedInCombat(1)
THEN
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

IF
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_LOW_CazadorsPalace_RitualRoom_AstarionCapturedInCombat(1)
AND
NOT QRY_LOW_CazadorsPalace_RitualRoom_CanStartRitualInCombat()
THEN
PROC_LOW_CazadorsPalace_RitualRoom_EnableBeam((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyBuffs();
NOT DB_LOW_CazadorsPalace_RitualRoom_AstarionCapturedInCombat(1);

IF
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_LOW_CazadorsPalace_RitualRoom_AstarionCapturedInCombat(1)
AND
QRY_LOW_CazadorsPalace_RitualRoom_CanStartRitualInCombat()
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a);
NOT DB_LOW_CazadorsPalace_RitualRoom_AstarionCapturedInCombat(1);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_CanStartRitualInCombat()
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCannotBeCompleted_71cb0aae-aea2-4304-9932-4c57bf6669a8)
THEN
DB_NOOP(1);

IF
StatusRemoved(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", _, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _, _Pentagram, _)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
PROC_LOW_CazadorsPalace_RitualRoom_DisableBeam((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
RemoveStatus(_Pentagram, "LOW_CAZADORSPALACE_PENTAGRAM_BUFF_GLOW");
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyBuffs();

IF
DialogStarted((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, _)
THEN
DB_LOW_CazadorsPalace_PreCombatOMHappened(1);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, _)
THEN
PROC_SceneOver("LOW_CazadorsPalace_RitualRoom_BeforeRitual");
PROC_LOW_CazadorsPalace_RitualRoom_MakeRitualRoomHostile();

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6, _)
AND
DB_GlobalFlag(ORI_Astarion_State_NecroZombie_273d5473-cfd1-4fec-b1f5-a4db0ac4f4ed)
THEN
PROC_SceneOver("LOW_CazadorsPalace_RitualRoom_BeforeRitual");
PROC_LOW_CazadorsPalace_RitualRoom_MakeRitualRoomHostile();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_MakeRitualRoomHostile()
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a);

PROC
PROC_SceneOver("LOW_CazadorsPalace_RitualRoom_BeforeRitual")
THEN
SetFlag(ORI_Astarion_State_PreRitualSceneEnded_8e60ef2f-d3cc-49b2-a552-70a545caceed);
PROC_SpotPlayers_StopSpotting("LOW_CazadorsPalace_RitualRoom");
PROC_SpotPlayers_StopSpotting("LOW_CazadorsPalace_PreCombat_LookingForAstarion");
//END_REGION Before the Ritual

//REGION Additional minions
IF
EnteredCombat(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _ID)
AND
DB_LOW_CazadorsPalace_RitualRoom_CombatID(_OldID)
AND
_OldID != _ID
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_CombatID(_OldID);

IF
EnteredCombat(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _ID)
THEN
DB_LOW_CazadorsPalace_RitualRoom_CombatID(_ID);

IF
SwitchedCombat(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _OldID, _NewID)
AND
DB_LOW_CazadorsPalace_RitualRoom_CombatID(_OldID)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_CombatID(_OldID);
DB_LOW_CazadorsPalace_RitualRoom_CombatID(_NewID);

IF
CombatRoundStarted(_ID, _Round)
AND
DB_LOW_CazadorsPalace_RitualRoom_CombatID(_ID)
AND
QRY_LOW_CazadorsPalace_RitualRoom_AnyoneInCombat(_ID)
AND
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions(_MinionTemplate, _Round, _Pos)
AND
GetPosition(_Pos, _X, _Y, _Z)
AND
CreateAt(_MinionTemplate, _X, _Y, _Z, 0, 1, "LOW_CazadorsPalace_RitualRoom_MinionSpawned", _)
THEN
DB_NOOP(1);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_AnyoneInCombat((GUIDSTRING)_ID)
AND
DB_Is_InCombat(_, _ID)
THEN
DB_NOOP(1);

IF
EntityEvent(_Minion, "LOW_CazadorsPalace_RitualRoom_MinionSpawned")
THEN
SetCombatGroupID(_Minion, "LOW_CazadorsPalace_RitualRoom");
//END_REGION

//REGION Ritual - Pentagrams & Buffs logic
IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a, _, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_BeginRitual();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_BeginRitual()
THEN
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CanProgressRitualInCombat_078a4b8e-cf26-4f2c-b4e1-efa07935f1be, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_BeginRitual()
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants(_Spawn)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_EnableBeam(_Spawn);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_BeginRitual()
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyBuffs();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyBuffs()
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyMainBuffs();
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyExtraBuffs();
// for each pentagram
//	if cazador is in pentagram - he gets +1
//  if player is in pentagram - he gets + 1
//  if nobody is in pentragram - cazador gets + 1
//  then we apply a status corresponding to the number of buffs

// we need to get a DB:
// Pentagram - Current User
// Priority - Cazador - Player - Nobody (Cazador gets the buff)
PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyMainBuffs()
AND
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_Char, _PentagramTrigger, _IsPartyMember)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_Char, _PentagramTrigger, _IsPartyMember);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyMainBuffs()
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _Pentagram, _PentagramTrigger)
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants(_Spawn)
AND
DB_LOW_CazadorsPalace_RitualRoom_ActivePentagrams(_Pentagram)
THEN
PROC_LOW_CazadorsPalace_CheckPentagram(_PentagramTrigger);

PROC
PROC_LOW_CazadorsPalace_CheckPentagram((TRIGGER)_PentagramTrigger)
AND
IsInTrigger(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _PentagramTrigger, 1)
THEN
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, (TRIGGER)_PentagramTrigger, 0);

PROC
PROC_LOW_CazadorsPalace_CheckPentagram((TRIGGER)_PentagramTrigger)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_, _PentagramTrigger, _)
AND
DB_PartyMembers(_PartyMember)
AND
IsInTrigger(_PartyMember, _PentagramTrigger, 1)
THEN
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_PartyMember, _PentagramTrigger, 1);

PROC
PROC_LOW_CazadorsPalace_CheckPentagram((TRIGGER)_PentagramTrigger)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_, _PentagramTrigger, _)
THEN
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, (TRIGGER)_PentagramTrigger, 0);

// calculate the number of buffs
PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyMainBuffs()
AND
QRY_LOW_CazadorsPalace_RitualRoom_ResetBuffCounters()
AND
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_Char, _PentagramTrigger, _)
AND
QRY_LOW_CazadorsPalace_RitualRoom_IncreaseBuffsCounter(_Char)
THEN
DB_NOOP(1);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_ResetBuffCounters()
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ClearBuffCounterDB();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ClearBuffCounterDB()
AND
DB_LOW_CazadorsPalace_RitualRoom_OldNumOfBuffs(_Char, _Num)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_OldNumOfBuffs(_Char, _Num);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ClearBuffCounterDB()
AND
DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs(_Char, _Num)
THEN
DB_LOW_CazadorsPalace_RitualRoom_OldNumOfBuffs((CHARACTER)_Char, (INTEGER)_Num);
NOT DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs(_Char, _Num);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_IncreaseBuffsCounter((CHARACTER)_Char)
AND
DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs(_Char, _Num)
AND
IntegerSum(_Num, 1, _NewSum)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs(_Char, _Num);
DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs(_Char, _NewSum);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_IncreaseBuffsCounter((CHARACTER)_Char)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs(_Char, _)
THEN
DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs((CHARACTER)_Char, 1);

// remove old statuses if necessary
PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyMainBuffs()
AND
DB_LOW_CazadorsPalace_RitualRoom_OldNumOfBuffs(_Char, _NumOfBuffs)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs(_Char, _NumOfBuffs)
AND
DB_LOW_CazadorsPalace_RitualRoom_Buffs(_NumOfBuffs, _Buff, _)
THEN
RemoveStatus(_Char, _Buff, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_LOW_CazadorsPalace_RitualRoom_OldNumOfBuffs(_Char, _NumOfBuffs);

// if has the same num of buffs - do nothing
PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyMainBuffs()
AND
DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs(_Char, _NumOfBuffs)
AND
DB_LOW_CazadorsPalace_RitualRoom_OldNumOfBuffs(_Char, _NumOfBuffs)
THEN
DB_NOOP(1);

// otherwise - apply a new buff
PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyMainBuffs()
AND
DB_LOW_CazadorsPalace_RitualRoom_NumOfBuffs(_Char, _NumOfBuffs)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_OldNumOfBuffs(_Char, _NumOfBuffs)
AND
DB_LOW_CazadorsPalace_RitualRoom_Buffs(_NumOfBuffs, _Buff, _)
THEN
ApplyStatus(_Char, _Buff, -1.0);

// Extra Buffs Logic, called after the main buffs are applied
PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyExtraBuffs()
AND
DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffs(_PentagramTrigger, _ExtraBuff)
AND
DB_LOW_CazadorsPalace_RitualRoom_AppliedExtraBuffs(_Char, _ExtraBuff)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_Char, _PentagramTrigger, _)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_AppliedExtraBuffs(_Char, _ExtraBuff);
RemoveStatus(_Char, _ExtraBuff);

// extra buff for Astarion - has an entry in DB ExtraBuffsHelpers (an additional hidden status which has a duration of 1 turn)
PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyExtraBuffs()
AND
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_Char, _PentagramTrigger, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffs(_PentagramTrigger, _ExtraBuff)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_AppliedExtraBuffs(_Char, _ExtraBuff)
AND
DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffsHelpers(_ExtraBuff, _ExtraBuffHelperStatus)
AND
HasActiveStatus(_Char, _ExtraBuffHelperStatus, 0)
THEN
DB_LOW_CazadorsPalace_RitualRoom_AppliedExtraBuffs((CHARACTER)_Char, (STRING)_ExtraBuff);
ApplyStatus(_Char, _ExtraBuff, -1.0);

// extra buff for Yousen and Violet - don't have extra buffs in DB ExtraBuffHelpers
PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyExtraBuffs()
AND
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_Char, _PentagramTrigger, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffs(_PentagramTrigger, _ExtraBuff)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_AppliedExtraBuffs(_Char, _ExtraBuff)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffsHelpers(_ExtraBuff, _)
THEN
DB_LOW_CazadorsPalace_RitualRoom_AppliedExtraBuffs((CHARACTER)_Char, (STRING)_ExtraBuff);
ApplyStatus(_Char, _ExtraBuff, -1.0);

IF
StatusApplied(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Buff, _, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_Buffs(_, _Buff, _SarcophagusBuff)
AND
HasActiveStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, _SarcophagusBuff, 0)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ClearBeamFromSarcophagus();
ApplyStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, _SarcophagusBuff, -1.0);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ClearBeamFromSarcophagus()
AND
DB_LOW_CazadorsPalace_RitualRoom_Buffs(_, _, _SarcophagusBuff)
AND
HasActiveStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, _SarcophagusBuff, 1)
THEN
RemoveStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, _SarcophagusBuff);

// visuals for buff being applied to Cazador and stolen by Player
IF
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_, _PentagramTrigger, _IsPartyMember)
AND
_IsPartyMember == 0
THEN
PROC_LOW_CazadorsPalace_RitualRoom_DeactivateBuffToPlayerVFX(_PentagramTrigger);
PROC_LOW_CazadorsPalace_RitualRoom_ActivateBuffToCazadorVFX(_PentagramTrigger);

IF
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_, _PentagramTrigger, _IsPartyMember)
AND
_IsPartyMember == 1
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ActivateBuffToPlayerVFX(_PentagramTrigger);
PROC_LOW_CazadorsPalace_RitualRoom_DeactivateBuffToCazadorVFX(_PentagramTrigger);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_DeactivateBuffToPlayerVFX((TRIGGER)_PentagramTrigger)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_, _, _Pentagram, _PentagramTrigger)
AND
HasActiveStatus(_Pentagram, "LOW_CAZADORSPALACE_PENTAGRAM_BUFF_GLOW", 1)
THEN
RemoveStatus(_Pentagram, "LOW_CAZADORSPALACE_PENTAGRAM_BUFF_GLOW");

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ActivateBuffToPlayerVFX((TRIGGER)_PentagramTrigger)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_, _, _Pentagram, _PentagramTrigger)
AND
HasActiveStatus(_Pentagram, "LOW_CAZADORSPALACE_PENTAGRAM_BUFF_GLOW", 0)
THEN
ApplyStatus(_Pentagram, "LOW_CAZADORSPALACE_PENTAGRAM_BUFF_GLOW", -1.0);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_DeactivateBuffToCazadorVFX((TRIGGER)_PentagramTrigger)
AND
DB_LOW_CazadorsPalace_RitualRoom_Gratings(_PentagramTrigger, _Grating)
AND
HasActiveStatus(_Grating, "LOW_CAZADORSPALACE_GRATING_BUFF_GLOW", 1)
THEN
RemoveStatus(_Grating, "LOW_CAZADORSPALACE_GRATING_BUFF_GLOW");

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ActivateBuffToCazadorVFX((TRIGGER)_PentagramTrigger)
AND
DB_LOW_CazadorsPalace_RitualRoom_Gratings(_PentagramTrigger, _Grating)
AND
HasActiveStatus(_Grating, "LOW_CAZADORSPALACE_GRATING_BUFF_GLOW", 0)
THEN
ApplyStatus(_Grating, "LOW_CAZADORSPALACE_GRATING_BUFF_GLOW", -1.0);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_EnableBeam((CHARACTER)_Spawn)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _Pentagram, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants(_Spawn)
THEN
ApplyStatus(_Spawn, "LOW_CAZADORSPALACE_BEAM_TO_PENTAGRAM", -1.0, 1, _Pentagram);
ApplyStatus(_Pentagram, "LOW_CAZADORSPALACE_PENTAGRAM_ACTIVATED", -1.0);
DB_LOW_CazadorsPalace_RitualRoom_ActivePentagrams((ITEM)_Pentagram);

// the ritual is stopped when Cazador dies. Three possible scenarios:
// a) Astarion sacrificed him (BecameVampireLord). -> this sets flag RitualCompleted
// b) Astarion killed him (StayedSpawn). Need to change the state of the ritual to Cancelled
// c) Non-Astarion killed him (no additional flag). Need to change the state of the ritual to Cancelled
PROC
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual()
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCompleted_7edf33ff-b185-46ed-b4d8-546c8a016387)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCancelled_989b59f6-b4e3-4236-a8d0-a694fddde5d4);

IF
FlagSet((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438, _, _)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_CazadorsPalace_RitualRoom_Spawns_128ae9fe-23a3-4fb3-bb67-24b925290f8d, 50);

IF
FlagSet((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438, _, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _, _)
AND
HasActiveStatus(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED", 1)
THEN
PROC_CharacterDisableAllCrimes(_Spawn);
RemoveStatus(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED", NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED", NULL_00000000-0000-0000-0000-000000000000, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
THEN
ApplyStatus(_Spawn, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED", NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438)
THEN
ApplyStatus(_Spawn, "LOW_CAZADORSPALACE_RITUAL_DAZED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_DoNotChangeAttitudeAfterCombat((CHARACTER)_Spawn);

IF
DB_GlobalFlag((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _, _)
AND
HasActiveStatus(_Spawn, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", 1)
THEN
RemoveStatus(_Spawn, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(_Spawn, "LOW_CAZADORSPALACE_RITUAL_DAZED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied((CHARACTER)_Spawn, "LOW_CAZADORSPALACE_RITUAL_DAZED", _, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs(_Spawn, _Dialog)
THEN
SetCanFight(_Spawn, 1);
DB_NoLowAttitudeDialog(_Spawn);
DB_Dialogs(_Spawn, _Dialog);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_RitualRoom_State_LetSpawnsLeave_db2fa5ac-0fb9-46da-add9-f01db1d9e479, _Dialog);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_RitualRoom_State_AttackedSpawns_c304d348-bc99-444b-b3c8-a11b795c75f7, _Dialog);
PROC_LOW_CazadorsPalace_RitualRoom_CheckEnableAllCrimesAfterDialog(_Spawn);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CheckEnableAllCrimesAfterDialog((CHARACTER)_Spawn)
AND
NOT DB_DialogName((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _)
AND
NOT DB_DialogName((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, _)
THEN
PROC_CharacterEnableAllCrimes(_Spawn);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CheckEnableAllCrimesAfterDialog((CHARACTER)_Spawn)
AND
DB_DialogName((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _)
THEN
DB_LOW_CazadorsPalace_EnableAllCrimesAfterDialog((CHARACTER)_Spawn, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CheckEnableAllCrimesAfterDialog((CHARACTER)_Spawn)
AND
DB_DialogName((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, _)
THEN
DB_LOW_CazadorsPalace_EnableAllCrimesAfterDialog((CHARACTER)_Spawn, (DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09);

IF
DialogEnded(_Dialog, _)
AND
DB_LOW_CazadorsPalace_EnableAllCrimesAfterDialog(_Spawn, _Dialog)
THEN
PROC_CharacterEnableAllCrimes(_Spawn);
NOT DB_LOW_CazadorsPalace_EnableAllCrimesAfterDialog(_Spawn, _Dialog);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual()
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_DisableBeam(_Spawn);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual()
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualIndicators(_RitualIndicator, _)
THEN
RemoveStatus(_RitualIndicator, "LOW_CAZADORSPALACE_SCRIPTURE_GLOWING");

PROC
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual()
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_, _, _, _Pentagram)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_DeactivateBuffToPlayerVFX(_Pentagram);
PROC_LOW_CazadorsPalace_RitualRoom_DeactivateBuffToCazadorVFX(_Pentagram);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual()
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ClearBeamFromSarcophagus();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual()
AND
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_Char, _Pentagram, _IsPartyMember)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_Char, _Pentagram, _IsPartyMember);
PROC_LOW_CazadorsPalace_RitualRoom_ClearMainBuffs(_Char);
PROC_LOW_CazadorsPalace_RitualRoom_ClearExtraBuffs(_Char);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ClearMainBuffs((CHARACTER)_Char)
AND
DB_LOW_CazadorsPalace_RitualRoom_Buffs(_, _Buff, _)
AND
HasActiveStatus(_Char, _Buff, 1)
THEN
RemoveStatus(_Char, _Buff, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ClearExtraBuffs((CHARACTER)_Char)
AND
DB_LOW_CazadorsPalace_RitualRoom_AppliedExtraBuffs(_Char, _ExtraBuff)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_AppliedExtraBuffs(_Char, _ExtraBuff);
RemoveStatus(_Char, _ExtraBuff);

// re-applying the buffs when a party member enters a pentagram trigger if nobody is inside
IF
EnteredTrigger(_PartyMember, _PentagramTrigger)
AND
DB_PartyMembers(_PartyMember)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_, _, _Pentagram, _PentagramTrigger)
AND
DB_LOW_CazadorsPalace_RitualRoom_ActivePentagrams(_Pentagram)
AND
NOT QRY_LOW_CazadorsPalace_RitualRoom_PentagramTakenByCazador(_PentagramTrigger)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_, _PentagramTrigger, 1) // not taken by another party member
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyBuffs();

// if the player gets defeated they loose the buff
// if they then get undefeated they get the buff back (if it hasn't been taken yet)
PROC
PROC_StateCleared_Defeated(_PartyMember)
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_, _, _Pentagram, _PentagramTrigger)
AND
DB_LOW_CazadorsPalace_RitualRoom_ActivePentagrams(_Pentagram)
AND
IsInTrigger(_PartyMember, _PentagramTrigger, 1)
AND
NOT QRY_LOW_CazadorsPalace_RitualRoom_PentagramTakenByCazador(_PentagramTrigger)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_, _PentagramTrigger, 1) // not taken by another party member
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyBuffs();

QRY
QRY_LOW_CazadorsPalace_RitualRoom_PentagramTakenByCazador((TRIGGER)_PentagramTrigger)
AND
IsInTrigger(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _PentagramTrigger, 1)
AND
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_, _PentagramTrigger, 0)
THEN
DB_NOOP(1);

// re-applying the buffs when a character leaves a pentagram trigger
// only if they have the buff (multiple chars can be in one trigger)
IF
LeftTrigger(_Character, _PentagramTrigger)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_, _, _Pentagram, _PentagramTrigger)
AND
DB_LOW_CazadorsPalace_RitualRoom_ActivePentagrams(_Pentagram)
AND
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams(_Character, _PentagramTrigger, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyBuffs();

// if a party member got Defeated while standing in a pentagram trigger we need to re-apply the buffs
PROC
PROC_StateCleared_Defeated(_PartyMember)
AND
DB_LOW_CazadorsPalace_RitualRoom_TakenPentagrams((CHARACTER)_PartyMember, _, 1)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyBuffs();

IF
DB_PermaDefeated(_Spawn)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)_Spawn, _, _, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants(_Spawn)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_DisableBeam(_Spawn);
PROC_LOW_CazadorsPalace_RitualRoom_ReapplyBuffs();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_DisableBeam((CHARACTER)_Spawn)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _Pentagram, _)
THEN
RemoveStatus(_Spawn, "LOW_CAZADORSPALACE_BEAM_TO_PENTAGRAM");
RemoveStatus(_Pentagram, "LOW_CAZADORSPALACE_PENTAGRAM_ACTIVATED");
NOT DB_LOW_CazadorsPalace_RitualRoom_ActivePentagrams((ITEM)_Pentagram);

IF
DB_PermaDefeated(_Spawn)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)_Spawn, _, _, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants(_Spawn)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants(_Spawn);
//END_REGION Ritual - Pentagrams & Buffs logic

//REGION Ritual - main flow
IF
EntityEvent(_RitualIndicator, "LOW_CazadorsPalace_RitualRoom_EnableRitualIndicator")
AND
HasActiveStatus(_RitualIndicator, "LOW_CAZADORSPALACE_SCRIPTURE_GLOWING", 0)
THEN
ApplyStatus(_RitualIndicator, "LOW_CAZADORSPALACE_SCRIPTURE_GLOWING", -1.0);

IF
EntityEvent(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_RitualRoom_PreAscended")
THEN
NOT DB_CombatReact_AD_StatusRemoved(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, LOW_CazadorsPalace_RitualRoom_AD_BuffRemoved_001_Combat_ee4a186e-2009-f47a-be12-cfd4462a4219, "LOW_CAZADORSPALACE_SPAWNBUFF_007");
NOT DB_CombatReact_AD_StatusRemoved(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, LOW_CazadorsPalace_RitualRoom_AD_BuffRemoved_002_Combat_2c442107-0d6c-1133-344e-f8fb1e304d00, "LOW_CAZADORSPALACE_SPAWNBUFF_006");

IF
EntityEvent(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_RitualRoom_Ascended")
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_CompleteRitual((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

IF
FlagSet(LOW_CazadorsPalace_RitualRoom_State_CazadorIsShirtless_bf22182c-0cbb-4795-9778-d3f23053be1b, _, _)
THEN
Transform(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, Vampire_Spawn_Male_Cazador_Shirtless_8340756d-2515-4eeb-a6cd-bd496edb00ea, (SHAPESHIFTRULE)DisguiseWithCustomLooksKeepNameAndIcon_b40d9ab4-57a7-4632-b8d7-188904b00606);

IF
FlagSet((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546, NULL_00000000-0000-0000-0000-000000000000, _ID)
THEN
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611, NULL_00000000-0000-0000-0000-000000000000, _ID);
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazadorWithClear_9253fd5b-c5b9-4621-893c-3fc1f36db6bd, NULL_00000000-0000-0000-0000-000000000000, _ID);

IF
FlagSet((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, NULL_00000000-0000-0000-0000-000000000000, _ID)
THEN
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611, NULL_00000000-0000-0000-0000-000000000000, _ID);
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazadorWithClear_9253fd5b-c5b9-4621-893c-3fc1f36db6bd, NULL_00000000-0000-0000-0000-000000000000, _ID);

IF
FlagSet((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_CompleteRitual((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CompleteRitual((CHARACTER)_NewVampireLord)
THEN
PROC_GlobalSetFlagAndCache(LOW_CazadorsPalace_RitualRoom_State_RitualCompleted_7edf33ff-b185-46ed-b4d8-546c8a016387);
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual(); // disable all beams, statuses, VFX etc first
PROC_LOW_CazadorsPalace_RitualRoom_KillSpawns(_NewVampireLord); // kill the main spawns (Astarion only dies if Cazador became the new vampire lord)
PROC_LOW_CazadorsPalace_RitualRoom_KillPrisoners(); // all regular prisoners die no matter who became the new Vampire Lord

// all prisoners always die when the ritual is completed
PROC
PROC_LOW_CazadorsPalace_RitualRoom_KillPrisoners()
AND
DB_LOW_CazadorsPalace_Cells_Prisoners(_Prisoner, _, _)
AND
HasActiveStatus(_Prisoner, "LOW_CAZADORSPALACE_PRISONER_INVULNERABILITY", 1)
THEN
RemoveStatus(_Prisoner, "LOW_CAZADORSPALACE_PRISONER_INVULNERABILITY", NULL_00000000-0000-0000-0000-000000000000);

// remove children from the DB children
PROC
PROC_LOW_CazadorsPalace_RitualRoom_KillPrisoners()
AND
DB_LOW_CazadorsPalace_Cells_Prisoners(_Prisoner, _, 1)
THEN
PROC_Children_RemoveNPC(_Prisoner);

// then we kill all the prisoners
PROC
PROC_LOW_CazadorsPalace_RitualRoom_KillPrisoners()
AND
DB_LOW_CazadorsPalace_Cells_Prisoners(_Prisoner, _, _)
THEN
DB_DialogDeath(_Prisoner); // some of them could be in the dialog, we don't want to interrupt the dialog
Die(_Prisoner, DEATHTYPE.Explode, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 1.0);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_KillSpawns((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _, _)
THEN
DB_DialogDeath(_Spawn); // some of them could be in the dialog, we don't want to interrupt the dialog
ApplyStatus(_Spawn, "EXPLODE_DEATH", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
Die(_Spawn, DEATHTYPE.Explode, NULL_00000000-0000-0000-0000-000000000000, 1, 0, 1.0);
SetTag(_Spawn, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_KillSpawns((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _, _)
AND
_Spawn != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
THEN
DB_DialogDeath(_Spawn); // some of them could be in the dialog, we don't want to interrupt the dialog
ApplyStatus(_Spawn, "EXPLODE_DEATH", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
Die(_Spawn, DEATHTYPE.Explode, NULL_00000000-0000-0000-0000-000000000000, 1, 0, 1.0);
SetTag(_Spawn, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CompleteRitual((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
THEN
PROC_GlobalSetFlagAndCache(LOW_CazadorsPalace_RitualRoom_State_CazadorAscended_68cf8d54-b6f2-468b-925d-5f4610e93c04);
PROC_LOW_CazadorsPalace_RitualRoom_AstarionSacrificed();
ObjectSetTitle(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_Ascendant");
SetHitpointsPercentage(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 100.0);
RemoveHarmfulStatuses(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CompleteRitual((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
HasActiveStatus(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CAZADORSPALACE_ASCENSION_BUFF", 0)
THEN
ApplyStatus(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CAZADORSPALACE_ASCENSION_BUFF", -1.0);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_AstarionSacrificed()
AND
DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
ShowGameOverMenu();
DB_NOOP(1); // GameOver if the host character???

PROC
PROC_LOW_CazadorsPalace_RitualRoom_AstarionSacrificed()
AND
NOT DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "AstarionSacrificed");

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CompleteRitual((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
AddPassive(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_Astarion_VampireAscendant");

IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240, _, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_ReleasePrisoners();

IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_State_KilledPrisoners_a138792f-04ae-410b-afce-1bf661e9c868, _, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_KillPrisoners();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReleasePrisoners()
AND
DB_LOW_CazadorsPalace_Cells_Prisoners(_Prisoner, _, _)
THEN
PROC_SetOnStage(_Prisoner, 0);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_ReleasePrisoners()
AND
DB_LOW_CazadorsPalace_CellsDoors(_Door, _, _)
THEN
PROC_LOW_CazadorsPalace_Dungeon_OpenDoor(_Door);

// if a spawn dies after the ritual has been initialized, then the ritual cannot be completed anymore
// initialized - the player entered Cazador's Dungeon and we teleported Astarion to his ritual position if he is not in the team (expelled, died, never recruited)
// the rest of the spawns are immortal till the ritual initialization
IF
DB_PermaDefeated(_Spawn)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns((CHARACTER)_Spawn, _, _, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCompleted_7edf33ff-b185-46ed-b4d8-546c8a016387)
AND
QRY_LOW_CazadorsPalace_RitualRoom_RitualWasInitialized()
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCannotBeCompleted_71cb0aae-aea2-4304-9932-4c57bf6669a8);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_RitualWasInitialized()
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_BeforeRitual_540f9932-f058-48a3-8fa2-21254b7f830e)
THEN
DB_NOOP(1);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_RitualWasInitialized()
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
THEN
DB_NOOP(1);

IF
DB_PermaDefeated(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual();
//END_REGION Ritual - main flow

//REGION Cazador In Coffin
IF
HitpointsChanged((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0.0)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_SendingToCoffin(1)
AND
IsImmortal((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1)
THEN
DB_LOW_CazadorsPalace_RitualRoom_SendingToCoffin(1);
PROC_LOW_CazadorsPalace_SendCazadorToCoffin();

PROC
PROC_LOW_CazadorsPalace_SendCazadorToCoffin()
THEN
PROC_SelfHealing_Disable((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
SetCanJoinCombat(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0);
SetCanFight(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0);
LeaveCombat(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
RemoveHarmfulStatuses((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
PROC_GlobalSetFlagAndCache(LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c);
NOT DB_CustomDialogRange(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 50);
DB_CustomDialogRange(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 10000);
ApplyStatus(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE", 6.0);
NOT DB_CustomDefeatedState(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED");

IF
StatusAttemptFailed(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE", _, _)
THEN
PROC_Poof(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, VFX_Script_VampireSpawn_Disappearing_BodyFX_01_a65c2389-2ab4-1ec4-57b6-84087d529d1e);
ApplyStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CAZADORSPALACE_SARCOPHAGUS_AURA", -1.0);
TeleportTo((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, S_LOW_CazadorsPalace_RitualRoom_AsylumPos_5a9de1d3-dbfa-4796-96f5-973cee523b32, "LOW_CazadorsPalace_CazadorTeleportedToAsylum");

IF
StatusApplied(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE", _, _)
THEN
Freeze((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
ApplyStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE_BEAM", 6.0, 1, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
RealtimeObjectTimerLaunch(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CazadorsPalace_EnableCoffinVFX", 1500);

IF
StatusAttemptFailed(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE_BEAM", _, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_CazadorInCoffin();

IF
StatusApplied(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE_BEAM", _, _)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_CazadorInCoffin();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CazadorInCoffin()
THEN
PROC_SetOnStage(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0);
TeleportTo((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, S_LOW_CazadorsPalace_RitualRoom_AsylumPos_5a9de1d3-dbfa-4796-96f5-973cee523b32, "LOW_CazadorsPalace_CazadorTeleportedToAsylum");
Unfreeze((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

IF
ObjectTimerFinished(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CazadorsPalace_EnableCoffinVFX")
THEN
ApplyStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CAZADORSPALACE_SARCOPHAGUS_AURA", -1.0);

IF
EntityEvent(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_CazadorTeleportedToAsylum")
THEN
PROC_SetOnStage(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1);
SetHitpoints(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1);
RemoveHarmfulStatuses(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
NOT DB_LOW_CazadorsPalace_RitualRoom_SendingToCoffin(1);

IF
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c)
AND
HasAppliedStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", 1)
THEN
RemoveStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", _, _)
THEN
SetTag(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);
DB_CustomDefeatedState(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED");

IF
StatusRemoved(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", _, _)
THEN
ClearTag(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);

// could've been already removed
IF
StatusRemoved(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", _, _)
AND
DB_CustomDefeatedState(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED")
THEN
NOT DB_CustomDefeatedState(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED");

IF
StatusRemoved(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", _, _)
AND
NOT DB_CantAct(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
PROC_EnterCombat(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

PROC
PROC_BlockUseOfItem(_Player, (ITEM)S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c)
AND
NOT DB_Is_InCombat(_Player, _)
THEN
DB_CustomUseItemResponse(_Player, (ITEM)S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, 0);
PROC_LOW_CazadorsPalace_RitualRoom_StartDialogWithCoffin(_Player);

PROC
PROC_BlockUseOfItem(_Player, (ITEM)S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c)
AND
DB_Is_InCombat(_Player, _)
THEN
PROC_PlayCantUseItemAD(_Player);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_StartDialogWithCoffin((CHARACTER)_Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, (CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Player, S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853)
THEN
DB_NOOP(1);

// Cazador is the first speaker, but he is in asylum, so distance to him doesn't matter
// Coffin lid is the third speaker, we need to make sure the player character is close enough to the lid rather than to Cazador
QRY
QRY_OriginMoments_SpeakerIsAvailableAndInDialogRange((CHARACTER)_Character,
	(CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 
	(DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b,
	(DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09)
AND
GetDistanceTo(_Character, S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, _Dist)
AND
QRY_SpeakerIsAvailable(_Character)
AND
_Dist < 60.0
THEN
DB_NOOP(1);

IF
DialogStarted((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _ID)
AND
HasAppliedStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", 1)
THEN
RemoveStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_OriginMoment_PreventRelaunchDialog((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _, _)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
NOT DB_OriginMoment_DontAutoClearOriginMoment(LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);

// CoffinLid - Player
// PostCombat - could be 2nd or 3rd speaker 
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611)
THEN
NOT DB_OriginMoment_DontAutoClearOriginMoment(LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611)
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_Cells_State_OMHappened_58ce1207-c80e-462d-8a6a-48e1cd0b2fd4)
THEN
PROC_SpotPlayers_StopSpotting("LOW_CazadorsPalace_Cells");
PROC_ClearOriginMoment((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_AOM_OOM_ab54e585-5764-e180-9c2d-507eb4824c48);
PROC_ClearOriginMoment((DIALOGRESOURCE)LOW_CazadorsPalace_Cells_OM_Astarion_COM_00b72133-ddb8-d587-e7cc-761d9079317d);

// edge-case - dialog got interrupted after we killed Cazador and got his staff, but before we decided what to do with the prisoners
// in that case we fallback to the "Left Prisoners to Rot" flow
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_KilledPrisoners_a138792f-04ae-410b-afce-1bf661e9c868)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorAscended_68cf8d54-b6f2-468b-925d-5f4610e93c04)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5);

// Necro Zombie Astarion dies immediately
IF
FlagSet((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438, _, _)
AND
DB_GlobalFlag(ORI_Astarion_State_NecroZombie_273d5473-cfd1-4fec-b1f5-a4db0ac4f4ed)
AND
NOT DB_Dead(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
Die(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 0, 1.0);

IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_Event_GivePlayerCazadorsStaff_d347bcc5-2e68-4d7e-a22d-c97f4412da67, _Player, _)
AND
GetItemByTemplateInInventory(MAG_LC_CazadorVampiric_Quarterstaff_cf42b0d0-89d8-4756-b6d7-1e258dceeab0, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Staff)
THEN
ToInventory(_Staff, _Player, 1, 1, 1);

IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5, _Player, _)
AND
GetItemByTemplateInInventory(MAG_LC_CazadorVampiric_Quarterstaff_cf42b0d0-89d8-4756-b6d7-1e258dceeab0, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Staff)
THEN
ToInventory(_Staff, S_LOW_CazadorsPalace_RitualRoom_StaffContainer_f0f8521d-77f6-4ce2-b211-9562a2cd7e4d, 1, 0, 1);

IF
DialogStarted((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, _)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c)
THEN
RemoveStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CAZADORSPALACE_SARCOPHAGUS_AURA");

IF
DialogStarted((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c)
THEN
RemoveStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CAZADORSPALACE_SARCOPHAGUS_AURA");
//END_REGION Cazador In Coffin

//REGION Spawns
IF
DialogStarted((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CazadorsPalace_RitualRoom_State_PostCombatOMInProgress_df9626cc-5a9f-4e38-bad1-c7d1553ced14);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_PostCombatOMInProgress_df9626cc-5a9f-4e38-bad1-c7d1553ced14)
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_CazadorsPalace_RitualRoom_State_PostCombatOMInProgress_df9626cc-5a9f-4e38-bad1-c7d1553ced14);

// coffin dialog - attacking spawns
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_RitualRoom_State_AttackedSpawns_c304d348-bc99-444b-b3c8-a11b795c75f7)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_CazadorsPalace_RitualRoom_Spawns_128ae9fe-23a3-4fb3-bb67-24b925290f8d, 0);

// or spawns leave after Coffin / PostCombat dialog
// post-combat dialog
IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _ID)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_SpawnsLeftInCinematic_25a1be30-b998-4b26-8e0e-7571cd3ece23)
AND
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs(_Spawn, _)
THEN
PROC_SetOnStage(_Spawn, 0);

// spawns leave after Astarion's scene with Cazador ends
IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _ID)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_SpawnsLeftInCinematic_25a1be30-b998-4b26-8e0e-7571cd3ece23)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_SpawnsLeave();

// spawns leave after you talk to one of them and allow them to leave
// non-Astarion flow
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_CazadorsPalace_RitualRoom_State_LetSpawnsLeave_db2fa5ac-0fb9-46da-add9-f01db1d9e479)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_SpawnsLeave();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_SpawnsLeave()
AND
QRY_OnlyOnce("LOW_CazadorsPalace_RitualRoom_SpawnsLeave")
AND
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs(_Spawn, _)
THEN
PROC_NotifyWhenReadyToMoveOn(_Spawn, "LOW_CazadorsPalace_RitualRoom_SpawnReadyToLeave");

PROC
PROC_ReadyToMoveOn(_Spawn, "LOW_CazadorsPalace_RitualRoom_SpawnReadyToLeave")
THEN
SetCanFight(_Spawn, 0);
PROC_DisappearOutOfSightTo(_Spawn, S_LOW_CazadorsPalace_RitualRoom_SpawnDisappearPos_569c8fc4-b125-41ce-8905-f276f0b7c776, "Sprint", 1, "");

PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_CheckRemoveSpawns")
THEN
DB_ExecuteInLevel("LOW_CazadorsPalace_CheckRemoveSpawns","CTY_Main_A");

PROC
PROC_ExecuteInLevel("LOW_CazadorsPalace_CheckRemoveSpawns","CTY_Main_A")
AND
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs(_Spawn, _)
AND
NOT DB_PermaDefeated(_Spawn)
THEN
PROC_SetOnStage(_Spawn, 0);

// Cazador is restored fully
PROC
PROC_LongRest()
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c)
THEN
DB_ExecuteInLevel("LOW_CazadorsPalace_ResetCazadorPos","CTY_Main_A");

PROC
PROC_ExecuteInLevel("LOW_CazadorsPalace_ResetCazadorPos","CTY_Main_A")
THEN
TeleportTo(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, S_LOW_CazadorsPalace_RitualRoom_CazadorsDefaultPos_a3a70d4c-8ab8-4835-9a72-9b0eefb1b1e3);

PROC
PROC_LongRest()
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c)
THEN
PROC_SelfHealing_Enable((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
SetCanJoinCombat(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1);
SetCanFight(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1);				
SetHitpointsPercentage(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 100.0);
PROC_GlobalClearFlagAndCache(LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c);		
NOT DB_CustomDialogRange(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 10000);
//END_REGION

//REGION Cinematic support
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, _ID)
THEN
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_Cells_Prisoner_001_5f39e17d-28dc-4d48-8370-91bb41098c44);
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_Cells_Prisoner_002_4f062990-71e8-4c38-a66c-f5b623d5c0b8);
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_Cells_Prisoner_003_bf2bc6f6-3fad-4b81-848d-f60a32852c9e);
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_Cells_Prisoner_004_98b38439-05d9-4e25-a270-5005222869b9);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, _ID)
THEN
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_RitualRoom_Spawn_001_062ff971-d709-4f54-bb03-51c02844eacb);
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_RitualRoom_Spawn_002_a612de01-a750-491a-bacd-e09a67fc0de3);
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf);
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_RitualRoom_Spawn_004_a4dc8e21-833c-4469-a72b-1969c688b8a4);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _ID)
THEN
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_Cells_Prisoner_001_5f39e17d-28dc-4d48-8370-91bb41098c44);
PROC_DialogAddSpeakingActor(_ID, S_LOW_CazadorsPalace_Cells_Prisoner_002_4f062990-71e8-4c38-a66c-f5b623d5c0b8);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _ID)
AND
DB_LOW_CazadorsPalace_RitualRoom_PostCombatAdditionalSpeakers(_Speaker)
AND
NOT DB_PermaDefeated(_Speaker)
THEN
PROC_DialogAddSpeakingActor(_ID, _Speaker);
//END_REGION

//REGION Debug
IF
TextEvent("cp_getstaff")
AND
GetHostCharacter(_Player)
AND
GetItemByTemplateInInventory(MAG_LC_CazadorVampiric_Quarterstaff_cf42b0d0-89d8-4756-b6d7-1e258dceeab0, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Staff)
THEN
ToInventory(_Staff, _Player, 1, 1, 1);

IF
TextEvent("cp_hideminions")
AND
DB_LOW_CazadorsPalace_RitualRoom_Minions(_Minion)
THEN
PROC_SetOnStage(_Minion, 0);

IF
TextEvent("cp_killminions")
AND
DB_LOW_CazadorsPalace_RitualRoom_Minions(_Minion)
THEN
Die(_Minion, DEATHTYPE.DoT, 1);

IF
TextEvent("cp_disableritual")
AND
DB_LOW_CazadorsPalace_RitualRoom_Spotters(_Spotter)
THEN
PROC_SpotPlayers_StopSpotting("LOW_CazadorsPalace_RitualRoom");

IF
TextEvent("cp_disableritual")
AND
DB_LOW_CazadorsPalace_RitualRoom_Minions(_Minion)
THEN
PROC_SpotPlayers_StopSpotting("LOW_CazadorsPalace_RitualRoom");

IF
TextEvent("cp_enableritual")
AND
DB_LOW_CazadorsPalace_RitualRoom_Spotters(_Spotter)
THEN
PROC_SpotPlayers_RestartSpotting(_Spotter, "LOW_CazadorsPalace_RitualRoom");

IF
TextEvent("cp_enableritual")
AND
DB_LOW_CazadorsPalace_RitualRoom_Minions(_Minion)
THEN
PROC_SpotPlayers_RestartSpotting(_Minion, "LOW_CazadorsPalace_RitualRoom");

IF
TextEvent("cp_beam_to_p_on")
THEN
PROC_LOW_CazadorsPalace_RitualRoom_EnableBeam((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_001_062ff971-d709-4f54-bb03-51c02844eacb);

IF
TextEvent("cp_beam_to_p_off")
THEN
PROC_LOW_CazadorsPalace_RitualRoom_DisableBeam((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_001_062ff971-d709-4f54-bb03-51c02844eacb);

IF
TextEvent("cp_beam_to_c_on")
THEN
ApplyStatus(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CAZADORSPALACE_SPAWNBUFF_001", -1.0, 1, S_LOW_CazadorsPalace_RitualRoom_Rune_001_9a8d7873-f550-4c1f-a4fd-dba3262422e8);

IF
TextEvent("cp_beam_to_c_off")
THEN
RemoveStatus(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CAZADORSPALACE_SPAWNBUFF_001");

IF
TextEvent("cp_beam_to_s_on")
THEN
ApplyStatus((ITEM)S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE_BEAM", 6.0, 1, (CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

IF
TextEvent("cp_beam_to_s_off")
THEN
RemoveStatus(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE_BEAM");

IF
TextEvent("cp_to_coffin")
THEN
ApplyStatus(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE", 6.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("cp_from_coffin")
THEN
RemoveStatus(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CAZADORSPALACE_CAZADOR_MISTY_ESCAPE");

IF
TextEvent("cp_scripture_on")
THEN
ApplyStatus(S_LOW_CazadorsPalace_RitualRoom_RoundIndicator_001_09f0b7a5-3b7b-4bc1-b844-3e7e07db9e6a, "LOW_CAZADORSPALACE_SCRIPTURE_GLOWING", -1.0);

IF
TextEvent("cp_scripture_off")
THEN
RemoveStatus(S_LOW_CazadorsPalace_RitualRoom_RoundIndicator_001_09f0b7a5-3b7b-4bc1-b844-3e7e07db9e6a, "LOW_CAZADORSPALACE_SCRIPTURE_GLOWING");

IF
TextEvent("cp_beginritual")
THEN
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a);

IF
TextEvent("cp_endritual")
THEN
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual();

IF
TextEvent("cp_addgurhunter")
THEN
PROC_DebugBook_AddGurHunterToGurTribe();

IF
TextEvent("cp_killcazador")
THEN
SetImmortal((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0);
ApplyStatus((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "EXPLODE_DEATH", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
Die(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, DEATHTYPE.Explode, NULL_00000000-0000-0000-0000-000000000000, 1, 0, 1.0);

IF
TextEvent("cp_om")
THEN
DB_OriginDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);

IF
TextEvent("cp_ind1")
THEN
SetEntityEvent(S_LOW_CazadorsPalace_RitualRoom_RoundIndicator_001_09f0b7a5-3b7b-4bc1-b844-3e7e07db9e6a, "LOW_CazadorsPalace_RitualRoom_EnableRitualIndicator");

IF
TextEvent("cp_ind2")
THEN
SetEntityEvent(S_LOW_CazadorsPalace_RitualRoom_RoundIndicator_002_442f7c8a-2282-419d-9de3-8b15175046ed, "LOW_CazadorsPalace_RitualRoom_EnableRitualIndicator");

IF
TextEvent("cp_ind3")
THEN
SetEntityEvent(S_LOW_CazadorsPalace_RitualRoom_RoundIndicator_003_a695ea65-f76c-44e5-a1eb-a553c533c276, "LOW_CazadorsPalace_RitualRoom_EnableRitualIndicator");

// post-combat dialog with a companion
IF
TextEvent("cp_pcd_c")
AND
DB_Players(_Player)
AND
_Player != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
NOT DB_Avatars(_Player)
THEN
PROC_Debug_LOW_CazadorsPalace_RitualRoom_PostCombatDialog(_Player);

IF
TextEvent("cp_pcd_a")
AND
DB_Players(_Player)
AND
_Player != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
DB_Avatars(_Player)
THEN
PROC_Debug_LOW_CazadorsPalace_RitualRoom_PostCombatDialog(_Player);

PROC
PROC_Debug_LOW_CazadorsPalace_RitualRoom_PostCombatDialog((CHARACTER)_Player)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, (CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Player, S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853)
THEN
DB_NOOP(1);

IF
TextEvent("captureastarion")
THEN
PROC_LOW_CazadorsPalace_RitualRoom_CaptureAstarion();

IF
TextEvent("releaseastarion")
THEN
RemoveStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED",NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("cazador_ascend")
THEN
SetEntityEvent((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "debug_cazador_ascend");

IF
TextEvent("cazador_pd")
THEN
DB_PermaDefeated(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

IF
TextEvent("cazador_aa")
THEN
ApplyStatus(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "ACID_ARROW", 12.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("cazador_rhs")
THEN
RemoveHarmfulStatuses(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
//END_REGION Debug

//REGION Cinematic support
// Dialog shows all the VFXs and the timeline editor doesn't allow disabling them
// Solution - hacks, as usual
IF
DialogStarted((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _Pentagram, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants(_Spawn)
THEN
RemoveStatus(_Spawn, "LOW_CAZADORSPALACE_BEAM_TO_PENTAGRAM", NULL_00000000-0000-0000-0000-000000000000);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _Pentagram, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants(_Spawn)
THEN
ApplyStatus(_Spawn, "LOW_CAZADORSPALACE_BEAM_TO_PENTAGRAM", -1.0, 1, _Pentagram);
//END_REGION

//REGION Combat Reactivity

//REGION Killing a spawn
// Killing a spawn causes a reaction either from Astarion or from Cazador
// First we want Astarion to react. He does so if he is present, he wasn't the one who killed a spawn and he hasn't react yet.
// If Astarion can't react - Cazador reacts instead
IF
KilledBy(_Spawn, (CHARACTER)_Player, _, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _, _)
AND
DB_Players(_Player)
AND
_Spawn != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
THEN
PROC_LOW_CazadorsPalace_RitualRoom_SpawnKilledDuringRitual(_Player, _Spawn);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_SpawnKilledDuringRitual((CHARACTER)_SpawnKiller, (CHARACTER)_KilledSpawn)
AND
NOT QRY_LOW_CazadorsPalace_RitualRoom_AstarionCanReactToSpawnDeath(_SpawnKiller, _KilledSpawn)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_CazadorReactsToSpawnDeath(_KilledSpawn);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_SpawnKilledDuringRitual((CHARACTER)_SpawnKiller, (CHARACTER)_KilledSpawn)
AND
QRY_LOW_CazadorsPalace_RitualRoom_AstarionCanReactToSpawnDeath(_SpawnKiller, _KilledSpawn)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_AstarionReactsToSpawnDeath(_KilledSpawn);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_AstarionCanReactToSpawnDeath((CHARACTER)_SpawnKiller, (CHARACTER)_KilledSpawn)
AND
NOT DB_Avatars(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_GlobalFlag(ORI_Astarion_State_NecroZombie_273d5473-cfd1-4fec-b1f5-a4db0ac4f4ed)
AND
_SpawnKiller != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
NOT DB_CantTalk_IgnoreCombat(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
IsInTrigger(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03, 1)
THEN
DB_NOOP(1);

// For Astarion we use DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_RitualFailedAstarionsReaction")
PROC
PROC_LOW_CazadorsPalace_RitualRoom_AstarionReactsToSpawnDeath((CHARACTER)_KilledSpawn)
AND
NOT DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_RitualFailedAstarionsReaction")
AND
QRY_StartDialogCustom((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PAD_SpawnKilled_fe216b0c-ab0f-1231-9f5b-0245671887b0, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0, 0, 0, 0)
THEN
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_RitualFailedAstarionsReaction");

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CazadorReactsToSpawnDeath((CHARACTER)_KilledSpawn)
AND
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_CazadorReactedOnce")
AND
QRY_StartDialogCustom(LOW_CazadorsPalace_RitualRoom_AD_SpawnKilled_002_Combat_60e3d49d-78c8-44f3-ca61-5268d57a0233, (CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0, 0, 0, 0)
THEN
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_CazadorReactedTwice");

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CazadorReactsToSpawnDeath((CHARACTER)_KilledSpawn)
AND
NOT DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_CazadorReactedOnce")
AND
QRY_StartDialogCustom(LOW_CazadorsPalace_RitualRoom_AD_SpawnKilled_001_Combat_80c90882-a196-d179-59fd-fd0eaa30c5a8, (CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0, 0, 0, 0)
THEN
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_CazadorReactedOnce");
//END_REGION

//REGION Ritual Failed
IF
TurnStarted(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_RitualCannotBeCompleted_71cb0aae-aea2-4304-9932-4c57bf6669a8)
AND
NOT DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_RitualFailedCazadorsReaction")
AND
QRY_StartDialogCustom((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_AD_RitualFailure_Cazador_4d21a4fb-94d2-5271-e58f-15b06c871959, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0, 0, 0, 0)
THEN
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_RitualFailedCazadorsReaction");

IF
TurnStarted(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_RitualCannotBeCompleted_71cb0aae-aea2-4304-9932-4c57bf6669a8)
AND
IsInTrigger(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03, 1)
AND
NOT DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_RitualFailedAstarionsReaction")
AND
QRY_StartDialogCustom((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_AD_RitualFailure_Astarion_b458ba23-9ba1-a114-2e35-287830b3d4a3, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0, 0, 0, 0)
THEN
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_RitualFailedAstarionsReaction");
DB_LOW_CazadorsPalace_RitualRoom_AstarionReactedToFailure(1); // prevents regular banter between Astarion and Cazador from happening for 1 turn

IF
TurnEnded(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_LOW_CazadorsPalace_RitualRoom_AstarionReactedToFailure(1)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_AstarionReactedToFailure(1);
//END_REGION

//REGION Banter Between Astarion and Cazador
IF
TurnStarted((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_AstarionReactedToFailure(1)
AND
NOT DB_CantTalk_IgnoreCombat(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_TryAstarionBanter();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_TryAstarionBanter()
AND
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_AstarionBanter_001")
AND
NOT DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_AstarionBanter_002")
AND
QRY_StartDialogCustom((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PAD_AstarionTalksToCazador_002_24e5d57d-752c-3206-97e3-b4d69b7bca11, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0, 0, 0, 0)
THEN
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_AstarionBanter_002");

PROC
PROC_LOW_CazadorsPalace_RitualRoom_TryAstarionBanter()
AND
NOT DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_AstarionBanter_001")
AND
QRY_StartDialogCustom((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PAD_AstarionTalksToCazador_001_35c1c3f5-ccd8-9447-4297-0fda61762c73, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0, 0, 0, 0)
THEN
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_AstarionBanter_001");

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PAD_AstarionTalksToCazador_001_35c1c3f5-ccd8-9447-4297-0fda61762c73, _)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_AD_ResponseToAstarion_001_475dab57-7cb2-9816-047c-fbeb9a4baabb, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PAD_AstarionTalksToCazador_002_24e5d57d-752c-3206-97e3-b4d69b7bca11, _)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_AD_ResponseToAstarion_002_c53fb4aa-4d64-df41-ce5f-29718f9fd71c, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
//END_REGION

//REGION Non-Ascended Cazador attacks Astarion
IF
AttackedBy(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _, _, _, _, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorAscended_68cf8d54-b6f2-468b-925d-5f4610e93c04)
AND
NOT DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_CazadorAttackedAstarion")
AND
QRY_StartDialogCustom(LOW_CazadorsPalace_RitualRoom_AD_AttackingAstarion_6e8f1b00-042d-b0fc-e4db-e16519bd7f92, S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0, 0, 0, 0)
THEN
DB_OnlyOnce("LOW_CazadorsPalace_RitualRoom_CazadorAttackedAstarion");
//END_REGION

//END_REGION

//REGION Cazador death
IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazadorWithClear_9253fd5b-c5b9-4621-893c-3fc1f36db6bd, _, _ID)
THEN
SetImmortal((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0); // Cazador can only be killed during the dialog with his Sarcophagus during which this flag is set
DB_DialogDeath((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);
DB_LOW_CazadorsPalace_RitualRoom_MoveItemsToCoffinAfterDialog(_ID);

IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazadorWithClear_9253fd5b-c5b9-4621-893c-3fc1f36db6bd, _, _ID)
AND
GetFlag((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
GetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_StoppedRitual_ece54bb7-acdf-4f6f-a153-d3b33bdc37d2, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
PROC_DieImmediate((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, DEATHTYPE.Physical, 1);
TeleportTo(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_004_737c59cc-e0ec-4821-b059-d8f0c05089a6);

IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazadorWithClear_9253fd5b-c5b9-4621-893c-3fc1f36db6bd, _, _ID)
AND
GetFlag((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
GetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_StoppedRitual_ece54bb7-acdf-4f6f-a153-d3b33bdc37d2, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
PROC_DieImmediate((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, DEATHTYPE.Physical, 1);
TeleportTo(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, S_LOW_CazadorsPalace_RitualRoom_CazadorsDefaultPos_a3a70d4c-8ab8-4835-9a72-9b0eefb1b1e3);

IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazadorWithClear_9253fd5b-c5b9-4621-893c-3fc1f36db6bd, _, _ID)
AND
GetFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
TeleportTo(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, S_LOW_CazadorsPalace_RitualRoom_SpawnPosition_004_737c59cc-e0ec-4821-b059-d8f0c05089a6, "LOW_CazadorsPalace_RitualRoom_CazadorTeleportedToRitualPos");

IF
EntityEvent(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "LOW_CazadorsPalace_RitualRoom_CazadorTeleportedToRitualPos")
THEN
ApplyStatus((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, "EXPLODE_DEATH", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_DieImmediate((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, DEATHTYPE.Explode, 1);

IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazadorWithClear_9253fd5b-c5b9-4621-893c-3fc1f36db6bd, _, _ID)
AND
GetFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
GetFlag((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
PROC_DieImmediate((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, DEATHTYPE.Physical, 1);
DB_LOW_CazadorsPalace_RitualRoom_MoveToCoffin(1);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_MoveToCoffin(1)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_MoveToCoffin(1);
ToInventory(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853); 

IF
DialogEnded(_, _ID)
AND
DB_LOW_CazadorsPalace_RitualRoom_MoveItemsToCoffinAfterDialog(_DialogID)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_MoveItemsToCoffinAfterDialog(_DialogID);
ToInventory(S_LOW_CazadorsPalace_RitualRoom_RitualDagger_feae3d43-138d-4692-aa43-787e3f7e499f, (CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1, 0, 1);
//END_REGION

//REGION Astarion-Avatar has no companions
IF
FlagSet((FLAG)LOW_CazadorsPalace_RitualRoom_Event_CheckNotAlone_0fbd0058-9ec6-4265-89db-b15849fcc3a5, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _)
AND
DB_Players(_PlayerNearby)
AND
_PlayerNearby != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
GetDistanceTo((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _PlayerNearby, _Dist)
AND
_Dist < 30.0
THEN
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_NotAlone_e3a36203-aae3-4791-bcd5-d6124ec50279, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _)
AND
GetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_NotAlone_e3a36203-aae3-4791-bcd5-d6124ec50279, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
THEN
ClearFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_NotAlone_e3a36203-aae3-4791-bcd5-d6124ec50279, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
//END_REGION

//REGION Block ADs about buffs if a spawn is dead
IF
Dying(_Spawn)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _, _)
THEN
NOT DB_CombatReact_AD_StatusRemoved(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, LOW_CazadorsPalace_RitualRoom_AD_BuffRemoved_001_Combat_ee4a186e-2009-f47a-be12-cfd4462a4219, "LOW_CAZADORSPALACE_SPAWNBUFF_007");
NOT DB_CombatReact_AD_StatusRemoved(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, LOW_CazadorsPalace_RitualRoom_AD_BuffRemoved_002_Combat_2c442107-0d6c-1133-344e-f8fb1e304d00, "LOW_CAZADORSPALACE_SPAWNBUFF_006");
//END_REGION

//REGION Removing the spawns from combat
// The spawns are in combat, but not in Turn Order (CanFight = 0)
// When all other enemies are defeated, we need to end combat by forecefully removing them from it.
// This won't trigger if CanFight = 1
IF
EnteredCombat(_NPC, _)
AND
GetCombatGroupID(_NPC, "LOW_CazadorsPalace_RitualRoom")
THEN
DB_LOW_CazadorsPalace_RitualRoom_EnemiesInCombat((CHARACTER)_NPC);

IF
LeftCombat((CHARACTER)_NPC, _)
AND
DB_LOW_CazadorsPalace_RitualRoom_EnemiesInCombat(_NPC)
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_EnemiesInCombat(_NPC);
PROC_LOW_CazadorsPalace_RitualRoom_CheckEndCombat((CHARACTER)_NPC);

PROC
PROC_LOW_CazadorsPalace_RitualRoom_CheckEndCombat((CHARACTER)_NPC)
AND
NOT QRY_LOW_CazadorsPalace_RitualRoom_IsSpawnThatCanFight((CHARACTER)_NPC)
AND
NOT QRY_LOW_CazadorsPalace_RitualRoom_HasNonSpawnNPCIsInCombat()
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_AttackedSpawns_c304d348-bc99-444b-b3c8-a11b795c75f7)
THEN
PROC_LOW_CazadorsPalace_RitualRoom_EndCombat();

QRY
QRY_LOW_CazadorsPalace_RitualRoom_IsSpawnThatCanFight((CHARACTER)_NPC)
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_NPC, _, _, _)
AND
CanFight(_NPC, 1)
THEN
DB_NOOP(1);

QRY
QRY_LOW_CazadorsPalace_RitualRoom_HasNonSpawnNPCIsInCombat()
AND
DB_LOW_CazadorsPalace_RitualRoom_EnemiesInCombat(_NPC)
AND
NOT DB_LOW_CazadorsPalace_RitualRoom_Spawns(_NPC, _, _, _)
THEN
DB_NOOP(1);

// left for old savegame patching
PROC
PROC_LOW_CazadorsPalace_RitualRoom_CheckEndCombat()
AND
NOT QRY_LOW_CazadorsPalace_RitualRoom_HasNonSpawnNPCIsInCombat()
THEN
PROC_LOW_CazadorsPalace_RitualRoom_EndCombat();

PROC
PROC_LOW_CazadorsPalace_RitualRoom_EndCombat()
AND
DB_LOW_CazadorsPalace_RitualRoom_EnemiesInCombat(_Spawn)
THEN
LeaveCombat(_Spawn);
//END_REGION

//REGION Block the message about Astarion leaving if he is sacrificed
QRY
QRY_PartyMembers_BlockLeaveMessage("AstarionSacrificed")
THEN
DB_NOOP(1);
//END_REGION

//REGION Cinematic Fix - the doors aren't active when the cinematic shows them
IF
DialogStarted((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, _)
THEN
SetForceUpdate(S_LOW_CazadorsPalace_Cells_AdultDoor_aa404054-9dae-4684-82aa-48c948295e6c, 1);
SetForceUpdate(S_LOW_CazadorsPalace_Cells_ChildrenDoor_6bca442f-383d-46a6-be5b-a5e046aa853e, 1);

IF
DialogEnded((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, _)
THEN
SetForceUpdate(S_LOW_CazadorsPalace_Cells_AdultDoor_aa404054-9dae-4684-82aa-48c948295e6c, 0);
SetForceUpdate(S_LOW_CazadorsPalace_Cells_ChildrenDoor_6bca442f-383d-46a6-be5b-a5e046aa853e, 0);
//END_REGION

//REGION Voicebark Hint at the start of combat
IF
TurnStarted((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_CantTalk_IgnoreCombat(_Player)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_RitualInProgress_95fe8bc3-21da-4741-a6dc-f5ccfd89be2a)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
QRY_GLO_IsOrWasInCombat(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _CombatID)
AND
QRY_OnlyOnce("LOW_CazadorsPalace_RitualRoom_Runes")
THEN
StartVoiceBark((VOICEBARKRESOURCE)LOW_CazadorsPalace_VB_Runes_e8d261a0-7f6f-bd70-5171-08328f5789d3, _Player);
//END_REGION
EXITSECTION
PROC_LOW_CazadorsPalace_RitualRoom_StopRitual();
ENDEXITSECTION
ParentTargetEdge "Act3b"
