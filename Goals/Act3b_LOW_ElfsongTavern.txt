Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Main Elfsong

//Dialogues (not patrons)
DB_Dialogs((CHARACTER)S_LOW_Dvella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (DIALOGRESOURCE)LOW_Elfsong_PrivateRoom_Devella_Fountainhead_75a04306-47c0-1a49-831b-513da5038188);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_Inkeeper_81651113-d779-44e8-9d46-d49d5577453b, (DIALOGRESOURCE)LOW_Elfsong_Inkeeper_97fec03c-8536-f429-353d-5b2e29af7ca4);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_Skoona_9a4e3f08-739f-4576-a50c-e051ce5126d1, (DIALOGRESOURCE)LOW_Elfsong_Skoona_34db7205-c794-cf4a-16cc-68301b941837);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_Roveer_3e5b30c3-ae3a-48b6-9394-11adde54ad57, (DIALOGRESOURCE)LOW_Elfsong_Roveer_711efccc-766c-5a4a-6e07-d79558aad3f8);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_Cooker_Assistant_d417bc4a-bb08-4593-b1ae-3241ddbd0d8d, (DIALOGRESOURCE)LOW_Elfsong_Cook_Assistant_56b47bf7-2e35-070e-e1a1-bb900abf52a4);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_Cat_001_2108d072-77be-49b2-b3ad-9e9a94f71c40, (DIALOGRESOURCE)LOW_Elfsong_Cat_001_455d03bd-cf57-a48a-a70b-ff8de9bbcbf9);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_Cat_002_d7b843fe-3496-4129-826a-25e50aa189c9, (DIALOGRESOURCE)LOW_Elfsong_Cat_002_792b078a-7a3a-19bb-5e52-70262e1f2805);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, (CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, LOW_Elfsong_GuardingFlamingFists_de8e2c62-4637-7320-03e0-721e5be8e808);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_HarvardWilloughby_8a69560f-3a7a-4e6e-81df-eb77de816197, (DIALOGRESOURCE)LOW_Elfsong_HarvardWilloughby_b6115a49-cb95-fe6e-38c5-0ccf35b37c94);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_OxordWilloughby_a84b1a06-457f-44bc-a21d-08341161e1cf, (DIALOGRESOURCE)LOW_Elfsong_OxordWilloughby_3e3789d4-e37c-c6e5-81a4-1b89c33f0865);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_ComedyPublic_001_c1f1d97a-3549-4a03-b756-3a2040673af0, (DIALOGRESOURCE)LOW_Elfsong_ComedyTournament_Watcher001_4c955a0e-f474-114c-b719-9234e79a2875);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_ComedyPublic_002_241debf0-4efb-4f82-b0ec-bd75533de420, (DIALOGRESOURCE)LOW_Elfsong_ComedyTournament_Watcher002_22a02d22-9518-e42d-51d8-6e7dc4142ee0);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_ComedyPublic_003_1dab7218-58bc-4166-a775-ff923783e342, (DIALOGRESOURCE)LOW_Elfsong_ComedyTournament_Watcher003_66d948df-ff49-4c3f-2671-97bcd7104b8d);
DB_Dialogs(S_LOW_Elfsong_ComedyPublic_004_9f8631d6-b512-45b6-943e-88bb5a985572, (DIALOGRESOURCE)LOW_Elfsong_ComedyTournament_Watcher004_5887dcbb-0075-83ea-617c-dfeae11f83c0);
DB_Dialogs(S_LOW_Elfsong_Yimiur_4e736c46-741a-4643-9b4a-e56dbf21699d, (DIALOGRESOURCE)LOW_Elfsong_Yimuir_e104d1ea-9167-fa5b-23b4-d2e04ff048e4);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_Oloric_8083ab20-4877-4e16-adca-7f4f400ed87b, (DIALOGRESOURCE)LOW_Elfsong_Oloric_36b86bef-73e1-203a-9c27-ddc156a2f0e6);

DB_LOW_ComedyApproval(0);

DB_LOW_ComedyPoints(LOW_Elfsong_Event_ComedyTournament_Approval_67cf200d-9186-9317-cff8-6f67636c2691, 10);
DB_LOW_ComedyPoints(LOW_Elfsong_Event_ComedyTournament_Disapproval_9db8af65-2436-3b2e-3731-7c5c0101f672, -5);

//Devella spotting
DB_SpotPlayers((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_ElfsongTavern_DevellaSpotting",
	NULL_00000000-0000-0000-0000-000000000000, LOW_Elfsong_Event_DvellaStopSpotting_5fceb72f-1060-4754-9b65-99211513aac6);

//Patrons
DB_Dialogs((CHARACTER)S_Elfsong_Patron_001_efb4061b-46b1-4e6d-94fb-394c69106088, (DIALOGRESOURCE)LOW_Elfsong_Patron001_b95c656d-3de4-aad3-6c5c-cb30db981781);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_002_bfce0ced-b83d-4156-bd90-0d5ac6ec241c, (DIALOGRESOURCE)LOW_Elfsong_Patron002_8b7e1568-b0a6-5d0b-5784-18652b4165e8);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_003_47868c4b-f879-419e-97fa-bddd9ec526d7, (DIALOGRESOURCE)LOW_Elfsong_Patron003_99ca0c2b-1bfc-fe3f-babf-d18f5138549f);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_004_6c8278f3-21ca-439b-881f-7a9994a13972, (DIALOGRESOURCE)LOW_Elfsong_Patron004_1f42fa63-9e4d-b175-2b0f-12b1e92eed12);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_005_71f808ce-26f8-435f-9e67-2ff66b0123ad, (DIALOGRESOURCE)LOW_Elfsong_Patron005_c1537296-67ad-6f98-3a96-54bacff36728);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_006_b026b2d2-bd8a-4ca6-910d-03d23bfd637b, (DIALOGRESOURCE)LOW_Elfsong_Patron006_66eb5e92-430b-7e12-6528-361104374683);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_007_8ed56d53-43bd-407d-bf02-bd9c1035b357, (DIALOGRESOURCE)LOW_Elfsong_Patron_007_SingleDialog_88629d60-898a-f4d5-a68e-54f031d2a984);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_008_a29c8ff1-ce29-42c0-a426-c955cdb485bd, (DIALOGRESOURCE)LOW_Elfsong_Patron_008_4eaadc92-0ea4-c3fe-4e83-c83610b2b94e);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_009_12920d57-6bea-415f-bb2e-3b3f71d93319, (DIALOGRESOURCE)LOW_Elfsong_Patron_009_8613033c-d4da-3048-127c-428ff4f64b35);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_010_beaa5595-dbf8-4bef-9543-3ca62c4564a5, (DIALOGRESOURCE)LOW_Elfsong_Patron_010_98e938f4-d86d-eb9b-24e5-62e3afd23127);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_011_a69ca09c-3d04-4b21-bf79-6396a574763f, (DIALOGRESOURCE)LOW_Elfsong_Patron_011_d1c17902-2b82-b862-1683-1e8bd4fcd038);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_012_7ec9de35-051c-469a-a262-b99acb5c145f, (DIALOGRESOURCE)LOW_Elfsong_Patron_012_4eebb6be-285e-94f9-cdec-a4c775ba3cb5);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_013_8e7088f7-500c-49fb-af01-1421b060bb8d, (DIALOGRESOURCE)LOW_Elfsong_Patron_013_16949291-19c1-749a-d206-d7904ad280cd);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_014_f2759ac8-fb14-4c20-9ab0-0c9dd72c8b71, (DIALOGRESOURCE)LOW_Elfsong_Patron_014_5891223b-c93c-9f3e-76a0-b99a62e2ff1f);
DB_Dialogs((CHARACTER)S_Elfsong_Patron_015_2c08c5c3-88a1-4eb0-9bd8-938a94e08b07, (DIALOGRESOURCE)LOW_Elfsong_Patron_015_8bd5e45a-b3a4-e933-2a99-3b120f61d911);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, (DIALOGRESOURCE)LOW_Elfsong_FlamingFist_001_2b507172-3cad-a56c-256d-8be311219148);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, (DIALOGRESOURCE)LOW_Elfsong_FlamingFist_002_09e3d5d2-b742-cb93-2615-7f46120bad40);

//ExteriorPatrons
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_000_c1a924a2-032a-4f21-9849-93cfa6af83f8, LOW_Elfsong_Exterior_Patron_000_58b2c7df-4f53-1acb-cb18-d69697c68d77);
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_001_b0acaed9-296a-409c-8064-a8aff1131013, LOW_Elfsong_Exterior_Patron_001_9c0046fa-1a6a-bddd-987c-2ae0eb0bfbfe);
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_002_31d1b1ba-5d49-438a-849b-f6554bb361f9, LOW_Elfsong_Exterior_Patron_002_5cffaafc-cabe-8e9e-6b1b-094e75b12973);
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_003_a2f68872-56c0-4ad7-ae32-31907d1c3b16, LOW_Elfsong_Exterior_Patron_003_47be271b-06ab-b9c9-3234-c4ba6ceb1609);
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_004_df00eb84-1d3e-4a65-8586-231e5b03f41f, LOW_Elfsong_Exterior_Patron_004_6253723e-5215-5eb7-1a7e-cd6ff4942779);
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_005_1953efbc-6d0d-431c-8705-103be37192f8, LOW_Elfsong_Exterior_Patron_005_e0e08ce2-55d6-0d5d-d7a5-84c5a5b2b8b5);
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_006_dbb296c5-29e5-454c-bfd1-f555a8eea857, LOW_Elfsong_Exterior_Patron_006_6527073f-42b3-502d-9366-cd3e59f501ab);
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_007_5da0601f-e787-4657-b3da-f90de474cc3f, LOW_Elfsong_Exterior_Patron_007_6c60d449-d367-fc14-4b30-66f5ad060499);
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_008_25de2571-f001-4556-832a-91db150f0aab, LOW_Elfsong_Exterior_Patron_008_225c6868-cfc7-3093-ed97-4c9e79eb961f);
DB_Dialogs(S_LOW_Elfsong_Exterior_Patron_009_b5c2a086-ff3a-4386-b581-e5befba8e702, LOW_Elfsong_Exterior_Patron_009_1002aba1-b9d2-c779-1dca-b9d28a12adc6);
DB_Dialogs(S_LOW_Elfsong_Exterior_Waiter_4c498970-d896-42de-b1e1-8757b02a552e, LOW_Elfsong_Exterior_Waiter_91cdf0c9-54ef-b668-471e-3a0b790b1baa);

//Setup for Exterior Patron 001 and the payments/necklace
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_Elfsong_Exterior_Patron_001_9c0046fa-1a6a-bddd-987c-2ae0eb0bfbfe, 200);
DB_HasItemEvent((ITEM)S_LOW_Elfsong_Exterior_Patron_001_Necklace_fe36ade5-6835-4dbb-b9fb-59e95217e6a8, (FLAG)LOW_Elfsong_State_PatronNecklace_HasItem_f578df4d-7592-76fb-75ca-8a4fa5f9b8c1);
DB_GiveItemToEvent((ITEM)S_LOW_Elfsong_Exterior_Patron_001_Necklace_fe36ade5-6835-4dbb-b9fb-59e95217e6a8, (FLAG)LOW_Elfsong_Event_Necklace_GettingNecklace_ef5426d8-de7c-4590-a285-f4eafd376317);


//Patrons with dialog with two speakers
DB_LOW_Elfsong_Patrons_Paired((CHARACTER)S_LOW_Elfsong_Exterior_Patron_000_c1a924a2-032a-4f21-9849-93cfa6af83f8, (DIALOGRESOURCE)LOW_Elfsong_Exterior_Patron_000_And_Patron_002_fe39bfe9-fb46-0dc1-c31a-1df558a478f6,  (CHARACTER)S_LOW_Elfsong_Exterior_Patron_002_31d1b1ba-5d49-438a-849b-f6554bb361f9);
DB_LOW_Elfsong_Patrons_Paired((CHARACTER)S_Elfsong_Patron_007_8ed56d53-43bd-407d-bf02-bd9c1035b357, (DIALOGRESOURCE)LOW_Elfsong_Patron_007_a660527d-e11d-5be3-bc3b-d99fefc440a9, (CHARACTER)S_LOW_Elfsong_Patron_009_12920d57-6bea-415f-bb2e-3b3f71d93319);
DB_LOW_Elfsong_Patrons_Paired((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, (DIALOGRESOURCE)LOW_Elfsong_GuardingFlamingFists_de8e2c62-4637-7320-03e0-721e5be8e808, (CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159);

//Private Room
DB_LOW_Elfsong_PrivateRoomPADs((ITEM)S_LOW_Elfsong_PrivateRoomBed_f775f5a7-ba08-4825-b470-5f18c0394b53, (DIALOGRESOURCE)LOW_Elfsong_PAD_BedWithBood_f1d8ed3c-3a9f-9668-1d85-beba581310bb);
DB_LOW_Elfsong_PrivateRoomPADs((ITEM)S_LOW_Elfsong_StelemaneRing_49114c66-a7cc-48d5-895f-9a31c71c4675, (DIALOGRESOURCE)LOW_Elfsong_PAD_RingWithBlood_749a98ba-b847-d80e-3414-9b9b85eb0898);
DB_LOW_Elfsong_PrivateRoomPADs((ITEM)S_LOW_Elfsong_TargetList_ea5df42e-9870-4e1a-b858-41b211c8c2d2, (DIALOGRESOURCE)LOW_Elfsong_PAD_TargetList_287f1679-37db-dfe4-2c63-7ecef38b6593);
DB_LOW_Elfsong_PrivateRoomPADs((ITEM)S_LOW_Elfsong_EmptyKarabasansGift_da56b1d7-7f11-4f4f-81d2-c9e326a026c1, (DIALOGRESOURCE)LOW_Elfsong_PAD_KarabasansGift_097d284a-b0d9-e0c6-8121-e43d85c522df);

DB_LOW_Elfsong_PrivateRoomPADs_OneUseItems(S_LOW_Elfsong_StelemaneRing_49114c66-a7cc-48d5-895f-9a31c71c4675);

DB_LOW_Elfsong_FlamingFists((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c);
DB_LOW_Elfsong_FlamingFists((CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159);

//Triggers
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_Elfsong_EmperorPrivateRoomTrigger_1459de50-2f63-446e-8da7-0016c737cb5c);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_Elfsong_LeavingPrivateRoom_3e205a46-fae6-4f3e-acc6-da287935ddc6);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_Elfsong_KitchenBeforeCellar_68d030d5-03a1-466c-a168-0115924c0c4a);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_Elfsong_FlamingFistsAD_79d2c476-1100-4511-a466-e964c5c7e3cc);

DB_CTY_DaisyElfsongApproach((TRIGGER)CTY_Daisy_ElfsongApproach1_194cbfdd-67ae-4bae-a6f7-991baddf947d);
DB_CTY_DaisyElfsongApproach((TRIGGER)CTY_Daisy_ElfsongApproach2_831f2ec7-bf54-4318-8360-2fef903ce646);
DB_CTY_DaisyElfsongApproach((TRIGGER)CTY_Daisy_ElfsongApproach3_54225eff-4649-4015-ad35-d5ac387574c8);

// Pay for rent the first floor
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_Elfsong_Inkeeper_97fec03c-8536-f429-353d-5b2e29af7ca4,200);//Normal price
DB_DialogMoneyTransfer(2, (DIALOGRESOURCE)LOW_Elfsong_Inkeeper_97fec03c-8536-f429-353d-5b2e29af7ca4,300);//Over priced

// Sitting Oloric

//Discover the poison
DB_KnowledgeCheckTemplate_AD("LOW_DiscoverEmptyPoisonedWine", (ITEMROOT)LOW_EmptyKarabasansGift_e9271adf-525d-4ac9-9a94-fe2ae02fd772, "Medicine", Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57,
	(DIALOGRESOURCE)LOW_Elfsong_PAD_KarabasansGift_097d284a-b0d9-e0c6-8121-e43d85c522df, (FLAG)LOW_SerialKiller_Know_PlayersKnowAboutPoison_6f7fc46a-2ffa-407e-ad2e-c6f8e13d9567);
//PROC_TriggerRegisterForPlayers(S_LOW_Elfsong_InvestigationCheckBottle_93ee83f7-2b49-42c5-a349-f58010a936c8);

//Making sure that the secrets doors is closed
Close((ITEM)S_LOW_Elfsong_SecretDoor_0c7833f6-740c-47fb-b4a0-dec5eaa53cbd);
//Close((ITEM)S_Elfsong_Basement_SecretLairDoor_709781f8-9a04-4626-841c-ed045dd9ea33);

//Global character setups
PROC_LOW_LakrissaSetup();

//Rooftop
PROC_LOW_AlfiraSetup();
DB_HasItemEvent(S_LOW_Elfsong_Rooftop_AlfiraFirstLute_c665b0ee-7215-4e76-b957-6c47a52f89a0, (FLAG)LOW_Elfsong_State_HasAlfiraLute_23ce5eb6-827b-48f4-b8d2-db2a7c72b1d3);
DB_GiveItemToEvent((ITEM)S_LOW_Elfsong_Rooftop_AlfiraFirstLute_c665b0ee-7215-4e76-b957-6c47a52f89a0, (FLAG)LOW_Elfsong_Event_GivingAlfiraLute_5417d742-b38c-db84-d56c-9ed1898032b1);
PROC_TriggerRegisterForParty(S_LOW_Elfsong_Rooftop_AlfiraPerformingArea_5dc4f36a-c1fc-4f97-8231-ca0fd7c46e1f);

//Hiding one broken world behaviour character
PROC_SetOnStage(S_LOW_Elfsong_CrowdDrinkers_F_002_10baea80-e979-4586-891a-9712903bc3b8, 0);

//Hiding deprecated items
PROC_SetOnStage(S_LOW_Elfsong_SitAndDrink_HUM_M_Mug_004_e308b28d-cf55-4e88-875d-5b0252e40598, 0);
//END_REGION

//REGION Elfsong Cellar
//Cellar DBs
DB_LOW_Elfsong_OpenHiddenDoor((ITEM)S_LOW_Elfsong_HiddenButton_88609209-1e67-4792-8606-155cc039d1bc);
DB_LOW_Elfsong_OpenHiddenDoor((ITEM)S_LOW_Elfsong_HiddenButton_000_ba8e2225-2b2f-4722-bc7c-b57d12b56a1f);

DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_02_Rat_001_83a3bfe2-7ced-4025-b762-f286b36d9855, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_02_Rat_002_9647d611-7ab0-4f4e-8c5c-6b3630c41892, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_02_Rat_003_08f9cd23-fe35-4b15-88d4-630d37d29a18, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_02_Rat_004_4f8b99b4-523b-4ef7-9c19-18ece39b1983, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_02_Rat_005_442d2059-ae56-4d11-8fca-a842ef8863ae, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_02_Rat_006_cd79cc46-e3b0-45c7-a6fa-65e489363e4e, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_02_Rat_007_311d3c19-e564-498d-b1b5-a794f0b72ae0, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_02_Rat_008_28a29b0a-bf69-4b8c-b971-83b3ff334b71, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_01_Rat_001_88e924b7-8b1d-4f57-aa5d-506a17057044, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_01_Rat_002_0caa43da-c0c4-4ffe-90d0-558eee767621, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_01_Rat_003_f9f2e443-152e-47e7-958c-efd9cc96404a, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_01_Rat_004_d8249bc4-936a-40f3-b93a-5aaeb9de4df5, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_01_Rat_005_d17c1cb4-0198-4cc7-a417-84ff974b628b, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_01_Rat_006_914b09cf-a7ed-4717-b7e4-d53b14f0a620, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_01_Rat_007_8703dfd9-14d7-4c20-bc31-38969470f405, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_03_Rat_002_94191166-34c7-4ba3-93ac-50e9e1448d4b, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_03_Rat_003_3289c166-6b8c-4420-bd27-fc335d1e786f, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_03_Rat_004_8ee0159f-8fef-4167-a198-9245111d5b07, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_03_Rat_005_339d4f56-fa3b-4c5d-b52d-50b7ff375a06, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_03_Rat_006_3b3b8148-28d0-4acf-9dde-992fb8ae30ff, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_03_Rat_001_e5644356-fadc-48e6-9d92-ba71a8eb9276, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_04_Rat_001_bb2f9751-072a-4c84-b07e-d793cc4aea14, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_04_Rat_002_a912b318-0314-45fc-b361-2c536c1d6a58, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_04_Rat_003_cb980936-63a5-4848-b845-82153bc85700, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_04_Rat_004_ac3f3370-29b6-42e8-abdd-c63584687f1b, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_04_Rat_005_805546b4-7bf1-4281-b2c9-e80c6be21420, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_04_Rat_006_e4ad99d5-6882-41bc-b926-5c25f152bc8e, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_04_Rat_007_34146ded-333e-41b0-8110-5621dd165dd9, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_05_Rat_001_e5108c6c-150e-43dc-958b-d06ef3345e89, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_05_Rat_002_1e1746dc-1c50-4c8c-9d72-1e11746cafd5, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_05_Rat_003_e6662992-6677-49de-b091-0d070c76061c, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_05_Rat_004_69a46cf7-8b87-4416-addb-2f56cdafb24a, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_05_Rat_005_7f1e55ba-093d-451c-be1f-e0cb5320fdc9, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_05_Rat_006_7cc4f36e-e41c-4c7f-9b1b-3e73220f50b4, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_05_Rat_007_8bdf06f2-0fb6-4a09-99cc-9b812a00efc2, "LOW_Elfsong_CellarRats");
DB_GLO_DefeatCounter(S_LOW_Elfsong_RatSwarmGroup_03_Rat_007_c8ae9dc7-cfdd-48bc-8ec8-1aa78f871534, "LOW_Elfsong_CellarRats");

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_Elfsong_CellarRats",(FLAG)LOW_Elfsong_State_RatsKilledGlobal_7416b42a-3c5b-4e6d-a584-84812e61fd1a);

DB_LOW_Elfsong_LastRatKiller(NULL_00000000-0000-0000-0000-000000000000);

//DB_GLO_DefeatCounter_AllDefeatedGlobalFlag(_DefeatCounter, _Flag)

//DBs to play one of the Emperor's Call
DB_LOW_Elfsong_BasementDoors((ITEM)S_LOW_Elfsong_Basement_Door_MainBasement_dd6d3f85-e144-4fa5-986f-4d7d03954d34);
DB_LOW_Elfsong_BasementDoors((ITEM)S_LOW_Elfsong_Basement_Door_HiddenButtonRoom_08a99580-8486-4d5b-b096-a4366f994f42);
DB_LOW_Elfsong_BasementDoors((ITEM)S_LOW_Elfsong_HiddenButton_88609209-1e67-4792-8606-155cc039d1bc);

//END_REGION

//REGION Knights of the Shield Hideout
//Set upt the Queen's Traitor Scene
DB_LOW_Elfsong_QueenTraitorTriggers((TRIGGER)S_LOW_Elfsong_Basement_GithEntrance_000_84d1f118-d2a1-4bbd-a4c3-eae7e2f0bfe3);
DB_LOW_Elfsong_QueenTraitorTriggers((TRIGGER)S_LOW_Elfsong_Basement_GithEntrance_58fb5b44-9fc5-448b-9c6d-1fc97db6e076);
DB_LOW_Elfsong_QueenTraitorTriggers((TRIGGER)S_LOW_Elfsong_Basement_GithBeginSpot_ac3fc424-fea2-42a4-8cfb-7b1f262efeb4);
DB_DialogBlockTradeButton(LOW_Elfsong_Githyanki_InquisitorInterrogation_b14188e9-1319-367d-83ad-976ffc42c025);
PROC_LOW_Elfsong_RegisterGithSceneTriggers();

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_Elfsong_Basement_EmperorLair_ab5deea7-35fc-46dd-a908-745f94f6c07c);

DB_LOW_Elfsong_KotS_GithDialogs(LOW_Elfsong_GithyankiShield_OM_Laezel_COM_32558c78-c252-ae93-9f78-1bee7dab002d);
DB_LOW_Elfsong_KotS_GithDialogs(LOW_Elfsong_GithyankiShieldo_OM_Laezel_AOM_OOM_2c9c71fe-ed2a-8181-42e9-9dee66b7743f);
DB_CustomDialogRange(S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, 30);

DB_GLO_DefeatCounter((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_001_f9cf10cf-0901-4568-bc95-2a09cb3228f0, "LOW_Elfsong_KotS_GithyankiCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_Elfsong_GithyankiShield_Gish_001_88fea102-74eb-440c-86e6-3984e5f66de2, "LOW_Elfsong_KotS_GithyankiCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_Elfsong_GithyankiShield_Gish_002_9d556b37-ea56-43ce-907f-a42505959279, "LOW_Elfsong_KotS_GithyankiCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_002_cd381392-a5fd-48e6-9b63-4d201ff0004c, "LOW_Elfsong_KotS_GithyankiCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, "LOW_Elfsong_KotS_GithyankiCombat");

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_Elfsong_KotS_GithyankiCombat",(FLAG)LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446);

//Portals and Gith associated for first wave
//DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave((CHARACTER)S_LOW_Elfsong_GithyankiShield_Ranger_002_d13f378e-8c9f-41d3-9cf6-385d90c5a90b,
//	(ITEM)S_LOW_Elfsong_Basement_Portal_002_dbe864c5-0569-478d-b537-f6477b5e2180,
//	(TRIGGER)S_LOW_Elfsong_Basement_PortalPoint_002_74e3e3b4-74c0-4541-ab84-b90df014ff6a);
DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave((CHARACTER)S_LOW_Elfsong_GithyankiShield_Ranger_001_c8d0ee15-a8f5-469f-a949-244b5657590a,
	(ITEM)S_LOW_Elfsong_Basement_Portal_003_5e52b392-9074-4a63-a695-d6949d0e4d58,
	(TRIGGER)S_LOW_Elfsong_Basement_PortalPoint_003_ccb2ec84-5948-4237-9fa2-7e74d09e477c);
DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c,
	(ITEM)S_LOW_Elfsong_Basement_Portal_004_c2514fc6-5cc4-4bf7-9d00-b544ec27f49b,
	S_LOW_Elfsong_Basement_PortalPoint_004_b698f739-cc86-4d76-a499-7af58571e831);
DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave((CHARACTER)S_TWN_VlaakithAttack_Caster_000_e4141a02-f5e7-4a0c-a7af-d3dda6610c1b,
	(ITEM)S_LOW_Elfsong_Basement_Portal_005_2c34cf7b-089d-47a1-8794-067422d586a8,
	(TRIGGER)S_LOW_Elfsong_Basement_PortalPoint_004_b698f739-cc86-4d76-a499-7af58571e831);

NOT DB_LOW_Elfsong_GithyankiThroughPortals_NextReinforcement((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

// Githyanki Gish and their associated GateMasters.
DB_LOW_Elfsong_GithyankiGishAIHints((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_001_f9cf10cf-0901-4568-bc95-2a09cb3228f0, (CHARACTER)S_LOW_Elfsong_GithyankiShield_Gish_001_88fea102-74eb-440c-86e6-3984e5f66de2);
DB_LOW_Elfsong_GithyankiGishAIHints((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_002_cd381392-a5fd-48e6-9b63-4d201ff0004c, (CHARACTER)S_LOW_Elfsong_GithyankiShield_Gish_002_9d556b37-ea56-43ce-907f-a42505959279);

//FOR COMBAT DESIGNERS: If you want to add more reinforcemets, just add to this DB. They will be picked randomly each turn of the Portal Caster.
// Reinforcement for the first Gate Master
DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements((CHARACTER)S_LOW_Elfsong_GithyankiShield_Reinforcement_Melee_003_dd2877fe-a330-48c2-968b-208496b62db8, S_LOW_Elfsong_Basement_Portal_003_5e52b392-9074-4a63-a695-d6949d0e4d58);
DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements((CHARACTER)S_LOW_Elfsong_GithyankiShield_Reinforcement_Ranger_002_2a26da17-17f4-4850-93ce-12a4cc5f862e, S_LOW_Elfsong_Basement_Portal_003_5e52b392-9074-4a63-a695-d6949d0e4d58);
DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements((CHARACTER)S_LOW_Elfsong_GithyankiShield_Reinforcement_Melee_001_c6e7a048-f452-4332-8ef0-a5403bc9b5a1, S_LOW_Elfsong_Basement_Portal_003_5e52b392-9074-4a63-a695-d6949d0e4d58);

// Reinforcement for the second Gate Master
DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements((CHARACTER)S_LOW_Elfsong_GithyankiShield_Reinforcement_Ranger_003_d03b9d09-00bc-4c04-9653-52febfbdcd81, S_LOW_Elfsong_Basement_Portal_002_dbe864c5-0569-478d-b537-f6477b5e2180);
DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements((CHARACTER)S_LOW_Elfsong_GithyankiShield_Reinforcement_Ranger_001_e13b3d55-07d3-4aab-92f9-ed2f8dab0076, S_LOW_Elfsong_Basement_Portal_002_dbe864c5-0569-478d-b537-f6477b5e2180);
DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements((CHARACTER)S_LOW_Elfsong_GithyankiShield_Reinforcement_Melee_002_2093cfe8-d1dd-4749-8db6-c820b9413aab, S_LOW_Elfsong_Basement_Portal_002_dbe864c5-0569-478d-b537-f6477b5e2180);

DB_LOW_Elfsong_GithyankiGateMasters((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_001_f9cf10cf-0901-4568-bc95-2a09cb3228f0, (ITEM)S_LOW_Elfsong_Basement_Portal_002_dbe864c5-0569-478d-b537-f6477b5e2180,
	(TRIGGER)S_LOW_Elfsong_Basement_PortalPoint_002_74e3e3b4-74c0-4541-ab84-b90df014ff6a);
DB_LOW_Elfsong_GithyankiGateMasters((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_002_cd381392-a5fd-48e6-9b63-4d201ff0004c, (ITEM)S_LOW_Elfsong_Basement_Portal_003_5e52b392-9074-4a63-a695-d6949d0e4d58,
	(TRIGGER)S_LOW_Elfsong_Basement_PortalPoint_003_ccb2ec84-5948-4237-9fa2-7e74d09e477c);

PROC_LOW_Elfsong_GithPortalsShow(0);

//Emperor's Lair ADs
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)S_LOW_Elfsong_EmperorSword_5e46d5b5-0a24-4e01-adc9-96914091cdbe, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_Sword_ed8d8492-2d37-9e73-4f05-05dd3ee7867d,
	(FLAG)LOW_Elfsong_EmperorAD_Knows_Sword_7bbe76f8-ccfd-46b4-8364-8efc64e98bbc);
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)S_LOW_Elfsong_EmperorRecipe_9d532a32-75c8-4eb7-a198-f3e407e7c6a8, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_SoupRecipe_d8c5ccb2-39b7-8ba1-d270-0b21f635e125,
	(FLAG)LOW_Elfsong_EmperorAD_Knows_SoupRecipe_43a4e50c-cc8c-43f9-9270-58bb1c16079f);
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)S_LOW_Elfsong_EmperorWardrobe_aa5db69a-19b3-4ef2-b8a5-910d1ae7c6da, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_Wardrove_2f4fe88a-4393-68e7-1c08-b7bd7d744dde,
	(FLAG)LOW_ElfSong_EmperorAD_Knows_Wardrobe_9cf5af10-77aa-4c2a-a0c5-280455efe71f);
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)S_LOW_Elfsong_EmperorRascal_91e7d1ee-1455-47a8-b248-5e5c85940d43, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_RascalCollar_67185b38-a75b-038f-6a50-31bbf92541a1,
	(FLAG)LOW_Elfsong_EmperorAD_Knows_RascallCollar_68392a64-4a4d-4bdb-ba08-c853e9e03e75);
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)S_LOW_Elfsong_Basement_PrisonersChains_6906a11f-3502-4b3c-9390-bb567bc7c84b, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_EmperorPrisonerChains_248b5391-c67c-5beb-e821-e447d71c4c0e,
	(FLAG)LOW_Elfsong_EmperorAD_Knows_PrisonerChains_02524256-6f36-4953-8a09-2a2d77c3a048);
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)S_LOW_Elfsong_Basement_BrainJar_f9096cc9-0463-4511-9d54-1a30d4e7281f, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_EmperorEmptyJars_3e17ca6f-069a-4886-23ea-feb47fd7e58a,
	(FLAG)LOW_Elfsong_EmperorAD_Knows_BrainJar_964c5f9d-d7b7-4450-9156-1cefb99607bd);
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)S_LOW_Elfsong_EmperorsLair_ButterFork_23903b2e-558e-46e8-9470-90941dfeb892, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_ButterFork_d889c1b0-e52b-86fb-3c41-8030edcfb037,
	(FLAG)LOW_Elfsong_EmperorAD_Knows_ButterFork_06b862a1-4300-4bd1-b458-3a54f04fed77);
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)S_LOW_Elfsong_EmperorsLair_StelemanePortrait_44243a84-b27a-4535-b13f-fc9b05842cff, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_StelemanePortrait_d1c9d846-6f9e-29da-c4f8-59bf88908dd1,
	(FLAG)LOW_Elfsong_EmperorAD_Knows_StelmanePortrait_46c035a2-4d6a-459a-a09a-0004019957e6);
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)S_LOW_Elfsong_EmperorLair_Shell_a950d326-273d-4853-9957-956ec75d0656, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_Shell_80b356a0-10bb-37e2-f712-8a195dee3865,
	(FLAG)LOW_Elfsong_EmperorAD_Knows_Shell_02fa6906-836c-4cd1-b7d8-e0d4cf9d8647);

//Items that should be used only once and, if players use them, then should remove the Use Action.
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorSword_5e46d5b5-0a24-4e01-adc9-96914091cdbe);
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorRascal_91e7d1ee-1455-47a8-b248-5e5c85940d43);
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorsLair_StelemanePortrait_44243a84-b27a-4535-b13f-fc9b05842cff);
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorsLair_ButterFork_23903b2e-558e-46e8-9470-90941dfeb892);
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorLair_Shell_a950d326-273d-4853-9957-956ec75d0656);
//Undercity Triggers
DB_LOW_Elfsong_Undercity_EmperorAD((TRIGGER)S_LOW_Elfsong_Undercity_CallToSecretLair_Manhole_1e71c91a-6dd4-4b4d-ad1e-79736acb8d79);
DB_LOW_Elfsong_Undercity_EmperorAD((TRIGGER)S_LOW_Elfsong_Undercity_CallToSecretLair_Sewers_9fd06e45-f85e-4dc4-9ec5-d2299a646deb);

// Hanging Chandelier
DB_GLO_FireBowls(S_LOW_Elfsong_LTS_DUN_Chandelier_C_000_7081a698-16c0-4ff1-ba6e-69bb52a0238e, S_LOW_Elfsong_LTS_DUN_Chandelier_Hinge_A_000_591c3d39-217c-43bf-adab-e5761f03156a);

//Gith Radar activation trigger
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_GithRadarActivateKOTSArea_358b5df3-7ef6-4ef3-8529-5266ae3b2232);
//END_REGION

//REGION Journal LOW_ReachEmperorLair
DB_QuestDef_State((FLAG)LOW_Elfsong_State_RatsKilledGlobal_7416b42a-3c5b-4e6d-a584-84812e61fd1a, "LOW_ReachEmperorLair", "Elfsong_FindButton");
DB_QuestDef_State((FLAG)LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446, "LOW_ReachEmperorLair", "EmperorLair");
//END_REGION

//REGION Private Room
UnloadLevelTemplate(LT_BGH_ElfsongTavern_PrivateRoom_Clean_000_ca85a03f-41d9-4326-aabc-7a59be90e694);
DB_LOW_Elfsong_FlagsToChangePrivateRoom((FLAG)LOW_SerialKiller_Event_DevellaGoingUpperCity_5aae63f9-594f-407d-8b34-078a0b688968);
DB_LOW_Elfsong_FlagsToChangePrivateRoom(LOW_SerialKiller_State_DolorIsDead_fa48e3fe-dc3c-b5c5-09f1-039a5b6974cf);


//END_REGION Private Room

//REGION Journal LOW_ElfsongRats
DB_QuestDef_State((FLAG)LOW_Elfsong_State_RatsKilledGlobal_7416b42a-3c5b-4e6d-a584-84812e61fd1a, "LOW_ElfsongRats", "Elfsong_RatsKilled");
DB_QuestDef_State((FLAG)LOW_Elfsong_State_CellarRats_ReceivedReward_821a1d4c-1042-88af-e2b9-3490f55e8889, "LOW_ElfsongRats", "Elfsong_Rats_COMPLETION");
DB_QuestDef_LevelLoaded("LOW_ElfsongRats", "Elfsong_Rats_Endgame_COMPLETION", "END_Main");

//END_REGION Journal LOW_ElfsongRats

DB_QuestDef_State(LOW_ElfsongTavern_State_BuyedNecklace_acc89a5b-7660-0922-ca72-f7fc939ee499, "HIDDEN_CTY_Boosters", "LOW_Elfsong_BuyCollar");
//REGION Combat
// Combat NPC Reactivity
DB_CombatReact_AD_OnNextTurn(S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, (DIALOGRESOURCE)LOW_Elfsong_AD_GithyankiShield_Paladin_Turn1_65add503-8d3a-710b-1e31-9d9421a4e04f);
DB_CombatReact_AD_OnNextTurn(S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, (DIALOGRESOURCE)LOW_Elfsong_AD_GithyankiShield_Paladin_Turn2_a46aedc0-544a-2cd9-755a-ded089d708d1);
DB_CombatReact_AD_OnNextTurn(S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, (DIALOGRESOURCE)LOW_Elfsong_AD_GithyankiShield_Paladin_Turn3_827c0b0e-c790-68d9-329c-30fd4508a008);

//END_REGION

//REGION Ownership
//Ownership
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_Elfsong_Outside_Ownership_0c0d8180-f902-4d49-8959-ef1dd8fbed9d, (CHARACTER)S_LOW_Elfsong_Inkeeper_81651113-d779-44e8-9d46-d49d5577453b);
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_Elfsong_Bar_Ownership_a0796bc9-0439-4e07-a5f3-14c06b1f0459, (CHARACTER)S_LOW_Elfsong_Inkeeper_81651113-d779-44e8-9d46-d49d5577453b);
DB_ItemShopTrigger((TRIGGER)S_LOW_Elfsong_Bar_Ownership_a0796bc9-0439-4e07-a5f3-14c06b1f0459, (CHARACTER)S_LOW_Elfsong_Inkeeper_81651113-d779-44e8-9d46-d49d5577453b);
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_Elfsong_Resto_Ownership_4bb7878f-6d3d-4d4b-a17c-7b761ed0e509, (CHARACTER)S_LOW_Elfsong_Inkeeper_81651113-d779-44e8-9d46-d49d5577453b);
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_Elfsong_Kitchen_Ownership_4755a8af-9e30-4c46-9de2-2fd99d9d0516, (CHARACTER)S_LOW_Elfsong_Reevor_3e5b30c3-ae3a-48b6-9394-11adde54ad57);
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_Elfsong_Storage_Ownership_b2bd4156-a1c2-4cb8-ad66-6a113c7caf75, (CHARACTER)S_LOW_Elfsong_Inkeeper_81651113-d779-44e8-9d46-d49d5577453b);
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_Elfsong_PrivateRoom_Ownership_5b8d0edb-66f2-482d-8c48-d83b9a2b08b3, (CHARACTER)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_ComedyPublic_Ownership_7667ed18-deb0-4043-9c01-35760f9dd838, (CHARACTER)S_LOW_Elfsong_HarvardWilloughby_8a69560f-3a7a-4e6e-81df-eb77de816197);
//END_REGION
KBSECTION
//REGION Exterior
IF
DB_CTY_DaisyElfsongApproach((TRIGGER)_Trigger)
THEN
PROC_TriggerRegisterForPlayers(_Trigger);

IF
EnteredTrigger(_Player,_DaisyElfsongApproach)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
AND
DB_CTY_DaisyElfsongApproach(_DaisyElfsongApproach)
THEN
PROC_EmperorAD(_Player,(DIALOGRESOURCE)LOW_Elfsong_EmperorAD_Remembrance_9901caa1-663d-f88b-bc16-1ad29a486a6f);
QuestUpdate("LOW_ReachEmperorLair", "Start_Elfsong");

IF
AutomatedDialogEnded(LOW_Elfsong_EmperorAD_Remembrance_9901caa1-663d-f88b-bc16-1ad29a486a6f, _)
AND
DB_CTY_DaisyElfsongApproach(_Trigger)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);
NOT DB_CTY_DaisyElfsongApproach(_Trigger);

IF
DB_QuestIsClosed("LOW_ReachEmperorLair")
AND
DB_CTY_DaisyElfsongApproach(_Trigger)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);
NOT DB_CTY_DaisyElfsongApproach(_Trigger);

//END_REGION

//REGION Taproom

//Lakrissa or Falten setup
PROC
PROC_LOW_LakrissaSetup()
AND
NOT DB_PermaDefeated(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c)
AND
DB_GlobalFlag(DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
THEN
PROC_SetOnStage((CHARACTER)S_LOW_Elfsong_Falten_f7a12012-0d77-4741-adea-26e9c5c58aea, 0);
PROC_SetOnStage(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, 1);
SetVisible(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, 1);
TeleportTo(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (TRIGGER)S_LOW_Elfsong_LakgrisssaTeleport_91e02e76-0949-4a21-8d26-fc70b8a23e92);
SetFaction(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (FACTION)ACT3_LOW_ElfsongTavern_7d31678e-25a9-4006-9c57-3baefdb9c4fa);
PROC_RemoveDialog(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c);
DB_Dialogs(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, (DIALOGRESOURCE)LOW_Elfsong_Lakrissa_4a84a38c-3335-57f1-033c-c429d8b9b875);

PROC
PROC_LOW_LakrissaSetup()
AND
QRY_LOW_Elfsong_IsLakrissaNotAvailable()
THEN
DB_Dialogs(S_LOW_Elfsong_Falten_f7a12012-0d77-4741-adea-26e9c5c58aea, (DIALOGRESOURCE)LOW_Elfsong_Falten_099e9f52-68d8-e50b-ec0e-9ca42edad83d);
SetFlag(LOW_Elfsong_State_LakrissaPermaDefeated_5db59b9f-a8a5-4c58-b386-0af81fab8eea);

QRY
QRY_LOW_Elfsong_IsLakrissaNotAvailable()
AND
DB_PermaDefeated(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c)
THEN
DB_NOOP(1);

QRY
QRY_LOW_Elfsong_IsLakrissaNotAvailable()
AND
NOT DB_GlobalFlag(DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
THEN
DB_NOOP(1);

IF
DB_PermaDefeated(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c)
THEN
SetFlag(LOW_Elfsong_State_LakrissaPermaDefeated_5db59b9f-a8a5-4c58-b386-0af81fab8eea);

//Check the double dialogs)
QRY
QRY_SelectCustomDialog(_FirstSpeaker, _Player)
AND
DB_LOW_Elfsong_Patrons_Paired((CHARACTER)_FirstSpeaker, _DoubleDialog, (CHARACTER)_SecondSpeaker)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_SecondSpeaker, _Player)
THEN
DB_SelectedDialog(_Doubledialog, _FirstSpeaker, _SecondSpeaker, _Player);

QRY
QRY_SelectCustomDialog(_SecondSpeaker, _Player)
AND
DB_LOW_Elfsong_Patrons_Paired(_FirstSpeaker, _DoubleDialog, (CHARACTER)_SecondSpeaker)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_FirstSpeaker, _Player)
THEN
DB_SelectedDialog(_Doubledialog, _FirstSpeaker, _SecondSpeaker, _Player);

IF
DB_GlobalFlag(LOW_Elfsong_State_PermissionToSeeDevella_44a27518-ab25-28a2-38d4-1db9a8b375b1)
THEN
PROC_TriggerUnregisterForPlayers(S_LOW_Elfsong_FlamingFistsAD_79d2c476-1100-4511-a466-e964c5c7e3cc);

//Flaming Fists AD
IF
EnteredTrigger(_Character, S_LOW_Elfsong_FlamingFistsAD_79d2c476-1100-4511-a466-e964c5c7e3cc)
AND
NOT DB_GlobalFlag(LOW_Elfsong_State_PermissionToSeeDevella_44a27518-ab25-28a2-38d4-1db9a8b375b1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_Elfsong_Taproom_AD_FlamingFists_f99f0dad-e3a3-50ab-5d5a-126400226941, S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c,  S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159);

//Giving the Health Potion to S_LOW_Elfsong_Exterior_Patron_006
IF
FlagSet(LOW_Elfsong_Event_GivingPotion_4225d841-5927-4cfe-afef-6af45f690e7a, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
MagicPocketsMoveToByTag(_Player, "HEALING_POTION_1879a93d-2edf-4f54-85dd-81a3724d677f", 1, S_LOW_Elfsong_Exterior_Patron_006_dbb296c5-29e5-454c-bfd1-f555a8eea857, 0, 1);

//END_REGION

//REGION Comedy Tournament

//Add/Substract points to the current score
IF
FlagSet((FLAG)_Flag, _, _) //For this case, prefer to have a FlagSet event
AND
DB_LOW_ComedyPoints(_Flag, _PointsToAdd)
AND
DB_LOW_ComedyApproval(_CurrentPoints)
AND
IntegerSum(_CurrentPoints, _PointsToAdd, _OutNewPoints)
THEN
ClearFlag(_Flag);
NOT DB_LOW_ComedyApproval(_CurrentPoints);
DB_LOW_ComedyApproval(_OutNewPoints);

IF
FlagSet(LOW_Elfsong_State_ComedyTournament_Participate_8b116a03-d12b-679e-5685-5d5061e57333, _, _)
AND
DB_LOW_ComedyApproval(_Points)
AND
_Points > 15
THEN
SetFlag((FLAG)LOW_Elfsong_State_WinComedyTournament_58ac0d2f-319e-e2c4-627f-15114b93c510);

//Cleaning Databases
IF
DialogEnded((DIALOGRESOURCE)LOW_Elfsong_HarvardWilloughby_b6115a49-cb95-fe6e-38c5-0ccf35b37c94, _)
AND
DB_GlobalFlag(LOW_Elfsong_State_ComedyTournament_Participate_8b116a03-d12b-679e-5685-5d5061e57333)
AND
DB_LOW_ComedyPoints(_Flag, _Points)
THEN
NOT DB_LOW_ComedyPoints(_Flag, _Points);

IF
DialogEnded((DIALOGRESOURCE)LOW_Elfsong_HarvardWilloughby_b6115a49-cb95-fe6e-38c5-0ccf35b37c94, _)
AND
DB_GlobalFlag(LOW_Elfsong_State_ComedyTournament_Participate_8b116a03-d12b-679e-5685-5d5061e57333)
AND
DB_LOW_ComedyApproval(_Points)
THEN
NOT DB_LOW_ComedyApproval(_Points);


//END_REGION

//REGION Rooftop: Alfira

PROC
PROC_LOW_AlfiraSetup()
AND
DB_PermaDefeated(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
THEN
SetFlag(LOW_Elfsong_State_AlfiraPermaDefeated_40cc6764-685b-4abd-ac41-ce20055c8d91);

IF
DB_PermaDefeated(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
THEN
SetFlag(LOW_Elfsong_State_AlfiraPermaDefeated_40cc6764-685b-4abd-ac41-ce20055c8d91);

//Alfira basic setup is she is alive
PROC
PROC_LOW_AlfiraSetup()
AND
NOT DB_PermaDefeated(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
AND
DB_GlobalFlag(DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
THEN
TeleportTo(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, S_LOW_Elfsong_AlfiraTP_d8128b77-5dff-48f0-814c-4041f8e05190);
SetOnStage(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, 1);
SetFaction(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, (FACTION)ACT3_LOW_ElfsongTavern_7d31678e-25a9-4006-9c57-3baefdb9c4fa);
PROC_RemoveDialog(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);
DB_Dialogs(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, (DIALOGRESOURCE)LOW_Elfsong_Alfira_a00f488d-09af-f1f0-35bb-908e08729142);
ToInventory(S_LOW_Elfsong_Rooftop_AlfiraFirstLute_c665b0ee-7215-4e76-b957-6c47a52f89a0, S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);

IF
EnteredTrigger(_PartyCharacter, S_LOW_Elfsong_Rooftop_AlfiraPerformingArea_5dc4f36a-c1fc-4f97-8231-ca0fd7c46e1f)
AND
NOT DB_GlobalFlag((FLAG)LOW_Elfsong_Event_AlfiraPerformance_0504db7d-7e61-673f-c5d8-75bc0ae4457c)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_Elfsong_Event_AlfiraPerformance_0504db7d-7e61-673f-c5d8-75bc0ae4457c);

IF
LeftTrigger(_PartyCharacter, S_LOW_Elfsong_Rooftop_AlfiraPerformingArea_5dc4f36a-c1fc-4f97-8231-ca0fd7c46e1f)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger(S_LOW_Elfsong_Rooftop_AlfiraPerformingArea_5dc4f36a-c1fc-4f97-8231-ca0fd7c46e1f)
THEN
ClearFlag((FLAG)LOW_Elfsong_Event_AlfiraPerformance_0504db7d-7e61-673f-c5d8-75bc0ae4457c);

IF
FlagCleared((FLAG)LOW_Elfsong_Event_AlfiraPerformance_0504db7d-7e61-673f-c5d8-75bc0ae4457c, _, _)
THEN
RemoveStatus(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "PERFORM_POSITIVE", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "PERFORM_POSITIVE_THEPOWER", NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GlobalFlag((FLAG)LOW_Elfsong_Event_LakrissaGoingUpstairs_13b8ec89-1a9d-c766-31df-3fcd3fde81b9)
THEN
PROC_SetAnubisConfig((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, "LOW_Elfsong_LakrissaOnRooftop");
PROC_GLO_BreakConcentration(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);

PROC
PROC_LongRest_InLevel("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74)
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_State_TalkWithAlfiraLakrissaRooftopOnce_d1031d99-f9a4-4b01-ac96-6bc2619ceab6)
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74);
PROC_SetAnubisConfig((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, "LOW_Elfsong_Lakrissa");

PROC
PROC_LongRest()
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74)
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_State_TalkWithAlfiraLakrissaRooftopOnce_d1031d99-f9a4-4b01-ac96-6bc2619ceab6)
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74);
DB_LOW_Elfsong_Lakrissa_WaitToLevelLoad(1);

IF
LevelLoaded("CTY_Main_A")
AND
DB_LOW_Elfsong_Lakrissa_WaitToLevelLoad(1)
THEN
NOT DB_LOW_Elfsong_Lakrissa_WaitToLevelLoad(1);
PROC_SetAnubisConfig((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, "LOW_Elfsong_Lakrissa");

//If Alfira and Lakrissa are together in the rooftop, make this dialog the main one.
QRY
QRY_SelectCustomDialog(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, _Player)
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74)
THEN
DB_SelectedDialog(LOW_Elfsong_Alfira_Lakrisssa_ed395877-0673-6431-9c37-c62db8d378c6, S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, _Player);

QRY
QRY_SelectCustomDialog(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, _Player)
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74)
THEN
DB_SelectedDialog(LOW_Elfsong_Alfira_Lakrisssa_ed395877-0673-6431-9c37-c62db8d378c6, S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, _Player);

//END_REGION

//REGION Private Room

//Change templates on long rest if the right flags are set
PROC
PROC_LongRest()
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_Elfsong_FlagsToChangePrivateRoom(_Flag)
AND
DB_GlobalFlag(_Flag)
THEN
PROC_LOW_Elfsong_CleanElfsongTemplate();

PROC
PROC_LongRest()
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LOW_Elfsong_FlagsToChangePrivateRoom(_Flag)
AND
DB_GlobalFlag(_Flag)
THEN
DB_LOW_Elfsong_CleanElfsongTemplate(1);

IF
LevelLoaded("CTY_Main_A")
AND
DB_LOW_Elfsong_CleanElfsongTemplate(1)
THEN
PROC_LOW_Elfsong_CleanElfsongTemplate();

PROC
PROC_LOW_Elfsong_CleanElfsongTemplate()
THEN
UnloadLevelTemplate(LT_BGH_ElfsongTavern_PrivateRoom_Bloodied_000_46bc4222-ac7f-4acd-b9c9-e2fb2a3624d1);
LoadLevelTemplate(LT_BGH_ElfsongTavern_PrivateRoom_Clean_000_ca85a03f-41d9-4326-aabc-7a59be90e694);

PROC
PROC_LOW_Elfsong_CleanElfsongTemplate()
THEN
NOT DB_LOW_Elfsong_CleanElfsongTemplate(1);
TeleportTo(S_LOW_SerialKiller_Map_Tableaux_000_54cdd5e2-c57e-41c5-9a8e-5352cedd1c33, S_LOW_Elfsong_PrivateRoom_MapTeleport_cd556afb-3f4b-4b6d-b8cc-6a9647236a89, "", 0, 0, 0, 0, 0);

PROC
PROC_LOW_Elfsong_CleanElfsongTemplate()
AND
DB_LOW_Elfsong_FlagsToChangePrivateRoom(_Flag)
THEN
NOT DB_LOW_Elfsong_FlagsToChangePrivateRoom(_Flag);

//Devella spots us
PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_ElfsongTavern_DevellaSpotting", (CHARACTER)_Target)
AND
DB_Players(_Target)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_Elfsong_PrivateRoom_Devella_Fountainhead_75a04306-47c0-1a49-831b-513da5038188, (CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _Target)
THEN
DB_NOOP(1);

//Set flag when read the death report
IF
UseStarted(_Character, (ITEM)S_LOW_Elfsong_DvellaReport_eeb8f024-40d6-4691-befb-71f90900bbf2)
AND
DB_Players(_Character)
THEN
SetFlag((FLAG)LOW_Elfsong_Knows_DvelaReportReaded_cba69fc4-d471-463a-98d0-8a167ae7d418);

// Before entering the private room
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_Elfsong_PrivateRoomTrigger_1459de50-2f63-446e-8da7-0016c737cb5c)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
THEN
PROC_EmperorAD(_Player, (DIALOGRESOURCE)LOW_Elfsong_DaisyAD_EmperorPrivateRoom_1accbe12-c28f-118c-599d-0bad46a7088a);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_Elfsong_PrivateRoomTrigger_1459de50-2f63-446e-8da7-0016c737cb5c);

IF
DB_GlobalFlag(LOW_Elfsong_State_AllowHelpDevella_6692d31b-c2a1-4c1f-6471-1a2c701867dd)
THEN
TriggerClearItemsOwner(S_LOW_Elfsong_PrivateRoom_Ownership_5b8d0edb-66f2-482d-8c48-d83b9a2b08b3);

//Add new map to Player's inventory
IF
FlagSet(LOW_SerialKiller_AllowHelpDevella_Map_48a73e3a-7001-7065-c78c-c0eb117d17fa, _Player, _)
THEN
TemplateAddTo(BOOK_LOW_SerialKiller_Map_Tableaux_0abb9873-a07e-486b-bf50-60ccd5f8a0a3, _Player, 1, 1);

//When we finish the dialog, Devella will go away with the Flaming Fists if we show her the Target List in the dialog
IF
DialogEnded((DIALOGRESOURCE)LOW_Elfsong_PrivateRoom_Devella_Fountainhead_75a04306-47c0-1a49-831b-513da5038188, _)
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_Event_DevellaGoingUpperCity_5aae63f9-594f-407d-8b34-078a0b688968)
THEN
PROC_LOW_Elfsong_DevellaDownstairs();

//Devella Going downstairs
PROC
PROC_LOW_Elfsong_DevellaDownstairs()
THEN
PROC_RemoveDialog(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81); //Since the character will not have this dialog again, we can remove it.
PROC_SetAnubisConfig((CHARACTER)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "DefaultCharacter");
PROC_CharacterMoveTo((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (TRIGGER)S_LOW_Elfsong_FlamingFistsAD_79d2c476-1100-4511-a466-e964c5c7e3cc, "Run", "LOW_Elfsong_DevellaGoDownstairs");
PROC_TriggerUnregisterForParty(S_LOW_Elfsong_LeavingPrivateRoom_3e205a46-fae6-4f3e-acc6-da287935ddc6);

//Devella Going downstairs
PROC
PROC_LOW_Elfsong_DevellaDownstairs()
AND
NOT DB_GlobalFlag((FLAG)LOW_SerialKiller_Event_DevellaGoingUpperCity_5aae63f9-594f-407d-8b34-078a0b688968)
THEN
SetFlag((FLAG)LOW_SerialKiller_Event_DevellaGoingUpperCity_5aae63f9-594f-407d-8b34-078a0b688968);

IF
EntityEvent(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Elfsong_DevellaGoDownstairs")
THEN
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, S_LOW_Elfsong_DevellaDissapearOutOfSighTo_6f5f2ef4-4329-4d8b-a6ec-355526d969f1, "Run", 1, "LOW_Elfsong_DevellaIsAway");
Follow(S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);
Follow(S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);
ObjectTimerLaunch(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Elfsong_Devella_FlamingFistFollowTimer", 6000, 1);

IF
ObjectTimerFinished(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Elfsong_Devella_FlamingFistFollowTimer")
AND
DB_LOW_Elfsong_FlamingFists(_FlamingFist)
AND
GetDistanceTo(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _FlamingFist, _Distance)
AND
_Distance > 10
THEN
PROC_DisappearOutOfSightTo(_FlamingFist, S_LOW_Elfsong_DevellaDissapearOutOfSighTo_6f5f2ef4-4329-4d8b-a6ec-355526d969f1, "Run", 1, "");

IF
ObjectTimerFinished(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Elfsong_Devella_FlamingFistFollowTimer")
AND
NOT DB_OffStage(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
THEN
ObjectTimerLaunch(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Elfsong_Devella_FlamingFistFollowTimer", 6000, 1);

IF
WentOnStage(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, 0)
THEN
ObjectTimerCancel(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Elfsong_Devella_FlamingFistFollowTimer");

IF
EntityEvent(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Elfsong_DevellaIsAway")
THEN
PROC_SetOnStage(S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, 0);
PROC_SetOnStage(S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, 0);

//Adding to inclusion database
IF
DB_LOW_Elfsong_PrivateRoomPADs(_Item, _Dialog)
THEN
DB_Inclusion_NPCDialog(_Dialog, (CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);

//Interact with the objects
IF
AddedTo(_Item, _Character, _)
AND
DB_LOW_Elfsong_PrivateRoomPADs((ITEM)_Item, _DialogSource)
AND
DB_Players((CHARACTER)_Character)
AND
QRY_StartDialog_Fixed(_DialogSource, _Character)
THEN
NOT DB_LOW_Elfsong_PrivateRoomPADs((ITEM)_Item, _DialogSource);

//Start AD when we try to get the objects
PROC
PROC_BlockUseOfItem(_Character, _Item)
AND
DB_LOW_Elfsong_PrivateRoomPADs((ITEM)_Item, _DialogSource)
AND
NOT DB_LOW_Elfsong_PrivateRoomPADs_UsedItems(_Character, _Item)
AND
QRY_StartDialog_Fixed(_DialogSource, _Character)
THEN
DB_CustomUseItemResponse(_Character, _Item, 0);
DB_LOW_Elfsong_PrivateRoomPADs_UsedItems(_Character, _Item);

IF
DB_LOW_Elfsong_PrivateRoomPADs_UsedItems(_, _Item)
AND
DB_LOW_Elfsong_PrivateRoomPADs_OneUseItems(_Item)
THEN
SetDisableUse((ITEM)_Item, 1);

IF
UseFinished(_Character, _Item, _)
AND
DB_LOW_Elfsong_PrivateRoomPADs((ITEM)_Item, _DialogSource)
AND
DB_Players(_Character)
AND
QRY_StartDialog_Fixed(_DialogSource, _Character)
THEN
NOT DB_LOW_Elfsong_PrivateRoomPADs((ITEM)_Item, _DialogSource);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)_Dialog, (INTEGER)_ID)
AND
DB_LOW_Elfsong_PrivateRoomPADs(_Item, _Dialog)
THEN
PROC_DialogAddSpeakingActor(_ID,(GUIDSTRING)LOW_Elfsong_Devella_Fountainhead_4baeba73-72d6-47e9-3682-dd899592ac25);

IF
LeftTrigger(_Player, S_LOW_Elfsong_LeavingPrivateRoom_3e205a46-fae6-4f3e-acc6-da287935ddc6)
AND
NOT QRY_LOW_Elfsong_PrivateRoomNotEmpty()
AND
DB_GlobalFlag(LOW_SerialKiller_State_PlayersTalkDevellaPrivateroom_d7cb303c-e0b0-4c5b-8e1a-62eb68547781)
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_Knows_TargetList_262314d1-43bf-4ea5-ae23-4a77bfab2671)
THEN
PROC_LOW_Elfsong_DevellaDownstairs();

QRY
QRY_LOW_Elfsong_PrivateRoomNotEmpty()
AND
DB_PartyMembers(_Character)
AND
DB_InRegion(_Character, (TRIGGER)S_LOW_Elfsong_LeavingPrivateRoom_3e205a46-fae6-4f3e-acc6-da287935ddc6)
THEN
DB_NOOP(1);

QRY
QRY_LOW_Elfsong_DevellaIsSeen()
AND
DB_PartyMembers((CHARACTER)_OtherPartyCharacter)
AND
NOT DB_Sees((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _OtherPartyCharacter)
THEN
DB_NOOP(1);


//Devella out of sight from Elfsong
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_SerialKiller_VisitWineFestival_f5419edc-b46c-4f87-9853-eaf67eaefa23)
AND
NOT DB_LOW_SerialKiller_DevellaOutOfElsong(1)
AND
DB_Players(_Player)
AND
NOT QRY_LOW_Elfsong_DevellaIsSeen()
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
PROC_LOW_Elfsong_DevellaDownstairs();

//Prevent do Devella going away if a player is on Elfsong and can see her. She will go after players leave Elfsong
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_SerialKiller_VisitWineFestival_f5419edc-b46c-4f87-9853-eaf67eaefa23)
AND
NOT DB_LOW_SerialKiller_DevellaOutOfElsong(1)
AND
DB_Players(_Player)
AND
QRY_LOW_Elfsong_DevellaIsSeen()
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
DB_LOW_SerialKiller_DevellaOutOfElsong(1);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_Knows_WordOfPassage_839150e6-d168-4c89-a980-68b9e9f60556)
AND
NOT DB_LOW_SerialKiller_DevellaOutOfElsong(1)
AND
NOT QRY_LOW_Elfsong_DevellaIsSeen()
AND
NOT DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "PermaDefeated")
THEN
PROC_LOW_Elfsong_DevellaDownstairs();

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_Knows_WordOfPassage_839150e6-d168-4c89-a980-68b9e9f60556)
AND
NOT DB_LOW_SerialKiller_DevellaOutOfElsong(1)
AND
QRY_LOW_Elfsong_DevellaIsSeen()
THEN
DB_LOW_SerialKiller_DevellaOutOfElsong(1);

IF
EnteredTrigger(_Player, S_LOW_BhaalTemple_VB_ArrivalBridge_8553d251-51c9-4afc-babd-7b4e3387ac67)
AND
NOT DB_LOW_SerialKiller_DevellaOutOfElsong(1)
AND
NOT QRY_LOW_Elfsong_DevellaIsSeen()
THEN
PROC_LOW_Elfsong_DevellaDownstairs();


IF
EnteredTrigger(_Player, S_LOW_BhaalTemple_VB_ArrivalBridge_8553d251-51c9-4afc-babd-7b4e3387ac67)
AND
NOT DB_LOW_SerialKiller_DevellaOutOfElsong(1)
AND
QRY_LOW_Elfsong_DevellaIsSeen()
THEN
DB_LOW_SerialKiller_DevellaOutOfElsong(1);

//Devella Leaving after the last player leaves the private room if she is still there
IF
LeftTrigger(_Player, (TRIGGER)S_LOW_Elfsong_LeavingPrivateRoom_3e205a46-fae6-4f3e-acc6-da287935ddc6)
AND
DB_LOW_SerialKiller_DevellaOutOfElsong(1)
AND
DB_Players(_Player)
AND
NOT QRY_LOW_Elfsong_PrivateRoomNotEmpty()
THEN
NOT DB_LOW_SerialKiller_DevellaOutOfElsong(1);
PROC_LOW_Elfsong_DevellaDownstairs();

IF
DB_GlobalFlag((FLAG)LOW_SerialKiller_Know_PlayersKnowAboutPoison_6f7fc46a-2ffa-407e-ad2e-c6f8e13d9567)
THEN
SetStoryDisplayName(S_LOW_Elfsong_EmptyKarabasansGift_da56b1d7-7f11-4f4f-81d2-c9e326a026c1, "LOW_SerialKiller_KarabasansGift");

IF
FlagSet((FLAG)FactionHostileToPlayerGroupAfterDialog_d73ce44b-1b9a-2e02-f29a-d8e9e68c7edc, S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _)
AND
DB_LOW_Elfsong_FlamingFists(_FlamingFist)
AND
NOT DB_Defeated(_FlamingFist)
THEN
PROC_ForceStopDialog(_FlamingFist);
PROC_CharacterMoveTo(_FlamingFist, S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "Run", "");

//END_REGION

//REGION Kitchen

// Near the cellar's entrance
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_Elfsong_KitchenBeforeCellar_68d030d5-03a1-466c-a168-0115924c0c4a)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
THEN
PROC_EmperorAD(_Player, (DIALOGRESOURCE)LOW_Elfsong_DaisyAD_EmperorBeforeCellar_5daf7191-026f-a284-a506-8fbded2b4972);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_Elfsong_KitchenBeforeCellar_68d030d5-03a1-466c-a168-0115924c0c4a);

IF
DB_QuestIsClosed("LOW_ReachEmperorLair")
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_Elfsong_KitchenBeforeCellar_68d030d5-03a1-466c-a168-0115924c0c4a);

IF
DB_Dead(S_LOW_Elfsong_Roveer_3e5b30c3-ae3a-48b6-9394-11adde54ad57)
AND
NOT DB_CantAct(S_LOW_Elfsong_Cooker_Assistant_d417bc4a-bb08-4593-b1ae-3241ddbd0d8d)
THEN
PROC_DisappearOutOfSight(S_LOW_Elfsong_Cooker_Assistant_d417bc4a-bb08-4593-b1ae-3241ddbd0d8d, "Sprint", 1, "");

//END_REGION

//REGION Elfsong basement

IF
DB_GLO_DefeatCounter(_Rat, "LOW_Elfsong_CellarRats")
THEN
DB_LOW_Elfsong_TrackRats(_Rat);

IF
KilledBy(_Rat, _Player, _, _)
AND
DB_LOW_Elfsong_TrackRats(_Rat)
AND
DB_LOW_Elfsong_LastRatKiller(_Killer)
THEN
NOT DB_LOW_Elfsong_LastRatKiller(_Killer);
DB_LOW_Elfsong_LastRatKiller(_Player);

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_Elfsong_CellarRats")
AND
DB_LOW_Elfsong_LastRatKiller(_Player)
THEN
SetFlag(LOW_Elfsong_State_CellarRats_Killed_a0258996-aa49-46f7-a69d-07e56170e76c, _Player);
NOT DB_LOW_Elfsong_LastRatKiller(_Player);

IF
FlagSet((FLAG)LOW_Elfsong_State_CellarRats_Killed_a0258996-aa49-46f7-a69d-07e56170e76c, _Player, _)
AND
NOT DB_QuestIsClosed("LOW_ReachEmperorLair")
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_EmperorAD(_Player, LOW_Elfsong_EmperorAD_AfterKillRats_1e5a381b-c120-382e-85af-6a0e4345d3b7);

//Play EmperorAD when players open (or try to open) one of the doors at the cellar
IF
UseStarted(_Character, _Door)
AND
DB_LOW_Elfsong_BasementDoors(_Door)
AND
NOT DB_QuestIsClosed("LOW_ReachEmperorLair")
AND
DB_Players(_Character)
THEN
PROC_EmperorAD(_Character, LOW_Elfsong_EmperorAD_CellarDoor_e3d8e9d9-a698-de13-7017-69bc35f2d87c);
PROC_LOW_Elfsong_BasementDoors_Remove();

PROC
PROC_LOW_Elfsong_BasementDoors_Remove()
AND
DB_LOW_Elfsong_BasementDoors(_Door)
THEN
NOT DB_LOW_Elfsong_BasementDoors(_Door);

//Opening the secret door at Elfsong Cellar
IF
UseStarted(_Character, _HiddenButton)
AND
DB_LOW_Elfsong_OpenHiddenDoor(_HiddenButton)
THEN
Open((ITEM)S_LOW_Elfsong_SecretDoor_0c7833f6-740c-47fb-b4a0-dec5eaa53cbd);
QuestUpdate("LOW_ReachEmperorLair", "ElfsongBasement");


//END_REGION

//REGION Knights of the Shield Hideout
//GithRadar activating at secret room behind barrels
//ToDo: Check if there are any other conditions for the Githyanki to be there. In order to have the Radar, the player must have been to the Creche already.
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_GithRadarActivateKOTSArea_358b5df3-7ef6-4ef3-8529-5266ae3b2232)
AND
DB_Players(_Player)
AND
IsInInventoryOf((ITEM)S_GLO_GithRadar_4aca442e-5ecb-4611-b481-5eaf35596dea, _Player, 1)
AND
QRY_OnlyOnce("LOW_Elfsong_RadarActivated")
THEN
PlaySound(_Player, "SE_Pendulum_Psionic_Detector");
StartVoiceBark((VOICEBARKRESOURCE)LOW_Elfsong_Githyanki_VB_GithRadarGoingOffComment_4d0dc8e7-8074-72a4-9b2a-d73a59607161, _Player);

//Show/Hide the portals and the gith
PROC
PROC_LOW_Elfsong_GithPortalsShow((INTEGER)_Int)
AND
DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave(_Gith, _Portal, _)
THEN
PROC_SetOnStage(_Gith, _Int);
PROC_SetOnStage(_Portal, _Int);

//Show/Hide the portals and the gith
PROC
PROC_LOW_Elfsong_GithPortalsShow((INTEGER)_Int)
AND
DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements((CHARACTER)_Gith, _)
THEN
PROC_SetOnStage(_Gith, _Int);

//Can be checked in the PROC_LOW_Elfsong_GithFirstWave(), but doing this is easier to remove the DB entry.
PROC
PROC_LOW_Elfsong_CheckNumberOfPortals()
AND
DB_PermaDefeated(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c)
THEN
NOT DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c,
	S_LOW_Elfsong_Basement_Portal_004_c2514fc6-5cc4-4bf7-9d00-b544ec27f49b,
	S_LOW_Elfsong_Basement_PortalPoint_004_b698f739-cc86-4d76-a499-7af58571e831);

//Adding ADs again just in case players never visit Creche
PROC
PROC_LOW_Elfsong_CheckNumberOfPortals()
AND
NOT DB_PermaDefeated(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c)
THEN
DB_CombatReact_AD_OnTurn(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarCombatThirdLine_4a94a362-cd9a-8abe-5e8f-e44fa0f39791, 2);
DB_CombatReact_AD_OnTurn(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarCombatSecondLine_7f992f5b-b0b9-1282-ae38-14d0468d9cbf, 3);
DB_CombatReact_AD_OnCast(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (DIALOGRESOURCE)CRE_ChainOfCommand_AD_TemplarCombatFirstLine_ec898b4b-7313-7758-5346-5bdc7bc2c4ba, "Shout_CRE_GithyankiInquisitor_Mindsteal_Tempest");

//Can be checked in the PROC_LOW_Elfsong_GithFirstWave(), but doing this is easier to remove the DB entry.
PROC
PROC_LOW_Elfsong_CheckNumberOfPortals()
AND
DB_PermaDefeated(S_TWN_VlaakithAttack_Caster_000_e4141a02-f5e7-4a0c-a7af-d3dda6610c1b)
THEN
NOT DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave((CHARACTER)S_TWN_VlaakithAttack_Caster_000_e4141a02-f5e7-4a0c-a7af-d3dda6610c1b,
	(ITEM)S_LOW_Elfsong_Basement_Portal_005_2c34cf7b-089d-47a1-8794-067422d586a8,
	(TRIGGER)S_LOW_Elfsong_Basement_PortalPoint_004_b698f739-cc86-4d76-a499-7af58571e831);

//Adding ADs again just in case players never visit Creche
PROC
PROC_LOW_Elfsong_CheckNumberOfPortals()
AND
NOT DB_PermaDefeated(S_TWN_VlaakithAttack_Caster_000_e4141a02-f5e7-4a0c-a7af-d3dda6610c1b)
THEN
DB_CombatReact_AD_OnNextTurn(S_TWN_VlaakithAttack_Caster_000_e4141a02-f5e7-4a0c-a7af-d3dda6610c1b, (DIALOGRESOURCE)TWN_VlaakithAttack_AD_Caster_000_TakingTurn_001_7b09b907-9742-a382-54fb-ac99e497f920);
DB_CombatReact_AD_OnNextTurn(S_TWN_VlaakithAttack_Caster_000_e4141a02-f5e7-4a0c-a7af-d3dda6610c1b, (DIALOGRESOURCE)TWN_VlaakithAttack_AD_Caster_000_TakingTurn_002_e71c74fe-d7ff-1a1d-a39e-1671d9bd5e5e);
DB_CombatReact_AD_OnNextTurn(S_TWN_VlaakithAttack_Caster_000_e4141a02-f5e7-4a0c-a7af-d3dda6610c1b, (DIALOGRESOURCE)TWN_VlaakithAttack_AD_Caster_000_TakingTurn_003_69558b1d-d5bf-2bbf-d139-a59d20675e48);


//Setup when the players enters in the scene
PROC
PROC_LOW_Elfsong_GithFirstWave()
AND
DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave(_Gith, _Portal, _Point)
AND
NOT DB_PermaDefeated(_Gith)
THEN
PROC_SetOnStage(_Portal, 1);
TeleportTo(_Gith, _Portal);
PROC_SetOnStage(_Gith, 1);
//PROC_CharacterMoveTo((CHARACTER)_Gith, _Point, "Walk", "LOW_KnightsOfTheShield_FirstWave");
SetFlag(LOW_Elfsong_KotS_MoveToPosition_fde28148-eff7-4014-a71d-9880ce812d61, _Gith);
SetFaction(_Gith, (FACTION)ACT3_LOW_Elfsong_Githyanki_e2c5c1ae-1797-44af-bd68-4071820b7e89);
//In the first wave, one portal per character, and one conditional
DB_GLO_DefeatCounter(_Gith, "LOW_Elfsong_KotS_GithyankiCombat");

//Apply the status that will be removed through Scripting and not throught the spell
PROC
PROC_LOW_Elfsong_GithFirstWave()
AND
DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave(_Gith, _Portal, _Point)
AND
NOT DB_LOW_Elfsong_GithyankiGateMasters(_, _Portal, _)
THEN
ApplyStatus((ITEM)_Portal, "PUZ_CASTEDPORTAL_PURPLE", -1.0);

//Apply the status to the portals throught the Spell
PROC
PROC_LOW_Elfsong_GithFirstWave()
AND
DB_LOW_Elfsong_GithyankiGateMasters((CHARACTER)_GateMaster, _Portal, _Point)
THEN
UseSpell(_GateMaster, "Target_LOW_OpenGate", _Portal);

IF
EnteredTrigger(_Player, S_LOW_Elfsong_Basement_GithBeginSpot_ac3fc424-fea2-42a4-8cfb-7b1f262efeb4)
AND
DB_Players(_Player)
AND
DB_GLO_DefeatCounter(_Gith, "LOW_Elfsong_KotS_GithyankiCombat")
THEN
DB_SpotPlayers((CHARACTER)_Gith, "LOW_Elfsong_QueenTraitorScene",
	NULL_00000000-0000-0000-0000-000000000000, (FLAG)LOW_Elfsong_State_GithStopSpotting_2cff4bb4-f944-4b59-80b2-cc20d6481e58);

//Recasting the spell on level load
IF
LevelLoaded("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
QRY_LOW_KotS_CheckIfSceneStarted()
THEN
PROC_LOW_KotS_RestartIfNeeded();

PROC
PROC_LOW_KotS_RestartIfNeeded()
AND
DB_LOW_Elfsong_GithyankiGateMasters(_GateMaster, _Portal, _Point)
AND
NOT DB_Defeated(_GateMaster)
AND
HasActiveStatus(_GateMaster, "LOW_OPENGATE_CHANNEL", 0)
AND
NOT DB_Is_InCombat(_GateMaster, _)
THEN
UseSpell(_GateMaster, "Target_LOW_OpenGate", _Portal);

QRY
QRY_LOW_KotS_CheckIfSceneStarted()
AND
DB_LOW_Elfsong_QueenTraitorTriggers(_Trigger)
AND
DB_WasInRegion(_, _Trigger)
THEN
DB_NOOP(1);

QRY
QRY_LOW_KotS_CheckIfSceneStarted()
AND
DB_LOW_Elfsong_QueenTraitorTriggers(_Trigger)
AND
DB_InRegion(_, _Trigger)
THEN
DB_NOOP(1);
//Closing the two portals we didn't need
IF
EntityEvent(_Gith, "LOW_KnightsOfTheShield_FirstWave")
AND
DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave((CHARACTER)_Gith, _Portal, _Point)
THEN
NOT DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave(_Gith, _Portal, _Point);

IF
EntityEvent(_Gith, "LOW_KnightsOfTheShield_FirstWave")
AND
QRY_IsEmptyDB("DB_LOW_Elfsong_GithyankiThroughPortals_FirstWave", 3)
THEN
RemoveStatus(S_LOW_Elfsong_Basement_Portal_004_c2514fc6-5cc4-4bf7-9d00-b544ec27f49b, "PUZ_CASTEDPORTAL_PURPLE", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_LOW_Elfsong_Basement_Portal_001_1b4bb4f5-9601-4ccc-a1b0-8ae1542d98e8, "PUZ_CASTEDPORTAL_PURPLE", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_LOW_Elfsong_Basement_Portal_005_2c34cf7b-089d-47a1-8794-067422d586a8, "PUZ_CASTEDPORTAL_PURPLE", NULL_00000000-0000-0000-0000-000000000000);

//Get the next reinforcement and delete from the pool
QRY
QRY_LOW_Elfsong_NextReinforcement((ITEM)_Portal)
AND
DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements(_Reinforcement, _Portal)
AND
QRY_IsEmptyDB("DB_LOW_Elfsong_GithyankiThroughPortals_NextReinforcement", 1)
THEN
DB_LOW_Elfsong_GithyankiThroughPortals_NextReinforcement((CHARACTER)_Reinforcement);
NOT DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements(_Reinforcement, _Portal);

// If both Gate Masters are channeling a Gate and combat starts, make one of them start bringing allies the next round
IF
EnteredCombat((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_001_f9cf10cf-0901-4568-bc95-2a09cb3228f0,_)
AND
HasActiveStatus((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_001_f9cf10cf-0901-4568-bc95-2a09cb3228f0, "LOW_OPENGATE_CHANNEL", 1)
AND
HasActiveStatus((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_002_cd381392-a5fd-48e6-9b63-4d201ff0004c, "LOW_OPENGATE_CHANNEL", 1)
THEN
ApplyStatus((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_001_f9cf10cf-0901-4568-bc95-2a09cb3228f0, "LOW_OPENGATE_TECHNICAL", 6.0, 1, NULL_00000000-0000-0000-0000-000000000000);

//If the invoker is alive, try to get reinforcements
IF
CastedSpell(_PortalMaster, "Shout_LOW_OpenGate_BringReinforcements", _, _, _)
AND
DB_LOW_Elfsong_GithyankiGateMasters((CHARACTER)_PortalMaster, _Portal, _Point)
AND
QRY_LOW_Elfsong_NextReinforcement((ITEM)_Portal)
AND
DB_LOW_Elfsong_GithyankiThroughPortals_NextReinforcement(_Reinforcement)
THEN
TeleportTo(_Reinforcement, _Portal);
PROC_SetOnStage(_Reinforcement, 1);
PROC_CharacterMoveTo(_Reinforcement, _Point, "Run", "");
NOT DB_LOW_Elfsong_GithyankiThroughPortals_NextReinforcement(_Reinforcement);
DB_GLO_DefeatCounter(_Reinforcement, "LOW_Elfsong_KotS_GithyankiCombat");
SetEntityEventReal(_PortalMaster, "GLO_CombatWait", 1.0);

//If no more reinforcements available, AD about that
IF
TurnStarted(S_LOW_Elfsong_GithyankiShield_Gish_002_9d556b37-ea56-43ce-907f-a42505959279)
AND
QRY_IsEmptyDB("DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements", 2)
THEN
PROC_TryStartAD(LOW_Elfsong_Githyanki_Caster_f56c8786-e8e1-80ea-1818-dc6de52065a8, S_LOW_Elfsong_GithyankiShield_Gish_002_9d556b37-ea56-43ce-907f-a42505959279);

//Closing portals if the dbs are empty at the end of the turn
IF
TurnEnded(_GateMaster)
AND
DB_LOW_Elfsong_GithyankiGateMasters((CHARACTER)_GateMaster, _Portal, _Point)
AND
NOT DB_LOW_Elfsong_GithyankiThroughPortals_Reinforcements(_, _Portal)
THEN
NOT DB_LOW_Elfsong_GithyankiGateMasters(_GateMaster, _Portal, _Point);
PROC_GLO_BreakConcentration(_GateMaster);

//Dispell the portals by killing the casters
IF
Died(_GithyankiCaster)
AND
DB_LOW_Elfsong_GithyankiGateMasters(_GithyankiCaster, _Portal, _Point)
THEN
NOT DB_LOW_Elfsong_GithyankiGateMasters(_GithyankiCaster, _Portal, _Point);

//Removing the GatMasters from their DB once the spell ends.
IF
DB_PermaDefeated(_GateMaster)
AND
DB_LOW_Elfsong_GithyankiGateMasters((CHARACTER)_GateMaster, _Portal, _Point)
THEN
NOT DB_LOW_Elfsong_GithyankiGateMasters(_GateMaster, _Portal, _Point);

//Removing the Gishes AIHint info when thei Gate Master stop channeling. From that moment, they can move around the arena freely
IF
StatusRemoved((CHARACTER)_GateMaster, "LOW_OPENGATE_CHANNEL", _, _)
AND
DB_LOW_Elfsong_GithyankiGishAIHints(_GateMaster, _Gish)
THEN
SetAiHint(_Gish, NULL_00000000-0000-0000-0000-000000000000);
SetStayInAiHints(_Gish, 0);

PROC
PROC_LOW_Elfsong_RegisterGithSceneTriggers()
AND
DB_LOW_Elfsong_QueenTraitorTriggers(_Trigger)
THEN
PROC_TriggerRegisterForParty(_Trigger);

PROC
PROC_LOW_Elfsong_UnregisterGithSceneTriggers()
AND
DB_LOW_Elfsong_QueenTraitorTriggers(_Trigger)
THEN
PROC_TriggerUnregisterForParty(_Trigger);

//Activate the scene
IF
EnteredTrigger(_Character, _Trigger)
AND
DB_LOW_Elfsong_QueenTraitorTriggers(_Trigger)
AND
QRY_OnlyOnce("LOW_Elfsong_QueenTraitor")
THEN
PROC_LOW_Elfsong_CheckNumberOfPortals();
PROC_LOW_Elfsong_GithFirstWave();
PROC_LOW_Elfsong_UnregisterGithSceneTriggers();
PROC_CharacterMoveTo(S_LOW_Elfsong_GithyankiShield_Gish_001_88fea102-74eb-440c-86e6-3984e5f66de2, S_LOW_Elfsong_KotS_GishADPoint_aaa5e5ab-d87c-4a0c-9a61-effc0b618252, "Walk", "LOW_KotS_GishArriving");
DB_SpotPlayers((CHARACTER)S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16, "LOW_Elfsong_QueenTraitorScene",
	NULL_00000000-0000-0000-0000-000000000000, (FLAG)LOW_Elfsong_State_GithStopSpotting_2cff4bb4-f944-4b59-80b2-cc20d6481e58);
PROC_EmperorAD(_Character, LOW_Elfsong_EmperorAD_EmperorSeeGithyanki_7a92fd73-16f8-31a6-69b2-55475de2f7bb);
QuestUpdate("LOW_ReachEmperorLair", "KnightsOftheShield");

IF
EntityEvent(S_LOW_Elfsong_GithyankiShield_Gish_001_88fea102-74eb-440c-86e6-3984e5f66de2, "LOW_KotS_GishArriving")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_Elfsong_Githyanki_InquisitorAD_20547720-9069-8121-052c-6e8217710eb3, S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16,
	(CHARACTER)S_LOW_Elfsong_GithyankiShield_Gish_001_88fea102-74eb-440c-86e6-3984e5f66de2);

//REGION  Laezel Origin Moment
//Speaker selection for Laezel moment
//Clears DB at first
QRY
QRY_ORI_Laezel_KotS_PickBestSpeaker(_)
AND
DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(_PreviouslySelected)
THEN
NOT DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(_PreviouslySelected);

//If Companion Laezel is nearby and has a suitable avatar nearby, trigger COM
QRY
QRY_ORI_Laezel_KotS_PickBestSpeaker((CHARACTER)_SpottedTarget)
AND
DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _SpottedTarget) //Mihail: Maybe the Gith Inquisitor should be used as Anchor instead, not sure
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1, 1)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _BestAvatar)
THEN
DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(_BestAvatar);

//Pick Laezel avatar if she is in range
QRY
QRY_ORI_Laezel_KotS_PickBestSpeaker((CHARACTER)_SpottedTarget)
AND
DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16)
THEN
DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
SetFlag(AOM_794d7d9a-4e15-849c-7c0d-6e6cdb67cdcb, S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16);

//If Orphaned Laezel triggers the dialog, no suitable bonded avatar nearby, triggers as OOM
QRY
QRY_ORI_Laezel_KotS_PickBestSpeaker((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1, 1)
AND
NOT DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
THEN
SetFlag(OOM_018ab052-38df-6d2c-117f-8d7c1e56b061, S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16);

//Set flag for COM moment with Laezel available
QRY
QRY_ORI_Laezel_KotS_PickBestSpeaker(_Target)
AND
DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(_Target)
AND
_Target != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Target)
THEN
SetFlag(COM_7075ec1a-70ad-bd25-3111-0a955cf07585, S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16);

//Always passes the spotted target if it shouldn't override with bonded avatar
QRY
QRY_ORI_Laezel_KotS_PickBestSpeaker((CHARACTER)_SpottedTarget)
AND
NOT DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(_)
THEN
DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(_SpottedTarget);

//Spot event and begin the dialog with the Inquisitor, LaeZel OOM
PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_Elfsong_QueenTraitorScene", (CHARACTER)_Target)
AND
QRY_ORI_Laezel_KotS_PickBestSpeaker(_Target)
AND
DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_OnlyOnce("LOW_Elfsong_QueenTraitorScene_Spotting")
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_Elfsong_GithyankiShieldo_OM_Laezel_AOM_OOM_2c9c71fe-ed2a-8181-42e9-9dee66b7743f,
S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_OnlyOnce("LOW_Elfsong_QueenTraitorScene_Spotting");
NOT DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
SetFlag((FLAG)LOW_Elfsong_State_GithStopSpotting_2cff4bb4-f944-4b59-80b2-cc20d6481e58);

//Spot event and begin the dialog with the Inquisitor, LaeZel AOM
PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_Elfsong_QueenTraitorScene", (CHARACTER)_Target)
AND
QRY_ORI_Laezel_KotS_PickBestSpeaker(_Target)
AND
DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_OnlyOnce("LOW_Elfsong_QueenTraitorScene_Spotting")
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_Elfsong_GithyankiShieldo_OM_Laezel_AOM_OOM_2c9c71fe-ed2a-8181-42e9-9dee66b7743f,
S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_OnlyOnce("LOW_Elfsong_QueenTraitorScene_Spotting");
DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
SetFlag((FLAG)LOW_Elfsong_State_GithStopSpotting_2cff4bb4-f944-4b59-80b2-cc20d6481e58);

PROC
PROC_StartDialog_AddExtraSpeakers(LOW_Elfsong_GithyankiShieldo_OM_Laezel_AOM_OOM_2c9c71fe-ed2a-8181-42e9-9dee66b7743f, _ID)
AND
QRY_SpeakerIsAvailableAndInDialogRange( S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16)
THEN
PROC_DialogAddSpeakingActor(_ID, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c);

//Spot event and begin the dialog with the Inquisitor, LaeZel COM or normal dialog
PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_Elfsong_QueenTraitorScene", (CHARACTER)_Target)
AND
QRY_ORI_Laezel_KotS_PickBestSpeaker(_Target)
AND
DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(_BestSpeaker)
AND
_BestSpeaker != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
AND
NOT DB_OnlyOnce("LOW_Elfsong_QueenTraitorScene_Spotting")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_Elfsong_GithyankiShield_OM_Laezel_COM_32558c78-c252-ae93-9f78-1bee7dab002d,
S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, _BestSpeaker)
THEN
DB_OnlyOnce("LOW_Elfsong_QueenTraitorScene_Spotting");
NOT DB_QRYRTN_Elfsong_QueenTraitorScene_BestSpeaker(_BestSpeaker);
SetFlag((FLAG)LOW_Elfsong_State_GithStopSpotting_2cff4bb4-f944-4b59-80b2-cc20d6481e58);

PROC
PROC_StartDialog_AddExtraSpeakers(LOW_Elfsong_GithyankiShield_OM_Laezel_COM_32558c78-c252-ae93-9f78-1bee7dab002d, _ID)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16)
THEN
PROC_DialogAddSpeakingActor(_ID, S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c);

//If everything fails, start combat when spotted
PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_Elfsong_QueenTraitorScene", (CHARACTER)_Target)
AND
QRY_OnlyOnce("LOW_Elfsong_QueenTraitorScene_Spotting")
THEN
SetHostileAndEnterCombat((FACTION)ACT3_LOW_Elfsong_Githyanki_e2c5c1ae-1797-44af-bd68-4071820b7e89, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16, _Target);

//END_REGION

//REGION Combat against githyanki
//Begin the combat after the dialog
IF
FlagSet((FLAG)LOW_Elfsong_Event_GithyankiCombatStarts_7aa5f992-f70b-e567-a963-5a661d5c41a0, _Player, _)
THEN
DB_Elfsong_InquisitorHostilityAfterDialog(_Player);

IF
DialogEnded(_Dialog, _)
AND
DB_LOW_Elfsong_KotS_GithDialogs(_Dialog)
AND
DB_Elfsong_InquisitorHostilityAfterDialog(_Player)
THEN
NOT DB_Elfsong_InquisitorHostilityAfterDialog(_Player);
SetHostileAndEnterCombat((FACTION)ACT3_LOW_Elfsong_Githyanki_e2c5c1ae-1797-44af-bd68-4071820b7e89, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16, _Player);
ClearFlag((FLAG)LOW_Elfsong_Event_GithyankiCombatStarts_7aa5f992-f70b-e567-a963-5a661d5c41a0, _Player);

IF
DB_GlobalFlag((FLAG)LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446)
AND
NOT DB_QuestIsClosed("LOW_ReachEmperorLair")
AND
DB_Players(_Player)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
THEN
PROC_EmperorAD(_Player, (DIALOGRESOURCE)LOW_Elfsong_EmperorAD_AfterKillGithyanki_6d92de69-5605-5594-f0dd-6184368411fb);

// If the Paladin is killed, the inquisitor takes over and uses Mindsteal tempest
IF
KilledBy((CHARACTER)S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, _, _, _)
AND
IsInCombat((CHARACTER)S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c,1)
THEN
SetTag(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, ACT1B_CRE_INQUISITOR_TRIGGERMINDSTEALTEMPEST_1271938d-b5a2-4321-9cae-f681045981b2);

//Converting temporary hostility into permanent one
PROC
PROC_OnDialogAttack_GoingHostile(S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, _Player)
THEN
SetHostileAndEnterCombat(ACT3_LOW_Elfsong_Githyanki_e2c5c1ae-1797-44af-bd68-4071820b7e89, Hero_a1542c81-6895-929e-4522-10ce218bb360, S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, _Player);
//END_REGION

//REGION Peaceful Resolution

IF
FlagSet((FLAG)LOW_Elfsong_KotS_State_GithPeacefulResolution_0b4904a4-40f4-4396-bcb8-4754d4d3a646, _, _)
THEN
DB_Elfsong_KotS_PeacefulResolution(1);

IF
DialogEnded(_Dialog, _)
AND
DB_LOW_Elfsong_KotS_GithDialogs(_Dialog)
AND
DB_Elfsong_KotS_PeacefulResolution(1)
AND
DB_GLO_DefeatCounter(_Character, "LOW_Elfsong_KotS_GithyankiCombat")
AND
_Character != S_LOW_Elfsong_GithyankiShield_GateMaster_002_cd381392-a5fd-48e6-9b63-4d201ff0004c
THEN
NOT DB_GLO_DefeatCounter((CHARACTER)_Character, "LOW_Elfsong_KotS_GithyankiCombat");
DB_LOW_Elfsong_KotS_PeacefulResolutionGith(_Character);
PROC_PeacefulResolve(_Character);

IF
DialogEnded(_Dialog, _)
AND
DB_LOW_Elfsong_KotS_GithDialogs(_Dialog)
AND
DB_Elfsong_KotS_PeacefulResolution(1)
THEN
TimerLaunch("LOW_Elfsong_KotS_DelayTimerUntilGoAway", 3000);//Wait three seconds after the end of the dialog until start to move the characters away
NOT DB_Elfsong_KotS_PeacefulResolution(1);

IF
TimerFinished("LOW_Elfsong_KotS_DelayTimerUntilGoAway")
AND
DB_LOW_Elfsong_KotS_PeacefulResolutionGith(_Character)
THEN
NOT DB_LOW_Elfsong_KotS_PeacefulResolutionGith(_Character);
PROC_LOW_Elfsong_KotS_PeacefulResolution(_Character);

PROC
PROC_LOW_Elfsong_KotS_PeacefulResolution((CHARACTER)_Character)
AND
GUIDToString(_Character, _OutCharacterString)
AND
Concatenate("LOW_Elfsong_KotS_PeacefulResolution_", _OutCharacterString, _OutEventString)
THEN
DB_LOW_Elfsong_KotS_PeacefulResolutionGith_GoingAway(_Character, _OutEventString);
PROC_CharacterMoveTo(_Character, S_LOW_Elfsong_Basement_Portal_003_5e52b392-9074-4a63-a695-d6949d0e4d58, "Run", _OutEventString);

IF
EntityEvent(_Character, _EventString)
AND
DB_LOW_Elfsong_KotS_PeacefulResolutionGith_GoingAway((CHARACTER)_Character, _EventString)
THEN
NOT DB_LOW_Elfsong_KotS_PeacefulResolutionGith_GoingAway(_Character, _EventString);
PROC_FadeOutEntity(_Character);
PROC_LOW_Elfsong_KotS_CheckGithGone();

PROC
PROC_LOW_Elfsong_KotS_CheckGithGone()
AND
NOT DB_LOW_Elfsong_KotS_PeacefulResolutionGith_GoingAway(_, _)
AND
GetFlag((FLAG)LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446,NULL_00000000-0000-0000-0000-000000000000,0)
THEN
PROC_LOW_Elfsong_KotS_PeacefulResolution((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_002_cd381392-a5fd-48e6-9b63-4d201ff0004c);
SetFlag((FLAG)LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446);

//Removing dialog entries
IF
DialogEnded(_Dialog, _)
AND
DB_LOW_Elfsong_KotS_GithDialogs(_Dialog)
AND
DB_Elfsong_KotS_PeacefulResolution(1)
THEN
NOT DB_LOW_Elfsong_KotS_GithDialogs(_Dialog);

//END_REGION Peaceful Resolution

//Cleaning the remaining DBs
//Clean databases when player defeat gith (paceful or fight)
IF
FlagSet(LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446,_,_)
AND
DB_LOW_Elfsong_KotS_GithDialogs(_Dialog)
THEN
NOT DB_LOW_Elfsong_KotS_GithDialogs(_Dialog);

//END_REGION

//REGION Emperor's Lair
IF
EnteredTrigger(_Player,(TRIGGER)S_LOW_Elfsong_Basement_EmperorLair_ab5deea7-35fc-46dd-a908-745f94f6c07c)
AND
NOT DB_GlobalFlag((FLAG)GLO_Daisy_State_TriggerDaisyAcknowledgement_502407ba-c92f-47fa-b3fc-c00d1fecbf9d)
THEN
SetFlag((FLAG)GLO_Daisy_State_TriggerDaisyAcknowledgement_502407ba-c92f-47fa-b3fc-c00d1fecbf9d,NULL_00000000-0000-0000-0000-000000000000,0);
PROC_EmperorAD(_Player, LOW_Elfsong_EmperorAD_ReachLair_44454be4-4e54-ba86-c27d-6c62f11a8efa);

//Interact with the objects
IF
AddedTo(_Item, _Character, _)
AND
IsTagged(_Character, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
AND
DB_LOW_Elfsong_EmperorsLair_UniqueADs((ITEM)_Item, _DialogSource, _Flag)
THEN
PROC_EmperorAD((CHARACTER)_Character, _DialogSource);
SetFlag(_Flag, _Character);

//Start AD when we try to get the objects
PROC
PROC_BlockUseOfItem(_Character, _Item)
AND
IsTagged(_Character, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
AND
DB_LOW_Elfsong_EmperorsLair_UniqueADs(_Item, _DialogSource, _Flag)
AND
NOT DB_LOW_Elfsong_EmperorsLair_UniqueADs_UsedItems(_Character, _Item)
THEN
DB_CustomUseItemResponse(_Character, _Item, 0);
DB_LOW_Elfsong_EmperorsLair_UniqueADs_UsedItems(_Character, _Item);
PROC_EmperorAD((CHARACTER)_Character, _DialogSource);
SetFlag(_Flag, _Character);

IF
DB_LOW_Elfsong_EmperorsLair_UniqueADs_UsedItems(_, _Item)
AND
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(_Item)
THEN
SetDisableUse((ITEM)_Item, 1);

IF
DB_LOW_Elfsong_Undercity_EmperorAD(_Trigger)
THEN
PROC_TriggerRegisterForParty(_Trigger);

IF
EnteredTrigger(_Character, _Trigger)
AND
DB_LOW_Elfsong_Undercity_EmperorAD(_Trigger)
AND
IsTagged(_Character, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
AND
NOT DB_GlobalFlag((FLAG)GLO_Daisy_State_TriggerDaisyAcknowledgement_502407ba-c92f-47fa-b3fc-c00d1fecbf9d)
THEN
PROC_LOW_Elfsong_Undercity_EmperorAD_Unregister();
PROC_EmperorAD(_Character, LOW_Elfsong_EmperorAD_Sewers_9e0e4940-0101-e376-b671-699fe8c5514a);
QuestUpdate("LOW_ReachEmperorLair", "Start_Sewers");

PROC
PROC_LOW_Elfsong_Undercity_EmperorAD_Unregister()
AND
DB_LOW_Elfsong_Undercity_EmperorAD(_Trigger)
THEN
PROC_TriggerUnregisterForParty(_Trigger);
NOT DB_LOW_Elfsong_Undercity_EmperorAD(_Trigger);

IF
AddedTo(S_LOW_Elfsong_EmperorArmor_bf514173-1063-4a50-8de3-32ad0fe6d28d, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_Elfsong_TransformContainer")
THEN
Transform(S_LOW_Elfsong_EmperorMannequin_a0ff29a4-f50d-47f3-9c7c-a1fd1d7edad0, DEC_GEN_Mannequin_A_Interactive_62f8419d-37dc-4705-a684-bf554ebbc3cb, DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);



//END_REGION

//REGION Journal LOW_ReachEmperorLair

IF
AddedTo(S_LOW_Elfsong_EmperorSword_5e46d5b5-0a24-4e01-adc9-96914091cdbe, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
Questupdate("LOW_ReachEmperorLair", "EmperorLair_Completion");

//END_REGION

//REGION Journal LOW_ElfsongRats
IF
FlagSet(LOW_Elfsong_Roveer_HasMet_ed6c03ae-982c-641c-c9d6-89f995bfef4d, _Player, _)
THEN
QuestUpdate((CHARACTER)_Player, "LOW_ElfsongRats", "Start_RoveerRats");

IF
DB_PermaDefeated(S_LOW_Elfsong_Reevor_3e5b30c3-ae3a-48b6-9394-11adde54ad57)
AND
DB_QuestIsOpened("LOW_ElfsongRats")
THEN
QuestUpdate("LOW_ElfsongRats", "Elfsong_Rats_DeadRoveer_COMPLETION");
//END_REGION Journal LOW_ElfsongRats

//REGION Met Devella
IF
FlagSet((FLAG)LOW_Elfsong_DevellaHasMet_55c4521a-5cf9-2e38-1877-bf229e1c57ab, _, _)
THEN
SetEntityEvent((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_ElfSong_MetDevellaFountainhead", 1);
//END_REGION

//REGION Debug

IF
TextEvent("KilledLakrissa")
THEN
PROC_SetOnStage(S_LOW_Elfsong_Falten_f7a12012-0d77-4741-adea-26e9c5c58aea, 1);
PROC_SetOnStage(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, 0);
Die(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c);
DB_Dialogs(S_LOW_Elfsong_Falten_f7a12012-0d77-4741-adea-26e9c5c58aea, (DIALOGRESOURCE)LOW_Elfsong_Falten_099e9f52-68d8-e50b-ec0e-9ca42edad83d);

IF
TextEvent("LOW_BetLakrissa")
AND
DB_Players(_Player)
THEN
SetFlag(DEN_General_TieflingGuard10_MadeBet_da251529-cf00-141c-4ace-52bb3ce70b41, _Player);

IF
TextEvent("KilledAlfira")
THEN
PROC_SetOnStage(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, 0);
Die(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);

IF
TextEvent("LOW_KillTemplar")
THEN
Die(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c);

IF
TextEvent("LOW_KillVlaakithCaster")
THEN
Die(S_TWN_VlaakithAttack_Caster_000_e4141a02-f5e7-4a0c-a7af-d3dda6610c1b);

IF
TextEvent("LOW_Elfsong_AllPatronFlags")
THEN
SetFlag(LOW_BaldursMouth_State_PositiveArticlePublished_14071582-0c75-40e5-9121-251d6a9524e4);
SetFlag(LOW_BaldursMouth_State_NegativeArticlePublished_baa834bc-8237-4081-8699-297743dc54d2);
SetFlag(GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b);
SetFlag(LOW_SerialKiller_State_DolorIsDead_fa48e3fe-dc3c-b5c5-09f1-039a5b6974cf);
SetFlag(WYR_KillDirectorGortash_State_CeremonyEnded_9aeab401-c087-4f2e-9894-859df23680dc);
SetFlag(GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769);
SetFlag(LOW_SerialKiller_State_HighberrysRitualPerformed_00c1e2ab-8752-47f1-b847-51aedc0fb189);
SetFlag(IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9);
SetFlag(LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098);
SetFlag(CAMP_Elfsong_PaymentDone_fd063151-f443-4b87-80bf-6a9441b2b4d7);
SetFlag(LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5);

IF
TextEvent("LOW_Elfsong_KillRats")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_Elfsong_KillAllRats(_Player);

PROC
PROC_LOW_Elfsong_KillAllRats((CHARACTER)_Player)
AND
DB_GLO_DefeatCounter(_Rat, "LOW_Elfsong_CellarRats")
THEN
Die(_Rat, DEATHTYPE.Physical, _Player, 1, 1, 1.0);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
