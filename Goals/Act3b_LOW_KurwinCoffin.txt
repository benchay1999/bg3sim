Version 1
SubGoalCombiner SGC_AND
INITSECTION
//For now, the coffins are chests. This sets up the original lootable ChestCoffins with the Mounds
DB_ShovelArea((ITEM)S_LOW_KurwinMound_e804773e-78fb-49bc-ab34-14c2fd976986,(ITEM)S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55);
DB_ShovelArea((ITEM)S_LOW_GraveMound1_b62f51ce-739e-4aee-8dab-914f4ac845e6,(ITEM)S_LOW_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06);
DB_ShovelArea((ITEM)S_LOW_GraveMound2_d210cbd2-b90c-4e20-986d-152bdfed7a38,(ITEM)S_LOW_GraveCasket2_0f6483b9-5116-41d0-a464-4b43820a460a);
DB_ShovelArea((ITEM)S_LOW_GraveMound3_2953ed1b-8ba0-4add-8249-1160da206d27,(ITEM)S_LOW_GraveCasket3_1207bc29-3ac0-4381-9c5f-d801964569e1);
DB_ShovelArea((ITEM)S_LOW_GraveMound4_6b4791ae-ad25-4531-9a3c-9b062db9a884,(ITEM)S_LOW_GraveCasket4_d6a936c3-8618-49aa-bdd1-f31bfbcfe05e);
DB_ShovelArea((ITEM)S_LOW_GraveMound5_c60ddd34-58fa-4ee0-94da-cdbf94ff1e4b,(ITEM)S_LOW_GraveCasket5_6bd4ec71-3b70-45c4-bf72-68a763782da9);
DB_ShovelArea((ITEM)S_LOW_KurwinCoffin_GraveMound6_6c391627-cb6b-4a94-bd62-9b4474945f08,(ITEM)S_LOW_KurwinCoffin_TeleportMound_8712c8d1-c013-4b6c-b626-0dcd66c85830);
DB_ShovelArea((ITEM)S_LOW_KurwinCoffin_GraveMound7_a2d00bd0-b859-4a70-a261-bebba8af3e11, (ITEM)S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107);

// List of mounds to keep an ear out for graverobbing
DB_LOW_KurwinCoffin_Mounds((ITEM)S_LOW_KurwinMound_e804773e-78fb-49bc-ab34-14c2fd976986);
DB_LOW_KurwinCoffin_Mounds((ITEM)S_LOW_GraveMound1_b62f51ce-739e-4aee-8dab-914f4ac845e6);
DB_LOW_KurwinCoffin_Mounds((ITEM)S_LOW_GraveMound2_d210cbd2-b90c-4e20-986d-152bdfed7a38);
DB_LOW_KurwinCoffin_Mounds((ITEM)S_LOW_GraveMound3_2953ed1b-8ba0-4add-8249-1160da206d27);
DB_LOW_KurwinCoffin_Mounds((ITEM)S_LOW_GraveMound4_6b4791ae-ad25-4531-9a3c-9b062db9a884);
DB_LOW_KurwinCoffin_Mounds((ITEM)S_LOW_GraveMound5_c60ddd34-58fa-4ee0-94da-cdbf94ff1e4b);
DB_LOW_KurwinCoffin_Mounds((ITEM)S_LOW_KurwinCoffin_GraveMound6_6c391627-cb6b-4a94-bd62-9b4474945f08);
DB_LOW_KurwinCoffin_Mounds((ITEM)S_LOW_KurwinCoffin_GraveMound7_a2d00bd0-b859-4a70-a261-bebba8af3e11);

//Removed post-GUS-258003 patch, replaced with separate _Hole and _Kobold DB. These are kept to set the old holes off stage
DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)S_LOW_KurwinCoffin_KoboldHole001_9b09f43e-46d7-4a10-8351-0c3b70ca8686, S_LOW_KurwinCoffin_KoboldSpawn001_7994ac58-4731-4fa0-9a67-aa4344fe6779);
DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)S_LOW_KurwinCoffin_KoboldHole002_8f12bdc1-fa74-4e66-a0b3-6d2f77376b92, S_LOW_KurwinCoffin_KoboldSpawn002_c21fe2ed-913b-47ae-b11c-eed803d77115);
DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)S_LOW_KurwinCoffin_KoboldHole003_f1b59184-15ad-479d-af65-3cd463c65149, S_LOW_KurwinCoffin_KoboldSpawn003_f2f32380-c9c5-449d-8c8f-faa56a6f8ddb);
DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)S_LOW_KurwinCoffin_KoboldHole004_e838a453-1cf0-47e9-aae2-d2b40a4ac9ac, S_LOW_KurwinCoffin_KoboldSpawn004_b650b1a8-967d-4482-ad86-ce218772ef1d);
DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)S_LOW_KurwinCoffin_KoboldHole005_d9d107ac-aed5-449b-ae9c-93f282ada235, S_LOW_KurwinCoffin_KoboldSpawn005_0dd30c36-a1fd-4841-bde5-d4e40f9a2172);
DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)S_LOW_KurwinCoffin_KoboldHole006_04e52cb8-9ec2-47dd-bcb1-50f9ea2bc4f4, S_LOW_KurwinCoffin_KoboldSpawn006_8eacd75a-745e-4d1c-8168-6a6dc8dffe89);

//Kobold Looter and cronies have to be gathered, then set off stage, so start them off stage.
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem001_aa9fb237-7e97-4c23-bdd8-3c8e4c5cf5b9, S_LOW_KurwinCoffin_KoboldSpawn001_7994ac58-4731-4fa0-9a67-aa4344fe6779);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem002_468a7ce1-bcb2-4ea8-ad17-a4c5a6c18153, S_LOW_KurwinCoffin_KoboldSpawn002_c21fe2ed-913b-47ae-b11c-eed803d77115);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem003_0b97635b-8082-44c0-b2cd-f8853408194f, S_LOW_KurwinCoffin_KoboldSpawn003_f2f32380-c9c5-449d-8c8f-faa56a6f8ddb);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem004_422ffd36-8314-4c8f-b016-0c03db4e40d2, S_LOW_KurwinCoffin_KoboldSpawn004_b650b1a8-967d-4482-ad86-ce218772ef1d);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem005_d1771acc-becd-4bdf-96af-fe02073b2a4e, S_LOW_KurwinCoffin_KoboldSpawn005_0dd30c36-a1fd-4841-bde5-d4e40f9a2172);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem006_fe6c5226-2e2e-4767-9658-793c51bc3668, S_LOW_KurwinCoffin_KoboldSpawn006_8eacd75a-745e-4d1c-8168-6a6dc8dffe89);

DB_LOW_KurwinCoffin_KoboldGang_Kobolds((CHARACTER)S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);

//Kobold spell spawn catchers
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_KurwinCoffin_Kobolds_Inventor_f464fb6a-ff22-4ba6-9a33-d9608b67c044);
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_KurwinCoffin_Kobolds_Melee_339b7a9b-fce9-42d3-a542-2cb116c174aa);
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_KurwinCoffin_Kobolds_Ranger_592f90cc-f9bd-4916-a493-0439935a2c04);

//DB to associate Filled Coffins with Mounds (Might be unnecessary and something I could just do as part of the next DB? - Review)
DB_LOW_KurwinCoffin_FilledCoffins((ITEM)S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55, (ITEM)S_LOW_KurwinMound_e804773e-78fb-49bc-ab34-14c2fd976986);
DB_LOW_KurwinCoffin_FilledCoffins((ITEM)S_LOW_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06, (ITEM)S_LOW_GraveMound1_b62f51ce-739e-4aee-8dab-914f4ac845e6);
DB_LOW_KurwinCoffin_FilledCoffins((ITEM)S_LOW_GraveCasket2_0f6483b9-5116-41d0-a464-4b43820a460a, (ITEM)S_LOW_GraveMound2_d210cbd2-b90c-4e20-986d-152bdfed7a38);
DB_LOW_KurwinCoffin_FilledCoffins((ITEM)S_LOW_GraveCasket3_1207bc29-3ac0-4381-9c5f-d801964569e1, (ITEM)S_LOW_GraveMound3_2953ed1b-8ba0-4add-8249-1160da206d27);
DB_LOW_KurwinCoffin_FilledCoffins((ITEM)S_LOW_GraveCasket4_d6a936c3-8618-49aa-bdd1-f31bfbcfe05e, (ITEM)S_LOW_GraveMound4_6b4791ae-ad25-4531-9a3c-9b062db9a884);
DB_LOW_KurwinCoffin_FilledCoffins((ITEM)S_LOW_GraveCasket5_6bd4ec71-3b70-45c4-bf72-68a763782da9, (ITEM)S_LOW_GraveMound5_c60ddd34-58fa-4ee0-94da-cdbf94ff1e4b);

//DB to associate Filled coffins with empty coffins so we can swap them out later
DB_LOW_KurwinCoffin_EmptyCoffins((ITEM)S_LOW_KurwinCoffin_KurwinCasketEmpty_167bac6c-3717-486a-8262-7d2cc481593d, (ITEM)S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55);
DB_LOW_KurwinCoffin_EmptyCoffins((ITEM)S_LOW_EmptyGraveCasket1_5014faf2-e3e6-4eb4-99d1-e52d372dfd65, (ITEM)S_LOW_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06);
DB_LOW_KurwinCoffin_EmptyCoffins((ITEM)S_LOW_EmptyGraveCasket2_4ff4a2a5-2631-4f81-af68-f1fadc06e75a, (ITEM)S_LOW_GraveCasket2_0f6483b9-5116-41d0-a464-4b43820a460a);
DB_LOW_KurwinCoffin_EmptyCoffins((ITEM)S_LOW_EmptyGraveCasket3_92926de7-3be7-4d5f-b683-cfd7a7f1ebb0, (ITEM)S_LOW_GraveCasket3_1207bc29-3ac0-4381-9c5f-d801964569e1);
DB_LOW_KurwinCoffin_EmptyCoffins((ITEM)S_LOW_EmptyGraveCasket4_3122f591-db26-4a4c-9276-c239ed31daf9, (ITEM)S_LOW_GraveCasket4_d6a936c3-8618-49aa-bdd1-f31bfbcfe05e);
DB_LOW_KurwinCoffin_EmptyCoffins((ITEM)S_LOW_EmptyGraveCasket5_1468f631-8614-4ae0-bd0c-0cd8fa1518cc, (ITEM)S_LOW_GraveCasket5_6bd4ec71-3b70-45c4-bf72-68a763782da9);

//AD's for Graves, if the player chooses to look around
DB_ItemDialog_NarratorAD(S_LOW_KurwinCoffin_Grave1_3694939a-eaa9-4c92-8140-ab82e6102bad, LOW_KurwinCoffin_AD_Grave1_3cab3640-fff9-96f8-3e88-eabfc37319a7);
DB_ItemDialog_NarratorAD(S_LOW_KurwinCoffin_Grave2_67c11a15-6c7c-4f45-8248-b0377774a488, LOW_KurwinCoffin_AD_Grave2_459bcb05-1a2d-709e-5254-267a2aa4d921);
DB_ItemDialog_NarratorAD(S_LOW_KurwinCoffin_Grave3_1aae905d-89dc-4f48-8ffe-668f8806ea15, LOW_KurwinCoffin_AD_Grave3_799b60f8-b0e9-bf4e-9093-9e22513f0c60);
DB_ItemDialog_NarratorAD(S_LOW_KurwinCoffin_Grave4_0afd0d5c-50da-405f-92ac-ff30a8eb9b32, LOW_KurwinCoffin_AD_Grave4_b7baea88-8d17-0440-ffc4-561fd69cacc8);
DB_ItemDialog_NarratorAD(S_LOW_KurwinCoffin_Grave5_16a0167b-a507-47cc-afee-85503d62a1e5, LOW_KurwinCoffin_AD_Grave5_c35a1000-6772-e834-97f1-acfae49306a5);

//Proc to set up the offset of the Kobold Trigger to the Casket, since it can realistically be anywhere
//PROC_LOW_KurwinCoffer_Init():

//For setting up the gold in the dialogue
DB_DialogMoneyTransfer(1, LOW_KurwinCoffin_KoboldLooter_5551974f-68cb-76de-8ef9-66094b2bd7de, 500);

//For registering the trigger
PROC_TriggerRegisterForParty(S_LOW_KoboldLeaveTrigger_58c117c7-889d-415b-b069-77851a544fbe);

//Adding in the dialog for the Kobold Looter as a backup
DB_Dialogs(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, LOW_KurwinCoffin_KoboldLooter_5551974f-68cb-76de-8ef9-66094b2bd7de);

//Dialogs for all those in the graveyard
DB_Dialogs(S_LOW_GraveyardFlowerGirl_7a05212e-a019-4802-aaca-7fdb98f3c872, LOW_KurwinCoffin_FlowerSeller_b4725589-2394-0885-a6f5-ed0823d6fa5e);
DB_Dialogs(S_LOW_BereavedFather_42023010-c670-4885-addf-23e9bb31af32, LOW_KurwinCoffin_BereavedFather_7c50f051-47e8-6d6e-b5a8-29c2e3a3bab9);
DB_Dialogs(S_LOW_BereavedMother_f83df228-b03f-465d-aae5-c40007249f19, LOW_KurwinCoffin_BereavedMother_2c487839-c156-a14c-67b6-8086d60920be);
DB_Dialogs(S_LOW_CoffinMaker_e78e15fe-f131-49b3-8b88-87b33cebf694, LOW_KurwinCoffin_CoffinMaker_5b072aae-75e2-eed3-689c-ab38ef67f1ec);
DB_Dialogs(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, LOW_KurwinCoffin_BuriedMan_509c0640-b99c-bc07-7c19-56080a24458b);
DB_Dialogs(S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, LOW_KurwinCoffin_KidNecromancer_ec5d912b-b3cd-0476-50b3-52598ac1b30d);
DB_Dialogs(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, LOW_KurwinCoffin_KelemvorPriestess_54975a96-4874-ec96-635c-f9c28c307c60);
DB_Dialogs(S_LOW_KurwinCoffin_Gravekeeper_865e5b54-e3d6-4fa3-80b4-d5f0b31873d5, LOW_KurwinCoffin_Gravekeeper_117abe07-0931-0971-10a0-ddb22e982319);
DB_Dialogs(S_LOW_KurwinCoffin_MourningChild_025399eb-b420-47b7-a00f-34dde4fb8499, LOW_KurwinCoffin_MourningChild_178bbaa4-87e5-5022-2817-aac4118751bc);
DB_Dialogs(S_LOW_KurwinCoffin_MourningDwarf_1c70be16-21f6-4903-abfc-92e7c64e52b9, LOW_KurwinCoffin_MourningDwarf_876fcb57-e598-ca8a-fc9b-fd03dd1daab6);
DB_Dialogs(S_LOW_KurwinCoffin_BuriedManTube_08ac4f07-1d09-46f5-9da7-af2ad8c282b2, LOW_KurwinCoffin_AD_BuriedManBell_f78fb8ef-51e2-6275-c828-2790e69ab966);

//Hide Kurwin's Cauteriser
SetOnStage(WPN_LOW_KurwinCoffin_KurwinsCauteriserMace_000_c8d32907-5cee-45d2-8892-b724b3fd9741, 0);

// DBs for the risen undead of the Kid Necromancer
DB_LOW_KurwinCoffin_RisenUndead_Waves(1,(CHARACTER)S_LOW_KurwinCoffin_W1_RisenGreaterZombie_000_a249e576-9590-44bb-8861-727878ff6378);
DB_LOW_KurwinCoffin_RisenUndead_Waves(1,(CHARACTER)S_LOW_KurwinCoffin_W1_RisenGreaterZombie_001_12ff4a57-71d3-4728-b82e-79881aeb2422);
DB_LOW_KurwinCoffin_RisenUndead_Waves(1,(CHARACTER)S_LOW_KurwinCoffin_W1_RisenSkeleton_000_adafe912-0ea8-4672-831f-89379f7dbbb3);
DB_LOW_KurwinCoffin_RisenUndead_Waves(1,(CHARACTER)S_LOW_KurwinCoffin_W1_RisenSkeleton_001_7dd25316-fcd2-4be0-9e95-4329c3c63e15);
DB_LOW_KurwinCoffin_RisenUndead_Waves(1,(CHARACTER)S_LOW_KurwinCoffin_W3_RisenSkeleton_Giant_49cc5f9e-72e3-440f-be8b-2c4ecf5964b5);
DB_LOW_KurwinCoffin_RisenUndead_Waves(1,(CHARACTER)S_LOW_KurwinCoffin_W1_RisenZombie_000_ef33221b-8784-4ef5-8254-f5509bebf280);
DB_LOW_KurwinCoffin_RisenUndead_Waves(1,(CHARACTER)S_LOW_KurwinCoffin_W1_RisenZombie_001_33f12cb2-a215-4477-9b63-e808943e5622);
DB_LOW_KurwinCoffin_RisenUndead_Waves(1,(CHARACTER)S_LOW_KurwinCoffin_W1_RisenZombie_002_0d85e2c0-8bdd-4054-863e-9ae48d26d3e0);

DB_LOW_KurwinCoffin_RisenUndead_Waves(3,(CHARACTER)S_LOW_KurwinCoffin_W2_RisenGreaterZombie_000_f34c2984-6a8d-4be2-9194-41b58fd76b78);
DB_LOW_KurwinCoffin_RisenUndead_Waves(3,(CHARACTER)S_LOW_KurwinCoffin_W2_RisenSkeleton_000_cddec41d-e04d-4f92-831c-5b69f9ca3935);
DB_LOW_KurwinCoffin_RisenUndead_Waves(3,(CHARACTER)S_LOW_KurwinCoffin_W2_RisenSkeleton_001_ebeac71b-70c2-4967-8db4-6479cf95d156);
DB_LOW_KurwinCoffin_RisenUndead_Waves(3,(CHARACTER)S_LOW_KurwinCoffin_W2_RisenSkeleton_002_81fe4430-ff34-4d74-993a-f96596b57f15);
DB_LOW_KurwinCoffin_RisenUndead_Waves(3,(CHARACTER)S_LOW_KurwinCoffin_W2_RisenZombie_000_32184af9-a79c-4441-8984-f88222c6beee);
DB_LOW_KurwinCoffin_RisenUndead_Waves(3,(CHARACTER)S_LOW_KurwinCoffin_W2_RisenZombie_001_4f7f5f28-0a47-41a1-b296-0b10de15f9ab);
DB_LOW_KurwinCoffin_RisenUndead_Waves(3,(CHARACTER)S_LOW_KurwinCoffin_W2_RisenZombie_002_b3d5ce26-a490-44cb-8d3b-c608dc970290);

DB_LOW_KurwinCoffin_RisenUndead_Waves(4,(CHARACTER)S_LOW_KurwinCoffin_W3_RisenGreaterZombie_000_db09a47c-c7ec-40e9-8d3d-d13b8a071106);
DB_LOW_KurwinCoffin_RisenUndead_Waves(4,(CHARACTER)S_LOW_KurwinCoffin_W3_RisenSkeleton_001_53e41096-751f-44c5-8868-8a1889d3b2ec);
DB_LOW_KurwinCoffin_RisenUndead_Waves(4,(CHARACTER)S_LOW_KurwinCoffin_W3_RisenSkeleton_001_9f84f821-a388-451d-87e4-3cce8312a40a);
DB_LOW_KurwinCoffin_RisenUndead_Waves(4,(CHARACTER)S_LOW_KurwinCoffin_W1_RisenSkeleton_002_8fa9a234-af17-45ec-a886-ee5b9801cb30);
DB_LOW_KurwinCoffin_RisenUndead_Waves(4,(CHARACTER)S_LOW_KurwinCoffin_W3_RisenZombie_000_efe97f82-580d-4b63-865f-153ef65d8ee9);
DB_LOW_KurwinCoffin_RisenUndead_Waves(4,(CHARACTER)S_LOW_KurwinCoffin_W3_RisenZombie_001_975a3277-5fc6-4bfc-9d4f-929ca55ac55b);
DB_LOW_KurwinCoffin_RisenUndead_Waves(4,(CHARACTER)S_LOW_KurwinCoffin_W3_RisenZombie_002_fe7ca260-5c50-4280-8dad-60378f86f8a6);

PROC_DeclareCounter("LOW_KidNecromancer_TurnCount");

// Combat NPC Reactivity
DB_CombatReact_AD_OnNextTurn(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, (DIALOGRESOURCE)LOW_KurwinCoffin_AD_KoboldAttack001_98798511-7dcd-b615-8b74-c97e0b6e287e);
DB_CombatReact_AD_OnNextTurn(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, (DIALOGRESOURCE)LOW_KurwinCoffin_AD_KoboldAttack002_b4a84c61-9b5a-7a3d-b5e1-7cda4f4d620f);
DB_CombatReact_AD_OnNextTurn(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, (DIALOGRESOURCE)LOW_KurwinCoffin_AD_KoboldAttack003_d9317695-cc8e-1985-ea2b-0945e60d513c);
DB_CombatReact_AD_OnNextTurn(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, (DIALOGRESOURCE)LOW_KurwinCoffin_AD_KoboldAttack004_6b6ea21a-94cb-19a5-f03c-b6560c79f37a);

DB_CombatReact_AD_OnNextTurn(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, (DIALOGRESOURCE)LOW_KurwinCoffin_AD_PriestessCombatAD001_c2a609a9-a767-01cb-94c3-2a0c73eafe09);
DB_CombatReact_AD_OnNextTurn(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, (DIALOGRESOURCE)LOW_KurwinCoffin_AD_PriestessCombatAD002_34900b62-8eb2-34f3-5851-ac65e6f8a22c);
DB_CombatReact_AD_OnNextTurn(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, (DIALOGRESOURCE)LOW_KurwinCoffin_AD_PriestessCombatAD003_17853b47-ac6e-3054-1029-0bc435e84ba1);

//Ownership
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_KukrwinCoffin_Mortuary_SUB_6aa0a6fb-53dc-4cd9-b52c-f1340aae0452, (CHARACTER)S_LOW_KurwinCoffin_Gravekeeper_865e5b54-e3d6-4fa3-80b4-d5f0b31873d5);

SetOnStage(S_LOW_KurwinCoffin_BuriedManTube_Useless_ad6b2bab-b0c3-4223-8e74-4cabfa561336, 0);
SetOnStage(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, 0);
SetOnStage(S_LOW_KurwinCoffin_DogGhost_01_05fcc85e-ff22-4ba3-9fcf-71e08f50eb69, 0);
SetOnStage(S_LOW_KurwinCoffin_DogGhost_03_b40c5e21-4aba-4252-b8e6-219ac1764814, 0);
SetOnStage(S_LOW_KurwinCoffin_DogGhost_02_fd402b3e-4e95-4366-8e46-9b8e6f0b85b0, 0);
SetOnStage(S_LOW_KurwinCoffin_Houndmaster_ae950485-c1c8-45ed-9420-e14007f53cd6, 0);

//List of Coffin inhabitants and their items
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_Cat000_dad7c727-bb5d-47ba-9203-bb0845e6cd7a, S_LOW_KurwinCoffin_EmptyGraveCasket1_5014faf2-e3e6-4eb4-99d1-e52d372dfd65, S_LOW_KurwinCoffin_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_Cat001_9ad37a3d-fadb-46cf-9d3f-1e271aa06775, S_LOW_KurwinCoffin_EmptyGraveCasket1_5014faf2-e3e6-4eb4-99d1-e52d372dfd65, S_LOW_KurwinCoffin_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_Cat002_6c7e3473-48b7-4ca2-8fed-89e500682c98, S_LOW_KurwinCoffin_EmptyGraveCasket1_5014faf2-e3e6-4eb4-99d1-e52d372dfd65, S_LOW_KurwinCoffin_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_Cat003_da9aacae-4764-48b1-96a9-f3a6b6dbdc20, S_LOW_KurwinCoffin_EmptyGraveCasket1_5014faf2-e3e6-4eb4-99d1-e52d372dfd65, S_LOW_KurwinCoffin_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_Cat004_79639570-f77a-495b-baf7-02f5af74c531, S_LOW_KurwinCoffin_EmptyGraveCasket1_5014faf2-e3e6-4eb4-99d1-e52d372dfd65, S_LOW_KurwinCoffin_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_CatLover_38c5e294-5f1d-47f0-9962-43c33d3c7183, S_LOW_KurwinCoffin_EmptyGraveCasket1_5014faf2-e3e6-4eb4-99d1-e52d372dfd65, S_LOW_KurwinCoffin_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_CatManDiary_f10ebd91-7278-431d-b7c0-b4838347a68b, S_LOW_KurwinCoffin_EmptyGraveCasket1_5014faf2-e3e6-4eb4-99d1-e52d372dfd65, S_LOW_KurwinCoffin_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06);

DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_MournedMotherNote_951a7184-e4f5-4a4a-aeab-8bc3bd90f320, S_LOW_KurwinCoffin_EmptyGraveCasket2_4ff4a2a5-2631-4f81-af68-f1fadc06e75a, S_LOW_KurwinCoffin_GraveCasket2_0f6483b9-5116-41d0-a464-4b43820a460a);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_MournedMother_faa6c698-079c-499e-9db5-c39111e45a6f, S_LOW_KurwinCoffin_EmptyGraveCasket2_4ff4a2a5-2631-4f81-af68-f1fadc06e75a, S_LOW_KurwinCoffin_GraveCasket2_0f6483b9-5116-41d0-a464-4b43820a460a);

DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_WyvernTeaHorn_b9054e9b-1e23-490d-85b7-fa98e94d8c61, S_LOW_KurwinCoffin_EmptyGraveCasket3_92926de7-3be7-4d5f-b683-cfd7a7f1ebb0, S_LOW_KurwinCoffin_GraveCasket3_1207bc29-3ac0-4381-9c5f-d801964569e1);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_WyvernTeaNotes_168a39f0-ea8e-42fc-affe-1a724622d9f2, S_LOW_KurwinCoffin_EmptyGraveCasket3_92926de7-3be7-4d5f-b683-cfd7a7f1ebb0, S_LOW_KurwinCoffin_GraveCasket3_1207bc29-3ac0-4381-9c5f-d801964569e1);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_WyvernTeaDrinker_6411b408-32c4-43bc-a3d3-b85f632fcf45, S_LOW_KurwinCoffin_EmptyGraveCasket3_92926de7-3be7-4d5f-b683-cfd7a7f1ebb0, S_LOW_KurwinCoffin_GraveCasket3_1207bc29-3ac0-4381-9c5f-d801964569e1);

DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_RunawaySister_5cd78c94-eeec-4b79-9170-92ee383467d9, S_LOW_KurwinCoffin_EmptyGraveCasket4_3122f591-db26-4a4c-9276-c239ed31daf9, S_LOW_KurwinCoffin_GraveCasket4_d6a936c3-8618-49aa-bdd1-f31bfbcfe05e);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_RunawayBrother_e9d1aa0f-a782-40f4-81f3-2ed2267bf4d1, S_LOW_KurwinCoffin_EmptyGraveCasket4_3122f591-db26-4a4c-9276-c239ed31daf9, S_LOW_KurwinCoffin_GraveCasket4_d6a936c3-8618-49aa-bdd1-f31bfbcfe05e);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_RunawayLetter_d39a9058-4ac6-4d95-a72c-2a49ca37f368, S_LOW_KurwinCoffin_EmptyGraveCasket4_3122f591-db26-4a4c-9276-c239ed31daf9, S_LOW_KurwinCoffin_GraveCasket4_d6a936c3-8618-49aa-bdd1-f31bfbcfe05e);

DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_LonelyManDiary_a78bad85-94e7-407d-95f3-262e623737de, S_LOW_KurwinCoffin_EmptyGraveCasket5_1468f631-8614-4ae0-bd0c-0cd8fa1518cc, S_LOW_KurwinCoffin_GraveCasket5_6bd4ec71-3b70-45c4-bf72-68a763782da9);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_LonelyMan_86f0b40a-350e-40b5-bd65-ca2430f76ef3, S_LOW_KurwinCoffin_EmptyGraveCasket5_1468f631-8614-4ae0-bd0c-0cd8fa1518cc, S_LOW_KurwinCoffin_GraveCasket5_6bd4ec71-3b70-45c4-bf72-68a763782da9);

DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_MausoleumDogCorpse_03_550cbc2c-004a-4fe5-a70e-8f1d890a2e1f, S_LOW_PetMausoleum_DogTomb_03_fb6a83a2-afbb-4a78-84f0-948c702d8f41, S_LOW_PetMausoleum_DogTomb_03_fb6a83a2-afbb-4a78-84f0-948c702d8f41);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_MausoleumDogCorpse_02_8945ba9c-a8d5-4bea-aac2-3e5a924424cd, S_LOW_PetMausoleum_DogTomb_02_69c4853f-a37f-4a03-a987-da15f3361ed6, S_LOW_PetMausoleum_DogTomb_02_69c4853f-a37f-4a03-a987-da15f3361ed6);
DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_MausoleumDogCorpse_01_f9d9d099-8be3-4184-9701-2e8465e8c973, S_LOW_PetMausoleum_DogTomb_01_aa7250c0-62e5-4d09-a64b-f6294d619733, S_LOW_PetMausoleum_DogTomb_01_aa7250c0-62e5-4d09-a64b-f6294d619733);

DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_BuriedManCoffinSharer_b4b8e3b9-c8bd-40dd-8319-2aeee508f372, S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107, S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107);

//Money for the coffin builder
DB_DialogMoneyTransfer(1, LOW_KurwinCoffin_CoffinMaker_5b072aae-75e2-eed3-689c-ab38ef67f1ec, 500);

//Debug casket setups
DB_LOW_KurwinCoffin_DebugList("LOW_KurwinCoffin_CasketCatMan", S_LOW_KurwinCoffin_GraveCasket1_571bcb15-5571-4b2f-9090-64a7dbe57c06, S_LOW_KurwinCoffin_GraveMound1_b62f51ce-739e-4aee-8dab-914f4ac845e6);
DB_LOW_KurwinCoffin_DebugList("LOW_KurwinCoffin_CasketMourningChild", S_LOW_KurwinCoffin_GraveCasket2_0f6483b9-5116-41d0-a464-4b43820a460a, S_LOW_KurwinCoffin_GraveMound2_d210cbd2-b90c-4e20-986d-152bdfed7a38);
DB_LOW_KurwinCoffin_DebugList("LOW_KurwinCoffin_CasketTeaDrinker", S_LOW_KurwinCoffin_GraveCasket3_1207bc29-3ac0-4381-9c5f-d801964569e1, S_LOW_KurwinCoffin_GraveMound3_2953ed1b-8ba0-4add-8249-1160da206d27);
DB_LOW_KurwinCoffin_DebugList("LOW_KurwinCoffin_CasketRunaways", S_LOW_KurwinCoffin_GraveCasket4_d6a936c3-8618-49aa-bdd1-f31bfbcfe05e, S_LOW_KurwinCoffin_GraveMound4_6b4791ae-ad25-4531-9a3c-9b062db9a884);
DB_LOW_KurwinCoffin_DebugList("LOW_KurwinCoffin_CasketLonelyMan", S_LOW_KurwinCoffin_GraveCasket5_6bd4ec71-3b70-45c4-bf72-68a763782da9, S_LOW_KurwinCoffin_GraveMound5_c60ddd34-58fa-4ee0-94da-cdbf94ff1e4b);
DB_LOW_KurwinCoffin_DebugList("LOW_KurwinCoffin_CasketKurwin", S_LOW_KurwinCoffin_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55, S_LOW_KurwinCoffin_KurwinMound_e804773e-78fb-49bc-ab34-14c2fd976986);
DB_LOW_KurwinCoffin_DebugList("LOW_KurwinCoffin_CasketMinscVictim", S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107, S_LOW_KurwinCoffin_GraveMound7_a2d00bd0-b859-4a70-a261-bebba8af3e11);
DB_LOW_KurwinCoffin_DebugList("LOW_KurwinCoffin_CasketTeleporter", S_LOW_KurwinCoffin_TeleportMound_8712c8d1-c013-4b6c-b626-0dcd66c85830, S_LOW_KurwinCoffin_GraveMound6_6c391627-cb6b-4a94-bd62-9b4474945f08);

DB_HasItemTemplateScriptFlag(1, (DIALOGRESOURCE)LOW_KurwinCoffin_KidNecromancer_ec5d912b-b3cd-0476-50b3-52598ac1b30d, (ITEMROOT)LOOT_SCROLL_AnimateDead_8b9b4657-93f3-4382-b6e0-a587902abcba, 2);
DB_RemoveItemFromTemplateEvent((ITEMROOT)LOOT_SCROLL_AnimateDead_8b9b4657-93f3-4382-b6e0-a587902abcba, (FLAG)LOW_KurwinCoffin_Event_GaveNinaScroll_03c93df1-c08a-4423-87e8-263e22b4ea4b, NULL_00000000-0000-0000-0000-000000000000, 1);

//Pol and the ghost dogs

DB_LOW_KurwinCoffin_GhostEncounter(S_LOW_KurwinCoffin_DogGhost_01_05fcc85e-ff22-4ba3-9fcf-71e08f50eb69);
DB_LOW_KurwinCoffin_GhostEncounter(S_LOW_KurwinCoffin_DogGhost_03_b40c5e21-4aba-4252-b8e6-219ac1764814);
DB_LOW_KurwinCoffin_GhostEncounter(S_LOW_KurwinCoffin_DogGhost_02_fd402b3e-4e95-4366-8e46-9b8e6f0b85b0);
DB_LOW_KurwinCoffin_GhostEncounter(S_LOW_KurwinCoffin_Houndmaster_ae950485-c1c8-45ed-9420-e14007f53cd6);

//Peaceful resolution groups

//DB_LOW_KurwinCoffin_PeacefulKobolds(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);

DB_LOW_KurwinCoffin_PeacefulNecromancyFlags(LOW_KurwinCoffin_State_PriestessAndNecromancer_WontRaiseBrother_278ab1a1-8117-79d6-26e2-1a85e4dbbc90);
DB_LOW_KurwinCoffin_PeacefulNecromancyFlags(LOW_KurwinCoffin_State_PriestessAndNecromancer_NinaRanAway_99e9aa29-9d46-312f-dbc6-b40e528497fc);

DB_FlagReactionAfterDialog(LOW_KurwinCoffin_State_ScaredKoboldLeader_e9c5bff9-ebf7-2212-e632-ee24b6c7c1d1, LOW_KurwinCoffin_KoboldLooter_5551974f-68cb-76de-8ef9-66094b2bd7de);
DB_GlobalFlagReactionAfterDialog(LOW_KurwinCoffin_State_DUBuriedLooter_033f9204-b879-4397-b9c5-877251bf2e77, LOW_KurwinCoffin_KoboldLooter_5551974f-68cb-76de-8ef9-66094b2bd7de);
DB_GlobalFlagReactionAfterDialog(LOW_KurwinCoffin_State_KidNecromancer_RaisedBrotherFromDead_50f20126-fafe-f712-8e3d-08d521ea183d, LOW_KurwinCoffin_KidNecromancer_ec5d912b-b3cd-0476-50b3-52598ac1b30d);

DB_QuestDef_State((FLAG)LOW_KurwinCoffin_State_HelpedBereavedCouple_4d3baf56-a815-457b-8465-62e03a70fe9c, "HIDDEN_CTY_Boosters", "LOW_KurwinCoffin_BereavedCouple");
DB_QuestDef_State((FLAG)LOW_KurwinCoffin_State_BuriedMan_Saved_a4eba5cc-906c-97dd-2aa5-4674cc3435f9, "HIDDEN_CTY_Boosters", "LOW_KurwinCoffin_BuriedMan");

// Part of a different changelist that's on hold, dialog file not ready yet
//DB_OneShot_VoiceBarkTrigger(S_LOW_KurwinCoffin_DarkUrgePADTrigger_153714db-a893-4005-bf7b-e6c62d8ca894, (VOICEBARKRESOURCE)LOW_KurwinCoffin_VB_DarkUrge_b72c0288-55c7-c617-6dac-e6c9853b535d, "GlobalIgnoreFailure");

DB_LOW_KurwinCoffin_CatacombUnlocker(S_DOOR_Invisible_A_Interior_Catacomb_Hhune_e74ec421-fa84-452e-9505-91ff992617a8, S_DOOR_CTY_Catacomb_003_1b31b073-eb3a-4b61-b307-27e5158e9f71);
DB_LOW_KurwinCoffin_CatacombUnlocker(S_DOOR_Invisible_A_Interior_Catacomb_004_407a1f6b-266f-44de-a71f-53163ea3db20, S_DOOR_CTY_Catacomb_004_55a53cd9-ab72-448f-b0bf-2a1d27da1da4);

AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, PUZ_LOW_KoboldHoleItem004_422ffd36-8314-4c8f-b016-0c03db4e40d2);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, PUZ_LOW_KoboldHoleItem005_d1771acc-becd-4bdf-96af-fe02073b2a4e);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc,PUZ_LOW_KoboldHoleItem002_468a7ce1-bcb2-4ea8-ad17-a4c5a6c18153);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc,PUZ_LOW_KoboldHoleItem006_fe6c5226-2e2e-4767-9658-793c51bc3668);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc,PUZ_LOW_KoboldHoleItem003_0b97635b-8082-44c0-b2cd-f8853408194f);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc,PUZ_LOW_KoboldHoleItem001_aa9fb237-7e97-4c23-bdd8-3c8e4c5cf5b9);
KBSECTION
//Casket Setup
IF
DB_LOW_KurwinCoffin_CoffinFillers(_GUID, _EmptyCoffin, _FullCoffin)
THEN
ToInventory(_GUID, _FullCoffin, 1, 0, 0);
ObjectTimerLaunch(_GUID, "LOW_KurwinCoffin_BloodTidier", 2000, 1);

IF
ObjectTimerFinished(_Corpse, "LOW_KurwinCoffin_BloodTidier")
AND
DB_LOW_KurwinCoffin_CoffinFillers(_Corpse, _EmptyCoffin, _FullCoffin)
THEN
CreateSurface(_FullCoffin, "SurfaceNone", 30.0, -1.0, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_LOW_KurwinCoffin_CoffinFillers(_Corpse, _EmptyCoffin, _FullCoffin);

IF
ObjectTimerFinished(_Corpse, "LOW_KurwinCoffin_BloodTidier")
AND
IsCharacter(_Corpse, 1)
THEN
PROC_SetCorpseOwner((CHARACTER)_Corpse, S_LOW_KurwinCoffin_Gravekeeper_865e5b54-e3d6-4fa3-80b4-d5f0b31873d5);

//Casket Debug
IF
TextEvent(_Text)
AND
DB_LOW_KurwinCoffin_DebugList(_Text, _Casket, _Mound)
THEN
TeleportTo(_Casket, _Mound, "LOW_KurwinCoffin_CasketSurfacing", 0, 0, 0, 0, 1);
PROC_SetOnStage(_Mound, 0);
PROC_SetOnStage(_Casket, 1);

IF
TextEvent("LOW_KurwinCoffin_CasketsAll")
AND
DB_LOW_KurwinCoffin_DebugList(_Text, _Casket, _Mound)
THEN
TeleportTo(_Casket, _Mound, "LOW_KurwinCoffin_CasketSurfacing", 0, 0, 0, 0, 1);
PROC_SetOnStage(_Mound, 0);
PROC_SetOnStage(_Casket, 1);

//Watch for graverobbing crimes

PROC
PROC_CharacterRegisterCrime_Success((CHARACTER)_Player, "UseForbiddenItem", _, _Mound, _, _)
AND
DB_LOW_KurwinCoffin_Mounds((ITEM)_Mound)
AND
GetFlag((FLAG)LOW_KurwinCoffin_Event_GraveRobbed_feb5edff-e52c-42fe-9176-25580af04f6d, _Player, 0)
THEN
SetFlag((FLAG)LOW_KurwinCoffin_Event_GraveRobbed_feb5edff-e52c-42fe-9176-25580af04f6d, _Player); 

IF
EnteredTrigger(_Player, S_LOW_KurwinCoffin_Graveyard_SUB_76de993a-745d-49bd-907c-468e88acd9b1)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("LOW_KurwinCoffin_DarkUrgeVB")
THEN
StartVoiceBark((VOICEBARKRESOURCE)LOW_KurwinCoffin_VB_DarkUrge_b72c0288-55c7-c617-6dac-e6c9853b535d, _Player);

IF
VoiceBarkStarted((VOICEBARKRESOURCE)LOW_KurwinCoffin_VB_DarkUrge_b72c0288-55c7-c617-6dac-e6c9853b535d, _)
THEN
DB_OnlyOnce("LOW_KurwinCoffin_DarkUrgeVB");

//REGION Seeing strange things in the graveyard should prompt the dialog, but all the flags are set on characters - so mimic the compound flow

IF
FlagSet(LOW_Morbus_State_RecognisedZombie_82c8df5a-6ad2-8a9a-d24c-d9729d7ec916, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_SawStrangeHappenings")
THEN
PROC_GlobalSetFlagAndCache(LOW_KurwinCoffin_State_SawStrangeHappenings_3d926bc9-a089-47a9-85ee-949347f7129c);

IF
FlagSet(LOW_KurwinCoffin_HasMet_KidNecromancer_2035071a-7172-af46-9542-4b068c336668, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_SawStrangeHappenings")
THEN
PROC_GlobalSetFlagAndCache(LOW_KurwinCoffin_State_SawStrangeHappenings_3d926bc9-a089-47a9-85ee-949347f7129c);

IF
FlagSet(LOW_KurwinCoffin_HasMet_KoboldLooter_3521225a-b296-7258-acd5-bf01c1cd6d46, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_SawStrangeHappenings")
THEN
PROC_GlobalSetFlagAndCache(LOW_KurwinCoffin_State_SawStrangeHappenings_3d926bc9-a089-47a9-85ee-949347f7129c);



//REGION General Retreat Script

PROC
PROC_LOW_KurwinCoffin_RetreatWest((CHARACTER)_Character)
THEN
PROC_DisappearOutOfSightTo(_Character, LOW_KurwinCoffin_RetreatPointWest_20386464-3464-4aca-853b-e712e4b8d4e1, "Run", 1, "LOW_KurwinCoffin_CharacterRetreat");

PROC
PROC_LOW_KurwinCoffin_RetreatEast((CHARACTER)_Character)
THEN
PROC_DisappearOutOfSightTo(_Character, LOW_KurwinCoffin_RetreatPointEast_8eb601c8-87a8-4762-a222-19c5b8fe1890, "Run", 1, "LOW_KurwinCoffin_CharacterRetreat");

//END_REGION

//REGION - Booster: Bereaved Couple
//Here to control the dialogues you start with the Father/Mother. They both need to be in the dialog if they can, but have fallbacks otherwise.

QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_BereavedFather_42023010-c670-4885-addf-23e9bb31af32, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_BereavedMother_f83df228-b03f-465d-aae5-c40007249f19, S_LOW_BereavedFather_42023010-c670-4885-addf-23e9bb31af32)
THEN
DB_SelectedDialog(LOW_KurwinCoffin_BereavedCouple_c0a76b39-b79e-9bed-dded-38546936d1cc, S_LOW_BereavedFather_42023010-c670-4885-addf-23e9bb31af32, S_LOW_BereavedMother_f83df228-b03f-465d-aae5-c40007249f19, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_BereavedMother_f83df228-b03f-465d-aae5-c40007249f19, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_BereavedFather_42023010-c670-4885-addf-23e9bb31af32, S_LOW_BereavedMother_f83df228-b03f-465d-aae5-c40007249f19)
THEN
DB_SelectedDialog(LOW_KurwinCoffin_BereavedCouple_c0a76b39-b79e-9bed-dded-38546936d1cc, S_LOW_BereavedFather_42023010-c670-4885-addf-23e9bb31af32, S_LOW_BereavedMother_f83df228-b03f-465d-aae5-c40007249f19, _Player);

PROC
PROC_StateSet_PermaDefeated(S_LOW_CoffinMaker_e78e15fe-f131-49b3-8b88-87b33cebf694)
AND
DB_GlobalFlag(LOW_KurwinCoffin_State_CoffinBeingMade_f7f8b7fc-7f7b-091f-fdf8-8b078e71d519)
THEN
PROC_GlobalClearFlagAndCache(LOW_KurwinCoffin_State_CoffinBeingMade_f7f8b7fc-7f7b-091f-fdf8-8b078e71d519);


//END_REGION

//REGION - Booster: Priestess

IF
FlagSet(LOW_KurwinCoffin_State_PriestessSavingNina_17dd161f-0656-39b4-b5f0-c945fe5bc679, S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, _)
THEN
PROC_NotifyWhenReadyToMoveOn(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, "LOW_KurwinCoffin_PriestessMovingToNina");

PROC
PROC_ReadyToMoveOn(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, "LOW_KurwinCoffin_PriestessMovingToNina")
THEN
PROC_CharacterMoveTo((CHARACTER)S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, S_LOW_KurwinCoffin_PriestessWanderTrigger_b28bddec-c70d-4ea0-87cc-5a407db7db6e, "Walk", "Camp_MeetingYenna_InvitedYenna");

//END_REGION

//REGION - Booster: Kid Necromancer

// Set all the Undead offstage
IF
DB_LOW_KurwinCoffin_RisenUndead_Waves(_,_Char)
THEN
PROC_SetOnStage(_Char, 0);



//If the flag is not set and Mortarch is nearby

QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, _Player)
AND
NOT DB_GlobalFlag(LOW_KurwinCoffin_State_PriestessAndNecromancer_WontRaiseBrother_278ab1a1-8117-79d6-26e2-1a85e4dbbc90)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc)
THEN
DB_SelectedDialog(LOW_KurwinCoffin_PriestessAndNecromancer_68886b55-3cec-df73-e750-7b6b5ef846d7, S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc , S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, _Player)
AND
NOT DB_GlobalFlag(LOW_KurwinCoffin_State_PriestessAndNecromancer_WontRaiseBrother_278ab1a1-8117-79d6-26e2-1a85e4dbbc90)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc)
THEN
DB_SelectedDialog(LOW_KurwinCoffin_PriestessAndNecromancer_68886b55-3cec-df73-e750-7b6b5ef846d7, S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc , S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, _Player);

IF
DB_GlobalFlag(LOW_KurwinCoffin_State_PriestessAndNecromancer_NinaRanAway_99e9aa29-9d46-312f-dbc6-b40e528497fc)
THEN
PROC_NotifyWhenReadyToMoveOn(S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, "LOW_KurwinCoffin_NinaUpset");

PROC
PROC_ReadyToMoveOn(S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, "LOW_KurwinCoffin_NinaUpset")
THEN
PROC_LOW_KurwinCoffin_RetreatWest(S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e);

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_KurwinCoffin_State_KidNecromancer_RaisedBrotherFromDead_50f20126-fafe-f712-8e3d-08d521ea183d)
THEN
PROC_IncreaseCounter("LOW_KidNecromancer_TurnCount");

IF
TurnStarted(S_LOW_KurwinCoffin_W3_RisenSkeleton_Giant_49cc5f9e-72e3-440f-be8b-2c4ecf5964b5)
THEN
PROC_IncreaseCounter("LOW_KidNecromancer_TurnCount");

PROC
PROC_CounterIncreased("LOW_KidNecromancer_TurnCount",(INTEGER)_NewCount)
THEN
PROC_KidNecromancer_RaiseWave(_NewCount);

PROC
PROC_KidNecromancer_RaiseWave((INTEGER)_Wave)
AND
DB_LOW_KurwinCoffin_RisenUndead_Waves(_Wave,_Char)
AND
IsOnStage(_Char,0)
THEN
AppearAt(_Char, _Char, 1, DFLT_UTIL_Spawn_01_510ff37e-0618-40e4-8ce0-236e3dc9c291, "");

//When combat starts with the necromancer skellie, store the GUID
IF
EnteredCombat(S_LOW_KurwinCoffin_W3_RisenSkeleton_Giant_49cc5f9e-72e3-440f-be8b-2c4ecf5964b5, _GUID)
THEN
DB_LOW_KurwinCoffin_NecromancerCombat(_GUID);

IF
SwitchedCombat(S_LOW_KurwinCoffin_W3_RisenSkeleton_Giant_49cc5f9e-72e3-440f-be8b-2c4ecf5964b5, _OldGUID, _NewGUID)
AND
DB_LOW_KurwinCoffin_NecromancerCombat(_OldGUID)
THEN
NOT DB_LOW_KurwinCoffin_NecromancerCombat(_OldGUID);
DB_LOW_KurwinCoffin_NecromancerCombat(_NewGUID);

//When that combat ends, start Nina spotting
IF
CombatEnded(_GUID)
AND
DB_LOW_KurwinCoffin_NecromancerCombat(_GUID)
THEN
DB_SpotPlayers(S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, "LOW_KurwinCoffin_NecromancerFollowUp", LOW_KurwinCoffin_Event_NecromancerStartSpotting_de0810bd-2a23-4990-bcc3-ce1d3f3e2922, LOW_KurwinCoffin_Event_NecromancerStopSpotting_aa8dbbc9-6b7e-4e6f-a58b-ca5ee73433fd);
NOT DB_LOW_KurwinCoffin_NecromancerCombat(_GUID);

//If she spots someone, say her one liner
PROC
PROC_SpotPlayers_Spotted(S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, "LOW_KurwinCoffin_NecromancerFollowUp", _Player)
AND
DB_Players(_Player)
AND
QRY_StartDialog(LOW_KurwinCoffin_KidNecromancer_ec5d912b-b3cd-0476-50b3-52598ac1b30d, S_LOW_KurwinCoffin_KidNecromancer_2be44da8-cada-4e84-a788-fc9813fa651e, _Player)
THEN
SetFlag(LOW_KurwinCoffin_Event_NecromancerStopSpotting_aa8dbbc9-6b7e-4e6f-a58b-ca5ee73433fd, NULL_00000000-0000-0000-0000-000000000000, 1); 


//Peaceful Resolution

IF
DB_GlobalFlag(_Flag)
AND
DB_LOW_KurwinCoffin_PeacefulNecromancyFlags(_Flag)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_NecromancerNotSummoning")
THEN
PROC_LOW_KurwinCoffin_PeacefulNecromancyEXP();

PROC
PROC_LOW_KurwinCoffin_PeacefulNecromancyEXP()
AND
DB_LOW_KurwinCoffin_RisenUndead_Waves(_Wave, _Enemy)
AND
NOT DB_PermaDefeated(_Enemy)
THEN
PROC_PeacefulResolve(_Enemy);
NOT DB_LOW_KurwinCoffin_RisenUndead_Waves(_Wave, _Enemy);

//END_REGION

//REGION - Booster: Exploding Body

//A variety of things that should set it off, all ending in an explosion

PROC
PROC_BlockLootCorpse(_Player, S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103)
AND
DB_Players(_Player)
AND
NOT GetDeathType(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, "Explode")
THEN
DB_CustomLootCorpseResponse(_Player, S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, 0);
PROC_LOW_KurwinCoffin_ExplodeBody();

IF
AttackedBy(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, _, _, _, _, _, _)
AND
NOT GetDeathType(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, "Explode")
THEN
PROC_LOW_KurwinCoffin_ExplodeBody();

IF
OnThrown(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, _, _, _, _, _, _)
AND
NOT GetDeathType(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, "Explode")
THEN
PROC_LOW_KurwinCoffin_ExplodeBody();

PROC
PROC_LOW_KurwinCoffin_ExplodeBody()
THEN
CreateExplosion(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, "Projectile_LOW_KurwinCoffin_ExplodingBody", 6);
PROC_Poof(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103);

//END_REGION

//REGION - Booster: Undercity Ruins Teleporter
//END_REGION

//REGION - Booster: Buried Man
IF
WentOnStage(S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107, 1)
THEN
PROC_SetOnStage(S_LOW_KurwinCoffin_BuriedManTube_Useless_ad6b2bab-b0c3-4223-8e74-4cabfa561336, 1);
PROC_SetOnStage(S_LOW_KurwinCoffin_BuriedManTube_08ac4f07-1d09-46f5-9da7-af2ad8c282b2, 0);
PROC_LOW_KurwinCoffin_BuriedManAppears();

PROC
PROC_LOW_KurwinCoffin_BuriedManAppears()
THEN
SetOnStage(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, 1);
SetVisible(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, 0);
TeleportTo(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, S_LOW_KurwinCoffin_BuriedManSpawnPoint_fc62d2f9-a3c4-4351-8efd-68d5861cf6eb, "LOW_KurwinCoffin_BuriedManOnstage", 0, 0, 0, 1, 1);
ApplyStatus(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "UNCONSCIOUS", -1.0);
RealtimeObjectTimerLaunch(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "LOW_KurwinCoffin_BuriedManBecomingUnconscious", 270);
Open(S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107);

IF
ObjectTimerFinished(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "LOW_KurwinCoffin_BuriedManBecomingUnconscious")
AND
GetPosition(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, _X, _Y, _Z)
THEN
RemoveStatus(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "UNCONSCIOUS");
SetVisible(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, 1);
PlayEffectAtPosition((EFFECTRESOURCE)VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416,_X,_Y,_Z);
RealtimeObjectTimerLaunch(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c,"LOW_KurwinCoffin_BuriedManStands", 2600);


IF
ObjectTimerFinished(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c,"LOW_KurwinCoffin_BuriedManStands")
THEN
DB_SpotPlayers(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "LOW_KurwinCoffin_BuriedManLookingForRescuer", LOW_KurwinCoffin_Event_BuriedManStartSpotting_8de18997-a9ae-4154-adb7-a3a3165edba6, LOW_KurwinCoffin_Event_BuriedManStopSpotting_f9ea0d50-3d92-4ab5-a7dd-6c2fd74bd039);


PROC
PROC_SpotPlayers_Spotted(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "LOW_KurwinCoffin_BuriedManLookingForRescuer", _Player)
THEN
SetFlag(LOW_KurwinCoffin_Event_BuriedManStopSpotting_f9ea0d50-3d92-4ab5-a7dd-6c2fd74bd039, NULL_00000000-0000-0000-0000-000000000000, 1); 
ObjectTimerLaunch(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "LOW_KurwinCoffin_BuriedManSpotCheck", 3000, 1);

//If he spotted them try to talk. But run away if it fails

PROC
PROC_SpotPlayers_Spotted(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "LOW_KurwinCoffin_BuriedManLookingForRescuer", _Player)
AND
DB_Players(_Player)
AND
QRY_StartDialog(LOW_KurwinCoffin_BuriedMan_509c0640-b99c-bc07-7c19-56080a24458b, S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, _Player)
THEN
ObjectTimerCancel(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "LOW_KurwinCoffin_BuriedManSpotCheck");

IF
DialogEnded(LOW_KurwinCoffin_BuriedMan_509c0640-b99c-bc07-7c19-56080a24458b, _ID)
AND
CanMove(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, 1)
THEN
PROC_LOW_KurwinCoffin_RetreatEast(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c);

IF
UseStarted(_Player, S_LOW_KurwinCoffin_BuriedManTube_08ac4f07-1d09-46f5-9da7-af2ad8c282b2)
THEN
ClearOwnership(S_LOW_KurwinCoffin_GraveMound7_a2d00bd0-b859-4a70-a261-bebba8af3e11);

//If time runs out and hasn't seen anyone, run away
IF
ObjectTimerFinished(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, "LOW_KurwinCoffin_BuriedManSpotCheck")
AND
CanMove(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c, 1)
THEN
PROC_LOW_KurwinCoffin_RetreatEast(S_LOW_KurwinCoffin_BuriedMan_4cb2ab0d-35f5-4168-a5dc-292bbcac597c);

IF
UseStarted(_Player, S_LOW_KurwinCoffin_BuriedManTube_08ac4f07-1d09-46f5-9da7-af2ad8c282b2)
THEN
PROC_TryStartAD(LOW_KurwinCoffin_AD_BuriedManBell_f78fb8ef-51e2-6275-c828-2790e69ab966, S_LOW_KurwinCoffin_BuriedManTube_08ac4f07-1d09-46f5-9da7-af2ad8c282b2);

//END_REGION

//REGION - Booster: Ghost Dogs

//Prepping for any type of interactivity so we can just throw on a tag to anything that should be protected

IF
Opened(_ForbiddenItem)
AND
IsTagged(_ForbiddenItem, (TAG)ACT3_LOW_KURWINCOFFIN_FORBIDDENBYGHOSTS_5494ba04-c134-472a-b072-2b167ed74253, 1)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_GhostDogsAppear")
THEN
PROC_LOW_KurwinCoffin_SetupGhosts((ITEM)_ForbiddenItem);

IF
MovedBy(_ForbiddenItem, _Player)
AND
IsTagged(_ForbiddenItem, (TAG)ACT3_LOW_KURWINCOFFIN_FORBIDDENBYGHOSTS_5494ba04-c134-472a-b072-2b167ed74253, 1)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_GhostDogsAppear")
AND
DB_Players(_Player)
THEN
PROC_LOW_KurwinCoffin_SetupGhosts((ITEM)_ForbiddenItem);

IF
AttackedBy(_ForbiddenItem, _Player, _, _, _, _, _)
AND
IsTagged(_ForbiddenItem, (TAG)ACT3_LOW_KURWINCOFFIN_FORBIDDENBYGHOSTS_5494ba04-c134-472a-b072-2b167ed74253, 1)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_GhostDogsAppear")
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_LOW_KurwinCoffin_SetupGhosts((ITEM)_ForbiddenItem);

PROC
PROC_ItemThrownByPlayer(_Player, _ForbiddenItem)
AND
IsTagged(_ForbiddenItem, (TAG)ACT3_LOW_KURWINCOFFIN_FORBIDDENBYGHOSTS_5494ba04-c134-472a-b072-2b167ed74253, 1)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_GhostDogsAppear")
AND
DB_Players(_Player)
THEN
PROC_LOW_KurwinCoffin_SetupGhosts((ITEM)_ForbiddenItem);


PROC
PROC_BlockPickupOfItem(_Player, _ForbiddenItem)
AND
IsTagged(_ForbiddenItem, (TAG)ACT3_LOW_KURWINCOFFIN_FORBIDDENBYGHOSTS_5494ba04-c134-472a-b072-2b167ed74253, 1)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_GhostDogsAppear")
AND
DB_Players(_Player)
THEN
PROC_LOW_KurwinCoffin_SetupGhosts((ITEM)_ForbiddenItem);

PROC
PROC_LOW_KurwinCoffin_SetupGhosts((ITEM)_ForbiddenItem)
AND
DB_LOW_KurwinCoffin_GhostEncounter(_Ghost)
THEN
PROC_SetOnStage(_Ghost, 1);

IF
WentOnStage(_Ghost, 1)
AND
DB_LOW_KurwinCoffin_GhostEncounter(_Ghost)
AND
DB_Players(_Player)
THEN
PROC_SetHostileToIndivPlayerFaction(Act3_LOW_DogGhosts_95521445-f058-462e-9144-72e2f1737faf, _Player);
NOT DB_LOW_KurwinCoffin_GhostEncounter(_Ghost);

//END_REGION

//REGION - Booster: Catacombs

IF
UseFinished(_Player, _Stairs, 1)
AND
DB_LOW_KurwinCoffin_CatacombUnlocker(_Stairs, _Door)
AND
IsLocked((ITEM)_Door, 1)
THEN
Unlock(_Door, _Player);

//END_REGION

//Main Booster: Kurwin Coffin

//REGION Set up - Kobold gang and Empty Caskets go offstage
QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)_Kobold)
AND
DB_LOW_KurwinCoffin_KoboldGang_Kobolds(_Kobold)
THEN
DB_NOOP(1);

//Old pre-patch - removed now.
IF
DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)_Character, _Trigger)
THEN
PROC_SetOnStage(_Character, 0);
NOT DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)_Character, _Trigger);

IF
DB_LOW_KurwinCoffin_KoboldGang_Hole(_KoboldHole, _)
THEN
PROC_SetOnStage(_KoboldHole, 0);

IF
DB_LOW_KurwinCoffin_KoboldGang_Kobolds(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15)
THEN
PROC_SetOnStage(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, 0);

IF
DB_LOW_KurwinCoffin_EmptyCoffins(_EmptyCoffin, _)
THEN
PROC_SetOnStage(_EmptyCoffin, 0);

IF
UseStarted(_Character, S_LOW_KurwinCoffin_KurwinGravestone_2dfe90f5-cea1-4a21-9e9d-bf131fc35a7e)
THEN
PROC_TryStartAD(LOW_KurwinCoffin_AD_GraveKurwin_ccee4369-4234-f655-5a5c-16d2ab03bbc1, _Character);

//END_REGION

//REGION Looter initial setup - After coffin is dug up, handle opening/bashing the casket and Looter's initial appearing/dialogue

//If you use the coffin and Looter isn't around
IF
WentOnStage(S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55, 1)
AND
NOT DB_GlobalFlag(LOW_KurwinCoffin_Quest_OpenedKurwinCoffin_7a80f5e8-8e6c-4127-b12a-8288bae00660)
AND
IsOnStage(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, 0)
THEN
PROC_LOW_KurwinCoffin_KoboldLooterSpawns();

//Block crime registering on the casket for Bugthimble - She has her own logic
PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_ID, _Player, "UseForbiddenItem", _, (CHARACTER)S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15)
THEN
CrimeIgnoreCrime(_ID, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);

//If you break the coffin and Looter isn't around
IF
AttackedBy(S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55, _, (CHARACTER)_Player, _, _, _, _)
AND
DB_Players(_Player)
AND
IsOnStage(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, 0)
THEN
PROC_LOW_KurwinCoffin_KoboldLooterSpawns();

//Make Bugthimble appear and give her the Kurwin's Cauteriser
PROC
PROC_LOW_KurwinCoffin_KoboldLooterSpawns()
THEN
PROC_GlobalSetFlagAndCache(LOW_KurwinCoffin_Quest_OpenedKurwinCoffin_7a80f5e8-8e6c-4127-b12a-8288bae00660);
PROC_SetOnStage(WPN_LOW_KurwinCoffin_KurwinsCauteriserMace_000_c8d32907-5cee-45d2-8892-b724b3fd9741, 1);
Equip((CHARACTER)S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15,(ITEM)WPN_LOW_KurwinCoffin_KurwinsCauteriserMace_000_c8d32907-5cee-45d2-8892-b724b3fd9741);
AppearAt(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, S_LOW_BugthimbleAppears_b532b11b-1130-4ff0-87eb-109630768f43, 1, NULL_00000000-0000-0000-0000-000000000000, "LOW_KurwinCoffin_KoboldLooterAppears");

//When Looter appears, it starts looking for a player - unless the player is inconspicuous, in which case it just decides to attack.

IF
EntityEvent(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, "LOW_KurwinCoffin_KoboldLooterAppears")
THEN
DB_SpotPlayers(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, "LOW_KurwinCoffin_LooterLookingForOpener", LOW_KurwinCoffin_Event_KoboldStartSpotting_c30e39f9-bdc4-4e7b-8c68-3e778e8c123a, LOW_KurwinCoffin_Event_KoboldStopSpotting_135fab2d-d344-48cb-b543-ccd9637f125c);
DB_SpotPlayers_IncludeWildshapedPlayers(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, "LOW_KurwinCoffin_LooterLookingForOpener");

IF
EntityEvent(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, "LOW_KurwinCoffin_KoboldLooterAppears")
AND
DB_Is_InconspicuousPartyMember(_Player)
THEN
PROC_TryStartAD(LOW_KurwinCoffin_AD_KoboldLooterInconspicuousWildshapeReact_ed23b2a1-7bb5-63f7-17bd-57859a1a9909, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);


//Regardless of what happens when spotted, the Kobold stops looking
PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, "LOW_KurwinCoffin_LooterLookingForOpener", _Player)
THEN
SetFlag(LOW_KurwinCoffin_Event_KoboldStopSpotting_135fab2d-d344-48cb-b543-ccd9637f125c, NULL_00000000-0000-0000-0000-000000000000, 1); 

//Attack an aggressive wildshape
PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, "LOW_KurwinCoffin_LooterLookingForOpener", _Player)
AND
DB_Players(_Player)
AND
DB_Is_WildShaped(_Player)
AND
NOT DB_Is_InconspicuousPartyMember(_Player)
THEN
PROC_TryStartAD(LOW_KurwinCoffin_AD_KoboldLooterAngryWithPlayerLooting_051f6a2a-f1da-540f-1224-94265eac063d, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);
PROC_SetHostileToIndivPlayerFaction((FACTION)Act3_LOW_KoboldGang_aef430b4-fa86-4867-83e5-69887f32a174,_Player);



//Players are spotted, they get to talk to the Kobold
PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, "LOW_KurwinCoffin_LooterLookingForOpener", _Player)
AND
QRY_StartDialog(LOW_KurwinCoffin_KoboldLooter_5551974f-68cb-76de-8ef9-66094b2bd7de, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, _Player)
THEN
DB_KurwinCoffin_DialogTarget(_Player);

//If it fails then the kobold just gets mad and attacks

QRY
QRY_StartDialogFailed(LOW_KurwinCoffin_KoboldLooter_5551974f-68cb-76de-8ef9-66094b2bd7de, _, _Player, _, _, _, _)
THEN
PROC_TryStartAD(LOW_KurwinCoffin_AD_KoboldLooterAngryWithPlayerLooting_051f6a2a-f1da-540f-1224-94265eac063d, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);
PROC_SetHostileToIndivPlayerFaction((FACTION)Act3_LOW_KoboldGang_aef430b4-fa86-4867-83e5-69887f32a174, (CHARACTER)_Player);



//END_REGION 



//REGION If you intimidate the looter mid dialogue, she flees. If you intimidated her -twice- then she throws the mace at your and flees.

IF
DialogEnded(LOW_KurwinCoffin_KoboldLooter_5551974f-68cb-76de-8ef9-66094b2bd7de, _)
AND
GetFlag(LOW_KurwinCoffin_State_ScaredKoboldTwice_6eea2910-4046-46d1-b78a-0728e908eff5, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, 1)
AND
DB_KurwinCoffin_DialogTarget(_Player)
THEN
UseSpell(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, "Throw_Throw", _Player, WPN_LOW_KurwinCoffin_KurwinsCauteriserMace_000_c8d32907-5cee-45d2-8892-b724b3fd9741);


IF
CastedSpell(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, "Throw_Throw", _, _, _)
AND
DB_KurwinCoffin_DialogTarget(_Player)
THEN
PROC_Poof (S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);
PROC_TryStartAD(LOW_KurwinCoffin_AD_KoboldThrowsWeaponAtPlayer_6b3ec595-a8f3-77c4-5d44-edfee156ae43, _Player);
NOT DB_KurwinCoffin_DialogTarget(_Player);

IF
DialogEnded(LOW_KurwinCoffin_KoboldLooter_5551974f-68cb-76de-8ef9-66094b2bd7de, _)
AND
GetFlag(LOW_KurwinCoffin_State_ScaredKoboldLeader_e9c5bff9-ebf7-2212-e632-ee24b6c7c1d1, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, 1)
AND
GetFlag(LOW_KurwinCoffin_State_ScaredKoboldTwice_6eea2910-4046-46d1-b78a-0728e908eff5, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, 0)
AND
DB_KurwinCoffin_DialogTarget(_Player)
THEN
PROC_Poof (S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);
PROC_TryStartAD(LOW_KurwinCoffin_AD_KoboldLeavesWithoutExtraPayment_17ebce0d-61e5-809e-fd29-9604e0f417c2, _Player);
NOT DB_KurwinCoffin_DialogTarget(_Player);

//Peaceful Resolution

PROC
PROC_FlagReactionAfterDialog(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, LOW_KurwinCoffin_State_ScaredKoboldLeader_e9c5bff9-ebf7-2212-e632-ee24b6c7c1d1, LOW_KurwinCoffin_KoboldLooter_5551974f-68cb-76de-8ef9-66094b2bd7de)
AND
QRY_OnlyOnce("LOW_KurwinCoffin_BugthimbleLeft")
THEN
PROC_LOW_KurwinCoffin_PeacefulKoboldEXP();

PROC
PROC_LOW_KurwinCoffin_PeacefulKoboldEXP()
AND
DB_LOW_KurwinCoffin_KoboldGang_Kobold(_Enemy)
THEN
PROC_PeacefulResolve(_Enemy);
NOT DB_LOW_KurwinCoffin_KoboldGang_Kobold(_Enemy);

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_KurwinCoffin_State_DUBuriedLooter_033f9204-b879-4397-b9c5-877251bf2e77)
AND
DB_Players(_Player)
AND
IsTagged(_Player, (TAG)REALLY_DARK_URGE_cd611d7d-b67d-42b4-a75c-a0c6091ef8a2, 1)
THEN
PROC_SetOnStage(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, 0);
DB_ShovelArea((ITEM)S_LOW_KurwinMound_e804773e-78fb-49bc-ab34-14c2fd976986,(ITEM)S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55);

//END_REGION 

//REGION If you try to do anything with the Kurwin Casket with Bugthimble resolved peacefully.

//If you try to open the casket

IF
UseStarted((CHARACTER)_Player, (ITEM)S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55)
AND
IsOnStage(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, 1)
AND
NOT DB_Is_InCombat(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, _)
AND
CanSee((CHARACTER)S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, _Player, 1)
AND
DB_Players(_Player)
THEN
PROC_TryStartAD(LOW_KurwinCoffin_AD_KoboldLooterAngryWithPlayerLooting_051f6a2a-f1da-540f-1224-94265eac063d, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);
ObjectTimerLaunch(_Player, "LOW_KurwinCoffin_LooterYellDelay", 2500, 1);

IF
ObjectTimerFinished(_Player, "LOW_KurwinCoffin_LooterYellDelay")
THEN
PROC_SetHostileToIndivPlayerFaction((FACTION)Act3_LOW_KoboldGang_aef430b4-fa86-4867-83e5-69887f32a174, (CHARACTER)_Player);


//If you attack the casket
IF
AttackedBy(S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55, _, (CHARACTER)_Player, _, _, _, _)
AND
DB_Players(_Player)
AND
IsOnStage(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, 1)
AND
NOT DB_Is_InCombat(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, _)
THEN
PROC_TryStartAD(LOW_KurwinCoffin_AD_KoboldLooterAngryWithPlayerLooting_051f6a2a-f1da-540f-1224-94265eac063d, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);
PROC_SetHostileToIndivPlayerFaction((FACTION)Act3_LOW_KoboldGang_aef430b4-fa86-4867-83e5-69887f32a174, (CHARACTER)_Player);

//END_REGION 

//REGION Kobold Looter has loot stolen under her nose
IF
UseFinished(_Player, S_LOW_KurwinCasket_a78b1000-38bf-49a9-9597-3311709deb55, 1)
AND
CanSee((CHARACTER)S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, _Player, 0)
THEN
PROC_TryStartAD(LOW_KurwinCoffin_AD_KoboldLooterAngryWithPlayerLooting_051f6a2a-f1da-540f-1224-94265eac063d, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);
PROC_Poof (S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);

//END_REGION

//REGION When Bugthimble uses her Spell to summon other Kobolds

//Spawn the Kobold Holes when combat starts against the gang leader
IF 
EnteredCombat(S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15, _)
AND
DB_LOW_KurwinCoffin_KoboldGang_Hole(_KoboldHole, _)
AND
IsOnStage (_KoboldHole, 0)
THEN
PROC_Foop(_KoboldHole);
ApplyStatus(_KoboldHole, "LOW_KOBOLDHOLE_SPAWNKOBOLD", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_KurwinCoffin_KoboldYell();
//AppearAt(_Kobold, _Location, 1, NULL_00000000-0000-0000-0000-000000000000, "LOW_KurwinCoffin_KoboldGangAppear");
//(Using Foop just for clarity in where they appear)

IF
StatusApplied(_KoboldHole, "LOW_KOBOLDHOLE_SPAWNKOBOLD_TECHNICAL", _, _)
AND
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)_KoboldHole, _)
THEN
RemoveStatus(_KoboldHole, "LOW_KOBOLDHOLE_SPAWNKOBOLD", NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved(_KoboldHole, "LOW_KOBOLDHOLE_SPAWNKOBOLD_TECHNICAL", _, _)
AND
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)_KoboldHole, _)
THEN
ApplyStatus(_KoboldHole, "LOW_KOBOLDHOLE_SPAWNKOBOLD",-1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

// Poof the Kobold Hole when killed or when out of kobolds to spawn
IF
StatusRemoved((ITEM)_KoboldHole,"LOW_KOBOLDHOLE_SPAWNKOBOLD_AURA_SOURCE",_,0)
AND
DB_LOW_KurwinCoffin_KoboldGang_Hole(_KoboldHole, _)
THEN
PROC_Poof(_KoboldHole);

//Sent from constellation
IF
EntityEvent((ITEM)_KoboldHole,"PUZ_LOW_KoboldHole_Poof")
AND
DB_LOW_KurwinCoffin_KoboldGang_Hole(_KoboldHole, _)
THEN
PROC_Poof(_KoboldHole);

//If any Kobolds come into the battle, make sure they go in the DB
IF
EnteredLevel(_Kobold, _KoboldType, "CTY_Main_A")
AND
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)_KoboldType)
THEN
DB_LOW_KurwinCoffin_KoboldGang_Kobolds((CHARACTER)_Kobold);

PROC
PROC_KurwinCoffin_KoboldYell()
AND
QRY_OnlyOnce("KoboldYell")
THEN
PROC_SetRelationMutual((FACTION)Act3_LOW_KoboldGang_aef430b4-fa86-4867-83e5-69887f32a174, (FACTION)Act3_LOW_KelemvorPriestess_9b62c325-6404-46d0-8f16-02b9b8aef3cd, 0);
PROC_TryStartAD(LOW_KurwinCoffin_AD_KoboldLooterSummonsGang_354894f6-00fa-df61-cd18-a77d6992ce4f, S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);

//END_REGION

//REGION Kobold spawning from the Kobold Holes

// Stop the camera a second at the start of the kobold hole turn to not confuse the player
IF
TurnStarted((ITEM)_KoboldHole)
AND
DB_LOW_KurwinCoffin_KoboldGang_Hole(_KoboldHole,_)
THEN
SetEntityEventReal((ITEM)_KoboldHole, "GLO_CombatWait", 1.0);

//END_REGION

//REGION Handle checks - If the party has all left the area with the Kobolds outside of combat and not all dead, they burrow away and take the loot.
IF
DB_LOW_KurwinCoffin_KoboldGang_Kobolds(_Kobold)
AND
NOT DB_PermaDefeated(_Kobold)
AND
NOT DB_InRegion(_, S_LOW_KoboldLeaveTrigger_58c117c7-889d-415b-b069-77851a544fbe)
AND
DB_GlobalFlag(LOW_KurwinCoffin_Quest_OpenedKurwinCoffin_7a80f5e8-8e6c-4127-b12a-8288bae00660)
AND
NOT QRY_LOW_KurwinCoffin_AnyKoboldInCombat()
AND
QRY_OnlyOnce("LOW_KurwinCoffin_KoboldsLeavingWithLoot")
THEN
PROC_LOW_KurwinCoffin_KoboldsLeave();
PROC_ChangeCasketsOver();
PROC_TriggerUnregisterForParty(S_LOW_KoboldLeaveTrigger_58c117c7-889d-415b-b069-77851a544fbe);

IF
DB_LOW_KurwinCoffin_KoboldGang_Hole(_KoboldHole, _)
AND
NOT DB_PermaDefeated(_KoboldHole)
AND
NOT DB_InRegion(_, S_LOW_KoboldLeaveTrigger_58c117c7-889d-415b-b069-77851a544fbe)
AND
DB_GlobalFlag(LOW_KurwinCoffin_Quest_OpenedKurwinCoffin_7a80f5e8-8e6c-4127-b12a-8288bae00660)
AND
NOT QRY_LOW_KurwinCoffin_AnyKoboldInCombat()
AND
QRY_OnlyOnce("LOW_KurwinCoffin_KoboldsLeavingWithLoot")
THEN
PROC_LOW_KurwinCoffin_KoboldsLeave();
PROC_ChangeCasketsOver();
PROC_TriggerUnregisterForParty(S_LOW_KoboldLeaveTrigger_58c117c7-889d-415b-b069-77851a544fbe);

//In theory this should mean that this single PROC restarts the check, and tidies away any Kobolds that are part of the gang and not dead, by throwing them off stage.

QRY
QRY_LOW_KurwinCoffin_AnyKoboldInCombat()
AND
DB_LOW_KurwinCoffin_KoboldGang_Kobolds(_Kobold)
AND
DB_Is_InCombat(_Kobold, _)
THEN
DB_NOOP(1);

QRY
QRY_LOW_KurwinCoffin_AnyKoboldInCombat()
AND
DB_LOW_KurwinCoffin_KoboldGang_Hole(_KoboldHole, _)
AND
DB_Is_InCombat(_KoboldHole, _)
THEN
DB_NOOP(1);

PROC
PROC_LOW_KurwinCoffin_KoboldsLeave()
AND
DB_LOW_KurwinCoffin_KoboldGang_Hole(_KoboldHole, _)
AND
NOT DB_PermaDefeated(_KoboldHole)
THEN
PROC_Poof(_KoboldHole);

PROC
PROC_LOW_KurwinCoffin_KoboldsLeave()
AND
DB_LOW_KurwinCoffin_KoboldGang_Kobolds(_Kobold)
AND
NOT DB_PermaDefeated(_Kobold)
THEN
PROC_Poof(_Kobold);

//If all the Kobolds are dead, set Kobolds are dead flag 
//NOTE: Might need some advice on this one, I can't think of a good initiator for the IF, so for now I have it happen when the dialog with the Gravekeeper starts since she's the only one that needs this flag at present
IF
DialogStarted(LOW_KurwinCoffin_Gravekeeper_117abe07-0931-0971-10a0-ddb22e982319, _)
AND
DB_Players(_Player)
AND
NOT DB_LOW_KurwinCoffin_KoboldGang_Hole(_,_)
AND
NOT DB_LOW_KurwinCoffin_KoboldGang_Kobolds(_)
AND
GetFlag(LOW_KurwinCoffin_State_KilledAllKobolds_0e24e6b4-f1e7-4ae2-b2da-980634a41fba, _Player, 0)
THEN
SetFlag(LOW_KurwinCoffin_State_KilledAllKobolds_0e24e6b4-f1e7-4ae2-b2da-980634a41fba, _Player);

//END_REGION


//REGION Casket Management

//Remove Caskets from the DB if they are dug up
IF
UseStarted(_Player,_DirtMound)
AND
DB_LOW_KurwinCoffin_FilledCoffins(_FullCoffin,_DirtMound)
AND
DB_LOW_KurwinCoffin_EmptyCoffins(_EmptyCoffin,_FullCoffin)
THEN
NOT DB_LOW_KurwinCoffin_EmptyCoffins(_EmptyCoffin, _FullCoffin);


//If it's specifically the mourning kid's casket, we want him to run away - Might replace with a unique crime reaction at a later stage, when I revisit the state of the graveyard digging

IF
UseStarted(_Player, S_LOW_GraveMound2_d210cbd2-b90c-4e20-986d-152bdfed7a38)
THEN
PROC_TryStartAD(LOW_KurwinCoffin_AD_MourningChild_c9d08f05-0c1c-d388-feb6-6095a08a9c9f, S_LOW_KurwinCoffin_MourningChild_025399eb-b420-47b7-a00f-34dde4fb8499);
PROC_LOW_KurwinCoffin_RetreatEast(S_LOW_KurwinCoffin_MourningChild_025399eb-b420-47b7-a00f-34dde4fb8499);

//Find and replace underground Caskets and replace them with empty versions. Also makes sure Kurwin's coffin is empty.
//NOTE: This should be ok, but worth rethinking about - Currently the Kurwin Casket can be dug up, but not emptied (Looter attacks you if you move/break/open it) and the rest can be dug up and emptied, so the current solve is
//														to change those still underground, but not change those above ground (even if they haven't moved), aside from Kurwin's which will either be looted mid combat or not at all
//														IN THEORY this should never be in a state where players can have got the above ground Kurwin coffin into a state where it couldn't theoretically still have loot in.
//

PROC
PROC_ChangeCasketsOver()
AND
DB_LOW_KurwinCoffin_EmptyCoffins(_EmptyCoffin, _FullCoffin)
AND
DB_ShovelArea(_DirtMound,_FullCoffin)
THEN
PROC_LOW_KurwinCoffin_MoveBodiesAndBooks();
NOT DB_ShovelArea(_DirtMound,_FullCoffin);
DB_ShovelArea(_DirtMound,_EmptyCoffin);

PROC
PROC_LOW_KurwinCoffin_MoveBodiesAndBooks()
AND
DB_LOW_KurwinCoffin_CoffinFillers(_Thing, _EmptyCasket, _FullCasket)
AND
IsInInventoryOf((GUIDSTRING)_Thing, _FullCasket, 1)
THEN
ToInventory(_Thing, _EmptyCasket, 1, 0, 1);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
