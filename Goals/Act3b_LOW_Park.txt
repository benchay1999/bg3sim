Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, LOW_ParkCultistAmbush_001_258e1ff8-f890-3347-01cd-e3c4fd55dff7);
DB_Dialogs(S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952, LOW_Park_BhaalAssassin03_74b55991-2e1b-4b84-ffe8-d0d6152681e8);
Db_Dialogs(S_LOW_Park_BhaalAssassin01_500d7c8c-60a6-40c6-86b0-82db100b530e, LOW_ParkCultistAmbush_001_258e1ff8-f890-3347-01cd-e3c4fd55dff7);
DB_Dialogs(S_LOW_Park_BhaalAssassin02_8bfe6f21-58ed-4963-8f05-10991075e144, LOW_ParkCultistAmbush_001_258e1ff8-f890-3347-01cd-e3c4fd55dff7);
DB_Dialogs(S_LOW_Park_BhaalAssassin05_3eef8b7b-f06e-4afb-b4c7-c21bb6dd0268, LOW_ParkCultistAmbush_001_258e1ff8-f890-3347-01cd-e3c4fd55dff7);

DB_Dialogs(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, LOW_Park_GuardPreCombat_57fada27-ac39-599d-c9b9-d35f2ad67762);
DB_Dialogs(S_LOW_Park_FlamingFist1_bbd05a60-77c7-48fe-9273-a9e5303c7c24, LOW_Park_FlamingFist1_9dc0111a-cd40-aef6-67b9-079cdb5020a5);
DB_Dialogs(S_LOW_Park_FlamingFist2_be3b99d0-b8ed-4d39-92e1-848f09e022c3, LOW_Park_FlamingFist2_91490621-1d4a-b836-38cc-4d69da6311fe);
DB_Dialogs(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00 , LOW_ParkCultistAmbush_BackUpDialog_4533193d-1912-b7db-e136-ae5458010afe);

DB_Dialogs(S_LOW_Park_ChildLostBallScene01_8140a70d-bf67-4a93-ab63-ff3a441f9b2f, LOW_Park_ChildLostBall01_49c02bc5-160a-c108-ebc9-24a34635b19b);
DB_Dialogs(S_LOW_Park_ChildLostBallScene02_0c6d7c78-bb49-45d6-ada9-4a46783396fb, LOW_Park_ChildLostBall02_c596e3c7-fa06-4016-db70-ed08ccf340b2);

DB_Dialogs(S_LOW_Park_RetiredFist_Dwarf01_a94d18f7-23ec-4f4b-868a-d6feaf9beaae, LOW_Park_RetiredFists_Dwarf01_caf0c3aa-ee3b-dee9-f818-ad389d699383);
DB_Dialogs(S_LOW_Park_RetiredFist_Dwarf02_669e3ab9-acc1-4fe2-814a-4d21e901cf86, LOW_Park_RetiredFists_Dwarf02_0d838a29-8a9d-2ef0-9f93-90e2af1fd7f7);
DB_Dialogs(S_LOW_Park_RetiredFist_Elf01_08d2d3a7-6d87-40e7-8649-750e9857dd3c, LOW_Park_RetiredFists_Elf01_ab3a303e-88dc-b891-43a8-ad081ecaf8a8);
DB_Dialogs(S_LOW_Park_RetiredFist_Elf02_d7cd0aa5-7303-45c7-a9e2-fac6a458f63e, LOW_Park_RetiredFists_Elf02_7f338a22-ae09-40c8-58f1-d467f545e76c);

DB_Dialogs(S_LOW_Park_LoversMale_cc2aca46-3a9a-4637-98a4-dc812b71ff6d, LOW_Park_LoversMale_4cc570a7-188f-faf6-298a-da5a984592b6);
DB_Dialogs(S_LOW_Park_LoversFemale_bf8d1fd2-53ea-4df4-9924-5136a4345ef3, LOW_Park_LoversFemale_a10b6bb5-7a93-04d9-99a4-a3b5c95b2677);

DB_Dialogs(S_LOW_Park_FanclubMember01_32c18a38-6f75-4e72-8072-409dae627929, LOW_Park_VampireBookClub01_4518622c-696e-659e-872f-d572a769dc94);
DB_Dialogs(S_LOW_Park_FanclubMember02_c11362d2-c6dd-48e7-87a1-775562ede7f1, LOW_Park_VampireBookClub02_3be552bd-d77a-ce72-ec17-141ddc399f22);
DB_Dialogs(S_LOW_Park_FanclubMember03_b91ad1bf-f323-4378-bc47-3492efbd10ae, LOW_Park_VampireBookClub03_f1e72a9e-cc78-3fd9-5ff9-eb2e0b11edef);

DB_Dialogs(S_LOW_Park_BoyWithDog_ab5e67c3-f0f4-4234-b36d-0bfad1592d09, LOW_Park_BoyWithDog_fe39a141-6c1c-05ab-b3e1-7242d2c73d41);
DB_Dialogs(S_LOW_Park_DogWithBoy_549bb04f-8243-4366-ae75-fcbb98d5ef9d, LOW_Park_SWA_Rufie_59d98bd8-7d78-0174-8a04-ef2ccd80dfa0);

DB_Dialogs(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd, LOW_Park_ElderlyCouple01_ce0c93bc-292b-54d1-9a51-b3b578b43bb0);
DB_Dialogs(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, LOW_Park_ElderlyCouple02_7d73e132-d1a7-2f6a-4d60-aab5acaf7531);


DB_Dialogs(LOW_Park_ReplacementFlamingFist01_517753c7-15e4-4eb5-ba21-a0c13080a3b4, LOW_Park_ReplacementFlamingFist01_913b4182-e826-3e6a-57e0-f17eb0c23ec0);
DB_Dialogs(LOW_Park_ReplacementFlamingFist02_abb7f3be-9b67-4c61-8e19-5572f66648a0, LOW_Park_ReplacementFlamingFist02_e180391f-80f1-149d-5320-10d62b32f156);
DB_Dialogs(LOW_Park_ReplacementFlamingFist03_69a250da-cb91-450f-aa73-3c19dbd9ea61, LOW_Park_ReplacementFlamingFist03_865e5572-7950-c35a-df75-1d60f1743108);
DB_Dialogs(LOW_Park_ReplacementFlamingFist04_ea22f162-1ca7-4ece-9305-1d95f21689d1, LOW_Park_ReplacementFlamingFist04_5838afe4-75b7-c401-f392-bb9df5eb1ebb);



DB_AmbushTrigger((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1, (TRIGGER)S_LOW_Park_AmbushDetectTrigger_2e77c8e8-7b7f-4e79-b84d-27596bfe68e4,(DIFFICULTYCLASS)Act3_Easy_5028066b-6ea0-4a6a-9e3e-53bee62559a7 );
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1, (GUIDSTRING)S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1, (GUIDSTRING)S_LOW_Park_BhaalAssassin01_500d7c8c-60a6-40c6-86b0-82db100b530e, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1, (GUIDSTRING)S_LOW_Park_BhaalAssassin02_8bfe6f21-58ed-4963-8f05-10991075e144, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1, (GUIDSTRING)S_LOW_Park_BhaalAssassin05_3eef8b7b-f06e-4afb-b4c7-c21bb6dd0268, 1);


DB_AmbushTrigger_AmbushRevealAD((TRIGGER)S_LOW_Park_AmbushDetectTrigger_2e77c8e8-7b7f-4e79-b84d-27596bfe68e4, LOW_Park_PAD_SpottedAmbush_3420a741-d89b-e555-e962-45fa1be3a069);

DB_LOW_Park_MovePairs((CHARACTER)S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511,(CHARACTER)S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61);
DB_LOW_Park_MovePairs((CHARACTER)S_LOW_Park_FlamingFist1_bbd05a60-77c7-48fe-9273-a9e5303c7c24,(CHARACTER)S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952);
DB_LOW_Park_MovePairs((CHARACTER)S_LOW_Park_FlamingFist2_be3b99d0-b8ed-4d39-92e1-848f09e022c3,(CHARACTER)S_LOW_Park_BhaalAssassin02_8bfe6f21-58ed-4963-8f05-10991075e144);

DB_LOW_Park_Cultists(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61);
DB_LOW_Park_Cultists(S_LOW_Park_BhaalAssassin01_500d7c8c-60a6-40c6-86b0-82db100b530e);
DB_LOW_Park_Cultists(S_LOW_Park_BhaalAssassin02_8bfe6f21-58ed-4963-8f05-10991075e144);
DB_LOW_Park_Cultists(S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952);
DB_LOW_Park_Cultists(S_LOW_Park_BhaalAssassin04_a9bee6df-338e-4df2-a5b6-3a2f6fcebade);
DB_LOW_Park_Cultists(S_LOW_Park_BhaalAssassin05_3eef8b7b-f06e-4afb-b4c7-c21bb6dd0268);

DB_LOW_Park_FlamingFists(S_LOW_Park_FlamingFist1_bbd05a60-77c7-48fe-9273-a9e5303c7c24);
DB_LOW_Park_FlamingFists(S_LOW_Park_FlamingFist2_be3b99d0-b8ed-4d39-92e1-848f09e022c3);
DB_LOW_Park_FlamingFists(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511);

DB_IgnoreMutingStatussesDialog(LOW_ParkCultistAmbush_003_b3dbcd94-1a5d-4ed7-f7bf-747e17cf7bf3);
DB_IgnoreMutingStatussesDialog(LOW_Park_EdenosaAnnoyed_d3ef83dd-574f-117a-759b-1fdc10729123);

PROC_SetOnStage(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00, 0);
PROC_SetOnStage(S_LOW_Park_SymbolOfTheAbsolute_276b729f-b399-4132-8f1a-5166000df2f4, 0);

// Character DB and Trigger Set Up for the Park Scenes
DB_LOW_Park_Civilians(S_LOW_Park_ChildLostBallScene01_8140a70d-bf67-4a93-ab63-ff3a441f9b2f);
DB_LOW_Park_Civilians(S_LOW_Park_ChildLostBallScene02_0c6d7c78-bb49-45d6-ada9-4a46783396fb);
DB_LOW_Park_Civilians(S_LOW_Park_RetiredFist_Dwarf01_a94d18f7-23ec-4f4b-868a-d6feaf9beaae);
DB_LOW_Park_Civilians(S_LOW_Park_RetiredFist_Dwarf02_669e3ab9-acc1-4fe2-814a-4d21e901cf86);
DB_LOW_Park_Civilians(S_LOW_Park_LoversFemale_bf8d1fd2-53ea-4df4-9924-5136a4345ef3);
DB_LOW_Park_Civilians(S_LOW_Park_LoversMale_cc2aca46-3a9a-4637-98a4-dc812b71ff6d);
DB_LOW_Park_Civilians(S_LOW_Park_RetiredFist_Elf01_08d2d3a7-6d87-40e7-8649-750e9857dd3c);
DB_LOW_Park_Civilians(S_LOW_Park_RetiredFist_Elf02_d7cd0aa5-7303-45c7-a9e2-fac6a458f63e);
DB_LOW_Park_Civilians(S_LOW_Park_FanclubMember01_32c18a38-6f75-4e72-8072-409dae627929);
DB_LOW_Park_Civilians(S_LOW_Park_FanclubMember02_c11362d2-c6dd-48e7-87a1-775562ede7f1);
DB_LOW_Park_Civilians(S_LOW_Park_FanclubMember03_b91ad1bf-f323-4378-bc47-3492efbd10ae);
DB_LOW_Park_Civilians(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd);
DB_LOW_Park_Civilians(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82);
DB_LOW_Park_Civilians(S_LOW_Park_BoyWithDog_ab5e67c3-f0f4-4234-b36d-0bfad1592d09);
DB_LOW_Park_Civilians(S_LOW_Park_DogWithBoy_549bb04f-8243-4366-ae75-fcbb98d5ef9d);

DB_Children(S_LOW_Park_BoyWithDog_ab5e67c3-f0f4-4234-b36d-0bfad1592d09);
DB_Children(S_LOW_Park_ChildLostBallScene01_8140a70d-bf67-4a93-ab63-ff3a441f9b2f);
DB_Children(S_LOW_Park_ChildLostBallScene02_0c6d7c78-bb49-45d6-ada9-4a46783396fb);
DB_Children(LOW_Park_AfterCombatChild01_dda4e182-e43e-4643-853f-ae6b0d0c0388);
DB_Children(LOW_Park_AfterCombatChild02_af76d1de-e86d-49b5-9fd0-306f847b68e1);
DB_Children(LOW_Park_AfterCombatChild03_f793b719-0925-46ed-a6ad-b3e169d9572d);


//Escort Set Up for Bertram and Martina
EscortAddCharacter(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, "LOW_Park_ElderlyCouple");
EscortAddCharacter(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd, "LOW_Park_ElderlyCouple");
EscortSetLeader(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, "LOW_Park_ElderlyCouple");


PROC_TriggerRegisterForParty(S_LOW_Park_ArguingKidsADTrigger_c78822a8-4a71-48e9-ae81-24555933427e);
PROC_TriggerRegisterForParty(S_LOW_Park_VampireBookClubADTrigger_99fab05c-0fa4-47e8-a0e0-b58418cd7dcf);
PROC_TriggerRegisterForParty(S_LOW_Park_LoversADTrigger_c57ae459-abc3-44ef-8087-07dc7f0dd574);
PROC_TriggerRegisterForParty(S_LOW_Park_RetiredFistsADTrigger_0ed5b973-2519-4959-afe4-4045c3935a87);
PROC_TriggerRegisterForParty(S_LOW_Park_CultistsADTrigger_74e17672-a3d7-46a5-a4b6-e7f40282c9f5);

// Replacement Characters DB and Trigger Set Up for post-Ambush Park
DB_LOW_Park_Replacements(LOW_Park_SteelWatcher_81cd5d46-d845-4d8a-8bd4-63ad335dc896);
DB_LOW_Park_Replacements(LOW_Park_ReplacementFlamingFist03_69a250da-cb91-450f-aa73-3c19dbd9ea61);
DB_LOW_Park_Replacements(LOW_Park_ReplacementFlamingFist02_abb7f3be-9b67-4c61-8e19-5572f66648a0);
DB_LOW_Park_Replacements(LOW_Park_ReplacementFlamingFist04_ea22f162-1ca7-4ece-9305-1d95f21689d1);
DB_LOW_Park_Replacements(LOW_Park_ReplacementFlamingFist01_517753c7-15e4-4eb5-ba21-a0c13080a3b4);
DB_LOW_Park_Replacements(LOW_Park_AfterCombatChild01_dda4e182-e43e-4643-853f-ae6b0d0c0388);
DB_LOW_Park_Replacements(LOW_Park_AfterCombatChild02_af76d1de-e86d-49b5-9fd0-306f847b68e1);
DB_LOW_Park_Replacements(LOW_Park_AfterCombatChild03_f793b719-0925-46ed-a6ad-b3e169d9572d);


//DBs for Retired Flaming Fists
DB_LOW_Park_RetiredFists(S_LOW_Park_RetiredFist_Dwarf01_a94d18f7-23ec-4f4b-868a-d6feaf9beaae);
DB_LOW_Park_RetiredFists(S_LOW_Park_RetiredFist_Dwarf02_669e3ab9-acc1-4fe2-814a-4d21e901cf86);
DB_LOW_Park_RetiredFists(S_LOW_Park_RetiredFist_Elf01_08d2d3a7-6d87-40e7-8649-750e9857dd3c);
DB_LOW_Park_RetiredFists(S_LOW_Park_RetiredFist_Elf02_d7cd0aa5-7303-45c7-a9e2-fac6a458f63e);

//DBs for Groups
DB_LOW_Park_CivilianGroup(S_LOW_Park_FanclubMember01_32c18a38-6f75-4e72-8072-409dae627929, "Fanclub");
DB_LOW_Park_CivilianGroup(S_LOW_Park_FanclubMember02_c11362d2-c6dd-48e7-87a1-775562ede7f1, "Fanclub");
DB_LOW_Park_CivilianGroup(S_LOW_Park_FanclubMember03_b91ad1bf-f323-4378-bc47-3492efbd10ae, "Fanclub");
DB_LOW_Park_CivilianGroup(S_LOW_Park_RetiredFist_Dwarf01_a94d18f7-23ec-4f4b-868a-d6feaf9beaae, "Fists");
DB_LOW_Park_CivilianGroup(S_LOW_Park_RetiredFist_Dwarf02_669e3ab9-acc1-4fe2-814a-4d21e901cf86, "Fists");
DB_LOW_Park_CivilianGroup(S_LOW_Park_RetiredFist_Elf01_08d2d3a7-6d87-40e7-8649-750e9857dd3c, "Fists");
DB_LOW_Park_CivilianGroup(S_LOW_Park_RetiredFist_Elf02_d7cd0aa5-7303-45c7-a9e2-fac6a458f63e, "Fists");
DB_LOW_Park_CivilianGroup(S_LOW_Park_LoversFemale_bf8d1fd2-53ea-4df4-9924-5136a4345ef3, "Lovers");
DB_LOW_Park_CivilianGroup(S_LOW_Park_LoversMale_cc2aca46-3a9a-4637-98a4-dc812b71ff6d, "Lovers");
DB_LOW_Park_CivilianGroup(S_LOW_Park_LoversFemale_bf8d1fd2-53ea-4df4-9924-5136a4345ef3, "BoyAndDog");
DB_LOW_Park_CivilianGroup(S_LOW_Park_BoyWithDog_ab5e67c3-f0f4-4234-b36d-0bfad1592d09, "BoyAndDog");


//Item handler for the Kids scene
DB_HasItemEvent(S_LOW_Park_KidsToy_729e04f5-fef2-4d42-a27a-0d190fe76cb8, (FLAG)LOW_Park_State_HaveKidsToy_b1994427-dc53-470a-aaa2-f0311983d1a0);


DB_Children(S_LOW_Park_ChildLostBallScene01_8140a70d-bf67-4a93-ab63-ff3a441f9b2f);
DB_Children(S_LOW_Park_ChildLostBallScene02_0c6d7c78-bb49-45d6-ada9-4a46783396fb);
DB_Children(S_LOW_Park_BoyWithDog_ab5e67c3-f0f4-4234-b36d-0bfad1592d09);
DB_Children(LOW_Park_AfterCombatChild02_af76d1de-e86d-49b5-9fd0-306f847b68e1);
DB_Children(LOW_Park_AfterCombatChild03_f793b719-0925-46ed-a6ad-b3e169d9572d);
DB_Children(LOW_Park_AfterCombatChild01_dda4e182-e43e-4643-853f-ae6b0d0c0388);

DB_CombatReact_AD_OnTurn(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, LOW_Park_AD_CombatMaleCultists_ea0d896c-7c7a-75e8-88a9-23bb810ecd2a, 1);
DB_CombatReact_AD_OnTurn(S_LOW_Park_BhaalAssassin04_a9bee6df-338e-4df2-a5b6-3a2f6fcebade, LOW_Park_AD_CombatMaleCultists_ea0d896c-7c7a-75e8-88a9-23bb810ecd2a, 2);
DB_CombatReact_AD_OnTurn(S_LOW_Park_BhaalAssassin05_3eef8b7b-f06e-4afb-b4c7-c21bb6dd0268, LOW_Park_AD_CombatMaleCultists_ea0d896c-7c7a-75e8-88a9-23bb810ecd2a, 3);
DB_CombatReact_AD_OnTurn(S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952, LOW_Park_AD_CombatFemaleCultists_2e1378c2-d7eb-be20-5f65-481a8211ca36, 1);
DB_CombatReact_AD_OnTurn(S_LOW_Park_BhaalAssassin02_8bfe6f21-58ed-4963-8f05-10991075e144, LOW_Park_AD_CombatFemaleCultists_2e1378c2-d7eb-be20-5f65-481a8211ca36, 3);
DB_CombatReact_AD_OnTurn(S_LOW_Park_BhaalAssassin01_500d7c8c-60a6-40c6-86b0-82db100b530e, LOW_Park_AD_CombatFemaleCultists_2e1378c2-d7eb-be20-5f65-481a8211ca36, 4);

DB_OneShot_VoiceBarkTrigger((TRIGGER)S_LOW_Park_VB_FlowerPartyBanter_12177e60-d7b5-4ca1-896c-5d76db023aa5, (VOICEBARKRESOURCE)LOW_Park_VB_FlowerDreadful_7b9a58ca-aac1-09d6-e7fa-068efc3d24c1, "PerUserAndNearbyPlayers");

//Murder target civlians
DB_GLO_DefeatCounter(S_LOW_Park_LoversMale_cc2aca46-3a9a-4637-98a4-dc812b71ff6d, "LOW_Park_CivilianMurders");
DB_GLO_DefeatCounter(S_LOW_Park_LoversFemale_bf8d1fd2-53ea-4df4-9924-5136a4345ef3, "LOW_Park_CivilianMurders");
DB_GLO_DefeatCounter(S_LOW_Park_FanclubMember01_32c18a38-6f75-4e72-8072-409dae627929, "LOW_Park_CivilianMurders");
DB_GLO_DefeatCounter(S_LOW_Park_FanclubMember02_c11362d2-c6dd-48e7-87a1-775562ede7f1, "LOW_Park_CivilianMurders");
DB_GLO_DefeatCounter(S_LOW_Park_FanclubMember03_b91ad1bf-f323-4378-bc47-3492efbd10ae, "LOW_Park_CivilianMurders");
DB_GLO_DefeatCounter(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd, "LOW_Park_CivilianMurders");
DB_GLO_DefeatCounter(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, "LOW_Park_CivilianMurders");

//DB_LOW_Park_CiviliansSpreeTargets(_Civilian, _DeadOrOffstage)
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_LoversFemale_bf8d1fd2-53ea-4df4-9924-5136a4345ef3, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_LoversMale_cc2aca46-3a9a-4637-98a4-dc812b71ff6d, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_FanclubMember01_32c18a38-6f75-4e72-8072-409dae627929, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_FanclubMember02_c11362d2-c6dd-48e7-87a1-775562ede7f1, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_FanclubMember03_b91ad1bf-f323-4378-bc47-3492efbd10ae, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, 0);
KBSECTION
//REGION New dialog and behavior for Edenosa on successfully spotting ambush
//Set new dialogs on spotting ambush
PROC
PROC_RevealAmbush(S_LOW_Park_AmbushDetectTrigger_2e77c8e8-7b7f-4e79-b84d-27596bfe68e4, _Player)
AND
DB_Players(_Player)
THEN
TriggerRegisterForCharacter((TRIGGER)S_LOW_Park_FlamingFistPatrolArea_81bcb823-0945-4092-953d-5962e822dadd, (CHARACTER)S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511);
TriggerRegisterForCharacter((TRIGGER)S_LOW_ParkFlamingFistWarn_c2797dae-1cb7-45f7-baf1-57132dd4b21f, (CHARACTER)S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511);
PROC_RemoveDialogEntryForSpeaker(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, LOW_Park_GuardPreCombat_57fada27-ac39-599d-c9b9-d35f2ad67762);
DB_Dialogs(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, LOW_Park_EdenosaSpottedAmbush_1bf94dbc-f8c9-7db7-5650-e64e64893f81);

//Handles behavior to start following player
IF
FlagSet((FLAG)LOW_Park_Event_ToldEdenosaAboutAmbush_a04051b8-1ccd-4b0d-8bde-2c7b89bdeaa8, (CHARACTER)_Player, _)
AND
DB_Players(_Player)
THEN
PROC_Follow(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player);
PROC_RemoveDialogEntryForSpeaker(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, LOW_Park_EdenosaSpottedAmbush_1bf94dbc-f8c9-7db7-5650-e64e64893f81);
DB_Dialogs(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, LOW_Park_GuardPreCombat_57fada27-ac39-599d-c9b9-d35f2ad67762);

//Warns player if they start leaving the ambush area
IF
LeftTrigger((CHARACTER)S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, (TRIGGER)S_LOW_ParkFlamingFistWarn_c2797dae-1cb7-45f7-baf1-57132dd4b21f)
AND
DB_Following(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player)
AND
DB_Players(_Player)
AND
NOT DB_Is_InCombat(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _)
AND
QRY_StartDialog_Fixed(LOW_Park_AD_TryingLeavePark_d16b7191-bc10-5620-853b-8523a9613c60, S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511 ,_Player)
THEN
DB_NOOP(1);

//Edenosa has a dialog and stops following the players if they leave the Park area without dealing with the ambush
IF
LeftTrigger((CHARACTER)S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, (TRIGGER)S_LOW_Park_FlamingFistPatrolArea_81bcb823-0945-4092-953d-5962e822dadd)
AND
DB_Following(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player)
AND
DB_Players(_Player)
AND
NOT DB_Is_InCombat(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _) 
AND
QRY_StartDialog_Fixed(LOW_Park_EdenosaAnnoyed_d3ef83dd-574f-117a-759b-1fdc10729123, S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player)
THEN
DB_NOOP(1);

//Fixes some behaviour where Edenosa would walk away mid-dialog
IF
DialogEnded(LOW_Park_EdenosaAnnoyed_d3ef83dd-574f-117a-759b-1fdc10729123,  _ID)
AND
DB_Following(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player)
AND
DB_Players(_Player)
THEN
PROC_StopFollow(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_ParkGuards_cf08cf76-401e-4cd2-99a6-a352560db8c4, 50);
PROC_CharacterMoveTo(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, S_LOW_Park_EdenosaReturnPos_884dc272-7360-4dfb-acf7-f4f3fdaf0a8c, "Walk", "LOW_Park_EdenosaWandersOff");
//END_REGION 


//REGION Ambush initial dialogue
PROC
PROC_CancelAmbush((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1)
AND
NOT DB_GlobalFlag((FLAG)LOW_Park_Event_FinishedMurderSpree_befcdb46-1a93-4292-8c65-33f939f0dddd)
AND
GetClosestPlayer(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, _Player, _)
AND
NOT DB_OnlyOnce("LOW_Park_AmbushedBhaalCultists")
AND
NOT DB_GlobalFlag(GLO_Orin_State_AgreedToKillGortash_39af75d8-2442-8667-551e-6a0dc699398b)
AND
QRY_OnlyOnce("LOW_Park_AmbushInititalDialog")
AND
NOT QRY_StartDialogWithAvailableSpeakerInRange(LOW_ParkCultistAmbush_001_258e1ff8-f890-3347-01cd-e3c4fd55dff7, S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, _Player, 20.0)
AND
QRY_OnlyOnce("LOW_Park_CultistsSetHostile")
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_BhaalCultists_cfd782cf-5eba-40a5-85c9-00c7563f1312, 0);

PROC
PROC_LaunchAmbush((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1, (CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_Following(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player)
AND
QRY_OnlyOnce("LOW_Park_AmbushInititalDialog")
AND
NOT QRY_StartDialogWithAvailableSpeakerInRange_TryTargetFirst(LOW_ParkCultistAmbush_001_258e1ff8-f890-3347-01cd-e3c4fd55dff7, S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, _Player, 20.0)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_BhaalCultists_cfd782cf-5eba-40a5-85c9-00c7563f1312, 0);

PROC
PROC_LaunchAmbush((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1, (CHARACTER)_Character)
AND
NOT DB_Players(_Character)
AND
DB_PartyMembers(_Character)
AND
QRY_OnlyOnce("LOW_Park_AmbushInititalDialog")
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_BhaalCultists_cfd782cf-5eba-40a5-85c9-00c7563f1312, 0);

PROC
PROC_LaunchAmbush((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1, (CHARACTER)_Character)
AND
DB_Following(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_BhaalCultists_cfd782cf-5eba-40a5-85c9-00c7563f1312, 0);

//Sets the QRY_OnlyOnce to prevent the intro dialog from starting again if players started the ambush by clicking on a Cultist
IF
DialogEnded(LOW_ParkCultistAmbush_001_258e1ff8-f890-3347-01cd-e3c4fd55dff7, _)
AND
QRY_OnlyOnce("LOW_Park_AmbushInititalDialog")
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_BhaalCultists_cfd782cf-5eba-40a5-85c9-00c7563f1312, 0);

//Trigger main ambush dialog if players try and start a dialog with one of the hidden Cultists, forces the dialog to be with the Cultist Leader
QRY
QRY_SelectCustomDialog_AfterGenerics(_Cultist, _Player)
AND
DB_LOW_Park_Cultists(_Cultist)
AND
DB_Players((CHARACTER)_Player)
AND
NOT QRY_StartDialogWithAvailableSpeakerInRange_TryTargetFirst(LOW_ParkCultistAmbush_001_258e1ff8-f890-3347-01cd-e3c4fd55dff7, S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, _Player, 20.0)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_BhaalCultists_cfd782cf-5eba-40a5-85c9-00c7563f1312, 0);


//Trigger ambush if players attack Cirian or the Hooded Figure outside of normal Ambush pipeline
IF
EnteredCombat(_Cultist, _)
AND
DB_LOW_Park_Cultists(_Cultist)
AND
NOT DB_AmbushTrigger_Ambusher(S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1, _Cultist, 1)
THEN
PROC_CancelAmbush((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1);


//Equip Cirian with Murderous Dagger at start of Combat if able
IF
TurnStarted(S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952)
AND
QRY_OnlyOnce("LOW_Park_CirianEquipsDagger")
THEN
PROC_LOW_Park_EquipWeapon();

PROC
PROC_LOW_Park_EquipWeapon()
AND
GetItemByTemplateInInventory(MAG_Murderous_Dagger_2384a69e-7d7d-4052-84ee-2f53fa45320f, S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952, _MurderDagger)
THEN
Equip(S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952, _MurderDagger);

PROC
PROC_LOW_Park_EquipWeapon()
AND
NOT GetItemByTemplateInInventory(MAG_Murderous_Dagger_2384a69e-7d7d-4052-84ee-2f53fa45320f, S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952, _)
AND
GetItemByTemplateInInventory(WPN_HUM_Dagger_A_0_569b0f3d-abcd-4b01-aaf0-979091288163, S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952, _Dagger)
THEN
Equip(S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952, _Dagger);
//END_REGION

//REGION Killing spree combat start
IF
DialogEnded(LOW_ParkCultistAmbush_001_258e1ff8-f890-3347-01cd-e3c4fd55dff7, _)
AND
DB_GlobalFlag(GLO_Orin_State_AgreedToKillGortash_39af75d8-2442-8667-551e-6a0dc699398b)
THEN
PROC_LOW_Park_SetCiviliansCultistEnemy();

PROC
PROC_LOW_Park_SetCiviliansCultistEnemy()
AND
DB_LOW_Park_CiviliansSpreeTargets(_Civilian, 0)
THEN
SetCombatGroupID(_Civilian, "LOW_Park_CivilianMurders_Civilians");
SetCanFight(_Civilian, 1);

PROC
PROC_LOW_Park_SetCiviliansCultistEnemy()
AND
DB_LOW_Park_Cultists(_Cultist)
THEN
SetCombatGroupID(_Cultist, "LOW_Park_CivilianMurders_Cultists");

PROC
PROC_LOW_Park_SetCiviliansCultistEnemy()
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_Park_ParkCivilians_4c02de1b-d516-4c3f-ba2c-8317307f695b, Act3_LOW_BhaalCultists_cfd782cf-5eba-40a5-85c9-00c7563f1312, 0);

PROC
PROC_LOW_Park_SetCiviliansCultistEnemy()
AND
DB_LOW_Park_CiviliansSpreeTargets(_Civilian, 0)
AND
DB_LOW_Park_Cultists(_Cultist)
THEN
EnterCombat(_Civilian, _Cultist);

//Removes dialogs from cultists if the player has sided with Orin but refused to get involved in the Park slaughter
IF
FlagSet(LOW_Park_Event_PlayersUninvolvedInSlaughter_1a85207f-8dd1-4f25-832b-c9a09320f1cc, _, _)
AND
DB_LOW_Park_Cultists(_Cultist)
THEN
PROC_RemoveDialog(_Cultist);
//END_REGION


//REGION Get Combat GUID and handle combat switch edge case
IF
EnteredCombat(_Cultist, _CombatID)
AND
DB_LOW_Park_Cultists(_Cultist)
AND
NOT DB_GlobalFlag((FLAG)LOW_Park_State_CombatStarted_cc084b9e-ab49-4fa6-b6e6-2f0cfa54b938)
THEN
DB_LOW_Park_CombatGUID(_CombatID);
PROC_GlobalSetFlagAndCache((FLAG)LOW_Park_State_CombatStarted_cc084b9e-ab49-4fa6-b6e6-2f0cfa54b938);
PROC_SetRelationMutual((FACTION)Act3_LOW_Citizens_55059168-3e19-462a-8693-43299fa0d3bb, (FACTION)Act3_LOW_BhaalCultists_cfd782cf-5eba-40a5-85c9-00c7563f1312, 0);

// Remove Cirian Disguise and give her her Death's Head abilities when she enters combat
IF
EnteredCombat((CHARACTER)S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952, _)
AND
HasActiveStatus(S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952,"LOW_BLOOMRIDGEPARK_DISGUISEDCULTIST_TECHNICAL",0)
THEN
ApplyStatus(S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952,"LOW_BLOOMRIDGEPARK_DISGUISEDCULTIST_TECHNICAL",-1.0);



IF
SwitchedCombat(_Cultist,_OldCombatID,_NewCombatID)
AND
DB_LOW_Park_Cultists(_Cultist)
AND
DB_LOW_Park_CombatGUID(_OldCombatID)
THEN
DB_LOW_Park_CombatGUID(_NewCombatID);
NOT DB_LOW_Park_CombatGUID(_OldCombatID);


//END_REGION

//REGION If Edenosa is following the player, trigger the dialog and join combat
IF
CombatRoundStarted(_CombatID, _Round)
AND
DB_Following(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player)
AND
GetClosestAlivePlayer(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player, _)
AND
DB_Is_InCombat(_Player, _CombatID) 
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
NOT DB_OnlyOnce("LOW_Park_MidCombatDialog")  
AND
QRY_StartDialogCustom(LOW_ParkCultistAmbush_002_caadd1a8-17b6-e89c-362c-a2da1d12075e, S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, _Player, 0, 0, 0, 0)
AND
QRY_OnlyOnce("LOW_Park_MidCombatDialog")
THEN
PROC_StopFollow(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_ParkGuards_cf08cf76-401e-4cd2-99a6-a352560db8c4, 100);
//END_REGION

//REGION Move Flaming Fists to Combat if not following player
IF
CombatRoundStarted(_CombatID, _Round)
AND
_Round > 1
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
QRY_OnlyOnce("LOW_Park_ReinforcementsArrive")
AND
DB_LOW_Park_MovePairs(_Fist, _FistTarget)
THEN
PROC_CharacterMoveTo(_Fist, _FistTarget, "Run", "LOW_Park_FlamingFistsRun");
//END_REGION

//REGION Trigger Midcombat Dialog

//Handles if guards run to combat
IF
EntityEvent(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, "LOW_Park_FlamingFistsRun")
AND
DB_Is_InCombat(_Player, _CombatID) 
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
GetClosestAlivePlayer(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, (CHARACTER)_Player, _)
AND
NOT DB_OnlyOnce("LOW_Park_MidCombatDialog") 
AND
QRY_OnlyOnce("LOW_Park_MidCombatDialog") 
AND
NOT QRY_StartDialogCustom(LOW_ParkCultistAmbush_002_caadd1a8-17b6-e89c-362c-a2da1d12075e, S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, _Player, 0, 0, 0, 0)
THEN
SetFlag((FLAG)LOW_Park_Event_GuardsJoinCombat_ea42c40b-c4e9-40a5-bf67-a51f4466d766, _Player, 0);

IF
FlagSet((FLAG)LOW_Park_Event_GuardsJoinCombat_ea42c40b-c4e9-40a5-bf67-a51f4466d766, _, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_Park_Event_PlayersSidedWithCutlists_cde0a074-fa2a-44a5-8025-77a86ff94ce7)
THEN
PROC_SetRelationMutual((FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, (FACTION)Act3_LOW_BhaalCultists_cfd782cf-5eba-40a5-85c9-00c7563f1312, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_ParkGuards_cf08cf76-401e-4cd2-99a6-a352560db8c4, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 100);

//Makes sure NPCs in the combat cannot act during the dialog
IF
DB_Is_InCombat(_NPC, _CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_DialogName(LOW_ParkCultistAmbush_002_caadd1a8-17b6-e89c-362c-a2da1d12075e, _ID)
AND
NOT DB_Players((CHARACTER)_NPC)
AND
NOT DB_DialogNPCs (_ID, _NPC, _) 
AND
NOT DB_Defeated(_NPC)
THEN
PROC_DialogAddListeningActor(_ID, _NPC);

//Adds loose Flaming Fists to the midcombat dialog
IF
DB_Is_InCombat(_, _CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_DialogName(LOW_ParkCultistAmbush_002_caadd1a8-17b6-e89c-362c-a2da1d12075e, _ID)
AND
DB_LOW_Park_FlamingFists(_FlamingFist)
AND
NOT DB_DialogNPCs(_ID, _FlamingFist, _)
THEN
PROC_DialogAddListeningActor(_ID, _FlamingFist);


//Makes sure players that arrive late in the combat cannot act during the dialog
IF
DB_Is_InCombat(_Player, _CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_DialogName(LOW_ParkCultistAmbush_002_caadd1a8-17b6-e89c-362c-a2da1d12075e, _ID)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_DialogPlayers (_ID, _Player, _) 
AND
NOT DB_Defeated(_Player)
THEN
PROC_DialogAddListeningActor(_ID, _Player);

//END_REGION 

//REGION Restart Combat after dialog
IF
DialogEnded(LOW_ParkCultistAmbush_002_caadd1a8-17b6-e89c-362c-a2da1d12075e, _ID)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
DB_Is_InCombat(_Player, _CombatID) 
AND
DB_LOW_Park_CombatGUID(_CombatID)
THEN
PROC_CharacterMoveTo(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player, "Run", "LOW_Park_PostCombatDialogSetUp");
PROC_CharacterMoveTo(S_LOW_Park_FlamingFist1_bbd05a60-77c7-48fe-9273-a9e5303c7c24, S_LOW_Park_EndingPosition001_8d96eba6-4a5b-4ca7-b6da-a4086679bbc0, "Walk", "LOW_Park_PostCombatDialogSetUp");
PROC_CharacterMoveTo(S_LOW_Park_FlamingFist2_be3b99d0-b8ed-4d39-92e1-848f09e022c3, S_LOW_Park_EndingPosition002_398fb7b8-47ac-47f4-8eab-6ccf9eb06ab6, "Walk", "LOW_Park_PostCombatDialogSetUp");
PROC_RemoveDialogEntryForSpeaker(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, LOW_Park_EdenosaSpottedAmbush_1bf94dbc-f8c9-7db7-5650-e64e64893f81);
PROC_GlobalSetFlagAndCache((FLAG)LOW_Park_State_CombatStarted_cc084b9e-ab49-4fa6-b6e6-2f0cfa54b938);
//END_REGION

//REGION Post-combat Dialog

IF
CombatEnded(_CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_Defeated(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61)
AND
NOT DB_PermaDefeated(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511)
THEN
DB_SpotPlayers(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, "LOW_Park_EdenosaPostCombatSpot", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, "LOW_Park_EdenosaPostCombatSpot", _Player)
AND
QRY_StartDialog(LOW_ParkCultistAmbush_003_b3dbcd94-1a5d-4ed7-f7bf-747e17cf7bf3, S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, _Player)
THEN
PROC_RemoveDialogEntryForSpeaker(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, LOW_Park_GuardPreCombat_57fada27-ac39-599d-c9b9-d35f2ad67762);
PROC_ClearStoryMove(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511);

//Below handles spawning the spare Flaming Fist if Edenosa is dead, getting them to the player, and starting the post-combat dialog
IF
CombatEnded(_CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_Defeated(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61)
AND
DB_PermaDefeated(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511)
THEN
PROC_AppearOutOfSightTo(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00, S_LOW_Park_AmbushDetectTrigger_2e77c8e8-7b7f-4e79-b84d-27596bfe68e4, S_LOW_Park_EdenosaReturnPos_884dc272-7360-4dfb-acf7-f4f3fdaf0a8c, "LOW_Park_ReserveFlamingFistSummon");
DB_SpotPlayers(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00, "LOW_Park_ReserveFlamingFistSpot", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF 
EntityEvent(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00, "LOW_Park_ReserveFlamingFistSummon")
AND
GetClosestAlivePlayer(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00, _Player, _)
THEN
PROC_CharacterMoveTo(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00, _Player, "Run", "LOW_Park_ReservePostCombatDialogSetUp");

PROC
PROC_SpotPlayers_Spotted(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00, "LOW_Park_ReserveFlamingFistSpot", _Player)
AND
QRY_StartDialog(LOW_ParkCultistAmbush_BackUpDialog_4533193d-1912-b7db-e136-ae5458010afe, S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00, _Player)
THEN
PROC_ClearStoryMove(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00);

//Postcombat Brainquakes
IF
CombatEnded(_CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_Defeated(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61)
AND
GetClosestPlayer(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, _Player, _)
THEN
PROC_GLO_Brainquakes_StartForcedEvent(_Player, "LOW_Park_PostCombatBrainquake");

IF
FlagSet((FLAG)LOW_Park_Event_AbsoluteMessengerDied_2b89b979-7d80-4574-b89a-2d1eff182e2c, _, _)
THEN
TimerLaunch("LOW_Park_BrainTimer", 250);

IF 
TimerFinished("LOW_Park_BrainTimer")
AND
GetClosestPlayer(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, _Player, _)
THEN
PROC_GLO_Brainquakes_StartForcedEvent(_Player, "LOW_Park_TadpoledFistDeadBrainquake");


//END_REGION

//REGION Catch for situation where Cultists are all dead before Guards Start Moving
//Guards will run up to the dead cultists
IF
CombatEnded(_CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_LOW_Park_MovePairs(_Fist, _FistTarget)
AND
NOT DB_OnlyOnce("LOW_Park_ReinforcementsArrive")
THEN
PROC_CharacterMoveTo(_Fist, _FistTarget, "Run", "LOW_Park_FlamingFistsRun");
//END_REGION

//REGION Handles bodies and looting
//Makes dead Cultists lootable
QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)_Cultist)
AND
DB_LOW_Park_Cultists(_Cultist)
THEN
DB_NOOP(1);
//END_REGION

//REGION Melting the speaker after the post-combat dialog
IF
DialogEnded(LOW_ParkCultistAmbush_BackUpDialog_4533193d-1912-b7db-e136-ae5458010afe, _)
AND
NOT DB_PermaDefeated(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00)
THEN
Die(S_LOW_Park_FlamingFist_Reserve_3bd85855-86d9-4c58-92c6-115ac442ec00, DEATHTYPE.Psychic, NULL_00000000-0000-0000-0000-000000000000, 1, 0, 0.0);
PROC_GlobalSetFlagAndCache((FLAG)LOW_Park_Event_AbsoluteMessengerDied_2b89b979-7d80-4574-b89a-2d1eff182e2c);

IF
DialogEnded(LOW_ParkCultistAmbush_003_b3dbcd94-1a5d-4ed7-f7bf-747e17cf7bf3, _)
AND
NOT DB_PermaDefeated(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511)
THEN
Die(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511, DEATHTYPE.Psychic, NULL_00000000-0000-0000-0000-000000000000, 1, 0, 0.0);
PROC_GlobalSetFlagAndCache((FLAG)LOW_Park_Event_AbsoluteMessengerDied_2b89b979-7d80-4574-b89a-2d1eff182e2c);

IF
Died(S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511)
THEN
TeleportTo(S_LOW_Park_EndingPosition001_8d96eba6-4a5b-4ca7-b6da-a4086679bbc0, S_LOW_Edenosa_Cracklewall_980f2182-100a-4c30-9965-5bbae804a511);
//END_REGION

//REGION Park Scene Manager and combat interrupt management
//Makes sure civilians who enter the combat flee and disappear after combat
IF
EnteredCombat(_Civilian, _CombatID)
AND
DB_LOW_Park_Civilians(_Civilian)
THEN
DB_LOW_Park_FleeAfterCombat((CHARACTER)_Civilian, _CombatID);

IF
SwitchedCombat(_Civilian, _OldCombatID, _NewCombatID)
AND
DB_LOW_Park_FleeAfterCombat((CHARACTER)_Civilian, _OldCombatID)
THEN
DB_LOW_Park_FleeAfterCombat((CHARACTER)_Civilian, _NewCombatID);
NOT DB_LOW_Park_FleeAfterCombat((CHARACTER)_Civilian, _OldCombatID);

IF
CombatEnded(_CombatID)
AND
DB_LOW_Park_FleeAfterCombat(_Civilian,_CombatID)
AND
DB_Players(_Player)
THEN
PROC_DisappearOutOfSightTo(_Civilian, _Player, "Run", 0, "");
NOT DB_LOW_Park_FleeAfterCombat(_Civilian,_CombatID);

//Sets up Scene Manager
IF
DB_LOW_Park_Civilians(_Civilian)
THEN
DB_SceneManager((CHARACTER)_Civilian, "LOW_Park_PreAmbush");

PROC
PROC_SceneInterrupted(_Civilian, _Attacker, "LOW_Park_PreAmbush", "Attacked")
AND
DB_LOW_Park_Civilians(_Civilian)
AND
DB_PartOfTheTeam(_Attacker)
THEN
PROC_DisappearOutOfSight((CHARACTER)_Civilian, "Run", 0, "LOW_Park_CivilianFled");

//Stops ADs when cultists appear
IF
EnteredCombat(_Cultist, _)
AND
DB_LOW_Park_Cultists(_Cultist)
AND
DB_LOW_Park_Civilians(_Civilian)
THEN
PROC_TryStopDialogFor((CHARACTER)_Civilian);

//Kills Civilians and any remaining Flaming Fist if players flee combat
IF
FleeFromCombat(_, _CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_Players(_Player)
AND
NOT DB_Is_InCombat(_Player, _CombatID)
AND
DB_LOW_Park_Civilians(_Civilian)
AND
DB_LOW_Park_FlamingFists(_Fists)
AND
DB_LOW_Park_Cultists(_Cultist)
THEN
PROC_LOW_Park_MurderTargets(_Civilian);
PROC_LOW_Park_MurderTargets(_Fists);
PROC_LOW_Park_HideCultists(_Cultist);
PROC_SetOnStage(S_LOW_Park_SymbolOfTheAbsolute_276b729f-b399-4132-8f1a-5166000df2f4, 1);

PROC
PROC_LOW_Park_MurderTargets((GUIDSTRING)_Target)
AND
IsOnStage(_Target, 1)
AND
DB_Players(_Player)
AND
NOT DB_Sees((CHARACTER)_Player, (CHARACTER)_Target)
THEN
Die(_Target, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

PROC
PROC_LOW_Park_HideCultists((GUIDSTRING)_Cultist)
AND
IsOnStage(_Cultist, 1)
AND
DB_Players(_Player)
AND
NOT DB_Sees((CHARACTER)_Player, (CHARACTER)_Cultist)
THEN
PROC_SetOnStage(_Cultist, 0);

//Ensures kids with the lost ball flee from combat
IF
EnteredCombat(_Cultist, _)
AND
DB_LOW_Park_Cultists(_Cultist)
AND
QRY_OnlyOnce("LOW_Park_KidsFleeFromAmbush")
THEN
PROC_DisappearOutOfSight((CHARACTER)S_LOW_Park_ChildLostBallScene01_8140a70d-bf67-4a93-ab63-ff3a441f9b2f, "Run", 0, "LOW_Park_KidsFleeFromCombat");
PROC_DisappearOutOfSight((CHARACTER)S_LOW_Park_ChildLostBallScene02_0c6d7c78-bb49-45d6-ada9-4a46783396fb, "Run", 0, "LOW_Park_KidsFleeFromCombat");


//END_REGION

//REGION Park ADs set up and peaceful scene ends

//Cultists hiding in plain sight scene
IF
EnteredTrigger(_Player, S_LOW_Park_CultistsADTrigger_74e17672-a3d7-46a5-a4b6-e7f40282c9f5)
AND
DB_Players(_Player)
THEN
PROC_TryStartAD(LOW_Park_AD_DisguisedBhaalCultists_14e30beb-0885-f5f1-ad7e-779edc470606, (CHARACTER)S_LOW_Park_BhaalAssassin04_a9bee6df-338e-4df2-a5b6-3a2f6fcebade, (CHARACTER)S_LOW_Park_BhaalAssassin03_f28f8cd6-dc57-434e-a3ac-ed13cd9ed952);
PROC_TriggerUnregisterForPlayers(S_LOW_Park_CultistsADTrigger_74e17672-a3d7-46a5-a4b6-e7f40282c9f5);

//Kids who have lost their ball minibooster
IF
EnteredTrigger(_Player, S_LOW_Park_ArguingKidsADTrigger_c78822a8-4a71-48e9-ae81-24555933427e)
AND
DB_PartyMembers(_Player)
THEN
PROC_TryStartAD(LOW_Park_AD_ArguingKids_dba347e2-c666-e8ec-bdae-d26f59a69fd5, (CHARACTER)S_LOW_Park_ChildLostBallScene01_8140a70d-bf67-4a93-ab63-ff3a441f9b2f, (CHARACTER)S_LOW_Park_ChildLostBallScene02_0c6d7c78-bb49-45d6-ada9-4a46783396fb);
PROC_TriggerUnregisterForParty(S_LOW_Park_ArguingKidsADTrigger_c78822a8-4a71-48e9-ae81-24555933427e);

// Retired Flaming Fists Minibooster
IF
DB_LOW_Park_RetiredFists(_RetiredFist)
THEN
DB_PermaDefeatedFlag((CHARACTER)_RetiredFist, (FLAG)LOW_Park_State_AtleastOneRetiredFistsPermaDefeated_188326be-df44-44ad-9fef-7c6f1d4edd15);

IF
EnteredTrigger(_Player, S_LOW_Park_RetiredFistsADTrigger_0ed5b973-2519-4959-afe4-4045c3935a87)
AND
DB_PartyMembers(_Player)
THEN
PROC_TryStartAD(LOW_Park_AD_RetiredFists_ce1741d1-687e-41b4-14a2-1cdb51cbf4a3, S_LOW_Park_RetiredFist_Dwarf01_a94d18f7-23ec-4f4b-868a-d6feaf9beaae, S_LOW_Park_RetiredFist_Dwarf02_669e3ab9-acc1-4fe2-814a-4d21e901cf86, S_LOW_Park_RetiredFist_Elf01_08d2d3a7-6d87-40e7-8649-750e9857dd3c, S_LOW_Park_RetiredFist_Elf02_d7cd0aa5-7303-45c7-a9e2-fac6a458f63e);
PROC_TriggerUnregisterForParty(S_LOW_Park_RetiredFistsADTrigger_0ed5b973-2519-4959-afe4-4045c3935a87);

PROC
PROC_LongRest()
AND
DB_GlobalFlag(LOW_Park_Event_AbsoluteMessengerDied_2b89b979-7d80-4574-b89a-2d1eff182e2c)
AND
NOT DB_GlobalFlag((FLAG)LOW_Park_State_AtleastOneRetiredFistsPermaDefeated_188326be-df44-44ad-9fef-7c6f1d4edd15)
AND
QRY_OnlyOnce("LOW_Park_RetiredFlamingFistsHandled")
THEN
PROC_TriggerRegisterForParty(S_LOW_Park_RetiredFistsADTrigger_0ed5b973-2519-4959-afe4-4045c3935a87);
DB_LOW_Park_Replacements(S_LOW_Park_RetiredFist_Dwarf01_a94d18f7-23ec-4f4b-868a-d6feaf9beaae);
DB_LOW_Park_Replacements(S_LOW_Park_RetiredFist_Dwarf02_669e3ab9-acc1-4fe2-814a-4d21e901cf86);
DB_LOW_Park_Replacements(S_LOW_Park_RetiredFist_Elf01_08d2d3a7-6d87-40e7-8649-750e9857dd3c);
DB_LOW_Park_Replacements(S_LOW_Park_RetiredFist_Elf02_d7cd0aa5-7303-45c7-a9e2-fac6a458f63e);

// Lovers minibooster
IF
EnteredTrigger(_Player, S_LOW_Park_LoversADTrigger_c57ae459-abc3-44ef-8087-07dc7f0dd574)
AND
DB_PartyMembers(_Player)
THEN
PROC_TryStartAD(LOW_Park_AD_Lovers_d8527bcc-bee1-3105-48f7-6a92ee6843ac, S_LOW_Park_LoversMale_cc2aca46-3a9a-4637-98a4-dc812b71ff6d, S_LOW_Park_LoversFemale_bf8d1fd2-53ea-4df4-9924-5136a4345ef3);
PROC_TriggerUnregisterForParty(S_LOW_Park_LoversADTrigger_c57ae459-abc3-44ef-8087-07dc7f0dd574);

// Vampire bookclub minibooster
IF
EnteredTrigger(_Player, S_LOW_Park_VampireBookClubADTrigger_99fab05c-0fa4-47e8-a0e0-b58418cd7dcf)
AND
DB_PartyMembers(_Player)
THEN
PROC_TryStartAD(LOW_Park_AD_BookClub_08c21fc1-b3b3-cbbd-86b1-90a0d5755f02, S_LOW_Park_FanclubMember01_32c18a38-6f75-4e72-8072-409dae627929, S_LOW_Park_FanclubMember02_c11362d2-c6dd-48e7-87a1-775562ede7f1, S_LOW_Park_FanclubMember03_b91ad1bf-f323-4378-bc47-3492efbd10ae);
PROC_TriggerUnregisterForParty(S_LOW_Park_VampireBookClubADTrigger_99fab05c-0fa4-47e8-a0e0-b58418cd7dcf);

//Boy With Dog minibooster
IF
EnteredTrigger(_Player, S_LOW_Park_BoyWithDogADTrigger_f617b7b6-b85b-4532-88ca-4356e9541533)
AND
DB_Partymembers(_Player)
THEN
PROC_TryStartAD(LOW_Park_AD_BoyWithDog_6a1ec550-c243-409e-bc0c-98c8ff70681a, S_LOW_Park_BoyWithDog_ab5e67c3-f0f4-4234-b36d-0bfad1592d09);
PROC_TriggerUnregisterForParty(S_LOW_Park_BoyWithDogADTrigger_f617b7b6-b85b-4532-88ca-4356e9541533);

IF
FlagSet(LOW_Park_Event_CalmedRufie_9f508901-35f3-41be-bf83-8195d206ee76 ,_ ,_)
THEN
PROC_CharacterMoveTo(S_LOW_Park_BoyWithDog_ab5e67c3-f0f4-4234-b36d-0bfad1592d09, S_LOW_Park_BystandersOffstage_PointTrigger_b049b78f-6100-4eea-a89f-beda5ece53bf, "Walk", "LOW_Park_BoyAndDogLeave");
PROC_CharacterMoveTo(S_LOW_Park_DogWithBoy_549bb04f-8243-4366-ae75-fcbb98d5ef9d, S_LOW_Park_BystandersOffstage_PointTrigger_b049b78f-6100-4eea-a89f-beda5ece53bf, "Walk", "LOW_Park_BoyAndDogLeave");

IF
EntityEvent(_NPC, "LOW_Park_BoyAndDogLeave")
THEN
PROC_DisappearOutOfSight((CHARACTER)_NPC, "Walk", 0, "LOW_Park_BoyAndDogOffMap");


//Elderly Couple minibooster

QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, _Player)
THEN
DB_SelectedDialog(LOW_Park_ElderlyCouple_6c1f315a-ea71-2444-20c9-4888ad5240d3, 
	S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd,
	S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82,
	_Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd, _Player)
THEN
DB_SelectedDialog(LOW_Park_ElderlyCouple_6c1f315a-ea71-2444-20c9-4888ad5240d3, 
	S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd,
	S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82,
	_Player);

IF
DialogEnded(LOW_Park_ElderlyCouple_6c1f315a-ea71-2444-20c9-4888ad5240d3, _)
AND
DB_GlobalFlag((FLAG)LOW_Park_Event_ElderlyCoupleLeaves_28fef939-7fa2-42e6-914e-6c7b3539c72d)
THEN
PROC_CharacterMoveTo(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd, S_LOW_Park_BystandersOffstage_PointTrigger_b049b78f-6100-4eea-a89f-beda5ece53bf, "Walk", "LOW_Park_ElderlyCoupleLeave");
PROC_CharacterMoveTo(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, S_LOW_Park_BystandersOffstage_PointTrigger_b049b78f-6100-4eea-a89f-beda5ece53bf, "Walk", "LOW_Park_ElderlyCoupleLeave");
NOT DB_GLO_DefeatCounter(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd, "LOW_Park_CivilianMurders");
NOT DB_GLO_DefeatCounter(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, "LOW_Park_CivilianMurders");

IF
EntityEvent(_NPC, "LOW_Park_ElderlyCoupleLeave")
THEN
PROC_DisappearOutOfSight((CHARACTER)_NPC, "Walk", 0, "LOW_Park_ElderlyCoupleOffMap");

// Post Combat Nosy Kids Booster
IF
EnteredTrigger(_Player, LOW_Park_AfterCombatChildADTrigger_08be9052-d0e2-4eb7-a6c7-58dac58395e2)
AND
DB_PartyMembers(_Player)
THEN
PROC_TryStartAD(LOW_Park_AD_NosyKids_2a7e6be6-9998-b992-cc8e-c6daa35facb9, LOW_Park_AfterCombatChild01_dda4e182-e43e-4643-853f-ae6b0d0c0388, LOW_Park_AfterCombatChild02_af76d1de-e86d-49b5-9fd0-306f847b68e1, LOW_Park_AfterCombatChild03_f793b719-0925-46ed-a6ad-b3e169d9572d);
PROC_TriggerUnregisterForParty(LOW_Park_AfterCombatChildADTrigger_08be9052-d0e2-4eb7-a6c7-58dac58395e2);

//END_REGION

//REGION Repopulating the Park
IF
DB_LOW_Park_Replacements(_Replacement)
THEN
DB_ExecuteWhenObjectInCurrentLevel("GLO_OffStage",_Replacement);

PROC
PROC_LongRest()
AND
DB_GlobalFlag(LOW_Park_Event_AbsoluteMessengerDied_2b89b979-7d80-4574-b89a-2d1eff182e2c)
AND
QRY_OnlyOnce("LOW_Park_SwapCiviliansInPark")
THEN
DB_ExecuteInLevel("LOW_Park_SwapCiviliansInPark","CTY_Main_A");

PROC
PROC_ExecuteInLevel("LOW_Park_SwapCiviliansInPark","CTY_Main_A")
THEN
DB_LOW_Park_Replacements(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd);
DB_LOW_Park_Replacements(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82);
SetOnStage(S_LOW_Park_FlamingFist1_bbd05a60-77c7-48fe-9273-a9e5303c7c24, 0);
SetOnStage(S_LOW_Park_FlamingFist2_be3b99d0-b8ed-4d39-92e1-848f09e022c3, 0);
PROC_TriggerRegisterForParty(LOW_Park_AfterCombatChildADTrigger_08be9052-d0e2-4eb7-a6c7-58dac58395e2);
PROC_LOW_Park_OffstageCivilians();
PROC_LOW_Park_OnstageReplacements();

PROC
PROC_LOW_Park_OffstageCivilians()
AND
DB_LOW_Park_Civilians(_Civilian)
AND
NOT DB_LOW_Park_CivilianGroup(_Civilian, _)
THEN
SetOnStage(_Civilian, 0);

PROC
PROC_LOW_Park_OnstageReplacements()
AND
DB_LOW_Park_Replacements(_Replacement)
THEN
SetOnStage(_Replacement, 1);

//Handling groups staying/leaving
//Group leaves if a member died
IF
CombatEnded(_CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_Defeated(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61)
AND
DB_LOW_Park_CivilianGroup(_Civilian, _String)
AND
NOT DB_LOW_Park_GroupLeaves(_String)
AND
DB_Defeated(_Civilian)
THEN
PROC_LOW_Park_GroupLeaves(_String);

PROC
PROC_LOW_Park_GroupLeaves((STRING)_String)
THEN
DB_LOW_Park_GroupLeaves(_String);

PROC
PROC_LOW_Park_GroupLeaves((STRING)_String)
AND
DB_LOW_Park_CivilianGroup(_Civilian, _String)
AND
NOT DB_PermaDefeated(_Civilian)
THEN
PROC_DisappearOutOfSight((CHARACTER)_Civilian, "Run", 0, "LOW_Park_FledAfterCombat");

PROC
PROC_LOW_Park_GroupLeaves((STRING)_String)
AND
DB_LOW_Park_CivilianGroup(_Civilian, _String)
AND
DB_LOW_Park_Civilians(_Civilian)
THEN
NOT DB_LOW_Park_Civilians(_Civilian);

//These characters always leave
IF
CombatEnded(_CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
AND
DB_Defeated(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61)
AND
DB_LOW_Park_Civilians(_Civilian)
AND
NOT DB_LOW_Park_CivilianGroup(_Civilian, _)
THEN
PROC_DisappearOutOfSight((CHARACTER)_Civilian, "Run", 0, "LOW_Park_FledAfterCombat");
NOT DB_LOW_Park_Civilians(_Civilian);
//END_REGION

//REGION Cancelling the ambush in the Netherbrain as Antagonist State

//Sets Cultists off stage unless a player is fighting the Cultists when the state transition occurs
IF
FlagSet(GLO_Netherbrain_State_Emerge_a101a3f8-95cb-4d98-bb10-5965a43ef3bd, _, _)
AND
NOT DB_GlobalFlag(LOW_Park_Event_AbsoluteMessengerDied_2b89b979-7d80-4574-b89a-2d1eff182e2c)
AND
DB_LOW_Park_Cultists(_Cultist)
AND
NOT DB_Is_InCombat(_Cultist, _)
THEN
SetOnStage(_Cultist, 0);

IF
FlagSet(GLO_Netherbrain_State_Emerge_a101a3f8-95cb-4d98-bb10-5965a43ef3bd, _, _)
AND
NOT DB_GlobalFlag(LOW_Park_Event_AbsoluteMessengerDied_2b89b979-7d80-4574-b89a-2d1eff182e2c)
THEN
PROC_CancelAmbush((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1);

//END_REGION

//REGION Players siding with cultits for murder spree handling
//Adding murder targets to the combat in case they are not in range when it starts
IF
EnteredCombat(_Cultist, _)
AND
DB_LOW_Park_Cultists(_Cultist)
AND
QRY_OnlyOnce("LOW_Park_AddCiviliansToCombat")
THEN
PROC_LOW_Park_AddCiviliansToCombat(_Cultist);

PROC
PROC_LOW_Park_AddCiviliansToCombat((GUIDSTRING)_Cultist)
AND
DB_GLO_DefeatCounter(_Civilian, "LOW_Park_CivilianMurders")
THEN
PROC_EnterCombat(_Civilian, _Cultist);


PROC
PROC_GLO_DefeatCounter_Notify("LOW_Park_CivilianMurders", _,(INTEGER)_DefeatedCount,(INTEGER)_PermaDefeatedCount)
AND
IntegerSum(_DefeatedCount,_PermaDefeatedCount, 9)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_Park_Event_FinishedMurderSpree_befcdb46-1a93-4292-8c65-33f939f0dddd);


//Tries to start the dialog when all the Cultists Civilian Targets are dead
//siding with cultists was disabled in a hotfix that might remain permanent
IF
FlagSet((FLAG)LOW_Park_Event_FinishedMurderSpree_befcdb46-1a93-4292-8c65-33f939f0dddd, _, _)
AND
DB_GlobalFlag(LOW_Park_Event_PlayersSidedWithCutlists_cde0a074-fa2a-44a5-8025-77a86ff94ce7)
AND
GetClosestAlivePlayer(S_LOW_Bhaal_Leader_ecb818a4-d67d-4e7f-b917-552654a4cb61, (CHARACTER)_Player, _)
AND
NOT QRY_StartDialogCustom(LOW_Park_MurderCongratulations_14ef4101-f469-be72-50bb-c37d7bf34727, S_LOW_Park_BhaalAssassin01_500d7c8c-60a6-40c6-86b0-82db100b530e, _Player, 0, 0, 0, 0)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_Park_Event_CultistsLeave_fc3b853a-e001-4bd8-a199-a33082157094);

//Makes the Cultists go home if players did not get involved
IF
FlagSet((FLAG)LOW_Park_Event_FinishedMurderSpree_befcdb46-1a93-4292-8c65-33f939f0dddd, _, _)
AND
NOT DB_GlobalFlag(LOW_Park_Event_PlayersSidedWithCutlists_cde0a074-fa2a-44a5-8025-77a86ff94ce7)
//DB_GlobalFlag((FLAG)LOW_Park_Event_PlayersUninvolvedInSlaughter_1a85207f-8dd1-4f25-832b-c9a09320f1cc) //previous condition
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_Park_Event_CultistsLeave_fc3b853a-e001-4bd8-a199-a33082157094);

IF
FlagSet((FLAG)LOW_Park_Event_CultistsLeave_fc3b853a-e001-4bd8-a199-a33082157094, _, _)
AND
DB_LOW_Park_Cultists(_Cultist)
THEN
PROC_DisappearOutOfSight((CHARACTER)_Cultist, "Run", 0, "LOW_Park_CultistsDisappear");
//END_REGION


//REGION Cleanup
IF
CombatEnded(_CombatID)
AND
DB_LOW_Park_CombatGUID(_CombatID)
THEN
NOT DB_LOW_Park_CombatGUID(_CombatID);
//END_REGION


//REGION general dispersion on group member deaths
IF
DB_PermaDefeated(_Char)
AND
DB_LOW_Park_CivilianGroup(_Char, _CivGroup)
AND
NOT DB_Is_InCombat(_Char, _)
AND
DB_LOW_Park_CivilianGroup(_OtherGroupChars, _CivGroup)
THEN
PROC_DisappearOutOfSight((CHARACTER)_OtherGroupChars, "Run", 0, "LOW_Park_Dispersed");
PROC_RemoveDialog(_OtherGroupChars);
//END_REGION

//REGION Checking if there are even any civilians to kill
IF
DB_PermaDefeated(_Char)
AND
DB_LOW_Park_CiviliansSpreeTargets((CHARACTER)_Char, _)
THEN
NOT DB_LOW_Park_CiviliansSpreeTargets(_Char, 0);
DB_LOW_Park_CiviliansSpreeTargets(_Char, 1);
PROC_LOW_Park_EvaluateCultistTargets();

IF
WentOnStage(_Char, 0)
AND
DB_LOW_Park_CiviliansSpreeTargets((CHARACTER)_Char, _)
THEN
NOT DB_LOW_Park_CiviliansSpreeTargets(_Char, 0);
DB_LOW_Park_CiviliansSpreeTargets(_Char, 1);
PROC_LOW_Park_EvaluateCultistTargets();

PROC
PROC_LOW_Park_EvaluateCultistTargets()
AND
NOT DB_LOW_Park_CiviliansSpreeTargets(_, 0)
AND
DB_LOW_Park_Cultists(_Cultist)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_Park_Event_FinishedMurderSpree_befcdb46-1a93-4292-8c65-33f939f0dddd);
PROC_RemoveDialog(_Cultist);
PROC_CancelAmbush((TRIGGER)S_LOW_Park_AmbushTrigger_a928be42-b963-48bb-bc62-5a42c39c55d1);
//END_REGION


EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
