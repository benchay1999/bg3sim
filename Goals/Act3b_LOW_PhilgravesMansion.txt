Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Ancient lair
Open((ITEM)S_LOW_AncientLairEntranceDoor_13b8694c-dd66-486d-8487-3e7561e0ba21);

//Tags of creatures that don't trigger alarm when going inside the ancient lair 
DB_LOW_PhilgravesMansion_AllowedUndeadTagsInLair((TAG)UNDEAD_33c625aa-6982-4c27-904f-e47029a9b140);
DB_LOW_PhilgravesMansion_AllowedUndeadTagsInLair((TAG)UNDEAD_BEAST_1d156657-b014-48fa-b34c-327763480627);
DB_LOW_PhilgravesMansion_AllowedUndeadTagsInLair((TAG)VAMPIRE_f6662b6e-b3bf-468e-82cb-402247176a1b);
DB_LOW_PhilgravesMansion_AllowedUndeadTagsInLair((TAG)GHOST_3def9d73-7c73-487b-8111-d1df1dce076e);
DB_LOW_PhilgravesMansion_AllowedUndeadTagsInLair((TAG)SKELETON_146a89e7-802f-4926-bc21-4a41c2478502);
DB_LOW_PhilgravesMansion_AllowedUndeadTagsInLair((TAG)REALLY_ASTARION_ffd08582-7396-4cac-bcd4-8f9cd0fd8ef3);

DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLairMummy_001_65b33bdc-3126-4962-a712-4175007d9e54);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLairMummy_002_6f71be30-7cab-43a7-999d-12b9adde5a0e);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLairMummy_003_6d04276b-aefd-43a2-a2f0-eb586bcfc881);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLairMummy_004_d526d72a-599c-464e-b7fe-84128d496b3c);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLairMummy_005_331ffe6e-00c9-4f79-94d4-c6d65b4a9093);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_GreaterZombie_000_bd8ab705-e59e-44b1-89fa-df0dc41cd563);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_GreaterZombie_001_64b89b9c-657a-40d3-8232-3931e6c72aaf);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_GreaterZombie_002_ba701b3d-20ec-4225-8a69-3a8be31b4c4f);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_CrawlingClaw_002_8aa6c119-d8f2-4c47-877b-425645df061c);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_CrawlingClaw_000_7f5d8047-66dd-4cec-a992-98d7fe7d9263);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_CrawlingClaw_001_b174f4f8-7a3e-49d9-90c4-a254bbee9c41);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_CrawlingClaw_003_dfb5ea37-aebf-45c5-a658-d69534414132);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_CrawlingClaw_004_461234ed-2457-417b-b850-7dffb9d57498);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_CrawlingClaw_005_387ea8f7-eed3-46b0-81bc-a2ecc280550c);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_CrawlingClaw_006_2928d81e-4ceb-466f-95a4-a774b35a4c83);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_CrawlingClaw_007_fdc82f15-f593-4f03-a9da-26505e66e8e1);
DB_LOW_PhilgravesMansion_LairEnemies((CHARACTER)S_LOW_AncientLair_CrawlingClaw_008_bfaacde1-8b90-4846-b474-5d8f8f81c4f6);

DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_001_963cf82e-1255-4da6-9c16-f1c8b98a33a4);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_002_f721addc-feed-494e-b2d2-94da197daf3c);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_003_130229a5-5da4-45f2-892e-1034f199b519);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_004_b89866e4-b57a-4346-96d9-317a94920ceb);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_005_5e0ac38e-7fa8-482f-a0e5-829b700d1bfc);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_006_d15370a7-43c8-4a99-90bc-0a0d8a7dadfe);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_007_04a7b7ce-6d9d-4f9d-8629-ff268255be8a);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_008_01a006b8-9a61-46dd-aa2f-00113ef46b73);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_009_6901c2fc-554a-44c6-8e49-2c847fe70a94);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_010_262ab1a6-2e77-47d3-8ef6-db44c289eda4);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_011_a9f10a6d-50bc-47fb-9731-43223ec4b6ac);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_012_aacb0126-6490-4df5-9e64-5f020e9a5a08);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_013_5debe83a-93a8-416b-83ba-aac9bc8873dd);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_014_97e9b580-2b7e-458c-a2a6-06537f1afd2b);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_015_7d5685a7-e475-4ab2-b557-c8eb0e424574);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_016_08da9e05-e528-47dd-b360-20ac59c27551);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_017_f3ddfb1f-5ac2-495d-8c46-e6208b3b2f96);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_018_43f0d8cb-b202-40d6-ba66-449c7f1b4aad);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_019_4fb5ae5b-8780-4e36-8bda-c33f4698ac56);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_LairWorkshopDoor_89f3dd4f-850f-44a5-8441-42e35330a5dc);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_020_f1cff6a8-0e7f-4750-b398-0d05a1214ff1);
DB_LOW_PhilgravesMansion_LairItems((ITEM)S_LOW_PhilgravesMansion_AncientLairObject_021_73fdd8fe-7f19-4ee5-b6af-61bf42ae065c);

DB_LOW_PhilgravesMansion_DifficultyLairCurses("LOW_ANCIENTLAIR_CURSE","EASY");
DB_LOW_PhilgravesMansion_DifficultyLairCurses("LOW_ANCIENTLAIR_CURSE","MEDIUM");
DB_LOW_PhilgravesMansion_DifficultyLairCurses("LOW_ANCIENTLAIR_CURSE_HARDCORE","HARD");

//END_REGION

//Set torch in Carrion chest
ToInventory(S_UNI_LOW_TorchOfRevocation_a042774f-ae71-4d19-9554-ba90cf34d046, S_LOW_PhilgravesMansion_ClientChest_ee7e8c08-5359-4cc2-932a-42edd01c4de6,1,0,0);
SetFlag((FLAG)LOW_PhilgravesMansion_TorchIsInChest_177f5f22-0fd8-4e31-8949-cb8cf45f0dfa);

PROC_SetOnStage(S_LOW_NoteFromThrumbo_c1fb827d-eb8c-4898-8d3b-32281695a682,0);
PROC_SetOnStage(S_LOW_CarrionThreat_2ae36508-b040-4292-843d-b5939285435e,0);
PROC_SetOnStage(S_LOW_ThrumboRing_15edfd0b-ae2a-4ce5-8369-748070746713,0);

DB_SpotPlayers((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e, "LOW_PhilgravesMansion_CarrionSpotted", NULL_00000000-0000-0000-0000-000000000000, (FLAG)LOW_PhilgravesMansion_State_CarrionNotSpotting_223ba810-bd5e-4a07-801b-2a84c8eedd04);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e, "LOW_PhilgravesMansion_CarrionSpotted", (TRIGGER)LOW_PhilgravesMansion_MainHallTrigger_97b50e48-fc3e-435c-a3ba-2745eb733f2e);
Open((ITEM)S_LOW_AncientLairEntranceDoor_13b8694c-dd66-486d-8487-3e7561e0ba21);

DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_PhilgravesMansion_AngryFatherCarrion_f1c37076-434c-a441-d6ec-0f0827f97ed2);

DB_PreventPermaDefeated(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e);

DB_Dialogs(S_LOW_FatherCarrion_CoffinMummy_000_d03067ac-43a7-435b-be97-558065b1f7d1,(DIALOGRESOURCE)LOW_PhilgravesMansion_CoffinMummy_000_5aadf206-e35a-4a08-3fec-9d1c0bfef808);
DB_Dialogs(S_LOW_FatherCarrion_CoffinMummy_001_f7e60433-053d-4735-b542-658397785f7a,(DIALOGRESOURCE)LOW_PhilgravesMansion_CoffinMummy_001_1f905333-6dbe-170e-058e-48803196ca32);
DB_Dialogs(S_LOW_FatherCarrion_CoffinMummy_002_2bb0196b-9bd6-4eb3-989f-29d14a8cd2d8,(DIALOGRESOURCE)LOW_PhilgravesMansion_CoffinMummy_002_7dd9b447-3245-f1d2-32b5-604891e23409);
DB_Dialogs(S_LOW_FatherCarrion_CoffinMummy_003_1ada20fe-49b1-4663-a832-0e2c7126907d,(DIALOGRESOURCE)LOW_PhilgravesMansion_CoffinMummy_003_1eb7ebed-5659-10ea-d9e8-cabdf6a09c08);
DB_Dialogs(S_LOW_FatherCarrion_CoffinMummy_004_ca673f78-bf5a-4170-9a3d-86956fd7320b,(DIALOGRESOURCE)LOW_PhilgravesMansion_CoffinMummy_004_46d3bf88-3980-126f-7ace-e70ae3658aed);
DB_Dialogs(S_LOW_FatherCarrion_CoffinMummy_005_9ede4829-ec97-40b6-ac1c-ef14b9c6d14a,(DIALOGRESOURCE)LOW_PhilgravesMansion_CoffinMummy_005_de579c75-7fd7-5c4f-7832-f36c24e9168b);
DB_Dialogs(S_LOW_FatherCarrion_CoffinMummy_006_e6bd5cec-2691-4dc4-99ae-2461c87bb6ba,(DIALOGRESOURCE)LOW_PhilgravesMansion_CoffinMummy_006_3c872b31-e6fb-891a-1566-6c75cac67ba5);
DB_Dialogs(S_LOW_FatherCarrion_Ghoul_000_d8141d00-5f80-4245-9a48-fe3651be6954,(DIALOGRESOURCE)LOW_PhilgravesMansion_CarrionGhoul_000_874a2940-42d6-0557-a06d-4e3a3aee1f6b);
DB_Dialogs(S_LOW_FatherCarrion_Ghoul_001_ea1e4956-140f-4dda-a0eb-211744ec3fd0,(DIALOGRESOURCE)LOW_PhilgravesMansion_CarrionGhoul_001_2985a732-1084-d784-f850-7d2872c6dd6b);
DB_Dialogs(S_LOW_FatherCarrion_Ghoul_002_f0f2dbe1-d72b-48b0-9e9f-8a47ab189cfa,(DIALOGRESOURCE)LOW_PhilgravesMansion_CarrionGhoul_002_d3f42ced-8f2f-ac11-11fd-d984bd613ea7);
DB_Dialogs(S_LOW_FatherCarrion_Ghoul_003_08bfd546-b2c2-461d-83e5-fc86160b3bfc,(DIALOGRESOURCE)LOW_PhilgravesMansion_CarrionGhoul_003_412aa655-c826-4ed9-019f-c09378776d59);
DB_Dialogs(S_LOW_FatherCarrion_Ghoul_004_bbc46971-3203-44b2-8582-b8822b1d5d70,(DIALOGRESOURCE)LOW_PhilgravesMansion_CarrionGhoul_004_9ace1117-027d-891c-7982-bc9d6df5657a);

DB_GLO_CharacterCorpseDialog(S_LOW_DeadAdventurer_001_98f5af07-74fb-49ae-be05-3834e0a23464, (DIALOGRESOURCE)LOW_PhilgravesMansion_DeadAdventurer_Dead_219fa9ed-e842-ecf0-b64b-15097fb0db7b);

DB_HasItemEvent((ITEM)S_LOW_UNI_CarrionJar_Lungs_cc6570db-e584-4ba1-a162-7a5419c887f8, (FLAG)LOW_PhilgravesMansion_State_HasLungs_2e069f6f-27cb-4646-a3b5-ab559216b18e);
DB_HasItemEvent((ITEM)S_LOW_UNI_CarrionJar_Liver_add49a50-6200-4430-9f28-e4fe79e45a48, (FLAG)LOW_PhilgravesMansion_State_HasLiver_ed2cbee5-58d3-40ed-b81c-48b3689327c9);
DB_HasItemEvent((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492, (FLAG)LOW_PhilgravesMansion_State_HasHeart_22154967-9777-4149-bbae-216409fea025);
DB_HasItemEvent((ITEM)S_LOW_UNI_CarrionJar_Brain_d4c6be37-524a-43cd-ad45-4fc9b68cf531, (FLAG)LOW_PhilgravesMansion_State_HasBrain_2de27cfc-fc18-4db0-abe6-b7f6f6d6b2a2);
DB_HasItemEvent((ITEM)S_LOW_ThrumboRing_15edfd0b-ae2a-4ce5-8369-748070746713, (FLAG)LOW_PhilgravesMansion_State_HasThrumboRing_38b11f4b-ac6c-4861-8648-0d40f8c83cd0);

DB_LOW_PhilgravesMansion_CarrionBuffs("LOW_PHILGRAVESMANSION_CANOPICAURA_HEART",(ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492); 
DB_LOW_PhilgravesMansion_CarrionBuffs("LOW_PHILGRAVESMANSION_CANOPICAURA_LIVER",(ITEM)S_LOW_UNI_CarrionJar_Liver_add49a50-6200-4430-9f28-e4fe79e45a48); 
DB_LOW_PhilgravesMansion_CarrionBuffs("LOW_PHILGRAVESMANSION_CANOPICAURA_BRAIN",(ITEM)S_LOW_UNI_CarrionJar_Brain_d4c6be37-524a-43cd-ad45-4fc9b68cf531); 
DB_LOW_PhilgravesMansion_CarrionBuffs("LOW_PHILGRAVESMANSION_CANOPICAURA_LUNGS",(ITEM)S_LOW_UNI_CarrionJar_Lungs_cc6570db-e584-4ba1-a162-7a5419c887f8); 

DB_Dialogs((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,(DIALOGRESOURCE)LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b);
DB_Dialogs((CHARACTER)S_LOW_Ghast_48d8e43e-e5d1-4ae4-bd14-8208bdacb21b,(DIALOGRESOURCE)LOW_PhilgravesMansion_Ghast_c6d694f1-0da7-d86c-819d-4ebc8feddb54);
DB_Dialogs((CHARACTER)S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa,(DIALOGRESOURCE)LOW_PhilgravesMansion_ZombieBeggar_Morbus_f975f719-21d3-fea9-4147-c58f3b313473);
DB_Dialogs((CHARACTER)S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460,(DIALOGRESOURCE)LOW_PhilgravesMansion_ZombieBeggar_Sacrum_020e39c8-6fb2-9d3d-4432-5b5d23366339);
DB_Dialogs((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,(DIALOGRESOURCE)LOW_PhilgravesMansion_Thrumbo_eaa15ff1-12c2-a8fe-657e-b0e83d779339);
DB_Dialogs((CHARACTER)S_LOW_ChildTalkingToMorbus_1218e27d-368b-4a97-8a53-623b53848c4f,(DIALOGRESOURCE)LOW_PhilgravesMansion_MorbusGirl_3ac05ccf-b963-f9b2-1941-134fda9b8f4b);
DB_Dialogs((CHARACTER)S_LOW_LumbarAttacker_1f9a18a4-a5a1-4204-8857-7c9977e96bff,(DIALOGRESOURCE)LOW_PhilgravesMansion_LumbarAttacker_13ebe2ec-2700-226b-7b12-f7c0e35a4241);
DB_Dialogs((CHARACTER)S_LOW_SacrumVignetteCivilian_c2fdc5ab-ddc4-446a-9151-fee891eff6d0, (DIALOGRESOURCE)LOW_PhilgravesMansion_SacrumVignetteCivilian_f907866b-d8b7-de2c-7caf-bab15656c2f4);
DB_Dialogs((CHARACTER)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,(DIALOGRESOURCE)LOW_PhilgravesMansion_Lumbar_5b26d0e7-ee4f-efd7-4c1b-6f9b90293d5e);

DB_LOW_PhilgravesMansion_LeavingTriggers((CHARACTER)S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa, (TRIGGER)S_LOW_DissapearToTrigger_Morbus_707c94ad-30ca-4f4c-8a82-52420eb7b215);
DB_LOW_PhilgravesMansion_LeavingTriggers((CHARACTER)S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460,(TRIGGER)S_LOW_DissapearToTrigger_Sacrum_1300acc5-f6c2-4f8b-a83c-1ab27f9ef659);
DB_LOW_PhilgravesMansion_LeavingTriggers((CHARACTER)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,(TRIGGER)S_LOW_DissapearToTrigger_Lumbar_ec9c25e9-b7f3-461a-a41d-471a00d9bbfd);
DB_LOW_PhilgravesMansion_LeavingTriggers((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,(TRIGGER)S_LOW_DissapearToTrigger_Thrumbo_139a1c6f-1b14-47e1-9a4e-276f56cb96d2);

DB_PermaDefeatedFlag((CHARACTER)S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa, (FLAG)LOW_Morbus_State_IsPermaDefeated_8adaebc8-e85c-4d20-88a0-38b39eae8d5a);
DB_PermaDefeatedFlag((CHARACTER)S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460, (FLAG)LOW_Sacrum_State_IsPermaDefeated_f7be2a58-3487-4933-a9b1-f5eaeb0a0f8b);
DB_PermaDefeatedFlag((CHARACTER)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4, (FLAG)LOW_Lumbar_State_IsPermaDefeated_ba898ac2-6eb5-4462-a314-e941bf005848);
DB_PermaDefeatedFlag((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, (FLAG)LOW_Thrumbo_State_IsPermaDefeated_21e2f143-abef-45fa-a29c-6eb91491b9ec);
DB_DeadOnceFlag(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,(FLAG)LOW_FatherCarrion_State_HasBeenKilled_34a30ab8-c0e4-44a1-b2b4-31a5cc65bcea);
DB_DeadStateFlag(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,(FLAG)LOW_FatherCarrion_State_IsTempDefeated_56356b1f-9ddc-4d34-a22b-3b92dc2b6e8b);

DB_DialogMoneyTransfer(1, LOW_PhilgravesMansion_ZombieBeggar_Morbus_f975f719-21d3-fea9-4147-c58f3b313473, 50);
DB_DialogMoneyTransfer(2, LOW_PhilgravesMansion_ZombieBeggar_Morbus_f975f719-21d3-fea9-4147-c58f3b313473, 100);
DB_DialogMoneyTransfer(1, LOW_PhilgravesMansion_ZombieBeggar_Sacrum_020e39c8-6fb2-9d3d-4432-5b5d23366339, 50);
DB_DialogMoneyTransfer(2, LOW_PhilgravesMansion_ZombieBeggar_Sacrum_020e39c8-6fb2-9d3d-4432-5b5d23366339, 100);
DB_DialogMoneyTransfer(1, LOW_BaldursMouth_SkaraiBervos_5b26d0e7-ee4f-efd7-4c1b-6f9b90293d5e, 50);
DB_DialogMoneyTransfer(2, LOW_BaldursMouth_SkaraiBervos_5b26d0e7-ee4f-efd7-4c1b-6f9b90293d5e, 100);
DB_DialogMoneyTransfer(1, LOW_PhilgravesMansion_ThrumboInsideHouse_149b5744-5f7a-154b-87d0-ac1f54a02b6c, 20);
DB_DialogMoneyTransfer(2, LOW_PhilgravesMansion_ThrumboInsideHouse_149b5744-5f7a-154b-87d0-ac1f54a02b6c, 40);

//1 - Seance price no discount
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b, 1500, 2, 1);
//1 - Seance price discount
DB_DialogMoneyTransfer(2, (DIALOGRESOURCE)LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b, 1000, 2, 1);
//3 - small bonus after blackmailing for heart 
DB_DialogMoneyTransfer(3,(DIALOGRESOURCE)LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b,500,1);

//4 - price of the torch
DB_DialogMoneyTransfer(4, (DIALOGRESOURCE)LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b, 3000, 2, 1);

DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_PhilgravesMansion_ZombieBeggar_Sacrum_020e39c8-6fb2-9d3d-4432-5b5d23366339, 5, 2, 1);
DB_DialogMoneyTransfer(2, (DIALOGRESOURCE)LOW_PhilgravesMansion_ZombieBeggar_Sacrum_020e39c8-6fb2-9d3d-4432-5b5d23366339, 100, 2, 1);
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_PhilgravesMansion_Lumbar_5b26d0e7-ee4f-efd7-4c1b-6f9b90293d5e, 15, 2, 1);


DB_HasItemEvent((ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507,(FLAG)LOW_PhilgravesMansion_State_PlayerHasNecromancyOfThay_32fe3265-f672-4846-9b56-7400f66c899f);
DB_HasItemEvent((ITEM)S_LOW_LetterFatherCarrion_c4aae84c-c9b5-4941-a94f-c5c8ead07205,(FLAG)LOW_PhilgravesMansion_State_PlayerHasLetter_6e10c2c4-0d6d-4709-8b02-a92fc277a15f);

DB_GiveItemToEvent((ITEM)S_UNI_LOW_TorchOfRevocation_a042774f-ae71-4d19-9554-ba90cf34d046,(FLAG)LOW_FatherCarrion_Event_GiveTorch_93398704-3e10-4515-9996-5b42cb917f53);
DB_GiveItemToEvent((ITEM)S_LOW_LetterFatherCarrion_c4aae84c-c9b5-4941-a94f-c5c8ead07205,(FLAG)Debug_LOW_PhilgravesMansion_GetLetterFatherCarrion_63062d16-ac9f-48f9-8687-be13b90ae13c);
DB_GiveItemToEvent((ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507,(FLAG)Debug_LOW_PhilgravesMansion_GiveNecromancyOfThay_84bd0fe3-0fb6-4269-9c1b-67551756831f);
DB_GiveItemToEvent((ITEM)S_LOW_ThrumboRing_15edfd0b-ae2a-4ce5-8369-748070746713,(FLAG)LOW_Thrumbo_Event_GiveRing_8cd84b82-c06b-4dce-a551-8674bf30f7ea);

PROC_TriggerRegisterForPlayers((TRIGGER)LOW_PhilgravesMansion_MainHallTrigger_97b50e48-fc3e-435c-a3ba-2745eb733f2e);
PROC_TriggerRegisterForPlayers((TRIGGER)LOW_PhilgravesMansion_LigusTrigger_5f95560a-4d59-469e-978b-26b59bebff05);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_TriggerEntranceDoor_3ecec798-f164-47c7-9e1a-8f1c4eeba7ba);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_PhilgravesMansion_BasementRegionTrigger_17a71a2b-98b2-470d-bb7b-f8cfeda2d4dc);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_PhilgravesMansion_AncientLairRegion_ec10580c-2e07-4eb1-8465-a648183ccaea);

DB_ItemDialog_NarratorAD((ITEM)S_LOW_TabletAncientLair_001_a1285a32-8b20-45a1-bf26-1807242e91c3, (DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_AncientLairTablet_001_85b9f0ed-c647-2b65-7a63-225cb3f02111);

DB_LOW_PhilgravesMansion_ZombieBeggars((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb);
DB_LOW_PhilgravesMansion_ZombieBeggars((CHARACTER)S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa);
DB_LOW_PhilgravesMansion_ZombieBeggars((CHARACTER)S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460);
DB_LOW_PhilgravesMansion_ZombieBeggars((CHARACTER)S_LOW_BaldursMouth_SkaraiBervos_cc4b66fb-a789-472d-8d23-ad3380215ca4);

DB_LOW_PhilgravesMansion_BasementDropZombies((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,(TRIGGER)S_LOW_BasementZombieDropPosition_000_8acce947-e8bb-401e-94e9-4a068326be2d);
DB_LOW_PhilgravesMansion_BasementDropZombies((CHARACTER)S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa,(TRIGGER)S_LOW_BasementZombieDropPosition_001_c52260ff-1ed3-4e25-b88d-06f967f8b391);
DB_LOW_PhilgravesMansion_BasementDropZombies((CHARACTER)S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460,(TRIGGER)S_LOW_BasementZombieDropPosition_002_4ba44985-ee72-4b43-a4db-afd855268001);
DB_LOW_PhilgravesMansion_BasementDropZombies((CHARACTER)S_LOW_BaldursMouth_SkaraiBervos_cc4b66fb-a789-472d-8d23-ad3380215ca4,(TRIGGER)S_LOW_BasementZombieDropPosition_003_8351fc4f-8288-4eef-b97a-be40bc9986a4);

DB_LOW_PhilgravesMansion_Jars((ITEM)S_LOW_UNI_CarrionJar_Brain_d4c6be37-524a-43cd-ad45-4fc9b68cf531);
DB_LOW_PhilgravesMansion_Jars((ITEM)S_LOW_UNI_CarrionJar_Liver_add49a50-6200-4430-9f28-e4fe79e45a48);
DB_LOW_PhilgravesMansion_Jars((ITEM)S_LOW_UNI_CarrionJar_Lungs_cc6570db-e584-4ba1-a162-7a5419c887f8);
DB_LOW_PhilgravesMansion_Jars((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492);

//DB_PhilgravesMansion_JarBasementLocation(_Jar, _Location)
DB_PhilgravesMansion_JarBasementLocation((ITEM)S_LOW_UNI_CarrionJar_Liver_add49a50-6200-4430-9f28-e4fe79e45a48,(TRIGGER)S_LOW_JarBasementLocation_Liver_239dc974-d8d6-4c1f-8e7b-8412cfef4c89);
DB_PhilgravesMansion_JarBasementLocation((ITEM)S_LOW_UNI_CarrionJar_Lungs_cc6570db-e584-4ba1-a162-7a5419c887f8,(TRIGGER)S_LOW_JarBasementLocation_Lungs_6604044d-3c7b-4de3-8d69-3ced43c290ae);
DB_PhilgravesMansion_JarBasementLocation((ITEM)S_LOW_UNI_CarrionJar_Brain_d4c6be37-524a-43cd-ad45-4fc9b68cf531,(TRIGGER)S_LOW_JarBasementLocation_Brain_34b7fa14-ed4e-4ed7-8477-077c91c4bd28);
DB_PhilgravesMansion_JarBasementLocation((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492,(TRIGGER)S_LOW_JarBasementLocation_Heart_68eec807-9a0b-412e-b30e-0e75dbc551f5);

PROC_SetOnStage(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,0);

SetFlag((FLAG)LOW_PhilgravesMansion_State_ZombieInOriginalLocation_0c1ac3f8-ce83-40b2-bcff-9ea7572bd983, S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa);
SetFlag((FLAG)LOW_PhilgravesMansion_State_ZombieInOriginalLocation_0c1ac3f8-ce83-40b2-bcff-9ea7572bd983, S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460);
SetFlag((FLAG)LOW_PhilgravesMansion_State_ZombieInOriginalLocation_0c1ac3f8-ce83-40b2-bcff-9ea7572bd983, S_LOW_BaldursMouth_SkaraiBervos_cc4b66fb-a789-472d-8d23-ad3380215ca4);

DB_LOW_PhilgravesMansion_CarrionCoffins((ITEM)LOW_ZombieCoffin_000_df6939ee-d2e9-4aff-81d4-6c46b6aedaef,(CHARACTER)S_LOW_FatherCarrion_CoffinMummy_000_d03067ac-43a7-435b-be97-558065b1f7d1,(DIALOGRESOURCE)LOW_PhilgravesMansion_AD_MummyAwakened_000_9dd5a3e1-1720-c624-a55d-58155ccbc990);
DB_LOW_PhilgravesMansion_CarrionCoffins((ITEM)LOW_ZombieCoffin_001_77849166-fdb7-4439-b424-ea6369d13a97,(CHARACTER)S_LOW_FatherCarrion_CoffinMummy_001_f7e60433-053d-4735-b542-658397785f7a,(DIALOGRESOURCE)LOW_PhilgravesMansion_AD_MummyAwakened_001_19ae2276-7a65-130a-e012-666946daa068);
DB_LOW_PhilgravesMansion_CarrionCoffins((ITEM)LOW_ZombieCoffin_002_c66e2e13-41b6-40fc-9fe6-c97246b020bd,(CHARACTER)S_LOW_FatherCarrion_CoffinMummy_002_2bb0196b-9bd6-4eb3-989f-29d14a8cd2d8,(DIALOGRESOURCE)LOW_PhilgravesMansion_AD_MummyAwakened_002_da25b5b4-6351-72a3-b2ba-06a510b1017e);
DB_LOW_PhilgravesMansion_CarrionCoffins((ITEM)LOW_ZombieCoffin_003_3056e5d8-5166-4263-bf83-5e630bd4bcaa,(CHARACTER)S_LOW_FatherCarrion_CoffinMummy_003_1ada20fe-49b1-4663-a832-0e2c7126907d,(DIALOGRESOURCE)LOW_PhilgravesMansion_AD_MummyAwakened_003_fd0c81f3-1c97-2c43-2bc2-e239b5d3d877);
DB_LOW_PhilgravesMansion_CarrionCoffins((ITEM)LOW_ZombieCoffin_004_33a119e2-2d37-4606-91e0-2b8181544b25,(CHARACTER)S_LOW_FatherCarrion_CoffinMummy_004_ca673f78-bf5a-4170-9a3d-86956fd7320b,(DIALOGRESOURCE)LOW_PhilgravesMansion_AD_MummyAwakened_004_8f07a175-3605-c102-dd7f-0910df2accee);
DB_LOW_PhilgravesMansion_CarrionCoffins((ITEM)LOW_ZombieCoffin_005_6770bb1b-b7a6-40f8-adce-d6b5d739bf57,(CHARACTER)S_LOW_FatherCarrion_CoffinMummy_005_9ede4829-ec97-40b6-ac1c-ef14b9c6d14a,(DIALOGRESOURCE)LOW_PhilgravesMansion_AD_MummyAwakened_005_bcf9d823-3ab5-8d11-9ea3-96e11e1b46c1);
DB_LOW_PhilgravesMansion_CarrionCoffins((ITEM)LOW_ZombieCoffin_006_1ad93cb6-1d93-4083-9934-aefbd87a0181,(CHARACTER)S_LOW_FatherCarrion_CoffinMummy_006_e6bd5cec-2691-4dc4-99ae-2461c87bb6ba,(DIALOGRESOURCE)LOW_PhilgravesMansion_AD_MummyAwakened_006_1eba4de1-cf8d-b92c-cad9-42752e23eea5);

//Trigger, NPC1, NPC2, Dialog
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers((TRIGGER)S_LOW_MorbusAndGirlTrigger_d896a41f-394f-479e-9e12-db24959d86e8,(CHARACTER)S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa,(CHARACTER)S_LOW_ChildTalkingToMorbus_1218e27d-368b-4a97-8a53-623b53848c4f,(DIALOGRESOURCE)LOW_PhilgravesMansion_AD_MorbusAndGirl_6dfbfa58-54dd-b254-2533-aca632376860);
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers((TRIGGER)S_LOW_LumbarBeatingTrigger_aac37b70-327c-4097-8f9c-97d762002e85,(CHARACTER)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,(CHARACTER)S_LOW_LumbarAttacker_1f9a18a4-a5a1-4204-8857-7c9977e96bff,(DIALOGRESOURCE)LOW_PhildravesMansion_AD_LumbarPreBeating_19676a7d-bae5-f015-8a87-09ebd10bbcf6);
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers((TRIGGER)S_LOW_SacrumVignetteTrigger_116787bd-ad1e-4071-bacf-7a3cc718200e,(CHARACTER)S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460,(CHARACTER)S_LOW_SacrumVignetteCivilian_c2fdc5ab-ddc4-446a-9151-fee891eff6d0,(DIALOGRESOURCE)LOW_PhilgravesMansion_AD_SacrumVignette_c62a26e1-d66d-f289-cd20-f94b7bbab8b8);
DB_OneShotPlayerTrigger((TRIGGER)S_LOW_PhilgravesLarderTrigger_362d5da1-7b69-485e-a7a6-65e5277dc9dd);
DB_NoLowAttitudeDialog(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e);
PROC_LOW_PhilgravesMansion_SetOneShots();
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_CoffinMummy_000_d03067ac-43a7-435b-be97-558065b1f7d1);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_CoffinMummy_001_f7e60433-053d-4735-b542-658397785f7a);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_CoffinMummy_002_2bb0196b-9bd6-4eb3-989f-29d14a8cd2d8);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_CoffinMummy_003_1ada20fe-49b1-4663-a832-0e2c7126907d);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_CoffinMummy_004_ca673f78-bf5a-4170-9a3d-86956fd7320b);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_CoffinMummy_005_9ede4829-ec97-40b6-ac1c-ef14b9c6d14a);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_CoffinMummy_006_e6bd5cec-2691-4dc4-99ae-2461c87bb6ba);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_Ghoul_000_d8141d00-5f80-4245-9a48-fe3651be6954);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_Ghoul_001_ea1e4956-140f-4dda-a0eb-211744ec3fd0);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_Ghast_48d8e43e-e5d1-4ae4-bd14-8208bdacb21b);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_Ghoul_002_f0f2dbe1-d72b-48b0-9e9f-8a47ab189cfa);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_Ghoul_003_08bfd546-b2c2-461d-83e5-fc86160b3bfc);
DB_LOW_PhilgravesMansion_CarrionMinions((CHARACTER)S_LOW_FatherCarrion_Ghoul_004_bbc46971-3203-44b2-8582-b8822b1d5d70);

DB_LOW_PhilgravesMansion_CheckpointGuards((CHARACTER)S_LOW_FatherCarrion_Ghast_48d8e43e-e5d1-4ae4-bd14-8208bdacb21b);
DB_LOW_PhilgravesMansion_CheckpointGuards((CHARACTER)S_LOW_FatherCarrion_Ghoul_001_ea1e4956-140f-4dda-a0eb-211744ec3fd0);
DB_LOW_PhilgravesMansion_CheckpointGuards((CHARACTER)S_LOW_FatherCarrion_Ghoul_002_f0f2dbe1-d72b-48b0-9e9f-8a47ab189cfa);
DB_LOW_PhilgravesMansion_CheckpointGuards((CHARACTER)S_LOW_FatherCarrion_Ghoul_003_08bfd546-b2c2-461d-83e5-fc86160b3bfc);
DB_LOW_PhilgravesMansion_CheckpointGuards((CHARACTER)S_LOW_FatherCarrion_Ghoul_004_bbc46971-3203-44b2-8582-b8822b1d5d70);

PROC_LOW_PhilgravesMansion_InitCoffinMinions();
PROC_LOW_PhilgravesMansion_InitJars();

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_PhilgravesMansion_Jars",(FLAG)LOW_FatherCarrion_State_AllJarsDestroyed_a915bde9-1c3b-469c-8a75-ce761f8f30e4);

DB_LOW_PhilgravesMansion_ZombieBeggarsMeetingLocations((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, (TRIGGER)S_LOW_ThrumboLocation_a1f7a6d1-d3af-4fcd-a69c-7d6812ba2c50, (FLAG)Debug_Teleport_LOW_ZombieBeggarPosition1_c8637295-a337-42d8-a057-856c567dbfc3);
DB_LOW_PhilgravesMansion_ZombieBeggarsMeetingLocations((CHARACTER)S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa, (TRIGGER)S_LOW_ZombieFinalLocation_001_92862dbd-f6cb-45bc-a386-7e8a8695febf,(FLAG)Debug_Teleport_LOW_ZombieBeggarPosition2_33d4df0d-3fc0-450d-ab22-83b7452d807e);
DB_LOW_PhilgravesMansion_ZombieBeggarsMeetingLocations((CHARACTER)S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460, (TRIGGER)S_LOW_ZombieFinalLocation_002_dd688b62-cdb3-4cd0-8068-0342fe302045,(FLAG)Debug_Teleport_LOW_ZombieBeggarPosition3_bfaa0136-0852-4981-8bbe-42ea550ddd74);
DB_LOW_PhilgravesMansion_ZombieBeggarsMeetingLocations((CHARACTER)S_LOW_BaldursMouth_SkaraiBervos_cc4b66fb-a789-472d-8d23-ad3380215ca4, (TRIGGER)S_LOW_ZombieFinalLocation_003_86e27bec-b55f-4f17-9066-2d431163b156,(FLAG)Debug_Teleport_LOW_ZombieBeggarPosition4_58f819a5-0cc6-44c0-af71-e4a32f73fcc0);

DB_LOW_PhilgravesMansion_ZombieBeggarsInsideHouseLocations((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, (TRIGGER)S_LOW_InsideHouse_Thrumbo_a605f958-a726-431c-b90a-30dc8ac6a8c9);
DB_LOW_PhilgravesMansion_ZombieBeggarsInsideHouseLocations((CHARACTER)S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa, (TRIGGER)S_LOW_InsideHouse_Morbus_55b9d90b-8274-42fd-9447-cef8f81c8c71);
DB_LOW_PhilgravesMansion_ZombieBeggarsInsideHouseLocations((CHARACTER)S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460, (TRIGGER)S_LOW_InsideHouse_Sacrum_40b59685-951a-4409-9406-1fd3c1597f66);
DB_LOW_PhilgravesMansion_ZombieBeggarsInsideHouseLocations((CHARACTER)S_LOW_BaldursMouth_SkaraiBervos_cc4b66fb-a789-472d-8d23-ad3380215ca4, (TRIGGER)S_LOW_InsideHouse_Skarai_a4b07289-2d59-4e52-88b0-22d1aa65c873);

DB_GLO_DefeatCounter(S_LOW_ZombieBeggar_001_3bca7480-e42d-4c3f-aa12-2b03a03064aa, "LOW_PhilgravesMansion_AllBeggarsButThrumbo");
DB_GLO_DefeatCounter(S_LOW_ZombieBeggar_002_d4ff4e8c-7788-408b-a9ee-ee5e6a27b460, "LOW_PhilgravesMansion_AllBeggarsButThrumbo");
DB_GLO_DefeatCounter(S_LOW_BaldursMouth_SkaraiBervos_cc4b66fb-a789-472d-8d23-ad3380215ca4, "LOW_PhilgravesMansion_AllBeggarsButThrumbo");

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_PhilgravesMansion_AllBeggarsButThrumbo",(FLAG)LOW_PhilgravesMansion_State_AllZombiesPermaDefeated_e938c802-ee1b-4e15-87b1-d44ae67ec589);

DB_GLO_DefeatCounter(S_LOW_Ghast_48d8e43e-e5d1-4ae4-bd14-8208bdacb21b, "LOW_PhilgravesMansion_UpperFloorEnemies");
DB_GLO_DefeatCounter(S_LOW_FatherCarrion_Ghoul_001_ea1e4956-140f-4dda-a0eb-211744ec3fd0, "LOW_PhilgravesMansion_UpperFloorEnemies");
DB_GLO_DefeatCounter(S_LOW_FatherCarrion_Ghoul_002_f0f2dbe1-d72b-48b0-9e9f-8a47ab189cfa, "LOW_PhilgravesMansion_UpperFloorEnemies");

DB_GLO_DefeatCounter_AllDeadGlobalFlag("LOW_PhilgravesMansion_UpperFloorEnemies",(FLAG)LOW_PhilgravesMansion_State_AllUpperFloorEnemiesDead_2ef71980-faae-49d0-8bd6-affa8b4164a5);
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_PhilgravesMansion_UpperFloorEnemies",(FLAG)LOW_PhilgravesMansion_State_AllUpperFloorEnemiesPermaDefeated_04f8421c-896e-4fc0-8da2-358abf2cb2b3);

DB_CheckPoint(
(CHARACTER)S_LOW_Ghast_48d8e43e-e5d1-4ae4-bd14-8208bdacb21b, 
(CHARACTER)S_LOW_FatherCarrion_Ghoul_002_f0f2dbe1-d72b-48b0-9e9f-8a47ab189cfa, 
(TRIGGER)S_LOW_CheckpointPhilgravesPrimary_979cabfa-019e-4cef-88b8-7ce8f94f7dbb, 
(TRIGGER)S_LOW_CheckpointPhilgravesWarning_1e1e5fd6-c745-42f4-a334-a631592e4e15,
(TRIGGER)S_LOW_CheckpointPhilgravesTrespass_eaf77afe-232f-4b01-8b7b-e28f09ef01d4,
"S_LOW_PhilgravesMansionCheckpoint",
(FLAG)LOW_PhilgravesMansion_State_CheckpointGivenAccess_0cd65e38-ca07-44c3-a225-19365ff5c483, "LOW_PhilgravesMansion_Trespassing", (TRIGGER)S_LOW_CheckpointPhilgravesOutTrigger_5e7d879d-0ee7-47ff-858d-5410e902a799 );

DB_PerceptionSkillCustomAD((ITEM)S_LOW_BeggarsPortrait_9e5d743a-f00e-4d5c-93ff-272b9a895c15, (DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_SucceededPerceptionPortrait_41852fb3-a558-5995-16cc-9ac05c1047f2);
DB_PerceptionSkillCustomAD((ITEM)S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00, (DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_AlarmDoorRevealed_4e0c6bf8-d336-2c20-7842-a47319e8b33c);

DB_PermaDefeatedFlag(S_LOW_FatherCarrion_Ghast_48d8e43e-e5d1-4ae4-bd14-8208bdacb21b,(FLAG)LOW_PhilgravesMansion_State_GhastIsPermadefeated_925e603a-9238-4cbb-a931-bc9938fd9227);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Thrumbo_Event_ThrowUp_6e4e32f8-312b-4bfc-bd46-15af3831a1b5, (DIALOGRESOURCE)LOW_PhilgravesMansion_Thrumbo_eaa15ff1-12c2-a8fe-657e-b0e83d779339);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Thrumbo_Event_ThrowUpNearMansion_b122a9c2-002e-4d89-ae81-0a6c7094540e,(DIALOGRESOURCE)LOW_PhilgravesMansion_ThrumboHouse_f6455bc1-4c42-e798-8730-61b6433fca65);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_PhilgravesMansion_Event_OpenMagicDoor_020ec7ce-3094-4f4d-bebe-51d298a10128,(DIALOGRESOURCE)LOW_PhilgravesMansion_DoorInteraction_fee7f153-a59f-5734-1745-4e131fb862e9);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_PhilgravesMansion_State_CheckpointGivenAccess_0cd65e38-ca07-44c3-a225-19365ff5c483,(DIALOGRESOURCE)LOW_PhilgravesMansion_Ghast_c6d694f1-0da7-d86c-819d-4ebc8feddb54);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Thrumbo_Event_RunAfterBetrayal_00d54df6-0fe7-45c5-b794-e7b326f97ad2,(DIALOGRESOURCE)LOW_PhilgravesMansion_Thrumbo_eaa15ff1-12c2-a8fe-657e-b0e83d779339);

DB_QuestDef_State((FLAG)LOW_FatherCarrion_State_ExplainedTask_f77ed6af-3076-43da-9a68-1d83edf9068d, "LOW_PhilgravesMansion", "Carrion_ExplainedTask");
DB_QuestDef_State((FLAG)LOW_FatherCarrion_State_PlayersAcceptedTask_318caac3-8dba-4f13-b1ad-02f847715231, "LOW_PhilgravesMansion", "Carrion_AcceptedTask");
DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_State_ReadThrumboNote_2e0a5f21-a80c-4e6b-852b-dad97ac47f19, "LOW_PhilgravesMansion", "BeggarNoteRead");
DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_Event_SendThrumboTorsoToChest_d3ff1c4d-8ed9-494b-bcaa-6bcb9bfc3c61, "LOW_PhilgravesMansion", "Carrion_GaveCorpse");
DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_Event_SendHeartToChest_c3117ba0-ab0c-40f1-a73a-516af03c44a6, "LOW_PhilgravesMansion", "Carrion_GaveJar");
DB_QuestDef_State((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac, "LOW_PhilgravesMansion", "CarrionFullyKilled");
DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_State_ReadBasementLetter_9bbb0551-5ec6-44a1-b826-67a14bbd5409, "LOW_PhilgravesMansion", "ReadBasementBook");
DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44, "LOW_PhilgravesMansion", "HeartDestroyed");
DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_Event_SendHeartToChest_c3117ba0-ab0c-40f1-a73a-516af03c44a6, "LOW_PhilgravesMansion", "HeartGiven");
DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_State_FoundThrumbo_14d2ebc7-b98f-456a-b7f0-cb73ec788826, "LOW_PhilgravesMansion", "FoundThrumbo");

DB_QuestDef_State_ConditionalFlag((FLAG)LOW_PhilgravesMansion_Quest_ReadJarDiagrams_9d307fd4-e5e3-430c-b617-2d208d5e1053, "LOW_PhilgravesMansion", "AncientLair_ReadBook_ThrumboDead", 1, LOW_Thrumbo_State_IsDead_21e2f143-abef-45fa-a29c-6eb91491b9ec);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_PhilgravesMansion_Quest_ReadJarDiagrams_9d307fd4-e5e3-430c-b617-2d208d5e1053, "LOW_PhilgravesMansion", "AncientLair_ReadBook_ThrumboAlive", 0, LOW_Thrumbo_State_IsDead_21e2f143-abef-45fa-a29c-6eb91491b9ec);

DB_QuestDef_BookReadState("LOW_PhilgravesMansion", "Carrion_StoleHeartFromPlayers",(ITEM)S_LOW_CarrionThreat_2ae36508-b040-4292-843d-b5939285435e);

PROC_SetOnStage(S_LOW_ThrumboDeadWarningCleaver_6e254dae-1454-4885-acd9-26bd917a9cc0,0);
PROC_SetOnStage(S_LOW_ThrumboDeadWarning_113c6cee-50d1-41f0-bedb-ebd759f2828c,0);

DB_DeadOnceFlag((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,(FLAG)LOW_Thrumbo_State_IsDead_21e2f143-abef-45fa-a29c-6eb91491b9ec);

DB_OneShotPlayerTrigger((TRIGGER)S_LOW_PhilgravesMansion_BasementRegionTrigger_17a71a2b-98b2-470d-bb7b-f8cfeda2d4dc);
DB_OneShotPlayerTrigger((TRIGGER)S_LOW_PhilgravesMansion_AncientLairRegion_ec10580c-2e07-4eb1-8465-a648183ccaea);


// Voice bark
DB_OneShot_VoiceBarkTrigger((TRIGGER)LOW_PhilgravesMansion_BadPlaceVB_Trigger_99aa70ee-ac39-480b-a686-6ab513f57483,(VOICEBARKRESOURCE)LOW_PhilgravesMansion_VB_BadPlace_5db97567-ccb6-5043-ac82-0d915e96748a);

// Ownership
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_PhilgravesMansion_Ownership_1c101e16-3568-4a76-b2ae-be54d9e807d0, (CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e);

//Transform the book into a tablet
Transform(S_LOW_CarrionJarDiagrams_c8a2228a-adff-4fcd-b60a-81f81c033e2f, (ITEMROOT)DEC_Druids_Tablet_Stone_C_27cfa136-43a4-42c4-9331-f9bce7352f8a, (SHAPESHIFTRULE)WildShapeKeepName_9c580a1d-dab9-4b17-b0da-b16c7d7360e0); 
PROC_SetInvulnerable(S_LOW_CarrionJarDiagrams_c8a2228a-adff-4fcd-b60a-81f81c033e2f,1);
KBSECTION
//REGION Debug Messages
IF
TextEvent("LOW_Philgraves_SendJarsToBasement")
THEN
PROC_LOW_PhilgravesMansion_SendAllJarsToBasement();

IF
TextEvent("LOW_Philgraves_SendGemToBasement")
THEN
SetGravity((ITEM)S_FOR_DangerousBook_Key_000_123c268d-ad0c-4df5-905b-a78dacbed80b,GRAVITYTYPE.DisabledUntilMove);
TeleportTo((ITEM)S_FOR_DangerousBook_Key_000_123c268d-ad0c-4df5-905b-a78dacbed80b,S_LOW_PhilgravesMansion_PlaceForGem_5e6f51c1-a861-493f-91e8-806c8498fa64,"",0,0,0,0,0);

IF
TextEvent("LOW_PhilgravesMansion_ResetBeggarPositions")
AND
DB_LOW_PhilgravesMansion_ZombieBeggarsMeetingLocations(_Zombie, _Location, _)
THEN
TeleportTo(_Zombie, _Location);

IF
TextEvent("LOW_PhilgravesMansion_HaveNecromancyBookNotUnlocked")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507,_Player,1,1,1);

IF
TextEvent("LOW_PhilgravesMansion_HaveNecromancyBookReady")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507,_Player,1,1,1);
SetFlag(FOR_DangerousBook_State_BookUnlocked_fd215551-a14c-8cfa-ba34-7ac32d1ada28);
SetFlag((FLAG)FOR_DangerousBook_State_BookOwner_06022678-24ed-35af-de93-bd91abc02452,_Player);
SetFlag((FLAG)FOR_DangerousBook_State_Bound_5e16d6fc-ae5c-cb6f-3a0f-4237593ee05e);
SetFlag((FLAG)FOR_DangerousBook_State_BookFinished_489a23a0-758a-97bd-bd0c-d6b417c20af3);

IF
TextEvent("LOW_PhilgravesMansion_GetLetterFatherCarrion")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_LOW_LetterFatherCarrion_c4aae84c-c9b5-4941-a94f-c5c8ead07205,_Player,1,1,1);

IF
TextEvent("LOW_PhilgravesMansion_GetCandles")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_UNI_LOW_TorchOfRevocation_a042774f-ae71-4d19-9554-ba90cf34d046,_Player,1,1,1);

IF
TextEvent("LOW_PhilgravesMansion_ZombiesGoToHouse")
THEN
PROC_SetOnStage(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,1);
Die((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e, DEATHTYPE.Physical, 0);
SetFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac);
PROC_LOW_PhilgravesMansion_ZombiesGoToHouse();

IF
TextEvent("LOW_PhilgravesMansion_ThrumboThrowUp")
THEN
ClearOwnership((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492);
ObjectTimerLaunch(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,"LOW_PhilgravesMansion_ThrowingUp",500);
PlayAnimation(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,(ANIMATION)CUST_Throw_Up_01_cf51f24c-b405-4c55-a4e9-bbaf5e210954, "LOW_PhilgravesMansion_ThrowUpAnimationDone");


//END_REGION

//REGION Debugbook Flags

IF
DB_GlobalFlag((FLAG)Debug_LOW_PhilgravesMansion_DestroyJars_de5a8e4a-8602-4ce1-82c7-bc83329412ff)
AND
DB_LOW_PhilgravesMansion_Jars(_Jar)
THEN
Die((ITEM)_Jar);

IF
DB_GlobalFlag((FLAG)Debug_LOW_PhilgravesMansion_GoToMansion_22d23237-a519-4c3a-8f3c-44e4d6066985)
THEN
PROC_LOW_PhilgravesMansion_ZombiesGoToHouse();

IF
FlagSet((FLAG)Debug_LOW_PhilgravesMansion_GetTorches_38a628a7-f686-40fd-a144-2ea23db42d29,_Player,_)
THEN
ToInventory((ITEM)S_UNI_LOW_TorchOfRevocation_a042774f-ae71-4d19-9554-ba90cf34d046,_Player,1,1,1);

IF
FlagSet((FLAG)Debug_LOW_PhilgravesMansion_GetJars_b9d66897-b7f4-4dc7-8f45-38320bbac9fb,_Player,_)
AND
DB_LOW_PhilgravesMansion_Jars(_Jar)
THEN
ToInventory((ITEM)_Jar,_Player,1,1,1);

IF
FlagSet((FLAG)Debug_LOW_PhilgravesMansion_GetFatherCarrionLetter_b8b04a6a-2c2b-4039-8e79-766db57bc1c4, _Player, _)
THEN
PROC_ToInventoryAndOnStage((ITEM)S_LOW_LetterFatherCarrion_c4aae84c-c9b5-4941-a94f-c5c8ead07205,_Player,1,1,1);

//END_REGION

//REGION Ancient Lair

IF
Saw(_Player,S_LOW_DeadAdventurer_001_98f5af07-74fb-49ae-be05-3834e0a23464,_)
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_PlayersSawLairDeadBody")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_EnteredLabAncientLair_dd0e55db-932b-37c3-1d2f-a46d88ab19e1,_Player);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_LOW_DeadAdventurer_001_98f5af07-74fb-49ae-be05-3834e0a23464, _Player)
AND
DB_Dead((CHARACTER)S_LOW_DeadAdventurer_001_98f5af07-74fb-49ae-be05-3834e0a23464)
THEN
DB_SelectedDialog(
	LOW_PhilgravesMansion_DeadAdventurer_Dead_219fa9ed-e842-ecf0-b64b-15097fb0db7b, 
	S_LOW_DeadAdventurer_001_98f5af07-74fb-49ae-be05-3834e0a23464,
_Player);

IF
UseFinished(_Player, (ITEM)S_LOW_BasementBookPhilgraves_f4180de1-823c-44f1-8995-a62de3e5f5af,1)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ReadBasementBook")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_BasementBookFound_55183485-d424-c7ac-2332-22299d722094, _Player);
SetFlag((FLAG)LOW_PhilgravesMansion_State_ReadBasementLetter_9bbb0551-5ec6-44a1-b826-67a14bbd5409);


IF
DB_LOW_PhilgravesMansion_LairItems(_Entity)
THEN
DB_LOW_PhilgravesMansion_LairEntities((GUIDSTRING)_Entity);


IF
UseStarted(_Char,_Item)
AND
DB_PartyMembers(_Char)
AND
DB_LOW_PhilgravesMansion_LairItems(_Item)
THEN
PROC_LOW_PhilgravesMansion_ProcessLairDisturbance(_Char);

IF
AttackedBy(_Target,_,_,_,_,_,_)
AND
NOT DB_LOW_PhilgravesMansion_AlarmSet(1)
AND
DB_LOW_PhilgravesMansion_LairEntities(_Target)
THEN
PROC_LOW_PhilgravesMansion_SetAlarm();

IF
MovedBy(_Item,_Char)
AND
NOT DB_LOW_PhilgravesMansion_AlarmSet(1)
AND
DB_LOW_PhilgravesMansion_LairEntities(_Item)
THEN
PROC_LOW_PhilgravesMansion_ProcessLairDisturbance(_Char);

IF
RequestCanLoot(_Char,_Entity)
AND
NOT DB_LOW_PhilgravesMansion_AlarmSet(1)
AND
DB_LOW_PhilgravesMansion_LairEntities(_Entity)
THEN
PROC_LOW_PhilgravesMansion_ProcessLairDisturbance(_Char);

PROC
PROC_CastedSpellOnTarget((GUIDSTRING)_Caster,(GUIDSTRING)_Target,(STRING)_Spell,(STRING)_SpellType,(STRING)_SpellElement,(INTEGER)_StoryActionID)
AND
NOT DB_LOW_PhilgravesMansion_AlarmSet(1)
AND
DB_PartyMembers((CHARACTER)_Caster)
AND
DB_LOW_PhilgravesMansion_LairEntities(_Target)
THEN
PROC_LOW_PhilgravesMansion_SetAlarm();

IF
AddedTo(_Entity,_Char,_)
AND
NOT DB_LOW_PhilgravesMansion_AlarmSet(1)
AND
DB_LOW_PhilgravesMansion_LairEntities(_Entity)
THEN
PROC_LOW_PhilgravesMansion_ProcessLairDisturbance((CHARACTER)_Char);

PROC
PROC_LOW_PhilgravesMansion_ProcessLairDisturbance((CHARACTER)_Char)
AND
NOT QRY_LOW_PhilgravesMansion_CheckTagsInLair((CHARACTER)_Char)
THEN
PROC_LOW_PhilgravesMansion_SetAlarm();

PROC
PROC_LOW_PhilgravesMansion_ProcessLairDisturbance((CHARACTER)_Char)
AND
NOT DB_LOW_PhilgravesMansion_ProcessingLairRoll(_Char)
AND
QRY_LOW_PhilgravesMansion_CheckTagsInLair((CHARACTER)_Char)
THEN
DB_LOW_PhilgravesMansion_ProcessingLairRoll(_Char);
RequestPassiveRoll((CHARACTER)_Char, _Char, "SavingThrow", "Wisdom", (DIFFICULTYCLASS)Act3_Hard_6298329e-255c-4826-9209-e911873b64e7, 0, "LOW_PhilgravesMansion_LairAvoidDetect");

PROC
PROC_RollResult("LOW_PhilgravesMansion_LairAvoidDetect",_,_,0)
THEN
PROC_LOW_PhilgravesMansion_SetAlarm();

PROC
PROC_RollResult("LOW_PhilgravesMansion_LairAvoidDetect",_Char,_,_)
AND
DB_LOW_PhilgravesMansion_ProcessingLairRoll(_Char)
THEN
NOT DB_LOW_PhilgravesMansion_ProcessingLairRoll(_Char);

QRY
QRY_LOW_PhilgravesMansion_CheckTagsInLair((CHARACTER)_Char)
AND
DB_LOW_PhilgravesMansion_AllowedUndeadTagsInLair(_Tag)
AND
IsTagged(_Char, _Tag, 1)
THEN
DB_NOOP(1);

PROC
PROC_LOW_PhilgravesMansion_SetAlarm()
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_SetAncientLairAlarm")
THEN
DB_LOW_PhilgravesMansion_AlarmSet(1);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_PhilgravesMansion_LairCurseArea_33383141-aa85-4b8d-9b71-86a2bb6b5f70);
PROC_ItemCloseAndLock((ITEM)S_LOW_AncientLairEntranceDoor_13b8694c-dd66-486d-8487-3e7561e0ba21,"LOW_PhilgravesMansion_LairKey");
PROC_SetRelationToPlayers((FACTION)ACT3_PhilgravesMansion_LairMummies_92f0e992-3a6b-40db-adba-eaa78f01ac17,0);
PROC_LOW_PhilgravesMansion_WakeUpLairMinions();

IF
DB_LOW_PhilgravesMansion_LairEnemies(_Enemy)
THEN
DB_LOW_PhilgravesMansion_LairEntities((GUIDSTRING)_Enemy);
TriggerRegisterForCharacter((TRIGGER)S_LOW_PhilgravesMansion_LairCurseArea_33383141-aa85-4b8d-9b71-86a2bb6b5f70,(CHARACTER)_Enemy);

PROC
PROC_LOW_PhilgravesMansion_WakeUpLairMinions()
AND
DB_LOW_PhilgravesMansion_LairEnemies(_Enemy)
AND
Random(2000,_RandomDelay)
THEN
ObjectTimerLaunch(_Enemy,"LOW_PhilgravesMansion_WakeUpLairMinion",_RandomDelay);

IF
ObjectTimerFinished(_Enemy,"LOW_PhilgravesMansion_WakeUpLairMinion")
AND
DB_InRegion((CHARACTER)_Enemy,(TRIGGER)S_LOW_PhilgravesMansion_LairCurseArea_33383141-aa85-4b8d-9b71-86a2bb6b5f70)
THEN
Resurrect((CHARACTER)_Enemy,NULL_00000000-0000-0000-0000-000000000000,1);

IF
EnteredTrigger(_PartyMember, (TRIGGER)S_LOW_PhilgravesMansion_LairCurseArea_33383141-aa85-4b8d-9b71-86a2bb6b5f70)
THEN
PROC_LOW_PhilgravesMansion_ApplyCurseCheckImmunity((CHARACTER)_PartyMember);

IF
StatusRemoved(_PartyMember,"LOW_ANCIENTLAIR_CURSE",_Cause,_ID)
AND
DB_PartyMembers((CHARACTER)_Cause)
AND
DB_InRegion((CHARACTER)_PartyMember, (TRIGGER)S_LOW_PhilgravesMansion_LairCurseArea_33383141-aa85-4b8d-9b71-86a2bb6b5f70)
AND
GetHitpoints(_PartyMember,_HP)
AND
_HP > 0
THEN
ApplyStatus(_PartyMember,"LOW_ANCIENTLAIR_CURSE_IMMUNITY",18.0);

IF
Resurrected(_PartyMember)
AND
DB_PartyMembers(_PartyMember)
AND
DB_InRegion((CHARACTER)_PartyMember, (TRIGGER)S_LOW_PhilgravesMansion_LairCurseArea_33383141-aa85-4b8d-9b71-86a2bb6b5f70)
THEN
PROC_LOW_PhilgravesMansion_ApplyCurseCheckImmunity((CHARACTER)_PartyMember);

IF
StatusRemoved(_PartyMember,"LOW_ANCIENTLAIR_CURSE_IMMUNITY",_,_ID)
AND
DB_InRegion((CHARACTER)_PartyMember, (TRIGGER)S_LOW_PhilgravesMansion_LairCurseArea_33383141-aa85-4b8d-9b71-86a2bb6b5f70)
THEN
PROC_LOW_PhilgravesMansion_ApplyCurseCheckImmunity((CHARACTER)_PartyMember);

IF
RulesetModifierChangedString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,(STRING)_OldDifficulty, (STRING)_NewDifficulty)
AND
DB_InRegion((CHARACTER)_PartyMember, (TRIGGER)S_LOW_PhilgravesMansion_LairCurseArea_33383141-aa85-4b8d-9b71-86a2bb6b5f70)
AND
NOT DB_Dead(_PartyMember)
AND
DB_LOW_PhilgravesMansion_DifficultyLairCurses(_OldStatus,_OldDifficulty)
AND
DB_LOW_PhilgravesMansion_DifficultyLairCurses(_NewStatus,_NewDifficulty)
AND
HasActiveStatus(_PartyMember,_OldStatus,1)
THEN
RemoveStatus(_PartyMember,_OldStatus);
ApplyStatus(_PartyMember, _NewStatus, -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);


IF
LeftTrigger((CHARACTER)_PartyMember, (TRIGGER)S_LOW_PhilgravesMansion_LairCurseArea_33383141-aa85-4b8d-9b71-86a2bb6b5f70)
AND
GetRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,(STRING)_Difficulty)
AND
DB_LOW_PhilgravesMansion_DifficultyLairCurses(_Status,_Difficulty)
AND
HasActiveStatus(_PartyMember,_Status,1)
THEN
RemoveStatus(_PartyMember,_Status);

PROC
PROC_LOW_PhilgravesMansion_ApplyCurseCheckImmunity((CHARACTER)_PartyMember)
AND
HasActiveStatus(_PartyMember,"LOW_ANCIENTLAIR_CURSE_IMMUNITY",0)
AND
NOT QRY_LOW_PhilgravesMansion_CheckTagsInLair((CHARACTER)_PartyMember)
AND
GetRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,(STRING)_Difficulty)
AND
DB_LOW_PhilgravesMansion_DifficultyLairCurses(_Status,_Difficulty)
AND
HasActiveStatus(_PartyMember,_Status,0)
THEN
ApplyStatus(_PartyMember,_Status,-1.0);

IF
StatusApplied(_Player, "LOW_ANCIENTLAIR_CURSE", _,_)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_AncientLairCurseReaction")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_AncientLairCurseReaction_ed8a580a-ee6b-df0c-f1cc-42c1d40b7f11,_Player);


//END_REGION

//REGION Checkpoint

IF
EnteredTrigger(_Player,(TRIGGER)LOW_PhilgravesMansion_LigusTrigger_5f95560a-4d59-469e-978b-26b59bebff05)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_CheckpointGivenAccess_0cd65e38-ca07-44c3-a225-19365ff5c483)
AND
NOT DB_PermaDefeated(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
QRY_SpeakerIsAvailable(S_LOW_FatherCarrion_Ghoul_003_08bfd546-b2c2-461d-83e5-fc86160b3bfc)
AND
CanSee(S_LOW_FatherCarrion_Ghoul_003_08bfd546-b2c2-461d-83e5-fc86160b3bfc,_Player,1)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_PhilgravesMansion_CarrionGhoul_003_412aa655-c826-4ed9-019f-c09378776d59,S_LOW_FatherCarrion_Ghoul_003_08bfd546-b2c2-461d-83e5-fc86160b3bfc,_Player)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)LOW_PhilgravesMansion_Event_TeleportOutsideCheckpoint_b1e385fd-9e3e-4323-a908-bd651d5f9fe2,_Player,_)
THEN
TeleportTo(_Player,S_LOW_CheckpointPhilgravesOutTrigger_5e7d879d-0ee7-47ff-858d-5410e902a799,"",1,1,1,0,1);


IF
Opened((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_StreetDoorOpenedOrDestroyed_92ff7268-c049-43f7-9731-89200c439afb);

IF
DestroyedBy((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,_,_,_)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_StreetDoorOpenedOrDestroyed_92ff7268-c049-43f7-9731-89200c439afb);

IF
Closed((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab)
THEN
ClearFlag((FLAG)LOW_PhilgravesMansion_State_StreetDoorOpenedOrDestroyed_92ff7268-c049-43f7-9731-89200c439afb);


//Secondary guard
PROC
PROC_CheckPointDialogue((CHARACTER)_Player, (CHARACTER)S_LOW_FatherCarrion_Ghoul_002_f0f2dbe1-d72b-48b0-9e9f-8a47ab189cfa)
AND
QRY_StartCheckpointWarningDialog(
	"S_LOW_PhilgravesMansionCheckpoint",
	(DIALOGRESOURCE)LOW_PhilgravesMansion_GhoulWarning_43b3341c-cb5c-fb39-f7dd-5465c38c37cb, 
	(CHARACTER)S_LOW_FatherCarrion_Ghoul_002_f0f2dbe1-d72b-48b0-9e9f-8a47ab189cfa, _Player)
THEN
DB_NOOP(1);

PROC
PROC_CheckPointDialogue((CHARACTER)_Player, (CHARACTER)S_LOW_FatherCarrion_Ghast_48d8e43e-e5d1-4ae4-bd14-8208bdacb21b)
AND
QRY_StartCheckpointWarningDialog(
	"S_LOW_PhilgravesMansionCheckpoint",
	(DIALOGRESOURCE)LOW_PhilgravesMansion_Ghast_c6d694f1-0da7-d86c-819d-4ebc8feddb54, 
	(CHARACTER)S_LOW_FatherCarrion_Ghast_48d8e43e-e5d1-4ae4-bd14-8208bdacb21b, 
	_Player)
THEN
DB_NOOP(1);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_PhilgravesMansion_State_CheckpointGivenAccess_0cd65e38-ca07-44c3-a225-19365ff5c483)
THEN
ClearOwnership((ITEM)S_Lever_FirstFloorPhilgraveDoor_A_0c176205-625d-4c4d-8eb9-7a1c98a356a9);
ClearOwnership((ITEM)S_LOW_FirstFloorPhilgravesDoor_0c989650-9ac2-4737-ac95-2f9f573d133a);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_PhilgravesMansion_State_CheckpointGivenAccess_0cd65e38-ca07-44c3-a225-19365ff5c483)
AND
DB_LOW_PhilgravesMansion_CheckpointGuards(_Guard)
THEN
PROC_PeacefulResolve(_Guard);

IF
DB_PlayerTrespassing(_Player,_,(TRIGGER)S_LOW_CheckpointPhilgravesTrespass_8c7d5e5c-398e-47f5-8f1f-7a5d74ccc65b)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrionUpperFloor_1d746532-eee0-4ea7-a7fa-09fbddb84f94,0);

IF
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_AllUpperFloorEnemiesPermaDefeated_04f8421c-896e-4fc0-8da2-358abf2cb2b3)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_CheckpointGivenAccess_0cd65e38-ca07-44c3-a225-19365ff5c483);

//END_REGION

//REGION Coffins and Minions

PROC
PROC_LOW_PhilgravesMansion_InitCoffinMinions()
AND
DB_LOW_PhilgravesMansion_CarrionCoffins(_Coffin,_Minion,_)
THEN
PROC_SetOnStage(_Minion,0);
PROC_SetOnStage(_Coffin,1);

IF
UseStarted(_,_Coffin)
AND
DB_LOW_PhilgravesMansion_CarrionCoffins(_Coffin,_,_)
THEN
Die(_Coffin);

IF
DestroyedBy(_Coffin,_,_,_)
AND
DB_LOW_PhilgravesMansion_CarrionCoffins(_Coffin,_Minion,_AD)
AND
IsOnStage(_Minion, 0)
THEN
TeleportTo(_Minion,_Coffin);
PROC_Foop(_Minion);
PROC_TryStartAD((DIALOGRESOURCE)_AD,_Minion);


PROC
PROC_LOW_PhilgravesMansion_ExplodeCoffins()
AND
DB_LOW_PhilgravesMansion_CarrionCoffins(_Coffin,_Minion,_)
AND
IsOnStage(_Minion, 0)
THEN
Die(_Coffin);
TeleportTo(_Minion,_Coffin,"",0,0,0,0,1);
PROC_Foop(_Minion);


//END_REGION

//REGION Magic door

IF
UseFinished(_Player,(ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,0)
AND
DB_Players(_Player)
AND
IsLocked((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,1)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_PhilgravesMansion_DoorInteraction_fee7f153-a59f-5734-1745-4e131fb862e9, S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,_Player)
THEN
DB_NOOP(1);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_TriggerEntranceDoor_3ecec798-f164-47c7-9e1a-8f1c4eeba7ba)
AND
DB_Players(_Player)
AND
GetCanInteract((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,0)
AND
GetFlag((FLAG)LOW_PhilgravesMansion_PlayerHasLetter_6e10c2c4-0d6d-4709-8b02-a92fc277a15f,_Player,1)
THEN
SetCanInteract(S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,1);
PROC_PlayPerceptionRevealEffect(S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab, "", 6000);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_TriggerEntranceDoor_3ecec798-f164-47c7-9e1a-8f1c4eeba7ba)
AND
DB_Players(_Player)
AND
NOT DB_LOW_PhilgravesMansion_AttemptedPerceptionStreetDoor(_Player)
AND
GetCanInteract((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,0)
AND
NOT GetFlag((FLAG)LOW_PhilgravesMansion_PlayerHasLetter_6e10c2c4-0d6d-4709-8b02-a92fc277a15f,_Player,1)
THEN
DB_LOW_PhilgravesMansion_AttemptedPerceptionStreetDoor(_Player);
RequestPassiveRoll(_Player, S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab, "SkillCheck", "Perception", (DIFFICULTYCLASS)DC_Legacy_15_625be976-7a67-4394-97c8-14c69715ae4b, 0, "LOW_PhilgravesMansion_PerceptionStreetDoor");

PROC
PROC_RollResult("LOW_PhilgravesMansion_PerceptionStreetDoor", _Player, (ITEM)_StreetDoor, 1)
THEN
SetCanInteract(S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,1);
PROC_PlayPerceptionRevealEffect(S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab, "LOW_PhilgravesMansion_PerceptionStreetDoor");

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_PhilgravesMansion_Event_OpenMagicDoor_020ec7ce-3094-4f4d-bebe-51d298a10128)
THEN
SetCanInteract(S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,1);
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_MagicDoor_AD_2d8a4178-1fb7-b062-4f5d-5a9a8f2afdf0,S_LOW_PhilgraesMansion_MagicDoorHelper_26c8f01f-eeda-45ad-8485-ddf9bce08209);
PROC_ItemUnlockAndOpen((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab);

IF
UseStarted(_Player, (ITEM)S_LOW_DoorLever_e1b2ef3a-ad17-48ad-a643-f1c10474fd68)
AND
IsLocked((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,1)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab);

PROC
PROC_LOW_Philgraves_OpenOrCloseDoor((ITEM)_Door, (ITEM)_Lever)
AND
IsClosed((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,1)
THEN
PlayAnimation(_Lever, OBJ_Open_Unused_01_1c8ad609-f780-418e-9fdf-c52f6d749c9f, "");
Open(_Door);

PROC
PROC_LOW_Philgraves_OpenOrCloseDoor((ITEM)_Door, (ITEM)_Lever)
AND
IsOpened((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,1)
THEN
PlayAnimation(_Lever, OBJ_Close_Unused_01_a7078367-8eed-4ba7-a436-196774f68a60, "");
Close(_Door);

IF
UseStarted(_Player, (ITEM)S_LOW_DoorLever_e1b2ef3a-ad17-48ad-a643-f1c10474fd68)
THEN
PROC_LOW_Philgraves_OpenOrCloseDoor((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab, (ITEM)S_LOW_DoorLever_e1b2ef3a-ad17-48ad-a643-f1c10474fd68);



//END_REGION

//REGION Zombie Beggars

//REGION Thrumbo initial state
IF
CharacterLootedCharacter(_Player,(CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_FirstSawHeart")
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_SeenHeart_1afe634c-dc0e-432b-b19c-231cfcffe4fe);

IF
DestroyedBy((ITEM)S_LOW_ThrumboWardrobe_360023df-ad20-483d-a6ad-5543db21d902, _Attacker,_AttackerOwner,_)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ThrumboLeaveSpot")
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_Quest_FoundThrumbo_14d2ebc7-b98f-456a-b7f0-cb73ec788826);
PROC_SetOnStage(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,1);
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,"LOW_PhilgravesMansion_ThrumboReadyToLeaveCloset");

IF
UseStarted(_Player,(ITEM)S_LOW_ThrumboWardrobe_360023df-ad20-483d-a6ad-5543db21d902)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ThrumboLeaveSpot")
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_Quest_FoundThrumbo_14d2ebc7-b98f-456a-b7f0-cb73ec788826);
PROC_SetOnStage(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,1);
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,"LOW_PhilgravesMansion_ThrumboReadyToLeaveCloset");

PROC
PROC_ReadyToMoveOn(_Thrumbo,"LOW_PhilgravesMansion_ThrumboReadyToLeaveCloset")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_AD_ThrumboLeftCloset_909f9840-ca35-bcd7-3df0-82ab0f83b747,S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb);
PROC_CharacterMoveTo(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, S_LOW_ThrumboJump_59becc5d-09b5-4df0-9667-190fd8b9f32c, "Run", "LOW_PhilgravesMansion_ThrumboLeftCloset");

IF
EntityEvent(_Thrumbo, "LOW_PhilgravesMansion_ThrumboLeftCloset")
AND
QRY_SpeakerIsAvailable(_Thrumbo)
AND
QRY_LOW_PhilgravesMansion_FindSpeakerForThrumbo()
AND
DB_QRYRTN_LOW_PhilgravesMansion_FindSpeakerForThrumbo(_Player)
AND
QRY_StartDialog(LOW_PhilgravesMansion_Thrumbo_eaa15ff1-12c2-a8fe-657e-b0e83d779339, _Thrumbo, _Player)
THEN
DB_NOOP(1);

QRY
QRY_LOW_PhilgravesMansion_FindSpeakerForThrumbo()
AND
NOT DB_QRYRTN_LOW_PhilgravesMansion_FindSpeakerForThrumbo(_)
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb)
THEN
DB_QRYRTN_LOW_PhilgravesMansion_FindSpeakerForThrumbo((CHARACTER)_Player);


IF
DialogEnded((DIALOGRESOURCE)LOW_PhilgravesMansion_Thrumbo_eaa15ff1-12c2-a8fe-657e-b0e83d779339,_)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ThrumboDialogEnded")
THEN
SetFlag((FLAG)LOW_Thrumbo_Event_StopHiding_9f4d1064-e5b9-41b1-969a-8ee9886eb07c);

QRY
QRY_StartDialogFailed((DIALOGRESOURCE)LOW_PhilgravesMansion_Thrumbo_eaa15ff1-12c2-a8fe-657e-b0e83d779339,_,_,_,_,_,_)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ThrumboDialogEnded")
THEN
SetFlag((FLAG)LOW_Thrumbo_Event_StopHiding_9f4d1064-e5b9-41b1-969a-8ee9886eb07c);


//END_REGION

//REGION Vignettes
PROC
PROC_LOW_PhilgravesMansion_SetOneShots()
AND
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers(_Trigger,_,_,_)
THEN
DB_OneShotPlayerTrigger(_Trigger);

PROC
PROC_OneShotTriggerEntered(_Player, _Trigger)
AND
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers(_Trigger, _NPC1, _NPC2, _Dialog)
AND
NOT DB_PermaDefeated(_NPC1)
AND
NOT DB_DialogNPCs(_,_NPC1,_)
AND
NOT DB_PermaDefeated(_NPC2)
AND
NOT DB_DialogNPCs(_,_NPC2,_)
THEN
PROC_TryStartAD((DIALOGRESOURCE)_Dialog,_NPC1,_NPC2);

IF
AutomatedDialogRequestFailed(_Dialog,_)
AND
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers(_,_Zombie,_,_Dialog)
THEN
SetEntityEvent(_Zombie,"LOW_PhilgravesMansion_EndedInitialScene");

IF
AutomatedDialogEnded(_Dialog,_)
AND
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers(_,_Zombie,_,_Dialog)
AND
_Zombie != S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4
THEN
SetEntityEvent(_Zombie,"LOW_PhilgravesMansion_EndedInitialScene");

IF
DialogEnded((DIALOGRESOURCE)LOW_PhilgravesMansion_LumbarAttacker_13ebe2ec-2700-226b-7b12-f7c0e35a4241,_)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_StartBeating")
THEN
PROC_LOW_PhilgravesMansion_StartBeating();



//REGION Lumbar


IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_PhilgravesMansion_AD_LumbarPreBeating_19676a7d-bae5-f015-8a87-09ebd10bbcf6,_)
THEN
PROC_LOW_PhilgravesMansion_StartBeating();

PROC
PROC_LOW_PhilgravesMansion_StartBeating()
THEN
PROC_SelfHealing_Disable((CHARACTER)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4);
DB_LOW_PhilgravesMansion_BeatingActive(1);
DB_LOW_PhilgravesMansion_LumbarPunchesLeft(4);
PROC_LOW_PhilgravesMansion_PunchLumbar();

QRY
QRY_LOW_PhilgravesMansion_CheckDoBeating()
AND
NOT DB_Is_InCombat(S_LOW_LumbarAttacker_1f9a18a4-a5a1-4204-8857-7c9977e96bff,_)
AND
NOT DB_Is_InCombat(S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,_)
AND
NOT DB_Defeated(S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4)
AND
NOT DB_Defeated(S_LOW_LumbarAttacker_1f9a18a4-a5a1-4204-8857-7c9977e96bff)
THEN
DB_NOOP(1);

PROC
PROC_LOW_PhilgravesMansion_PunchLumbar()
AND
NOT QRY_LOW_PhilgravesMansion_CheckDoBeating()
THEN
PROC_PhilgravesMansion_StopBeatingLumbar();

PROC
PROC_LOW_PhilgravesMansion_PunchLumbar()
AND
NOT DB_LOW_PhilgravesMansion_WaitingToLeaveBeating(_)
AND
QRY_LOW_PhilgravesMansion_CheckDoBeating()
AND
DB_LOW_PhilgravesMansion_LumbarPunchesLeft(_PunchesLeft)
AND
DB_LOW_PhilgravesMansion_BeatingActive(1)
AND
IntegerSubtract(_PunchesLeft,1,_PunchesRemaining)
AND
_PunchesRemaining > 0
THEN
NOT DB_LOW_PhilgravesMansion_LumbarPunchesLeft(_PunchesLeft);
DB_LOW_PhilgravesMansion_LumbarPunchesLeft(_PunchesRemaining);
UseSpell(S_LOW_LumbarAttacker_1f9a18a4-a5a1-4204-8857-7c9977e96bff, "Target_UnarmedAttack", S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4);

PROC
PROC_LOW_PhilgravesMansion_PunchLumbar()
AND
DB_LOW_PhilgravesMansion_LumbarPunchesLeft(_PunchesLeft)
AND
DB_LOW_PhilgravesMansion_BeatingActive(1)
AND
IntegerSubtract(_PunchesLeft,1,_PunchesRemaining)
AND
_PunchesRemaining <= 0
THEN
PROC_PhilgravesMansion_StopBeatingLumbar();

PROC
PROC_PhilgravesMansion_StopBeatingLumbar()
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_StopBeating")
THEN
NOT DB_LOW_PhilgravesMansion_BeatingActive(1);
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhildravesMansion_AD_PostLumbarBeating_7994d3ba-9de9-ce11-274d-a6ce2e70562d, S_LOW_LumbarAttacker_1f9a18a4-a5a1-4204-8857-7c9977e96bff, S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4);
PROC_SelfHealing_Enable((CHARACTER)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4);

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_PhildravesMansion_AD_PostLumbarBeating_7994d3ba-9de9-ce11-274d-a6ce2e70562d,_)
THEN
PROC_LOW_PhilgravesMansion_EndLumbarVignette();

IF
AutomatedDialogRequestFailed((DIALOGRESOURCE)LOW_PhildravesMansion_AD_PostLumbarBeating_7994d3ba-9de9-ce11-274d-a6ce2e70562d,_)
THEN
PROC_LOW_PhilgravesMansion_EndLumbarVignette();

PROC
PROC_LOW_PhilgravesMansion_EndLumbarVignette()
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_LumbarBeatingDone_6aa92ecb-8f64-4b85-899a-039518d60c07);
SetEntityEvent((CHARACTER)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,"LOW_PhilgravesMansion_EndedInitialScene");
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_LumbarAttacker_1f9a18a4-a5a1-4204-8857-7c9977e96bff, S_LOW_LumbarAttackerLeaveTrigger_03750117-a17e-45e4-a0d8-6773761d1d4c, "Walk", 0, "");

IF
DialogStarted((DIALOGRESOURCE)LOW_PhilgravesMansion_Lumbar_5b26d0e7-ee4f-efd7-4c1b-6f9b90293d5e,_)
AND
DB_LOW_PhilgravesMansion_BeatingActive(1)
THEN
PROC_PhilgravesMansion_StopBeatingLumbar();

IF
DialogStarted((DIALOGRESOURCE)LOW_PhilgravesMansion_LumbarAttacker_13ebe2ec-2700-226b-7b12-f7c0e35a4241,_)
AND
NOT DB_LOW_PhilgravesMansion_WaitingToLeaveBeating(1)
THEN
DB_LOW_PhilgravesMansion_WaitingToLeaveBeating(1);

IF
DialogEnded((DIALOGRESOURCE)LOW_PhilgravesMansion_LumbarAttacker_13ebe2ec-2700-226b-7b12-f7c0e35a4241,_)
AND
DB_LOW_PhilgravesMansion_WaitingToLeaveBeating(1)
THEN
NOT DB_LOW_PhilgravesMansion_WaitingToLeaveBeating(1);
PROC_SelfHealing_Enable((CHARACTER)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4);
NOT DB_LOW_PhilgravesMansion_BeatingActive(1);
PROC_LOW_PhilgravesMansion_EndLumbarVignette();

PROC
PROC_CastedSpellOnTarget((GUIDSTRING)S_LOW_LumbarAttacker_1f9a18a4-a5a1-4204-8857-7c9977e96bff,(GUIDSTRING)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,"Target_UnarmedAttack",(STRING)_SpellType,(STRING)_SpellElement,(INTEGER)_StoryActionID)
THEN
TimerLaunch("LOW_PhilgravesMansion_WaitForNextLumbarPunch",3000);

IF
TimerFinished("LOW_PhilgravesMansion_WaitForNextLumbarPunch")
THEN
PROC_LOW_PhilgravesMansion_PunchLumbar();

IF
UsingSpellOnTarget((CHARACTER)_Player,(CHARACTER)S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,"Target_UnarmedAttack",_,_,_ID)
AND
DB_PartyMembers((CHARACTER)_Player)
THEN
DB_LOW_PhilgravesMansion_LumbarPunch_Player(_ID);

IF
DB_LOW_PhilgravesMansion_LumbarPunch_Player(_ID)
AND
NOT DB_GlobalFlag(LOW_PhilgravesMansion_LumbarBeatingDone_6aa92ecb-8f64-4b85-899a-039518d60c07)
THEN
NOT DB_LOW_PhilgravesMansion_BeatingActive(1);
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_LumbarAttacker_1f9a18a4-a5a1-4204-8857-7c9977e96bff, S_LOW_LumbarAttackerLeaveTrigger_03750117-a17e-45e4-a0d8-6773761d1d4c, "Run", 0, "");
SetFlag((FLAG)LOW_PhilgravesMansion_LumbarBeatingDone_6aa92ecb-8f64-4b85-899a-039518d60c07);

QRY
QRY_CRIME_BlockRegisterCrime(_Player,_CrimeType,_StoryID,_Evidence,S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,_CrimeID)
AND
QRY_CRIME_IsCrimeFamilyMember(_CrimeType, "Assault")
THEN
NOT DB_LOW_PhilgravesMansion_LumbarPunch_Player(_StoryID);
SetFlag((FLAG)LOW_Lumbar_State_PunchedByPlayer_e015603e-28d1-1efd-4cc7-3702638d6963,_Player);
PROC_LOW_PhilgravesMansion_LumbarReactToPlayerPunch(_Player);

IF
ObjectTimerFinished(_Player,"LOW_PhilgravesMansion_LumbarRecoverTimer")
THEN
NOT DB_LOW_PhilgravesMansion_RecoverTimer(_Player);

IF
FlagSet((FLAG)LOW_PhilgravesMansion_PaidLumbar_9599f39c-7ed3-8976-4932-a2348b55784c, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
SetDualEntityEvent(S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4, _Player, "LOW_Lumbar_PlayerPaid", 1);

PROC
PROC_LOW_PhilgravesMansion_LumbarReactToPlayerPunch((GUIDSTRING)_Player)
AND
GetFlag((FLAG)LOW_PhilgravesMansion_PaidLumbar_9599f39c-7ed3-8976-4932-a2348b55784c,_Player,0)
AND
GetFlag((FLAG)LOW_Lumbar_NextPunchWillBeHostile_01fee4d2-74ab-4d00-a8b8-d447c02f2a95,_Player,0)
AND
NOT DB_LOW_PhilgravesMansion_RecoverTimer(_Player)
THEN
PROC_ForceStopDialog(S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4);
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_AD_LumbarReactionAfterPunch_NoPay_fad9ed9c-f59b-74d3-bd5e-00393305cca1,S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,_Player);

PROC
PROC_LOW_PhilgravesMansion_LumbarReactToPlayerPunch((GUIDSTRING)_Player)
AND
NOT DB_LOW_PhilgravesMansion_RecoverTimer(_Player)
AND
GetFlag((FLAG)LOW_PhilgravesMansion_PaidLumbar_9599f39c-7ed3-8976-4932-a2348b55784c,_Player,0)
AND
GetFlag((FLAG)LOW_Lumbar_NextPunchWillBeHostile_01fee4d2-74ab-4d00-a8b8-d447c02f2a95,_Player,1)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_PhilgravesMansion_Lumbar_036304f6-bbd9-46fb-879c-fc4408eed63d,0);

PROC
PROC_LOW_PhilgravesMansion_LumbarReactToPlayerPunch((GUIDSTRING)_Player)
AND
NOT DB_LOW_PhilgravesMansion_RecoverTimer(_Player)
AND
GetFlag((FLAG)LOW_PhilgravesMansion_PaidLumbar_9599f39c-7ed3-8976-4932-a2348b55784c,_Player,1)
THEN
ClearFlag((FLAG)LOW_PhilgravesMansion_PaidLumbar_9599f39c-7ed3-8976-4932-a2348b55784c,_Player);
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_AD_LumbarReactionAfterPunch_d0889c69-aa30-18d2-560c-5fcdb364be3a,S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4,_Player);
SetDualEntityEvent(S_LOW_Lumbar_cc4b66fb-a789-472d-8d23-ad3380215ca4, _Player, "LOW_Lumbar_PlayerAttacked", 1);

PROC
PROC_LOW_PhilgravesMansion_LumbarReactToPlayerPunch((GUIDSTRING)_Player)
AND
NOT DB_LOW_PhilgravesMansion_RecoverTimer(_Player)
THEN
DB_LOW_PhilgravesMansion_RecoverTimer(_Player);
ObjectTimerLaunch(_Player,"LOW_PhilgravesMansion_LumbarRecoverTimer",500);

//END_REGION


//END_REGION

IF
FlagSet((FLAG)LOW_PhilgravesMansion_State_HasHeart_22154967-9777-4149-bbae-216409fea025, S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,_)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_HeartInThrumbosInventory_46beba15-84e7-47ac-bc46-922cf0345b1a);

IF
FlagCleared((FLAG)LOW_PhilgravesMansion_State_HasHeart_22154967-9777-4149-bbae-216409fea025, S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,_)
THEN
ClearFlag((FLAG)LOW_PhilgravesMansion_State_HeartInThrumbosInventory_46beba15-84e7-47ac-bc46-922cf0345b1a);

IF
MovedFromTo((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492, S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, _,_)
AND
IsDead((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,0)
THEN
Die((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, DEATHTYPE.Physical, 0);


//REGION Moving between Initial position, meeting, outside house and inside house

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_Thrumbo_Event_ThrowUp_6e4e32f8-312b-4bfc-bd46-15af3831a1b5)
AND
NOT DB_PermaDefeated(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb)
THEN
DB_LOW_PhilgravesMansion_HasSeenHeart(1);
ClearOwnership((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492);
ObjectTimerLaunch(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,"LOW_PhilgravesMansion_ThrowingUp",500);
PlayAnimation(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,(ANIMATION)CUST_Throw_Up_01_cf51f24c-b405-4c55-a4e9-bbaf5e210954, "LOW_PhilgravesMansion_ThrowUpAnimationDone");

IF
ObjectTimerFinished(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, "LOW_PhilgravesMansion_ThrowingUp")
THEN
DB_LOW_PhilgravesMansion_ReadyToTeleport(1);
//Send anubis event to find location for jar in front of zombie
SetFlag((FLAG)LOW_Thrumbo_Event_TeleportJarFromThrumbo_504e5385-96bd-4215-85de-22b81374382c);


//React to the jar being moved after anubis event
IF
ItemTeleported(S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492, _,_,_,_,_,_)
AND
DB_LOW_PhilgravesMansion_ReadyToTeleport(1)
AND
GetPosition(S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492,_X,_Y,_Z)
THEN
NOT DB_LOW_PhilgravesMansion_ReadyToTeleport(1);
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_ZombieBeggarsVomit_AD_0eb35eb5-79ce-3343-076c-f731ee4fc36e,S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb);
PlayEffectAtPosition((EFFECTRESOURCE)VFX_Script_LOW_HAG_BlushingMermaid_Vomit_01_44647e59-07b5-9678-6989-a08aa59c4ba2,_X,_Y,_Z,1.0);
SetFlag((FLAG)LOW_PhilgravesMansion_State_SeenHeart_1afe634c-dc0e-432b-b19c-231cfcffe4fe);
QuestUpdate("LOW_PhilgravesMansion", "Thrumbo_ThrowUp");

IF
AttackedBy(S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492, _,_,_,_,_,_)
AND
CanSee(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492,1)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ThrumboReactToAttackedJar")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_ThrumboJarAttack_AD_2890a536-064b-1186-f2d6-e1f557f763e5, S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb);

PROC
PROC_LOW_PhilgravesMansion_ChangeFactionUndeads()
AND
DB_LOW_PhilgravesMansion_CarrionMinions(_Undead)
THEN
SetFaction(_Undead,(FACTION)ACT3_LOW_PhilgravesMansion_Beggars_ccd1d57e-f358-4608-94e0-114dd2b552bb);

PROC
PROC_LOW_PhilgravesMansion_ChangeFactionUndeads()
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_CheckpointGivenAccess_0cd65e38-ca07-44c3-a225-19365ff5c483);


PROC
PROC_ReadyToMoveOn(_Zombie, "LOW_PhilgravesMansion_ZombieGoingToHouse")
AND
DB_LOW_PhilgravesMansion_ZombieBeggarsInsideHouseLocations(_Zombie, _Location)
THEN
ClearFlag((FLAG)LOW_PhilgravesMansion_State_ZombieOutsideHouse_c8999882-566e-40b5-9e44-eff82249850b,_Zombie);
PROC_CharacterMoveTo(_Zombie,_Location,"Run","LOW_PhilgravesMansion_ZombieInstalledInHouse");


PROC
PROC_SpotPlayers_Spotted(_Thrumbo,"LOW_PhilgravesMansion_ThrumboWantsToThank",_Player)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_PhilgravesMansion_ThrumboInsideHouse_149b5744-5f7a-154b-87d0-ac1f54a02b6c, S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, _Player)
THEN
DB_NOOP(1);

IF
DialogStarted((DIALOGRESOURCE)LOW_PhilgravesMansion_ThrumboInsideHouse_149b5744-5f7a-154b-87d0-ac1f54a02b6c,_)
THEN
PROC_SpotPlayers_StopSpotting("LOW_PhilgravesMansion_ThrumboWantsToThank");

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_PhilgravesMansion_AD_BeggarsConversationEndState_3be8f5f2-3c49-facf-2e1e-727e2510e794,_ID)
AND
DB_LOW_PhilgravesMansion_ZombieBeggars(_Zombie)
AND
_Zombie != S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb
AND
QRY_SpeakerIsAvailable(_Zombie)
THEN
PROC_DialogAddSpeakingActor(_ID,_Zombie);

//END_REGION

IF
DB_LOW_PhilgravesMansion_ZombieBeggars(_Zombie)
THEN
DB_NoLowAttitudeDialog(_Zombie);

IF
DB_Is_InCombat(_Zombie,_ID)
AND
DB_LOW_PhilgravesMansion_ZombieBeggars((CHARACTER)_Zombie)
AND
DB_Is_InCombat(_Player,_ID)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_BeggarAngryAtPlayers_6c6c3e32-8f04-4cb7-a2a6-9b6881391834)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_PhilgravesMansion_BeggarAngryAtPlayers_6c6c3e32-8f04-4cb7-a2a6-9b6881391834);

//Zombie is unactive - Dissapear/appear out ofsight towards meeting

PROC
PROC_LOW_PhilgravesMansion_ZombiesGoToHouse()
AND
DB_LOW_PhilgravesMansion_ZombieBeggars(_Zombie)
AND
GetFaction(_Zombie,_Faction)
AND
GetRelation((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, _Faction,_Relation)
AND
_Relation < 50
THEN
PROC_SetRelationToPlayers(_Faction, 50);

PROC
PROC_LOW_PhilgravesMansion_ZombiesGoToHouse()
AND
DB_LOW_PhilgravesMansion_ZombieBeggars(_Zombie)
AND
NOT DB_PermaDefeated(_Zombie)
AND
IsActive(_Zombie,1)
THEN
TriggerRegisterForCharacter((TRIGGER)S_LOW_TriggerEntranceDoor_3ecec798-f164-47c7-9e1a-8f1c4eeba7ba,_Zombie);
ClearFlag((FLAG)LOW_PhilgravesMansion_State_ZombieInOriginalLocation_0c1ac3f8-ce83-40b2-bcff-9ea7572bd983,_Zombie);
SetFlag((FLAG)LOW_PhilgravesMansion_ZombieMoving_9fa1155b-8a73-4cd2-8344-ae7faa34cbbb,_Zombie);

IF
EnteredTrigger(_Zombie,(TRIGGER)S_LOW_TriggerEntranceDoor_3ecec798-f164-47c7-9e1a-8f1c4eeba7ba)
AND
DB_LOW_PhilgravesMansion_ZombieBeggars(_Zombie)
THEN
TriggerUnregisterForCharacter((TRIGGER)S_LOW_TriggerEntranceDoor_3ecec798-f164-47c7-9e1a-8f1c4eeba7ba,_Zombie);
SetFlag((FLAG)LOW_PhilgravesMansion_State_ZombieInHouse_1b0c0656-5d5a-4d4a-89cd-83949b09dd98,_Zombie);

IF
EntityEvent(_Zombie, "LOW_PhilgravesMansion_ZombieGoToHouse")
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_ZombieMoving_9fa1155b-8a73-4cd2-8344-ae7faa34cbbb,_Zombie);

PROC
PROC_LOW_PhilgravesMansion_ZombiesGoToHouse()
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ChangeFactionUndeads")
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_ZombiesMastersOfHouse_d1fe7420-0244-48dd-a726-e98c9e130ac9);
PROC_LOW_PhilgravesMansion_ChangeFactionUndeads();


//Zombie is unactive - Dissapear/appear out ofsight towards meeting
PROC
PROC_LOW_PhilgravesMansion_ZombiesGoToHouse()
AND
DB_LOW_PhilgravesMansion_LeavingTriggers(_Zombie, _Location)
AND
NOT DB_PermaDefeated(_Zombie)
AND
IsActive(_Zombie,0)
THEN
ClearFlag((FLAG)LOW_PhilgravesMansion_State_ZombieInOriginalLocation_0c1ac3f8-ce83-40b2-bcff-9ea7572bd983,_Zombie);
PROC_DisappearOutOfSightTo((CHARACTER)_Zombie,_Location,"Run",0,"LOW_PhilgravesMansion_ZombieLeftInitialPosition");

//Appear in meeting out of sight
IF
EntityEvent(_Zombie, "LOW_PhilgravesMansion_ZombieLeftInitialPosition")
AND
Random(6000, _RandomTime)
THEN
ObjectTimerLaunch(_Zombie, "LOW_PhilgravesMansion_WaitingBeforeAppearingInHouse", _RandomTime, 0);

IF
ObjectTimerFinished(_Zombie, "LOW_PhilgravesMansion_WaitingBeforeAppearingInHouse")
AND
DB_LOW_PhilgravesMansion_ZombieBeggarsInsideHouseLocations((CHARACTER)_Zombie,(TRIGGER)_Location)
THEN
TriggerRegisterForCharacter((TRIGGER)S_LOW_TriggerEntranceDoor_3ecec798-f164-47c7-9e1a-8f1c4eeba7ba,_Zombie);
PROC_AppearOutOfSightTo((CHARACTER)_Zombie, S_LOW_OutOfSightHouseTrigger_bcca2908-f0f5-40a6-852e-8b27d9bbd95c, _Location, "LOW_PhilgravesMansion_ZombieGoToHouse");

//Thrumbo is killed before carrion is fully killed - other beggars will disappear
IF
DB_GlobalFlag((FLAG)LOW_Thrumbo_State_IsDead_21e2f143-abef-45fa-a29c-6eb91491b9ec)
AND
NOT DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac)
THEN
PROC_LOW_PhilgravesMansion_RemoveAllBeggars();

PROC
PROC_LOW_PhilgravesMansion_RemoveAllBeggars()
AND
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers(_Trigger,_Zombie,_Civilian,_Dialog)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);
PROC_LOW_PhilgravesMansion_RemoveCharacter(_Zombie,"Run");
PROC_LOW_PhilgravesMansion_RemoveCharacter(_Civilian,"Walk");
NOT DB_LOW_PhilgravesMansion_BeggarOneShotTriggers(_Trigger,_Zombie,_Civilian,_Dialog);

PROC
PROC_LOW_PhilgravesMansion_RemoveCharacter((CHARACTER)_Char,(STRING)_Speed)
AND
IsOnStage(_Char,1)
AND
NOT DB_PermaDefeated(_Char)
THEN
PROC_DisappearOutOfSight((CHARACTER)_Char,_Speed,0,"LOW_PhilgravesMansion_CharLeavesPermanently");

IF
EntityEvent(_Thrumbo,"LOW_PhilgravesMansion_StartBeggarConversation")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_AD_BeggarsConversationEndState_3be8f5f2-3c49-facf-2e1e-727e2510e794,_Thrumbo);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_Thrumbo_Event_RunAfterBetrayal_00d54df6-0fe7-45c5-b794-e7b326f97ad2)
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,"LOW_PhilgravesMansion_ThrumboRunsOffstage");

PROC
PROC_ReadyToMoveOn(_Thrumbo,"LOW_PhilgravesMansion_ThrumboRunsOffstage")
THEN
PROC_DisappearOutOfSightTo(_Thrumbo,S_LOW_PhilgravesMansion_ThrumboLeaveTrigger_b4593fb6-d005-4d33-a2d0-74e61a296254,"Run",1,"");
PROC_SetCanFight(_Thrumbo,0);
PROC_LOW_PhilgravesMansion_RemoveAllBeggars();
//END_REGION

//REGION Father Carrion

//Initializing Carrion Buffs
IF
DB_LOW_PhilgravesMansion_CarrionBuffs(_Buff,_)
THEN
ApplyStatus((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_Buff,-1.0);

IF
DestroyedBy(_Jar,_,_,_)
AND
DB_LOW_PhilgravesMansion_CarrionBuffs(_Buff,_Jar)
THEN
RemoveStatus((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_Buff);

IF
LevelLoaded("CTY_Main_A")
AND
NOT DB_LOW_PhilgravesMansion_MovedGem(1)
THEN
SetGravity((ITEM)S_FOR_DangerousBook_Key_000_123c268d-ad0c-4df5-905b-a78dacbed80b,GRAVITYTYPE.DisabledUntilMove);
TeleportTo((ITEM)S_FOR_DangerousBook_Key_000_123c268d-ad0c-4df5-905b-a78dacbed80b,S_LOW_PhilgravesMansion_PlaceForGem_5e6f51c1-a861-493f-91e8-806c8498fa64,"",0,0,0,0,0);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_Carrion,"LOW_PhilgravesMansion_CarrionSpotted",_Player)
AND
QRY_GetClosestAvailableCharacterTo(_Carrion, 1, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_PreferredPlayer,_Carrion,_,_)
AND
QRY_SpeakerIsAvailable(_Carrion)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_CarrionNotSpotting_223ba810-bd5e-4a07-801b-2a84c8eedd04)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b,_Carrion, _PreferredPlayer)
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers(LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b, _DialogID) // Add other harpers to Branthos main dialog as listeners.
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_FatherCarrion_Ghast_Lower_d8141d00-5f80-4245-9a48-fe3651be6954, S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
THEN
PROC_DialogAddSpeakingActor(_DialogID, S_LOW_FatherCarrion_Ghast_Lower_d8141d00-5f80-4245-9a48-fe3651be6954);


IF
DialogStarted((DIALOGRESOURCE)LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_CarrionNotSpotting_223ba810-bd5e-4a07-801b-2a84c8eedd04)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_CarrionNotSpotting_223ba810-bd5e-4a07-801b-2a84c8eedd04); 
PROC_TriggerUnregisterForPlayers((TRIGGER)LOW_PhilgravesMansion_MainHallTrigger_97b50e48-fc3e-435c-a3ba-2745eb733f2e);

IF
Saw((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,(CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_ReactedToDroppedCorpse_6f17e3bb-64b2-4e67-b3f9-a2daca64e6e7)
AND
DB_Dead(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb)
AND
NOT DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsIndebtedToPlayers_b2e22b4d-f88a-437a-b893-1f20e3e5ebf9)
THEN
PROC_PhilgravesMansion_CarrionReactToDroppedCorpse();

PROC
PROC_PhilgravesMansion_CarrionReactToDroppedCorpse()
AND
QRY_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(0)
AND
DB_QRYRTN_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(_Player)
THEN
SetFlag((FLAG)LOW_FatherCarrion_Event_ReactToDroppedCorpse_65c40747-2eb8-47a8-b0ea-20f1450f4796);
PROC_CharacterMoveToAndTalk((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_Player,(DIALOGRESOURCE)LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b,"LOW_PhilgravesMansion_CarrionReactToCorpse", "Walk", 15.0);

PROC
PROC_PhilgravesMansion_CarrionReactToDroppedCorpse()
AND
NOT QRY_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(0)
THEN
DB_LOW_PhilgravesMansion_CarrionSawThrumboOnGround(1);

IF
Saw((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_Player,_)
AND
DB_Players(_Player)
AND
DB_LOW_PhilgravesMansion_CarrionSawThrumboOnGround(1)
THEN
SetFlag((FLAG)LOW_FatherCarrion_Event_ReactToDroppedCorpse_65c40747-2eb8-47a8-b0ea-20f1450f4796);
PROC_CharacterMoveToAndTalk((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_Player,(DIALOGRESOURCE)LOW_PhilgravesMansion_FatherCarrion_b141f677-21c0-cba8-331e-21e157dba36b,"LOW_PhilgravesMansion_CarrionReactToCorpse", "Walk", 15.0);


IF
FlagSet((FLAG)LOW_FatherCarrion_State_ReactedToDroppedCorpse_6f17e3bb-64b2-4e67-b3f9-a2daca64e6e7,_,_)
THEN
NOT DB_LOW_PhilgravesMansion_CarrionSawThrumboOnGround(1);

IF
CharacterMoveToAndTalkFailed(_Carrion,_Player,"LOW_PhilgravesMansion_CarrionReactToCorpse",_)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_AD_CarrionSeesThrumboInHouse_32b2a54a-be23-143a-103a-263db958a871,_Carrion);

IF
UseStarted(_, S_LOW_LetterFatherCarrion_c4aae84c-c9b5-4941-a94f-c5c8ead07205)
THEN
SetFlag((FLAG)LOW_OskarsBeloved_State_ReadLetter_ee3f0fae-416f-4511-a2e6-30e79685f730);

PROC
PROC_PhilgravesMansion_RevealStartCombatLower()
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_CoffinsExploded_1f9f2727-f672-42d9-a78f-977be962c77b)
THEN
PROC_LOW_PhilgravesMansion_ExplodeCoffins();
SetFlag((FLAG)LOW_PhilgravesMansion_State_CoffinsExploded_1f9f2727-f672-42d9-a78f-977be962c77b);

PROC
PROC_PhilgravesMansion_RevealStartCombatUpper()
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_CoffinsExploded_1f9f2727-f672-42d9-a78f-977be962c77b)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_CoffinsUpperExploded_f0f97b89-13ef-4b15-9c94-25e0e76181e1);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrionUpperFloor_1d746532-eee0-4ea7-a7fa-09fbddb84f94,0);

IF
AttackedBy(_Jar,_Attacker,_,_DamageType,_,_,_)
AND
DB_LOW_PhilgravesMansion_Jars((ITEM)_Jar)
AND
_DamageType != "Fire"
THEN
ApplyDamage(_Attacker, 5, "Necrotic", _Attacker);

IF
AttackedBy(_Jar,_Attacker,_,_DamageType,_,_,_)
AND
DB_LOW_PhilgravesMansion_Jars((ITEM)_Jar)
AND
DB_Players((CHARACTER)_Attacker)
AND
_DamageType != "Fire"
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ReactionToWrongJarAttack")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_ReactToJarNoDamage_cee6df2f-ad9c-d5f5-5846-af7edc9c0e0f,_Attacker);

IF 
DestroyedBy((ITEM)_Jar,_,_Char,_)
AND
DB_LOW_PhilgravesMansion_Jars(_Jar)
AND
GetPosition(_Jar,_X,_Y,_Z)
THEN
CreateExplosionAtPosition(_X,_Y,_Z,"Projectile_Fireball",5, NULL_00000000-0000-0000-0000-000000000000);

IF 
DestroyedBy((ITEM)_Jar,_,_Char,_)
AND
DB_LOW_PhilgravesMansion_Jars(_Jar)
AND
_Jar != S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_DestroyedNonHeartJar_0b8a48a7-b093-4ac2-a4b1-502e9b5dad31)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_DestroyedNonHeartJar_0b8a48a7-b093-4ac2-a4b1-502e9b5dad31);

//Destroying one jar
IF 
DestroyedBy((ITEM)_Jar,_,_Char,_)
AND
DB_LOW_PhilgravesMansion_Jars(_Jar)
AND
QRY_CharacterGetOwnerOrSelf(_Char)
AND
DB_QRYRTN_CharacterGetOwnerOrSelf(_OwnerOrSelf)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_FirstJarDestroyed")
THEN
SetFlag((FLAG)LOW_FatherCarrion_Event_DetectedDestroyedJar_5e62e951-554d-40bb-b743-a69488cafdd0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrionUpperFloor_1d746532-eee0-4ea7-a7fa-09fbddb84f94,0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrion_6ee4b3ed-b298-4388-ab59-e999f4d2a504,0);
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_ReactToJarDestroyed_b1f012fe-8e9a-0174-2fd5-be784db92cc2,_OwnerOrSelf);

IF
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Event_SetJarsToChest_98b9ea3e-835d-4cfe-8dca-def8b48affcb)
THEN
PROC_LOW_PhilgravesMansion_SendAllJarsToBasement();

IF
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Event_SendThrumboTorsoToChest_d3ff1c4d-8ed9-494b-bcaa-6bcb9bfc3c61)
AND
GetInventoryOwner(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,_Owner)
THEN
MagicPocketsDrop((CHARACTER)_Owner,S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb);
PROC_PhilgravesMansion_SendJarToBasement((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492);

IF
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Event_SendHeartToChest_c3117ba0-ab0c-40f1-a73a-516af03c44a6)
THEN
PROC_PhilgravesMansion_SendJarToBasement((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492);

PROC
PROC_LOW_PhilgravesMansion_SendAllJarsToBasement()
AND
DB_LOW_PhilgravesMansion_Jars((ITEM)_Jar)
THEN
PROC_PhilgravesMansion_SendJarToBasement(_Jar);

IF
AddedTo(_Jar,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_LOW_PhilgravesMansion_Jars((ITEM)_Jar)
AND
_Jar != S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_GrabbedFirstJarOtherThanHeart_6e4cb103-051d-4164-8c0a-84af4b2a3bff)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_GrabbedFirstJarOtherThanHeart_6e4cb103-051d-4164-8c0a-84af4b2a3bff);

IF
AddedTo(_Jar,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_LOW_PhilgravesMansion_Jars((ITEM)_Jar)
AND
GetDirectInventoryOwner(_Jar,_Player)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ReactToGettingFirstJar")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_FirstJarGrabbed_5b6dd0c6-c2b0-c5a5-3bf0-ab99b830d334,_Player);

IF
AddedTo(_Jar,_Container,_)
AND
DB_LOW_PhilgravesMansion_Jars((ITEM)_Jar)
THEN
DB_LOW_PhilgravesMansion_JarContainer((ITEM)_Jar,_Container);

IF
RemovedFrom(_Jar,_Container)
AND
DB_LOW_PhilgravesMansion_JarContainer((ITEM)_Jar,_Container)
THEN
NOT DB_LOW_PhilgravesMansion_JarContainer((ITEM)_Jar,_Container);

PROC
PROC_PhilgravesMansion_SendJarsFromHeartContainer()
AND
DB_LOW_PhilgravesMansion_JarContainer((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492,_Container)
AND
DB_LOW_PhilgravesMansion_JarContainer(_Jar,_Container)
AND
S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492 != _Jar
THEN
PROC_PhilgravesMansion_SendJarToBasement(_Jar);

PROC
PROC_PhilgravesMansion_SendJarToBasement((ITEM)_Jar)
AND
DB_LOW_PhilgravesMansion_Jars(_Jar)
AND
DB_PhilgravesMansion_JarBasementLocation(_Jar, _Location)
THEN
SetGravity(_Jar, GRAVITYTYPE.DisabledUntilMove);
TeleportTo((ITEM)_Jar,_Location,"",0,0,0,0,0);

IF
RelationChanged((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrion_6ee4b3ed-b298-4388-ab59-e999f4d2a504, _Faction,0,0)
AND
FactionGetParentFaction(_Faction,1,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360)
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrion_6ee4b3ed-b298-4388-ab59-e999f4d2a504,_Faction,0);

IF
RelationChanged((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrion_6ee4b3ed-b298-4388-ab59-e999f4d2a504, _Faction,0,_)
AND
FactionGetParentFaction(_Faction,1,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_AngeredCarrion")
THEN
SetFlag((FLAG)LOW_FatherCarrion_State_IsHostile_50c741f9-19be-4fac-997a-3d31202ba14e);

IF
DB_Is_InCombat(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_ID)
AND
NOT DB_LOW_PhilgravesMansion_CarrionCombat(_ID)
THEN
PROC_PhilgravesMansion_RevealStartCombatLower();
DB_LOW_PhilgravesMansion_CarrionCombat(_ID);

IF
CombatEnded(_ID)
AND
DB_LOW_PhilgravesMansion_CarrionCombat(_ID)
AND
DB_Dead(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
QRY_LOW_PhilgravesMansion_ShouldPlayersReactToCarrionDeath()
AND
QRY_GetClosestAvailableCharacterTo(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 1)
AND
DB_ClosestAvailableCharacterTo(_Player, S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e, _)
THEN
PROC_LOW_PhilgravesMansion_PlayCarrionReaction(_Player);

PROC
PROC_LOW_PhilgravesMansion_PlayCarrionReaction((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_IdentifiedCarrionAsMummyLord_a6769dc6-e746-40be-95f2-321c2ec9b182)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_CarrionKilledReaction_58d92b94-d115-8af4-51d8-ed535461857f,_Player);


PROC
PROC_LOW_PhilgravesMansion_PlayCarrionReaction((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_IdentifiedCarrionAsMummyLord_a6769dc6-e746-40be-95f2-321c2ec9b182)
THEN
RequestPassiveRoll(_Player, _Player, "SkillCheck", "Arcana", (DIFFICULTYCLASS)Act3_Hard_6298329e-255c-4826-9209-e911873b64e7, 0, "LOW_PhilgravesMansion_CarrionDeathReaction");

PROC
PROC_RollResult("LOW_PhilgravesMansion_CarrionDeathReaction", _Player, _Player, 1)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_Event_PlayersSucceededRollCarrionDeath_51e725be-2b27-4411-bc77-4148552a6d32);

PROC
PROC_RollResult("LOW_PhilgravesMansion_CarrionDeathReaction", _Player, _Player, _)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_CarrionKilledReaction_58d92b94-d115-8af4-51d8-ed535461857f,_Player);

QRY
QRY_LOW_PhilgravesMansion_ShouldPlayersReactToCarrionDeath()
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_CarrionDeathAD_HeartAlive")
THEN
DB_NOOP(1);

QRY
QRY_LOW_PhilgravesMansion_ShouldPlayersReactToCarrionDeath()
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_CarrionDeathAD_HeartDead")
THEN
DB_NOOP(1);

IF
CombatEnded(_ID)
AND
DB_LOW_PhilgravesMansion_CarrionCombat(_ID)
AND
DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac)
AND
NOT DB_PermaDefeated((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb)
AND
NOT DB_GlobalFlag((FLAG)LOW_Thrumbo_Event_RunAfterBetrayal_00d54df6-0fe7-45c5-b794-e7b326f97ad2)
THEN
PROC_LOW_PhilgravesMansion_BeggarTakeover();

IF
DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac)
AND
NOT DB_LOW_PhilgravesMansion_CarrionCombat(_)
AND
NOT DB_PermaDefeated((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb)
AND
NOT DB_GlobalFlag((FLAG)LOW_Thrumbo_Event_RunAfterBetrayal_00d54df6-0fe7-45c5-b794-e7b326f97ad2)
THEN 
PROC_LOW_PhilgravesMansion_BeggarTakeover();

PROC
PROC_LOW_PhilgravesMansion_BeggarTakeover()
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_BeggarTakeover")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb);
SetCustomTradeTreasure((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,"LOW_MysticCarrion_Thrumbo");
DB_Dialogs((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,(DIALOGRESOURCE)LOW_PhilgravesMansion_ThrumboInsideHouse_149b5744-5f7a-154b-87d0-ac1f54a02b6c);
PROC_ToInventoryAndOnStage((ITEM)S_LOW_ThrumboRing_15edfd0b-ae2a-4ce5-8369-748070746713, S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,1,0,1);
SetCanInteract(S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab,1);
Unlock((ITEM)S_LOW_StreetDoor_8f8f545c-5718-47a1-9c3a-f23d10b4e5ab);
DB_SpotPlayers((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, "LOW_PhilgravesMansion_ThrumboWantsToThank", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_CustomRadius((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, "LOW_PhilgravesMansion_ThrumboWantsToThank", 15.0);
PROC_LOW_PhilgravesMansion_ZombiesGoToHouse();
PROC_LOW_PhilgravesMansion_RemoveBeggarVignettes();

PROC
PROC_LOW_PhilgravesMansion_RemoveBeggarVignettes()
AND
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers((TRIGGER)_Trigger,_Zombie,_Civilian,_Dialog)
THEN
PROC_RemoveOneShotTrigger(_Trigger);
PROC_LOW_PhilgravesMansion_RemoveCharacter(_Civilian,"Walk");
NOT DB_LOW_PhilgravesMansion_BeggarOneShotTriggers((TRIGGER)_Trigger,_Zombie,_Civilian,_Dialog);

IF
DB_PermaDefeated(_Zombie)
AND
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers(_Trigger,(CHARACTER)_Zombie,_Civilian,_Dialog)
THEN
PROC_RemoveOneShotTrigger(_Trigger);
PROC_LOW_PhilgravesMansion_RemoveCharacter(_Civilian,"Run");
NOT DB_LOW_PhilgravesMansion_BeggarOneShotTriggers(_Trigger,(CHARACTER)_Zombie,_Civilian,_Dialog);

IF
CombatEnded(_ID)
AND
DB_LOW_PhilgravesMansion_CarrionCombat(_ID)
THEN
NOT DB_LOW_PhilgravesMansion_CarrionCombat(_ID);

IF
SwitchedCombat(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_OldID,_NewID)
AND
DB_LOW_PhilgravesMansion_CarrionCombat(_OldID)
THEN
NOT DB_LOW_PhilgravesMansion_CarrionCombat(_OldID);
DB_LOW_PhilgravesMansion_CarrionCombat(_NewID);

//Checking whether torch is in chest
IF
MovedFromTo(S_UNI_LOW_TorchOfRevocation_a042774f-ae71-4d19-9554-ba90cf34d046,_,_WhoHasIt,_)
AND
_WhoHasIt != S_LOW_PhilgravesMansion_ClientChest_ee7e8c08-5359-4cc2-932a-42edd01c4de6
THEN
ClearFlag((FLAG)LOW_PhilgravesMansion_TorchIsInChest_177f5f22-0fd8-4e31-8949-cb8cf45f0dfa);

IF
MovedFromTo(S_UNI_LOW_TorchOfRevocation_a042774f-ae71-4d19-9554-ba90cf34d046,_,S_LOW_PhilgravesMansion_ClientChest_ee7e8c08-5359-4cc2-932a-42edd01c4de6,_)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_TorchIsInChest_177f5f22-0fd8-4e31-8949-cb8cf45f0dfa);

//REGION Bringing beggars back dead

PROC
PROC_LOW_PhilgravesMansion_SendZombiesToBasement()
AND
DB_LOW_PhilgravesMansion_ZombieBeggars(_Zombie)
AND
_Zombie != S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb
AND
DB_LOW_PhilgravesMansion_BasementDropZombies(_Zombie,_Location)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrionUpperFloor_1d746532-eee0-4ea7-a7fa-09fbddb84f94,0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrion_6ee4b3ed-b298-4388-ab59-e999f4d2a504,0);
SetFlag((FLAG)LOW_PhilgravesMansion_State_CarrionWantingToBoastAboutBeggars_b43b44c8-2a8e-4aef-ad47-9e79cda37617);
PROC_SetOnStage(_Zombie,1);
Die((CHARACTER)_Zombie, DEATHTYPE.Physical, 0);
TeleportTo(_Zombie,_Location,"",0,0,0,0,1);

PROC
PROC_LOW_PhilgravesMansion_KillThrumboInHouse()
THEN
TeleportTo(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,S_LOW_ThrumboLocation_a1f7a6d1-d3af-4fcd-a69c-7d6812ba2c50);
PROC_SetOnStage(S_LOW_ThrumboDeadWarningCleaver_6e254dae-1454-4885-acd9-26bd917a9cc0,1);
PROC_SetOnStage(S_LOW_ThrumboDeadWarning_113c6cee-50d1-41f0-bedb-ebd759f2828c,1);
PROC_SetOnStage(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,1);
SetFlag((FLAG)LOW_PhilgravesMansion_State_CarrionKilledThrumbo_6dae544d-10d8-45d0-b2c9-af51e59c0a8e);
DB_SeenDeadNPCGlobalFlag((CHARACTER)S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,(FLAG)LOW_PhilgravesMansion_SeenThrumboExploded_8e2a4753-5fb7-4132-8db5-fde42ce4c96f);
Die(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb, DEATHTYPE.Explode, 0);

//If a zombie has a jar in them
QRY
QRY_LOW_PhilgravesMansion_TeleportJarIfZombieHas((CHARACTER)_Zombie)
AND
DB_PhilgravesMansion_JarBasementLocation(_Jar, _Location)
AND
GetOwner(_Jar,_Zombie)
THEN
SetGravity(_Jar, GRAVITYTYPE.DisabledUntilMove);
TeleportTo(_Jar, _Location,"",0,0,0,0,0);

//If torso that has the heart is in a zombie
QRY
QRY_LOW_PhilgravesMansion_ZombieHasHeart()
AND
GetOwner((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492,_Zombie)
AND
DB_LOW_PhilgravesMansion_ZombieBeggars(_Zombie)
THEN
DB_NOOP(1);

//END_REGION


PROC
PROC_LongRest()
AND
DB_Dead(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
NOT DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac)
AND
NOT DB_LOW_PhilgravesMansion_WaitingForCarrionRez(1)
THEN
DB_LOW_PhilgravesMansion_WaitingForCarrionRez(1);

IF
DB_LOW_PhilgravesMansion_WaitingForCarrionRez(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_PhilgravesMansion_WaitingForCarrionRez(1);
PROC_LOW_PhilgravesMansion_CarrionResurrection();

PROC
PROC_LOW_PhilgravesMansion_CarrionResurrection()
AND
GetOwner((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492, _WhoHasTorso)
AND
DB_Players(_WhoHasTorso)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_CarrionThreatSend")
THEN
ObjectTimerLaunch(_WhoHasTorso,"LOW_PhilgravesMansion_CarrionThreatSendTimer",2000);

IF
ObjectTimerFinished(_WhoHasTorso,"LOW_PhilgravesMansion_CarrionThreatSendTimer")
THEN
PROC_ToInventoryAndOnStage((ITEM)S_LOW_CarrionThreat_2ae36508-b040-4292-843d-b5939285435e, _WhoHasTorso, 1, 1, 0);

//Bringing back the zombies if one of them has the heart
PROC
PROC_LOW_PhilgravesMansion_CarrionResurrection()
AND
QRY_LOW_PhilgravesMansion_ZombieHasHeart()
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_GetZombiesBack")
THEN
PROC_LOW_PhilgravesMansion_KillThrumboInHouse();
PROC_LOW_PhilgravesMansion_SendZombiesToBasement();

PROC
PROC_LOW_PhilgravesMansion_SendZombiesToBasement()
AND
DB_LOW_PhilgravesMansion_ZombieBeggars(_Zombie)
AND
QRY_LOW_PhilgravesMansion_TeleportJarIfZombieHas((CHARACTER)_Zombie)
THEN
DB_NOOP(1);

PROC
PROC_LOW_PhilgravesMansion_CarrionResurrection()
THEN
PROC_CharacterFullRestore(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e);
NOT DB_PhilgravesMansion_AngryCarrionHasTalked(1);
TeleportTo(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,S_LOW_FatherCarrionTeleportTo_5681db68-1e7c-4f82-8a07-e62a33ce17ea);
PROC_PhilgravesMansion_SendJarsFromHeartContainer();
PROC_PhilgravesMansion_SendJarToBasement((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492);

PROC
PROC_LOW_PhilgravesMansion_InitJars()
AND
DB_LOW_PhilgravesMansion_Jars(_Jar)
THEN
DB_GLO_DefeatCounter((ITEM)_Jar, "LOW_PhilgravesMansion_Jars");

IF
DialogEnded((DIALOGRESOURCE)LOW_PhilgravesMansion_AngryFatherCarrion_f1c37076-434c-a441-d6ec-0f0827f97ed2,_)
THEN
PROC_PhilgravesMansion_RevealStartCombatLower();
PROC_PhilgravesMansion_RevealStartCombatUpper();


//REGION Stop combat to have pre-combat dialog

QRY
QRY_CarrionShouldStartAngryDialog()
AND
DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_HasBeenKilled_34a30ab8-c0e4-44a1-b2b4-31a5cc65bcea)
THEN
DB_NOOP(1);

QRY
QRY_CarrionShouldStartAngryDialog()
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_DestroyedNonHeartJar_0b8a48a7-b093-4ac2-a4b1-502e9b5dad31)
THEN
DB_NOOP(1);

QRY
QRY_CarrionShouldStartAngryDialog()
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44)
THEN
DB_NOOP(1);

QRY
QRY_CarrionShouldStartAngryDialog()
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_CarrionWantingToBoastAboutBeggars_b43b44c8-2a8e-4aef-ad47-9e79cda37617)
THEN
DB_NOOP(1);

QRY
QRY_CarrionShouldStartAngryDialog()
AND
DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsIndebtedToPlayers_b2e22b4d-f88a-437a-b893-1f20e3e5ebf9)
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_HasHeart_22154967-9777-4149-bbae-216409fea025)
THEN
DB_NOOP(1);

IF
DB_Is_InCombat(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_CombatGUID)
AND
NOT DB_PhilgravesMansion_AngryCarrionHasTalked(1)
AND
QRY_CarrionShouldStartAngryDialog()
AND
CombatGetInvolvedPlayersCount(_CombatGUID,_CountPlayers)
AND
_CountPlayers > 0
AND
QRY_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(1)
AND
DB_QRYRTN_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(_Player)
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)LOW_PhilgravesMansion_AngryFatherCarrion_f1c37076-434c-a441-d6ec-0f0827f97ed2,(CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,  _Player, 0, 0, 0, 1)
THEN
DB_NOOP(1);


// Adding other players to the angry Carrion's dialog
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_PhilgravesMansion_AngryFatherCarrion_f1c37076-434c-a441-d6ec-0f0827f97ed2, (INTEGER)_DialogID)
AND
DB_DialogRequestCache_SpeakerList_Players((DIALOGRESOURCE)LOW_PhilgravesMansion_AngryFatherCarrion_f1c37076-434c-a441-d6ec-0f0827f97ed2,_DialogID, _PlayerInDialog, 1)
AND
DB_Is_InCombat(_PlayerInDialog, (GUIDSTRING)_CombatID)
AND
DB_Players((CHARACTER)_OtherPlayer)
AND
_PlayerInDialog != _OtherPlayer
AND
DB_Is_InCombat(_OtherPlayer, _CombatID)
AND
NOT DB_DialogRequestCache_SpeakerList_Players((DIALOGRESOURCE)LOW_PhilgravesMansion_AngryFatherCarrion_f1c37076-434c-a441-d6ec-0f0827f97ed2,_DialogID, _OtherPlayer, _)
THEN
PROC_DialogAddListeningActor(_DialogID, _OtherPlayer);



IF
DialogStarted((DIALOGRESOURCE)LOW_PhilgravesMansion_AngryFatherCarrion_f1c37076-434c-a441-d6ec-0f0827f97ed2,_)
THEN
DB_PhilgravesMansion_AngryCarrionHasTalked(1);

IF
DialogStarted((DIALOGRESOURCE)LOW_PhilgravesMansion_AngryFatherCarrion_f1c37076-434c-a441-d6ec-0f0827f97ed2,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_IdentifiedCarrionAsMummyLord_a6769dc6-e746-40be-95f2-321c2ec9b182)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_IdentifiedCarrionAsMummyLord_a6769dc6-e746-40be-95f2-321c2ec9b182);


QRY
QRY_LOW_PhilgravesMansion_CarrionFindAvatarToTalk((INTEGER)_)
AND
DB_QRYRTN_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(_Previous)
THEN
NOT DB_QRYRTN_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(_Previous);

QRY
QRY_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(0)
AND
DB_Avatars(_Avatar)
AND
NOT DB_QRYRTN_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(_Avatar)
AND
QRY_SpeakerIsAvailable(_Avatar)
AND
CanSee((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_Avatar,1)
THEN
DB_QRYRTN_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(_Avatar);

QRY
QRY_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(1)
AND
DB_Avatars(_Avatar)
AND
NOT DB_QRYRTN_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(_)
AND
CanSee((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,_Avatar,1)
THEN
DB_QRYRTN_LOW_PhilgravesMansion_CarrionFindAvatarToTalk(_Avatar);

//END_REGION


QRY
QRY_LOW_PhilgravesMansion_DestroyedJarOrMetParty()
AND
DB_GlobalFlag((FLAG)LOW_FatherCarrion_HasMetParty_7ef170f0-4a35-48b4-a0b8-34340d5b5fba)
THEN
DB_NOOP(1);

QRY
QRY_LOW_PhilgravesMansion_DestroyedJarOrMetParty()
AND
DB_GlobalFlag((FLAG)LOW_FatherCarrion_Event_DetectedDestroyedJar_5e62e951-554d-40bb-b743-a69488cafdd0)
THEN
DB_NOOP(1);

IF 
Died(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrionUpperFloor_1d746532-eee0-4ea7-a7fa-09fbddb84f94,0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_PhilgravesMansion_FatherCarrion_6ee4b3ed-b298-4388-ab59-e999f4d2a504,0);

IF 
DB_PermaDefeated(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
DB_Dead(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
DB_GlobalFlag((FLAG)LOW_Philgraves_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44)
THEN
SetFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac);

IF
DestroyedBy((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492,_,_,_)
THEN
SetFlag((FLAG)LOW_Philgraves_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44);
NOT DB_PreventPermaDefeated(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e);

IF
DestroyedBy((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492,_,_,_)
AND
DB_Dead(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
THEN
SetFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac);

//END_REGION

//REGION Beggars Quarters

IF
UseStarted(_Player,S_LOW_BeggarsPortrait_9e5d743a-f00e-4d5c-93ff-272b9a895c15)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_DisarmedPortrait_086174ca-6f10-4d8c-a149-007671cc9240)
THEN
RequestActiveRoll(_Player, S_LOW_BeggarsPortrait_9e5d743a-f00e-4d5c-93ff-272b9a895c15, "Arcana", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, "LOW_PhilgravesMansion_BeggarsPortrait");


PROC
PROC_RollResult("LOW_PhilgravesMansion_BeggarsPortrait", _Character, _, 1)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_DisarmedPortrait_086174ca-6f10-4d8c-a149-007671cc9240);
PROC_ToInventoryAndOnStage((ITEM)S_LOW_NoteFromThrumbo_c1fb827d-eb8c-4898-8d3b-32281695a682,_Character,1,1,1);

IF
GameBookInterfaceClosed((ITEM)S_LOW_NoteFromThrumbo_c1fb827d-eb8c-4898-8d3b-32281695a682,_Player)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ReadThrumboNote")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_PortraitLetter_94a8c42b-9322-65cb-f7e9-6efa2b29162b,_Player);
SetFlag((FLAG)LOW_PhilgravesMansion_State_ReadThrumboNote_2e0a5f21-a80c-4e6b-852b-dad97ac47f19);

PROC
PROC_RollResult("LOW_PhilgravesMansion_BeggarsPortrait", _Character, _RollSubject, 0)
THEN
CreateSurface(S_LOW_BeggarsPortrait_9e5d743a-f00e-4d5c-93ff-272b9a895c15, "SurfaceDarknessCloud", 9.0, 16.0, _Character);
PROC_LOW_ApplyMaddeningDarkness();


PROC
PROC_LOW_ApplyMaddeningDarkness()
AND
DB_Players(_Player)
AND
GetDistanceTo(_Player,S_LOW_BeggarsPortrait_9e5d743a-f00e-4d5c-93ff-272b9a895c15,_Dist)
AND
_Dist <= 9
THEN
RequestPassiveRoll(_Player, S_LOW_BeggarsPortrait_9e5d743a-f00e-4d5c-93ff-272b9a895c15, "SavingThrow", "Wisdom", (DIFFICULTYCLASS)DC_Legacy_15_625be976-7a67-4394-97c8-14c69715ae4b, 0, "LOW_MaddeningDarkness");

PROC
PROC_RollResult("LOW_MaddeningDarkness", _Character, _, 1)
AND
Random(28,_Damage)
AND
IntegerSum(_Damage,4,_FinalDamage)
THEN
ApplyDamage(_Character,_FinalDamage,"Psychic",S_LOW_BeggarsPortrait_9e5d743a-f00e-4d5c-93ff-272b9a895c15);


PROC
PROC_RollResult("LOW_MaddeningDarkness", _Character, _, 0)
AND
Random(56,_Damage)
AND
IntegerSum(_Damage,8,_FinalDamage)
THEN
ApplyDamage(_Character,_FinalDamage,"Psychic",S_LOW_BeggarsPortrait_9e5d743a-f00e-4d5c-93ff-272b9a895c15);

//END_REGION

//REGION Workshop / Alarm Door

IF
GameBookInterfaceClosed((ITEM)S_LOW_CarrionJarDiagrams_c8a2228a-adff-4fcd-b60a-81f81c033e2f, _Character)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_ReadFirstTimeCarrionDiagrams")
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_Quest_ReadJarDiagrams_9d307fd4-e5e3-430c-b617-2d208d5e1053);
SetFlag((FLAG)LOW_PhilgravesMansion_State_JarsInBodiesDiscovered_3b3d84a4-7b4f-4c9b-a669-95ba915a603d);
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_DiscoveredMummyLordResearch_ba106cdb-0223-7e89-062d-c536d2dc9d72, _Character);

IF
DB_PerceptionSkillCheck(_Player,S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00,1)
THEN
DB_LOW_PhilgravesMansion_RevealedAlarm(1);
ApplyStatus(S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00,"LOW_PHILGRAVESMANSION_ALARM", -1.0,1);

IF
RequestCanUse(_Player,(ITEM)S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00,_)
AND
NOT DB_LOW_PhilgravesMansion_RevealedAlarm(1)
THEN
PROC_LOW_PhilgravesMansion_AlertTrigger();
PROC_LOW_PhilgravesMansion_EnemiesDetectingAlarm();

IF
RequestCanUse(_Player,(ITEM)S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_AlarmSpellRemoved_e947c865-923d-485d-96da-4589403b7f5c)
AND
DB_LOW_PhilgravesMansion_RevealedAlarm(1)
THEN
RequestActiveRoll(_Player, S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00, "Arcana", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, "LOW_PhilgravesMansion_WorkshopDoorDisarm");


PROC
PROC_LOW_PhilgravesMansion_EnemiesDetectingAlarm()
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_Event_ReactToAlarm_5f888172-7806-47c4-bdfe-dd5631a670d2);
PROC_PhilgravesMansion_RevealStartCombatLower();
PROC_PhilgravesMansion_RevealStartCombatUpper();

PROC
PROC_RollResult("LOW_PhilgravesMansion_WorkshopDoorDisarm", _Character, _, 1)
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_AlarmSpellRemoved_e947c865-923d-485d-96da-4589403b7f5c);
RemoveStatus(S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00,"LOW_PHILGRAVESMANSION_ALARM");
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_AlarmDoorDispeled_a2cec61e-8761-1309-4d97-3c79c5b173dc, _Character);


PROC
PROC_RollResult("LOW_PhilgravesMansion_WorkshopDoorDisarm", _Character, _, 0)
THEN
PROC_LOW_PhilgravesMansion_AlertTrigger();
PROC_LOW_PhilgravesMansion_EnemiesDetectingAlarm();

IF 
AttackedBy(S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00, _Player, _, _, _, _, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_AlarmSpellRemoved_e947c865-923d-485d-96da-4589403b7f5c)
THEN
PROC_LOW_PhilgravesMansion_AlertTrigger();
PROC_LOW_PhilgravesMansion_EnemiesDetectingAlarm();

QRY
QRY_CRIME_BlockRegisterCrime(_Criminal,"UseForbiddenItem",S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00,_Char,_CrimeId)
AND
DB_Sees((CHARACTER)_Char, (CHARACTER)_Criminal)
AND
QRY_OnlyOnce("LOW_Philgraves_GetHostileWithPeople")
THEN
PROC_LOW_PhilgravesMansion_EnemiesDetectingAlarm();

PROC
PROC_LOW_PhilgravesMansion_AlertTrigger()
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_Alarm")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_AlarmDoor_AD_14abcf8d-febd-fe93-4da8-cbe78b46ad05, S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00);

PROC
PROC_LOW_PhilgravesMansion_AlertTrigger()
AND
HasActiveStatus(S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00,"LOW_PHILGRAVESMANSION_ALARM",0)
THEN 
ApplyStatus(S_LOW_PhilgravesBasementGuardedDoor_717a919a-e1e0-4ca3-b2da-eac784afae00,"LOW_PHILGRAVESMANSION_ALARM", -1.0,1);

//END_REGION

IF 
EnteredTrigger(_Player, (TRIGGER)S_LOW_PhilgravesLarderTrigger_362d5da1-7b69-485e-a7a6-65e5277dc9dd)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_PhilgravesMansion_PAD_EnteredLarder_e2c0362a-fb62-4e91-2540-d6425bb12740,_Player);

//REGION Journal

IF
FlagSet((FLAG)LOW_Thrumbo_State_IsDead_21e2f143-abef-45fa-a29c-6eb91491b9ec,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_CarrionKilledThrumbo_6dae544d-10d8-45d0-b2c9-af51e59c0a8e)
THEN
QuestUpdate("LOW_PhilgravesMansion", "Thrumbo_PlayerKilled");


IF
DB_Dead((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
NOT DB_GlobalFlag((FLAG)LOW_Philgraves_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Quest_ThrumboToldAboutCarrionResurrecting_77ba2f6a-05a5-4ac7-9946-cbe8a4863e64)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "Carrion_Killed")
THEN
QuestUpdate("LOW_PhilgravesMansion", "Carrion_Killed");

IF
DB_Dead((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
QRY_LOW_PhilgravesMansion_ThrumboHasHeartAndIsAlive()
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Quest_ThrumboToldAboutCarrionResurrecting_77ba2f6a-05a5-4ac7-9946-cbe8a4863e64)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "Carrion_KilledKnowsWillResurrect_ThrumboAliveWithJar")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "Carrion_KilledKnowsWillResurrect_ThrumboDeadOrNoJar")
THEN
QuestUpdate("LOW_PhilgravesMansion", "Carrion_KilledKnowsWillResurrect_ThrumboAliveWithJar");

IF
DB_Dead((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
NOT QRY_LOW_PhilgravesMansion_ThrumboHasHeartAndIsAlive()
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Quest_ThrumboToldAboutCarrionResurrecting_77ba2f6a-05a5-4ac7-9946-cbe8a4863e64)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "Carrion_KilledKnowsWillResurrect_ThrumboDeadOrNoJar")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "Carrion_KilledKnowsWillResurrect_ThrumboAliveWithJar")
THEN
QuestUpdate("LOW_PhilgravesMansion", "Carrion_KilledKnowsWillResurrect_ThrumboDeadOrNoJar");

QRY
QRY_LOW_PhilgravesMansion_ThrumboHasHeartAndIsAlive()
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_HeartInThrumbosInventory_46beba15-84e7-47ac-bc46-922cf0345b1a)
AND
NOT DB_Dead(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)LOW_PhilgravesMansion_SeenThrumboExploded_8e2a4753-5fb7-4132-8db5-fde42ce4c96f,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Quest_ThrumboToldAboutCarrionResurrecting_77ba2f6a-05a5-4ac7-9946-cbe8a4863e64)
THEN
QuestUpdate("LOW_PhilgravesMansion", "Thrumbo_FoundDead_MetHim");

IF
FlagSet((FLAG)LOW_PhilgravesMansion_SeenThrumboExploded_8e2a4753-5fb7-4132-8db5-fde42ce4c96f,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_ExplainedTask_f77ed6af-3076-43da-9a68-1d83edf9068d)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Quest_ThrumboToldAboutCarrionResurrecting_77ba2f6a-05a5-4ac7-9946-cbe8a4863e64)
THEN
QuestUpdate("LOW_PhilgravesMansion", "ThrumboFoundDead_NotMetHim_Explained");

IF
GameBookInterfaceClosed((ITEM)S_LOW_ThrumboDeadWarning_113c6cee-50d1-41f0-bedb-ebd759f2828c,_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_ExplainedTask_f77ed6af-3076-43da-9a68-1d83edf9068d)
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Quest_ThrumboToldAboutCarrionResurrecting_77ba2f6a-05a5-4ac7-9946-cbe8a4863e64)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "ThrumboFoundDead_NotMetHim_NotExplained")
THEN
QuestUpdate("LOW_PhilgravesMansion", "ThrumboFoundDead_NotMetHim_NotExplained");

IF
DB_LOW_PhilgravesMansion_HasSeenHeart(1)
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_DestroyedNonHeartJar_0b8a48a7-b093-4ac2-a4b1-502e9b5dad31)
THEN
NOT DB_LOW_PhilgravesMansion_HasSeenHeart(1);
QuestUpdate("LOW_PhilgravesMansion", "NonHeartJarDestroyed");

IF
DB_LOW_PhilgravesMansion_CarrionCombat(_ID)
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_DestroyedNonHeartJar_0b8a48a7-b093-4ac2-a4b1-502e9b5dad31)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_UpdateDestroyedJarMainQuest")
THEN
QuestUpdate("LOW_PhilgravesMansion", "NonHeartJarDestroyed_Parent");

IF
FlagSet((FLAG)LOW_PhilgravesMansion_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44,_,_)
AND
QRY_LOW_PhilgravesMansion_PlayersKnowHeartStopsResurrection()
THEN
QuestUpdate("LOW_PhilgravesMansion", "HeartDestroyed_Parent");

IF
FlagSet((FLAG)LOW_PhilgravesMansion_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44,_,_)
AND
QRY_LOW_PhilgravesMansion_PlayersKnowHeartStopsResurrection()
THEN
QuestUpdate("LOW_PhilgravesMansion", "HeartDestroyed");

QRY
QRY_LOW_PhilgravesMansion_PlayersKnowHeartStopsResurrection()
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Quest_ThrumboToldAboutCarrionResurrecting_77ba2f6a-05a5-4ac7-9946-cbe8a4863e64)
THEN
DB_NOOP(1);

QRY
QRY_LOW_PhilgravesMansion_PlayersKnowHeartStopsResurrection()
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_JarsInBodiesDiscovered_3b3d84a4-7b4f-4c9b-a669-95ba915a603d)
THEN
DB_NOOP(1);

IF
Resurrected((CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
DB_OnlyOnce("LOW_PhilgravesMansion_FirstCarrionResurrection")
THEN
DB_LOW_PhilgravesMansion_ReadyToReactWhenSeenCarrion(1);

IF
DB_Sees(_Player,(CHARACTER)S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
DB_Players(_Player)
AND
DB_LOW_PhilgravesMansion_ReadyToReactWhenSeenCarrion(1)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "Carrion_FoundAliveAfterDeath")
THEN
QuestUpdate("LOW_PhilgravesMansion", "Carrion_FoundAliveAfterDeath");

PROC
PROC_OneShotTriggerEntered(_,(TRIGGER)S_LOW_PhilgravesMansion_BasementRegionTrigger_17a71a2b-98b2-470d-bb7b-f8cfeda2d4dc)
THEN
QuestUpdate("LOW_PhilgravesMansion", "ReachedBasement");

PROC
PROC_OneShotTriggerEntered(_,(TRIGGER)S_LOW_PhilgravesMansion_AncientLairRegion_ec10580c-2e07-4eb1-8465-a648183ccaea)
THEN
QuestUpdate("LOW_PhilgravesMansion", "AncientLair_Explore");
DB_LOW_PhilgravesMansion_EnteredLair(1);

IF
DB_LOW_PhilgravesMansion_EnteredLair(1)
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_GrabbedFirstJarOtherThanHeart_6e4cb103-051d-4164-8c0a-84af4b2a3bff)
THEN
NOT DB_LOW_PhilgravesMansion_EnteredLair(1);
QuestUpdate("LOW_PhilgravesMansion", "LootedNonHeartJar");

IF
FlagSet((FLAG)LOW_PhilgravesMansion_State_HasHeart_22154967-9777-4149-bbae-216409fea025, _Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "LootedHeart")
THEN
QuestUpdate("LOW_PhilgravesMansion", "LootedHeart");
DB_LOW_PhilgravesMansion_HasSeenHeart(1);

IF
DB_LOW_PhilgravesMansion_CarrionCombat(_)
AND
QRY_OnlyOnce("LOW_PhilgravesMansion_CarrionHostile")
THEN
QuestUpdate("LOW_PhilgravesMansion", "DealFellThrough");


//END_REGION





EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
