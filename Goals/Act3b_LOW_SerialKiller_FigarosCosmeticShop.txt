Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, (DIALOGRESOURCE)LOW_Figaro_SellingThings_aac70e59-5957-5b56-bea7-fd00b13ab95a);
DB_Dialogs(S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, LOW_SerialKiller_Figaro_Assistant_000_173022ff-f99a-81dc-27be-86f96808cd1d);
DB_Dialogs(S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, LOW_SerialKiller_Figaro_Assistant_001_8823a9d1-1595-2644-f1c1-753a20577944);

DB_DeadOnceFlag((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09,LOW_SerialKiller_State_Figaro_IsDead_34b421f0-c8d8-4b31-9f96-962dbf981260);
PROC_SetOnStage((ITEM)S_LOW_SerialKiller_SymbolOfTheAbsolute_Figaro_0bc127ca-8f4a-4edb-a15a-6c5ec3f3a397, 0);

//Doors for Dolor's Soliloquy
DB_LOW_SerialKiller_FigarosDoors((ITEM)S_LOW_SerialKiller_FigaroDoor_Far_02e41e0d-6b50-44dd-8dfd-1d135762903c, (FLAG)LOW_SerialKiller_State_Figaro_PlayersUseFarDoor_25d159d9-fcb0-4172-944f-22f89617f665);
DB_LOW_SerialKiller_FigarosDoors((ITEM)S_LOW_SerialKiller_FigaroDoor_Near_6a089d5e-febd-4d0c-84b1-52610a4a7bb1, (FLAG)LOW_SerialKiller_State_Figaro_PlayersUseNearDoor_47db30b5-35eb-4910-a876-8050ccdbe316);
//Block atack on Dolor's Soliloquy
DB_DialogBlockAttackButton(LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae);

DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, (TRIGGER)S_LOW_Figaros_TPDolor_083e02ea-63da-4cf4-959a-0e67cd0bbc5f,
	(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_SerialKiller_Figaro_Doppelganger_000_9fd43e05-2158-487c-9c08-57b0c2caf7d8, (TRIGGER)S_LOW_DoppelgangerTrigger_000_f9c9c13c-29d7-4528-8773-69ff01d0fe90,
	(DIALOGRESOURCE)LOW_SerialKiller_Figaro_Doppelganger_000_bae5e7e9-d0c3-0644-43cc-d6b7bf85bfc3);
DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_SerialKiller_Figaro_Doppelganger_001_a4f560e6-8869-4316-a674-aee94da4cee0, (TRIGGER)S_LOW_DoppelgangerTrigger_001_8d8addb0-e4c7-415b-8e35-55c8e79a1460,
	(DIALOGRESOURCE)LOW_SerialKiller_Figaro_Doppelganger_001_7b1ccbf6-3c39-aaf5-75e6-60fb1b3d54ef);
DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_SerialKiller_Figaro_Doppelganger_002_bc6b17c7-b681-4607-bc4a-c578aa3cb55d, (TRIGGER)S_LOW_DoppelgangerTrigger_002_94a5d852-82d6-4068-b6d0-f0750b73f61c,
	(DIALOGRESOURCE)LOW_SerialKiller_Figaro_Doppelganger_002_edf98f9c-0d08-c702-0eda-0588772e904b);
DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_SerialKiller_Figaro_Doppelganger_003_e1ea7d43-2b85-45da-9778-3e4f6197dd9a, (TRIGGER)S_LOW_DoppelgangerTrigger_003_657de47e-b9ca-40f9-bfe7-a36e9c93de19,
	(DIALOGRESOURCE)LOW_SerialKiller_Figaro_Doppelganger_003_a3c743b4-901b-07c3-d0c3-3d18e974ee37);
/*DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_SerialKiller_Figaro_Doppelganger_004_0da467ef-7eb6-4d2e-b577-014144718819, (TRIGGER)S_LOW_SerialKiller_DoppelgangerInside_001_9fae972f-df2e-41d4-bc4f-2aa4d094a3c8,
	(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);*/
DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_SerialKiller_Figaro_Doppelganger_005_d2ad989b-3e08-448e-bd66-ab132d83fafd, (TRIGGER)S_LOW_SerialKiller_DoppelgangerInside_002_b2a45091-5b7d-4c0a-b0c2-f398f6eedc70,
	(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_SerialKiller_Figaro_Doppelganger_006_3344edd8-94a2-42f7-b2a3-4cd4aa639a12, (TRIGGER)S_LOW_SerialKiller_DoppelgangerInside_003_b6a7cf95-cec4-4580-b2f2-ddecc686c157,
	(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_SerialKiller_Figaro_Doppelganger_007_15884103-c8b3-4c5f-b3b5-67ae481074c6, (TRIGGER)S_LOW_SerialKiller_DoppelgangerInside_004_2da32045-291f-4f14-8535-72e91e43d71a,
	(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (TRIGGER)S_LOW_SerialKiller_DevellaTeleport_4c1c2468-8f66-4759-bbce-e58a2dd02488,
	(DIALOGRESOURCE)LOW_SerialKiller_Figaro_Devella_AfterParalysis_5683b9b3-136d-d860-bc93-376b8bc78c23);


DB_OneShotPlayerTrigger((TRIGGER)S_LOW_SerialKiller_FigaroSecureZone_b8f776cf-e2f7-4202-a30d-823d20e74392);

DB_Dialogs(S_LOW_Figaros_CivilianWaiting_a302cea3-9950-48cb-828d-b8b35e397975, (DIALOGRESOURCE)LOW_Figaros_CivilianWaiting_8e621a57-a36d-4ffd-a42e-93b71fa995d3);

// Combat NPC Reactivity
DB_CombatReact_AD_OnNextTurn(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (DIALOGRESOURCE)LOW_Elfsong_AD_Devella_Fountainhead_Turn1_bbafc977-e559-c425-14c3-08a45be52061);
DB_CombatReact_AD_OnNextTurn(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (DIALOGRESOURCE)LOW_Elfsong_AD_Devella_Fountainhead_Turn2_080e9cdc-cec9-c4cb-21e8-a70200c7bc8b);
DB_CombatReact_AD_OnNextTurn(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (DIALOGRESOURCE)LOW_Elfsong_AD_Devella_Fountainhead_Turn3_c484f4c2-f4a9-de1e-1da3-3bdf46beed3c);

// Ownership
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_Figaro_Ownership_7758eeea-fd29-4944-a366-1364aef16a0b, (CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09);
DB_ItemOwnerShipTriggersFallback((TRIGGER)S_LOW_Figaro_Ownership_7758eeea-fd29-4944-a366-1364aef16a0b,(CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f);
DB_ItemShopTrigger((TRIGGER)S_LOW_Figaro_Shopping_b68f02db-3b2e-43f5-b3b3-e77cf3f2fbab, (CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09);

TriggerRegisterForCharacter((TRIGGER)S_LOW_SerialKiller_Figaro_StoreReceptionTrigger_fe602663-ef4f-4539-a308-8e3bbbadabd7, (CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f);

DB_LOW_SerialKiller_DevellaIgnoreCrimes("PrisonEscape_AD");
DB_LOW_SerialKiller_DevellaIgnoreCrimes("PrisonEscape");

KBSECTION
//REGION General Store
IF
EnteredTrigger(S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, S_LOW_SerialKiller_Figaro_StoreReceptionTrigger_fe602663-ef4f-4539-a308-8e3bbbadabd7)
THEN
SetFlag(LOW_SerialKiller_Figaros_State_CanChatter_a9dea102-5bc1-4224-b26c-2078b4794311);

IF
LeftTrigger(S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, S_LOW_SerialKiller_Figaro_StoreReceptionTrigger_fe602663-ef4f-4539-a308-8e3bbbadabd7)
THEN
ClearFlag(LOW_SerialKiller_Figaros_State_CanChatter_a9dea102-5bc1-4224-b26c-2078b4794311);
//END_REGION General Store

//REGION Dolor try to kill Figaro

//The usual way, Figaro is alive
PROC
PROC_LOW_SerialKiller_FigarosSetupCommon()
AND
NOT DB_Defeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
AND
NOT DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal")
THEN
PROC_SetRelationMutual(Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 50);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, 50); //Neutral faction again until the end of the soliloqy
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "Figaro");
PROC_LOW_SerialKiller_MoveDolorAndDoppelgangersToFigaro();
SetFlag(LOW_SerialKiller_Event_DolorRevealHimself_b9cb8e1a-5ade-1834-7d6d-992f6a232063);
SetFlag((FLAG)LOW_SerialKiller_State_DolorAtFigaro_0c0df309-ff40-f3ef-9df4-c37b86f6e666);
TeleportTo(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, S_LOW_Figaros_TPFigaro_ecf89204-8305-4cdd-9ed4-34b4481b4af7);
Use((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, S_LOW_SerialKiller_Figaro_TortureChair_2186f0dc-4d25-4156-9c0b-f31cc54a33d7, 1, 1, "");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, "DefaultCharacter");
PROC_RemoveDialog(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
SetStoryDisplayName(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "SerialKiller_Dolor_Name"); //Rename Meztil as Dolor
PROC_CharacterDisableAllCrimes((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09);
PROC_LOW_SerialKiller_CloseFigaroDoors();
PROC_TriggerUnregisterForParty(S_LOW_SerialKiller_FigaroSecureZone_b8f776cf-e2f7-4202-a30d-823d20e74392);
//DB_OneShotPlayerTrigger((TRIGGER)S_LOW_SerialKiller_ADFigaroOut_d3ba3393-3e60-4d3c-9807-d8e67fb64e80);
DB_OneShotPlayerTrigger(S_LOW_SerialKiller_TriggerSoliloquy_bdf8d2c4-a5f0-4643-b597-07238364872e);
DB_GLO_DieFlag(LOW_SerialKiller_Event_DolorKillsFigaro_f0d3cf6c-3139-f174-b286-7f952381469f, (CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, DEATHTYPE.Physical, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
TeleportTo((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, S_LOW_SerialKiller_Figaros_ParalysisPoint_Assistant000_00e6752c-07ba-4232-850a-7e6a8fab173c);
TeleportTo((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, S_LOW_SerialKiller_Figaros_ParalysisPoint_Assistant001_34aca35e-a27c-4eb4-bfc9-4da75c79b676);
ApplyStatus((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, "LOW_SERIALKILLER_UNCONSCIOUS", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, "LOW_SERIALKILLER_UNCONSCIOUS", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_SetOnStage((CHARACTER)S_LOW_Figaros_CivilianWaiting_a302cea3-9950-48cb-828d-b8b35e397975, 0);
DB_CombatReact_AD_OnNextTurn(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, (DIALOGRESOURCE)LOW_SerialKiller_AD_Dolor_Threat1_0a001db5-97ee-e6f7-6a3f-e38e99f0dfc6);
DB_CombatReact_AD_OnNextTurn(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, (DIALOGRESOURCE)LOW_SerialKiller_AD_Dolor_Threat2_a172cb99-0ba6-d0af-fe34-4c2ee42077b9);
DB_AmbushTrigger(S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, S_LOW_SerialKiller_Figaro_AmbushZone_Detection_334e8fe6-6760-48dd-9485-bab4f3de209d, Act3_Easy_5028066b-6ea0-4a6a-9e3e-53bee62559a7);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, (GUIDSTRING)S_LOW_SerialKiller_Figaro_Doppelganger_006_3344edd8-94a2-42f7-b2a3-4cd4aa639a12, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, (GUIDSTRING)S_LOW_SerialKiller_Figaro_Doppelganger_007_15884103-c8b3-4c5f-b3b5-67ae481074c6, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, (GUIDSTRING)S_LOW_SerialKiller_Figaro_Doppelganger_005_d2ad989b-3e08-448e-bd66-ab132d83fafd, 1);

//Figaro is alive but player already kill the second victim, so no soliloquy and no Dolor there, only the doppelgangers. Dolor will be on Murder Tribunal.
PROC
PROC_LOW_SerialKiller_FigarosSetupCommon()
AND
NOT DB_Defeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
AND
DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal")
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, 0);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, 50); //Neutral faction again until the end of the soliloqy
PROC_SetRelationMutual(Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 50);
PROC_LOW_SerialKiller_MoveDolorAndDoppelgangersToFigaro();
SetFlag(LOW_SerialKiller_Event_DolorRevealHimself_b9cb8e1a-5ade-1834-7d6d-992f6a232063);
TeleportTo(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, S_LOW_Figaros_TPFigaro_ecf89204-8305-4cdd-9ed4-34b4481b4af7);
Die(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, Deathtype.Physical, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, 0, 1, 1.0);
SetStoryDisplayName(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "SerialKiller_Dolor_Name"); //Rename Meztil as Dolor
PROC_LOW_SerialKiller_CloseFigaroDoors();
TeleportTo((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, S_LOW_SerialKiller_Figaros_ParalysisPoint_Assistant000_00e6752c-07ba-4232-850a-7e6a8fab173c);
TeleportTo((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, S_LOW_SerialKiller_Figaros_ParalysisPoint_Assistant001_34aca35e-a27c-4eb4-bfc9-4da75c79b676);
ApplyStatus((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, "LOW_SERIALKILLER_UNCONSCIOUS", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, "LOW_SERIALKILLER_UNCONSCIOUS", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_SetOnStage((CHARACTER)S_LOW_Figaros_CivilianWaiting_a302cea3-9950-48cb-828d-b8b35e397975, 0);
PROC_LOW_SerialKiller_AddFigarosCharactersToCombatGroupButDolor();

//If Figaro is defeated but not dead, Dolor will get his hand with the partial setup in the previous step
PROC
PROC_LOW_SerialKiller_FigarosSetupCommon()
AND
DB_Defeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
AND
NOT DB_Dead((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
THEN
TeleportTo(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, S_LOW_Figaros_TPFigaro_ecf89204-8305-4cdd-9ed4-34b4481b4af7);
Die(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, DEATHTYPE.Physical, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, 0, 1, 1.0);
ToInventory((ITEM)S_LOW_SerialKiller_Hand_Figaro_f494ba51-9973-4328-b3fd-04b116281448, S_LOW_SerialKiller_DolorBag_43404e7f-b5a9-491d-b0ef-f3fc7f002229, 1, 0, 1);

//Figaro's Setup if Figaro is Defeated
PROC
PROC_LOW_SerialKiller_FigarosSetupCommon()
AND
DB_Defeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, 50); //Neutral faction again until the end of the soliloqy
PROC_SetRelationMutual(Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 50);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, 0);
SetFlag((FLAG)LOW_SerialKiller_State_FigaroAlreadyDeadSetup_ed3aa8f2-b822-4073-b1dc-aacc13aa28f5);
PROC_LOW_SerialKiller_MoveDolorAndDoppelgangersToFigaro();
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal");
PROC_RemoveDialog(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
SetStoryDisplayName(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "SerialKiller_Dolor_Name"); //Rename Meztil as Dolor
PROC_LOW_SerialKiller_CloseFigaroDoors();
PROC_TriggerUnregisterForParty(S_LOW_SerialKiller_FigaroSecureZone_b8f776cf-e2f7-4202-a30d-823d20e74392);
DB_OneShotPlayerTrigger(S_LOW_SerialKiller_TriggerSoliloquy_bdf8d2c4-a5f0-4643-b597-07238364872e);
TeleportTo((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, S_LOW_SerialKiller_Figaros_ParalysisPoint_Assistant000_00e6752c-07ba-4232-850a-7e6a8fab173c);
TeleportTo((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, S_LOW_SerialKiller_Figaros_ParalysisPoint_Assistant001_34aca35e-a27c-4eb4-bfc9-4da75c79b676);
ApplyStatus(LOW_SerialKiller_Figaro_Assistant_000_173022ff-f99a-81dc-27be-86f96808cd1d, "LOW_SERIALKILLER_UNCONSCIOUS", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, "LOW_SERIALKILLER_UNCONSCIOUS", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_LOW_SerialKiller_AddFigarosCharactersToCombatGroupButDolor();
ToInventory(S_LOW_SerialKiller_NoteFromOrin_FigarosBody_fd96ca11-3ad0-4eeb-b550-d5e800e92592, S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, 1, 0, 1);

//Common part of Figaro's Setup, check if Devella is still alive
PROC
PROC_LOW_SerialKiller_FigarosSetupCommon()
AND
NOT DB_Defeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
NOT DB_Defeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
AND
IsActive(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, 0)
THEN
PROC_LOW_SerialKiller_SetupDevellaAtFigaros();

PROC
PROC_LOW_SerialKiller_FigarosSetupCommon()
AND
NOT DB_Defeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
NOT DB_Defeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
AND
IsActive(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, 1)
THEN
DB_LOW_SerialKiller_DevellaToFigaros(1);

IF
WentOnStage(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, 0)
AND
DB_LOW_SerialKiller_DevellaToFigaros(1)
THEN
NOT DB_LOW_SerialKiller_DevellaToFigaros(1);
PROC_LOW_SerialKiller_SetupDevellaAtFigaros();

PROC
PROC_LOW_SerialKiller_SetupDevellaAtFigaros()
THEN
PROC_ResumeStoryMoving(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (DIALOGRESOURCE)LOW_SerialKiller_Devella_Dead_b08454c0-23bd-8cbf-42c3-52bff94c25ab);
SetFaction(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799);
PROC_RemoveDialog(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (DIALOGRESOURCE)LOW_SerialKiller_Figaro_Devella_AfterParalysis_5683b9b3-136d-d860-bc93-376b8bc78c23);
SetFlag(LOW_Elfsong_Event_DvellaStopSpotting_5fceb72f-1060-4754-9b65-99211513aac6); //Dvella stop spotting
ApplyStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_SerialKiller_DevellaWillIgnoreCrime(1);

//If Figaro was warned, adding a dagger to his inventory as "protection"
PROC
PROC_LOW_SerialKiller_FigarosSetupCommon()
AND
DB_GlobalFlag((FLAG)LOW_Figaro_SellingThings_State_FigaroKnowsTargetList_cd785159-9139-4b7f-28d7-9bd6993c3569)
AND
NOT DB_Defeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
THEN
TemplateAddTo((ITEMROOT)WPN_HUM_Dagger_A_0_569b0f3d-abcd-4b01-aaf0-979091288163, S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, 1, 0);

//Figaro's dead, Devella is alive before the murder
PROC
PROC_LOW_SerialKiller_FigarosSetupCommon()
AND
DB_Defeated(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
AND
NOT DB_Defeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
THEN
Die(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, DEATHTYPE.Physical, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, 0, 1, 1.0);
DB_GLO_CharacterCorpseDialog(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (DIALOGRESOURCE)LOW_SerialKiller_Devella_Dead_b08454c0-23bd-8cbf-42c3-52bff94c25ab);

//Removing Dolor from Figaro's combat group setup if players kill the second target after the setup for figaro

IF
DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "Figaro")
THEN
DB_LOW_SerialKiller_DolorWasInFigaros(1);

PROC
PROC_State_Progress( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal")
AND
DB_LOW_SerialKiller_DolorWasInFigaros(1)
THEN
NOT DB_LOW_SerialKiller_DolorWasInFigaros(1);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, 0);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)Act3_LOW_Figaro_d91dd3bb-b2b5-4d72-857b-e875cbbc2744, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
RemoveStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", NULL_00000000-0000-0000-0000-000000000000);//Removing the unlimited paralysis
ApplyStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, "LOW_SERIALKILLER_PARALYZED", NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, "LOW_SERIALKILLER_PARALYZED", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_State_Progress( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal")
THEN
SetCombatGroupID(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "");
PROC_RemoveOneShotTrigger(S_LOW_SerialKiller_TriggerSoliloquy_bdf8d2c4-a5f0-4643-b597-07238364872e);
NOT DB_LOW_SerialKiller_FigarosDoors((ITEM)S_LOW_SerialKiller_FigaroDoor_Far_02e41e0d-6b50-44dd-8dfd-1d135762903c, (FLAG)LOW_SerialKiller_State_Figaro_PlayersUseFarDoor_25d159d9-fcb0-4172-944f-22f89617f665);
NOT DB_LOW_SerialKiller_FigarosDoors((ITEM)S_LOW_SerialKiller_FigaroDoor_Near_6a089d5e-febd-4d0c-84b1-52610a4a7bb1, (FLAG)LOW_SerialKiller_State_Figaro_PlayersUseNearDoor_47db30b5-35eb-4910-a876-8050ccdbe316);

//If Dolor runs away from the Wine festival because cora was the second victim for players, Dolor will be on Murder Tribunal and doppelgangers on Figaro's
PROC
PROC_LOW_FigarosSetup_NotLongRest("NotKillCora")
AND
DB_GlobalFlag(LOW_SerialKiller_State_PlayersKillSecondTargetList_68c5736d-8b62-4e30-bc9c-0f3bcae40629)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "WineFestival")
THEN
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal");

//If players kill cora during the wine festival, Dolor will be here after running away
PROC
PROC_LOW_FigarosSetup_NotLongRest("NotKillCora")
AND
NOT QRY_LOW_SerialKiller_CharactersNearFigaro()
THEN
PROC_LOW_SerialKiller_FigarosSetupCommon();

PROC
PROC_LOW_FigarosSetup_NotLongRest("NotKillCora")
AND
QRY_LOW_SerialKiller_CharactersNearFigaro()
THEN
DB_LOW_SerialKiller_WaitingFigaroBeFree("NotKillCora");

PROC
PROC_LOW_FigarosSetup_NotLongRest("KilledCora")
AND
NOT QRY_LOW_SerialKiller_CharactersNearFigaro()
THEN
PROC_LOW_SerialKiller_FigarosSetupCommon();
PROC_LOW_DolorHaveCoraHand();

PROC
PROC_LOW_FigarosSetup_NotLongRest("KilledCora")
AND
QRY_LOW_SerialKiller_CharactersNearFigaro()
THEN
DB_LOW_SerialKiller_WaitingFigaroBeFree("KilledCora");

PROC
PROC_LOW_SerialKiller_CloseFigaroDoors()
AND
DB_LOW_SerialKiller_FigarosDoors(_Door, _)
THEN
Close(_Door);

//TryAgain if characters leave the zone
IF
LeftTrigger(_Character, S_LOW_SerialKiller_FigaroSecureZone_b8f776cf-e2f7-4202-a30d-823d20e74392)
AND
DB_LOW_SerialKiller_WaitingFigaroBeFree("KilledCora")
AND
NOT QRY_LOW_SerialKiller_CharactersNearFigaro()
THEN
NOT DB_LOW_SerialKiller_WaitingFigaroBeFree("KilledCora");
PROC_LOW_FigarosSetup_NotLongRest("KilledCora");

IF
LeftTrigger(_Character, S_LOW_SerialKiller_FigaroSecureZone_b8f776cf-e2f7-4202-a30d-823d20e74392)
AND
DB_LOW_SerialKiller_WaitingFigaroBeFree("NotKillCora")
AND
NOT QRY_LOW_SerialKiller_CharactersNearFigaro()
THEN
NOT DB_LOW_SerialKiller_WaitingFigaroBeFree("NotKillCora");
PROC_LOW_FigarosSetup_NotLongRest("NotKillCora");

//Move Dolor and the Doppelgangers to their positions
PROC
PROC_LOW_SerialKiller_MoveDolorAndDoppelgangersToFigaro()
AND
NOT DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_LOW_SerialKiller_SceneAtFigaros(_Character, _Trigger, _)
AND
_Character != S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134
AND
_Character != S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81
THEN
TeleportTo(_Character, _Trigger);
PROC_SetOnStage(_Character, 1);

//Section for Devella
PROC
PROC_LOW_SerialKiller_MoveDolorAndDoppelgangersToFigaro()
AND
NOT DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
DB_LOW_SerialKiller_SceneAtFigaros(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _Trigger, _)
AND
IsActive(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, 0)
THEN
TeleportTo(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _Trigger);
PROC_SetOnStage(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, 1);
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, S_LOW_Elfsong_DevellaDissapearOutOfSighTo_6f5f2ef4-4329-4d8b-a6ec-355526d969f1, "Run", 1, "");
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, S_LOW_Elfsong_DevellaDissapearOutOfSighTo_6f5f2ef4-4329-4d8b-a6ec-355526d969f1, "Run", 1, "");

PROC
PROC_LOW_SerialKiller_MoveDolorAndDoppelgangersToFigaro()
AND
NOT DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_LOW_SerialKiller_SceneAtFigaros(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _Trigger, _)
AND
IsActive(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, 1)
THEN
PROC_LOW_Elfsong_DevellaDownstairs();

IF
EntityEvent(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Elfsong_DevellaIsAway")
AND
DB_LOW_SerialKiller_SceneAtFigaros((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, (TRIGGER)_Trigger, _)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","Figaro")
THEN
TeleportTo(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _Trigger);
PROC_SetOnStage(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, 1);

//Move Dolor and the Doppelgangers to their positions
PROC
PROC_LOW_SerialKiller_MoveDolorAndDoppelgangersToFigaro()
AND
NOT DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_LOW_SerialKiller_SceneAtFigaros(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _Trigger, _)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","Figaro")
THEN
TeleportTo(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _Trigger);
PROC_SetOnStage(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, 1);

PROC
PROC_LOW_SerialKiller_MoveDolorAndDoppelgangersToFigaro()
AND
NOT DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_LOW_SerialKiller_SceneAtFigaros(_Character, _, _Dialog)
AND
_Dialog != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_Dialogs(_Character, _Dialog);


//Add the hand to Dolor's Inventory only if player didn't get it.
PROC
PROC_LOW_DolorHaveCoraHand()
AND
NOT DB_GlobalFlag((FLAG)LOW_SerialKiller_State_Cora_SeveredHand_d8c2c89a-235d-486c-9bf7-4f5aed0b84e7)
THEN
ToInventory(S_LOW_SerialKiller_Hand_Cora_e8b086d8-1b22-47ac-adf8-7e165fdf99ab, S_LOW_SerialKiller_DolorBag_43404e7f-b5a9-491d-b0ef-f3fc7f002229, 1, 0, 1);

//Enter Figaro's frontyard and hear Doppelganger AD
PROC
PROC_OneShotTriggerEntered(_Player, (TRIGGER)S_LOW_SerialKiller_ADFigaroOut_d3ba3393-3e60-4d3c-9807-d8e67fb64e80)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SerialKiller_Figaro_Doppelganger_001_AD_FigaroClosedStore_b4ae65ee-0d99-6e13-cb07-b0a4c09b30ca, S_LOW_SerialKiller_Figaro_Doppelganger_001_a4f560e6-8869-4316-a674-aee94da4cee0);

IF
KilledBy((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _StoryID)
AND
NOT DB_GlobalFlag(LOW_SerialKiller_Event_DolorKillsFigaro_f0d3cf6c-3139-f174-b286-7f952381469f)
THEN
SetFlag(LOW_SerialKiller_Event_DolorKillsFigaro_f0d3cf6c-3139-f174-b286-7f952381469f);

IF
EntityEvent(_, "LOW_SerialKiller_FigaroKilled")
THEN
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal");

//If Soliloquy fails to start here, second +1, fallback to combat
PROC
PROC_OneShotTriggerEntered(_Player, S_LOW_SerialKiller_TriggerSoliloquy_bdf8d2c4-a5f0-4643-b597-07238364872e)
AND
DB_Players(_Player)
AND
NOT DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_PermaDefeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, _Player)
THEN
SetFlag((FLAG)LOW_SerialKiller_State_SoliloquyCannotBeTriggered_2daea396-6a7d-4f79-9f1d-f8e40f968e64);
PROC_LOW_SerialKiller_HostilityAtFigaro(_Player);
RemoveStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", NULL_00000000-0000-0000-0000-000000000000);//Removing the unlimited paralysis
ApplyStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);

//Trigger Dolor's Soliloquy when using the door
IF
UseStarted(_Players, _Door)
AND
DB_LOW_SerialKiller_FigarosDoors(_Door, _Flag)
AND
DB_Players(_Players)
AND
IsTagged(_Players, (TAG)HUMANOID_7fbed0d4-cabc-4a9d-804e-12ca6088a0a8, 1)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","Figaro")
AND
QRY_OnlyOnce("LOW_SerialKiller_DolorSoliloquy")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, _Players)
THEN
SetFlag(_Flag);
PROC_LOW_SerialKiller_AddFigarosCharactersToCombatGroup();

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae, (INTEGER)_ID)
AND
NOT DB_PermaDefeated(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
THEN
PROC_DialogAddSpeakingActor(_ID,(GUIDSTRING)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);

IF
DialogEnded(LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae, _)
AND
NOT DB_Dead(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
THEN
RemoveStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", NULL_00000000-0000-0000-0000-000000000000);//Removing the unlimited paralysis
ApplyStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);

IF
DialogEnded(LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae, _)
AND
NOT DB_Dead(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
THEN
ApplyStatus(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, "LOW_SERIALKILLER_PARALYZED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(LOW_SerialKiller_Figaro_Event_SuccessHiding_46ea804c-37d3-48d0-8259-b2fd6be2da44, _Player, _ID)
THEN
DB_LOW_SerialKiller_HidingDone(1);
TeleportTo(_Player, S_LOW_SerialKiller_HidingSoliloquyPoint_77c5eb3c-f41d-4073-9428-b81252d325be, "LOW_SerialKiller_TeleportedStealth", 0, 0, 0, 0, 1);

IF
FlagSet(LOW_SerialKiller_Figaro_Event_FailedHiding_64449e96-99ae-4c4f-be7c-4e3a3fb94f88, _Player, _)
THEN
PROC_RemoveOneShotTrigger(S_LOW_SerialKiller_TriggerSoliloquy_bdf8d2c4-a5f0-4643-b597-07238364872e);
TeleportTo(_Player, S_LOW_SerialKiller_FailStealthTeleport_Main_0cddc775-c73f-490a-9245-d920a1db0a7f, "LOW_SerialKiller_TeleportedFaileDStealth", 0, 1, 1, 0, 1);
DB_LOW_SerialKiller_FailedStealth((CHARACTER)_Player);

IF
DialogEnded(LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae, _)
AND
DB_LOW_SerialKiller_FailedStealth(_Player)
THEN
PROC_LaunchAmbush(S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, _Player);
NOT DB_LOW_SerialKiller_FailedStealth(_Player);
RemoveStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", NULL_00000000-0000-0000-0000-000000000000);//Removing the unlimited paralysis
ApplyStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);

IF
EntityEvent(_Player, "LOW_SerialKiller_TeleportedStealth")
AND
HasActiveStatus(_Player, "SNEAKING", 0)
THEN
UseSpell(_Player,"Shout_Hide",_Player);

IF
DB_LOW_SerialKiller_HidingDone(1)
AND
DB_PartyMembers(_OtherPlayer)
AND
DB_InRegion(_OtherPlayer, S_LOW_SerialKiller_Figaro_SUB_13409b18-250a-4259-826f-e30733e12783)
AND
HasActiveStatus(_OtherPlayer, "SNEAKING", 0)
THEN
UseSpell(_OtherPlayer,"Shout_Hide",_OtherPlayer);

//Removing HidingDone if players enter combat

PROC
PROC_LOW_SerialKiller_AddFigarosCharactersToCombatGroup()
AND
DB_LOW_SerialKiller_SceneAtFigaros(_Character, _, _)
THEN
SetCombatGroupID(_Character, "LOW_SerialKiller_DolorAtFigarosCG");

//Only if Figaro was already killed
PROC
PROC_LOW_SerialKiller_AddFigarosCharactersToCombatGroupButDolor()
AND
DB_LOW_SerialKiller_SceneAtFigaros(_Character, _, _)
AND
_Character != S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134
THEN
SetCombatGroupID(_Character, "LOW_SerialKiller_FigarosButNotDolor");

QRY
QRY_SerialKiller_IgnorePrisonEscape((STRING)_CrimeType)
AND
DB_LOW_SerialKiller_DevellaIgnoreCrimes(_CrimeType)
THEN
DB_NOOP(1);

//Devella will ignore prison escape crime until the end of the scene
PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_CrimeID, (CHARACTER)_Player, (STRING)_CrimeType, (GUIDSTRING)_, (CHARACTER)_)
AND
DB_Players(_Player)
AND
QRY_SerialKiller_IgnorePrisonEscape(_CrimeType)
AND
DB_LOW_SerialKiller_DevellaWillIgnoreCrime(1)
AND
NOT DB_LOW_SerialKiller_IgnoredCrimesIDs(_CrimeID)
THEN
DB_LOW_SerialKiller_IgnoredCrimesIDs(_CrimeID);
CrimeIgnoreCrime(_CrimeID, S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);

//END_REGION

//REGION QRY_LOW_SerialKiller_CharactersNearFigaro

QRY
QRY_LOW_SerialKiller_CharactersNearFigaro()
AND
DB_PartyMembers(_PartyMember)
AND
DB_InRegion(_PartyMember, S_LOW_SerialKiller_FigaroSecureZone_b8f776cf-e2f7-4202-a30d-823d20e74392)
THEN
DB_NOOP(1);
//END_REGION

//REGION Attack Dolor at Figaros

IF
AttackedBy((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _Attacker, _, _, _, _, _StoryID)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","Figaro")
AND
DB_PartyMembers((CHARACTER)_Attacker)
AND
QRY_OnlyOnce("LOW_SerialKiller_DolorBeingAttackedFigaro")
THEN
PROC_ForceStopDialog(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
PROC_TryStartAD((DIALOGRESOURCE)LOW_SerialKiller_AD_DolorBeingAttackedFigaro_56118f56-464d-5e9c-69d7-25d0835c1e83, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
PROC_LOW_SerialKiller_HostilityAtFigaro(_Attacker);


//END_REGION

//REGION Killing Dolor and being hostile to him

//Doppelganger ambush factions
PROC
PROC_LaunchAmbush((TRIGGER)S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, (CHARACTER)_Player)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, 0);

//Adding the players to a custom DB when they start combat with Dolor
IF
DB_Is_InCombat(_Player, _CombatGuid)
AND
DB_Is_InCombat(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _CombatGuid)
AND
NOT DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Player, _CombatGuid)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","Figaro")
AND
DB_Players((CHARACTER)_Player)
THEN
DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Player, _CombatGuid);

IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Player, _CombatGuid)
AND
DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_Defeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
AND
QRY_OnlyOnce("LOW_SerialKiller_FinishedCombatAtFigaro")
THEN
PROC_RemoveDialog((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09);
PROC_SetAnubisConfig((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, "LOW_SerialKiller_Figaro");
DB_Dialogs((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, (DIALOGRESOURCE)LOW_Figaro_SellingThings_aac70e59-5957-5b56-bea7-fd00b13ab95a);

IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Player, _CombatGuid)
AND
DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_Defeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
THEN
AddAttitudeTowardsPlayer(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, (CHARACTER)_Player, 100);

IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Player, _CombatGuid)
AND
DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
THEN
RemoveStatus(S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, "LOW_SERIALKILLER_UNCONSCIOUS", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, "LOW_SERIALKILLER_UNCONSCIOUS", NULL_00000000-0000-0000-0000-000000000000);
PROC_CharacterMoveTo((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, LOW_SerialKiller_Figaro_BackstoreWanderPoint_fc15ef62-5426-4388-a789-edbf83e0ec1b, "Walk", "");
PROC_CharacterMoveTo((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, S_LOW_SerialKiller_AfterDolorTrigger_Assistant_000_d5a8a4e5-9f0f-4af7-b73d-dc731c2329e1, "Walk", "");
PROC_AppearOutOfSightTo(S_LOW_Figaros_CivilianWaiting_a302cea3-9950-48cb-828d-b8b35e397975, LOW_SerialKiller_Figaro_BackstoreWanderPoint_fc15ef62-5426-4388-a789-edbf83e0ec1b, S_LOW_Figaros_CivilianWaiting_a302cea3-9950-48cb-828d-b8b35e397975, "");
PROC_DisappearOutOfSight(S_LOW_SerialKiller_Figaro_CivilianOutside_000_bc6b17c7-b681-4607-bc4a-c578aa3cb55d, "Walk", 0, "");
PROC_DisappearOutOfSight(S_LOW_SerialKiller_Figaro_CivilianOutside_001_9fd43e05-2158-487c-9c08-57b0c2caf7d8, "Walk", 0, "");

//Removing paralysis to Figaro after combat ends
IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Player, _CombatGuid)
AND
NOT DB_PermaDefeated(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
THEN
RemoveStatus(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, "LOW_SERIALKILLER_PARALYZED", NULL_00000000-0000-0000-0000-000000000000);

//After combat ended, Devella spotting
IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Player, _CombatGuid)
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
HasActiveStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", 0)
AND
QRY_OnlyOnce("LOW_SerialKiller_DolorDead_TryTalk")
THEN
PROC_ForceStopDialog(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);//To stop the possible combat ADs
TriggerUnregisterForCharacter((TRIGGER)S_LOW_SerialKiller_Figaro_SUB_13409b18-250a-4259-826f-e30733e12783, (CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);
PROC_CharacterMoveToAndTalk(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _Player, LOW_SerialKiller_Figaro_Devella_AfterParalysis_5683b9b3-136d-d860-bc93-376b8bc78c23, "LOW_SerialKiller_DolorDead_DevellaTryingTalk", "Sprint", 20.0);

IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Player, _CombatGuid)
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
HasActiveStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", 1)
AND
QRY_OnlyOnce("LOW_SerialKiller_DolorDead_TryTalk")
THEN
DB_LOW_SerialKiller_DevellaAfterCombat_DelayedStart(_Player);
TriggerUnregisterForCharacter((TRIGGER)S_LOW_SerialKiller_Figaro_SUB_13409b18-250a-4259-826f-e30733e12783, (CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);

IF
StatusRemoved(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", _, _)
AND
DB_LOW_SerialKiller_DevellaAfterCombat_DelayedStart(_Player)
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
THEN
NOT DB_LOW_SerialKiller_DevellaAfterCombat_DelayedStart(_Player);
PROC_CharacterMoveToAndTalk(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _Player, LOW_SerialKiller_Figaro_Devella_AfterParalysis_5683b9b3-136d-d860-bc93-376b8bc78c23, "LOW_SerialKiller_DolorDead_DevellaTryingTalk", "Sprint", 20.0);

IF
CharacterMoveToAndTalkFailed(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _Player, "LOW_SerialKiller_DolorDead_DevellaTryingTalk", _)
THEN
PROC_GlobalClearFlagAndCache(LOW_Elfsong_Event_DvellaStopSpotting_5fceb72f-1060-4754-9b65-99211513aac6);
DB_SpotPlayers((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Figaros_DevellaSpotting",
	NULL_00000000-0000-0000-0000-000000000000, LOW_Elfsong_Event_DvellaStopSpotting_5fceb72f-1060-4754-9b65-99211513aac6);

//Devella spots us
PROC
PROC_SpotPlayers_Spotted(_Spotter, "LOW_Figaros_DevellaSpotting", (CHARACTER)_Target)
AND
DB_Players(_Target)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_SerialKiller_Figaro_Devella_AfterParalysis_5683b9b3-136d-d860-bc93-376b8bc78c23, (CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _Target)
THEN
SetFlag(LOW_Elfsong_Event_DvellaStopSpotting_5fceb72f-1060-4754-9b65-99211513aac6);

//Cleaning combat databases
IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Character, _CombatGuid)
THEN
NOT DB_LOW_SerialKiller_PlayersIncombat_Figaros(_Character, _CombatGuid);

IF
DialogEnded((DIALOGRESOURCE)LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae, _ID)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_SerialKiller_Event_DolorFigaroAtk_ca877930-7d30-9c1e-d8d8-a7a35dc68eb7, _Player, 1)
AND
QRY_OnlyOnce("LOW_SerialKiller_CombatAfterSoliloquy")
THEN
ClearFlag(LOW_SerialKiller_Event_DolorFigaroAtk_ca877930-7d30-9c1e-d8d8-a7a35dc68eb7);
PROC_LOW_SerialKiller_HostilityAtFigaro(_Player);

PROC
PROC_LOW_SerialKiller_HostilityAtFigaro((CHARACTER)_Player)
THEN
PROC_CancelAmbush(S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9);
SetHostileAndEnterCombat((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _Player);
SetHostileAndEnterCombat((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _Player);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, 0);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);

IF
DialogEnded((DIALOGRESOURCE)LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae, _ID)
AND
DB_LOW_SerialKiller_HidingDone(1)
THEN
NOT DB_LOW_SerialKiller_HidingDone(1);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, 0);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, 0);

IF
GameBookInterfaceClosed((ITEM)S_LOW_SerialKiller_NoteFromOrin_9c029a99-2636-4c19-9ff3-c7564a91cd35, _Player)
AND
QRY_OnlyOnce("LOW_SerialKiller_ReadOrinNote")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SerialKiller_PAD_ReadingDolorsNote_c695d271-ed3a-a61b-6a61-9bebf5e67b7a, _Player);

PROC
PROC_LongRest_InLevel("CTY_Main_A")
AND
DB_PermaDefeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
NOT DB_GlobalFlag(LOW_SerialKiller_State_DevellaOnBasiliskGate_c35f72bb-834c-496a-9d02-99679c612bc2)
THEN
PROC_LOW_SerialKiller_DevellaToBasilisk();

PROC
PROC_LongRest()
AND
DB_PermaDefeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT DB_GlobalFlag(LOW_SerialKiller_State_DevellaOnBasiliskGate_c35f72bb-834c-496a-9d02-99679c612bc2)
THEN
DB_LOW_SerialKiller_DevellaToBasiliskAfterLoad(1);

IF
LevelLoaded("CTY_Main_A")
AND
DB_LOW_SerialKiller_DevellaToBasiliskAfterLoad(1)
THEN
NOT DB_LOW_SerialKiller_DevellaToBasiliskAfterLoad(1);
PROC_LOW_SerialKiller_DevellaToBasilisk();

PROC
PROC_LOW_SerialKiller_DevellaToBasilisk()
THEN
TeleportTo(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, S_LOW_SerialKiller_FinalDevellaPoint_477f0e94-4227-45ff-96c7-02e2d2d252cb);
PROC_SetOnStage(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, 1);
PROC_RemoveDialog(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);
DB_Dialogs(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, LOW_Devella_Fountainhead_BasiliskGate_OneLiner_2a6af5aa-697c-593e-65e5-5c9d22782ef9);
SetFlag((FLAG)LOW_SerialKiller_State_DevellaOnBasiliskGate_c35f72bb-834c-496a-9d02-99679c612bc2);
PROC_SetAnubisConfig((CHARACTER)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "DefaultCharacter");

IF
DialogEnded(LOW_SerialKiller_Figaro_Devella_AfterParalysis_5683b9b3-136d-d860-bc93-376b8bc78c23, _)
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_Event_DevellaGoingBasiliskGate_274ab2d5-a9cb-a8cd-d21d-39ac3949c108)
AND
NOT DB_Defeated(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
THEN
PROC_DisappearOutOfSight((CHARACTER)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "Run", 1, "LOW_SerialKiller_DevellaGoingToBasilisk");
ClearFlag((FLAG)LOW_SerialKiller_Event_DevellaGoingBasiliskGate_274ab2d5-a9cb-a8cd-d21d-39ac3949c108);
PROC_SetAnubisConfig((CHARACTER)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "DefaultCharacter");

//Removing Devella ignoring prison escape crime
IF
DB_GlobalFlag((FLAG)LOW_SerialKiller_Event_DevellaGoingBasiliskGate_274ab2d5-a9cb-a8cd-d21d-39ac3949c108)
AND
NOT DB_Defeated(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
DB_LOW_SerialKiller_IgnoredCrimesIDs(_CrimeID)
THEN
NOT DB_LOW_SerialKiller_IgnoredCrimesIDs(_CrimeID);
CrimeStopIgnoringCrime(_CrimeID, S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);

IF
EntityEvent(S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SerialKiller_DevellaGoingToBasilisk")
THEN
PROC_AppearOutOfSightTo((CHARACTER)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, S_LOW_SerialKiller_FinalDevellaPoint_477f0e94-4227-45ff-96c7-02e2d2d252cb, S_LOW_SerialKiller_FinalDevellaPoint_477f0e94-4227-45ff-96c7-02e2d2d252cb, "");
SetFlag((FLAG)LOW_SerialKiller_State_DevellaOnBasiliskGate_c35f72bb-834c-496a-9d02-99679c612bc2);
PROC_RemoveDialog(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);
DB_Dialogs(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, LOW_Devella_Fountainhead_BasiliskGate_OneLiner_2a6af5aa-697c-593e-65e5-5c9d22782ef9);

IF
DB_GlobalFlag(LOW_SerialKiller_State_DevellaOnBasiliskGate_c35f72bb-834c-496a-9d02-99679c612bc2)
THEN
//Can be two spottings, try to stop both just in case as fallback.
PROC_SpotPlayers_StopSpotting(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Figaros_DevellaSpotting");
PROC_SpotPlayers_StopSpotting(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_ElfsongTavern_DevellaSpotting");
//END_REGION

//REGION Store if Figaro is Dead

IF
DB_PermaDefeated((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
THEN
PROC_SetCustomTradeTreasure((CHARACTER)S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, "LOW_Figaro_Assistant");

//END_REGION

//REGION Event ADs

IF
DB_GlobalFlag(LOW_SerialKiller_Figaros_State_WaitingToChatter_3455890f-78e8-4671-b568-b129712e86c6)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SerialKiller_Figaro_AD_AssistantsChatting_b0be71e0-2c50-3ba2-9c18-1640a6bbefd8, S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f,  S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061);

//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
