Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_DeadOnceFlag(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,(FLAG)LOW_SerialKiller_State_DolorIsDead_fa48e3fe-dc3c-b5c5-09f1-039a5b6974cf);
DB_PermaDefeatedFlag(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,(FLAG)LOW_SerialKiller_State_DolorIsPermaDefeated_a1ca5851-fea5-4536-934a-b402ac8d92a6);
DB_DeadOnceFlag(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81,(FLAG)LOW_SerialKiller_State_DevellaIsDead_156d25aa-f1b8-47af-9fd5-da374420dc95);
DB_PermaDefeatedFlag(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81,(FLAG)LOW_SerialKiller_State_DevellaIsPermaDefeated_944a98e2-fb7a-4259-9061-928793071330);

DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, (DIALOGRESOURCE)LOW_SerialKiller_Dolor_Dead_05ad2965-db75-88bb-adfd-8504175b444f);
DB_LOW_SerialKiller_VictimsAndCrimeTriggers(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, S_LOW_SerialKiller_WineFestival_SUB_dcc45981-c2a2-43db-b89a-479f7debb4d2);
DB_LOW_SerialKiller_VictimsAndCrimeTriggers(S_LOW_Elfsong_Reevor_3e5b30c3-ae3a-48b6-9394-11adde54ad57, S_LOW_Elfsong_Kitchen_Ownership_4755a8af-9e30-4c46-9de2-2fd99d9d0516);
DB_LOW_SerialKiller_VictimsAndCrimeTriggers(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, S_LOW_SerialKiller_TriggerSoliloquy_bdf8d2c4-a5f0-4643-b597-07238364872e);
//REGION OtherHouses
Die(S_LOW_SerialKiller_Franc_Peartree_1556e29c-a876-4853-9ea7-283a48703a56, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 1.0);
Die(S_LOW_SerialKiller_AlexanderRainforest_18fe60a8-7235-4450-ac5b-fcbf15bdae88, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 1.0);
PROC_TriggerRegisterForPlayers(S_LOW_SerialKiller_AlexanderHouse_SawBody_89c03b92-8b39-42c4-ba1b-0ff8583fbfe2);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_SerialKiller_Franc_Peartree_1556e29c-a876-4853-9ea7-283a48703a56, (DIALOGRESOURCE)LOW_SerialKiller_SwD_FrancPeartree_6fed613c-42ae-658d-80a6-cf5c0c0c0ba7);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_SerialKiller_AlexanderRainforest_18fe60a8-7235-4450-ac5b-fcbf15bdae88, (DIALOGRESOURCE)LOW_SerialKiller_SwD_AlexanderRainforest_eed23034-b030-e87a-91e4-c0e27575ded8);
DB_Dialogs(S_LOW_SerialKiller_Rat_Witness_28eabcbd-8297-4959-b6ca-a99cec39ed51, LOW_SerialKiller_SwA_RatWitness_09dbdb7a-b419-6fa9-df25-332d87dc570c);
//Hide the double door on Peartree's house
SetOnStage(S_Door_HeapsideBottomA_299081b0-8dbf-4aac-8a80-6bbb17c64375, 0);

DB_LOW_SerialKiller_DoppelgangerPauseRegions((TRIGGER)S_LOW_SerialKiller_HighberrysHouse_NoGiverZone_3ea992fd-639c-4bf1-92cb-0f5f91fe52d2);
DB_LOW_SerialKiller_DoppelgangerPauseRegions((TRIGGER)S_LOW_SerialKiller_Figaro_NoGiverZone_9138226b-741e-46c1-9638-521d09f4bfa5);
DB_LOW_SerialKiller_DoppelgangerPauseRegions((TRIGGER)S_LOW_SerialKiller_Elfsong_NoGiverZone_3d00a1ee-2f8b-40ae-b7b4-569060cf5483);
DB_LOW_SerialKiller_DoppelgangerPauseRegions((TRIGGER)S_LOW_SerialKiller_BlushingMermaid_NoGiverZone_502a50c1-3f12-409c-9c39-1cc0666d96e4);
DB_LOW_SerialKiller_DoppelgangerPauseRegions((TRIGGER)S_LOW_SerialKiller_BasiliskGate_NoGiverZone_a2baa89f-d5c5-45f8-baee-7bb9942e88a8);
DB_LOW_SerialKiller_DoppelgangerPauseRegions((TRIGGER)S_LOW_SerialKiller_BasiliskGatePrison_NoGiverZone_78acc566-3a3a-46bb-b203-0b4c0318a6d9);
//END_REGION

//REGION PADs about Murder Tableux
DB_GEN_SerialKiller_TableuxPADs((CHARACTER)S_LOW_FakeAbazigal_Corpse_0d20d453-e593-45af-85f7-c6081d1e6781, (FLAG)LOW_SerialKiller_Event_SawAbazigalTableu_279d6b39-92e5-400a-8bc4-fdccae2c7b94, "LOW_FakeAbazigal", (TRIGGER)S_LOW_FakeAbazigal_Corpse_Area_c27d611f-f5f8-4480-9533-3f978687487c);
DB_GEN_SerialKiller_TableuxPADs((CHARACTER)S_LOW_SerialKiller_FakeYagaShura_deecbcbc-aab6-41f5-a534-ace00fe38b33, (FLAG)LOW_SerialKiller_Event_SawYagaShuraTableu_f99e80a7-899c-4c15-bdf9-320f4993bda4, "LOW_FakeYagaShura", (TRIGGER)S_LOW_SerialKiller_FakeYagaShura_Area_dfdd1f6e-c4f9-4751-8c9b-06507518fdae);
DB_GEN_SerialKiller_TableuxPADs((CHARACTER)S_LOW_SerialKiller_FakeBalthazar_0a522d54-ac41-43ac-bf33-e4b3d7f85ee0, (FLAG)LOW_SerialKiller_Event_SawIBalthazarTableu_0becefe2-0479-4497-8741-48171a1bfc77, "LOW_FakeBalthazar", (TRIGGER)S_LOW_SerialKiller_FakeBalthazar_Area_1fb1a270-ac5b-45b3-8ea4-ea7bd0bbb7b3);
DB_GEN_SerialKiller_TableuxPADs((CHARACTER)S_LOW_FakeSendai_Corpse_001_86ccda32-2196-40fb-92ea-ed534c8021ae, (FLAG)LOW_SerialKiller_Event_SawSendaiTableu_350681aa-93b0-43f4-a050-6dd141ed1623, "LOW_FakeSendai", (TRIGGER)S_LOW_FakeSendai_Corpse_001_Area_af78b403-0ac4-4c46-8f63-a7bdd2de2ae2);
DB_GEN_SerialKiller_TableuxPADs((CHARACTER)S_LOW_SerialKiller_Amelyssan_FakeAmelyssan_8013105c-2bb0-43a1-9ede-fdcc9593969a, (FLAG)LOW_SerialKiller_Event_SawAmelyssanTableu_f48e2f4f-af9f-48af-af8d-d170d76d2bdf, "LOW_Amelyssan", (TRIGGER)S_LOW_SerialKiller_Amelyssan_FakeAmelyssan_Area_23075432-cd1a-4049-b727-819dc42bf18b);

//END_REGION

//REGION Victim Tracking: items only on CTY_Main_A

DB_LOW_MurderTribunal_PossibleMurderVictims((CHARACTER)S_WYR_OpenHand_Lorgan_75fd6462-4d79-4d36-8fdc-fbdd124f5722,S_LOW_SerialKiller_Hand_FatherLorghan_07407a2b-3b33-4f7c-aab1-452eaf012dff,(FLAG)LOW_SerialKiller_State_HandHasItem_FatherLorghan_376d6cac-71ee-48f1-9ea2-2ddd1b2b8234, NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_MurderTribunal_PossibleMurderVictims((CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09,S_LOW_SerialKiller_Hand_Figaro_f494ba51-9973-4328-b3fd-04b116281448,(FLAG)LOW_SerialKiller_State_HandHasItem_Figaro_5959e085-1d83-4b43-95e5-dcde5722a298, (CHARACTERROOT)UNI_LOW_Figaro_NoHandTemplate_208a13ad-c2e4-467d-8ecb-22fd2e3b466c);
DB_LOW_MurderTribunal_PossibleMurderVictims((CHARACTER)S_LOW_SerialKiller_AlexanderRainforest_18fe60a8-7235-4450-ac5b-fcbf15bdae88,S_LOW_SerialKiller_Hand_Alexander_ed1a4ea7-f783-4313-bfc5-cde084392ada,(FLAG)LOW_SerialKiller_State_HandHasItem_Alexander_5f1a269a-28e0-43ab-a0e0-d99927ed0c7d, NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_MurderTribunal_PossibleMurderVictims((CHARACTER)S_LOW_SerialKiller_Franc_Peartree_1556e29c-a876-4853-9ea7-283a48703a56,S_LOW_SerialKiller_Hand_Franc_b24e36b9-a47b-4c85-9176-75d3e9f7962c,(FLAG)LOW_SerialKiller_State_HandHasItem_Franc_62c46efe-2c56-4c00-b1d2-9ce62947a2ac, NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_MurderTribunal_PossibleMurderVictims((CHARACTER)S_LOW_BlushingMermaid_Patron_08_40dcda0b-7891-414f-8aeb-f742d842207d,S_LOW_SerialKiller_Hand_BlushingMermaidPatron08_d83087b0-1a0f-4b57-a277-c083aa9f6560,(FLAG)LOW_SerialKiller_State_HandHasItem_Patron08_edf70175-ae20-4319-aedc-1d7887e6874c, (CHARACTERROOT)UNI_LOW_BlushingMermaid_Patron_08_NoHandTemplate_b1ddd3fe-c55d-454f-ba70-c625344e1f80);
DB_LOW_MurderTribunal_PossibleMurderVictims((CHARACTER)S_LOW_Elfsong_Reevor_3e5b30c3-ae3a-48b6-9394-11adde54ad57,S_LOW_SerialKiller_Hand_Reevor_505e07c2-4cdc-4071-9b93-58cd2b68dc48,(FLAG)LOW_SerialKiller_State_HandHasItem_Reevor_040910d8-b5fb-496d-8d58-f4f3747c8562, (CHARACTERROOT)UNI_LOW_Elfsong_Reevor_NoHandTemplate_411c9b77-375a-4483-a670-24a4ffc7b348);
DB_LOW_MurderTribunal_PossibleMurderVictims((CHARACTER)S_LOW_MurderTribunal_DukeStelmane_f4856724-d8a9-4fa4-88c4-d8bd0dfc2d91,(ITEM)S_LOW_SerialKiller_Hand_Stelmane_1fea7849-9915-49e0-a0a3-54628cb1cffd,(FLAG)LOW_SerialKiller_State_HandHasItem_Stelmane_4e1f1e27-c740-4f38-a59c-9b6336e7f204, NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_MurderTribunal_PossibleMurderVictims((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679,S_LOW_SerialKiller_Hand_Cora_e8b086d8-1b22-47ac-adf8-7e165fdf99ab,(FLAG)LOW_SerialKiller_State_HandHasItem_Cora_14b2403a-7a5b-44ab-ab99-903686f357cc, (CHARACTERROOT)UNI_LOW_CoraHighberry_NoHandTemplate_2b9ac81b-7f12-4684-a509-f45f6dd85b9a);

//END_REGION Victim Tracking: items only on CTY_Main_A

DB_LOW_SerialKiller_DolorKnockOutImmuneStates("WineFestival");
DB_LOW_SerialKiller_DolorKnockOutImmuneStates("Figaro");

SetOnStage(S_Door_HeapsideBottomA_299081b0-8dbf-4aac-8a80-6bbb17c64375, 0);
KBSECTION
//REGION Devella and Valeria Events

//If players start a combat with Dolor, Valeria should move to Murder Tribunal
IF
EnteredCombat(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _ID)
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608)
AND
DB_Players(_Player)
AND
IsInCombat(_Player, 1)
AND
CombatGetGuidFor(_Player, _ID)
THEN
PROC_GlobalSetFlagAndCache(LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608);


//END_REGION

//REGION Combat and after-combat With Dolor
QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
THEN
PROC_ClearCorpseOwner((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

//Put Dolor's Inventory on the ground
PROC
PROC_LongRest()
AND
DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
QRY_OnlyOnce("LOW_SerialKiller_HandleDolorBelongings")
THEN
DB_LOW_SerialKiller_HandleDolorBelongings(1);

IF
DB_LOW_SerialKiller_HandleDolorBelongings(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_DolorAndDoppelgangers(_Character, _, _)
AND
DB_Defeated(_Character)
THEN
SetOnStage(_Character, 0);

IF
DB_LOW_SerialKiller_HandleDolorBelongings(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
TeleportTo((ITEM)S_LOW_SerialKiller_DolorBelongings_bca6bbd2-94b0-4f27-92ae-6d1ee0c0b8ae, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
MoveAllItemsTo(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,S_LOW_SerialKiller_DolorBelongings_bca6bbd2-94b0-4f27-92ae-6d1ee0c0b8ae,0,0,1,0);
NOT DB_LOW_SerialKiller_HandleDolorBelongings(1);

//Advance Dolor to the Murder Tribunal if he's only knocked out
PROC
PROC_State_Changed(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor",_OldState,_NewState)
AND
DB_LOW_SerialKiller_DolorKnockOutImmuneStates(_NewState)
AND
NOT DB_LOW_SerialKiller_DolorKnockOutImmuneStates(_OldState)
THEN
DB_PreventKnockedOutPermaDefeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

PROC
PROC_State_Changed(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor",_OldState,_NewState)
AND
DB_LOW_SerialKiller_DolorKnockOutImmuneStates(_OldState)
AND
NOT DB_LOW_SerialKiller_DolorKnockOutImmuneStates(_NewState)
THEN
NOT DB_PreventKnockedOutPermaDefeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

PROC
PROC_LongRest()
AND
DB_KnockedOut(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor",_State)
AND
DB_LOW_SerialKiller_DolorKnockOutImmuneStates(_State)
THEN
DB_LOW_SerialKiller_DoDolorKnockOutToTribunal(1);

IF
DB_LOW_SerialKiller_DoDolorKnockOutToTribunal(1)
AND
DB_ActiveLevel("CTY_Main_A")
THEN
NOT DB_LOW_SerialKiller_DoDolorKnockOutToTribunal(1);
SetOnStage(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,0);
TeleportTo((ITEM)S_LOW_SerialKiller_DolorBelongings_bca6bbd2-94b0-4f27-92ae-6d1ee0c0b8ae, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
MoveAllItemsTo(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,S_LOW_SerialKiller_DolorBelongings_bca6bbd2-94b0-4f27-92ae-6d1ee0c0b8ae,0,0,1,0);
DB_LOW_Dolor_KnockedOutToTribunal(1);

PROC
PROC_KnockedOut_Ended((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_LOW_Dolor_KnockedOutToTribunal(1)
THEN
NOT DB_LOW_Dolor_KnockedOutToTribunal(1);
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal");

//END_REGION

//REGION CrimeArea regions

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_GlobalFlag(LOW_SerialKiller_Knows_TargetList_262314d1-43bf-4ea5-ae23-4a77bfab2671)
AND
DB_LOW_SerialKiller_VictimsAndCrimeTriggers(_, _Trigger)
THEN
CrimeAreaSetTensionModifier((TRIGGER)_Trigger, 3);

IF
DB_Dead(_Victim)
AND
DB_LOW_SerialKiller_VictimsAndCrimeTriggers(_Victim, _Trigger)
THEN
NOT DB_LOW_SerialKiller_VictimsAndCrimeTriggers(_Victim, _Trigger);
CrimeAreaResetTensionModifier((TRIGGER)_Trigger);

//END_REGION CrimeArea regions

//REGION Journal Alexaner Rainforest

IF
EnteredTrigger(_Player, S_LOW_SerialKiller_AlexanderHouse_SawBody_89c03b92-8b39-42c4-ba1b-0ff8583fbfe2)
AND
DB_GlobalFlag(LOW_SerialKiller_Knows_TargetList_262314d1-43bf-4ea5-ae23-4a77bfab2671)
THEN
QuestUpdate(_Player, "LOW_FindBhaalTemple", "Stopmurders_FailAlexander");
PROC_TriggerUnregisterForPlayers(S_LOW_SerialKiller_AlexanderHouse_SawBody_89c03b92-8b39-42c4-ba1b-0ff8583fbfe2);
SetFlag(LOW_SerialKiller_State_SawDolorVictim_8ae5dc4c-4728-4f42-884a-791095955c92);

IF
EnteredTrigger(_Player, S_LOW_SerialKiller_AlexanderHouse_SawBody_89c03b92-8b39-42c4-ba1b-0ff8583fbfe2)
AND
NOT DB_GlobalFlag(LOW_SerialKiller_Knows_TargetList_262314d1-43bf-4ea5-ae23-4a77bfab2671)
THEN
DB_LOW_SerialKiller_SawAlexanderDead(_Player);

IF
DB_GlobalFlag(LOW_SerialKiller_Knows_TargetList_262314d1-43bf-4ea5-ae23-4a77bfab2671)
AND
DB_LOW_SerialKiller_SawAlexanderDead(_Player)
THEN
NOT DB_LOW_SerialKiller_SawAlexanderDead(_Player);
QuestUpdate(_Player, "LOW_FindBhaalTemple", "Stopmurders_FailAlexander");
PROC_TriggerUnregisterForPlayers(S_LOW_SerialKiller_AlexanderHouse_SawBody_89c03b92-8b39-42c4-ba1b-0ff8583fbfe2);

//END_REGION Journal Alexaner Rainforest

//REGION Debug

IF
DB_GlobalFlag(Debug_LOW_SerialKiller_NextStageQuest_06aad8a3-cdeb-4fd1-b029-6cfe8c096397)
THEN
ClearFlag(Debug_LOW_SerialKiller_NextStageQuest_06aad8a3-cdeb-4fd1-b029-6cfe8c096397);
PROC_LongRest();


// Perform the ritual (make a long rest)
IF
TextEvent("LOW_RitualHighberrys")
THEN
SetFlag((FLAG)LOW_SerialKiller_Event_KillHighberrysAfterLongRest_c79f8fc7-272d-4398-8861-848d469b885b, NULL_00000000-0000-0000-0000-000000000000);
PROC_LongRest();

IF
TextEvent("LOW_GetInfoHighberrys")
THEN
SetFlag((FLAG)LOW_SerialKiller_Knows_DolorAtHighberrys_0179c3aa-ba2d-0987-e5cb-0cae6fed90ed, NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("LOW_PlayerKnowsPoison")
THEN
SetFlag((FLAG)LOW_SerialKiller_Know_PlayersKnowAboutPoison_6f7fc46a-2ffa-407e-ad2e-c6f8e13d9567);

IF
TextEvent("LOW_TargetList")
THEN
SetFlag((FLAG)LOW_SerialKiller_Knows_TargetList_262314d1-43bf-4ea5-ae23-4a77bfab2671);

IF
TextEvent("LOW_ResurrectDolor")
THEN
PROC_ResurrectDolor();

IF
TextEvent("LOW_KillDevella")
THEN
Die(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);

PROC
PROC_ResurrectDolor()
AND
DB_LOW_DolorAndDoppelgangers(_Character, _, _)
THEN
Resurrect(_Character);

IF
TextEvent("LOW_CheckVictims")
THEN
SetFlag((FLAG)LOW_SerialKiller_State_CheckedMeadhoney_1ac8a71f-17fe-43f8-a350-4bdf3db6a50e);
SetFlag((FLAG)LOW_BaldursMouth_State_ToldEttvardAboutSerialKiller_7b11a267-678c-4638-969c-c7cc6c683b38);


//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
