Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_ItemOwnershipTriggers("CTY_Main_A",(TRIGGER)S_LOW_OwnershipTolnaTrigger_65e883e0-57c8-4121-9735-bb17beedb48a,(CHARACTER)S_LOW_Tolna_46aa02d8-28e9-4ebb-876c-82fe29262d35);
DB_ItemShopTrigger((TRIGGER)S_LOW_OwnershipTolnaTrigger_65e883e0-57c8-4121-9735-bb17beedb48a, (CHARACTER)S_LOW_Tolna_46aa02d8-28e9-4ebb-876c-82fe29262d35);

DB_HasItemEvent((ITEM)S_UNI_TharchiateCypher_0addb171-6e14-4b4c-8d97-c9af9ba1dcb8, (FLAG)LOW_SorcerousSundries_State_HasTharchiate_79067d89-0cb1-47cf-a746-cc265948b527);

DB_LOW_SorcerousSundries_Barriers((ITEM)S_LOW_MagicItemRamazith_Barrier_000_62b8513b-2e9f-405e-8f7e-7ea590a1e93c, (ITEM)S_LOW_MagicItemRamazith_000_7a15ab31-e722-4ce0-8f1c-907025e3bef0);
DB_LOW_SorcerousSundries_Barriers((ITEM)S_LOW_MagicItemRamazith_Barrier_001_1c250ae9-3ea6-43f8-b0a9-33da13d8c2f0, (ITEM)S_LOW_MagicItemRamazith_001_8ed5daac-b55f-40df-938c-34dc189101ad);

DB_DialogBlockTradeButton((DIALOGRESOURCE)CAMP_SCO_AradinAttack_cdc441b1-9530-da70-d479-6c572b0fc5ee);
DB_GLO_DefeatCounter(S_LOW_CurriculumStrategy_Fake_4644d414-71bc-4929-9072-dcf641b68694,"LOW_SorcerousSundries_ReplacedTolnaBooks");
DB_GLO_DefeatCounter(S_LOW_SightOfTheSeelie_Fake_302c13d4-f07f-45a3-a20a-fcfcb7d0aa8b,"LOW_SorcerousSundries_ReplacedTolnaBooks");
DB_GLO_DefeatCounter(S_UNI_TharchiateCypher_Fake_fc410088-46a8-4c47-93d8-4aa28736a063,"LOW_SorcerousSundries_ReplacedTolnaBooks");
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_SorcerousSundries_ReplacedTolnaBooks",(FLAG)LOW_Tolna_State_AllCursedBooksRemoved_8cdfb6db-47f4-409d-b4bb-36974f861ddd);

DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c);

PROC_LOW_SorcerousSundries_AradinSetup((CHARACTER)S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
PROC_LOW_SorcerousSundries_NightsongSetup((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_LOW_SorcerousSundries_RolanSetup((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

DB_DangerZone((TRIGGER)S_FOR_DangerousBook_SorcSundriesBasementTrigger_a4fc3ecc-3e6e-4a02-b0e8-2b629911122e, "LOW_SorcerousSundries_Basement");
DB_DoNotRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9);

DB_LOW_SorcerousSundries_ClerkCheckpointWarningDialogues((DIALOGRESOURCE)LOW_SorcerousSundries_RolanWarning_d8fcff57-2afa-06c0-5e21-36c77107c6be, (CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
DB_LOW_SorcerousSundries_ClerkCheckpointWarningDialogues((DIALOGRESOURCE)LOW_SorcerousSundries_RolanProjectionWarning_859aa6d4-4fc1-398d-0131-91a63940345d, (CHARACTER)S_LOW_RolanProjection_c6a47d05-5051-42de-86b0-776fe0285cd1);
DB_LOW_SorcerousSundries_ClerkCheckpointWarningDialogues((DIALOGRESOURCE)LOW_SorcerousSundries_LorroakanProjectionWarning_91430540-4848-ce3d-61a7-a0c8c3dbaa6c, (CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);

DB_LOW_SorcerousSundries_TolnaExplosionLocations((TRIGGER)S_LOW_SorcerousSundries_BookExplosionTrigger_001_d88bf575-db3c-4fae-bc77-76b60595a500);
DB_LOW_SorcerousSundries_TolnaExplosionLocations((TRIGGER)S_LOW_SorcerousSundries_BookExplosionTrigger_000_bc275e0f-447a-4bc9-b46e-92870d4bee97);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Nightsong_Event_GoToRamazithTower_59fab159-060f-424c-9fd9-43cc00a88db9,(DIALOGRESOURCE)CAMP_Nightsong_60070e0f-0ab6-f653-7962-c2fff93b5a2d);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Nightsong_Event_GoToRamazithTower_59fab159-060f-424c-9fd9-43cc00a88db9,(DIALOGRESOURCE)LOW_SorcerousSundries_NightsongPostAttack_42a7f9de-9883-9a29-20c0-721271188f18);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Nightsong_Event_GoToRamazithTower_59fab159-060f-424c-9fd9-43cc00a88db9,(DIALOGRESOURCE)LOW_SorcerousSundries_NightsongCamp_8a4dce9f-f256-fdfc-7ce4-28ece903328d);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Aradin_Event_LeaveSorcerousSundries_9b859898-5d65-4cfb-8b0b-fa3c93f9c752,(DIALOGRESOURCE)LOW_SorcerousSundries_Aradin_f25cbd18-f09a-4dc2-414c-6762d60a3a86);

DB_LOW_SorcerousSundries_ShopArmors((CHARACTER)S_LOW_ShopAnimatedArmor_005_d42295ab-7169-4bba-9a7c-8124196caea7);
DB_LOW_SorcerousSundries_ShopArmors((CHARACTER)S_LOW_ShopAnimatedArmor_002_4b741aa9-c2af-4196-a8fd-7bc9a8f5cd5d);
DB_LOW_SorcerousSundries_ShopArmors((CHARACTER)S_LOW_ShopAnimatedArmor_004_9752ca37-cc97-42fc-b7d0-a0f0a8b1dfd3);
DB_LOW_SorcerousSundries_ShopArmors((CHARACTER)S_LOW_ShopAnimatedArmor_003_e57cc258-8f98-45d0-b6dc-063e945ce086);
DB_LOW_SorcerousSundries_ShopArmors((CHARACTER)S_LOW_ShopAnimatedArmor_001_50e39747-fa44-4d2a-8427-186d2f9a5d1c);

DB_PreventPermaDefeated(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7);
PROC_CharacterDisableAllCrimes((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c,(TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3,1,1,1,1);

DB_Dialogs(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,S_LOW_LorroakanButler_637bb24f-66b7-4447-807b-556bd1c00ed6,S_LOW_Krank_47a3de7a-049b-462d-b526-60a178a649db,(DIALOGRESOURCE)LOW_SorcerousSundries_Lorroakan_b206fd7c-7992-6d5f-51f4-0943a92f3d48);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, (DIALOGRESOURCE)LOW_SorcerousSundries_Lorroakan_Dead_7b5595c0-aa22-93a1-6ff9-e386dbaadacc);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_SorcerousSundries_Lorroakan_b206fd7c-7992-6d5f-51f4-0943a92f3d48);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_SorcerousSundries_NightsongSmash_ca824374-abdf-7094-9b35-2578466eb7b8);

Open((ITEM)S_LOW_SorcerousSundries_Door_599e0543-c81b-461b-8807-8213b88c6c1c);
PROC_SetOnStage(LOW_SorcerousSundries_LorroakanSoulCage_33fab5d8-f1e3-45ad-8f62-1247f7eadd37,0);
PROC_SetOnStage(S_LOW_SorcerousSundries_IsobelThreat_807ee341-d395-43a8-9cbd-8d2eef9026da,0);

ApplyStatus(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, "LOW_SORCEROUSSUNDRIES_ANIMATEDARMOR_KLANK",-1.0);
ApplyStatus(S_LOW_Krank_47a3de7a-049b-462d-b526-60a178a649db, "LOW_SORCEROUSSUNDRIES_ANIMATEDARMOR_KLANK",-1.0);

//Triggers only affecting Lorroakan and Nightsong for the smashing movement after confrontation
TriggerRegisterForCharacter((TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TriggerRegisterForCharacter((TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3, S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9);
TriggerRegisterForCharacter((TRIGGER)S_LOW_AradinStayAreaTrigger_ddc16aed-a2d2-473b-aa9f-fafb647bf4a4, S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
DB_NoLowAttitudeDialog(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_EnterSorcerousTrigger_7c408b4f-8d02-43d5-9f7b-a3898afe2bf0);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_IllusionTrigger_27b7a6e4-9869-4aab-b28a-0d007d987a66);
DB_LOW_KarsusTomeADGaleTriggerSetup(1);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_SorcerousCheckpoint_ClerkSpotTrigger_21b5350e-7827-4894-a2d2-0d71849d2a4e);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_SorcerousCheckpoint_PrimaryTrigger_1181722d-3b04-4ebc-be3c-9e9059ba451c);

DB_DeadOnceFlag((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(FLAG)LOW_Rolan_State_IsDead_47b8a371-e4a9-40e6-bc0f-18ac582142b9);

//Lorroakan death
DB_DeadOnceFlag((CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,(FLAG)LOW_Lorroakan_State_IsDead_7bc03119-8aaa-458d-b795-fd2e2523d3b8);

DB_PermaDefeatedFlag(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,(FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098);
DB_GLO_CharacterCorpseDialog(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, LOW_SorcerousSundries_Lorroakan_Dead_7b5595c0-aa22-93a1-6ff9-e386dbaadacc);

DB_CrimeAttitudeChange("LOW_SorcerousSundries_DispelArmor",-15);

DB_Dialogs(S_LOW_LavaElemental_1dea794e-2657-4c54-916b-edc639c4ff8c,(DIALOGRESOURCE)LOW_SorcerousSundries_Elemental_df026427-841d-a340-8082-05df7840bb9c);
DB_Dialogs(S_LOW_WaterElemental_4cb61416-f095-4fbb-aece-51f37b6bb4d6,(DIALOGRESOURCE)LOW_SorcerousSundries_WaterElemental_1ba0373b-da31-afff-f6f6-f99791bffc0a);

DB_LOW_SorcerousSundries_NSAndIsobelLeaveCampPos("SLUMS",S_LOW_SlumsPosition_NightsongLeave_0d373811-b182-40da-9763-defdf9a1997c);
DB_LOW_SorcerousSundries_NSAndIsobelLeaveCampPos("ELFSONG",S_LOW_NightsongLeaveCampPos_385051cc-92b6-4dcf-af63-3f0d84906849);
DB_LOW_SorcerousSundries_NSAndIsobelLeaveCampPos("FARM",S_LOW_SorcerousSundries_Farm_NightsongLeaveCampPos_7099c20c-2710-4575-9f32-d4780dfe5965);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_SorcerousSundries_Event_NSAndIsobelLeaveCamp_64a6e5df-b6a0-42ab-93b6-818bc4e2859a,(DIALOGRESOURCE)LOW_SorcerousSundries_NightsongAndIsobelCampAfterFight_5c788540-1b65-2b31-8814-450e72458314);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_SorcerousSundries_Event_NSAndIsobelLeaveCamp_64a6e5df-b6a0-42ab-93b6-818bc4e2859a,(DIALOGRESOURCE)CAMP_Nightsong_60070e0f-0ab6-f653-7962-c2fff93b5a2d);

DB_LOW_SorcerousSundris_NSAndIsobel((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_LOW_SorcerousSundris_NSAndIsobel((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);

//REGION Client dialogues

DB_Dialogs(S_LOW_Client_000_7d85aa52-0d27-4389-a5c9-9bc329fd7376,(DIALOGRESOURCE)LOW_SorcerousSundries_Client000_b9f1a9fa-debf-ae31-e8cd-1eec5ee3f12b);
DB_Dialogs(S_LOW_Client_001_9504e91f-b535-411b-ac3b-b4047150f93f,(DIALOGRESOURCE)LOW_SorcerousSundries_Client001_ae46d6fb-6fd3-8844-1fa3-74ba9eccff28);
DB_Dialogs(S_LOW_Client_002_91a348f4-a6a4-423d-8f3c-c48ceeb7383d,(DIALOGRESOURCE)LOW_SorcerousSundries_Client002_093122d8-1465-1faa-37fc-00cb34a13eb1);
DB_Dialogs(S_LOW_Client_003_8d2f44b7-7fa1-4586-a2c8-c49f730a3f2b,(DIALOGRESOURCE)LOW_SorcerousSundries_Client003_04f5fcd5-1f40-5cd3-691b-525a7817f789);
DB_Dialogs(S_LOW_Client_007_9e4e8404-4f2e-43ed-8bc5-f83c40127900,(DIALOGRESOURCE)LOW_SorcerousSundries_Client007_18590482-3a04-dd8d-2341-13ca54939c0a);
DB_Dialogs(S_LOW_Client_004_e3fa81d4-53f3-49ad-8497-18673d399a37,(DIALOGRESOURCE)LOW_SorcerousSundries_Client004_e98d8904-03d9-8acb-9729-98b0ea5a983c);
DB_Dialogs(S_LOW_Client_005_bf5f19cd-638f-4011-ae3d-45007163c637,(DIALOGRESOURCE)LOW_SorcerousSundries_Client005_d2bdcee8-b9d5-ca2a-d8bf-700d37381bdb);
DB_Dialogs(S_LOW_Client_006_d3239308-d0d6-49dd-a3b9-39605f5b57e9,(DIALOGRESOURCE)LOW_SorcerousSundries_Client006_798f365d-a7dc-3765-b4ab-21ce1702a55f);
DB_Dialogs(S_LOW_SorcerousSundries_Necromancer_ba40224c-9113-4a18-b30b-a1a77e88f9d2, (DIALOGRESOURCE)LOW_SorcerousSundries_NecromancerVendor_e1d83981-a4d1-53c8-98cb-0db6a8154328);
DB_Dialogs(S_LOW_NecromancyBuyer_d33d47b9-299e-4be3-8867-eaf53b200b46,(DIALOGRESOURCE)LOW_SorcerousSundries_NecromancyBuyer_d05f0780-38a6-642e-5743-15289461b407);

DB_OneShotPlayerTrigger((TRIGGER)S_LOW_GaleCheckTrigger_41cf8357-fd36-4cd6-b28f-0bd321d27c3f);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_EntryRamazithTrigger_b3f97f64-d3d7-4f2b-9df8-87fd3767e532);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_NecromanticVendorTrigger_9ea2b581-5104-4848-933d-7bff203e81a2);

//END_REGION

//REGION CampAttack


DB_CampNight((FLAG)NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113,1050);
DB_CampNight_Requirement((FLAG)NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113, (FLAG)LOW_Aradin_State_AttackingCamp_81f0d1a8-6f8e-4872-ad70-b657ff2c60fd);
DB_CampNight_SCO((FLAG)NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113, (DIALOGRESOURCE)CAMP_SCO_AradinAttack_cdc441b1-9530-da70-d479-6c572b0fc5ee);
DB_CampNight_Camp((FLAG)NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113, "ELFSONG");
DB_CampNight_CancelledBy((FLAG)NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113,(FLAG)LOW_SorcerousSundries_Event_CampAttackAverted_f3441499-0574-48b0-bf5c-56615ee2d07e);


//Thug, trigger in elfsong, trigger in bridge
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, S_LOW_ElfsongPosition_AradinTeleportTo_eb99615a-7a9f-4a43-bdb1-7c36d057d989, "ELFSONG");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, S_LOW_SlumsPosition_AradinTeleportTo_74070c7e-a6ce-480e-b613-e92ad4798586, "SLUMS");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug1_19a10473-cacd-47fe-a21d-0d9b1664b66a, S_LOW_ElfsongPosition_AradinThug1_e3620554-8907-4357-a890-e6ef23b0ae11, "ELFSONG");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug2_19a10473-cacd-47fe-a21d-0d9b1664b66a, S_LOW_ElfsongPosition_AradinThug2_e3620554-8907-4357-a890-e6ef23b0ae11, "ELFSONG");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug3_e16eb8e3-04e8-49ec-9400-b4868c587890, S_LOW_ElfsongPosition_AradinThug3_f568e8b9-94cc-4266-98d3-e47f36dd3092, "ELFSONG");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug4_d69d546c-a737-4f43-a940-d176e213b343, S_LOW_ElfsongPosition_AradinThug4_233a57c9-7d53-488e-804f-8c52b3385729, "ELFSONG");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug5_acb140f5-54bc-4e0a-b902-eaf4de39ec94, S_LOW_ElfsongPosition_AradinThug5_e8939e15-95a5-4a3d-bf33-265acd8bb812, "ELFSONG");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug6_9909dc5b-bf27-441d-a75d-b7099e1edf30, S_LOW_ElfsongPosition_AradinThug6_7c0cb8aa-6246-442a-92cb-42ca778efe10, "ELFSONG");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug7_5c9d1b7f-7c8a-4917-b5bc-26b3b07f5f0c, S_LOW_ElfsongPosition_AradinThug7_0e80561f-75c1-4955-923d-ad0d7acb3917, "ELFSONG");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug8_a91d7090-4d49-44c7-89da-f72ec29c8bf2, S_LOW_ElfsongPosition_AradinThug8_1675b8fa-3e86-4523-89ad-e4ef272a47b5, "ELFSONG");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug1_19a10473-cacd-47fe-a21d-0d9b1664b66a, S_LOW_SlumsPosition_AradinThug1_64e8bf81-1cb5-4c78-9465-8457d10a19e6, "SLUMS");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug2_19a10473-cacd-47fe-a21d-0d9b1664b66a, S_LOW_SlumsPosition_AradinThug2_64e8bf81-1cb5-4c78-9465-8457d10a19e6, "SLUMS");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug3_e16eb8e3-04e8-49ec-9400-b4868c587890, S_LOW_SlumsPosition_AradinThug3_eef8315f-9790-445a-b6a8-4ec114f326f4, "SLUMS");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug4_d69d546c-a737-4f43-a940-d176e213b343, S_LOW_SlumsPosition_AradinThug4_db9bdac0-21e9-48f5-81e3-59037cce89e9, "SLUMS");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug5_acb140f5-54bc-4e0a-b902-eaf4de39ec94, S_LOW_SlumsPosition_AradinThug5_5bc36b69-6c45-4e8a-a311-90ec043a1173, "SLUMS");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug6_9909dc5b-bf27-441d-a75d-b7099e1edf30, S_LOW_SlumsPosition_AradinThug6_a9a4001f-4ff4-47dd-9569-fb51a95723b8, "SLUMS");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug7_5c9d1b7f-7c8a-4917-b5bc-26b3b07f5f0c, S_LOW_SlumsPosition_AradinThug7_cad02f33-15c2-4b51-a001-4e6ca6fa0deb, "SLUMS");
DB_LOW_SorcerousSundries_AradinThugPositions((CHARACTER)S_LOW_AradinThug8_a91d7090-4d49-44c7-89da-f72ec29c8bf2, S_LOW_SlumsPosition_AradinThug8_3530def3-c3f2-46d8-a0d7-b144a65426d4, "SLUMS");

DB_LOW_SorcerousSundries_AradinAttackPlayerPositions((TRIGGER)S_LOW_ElfsongPosition_AradinAttackPlayerPosition_002_23ef09a4-fd1a-477a-b664-9f161a269334, 2, "ELFSONG");
DB_LOW_SorcerousSundries_AradinAttackPlayerPositions((TRIGGER)S_LOW_ElfsongPosition_AradinAttackPlayerPosition_003_b14f5f26-24ea-4ca6-9a81-b4f81e63019d, 3, "ELFSONG");
DB_LOW_SorcerousSundries_AradinAttackPlayerPositions((TRIGGER)S_LOW_ElfsongPosition_AradinAttackPlayerPosition_004_e41f2227-6b35-46dd-ab40-fc93c385af83, 4, "ELFSONG");
DB_LOW_SorcerousSundries_AradinAttackPlayerPositions((TRIGGER)S_LOW_SlumsPosition_AradinAttackPlayerPosition_002_a35b08af-fca8-4c60-b19b-cf86256af17b, 2, "SLUMS");
DB_LOW_SorcerousSundries_AradinAttackPlayerPositions((TRIGGER)S_LOW_SlumsPosition_AradinAttackPlayerPosition_003_b45d903e-0d69-492e-97b7-4fc8c42bb189, 3, "SLUMS");
DB_LOW_SorcerousSundries_AradinAttackPlayerPositions((TRIGGER)S_LOW_SlumsPosition_AradinAttackPlayerPosition_004_38c1ca0b-b56b-4497-9b62-fd4d30ca8d77, 4, "SLUMS");
DB_LOW_SorcerousSundries_AradinAttackPlayerPositions((TRIGGER)S_LOW_SlumsPosition_AradinAttackPlayerPosition_001_e0aa298e-eb8c-4fac-aa64-735551fb3003, 1, "SLUMS");
DB_LOW_SorcerousSundries_AradinAttackPlayerPositions((TRIGGER)S_LOW_ElfsongPosition_AradinAttackPlayerPosition_001_72fa3857-d560-4b40-82f3-e2afaa75ca81, 1, "ELFSONG");

DB_LOW_SorcerousSundries_AradinAttackNSPositions(S_LOW_ElfsongPosition_NightsongAttackPosition_f6f04024-371c-4cd2-8f1b-d0fd4c9cb0a3, "ELFSONG");
DB_LOW_SorcerousSundries_AradinAttackNSPositions(S_LOW_SlumsPosition_NightsongAttackPosition_e92e2591-a5c2-4871-879a-2e56357bb96e, "SLUMS");

DB_GLO_DefeatCounter(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, "LOW_SorcerousSundries_AradinAttackers");
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_SorcerousSundries_AradinAttackers",(FLAG)LOW_SorcerousSundries_CampAttackEnded_d7c61ab3-c0c3-4b78-95c6-0144209f40a4);
PROC_LOW_SorcerousSundries_InitThugs();

DB_LOW_SorcerousSundries_PuzzlePlaques((ITEM)S_LOW_PlaqueArmy_32f301b2-9ed6-4ce2-9a66-7fb2b9bf146a);
DB_LOW_SorcerousSundries_PuzzlePlaques(S_LOW_PlaqueLove_4a1e7dfa-c915-4992-a70d-19faa93ac82d);
DB_LOW_SorcerousSundries_PuzzlePlaques(S_LOW_PlaqueWealth_5d9cfef0-6502-4653-8d77-94db60893ea9);
DB_LOW_SorcerousSundries_PuzzlePlaques(S_LOW_PlaqueImmortality_c606ff71-77c3-4131-8333-e16505f2e58d);

//END_REGION

//REGION Puzzle

PROC_SetOnStage(S_LOW_LorroakanProjection_PuzzleGuardian_c65a2e91-34f1-4dd9-a784-2aca5a4d9cd2,0);
PROC_SetOnStage(S_LOW_LorroakanProjection_PuzzleGuardian_Punisher_ae4c07db-c5c3-4b83-9fb4-23854dda14c5,0);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_PuzzleEntranceTrigger_63ded352-7943-43c9-844e-aa1673eb1388);

DB_Dialogs((CHARACTER)S_LOW_LorroakanProjection_PuzzleGuardian_c65a2e91-34f1-4dd9-a784-2aca5a4d9cd2,(DIALOGRESOURCE)LOW_SorcerousSundries_PuzzleGuardian_5423a690-96fd-9057-4068-0b51ba9c14c0);
DB_Dialogs((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,(DIALOGRESOURCE)LOW_SorcerousSundries_Klank_04e461be-8cd3-f261-3f12-3c70eb4cd0f6);

DB_LOW_SorcerousSundriesPuzzlePortals((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,"PUZ_CASTEDPORTAL_BLUE");
DB_LOW_SorcerousSundriesPuzzlePortals((ITEM)LOW_PuzzlePortal_002_6fa1aa19-67e3-45c7-b633-8c873637bcca, "PUZ_CASTEDPORTAL_RED");
DB_LOW_SorcerousSundriesPuzzlePortals((ITEM)LOW_PuzzlePortal_003_f6806383-5661-4b49-8280-86e432188240,"PUZ_CASTEDPORTAL_GREEN");
DB_LOW_SorcerousSundriesPuzzlePortals((ITEM)LOW_PuzzlePortal_004_a5bc28c0-6a80-42ed-a63a-633abf3f256d,"PUZ_CASTEDPORTAL_PURPLE");

ApplyStatus((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec, "PUZ_CASTEDPORTAL_BLUE",-1.0);

DB_LOW_SorcerousSundriesPuzzlePlaques(S_LOW_PlaqueImmortality_c606ff71-77c3-4131-8333-e16505f2e58d,(DIALOGRESOURCE)LOW_SorcerousSundries_AD_PuzzlePortalImmortality_5b02e5a5-39cf-386f-0564-d02882a23080);
DB_LOW_SorcerousSundriesPuzzlePlaques(S_LOW_PlaqueWealth_5d9cfef0-6502-4653-8d77-94db60893ea9,(DIALOGRESOURCE) LOW_SorcerousSundries_AD_PuzzlePortalWealth_4797dba7-cb01-6283-b8ca-41f8426acb3b);
DB_LOW_SorcerousSundriesPuzzlePlaques(S_LOW_PlaqueArmy_32f301b2-9ed6-4ce2-9a66-7fb2b9bf146a,(DIALOGRESOURCE)LOW_SorcerousSundries_AD_PuzzlePortalArmy_d1f240ed-43de-a8b6-e5c3-3ded2be93193);
DB_LOW_SorcerousSundriesPuzzlePlaques(S_LOW_PlaqueLove_4a1e7dfa-c915-4992-a70d-19faa93ac82d,(DIALOGRESOURCE) LOW_SorcerousSundries_AD_PuzzlePortalPotion_5833d375-70d2-811f-bf36-ac7d12791138);

DB_OneShotPlayerTrigger((TRIGGER)S_LOW_PuzzleEntranceTrigger_63ded352-7943-43c9-844e-aa1673eb1388);

//END_REGION

//REGION Tomes

DB_LOW_SorcerousSundries_TomesWithScroll(S_LOW_KarsusNotes_0bf067e2-6b9e-4a5e-9c04-e732db3fcc02, "LOW_SorcerousSundries_KarsusBook");
DB_LOW_SorcerousSundries_TomesWithScroll(S_LOW_SightOfTheSeelie_5dc89036-5313-45ef-816c-38bbd0a46ce9, "LOW_SorcerousSundries_SeelieBook");
DB_LOW_SorcerousSundries_TomesWithScroll(S_LOW_CurriculumStrategy_6a87c342-a1e1-4854-8f44-96eab8813fe7, "LOW_SorcerousSundries_StrategyBook");

DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_SorcerousSundries_Tolna_6a5d58cc-6d82-4a9e-e8b2-5c4c09c67e14, 2000, 2, 1);
DB_DialogMoneyTransfer(2, (DIALOGRESOURCE)LOW_SorcerousSundries_Tolna_6a5d58cc-6d82-4a9e-e8b2-5c4c09c67e14, 400, 2, 1);

DB_GiveItemToEvent((ITEM)S_LOW_KarsusNotes_0bf067e2-6b9e-4a5e-9c04-e732db3fcc02,(FLAG)LOW_SorcerousSundries_Event_GiveKarsus_1621c341-419a-4540-b5dc-476500af3053);

DB_HasItemEvent((ITEM)S_LOW_KarsusNotes_0bf067e2-6b9e-4a5e-9c04-e732db3fcc02, (FLAG)LOW_SorcerousSundries_Event_HasKarsusBook_c7019855-fcac-4bc5-bacf-9fad0213ab28);
DB_HasItemEvent((ITEM)S_LOW_CurriculumStrategy_6a87c342-a1e1-4854-8f44-96eab8813fe7, (FLAG)LOW_SorcerousSundries_State_HasStrategyBook_d5bcfafa-39e4-4fa7-845d-b85bb0a2652d);

DB_LOW_SorcerousSundries_SensitiveBooks(S_LOW_SensitiveBooks_002_93cbbe6b-51ba-421c-ae49-85a1dacb1b9c);
DB_LOW_SorcerousSundries_SensitiveBooks(S_LOW_SensitiveBooks_003_8a523a6a-a09b-4d80-a26e-5f1510be87dd);
DB_LOW_SorcerousSundries_SensitiveBooks(S_LOW_SensitiveBooks_001_b92167a0-40fa-4cb0-8cb0-4441f1cc0c16);
DB_LOW_SorcerousSundries_SensitiveBooks(S_LOW_SensitiveBooks_004_3ddb4d00-ad47-453d-b3ac-afe4fc44b664);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_SorcerousSundries_Event_BlowUpBooks_9b3aa100-dc49-413b-9b03-e9ff967d9220,(DIALOGRESOURCE)LOW_SorcerousSundries_Tolna_6a5d58cc-6d82-4a9e-e8b2-5c4c09c67e14);


//END_REGION

SetOnStage(S_LOW_LastPageNecromancy_45f16b38-3418-497a-ba6e-3c9ee523388f, 0);

DB_LOW_SorcerousSundries_Projections((CHARACTER)S_LOW_LorroakanProjection_PuzzleGuardian_Punisher_ae4c07db-c5c3-4b83-9fb4-23854dda14c5);
DB_LOW_SorcerousSundries_Projections((CHARACTER)S_LOW_LorroakanProjection_PuzzleGuardian_c65a2e91-34f1-4dd9-a784-2aca5a4d9cd2);
DB_LOW_SorcerousSundries_Projections((CHARACTER)S_LOW_RolanProjection_c6a47d05-5051-42de-86b0-776fe0285cd1);
DB_LOW_SorcerousSundries_Projections((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);

DB_SeenPermaDefeatedNPCGlobalFlag((CHARACTER)S_LOW_Tolna_46aa02d8-28e9-4ebb-876c-82fe29262d35, (FLAG)LOW_Tolna_Knows_PermaDefeated_629cbe29-01fb-4fb6-81c3-23748fb4c03d);

SetHasDialog(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, 1);
SetHasDialog(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, 1);

SetOnStage(S_LOW_UNI_ElfsongDoorKey_2f1b990a-2d23-49fb-b1e0-dd06a6ea8739, 0);
SetOnStage(S_LOW_RolanProjection_c6a47d05-5051-42de-86b0-776fe0285cd1, 0);
SetOnStage(S_LOW_NightsongThreat_d9df0940-238f-4451-a312-d2847ee04f9a,0);

DB_Dialogs((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2,(DIALOGRESOURCE)LOW_SorcerousSundries_LorroakanProjection_b90d7005-f9c9-350d-2dc0-d821f756455f);
DB_Dialogs((CHARACTER)S_LOW_Tolna_46aa02d8-28e9-4ebb-876c-82fe29262d35,(DIALOGRESOURCE)LOW_SorcerousSundries_Tolna_6a5d58cc-6d82-4a9e-e8b2-5c4c09c67e14);
DB_Dialogs((CHARACTER)S_LOW_RolanProjection_c6a47d05-5051-42de-86b0-776fe0285cd1,(DIALOGRESOURCE)LOW_SorcerousSundries_RolanProjection_4e70211d-ec10-a709-3781-b1cb47b5277c);
DB_Dialogs((CHARACTER)S_LOW_Miklaur_637bb24f-66b7-4447-807b-556bd1c00ed6,LOW_SorcerousSundries_Miklaur_4baaa8ff-a1b0-8d4a-a495-8792e3a9bafb);
DB_Dialogs((CHARACTER)S_LOW_Krank_47a3de7a-049b-462d-b526-60a178a649db,LOW_SorcerousSundries_Krank_cbbb03ec-145b-2583-a21c-cb235036d67e);

DB_PreventKnockedOutPermaDefeated((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7);
DB_CorpseCleanup_Ignore((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7);

AddGold(S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2, 100);

DB_DialogMoneyTransfer(1,(DIALOGRESOURCE)LOW_SorcerousSundries_LorroakanProjection_b90d7005-f9c9-350d-2dc0-d821f756455f,100,2);
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_SorcerousSundries_LorroakanConclusion_b6642d43-ba6f-b22b-9527-3a4a909e048a, 400, 2);
DB_GiveItemToEvent((ITEM)S_LOW_UNI_ElfsongDoorKey_2f1b990a-2d23-49fb-b1e0-dd06a6ea8739,(FLAG)LOW_Aradin_Event_GetElfsongKey_477feac9-1e8f-4711-8dbb-b2086e11a529);

Transform(S_LOW_RolanProjection_c6a47d05-5051-42de-86b0-776fe0285cd1, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, (SHAPESHIFTRULE)PHYSICAL_4acc6277-6dcd-4110-9450-b9379beaedac);
DB_BlockedWaypointZone((TRIGGER)S_LOW_RamaitzhsTower_RegionTrigger_8d737a4c-9b13-4935-9ce0-34520a2de266);

DB_LOW_SorcerousSundries_BannedIFFoughtFactions((FACTION)ACT3_LOW_SorcerousSundries_Buyers_b16faa54-f60e-4e43-82f7-5b57cadc4da3);
DB_LOW_SorcerousSundries_BannedIFFoughtFactions((FACTION)ACT3_LOW_SorcerousSundries_Shop_0a2e84ee-30af-49a7-9216-935318f1eae1);
DB_LOW_SorcerousSundries_BannedIFFoughtFactions((FACTION)ACT3_LOW_SorcerousSundries_AnimatedArmors_2eac0e71-1ba1-4af2-85c7-e9fdbb9ad938);

DB_LOW_SorcerousSundries_GaleQuestUpdates("FindBook2");
DB_LOW_SorcerousSundries_GaleQuestUpdates("FindBook_Book");

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_SorcerousSundries_MystraVaultTrigger_473bf62c-5f9a-40e4-bf9e-e6eb7439ad57);
DB_OneShotPartyTrigger(S_LOW_SorcerousSundries_NearSorcerousSundries_deb2beec-f1fd-4ca3-b515-9a65011938bd);

DB_KnowledgeCheckTrigger_AD("LOW_SorcerousSundries_MystraVaultCheck", (TRIGGER)S_LOW_SorcerousSundries_MystraVaultTrigger_473bf62c-5f9a-40e4-bf9e-e6eb7439ad57,"Arcana",(DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, (DIALOGRESOURCE)LOW_SorcerousSundries_PAD_MystraVaultEntered_f18ccb6a-393f-d372-075f-765960372335, (FLAG)LOW_SorcerousSundries_State_MystraVaultCheckSuccess_b7f69e3d-da44-4d4e-b565-9bf68fadad93);

//Basement
DB_TrespassTrigger((TRIGGER)S_LOW_SorcerousSundries_ClerkRoomTrespassingTrigger_458880c6-2789-450f-8506-0e1c52c1af6a, (TRIGGER)LOW_SorcerousSundries_ClerkRoomBacktrackTrigger_0b33feb0-a2b1-4149-bddf-ef0f2783d2a7);
DB_TrespassTrigger((TRIGGER)S_LOW_SorcerousSundries_BasementEntranceRestrictedArea_860973ae-bf8b-4cb3-917a-3743bfb766df, (TRIGGER)LOW_SorcerousSundries_BasementEntranceBacktrackTrigger_5f522e3e-cbfd-4bc6-9452-e745ec2f32ec);
DB_DangerZone((TRIGGER)S_LOW_SorcerousSundries_Cellar_SUB_a3ad0aa6-0b85-495d-9378-ad495d90b8e7, "LOW_SorcerousSundries_Basement");

DB_LOW_SorcerousSundries_ForbiddenDoors((ITEM)S_Door_SorcererSundriesTop_B_a4db08f9-e6cc-46e4-b89c-ddb4496283bf);
DB_LOW_SorcerousSundries_ForbiddenDoors((ITEM)S_Door_SorcererSundriesTop_A_07f823ca-2e2f-412d-91e5-7895aef2d11a);

DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_SorcerousSundries_RamazithOwnershipTrigger_af5a1002-68b2-4b3e-8399-e077af9f1dd5, (CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9);

//REGION Enemy Misty Step teleporters
//DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)_TeleportHelper, (ITEM)_TeleportHelperReturn)
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_001_a47c4303-7771-476d-8048-f970e28e9ef5, (ITEM)S_LOW_MistyStep_Helper_001_Return_050bcdb1-1ffc-46bd-b100-913f8a0517ee);
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_003_f530157f-0c10-4515-91e3-5e952948c0d1, (ITEM)S_LOW_MistyStep_Helper_003_Return_dfa817f1-fa69-4b72-89fd-c6ac01bbf04f);
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_002_06e2f47b-e627-4865-809e-d708227bdae8, (ITEM)S_LOW_MistyStep_Helper_002_Return_9af0d3cf-ce8f-44b6-a070-59efdfa972aa);
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_004_79fc3097-3dee-4542-985e-b1a4dbb76977, (ITEM)S_LOW_MistyStep_Helper_004_Return_689f7be5-93e0-4515-88a7-9a02f49cd844);
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_005_85f5339b-842b-4749-9f95-1d29beba544c, (ITEM)S_LOW_MistyStep_Helper_005_Return_f192d087-b0d9-4a53-a861-96086d1f9de2);

//END_REGION

//REGION Nightsong's Last Stand - Silver Servants
DB_LOW_SorcerousSundries_Nightsong_Deva((CHARACTER)LOW_Nightsong_Deva_001_54ab1644-1ae1-4d85-8bb7-e870dbc2ea8c);
DB_LOW_SorcerousSundries_Nightsong_Deva((CHARACTER)LOW_Nightsong_Deva_002_3d2a675a-a945-44e3-b363-6e5b9f8c52b0);
DB_LOW_SorcerousSundries_Nightsong_Deva((CHARACTER)LOW_Nightsong_Deva_003_0d53dbe4-9991-49c8-9370-1f71e70564d9);
//END_REGION

SetVisible((ITEM)S_Ramazith_Cannon_000_a6d7dd21-62d7-413a-aa1c-fdcc31fe5fec,0);
SetVisible((ITEM)S_Ramazith_Cannon_001_b9e1286d-1964-428c-8d8f-a3c0145994af,0);

SetAmbushing(LOW_SorcerousSundries_PetSummoner_9a103ea7-e269-4ae0-ad4a-70a1b76e5135, 1);
SetDetached(LOW_SorcerousSundries_PetSummoner_9a103ea7-e269-4ae0-ad4a-70a1b76e5135, 1);
SetVisible(LOW_SorcerousSundries_PetSummoner_9a103ea7-e269-4ae0-ad4a-70a1b76e5135, 0);

DB_LOW_SorcerousSundries_BlockedTomes((ITEM)S_UNI_TharchiateCypher_0addb171-6e14-4b4c-8d97-c9af9ba1dcb8, (ITEM)S_LOW_DisplayCase_Tharchiate_60b8b79c-ac17-4e7f-8616-f2a2f9c4cc81);
DB_LOW_SorcerousSundries_BlockedTomes((ITEM)S_LOW_CurriculumStrategy_6a87c342-a1e1-4854-8f44-96eab8813fe7,(ITEM)S_LOW_DisplayCase_Cypher_Strategy_a47ddb51-8b74-4bc1-8dab-6d4b43215012);

DB_LOW_SorcerousSundries_NSRunToRamazithLocation("FARM",S_LOW_SorcerousSundries_Farm_NightsongLeaveCampPos_7099c20c-2710-4575-9f32-d4780dfe5965);
DB_LOW_SorcerousSundries_NSRunToRamazithLocation("ELFSONG",S_LOW_NightsongLeaveCampPos_385051cc-92b6-4dcf-af63-3f0d84906849);
DB_LOW_SorcerousSundries_NSRunToRamazithLocation("SLUMS",S_LOW_SlumsPosition_NightsongLeave_0d373811-b182-40da-9763-defdf9a1997c);

DB_LOW_SorcerousSundries_Client(S_LOW_Client_002_91a348f4-a6a4-423d-8f3c-c48ceeb7383d);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_001_9504e91f-b535-411b-ac3b-b4047150f93f);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_007_9e4e8404-4f2e-43ed-8bc5-f83c40127900);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_000_7d85aa52-0d27-4389-a5c9-9bc329fd7376);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_003_8d2f44b7-7fa1-4586-a2c8-c49f730a3f2b);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_005_bf5f19cd-638f-4011-ae3d-45007163c637);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_006_d3239308-d0d6-49dd-a3b9-39605f5b57e9);
DB_LOW_SorcerousSundries_Client(S_LOW_NecromancyBuyer_d33d47b9-299e-4be3-8867-eaf53b200b46);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_004_e3fa81d4-53f3-49ad-8497-18673d399a37);
KBSECTION
//REGION Setting up Aradin, Lorroakan and Rolan/Projection
PROC
PROC_LOW_SorcerousSundries_NightsongSetup((CHARACTER)_Nightsong)
AND
NOT DB_PermaDefeated(_Nightsong)
THEN
PROC_LOW_SorcerousSundries_ContinueNSSetup();

PROC
PROC_LOW_SorcerousSundries_ContinueNSSetup()
AND
HasAppliedStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_SOULCAGE",1)
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_NIGHTSONG_SOULCAGE",S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

PROC
PROC_LOW_SorcerousSundries_ContinueNSSetup()
AND
DB_Camp_PreCampFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION) ACT2_SCE_EpilogueFaction_9c896609-f2f6-4f1a-8967-c83140977975)
THEN
NOT DB_Camp_PreCampFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION) ACT2_SCE_EpilogueFaction_9c896609-f2f6-4f1a-8967-c83140977975);
DB_Camp_PreCampFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4);

PROC
PROC_LOW_SorcerousSundries_ContinueNSSetup()
AND
GetFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT2_SCE_EpilogueFaction_9c896609-f2f6-4f1a-8967-c83140977975)
THEN
SetFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4);

//Checking if Aradin ever told players about nightsong plot
PROC
PROC_LOW_SorcerousSundries_AradinSetup((CHARACTER)_Aradin)
AND
DB_GlobalFlag((FLAG)GLO_AdventurersQuest_Knows_AboutBounty_93fcf273-334d-7aa8-d5c1-a4d154f0fe23)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_Knows_AboutLorroakanGoingAfterNightsong_06fc1554-756a-4d3f-8560-5848313210fa);

// Checking if Aradin is Available to start the dialogue (not dead) and registering the trigger
// Also removing remaining invulnerable act 1 scripting that might be remaining
PROC
PROC_LOW_SorcerousSundries_AradinSetup((CHARACTER)_Aradin)
AND
NOT DB_PermaDefeated(_Aradin)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_Aradin_ADTrigger_8329c11b-843d-4a16-9fd6-600e59972dce);
TeleportTo(_Aradin,S_LOW_AradinTeleportTo_b949ec95-fed4-4791-86dc-4d849b0c9e9d);
PROC_SetOnStage(_Aradin, 1);
SetHasDialog(_Aradin, 1);
SetFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92);
SetFlag((FLAG)LOW_Aradin_State_HasBeenAtSorcerousSundries_1255ce1e-d0a1-4b41-9a30-3e62063648ce);
SetFaction(_Aradin,(FACTION)ACT1_DEN_AdventurerLeader_8276868b-adf0-4b7e-fc32-2f268e43f51e);
PROC_SetInvulnerable(_Aradin,0);
SetImmortal(_Aradin,0);
PROC_SceneOver("DEN_RaidingParty_PleaAtGate");
PROC_CharacterEnableAllCrimes(_Aradin);
DB_SceneManager(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,"LOW_SorcerousSundries_AradinYellingAtKlankScene");

PROC
PROC_LOW_SorcerousSundries_AradinSetup((CHARACTER)_Aradin)
AND
DB_PermaDefeated(_Aradin)
THEN
SetFlag((FLAG)LOW_Aradin_State_IsPermaDefeated_f9fb4d8e-dfda-4457-a3de-1716cdb8d343);
ClearFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_Aradin_ADTrigger_7456d3db-aad6-4411-8c82-6266f81b29ef);

//Making Rolan level up to 7
PROC
PROC_LOW_SorcerousSundries_RolanSetup((CHARACTER)_Rolan)
AND
GetLevel(_Rolan,_CurrentLevel)
AND
IntegerSubtract(7,_CurrentLevel,_Dif)
AND
_Dif > 0
THEN
PROC_LevelUpBy(_Rolan,_Dif);

// Checking if Rolan is Available, updating the faction

PROC
PROC_LOW_SorcerousSundries_RolanSetup((CHARACTER)_Rolan)
AND
DB_GlobalFlag((FLAG)HAV_ProdigyLament_State_InShadowlands_68d204cb-3017-455e-9d80-c02abbc9f477)
THEN
Die(_Rolan, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

PROC
PROC_LOW_SorcerousSundries_RolanSetup((CHARACTER)_Rolan)
AND
NOT DB_GlobalFlag((FLAG)HAV_ProdigyLament_State_InShadowlands_68d204cb-3017-455e-9d80-c02abbc9f477)
AND
NOT DB_PermaDefeated(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
PROC_LOW_SorcerousSundries_SendRolanToLOW(_Rolan);

IF
TextEvent("LOW_SorcerousSundries_SendRolan")
THEN
PROC_LOW_SorcerousSundries_SendRolanToLOW((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

PROC
PROC_LOW_SorcerousSundries_SendRolanToLOW((CHARACTER)_Rolan)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_RolanMovesIn")
THEN
SetFlag((FLAG)GLO_Prodigy_State_InCity_5de01603-0dc7-4ebc-99f1-da5342ba9fd7);
ClearFlag((FLAG)GLO_Prodigy_State_InHaven_fe9b4527-9d66-45db-8e04-490fd51b7be5);
TeleportTo(_Rolan,S_LOW_RolanTeleportTo_c76eb1ca-e97e-4b27-ad8d-51e4cc4fd381);
SetOnStage(_Rolan, 1);
SetOnStage(S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2, 0);
SetFaction(_Rolan, (FACTION)ACT3_LOW_SorcerousSundries_Shop_0a2e84ee-30af-49a7-9216-935318f1eae1);
PROC_RemoveAllDialogEntriesForSpeaker(_Rolan);
DB_Dialogs((CHARACTER)_Rolan,(DIALOGRESOURCE)LOW_SorcerousSundries_Rolan_c6d83bfb-ed34-af42-dbff-506114212e96);
SetFlag((FLAG)LOW_Rolan_State_RolanAtTheShop_cd1aa0f6-c061-48e3-8222-ac648a66d3ca, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
SetTag(_Rolan,(TAG)ACT3_LOW_SORCEROUSSUNDRIES_VENDOR_9f66044c-876d-48cb-94c4-5b8c7a5f5d9e);
SetTag(_Rolan,(TAG)TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b);
SetTag(_Rolan,(TAG)AI_UNPREFERRED_TARGET_9787450d-f34d-43bd-be88-d2bac00bb8ee);
DB_LOW_SorcerousSundries_CurrentMainClerk(_Rolan);
PROC_SetCustomTradeTreasure(_Rolan,"LOW_SorcerousSundries_Trade");
DB_GLO_DefeatCounter(_Rolan,"LOW_SorcerousSundries_ShopCombatant");
PROC_LOW_SorcerousSundries_InitShop(_Rolan);
DB_NoLowAttitudeDialog(_Rolan);
PROC_LOW_SorcerousSundries_PlaceRolanJournal();

PROC
PROC_LOW_SorcerousSundries_PlaceRolanJournal()
AND
QRY_LOW_SorcerousSundries_SiblingsDead()
AND
QRY_OnlyOnce("LOW_SorcerousSundries_PlaceJournals")
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_SorcerousSundries_RolanJournalSiblingsFailed_7e91fa6a-dee7-4ed2-876f-a0081b8e5c33,S_LOW_SorcerousSundries_ClerkCabinet_4d99e79a-9669-4b9c-a74f-d21f75dd492c,1,0);

PROC
PROC_LOW_SorcerousSundries_PlaceRolanJournal()
AND
NOT QRY_LOW_SorcerousSundries_SiblingsDead()
AND
QRY_OnlyOnce("LOW_SorcerousSundries_PlaceJournals")
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_SorcerousSundries_RolanJournalSiblingsSaved_fe8c0c14-7484-4562-94b9-e99b0301867e,S_LOW_SorcerousSundries_ClerkCabinet_4d99e79a-9669-4b9c-a74f-d21f75dd492c,1,0); 

QRY
QRY_LOW_SorcerousSundries_SiblingsDead()
AND
DB_PermaDefeated((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b)
AND
DB_PermaDefeated((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d)
THEN
DB_NOOP(1);

PROC
PROC_LOW_SorcerousSundries_RolanSetup((CHARACTER)_Rolan)
AND
NOT DB_LOW_SorcerousSundries_CurrentMainClerk(_Rolan)
THEN
SetFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640);
TeleportTo(S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2,S_LOW_ProjectionTeleportTo_a84efcfe-3145-48fc-bc89-29e69e2036c3);
PROC_SetOnStage(S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2,1);
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);
PROC_LOW_SorcerousSundries_InitShop((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);

// Set Silver Servants Off-Stage
IF
DB_LOW_SorcerousSundries_Nightsong_Deva(_SilverServants)
THEN
SetOnStage(_SilverServants, 0);

//END_REGION

//REGION Debug element
IF
TextEvent("LOW_SorcerousSundries_NightsongMove")
THEN
SetFlag((FLAG)LOW_Nightsong_Quest_HasGoneToConfrontLorroakan_ed98ef99-f229-44d4-b020-62c415dba302);
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_NightsongCallsLorroakan_83276954-fdb0-6013-e71e-d074315edf1f, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_CharacterMoveTo(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, S_LOW_LorroakanTeleportTo_0063de25-d5c9-4c10-b907-a9abbe246114, "Run", "LOW_SorcerousSundries_FinalConfronationReached");
PROC_CharacterMoveTo((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_NightsongLorrokananTeleportTo_5c68bfc2-7e9b-4856-8f69-81f75f65feae, "Run", "LOW_SorcerousSundries_FinalConfronationReached");


IF
FlagSet((FLAG)LOW_SorcerousSundries_Event_DebugBlacklist_0176e04c-d587-443f-9127-4b0a5e3759af, _Player,_)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,_Value)
THEN
PROC_LOW_SorcerousSundries_ToggleBlacklisted(_Player,_Value);

PROC
PROC_LOW_SorcerousSundries_ToggleBlacklisted((GUIDSTRING)_Player, (INTEGER)_Value)
AND
_Value == 1
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player);

PROC
PROC_LOW_SorcerousSundries_ToggleBlacklisted((GUIDSTRING)_Player, (INTEGER)_Value)
AND
_Value == 0
THEN
SetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,1);

IF
DB_GlobalFlag((FLAG)LOW_Aradin_Event_DebugLeaveSorcerousSundries_a68c3a15-0556-467e-b3ca-769789a8f9c9)
THEN
ClearFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92);
PROC_DisappearOutOfSightTo(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, S_LOW_AlarinLeaveTo_88109786-792a-4ac9-b565-6014e50e8ea4, "Run", 0, "LOW_SorcerousSundries_AradinLeft");

IF
DB_GlobalFlag((FLAG)LOW_Nightsong_Event_DebugGoToRamazithTower_8303d93c-b8e9-4839-b4d3-69547553dfc5)
THEN
SetFlag((FLAG)LOW_Nightsong_Event_GoToRamazithTower_59fab159-060f-424c-9fd9-43cc00a88db9);
ClearFlag((FLAG)LOW_Lorroakan_Quest_WaitingForCampNightsongDialog_ce238f16-8215-48f8-90b4-a503a4426efd);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SetRelationToPlayers((FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 100);
SetFlag((FLAG)LOW_Nightsong_Quest_HasGoneToConfrontLorroakan_ed98ef99-f229-44d4-b020-62c415dba302, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_RamazithsJump_Start_12ca715e-872c-49be-93e1-65e17eacc8be, "LOW_SorcerousSundries_NightsongReadyToEnterRamazith",0,0,0,1,1);

IF
TextEvent("LOW_SorcerousSundries_NightsongTeleport")
THEN
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1);
SetFlag((FLAG)LOW_Nightsong_Event_GoToRamazithTower_59fab159-060f-424c-9fd9-43cc00a88db9);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SetRelationToPlayers((FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 100);
ClearFlag((FLAG)LOW_Lorroakan_Quest_WaitingForCampNightsongDialog_ce238f16-8215-48f8-90b4-a503a4426efd);
SetFlag((FLAG)LOW_Nightsong_Quest_HasGoneToConfrontLorroakan_ed98ef99-f229-44d4-b020-62c415dba302, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_RamazithsJump_Start_12ca715e-872c-49be-93e1-65e17eacc8be, "LOW_SorcerousSundries_NightsongReadyToEnterRamazith",0,0,0,1,1);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_Dialogs(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(DIALOGRESOURCE)LOW_SorcerousSundries_IsobelCamp_f7674ec5-775e-1a91-5faa-cb3e0532aa67);

IF
TextEvent("LOW_SorcerousSundries_GetTomes")
AND
GetHostCharacter(_Player)
AND
DB_LOW_SorcerousSundries_TomesWithScroll(_Tome,_)
THEN
ToInventory(_Tome, _Player, 1, 1, 1);


IF
TextEvent("LOW_SorcerousSundries_GetTomes")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_UNI_TharchiateCypher_0addb171-6e14-4b4c-8d97-c9af9ba1dcb8, _Player, 1, 1, 1);

IF
TextEvent("LOW_SorcerousSundries_RemoveSpellsRolan")
THEN
RemoveSpell((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"Projectile_MagicMissile", 0);
RemoveSpell((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"Zone_ColorSpray", 0);
RemoveSpell((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"Zone_Thunderwave", 0);
RemoveSpell((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"Target_MageArmor", 0);

IF
TextEvent("LOW_SorcerousSundries_ZombieSpell")
AND
GetHostCharacter(_Player)
THEN
AddSpell((CHARACTER)_Player, "Shout_LOW_SorcerousSundries_WakeOfTheDead",1,0);


IF
TextEvent("LOW_SorcerousSundries_OwnershipDoors")
AND
DB_LOW_SorcerousSundries_ForbiddenDoors(_Door)
THEN
ClearOwnership(_Door);
SetOwner(_Door,(CHARACTER)S_LOW_LorroakanProjection_PuzzleGuardian_c65a2e91-34f1-4dd9-a784-2aca5a4d9cd2);

IF
TextEvent("LOW_SorcerousSundries_MakeRolanInCharge")
THEN
SetFlag((FLAG)LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5);
TeleportTo(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, S_LOW_RolanLorroakanTeleportTo_13708935-bd6f-4053-98e1-bd07a2aeab78);

IF
TextEvent("LOW_SorcerousSundries_AradinLeaveAndAttack")
THEN
SetFlag((FLAG)LOW_Aradin_Knows_BelievesNightsongIsAtCamp_aa7cc65a-3fb6-4bf7-aa65-c14b5c38df70);
ClearFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92);
SetFlag((FLAG)LOW_Aradin_Event_DebugLeaveSorcerousSundries_a68c3a15-0556-467e-b3ca-769789a8f9c9);

IF
TextEvent("LOW_portal")
THEN
SetOnStage(S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,1);
SetOnStage(S_LOW_PortalToShop_824362a7-c028-484f-9ed1-2fb0a915551a,1);
ApplyStatus(S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,"PUZ_CASTEDPORTAL_BLUE",999.0, 1);
ApplyStatus(S_LOW_PortalToShop_824362a7-c028-484f-9ed1-2fb0a915551a,"PUZ_CASTEDPORTAL_BLUE",999.0, 1);
SetCanInteract((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,1);
SetCanInteract((ITEM)S_LOW_PortalToShop_824362a7-c028-484f-9ed1-2fb0a915551a,1);

IF
TextEvent("LOW_portalOff")
THEN
RemoveStatus(S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,"PUZ_CASTEDPORTAL_BLUE",LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5);
RemoveStatus(S_LOW_PortalToShop_824362a7-c028-484f-9ed1-2fb0a915551a,"PUZ_CASTEDPORTAL_BLUE",S_LOW_PortalToShop_824362a7-c028-484f-9ed1-2fb0a915551a);
SetCanInteract((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,0);
ObjectTimerLaunch(S_LOW_PortalToShop_824362a7-c028-484f-9ed1-2fb0a915551a,"LOW_SorcerousSundries_SetOffStageDelayed",2500);
ObjectTimerLaunch(S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,"LOW_SorcerousSundries_SetOffStageDelayed",2500);

IF
TextEvent("LOW_SorcerousSundries_SetNightsongAtCamp")
THEN
SetFlag((FLAG)CAMP_SharTempleEpilogue_State_NightsongInCamp_1e3475b8-ab7b-4a53-a079-0ac3f86899ed);
ClearFlag((FLAG)SHA_Nightsong_State_PermaDefeated_d02e8ea4-dec7-4824-8117-efc075dee4ba,NULL_00000000-0000-0000-0000-000000000000, 0);

IF
TextEvent("LOW_SorcerousSundries_AradinGoAttackCamp")
THEN
SetFlag((FLAG)LOW_Aradin_Knows_BelievesNightsongIsAtCamp_aa7cc65a-3fb6-4bf7-aa65-c14b5c38df70);
SetFlag((FLAG)LOW_Aradin_Event_LeaveSorcerousSundries_9b859898-5d65-4cfb-8b0b-fa3c93f9c752,S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, 0);
ClearFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92,NULL_00000000-0000-0000-0000-000000000000, 0);

IF
TextEvent("LOW_SendNightsongToCamp")
THEN
SetEntityEvent(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "DebugTeleportedToCamp");

IF
TextEvent("LOW_SorcerousSundries_HaveNecromancyBookReady")
AND
GetClosestAlivePlayer(S_UNI_TharchiateCypher_0addb171-6e14-4b4c-8d97-c9af9ba1dcb8,_Player,_)
THEN
ToInventory((ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507,_Player,1,1,1);
SetFlag(FOR_DangerousBook_State_BookUnlocked_fd215551-a14c-8cfa-ba34-7ac32d1ada28);
SetFlag((FLAG)FOR_DangerousBook_State_BookOwner_06022678-24ed-35af-de93-bd91abc02452,_Player);
SetFlag((FLAG)FOR_DangerousBook_State_Bound_5e16d6fc-ae5c-cb6f-3a0f-4237593ee05e);
SetFlag((FLAG)FOR_DangerousBook_State_BookFinished_489a23a0-758a-97bd-bd0c-d6b417c20af3);

IF
TextEvent("LOW_SorcerousSundries_GetNecromancyOfThay")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_FOR_DangerousBook_Key_000_123c268d-ad0c-4df5-905b-a78dacbed80b,_Player,1,1,1);
ToInventory((ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507,_Player,1,1,1);


IF
TextEvent("LOW_RolanBrotherSaved")
THEN
SetFlag((FLAG)HAV_SavingPrisoners_State_BrotherReturned_2b696962-1d09-4cb6-b034-34d86d73dba0);

IF
TextEvent("LOW_RolanSisterSaved")
THEN
SetFlag((FLAG)HAV_SavingPrisoners_State_SisterReturned_54cbf85c-163b-d0f7-2519-93ff58c843aa);

//END_REGION

//REGION Shop vendors

//Lorroakan projection
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2, _Player)
THEN
DB_SelectedDialog(
	(DIALOGRESOURCE)LOW_SorcerousSundries_LorroakanProjection_b90d7005-f9c9-350d-2dc0-d821f756455f,
	S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2,
	_Player);

IF
DB_LOW_SorcerousSundries_Projections(_Projection)
THEN
PROC_SetInvulnerable(_Projection,1);
PROC_CharacterDisableAllCrimes(_Projection);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_SorcerousSundries_Event_BlowUpBooks_9b3aa100-dc49-413b-9b03-e9ff967d9220)
AND
DB_LOW_SorcerousSundries_SensitiveBooks(_Book)
AND
DB_Defeated((ITEM)_Book)
THEN
PROC_Poof(_Book);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_SorcerousSundries_Event_BlowUpBooks_9b3aa100-dc49-413b-9b03-e9ff967d9220)
AND
DB_LOW_SorcerousSundries_TolnaExplosionLocations(_Trigger)
THEN
CreateExplosion(_Trigger,"Projectile_LOW_SorcerousSundries_BookExplosion",1);

IF
BaseFactionChanged(_Pet,_,(FACTION)LOW_SorcerousSundries_PetSummoner_24799649-c97e-495d-b825-7df1a996b573)
THEN
ApplyStatus(_Pet,"LOW_SORCEROUSSUNDRIES_MINORILLUSION",-1.0);

//REGION Clerk position

PROC
PROC_LOW_SorcerousSundries_InitShop((CHARACTER)_Clerk)
THEN
DB_ItemOwnershipTriggers("CTY_Main_A",(TRIGGER)S_LOW_OwnershipMainClerkTrigger_c878a73d-b8d8-4b31-86b5-04182b134e1c,_Clerk);
DB_ItemOwnershipTriggers("CTY_Main_A",(TRIGGER)S_LOW_OwnershipRestOfTheShopTrigger_82898b18-a3e7-474e-8a28-4ea9d370d4f5,_Clerk);
DB_ItemShopTrigger((TRIGGER)S_LOW_OwnershipMainClerkTrigger_c878a73d-b8d8-4b31-86b5-04182b134e1c, _Clerk);
DB_ItemOwnerShipClearItem("CTY_Main_A", (ITEM)S_LOW_NightsongPamphlet_000_40ad72cb-ae54-4b45-a4ce-d9c85d61611d);
DB_ItemOwnerShipClearItem("CTY_Main_A", (ITEM)S_LOW_NightsongPamphlet_001_ff7fa76b-a555-4c37-a32a-e4834153a6cf);
DB_ItemOwnerShipClearItem("CTY_Main_A", (ITEM)S_LOW_NightsongPamphlet_002_8202b31a-1b30-4b4d-a457-fe47f1201a15);

PROC
PROC_LOW_SorcerousSundries_InitShop((CHARACTER)_Clerk)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_SetSpottingAndCombatants")
THEN
PROC_LOW_SorcerousSundries_SetSpottingAndCombatants(_Clerk);


PROC
PROC_LOW_SorcerousSundries_SetSpottingAndCombatants((CHARACTER)_Clerk)
THEN
DB_GLO_DefeatCounter(S_LOW_LavaElemental_1dea794e-2657-4c54-916b-edc639c4ff8c,"LOW_SorcerousSundries_ShopCombatant");
DB_GLO_DefeatCounter(S_LOW_WaterElemental_4cb61416-f095-4fbb-aece-51f37b6bb4d6,"LOW_SorcerousSundries_ShopCombatant");
DB_GLO_DefeatCounter(S_LOW_Tolna_46aa02d8-28e9-4ebb-876c-82fe29262d35,"LOW_SorcerousSundries_ShopCombatant");
DB_GLO_DefeatCounter(S_LOW_ShopAnimatedArmor_004_9752ca37-cc97-42fc-b7d0-a0f0a8b1dfd3,"LOW_SorcerousSundries_ShopCombatant");
DB_GLO_DefeatCounter(S_LOW_ShopAnimatedArmor_005_d42295ab-7169-4bba-9a7c-8124196caea7,"LOW_SorcerousSundries_ShopCombatant");
DB_GLO_DefeatCounter(S_LOW_ShopAnimatedArmor_003_e57cc258-8f98-45d0-b6dc-063e945ce086,"LOW_SorcerousSundries_ShopCombatant");
DB_GLO_DefeatCounter(S_LOW_ShopAnimatedArmor_002_4b741aa9-c2af-4196-a8fd-7bc9a8f5cd5d,"LOW_SorcerousSundries_ShopCombatant");
DB_GLO_DefeatCounter(S_LOW_ShopAnimatedArmor_001_50e39747-fa44-4d2a-8427-186d2f9a5d1c,"LOW_SorcerousSundries_ShopCombatant");
DB_GLO_DefeatCounter(S_LOW_SorcerousSundries_Necromancer_ba40224c-9113-4a18-b30b-a1a77e88f9d2,"LOW_SorcerousSundries_ShopCombatant");
PROC_LOW_SorcerousSundries_SetMainClerkSpotting((CHARACTER)_Clerk); //main clerk warning spotting
DB_SpotPlayers((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, "LOW_SorcerousSundries_KlankBannedSpotting", (FLAG)NULL_00000000-0000-0000-0000-000000000000,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,"LOW_SorcerousSundries_KlankBannedSpotting");
DB_SpotPlayers_IncludeWildshapedPlayers((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,"LOW_SorcerousSundries_KlankBannedSpotting");
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,"LOW_SorcerousSundries_KlankBannedSpotting",(TRIGGER)S_LOW_SorcerousCheckpoint_PrimaryTrigger_1181722d-3b04-4ebc-be3c-9e9059ba451c);

PROC
PROC_LOW_SorcerousSundries_ChangeOwnershipClerk((CHARACTER)_Char)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_MainClerk)
AND
DB_ItemShopTrigger((TRIGGER)S_LOW_OwnershipMainClerkTrigger_c878a73d-b8d8-4b31-86b5-04182b134e1c,_MainClerk)
THEN
NOT DB_ItemShopTrigger((TRIGGER)S_LOW_OwnershipMainClerkTrigger_c878a73d-b8d8-4b31-86b5-04182b134e1c, (CHARACTER)_MainClerk);
DB_ItemShopTrigger((TRIGGER)S_LOW_OwnershipMainClerkTrigger_c878a73d-b8d8-4b31-86b5-04182b134e1c, (CHARACTER)_Char);

//Rolan replaced by Lorroakan projection
IF
DB_GlobalFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
//Set timer to have time to set DB_LOW_SorcerousSundries_AllCombatantsDead(1) in case Rolan is last combatant to be killed
TimerLaunch("LOW_SorcerousSundries_PrepareForRolanReplacement",1000);

IF
TimerFinished("LOW_SorcerousSundries_PrepareForRolanReplacement")
THEN
PROC_LOW_SorcerousSundries_ReplaceMainClerk((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);

// Lorroakan substituted by rolan projection
PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5)
AND
NOT DB_GlobalFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640)
THEN
DB_ExecuteInLevel("LOW_SorcerousSundries_ReplaceMainClerk_RolanProjection","CTY_Main_A");

PROC
PROC_ExecuteInLevel("LOW_SorcerousSundries_ReplaceMainClerk_RolanProjection","CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5)
AND
NOT DB_GlobalFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640)
AND
NOT DB_LOW_SorcerousSundries_AllCombatantsDead(1)
THEN
PROC_LOW_SorcerousSundries_ReplaceMainClerk((CHARACTER)S_LOW_RolanProjection_c6a47d05-5051-42de-86b0-776fe0285cd1);

//If Rolan is defeated after being master of the shop
IF
FlagSet((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640,_,_)
AND
DB_GlobalFlag((FLAG)LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5)
THEN
ClearFlag((FLAG)LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5);

PROC
PROC_LOW_SorcerousSundries_ReplaceMainClerk((CHARACTER)_NewClerk)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)_OldClerk)
AND
NOT DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)_NewClerk)
AND
NOT QRY_LOW_SorcerousSundries_NoCombatantLeftAndLorroProjection((CHARACTER)_NewClerk)
THEN
PROC_LOW_SorcerousSundries_ProceedWithClerkReplacement(_NewClerk);

PROC
PROC_LOW_SorcerousSundries_ProceedWithClerkReplacement((CHARACTER)_NewClerk)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)_OldClerk)
AND
IsOnStage(_OldClerk, 1)
AND
DB_LOW_SorcerousSundries_Projections((CHARACTER)_OldClerk)
THEN
RemoveStatus(_OldClerk,"LOW_SORCEROUSSUNDRIES_PROJECTION");

PROC
PROC_LOW_SorcerousSundries_ProceedWithClerkReplacement((CHARACTER)_NewClerk)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)_OldClerk)
AND
NOT DB_LOW_SorcerousSundries_Projections((CHARACTER)_OldClerk)
AND
NOT DB_Defeated(_OldClerk)
THEN
PROC_SetOnStage(_OldClerk,0);

IF
WentOnStage(_Projection,1)
AND
DB_LOW_SorcerousSundries_Projections((CHARACTER)_Projection)
AND
HasActiveStatus(_Projection,"LOW_SORCEROUSSUNDRIES_PROJECTION",0)
THEN
ApplyStatus(_Projection,"LOW_SORCEROUSSUNDRIES_PROJECTION",-1.0);

IF
StatusRemoved(_Projection,"LOW_SORCEROUSSUNDRIES_PROJECTION",_,_)
THEN
PROC_SetOnStage(_Projection,0);

PROC
PROC_LOW_SorcerousSundries_ProceedWithClerkReplacement((CHARACTER)_NewClerk)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)_OldClerk)
THEN
PROC_LOW_SorcerousSundries_ChangeOwnershipClerk(_NewClerk);
NOT DB_LOW_SorcerousSundries_CurrentMainClerk(_OldClerk);
DB_LOW_SorcerousSundries_CurrentMainClerk(_NewClerk);
TeleportTo(_NewClerk,S_LOW_ProjectionTeleportTo_a84efcfe-3145-48fc-bc89-29e69e2036c3,"LOW_SorcerousSundries_NewClerkTeleported");
PROC_SpotPlayers_StopSpotting(_OldClerk,"LOW_SorcerousSundries_BannedSpotting");
PROC_LOW_SorcerousSundries_SetMainClerkSpotting((CHARACTER)_NewClerk);

IF
EntityEvent(_NewClerk, "LOW_SorcerousSundries_NewClerkTeleported")
THEN
PROC_SetOnStage(_NewClerk,1);

//Edgecase where the last combatant is Rolan and killing him triggered the appeareance of projection
QRY
QRY_LOW_SorcerousSundries_NoCombatantLeftAndLorroProjection((CHARACTER)_Clerk)
AND
_Clerk == S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2
AND
DB_LOW_SorcerousSundries_AllCombatantsDead(1)
THEN
DB_NOOP(1);


//END_REGION

//REGION Guards

IF
EnteredTrigger(_,(TRIGGER)S_LOW_NecromanticVendorTrigger_9ea2b581-5104-4848-933d-7bff203e81a2)
AND
QRY_SpeakerIsAvailable(S_LOW_SorcerousSundries_Necromancer_ba40224c-9113-4a18-b30b-a1a77e88f9d2)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_ReanimateBody")
THEN
UseSpell(S_LOW_SorcerousSundries_Necromancer_ba40224c-9113-4a18-b30b-a1a77e88f9d2,"Target_AnimateDead_Zombie",S_LOW_BodyToResurrect_85591bc4-05f2-40b3-8498-a8747671c8e3);

IF
CastSpellFailed(S_LOW_SorcerousSundries_Necromancer_ba40224c-9113-4a18-b30b-a1a77e88f9d2,"Target_AnimateDead_Zombie",_,_,_)
AND
DB_OnlyOnce("LOW_SorcerousSundries_ReanimateBody")
THEN
NOT DB_OnlyOnce("LOW_SorcerousSundries_ReanimateBody");

IF
CastedSpell(S_LOW_SorcerousSundries_Necromancer_ba40224c-9113-4a18-b30b-a1a77e88f9d2,"Target_AnimateDead_Zombie",_,_,_)
THEN
PROC_TriggerUnregisterForParty((TRIGGER)S_LOW_NecromanticVendorTrigger_9ea2b581-5104-4848-933d-7bff203e81a2);

IF
BaseFactionChanged(_Zombie,_,(FACTION)ACT3_LOW_SorcerousSundries_Shop_0a2e84ee-30af-49a7-9216-935318f1eae1)
AND
CharacterGetOwner(_Zombie,(CHARACTER)S_LOW_SorcerousSundries_Necromancer_ba40224c-9113-4a18-b30b-a1a77e88f9d2)
THEN
DB_Dialogs((CHARACTER)_Zombie, (DIALOGRESOURCE)LOW_SorcerousSundries_ZombieNecromancy_55693fbb-3274-3519-3947-070422f07cf3);
PROC_CharacterDisableAllCrimes((CHARACTER)_Zombie);
SetFlag((FLAG)LOW_SorcerousSundries_State_RaisedZombie_6df57400-b395-4391-be33-5bb0b8750335);

IF
DB_LOW_SorcerousSundries_ShopArmors(_Armor)
THEN
DB_Dialogs(_Armor,(DIALOGRESOURCE)LOW_SorcerousSundries_AnimatedArmor_6195a66d-38b3-488a-b65e-1c597ef8c606);

IF
Died(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_SorcerousSundries_Klank_f20b4417-45a0-49c0-bcc4-cd3437909f35,50);
PROC_SetRelationMutual((FACTION)Act3_LOW_SorcerousSundries_Klank_f20b4417-45a0-49c0-bcc4-cd3437909f35, (FACTION)ACT1_DEN_AdventurerLeader_8276868b-adf0-4b7e-fc32-2f268e43f51e,50);

PROC
PROC_LongRest()
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_SorcerousSundries_AnimatedArmors_2eac0e71-1ba1-4af2-85c7-e9fdbb9ad938,50);


//END_REGION

//END_REGION

//REGION Shop buyers

IF
DB_LOW_SorcerousSundries_CustomerADs(_Trigger,_,_,_,_)
THEN
DB_OneShotPlayerTrigger(_Trigger);

PROC
PROC_OneShotTriggerEntered(_,_Trigger)
AND
DB_LOW_SorcerousSundries_CustomerADs(_Trigger,_,_,_Dialog,_)
THEN
PROC_LOW_SorcerousSundries_StartRepeatedAD(_Dialog);

PROC
PROC_LOW_SorcerousSundries_StartRepeatedAD((DIALOGRESOURCE)_Dialog)
AND
DB_LOW_SorcerousSundries_CustomerADs(_Trigger,_NPC1,_NPC2,_Dialog,1)
AND
NOT DB_DialogNPCs(_,_NPC1,_)
AND
NOT DB_PermaDefeated(_NPC1)
THEN
PROC_TryStartAD(_Dialog, _NPC1);

PROC
PROC_LOW_SorcerousSundries_StartRepeatedAD((DIALOGRESOURCE)_Dialog)
AND
DB_LOW_SorcerousSundries_CustomerADs(_Trigger,_NPC1,_NPC2,_Dialog,2)
AND
NOT DB_DialogNPCs(_,_NPC1,_)
AND
NOT DB_DialogNPCs(_,_NPC2,_)
AND
NOT DB_PermaDefeated(_NPC1)
AND
NOT DB_PermaDefeated(_NPC2)
THEN
PROC_TryStartAD(_Dialog, _NPC1, _NPC2);


IF
AutomatedDialogEnded(_Dialog,_)
AND
DB_LOW_SorcerousSundries_CustomerADs(_,_NPC1,_,_Dialog,_)
THEN
ObjectTimerLaunch(_NPC1,"LOW_SorcerousSundries_StartRepeatedDialog",5000);

IF
ObjectTimerFinished(_NPC1,"LOW_SorcerousSundries_StartRepeatedDialog")
AND
DB_LOW_SorcerousSundries_CustomerADs(_,_NPC1,_,_Dialog,_)
THEN
PROC_LOW_SorcerousSundries_StartRepeatedAD((DIALOGRESOURCE)_Dialog);



//END_REGION


//REGION Klank

IF
DB_Is_InCombat(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,_CombatGUID)
AND
DB_Is_InCombat(_Player,_CombatGUID)
AND
DB_Players((CHARACTER)_Players)
AND
IsEnemy((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, (CHARACTER)_Player,1)
AND
NOT DB_LOW_SorcerousSundries_CombatPlayerKlank(_CombatGUID, _Player)
THEN
DB_LOW_SorcerousSundries_CombatPlayerKlank(_CombatGUID, _Player);
PROC_LOW_SorcerousSundries_KlankAttackedByPlayer(_Player);


IF
SwitchedCombat(_Player, _OldID, _NewID)
AND
DB_LOW_SorcerousSundries_CombatPlayerKlank(_OldID, (CHARACTER)_Player)
THEN
NOT DB_LOW_SorcerousSundries_CombatPlayerKlank(_OldID, _Player);
DB_LOW_SorcerousSundries_CombatPlayerKlank(_NewID, (CHARACTER)_Player);

PROC
PROC_LOW_SorcerousSundries_KlankAttackedByPlayer((CHARACTER)_Player)
AND
QRY_LOW_SorcerousSundries_CheckIfWarned((CHARACTER)_Player)
THEN
DB_NOOP(1);

QRY
QRY_LOW_SorcerousSundries_CheckIfWarned((CHARACTER)_Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_State_Warned_591a4170-a732-44a1-aa36-a1be35bf8a28,_Player,1)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,0)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_ProdigyHasStayedAtRamazith_524ab56a-8169-4926-9105-8bcaf8c87499)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player);

QRY
QRY_LOW_SorcerousSundries_CheckIfWarned((CHARACTER)_Player)
AND
NOT DB_LOW_SorcerousSundries_KilledKlank(_Player)
THEN
DB_LOW_SorcerousSundries_KilledKlank(_Player);
SetFlag((FLAG)LOW_SorcerousSundries_State_WaitingToBeWarned_11c39e25-12a2-4c8d-8658-69ca6f4bee1c,_Player);


IF
FlagSet((FLAG)LOW_Aradin_Event_LeaveSorcerousSundries_9b859898-5d65-4cfb-8b0b-fa3c93f9c752, (CHARACTER) _Character,_)
THEN
PROC_CharacterMoveTo((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, S_LOW_SideKlankPositionTrigger_3df99565-8ef6-43cb-941d-0cc8836db185, "Walk","");

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, _Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92)
THEN
DB_SelectedDialog(
	LOW_SorcerousSundries_Klank_04e461be-8cd3-f261-3f12-3c70eb4cd0f6,
	S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,
	_Player);

PROC
PROC_LongRest()
AND
QRY_LOW_SorcerousSundries_CheckIfThereIsOwner()
AND
NOT DB_LOW_SorcerousSundries_ReadyToResurrectKlank(1)
THEN
DB_LOW_SorcerousSundries_ReadyToResurrectKlank(1);

IF
DB_LOW_SorcerousSundries_ReadyToResurrectKlank(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToResurrectKlank(1);
PROC_CharacterFullRestore((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_SorcerousSundries_Klank_f20b4417-45a0-49c0-bcc4-cd3437909f35,50);

QRY
QRY_LOW_SorcerousSundries_CheckIfThereIsOwner()
AND
NOT DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
THEN
DB_NOOP(1);

QRY
QRY_LOW_SorcerousSundries_CheckIfThereIsOwner()
AND
DB_GlobalFlag((FLAG)LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5)
THEN
DB_NOOP(1);



//END_REGION

//REGION Aradin dialog

IF
KilledBy( S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, _Player, _,_)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_LOW_SorcerousSundries_KlankAttackedByPlayer((CHARACTER)_Player);

IF
KilledBy( S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, _Player, _,_)
AND
DB_GlobalFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92)
AND
IsInCombat(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,0)
AND
QRY_SpeakerIsAvailable(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_AradinApproachesPlayer")
THEN
PROC_CharacterMoveToAndTalk(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,  _Player, (DIALOGRESOURCE) LOW_SorcerousSundries_Aradin_f25cbd18-f09a-4dc2-414c-6762d60a3a86, "LOW_SorcerousSundries_AradinGoTalkAfterCombat", "Run", 15.0);

IF
CharacterMoveToAndTalkFailed(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,_Player,"LOW_SorcerousSundries_AradinGoTalkAfterCombat",_)
THEN
PROC_LOW_SorcerousSundries_AradinLeaveShop();

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_Aradin_Event_LeaveSorcerousSundries_9b859898-5d65-4cfb-8b0b-fa3c93f9c752)
THEN
SetHasDialog(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
PROC_LOW_SorcerousSundries_AradinLeaveShop();

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_Aradin_Event_LeaveSorcerousSundries_9b859898-5d65-4cfb-8b0b-fa3c93f9c752)
AND
NOT DB_GlobalFlag((FLAG)LOW_Aradin_Knows_BelievesNightsongIsAtCamp_aa7cc65a-3fb6-4bf7-aa65-c14b5c38df70)
AND
DB_GLO_DefeatCounter(_Character, "LOW_SorcerousSundries_AradinAttackers")
THEN
PROC_PeacefulResolve((CHARACTER)_Character);

PROC
PROC_LOW_SorcerousSundries_AradinLeaveShop()
THEN
SetFlag((FLAG)LOW_Lorroakan_Quest_WaitingForCampNightsongDialog_ce238f16-8215-48f8-90b4-a503a4426efd);
ClearFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92);
TriggerUnregisterForCharacter((TRIGGER)S_LOW_AradinStayAreaTrigger_ddc16aed-a2d2-473b-aa9f-fafb647bf4a4, S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);

IF
FlagCleared((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92,_,_)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_AradinLeaves")
THEN
DB_LOW_SorcerousSundries_AradinStoppedYelling(1);

IF
DB_PermaDefeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
AND
DB_LOW_SorcerousSundries_AradinStoppedYelling(1)
THEN
NOT DB_LOW_SorcerousSundries_AradinStoppedYelling(1);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, _Player)
AND
DB_GlobalFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92)
AND
QRY_SpeakerIsAvailable(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
THEN
DB_SelectedDialog(
	LOW_SorcerousSundries_Aradin_f25cbd18-f09a-4dc2-414c-6762d60a3a86,
	S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,
	_Player,
	S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7
	);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, _Player)
AND
NOT DB_PermaDefeated(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7)
AND
QRY_SpeakerIsAvailable(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7)
AND
DB_GlobalFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92)
THEN
DB_SelectedDialog(
	LOW_SorcerousSundries_Aradin_f25cbd18-f09a-4dc2-414c-6762d60a3a86,
	S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,
	_Player,
	S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7
	);

PROC
PROC_SceneInterrupted(_,_Player, "LOW_SorcerousSundries_AradinYellingAtKlankScene","DisturbanceRegistering")
THEN
DB_LOW_SorcerousSundries_PlayerToMakeHostileToKlank(_Player);
PROC_SceneOver("LOW_SorcerousSundries_AradinYellingAtKlankScene");

PROC
PROC_SceneOver("LOW_SorcerousSundries_AradinYellingAtKlankScene")
AND
DB_LOW_SorcerousSundries_PlayerToMakeHostileToKlank(_Player)
THEN
PROC_SetRelationTemporaryHostile(_Player,S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7);
SetFlag((FLAG)LOW_SorcerousSundries_State_KlankAttackedAradinSaw_f57b0854-44fd-4b8e-a888-a5514e794699);
PROC_SetRelationMutual((FACTION)Act3_LOW_SorcerousSundries_Klank_f20b4417-45a0-49c0-bcc4-cd3437909f35, (FACTION)ACT1_DEN_AdventurerLeader_8276868b-adf0-4b7e-fc32-2f268e43f51e, 0);

IF
DB_Is_InCombat(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,_CombatGUID)
AND
DB_Is_InCombat(_Player,_CombatGUID)
AND
DB_Players((CHARACTER)_Players)
AND
DB_GlobalFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_AradinAttacksKlank")
THEN
SetFlag((FLAG)LOW_SorcerousSundries_State_KlankAttackedAradinSaw_f57b0854-44fd-4b8e-a888-a5514e794699);
PROC_SetRelationMutual((FACTION)Act3_LOW_SorcerousSundries_Klank_f20b4417-45a0-49c0-bcc4-cd3437909f35, (FACTION)ACT1_DEN_AdventurerLeader_8276868b-adf0-4b7e-fc32-2f268e43f51e, 0);

IF
DB_Is_InCombat(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,_CombatGUID)
AND
DB_Is_InCombat(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,_CombatGUID)
THEN
DB_LOW_SorcerousSundries_AradinAndKlankCombatID(_CombatGUID);
PROC_ForceStopDialog(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
DB_CombatReact_AD_OnTurn(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, (DIALOGRESOURCE)LOW_SorcerousSundries_AD_AradinSeesKlankAttacked_d045107c-75df-8031-ce60-3c6b15ba74f6, 1);

IF
SwitchedCombat(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, _OldID, _NewID)
AND
DB_LOW_SorcerousSundries_AradinAndKlankCombatID(_OldID)
THEN
NOT DB_LOW_SorcerousSundries_AradinAndKlankCombatID(_OldID);
DB_LOW_SorcerousSundries_AradinAndKlankCombatID(_NewID);

//After combat Aradin-Klank, Aradin talks to player
IF
CombatEnded(_ID)
AND
DB_LOW_SorcerousSundries_AradinAndKlankCombatID(_ID)
AND
NOT DB_GlobalFlag((FLAG)LOW_Aradin_State_IsPermaDefeated_f9fb4d8e-dfda-4457-a3de-1716cdb8d343)
AND
GetClosestAlivePlayer(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,_Player,_Dist)
THEN
PROC_CharacterMoveToAndTalk(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,  _Player, (DIALOGRESOURCE) LOW_SorcerousSundries_Aradin_f25cbd18-f09a-4dc2-414c-6762d60a3a86, "LOW_SorcerousSundries_AradinGoTalkAfterCombat", "Run", 15.0);

IF
EnteredTrigger(_Player,(TRIGGER)S_LOW_EnterSorcerousTrigger_7c408b4f-8d02-43d5-9f7b-a3898afe2bf0)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92)
AND
NOT DB_DialogNPCs(_,S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,_)
THEN
PROC_ForceStopDialog(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
SetEntityEvent(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,"LOW_SorcerousSundries_InterruptAradinYelling");
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_AradinReactEnterWhileYelling_589f55c3-5364-8fea-714c-0e0e92b8d187,S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_EnterSorcerousTrigger_7c408b4f-8d02-43d5-9f7b-a3898afe2bf0);

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_AD_AradinReactEnterWhileYelling_589f55c3-5364-8fea-714c-0e0e92b8d187,_)
THEN
SetEntityEvent(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,"LOW_SorcerousSundries_ResumeAradinYelling");


IF
LeftTrigger(_Aradin,(TRIGGER)S_LOW_AradinStayAreaTrigger_ddc16aed-a2d2-473b-aa9f-fafb647bf4a4)
AND
IsInCombat(_Aradin,0)
AND
NOT DB_GlobalFlag((FLAG)NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113)
AND
NOT DB_PermaDefeated(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7)
THEN
PROC_CharacterMoveTo(_Aradin,S_LOW_AradinTeleportTo_b949ec95-fed4-4791-86dc-4d849b0c9e9d,"Run","");


//END_REGION

//REGION Rolan

IF
FlagSet((FLAG)LOW_Rolan_Event_GoBackToSorcerousSundries_234e30c0-103c-4117-a137-968a6a3f3cef, _Rolan,_)
THEN
TeleportTo(_Rolan,S_LOW_RolanTeleportTo_c76eb1ca-e97e-4b27-ad8d-51e4cc4fd381);
SetOnStage(S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2, 0);
SetFlag((FLAG)LOW_Rolan_State_RolanAtTheShop_cd1aa0f6-c061-48e3-8222-ac648a66d3ca, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
DB_Dialogs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(DIALOGRESOURCE)LOW_SorcerousSundries_Rolan_c6d83bfb-ed34-af42-dbff-506114212e96);

IF
DB_PermaDefeated(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
SetFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640);
ClearFlag((FLAG)LOW_Rolan_State_RolanAtTheShop_cd1aa0f6-c061-48e3-8222-ac648a66d3ca, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

//END_REGION

//REGION Custom checkpoint
IF
FlagSet((FLAG)LOW_SorcerousSundries_Event_BlacklistedPlayerTeleported_e4a4d044-123f-4499-8714-9a8dca72a583, _Player, _Instance)
THEN
TeleportTo(_Player, S_LOW_SorcerousSundriesTeleportTo_769fa8ca-63f8-4364-b903-1f0190588db2, "", 1, 1, 1, 1, 1);
ClearFlag((FLAG)LOW_SorcerousSundries_Event_BlacklistedPlayerTeleported_e4a4d044-123f-4499-8714-9a8dca72a583, _Player, _Instance);

PROC
PROC_LOW_SorcerousSundries_SetMainClerkSpotting((CHARACTER)_Clerk)
THEN
DB_SpotPlayers(_Clerk, "LOW_SorcerousSundries_BannedSpotting", (FLAG)NULL_00000000-0000-0000-0000-000000000000,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous(_Clerk,"LOW_SorcerousSundries_BannedSpotting");
DB_SpotPlayers_IncludeWildshapedPlayers(_Clerk,"LOW_SorcerousSundries_BannedSpotting");
DB_SpotPlayers_SpotTrigger(_Clerk,"LOW_SorcerousSundries_BannedSpotting",(TRIGGER)S_LOW_SorcerousCheckpoint_ClerkSpotTrigger_21b5350e-7827-4894-a2d2-0d71849d2a4e);

//If all combatants in shop are dead, projections will disappear
PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_SorcerousSundries_ShopCombatant")
THEN
DB_LOW_SorcerousSundries_AllCombatantsDead(1);
SetFlag((FLAG)LOW_SorcerousSundries_State_ShopEmptied_afa22562-ce57-4377-a153-59d60674d997);
PROC_LOW_SorcerousSundries_PatronsFlee();

PROC
PROC_LOW_SorcerousSundries_PatronsFlee()
AND
DB_LOW_SorcerousSundries_Client(_Client)
AND
NOT DB_Defeated(_Client)
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)_Client,"LOW_SorcerousSundries_ReadyToFlee");

PROC
PROC_ReadyToMoveOn((CHARACTER)_Client,"LOW_SorcerousSundries_ReadyToFlee")
THEN
PROC_CharacterMoveTo((CHARACTER)_Client,S_LOW_SorcerousSundries_LeaveShopTrigger_949058f4-23e3-4f33-be33-1d76b4760628,"Run","LOW_SorcerousSundries_LeftShop");

IF
EntityEvent(_Client,"LOW_SorcerousSundries_LeftShop")
THEN
PROC_DisappearOutOfSightTo((CHARACTER)_Client,S_LOW_EastwayWizard_Point_001_8fcfce1c-a582-4850-a7f6-5fe896e8f35b,"Run",0,"");

IF
DB_LOW_SorcerousSundries_AllCombatantsDead(1)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_Clerk)
AND
DB_LOW_SorcerousSundries_Projections(_Clerk)
THEN
RemoveStatus(_Clerk,"LOW_SORCEROUSSUNDRIES_PROJECTION");

PROC
PROC_SpotPlayers_Spotted(_Clerk,"LOW_SorcerousSundries_BannedSpotting",_Player)
AND
NOT DB_LOW_SorcerousSundries_AllCombatantsDead(1)
THEN
PROC_LOW_SorcerousSundries_ClerkWarnsBannedPlayers(_Clerk,_Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(_Clerk, _Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,1)
AND
DB_LOW_SorcerousSundries_Projections((CHARACTER)_Clerk)
AND
DB_LOW_SorcerousSundries_ClerkCheckpointWarningDialogues(_Dialog,_Clerk)
THEN
DB_SelectedDialog(_Dialog, _Clerk, _Player);	

PROC
PROC_SpotPlayers_Spotted(_Klank,"LOW_SorcerousSundries_KlankBannedSpotting",_Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,1)
AND
QRY_SpeakerIsAvailable(_Klank)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_SorcerousSundries_KlankCheckpoint_275b16c1-85d5-90ea-ccba-0f1441a6b298,_Klank, _Player)
THEN
DB_NOOP(1);

IF
ShapeshiftChanged(_Player,_,_,_)
AND
DB_InRegion(_Player,(TRIGGER)S_LOW_SorcerousCheckpoint_ClerkSpotTrigger_21b5350e-7827-4894-a2d2-0d71849d2a4e)
AND
DB_Sees(_Clerk, _Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,1)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_Clerk)
THEN
PROC_LOW_SorcerousSundries_ClerkWarnsBannedPlayers(_Clerk,_Player);

IF
ShapeshiftChanged(_Player,_,_,_)
AND
DB_InRegion(_Player,(TRIGGER)S_LOW_SorcerousCheckpoint_PrimaryTrigger_1181722d-3b04-4ebc-be3c-9e9059ba451c)
AND
DB_Sees((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, _Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,1)
AND
QRY_SpeakerIsAvailable(S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_SorcerousSundries_KlankCheckpoint_275b16c1-85d5-90ea-ccba-0f1441a6b298,S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7, _Player)
THEN
DB_NOOP(1);

PROC
PROC_LOW_SorcerousSundries_ClerkWarnsBannedPlayers((CHARACTER)_Clerk, (CHARACTER)_Player)
AND
DB_LOW_SorcerousSundries_ClerkCheckpointWarningDialogues((DIALOGRESOURCE)_Dialogue,(CHARACTER)_Clerk)
AND
QRY_SpeakerIsAvailable(_Clerk)
AND
QRY_LOW_SorcerousSundries_ClerkWantsToWarn(_Player)
AND
QRY_StartDialog_Fixed(_Dialogue,_Clerk, _Player)
THEN
DB_NOOP(1);

QRY
QRY_LOW_SorcerousSundries_ClerkWantsToWarn((CHARACTER)_Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,1)
THEN
DB_NOOP(1);

QRY
QRY_LOW_SorcerousSundries_ClerkWantsToWarn((CHARACTER)_Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_State_WaitingToBeWarned_11c39e25-12a2-4c8d-8658-69ca6f4bee1c, _Player,1)
THEN
DB_NOOP(1);


//Ban player if they fight customers or staff
IF
DB_Is_InCombat(_Attacker,_ID)
AND
DB_PartyMembers((CHARACTER)_Attacker)
AND
DB_Is_InCombat(_Victim,_ID)
AND
GetFaction(_Victim,_Faction)
AND
DB_LOW_SorcerousSundries_BannedIFFoughtFactions(_Faction)
AND
QRY_CharacterGetOwnerOrSelf((CHARACTER)_Attacker)
AND
DB_QRYRTN_CharacterGetOwnerOrSelf(_Owner)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_ProdigyHasStayedAtRamazith_524ab56a-8169-4926-9105-8bcaf8c87499)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Owner,0)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Owner);

//END_REGION

//REGION Portal puzzle and basement

IF
DB_LOW_SorcerousSundriesPuzzlePortals(_Portal,_)
THEN
SetCanInteract(_Portal,0);

IF
UseFinished(_Player, (ITEM)S_LOW_SorcerousSundries_BasementLever_8f45c625-cd2e-4de3-8b2b-e3e583209b9d,1)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_ActivateBasementRoute")
THEN
PROC_LOW_SorcerousSundries_ActivateBasementRoute();

IF
UseFinished(_Player, (ITEM)S_SorcSundries_BasementTeleport_002_3d37e42e-52de-4f0b-8f33-19c66df5cb17,1)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_ActivateBasementRoute")
THEN
PROC_LOW_SorcerousSundries_ActivateBasementRoute();

PROC
PROC_LOW_SorcerousSundries_ActivateBasementRoute()
THEN
SetCanInteract((ITEM)S_LOW_SorcerousSundries_BasementLever_8f45c625-cd2e-4de3-8b2b-e3e583209b9d,0);
SetCanInteract(S_SorcSundries_BasementTeleport_001_e3a08981-e43d-4a41-94dc-7af1aa378ece,1);
ApplyStatus(S_SorcSundries_BasementTeleport_001_e3a08981-e43d-4a41-94dc-7af1aa378ece,"PUZ_CASTEDPORTAL_PURPLE",-1.0);
PROC_TryStartAD((DIALOGRESOURCE)GLO_AD_MechanicalClick_fc8d3dc5-b947-6354-3aa9-d1f02fd51af4,S_LOW_SorcerousSundries_BasementLever_8f45c625-cd2e-4de3-8b2b-e3e583209b9d);

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_PuzzleGuardian_5423a690-96fd-9057-4068-0b51ba9c14c0,_)
AND
QRY_OnlyOnce("LOW_OskarsBeloved_RevealPortals")
THEN
PROC_LOW_SorcerousSundries_ActivatePuzzlePortals();

PROC
PROC_LOW_SorcerousSundries_ActivatePuzzlePortals()
AND
DB_LOW_SorcerousSundriesPuzzlePortals(_Portal,_Effect)
AND
HasAppliedStatus(_Portal,_Effect,0)
THEN
ApplyStatus(_Portal, _Effect,-1.0);
SetCanInteract(_Portal,1);

PROC
PROC_LOW_SorcerousSundries_ActivatePuzzlePortals()
AND
DB_LOW_SorcerousSundries_PuzzlePlaques(_Plaque)
AND
HasAppliedStatus(_Plaque,"LIGHT",0)
THEN
ApplyStatus(_Plaque,"LIGHT",-1.0);


PROC
PROC_OneShotTriggerEntered(_Player,(TRIGGER)S_LOW_PuzzleEntranceTrigger_63ded352-7943-43c9-844e-aa1673eb1388)
THEN
PROC_SetOnStage(S_LOW_LorroakanProjection_PuzzleGuardian_c65a2e91-34f1-4dd9-a784-2aca5a4d9cd2,1);
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_LorroakanProjectionPuzzle_05f9abef-2c51-5195-2496-494531b87c9c, S_LOW_LorroakanProjection_PuzzleGuardian_c65a2e91-34f1-4dd9-a784-2aca5a4d9cd2);
DB_SpotPlayers((CHARACTER)S_LOW_LorroakanProjection_PuzzleGuardian_c65a2e91-34f1-4dd9-a784-2aca5a4d9cd2, "LOW_SorcerousSundries_PuzzleGuardian", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(_PuzzleGuardian, "LOW_SorcerousSundries_PuzzleGuardian",_Player)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_SorcerousSundries_PuzzleGuardian_5423a690-96fd-9057-4068-0b51ba9c14c0,_PuzzleGuardian,_Player)
THEN
DB_NOOP(1);

IF
EntityEvent((CHARACTER)_Player,"LOW_PortalTeleported")
THEN
PlayEffect(_Player,VFX_Script_Waypoint_Teleport_In_aaf7e739-11f9-7e5d-c453-fba37e542750,"",1.0);

IF
UseStarted(_Player,_Portal)
AND
DB_Players(_Player)
AND
DB_LOW_SorcerousSundriesPuzzlePortals(_Portal,_)
AND
_Portal != S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5
AND
GetPosition(S_LOW_SorcerousSundriesTeleportTo_769fa8ca-63f8-4364-b903-1f0190588db2,_X,_Y,_Z)
AND
FindValidPosition(_X,_Y,_Z,10.0,_Player,1,_TeleportX,_TeleportY,_TeleportZ)
THEN
DB_LOW_SorcerousSundries_PlayerTeleported(1);
PlayEffect(_Player,(EFFECTRESOURCE)VFX_Status_SorcerousSundries_Projection_BodyFX_01_a2da89fc-c6bd-4006-086a-85b528c452ee,"",0.0);
TeleportToPosition(_Player,_TeleportX,_TeleportY,_TeleportZ,"LOW_SorcerousSundries_TeleportedOutside",0,0,0,0,1);

IF
UseStarted(_Player,_Portal)
AND
NOT DB_LOW_SorcerousSundries_PlayerTeleported(1)
AND
DB_Players(_Player)
AND
DB_LOW_SorcerousSundriesPuzzlePortals(_Portal,_)
AND
_Portal != S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5
AND
GetPosition(S_LOW_SorcerousSundriesTeleportTo_769fa8ca-63f8-4364-b903-1f0190588db2,_X,_Y,_Z)
THEN
DB_LOW_SorcerousSundries_PlayerTeleported(1);
PlayEffect(_Player,(EFFECTRESOURCE)VFX_Status_SorcerousSundries_Projection_BodyFX_01_a2da89fc-c6bd-4006-086a-85b528c452ee,"",0.0);
TeleportToPosition(_Player,_X,_Y,_Z,"LOW_SorcerousSundries_TeleportedOutside",0,0,0,0,1);

IF
EntityEvent(_Player,"LOW_SorcerousSundries_TeleportedOutside")
AND
GetHitpoints(_Player,_HP)
THEN
NOT DB_LOW_SorcerousSundries_PlayerTeleported(1);
PlayEffect(_Player,(EFFECTRESOURCE)VFX_Status_SorcerousSundries_Projection_BodyFX_01_a2da89fc-c6bd-4006-086a-85b528c452ee,"",0.0);
ApplyDamage(_Player,_HP,"Radiant",NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_SorcerousSundries_Punishing(1);
PROC_SetOnStage(_Player,1);//Added for savegame patching in case player was poofed instead of set not visible in previous block
TimerLaunch("LOW_SorcerousSundries_WaitToSpawnPunisher",1000);

//Blaklist player if not blacklisted
IF
UseStarted(_Player,_Portal)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,0)
AND
DB_LOW_SorcerousSundriesPuzzlePortals(_Portal,_)
AND
_Portal != S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5
THEN
SetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player);

IF
UseStarted(_Player,_Portal)
AND
DB_Players(_Player)
AND
DB_LOW_SorcerousSundriesPuzzlePortals(_Portal,_)
AND
_Portal != S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5
AND
NOT DB_LOW_SorcerousSundries_Punishing(1)
THEN
DB_LOW_SorcerousSundries_Punishing(1);

IF
TimerFinished("LOW_SorcerousSundries_WaitToSpawnPunisher")
THEN
TeleportTo(S_LOW_PuzzleGuardianTrigger_Punishment_2fd46708-ee60-4928-a6cc-4b8e38a0b733,S_LOW_LorroakanProjection_PuzzleGuardian_Punisher_ae4c07db-c5c3-4b83-9fb4-23854dda14c5);
PROC_SetOnStage(S_LOW_LorroakanProjection_PuzzleGuardian_Punisher_ae4c07db-c5c3-4b83-9fb4-23854dda14c5,1);
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_GuardianWrongPortal_d4aaa2de-dcfc-14f5-6d26-4bcfdc9d96d7,S_LOW_LorroakanProjection_PuzzleGuardian_Punisher_ae4c07db-c5c3-4b83-9fb4-23854dda14c5);

IF
AutomatedDialogEnded(LOW_SorcerousSundries_AD_GuardianWrongPortal_d4aaa2de-dcfc-14f5-6d26-4bcfdc9d96d7,_)
AND
DB_LOW_SorcerousSundries_Punishing(1)
THEN
NOT DB_LOW_SorcerousSundries_Punishing(1);
RemoveStatus(S_LOW_LorroakanProjection_PuzzleGuardian_Punisher_ae4c07db-c5c3-4b83-9fb4-23854dda14c5,"LOW_SORCEROUSSUNDRIES_PROJECTION");

IF
UseStarted(_Player,_Plaque)
AND
DB_Players(_Player)
AND
DB_LOW_SorcerousSundriesPuzzlePlaques(_Plaque, _AD)
AND
NOT DB_LOW_PlaqueDescriptionBeingPlayed(1)
THEN
DB_LOW_PlaqueDescriptionBeingPlayed(1);
PROC_TryStartAD(_AD,_Player);

IF
AutomatedDialogEnded(_AD,_)
AND
DB_LOW_SorcerousSundriesPuzzlePlaques(_Plaque, _AD)
AND
DB_LOW_PlaqueDescriptionBeingPlayed(1)
THEN
NOT DB_LOW_PlaqueDescriptionBeingPlayed(1);

IF
EntityEvent(_Player,"LOW_SorcerousSundries_PortalTeleportedToRamazith")
AND
QRY_OnlyOnce("LOW_SorcerousSundries_LorroakanIntroduction")
AND
NOT DB_LOW_SorcerousSundries_StartedConfrontation(1)
THEN
ObjectTimerLaunch(_Player,"LOW_SorcerousSundries_WaitPlayersTeleporting",500);

IF
ObjectTimerFinished(_Player,"LOW_SorcerousSundries_WaitPlayersTeleporting")
AND
QRY_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction(_Player)
AND
DB_QRYRTN_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction(_Speaker)
AND
QRY_StartDialog_Fixed(
	LOW_SorcerousSundries_Lorroakan_b206fd7c-7992-6d5f-51f4-0943a92f3d48,
	S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,
	S_LOW_LorroakanButler_637bb24f-66b7-4447-807b-556bd1c00ed6,
	S_LOW_Krank_47a3de7a-049b-462d-b526-60a178a649db,
	_Speaker)
THEN
DB_NOOP(1);


//Speaker priority for introductory Ramazith Tower dialog: Avatar Gale > Avatar player that interacted with portal > Companion Gale > Other players that teleported
QRY
QRY_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction((GUIDSTRING)_Player)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
IsInTrigger(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TRIGGER)S_LOW_EntryRamazithTrigger_b3f97f64-d3d7-4f2b-9df8-87fd3767e532,1)
THEN
DB_QRYRTN_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

QRY
QRY_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction((GUIDSTRING)_Player)
AND
NOT DB_QRYRTN_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction(_)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
IsInTrigger(_Avatar, (TRIGGER)S_LOW_EntryRamazithTrigger_b3f97f64-d3d7-4f2b-9df8-87fd3767e532,1)
THEN
DB_QRYRTN_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction(_Avatar);

QRY
QRY_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction((GUIDSTRING)_Player)
AND
NOT DB_QRYRTN_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction(_)
AND
IsInTrigger(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TRIGGER)S_LOW_EntryRamazithTrigger_b3f97f64-d3d7-4f2b-9df8-87fd3767e532,1)
THEN
DB_QRYRTN_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

QRY
QRY_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction((GUIDSTRING)_Player)
AND
NOT DB_QRYRTN_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction(_)
AND
DB_Players(_OtherPlayer)
AND
_OtherPlayer != _Player
AND
IsInTrigger(_OtherPlayer, (TRIGGER)S_LOW_EntryRamazithTrigger_b3f97f64-d3d7-4f2b-9df8-87fd3767e532,1)
THEN
DB_QRYRTN_LOW_SorcerousSundries_GetSpeakerForLorroakanInteraction(_OtherPlayer);

PROC
PROC_OneShotTriggerEntered(_Player, (TRIGGER)S_LOW_GaleCheckTrigger_41cf8357-fd36-4cd6-b28f-0bd321d27c3f)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_Players(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_RamazithTowerNoGale_1d74c3c5-d3fb-0160-7bde-5d6cfd72098d,(CHARACTER)_Player);

PROC
PROC_StateSet_Defeated(_Barrier)
AND
DB_LOW_SorcerousSundries_Barriers((ITEM)_Barrier,_Object)
THEN
SetCanInteract((ITEM)_Object,1);

//END_REGION

//REGION Aradin death/defeat

PROC
PROC_StateSet_Defeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
THEN
ClearFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92);

IF
DB_LOW_SorcerousSundries_AradinStoppedYelling(1)
AND
NOT DB_Defeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
THEN
NOT DB_LOW_SorcerousSundries_AradinStoppedYelling(1);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_Aradin_ADTrigger_8329c11b-843d-4a16-9fd6-600e59972dce);
PROC_DisappearOutOfSightTo(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, S_LOW_AlarinLeaveTo_88109786-792a-4ac9-b565-6014e50e8ea4, "Run", 0, "LOW_SorcerousSundries_AradinLeft");

PROC
PROC_StateSet_PermaDefeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
THEN
SetFlag((FLAG)LOW_Aradin_State_IsPermaDefeated_f9fb4d8e-dfda-4457-a3de-1716cdb8d343);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_Aradin_ADTrigger_8329c11b-843d-4a16-9fd6-600e59972dce);

//END_REGION

//REGION Nightsong

//Activate camp dialog after Lorroakan dialog and before attack
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Player)
AND
NOT DB_LOW_SorcerousSundries_NightsongCampDialogStarted(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_WaitingForCampNightsongDialog_ce238f16-8215-48f8-90b4-a503a4426efd)
AND
DB_PartOfTheTeam((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
NOT DB_GlobalFlag((FLAG)LOW_Nightsong_Knows_LorroakansPlan_00d4715e-55c1-483e-9d70-9abb2c9c1d81)
THEN
DB_SelectedDialog(
	LOW_SorcerousSundries_NightsongCamp_8a4dce9f-f256-fdfc-7ce4-28ece903328d,
	S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,
_Player);

IF
DialogStarted((DIALOGRESOURCE)LOW_SorcerousSundries_NightsongCamp_8a4dce9f-f256-fdfc-7ce4-28ece903328d,_)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_NightsongCampDialog")
THEN
DB_LOW_SorcerousSundries_NightsongCampDialogStarted(1);


IF
FlagSet((FLAG)LOW_Lorroakan_Quest_WaitingForCampNightsongDialog_ce238f16-8215-48f8-90b4-a503a4426efd,_,_)
THEN
SetHasDialog(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
SetFlag((FLAG)LOW_SorcerousSundries_Knows_AboutLorroakanGoingAfterNightsong_06fc1554-756a-4d3f-8560-5848313210fa);

IF
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_IsobelTalkedAfterNSReturns_89cd0844-d851-4b87-9ed6-6ef2570c5f0b)
THEN
PROC_RemoveDialogEntryForSpeaker(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(DIALOGRESOURCE)LOW_SorcerousSundries_IsobelCamp_f7674ec5-775e-1a91-5faa-cb3e0532aa67);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_Nightsong_Event_GoToRamazithTower_59fab159-060f-424c-9fd9-43cc00a88db9)
AND
NOT DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
DB_ActiveCamp(_Camp)
AND
DB_LOW_SorcerousSundries_NSRunToRamazithLocation(_Camp,_Location)
THEN
PROC_DisappearOutOfSightTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,_Location,"Run",0,"LOW_SorcerousSundries_NSReachedEntryCamp");
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1);
DB_LOW_SorcerousSundries_NightsongMovingToEntryCamp(1);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_Dialogs(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(DIALOGRESOURCE)LOW_SorcerousSundries_IsobelCamp_f7674ec5-775e-1a91-5faa-cb3e0532aa67);
ClearFlag((FLAG)LOW_Aradin_State_AttackingCamp_81f0d1a8-6f8e-4872-ad70-b657ff2c60fd);
SetFlag((FLAG)LOW_SorcerousSundries_Event_CampAttackAverted_f3441499-0574-48b0-bf5c-56615ee2d07e);
QuestUpdate("SHA_Nightsong","NightsongLeft");

IF
DB_LOW_SorcerousSundries_NightsongMovingToEntryCamp(1)
AND
DB_CurrentLevel("BGO_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_NightsongMovingToEntryCamp(1);
DB_LOW_SorcerousSundries_NightsongWillAppearInRamazith(1);


IF
EntityEvent(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"LOW_SorcerousSundries_NSReachedEntryCamp")
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_NightsongMovingToEntryCamp(1);
TimerLaunch("LOW_SorcerousSundries_NightsongFlying",7000);

IF
TimerFinished("LOW_SorcerousSundries_NightsongFlying")
THEN
DB_LOW_SorcerousSundries_NightsongWillAppearInRamazith(1);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_SorcerousSundries_NightsongWillAppearInRamazith(1)
THEN
NOT DB_LOW_SorcerousSundries_NightsongWillAppearInRamazith(1);
PROC_LOW_SorcerousSundries_TeleportNightsongToRamazith();

PROC
PROC_LOW_SorcerousSundries_TeleportNightsongToRamazith()
AND
QRY_OnlyOnce("LOW_SorcerousSundries_TeleportNightsongToConfrontation")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SetRelationToPlayers((FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 100);
ClearFlag((FLAG)LOW_Lorroakan_Quest_WaitingForCampNightsongDialog_ce238f16-8215-48f8-90b4-a503a4426efd);
SetFlag((FLAG)LOW_Nightsong_Quest_HasGoneToConfrontLorroakan_ed98ef99-f229-44d4-b020-62c415dba302, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_RamazithsJump_Start_12ca715e-872c-49be-93e1-65e17eacc8be, "LOW_SorcerousSundries_NightsongReadyToEnterRamazith",0,0,0,1,1);

IF
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
NOT DB_PermaDefeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
AND
DB_GlobalFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92)
THEN
PROC_NotifyWhenReadyToMoveOn(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,"LOW_SorcerousSundries_DisableAradin");

PROC
PROC_ReadyToMoveOn(_Aradin, "LOW_SorcerousSundries_DisableAradin")
THEN
ClearFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92);
SetFlag((FLAG)LOW_Aradin_Event_LeaveSorcerousSundries_9b859898-5d65-4cfb-8b0b-fa3c93f9c752, S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);
PROC_DisappearOutOfSightTo(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c, S_LOW_AlarinLeaveTo_88109786-792a-4ac9-b565-6014e50e8ea4, "Run", 0, "");


//END_REGION

//REGION Camp attack

IF
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_Event_CampAttackAverted_f3441499-0574-48b0-bf5c-56615ee2d07e);

IF
EntityEvent(_Player, "LOW_SorcerousSundries_AradinLeft")
AND
DB_GlobalFlag((FLAG)LOW_Aradin_Knows_BelievesNightsongIsAtCamp_aa7cc65a-3fb6-4bf7-aa65-c14b5c38df70)
AND
GetFlag((FLAG)LOW_Nightsong_Quest_HasGoneToConfrontLorroakan_ed98ef99-f229-44d4-b020-62c415dba302,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0)
THEN
SetFlag((FLAG)LOW_Aradin_State_AttackingCamp_81f0d1a8-6f8e-4872-ad70-b657ff2c60fd);

PROC
PROC_LOW_SorcerousSundries_InitThugs()
AND
DB_LOW_SorcerousSundries_AradinThugPositions(_Thug,_,_)
AND
_Thug != S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c
THEN
DB_GLO_DefeatCounter(_Thug, "LOW_SorcerousSundries_AradinAttackers");
SetOnStage(_Thug, 0);

IF
DialogEnded((DIALOGRESOURCE)CAMP_SCO_AradinAttack_cdc441b1-9530-da70-d479-6c572b0fc5ee, _)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_DEN_Adventurers_d8ebdf1b-1362-460a-f51c-30ecd9b34e6b, 0);
PROC_SetRelationMutual((FACTION)ACT1_DEN_Adventurers_d8ebdf1b-1362-460a-f51c-30ecd9b34e6b, (FACTION)GLO_CampFollowers_4bfd476c-55f7-48e5-b078-e71adfc4624d,0);


PROC
PROC_LOW_SorcerousSundries_SetupAradinAttack()
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_ActiveCamp(_Camp)
AND
DB_LOW_SorcerousSundries_AradinAttackNSPositions(_Trigger,_Camp)
THEN
SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
SetVisible(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Trigger);

IF
DialogEnded((DIALOGRESOURCE)CAMP_SCO_AradinAttack_cdc441b1-9530-da70-d479-6c572b0fc5ee, _ID)
AND
DB_DialogSpeakers(_ID,_Player,_Num)
AND
_Num < 5
AND
DB_ActiveCamp(_Camp)
AND
DB_LOW_SorcerousSundries_AradinAttackPlayerPositions(_Trigger, _Num, _Camp)
THEN
TeleportTo(_Player, _Trigger,"",0,1,1,0,1);

PROC
PROC_CampNight_StartSelected()
AND
DB_Camp_QueuedNight(NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113)
THEN
DB_Camp_PreventEndOfNight(1);
ClearFlag((FLAG)LOW_Lorroakan_Quest_WaitingForCampNightsongDialog_ce238f16-8215-48f8-90b4-a503a4426efd);
SetFlag((FLAG)LOW_SorcerousSundries_State_NightOfAradinAttack_680a27a3-c15c-4e8d-8c39-f9bc781c1feb);
SetFlag((FLAG)LOW_SorcerousSundries_State_AradinAttackActive_c48ecbe3-1e99-44fa-914b-57b4c3528b7c);


PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CAMP_SCO_AradinAttack_cdc441b1-9530-da70-d479-6c572b0fc5ee, _InstanceID)
AND
QRY_SpeakerIsAvailable(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
THEN
PROC_DialogAddSpeakingActor(_InstanceID, S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CAMP_SCO_AradinAttack_cdc441b1-9530-da70-d479-6c572b0fc5ee, _InstanceID)
AND
DB_InCamp((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_ActiveCamp(_Camp)
THEN
SetFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)GLO_CampFollowers_NightsongAlly_9cdafa70-823e-439e-9a46-cb7a4837c3fe);
PROC_DialogAddListeningActor(_InstanceID, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

//Moving all thugs and NS
PROC
PROC_CampNight_StartSleepMoments_PreHook()
AND
DB_Camp_QueuedNight(NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_SetupAradinAttack")
THEN
PROC_LOW_SorcerousSundries_SetupAradinAttack();

PROC
PROC_LOW_SorcerousSundries_SetupAradinAttack()
AND
DB_ActiveCamp(_Camp)
AND
DB_LOW_SorcerousSundries_AradinThugPositions(_Thug, _Location, _Camp)
THEN
TeleportTo(_Thug, _Location);
PROC_SetOnStage(_Thug, 1);


IF
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_CampAttackEnded_d7c61ab3-c0c3-4b78-95c6-0144209f40a4)
AND
NOT DB_GlobalFlag((FLAG)LOW_Nightsong_Event_GoToRamazithTower_59fab159-060f-424c-9fd9-43cc00a88db9)
AND
NOT DB_PermaDefeated (S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_State_AradinAttackActive_c48ecbe3-1e99-44fa-914b-57b4c3528b7c);
PROC_LOW_SorcerousSundries_MovingNightsongToPlayer();

PROC
PROC_LOW_SorcerousSundries_MovingNightsongToPlayer()
AND
QRY_Camp_GetPreferredPlayerForDialogs()
AND
DB_QRYRTN_Camp_GetPreferredPlayerForDialogs(_Player)
THEN
PROC_CharacterMoveTo((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,_Player,"Run","LOW_SorcerousSundries_NightsongPostCampDialog");

IF
EntityEvent(_Nightsong,"LOW_SorcerousSundries_NightsongPostCampDialog")
AND
QRY_Camp_GetPreferredPlayerForDialogs()
AND
DB_QRYRTN_Camp_GetPreferredPlayerForDialogs(_Player)
AND
IsControlled(_Player,0)
THEN
PROC_Camp_ForceAvatarControl();
SetEntityEvent(_Nightsong,"LOW_SorcerousSundries_NightsongPostCampDialog");

IF
EntityEvent(_Nightsong,"LOW_SorcerousSundries_NightsongPostCampDialog")
AND
QRY_Camp_GetPreferredPlayerForDialogs()
AND
DB_QRYRTN_Camp_GetPreferredPlayerForDialogs(_Player)
AND
IsControlled(_Player,1)
AND
QRY_StartDialog_Fixed(
(DIALOGRESOURCE)LOW_SorcerousSundries_NightsongPostAttack_42a7f9de-9883-9a29-20c0-721271188f18,
(CHARACTER)_Nightsong,
_Player)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_NightsongPostAttack_42a7f9de-9883-9a29-20c0-721271188f18,_)
THEN
QuestUpdate("SHA_Nightsong", "AfterAradinAttack");
SetFlag((FLAG)GLO_AdventurersQuest_Knows_AboutBounty_93fcf273-334d-7aa8-d5c1-a4d154f0fe23);

PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_NightOfAradinAttack_680a27a3-c15c-4e8d-8c39-f9bc781c1feb)
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_State_NightOfAradinAttack_680a27a3-c15c-4e8d-8c39-f9bc781c1feb);

IF
DialogEnded(CAMP_SCO_AradinAttack_cdc441b1-9530-da70-d479-6c572b0fc5ee,_)
THEN
PROC_SetRelationMutual((FACTION)ACT1_DEN_Adventurers_d8ebdf1b-1362-460a-f51c-30ecd9b34e6b, (FACTION)GLO_CampFollowers_4bfd476c-55f7-48e5-b078-e71adfc4624d, 0);
PROC_SetRelationMutual((FACTION)ACT1_DEN_Adventurers_d8ebdf1b-1362-460a-f51c-30ecd9b34e6b, (FACTION)GLO_CampFollowers_4bfd476c-55f7-48e5-b078-e71adfc4624d, 0);


//END_REGION

//REGION Isobel
IF
DialogEnded(LOW_SorcerousSundries_Isobel_PostNightsongCaged_56dfe04d-a000-8f46-7784-ab75c4ae592c,_)
THEN
PROC_NotifyWhenReadyToMoveOn(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "LOW_SorcerousSundries_IsobelLeavesCamp");

PROC
PROC_ReadyToMoveOn(_Isobel, "LOW_SorcerousSundries_IsobelLeavesCamp")
AND
DB_ActiveCamp(_Camp)
AND
DB_LOW_SorcerousSundries_NSRunToRamazithLocation(_Camp,_Location)
THEN
PROC_DisappearOutOfSightTo(_Isobel, _Location, "Run", 0, "LOW_SorcerousSundries_IsobelLeavesCamp");

IF
EntityEvent(_Isobel,"LOW_SorcerousSundries_IsobelLeavesCamp")
THEN
DB_LOW_SorcerousSundries_IsobelWentToRescueNightsong(1);
//END_REGION

//REGION Final Confrontation

//REGION Setting up
// Sending Nightsong, Lorroakan and Rolan to their positions
//Nightsong

IF
UseFinished(_Player,(ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,1)
AND
DB_LOW_SorcerousSundries_StartedConfrontation(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationDialogStarted(1)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_RegisterConfrontationPortalEntrance")
THEN
SetFlag((FLAG)LOW_SorcerousSundries_Event_EnteredConfrontationPortal_3eafc29b-4c77-4755-98dc-16bfc3c4c6c9);


//REGION Nightsong jumps from above and runs to center of tower
IF
EntityEvent(_Nightsong, "LOW_SorcerousSundries_NightsongReadyToEnterRamazith")
AND
QRY_OnlyOnce("LOW_SorcerousSundries_NightsongAttack")
THEN
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_RamazithsJump_End_c08a853e-e66b-4b52-87c5-f77a32e6225d,"LOW_SorcerousSundries_NSTeleported",0,0,0,1,1);
PROC_Foop(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c,(TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3,1,1,1,1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_SorcerousSundries_NightsongSmash_ca824374-abdf-7094-9b35-2578466eb7b8,(TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3,1,1,1,1);
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_NightsongCallsLorroakan_83276954-fdb0-6013-e71e-d074315edf1f, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_CharacterMoveTo(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, S_LOW_LorroakanTeleportTo_0063de25-d5c9-4c10-b907-a9abbe246114, "Run", "");
PROC_CharacterMoveTo((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_NightsongLorrokananTeleportTo_5c68bfc2-7e9b-4856-8f69-81f75f65feae, "Run", "");

//Failsafe for extremely rare edgecases - once reached trigger and final confrontation is about to begin - Nightsong needs to be in Rammazith 
IF
DialogStarted(LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c,_)
AND
NOT DB_InRegion(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3)
THEN
PROC_SetOnStage((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_NightsongLorrokananTeleportTo_5c68bfc2-7e9b-4856-8f69-81f75f65feae,"",0,0,0,1,1);


//Rolan
IF
EntityEvent(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "LOW_SorcerousSundries_NSTeleported")
THEN
DB_LOW_SorcerousSundries_ReadyForConfrontation("Nightsong");

IF
EntityEvent(_Nightsong, "LOW_SorcerousSundries_NightsongReadyToEnterRamazith")
AND
QRY_LOW_SorcerousSundries_CheckRolanAvailableForConfrontation()
THEN
SetFaction(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e);
PROC_LOW_SorcerousSundries_ReplaceMainClerk((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);
ClearFlag((FLAG)LOW_Rolan_State_RolanAtTheShop_cd1aa0f6-c061-48e3-8222-ac648a66d3ca, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_Foop(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
NOT DB_GLO_DefeatCounter(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"LOW_SorcerousSundries_ShopCombatant");
TeleportTo(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,S_LOW_RolanLorroakanTeleportTo_13708935-bd6f-4053-98e1-bd07a2aeab78,"LOW_SorcerousSundries_FinalConfronationReached");

QRY
QRY_LOW_SorcerousSundries_CheckRolanAvailableForConfrontation()
AND
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
QRY_SpeakerIsAvailable(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
DB_NOOP(1);

QRY
QRY_CRIME_BlockRegisterCrime(_,_CrimeType, _,(CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _)
AND
QRY_CRIME_IsAssaultOrMurder(_CrimeType)
AND
DB_InRegion((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3)
AND
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationDialogStarted(1)
THEN
DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1);
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
SetFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425);
PROC_LOW_SorcerousSundries_SetNightsongEnemy();


//Edge-case - players become hositle with Nightsong or Lorroakan after start of final confrontation setup but before final confrontation dialog
IF
RelationChanged((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, _)
AND
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationDialogStarted(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1)
THEN
DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1);
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
SetFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b);
PROC_LOW_SorcerousSundries_SetLorroakanEnemy();

IF
RelationChanged((FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, _)
AND
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationDialogStarted(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1)
THEN
DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1);
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
SetFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425);
PROC_LOW_SorcerousSundries_SetNightsongEnemy();

//Edge-case - players kill lorroakan and don't tell Nightsong about it at all
IF
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b);

IF
EntityEvent(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, "LOW_SorcerousSundries_FinalConfronationReached")
THEN
SetFlag((FLAG)LOW_Rolan_State_TeamLorroakan_757b39f2-7a4f-4465-b03c-46225e3bb37b, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
DB_LOW_SorcerousSundries_RolanReachedRamaziths(1);
PROC_SetCustomTradeTreasure(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"Empty");
ClearTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)ACT3_LOW_SORCEROUSSUNDRIES_VENDOR_9f66044c-876d-48cb-94c4-5b8c7a5f5d9e);
ClearTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b);

IF
DB_LOW_SorcerousSundries_ReadyForConfrontation("Nightsong")
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationDialogStarted(1)
AND
NOT DB_LOW_SorcerousSundries_StartedConfrontation(1)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_State_FinalConfrontationOngoing_d2be5d4b-d315-4b28-9c76-78419b48e64f);
DB_LOW_SorcerousSundries_StartedConfrontation(1);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_ConfrontationTrigger_4f84cc91-7e65-4419-8f49-25157cdff76f);


//Edge-Case, somebody speaking to Lorroakan ---------------
IF
DB_LOW_SorcerousSundries_StartedConfrontation(1)
AND
DB_DialogNPCs(_LorroakanDialogueID,S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,_)
AND
SpeakerGetDialog(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,0,(DIALOGRESOURCE) LOW_SorcerousSundries_Lorroakan_b206fd7c-7992-6d5f-51f4-0943a92f3d48,_ID)
AND
DB_DialogSpeakers(_ID,_Player,4)
THEN
DB_LOW_SorcerousSundries_InterruptedLorroakan((CHARACTER)_Player);
PROC_ForceStopDialog((CHARACTER)_Player);

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_Lorroakan_b206fd7c-7992-6d5f-51f4-0943a92f3d48,_ID)
AND
DB_LOW_SorcerousSundries_InterruptedLorroakan(_Player)
THEN
NOT DB_LOW_SorcerousSundries_InterruptedLorroakan(_Player);
PROC_LOW_SorcerousSundries_StartDialogConfrontation(_Player);

PROC
PROC_LOW_SorcerousSundries_StartDialogConfrontation((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationDialogStarted(1)
AND
NOT DB_LOW_SorcerousSundries_RolanReachedRamaziths(1)
AND
QRY_StartDialog(
(DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c,
(CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,
NULL_00000000-0000-0000-0000-000000000000,
(CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,
_Player)
THEN
DB_NOOP(1);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_ConfrontationTrigger_4f84cc91-7e65-4419-8f49-25157cdff76f)
THEN
PROC_LOW_SorcerousSundries_StartDialogConfrontation(_Player);

PROC
PROC_LOW_SorcerousSundries_StartDialogConfrontation((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationDialogStarted(1)
AND
DB_LOW_SorcerousSundries_RolanReachedRamaziths(1)
AND
QRY_StartDialog(
(DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c,
(CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,
(CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,
(CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,
_Player)
THEN
DB_NOOP(1);

IF
DialogStarted(LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c,_)
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_State_FinalConfrontationOngoing_d2be5d4b-d315-4b28-9c76-78419b48e64f);
DB_LOW_SorcerousSundries_FinalConfrontationDialogStarted(1);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_ConfrontationTrigger_4f84cc91-7e65-4419-8f49-25157cdff76f);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c, (INTEGER)_DialogID)
AND
NOT DB_PermaDefeated(S_LOW_Krank_47a3de7a-049b-462d-b526-60a178a649db)
THEN
PROC_DialogAddSpeakingActor(_DialogID, S_LOW_Krank_47a3de7a-049b-462d-b526-60a178a649db);

//END_REGION


//REGION Reactions

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c, _)
THEN
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c, _)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
THEN
PROC_LOW_SorcerousSundries_SetNightsongEnemy();

PROC
PROC_LOW_SorcerousSundries_SetNightsongEnemy()
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, 100);
DB_GLO_DefeatCounter(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"LOW_SorcerousSundries_FinalConfrontationEnemies");
QuestUpdate("SHA_Nightsong","NightsongHostile");

//Set Silver Servants on Stage
PROC
PROC_LOW_SorcerousSundries_SetNightsongEnemy()
THEN
TimerLaunch("LOW_SorcerousSundries_NightsongDevasAppearDelay",1000);
ApplyStatus((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"LOW_RAMAZITHSTOWER_NIGHTSONG_BLESSING",-1.0,1);

IF
TimerFinished("LOW_SorcerousSundries_NightsongDevasAppearDelay")
AND
DB_LOW_SorcerousSundries_Nightsong_Deva(_NightsongReinforcements)
THEN
PROC_Foop(_NightsongReinforcements);

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c, _)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
THEN
PROC_LOW_SorcerousSundries_SetLorroakanEnemy();

PROC
PROC_LOW_SorcerousSundries_SetLorroakanEnemy()
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, 0);
PROC_SetRelationToPlayers((FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 100);
DB_GLO_DefeatCounter(S_LOW_LorroakanFireMyrmidon_4f9f5fc9-45a7-412d-b388-f8e31a2d1c6b,"LOW_SorcerousSundries_FinalConfrontationEnemies");
DB_GLO_DefeatCounter(S_LOW_LorroakanWaterMyrmidon_b9ed09f3-e67e-4498-aa24-5fecec718c07,"LOW_SorcerousSundries_FinalConfrontationEnemies");
DB_GLO_DefeatCounter(S_LOW_LorroakanEarthMyrmidon_fb67df58-9801-4661-bfa7-460c5f02b0bc,"LOW_SorcerousSundries_FinalConfrontationEnemies");
DB_GLO_DefeatCounter(S_LOW_LorroakanAirMyrmidon_fe3ad530-4bc1-436b-bffa-0e3d83a75782,"LOW_SorcerousSundries_FinalConfrontationEnemies");
DB_GLO_DefeatCounter(S_LOW_Krank_47a3de7a-049b-462d-b526-60a178a649db,"LOW_SorcerousSundries_FinalConfrontationEnemies");
DB_GLO_DefeatCounter(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,"LOW_SorcerousSundries_FinalConfrontationEnemies");
QuestUpdate("SHA_Nightsong","LorroakanHostile");

//If started combat with nightsong and lorroakan before dialog, bring Rolan if available
PROC
PROC_LOW_SorcerousSundries_SetLorroakanEnemy()
AND
NOT DB_LOW_SorcerousSundries_RolanReachedRamaziths(1)
AND
NOT DB_PermaDefeated(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
DB_GlobalFlag((FLAG)LOW_Rolan_State_RolanAtTheShop_cd1aa0f6-c061-48e3-8222-ac648a66d3ca)
THEN
PROC_ForceStopDialog(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
ClearFlag((FLAG)LOW_Rolan_State_RolanAtTheShop_cd1aa0f6-c061-48e3-8222-ac648a66d3ca, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
DB_Dialogs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(DIALOGRESOURCE)LOW_SorcerousSundries_RolanConclusion_7c012f1d-28c3-e97c-e127-f871c2e33aa7);
PROC_Poof(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_LOW_SorcerousSundries_ReplaceMainClerk((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);
TeleportTo(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec, "LOW_SorcerousSundries_FinalConfronationReached", 0, 0, 1, 0, 1);
PROC_Foop(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
SetFaction(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e);
NOT DB_GLO_DefeatCounter(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"LOW_SorcerousSundries_ShopCombatant");
DB_GLO_DefeatCounter(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"LOW_SorcerousSundries_FinalConfrontationEnemies");
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e,(FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e, 100);
PROC_SetRelationMutual((FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c, _)
AND
DB_LOW_SorcerousSundries_RolanReachedRamaziths(1)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
AND
GetFlag((FLAG)LOW_Rolan_State_TeamLorroakan_757b39f2-7a4f-4465-b03c-46225e3bb37b, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, 1)
THEN
DB_GLO_DefeatCounter(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"LOW_SorcerousSundries_FinalConfrontationEnemies");

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c, _)
AND
GetFlag((FLAG)LOW_Rolan_State_TeamLorroakan_757b39f2-7a4f-4465-b03c-46225e3bb37b, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, 0)
THEN
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e,(FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e, 0);
PROC_SetRelationMutual((FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 100);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e,100);

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_FinalConfrontation_1262c57a-9370-245b-dd1c-ce7f9b3a360c, _)
AND
GetFlag((FLAG)LOW_Rolan_State_TeamLorroakan_757b39f2-7a4f-4465-b03c-46225e3bb37b, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, 1)
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e,(FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e, 100);

//END_REGION

//END_REGION

//REGION Lorroakan killed before Nightsong goes to Ramazith's

//Edge-case - oneshoted Lorroakan without entering combat, waits a bit for other NPCs to join combat
IF
DB_PermaDefeated(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
AND
NOT DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_)
AND
NOT DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
GetFlag((FLAG)LOW_Rolan_State_RolanAtTheShop_cd1aa0f6-c061-48e3-8222-ac648a66d3ca, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, 1)
THEN
TimerLaunch("LOW_SorcerousSundries_DelayBeforeRolanInvestigates", 3000);

//If no combat happened after oneshot, Rolan teleports
IF
TimerFinished("LOW_SorcerousSundries_DelayBeforeRolanInvestigates")
AND
NOT DB_LorroakanCombatClosePortalID(_)
THEN
PROC_LOW_SorcerousSundries_RolanTryTeleportToRamazith((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

//If more NPCs joined after oneshotting Lorroakan, register the combat as a Lorroakan fight even without him
IF
TimerFinished("LOW_SorcerousSundries_DelayBeforeRolanInvestigates")
AND
DB_LorroakanCombatClosePortalID(_CombatID)
THEN
DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_CombatID);


//If combat starts with lorroakan and nightsong is still not there
IF
DB_Is_InCombat(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,_CombatGUID)
AND
GetFlag((FLAG)LOW_Nightsong_Quest_HasGoneToConfrontLorroakan_ed98ef99-f229-44d4-b020-62c415dba302,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0)
AND
NOT DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_)
THEN
DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_CombatGUID);

IF
SwitchedCombat(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, _OldID, _NewID)
AND
DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_OldID)
THEN
NOT DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_OldID);
DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_NewID);


//Combat ended and Lorroakan is dead - Rolan will teleport
IF
CombatEnded(_CombatID)
AND
DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_CombatID)
AND
DB_Defeated(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
THEN
NOT DB_BlockedWaypointZone((TRIGGER)S_LOW_RamaitzhsTower_RegionTrigger_8d737a4c-9b13-4935-9ce0-34520a2de266);
PROC_LOW_SorcerousSundries_RolanTryTeleportToRamazith((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

IF
DB_PermaDefeated(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
AND
NOT DB_GlobalFlag((FLAG)LOW_Rolan_State_IsDead_47b8a371-e4a9-40e6-bc0f-18ac582142b9)
THEN
SetFlag((FLAG)LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5);

IF
DB_PermaDefeated(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
AND
DB_QuestIsOpened("SHA_Nightsong")
AND
NOT QRY_LOW_SorcerousSundries_CheckPossibleWizardReward()
THEN
QuestUpdate("SHA_Nightsong", "LorroakanDead");

QRY
QRY_LOW_SorcerousSundries_CheckPossibleWizardReward()
AND
QRY_QuestUpdateIsUnlockedForAny("SHA_Nightsong","NightsongHostile")
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662)
THEN
DB_NOOP(1);


//Remove fact from DB when combat ends even if Lorroakan didn't die - covers edge case of player running away (though unlikely due to LD)
IF
CombatEnded(_CombatID)
AND
DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_CombatID)
THEN
NOT DB_LOW_SorcerousSundries_LorroakanCombatBeforeNightsong(_CombatID);

//Edge-case - Rolan knocked out in shop and then player kills lorroakan
PROC
PROC_LongRest()
AND
NOT DB_PermaDefeated(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
DB_LOW_SorcerousSundries_RolanWillTeleportToRamaziths(1)
THEN
NOT DB_LOW_SorcerousSundries_RolanWillTeleportToRamaziths(1);
PROC_LOW_SorcerousSundries_RolanTeleportToRamazith((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

PROC
PROC_LOW_SorcerousSundries_RolanTryTeleportToRamazith((CHARACTER)_Rolan)
AND
NOT DB_LOW_SorcerousSundries_RolanWillTeleportToRamaziths(1)
AND
DB_Defeated(_Rolan)
THEN
DB_LOW_SorcerousSundries_RolanWillTeleportToRamaziths(1);

PROC
PROC_LOW_SorcerousSundries_RolanTryTeleportToRamazith((CHARACTER)_Rolan)
AND
NOT DB_LOW_SorcerousSundries_RolanWillTeleportToRamaziths(1)
AND
NOT QRY_SpeakerIsAvailable(_Rolan)
THEN
PROC_NotifyWhenReadyToMoveOn(_Rolan,"LOW_SorcerousSundries_RolanWillTeleportWhenAvailalble");

PROC
PROC_ReadyToMoveOn_Failed(_Rolan,"LOW_SorcerousSundries_RolanWillTeleportWhenAvailalble")
THEN
DB_LOW_SorcerousSundries_RolanWillTeleportToRamaziths(1);

PROC
PROC_ReadyToMoveOn(_Rolan,"LOW_SorcerousSundries_RolanWillTeleportWhenAvailalble")
THEN
PROC_LOW_SorcerousSundries_RolanTeleportToRamazith((CHARACTER)_Rolan);

PROC
PROC_LOW_SorcerousSundries_RolanTryTeleportToRamazith((CHARACTER)_Rolan)
AND
NOT DB_Defeated(_Rolan)
AND
QRY_SpeakerIsAvailable(_Rolan)
THEN
PROC_LOW_SorcerousSundries_RolanTeleportToRamazith((CHARACTER)_Rolan);

PROC
PROC_LOW_SorcerousSundries_RolanTeleportToRamazith((CHARACTER)_Rolan)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_RolanChecksInOnLorroakan")
THEN
SetFlag((FLAG)LOW_SorcerousSudries_State_RolanWantsToInterrogate_0b3c14e8-628a-42e7-9886-691958d671d1);
ClearFlag((FLAG)LOW_Rolan_State_RolanAtTheShop_cd1aa0f6-c061-48e3-8222-ac648a66d3ca, S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_RemoveAllDialogEntriesForSpeaker(_Rolan);
DB_Dialogs(_Rolan,(DIALOGRESOURCE)LOW_SorcerousSundries_RolanConclusion_7c012f1d-28c3-e97c-e127-f871c2e33aa7);
PROC_Poof(_Rolan);
PROC_LOW_SorcerousSundries_ReplaceMainClerk((CHARACTER)S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);
TeleportTo(_Rolan, S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec, "LOW_SorcerousSundries_RolanTeleportedToRamazith", 0, 0, 1, 0, 1);
PROC_Foop(_Rolan);
SetFaction(_Rolan,(FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e);
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_RolanReactLorroakanDeath_cf7320b0-8c28-e146-4c36-d0a06648fe9e,_Rolan);
NOT DB_GLO_DefeatCounter(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"LOW_SorcerousSundries_ShopCombatant");

IF
EntityEvent(_Rolan, "LOW_SorcerousSundries_RolanTeleportedToRamazith")
THEN
DB_SpotPlayers((CHARACTER)_Rolan, "LOW_SorcerousSundries_RolanSpotsPlayers",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous((CHARACTER)_Rolan, "LOW_SorcerousSundries_RolanSpotsPlayers");
PROC_SetCustomTradeTreasure(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"Empty");
ClearTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)ACT3_LOW_SORCEROUSSUNDRIES_VENDOR_9f66044c-876d-48cb-94c4-5b8c7a5f5d9e);
ClearTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b);

//We block crimes of Rolan seeing Lorroakan's body when running to player to interrogate them
QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, _CrimeType, _, _Char, (INTEGER)_CrimeID)
AND
GetFaction(_Char,(FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSudries_State_RolanWantsToInterrogate_0b3c14e8-628a-42e7-9886-691958d671d1)
AND
GetFlag((FLAG)LOW_Nightsong_Quest_HasGoneToConfrontLorroakan_ed98ef99-f229-44d4-b020-62c415dba302,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0)
THEN
DB_NOOP(1);

PROC
PROC_SpotPlayers_Spotted(_Rolan,"LOW_SorcerousSundries_RolanSpotsPlayers",_Player)
THEN
PurgeOsirisQueue(_Rolan);
PROC_CharacterMoveToAndTalk(_Rolan, _Player, (DIALOGRESOURCE)LOW_SorcerousSundries_RolanConclusion_7c012f1d-28c3-e97c-e127-f871c2e33aa7, "LOW_SorcerousSundries_RolanGoesToInterrogate", "Run", 20.0);

IF
EntityEvent(_Rolan,"LOW_SorcerousSundries_RolanGoesToInterrogate")
THEN
PROC_SpotPlayers_StopSpotting("LOW_SorcerousSundries_RolanSpotsPlayers");

IF
EntityEvent(_Rolan, "LOW_SorcerousSundries_RolanTeleportedToRamazith")
THEN
PurgeOsirisQueue((CHARACTER)_Rolan);
PROC_CharacterMoveTo((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,"Run", "LOW_SorcerousSundries_RolanRunToLorroakan");


//END_REGION

//REGION Combat tracking


IF
RelationChanged((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e,_PlayerFaction,0,0)
AND
FactionGetParentFaction(_PlayerFaction, 1, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360)
THEN
PROC_SetRelationMutual((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e,0);

IF
RelationChanged((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e,Hero_a1542c81-6895-929e-4522-10ce218bb360,0,_)
AND
DB_QuestIsOpened("SHA_Nightsong")
THEN
QuestUpdate("SHA_Nightsong","LorroakanHostile");

IF
RelationChanged((FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e,_PlayerFaction,0,0)
AND
FactionGetParentFaction(_PlayerFaction, 1, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360)
THEN
PROC_SetRelationMutual((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e,0);

//Removing portals when fighting Lorroakan, with or without Nightsong
IF
DB_Is_InCombat(_Character,_CombatGUID)
AND
DB_InRegion((CHARACTER)_Character, (TRIGGER)S_LOW_RamaitzhsTower_RegionTrigger_8d737a4c-9b13-4935-9ce0-34520a2de266)
AND
NOT DB_LorroakanCombatClosePortalID(_CombatGUID)
THEN
DB_LorroakanCombatClosePortalID(_CombatGUID);

IF
DB_LorroakanCombatClosePortalID(_CombatGUID)
AND
HasAppliedStatus((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5, "PUZ_CASTEDPORTAL_BLUE",1)
THEN
RemoveStatus((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5, "PUZ_CASTEDPORTAL_BLUE");
SetCanInteract((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,0);

IF
DB_LorroakanCombatClosePortalID(_CombatGUID)
AND
HasAppliedStatus((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec, "PUZ_CASTEDPORTAL_BLUE",1)
THEN
RemoveStatus((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec, "PUZ_CASTEDPORTAL_BLUE");
SetCanInteract((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec,0);

IF
SwitchedCombat(_Character, _OldID, _NewID)
AND
DB_LorroakanCombatClosePortalID(_OldID)
THEN
NOT DB_LorroakanCombatClosePortalID(_OldID);
DB_LorroakanCombatClosePortalID(_NewID);


//Butler leaves if lorroakan dies and he survives
IF
CombatEnded(_CombatID)
AND
DB_LorroakanCombatClosePortalID(_CombatID)
AND
DB_Defeated(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
AND
NOT DB_PermaDefeated(S_LOW_Miklaur_637bb24f-66b7-4447-807b-556bd1c00ed6)
THEN
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_Miklaur_637bb24f-66b7-4447-807b-556bd1c00ed6, S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,"Run",1,"");

IF
CombatRoundStarted(_CombatID,_)
AND
DB_LorroakanCombatClosePortalID(_CombatID)
AND
NOT QRY_LOW_SorcerousSundries_ConsciousPlayersInRT(_CombatID)
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember,_CombatID)
AND
DB_Defeated(_PartyMember)
THEN
Die(_PartyMember,DEATHTYPE.DoT,1);

QRY
QRY_LOW_SorcerousSundries_ConsciousPlayersInRT((GUIDSTRING)_CombatID)
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember,_CombatID)
AND
DB_InRegion((CHARACTER)_PartyMember, (TRIGGER)S_LOW_RamaitzhsTower_RegionTrigger_8d737a4c-9b13-4935-9ce0-34520a2de266)
AND
NOT DB_Defeated(_PartyMember)
AND
NOT DB_Is_Banished(_PartyMember)
THEN
DB_NOOP(1);

IF
CombatEnded(_CombatID)
AND
DB_LorroakanCombatClosePortalID(_CombatID)
AND
HasAppliedStatus((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec, "PUZ_CASTEDPORTAL_BLUE",0)
THEN
ApplyStatus((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec, "PUZ_CASTEDPORTAL_BLUE",-1.0);
SetCanInteract((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec,1);

IF
CombatEnded(_CombatID)
AND
DB_LorroakanCombatClosePortalID(_CombatID)
AND
HasAppliedStatus((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5, "PUZ_CASTEDPORTAL_BLUE",0)
THEN
ApplyStatus((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5, "PUZ_CASTEDPORTAL_BLUE",-1.0);
SetCanInteract((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,1);

IF
CombatEnded(_CombatID)
AND
DB_LorroakanCombatClosePortalID(_CombatID)
THEN
NOT DB_LorroakanCombatClosePortalID(_CombatID);


//Tracking final combat
IF
DB_Is_InCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,_CombatGUID)
AND
DB_Is_InCombat(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,_CombatGUID)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_StartFinalConfrontationCombat")
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"GLO_NIGHTSONG_RESURRECTION");
DB_LOW_SorcerousSundries_LorroakanNighsongCombatID(_CombatGUID);
DB_LOW_SorcerousSundries_NightsongImpededByLorroakan(1);
DB_KeepDialogsOnDeath((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

IF
SwitchedCombat(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, _OldID, _NewID)
AND
DB_LOW_SorcerousSundries_LorroakanNighsongCombatID(_OldID)
THEN
NOT DB_LOW_SorcerousSundries_LorroakanNighsongCombatID(_OldID);
DB_LOW_SorcerousSundries_LorroakanNighsongCombatID(_NewID);

IF
DB_Defeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
NOT DB_PermaDefeated(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
THEN
PurgeOsirisQueue((CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9);
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, "LOW_SorcerousSundries_ReadyToMoveToNightsongsCorpse");

PROC
PROC_ReadyToMoveOn(_Lorroakan, "LOW_SorcerousSundries_ReadyToMoveToNightsongsCorpse")
AND
IsInTrigger(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3,1)
THEN
PROC_CharacterMoveTo(_Lorroakan, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "Run", "LOW_SorcerousSundries_ReachedNightsongsCorpse");

IF
EntityEvent(_Lorroakan, "LOW_SorcerousSundries_ReachedNightsongsCorpse")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_LorroakanPostConfrontation_2d02afae-1f6e-4884-5025-03d5c83f2a00, _Lorroakan);

//END_REGION

//REGION Nightsong going to WWE Lorroakan

IF
DB_LOW_SorcerousSundries_FinalConfrontationCombatEnded(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
DB_LOW_SorcerousSundries_NightsongImpededByLorroakan(1)
THEN
NOT DB_LOW_SorcerousSundries_NightsongImpededByLorroakan(1);
PROC_LOW_SorcerousSundries_HandleNightsongVictory();

PROC
PROC_LOW_SorcerousSundries_HandleNightsongVictory()
AND
QRY_SorcerousSundries_NightsongCanSmashLorro()
AND
NOT DB_Defeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
PROC_CharacterMoveTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, "Run", "LOW_SorcerousSundries_ReadyToSmashLorroakan");

IF
DB_LOW_SorcerousSundries_FinalConfrontationCombatEnded(1)
AND
DB_Defeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_NightsongGetsUpAfterCombat")
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662);
PROC_CharacterFullRestore((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TimerLaunch("LOW_SorcerousSundries_NightsongRecovering",2000);

IF
TimerFinished("LOW_SorcerousSundries_NightsongRecovering")
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "LOW_SorcerousSundries_SmashAfterRecover");

PROC
PROC_ReadyToMoveOn((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "LOW_SorcerousSundries_SmashAfterRecover")
AND
QRY_SorcerousSundries_NightsongCanSmashLorro()
AND
QRY_OnlyOnce_Reset("LOW_SorcerousSundries_NightsongSmash")
THEN
PROC_CharacterMoveTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, "Run", "LOW_SorcerousSundries_ReadyToSmashLorroakan");

IF
EntityEvent(_Nightsong, "LOW_SorcerousSundries_ReadyToSmashLorroakan")
AND
QRY_LOW_SorcerousSundries_CheckForPlayerSmash()
THEN
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_SorcerousSundries_NightsongSmash_ca824374-abdf-7094-9b35-2578466eb7b8,(TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3,1,1,1,1);
SetFlag((FLAG)LOW_SorcerousSundries_Event_LorroakanSmash_2bd7d7ea-709f-4e9d-974d-917c2911d5cd);

QRY
QRY_LOW_SorcerousSundries_CheckForPlayerSmash()
AND
QRY_OnlyOnce("LOW_SorcerousSundries_NightsongSmash")
AND
DB_Players(_Player)
AND
DB_InRegion(_Player,(TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_SorcerousSundries_NightsongSmash_ca824374-abdf-7094-9b35-2578466eb7b8, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,_Player)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_NightsongSmash_ca824374-abdf-7094-9b35-2578466eb7b8,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsDead_7bc03119-8aaa-458d-b795-fd2e2523d3b8)
THEN
Die(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,DEATHTYPE.Physical,S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0, 1, 1.0);

//Check that Lorroakan and Nightsong are in the first floor to know whether Nightsong can go and fatality him
QRY
QRY_SorcerousSundries_NightsongCanSmashLorro()
AND
DB_Defeated(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
AND
QRY_SorcerousSundries_LorroakanBodySmashable()
AND
IsInTrigger(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, (TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3,1)
AND
IsInTrigger(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3,1)
THEN
DB_NOOP(1);

QRY
QRY_SorcerousSundries_LorroakanBodySmashable()
AND
DB_Defeated(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
AND
NOT DB_Dead(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
THEN
DB_NOOP(1);

QRY
QRY_SorcerousSundries_LorroakanBodySmashable()
AND
IsFreshCorpse(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,1)
THEN
DB_NOOP(1);

QRY
QRY_SorcerousSundries_LorroakanBodySmashable()
AND
GetDeathType((CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,_DeathType)
AND
NOT DB_GLO_HeadRemoval_RestrictedDeathType(_DeathType)
THEN
DB_NOOP(1);


//END_REGION

PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SorcerousSundries_FinalConfrontationEnemies")
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsDead_7bc03119-8aaa-458d-b795-fd2e2523d3b8)
AND
QRY_SpeakerIsAvailable(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_RolanReactToLorroakanDeath")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_RolanWithoutLorroakanAfterCombat_ee2f41e3-455d-63d7-d53a-b07d82cf0be3,S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

IF
DB_LOW_SorcerousSundries_IsobelPermaDefeatedAtCamp(1)
AND
DB_LOW_SorcerousSundries_FinalConfrontationCombatEnded(1)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b);

PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SorcerousSundries_FinalConfrontationEnemies")
AND
DB_LOW_SorcerousSundries_LorroakanNighsongCombatID(_CombatID)
THEN
PROC_LOW_SorcerousSundries_SetupConclusion(_CombatID);

PROC
PROC_LOW_SorcerousSundries_SetupConclusion((GUIDSTRING)_CombatID)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_Conclude")
THEN
SetFlag((FLAG)LOW_SorcerousSundries_Event_CampAttackAverted_f3441499-0574-48b0-bf5c-56615ee2d07e);
ClearFlag((FLAG)LOW_Aradin_State_AttackingCamp_81f0d1a8-6f8e-4872-ad70-b657ff2c60fd);
DB_LOW_SorcerousSundries_FinalConfrontationCombatEnded(1);
NOT DB_LOW_SorcerousSundries_LorroakanNighsongCombatID(_CombatID);
NOT DB_BlockedWaypointZone((TRIGGER)S_LOW_RamaitzhsTower_RegionTrigger_8d737a4c-9b13-4935-9ce0-34520a2de266);
PROC_LOW_SorcerousSundries_AssignConclusionDialogs();
TriggerUnregisterForCharacter((TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TriggerUnregisterForCharacter((TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3, S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9);

//REGION Conclusion

PROC
PROC_LOW_SorcerousSundries_AssignConclusionDialogs()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
DB_Dialogs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(DIALOGRESOURCE)LOW_SorcerousSundries_RolanConclusion_7c012f1d-28c3-e97c-e127-f871c2e33aa7);
PROC_RemoveAllDialogEntriesForSpeaker(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9);
DB_Dialogs(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,(DIALOGRESOURCE)LOW_SorcerousSundries_LorroakanConclusion_b6642d43-ba6f-b22b-9527-3a4a909e048a);

PROC
PROC_LOW_SorcerousSundries_AssignConclusionDialogs()
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_Dialogs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(DIALOGRESOURCE)LOW_SorcerousSundries_NightsongConclusion_8d310f9d-4608-5947-811b-40ef291db5a9);

PROC
PROC_LOW_SorcerousSundries_AssignConclusionDialogs()
AND
DB_Defeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
THEN
DB_DoNotRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
SetFlag((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662);

IF
FlagSet((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662,_,_)
AND
DB_QuestIsOpened("SHA_Nightsong")
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
THEN
PROC_LOW_SorcerousSundries_ChooseNightsongRewardStep();

PROC
PROC_LOW_SorcerousSundries_ChooseNightsongRewardStep()
AND
NOT DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
THEN
QuestUpdate("SHA_Nightsong","NightsongDefeated_LorroakanAlive");

PROC
PROC_LOW_SorcerousSundries_ChooseNightsongRewardStep()
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
NOT DB_GlobalFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640)
THEN
QuestUpdate("SHA_Nightsong","NightsongDefeated_LorroakanDefeated");

PROC
PROC_LOW_SorcerousSundries_ChooseNightsongRewardStep()
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
DB_GlobalFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640)
THEN
QuestUpdate("SHA_Nightsong","NightsongDefeated_WizardsDefeated");



PROC
PROC_LevelBecameUnreachable("CTY_Main_A")
AND
DB_QuestIsOpened("SHA_Nightsong")
AND
QRY_QuestUpdateIsUnlockedForAny("SHA_Nightsong","LorroakanBelievedLies")
THEN
QuestUpdate("SHA_Nightsong","LorroakanLiedTo");

PROC
PROC_LevelBecameUnreachable("CTY_Main_A")
AND
DB_QuestIsOpened("SHA_Nightsong")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("SHA_Nightsong","LorroakanBelievedLies")
AND 
NOT QRY_LOW_SorcerousSundries_CheckNightsongDefeatedInRamaziths()
THEN
PROC_LOW_SorcerousSundries_UpdateNoResolution();

QRY
QRY_LOW_SorcerousSundries_CheckNightsongDefeatedInRamaziths()
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662)
THEN
QuestUpdate("SHA_Nightsong","LeftCityNightsongDefeated_NoReward");

PROC
PROC_LOW_SorcerousSundries_UpdateNoResolution()
AND
DB_GlobalFlag((FLAG)GLO_AdventurersQuest_Knows_AboutBounty_93fcf273-334d-7aa8-d5c1-a4d154f0fe23)
THEN
QuestUpdate("SHA_Nightsong","LeftCityNoResolution_HeardOfBounty");

PROC
PROC_LOW_SorcerousSundries_UpdateNoResolution()
AND
NOT DB_GlobalFlag((FLAG)GLO_AdventurersQuest_Knows_AboutBounty_93fcf273-334d-7aa8-d5c1-a4d154f0fe23)
THEN
QuestUpdate("SHA_Nightsong","LeftCityNoResolution_NotHeardOfBounty");


//REGION Long rest after confrontation

//If SetupConclusion was already done after combat, only handle Long Rest
PROC
PROC_Camp_EnterNightMode()
AND
DB_OnlyOnce("LOW_SorcerousSundries_Conclude")
AND
QRY_OnlyOnce("LOW_SorcerousSundries_HandleDayAfterConfrontation")
THEN
PROC_LOW_SorcerousSundries_LongRestAfterConfrontation();

//If SetupConclusion was not done because combat didn't finish, do conclusion then handle Long Rest
PROC
PROC_Camp_EnterNightMode()
AND
DB_LOW_SorcerousSundries_LorroakanNighsongCombatID(_CombatID)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_HandlingConfrontationNotFinished")
THEN
PROC_LOW_SorcerousSundries_SetupConclusion(_CombatID);
PROC_LOW_SorcerousSundries_LongRestAfterConfrontation();

//Cage Nightsong
PROC
PROC_LOW_SorcerousSundries_LongRestAfterConfrontation()
AND
NOT DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
DB_Defeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
DB_LOW_SorcerousSundries_NightsongCaged(1);
SetFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT3_LOW_SorcerousSundries_CagedNightsong_35fa7174-c563-4226-9c3d-50779c0405b6);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_Dialogs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(DIALOGRESOURCE)LOW_SorcerousSundries_NightsongCaged_ad21d48e-2793-6ac6-eba7-c94f4da2ab29);
SetFlag((FLAG)LOW_SorcerousSundries_State_NightsongCaged_d9739530-c72a-4ad8-96f0-7ec71bbcfd98);
DB_NoLowAttitudeDialog((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_Dialogs((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(DIALOGRESOURCE)LOW_SorcerousSundries_NightsongCaged_ad21d48e-2793-6ac6-eba7-c94f4da2ab29);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_Dialogs((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(DIALOGRESOURCE)LOW_SorcerousSundries_Isobel_PostNightsongCaged_56dfe04d-a000-8f46-7784-ab75c4ae592c);

IF
DB_LOW_SorcerousSundries_NightsongCaged(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
QRY_OnlyOnce("LOW_SorcerousSundries_CTYCagedState")
THEN
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_LorroakanSoulCagePosition_e1e9ccf3-831a-490e-919d-1e9e7c90cfd8);
PROC_SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
PROC_SetOnStage(LOW_SorcerousSundries_LorroakanSoulCage_33fab5d8-f1e3-45ad-8f62-1247f7eadd37,1);
PROC_SetOnStage(LOW_SorcerousSundries_LorroakanSoulCage_Unfinished_26101e55-e8dd-498a-b2b5-d1d26c9b9a99,0);
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0);
PROC_CharacterFullRestore(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
ApplyStatus(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,"LOW_SORRCEROUSSUNDRIES_INVULNERABLE",-1.0,1);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_NIGHTSONG_SOULCAGE",-1.0,1);

//If Isobel died this way it means she died at camp because of player
IF
DB_PermaDefeated((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
NOT DB_LOW_SorcerousSundries_IsobelWentToRescueNightsong(1)
THEN
DB_LOW_SorcerousSundries_IsobelPermaDefeatedAtCamp(1);

//If helped Nightsong she'll be back when Lorroakan is dead
PROC
PROC_Camp_EnterNightMode()
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
NOT DB_LOW_SorcerousSundries_IsobelPermaDefeatedAtCamp(1)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_BringBackNSFromRamazith") 
THEN
PROC_LOW_SorcerousSundries_SetIsobelNSCampPostRamazith();
PROC_LOW_SorcerousSundries_TeleportNightsongToCamp();
SetFlag((FLAG)LOW_SorcerousSundries_State_NSReturnedFromRamazith_b7cbc725-249c-48ba-9146-6cf9292c4c0c);

//In case isobel was killed at camp and NS had gone to ramazith
PROC
PROC_Camp_EnterNightMode()
AND
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
DB_LOW_SorcerousSundries_IsobelPermaDefeatedAtCamp(1)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_BringBackNSFromRamazith") 
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b);
DB_LOW_SorcerousSundries_ReadyNightsongLeaveOffscreen(1);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_SorcerousSundries_ReadyNightsongLeaveOffscreen(1)
THEN
NOT DB_LOW_SorcerousSundries_ReadyNightsongLeaveOffscreen(1);
PROC_SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0);
PROC_SetOnStage(S_LOW_NightsongThreat_d9df0940-238f-4451-a312-d2847ee04f9a,1);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_LOW_SorcerousSundries_AngryNightsongAsylum_a76e7ee2-4d88-4977-977e-0dafb5f9662d);

PROC
PROC_LOW_SorcerousSundries_SetIsobelNSCampPostRamazith()
AND
QRY_LOW_SorcerousSundries_IsobelInCampAndWell()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_Dialogs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(DIALOGRESOURCE)LOW_SorcerousSundries_NightsongAndIsobelCampAfterFight_5c788540-1b65-2b31-8814-450e72458314);

PROC
PROC_LOW_SorcerousSundries_SetIsobelNSCampPostRamazith()
AND
NOT QRY_LOW_SorcerousSundries_IsobelInCampAndWell()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_Dialogs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)CAMP_Nightsong_60070e0f-0ab6-f653-7962-c2fff93b5a2d);

QRY
QRY_LOW_SorcerousSundries_IsobelInCampAndWell()
AND
DB_InCamp((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
DB_NOOP(1);

PROC
PROC_LOW_SorcerousSundries_TeleportNightsongToCamp()
AND
DB_ActiveCamp("ELFSONG")
THEN
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_CAMP_ELFSONG_Nightsong_7ed8c96f-ceb3-4505-9dc9-85ff958afa7c);

PROC
PROC_LOW_SorcerousSundries_TeleportNightsongToCamp()
AND
DB_ActiveCamp("SLUMS")
THEN
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_CAMP_SLUMS_Nightsong_40a64565-aabf-4b4f-b223-04c7bf0e3a40);

PROC
PROC_LOW_SorcerousSundries_TeleportNightsongToCamp()
AND
DB_ActiveCamp("FARM")
THEN
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_CAMP_FARM_Nightsong_e91d0544-ffe7-4daf-9d12-49a554ca9d18);

PROC
PROC_LongRest()
AND
DB_LOW_SorcerousSundries_IsobelWentToRescueNightsong(1)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_IsobelGoesToRamazith")
THEN
NOT DB_LOW_SorcerousSundries_IsobelWentToRescueNightsong(1);
DB_LOW_SorcerousSundries_ReadyToKillIsobelInRamaziths(1);

IF
DB_LOW_SorcerousSundries_ReadyToKillIsobelInRamaziths(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToKillIsobelInRamaziths(1);
TeleportTo(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, LOW_IsobelDeathTriggerPosition_f7133aaf-4b01-440e-90d3-a0f9476be56f, "", 0, 0, 1);
PROC_SetOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,1);
Die(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_CorpseCleanup_Ignore((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
SetFlag((FLAG)LOW_Isobel_State_GotKilledInRamazith_a9139bad-5d46-40ef-824d-fc3a3e09a1ef);


//Isobel will leave if two days pass and players have not talked to her
PROC
PROC_Camp_EnterNightMode()
AND
QRY_LOW_SorcerousSundries_IsobelWaitsForNSNews()
AND
DB_LOW_SorcerousSundries_DaysPostCaging(1)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_SecondDayPostCaging")
THEN
NOT DB_PartOfTheTeam((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
TeleportTo(S_LOW_SorcerousSundries_IsobelThreat_807ee341-d395-43a8-9cbd-8d2eef9026da,S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"",0,0,0,0,1);
PROC_SetOnStage(S_LOW_SorcerousSundries_IsobelThreat_807ee341-d395-43a8-9cbd-8d2eef9026da,1);
PROC_SetOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,0);

PROC
PROC_LongRest()
AND
QRY_LOW_SorcerousSundries_IsobelWaitsForNSNews()
AND
QRY_OnlyOnce("LOW_SorcerousSundries_FirstDayPostCaging")
THEN
DB_LOW_SorcerousSundries_DaysPostCaging(1);

QRY
QRY_LOW_SorcerousSundries_IsobelWaitsForNSNews()
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
DB_PartOfTheTeam((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_NightsongCaged_d9739530-c72a-4ad8-96f0-7ec71bbcfd98)
AND
NOT DB_LOW_SorcerousSundries_PlayerTalkedToIsobelPostCaging(1)
THEN
DB_NOOP(1);

IF
DialogStarted((DIALOGRESOURCE)LOW_SorcerousSundries_Isobel_PostNightsongCaged_56dfe04d-a000-8f46-7784-ab75c4ae592c,_)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_IsobelGetsNewsPostCaging")
THEN
DB_LOW_SorcerousSundries_PlayerTalkedToIsobelPostCaging(1);


//Send Rolan back to shop if he and Lorroakan are alive
PROC
PROC_LongRest()
AND
DB_LOW_SorcerousSundries_NightsongCaged(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
NOT DB_GlobalFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_RolanBackToShop")
THEN
DB_LOW_SorcerousSundries_ReadyForRolanBackToShop(1);

IF
DB_LOW_SorcerousSundries_ReadyForRolanBackToShop(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyForRolanBackToShop(1);
DB_GLO_DefeatCounter(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"LOW_SorcerousSundries_ShopCombatant");
PROC_Poof(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
SetFaction(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(FACTION)ACT3_LOW_SorcerousSundries_Shop_0a2e84ee-30af-49a7-9216-935318f1eae1);
TeleportTo(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, S_LOW_RolanTeleportTo_c76eb1ca-e97e-4b27-ad8d-51e4cc4fd381);
PROC_LOW_SorcerousSundries_ReplaceMainClerk((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
DB_Dialogs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(DIALOGRESOURCE)LOW_SorcerousSundries_Rolan_c6d83bfb-ed34-af42-dbff-506114212e96);
PROC_SetCustomTradeTreasure(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"LOW_SorcerousSundries_Trade");
SetTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)ACT3_LOW_SORCEROUSSUNDRIES_VENDOR_9f66044c-876d-48cb-94c4-5b8c7a5f5d9e);
SetTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b);


//Rolan takeover
PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5)
AND
NOT DB_GlobalFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_RolanTakeover")
THEN
DB_LOW_SorcerousSundries_ReadyForRolanTakeover(1);

IF
DB_LOW_SorcerousSundries_ReadyForRolanTakeover(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyForRolanTakeover(1);
PROC_LOW_SorcerousSundries_RolanTakeover();

//Caging Nightsong but Lorroakan is dead
PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662)
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_FreeNightsong")
THEN
PROC_SetOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,0);
NOT DB_PartOfTheTeam((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_LOW_SorcerousSundries_TeleportIsobelAsylum();
DB_LOW_SorcerousSundries_ReadyForNightsongEscape(1);

PROC
PROC_LOW_SorcerousSundries_TeleportIsobelAsylum()
AND
DB_CurrentLevel("BGO_Main_A")
THEN
TeleportTo(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,S_LOW_SorcerousSundries_BGONightsongAsylum_9f324a58-c158-4c71-8796-4a463547f46d);

PROC
PROC_LOW_SorcerousSundries_TeleportIsobelAsylum(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
TeleportTo(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,S_LOW_SorcerousSundries_AngryNightsongAsylum_a76e7ee2-4d88-4977-977e-0dafb5f9662d);

IF
DB_LOW_SorcerousSundries_ReadyForNightsongEscape(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_LOW_SorcerousSundries_FreeNightsong();

PROC
PROC_LOW_SorcerousSundries_FreeNightsong()
THEN
NOT DB_LOW_SorcerousSundries_ReadyForNightsongEscape(1);
PROC_SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0);
PROC_SetOnStage(LOW_SorcerousSundries_LorroakanSoulCage_33fab5d8-f1e3-45ad-8f62-1247f7eadd37,0);
PROC_SetOnStage(S_LOW_NightsongThreat_d9df0940-238f-4451-a312-d2847ee04f9a,1);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_LOW_SorcerousSundries_AngryNightsongAsylum_a76e7ee2-4d88-4977-977e-0dafb5f9662d);
NOT DB_PartOfTheTeam((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
Die(S_LOW_LorroakanFireMyrmidon_4f9f5fc9-45a7-412d-b388-f8e31a2d1c6b);
Die(S_LOW_LorroakanWaterMyrmidon_b9ed09f3-e67e-4498-aa24-5fecec718c07);
Die(S_LOW_LorroakanEarthMyrmidon_fb67df58-9801-4661-bfa7-460c5f02b0bc);
Die(S_LOW_LorroakanAirMyrmidon_fe3ad530-4bc1-436b-bffa-0e3d83a75782);
Die(S_LOW_Krank_47a3de7a-049b-462d-b526-60a178a649db);
Die(S_LOW_Miklaur_637bb24f-66b7-4447-807b-556bd1c00ed6);

//Caging Nightsong and Rolan is alive but Lorroakan is dead
PROC
PROC_LOW_SorcerousSundries_FreeNightsong()
AND
NOT DB_GlobalFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640)
THEN
DB_LOW_SorcerousSundries_RolanKilledOffstage(1);
Die(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
Die(S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b);
Die(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d);
ToInventory(S_LOW_NightsongThreat_d9df0940-238f-4451-a312-d2847ee04f9a,S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
DB_CorpseCleanup_Ignore(S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b);
DB_CorpseCleanup_Ignore(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
DB_CorpseCleanup_Ignore(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d);
TeleportTo(S_LOW_SorcerousSundries_KilledOffscreenRolanTrigger_cb007c54-43f5-48da-ba62-a762a33affe4,S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_SorcerousSundries_KilledOffscreenRolanTrigger_cb007c54-43f5-48da-ba62-a762a33affe4);

IF
EnteredTrigger(_,(TRIGGER)S_LOW_SorcerousSundries_KilledOffscreenRolanTrigger_cb007c54-43f5-48da-ba62-a762a33affe4)
THEN
PROC_TriggerUnregisterForParty((TRIGGER)S_LOW_SorcerousSundries_KilledOffscreenRolanTrigger_cb007c54-43f5-48da-ba62-a762a33affe4);
QuestUpdate("SHA_Nightsong","NightsongEscapedAfterDefeat_RolanDied");
QuestUpdate("GLO_GatherYourAllies", "RolanNoSupport");

PROC
PROC_LOW_SorcerousSundries_RolanTakeover()
THEN
NOT DB_LOW_SorcerousSundries_CustomerADs((TRIGGER)S_LOW_ClientsDiscussionTrigger_09e59061-fef3-4443-a95c-f20bd38778e6, S_LOW_Client_004_e3fa81d4-53f3-49ad-8497-18673d399a37, S_LOW_Client_005_bf5f19cd-638f-4011-ae3d-45007163c637, (DIALOGRESOURCE)LOW_SorcerousSundries_AD_ClientsDiscussion_076f1b44-cd4f-9dd6-a046-274ad99b18d5,2);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_ClientsDiscussionTrigger_09e59061-fef3-4443-a95c-f20bd38778e6);
SetOnStage(S_LOW_Client_005_bf5f19cd-638f-4011-ae3d-45007163c637,0);
SetFlag((FLAG)LOW_SorcerousSundries_State_ProdigyHasStayedAtRamazith_524ab56a-8169-4926-9105-8bcaf8c87499);
PROC_LOW_SorcerousSundries_CheckSibling((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, S_LOW_CalTeleportTo_7ae1542c-49a8-4ea5-8367-d6bf447ca6be, (DIALOGRESOURCE)LOW_SorcerousSundries_Cal_a7b72e87-7538-6a81-e7f5-3cc0710b133d);
PROC_LOW_SorcerousSundries_CheckSibling((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, S_LOW_LiaTeleportTo_12dd3da1-208a-4e74-a1de-43df549c3bcc, (DIALOGRESOURCE)LOW_SorcerousSundries_Lia_545cfc32-f63a-7e90-5965-008457f14daa);
PROC_LOW_SorcerousSundries_RemovePortals();
ApplyStatus(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, "LOW_ROLAN_MASTER", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
SetLevel(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, 11);

//Remove all bans
PROC
PROC_LOW_SorcerousSundries_RolanTakeover()
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,1)
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_BannedPlayer_2cea88b0-bc13-4537-a70a-d3f122ed9699,_Player,1);


//Removing all dangerous portals
PROC
PROC_LOW_SorcerousSundries_RemovePortals()
AND
DB_LOW_SorcerousSundriesPuzzlePortals(_Portal,_)
AND
_Portal != S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5
THEN
PROC_SetOnStage(_Portal,0);

PROC
PROC_LOW_SorcerousSundries_RemovePortals()
AND
DB_LOW_SorcerousSundriesPuzzlePlaques(_Plaque,_)
THEN
PROC_SetOnStage(_Plaque,0);

PROC
PROC_LOW_SorcerousSundries_RemovePortals()
THEN
RemoveStatus(S_LOW_LorroakanProjection_PuzzleGuardian_c65a2e91-34f1-4dd9-a784-2aca5a4d9cd2,"LOW_SORCEROUSSUNDRIES_PROJECTION");

//Nightsong and Isobel leave camp after saying goodbye
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_SorcerousSundries_Event_NSAndIsobelLeaveCamp_64a6e5df-b6a0-42ab-93b6-818bc4e2859a)
AND
DB_LOW_SorcerousSundris_NSAndIsobel(_Ally)
AND
DB_PartOfTheTeam(_Ally)
THEN
PROC_NotifyWhenReadyToMoveOn(_Ally,"LOW_SorcerousSundries_ReadyToLeaveCamp");

PROC
PROC_ReadyToMoveOn(_Ally, "LOW_SorcerousSundries_ReadyToLeaveCamp")
AND
DB_LOW_SorcerousSundris_NSAndIsobel(_Ally)
AND
DB_ActiveCamp(_Camp)
AND
DB_LOW_SorcerousSundries_NSAndIsobelLeaveCampPos(_Camp,_Pos)
THEN
NOT DB_PartOfTheTeam((CHARACTER)_Ally);
PROC_DisappearOutOfSightTo(_Ally, _Pos, "Walk", 0, "LOW_SorcerousSundries_AllyLeaves");

IF
EntityEvent(_Char,"LOW_SorcerousSundries_AllyLeaves")
THEN
PROC_SetOnStage(_Char,0);

//END_REGION


//REGION Rolan Siblings

PROC
PROC_LOW_SorcerousSundries_CheckSibling((CHARACTER)_Sibling, (GUIDSTRING)_Location, (DIALOGRESOURCE)_Dialog)
AND
NOT DB_PermaDefeated(_Sibling)
THEN
PROC_CharacterFullRestore(_Sibling);
SetTag(_Sibling,BADASSCIVILIAN_91f4b379-63a2-40e9-a509-7b9b2f90e4c8);
SetFaction(_Sibling,(FACTION)ACT3_LOW_SorcerousSundries_RolanInRamazith_396849f7-d04f-4f49-85e1-8e97ef614f3e);
TeleportTo(_Sibling,_Location);
PROC_SetOnStage(_Sibling, 1);
PROC_RemoveAllDialogEntriesForSpeaker(_Sibling);
DB_Dialogs((CHARACTER)_Sibling,_Dialog);


//END_REGION

//END_REGION


//END_REGION

//REGION Cursed Tomes


//REGION Necromancy of Thay follow-up

IF
FlagSet((FLAG)LOW_SorcerousSundries_Event_CursedTomeEffect_Necromancy_f1ff24df-f882-40d0-b8c5-6d0c88178cd3,_Player,_)
THEN
AddSpell((CHARACTER)_Player, "Target_CursedTome_WakeTheDead",1,0);

PROC
PROC_BlockUseOfItem(_Player, (ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507)
AND
DB_Players(_Player)
AND
NOT DB_Is_WildShaped(_Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)FOR_DangerousBook_Tome_696a8379-fa91-d800-7cb6-2f27e04dc100, (ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507, _Player)
THEN
DB_NOOP(1);


//END_REGION

IF
GameBookInterfaceClosed((ITEM)S_LOW_KarsusNotes_0bf067e2-6b9e-4a5e-9c04-e732db3fcc02,_Player)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff)
AND
IsTagged(_Player, (TAG)REALLY_GALE_9b0354c0-56d9-4723-8034-918ac9abab19, 1)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_SorcerousSundries_CursedTomeKarsus_be3af88b-857e-24fe-4da8-3588e27aab75, S_LOW_KarsusNotes_0bf067e2-6b9e-4a5e-9c04-e732db3fcc02, _Player)
THEN
DB_NOOP(1);

IF
GameBookInterfaceClosed(_Tome,_Player)
AND
DB_LOW_SorcerousSundries_TomesWithScroll(_Tome, _QuestUpdate)
AND
QRY_OnlyOnce(_QuestUpdate)
THEN
QuestUpdate("HIDDEN_CTY_Boosters",_QuestUpdate);

IF
GameBookInterfaceClosed(S_UNI_TharchiateCypher_0addb171-6e14-4b4c-8d97-c9af9ba1dcb8,_Player)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_Event_CypherReadBy_236b6a38-319c-448c-aef4-239f1842b622, _Player); // used by LOW_PhilgravesMansion_FatherCarrion
SetFlag((FLAG)LOW_SorcerousSundries_Event_CypherRead_2dd1c3d5-53b1-4884-849d-b0b72d3602b0); // used by quest logic

IF
GameBookInterfaceClosed(S_UNI_TharchiateCypher_0addb171-6e14-4b4c-8d97-c9af9ba1dcb8,_Player)
AND
NOT DB_LOW_SorcerousSundries_BlockedTomes(S_UNI_TharchiateCypher_0addb171-6e14-4b4c-8d97-c9af9ba1dcb8,_)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_ApplyTharchiateCurse")
THEN
ApplyStatus(_Player, "CURSEDTOME_THARCHIATE_CODEX",-1.0);

IF
GameBookInterfaceClosed(S_UNI_TharchiateCypher_0addb171-6e14-4b4c-8d97-c9af9ba1dcb8,_Player)
AND
NOT DB_LOW_SorcerousSundries_BlockedTomes(S_UNI_TharchiateCypher_0addb171-6e14-4b4c-8d97-c9af9ba1dcb8,_)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_ReactionToTomeRead")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_PAD_ReactionToTomeRead_27bb277e-ec90-6757-7c2c-92fa51bb70fe, (CHARACTER)_Player);


IF
GameBookInterfaceClosed(_Tome,_Player)
AND
DB_LOW_SorcerousSundries_TomesWithScroll(_Tome, _)
AND
NOT DB_LOW_SorcerousSundries_BlockedTomes((ITEM)_Tome,_)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_ReactionToTomeRead")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_PAD_ReactionToTomeRead_27bb277e-ec90-6757-7c2c-92fa51bb70fe, (CHARACTER)_Player);

PROC
PROC_BlockUseOfItem(_Player,_Tome)
AND
DB_LOW_SorcerousSundries_BlockedTomes(_Tome,_Case)
THEN
DB_CustomUseItemResponse(_Player, _Tome, 0);
PROC_PlayCantUseItemAD(_Player);

PROC
PROC_BlockPickupOfItem(_Player,_Tome)
AND
DB_LOW_SorcerousSundries_BlockedTomes(_Tome,_Case)
THEN
DB_CustomPickupItemResponse(_Player, _Tome, 0);
PROC_PlayCantUseItemAD(_Player);

PROC
PROC_BlockMoveOfItem(_Player,_Tome)
AND
DB_LOW_SorcerousSundries_BlockedTomes(_Tome,_Case)
THEN
DB_CustomMoveItemResponse(_Player, _Tome, 0);
PROC_PlayCantUseItemAD(_Player);

IF
DB_Defeated(_Case)
AND
DB_LOW_SorcerousSundries_BlockedTomes(_Tome,(ITEM)_Case)
THEN
NOT DB_LOW_SorcerousSundries_BlockedTomes(_Tome,(ITEM)_Case);

IF
Unlocked(_Case,_,_)
AND
DB_LOW_SorcerousSundries_BlockedTomes(_Tome,_Case)
THEN
NOT DB_LOW_SorcerousSundries_BlockedTomes(_Tome,_Case);

//END_REGION

//REGION Gale OM

IF
DB_DialogPlayers(_ID, _, _)
AND
DB_DialogSpeakers(_ID, S_LOW_Tolna_46aa02d8-28e9-4ebb-876c-82fe29262d35, _)
THEN
NOT DB_LOW_KarsusTomeADGaleTriggerSetup(1); //If the players talk to Tolna before having heard of the book, the 'hey a trader' feels out of place.

IF
DB_LOW_KarsusTomeADGaleTriggerSetup(1)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_PartyHadKarsusNotes_9e26ca1b-0ae3-472b-a6a3-385846bc8ff5)
THEN
NOT DB_LOW_KarsusTomeADGaleTriggerSetup(1);
TriggerRegisterForCharacter((TRIGGER)S_LOW_KarsusTomeADGaleTrigger_c85f1787-ce07-490a-8102-bbf6eb2697b7, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
DialogStarted((DIALOGRESOURCE)LOW_SorcerousSundries_Lorroakan_b206fd7c-7992-6d5f-51f4-0943a92f3d48,_)
AND
DB_Is_Polymorphed(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_State_GaleIsDisguisedWithLorro_2dff8222-5064-4ce5-9862-9b5aedd43a90);

IF
DialogStarted((DIALOGRESOURCE)LOW_SorcerousSundries_Lorroakan_b206fd7c-7992-6d5f-51f4-0943a92f3d48,_)
AND
NOT DB_Is_Polymorphed(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_State_GaleIsDisguisedWithLorro_2dff8222-5064-4ce5-9862-9b5aedd43a90);

IF
AddedTo(S_LOW_KarsusNotes_0bf067e2-6b9e-4a5e-9c04-e732db3fcc02, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
THEN
SetFlag((FLAG)ORI_Gale_State_HasKarsusBookInInventory_7061de65-b651-4623-9901-e912d2421658);

IF
RemovedFrom(S_LOW_KarsusNotes_0bf067e2-6b9e-4a5e-9c04-e732db3fcc02, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
ClearFlag((FLAG)ORI_Gale_State_HasKarsusBookInInventory_7061de65-b651-4623-9901-e912d2421658);


//AD when getting to Tolna's desk and Karsus book is in there
IF
EnteredTrigger((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TRIGGER)S_LOW_KarsusTomeADGaleTrigger_c85f1787-ce07-490a-8102-bbf6eb2697b7)
THEN
TriggerUnregisterForCharacter((TRIGGER)S_LOW_KarsusTomeADGaleTrigger_c85f1787-ce07-490a-8102-bbf6eb2697b7, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_AD_GaleSensesKarsusTome_985270c9-136b-0da3-3981-ba6ea519829f, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

QRY
QRY_ORI_Gale_FindAvatarForKarsusNotes((CHARACTER)_Player)
AND
DB_QRYRTN_ORI_Gale_FindAvatarForKarsusNotes(_AnyCharacter)
THEN
NOT DB_QRYRTN_ORI_Gale_FindAvatarForKarsusNotes(_AnyCharacter);


QRY
QRY_ORI_Gale_FindAvatarForKarsusNotes((CHARACTER)_Character)
AND
DB_Avatars(_Avatar)
AND
QRY_SameUser(_Avatar, _Character)
AND
_Avatar != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
NOT DB_QRYRTN_ORI_Gale_FindAvatarForKarsusNotes(_)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Avatar, _Character)
THEN
DB_QRYRTN_ORI_Gale_FindAvatarForKarsusNotes(_Avatar);


//If players get the book by talking to Tolna and Gale is available to talk to player that got it - Gale will start dialog with player
IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_Tolna_6a5d58cc-6d82-4a9e-e8b2-5c4c09c67e14, _ID)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff)
AND
DB_DialogSpeakers(_ID,_Player,2)
AND
GetFlag((FLAG)LOW_SorcerousSundries_Event_HasKarsusBook_c7019855-fcac-4bc5-bacf-9fad0213ab28,_Player,1)
AND
QRY_LOW_SorcerousSundries_StartDialogAfterAcquiredKarsusBook((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_GaleTalkToPlayersAboutBook")
THEN
DB_NOOP(1);

//If players get the book by other means like stealing and are not in dialog
IF
AddedTo(S_LOW_KarsusNotes_0bf067e2-6b9e-4a5e-9c04-e732db3fcc02, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_DialogPlayers(_,_Player,_)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_KarsusADSaid")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_PAD_BoughtKarsusBook_5e520283-5074-e62b-3628-d3950b6facd4,_Player);

//If players get the book by taliking to Tolna and Gale is not available to talk to player that got it - AD to direct to Gale
IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_Tolna_6a5d58cc-6d82-4a9e-e8b2-5c4c09c67e14, _ID)
AND
DB_DialogSpeakers(_ID,_Player,2)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
GetFlag((FLAG)LOW_SorcerousSundries_Event_HasKarsusBook_c7019855-fcac-4bc5-bacf-9fad0213ab28,_Player,1)
AND
NOT QRY_LOW_SorcerousSundries_StartDialogAfterAcquiredKarsusBook((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_KarsusADSaid")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SorcerousSundries_PAD_BoughtKarsusBook_5e520283-5074-e62b-3628-d3950b6facd4,_Player);

QRY
QRY_LOW_SorcerousSundries_StartDialogAfterAcquiredKarsusBook((CHARACTER)_Player)
AND
QRY_ORI_Gale_FindAvatarForKarsusNotes((CHARACTER)_Player)
AND
DB_QRYRTN_ORI_Gale_FindAvatarForKarsusNotes(_Avatar)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
THEN
DB_NOOP(1);

PROC
PROC_DialogFlagSetup((DIALOGRESOURCE)LOW_SorcerousSundries_PAD_MystraVaultEntered_f18ccb6a-393f-d372-075f-765960372335,_Player)
AND
DB_LOW_SorcerousSundries_GaleQuestUpdates(_Update)
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", _Update)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_State_IsLookingForBook_096d1be3-1da7-46c7-934f-5a0691464e34);

//END_REGION

IF
UseFinished(_Player,(ITEM)S_LOW_SorcerousSundries_RamazithKeyCase_6a23597c-06c0-4c2f-ad93-d6fcab7cfc13, _)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_EnableKey")
THEN
SetCanInteract((ITEM)S_LOW_CountingHouse_Vault1_Key_34ae083f-fe59-45f9-9ed0-be94feab3b22,1);

IF
DB_Defeated((ITEM)S_LOW_SorcerousSundries_RamazithKeyCase_6a23597c-06c0-4c2f-ad93-d6fcab7cfc13)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_EnableKey")
THEN
SetCanInteract((ITEM)S_LOW_CountingHouse_Vault1_Key_34ae083f-fe59-45f9-9ed0-be94feab3b22,1);

PROC
PROC_OneShotTriggerEntered(_, S_LOW_SorcerousSundries_NearSorcerousSundries_deb2beec-f1fd-4ca3-b515-9a65011938bd)
THEN
SetFlag(LOW_SorcerousSundries_State_Visited_c1f40149-32b0-402f-b2ae-ffff7eb039b9);

//REGION Allow enemies in the Lorroakan fight to fly between floors
PROC
PROC_BlockUseOfItem(_Char, _Teleporter)
AND
DB_LOW_SorcerousSundries_MistyStepTeleporters(_Teleporter, _TeleportDestination)
THEN
DB_CustomUseItemResponse(_Char, _Teleporter, 0);
SetCanInteract(_Teleporter, 0);
DB_LOW_SorcerousSundries_DisabledTeleporter((ITEM)_Teleporter, (CHARACTER)_Char);
PROC_LOW_SorcerousSundries_MistyStepCharacterToDestination(_Char, _TeleportDestination);

PROC
PROC_BlockUseOfItem(_Char, _Teleporter)
AND
DB_LOW_SorcerousSundries_MistyStepTeleporters(_TeleportDestination, _Teleporter)
THEN
DB_CustomUseItemResponse(_Char, _Teleporter, 0);
SetCanInteract(_Teleporter, 0);
DB_LOW_SorcerousSundries_DisabledTeleporter((ITEM)_Teleporter, (CHARACTER)_Char);
PROC_LOW_SorcerousSundries_MistyStepCharacterToDestination(_Char, _TeleportDestination);

PROC
PROC_LOW_SorcerousSundries_MistyStepCharacterToDestination((CHARACTER)_Char, (ITEM)_TeleportDestination)
AND
NOT DB_LOW_SorcerousSundries_CharacterMistyStepUsed(_Char)
THEN
SetEntityEventReal(_Char,"GLO_CombatWait",0.5);
DB_LOW_SorcerousSundries_CharacterMistyStepQueued((CHARACTER)_Char, (ITEM)_TeleportDestination);
RealtimeObjectTimerLaunch(_Char,"LOW_SorcerousSundries_MistyStep_Timer",500);

IF
ObjectTimerFinished(_Char,"LOW_SorcerousSundries_MistyStep_Timer")
AND
DB_LOW_SorcerousSundries_CharacterMistyStepQueued((CHARACTER)_Char, _TeleportDestination)
AND
GetPosition(_TeleportDestination, _InitX, _InitY, _InitZ)
AND
FindValidPosition(_InitX, _InitY, _InitZ, 3.0, _Char, 0, _ValidX, _ValidY, _ValidZ)
THEN
NOT DB_LOW_SorcerousSundries_CharacterMistyStepQueued((CHARACTER)_Char, (ITEM)_TeleportDestination);
DB_LOW_SorcerousSundries_CharacterMistyStepUsed((CHARACTER)_Char);
UseSpellAtPosition(_Char, "Projectile_LOW_RamazithsTower_Fly", _ValidX, _ValidY, _ValidZ, 1);

//FindValidPosition Fallback
IF
ObjectTimerFinished(_Char,"LOW_SorcerousSundries_MistyStep_Timer")
AND
NOT DB_LOW_SorcerousSundries_CharacterMistyStepUsed((CHARACTER)_Char)
AND
DB_LOW_SorcerousSundries_CharacterMistyStepQueued((CHARACTER)_Char, _TeleportDestination)
AND
GetPosition(_TeleportDestination, _InitX, _InitY, _InitZ)
THEN
NOT DB_LOW_SorcerousSundries_CharacterMistyStepQueued((CHARACTER)_Char, (ITEM)_TeleportDestination);
DB_LOW_SorcerousSundries_CharacterMistyStepUsed((CHARACTER)_Char);
UseSpellAtPosition(_Char, "Projectile_LOW_RamazithsTower_Fly", _InitX, _InitY, _InitZ, 1);

IF
CastSpellFailed(_Char, "Projectile_LOW_RamazithsTower_Fly", _, _, _)
THEN
RealtimeObjectTimerLaunch(_Char, "LOW_SorccerousSundries_MistyStep_FailedToUseDelay", 2000);

IF
ObjectTimerFinished(_Char, "LOW_SorccerousSundries_MistyStep_FailedToUseDelay")
AND
DB_LOW_SorcerousSundries_CharacterMistyStepUsed((CHARACTER)_Char)
THEN
NOT DB_LOW_SorcerousSundries_CharacterMistyStepUsed(_Char);
PROC_LOW_SorcerousSundries_EnabledUsedTeleporter(_Char);

IF
TurnEnded(_Char)
AND
DB_LOW_SorcerousSundries_CharacterMistyStepUsed((CHARACTER)_Char)
THEN
ObjectTimerCancel(_Char, "LOW_SorccerousSundries_MistyStep_FailedToUseDelay");
NOT DB_LOW_SorcerousSundries_CharacterMistyStepUsed(_Char);
PROC_LOW_SorcerousSundries_EnabledUsedTeleporter(_Char);

IF
LeftCombat(_Char, _)
AND
DB_LOW_SorcerousSundries_CharacterMistyStepUsed((CHARACTER)_Char)
THEN
ObjectTimerCancel(_Char, "LOW_SorccerousSundries_MistyStep_FailedToUseDelay");
NOT DB_LOW_SorcerousSundries_CharacterMistyStepUsed(_Char);
PROC_LOW_SorcerousSundries_EnabledUsedTeleporter(_Char);

PROC
PROC_LOW_SorcerousSundries_EnabledUsedTeleporter((CHARACTER)_Char)
AND
DB_LOW_SorcerousSundries_DisabledTeleporter(_Teleporter, _Char)
AND
DB_LOW_SorcerousSundries_DisabledTeleporter(_Teleporter, _AllChars)
THEN
NOT DB_LOW_SorcerousSundries_DisabledTeleporter(_Teleporter, _AllChars);
SetCanInteract(_Teleporter, 1);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
