Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Brain Jar dialogs
DB_OneShot_ADTrigger((TRIGGER)S_LOW_BrainJarDialogArea_c1f26860-d0c6-44fe-820f-c040d52eda9c, (DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_BrainJarCallout_85e4cd21-15af-9b06-e276-01b0eff03f25, S_LOW_SteelWatchFoundry_BrainJar08_000_875f07b0-485a-4b26-b4d0-0a379c53af2c);

DB_Dialogs(S_LOW_SteelWatchFoundry_BrainJar08_000_875f07b0-485a-4b26-b4d0-0a379c53af2c, S_LOW_HiddenSpeaker_Dwarf_BrainJarDialog01_52bcaf18-872d-4807-88a0-5381f0a2331d, (DIALOGRESOURCE)LOW_SteelWatchFoundry_BrainJarInteraction01_8d13dcca-864b-a446-c7b0-bd07b6dcc110);
DB_Dialogs(S_LOW_SteelWatchFoundry_BrainJar10_000_caf93916-6e88-4a3d-a7b0-d621761b052c, S_LOW_HiddenSpeaker_Human_BrainJarDialog02_a9066498-7944-4c60-b98a-39464ad0bd3f, (DIALOGRESOURCE)LOW_SteelWatchFoundry_BrainJarInteraction02_e91382f5-f438-2ef3-cd57-28c93b87af4f);
DB_Dialogs(S_LOW_SteelWatchFoundry_BrainJar07_000_45363091-3cba-4e8a-b31a-bf4f67c0d9d1, (DIALOGRESOURCE)LOW_SteelWatchFoundry_BrainJarInteraction03_59cf18a1-afc3-e2b1-aaaf-18b7c90aa5ab);

DB_ItemDialog_NarratorAD(S_LOW_SteelWatchFoundry_BrainJar06_000_a3119184-908e-4a72-917f-f5cc5c03c16e, LOW_SteelWatchFoundry_AD_BrainJar06_Narrator_91766a93-b404-50d4-4ea3-6cc13f6fd25b);
DB_ItemDialog_NarratorAD(S_LOW_SteelWatchFoundry_BrainJar09_000_d5678ac5-3606-43f5-bee1-8a932924ab84, LOW_SteelWatchFoundry_AD_BrainJar09_Narrator_1a77150f-754f-438f-cf03-35aaf4b88444);
DB_ItemDialog_NarratorAD(S_LOW_SteelWatchFoundry_BrainJar11_000_6f39fd24-6f5b-4ebb-829f-b9f0c356301d, LOW_SteelWatchFoundry_AD_BrainJar11_Narrator_dcc91b3c-dcfa-2720-c1cf-75557bb0971d);

PROC_SetOnStage(S_LOW_HiddenSpeaker_Dwarf_BrainJarDialog01_52bcaf18-872d-4807-88a0-5381f0a2331d, 0);
PROC_SetOnStage(S_LOW_HiddenSpeaker_Human_BrainJarDialog02_a9066498-7944-4c60-b98a-39464ad0bd3f, 0);
DB_DialogBlockTradeButton(LOW_SteelWatchFoundry_BrainJarInteraction01_8d13dcca-864b-a446-c7b0-bd07b6dcc110);
DB_DialogBlockAttackButton(LOW_SteelWatchFoundry_BrainJarInteraction01_8d13dcca-864b-a446-c7b0-bd07b6dcc110);
DB_DialogBlockTradeButton(LOW_SteelWatchFoundry_BrainJarInteraction02_e91382f5-f438-2ef3-cd57-28c93b87af4f);
DB_DialogBlockAttackButton(LOW_SteelWatchFoundry_BrainJarInteraction02_e91382f5-f438-2ef3-cd57-28c93b87af4f);
DB_DialogBlockTradeButton(LOW_SteelWatchFoundry_BrainJarInteraction03_59cf18a1-afc3-e2b1-aaaf-18b7c90aa5ab);
DB_DialogBlockAttackButton(LOW_SteelWatchFoundry_BrainJarInteraction03_59cf18a1-afc3-e2b1-aaaf-18b7c90aa5ab);
//END_REGION

//REGION Triggers
PROC_TriggerRegisterForPlayers(S_LOW_ControlCentre_c8a971a6-b8b2-4706-ada4-dfaf6ec41f1c);
PROC_TriggerRegisterForPlayers(S_LOW_FudnangoTitanDialogArea_b4cb67ac-5196-4c66-99fa-4288bb908b98);
TriggerRegisterForCharacter(S_LOW_TitanRoom_94336e01-c407-48b9-96dd-eb3ace162cf3, S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
DB_AddCharactersInTriggerToDialog(LOW_SteelWatchFoundry_FundangoTitanWarning_ddbc8732-7c9d-a8f6-9295-70d873f727d8, S_LOW_ControlCentre_c8a971a6-b8b2-4706-ada4-dfaf6ec41f1c, 1, 0);
//END_REGION

//REGION Steel Watchers and associated brain jars
DB_CombatReact_AD_OnTurn(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6, (DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_TitanCombatlines_3e4f0b77-a54a-253a-b353-a95b601a5165, 1);
DB_CombatReact_AD_OnTurn(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6, (DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_TitanCombatlines_3e4f0b77-a54a-253a-b353-a95b601a5165, 2);
DB_CombatReact_AD_OnTurn(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6, (DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_TitanCombatlines_3e4f0b77-a54a-253a-b353-a95b601a5165, 3);
DB_CombatReact_AD_OnTurn(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6, (DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_TitanCombatlines_3e4f0b77-a54a-253a-b353-a95b601a5165, 4);

DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar01_7b748b83-1e6e-87a0-3491-861f32f5fe91);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar02_2c5dd55c-0f52-89b3-18ce-e979455ecab2);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar04_7c533796-6f45-848e-192e-74f57dc23412);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar05_56d0e422-dfb7-86ea-2ebf-f35ec7827b99);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar06_1e711426-16af-8a79-3f42-26db683aa595);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar07_24bb806d-b675-843c-4e41-444cb45aa00d);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar08_31ebc3e0-7030-8201-1520-98c05375ec1f);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar09_de44d24d-8b26-87fa-313d-4e2bfde4b170);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar10_67da68bb-2640-8e26-462c-0fa1a6b84151);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar11_85532d8c-fc4e-826c-163c-6a8c7c75031a);
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar12_a72d0f39-2507-844b-1860-d2e62611089b);
DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar16_000_07e8e64b-0a8d-4bfa-858d-b1ec6540001a);
DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar15_000_8fbebae5-8ef9-48e5-a4d2-d626b253182f);
DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar14_000_b6d1883d-2fa8-4d31-88bc-9d4ec591d056);
DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar17_000_63b1552f-7691-4488-97d4-43aae061b335);
DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar13_000_1da9a7e6-7796-49b2-9d1f-2aa4f6a48bad);

DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar16_000_07e8e64b-0a8d-4bfa-858d-b1ec6540001a);
DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar15_000_8fbebae5-8ef9-48e5-a4d2-d626b253182f);
DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar14_000_b6d1883d-2fa8-4d31-88bc-9d4ec591d056);
DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar17_000_63b1552f-7691-4488-97d4-43aae061b335);
DB_LOW_SteelWatchFoundry_ValveBrainJar((ITEM)S_LOW_SteelWatchFoundry_BrainJar13_000_1da9a7e6-7796-49b2-9d1f-2aa4f6a48bad);

SetVisible((CHARACTER)S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6,0);
//END_REGION

//REGION Outcome dialog
PROC_SetOnStage(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53, 0);
PROC_SetOnStage(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172, 0);
PROC_SetOnStage(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c, 0);

DB_GLO_DefeatCounter(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "LOW_SteelWatchFoundry_IronHands");
DB_GLO_DefeatCounter(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172, "LOW_SteelWatchFoundry_IronHands");
DB_GLO_DefeatCounter(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c, "LOW_SteelWatchFoundry_IronHands");

DB_ForceRemoveKnockedOutCharacterOnLongRest(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172);
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c);

//DB_LOW_GondianOutcomeTeleportLocations(_Gondian, _Trigger);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5, S_LOW_GenericGondianEscapeLocation_001_85bf4cb6-2440-4120-afe3-4f33513a0c92);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc, S_LOW_GenericGondianEscapeLocation_002_f4dfa967-c92b-400b-a0d1-af50dc4aa3fd);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker03_b28f2395-a5d4-4a4a-afcd-cddf9949a089, S_LOW_GenericGondianEscapeLocation_003_037a8f42-ff34-4e6d-ba97-74ae9e403fad);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker04_6cc09c40-6b09-4e92-ad36-4e5ad72f7c43, S_LOW_GenericGondianEscapeLocation_004_070b4f89-537e-4dca-91fe-916bfc434416);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker05_e86d2e9b-f55b-4eaf-9ba6-0245d17b6d1c, S_LOW_GenericGondianEscapeLocation_005_35c2e6b5-ba0f-41d8-b430-e3cfa5252ab7);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker06_53a85a70-979b-480a-afb1-ec8d9239e0f8, S_LOW_GenericGondianEscapeLocation_006_fb83283e-f737-4af2-937a-a1fbbd0e7b9f);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, S_LOW_GenericGondianEscapeLocation_008_a68d9288-e77d-4bae-a95b-24cdfc27892a);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker09_2fb2c297-3c00-4b98-8412-41aea0087db5, S_LOW_GenericGondianEscapeLocation_009_695e1d25-53f6-4e13-b46c-57c9b750b824);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker10_ffc8a25f-6ceb-4081-8e07-eca2205989c5, S_LOW_GenericGondianEscapeLocation_010_7fa76d3a-e321-458d-befe-60d8cc93eac1);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53, S_LOW_GenericGondianEscapeLocation_007_5587680e-5a92-446f-aa3c-f2f6b0035b52);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker_PostIRN01_a4eb6135-5656-430f-b5f6-a217feb6eb0d, S_LOW_GenericGondianEscapeLocation_011_bdeb453a-3203-476e-8c05-e08ad8b5d5c7);
DB_LOW_GondianOutcomeTeleportLocations(S_LOW_GondianWorker_PostIRN02_b264c860-f30a-45a8-b35d-9f03a0d393b1, S_LOW_GenericGondianEscapeLocation_012_4fd14207-cf1c-435f-9e67-da731abd7bde);

DB_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83, (DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f);
//END_REGION

//REGION  Gnomes leaving flag
DB_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593, (DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f);
DB_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c, (DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f);

//END_REGION

//REGION Destroying Foundry
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_SteelWatchFoundry_Event_SwitchBoardDestructionInitiated_24fbbf6c-4cad-4f3f-a4f2-2aaf4ca2f0a5, (DIALOGRESOURCE)LOW_SteelWatchFoundry_SwitchBoard_ec6c58fa-404d-b053-9e10-7cae2ae0f3a3);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_SteelWatchFoundry_Event_SwitchBoardDestructionInitiated_24fbbf6c-4cad-4f3f-a4f2-2aaf4ca2f0a5, (DIALOGRESOURCE)LOW_SteelWatchFoundry_GondianWorker08_Leader_AfterIRN_419df89c-ab1e-a95c-25c6-77651b70386f);
DB_HasItemTemplateScriptFlag(1, (DIALOGRESOURCE)LOW_SteelWatchFoundry_SwitchBoard_ec6c58fa-404d-b053-9e10-7cae2ae0f3a3, LOOT_GEN_Runepowder_Time_Bomb_A_9a711e91-04d0-4300-8ca8-b4cc07529a56, 2);

//Level templates to unload when foundry destroyed
DB_LOW_SteelWatchFoundry_IntactFoundry((LEVELTEMPLATE)PLT_SteelWatchFoundry_Roof_intact_A_000_712e5ab2-ee23-4c10-ae41-3465dc6054ac);
DB_LOW_SteelWatchFoundry_IntactFoundry((LEVELTEMPLATE)PLT_SteelWatchFoundry_Facade_Intact_A_000_80e84128-4987-476a-ae5d-dba011c6b43f);

//Level templates to load with foundry destroyed
DB_LOW_SteelWatchFoundry_DestroyedFoundry((LEVELTEMPLATE)PLT_SteelWatchFoundry_Facade_Broken_A_000_450cae1b-3e5e-47ec-a4b2-c5d6aa816b10);
DB_LOW_SteelWatchFoundry_DestroyedFoundry((LEVELTEMPLATE)PLT_SteelWatchFoundry_Roof_Broken_A_000_2b324e06-fe26-48bb-a079-184ff81ef07e);
//END_REGION

//REGION Watcher Titan Boss fight defeat counter
DB_GLO_DefeatCounter(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6, "LOW_SteelWatchFoundry_WatcherBossFight");
DB_GLO_DefeatCounter(S_LOW_SteelWatcher022_aca59fad-db3a-4d25-bfee-edbabff9da6a, "LOW_SteelWatchFoundry_WatcherBossFight");
DB_GLO_DefeatCounter(S_LOW_SteelWatcher023_a0594019-b0ed-46f8-a813-8be9379f0e8e, "LOW_SteelWatchFoundry_WatcherBossFight");
DB_GLO_DefeatCounter(S_LOW_SteelWatcherRanged_1c01c751-7ede-403e-a510-98cccc524e79, "LOW_SteelWatchFoundry_WatcherBossFight");

//DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_SteelWatchFoundry_WatcherBossFight", (FLAG)LOW_SteelWatchFoundry_State_ControlCentreWatchersDefeated_c4eb7726-fdb8-4e53-84a3-9ec1e955d154);
//END_REGION

//REGION Automaton head
DB_ItemDialog_NarratorAD(S_LOW_AutomatonComponent_Clickable_59ec4b0f-8dde-4739-ace5-c6286bd7743d, LOW_SteelWatchFoundry_AD_AutomatonHead_448f8e66-8e6f-e5d9-2d93-d8fb23ffec32);
//END_REGION

//REGION Gossip flags
//Foundry standing
SetFlag(LOW_SteelWatchFoundry_State_Standing_c80223ed-a1f0-46b3-b867-231df8442207);
//END_REGION
KBSECTION
//REGION Debug commands
IF
TextEvent("LOW_GiveBomb")
THEN
PROC_LOW_SteelWatchFoundry_GiveBomb();

IF
FlagSet((FLAG)Debug_LOW_SteelWatchFoundry_GiveBomb_0b2de5e9-b7a4-47a3-a68e-159357daf1c8, _,_)
THEN
PROC_LOW_SteelWatchFoundry_GiveBomb();


PROC
PROC_LOW_SteelWatchFoundry_GiveBomb()
AND
GetHostCharacter(_Player)
THEN
PROC_ToInventoryAndOnStage(S_LOW_SteelWatchFoundry_Bomb_Placeholder_a02e5ea2-5843-432b-b55f-4a87e6378fef, _Player);

IF
TextEvent("LOW_KillswitchKill")
THEN
PROC_LOW_SteelWatchFoundry_KillSwitchKill();

IF
TextEvent("LOW_FoundryLevelSwap")
THEN
PROC_LOW_SteelWatchFoundry_LoadDestroyedFoundry();

IF
TextEvent("LOW_FoundryUndoLevelSwap")
THEN
PROC_LOW_SteelWatchFoundry_UnLoadDestroyedFoundry();

IF
TextEvent("LOW_DestroyFoundry")
THEN
SetFlag((FLAG)Debug_LOW_SteelWatchFoundry_State_FoundryDestroyed_63d841b2-d380-4912-b927-3284a8e3c8c1);

IF
FlagSet((FLAG)Debug_LOW_SteelWatchFoundry_State_FoundryDestroyed_63d841b2-d380-4912-b927-3284a8e3c8c1,_,_)
THEN
PROC_LOW_SteelWatchFoundry_DeactivateAllSwitches();
PROC_LOW_SteelWatchFoundry_KillAllBaneites();
PROC_LOW_SteelWatchFoundry_KillAllGondians();
PROC_LOW_SteelWatchFoundry_DestroyIronThrone();
PROC_LOW_SteelWatchFoundry_LoadDestroyedFoundry();
SetFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a);
SetFlag((FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b);

IF
TextEvent("LOW_PlayFoundryDestroyCinematic")
THEN
PROC_LOW_SteelWatchFoundry_StartExplodeCinematic();
//END_REGION

//REGION Foundry triggers
IF
DB_LOW_SteelWatchFoundry_RoomTriggers(_Trigger)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)_Trigger);
//END_REGION

//REGION Fundango Titan warning
IF
DB_InRegion(_Player, S_LOW_FudnangoTitanDialogArea_b4cb67ac-5196-4c66-99fa-4288bb908b98)
AND
DB_Players(_Player)
AND
NOT DB_Defeated(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6)
AND
IsPartyFollower((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, 1)
AND
NOT QRY_StartDialog_Fixed(LOW_SteelWatchFoundry_FundangoTitanWarning_ddbc8732-7c9d-a8f6-9295-70d873f727d8, S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, _Player)
THEN
SetFlag(LOW_SteelWatchFoundry_State_FundangoWaitingInBrainRoom_4db9b98c-8867-4cc3-8371-47dc227ab044);
ClearFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b);

IF
DialogEnded(LOW_SteelWatchFoundry_FundangoTitanWarning_ddbc8732-7c9d-a8f6-9295-70d873f727d8, _)
THEN
SetFlag(LOW_SteelWatchFoundry_State_FundangoWaitingInBrainRoom_4db9b98c-8867-4cc3-8371-47dc227ab044);
ClearFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b);

//If Toobin enters the Room as a follower, before the watchers are dead, make him wait outside instead
IF
EnteredTrigger(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, S_LOW_TitanRoom_94336e01-c407-48b9-96dd-eb3ace162cf3)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_ControlCentreWatchersDefeated_c4eb7726-fdb8-4e53-84a3-9ec1e955d154)
AND
IsPartyFollower((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, 1)
AND
NOT DB_LOW_SteelWatchFoundry_WaitToobinLeaveTitanRoom(1) //This DB indicates that Toobin was already in the room when patched. This avoids nasty problems.
AND
DB_LOW_SteelWatchFoundry_FundangoFollowerOf(_Player)
AND
NOT QRY_StartDialog_Fixed(LOW_SteelWatchFoundry_FundangoTitanWarning_ddbc8732-7c9d-a8f6-9295-70d873f727d8, S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, _Player)
THEN
SetFlag(LOW_SteelWatchFoundry_State_FundangoWaitingInBrainRoom_4db9b98c-8867-4cc3-8371-47dc227ab044);
ClearFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b);

//If the player enters the region with Fundango as a follower but the player has already defeated the Titan without him present - immediately leave party and go to his place by the switchboard
IF
DB_InRegion(_Player, S_LOW_ControlCentre_c8a971a6-b8b2-4706-ada4-dfaf6ec41f1c)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_ControlCentreWatchersDefeated_c4eb7726-fdb8-4e53-84a3-9ec1e955d154)
AND
QRY_IsPartyFollower((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
THEN
SetFlag(LOW_SteelWatchFoundry_State_FundangoBySwitchBoard_d4ba6a0d-8233-4fdc-999b-8c75d598a375);
PROC_RemoveDialog(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
DB_Dialogs(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, (DIALOGRESOURCE)LOW_SteelWatchFoundry_GondianWorker08_Leader_AfterIRN_419df89c-ab1e-a95c-25c6-77651b70386f);
PROC_CharacterMoveTo((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, S_LOW_FundangoSwitchboardPos_28247708-93f9-43eb-8f5c-a2fcc2071b25, "Walk", "LOW_SteelWatchFoundry_ToobinMovedToSwitchBoard");
PROC_RemovePartyFollower((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);

//END_REGION

//REGION Titan Elevator
/*
IF
TurnStarted(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6)
*/

IF
EnteredCombat(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6, _)
AND
QRY_OnlyOnce("LOW_SteelWatchFoundry_TitanElevatorStarted")
AND
GetPosition(S_LOW_TitanElevatorUpPos_f5a44bce-1f1b-47b4-8cec-ebdd2e7a434f, _X, _Y, _Z)
THEN
//SetEntityEventReal(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6, "GLO_CombatWait", 5.0);
SetVisible((CHARACTER)S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6,1);
PROC_CameraShakeAroundObject(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6, 3000, 25.0);
PlatformMoveTo(LT_PLT_CTY_SteelTitanElevator_A_000_af79d731-9ed4-46ed-98d2-6e3c9a176750, _X, _Y, _Z, 1.3, "LOW_SteelWatchFoundry_TitanElevatorArrived", 0);

//END_REGION

//REGION Brain Jar ADs
IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_BrainJarCallout_85e4cd21-15af-9b06-e276-01b0eff03f25, _)
THEN
TimerLaunch("LOW_SteelWatchFoundry_BrainADTime01", 1000);

IF
TimerFinished("LOW_SteelWatchFoundry_BrainADTime01")
THEN
DB_OneShot_ADTrigger((TRIGGER)S_LOW_BrainJarDialogArea02_db421182-d647-402b-928e-d2314a829a21, (DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_BrainJarCallout02_6d994f4a-c7a5-882b-ac05-b188033123d7, S_LOW_SteelWatchFoundry_BrainJar10_000_caf93916-6e88-4a3d-a7b0-d621761b052c);

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_BrainJarCallout02_6d994f4a-c7a5-882b-ac05-b188033123d7, _)
THEN
TimerLaunch("LOW_SteelWatchFoundry_BrainADTime02", 1000);

IF
TimerFinished("LOW_SteelWatchFoundry_BrainADTime02")
THEN
DB_OneShot_ADTrigger(S_LOW_BrainjarDialogArea03_6d1de1bd-81d5-452d-8009-533edaf1c36d, (DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_BrainJarCallout03_7282abfc-713d-9f1b-0e80-c7f282fd57b2, S_LOW_SteelWatchFoundry_BrainJar07_000_45363091-3cba-4e8a-b31a-bf4f67c0d9d1);
//END_REGION

//REGION Brain jars
//If you use the pressure valve, it destroys the brainjars
IF
UseFinished(_Player, S_LOW_BrainPressureValve_c2d69b74-e9c7-49ef-a644-f981e89b2adc, _)
AND
DB_LOW_SteelWatchFoundry_ValveBrainJar(_Jar)
THEN
Die(_Jar, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
SetDisableUse(S_LOW_BrainPressureValve_c2d69b74-e9c7-49ef-a644-f981e89b2adc, 1);

//Brain jars are extremely flammable
IF
AttackedBy(_BrainJar, _, _, "Fire", _, _, _)
AND
DB_LOW_SteelWatchFoundry_BrainJar((ITEM)_BrainJar)
THEN
CreateExplosion(_BrainJar,"Projectile_Fireball",-1);
DebugText(_BrainJar, "I GO BOOM");
//END_REGION

//REGION Fundango after bossfight
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_WatcherBossFight")
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
IsPartyFollower((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, 1)
THEN
ClearFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b);
SetFlag(LOW_SteelWatchFoundry_State_FundangoBySwitchBoard_d4ba6a0d-8233-4fdc-999b-8c75d598a375);
PROC_RemoveDialog(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
DB_Dialogs(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, (DIALOGRESOURCE)LOW_SteelWatchFoundry_GondianWorker08_Leader_AfterIRN_419df89c-ab1e-a95c-25c6-77651b70386f);
//PROC_CharacterMoveTo((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, S_LOW_FundangoSwitchboardPos_28247708-93f9-43eb-8f5c-a2fcc2071b25, "Walk", "LOW_SteelWatchFoundry_ToobinMovedToSwitchBoard");

PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_WatcherBossFight")
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
NOT IsPartyFollower((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, 1)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_FundangoWaitingInBrainRoom_4db9b98c-8867-4cc3-8371-47dc227ab044)
THEN
ClearFlag(LOW_SteelWatchFoundry_State_FundangoWaitingInBrainRoom_4db9b98c-8867-4cc3-8371-47dc227ab044);
SetFlag(LOW_SteelWatchFoundry_State_FundangoBySwitchBoard_d4ba6a0d-8233-4fdc-999b-8c75d598a375);
PROC_RemoveDialog(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
DB_Dialogs(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, (DIALOGRESOURCE)LOW_SteelWatchFoundry_GondianWorker08_Leader_AfterIRN_419df89c-ab1e-a95c-25c6-77651b70386f);
PROC_CharacterMoveTo((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, S_LOW_FundangoSwitchboardPos_28247708-93f9-43eb-8f5c-a2fcc2071b25, "Walk", "LOW_SteelWatchFoundry_ToobinMovedToSwitchBoard");

//In case Toobin is dead
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_WatcherBossFight")
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
DB_PermaDefeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
THEN
SetFlag(LOW_SteelWatchFoundry_State_TitanDefeatedWithToobinDead_2fac6404-0e6b-48a5-b7cb-2500840aa4f6);

//In case Toobin is not present but alive
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_WatcherBossFight")
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
NOT IsPartyFollower((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, 1)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_FundangoWaitingInBrainRoom_4db9b98c-8867-4cc3-8371-47dc227ab044)
AND
NOT DB_PermaDefeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_ToobinWaitingToBeFollower_aba323fc-5ade-ebfc-a4e2-38947e78191c)
THEN
SetFlag(LOW_SteelWatchFoundry_State_TitanDefeatedWithoutToobinPresent_b0c70e67-f759-4e42-8568-93bc695e7437);

PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_WatcherBossFight")
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
THEN
SetFlag(LOW_SteelWatchFoundry_State_ControlCentreWatchersDefeated_c4eb7726-fdb8-4e53-84a3-9ec1e955d154);
//END_REGION

//REGION Destroying Foundry
IF
UseStarted(_Player, S_LOW_NeuralSwitchboard_b8d9d7e5-dd97-4946-83e3-66ae22cd7a81)
AND
NOT DB_Is_InCombat(_Player, _)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_SteelWatchFoundry_SwitchBoard_ec6c58fa-404d-b053-9e10-7cae2ae0f3a3, S_LOW_NeuralSwitchboard_b8d9d7e5-dd97-4946-83e3-66ae22cd7a81, _Player)
THEN
DB_NOOP(1);

IF
UseStarted(_Player, S_LOW_NeuralSwitchboard_b8d9d7e5-dd97-4946-83e3-66ae22cd7a81)
AND
DB_Is_InCombat(_Player, _)
THEN
PROC_PlayCantUseItemAD(_Player);

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_Event_SwitchBoardDestructionInitiated_24fbbf6c-4cad-4f3f-a4f2-2aaf4ca2f0a5)
AND
DB_Players(_Player)
AND
GetFlag(LOW_SteelWatchFoundry_State_ExplosionInitiatedBy_03fdd686-63c7-4823-b49e-ed3e3edf4956, _Player, 1)
THEN
PROC_LOW_SteelWatchFoundry_StartExplodeCinematicOnPlayer(_Player);

IF
FlagSet(LOW_SteelWatchFoundry_Event_PlaceBomb_232b5c85-7f53-4c3f-8904-ac3217a1c4c6, _, _)
AND
DB_Players(_Player)
AND
GetItemByTemplateInInventory(LOOT_GEN_Runepowder_Time_Bomb_A_9a711e91-04d0-4300-8ca8-b4cc07529a56, _Player, _Bomb)
THEN
ToInventory(_Bomb, LOW_SteelWatchFoundry_AsylumChest_34e06174-ee14-40fe-9367-d63303ae86ee, 1, 1, 1);

PROC
PROC_LOW_SteelWatchFoundry_StartExplodeCinematicOnPlayer((CHARACTER)_)
THEN
SetFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9);
PROC_LOW_SteelWatchFoundry_RemoveGondianDialogs();

PROC
PROC_LOW_SteelWatchFoundry_StartExplodeCinematic()
AND
DB_Players(_Player)
AND
DB_LOW_SteelWatchFoundry_RoomTriggers(_FoundryRoom)
AND
DB_InRegion(_Player, (TRIGGER)_FoundryRoom)
AND
QRY_OnlyOnce("LOW_SteelWatchFoudnry_StartedExplosionCinematicNonSpecific")
THEN
PROC_LOW_SteelWatchFoundry_StartExplodeCinematicOnPlayer(_Player);

PROC
PROC_LOW_SteelWatchFoundry_StartExplodeCinematicOnPlayer((CHARACTER)_Player)
AND
NOT DB_OnlyOnce("LOW_SteelWatchFoudnry_StartedExplosionCinematic")
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _Player, 0, 0, 0, 0)
THEN
DB_OnlyOnce("LOW_SteelWatchFoudnry_StartedExplosionCinematic");

//Add all other players as listening actors into the cinematic
IF
DialogStarted(LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _Inst)
AND
DB_Players(_Player)
AND
NOT DB_DialogPlayers(_, _Player, _)
AND
DB_InRegion(_Player, S_LOW_ControlCentre_c8a971a6-b8b2-4706-ada4-dfaf6ec41f1c)
THEN
PROC_DialogAddListeningActor(_Inst, _Player);

IF
DialogStarted(LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _Inst)
AND
DB_Players(_Player)
AND
NOT DB_DialogPlayers(_, _Player, _)
AND
NOT DB_InRegion(_Player, S_LOW_ControlCentre_c8a971a6-b8b2-4706-ada4-dfaf6ec41f1c)
THEN
SetTag(_Player, (TAG)ACT3_LOW_STEELWATCHFOUNDRY_CINEHIDE_9f00b763-df79-49fb-9915-9fd7aa1117cc);
DB_LOW_SteelWatchFoundry_InvisibleForEscape(_Player);
PROC_DialogAddListeningActor(_Inst, _Player);

//If they are in other dialogs wait for that dialog to finish and then join as listening actor
IF
DialogStarted(LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _Inst)
AND
DB_Players(_Player)
AND
DB_DialogPlayers(_Otherinst, _Player, _)
AND
_OtherInst != _Inst
THEN
DB_LOW_SteelWatchFoundry_JoinDestructDialogAfter(_OtherInst, _Player);

IF
DialogEnded(_, _OtherInst)
AND
DB_LOW_SteelWatchFoundry_JoinDestructDialogAfter(_OtherInst, _Player)
AND
DB_DialogName(LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _Inst)
THEN
SetTag(_Player, (TAG)ACT3_LOW_STEELWATCHFOUNDRY_CINEHIDE_9f00b763-df79-49fb-9915-9fd7aa1117cc);
DB_LOW_SteelWatchFoundry_InvisibleForEscape(_Player);
PROC_DialogAddListeningActor(_Inst, _Player);

IF
DialogEnded(LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _)
AND
DB_LOW_SteelWatchFoundry_InvisibleForEscape(_Player)
THEN
ClearTag(_Player, (TAG)ACT3_LOW_STEELWATCHFOUNDRY_CINEHIDE_9f00b763-df79-49fb-9915-9fd7aa1117cc);

PROC
PROC_LOW_SteelWatchFoundry_RemoveGondianDialogs()
AND
DB_LOW_Gondians(_Gondian)
THEN
PROC_RemoveDialog(_Gondian);

PROC
PROC_LOW_SteelWatchFoundry_KillAllGondians()
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_Event_FundangoSignalsGondians_321b9521-b937-4cd9-8e49-ad02e5dc9bea)
AND
DB_LOW_Gondians(_Gondian)
AND
_Gondian != S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d
THEN
Die(_Gondian, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

PROC
PROC_LOW_SteelWatchFoundry_KillAllBaneites()
AND
DB_LOW_Baneites(_Baneite)
AND
IsOnStage(_Baneite, 1)
THEN
Die(_Baneite, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

IF
DialogStarted((DIALOGRESOURCE)LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _)
THEN
PROC_LOW_SteelWatchFoundry_DeactivateAllSwitches();
PROC_LOW_SteelWatchFoundry_KillAllBaneites();
PROC_LOW_SteelWatchFoundry_KillAllGondians();

IF
DialogStarted((DIALOGRESOURCE)LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
THEN
PROC_LOW_SteelWatchFoundry_DestroyIronThrone();


IF
DialogEnded((DIALOGRESOURCE)LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _)
THEN
PROC_LOW_SteelWatchFoundry_LoadDestroyedFoundry();
PROC_LOW_SteelWatchFoundry_DetermineWulbrenInvolvement();
PROC_LOW_SteelWatchFoundry_TeleportOutcomeParticipants();
PROC_LOW_SteelWatchFoundry_StartOutcomeDialog();
SetFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a);
SetFlag((FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b);
ClearFlag(LOW_SteelWatchFoundry_State_FundangoBySwitchBoard_d4ba6a0d-8233-4fdc-999b-8c75d598a375);

//Unloading intact version of Foundry
PROC
PROC_LOW_SteelWatchFoundry_LoadDestroyedFoundry()
THEN
Close(S_LOW_FoundryFrontDoor_98556121-7aba-4b50-9336-e183b9906650);
Close(DOOR_Double_Big_Dungeon_Abbey_A_Foundry_A_000_99b0dfc2-8ea6-4d26-802a-43d872ddde7e);
Close(S_LOW_CargoDoor_3e11bdba-dd79-442d-9c6d-ce2059cb1307);
PROC_LOW_SteelWatchFoundry_SmallCargoElevator_MoveDown();

PROC
PROC_LOW_SteelWatchFoundry_LoadDestroyedFoundry()
AND
DB_LOW_SteelWatchFoundry_IntactFoundry(_LevelTemplate)
THEN
UnloadLevelTemplate(_LevelTemplate);

//Loading in broken version of the Foundry
PROC
PROC_LOW_SteelWatchFoundry_LoadDestroyedFoundry()
AND
DB_LOW_SteelWatchFoundry_DestroyedFoundry(_LevelTemplate)
THEN
LoadLevelTemplate(_LevelTemplate);



//Unloading intact version of Foundry
PROC
PROC_LOW_SteelWatchFoundry_UnLoadDestroyedFoundry()
AND
DB_LOW_SteelWatchFoundry_IntactFoundry(_LevelTemplate)
THEN
LoadLevelTemplate(_LevelTemplate);

//Loading in broken version of the Foundry
PROC
PROC_LOW_SteelWatchFoundry_UnLoadDestroyedFoundry()
AND
DB_LOW_SteelWatchFoundry_DestroyedFoundry(_LevelTemplate)
THEN
UnloadLevelTemplate(_LevelTemplate);

//Crowd removal
IF
DialogStarted(LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _Inst)
THEN
TriggerSetCrowdSpawningEnable(S_LOW_SteelWatchFoundry_CrowdDespawn_56378791-e047-4f39-81c3-4f20e142aedc, 0);
TriggerDespawnCrowd(S_LOW_SteelWatchFoundry_CrowdDespawn_56378791-e047-4f39-81c3-4f20e142aedc);

//Determine Wulbren involvement for the upcoming outcome dialog. We can use this to know if Wulbren was already dead when the dialog started, or was killed during.
PROC
PROC_LOW_SteelWatchFoundry_DetermineWulbrenInvolvement()
AND
NOT DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_GlobalFlag(WYR_Ironhand_InAct3_Wulbren_3097cdd8-33eb-4ca0-956b-b2826bb01f8a)
THEN
DB_LOW_SteelWatchFoundry_WulbrenAliveBeforeOutcomeDialog(1);

PROC
PROC_LOW_SteelWatchFoundry_StartOutcomeDialog()
AND
QRY_LOW_SteelWatchFoundry_PickPlayersForOutcomeDialog()
AND
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player)
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren)
AND
DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango)
AND
DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus)
AND
DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra)
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f, _Wulbren, _Fundango, _Barcus, _Extra, _Player, 0, 0, 0, 0)
THEN
NOT DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player);
NOT DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren);
NOT DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango);
NOT DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus);
NOT DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra);

//Allocating the player who will be the active speaker in the outcome dialog - prioritising host avatar first, other avatars second, companions third
QRY
QRY_LOW_SteelWatchFoundry_PickPlayersForOutcomeDialog()
AND
GetHostCharacter(_Player)
AND
DB_LOW_SteelWatchFoundry_OutcomeDialogPlayerParticipants(_Player)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player);

QRY
QRY_LOW_SteelWatchFoundry_PickPlayersForOutcomeDialog()
AND
DB_Avatars(_Player)
AND
DB_LOW_SteelWatchFoundry_OutcomeDialogPlayerParticipants(_Player)
AND
NOT DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player);

QRY
QRY_LOW_SteelWatchFoundry_PickPlayersForOutcomeDialog()
AND
DB_Players(_Player)
AND
DB_LOW_SteelWatchFoundry_OutcomeDialogPlayerParticipants(_Player)
AND
NOT DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player);

//Teleport surviving Gondians
PROC
PROC_LOW_SteelWatchFoundry_TeleportOutcomeParticipants()
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_Event_FundangoSignalsGondians_321b9521-b937-4cd9-8e49-ad02e5dc9bea)
AND
DB_LOW_Gondians(_Gondian)
AND
NOT DB_Defeated(_Gondian)
AND
DB_LOW_GondianOutcomeTeleportLocations(_Gondian, _Trigger)
THEN
TeleportTo(_Gondian, (TRIGGER)_Trigger, "", 0, 0, 0, 1, 1);

//Teleporting only the players that are in the foundry to the location of the outcome dialog
PROC
PROC_LOW_SteelWatchFoundry_TeleportOutcomeParticipants()
AND
DB_Players(_Player)
AND
DB_LOW_SteelWatchFoundry_RoomTriggers(_Region)
AND
IsInTrigger(_Player, (TRIGGER)_Region, 1)
AND
NOT DB_LOW_SteelWatchFoundry_OutcomeDialogPlayerParticipants(_Player)
THEN
TeleportTo(_Player, S_LOW_SteelWatchOutcomeLocation_Player_a50b838f-b8f2-4b15-813b-fc77198e76cd, "", 0, 1, 1, 1, 1);
DB_LOW_SteelWatchFoundry_OutcomeDialogPlayerParticipants(_Player);

//Teleporting Wulbren
PROC
PROC_LOW_SteelWatchFoundry_TeleportOutcomeParticipants()
AND
NOT DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_GlobalFlag((FLAG)WYR_Ironhand_InAct3_Wulbren_3097cdd8-33eb-4ca0-956b-b2826bb01f8a)
THEN
TeleportTo(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (TRIGGER)S_LOW_SteelWatchOutcomeLocation_Wulbren_672c319c-ecc6-4797-8447-16eeca161146, "", 0, 0, 0, 1, 1);
PROC_SetOnStage(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172, 1);
PROC_SetOnStage(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c, 1);
SetFaction(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (FACTION)ACT3_LOW_SteelWatchFoundry_Ironhands_64aaa374-aa33-4866-8780-6e1472f215d8);

//Teleporting Fundango and his substitute
PROC
PROC_LOW_SteelWatchFoundry_TeleportOutcomeParticipants()
AND
NOT DB_Defeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
THEN
TeleportTo(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, LOW_SteelWatchOutcomeLocation_Zanner_3cf37e67-0bb8-4f7f-85c3-32dcfc47bb6b, "", 0, 0, 0, 1, 1);

PROC
PROC_LOW_SteelWatchFoundry_TeleportOutcomeParticipants()
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5)
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_Event_FundangoSignalsGondians_321b9521-b937-4cd9-8e49-ad02e5dc9bea)
AND
DB_Defeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
THEN
PROC_SetOnStage(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53, 1);
TeleportTo(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53, LOW_SteelWatchOutcomeLocation_Zanner_3cf37e67-0bb8-4f7f-85c3-32dcfc47bb6b, "", 0, 0, 0, 1, 1);

//Teleporting Barcus (Barcus only participates if Wulbren is alive at the start)
PROC
PROC_LOW_SteelWatchFoundry_TeleportOutcomeParticipants()
AND
NOT DB_Defeated(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
AND
DB_LOW_SteelWatchFoundry_WulbrenAliveBeforeOutcomeDialog(1)
AND
DB_GlobalFlag(WYR_Ironhand_InAct3_UnfortunateGnome_ac1b779a-401d-4119-bebd-3efb70a697ee)
THEN
TeleportTo(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, S_LOW_SteelWatchOutcomeLocation_Barcus_926a584a-d1e7-4f14-bdb6-edf897357896, "", 0, 0, 0, 1, 1);

//Getting Wulbren
QRY
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
NOT DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_GlobalFlag(WYR_Ironhand_InAct3_Wulbren_3097cdd8-33eb-4ca0-956b-b2826bb01f8a)
THEN
DB_LOW_SteelWatchFoundy_OutcomeWulbren(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);

QRY
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
NOT DB_LOW_SteelWatchFoundy_OutcomeWulbren(_)
THEN
DB_LOW_SteelWatchFoundy_OutcomeWulbren(NULL_00000000-0000-0000-0000-000000000000);

//Getting Fundango
QRY
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
NOT DB_Defeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
THEN
DB_LOW_SteelWatchFoundry_OutcomeFundango(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);

//Getting Fundango's substitute
QRY
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Status_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5)
AND
DB_Defeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
NOT DB_Defeated(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53) // Mostly for the sake of GUS-318884 fix
THEN
DB_LOW_SteelWatchFoundry_OutcomeExtra(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53);
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53);

//Getting Barcus (Barcus is not involved if Wulbren was dead when the Outcome theatre starts)
QRY
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
NOT DB_Defeated(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
AND
DB_LOW_SteelWatchFoundry_WulbrenAliveBeforeOutcomeDialog(1)
AND
DB_GlobalFlag((FLAG)WYR_Ironhand_InAct3_UnfortunateGnome_ac1b779a-401d-4119-bebd-3efb70a697ee)
THEN
DB_LOW_SteelWatchFoundry_OutcomeBarcus(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);

//Filling in NULLs for empty roles
QRY
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
NOT DB_LOW_SteelWatchFoundry_OutcomeExtra(_)
THEN
DB_LOW_SteelWatchFoundry_OutcomeExtra(NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
NOT DB_LOW_SteelWatchFoundry_OutcomeFundango(_)
THEN
DB_LOW_SteelWatchFoundry_OutcomeFundango(NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
NOT DB_LOW_SteelWatchFoundry_OutcomeBarcus(_)
THEN
DB_LOW_SteelWatchFoundry_OutcomeBarcus(NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_StartDialogFailed(LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f,_,_,_,_,_,_)
AND
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player)
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren)
AND
DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango)
AND
DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus)
AND
DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra)
THEN
DB_Dialogs(_Wulbren, _Fundango, _Barcus, _Extra, (DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f);
NOT DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player);
NOT DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren);
NOT DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango);
NOT DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus);
NOT DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra);

//Add ironhand bodyguards to dialog
PROC
PROC_StartDialog_AddExtraSpeakers(LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f, _ID)
AND
IsOnStage(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172, 1)
THEN
PROC_DialogAddSpeakingActor(_ID, S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172);
PROC_DialogAddSpeakingActor(_ID, S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c);


//Add other players as listeners to outcome dialog
IF
DialogStarted(LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f, _ID)
AND
DB_LOW_SteelWatchFoundry_OutcomeDialogPlayerParticipants(_Player)
AND
NOT DB_DialogPlayers(_ID, _Player, _)
AND
NOT DB_Defeated(_Player)
THEN
PROC_DialogAddListeningActor(_ID, _Player);

//Add all other surviving gondians to the dialog
PROC
PROC_StartDialog_AddExtraSpeakers(LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f, _ID)
AND
DB_LOW_Gondians(_Gondian)
AND
IsOnStage(_Gondian, 1)
AND
NOT DB_Defeated(_Gondian)
THEN
PROC_DialogAddSpeakingActor(_ID, _Gondian);

//When the outcomedialog is concluded, all the rank-and-file gnomes leave
PROC
PROC_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_Event_WulbrenCombat_b4d7b17e-3c19-3140-b91a-3eb0574e9f7d)
THEN
PROC_LOW_SteelWatchFoundry_GondiansWalkOff();

PROC
PROC_LOW_SteelWatchFoundry_GondiansWalkOff()
AND
DB_LOW_Gondians(_Gondian)
AND
NOT DB_Defeated(_Gondian)
AND
_Gondian != S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d
THEN
PROC_DisappearOutOfSight((CHARACTER)_Gondian, "Walk", 0, "");

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_Event_WulbrenCombat_b4d7b17e-3c19-3140-b91a-3eb0574e9f7d)
AND
NOT DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
PROC_LOW_SteelWatchFoundry_IronHandsWalkOff();

PROC
PROC_LOW_SteelWatchFoundry_IronHandsWalkOff()
THEN
PROC_DisappearOutOfSight(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172, "Walk", 0, "");
PROC_DisappearOutOfSight(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c, "Walk", 0, "");

PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_IronHands")
THEN
PROC_LOW_SteelWatchFoundry_GondiansWalkOff();

PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_Gondians")
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83)
THEN
PROC_LOW_SteelWatchFoundry_IronHandsWalkOff();

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83)
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_SteelWatchFoundry_Gondians_98cec50e-60d9-4b18-a1f3-88e8b425d682, (FACTION)ACT3_LOW_SteelWatchFoundry_Ironhands_64aaa374-aa33-4866-8780-6e1472f215d8, 0);

PROC
PROC_LOW_SteelWatchFoundry_GondiansWalkOff()
AND
NOT DB_Defeated((CHARACTER)S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53)
THEN
PROC_DisappearOutOfSight(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53, "Walk", 0, "");

//Barcus stays behind
//When Gondians win in the fight
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_IronHands")
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpBarcus();

PROC
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpBarcus()
THEN
DB_LOW_SteelWatchFoundry_DisappearAfterLongRest(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
PROC_RemoveDialog(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
DB_Dialogs(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, (DIALOGRESOURCE)LOW_SteelWatchFoundry_Barcus_AfterOutcome_7ff42227-fa4d-9b93-84a3-3157b5c9b419);

//When Ironhands win in the fight
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_Gondians")
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpBarcus();

PROC
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpWulbrenHappy()
THEN
DB_LOW_SteelWatchFoundry_DisappearAfterLongRest((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
PROC_RemoveDialog(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
DB_Dialogs(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (DIALOGRESOURCE)LOW_SteelWatchFoundry_WulbrenThanks_23985c4f-1b42-5820-f757-e56ea3957746);

//When Everyone walks away
PROC
PROC_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593)
AND
NOT DB_Defeated(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpBarcus();

//Toobin stays behind
//When Gondians win in the fight
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_IronHands")
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
AND
NOT DB_Defeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpToobin();

PROC
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpToobin()
THEN
DB_LOW_SteelWatchFoundry_DisappearAfterLongRest(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
PROC_RemoveDialog(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
DB_Dialogs(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, (DIALOGRESOURCE)LOW_SteelWatchFoundry_ToobinThanks_cfea4275-9cc9-5e01-b35d-26f7af287731);

//When everyone just walks away
PROC
PROC_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593)
AND
NOT DB_Defeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpToobin();

//Wulbren stays behind
//If Wulbren is not dead, and not forced to leave he stays behind to confirm Ironhand support for the player
PROC
PROC_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593)
AND
NOT DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpWulbrenHappy();

//When the Ironhands win in the fight
PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_Gondians")
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83)
AND
NOT DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpWulbrenHappy();

//Wulbren leaving only if he was forced to
PROC
PROC_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c)
AND
NOT DB_Defeated((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
PROC_LOW_SteelWatchFoundry_WulbrenLeaves();

PROC
PROC_LOW_SteelWatchFoundry_WulbrenLeaves()
THEN
PROC_DisappearOutOfSight(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "Walk", 0, "S_LOW_SteelWatchFoundry_WulbrenWalkedAway");
PROC_PeacefulResolve((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
PROC_PeacefulResolve((CHARACTER)S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172);
PROC_PeacefulResolve((CHARACTER)S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c);

IF
EntityEvent(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "S_LOW_SteelWatchFoundry_WulbrenWalkedAway")
THEN
SetFaction(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, (FACTION)ACT3_WYR_IronhandGnomes_9e36c2d3-a13f-4d4e-bc5b-8ac237f84159);

//Setting off stage the gnomes that stayed behind after a long rest
PROC
PROC_LongRest_InLevel("CTY_Main_A")
AND
DB_LOW_SteelWatchFoundry_DisappearAfterLongRest(_ImportantGnomes)
THEN
PROC_SetOnStage(_ImportantGnomes, 0);
NOT DB_LOW_SteelWatchFoundry_DisappearAfterLongRest(_ImportantGnomes);

//Checking if all Gondians survived (For background goal)
IF
DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c)
AND
NOT DB_LOW_SteelWatchFoundry_AnyGondiansDied(1)
THEN
SetFlag(LOW_SteelWatchFoundry_State_Outcome_AllGondiansSaved_422247be-9c7a-4a0b-bf9e-070e62c72d1f);

PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_SteelWatchFoundry_IronHands")
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
AND
NOT DB_LOW_SteelWatchFoundry_AnyGondiansDied(1)
THEN
SetFlag(LOW_SteelWatchFoundry_State_Outcome_AllGondiansSaved_422247be-9c7a-4a0b-bf9e-070e62c72d1f);
//END_REGION

//REGION Toobin Dead Fallback
//If you've read both Toobin's formula book, and Gond's lore book you automatically know that the self-destruct code is Nebelun (Gond's gnomish name)
IF
UseFinished(_Player, S_LOW_ToobinFormulas_22ed4668-af60-48c9-bbf9-61d6c23ea5a0, _)
AND
QRY_OnlyOnce("LOW_SteelWatchFoundry_ReadToobinBook")
THEN
StartVoiceBark((VOICEBARKRESOURCE)LOW_SteelWatchFoundry_VB_ReadZannerBook_0b48f350-494a-91b6-a752-c4f8b9b7648a, _Player);
DB_LOW_SteelWatchFoundry_ReadZannersBook(1);
SetFlag(LOW_SteelWatchFoundry_State_ReadToobinBook_a116650f-3212-4781-a9f3-10b3e0f66c45);


IF
UseFinished(_Player, S_LOW_GondLoreBook_e3cbc4d4-80cc-49a1-bd9e-f0044d268e55, _)
AND
QRY_OnlyOnce("LOW_SteelWatchFoundry_ReadGondBook")
THEN
StartVoiceBark((VOICEBARKRESOURCE)LOW_SteelWatchFoundry_VB_ReadGondBook_5eaef77d-c939-cf97-cf8f-afdefb76f495, _Player);
DB_LOW_SteelWatchFoundry_ReadGondBook(1);
SetFlag(LOW_SteelWatchFoundry_State_ReadGondLoreBook_af3422fc-5ea9-4ee0-af17-6bd9c71ed0fd);

IF
DB_LOW_SteelWatchFoundry_ReadZannersBook(1)
AND
DB_LOW_SteelWatchFoundry_ReadGondBook(1)
THEN
DB_LOW_SteelWatchFoundry_ReadBothBooks(1);

IF
DB_LOW_SteelWatchFoundry_ReadBothBooks(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_KnownsHowToDisableNeurocitor_0df02f4a-0d44-f355-4638-9aee2ea61fde)
THEN
SetFlag(LOW_SteelWatchFoundry_State_KnownsHowToDisableNeurocitor_0df02f4a-0d44-f355-4638-9aee2ea61fde);
//END_REGION

//REGION Outcome dialog interrupted fallbacks
//Only Autoresolve if the final flags of the dialog aren't already set
IF
DialogForceStopping((DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f, _)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_GainedGondianENDSupport_1bb09a8b-001d-4b43-9f39-ba89eb3aece9)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_SidedWithGondians_60345f15-6632-482e-ac4f-8a1b77d7fc36)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Event_WulbrenCombat_b4d7b17e-3c19-3140-b91a-3eb0574e9f7d)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_SidedWithWulbren_044a290e-2835-44a8-ac0e-0a59da02a316)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_GainedIronhandENDSupport_a090a831-c695-4478-8d0d-84661deabb98)
AND
NOT DB_GlobalFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98)
THEN
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve();

//If the dialog is interrupted get outcome participants again to use for Auto-resolution
PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
THEN
DB_NOOP(1);

//If the gondians are all dead, and Wulbren is present -> Wulbren stays, Barcus stays, Ironhands leave || IRONHAND SUPPORT
PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5)
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
SetFlag(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593);
PROC_LOW_SteelWatchFoundry_IronHandsWalkOff();
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpWulbrenHappy();
SetFlag(LOW_SteelWatchFoundry_State_SidedWithWulbren_044a290e-2835-44a8-ac0e-0a59da02a316);
SetFlag(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593);
SetFlag(LOW_SteelWatchFoundry_State_Outcome_WulbrenSatisfied_5761bbee-eafa-4a61-a5fb-e83d9a77a9f9);
SetFlag(LOW_SteelWatchFoundry_State_GainedIronhandENDSupport_a090a831-c695-4478-8d0d-84661deabb98);
SetFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98);

PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5)
AND
DB_LOW_SteelWatchFoundry_OutcomeBarcus(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpBarcus();

//If Wulbren is not present, and Toobin is -> Toobin stays, Gondians leave || GONDIAN SUPPORT if majority saved
PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
NOT DB_LOW_SteelWatchFoundy_OutcomeWulbren(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_LOW_SteelWatchFoundry_OutcomeFundango(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
THEN
SetFlag(LOW_SteelWatchFoundry_State_SidedWithGondians_60345f15-6632-482e-ac4f-8a1b77d7fc36);
SetFlag(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593);
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpToobin();
PROC_LOW_SteelWatchFoundry_GondiansWalkOff();

PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
NOT DB_LOW_SteelWatchFoundy_OutcomeWulbren(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_LOW_SteelWatchFoundry_OutcomeFundango(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_MajorityIronThronePrisonersDead_6c40a75d-32ae-4402-a54c-062805f7ee7d)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_MajorityGondiansDead_74e0d621-1910-4661-821b-b0ca522b3abe)
THEN
SetFlag(LOW_SteelWatchFoundry_State_GainedGondianENDSupport_1bb09a8b-001d-4b43-9f39-ba89eb3aece9);

//If Wulbren is present and any gondians survived -> Wulbren walks off, Ironhands walk off, Gondians walk off. If Toobin is present, he stays, thankful. If Barcus is present he stays || Possible GONDIAN SUPPORT
PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5)
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
SetFlag(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593);
SetFlag(LOW_SteelWatchFoundry_State_SidedWithGondians_60345f15-6632-482e-ac4f-8a1b77d7fc36);
SetFlag((FLAG)LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c);
PROC_LOW_SteelWatchFoundry_WulbrenLeaves();
PROC_LOW_SteelWatchFoundry_GondiansWalkOff();
PROC_LOW_SteelWatchFoundry_IronHandsWalkOff();

PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5)
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_LOW_SteelWatchFoundry_OutcomeFundango(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpToobin();

PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5)
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus)
AND
DB_LOW_SteelWatchFoundry_OutcomeBarcus(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
PROC_LOW_SteelWatchFoundry_PostOutcome_SetUpBarcus();

PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5)
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_MajorityIronThronePrisonersDead_6c40a75d-32ae-4402-a54c-062805f7ee7d)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_MajorityGondiansDead_74e0d621-1910-4661-821b-b0ca522b3abe)
THEN
SetFlag(LOW_SteelWatchFoundry_State_GainedGondianENDSupport_1bb09a8b-001d-4b43-9f39-ba89eb3aece9);

//Cleanup
PROC
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve()
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren)
AND
DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango)
AND
DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus)
AND
DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra)
THEN
NOT DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren);
NOT DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango);
NOT DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus);
NOT DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra);
//END_REGION

//REGION Gossip flags
//Foundry getting destroyed
IF
FlagSet((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a, _, _)
THEN
ClearFlag(LOW_SteelWatchFoundry_State_Standing_c80223ed-a1f0-46b3-b867-231df8442207);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
