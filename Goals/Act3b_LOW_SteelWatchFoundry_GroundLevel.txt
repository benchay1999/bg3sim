Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Gondians
DB_LOW_Gondians(S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5);
DB_LOW_Gondians(S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc);
DB_LOW_Gondians(S_LOW_GondianWorker03_b28f2395-a5d4-4a4a-afcd-cddf9949a089);
DB_LOW_Gondians(S_LOW_GondianWorker04_6cc09c40-6b09-4e92-ad36-4e5ad72f7c43);
DB_LOW_Gondians(S_LOW_GondianWorker05_e86d2e9b-f55b-4eaf-9ba6-0245d17b6d1c);
DB_LOW_Gondians(S_LOW_GondianWorker06_53a85a70-979b-480a-afb1-ec8d9239e0f8);
DB_LOW_Gondians(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
DB_LOW_Gondians(S_LOW_GondianWorker09_2fb2c297-3c00-4b98-8412-41aea0087db5);
DB_LOW_Gondians(S_LOW_GondianWorker10_ffc8a25f-6ceb-4081-8e07-eca2205989c5);
DB_LOW_Gondians(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53);

DB_LOW_WorkroomGondians(S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5);
DB_LOW_WorkroomGondians(S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc);
DB_LOW_WorkroomGondians(S_LOW_GondianWorker03_b28f2395-a5d4-4a4a-afcd-cddf9949a089);
/*
DB_GLO_DefeatCounter(S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5,"LOW_SteelWatchFoundry_WorkRoomGondians");
DB_GLO_DefeatCounter(S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc,"LOW_SteelWatchFoundry_WorkRoomGondians");
DB_GLO_DefeatCounter(S_LOW_GondianWorker03_b28f2395-a5d4-4a4a-afcd-cddf9949a089,"LOW_SteelWatchFoundry_WorkRoomGondians");
*/
DB_PermaDefeatedFlag(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, (FLAG)LOW_SteelWatchFoundry_State_FundangoPermadefeated_8fbcef5a-d738-4a7a-be04-58e6ae551b9b);
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_SteelWatchFoundry_Gondians",LOW_SteelWatchFoundry_Status_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5);
//END_REGION

//REGION Exploding Collars
DB_LOW_SteelWatchFoundry_LooseCollars((ITEM)S_LOW_LooseCollar01_f35cdd25-5b06-4bff-a67d-56288cc18dbd);
DB_LOW_SteelWatchFoundry_LooseCollars((ITEM)S_LOW_LooseCollar02_f3a5bf13-a91b-4c8e-a05a-1b7dd5624ca9);
DB_LOW_SteelWatchFoundry_LooseCollars((ITEM)S_LOW_LooseCollar03_de4e5f21-7dd7-4d84-a01d-250c3e8a040e);
//END_REGION

//REGION Baneites
DB_LOW_Baneites(S_LOW_BaneiteOfficer01_db345b42-35f7-4a31-b5f4-1c4b86ebd25c);
DB_LOW_Baneites(S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418);
DB_LOW_Baneites(S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835);
DB_LOW_Baneites(S_LOW_BaneiteOfficer06_0ce716ac-f6fa-4b7d-8fda-456b0e74f90f);
DB_LOW_Baneites(S_LOW_BaneiteOfficer07_2dc326b9-73f4-40a6-af7f-54955e3b1ebd);
DB_LOW_Baneites(S_LOW_BaneiteOfficer08_015d02bd-0c8e-41c8-a6da-df92d71084d2);
DB_LOW_Baneites(S_LOW_BaneiteOfficer09_0c5259f6-3c86-4e84-b61e-42e9f31691ce);
DB_LOW_Baneites(S_LOW_BaneiteOfficer10_a2db5bf9-03a9-408e-971f-fc63741308bb);
DB_LOW_Baneites(S_LOW_BaneiteOfficer14_750a35b3-b0c5-4007-ae1a-4446c95a56ae);
DB_LOW_Baneites(S_LOW_BaneiteOfficer15_0b5a37de-60f3-403c-b5e8-b74afd50fa3d);
DB_LOW_Baneites(S_LOW_BaneiteOfficer16_38d84851-00b5-400c-81eb-7767a861e8e0);
DB_LOW_Baneites(S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd);
DB_LOW_Baneites(S_LOW_BaneiteOfficer18_f4a8f9e0-564c-41ed-8598-4c350b88f0e8);
DB_LOW_Baneites(S_LOW_BaneiteOfficer19_f5a48aa9-d67a-4fcd-9fe8-15e933314ca1);
DB_LOW_Baneites(S_LOW_BaneiteOfficer20_4b2f8018-f988-4dfd-bb59-962dc90070f3);
DB_LOW_Baneites(S_LOW_BaneiteOfficer21_9a64e678-c5aa-43ed-8765-33882e9f1ab9);
DB_LOW_Baneites(S_LOW_BaneiteOfficer_PostIRN01_36c0bb47-a8cc-4381-882b-a2ded38d0b5c);
DB_LOW_Baneites(S_LOW_BaneiteOfficer_PostIRN02_2cc225cf-794a-450a-bbb7-4b3400cb3c74);
DB_LOW_Baneites(S_LOW_LabRoomWatcher01_d48bb47b-7e55-45ab-ac19-708bd91e6eb4);
DB_LOW_Baneites(S_LOW_LabRoomWatcher02_c3117337-b9cb-455d-aaf2-15d69143acc8);
DB_LOW_Baneites(S_LOW_SteelWatcher_Prototype_51db791d-4378-448a-86ba-3e3ae2748db6);
DB_LOW_Baneites(S_LOW_SteelWatcher022_aca59fad-db3a-4d25-bfee-edbabff9da6a);
DB_LOW_Baneites(S_LOW_SteelWatcher023_a0594019-b0ed-46f8-a813-8be9379f0e8e);
DB_LOW_Baneites(S_LOW_SteelWatcherRanged_1c01c751-7ede-403e-a510-98cccc524e79);
DB_LOW_Baneites(S_LOW_SteelWatcher024_e1e3845f-89d4-41f3-a338-ec6a5b64b2b2);
DB_LOW_Baneites(S_LOW_SteelWatcher025_2c6cb9af-4d56-49c5-8324-17529bbfed6c);
DB_LOW_Baneites(S_LOW_SteelWatcher026_92c1d2f1-f1df-4a88-b599-7c0db7390ef9);
PROC_LOW_BaneitesEquipSwitches();
//END_REGION

//REGION Workroom dialogs
DB_Dialogs(S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5, (DIALOGRESOURCE)LOW_SteelWatchFoundry_GondianWorker01_3eb60328-1912-be93-811f-7827a1bc753c);
DB_Dialogs(S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc, (DIALOGRESOURCE)LOW_SteelWatchFoundry_GondianWorker02_aa3e5839-4ec3-3680-538b-afdba7d0abf4);
DB_Dialogs(S_LOW_GondianWorker03_b28f2395-a5d4-4a4a-afcd-cddf9949a089, (DIALOGRESOURCE)LOW_SteelWatchFoundry_GondianWorker03_ba8a62e5-5e44-c65a-f04c-1c5b9c8ee082);
//END_REGION

//REGION Security Office
DB_Dialogs(S_LOW_ScryScreen02_1d221b28-9a9b-482a-9ef0-4e65a0e60bc7, (DIALOGRESOURCE)LOW_SteelWatchFoundry_ScryScreen2_2eb678aa-bcf0-cd3a-eebf-034623a496f4);
DB_Dialogs(S_LOW_GondianWorker08_3607ec31-f939-41aa-a7d2-e32f8c46979d, LOW_SteelWatchFoundry_GondianWorker08_Leader_9d7d9cf1-437a-bba8-b087-456483f85edc);
DB_HasItemEvent(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, LOW_SteelWatchFoundry_State_HasBomb_8a262fbb-6d98-48cc-bebf-d52773eb38f7);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, (DIALOGRESOURCE)LOW_SteelWatchFoundry_Dead_GondianWorker08_Leader_ce7d7d08-ac8a-33d9-e5be-8adbc7842478);
DB_ItemDialog_NarratorAD(S_LOW_LabLevelWarning_a4b80405-1411-4412-9de7-eb66adee13c7, LOW_SteelWatchFoundry_AD_LabLevelWarningPlaque_2dd97823-17d0-5004-99c3-5077c75d759a);

PROC_SetOnStage(S_LOW_ScryScreenSparks01_a3eae668-1974-498a-bb46-94a3eb737038, 0);
PROC_SetOnStage(S_LOW_ScryScreenSparks02_efed19bb-d35a-4e79-9e05-5de6bcc61298, 0);
//Zanner ignores theft crimes
PROC_CharacterDisableCrime((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, "Steal");

//END_REGION

//REGION Entering the Foundry for the first time
PROC_TriggerRegisterForPlayers(S_LOW_FoundryGroundFloor_1a994e3a-d80d-478d-a452-b9100fdec719);
//END_REGION

//REGION Fundango Follower
TriggerRegisterForCharacter(S_LOW_ZannerTurnsBackTrigger_17c2f52c-6c3c-4d9d-af1c-3afaede821d2, S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
//END_REGION

//REGION Placeholder bomb setup
PROC_SetOnStage(S_LOW_SteelWatchFoundry_Bomb_Placeholder_a02e5ea2-5843-432b-b55f-4a87e6378fef, 0);
//END_REGION

//REGION Chatting baneties
//DB_OneShot_ADTrigger((TRIGGER)S_LOW_ChattingADTrigger_4cc93ca9-937b-49b5-936b-f0c6a2d764f7, (DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_ChattingBaneites_b0316789-ed69-dc06-5fa0-49bc17d03fce, S_LOW_BaneiteOfficer01_db345b42-35f7-4a31-b5f4-1c4b86ebd25c, S_LOW_BaneiteOfficer16_38d84851-00b5-400c-81eb-7767a861e8e0);
//END_REGION

//REGION Dead mans Switch introduction
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_WorkroomEncounterCineStartArea_a785fb75-de3e-4162-a679-1d6b8920dd65);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_DeadMansSwitchThreatCineStartArea_9a2e2fde-2084-492e-9fd9-1485eb10a9da);

DB_GiveItemToEvent(S_LOW_DeadMansSwitch02_0dbbc23e-a6c1-4ebb-8f8b-495306813e1b, (FLAG)LOW_SteelWatchFoundry_Event_HandOverKillSwitch_a34ee3af-0338-434a-8fff-2a564f2bb204);

DB_SpotPlayers((CHARACTER)S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5, "LOW_SteelWatchFoundry_WorkroomEncounter", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers((CHARACTER)S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc, "LOW_SteelWatchFoundry_WorkroomEncounter", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers((CHARACTER)S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd, "LOW_SteelWatchFoundry_WorkroomEncounter", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers((CHARACTER)S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418, "LOW_SteelWatchFoundry_WorkroomEncounter", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers((CHARACTER)S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835, "LOW_SteelWatchFoundry_WorkroomEncounter", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5, "LOW_SteelWatchFoundry_WorkroomEncounter", S_LOW_WorkroomEncounterCineStartArea_a785fb75-de3e-4162-a679-1d6b8920dd65);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc, "LOW_SteelWatchFoundry_WorkroomEncounter", S_LOW_WorkroomEncounterCineStartArea_a785fb75-de3e-4162-a679-1d6b8920dd65);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd, "LOW_SteelWatchFoundry_WorkroomEncounter", S_LOW_WorkroomEncounterCineStartArea_a785fb75-de3e-4162-a679-1d6b8920dd65);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418, "LOW_SteelWatchFoundry_WorkroomEncounter", S_LOW_WorkroomEncounterCineStartArea_a785fb75-de3e-4162-a679-1d6b8920dd65);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835, "LOW_SteelWatchFoundry_WorkroomEncounter", S_LOW_WorkroomEncounterCineStartArea_a785fb75-de3e-4162-a679-1d6b8920dd65);

DB_SceneManager((CHARACTER)S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5, "LOW_SteelWatchFoundry_WorkroomEncounter");
DB_SceneManager((CHARACTER)S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc, "LOW_SteelWatchFoundry_WorkroomEncounter");
DB_SceneManager((CHARACTER)S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd, "LOW_SteelWatchFoundry_WorkroomEncounter");
DB_SceneManager((CHARACTER)S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835, "LOW_SteelWatchFoundry_WorkroomEncounter");
DB_SceneManager((CHARACTER)S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418, "LOW_SteelWatchFoundry_WorkroomEncounter");

DB_SceneTriggerManager("LOW_SteelWatchFoundry_WorkroomEncounter",S_LOW_WorkroomEncounterCineStartArea_a785fb75-de3e-4162-a679-1d6b8920dd65);
DB_SceneAllowAllDisturbances("LOW_SteelWatchFoundry_WorkroomEncounter");

DB_GlobalFlagReactionAfterDialog(LOW_SteelWatchFoundry_State_AllowedInWorkroom_5f50c96b-735a-4f02-8d77-bccc5030ba64, (DIALOGRESOURCE)LOW_SteelWatchFoundry_WorkroomEncounter_36887f00-101d-96d8-0901-3bdfa90cd7c9);
//END_REGION

//REGION Workroom Elevator
PROC_SetOnStage(S_LOW_ElevatorToInstallRoom_a637edb4-a14c-47f8-a4b8-e900ea1af5a2, 0);
DB_LOW_SteelWatchFoundry_WorkroomElevatorState("Down");

PROC_TriggerRegisterForParty(S_LOW_WorkroomElevatorZone_152eaa67-924a-4b25-bfff-5584fae9e576);
PROC_TriggerRegisterForParty(S_LOW_LabElevatorZone_79f50483-4256-4603-b948-1c80edf0029c);
PROC_TriggerRegisterForParty(S_LOW_WorkroomElevator_Jumpzone_aaef3a0e-9030-455d-bbe6-c954648dbb2d);
//END_REGION

//REGION Workroom Baneites
DB_LOW_SteelWatchFoundry_WorkroomBaneites((CHARACTER)S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418);
DB_LOW_SteelWatchFoundry_WorkroomBaneites((CHARACTER)S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd);
DB_LOW_SteelWatchFoundry_WorkroomBaneites((CHARACTER)S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835);
//END_REGION

//REGION Small Docks Cargo Elevator + Door
DB_LOW_SteelWatchFoundry_SmallElevator_Stations((TRIGGER)S_LOW_CargoElevator_Down_60392413-d364-4d4b-80c2-eb5ba4e3fb2f, (ITEM)S_LOW_CargoDoor_OutsideLever_f6f8ebcc-6249-4278-8874-e5bc2de105e6, "Down");
DB_LOW_SteelWatchFoundry_SmallElevator_Stations((TRIGGER)S_LOW_CargoElevator_Up_80ea40a9-111a-4d45-9c7a-d4f2d4ef8208, (ITEM)S_LOW_CargoDoor_InsideLever_422413f8-37c0-40c5-b1fb-1e86f5c003ea, "Up");
DB_LOW_SteelWatchFoundry_SmallElevator_State("Down");

DB_LOW_SteelWatchFoundry_SmallElevator_Levers((ITEM)S_LOW_CargoDoor_OutsideLever_f6f8ebcc-6249-4278-8874-e5bc2de105e6);
DB_LOW_SteelWatchFoundry_SmallElevator_Levers((ITEM)S_LOW_CargoDoor_InsideLever_422413f8-37c0-40c5-b1fb-1e86f5c003ea);
DB_LOW_SteelWatchFoundry_SmallElevator_Levers((ITEM)S_LOW_CargoDoor_ElevatorLever_507b9737-25af-4600-aabb-8fc4fb3103af);
//END_REGION

//REGION Outside trespass
DB_TrespassTrigger(S_LOW_OutsideTresspassArea01_d27f4e54-fb0b-44ac-922b-ceda691557a4, S_LOW_OutsideTressPassArea01_OutTrigger_6a7f78d7-08f6-4d74-85da-037fcba57c1d, "LOW_SteelWatchFoundry_Trespass");
DB_TrespassTrigger(S_LOW_OutsideTresspassArea02_d688cf2a-ba9b-46b2-8205-c01218527729, S_LOW_OutsideTressPassArea02_OutTrigger_c18b2c84-3b93-4eab-8d72-fd40bb0fc11f, "LOW_SteelWatchFoundry_Trespass");
DB_TrespassTrigger(S_LOW_OutsideTresspassArea03_3d06883b-c7d2-492a-af68-50b2e4897095, NULL_00000000-0000-0000-0000-000000000000, "LOW_SteelWatchFoundry_Trespass_Aggressive");

//END_REGION

//REGION Region for Quest Update
DB_PartyProgress_Trigger(S_LOW_SteelWatchFoundry_OuterArea_c54e1a1a-935f-41a6-9bbe-ed2326e79012, (FLAG)WYR_KillDirectorGortash_State_LocatedFoundry_b9a0e503-1a39-4a69-817c-0a360cbba210);
//END_REGION

//REGION Topical Greeting flag
DB_TopicalGreeting(TG_LOW_SteelWatchFoudnry_e3f0e162-243a-49b2-bd5f-a750d170fab0);

DB_SteelWatchFoundry_SUBTRiggers(S_LOW_SteelWatchFoundry_GroundFloor_SUB_aad054dd-9b0e-4054-b411-bcc96a382bd8);
DB_SteelWatchFoundry_SUBTRiggers(S_LOW_SteelWatchFoundry_LabFloor_SUB_65a2f1d8-f8f9-41ae-b9b6-e561b6069af9);
DB_SteelWatchFoundry_SUBTRiggers(S_LOW_SteelWatchFoundry_ControlFloor_SUB_a77da59a-8e16-4d7c-8194-3ebaa89b6342);


//END_REGION

//REGION Disable attack button for dialogs
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_SteelWatchFoundry_Confrontation_AfterIRN_00ab0c07-17d9-a5b1-a900-9857bf839428);
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_SteelWatchFoundry_DeadMansSwitchThreat_47d40827-597b-d211-395a-75429620f340);
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_SteelWatchFoundry_WorkroomEncounter_36887f00-101d-96d8-0901-3bdfa90cd7c9);
//END_REGION

//REGION Antechamber Baneites
DB_LOW_SteelWatchFoundry_AntechamberBaneties((CHARACTER)S_LOW_BaneiteOfficer16_38d84851-00b5-400c-81eb-7767a861e8e0);
DB_LOW_SteelWatchFoundry_AntechamberBaneties((CHARACTER)S_LOW_BaneiteOfficer01_db345b42-35f7-4a31-b5f4-1c4b86ebd25c);
//END_REGION

//REGION Outside Watchers
DB_LOW_SteelWatchFoundry_OutsideWatchers((CHARACTER)S_LOW_SteelWatcher025_2c6cb9af-4d56-49c5-8324-17529bbfed6c);
DB_LOW_SteelWatchFoundry_OutsideWatchers((CHARACTER)S_LOW_SteelWatcher024_e1e3845f-89d4-41f3-a338-ec6a5b64b2b2);
DB_LOW_SteelWatchFoundry_OutsideWatchers((CHARACTER)S_LOW_SteelWatcher026_92c1d2f1-f1df-4a88-b599-7c0db7390ef9);
//END_REGION

//REGION Hiding outdated items
PROC_SetOnStage(DEC_Foundry_Neural_Switchboard_A_11a5dc17-2820-41f8-adbe-03213dee3328, 0);
PROC_SetOnStage(S_LOW_SteelWatchFoundry_MalfunctioningSwitchBoard_7c7afa83-46e5-4c4b-ac54-a02e91ada508, 0);
//END_REGION
KBSECTION
//REGION Debug
IF
TextEvent("LOW_Foundry_GiveCrossbowComponents")
AND
GetHostCharacter(_Player)
THEN
ToInventory(S_LOW_HarpoonCrossBowDiagram_433ff42d-9e81-47e9-a8ac-f0687d386507, _Player, 1, 0, 1);
ToInventory(S_LOW_TargetingModule_c5af38b4-d96d-4c81-bf5f-aeea46e0d97e, _Player, 1, 0, 1);
ToInventory(S_LOW_WatcherArm_cfc7a2cd-d5e7-4d54-8a2b-3a5ccb5949d2, _Player, 1, 0, 1);
//END_REGION

//REGION Baneites Equipping Switches
PROC
PROC_LOW_BaneitesEquipSwitches()
AND
DB_LOW_Baneites(_Baneites)
AND
GetItemByTemplateInInventory((ITEMROOT)QUEST_LOW_DeadMansSwitch_Shield_10d9e4a8-8019-47a9-88e3-dac74f7b8ae5, _Baneites, _EquipableSwitch)
AND
IsEquipped((ITEM)_EquipableSwitch, 0)
THEN
Equip((CHARACTER)_Baneites, (ITEM)_EquipableSwitch);
//END_REGION

//REGION Baneites don't come back from unconsciousness
//This covers certain edge cases
IF
DB_LOW_Baneites(_Baneite)
THEN
DB_ForceRemoveKnockedOutCharacterOnLongRest((CHARACTER)_Baneite);
//END_REGION

//REGION Entering the Foundry for the first time
IF
DB_InRegion(_Player, S_LOW_FoundryGroundFloor_1a994e3a-d80d-478d-a452-b9100fdec719)
AND
DB_Players(_Player)
AND
NOT GetFlag(LOW_SteelWatchFoundry_State_FoundryVisited_5c929efe-ffe2-4eeb-8853-da29735b53ab, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
SetFlag(LOW_SteelWatchFoundry_State_FoundryVisited_5c929efe-ffe2-4eeb-8853-da29735b53ab);
//END_REGION

//REGION Fundango Follower
IF
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b)
AND
DB_DialogNPCs(_ID, S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, _)
AND
DB_DialogPlayers(_ID, _Player, _)
THEN
AddPartyFollower((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, (CHARACTER)_Player);
DB_LOW_SteelWatchFoundry_FundangoFollowerOf(_Player);

IF
FlagCleared((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b, _, _)
AND
DB_LOW_SteelWatchFoundry_FundangoFollowerOf(_Player)
THEN
PROC_RemovePartyFollower((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
NOT DB_LOW_SteelWatchFoundry_FundangoFollowerOf(_Player);

PROC
PROC_GLO_PostReassignFollowerHook(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, (CHARACTER)_OldLeader, (CHARACTER)_NewLeader)
THEN
NOT DB_LOW_SteelWatchFoundry_FundangoFollowerOf(_OldLeader);
DB_LOW_SteelWatchFoundry_FundangoFollowerOf(_NewLeader);

IF
DB_PermaDefeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b)
THEN
ClearFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b);
ClearFlag(LOW_SteelWatchFoundry_State_ToobinWaitingToBeFollower_aba323fc-5ade-ebfc-a4e2-38947e78191c);

IF
DB_InRegion(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, S_LOW_ZannerTurnsBackTrigger_17c2f52c-6c3c-4d9d-af1c-3afaede821d2)
AND
DB_LOW_SteelWatchFoundry_FundangoFollowerOf(_Player)
THEN
ClearFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b);
SetFlag(LOW_SteelWatchFoundry_State_ToobinWaitingToBeFollower_aba323fc-5ade-ebfc-a4e2-38947e78191c);
DB_SteelWatchFoundry_ZannerShouldReturn(1);

IF
CharacterLeftParty(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
DB_SteelWatchFoundry_ZannerShouldReturn(1)
THEN
PROC_LOW_SteelWatchFoundry_FundangoReturn();
NOT DB_SteelWatchFoundry_ZannerShouldReturn(1);

QRY
QRY_CharInAnyFoundryTrigger((CHARACTER)_Char)
AND
DB_LOW_SteelWatchFoundry_RoomTriggers(_FoundryTrigger)
AND
DB_InRegion(_Char, (TRIGGER)_FoundryTrigger)
THEN
DB_NOOP(1);

//If the Player Waypoints out of the Foundry, Toobin stays behind
PROC
PROC_WaypointTeleported((CHARACTER)_Player,(TRIGGER)_)
AND
DB_LOW_SteelWatchFoundry_FundangoFollowerOf(_Player)
THEN
ClearFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b);

//Fundnago returns to the security office only if he himself was outsid the Foundry
//TODO: move to Anubis
PROC
PROC_LOW_SteelWatchFoundry_FundangoReturn()
THEN
PROC_CharacterMoveTo((CHARACTER)S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, S_LOW_FundangoSecurityOfficeLocation_7dba56b3-101e-4ac0-9a4a-5b11cda2cfa6, "Run", "");
//END_REGION

//REGION Census data
IF
UseStarted(_Player, S_LOW_SecOfficeDesk_d54a335e-4fb1-4f7a-ac71-e21f0771587b)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag(IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
QRY_OnlyOnce("LOW_CensusDataSet")
THEN
ToInventory(S_LOW_IronThroneCensusData_NoRavengard_bebeba70-e34c-4547-a451-7249fee0f78e, S_LOW_SecOfficeDesk_d54a335e-4fb1-4f7a-ac71-e21f0771587b, 1, 0, 1);
ToInventory(S_LOW_IronThroneCensusData_b726be30-3fc6-4c6f-be47-bc65faf522bf, LOW_SteelWatchFoundry_AsylumChest_34e06174-ee14-40fe-9367-d63303ae86ee, 1, 0, 1);

IF
UseStarted(_Player, S_LOW_SecOfficeDesk_d54a335e-4fb1-4f7a-ac71-e21f0771587b)
AND
DB_Players(_Player)
AND
DB_GlobalFlag(IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
QRY_OnlyOnce("LOW_CensusDataSet")
THEN
ToInventory(S_LOW_IronThroneCensusData_b726be30-3fc6-4c6f-be47-bc65faf522bf, S_LOW_SecOfficeDesk_d54a335e-4fb1-4f7a-ac71-e21f0771587b, 1, 0, 1);
ToInventory(S_LOW_IronThroneCensusData_NoRavengard_bebeba70-e34c-4547-a451-7249fee0f78e, LOW_SteelWatchFoundry_AsylumChest_34e06174-ee14-40fe-9367-d63303ae86ee, 1, 0, 1);
//END_REGION

//REGION Scry screen
IF
FlagSet((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9, _, _)
THEN
PROC_RemoveDialog(S_LOW_ScryScreen02_1d221b28-9a9b-482a-9ef0-4e65a0e60bc7);
PROC_SetOnStage(S_LOW_ScryScreenVFX_f77f7f74-6027-4735-8257-0a086954d2b8, 0);
PROC_SetOnStage(S_LOW_ScryScreenSparks01_a3eae668-1974-498a-bb46-94a3eb737038, 1);
PROC_SetOnStage(S_LOW_ScryScreenSparks02_efed19bb-d35a-4e79-9e05-5de6bcc61298, 1);

IF
UseStarted(_Player, S_LOW_ScryScreen02_1d221b28-9a9b-482a-9ef0-4e65a0e60bc7)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
THEN
PROC_PlayCantUseItemAD(_Player);
//END_REGION

//REGION Gondian defeat counter
IF
DB_LOW_Gondians(_Gondian)
AND
_Gondian != S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53
THEN
DB_GLO_DefeatCounter(_Gondian, "LOW_SteelWatchFoundry_Gondians");

IF
DB_LOW_Gondians(_Gondian)
THEN
PROC_GLO_DifficultyModes_AddHPBoostedEntity(_Gondian);

PROC
PROC_GLO_DefeatCounter_Notify("LOW_SteelWatchFoundry_Gondians", _TotalGondians, _DefeatedGondians, _PermaDefeatedGondians)
AND
IntegerSum(_DefeatedGondians,_PermaDefeatedGondians, _SumDefeated) 
AND
_SumDefeated !=0
AND
IntegerDivide(_TotalGondians, 2, _Threshold)
AND
_SumDefeated >= _Threshold
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_MajorityGondiansDead_74e0d621-1910-4661-821b-b0ca522b3abe)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_SteelWatchFoundry_State_MajorityGondiansDead_74e0d621-1910-4661-821b-b0ca522b3abe);

PROC
PROC_GLO_DefeatCounter_Notify("LOW_SteelWatchFoundry_Gondians", _TotalGondians, _DefeatedGondians, _PermaDefeatedGondians)
AND
IntegerSum(_DefeatedGondians,_PermaDefeatedGondians, _SumDefeated) 
AND
_SumDefeated !=0
AND
IntegerSubtract(_TotalGondians, 1, _Threshold)
AND
_SumDefeated >= _Threshold
AND
NOT DB_Defeated(LOW_SteelWatchFoundry_GondianWorker08_Leader_9d7d9cf1-437a-bba8-b087-456483f85edc)
THEN
SetFlag((FLAG)LOW_SteelWatchFoundry_State_AllGondiansButZannerDead_42485927-6585-fdfe-1433-3efbca97dc20);

PROC
PROC_GLO_DefeatCounter_Notify("LOW_SteelWatchFoundry_Gondians", _TotalGondians, _DefeatedGondians, _PermaDefeatedGondians)
AND
_PermaDefeatedGondians >=1
AND
QRY_OnlyOnce("LOW_SteelWatchFoudnry_AnyGondiansDead_Registered")
THEN
DB_LOW_SteelWatchFoundry_AnyGondiansDied(1);
//END_REGION

//REGION Exploding collars DB maintenence
IF
DB_LOW_Gondians(_Gondian)
AND
_Gondian != S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d
THEN
DB_LOW_SteelWatchFoundry_Collared(_Gondian);

IF
TemplateEquipped(QUEST_LOW_SteelWatchFoundry_ExplodingCollar_47af23c3-7eb0-4a49-a4a4-f2ee5ab521c0, _Collared)
THEN
DB_LOW_SteelWatchFoundry_Collared(_Collared);

IF
TemplateUnequipped(QUEST_LOW_SteelWatchFoundry_ExplodingCollar_47af23c3-7eb0-4a49-a4a4-f2ee5ab521c0, _Collared)
THEN
NOT DB_LOW_SteelWatchFoundry_Collared(_Collared);

//Tracking collars that aren't worn
IF
TemplateAddedTo(QUEST_LOW_SteelWatchFoundry_ExplodingCollar_47af23c3-7eb0-4a49-a4a4-f2ee5ab521c0, _Collar, _Char, _)
THEN
NOT DB_LOW_SteelWatchFoundry_LooseCollars((ITEM)_Collar);
DB_LOW_SteelWatchFoundry_Carrier(_Char);

IF
TemplateRemovedFrom(QUEST_LOW_SteelWatchFoundry_ExplodingCollar_47af23c3-7eb0-4a49-a4a4-f2ee5ab521c0, _Collar, _Char)
THEN
DB_LOW_SteelWatchFoundry_LooseCollars((ITEM)_Collar);
NOT DB_LOW_SteelWatchFoundry_Carrier(_Char);
//END_REGION

//REGION Gondians ignore crimes against Baneites
PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_CrimeID,_,_,_,_Baneite)
AND
DB_LOW_Baneites(_Baneite)
AND
DB_LOW_Gondians(_Gondians)
THEN
CrimeIgnoreCrime(_CrimeID ,_Gondians);

//Also stopping Gondians from looking at you funny when you loot Baneite corpses
QRY
QRY_CorpseLooting_BlockMakeOwned(_Baneite)
AND
DB_LOW_Baneites(_Baneite)
THEN
DB_Noop(1);

IF
DB_LOW_Gondians(_Gondian)
THEN
PROC_CharacterDisableCrime((CHARACTER)_Gondian, "Trespassing");
PROC_CharacterDisableCrime((CHARACTER)_Gondian, "LOW_SteelWatchFoundry_Trespass");
PROC_CharacterDisableCrime((CHARACTER)_Gondian, "LOW_SteelWatchFoundry_Trespass_Aggressive");
//END_REGION

//REGION Dead mans Switch introduction
//Starting the threat dialog
IF
DB_InRegion(_Player, (TRIGGER)S_LOW_DeadMansSwitchThreatCineStartArea_9a2e2fde-2084-492e-9fd9-1485eb10a9da)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOnce("LOW_SteelWatchFoundry_DeadMansSwitchIntroduced")
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_SteelWatchFoundry_DeadMansSwitchThreat_47d40827-597b-d211-395a-75429620f340, 
(CHARACTER)S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5, 
(CHARACTER)S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc, 
(CHARACTER)S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418, 
(CHARACTER)S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd, 
_Player)
THEN
DB_OnlyOnce("LOW_SteelWatchFoundry_DeadMansSwitchIntroduced");
DB_LOW_SteelWatchFoundry_DeadManSwitchThreat_MainWatchingPlayer(_Player);

PROC
PROC_StartDialog_AddExtraSpeakers(LOW_SteelWatchFoundry_DeadMansSwitchThreat_47d40827-597b-d211-395a-75429620f340, _ID)
THEN
PROC_DialogAddSpeakingActorAt(_ID, S_LOW_DeadMansSwitch02_0dbbc23e-a6c1-4ebb-8f8b-495306813e1b,6);
PROC_DialogAddSpeakingActorAt(_ID, S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835,7);

IF
DialogStarted(LOW_SteelWatchFoundry_DeadMansSwitchThreat_47d40827-597b-d211-395a-75429620f340, _ID)
AND
DB_LOW_SteelWatchFoundry_DeadManSwitchThreat_MainWatchingPlayer(_MainPlayer)
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, _MainPlayer)
THEN
PROC_DialogAddListeningActor(_ID, _Player);

IF
EnteredCombat(_WorkroomGondian, _)
AND
DB_LOW_WorkroomGondians(_WorkroomGondian)
THEN
SetFlag((FLAG)LOW_SteelWatchFoundry_State_WorkroomEncounterCombatEnd_1fe13fc8-90d8-44b7-61bb-2b8e0e24d70c);

//Starting the encounter dialog
PROC
PROC_SpotPlayers_Spotted(_ ,"LOW_SteelWatchFoundry_WorkroomEncounter" ,_Player)
AND
DB_Players(_Player)
AND
NOT DB_Defeated(S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418)
AND
NOT DB_OnlyOnce("LOW_SteelWatchFoundry_WorkroomEncounterPlayed")
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_SteelWatchFoundry_WorkroomEncounter_36887f00-101d-96d8-0901-3bdfa90cd7c9, 
(CHARACTER)S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5, 
(CHARACTER)S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418,
_Player)
THEN
DB_OnlyOnce("LOW_SteelWatchFoundry_WorkroomEncounterPlayed");

IF
DialogStarted((DIALOGRESOURCE)LOW_SteelWatchFoundry_WorkroomEncounter_36887f00-101d-96d8-0901-3bdfa90cd7c9, _)
AND
DB_SpotPlayers(_CHAR, "LOW_SteelWatchFoundry_WorkroomEncounter", _, _)
THEN
PROC_SpotPlayers_StopSpotting(_CHAR, "LOW_SteelWatchFoundry_WorkroomEncounter");

//If the player attacks the baneites or watcher, the baneites and watchers turn hostile
IF
AttackedBy(_Baneite, _Player, _, _, _, _, _)
AND
DB_LOW_SteelWatchFoundry_WorkroomBaneites((CHARACTER)_Baneite)
AND
NOT DB_Is_InCombat(_Baneite, _)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_SteelWatchFoundry_Banites_Workroom_1d8980ed-53a1-40ad-b0a5-346b5d3dc3d6, 0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_SteelWatchFoudnry_Banites_WorkroomWatchers_974319ca-0a71-4119-870d-3c1d27cae295, 0);

//If the baneites enter combat the gondians join in only before the IRN is visited
IF
EnteredCombat(_Baneite, _)
AND
DB_LOW_SteelWatchFoundry_WorkroomBaneites((CHARACTER)_Baneite)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_WorkroomGondiansPersuaded_b0a6f7b9-c045-4ba4-9799-45dabd422e02)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_SteelWatchFoundry_Gondians_Workroom_e87e44b4-5646-4c3f-a3a8-d1b33adf68f9, 0);

//If the gondians were convinced by the player to revolt, they join the combat on the player's side.
IF
EnteredCombat(_Baneite, _)
AND
DB_LOW_SteelWatchFoundry_WorkroomBaneites((CHARACTER)_Baneite)
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_WorkroomGondiansPersuaded_b0a6f7b9-c045-4ba4-9799-45dabd422e02)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_SteelWatchFoundry_Gondians_Workroom_e87e44b4-5646-4c3f-a3a8-d1b33adf68f9, 100);

IF
DialogEnded((DIALOGRESOURCE)LOW_SteelWatchFoundry_DeadMansSwitchThreat_47d40827-597b-d211-395a-75429620f340, _)
THEN
SetFlag(LOW_SteelWatchFoundry_State_WitnessedKillSwitchThreat_785ddb91-187e-488e-93a3-c416c568b79d);

//Interrupt dialog when the dead man's switch is dropped
IF
EnteredCombat(S_LOW_DeadMansSwitch02_0dbbc23e-a6c1-4ebb-8f8b-495306813e1b, _CombatID)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_ReturnedFromIronThrone_16f58dd6-71c1-41e8-b053-b32991ac8fa1)
AND
DB_LOW_WorkroomGondians(_Gondian)
AND
DB_Is_InCombat(_Gondian, _CombatID)
THEN
SetRelation((FACTION)ACT3_LOW_SteelWatchFoundry_Gondians_Workroom_e87e44b4-5646-4c3f-a3a8-d1b33adf68f9, (FACTION)ACT3_LOW_SteelWatchFoundry_Banites_Workroom_1d8980ed-53a1-40ad-b0a5-346b5d3dc3d6, 0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_SteelWatchFoundry_Gondians_Workroom_e87e44b4-5646-4c3f-a3a8-d1b33adf68f9, 50);

IF
EnteredCombat(S_LOW_DeadMansSwitch02_0dbbc23e-a6c1-4ebb-8f8b-495306813e1b, _CombatID)
AND
NOT DB_LOW_SteelWatchFoundry_SwitchBeingDisarmed(_)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
DB_LOW_WorkroomGondians(_Gondian)
AND
NOT DB_Defeated(_Gondian)
AND
QRY_OnlyOnce("LOW_SteelWatchFoundry_KillSwitchCombatInterruptDialog_Played")
AND
QRY_StartDialogCustom(
(DIALOGRESOURCE)LOW_SteelWatchFoundry_SwitchWarningCombatInterrupt_edd391fd-29d6-ba45-4f5e-21de808023ca, 
(ITEM)S_LOW_DeadMansSwitch02_0dbbc23e-a6c1-4ebb-8f8b-495306813e1b, 
(CHARACTER)_Gondian, 
_Player, 0, 0, 0, 0)
THEN
DB_LOW_SteelWatchFoundry_KillSwitchCombatInterruptDialog_Player(_Player);

IF
DialogStarted((DIALOGRESOURCE)LOW_SteelWatchFoundry_SwitchWarningCombatInterrupt_edd391fd-29d6-ba45-4f5e-21de808023ca, _DialogID)
AND
DB_Is_InCombat(S_LOW_DeadMansSwitch02_0dbbc23e-a6c1-4ebb-8f8b-495306813e1b, _CombatID)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
NOT DB_LOW_SteelWatchFoundry_KillSwitchCombatInterruptDialog_Player(_Player)
THEN
PROC_DialogAddListeningActor(_DialogID, _Player);

IF
DialogStarted((DIALOGRESOURCE)LOW_SteelWatchFoundry_WorkroomEncounter_36887f00-101d-96d8-0901-3bdfa90cd7c9, _)
THEN
PROC_SceneOver("LOW_SteelWatchFoundry_WorkroomEncounter");

IF
DialogStarted((DIALOGRESOURCE)LOW_SteelWatchFoundry_SwitchWarningCombatInterrupt_edd391fd-29d6-ba45-4f5e-21de808023ca, _)
THEN
SetFlag((FLAG)LOW_SteelWatchFoundry_State_AlternateWorkBehaviour_1cbf2ff3-53d9-48bb-b634-5d9c259b8056, S_LOW_GondianWorker01_92010ea3-cd5e-4896-97fc-1f1e7942fcf5);
SetFlag((FLAG)LOW_SteelWatchFoundry_State_AlternateWorkBehaviour_1cbf2ff3-53d9-48bb-b634-5d9c259b8056, S_LOW_GondianWorker02_a13a0681-de86-45f2-922c-85cb1fad1cfc);
SetFlag((FLAG)LOW_SteelWatchFoundry_State_AlternateWorkBehaviour_1cbf2ff3-53d9-48bb-b634-5d9c259b8056, S_LOW_GondianWorker03_b28f2395-a5d4-4a4a-afcd-cddf9949a089);

IF
DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllowedInWorkroom_5f50c96b-735a-4f02-8d77-bccc5030ba64)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_SteelWatchFoudnry_Banites_WorkroomWatchers_974319ca-0a71-4119-870d-3c1d27cae295, 50);
DB_Dialogs(S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418, (DIALOGRESOURCE)LOW_SteelWatchFoundry_BaneiteOfficer02_9d419d0e-3c42-2e9c-56e0-1cb3132c9f40);
DB_Dialogs(S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd, (DIALOGRESOURCE)LOW_SteelWatchFoundry_BaneiteOfficer17_61115931-eacd-962e-1f63-b4aa57538d30);
DB_Dialogs(S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835, (DIALOGRESOURCE)LOW_SteelWatchFoundry_BaneiteOfficer03_9d92a2ea-d253-f712-1edd-5994bc41590f);
PROC_SteelWatchFoundry_AntechamberBaneitesLeave();
PROC_SteelWatchFoundry_OutsideWatchersLeave();

PROC
PROC_SteelWatchFoundry_AntechamberBaneitesLeave()
AND
DB_LOW_SteelWatchFoundry_AntechamberBaneties(_Baneite)
AND
NOT DB_Defeated(_Baneite)
THEN
PROC_DisappearOutOfSight(_Baneite, "Run", 0, "");

PROC
PROC_SteelWatchFoundry_OutsideWatchersLeave()
AND
DB_LOW_SteelWatchFoundry_OutsideWatchers(_Watcher)
AND
NOT DB_Defeated(_Watcher)
THEN
PROC_DisappearOutOfSight(_Watcher, "Run", 0, "");

//Scene interruption
PROC
PROC_SceneInterrupted(_, _, "LOW_SteelWatchFoundry_WorkroomEncounter", _Interruption)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Interruption)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_SteelWatchFoundry_Banites_Workroom_1d8980ed-53a1-40ad-b0a5-346b5d3dc3d6, 0);

PROC
PROC_SceneOver("LOW_SteelWatchFoundry_WorkroomEncounter")
THEN
SetFlag(LOW_SteelWatchFoundry_State_LowaWorking_2194447d-7b32-44c3-a760-2afcb95e26de);
//END_REGION

//REGION Workroom Elevator
//Elevator Lever
IF
UseStarted(_, S_LOW_LabElevator_Lever_8bdb7ff9-32e1-4628-a39c-f976328267dc)
AND
DB_LOW_SteelWatchFoundry_WorkroomElevatorState("Down")
THEN
PROC_LOW_SteelWatchFoundry_WorkroomElevatorUp();

IF
UseStarted(_, S_LOW_WorkRoomElevator_Lever_ed121edc-6bad-4be9-8fd6-badce076f1e3)
AND
DB_LOW_SteelWatchFoundry_WorkroomElevatorState("Up")
THEN
PROC_LOW_SteelWatchFoundry_WorkroomElevatorDown();

//Lever in Sec office
IF
UseStarted(_, S_LOW_ElevatorLever_9bffd091-34f5-4f86-9530-3c3eff20a13a)
AND
DB_LOW_SteelWatchFoundry_WorkroomElevatorState("Down")
THEN
PROC_LOW_SteelWatchFoundry_WorkroomElevatorUp();

//Lever in Lab
IF
UseStarted(_, S_LOW_ElevatorCallToLabLever_bc092633-8245-4df6-9031-d7e3eaadee1f)
AND
DB_LOW_SteelWatchFoundry_WorkroomElevatorState("Up")
THEN
PROC_LOW_SteelWatchFoundry_WorkroomElevatorDown();

//Saving Occupants in the elevator
PROC
PROC_LOW_SteelWatchFoundry_WorkroomElevatorUp()
AND
DB_InRegion(_Character, S_LOW_LabElevatorZone_79f50483-4256-4603-b948-1c80edf0029c)
THEN
DB_LOW_SteelWatchFoundry_ElevatorTravellingCharacters(_Character);

PROC
PROC_LOW_SteelWatchFoundry_WorkroomElevatorUp()
THEN
LoadLevelTemplate((LEVELTEMPLATE)S_LOW_ElevatorWorkroomInstance_567ef4ea-15f9-4bbd-885b-799ced777dd1); //load workroom instance of elevator
DB_LOW_SteelWatchFoundry_ElevatorTemplateToUnload(S_LOW_ElevatorLabInstance_cde6a60b-bf4c-4f64-ba22-3b4c112d5770);

PROC
PROC_LOW_SteelWatchFoundry_WorkroomElevatorDown()
AND
DB_InRegion(_Character, S_LOW_WorkroomElevatorZone_152eaa67-924a-4b25-bfff-5584fae9e576)
THEN
DB_LOW_SteelWatchFoundry_ElevatorTravellingCharacters(_Character);

PROC
PROC_LOW_SteelWatchFoundry_WorkroomElevatorDown()
THEN
LoadLevelTemplate(S_LOW_ElevatorLabInstance_cde6a60b-bf4c-4f64-ba22-3b4c112d5770); //load lab instance of elevator
DB_LOW_SteelWatchFoundry_ElevatorTemplateToUnload(S_LOW_ElevatorWorkroomInstance_567ef4ea-15f9-4bbd-885b-799ced777dd1);

//If This is called with no characters to teleport just do the template unloading instantly
PROC
PROC_LOW_SteelWatchFoundry_Elevator_TeleportCharactersTo((TRIGGER)_Trigger)
AND
NOT DB_LOW_SteelWatchFoundry_ElevatorTravellingCharacters(_)
AND
DB_LOW_SteelWatchFoundry_ElevatorTemplateToUnload(_Template)
THEN
UnloadLevelTemplate((LEVELTEMPLATE)_Template);
NOT DB_LOW_SteelWatchFoundry_ElevatorTemplateToUnload(_Template);

//If This is called with some characters to teleport, wait with onloading until the players have all been teleported
PROC
PROC_LOW_SteelWatchFoundry_Elevator_TeleportCharactersTo((TRIGGER)_Trigger)
AND
DB_LOW_SteelWatchFoundry_ElevatorTravellingCharacters(_Character)
THEN
NOT DB_LOW_SteelWatchFoundry_ElevatorTravellingCharacters(_Character);
TeleportTo(_Character, _Trigger, "LOW_SteelWatchFoundry_BigElevator_Teleported", 1, 1, 1, 1, 1);

//Once there are no more characters left to teleport, unload template
IF
EntityEvent(_, "LOW_SteelWatchFoundry_BigElevator_Teleported")
AND
NOT DB_LOW_SteelWatchFoundry_ElevatorTravellingCharacters(_)
AND
DB_LOW_SteelWatchFoundry_ElevatorTemplateToUnload(_Template)
THEN
UnloadLevelTemplate((LEVELTEMPLATE)_Template);
NOT DB_LOW_SteelWatchFoundry_ElevatorTemplateToUnload(_Template);



//Elevator instance on Lab floor
IF
UseFinished(_, BLD_Foundry_Elevator_A_Cage_A_000_ff5b397e-c5ac-4b0f-9bd7-b2416dc53f2d, 1)
THEN
PROC_LOW_SteelWatchFoundry_WorkroomElevatorUp();

//Elevator instance on Ground floor
IF
UseFinished(_, BLD_Foundry_Elevator_A_Cage_A_000_ff5b397e-c5ac-4b0f-9bd7-b2416dc53f2d, 1)
THEN
PROC_LOW_SteelWatchFoundry_WorkroomElevatorDown();

//Moving elevator from Bottom position to top position
PROC
PROC_LOW_SteelWatchFoundry_WorkroomElevatorUp()
AND
GetPosition(S_LOW_LabElevator_TopPos_295b07f4-84f6-4e15-9ee5-e7e8682f1d92, _X, _Y, _Z)
THEN
NOT DB_LOW_SteelWatchFoundry_WorkroomElevatorState("Down");
PlatformMoveTo(S_LOW_ElevatorLabInstance_cde6a60b-bf4c-4f64-ba22-3b4c112d5770, _X, _Y, _Z, 3.0, "LOW_SteelWatchFoundry_ElevatorMoved_Lab_UP", 1);

IF
PlatformMovementFinished(S_LOW_ElevatorLabInstance_cde6a60b-bf4c-4f64-ba22-3b4c112d5770, "LOW_SteelWatchFoundry_ElevatorMoved_Lab_UP")
AND
GetPosition(S_LOW_WorkroomElevatorUpPosition_9b1cc22f-92cc-4817-a45b-70d969193bda, _X, _Y, _Z)
THEN
PROC_LOW_SteelWatchFoundry_Elevator_TeleportCharactersTo((TRIGGER)S_LOW_WorkroomElevator_DownPos_81001eed-8e17-414a-814e-eaf043cb0841);
PlatformMoveTo((LEVELTEMPLATE)S_LOW_ElevatorWorkroomInstance_567ef4ea-15f9-4bbd-885b-799ced777dd1, _X, _Y, _Z, 3.0, "LOW_SteelWatchFoundry_ElevatorMoved_Workroom_UP", 1); //Start moving workroom instance

IF
PlatformMovementFinished(S_LOW_ElevatorWorkroomInstance_567ef4ea-15f9-4bbd-885b-799ced777dd1, "LOW_SteelWatchFoundry_ElevatorMoved_Workroom_UP") // workroom instance arrived up
THEN
DB_LOW_SteelWatchFoundry_WorkroomElevatorState("Up");
PROC_TriggerUnregisterForParty(S_LOW_WorkroomElevatorZone_152eaa67-924a-4b25-bfff-5584fae9e576);
RealtimeObjectTimerLaunch(S_LOW_WorkroomElevatorZone_152eaa67-924a-4b25-bfff-5584fae9e576, "LOW_SteelWatchFoundry_ReRegisterElevatorTrigger", 200);

//Delaying re-registering elevator trigger so the player will definitely have working collision again
IF
ObjectTimerFinished(_Trigger, "LOW_SteelWatchFoundry_ReRegisterElevatorTrigger")
THEN
PROC_TriggerRegisterForParty((TRIGGER)_Trigger); // this needed because otherwise the party is not registered entering the trigger when moving up with the elevator platform

IF
PlatformMovementFinished(S_LOW_ElevatorWorkroomInstance_567ef4ea-15f9-4bbd-885b-799ced777dd1, "LOW_SteelWatchFoundry_ElevatorMoved_Workroom_UP") //workroom instance arrived up
AND
QRY_OnlyOnce("LOW_SteelWatchFoundry_WorkroomElevator_FirsttimeUp")
THEN
Open((ITEM)S_LOW_ElevatorGate_41ee393f-0463-47e6-8751-e5073fbb9b75);


//Moving Elevator from top position to bottom position
PROC
PROC_LOW_SteelWatchFoundry_WorkroomElevatorDown()
AND
GetPosition(S_LOW_WorkroomElevator_DownPos_81001eed-8e17-414a-814e-eaf043cb0841, _X, _Y, _Z)
THEN
NOT DB_LOW_SteelWatchFoundry_WorkroomElevatorState("Up");
PlatformMoveTo(S_LOW_ElevatorWorkroomInstance_567ef4ea-15f9-4bbd-885b-799ced777dd1, _X, _Y, _Z, 3.0, "LOW_SteelWatchFoundry_ElevatorMoved_WorkRoom_Down", 1); //Start moving Workroom instance down

IF
PlatformMovementFinished(S_LOW_ElevatorWorkroomInstance_567ef4ea-15f9-4bbd-885b-799ced777dd1, "LOW_SteelWatchFoundry_ElevatorMoved_WorkRoom_Down")
AND
GetPosition(S_LOW_LabElevator_BottomPos_954d268e-8f20-4f32-9851-350771a3b4b1, _X, _Y, _Z)
THEN
PROC_LOW_SteelWatchFoundry_Elevator_TeleportCharactersTo((TRIGGER)S_LOW_LabElevator_TopPos_295b07f4-84f6-4e15-9ee5-e7e8682f1d92); //teleport players to lab room instance
PlatformMoveTo(S_LOW_ElevatorLabInstance_cde6a60b-bf4c-4f64-ba22-3b4c112d5770, _X, _Y, _Z, 3.0, "LOW_SteelWatchFoundry_ElevatorMoved_Lab_Down", 1);

IF
PlatformMovementFinished(S_LOW_ElevatorLabInstance_cde6a60b-bf4c-4f64-ba22-3b4c112d5770, "LOW_SteelWatchFoundry_ElevatorMoved_Lab_Down")
THEN
DB_LOW_SteelWatchFoundry_WorkroomElevatorState("Down");
PROC_TriggerUnregisterForParty(S_LOW_LabElevatorZone_79f50483-4256-4603-b948-1c80edf0029c);
RealtimeObjectTimerLaunch(S_LOW_LabElevatorZone_79f50483-4256-4603-b948-1c80edf0029c, "LOW_SteelWatchFoundry_ReRegisterElevatorTrigger", 200);

//Teleporting falling characters - this was messing with the elevator script, will leave it alone for now (It seems like jumping down is not possible currently anyway)
/*
IF
DB_InRegion(_Character, S_LOW_WorkroomElevator_Jumpzone_aaef3a0e-9030-455d-bbe6-c954648dbb2d)
AND
NOT DB_LOW_SteelWatchFoundry_ElevatorTravellingCharacters(_Character)
THEN
TeleportTo(_Character, S_LOW_LabElevator_TopPos_295b07f4-84f6-4e15-9ee5-e7e8682f1d92, "", 0, 0, 0, 1, 0);
*/
//END_REGION

//REGION Small Docks Cargo Elevator + Door
//Travelling UP on the elevator
IF
UseStarted(_, _Lever)
AND
DB_LOW_SteelWatchFoundry_SmallElevator_Levers(_Lever)
AND
NOT DB_LOW_SteelWatchFoundry_SmallCargoElevator_Moving(1)
AND
DB_LOW_SteelWatchFoundry_SmallElevator_State("Down")
THEN
PROC_LOW_SteelWatchFoundry_SmallCargoElevator_MoveUp();

//Travelling DOWN on the elevator
IF
UseStarted(_, _Lever)
AND
DB_LOW_SteelWatchFoundry_SmallElevator_Levers(_Lever)
AND
NOT DB_LOW_SteelWatchFoundry_SmallCargoElevator_Moving(1)
AND
DB_LOW_SteelWatchFoundry_SmallElevator_State("Up")
THEN
PROC_LOW_SteelWatchFoundry_SmallCargoElevator_MoveDown();

//Moving the elevator UP
PROC
PROC_LOW_SteelWatchFoundry_SmallCargoElevator_MoveUp()
AND
DB_LOW_SteelWatchFoundry_SmallElevator_Stations(_Trigger, _, "Up")
AND
GetPosition(_Trigger, _X, _Y, _Z)
THEN
PlatformMoveTo(LT_PLT_BGH_SteelWatchFoundry_CartElevator_a1294b2d-94fa-4cea-96dc-a6eeb5a4aed6, _X, _Y, _Z, 1.0, "LOW_SteelWatchFoundy_ElevatorUp", 1);
NOT DB_LOW_SteelWatchFoundry_SmallElevator_State("Down");
DB_LOW_SteelWatchFoundry_SmallCargoElevator_Moving(1);

IF
PlatformMovementFinished(_, "LOW_SteelWatchFoundy_ElevatorUp")
THEN
DB_LOW_SteelWatchFoundry_SmallElevator_State("Up");
NOT DB_LOW_SteelWatchFoundry_SmallCargoElevator_Moving(1);
Open(S_LOW_CargoDoor_3e11bdba-dd79-442d-9c6d-ce2059cb1307);

//Moving the elevator DOWN
PROC
PROC_LOW_SteelWatchFoundry_SmallCargoElevator_MoveDown()
AND
DB_LOW_SteelWatchFoundry_SmallElevator_Stations(_Trigger, _, "Down")
AND
GetPosition(_Trigger, _X, _Y, _Z)
THEN
PlatformMoveTo(LT_PLT_BGH_SteelWatchFoundry_CartElevator_a1294b2d-94fa-4cea-96dc-a6eeb5a4aed6, _X, _Y, _Z, 1.0, "LOW_SteelWatchFoundy_ElevatorDown", 1);
NOT DB_LOW_SteelWatchFoundry_SmallElevator_State("Up");
DB_LOW_SteelWatchFoundry_SmallCargoElevator_Moving(1);

IF
PlatformMovementFinished(_, "LOW_SteelWatchFoundy_ElevatorDown")
THEN
DB_LOW_SteelWatchFoundry_SmallElevator_State("Down");
NOT DB_LOW_SteelWatchFoundry_SmallCargoElevator_Moving(1);
//END_REGION

//REGION Toobin combat ADs
//If Toobin starts his turn with other Gondians in the combat alongside him
IF
TurnStarted(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
QRY_OnlyOnce_Reset("LOW_SteelWatchFoundry_FundangoEncouragement")
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b)
AND
DB_Is_InCombat(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, _ID)
AND
DB_Is_InCombat(_Gondian, _ID)
AND
DB_LOW_Gondians(_Gondian)
AND
_Gondian != S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d
AND
QRY_OnlyOnce("LOW_SteelWatchFoundry_FundangoEncouragement")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SteelWatchFoundry_AD_GondianLeaderEncouragement_95b76a29-f938-3288-b042-61a888cb97d1, S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
//END_REGION

//REGION Topical Greeting flag
IF
DB_SteelWatchFoundry_SUBTRiggers(_Trigger)
THEN
DB_TopicalGreetingEndCondition_LeaveTrigger((FLAG)TG_LOW_SteelWatchFoudnry_e3f0e162-243a-49b2-bd5f-a750d170fab0, (TRIGGER)_Trigger);

IF
EnteredTrigger(_Player, _Trigger)
AND
DB_Avatars(_Player)
AND
DB_SteelWatchFoundry_SUBTRiggers(_Trigger)
THEN
PROC_TopicalGreeting_UnlockTopic((FLAG)TG_LOW_SteelWatchFoundry_e3f0e162-243a-49b2-bd5f-a750d170fab0);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
