Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_LOW_SteelWatchFoundry_NetherstoneLooter((CHARACTER)S_LOW_NetherstoneLooter_001_5a3a4187-9752-4255-87c7-fa82625f3571,
    (TRIGGER)S_LOW_NetherstoneLooterStartPoint_001_b8c975ee-24af-4628-82b8-843d1dd0f6b3,
    (ITEM)S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d);
DB_LOW_SteelWatchFoundry_NetherstoneLooter((CHARACTER)S_LOW_NetherstoneLooter_002_5f3e5a84-4f8a-4b56-881f-6027ef93694c,
    (TRIGGER)S_LOW_NetherstoneLooterStartPoint_002_59f8c97f-826b-4857-8e58-c2c7f3932cd8,
    (ITEM)S_LOW_CrownController_Orin_360b0dfd-8e0b-48d2-a079-fcf68c104d6b);
DB_LOW_SteelWatchFoundry_NetherstoneLooter((CHARACTER)S_LOW_NetherstoneLooter_003_649ace0e-a231-491d-88e9-4680696a94d5,
    (TRIGGER)S_LOW_NetherstoneLooterStartPoint_003_68529cea-8ee9-4d1d-9fdc-84717924a32c,
    (ITEM)S_WYR_CrownController_Gortash_383be300-d328-4152-86df-4927482d1fd7);

SetOnStage(S_LOW_NetherstoneLooter_003_649ace0e-a231-491d-88e9-4680696a94d5, 0);
SetOnStage(S_LOW_NetherstoneLooter_002_5f3e5a84-4f8a-4b56-881f-6027ef93694c, 0);
SetOnStage(S_LOW_NetherstoneLooter_001_5a3a4187-9752-4255-87c7-fa82625f3571, 0);

SetOnStage(S_LOW_NetherstoneLooterMound_8f8da8f2-7b20-4a98-ba41-4365f979680d, 0);
SetOnStage(S_LOW_NetherstoneLooterHole_d8298f78-4908-499d-a4d6-feecb76da952, 0);

DB_LOW_SteelWatchFoundry_InteriorRegions((TRIGGER)S_LOW_FoundryGroundFloor_1a994e3a-d80d-478d-a452-b9100fdec719);
DB_LOW_SteelWatchFoundry_InteriorRegions((TRIGGER)S_LOW_SteelWatchFoundry_LabFloor_SUB_65a2f1d8-f8f9-41ae-b9b6-e561b6069af9);
DB_LOW_SteelWatchFoundry_InteriorRegions((TRIGGER)S_LOW_SteelWatchFoundry_ControlFloor_SUB_a77da59a-8e16-4d7c-8194-3ebaa89b6342);
KBSECTION
//REGION Stone Checks
PROC
PROC_GLO_EmperorPrelude_PlayerDroppedNetherstone(_Netherstone, _, "CTY_Main_A")
AND
DB_LOW_SteelWatchFoundry_InteriorRegions(_Trigger)
AND
IsInTrigger(_Netherstone, _Trigger, 1)
AND
NOT DB_LOW_SteelWatchFoundry_DroppedNetherstones(_Netherstone)
THEN
DB_LOW_SteelWatchFoundry_DroppedNetherstones(_Netherstone);

PROC
PROC_GLO_EmperorPrelude_PlayerDroppedNetherstone(_Netherstone, _, "CTY_Main_A")
AND
DB_LOW_SteelWatchFoundry_InteriorRegions(_Trigger)
AND
IsInTrigger(_Netherstone, _Trigger, 1)
AND
DB_GlobalFlag(GLO_EmperorPrelude_State_StoneInSteelWatchFoundry_52bd5ddf-3960-4679-adce-ca2e37d686d8)
AND
NOT DB_GlobalFlag(GLO_EmperorPrelude_State_MoreThanOneStoneInSteelWatchFoundry_57ce1660-5103-45b1-9a17-3f1d709eba3b)
THEN
SetFlag(GLO_EmperorPrelude_State_MoreThanOneStoneInSteelWatchFoundry_57ce1660-5103-45b1-9a17-3f1d709eba3b);

PROC
PROC_GLO_EmperorPrelude_PlayerDroppedNetherstone(_Netherstone, _, "CTY_Main_A")
AND
DB_LOW_SteelWatchFoundry_InteriorRegions(_Trigger)
AND
IsInTrigger(_Netherstone, _Trigger, 1)
AND
NOT DB_GlobalFlag(GLO_EmperorPrelude_State_StoneInSteelWatchFoundry_52bd5ddf-3960-4679-adce-ca2e37d686d8)
THEN
SetFlag(GLO_EmperorPrelude_State_StoneInSteelWatchFoundry_52bd5ddf-3960-4679-adce-ca2e37d686d8);

PROC
PROC_GLO_EmperorPrelude_PlayerPickedUpNetherstone(_Netherstone, _, _)
AND
NOT DB_GlobalFlag(LOW_NetherstoneLooters_State_NetherstonesWithLooters_fd4e9121-f50e-482e-a3d3-71e5b84514ef)
AND
DB_LOW_SteelWatchFoundry_DroppedNetherstones(_Netherstone)
THEN
NOT DB_LOW_SteelWatchFoundry_DroppedNetherstones(_Netherstone);

PROC
PROC_GLO_EmperorPrelude_PlayerPickedUpNetherstone(_Netherstone, _, _)
AND
QRY_GLO_EmperorPrelude_DroppedNetherstoneCount()
AND
DB_QRTN_GLO_EmperorPrelude_DroppedNetherstoneCount(_Count)
AND
_Count == 0
THEN
ClearFlag(GLO_EmperorPrelude_State_StoneInSteelWatchFoundry_52bd5ddf-3960-4679-adce-ca2e37d686d8);

PROC
PROC_GLO_EmperorPrelude_PlayerPickedUpNetherstone(_Netherstone, _, _)
AND
QRY_GLO_EmperorPrelude_DroppedNetherstoneCount()
AND
DB_QRTN_GLO_EmperorPrelude_DroppedNetherstoneCount(_Count)
AND
_Count <= 1
AND
DB_GlobalFlag(GLO_EmperorPrelude_State_MoreThanOneStoneInSteelWatchFoundry_57ce1660-5103-45b1-9a17-3f1d709eba3b)
THEN
ClearFlag(GLO_EmperorPrelude_State_MoreThanOneStoneInSteelWatchFoundry_57ce1660-5103-45b1-9a17-3f1d709eba3b);

//END_REGION

//REGION Looter Check & Setup
IF
FlagSet(LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a, _, _)
AND
DB_GlobalFlag(GLO_EmperorPrelude_State_StoneInSteelWatchFoundry_52bd5ddf-3960-4679-adce-ca2e37d686d8)
AND
NOT DB_GlobalFlag(LOW_NetherstoneLooters_State_NetherstonesWithLooters_fd4e9121-f50e-482e-a3d3-71e5b84514ef)
THEN
PROC_GlobalSetFlagAndCache(LOW_NetherstoneLooters_State_NetherstonesWithLooters_fd4e9121-f50e-482e-a3d3-71e5b84514ef);
PROC_LOW_SteelWatchFoundry_ReadyLooters();

PROC
PROC_LOW_SteelWatchFoundry_ReadyLooters()
THEN
SetOnStage(S_LOW_NetherstoneLooterMound_8f8da8f2-7b20-4a98-ba41-4365f979680d, 1);
SetOnStage(S_LOW_NetherstoneLooterHole_d8298f78-4908-499d-a4d6-feecb76da952, 1);

PROC
PROC_LOW_SteelWatchFoundry_ReadyLooters()
AND
DB_LOW_SteelWatchFoundry_NetherstoneLooter(_Char, _StartPoint, _)
THEN
PROC_AppearOutOfSightTo(_Char, _StartPoint, S_LOW_NetherstoneLooterAppearFromPoint_538633d6-7718-473f-8264-70c88fbff8ea, "LOW_NetherstoneLooter_Appeared");

PROC
PROC_LOW_SteelWatchFoundry_ReadyLooters()
AND
DB_LOW_SteelWatchFoundry_NetherstoneLooter(_Char, _, _Netherstone)
AND
DB_LOW_SteelWatchFoundry_DroppedNetherstones(_Netherstone)
THEN
ToInventory(_Netherstone, _Char, 1, 0, 0);
//END_REGION

//REGION Emperor ADs
IF
DB_LOW_SteelWatchFoundry_OutcomeDialogPlayerParticipants(_Player)
AND
DB_GlobalFlag(LOW_NetherstoneLooters_State_NetherstonesWithLooters_fd4e9121-f50e-482e-a3d3-71e5b84514ef)
AND
DB_Avatars((CHARACTER)_Player)
AND
NOT DB_CantAct(_Player)
AND
NOT DB_CantTalk(_Player)
THEN
PROC_EmperorAD(_Player, LOW_NetherstoneLooters_EmperorAD_SearchRubble_597e0394-ac04-0991-e0bb-f312b6280569);

IF
TurnStarted(_Avatar)
AND
DB_GlobalFlag(LOW_NetherstoneLooters_State_NetherstonesWithLooters_fd4e9121-f50e-482e-a3d3-71e5b84514ef)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
DB_LOW_SteelWatchFoundry_NetherstoneLooter((CHARACTER)_Char, _, _)
AND
DB_Is_InCombat(_Char, _ID)
AND
DB_Is_InCombat(_Avatar, _ID)
THEN
PROC_EmperorAD(_Avatar, LOW_NetherstoneLooters_EmperorAD_LootersSpotted_16ddd604-9e9e-5412-4752-8006c0f03f2e);


PROC
PROC_GLO_EmperorPrelude_PlayerPickedUpNetherstone((ITEM)_Netherstone, (CHARACTER)_Player, _)
AND
DB_GlobalFlag(LOW_NetherstoneLooters_State_NetherstonesWithLooters_fd4e9121-f50e-482e-a3d3-71e5b84514ef)
AND
DB_LOW_SteelWatchFoundry_DroppedNetherstones(_Netherstone)
THEN
NOT DB_LOW_SteelWatchFoundry_DroppedNetherstones(_Netherstone);
PROC_LOW_SteelWatchFoundry_CheckAllNetherstonesReceived((CHARACTER)_Player);

PROC
PROC_LOW_SteelWatchFoundry_CheckAllNetherstonesReceived((CHARACTER)_Player)
AND
NOT DB_LOW_SteelWatchFoundry_DroppedNetherstones(_)
THEN
ClearFlag(LOW_NetherstoneLooters_State_NetherstonesWithLooters_fd4e9121-f50e-482e-a3d3-71e5b84514ef);
ClearFlag(GLO_EmperorPrelude_State_StoneInSteelWatchFoundry_52bd5ddf-3960-4679-adce-ca2e37d686d8);
ClearFlag(GLO_EmperorPrelude_State_MoreThanOneStoneInSteelWatchFoundry_57ce1660-5103-45b1-9a17-3f1d709eba3b);
PROC_LOW_SteelWatchFoundry_NetherstonesCollectedEmperorAD((CHARACTER)_Player);

PROC
PROC_LOW_SteelWatchFoundry_NetherstonesCollectedEmperorAD((CHARACTER)_Player)
AND
DB_Avatars(_Avatar)
AND
GetDistanceTo(_Avatar, _Player, _Dist)
AND
_Dist <= 20.0
THEN
DB_LOW_SteelWatchFoundry_StonesBackEmperorADAvatar(_Avatar);

IF
DB_LOW_SteelWatchFoundry_StonesBackEmperorADAvatar(_Avatar)
AND
NOT DB_CantTalk(_Avatar)
AND
NOT DB_CantAct(_Avatar)
THEN
NOT DB_LOW_SteelWatchFoundry_StonesBackEmperorADAvatar(_Avatar);
PROC_EmperorAD(_Avatar, LOW_NetherstoneLooters_EmperorAD_StonesBack_8c1d3993-623b-c9bf-d8cd-ed9ea10ce559);

//END_REGION

//REGION Looter Escape
IF
EnteredCombat(_Char, _)
AND
DB_LOW_SteelWatchFoundry_NetherstoneLooter((CHARACTER)_Char, _, _)
THEN
SetFlag(LOW_NetherstoneLooters_State_Fleeing_f8835423-f465-4943-ab23-630f7313c104);

IF
FlagSet(LOW_NetherstoneLooters_State_Escaped_f8c6f21a-b7b5-4b28-911a-10d31136dedc, _Char, _)
AND
DB_LOW_SteelWatchFoundry_NetherstoneLooter((CHARACTER)_Char, _, _Netherstone)
THEN
PROC_LOW_SteelWatchFoundry_LooterEscape(_Char, _Netherstone);

PROC
PROC_LOW_SteelWatchFoundry_LooterEscape((CHARACTER)_Char, (ITEM)_Netherstone)
THEN
PROC_Poof(_Char);

PROC
PROC_LOW_SteelWatchFoundry_LooterEscape((CHARACTER)_Char, (ITEM)_Netherstone)
AND
DB_GLO_EmperorPrelude_NetherStoneTrackers(_Netherstone, _HasItemFlag, _, _, _, _)
AND
GetFlag(_HasItemFlag, _Char, 1)
AND
QRY_GLO_ThrallOfTheAbsolute_GetNearestTadpoledPlayer(_Char)
AND
DB_QRYRTN_GLO_ThrallOfTheAbsolute_NearestPlayer(_Player, _)
THEN
PROC_GLO_ThrallOfTheAbsolute_StartGenericGameOverDialog(_Player);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
