Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_DeadOnceFlag(S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8, LOW_AllandraGrey_State_DiedOnce_e953dd67-ea9c-47f8-b2c2-b77e8cbdf0cf);

//REGION Water Queen's House - Temple
DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_InjuredWaveservant_c3a7ec85-cb65-4ffe-b0a8-93789613039d, (DIALOGRESOURCE)LOW_WaterQueensHouse_HolliDylford_SpeakWithDead_efae856c-b0ae-482d-ca16-aa057689fa18);
DB_LOW_WaterQueensHouse_FuneralWaveservants((CHARACTER)S_LOW_Waveservant01_ab993a69-39be-47f4-9330-49d3e4958e12);
DB_LOW_WaterQueensHouse_FuneralWaveservants((CHARACTER)S_LOW_Waveservant02_f8b70d49-2ab7-4fcd-8203-aa7ae0fcd99c);
DB_LOW_WaterQueensHouse_FuneralWaveservants((CHARACTER)S_LOW_Waveservant03_eddd4c99-74bb-45d6-902b-f866f88e3f84);
DB_LOW_WaterQueensHouse_FuneralWaveservants((CHARACTER)S_LOW_Waveservant04_28327055-7f42-4374-a483-3fd296fa26f6);
DB_LOW_WaterQueensHouse_FuneralWaveservants((CHARACTER)S_LOW_Waveservant05_3995ac03-7410-468a-8b04-37d03409259d);
DB_LOW_WaterQueensHouse_FuneralWaveservants((CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8);

DB_Dialogs((CHARACTER)S_LOW_Waveservant01_ab993a69-39be-47f4-9330-49d3e4958e12, (DIALOGRESOURCE)LOW_WaterQueensHouse_Waveservant01_e27d8840-e903-0b67-1e59-efbc606ce420);
DB_Dialogs((CHARACTER)S_LOW_Waveservant02_f8b70d49-2ab7-4fcd-8203-aa7ae0fcd99c, (DIALOGRESOURCE)LOW_WaterQueensHouse_Waveservant02_f5b3ccb7-c524-e346-5911-7acb1b0d042d);
DB_Dialogs((CHARACTER)S_LOW_Waveservant03_eddd4c99-74bb-45d6-902b-f866f88e3f84, (DIALOGRESOURCE)LOW_WaterQueensHouse_Waveservant03_1400a480-5a26-d0df-cae2-79789c09b8d9);
DB_Dialogs((CHARACTER)S_LOW_Waveservant04_28327055-7f42-4374-a483-3fd296fa26f6, (DIALOGRESOURCE)LOW_WaterQueensHouse_Waveservant04_8fd8129e-079e-80b0-9ee8-b58ef3c6fb5a);
DB_Dialogs((CHARACTER)S_LOW_Waveservant05_3995ac03-7410-468a-8b04-37d03409259d, (DIALOGRESOURCE)LOW_WaterQueensHouse_Waveservant05_9fdcda45-2e54-ff52-766c-e0c030f7784a);
DB_Dialogs((CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8, (DIALOGRESOURCE)LOW_WaterQueensHouse_AllandraGrey_a6d65561-469f-e63f-a2a2-1c0c0ed8f43c);
DB_Dialogs((CHARACTER)S_LOW_ChattyWaveservant_532cb053-c2c0-4b9e-b388-70b037b657d9, (DIALOGRESOURCE)LOW_WaterQueensHouse_ChattyWaveservant_86c43b4a-a777-e350-8d65-a3faad3124d2);

DB_SpotPlayers((CHARACTER)S_LOW_ChattyWaveservant_532cb053-c2c0-4b9e-b388-70b037b657d9, "LOW_ChattyWaveservant_Spotted", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_ChattyWaveservant_532cb053-c2c0-4b9e-b388-70b037b657d9, "LOW_ChattyWaveservant_Spotted", (TRIGGER)S_LOW_WaterQueensHouse_TempleEntrance_71970a05-c352-441a-8284-f96f1d2ade0f);

TriggerRegisterForCharacter((TRIGGER)S_LOW_WaterQueensHouse_AltarArea_ab0a602d-cc99-4d9d-825c-7642790fba33, (CHARACTER)S_LOW_InjuredWaveservant_c3a7ec85-cb65-4ffe-b0a8-93789613039d);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_WaterQueensHouse_OfferingsArea_72d1ab2f-9060-4c5a-87b7-8556833c3531);

// Allandra office guards
DB_Dialogs(S_LOW_GuardWaveservant01_da84f4e2-8b4f-478e-b101-fa2865f6aa53, (DIALOGRESOURCE)LOW_WaterQueensHouse_GuardWaveservant01_29838a16-40b0-7fdd-5452-b5cefd82293a);
DB_Dialogs(S_LOW_GuardWaveservant02_3e0733be-8f92-415d-b437-b4d6ffd0799b, (DIALOGRESOURCE)LOW_WaterQueensHouse_GuardWaveservant02_2cc78131-bfb3-90aa-3205-10885f4541a0);

DB_TrespassTrigger((TRIGGER)S_LOW_WaterQueensHouse_AllandraOffice_TrespassTrigger_aff0f58f-da00-42cf-b942-9aeed53d4e2b, (TRIGGER)S_LOW_WaterQueensHouse_AllandraOffice_OutTrigger_9218ee3c-022d-47b8-bde6-4bfd967b8f87);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_WaterQueensHouse_AllandraOffice_WarningTrigger_55231671-51ba-433f-a63d-e4a4b808742a);

DB_SpotPlayers((CHARACTER)S_LOW_GuardWaveservant01_da84f4e2-8b4f-478e-b101-fa2865f6aa53, "LOW_GuardWaveservant_Spotted", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_GuardWaveservant01_da84f4e2-8b4f-478e-b101-fa2865f6aa53, "LOW_GuardWaveservant_Spotted", (TRIGGER)S_LOW_WaterQueensHouse_AllandraOffice_WarningTrigger_55231671-51ba-433f-a63d-e4a4b808742a);
DB_SpotPlayers_Continuous((CHARACTER)S_LOW_GuardWaveservant01_da84f4e2-8b4f-478e-b101-fa2865f6aa53, "LOW_GuardWaveservant_Spotted");

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Allandra_State_ShouldReward_bac0fae0-ac59-2d53-32b2-d97ce56ef868, (DIALOGRESOURCE)LOW_WaterQueensHouse_AllandraGrey_a6d65561-469f-e63f-a2a2-1c0c0ed8f43c);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Allandra_State_LeftFuneralAlone_f95d6ca2-8a3b-edbf-9742-077fa354cf07, (DIALOGRESOURCE)LOW_WaterQueensHouse_AllandraGrey_a6d65561-469f-e63f-a2a2-1c0c0ed8f43c);

//Umberlee followers
DB_Dialogs((CHARACTER)S_LOW_UmberleeFollower01_ab5e42b9-89bf-472d-bc3f-f6f67186b5e4, (DIALOGRESOURCE)LOW_WaterQueensHouse_UmberleeFollower01_03b18a84-cff3-dc05-d22a-51142acb21e0);
DB_Dialogs((CHARACTER)S_LOW_UmberleeFollower02_9810e336-465c-4aae-abcd-be20f4294c5c, (DIALOGRESOURCE)LOW_WaterQueensHouse_UmberleeFollower02_7e8c765b-96b3-7707-b19d-848940e59b4a);
DB_Dialogs((CHARACTER)S_LOW_UmberleeFollower03_dd45c45b-a2df-4d93-8756-46d7d6da0996, (DIALOGRESOURCE)LOW_WaterQueensHouse_UmberleeFollower03_929b82af-89b6-9af9-fba5-e8fb91a963e7);
DB_Dialogs((CHARACTER)S_LOW_UmberleeFollower04_ba52a7af-885a-4298-9fe1-32bc8c67cc8a, (DIALOGRESOURCE)LOW_WaterQueensHouse_UmberleeFollower04_56f86759-5bb8-6f32-f602-d08e1a4aa1b5);


DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_Waveservant01_ab993a69-39be-47f4-9330-49d3e4958e12);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_Waveservant02_f8b70d49-2ab7-4fcd-8203-aa7ae0fcd99c);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_Waveservant03_eddd4c99-74bb-45d6-902b-f866f88e3f84);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_Waveservant04_28327055-7f42-4374-a483-3fd296fa26f6);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_Waveservant05_3995ac03-7410-468a-8b04-37d03409259d);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_Waveservant06_b4e6e0fb-43e8-4656-bbba-9a9b78fe733c);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_KitchenWaveservant01_582e2859-3602-4243-b7ec-c7d51d9c3b4a);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_KitchenWaveservant02_1b06ea64-c030-4cbf-a870-a41e8adae30c);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_GuardWaveservant01_da84f4e2-8b4f-478e-b101-fa2865f6aa53);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_GuardWaveservant02_3e0733be-8f92-415d-b437-b4d6ffd0799b);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_GuardWaveservant03_cd6cb468-b077-48d0-a7e1-1e3758466d5f);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_VaultGuardWaveservant01_8f087672-72c6-4bfb-a10c-e15182a012e4);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_VaultGuardWaveservant02_e76f27c5-0799-472c-a6a0-9d7e714d0114);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_VaultGuardWaveservant03_f362518e-a204-48b5-8400-f8e61e9323aa);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_ChattyWaveservant_532cb053-c2c0-4b9e-b388-70b037b657d9);
DB_LOW_WaterQueensHouse_AllWaveservants((CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8);

DB_LOW_WaterQueensHouse_UmberleeFollowers((CHARACTER)S_LOW_UmberleeFollower01_ab5e42b9-89bf-472d-bc3f-f6f67186b5e4);
DB_LOW_WaterQueensHouse_UmberleeFollowers((CHARACTER)S_LOW_UmberleeFollower02_9810e336-465c-4aae-abcd-be20f4294c5c);
DB_LOW_WaterQueensHouse_UmberleeFollowers((CHARACTER)S_LOW_UmberleeFollower03_dd45c45b-a2df-4d93-8756-46d7d6da0996);
DB_LOW_WaterQueensHouse_UmberleeFollowers((CHARACTER)S_LOW_UmberleeFollower04_ba52a7af-885a-4298-9fe1-32bc8c67cc8a);

NOT DB_LOW_WaterQueensHouse_ADPlayedInWaveservantCombat(NULL_00000000-0000-0000-0000-000000000000);

DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_WaterQueensHouse_AllandraGrey_a6d65561-469f-e63f-a2a2-1c0c0ed8f43c, 500);

DB_LOW_WaterQueensHouse_WaveservantAttackersReturn((CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8, (TRIGGER)S_LOW_Allandra_OfficeSpot_49174aa3-b7d3-477d-956b-fdfcb6a7cbaf);
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn((CHARACTER)S_LOW_Waveservant01_ab993a69-39be-47f4-9330-49d3e4958e12, (TRIGGER)S_LOW_Waveservant01_EndFuneralSpot_fed3865c-3e49-4c7b-a602-b9a6096a98a3);
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn((CHARACTER)S_LOW_Waveservant02_f8b70d49-2ab7-4fcd-8203-aa7ae0fcd99c, (TRIGGER)S_LOW_Waveservant02_EndFuneralSpot_cb2f7d09-502f-42b4-8368-9eeff3ebc950);
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn((CHARACTER)S_LOW_Waveservant03_eddd4c99-74bb-45d6-902b-f866f88e3f84, (TRIGGER)S_LOW_Waveservant03_EndFuneralSpot_d1191a87-a191-4790-8e60-ed644b9dc65e);
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn((CHARACTER)S_LOW_Waveservant04_28327055-7f42-4374-a483-3fd296fa26f6, (TRIGGER)S_LOW_Waveservant04_EndFuneralSpot_ae2644a2-cf38-4e0c-b4d7-231374ec8546);
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn((CHARACTER)S_LOW_Waveservant05_3995ac03-7410-468a-8b04-37d03409259d, (TRIGGER)S_LOW_Waveservant05_EndFuneralSpot_b0554ed3-4da4-4bd4-bbb4-ae6321f1e186);
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn((CHARACTER)S_LOW_Waveservant06_b4e6e0fb-43e8-4656-bbba-9a9b78fe733c, (TRIGGER)S_LOW_WaterQueensHouse_CeremonyGuardDefaultPos_a4e1eeed-7d7a-4ee7-8aa7-1515b9e3c868);

TriggerRegisterForItems(S_LOW_WaterQueensHouse_OfferingsZone_5c337e89-7408-45e6-9258-d53e0ba157dd);
//END_REGION

//REGION Water Queen's House - Offering's Vault

// Sahuagin squad
DB_LOW_WaterQueensHouse_SahuaginGuards((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Ranged_01_e485524c-93cc-45a7-b9eb-391f6487a0c1);
DB_LOW_WaterQueensHouse_SahuaginGuards((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Ranged_02_afae64ae-6159-4a53-9f7b-9fd0568af861);
DB_LOW_WaterQueensHouse_SahuaginGuards((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Ranged_03_f3608ec0-5062-4465-9416-d8592a090959);
DB_LOW_WaterQueensHouse_SahuaginGuards((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Champion_01_ce373e0a-6a9f-4eac-a139-65940f1670b8);
DB_LOW_WaterQueensHouse_SahuaginGuards((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Champion_02_f51152f7-de84-4a1c-827d-b9c7ab9bb8da);

DB_GLO_DefeatCounter((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Ranged_01_e485524c-93cc-45a7-b9eb-391f6487a0c1, "LOW_WaterQueensHouse_Sahuagins");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Ranged_02_afae64ae-6159-4a53-9f7b-9fd0568af861, "LOW_WaterQueensHouse_Sahuagins");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Ranged_03_f3608ec0-5062-4465-9416-d8592a090959,  "LOW_WaterQueensHouse_Sahuagins");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Champion_01_ce373e0a-6a9f-4eac-a139-65940f1670b8, "LOW_WaterQueensHouse_Sahuagins");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_WaterQueensHouse_Sahuagin_Champion_02_f51152f7-de84-4a1c-827d-b9c7ab9bb8da,  "LOW_WaterQueensHouse_Sahuagins");
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_WaterQueensHouse_Sahuagins", (FLAG)LOW_WaterQueensHouse_State_SahuaginsDefeated_18e24f32-57d8-5e56-34bf-1fe12b437748);

DB_Dialogs((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, (DIALOGRESOURCE)LOW_WaterQueensHouse_VaultWaveservant_680757f8-dc47-4fa3-14aa-e30280999c85);

DB_TrespassTrigger((TRIGGER)S_LOW_WaterQueensHouse_Vault_TrespassTrigger_875881bf-099b-4d66-8c14-ef846985138d, (TRIGGER)S_LOW_WaterQueensHouse_Vault_OutTrigger_45aa6e9d-de67-43eb-8747-eb9a82684140);
DB_CRIME_TrespassNoPermanentAccess((TRIGGER)S_LOW_WaterQueensHouse_Vault_TrespassTrigger_875881bf-099b-4d66-8c14-ef846985138d);

// Warning before getting into trespassing area
DB_Dialogs((CHARACTER)S_LOW_CellarWaveservant01_eb2f1d87-9d15-45bc-8899-15415c6cf6d2, (DIALOGRESOURCE)LOW_WaterQueensHouse_CellarWaveservant01_fd83674a-a0eb-5fdc-9040-2d353dfbe730);
DB_Dialogs((CHARACTER)S_LOW_CellarWaveservant02_22aaad49-98de-43a2-ab2f-c7ab9a8df922, (DIALOGRESOURCE)LOW_WaterQueensHouse_CellarWaveservant02_d5a3e493-8700-e717-e53d-87291307bf92);
/*
DB_SpotPlayers((CHARACTER)S_LOW_CellarWaveservant01_eb2f1d87-9d15-45bc-8899-15415c6cf6d2, "LOW_CellarWaveservant_Spotted", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_CellarWaveservant01_eb2f1d87-9d15-45bc-8899-15415c6cf6d2, "LOW_CellarWaveservant_Spotted", (TRIGGER)S_LOW_WaterQueensHouse_EntranceToGuardRoom_25f254e2-7641-4bc5-9a5e-ccf0ece99288);
DB_SpotPlayers_Continuous((CHARACTER)S_LOW_CellarWaveservant01_eb2f1d87-9d15-45bc-8899-15415c6cf6d2, "LOW_CellarWaveservant_Spotted");
*/

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_WaterQueensHouse_Event_SahuaginsCalled_19f987b3-2cb9-6391-3069-8757f5580371, (DIALOGRESOURCE)LOW_WaterQueensHouse_VaultWaveservant_Spotted_28b57829-ff1d-99fa-8636-e6a807c3ac4c);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_WaterQueensHouse_Event_SahuaginsCalled_19f987b3-2cb9-6391-3069-8757f5580371, (DIALOGRESOURCE)LOW_WaterQueensHouse_VaultWaveservant_CallForHelp_9cf95ed5-6cb4-1202-c6f3-7c5411e1e895);

DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_WaterQueensHouse_OfferingsVaultArea_8bfa4c21-5289-4a79-a6de-2b1aa2d5dc81, (CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8);

PROC_SetOnStage(S_LOW_Umberlee_InvisibleHelper_66ee6a2e-4b53-4ff0-897d-ada81470eb07, 0);

DB_LOW_WaterQueensHouse_UnderUmberleeProtection((ITEM)S_LOW_WaterQueensHouse_OfferingsPile_30fe6e14-ac7f-49cc-814d-fe0f79b2ecd4);

//SUB triggers for WQH: need them for activating Vault Waveservant
DB_LOW_WaterQueensHouse_LevelAreas((TRIGGER)S_LOW_WaterQueensHouse_SUB_d94bfab1-46de-404a-998d-1c5b605a4013);
DB_LOW_WaterQueensHouse_LevelAreas((TRIGGER)S_LOW_WaterQueensHouse_Cellar_SUB_b2045d8e-d41b-4ccb-898d-eb453aeece39);

//END_REGION

//REGION Water Queen's House - inhabitants
DB_Dialogs((CHARACTER)S_LOW_KitchenWaveservant01_582e2859-3602-4243-b7ec-c7d51d9c3b4a, (DIALOGRESOURCE)LOW_WaterQueensHouse_KitchenWaveservant01_254a5be4-1efc-cae0-82db-790be4ba5da8);
DB_Dialogs((CHARACTER)S_LOW_KitchenWaveservant02_1b06ea64-c030-4cbf-a870-a41e8adae30c, (DIALOGRESOURCE)LOW_WaterQueensHouse_KitchenWaveservant02_d693c98c-6362-e7b5-1df3-e3aeebf4642d);
DB_Dialogs((CHARACTER)S_LOW_Waveservant06_b4e6e0fb-43e8-4656-bbba-9a9b78fe733c, (DIALOGRESOURCE)LOW_WaterQueensHouse_Waveservant06_20af5583-f7a1-434c-9c0e-3afc9645d743);
DB_Dialogs((CHARACTER)S_LOW_GuardWaveservant03_cd6cb468-b077-48d0-a7e1-1e3758466d5f, (DIALOGRESOURCE)LOW_WaterQueensHouse_GuardWaveservant03_25d3377d-a330-e21f-c91e-57bf8daa030e);

DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_WaterQueensHouse_CrimeRegion_b8e22721-06da-4db8-a2cc-114a827a498b, (CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8);
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_WaterQueensHouse_AllandraOffice_TrespassTrigger_aff0f58f-da00-42cf-b942-9aeed53d4e2b, (CHARACTER)S_LOW_GuardWaveservant02_3e0733be-8f92-415d-b437-b4d6ffd0799b);
//END_REGION

//REGION LOW_AvengeWaveservant journal

DB_QuestDef_State((FLAG)LOW_Allandra_State_AcceptedQuest_d0f4ea27-21a9-b8e9-f799-de5de71d441e, "LOW_AvengeWaveservant", "AcceptedQuest");
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BellyOfTheBeast_Knows_DockWarehouse_6bd387d4-18e5-55f1-9027-3d55a5065e3a, "LOW_AvengeWaveservant", "TalkedToFisherman", 0, (FLAG)LOW_BellyOfTheBeast_State_TalkedToBeastmaster_6081a34a-dd2e-7830-fe29-acc57a233c71);

DB_QuestDef_State((FLAG)LOW_BellyOfTheBeast_State_TalkedToBeastmaster_6081a34a-dd2e-7830-fe29-acc57a233c71, "LOW_AvengeWaveservant", "TalkedBeastmaster");
DB_QuestDef_State((FLAG)LOW_BellyOfTheBeast_Knows_BeastmasterNickedWaveservant_c49ce176-a882-8148-22a2-0376785d5ce5, "LOW_AvengeWaveservant", "TalkedBeastmaster_NickedWaveservant");

DB_QuestDef_State((FLAG)LOW_BellyOfTheBeast_State_SubmersibleReadyToDepart_a2ae474a-de65-4fde-b019-b1fdb6306acb, "LOW_AvengeWaveservant", "MadeDealWithBeastmaster");

DB_QuestDef_PermaDefeatedState("LOW_AvengeWaveservant", "KilledBeastmasterInTime", (CHARACTER)S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1);

DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BellyOfTheBeast_State_ReportedBeastmasterDead_43dd5530-e74f-48fa-aeb1-43cbb8bbb7d6, "LOW_AvengeWaveservant", "ReturnedToAllandra", 0, (FLAG)LOW_BellyOfTheBeast_State_WaveservantsInAmbush_b5d448d1-36c9-4deb-8426-45c0fa67f9d1);

DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BellyOfTheBeast_Event_WaveservantsTurnHostile_75616c87-a135-430a-870c-fbbec5951736, "LOW_AvengeWaveservant", "TurnedTheTide", 0, (FLAG)LOW_Beastmaster_State_PermaDefeated_6c6850e9-79b5-4a6d-85d4-ae6e3dd36523);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BellyOfTheBeast_Event_WaveservantsTurnHostile_75616c87-a135-430a-870c-fbbec5951736, "LOW_AvengeWaveservant", "TurnedTheTide_WithoutBeastmaster", 1, (FLAG)LOW_Beastmaster_State_PermaDefeated_6c6850e9-79b5-4a6d-85d4-ae6e3dd36523);
DB_QuestDef_State((FLAG)LOW_BellyOfTheBeast_Event_BeastmasterLeavesWithWaveservants_774fdae4-a02e-4a03-a820-0edf8e316cc6, "LOW_AvengeWaveservant", "GaveBeastmasterToAllandra");

DB_QuestDef_DefeatedState("LOW_AvengeWaveservant", "DefeatedAllandra", (CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8);

DB_QuestDef_State((FLAG)LOW_BellyOfTheBeast_State_ReceivedBeastmasterReward_56151303-0c59-4846-b865-89727bf7b1ff, "LOW_AvengeWaveservant", "HelpedBeastmaster");

DB_QuestDef_State((FLAG)LOW_DockWareHouse_State_ReadResignationLetter_e55051c0-1b34-444a-8247-12208ef5be27, "LOW_AvengeWaveservant", "FoundBeastMastersLetter");
DB_QuestDef_State((FLAG)LOW_DockWareHouse_State_ReadResignationLetter_WithRavengard_a65a0874-9c21-47af-879d-9cf27474b634, "LOW_AvengeWaveservant", "FoundBeastMastersLetter");

DB_QuestDef_State((FLAG)LOW_WaterQueensHouse_State_ToldAllandraBeastmasterGone_f1b6efee-4870-4aa0-b345-2dbf7057a001, "LOW_AvengeWaveservant", "ToldAllandraBeastGone");
//END_REGION
KBSECTION
//REGION DEBUG
IF
TextEvent("oe low_waterqueencombat")
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_WaterQueensHouse_Waveservants_65b74fbb-f418-4ed4-8681-c396c54dfc5d, 0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_WaterQueensHouse_WaveservantGuards_7a21202c-678b-403b-9d4b-5fc14a5f545f, 0);
//END_REGION

//REGION Water Queen's House - Temple
// If a player tries to loot the corpse (we still think that a player wants to interact with a body)
PROC
PROC_BlockLootCorpse(_Player, (CHARACTER)S_LOW_InjuredWaveservant_c3a7ec85-cb65-4ffe-b0a8-93789613039d)
AND
NOT DB_GlobalFlag((FLAG)LOW_Allandra_State_AcceptedQuest_d0f4ea27-21a9-b8e9-f799-de5de71d441e)
AND
DB_LOW_WaterQueensHouse_FuneralWaveservants(_Waveservant)
AND 
DB_Sees(_Waveservant, _Player)
AND
NOT DB_LOW_WaterQueensHouse_InterruptsFuneral(_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Waveservant, _Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_WaterQueensHouse_StopInterruptingFuneral_f5f3a335-6d39-0578-d172-22ef5870f6cf, _Waveservant, _Player)
THEN
DB_LOW_WaterQueensHouse_InterruptsFuneral(_Player);
DB_CustomLootCorpseResponse(_Player, (CHARACTER)S_LOW_InjuredWaveservant_c3a7ec85-cb65-4ffe-b0a8-93789613039d, 0);


// As we don't actually start the interaction, a player can try to interact again while one character is speaking to a waveservant. 
// But initially there are 4 other waveservants that can stop a player from doing that
// With DB_LOW_WaterQueensHouse_InterruptsFuneral I make sure that for each character it happens only once 
IF
DialogEnded((DIALOGRESOURCE)LOW_WaterQueensHouse_StopInterruptingFuneral_f5f3a335-6d39-0578-d172-22ef5870f6cf, _ID)
AND
DB_DialogPlayers(_ID, _Player, _)
THEN
NOT DB_LOW_WaterQueensHouse_InterruptsFuneral((CHARACTER)_Player);


// Adding another speaker in Speak With Dead dialogue, so we'll be able to interrupt the dialogue with a better flow (without closing one dialogue and starting another)
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_WaterQueensHouse_HolliDylford_SpeakWithDead_efae856c-b0ae-482d-ca16-aa057689fa18, _ID)
AND
NOT DB_GlobalFlag((FLAG)LOW_Allandra_State_AcceptedQuest_d0f4ea27-21a9-b8e9-f799-de5de71d441e)
AND
DialogGetInvolvedPlayer(_ID, 1, _Player)
AND
QRY_OnlyOnce_Reset("LOW_WaterQueensHouse_WaveservantSpeakerAdded")
AND
DB_LOW_WaterQueensHouse_FuneralWaveservants(_Waveservant)
AND 
DB_Sees(_Waveservant, (CHARACTER)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Waveservant, _Player)
AND
QRY_OnlyOnce("LOW_WaterQueensHouse_WaveservantSpeakerAdded")
THEN
PROC_DialogAddSpeakingActor(_ID, _Waveservant);
DB_LOW_WaterQueensHouse_ShouldClearCorpseTag(1);


IF
DialogEnded((DIALOGRESOURCE)LOW_WaterQueensHouse_HolliDylford_SpeakWithDead_efae856c-b0ae-482d-ca16-aa057689fa18, _ID)
AND
DB_LOW_WaterQueensHouse_ShouldClearCorpseTag(1)
THEN
ClearTag((CHARACTER)S_LOW_InjuredWaveservant_c3a7ec85-cb65-4ffe-b0a8-93789613039d, (TAG)CORPSE_SPOKEN_249ba319-6652-47ec-9f31-ef5be55429c3);
NOT DB_LOW_WaterQueensHouse_ShouldClearCorpseTag(1);

IF 
DB_GlobalFlag((FLAG)LOW_Allandra_State_AcceptedQuest_d0f4ea27-21a9-b8e9-f799-de5de71d441e)
THEN
PROC_ClearCorpseOwner(S_LOW_InjuredWaveservant_c3a7ec85-cb65-4ffe-b0a8-93789613039d);


// Using this in a dialogue with a chatty waveservant: if a character knows that there's a funeral going on, no reason to ask what's happening there
IF
Saw(_Player, (CHARACTER)S_LOW_InjuredWaveservant_c3a7ec85-cb65-4ffe-b0a8-93789613039d, 0)
AND 
DB_Players(_Player)
THEN
SetFlag((FLAG)LOW_WaterQueensHouse_Knows_WaveservantMurdered_6491f392-7f96-d9be-3203-4149c453f6aa, NULL_00000000-0000-0000-0000-000000000000);

IF
LeftTrigger((CHARACTER)S_LOW_InjuredWaveservant_c3a7ec85-cb65-4ffe-b0a8-93789613039d, (TRIGGER)S_LOW_WaterQueensHouse_AltarArea_ab0a602d-cc99-4d9d-825c-7642790fba33)
AND
QRY_TryStopDialogFor((CHARACTER)S_LOW_InjuredWaveservant_c3a7ec85-cb65-4ffe-b0a8-93789613039d)
THEN
DB_NOOP(1);


// Chatty waveservant meets characters
PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_LOW_ChattyWaveservant_532cb053-c2c0-4b9e-b388-70b037b657d9, "LOW_ChattyWaveservant_Spotted", _Player)
AND
QRY_OnlyOnce("LOW_ChattyWaveservant_Spotted")
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_LOW_ChattyWaveservant_532cb053-c2c0-4b9e-b388-70b037b657d9, _Player)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_WaterQueensHouse_ChattyWaveservant_86c43b4a-a777-e350-8d65-a3faad3124d2, S_LOW_ChattyWaveservant_532cb053-c2c0-4b9e-b388-70b037b657d9, _Player)
THEN
DB_NOOP(1);


// Allandra office trespassing
PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_LOW_GuardWaveservant01_da84f4e2-8b4f-478e-b101-fa2865f6aa53, "LOW_GuardWaveservant_Spotted", _Player)
AND
GetFlag((FLAG)LOW_WaterQueensHouse_SpottedBy_GuardWaveservant01_759a0dc7-eaca-3e0b-e96a-7690e63e670c, _Player, 0)
AND
QRY_SpeakerIsAvailable((CHARACTER)S_LOW_GuardWaveservant01_da84f4e2-8b4f-478e-b101-fa2865f6aa53)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_WaterQueensHouse_GuardWaveservant01_29838a16-40b0-7fdd-5452-b5cefd82293a, (CHARACTER)S_LOW_GuardWaveservant01_da84f4e2-8b4f-478e-b101-fa2865f6aa53, _Player)
THEN
SetFlag((FLAG)LOW_WaterQueensHouse_SpottedBy_GuardWaveservant01_759a0dc7-eaca-3e0b-e96a-7690e63e670c, _Player);


IF
DB_GlobalFlag((FLAG)LOW_Allandra_State_InTheOffice_1424cc12-592a-4961-b482-177e69108bbd)
THEN
PROC_RemoveDBTrespassTrigger((TRIGGER)S_LOW_WaterQueensHouse_AllandraOffice_TrespassTrigger_aff0f58f-da00-42cf-b942-9aeed53d4e2b);


//Automated dialogs
IF
DialogEnded((DIALOGRESOURCE)LOW_WaterQueensHouse_ChattyWaveservant_86c43b4a-a777-e350-8d65-a3faad3124d2, _)
AND
QRY_OnlyOnce("LOW_UmberleeFollowers_OfferingsChat")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_WaterQueensHouse_AD_UmberleeFollowersChat_5d74eca8-66e5-29d3-0592-7524c20d3920, S_LOW_UmberleeFollower01_ab5e42b9-89bf-472d-bc3f-f6f67186b5e4, S_LOW_UmberleeFollower04_ba52a7af-885a-4298-9fe1-32bc8c67cc8a);


IF
DB_Players(_Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_WaterQueensHouse_OfferingsArea_72d1ab2f-9060-4c5a-87b7-8556833c3531)
AND
QRY_OnlyOnce("LOW_Waveservants_OfferingsChestChat")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_WaterQueensHouse_AD_OfferingsChat_d8825c95-10fc-6916-b370-683dd2bafe50, S_LOW_GuardWaveservant03_cd6cb468-b077-48d0-a7e1-1e3758466d5f, S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91);

// Umberlee Followers flee the temple
IF
DB_Sees(_Follower, _Waveservant)
AND
DB_LOW_WaterQueensHouse_UmberleeFollowers(_Follower)
AND
DB_LOW_WaterQueensHouse_AllWaveservants(_Waveservant)
AND
DB_Dead(_Waveservant)
THEN
PROC_WaterQueensHouse_UmberleeFollowersFlee();

PROC
PROC_WaterQueensHouse_UmberleeFollowersFlee()
AND
DB_LOW_WaterQueensHouse_UmberleeFollowers((CHARACTER)_Follower)
THEN
PROC_DisappearOutOfSightTo(_Follower, S_LOW_WaterQueensHouse_TempleEntrance_71970a05-c352-441a-8284-f96f1d2ade0f, "Run", 0,"");

//END_REGION

//REGION End Funeral state

PROC
PROC_StateSet_PermaDefeated(S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8)
THEN
PROC_LOW_WaterQueensHouse_EndFuneral();

IF
FlagSet((FLAG)LOW_BellyOfTheBeast_State_ReportedBeastmasterDead_43dd5530-e74f-48fa-aeb1-43cbb8bbb7d6,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_WaterQueensHouse_State_FuneralEnded_cebde540-6e92-ea5d-2187-c40eb9f5f95f)
THEN
PROC_LOW_WaterQueensHouse_EndFuneral();

PROC
PROC_LOW_WaterQueensHouse_EndFuneral()
AND
QRY_OnlyOnce("LOW_WaterQueensHouse_StopSinging")
THEN
TriggerSetSoundState((TRIGGER)SV_QueenHouse_Temple_e0f1094b-8952-450a-b76d-b512fb59c1a8, "SE_CTY_WaterQueensHouse_Funeral", "Funeral_Over", 1);

PROC
PROC_LOW_WaterQueensHouse_EndFuneral()
THEN
SetFlag((FLAG)LOW_WaterQueensHouse_State_FuneralEnded_cebde540-6e92-ea5d-2187-c40eb9f5f95f);

PROC
PROC_LOW_WaterQueensHouse_ShouldReturnFromIronThrone()
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)S_LOW_WaterQueensHouse_SUB_d94bfab1-46de-404a-998d-1c5b605a4013)
THEN
PROC_LOW_WaterQueensHouse_ReturnFromIronThrone();

PROC
PROC_LOW_WaterQueensHouse_ShouldReturnFromIronThrone()
AND
QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)S_LOW_WaterQueensHouse_SUB_d94bfab1-46de-404a-998d-1c5b605a4013)
THEN
DB_LOW_WaterQueensHouse_ShouldReturnFromIronThrone(1);

IF
LeftTrigger(_Player, (TRIGGER)S_LOW_WaterQueensHouse_SUB_d94bfab1-46de-404a-998d-1c5b605a4013)
AND
DB_LOW_WaterQueensHouse_ShouldReturnFromIronThrone(1)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger((TRIGGER)S_LOW_WaterQueensHouse_SUB_d94bfab1-46de-404a-998d-1c5b605a4013)
THEN
PROC_LOW_WaterQueensHouse_ReturnFromIronThrone();
NOT DB_LOW_WaterQueensHouse_ShouldReturnFromIronThrone(1);

PROC
PROC_LOW_WaterQueensHouse_ReturnFromIronThrone()
AND
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn(_Waveservant, _Spot)
AND
NOT DB_PermaDefeated(_Waveservant)
THEN
PurgeOsirisQueue(_Waveservant);
SetFaction(_Waveservant, (FACTION)ACT3_LOW_WaterQueensHouse_Waveservants_65b74fbb-f418-4ed4-8681-c396c54dfc5d);
SetCombatGroupID(_Waveservant, "738f3f72-fe83-fee1-6ff5-ea36126d2bed");
TeleportTo(_Waveservant, _Spot);
PROC_SetOnStage(_Waveservant, 1);

PROC
PROC_LOW_WaterQueensHouse_ReturnFromIronThrone()
THEN
DB_Dialogs((CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8, (DIALOGRESOURCE)LOW_WaterQueensHouse_AllandraGrey_a6d65561-469f-e63f-a2a2-1c0c0ed8f43c);
SetFlag((FLAG)LOW_WaterQueensHouse_State_ReturnedFromIronThrone_e20263a4-359c-4454-aa07-76823cdbfe5e);
PROC_RemoveDBTrespassTrigger((TRIGGER)S_LOW_WaterQueensHouse_AllandraOffice_TrespassTrigger_aff0f58f-da00-42cf-b942-9aeed53d4e2b);
PROC_SpotPlayers_StopSpotting("LOW_GuardWaveservant_Spotted");

PROC
PROC_LOW_WaterQueensHouse_ReturnFromIronThrone()
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_Event_WaveservantsTurnHostile_75616c87-a135-430a-870c-fbbec5951736)
AND
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn(_Waveservant, _Spot)
AND
NOT DB_PermaDefeated(_Waveservant)
AND
QRY_OnlyOnce("LOW_WaterQueensHouse_WaveservantsBack")
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_WaterQueensHouse_Waveservants_65b74fbb-f418-4ed4-8681-c396c54dfc5d, 0);

PROC
PROC_LOW_WaterQueensHouse_ReturnFromIronThrone()
AND
NOT DB_PermaDefeated(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1)
THEN
PROC_SetOnStage(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, 1);
TeleportTo(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, S_LOW_WaterQueensHouse_DeadBeastmasterSpot_bf308eff-94ff-4afa-9883-dc70e798ff3b);
Die(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, DEATHTYPE.Cold, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 0.0);


//END_REGION

//REGION Offering's Vault

IF
DB_LOW_WaterQueensHouse_SahuaginGuards(_Sahuagin)
THEN
PROC_SetOnStage(_Sahuagin, 0);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_WaterQueensHouse_Event_SahuaginsCalled_19f987b3-2cb9-6391-3069-8757f5580371)
THEN
PROC_LOW_WaterQueensHouse_CallSahuagins();
SetCombatGroupID(S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, "d275440c-fcfa-5e8b-da4c-75aa5c8f1bf3");

PROC
PROC_LOW_WaterQueensHouse_CallSahuagins()
AND
DB_LOW_WaterQueensHouse_SahuaginGuards(_Sahuagin)
THEN
PROC_Foop(_Sahuagin, VFX_Script_IRN_ReinforcementsMarker_Spawn_01_39e95fda-abf8-380e-bde9-d396d8b97867);
SetCombatGroupID(_Sahuagin, "d275440c-fcfa-5e8b-da4c-75aa5c8f1bf3");

// Reacting to stealing from any of the offerings in the vault
IF
UseFinished(_Player, _Item, 1)
AND
DB_Players(_Player)
AND
DB_LOW_WaterQueensHouse_UnderUmberleeProtection(_Item)
AND
QRY_OnlyOnce("LOW_WaterQueensHouse_UmberleeProtection")
THEN
DB_LOW_WaterQueensHouse_StoleFromUmberlee(1);
SetFlag((FLAG)LOW_WaterQueensHouse_Event_SahuaginsCalled_19f987b3-2cb9-6391-3069-8757f5580371);

IF
DB_LOW_WaterQueensHouse_StoleFromUmberlee(1)
THEN
PROC_SetOnStage(S_LOW_Umberlee_InvisibleHelper_66ee6a2e-4b53-4ff0-897d-ada81470eb07, 1);
PROC_TryStartAD((DIALOGRESOURCE)LOW_WaterQueensHouse_AD_StealFromUmberlee_422d290a-f3d8-64de-514e-d098eb6ffb12, S_LOW_Umberlee_InvisibleHelper_66ee6a2e-4b53-4ff0-897d-ada81470eb07);

IF
DB_LOW_WaterQueensHouse_StoleFromUmberlee(1)
THEN
DB_LOW_WaterQueenHouse_UmberleeWrath(S_LOW_WaterQueensHouse_UmberleeWrath_fbe90241-cc61-4d23-8281-57d087aeff43);
DB_LOW_WaterQueenHouse_UmberleeWrath(S_LOW_WaterQueensHouse_UmberleeWrath_000_b490b8e0-1a64-4aaa-a8a5-2e8f89b1692f);
DB_LOW_WaterQueenHouse_UmberleeWrath(S_LOW_WaterQueensHouse_UmberleeWrath_001_8652daa2-1438-4935-b93a-d4f9fa395fea);

IF
DB_LOW_WaterQueensHouse_StoleFromUmberlee(1)
THEN
PROC_LOW_WaterQueensHouse_UmberleeSpell();

PROC
PROC_LOW_WaterQueensHouse_UmberleeSpell()
AND
DB_LOW_WaterQueenHouse_UmberleeWrath(_Point)
THEN
CreateProjectileStrikeAt(_Point, "ProjectileStrike_LOW_WaterQueensHouse_UmberleeWrath");

IF
DB_LOW_WaterQueensHouse_StoleFromUmberlee(1)
THEN
PROC_LOW_WaterQueensHouse_CallSahuagins();

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_WaterQueensHouse_AD_StealFromUmberlee_422d290a-f3d8-64de-514e-d098eb6ffb12, _)
THEN
PROC_SetOnStage(S_LOW_Umberlee_InvisibleHelper_66ee6a2e-4b53-4ff0-897d-ada81470eb07, 0);

QRY
QRY_CrimeGetCustomWarning((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _Crime, _Dialog, _CrimeID)
AND
CrimeGetCriminal(_CrimeID, 1, _Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_WaterQueensHouse_OfferingsVaultArea_8bfa4c21-5289-4a79-a6de-2b1aa2d5dc81)
AND
NOT DB_GlobalFlag((FLAG)LOW_WaterQueensHouse_Event_Trespassing_5a1d8783-2a94-8aa1-9969-73875b090e9b)
THEN
DB_CrimeWarning_CustomDialog((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _CrimeID, (DIALOGRESOURCE)LOW_WaterQueensHouse_VaultWaveservant_Spotted_28b57829-ff1d-99fa-8636-e6a807c3ac4c);


QRY
QRY_CrimeGetCustomWarning((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _Crime, _Dialog, _CrimeID)
AND
CrimeGetCriminal(_CrimeID, 1, _Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_WaterQueensHouse_OfferingsVaultArea_8bfa4c21-5289-4a79-a6de-2b1aa2d5dc81)
AND
DB_GlobalFlag((FLAG)LOW_WaterQueensHouse_Event_Trespassing_5a1d8783-2a94-8aa1-9969-73875b090e9b)
THEN
DB_CrimeWarning_CustomDialog((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _CrimeID, (DIALOGRESOURCE)LOW_WaterQueensHouse_VaultWaveservant_CallForHelp_9cf95ed5-6cb4-1202-c6f3-7c5411e1e895);


QRY
QRY_CrimeGetCustomArrestDialogCustom((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _CrimeID, _Dialog, _, _, _, _)
AND
CrimeGetCriminal(_CrimeID, 1, _Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_WaterQueensHouse_OfferingsVaultArea_8bfa4c21-5289-4a79-a6de-2b1aa2d5dc81)
AND
NOT DB_GlobalFlag((FLAG)LOW_WaterQueensHouse_Event_Trespassing_5a1d8783-2a94-8aa1-9969-73875b090e9b)
AND
CrimeGetType(_CrimeID, "Trespassing")
THEN
DB_CrimeArrest_CustomDialog((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _CrimeID, (DIALOGRESOURCE)LOW_WaterQueensHouse_VaultWaveservant_Spotted_28b57829-ff1d-99fa-8636-e6a807c3ac4c);


QRY
QRY_CrimeGetCustomArrestDialogCustom((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _CrimeID, _Dialog, _, _, _, _)
AND
CrimeGetCriminal(_CrimeID, 1, _Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_WaterQueensHouse_OfferingsVaultArea_8bfa4c21-5289-4a79-a6de-2b1aa2d5dc81)
AND
DB_GlobalFlag((FLAG)LOW_WaterQueensHouse_Event_Trespassing_5a1d8783-2a94-8aa1-9969-73875b090e9b)
AND
CrimeGetType(_CrimeID, "Trespassing")
THEN
DB_CrimeArrest_CustomDialog((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _CrimeID, (DIALOGRESOURCE)LOW_WaterQueensHouse_VaultWaveservant_CallForHelp_9cf95ed5-6cb4-1202-c6f3-7c5411e1e895);


QRY
QRY_CrimeGetCustomArrestDialogCustom((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _CrimeID, _Dialog, _, _, _, _)
AND
CrimeGetCriminal(_CrimeID, 1, _Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_WaterQueensHouse_OfferingsVaultArea_8bfa4c21-5289-4a79-a6de-2b1aa2d5dc81)
AND
NOT CrimeGetType(_CrimeID, "Trespassing")
THEN
DB_CrimeArrest_CustomDialog((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _CrimeID, (DIALOGRESOURCE)LOW_WaterQueensHouse_VaultWaveservant_CallForHelp_9cf95ed5-6cb4-1202-c6f3-7c5411e1e895);


// Cellar Waveservants warns about guards ahead
/*
PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_LOW_CellarWaveservant01_eb2f1d87-9d15-45bc-8899-15415c6cf6d2, "LOW_CellarWaveservant_Spotted", _Player)
AND
GetFlag((FLAG)LOW_WaterQueensHouse_SpottedBy_CellarWaveservant01_13712c87-a623-ac16-6c5c-c8e97c038948, _Player, 0)
//AND
//QRY_SpeakerIsAvailable(LOW_WaterQueensHouse_CellarWaveservant01_fd83674a-a0eb-5fdc-9040-2d353dfbe730)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_WaterQueensHouse_CellarWaveservant01_fd83674a-a0eb-5fdc-9040-2d353dfbe730, S_LOW_CellarWaveservant01_eb2f1d87-9d15-45bc-8899-15415c6cf6d2, _Player)
THEN
SetFlag((FLAG)LOW_WaterQueensHouse_SpottedBy_CellarWaveservant01_13712c87-a623-ac16-6c5c-c8e97c038948, _Player);
*/

//END_REGION

//REGION Vault Waveservant's Behaviour

//Setting VaultWaveservant always active while any player is in Water Queen's House

IF
EnteredTrigger(_Player, _LevelArea)
AND
DB_LOW_WaterQueensHouse_LevelAreas(_LevelArea)
AND
DB_Players(_Player)
THEN
SetForceUpdate((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, 1);

IF
LeftTrigger(_Player, _LevelArea)
AND
DB_LOW_WaterQueensHouse_LevelAreas(_LevelArea)
AND
DB_Players(_Player)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(_LevelArea)
THEN
SetForceUpdate((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, 0);


IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_WaterQueensHouse_AD_OfferingsChat_d8825c95-10fc-6916-b370-683dd2bafe50, _ID)
THEN
SetFlag((FLAG)LOW_VaultWaveservant_State_InOfferingsRoutine_f3338bef-df48-45bd-ad28-3885d0181892);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_WaterQueensHouse_Cellar_SUB_b2045d8e-d41b-4ccb-898d-eb453aeece39)
AND
NOT DB_GlobalFlag((FLAG)LOW_VaultWaveservant_State_InOfferingsRoutine_f3338bef-df48-45bd-ad28-3885d0181892)
THEN
SetFlag((FLAG)LOW_VaultWaveservant_State_InOfferingsRoutine_f3338bef-df48-45bd-ad28-3885d0181892);

IF
FlagSet((FLAG)LOW_VaultWaveservant_State_InOfferingsRoutine_f3338bef-df48-45bd-ad28-3885d0181892,_,_)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_WaterQueensHouse_OfferingsArea_72d1ab2f-9060-4c5a-87b7-8556833c3531);

IF
UseFinished((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, (ITEM)S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, 1)
AND
IsInventoryEmpty(S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, 1)
THEN
SetFlag((FLAG)LOW_VaultWaveservant_State_WaitingForOfferings_2ab70a62-99ae-4f13-8c88-b582d9d0f214);

IF
UseFinished((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, (ITEM)S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, 1)
AND
IsInventoryEmpty(S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, 0)
THEN
ClearFlag((FLAG)LOW_VaultWaveservant_State_WaitingForOfferings_2ab70a62-99ae-4f13-8c88-b582d9d0f214);

IF
UseFinished(_NPC, (ITEM)S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, 1)
AND
_NPC != S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91
AND
DB_Sees((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _NPC)
THEN
ClearFlag((FLAG)LOW_VaultWaveservant_State_WaitingForOfferings_2ab70a62-99ae-4f13-8c88-b582d9d0f214);

IF 
DB_Sees((CHARACTER)S_LOW_VaultWaveservant_f9ee4d8f-0c1a-4b49-8859-7e3fab474c91, _Waveservant)
AND
DB_LOW_WaterQueensHouse_AllWaveservants(_Waveservant)
AND
DB_PermaDefeated(_Waveservant)
THEN
SetFlag((FLAG)LOW_WaterQueensHouse_State_VaultWaveservantAlarmed_77fe7e6f-50e9-40bb-97a9-3a04a923070b);

IF
DB_LOW_WaterQueensHouse_StoleFromUmberlee(1)
THEN
SetFlag((FLAG)LOW_WaterQueensHouse_State_VaultWaveservantAlarmed_77fe7e6f-50e9-40bb-97a9-3a04a923070b);

//END_REGION

//REGION LOW_AvengeWaveservant journal

IF
FlagSet((FLAG)LOW_Allandra_Knows_FishermenFoundHolli_9941b4fc-6b06-cf2b-30c9-c8aa447669e1,_,_)
THEN
DB_LOW_AvengeWaveservant_HintAboutFishermen(1);

IF
DB_LOW_AvengeWaveservant_HintAboutFishermen(1)
AND
DB_GlobalFlag((FLAG)LOW_Allandra_State_AcceptedQuest_d0f4ea27-21a9-b8e9-f799-de5de71d441e)
AND
NOT DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_Knows_DockWarehouse_6bd387d4-18e5-55f1-9027-3d55a5065e3a)
THEN
QuestUpdate("LOW_AvengeWaveservant", "MentionedFishermen");


IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_WarehouseInterior_88801975-6707-43ee-8644-3aa6d99c24e2)
AND
QuestUpdateIsUnlocked(_Player,"LOW_AvengeWaveservant", "EnteredWarehouse", 0)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player,"LOW_AvengeWaveservant", "TalkedToFisherman", 1)
THEN
QuestUpdate("LOW_AvengeWaveservant", "EnteredWarehouse");

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_BellyOfTheBeast_WarehouseBasement_SUB_6c9b1262-8097-45a1-b989-8f56dd4d38e4)
AND
QuestUpdateIsUnlocked(_Player,"LOW_AvengeWaveservant", "FoundBasement", 0)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player,"LOW_AvengeWaveservant", "EnteredWarehouse", 1)
THEN
QuestUpdate("LOW_AvengeWaveservant", "FoundBasement");

IF
DialogStarted((DIALOGRESOURCE)LOW_BellyOfTheBeast_WaveservantsConfrontation_f00cc5c0-68ef-9825-425e-5169af57ca3d, _)
AND
NOT DB_Defeated(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1)
THEN
QuestUpdate("LOW_AvengeWaveservant", "FinishedIronThrone");

IF
DialogEnded((DIALOGRESOURCE)LOW_BellyOfTheBeast_WaveservantsConfrontation_f00cc5c0-68ef-9825-425e-5169af57ca3d, _)
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_Event_WaveservantsLeaveDockWarehouse_2b60d130-03d3-4867-a7d7-39b0c5447ad0)
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_State_ReportedBeastmasterDead_43dd5530-e74f-48fa-aeb1-43cbb8bbb7d6)
THEN
QuestUpdate("LOW_AvengeWaveservant", "DidntReturnToAllandra");

IF
DialogEnded((DIALOGRESOURCE)LOW_BellyOfTheBeast_WaveservantsConfrontation_f00cc5c0-68ef-9825-425e-5169af57ca3d, _)
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_Event_WaveservantsLeaveDockWarehouse_2b60d130-03d3-4867-a7d7-39b0c5447ad0)
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_State_WaveservantsKilledBeastmasterWhilePlayerIsInIronThrone_30add9ad-0e3d-41d3-a784-24e7efbb2acc)
THEN
QuestUpdate("LOW_AvengeWaveservant", "WaveservantsKilledBeastmaster");

IF
FlagSet(LOW_BellyOfTheBeast_Event_WaveservantsTurnHostile_75616c87-a135-430a-870c-fbbec5951736,_,_)
THEN
NOT DB_QuestDef_DefeatedState("LOW_AvengeWaveservant", "DefeatedAllandra", (CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8);
NOT DB_QuestDef_PermaDefeatedState("LOW_AvengeWaveservant", "KilledBeastmasterInTime", (CHARACTER)S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1);
DB_QuestDef_PermaDefeatedState("LOW_AvengeWaveservant", "FailedBeastmaster", (CHARACTER)S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1);
//END_REGION

//REGION Combat ADs

IF
EnteredCombat((CHARACTER)_Waveservant,_CombatID)
AND
DB_LOW_WaterQueensHouse_AllWaveservants(_Waveservant)
AND
NOT DB_LOW_WaterQueensHouse_ADPlayedInWaveservantCombat(_CombatID)
THEN
RealtimeObjectTimerLaunch(_Waveservant, "WaveservantCombatReact_OnEntered", 500);
DB_LOW_WaterQueensHouse_ADPlayedInWaveservantCombat(_CombatID);

IF
ObjectTimerFinished(_Waveservant,"WaveservantCombatReact_OnEntered")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_WaterQueensHouse_AD_WaveservantsWrath_306d0d15-d4c5-51ec-def2-f1ec4c9deb60, _Waveservant)
THEN
DB_NOOP(1);


//END_REGION Entered Combat

//REGION Offerings to Umberlee
IF
MovedFromTo(_Item, (CHARACTER)_Player, S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc,0)
AND
DB_PartyMembers(_Player)
AND
NOT DB_LOW_WaterQueensHouse_CursedByUmberlee(_Player)
AND
NOT DB_LOW_WaterQueensHouse_NoMoreOfferings(1)
AND
NOT DB_GlobalFlag(LOW_WaterQueensHouse_State_OfferingsAreGone_7b4a853d-fff5-4faa-82b6-2e3829eb2851)
THEN
DB_LOW_WaterQueensHouse_UmberleeShouldBless(_Player);

IF
UseFinished(_Player, S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, 1)
AND
DB_LOW_WaterQueensHouse_UmberleeShouldBless(_Player)
THEN
NOT DB_LOW_WaterQueensHouse_UmberleeShouldBless(_Player);
PROC_LOW_WaterQueensHouse_BlessPlayer(_Player);

PROC
PROC_LOW_WaterQueensHouse_BlessPlayer((CHARACTER)_Player)
AND
NOT DB_LOW_WaterQueensHouse_BlessedByUmberlee(_Player)
THEN
ApplyStatus(_Player, "BLESS", -1.0, 0, S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc);
DB_LOW_WaterQueensHouse_BlessedByUmberlee(_Player);

PROC
PROC_LOW_WaterQueensHouse_BlessPlayer((CHARACTER)_Player)
AND
GetFlag((FLAG)LOW_WaterQueensHouse_State_OfferingGiven_30ab72c4-2730-495e-4266-043aeab7efd1, _Player, 0)
THEN
SetFlag(LOW_WaterQueensHouse_State_OfferingGiven_30ab72c4-2730-495e-4266-043aeab7efd1, _Player);

IF
MovedFromTo(_Item, S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, (CHARACTER)_Player, 0)
AND
DB_PartyMembers(_Player)
AND
GetPosition(S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, _X, _Y, _Z)
THEN
PROC_CharacterRegisterCrimeWithPosition(_Player, "Steal", _Item, _X, _Y, _Z, (CHARACTER)S_LOW_GuardWaveservant03_cd6cb468-b077-48d0-a7e1-1e3758466d5f, 0);
PROC_LOW_WaterQueensHouse_CursePlayer(_Player);

PROC
PROC_LOW_WaterQueensHouse_CursePlayer((CHARACTER)_Player)
AND
NOT DB_LOW_WaterQueensHouse_CursedByUmberlee(_Player)
THEN
DB_LOW_WaterQueensHouse_CursedByUmberlee(_Player);

IF
ItemLeftTrigger((ITEM)S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, S_LOW_WaterQueensHouse_OfferingsZone_5c337e89-7408-45e6-9258-d53e0ba157dd, _)
THEN
SetFlag(LOW_WaterQueensHouse_State_OfferingsAreGone_7b4a853d-fff5-4faa-82b6-2e3829eb2851);

IF
ItemEnteredTrigger((ITEM)S_LOW_WaterQueensHouse_OfferingsChest_9f1a218c-c8ba-42da-8370-51e723052dbc, S_LOW_WaterQueensHouse_OfferingsZone_5c337e89-7408-45e6-9258-d53e0ba157dd, _)
THEN
ClearFlag(LOW_WaterQueensHouse_State_OfferingsAreGone_7b4a853d-fff5-4faa-82b6-2e3829eb2851);

IF
RelationChanged(_PlayerFaction, (FACTION)ACT3_LOW_WaterQueensHouse_Waveservants_65b74fbb-f418-4ed4-8681-c396c54dfc5d, 0, _)
AND
NOT DB_GlobalFlag(LOW_WaterQueensHouse_State_StopOfferings_7b4a853d-fff5-4faa-82b6-2e3829eb2851)
THEN
DB_LOW_WaterQueensHouse_NoMoreOfferings(1);

IF 
FlagSet((FLAG)LOW_WaterQueensHouse_State_VaultWaveservantAlarmed_77fe7e6f-50e9-40bb-97a9-3a04a923070b,_,_)
THEN
DB_LOW_WaterQueensHouse_NoMoreOfferings(1);

IF
DB_LOW_WaterQueensHouse_StoleFromUmberlee(1)
THEN
DB_LOW_WaterQueensHouse_NoMoreOfferings(1);

//END_REGION

//REGION Learning that the Beastmaster is gone
IF 
FlagSet((FLAG)LOW_DockWareHouse_State_ReadResignationLetter_e55051c0-1b34-444a-8247-12208ef5be27, _, _)
THEN
SetFlag(LOW_WaterQueensHouse_Knows_BeastMasterLeft_f8d590aa-9370-4ac5-b0c9-e39947abe524);

IF 
FlagSet((FLAG)LOW_DockWareHouse_State_ReadResignationLetter_WithRavengard_a65a0874-9c21-47af-879d-9cf27474b634, _, _)
THEN
SetFlag(LOW_WaterQueensHouse_Knows_BeastMasterLeft_f8d590aa-9370-4ac5-b0c9-e39947abe524);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
