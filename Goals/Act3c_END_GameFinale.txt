Version 1
SubGoalCombiner SGC_AND
INITSECTION
//DB_END_GameFinale_CharacterPartneredDialogs((FLAG)_PartneredFlag, (DIALOGRESOURCE)_RomanticFates, (CHARACTER)_Partner)
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithHalsinSecondary_6af0be74-d032-4a20-876a-11bab5f86db2, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Halsin_a853d059-2572-04c4-88db-d737e4a264f7, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithHalsin_7b53fe60-bb16-48a9-ae5c-9bce1dfac1a9, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Halsin_a853d059-2572-04c4-88db-d737e4a264f7, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithAstarion_30819c8d-b39d-42e7-acd1-2a8c2c309994, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Astarion_73fb7151-e772-cae7-8d7a-bb5eb8e8860a, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithGale_e008e20d-d642-42ed-9008-297b6273aa21, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Gale_81fc2269-0613-259c-b950-c0dcebbb7934, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithLaezel_d169a786-6e56-4f0d-a2eb-33c48d8d1160, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Laezel_523b1bb2-0443-79bf-cf3e-8f435ff5f2e9, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Minthara_699ad056-06a4-db4f-53c4-6706dbb7c544, (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithShadowheart_3808ae35-ad4e-465b-800b-63d32b77211e, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Shadowheart_b9ebb9af-ad65-4e64-6015-105e831d49c0, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithWyll_5db4c1b6-3c42-43ae-aa85-1844acbf5a1d, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Wyll_32de9167-3489-9257-e3c1-e430f2f455ab, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithKarlach_d9ff60fa-0af9-45d7-99b4-bd7c3f80ed12, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Karlach_091af35d-0d30-a4bf-b056-9eda505138b5, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

DB_END_GameFinale_UnpartneredOriginDialogues((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3);
DB_END_GameFinale_UnpartneredOriginDialogues((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)END_GameFinale_SoloFates_Astarion_9a09777b-c0ac-d3d3-c2f4-5e6794fa2ca0);
DB_END_GameFinale_UnpartneredOriginDialogues((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (DIALOGRESOURCE)END_GameFinale_SoloFates_Laezel_fbee59b9-cb3a-c1f2-66b4-b0fb82cf24fa);
DB_END_GameFinale_UnpartneredOriginDialogues((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)END_GameFinale_SoloFates_Shadowheart_bdc19865-8e61-2db2-f135-4a611b15cae1);
DB_END_GameFinale_UnpartneredOriginDialogues((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (DIALOGRESOURCE)END_GameFinale_SoloFates_Wyll_1667181c-2c0a-5255-ecfd-bd0752b4639c);
DB_END_GameFinale_UnpartneredOriginDialogues((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)END_GameFinale_SoloFates_Karlach_0181cc77-4b25-dd9a-025b-b08e85387645);

DB_END_GameFinale_FatesPositions((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TRIGGER)S_END_FatesAstarionPoint_b16b352c-3fba-4af0-8515-0f211559d266);
DB_END_GameFinale_FatesPositions((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TRIGGER)S_END_FatesGalePoint_34c36805-aad7-493e-9cd1-dab8f58b54f3);
DB_END_GameFinale_FatesPositions((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (TRIGGER)S_END_FatesLaezelPoint_4c729d4d-0721-463d-9be9-f20cea053359);
DB_END_GameFinale_FatesPositions((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_END_FatesShadowheartPoint_bc6c7e08-dc46-4c41-8c8a-3b71b6c522d2);
DB_END_GameFinale_FatesPositions((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (TRIGGER)S_END_FatesWyllPoint_caa39fd7-a132-4c09-9b46-1e8b3bae1d1a);
DB_END_GameFinale_FatesPositions((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (TRIGGER)S_END_FatesMinscPoint_97a137b2-6aad-4567-922b-d5449d500d4d);
DB_END_GameFinale_FatesPositions((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (TRIGGER)S_END_FatesJaheiraPoint_2f1cdb98-6759-48cd-b807-c7819078e1c0);
DB_END_GameFinale_FatesPositions((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TRIGGER)S_END_FatesMintharaPoint_109cef63-089c-47e6-9712-015d76d3cb5c);
DB_END_GameFinale_FatesPositions((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (TRIGGER)S_END_FatesHalsinPoint_f38c0c01-cad9-4d02-ac61-3d5b7599712e);
DB_END_GameFinale_FatesPositions((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_END_FatesKarlachPoint_ba41b4af-4665-427c-beb6-5412b9ba1c1e);

DB_END_GameFinale_QueuedFatesDialog((DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_END_GameFinale_QueuedFatesDialog((DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);

//WARNING: These flags are for AVATAR GALE ONLY. We need to change the DB and patch it in if we have to expand this to more cases.
DB_END_GameFinale_NoSeque((FLAG)ORI_Gale_State_InElysium_d6c53ee8-ce94-4016-73ee-74d44d309837);
DB_END_GameFinale_NoSeque((FLAG)ORI_Gale_State_ChallengedMystra_d6dfa722-f85e-e191-a7e0-776d19c9f18a);
DB_END_GameFinale_NoSeque((FLAG)ORI_Gale_State_ClaimedCrown_93279f0c-82f0-b1e5-ff24-34a47c47a85d);

DB_END_GodsAndMonsters_KarlachFlags((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135);
DB_END_GodsAndMonsters_KarlachFlags((FLAG)GLO_END_GameFinale_DeathofKarlach_KarlachWentWithNonRomanceWyll_a552e386-af26-eb98-d198-a84221e467b0);
DB_END_GodsAndMonsters_KarlachFlags((FLAG)END_GameFinale_SoloFates_Karlach_ChoseAvernus_c5ffd6ad-7749-6eb8-992e-48d66766f6b6);
DB_END_GodsAndMonsters_KarlachFlags((FLAG)END_GameFinale_Event_KarlachReturnedToHell_bbec205a-5b1e-8488-f03a-10f0caaa5471);

//DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)_Companion, Flag)
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (FLAG)ORI_Astarion_State_IsInParty_ef789a01-f41e-4a7d-9097-fa9c4f1d0f16);
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (FLAG)ORI_Gale_State_IsInParty_639d141f-6fa8-4d93-8eb7-41243e0fea32);
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (FLAG)ORI_Karlach_State_IsInParty_eb7c4de0-36b7-4086-aa33-82c09596a395);
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (FLAG)ORI_Laezel_State_IsInParty_3ee6b1f2-24f4-4e85-b7dc-49060e6d2699);
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (FLAG)ORI_ShadowHeart_State_IsInParty_9a029c5a-e3c3-45ef-9cd4-1cb45718deb1);
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (FLAG)ORI_Wyll_State_IsInParty_3c0972ef-d7a4-46ac-abdd-0ce6aadd61b0);
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (FLAG)ORI_Minsc_State_IsInParty_aeb58e60-562a-4e20-8cb2-0deb03b010fc);
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (FLAG)ORI_Minthara_State_IsInParty_766b8981-eb17-3ec5-5d30-2626509c550f);
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (FLAG)ORI_Halsin_State_IsInParty_9a3ea4cd-3a44-40f7-9d63-2b29bdb28725);
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (FLAG)ORI_Jaheira_State_IsInParty_1b86aa78-a2db-4faa-b4a6-c5591c03bac9);

DB_END_GameFinale_CharacterPartnershipEndedFlags((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,(FLAG)END_GameFinale_State_PartnershipEndedAstarion_144c7dec-fc84-44e9-851f-d81d9c87c75c);
DB_END_GameFinale_CharacterPartnershipEndedFlags((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,(FLAG)END_GameFinale_State_PartnershipEndedGale_fa62b0f8-c884-4f68-b507-b70b9277b6de);
DB_END_GameFinale_CharacterPartnershipEndedFlags((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,(FLAG)END_GameFinale_State_PartnershipEndedHalsin_887340d1-4dd3-4b99-81e6-2c942e61b06e);
DB_END_GameFinale_CharacterPartnershipEndedFlags((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,(FLAG)END_GameFinale_State_PartnershipEndedKarlach_f9ec7b63-c6c9-4ca4-b7ff-bdfea27bc780);
DB_END_GameFinale_CharacterPartnershipEndedFlags((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(FLAG)END_GameFinale_State_PartnershipEndedLaezel_48bdbcad-da83-44c1-b3fe-5d4b227e8ba0);
DB_END_GameFinale_CharacterPartnershipEndedFlags((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,(FLAG)END_GameFinale_State_PartnershipEndedMinthara_421d45a7-3c15-486a-b856-e3ea4a705882);
DB_END_GameFinale_CharacterPartnershipEndedFlags((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)END_GameFinale_State_PartnershipEndedShadowheart_b123048b-07de-4b06-884e-a12b54e984e1);
DB_END_GameFinale_CharacterPartnershipEndedFlags((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(FLAG)END_GameFinale_State_PartnershipEndedWyll_3b60022c-b8a5-445e-b66a-21154f9fd73b);

KBSECTION
//REGION Debug
IF
TextEvent("Gamefinale_Setup")
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_END_BrainBattle_DominationCompleted(_Player);

IF
TextEvent("Gamefinale_Setup_Raph")
AND
DB_Players((CHARACTER)_Player)
THEN
SetFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc);
PROC_END_BrainBattle_DominationCompleted(_Player);

IF
TextEvent("GameFinale_SetEvilflags")
THEN
SetFlag((FLAG)END_FinalDecisions_PlayerBecameTheAbsolute_2eca30e3-7741-051a-8686-ce3c8dae0a81);
SetFlag((FLAG)END_FinalDecisions_PlayerSubjugatesBrainForBhaal_7f28008c-606e-b7ef-c1c1-94999670e653);

IF
TextEvent("GameFinale_SetGaleFlag")
THEN
SetFlag((FLAG)END_FinalDecisions_Event_GaleExploded_a32e3cb5-9536-3c3e-a4d2-1837ee3b6190);

IF
FlagSet((FLAG)_Flag, _, _ID)
AND
DB_Debug_END_GameFinale_RecruitedCompanions((CHARACTER)_Character, _Flag)
THEN
SetFlag((FLAG)ORI_State_Recruited_e78c0aab-fb48-98e9-3ed9-773a0c39988d, _Character, _ID);
DB_PartOfTheTeam(_Character);

IF
FlagSet((FLAG)END_Debug_GameFinale_SetAllCompanions_b5a6126b-7706-1254-b91a-1cf48de9cb45, _, _)
THEN
SetFlag((FLAG)ORI_Wyll_State_IsInParty_3c0972ef-d7a4-46ac-abdd-0ce6aadd61b0);
SetFlag((FLAG)ORI_ShadowHeart_State_IsInParty_9a029c5a-e3c3-45ef-9cd4-1cb45718deb1);
SetFlag((FLAG)ORI_Minsc_State_IsInParty_aeb58e60-562a-4e20-8cb2-0deb03b010fc);
SetFlag((FLAG)ORI_Laezel_State_IsInParty_3ee6b1f2-24f4-4e85-b7dc-49060e6d2699);
SetFlag((FLAG)ORI_Karlach_State_IsInParty_eb7c4de0-36b7-4086-aa33-82c09596a395);
SetFlag((FLAG)ORI_Jaheira_State_IsInParty_1b86aa78-a2db-4faa-b4a6-c5591c03bac9);
SetFlag((FLAG)ORI_Halsin_State_IsInParty_9a3ea4cd-3a44-40f7-9d63-2b29bdb28725);
SetFlag((FLAG)ORI_Gale_State_IsInParty_639d141f-6fa8-4d93-8eb7-41243e0fea32);
SetFlag((FLAG)ORI_Astarion_State_IsInParty_ef789a01-f41e-4a7d-9097-fa9c4f1d0f16);

IF
FlagSet((FLAG)END_Debug_GameFinale_SetOnlyOrigins_c0226304-4b3f-5928-c40f-5f374ae94a05, _, _)
THEN
SetFlag((FLAG)ORI_Astarion_State_IsInParty_ef789a01-f41e-4a7d-9097-fa9c4f1d0f16);
SetFlag((FLAG)ORI_Gale_State_IsInParty_639d141f-6fa8-4d93-8eb7-41243e0fea32);
SetFlag((FLAG)ORI_Laezel_State_IsInParty_3ee6b1f2-24f4-4e85-b7dc-49060e6d2699);
SetFlag((FLAG)ORI_Karlach_State_IsInParty_eb7c4de0-36b7-4086-aa33-82c09596a395);
SetFlag((FLAG)ORI_ShadowHeart_State_IsInParty_9a029c5a-e3c3-45ef-9cd4-1cb45718deb1);
SetFlag((FLAG)ORI_Wyll_State_IsInParty_3c0972ef-d7a4-46ac-abdd-0ce6aadd61b0);

IF
FlagSet((FLAG)END_Debug_GameFinale_SetRandomRomanticInterest_4026fe3e-12a0-68c5-b2e6-1e184c1c2923, (CHARACTER)_Player, _ID)
AND
DB_Players(_Player)
AND
QRY_GetRandom("DB_END_GameFinale_CharacterPartneredDialogs", 3, "DB_END_GameFinale_RandomRomance")
AND
DB_END_GameFinale_RandomRomance((FLAG)_Flag, (DIALOGRESOURCE)_Dialogue, (CHARACTER)_Character)
THEN
SetFlag(_Flag, _Player, _ID);
NOT DB_END_GameFinale_RandomRomance(_Flag, _Dialogue, _Character);

IF
TextEvent("SoloGale_Mystra_Karsus_Setup")
THEN
PROC_DebugBook_RecruitCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
PROC_DebugBook_RecruitAvatar(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag(END_General_Debug_GoodAllies_ee71917a-2c8d-cc3c-b50e-b981bf204b75, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag(END_General_Debug_SetupAllies_56c77d49-4963-4a38-b0ea-52a0e3911ca8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag(END_General_Debug_SideEmperor_4e4fa4b8-d870-d677-db2f-be9f1ecad210, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
SetFlag(END_General_Debug_EmperorMF_b027bc20-79fd-a08d-c483-78fadd3a8765, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
SetFlag(ORI_State_PartneredWithShadowheart_3808ae35-ad4e-465b-800b-63d32b77211e, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag((FLAG)ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9);
SetFlag((FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff);

IF
TextEvent("SoloGale_NoMystra_Karsus_Setup")
THEN
PROC_DebugBook_RecruitCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
PROC_DebugBook_RecruitAvatar(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag(END_General_Debug_GoodAllies_ee71917a-2c8d-cc3c-b50e-b981bf204b75, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag(END_General_Debug_SetupAllies_56c77d49-4963-4a38-b0ea-52a0e3911ca8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag(END_General_Debug_SideEmperor_4e4fa4b8-d870-d677-db2f-be9f1ecad210, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
SetFlag(END_General_Debug_EmperorMF_b027bc20-79fd-a08d-c483-78fadd3a8765, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
SetFlag(ORI_State_PartneredWithShadowheart_3808ae35-ad4e-465b-800b-63d32b77211e, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag((FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff);

IF
TextEvent("SoloGale_NoMystra_NoKarsus_Setup")
THEN
PROC_DebugBook_RecruitCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
PROC_DebugBook_RecruitAvatar(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag(END_General_Debug_GoodAllies_ee71917a-2c8d-cc3c-b50e-b981bf204b75, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag(END_General_Debug_SetupAllies_56c77d49-4963-4a38-b0ea-52a0e3911ca8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetFlag(END_General_Debug_SideEmperor_4e4fa4b8-d870-d677-db2f-be9f1ecad210, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
SetFlag(END_General_Debug_EmperorMF_b027bc20-79fd-a08d-c483-78fadd3a8765, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
SetFlag(ORI_State_PartneredWithShadowheart_3808ae35-ad4e-465b-800b-63d32b77211e, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
//END_REGION

//REGION Dark Urge flags
IF
FlagSet((FLAG)ORI_DarkUrge_State_GoMadEnding_a0bea44c-be8a-26e4-ded5-c6c5827d4190, _, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0)
THEN
SetFlag((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0);
//END_REGION

//REGION Clear Partnering Dark Urge partner becomes unavailable (death or jailed)

PROC
PROC_END_BrainBattle_Over()
AND
DB_ORI_DarkUrge(_Avatar)
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalResisted_74944ac3-1ea0-4eae-9653-1f1319f8646b)
AND
DB_ORI_Partnered(_Avatar, _Character)
AND
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)_PartneredWithFlag, _, _Character)
THEN
ClearFlag((FLAG)_PartneredWithFlag, _Avatar);
SetFlag(ORI_DarkUrge_State_WasPartneredGoneMad_fb3ab877-e2c3-4887-8e27-7050dc1b5171, _Character);

//END_REGION

//REGION End of CombatOver
PROC
PROC_END_BrainBattle_Over()
AND
DB_END_Underground_AlertedSearchers((CHARACTER)_UndergroundCharacter)
THEN
SetOnStage(_UndergroundCharacter, 0);

PROC
PROC_END_BrainBattle_Over()
AND
DB_END_Underground_FirstGroup((CHARACTER)_UndergroundCharacter)
THEN
SetOnStage(_UndergroundCharacter, 0);

PROC
PROC_END_BrainBattle_Over()
AND
NOT DB_END_RealPartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
SetOnStage(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0);

PROC
PROC_END_BrainBattle_Over()
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0)
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalResisted_74944ac3-1ea0-4eae-9653-1f1319f8646b)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
IsTagged(_Avatar, (TAG)REALLY_DARK_URGE_cd611d7d-b67d-42b4-a75c-a0c6091ef8a2, 1)
THEN
PROC_END_General_MakeAvatarUnavailable(_Avatar, 1);

PROC
PROC_END_BrainBattle_Over()
AND
NOT QRY_END_GameFinale_StartAvatarLaezelResolutionDialog()
THEN
PROC_END_GameFinale_FatesSetup();
//END_REGION

//REGION Avatar Laezel resolution dialog - if she wasn't main speaker in Combat Over
QRY
QRY_END_GameFinale_StartAvatarLaezelResolutionDialog()
AND
DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
IsTagged(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
AND
NOT DB_GlobalFlag((FLAG)END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209)
AND
NOT DB_GlobalFlag((FLAG)END_GameFinale_State_LaezelInFaerun_3cb6879c-f4e7-bb31-584a-63bea28ecb75)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)END_GameFinale_AvatarLaezelFinalChoice_d10594c3-607a-0b0c-bd1d-96b1ee614091, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)END_GameFinale_AvatarLaezelFinalChoice_d10594c3-607a-0b0c-bd1d-96b1ee614091, _)
THEN
PROC_END_GameFinale_FatesSetup();
//END_REGION

//REGION Game Finale setup
PROC
PROC_END_GameFinale_FatesSetup()
THEN
NOT DB_END_RealPartOfTheTeam((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
SetOnStage((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, 0);
NOT DB_END_RealPartOfTheTeam((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
SetOnStage((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 0);
TeleportTo((CHARACTER)S_LOW_Mystra_InvisibleHelper_c5470b50-3ab0-4d5f-b84a-ed68cdc65676, (TRIGGER)S_GLO_PixieAsylumPos_Act3c_9f22d897-b3df-49cb-82e9-3db74617dd26);
TeleportTo((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, (TRIGGER)S_END_GodMonWithersPoint_4017bacc-a1ab-49fd-bee4-1aa3f0326140);
SetOnStage((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 1);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_END_RealPartOfTheTeam(_Character)
AND
DB_END_GameFinale_FatesPositions(_Character, _Pos)
THEN
TeleportTo(_Character, _Pos, "", 0, 0, 0);
DetachFromPartyGroup(_Character);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_Players(_Player)
AND
NOT DB_END_GameFinale_FatesPositions(_Player, _)
THEN
TeleportTo(_Player, (TRIGGER)S_END_AvatarWaitPoint_d15cbfdc-fa3f-41c8-9f98-008038cd258e, "", 0, 0, 0);
DetachFromPartyGroup(_Player);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_Avatars((CHARACTER)_Avatar)
AND
IsTagged(_Avatar, (TAG)REALLY_DARK_URGE_cd611d7d-b67d-42b4-a75c-a0c6091ef8a2, 1)
AND
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)_Flag, (DIALOGRESOURCE)_Dialogue, (CHARACTER)_Partner)
AND
GetFlag(_Flag, _Avatar, 1)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Avatar)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Partner)
THEN
DB_END_GameFinale_FatesGroupDialogues(_Dialogue);
DB_END_GameFinale_QueuedPartneredSpeakers(_Dialogue, _Avatar, _Partner);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_Avatars((CHARACTER)_Avatar)
AND
IsTagged(_Avatar, (TAG)REALLY_DARK_URGE_cd611d7d-b67d-42b4-a75c-a0c6091ef8a2, 1)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Avatar)
AND
NOT DB_END_GameFinale_QueuedSoloSpeaker(_, _Avatar)
AND
NOT DB_END_GameFinale_QueuedPartneredSpeakers(_, _Avatar, _)
THEN
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_SoloFates_CustomAvatar_f346a423-c718-45ca-3a0d-cc228b92abe6);
DB_END_GameFinale_QueuedSoloSpeaker((DIALOGRESOURCE)END_GameFinale_SoloFates_CustomAvatar_f346a423-c718-45ca-3a0d-cc228b92abe6, _Avatar);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_Avatars((CHARACTER)_Avatar)
THEN
PROC_END_GameFinale_RomanceFatesDialogues(_Avatar);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_Avatars((CHARACTER)_Avatar)
AND
IsTagged(_Avatar, (TAG)REALLY_DARK_URGE_cd611d7d-b67d-42b4-a75c-a0c6091ef8a2, 1)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Avatar)
AND
DB_ORI_Partnered(_Avatar, _)
AND
NOT DB_END_GameFinale_QueuedSoloSpeaker((DIALOGRESOURCE)END_GameFinale_SoloFates_CustomAvatar_f346a423-c718-45ca-3a0d-cc228b92abe6, _Avatar)
THEN
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_SoloFates_CustomAvatar_f346a423-c718-45ca-3a0d-cc228b92abe6);
DB_END_GameFinale_QueuedSoloSpeaker((DIALOGRESOURCE)END_GameFinale_SoloFates_CustomAvatar_f346a423-c718-45ca-3a0d-cc228b92abe6, _Avatar);

//Guarantee it plays in all cases FatesSetup is called (aka add a speaker regardless of validity as they are not seen)
PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_Avatars((CHARACTER)_Avatar)
AND
NOT DB_END_GameFinale_SegueQueued(1)
THEN
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3);
DB_END_GameFinale_QueuedSoloSpeaker((DIALOGRESOURCE)END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3, _Avatar);
DB_END_GameFinale_SegueQueued(1);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_END_General_MainDialogAnchor((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
NOT DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3);
NOT DB_END_GameFinale_QueuedSoloSpeaker((DIALOGRESOURCE)END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb);
DB_END_GameFinale_QueuedPartneredSpeakers(END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)S_LOW_Mystra_InvisibleHelper_c5470b50-3ab0-4d5f-b84a-ed68cdc65676);
TeleportTo((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TRIGGER)S_END_GameFinale_ConfrontationGalePoint_9052b30d-59f2-4078-a2a0-27d2ef17df8f, "", 0, 0, 0);
TeleportTo((CHARACTER)S_LOW_Mystra_InvisibleHelper_c5470b50-3ab0-4d5f-b84a-ed68cdc65676, (TRIGGER)S_END_GameFinale_ConfrontationMystraPoint_984c4c76-cd6a-49ce-bc0b-db5085b9575d, "", 0, 0, 0);
Transform((CHARACTER)S_LOW_Mystra_InvisibleHelper_c5470b50-3ab0-4d5f-b84a-ed68cdc65676, (CHARACTERROOT)CINE_Mystra_a8240a68-1d48-4391-a878-765bcb1390e0, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_END_GameFinale_QueuedSoloSpeaker((DIALOGRESOURCE)END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3, _)
AND
NOT DB_END_General_MainDialogAnchor((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
NOT DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3);
NOT DB_END_GameFinale_QueuedSoloSpeaker((DIALOGRESOURCE)END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb);
DB_END_GameFinale_QueuedPartneredSpeakers(END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)S_LOW_Mystra_InvisibleHelper_c5470b50-3ab0-4d5f-b84a-ed68cdc65676);
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3);
DB_END_GameFinale_QueuedSoloSpeaker((DIALOGRESOURCE)END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
TeleportTo((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TRIGGER)S_END_GameFinale_ConfrontationGalePoint_9052b30d-59f2-4078-a2a0-27d2ef17df8f, "", 0, 0, 0);
TeleportTo((CHARACTER)S_LOW_Mystra_InvisibleHelper_c5470b50-3ab0-4d5f-b84a-ed68cdc65676, (TRIGGER)S_END_GameFinale_ConfrontationMystraPoint_984c4c76-cd6a-49ce-bc0b-db5085b9575d, "", 0, 0, 0);
Transform((CHARACTER)S_LOW_Mystra_InvisibleHelper_c5470b50-3ab0-4d5f-b84a-ed68cdc65676, (CHARACTERROOT)CINE_Mystra_a8240a68-1d48-4391-a878-765bcb1390e0, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_END_BrainBattle_CombatOverScene(1)	//If there's no CombatOver, it means we got here because Gale blew himself up and there was no other avatar so we should skip this.
AND
DB_END_RealPartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
IsTagged(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
AND
DB_ORI_Partnered(_Avatar, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4);
DB_END_GameFinale_QueuedPartneredSpeakers((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _Avatar, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

PROC
PROC_END_GameFinale_FatesSetup()
AND
DB_END_BrainBattle_CombatOverScene(1)	//If there's no CombatOver, it means we got here because Gale blew himself up and there was no other avatar so we should skip this.
AND
DB_END_RealPartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
IsTagged(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTER)_Avatar)
THEN
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4);
DB_END_GameFinale_QueuedPartneredSpeakers((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _Avatar, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

PROC
PROC_END_GameFinale_FatesSetup()
THEN
PROC_END_GameFinale_BeginFatesGroupDialogues();

PROC
PROC_END_GameFinale_RomanceFatesDialogues((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_END_GameFinale_UnpartneredOriginDialogues(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)_SoloDialogue)
THEN
DB_END_GameFinale_FatesGroupDialogues(_SoloDialogue);
DB_END_GameFinale_QueuedSoloSpeaker(_SoloDialogue, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

PROC
PROC_END_GameFinale_RomanceFatesDialogues((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_END_GameFinale_QueuedPartneredSpeakers(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)_Flag, (DIALOGRESOURCE)_Dialogue, (CHARACTER)_Partner)
AND
GetFlag(_Flag, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Partner)	//Exceptions defined per avatar.
THEN
DB_END_GameFinale_FatesGroupDialogues(_Dialogue);
DB_END_GameFinale_QueuedPartneredSpeakers(_Dialogue, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Partner);

//Ready a dialog if an avatar is partnered with a companion.
PROC
PROC_END_GameFinale_RomanceFatesDialogues((CHARACTER)_Avatar)
AND
DB_Avatars(_Avatar)
AND
NOT DB_END_GameFinale_QueuedSoloSpeaker(_, _Avatar)
AND
NOT DB_END_GameFinale_QueuedPartneredSpeakers(_, _Avatar, _)
AND
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)_Flag, (DIALOGRESOURCE)_Dialogue, (CHARACTER)_Partner)
AND
GetFlag(_Flag, _Avatar, 1)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Avatar)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Partner)	//Exceptions defined per avatar.
THEN
DB_END_GameFinale_FatesGroupDialogues(_Dialogue);
DB_END_GameFinale_QueuedPartneredSpeakers(_Dialogue, _Avatar, _Partner);

//If no partner dialogs have been found for an ORIGIN, assign the unpartnered solo dialog to that character.
PROC
PROC_END_GameFinale_RomanceFatesDialogues((CHARACTER)_Avatar)
AND
NOT DB_END_GameFinale_QueuedSoloSpeaker(_, _Avatar)
AND
NOT DB_END_GameFinale_QueuedPartneredSpeakers(_, _Avatar, _)
AND
DB_END_GameFinale_UnpartneredOriginDialogues(_Avatar, (DIALOGRESOURCE)_SoloDialogue)
THEN
DB_END_GameFinale_FatesGroupDialogues(_SoloDialogue);
DB_END_GameFinale_QueuedSoloSpeaker(_SoloDialogue, _Avatar);
//END_REGION

//REGION Playing Fates
PROC
PROC_END_GameFinale_BeginFatesGroupDialogues()
AND
NOT DB_END_GameFinale_PlayedAvernus(1)
AND
NOT DB_END_GameFinale_QueuedDialogAttempt(1)
AND
NOT DB_END_GameFinale_FatesGroupDialogues(_)
AND
DB_END_GodsAndMonsters_KarlachFlags(_Flag)
AND
DB_GlobalFlag(_Flag)
AND
QRY_DEBUG_PASSEDGENERAL()
THEN
DB_END_GameFinale_PlayedAvernus(1);
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e);

PROC
PROC_END_GameFinale_BeginFatesGroupDialogues()
AND
NOT DB_END_GameFinale_PlayedAvernus(1)
AND
NOT DB_END_GameFinale_QueuedDialogAttempt(1)
AND
NOT DB_END_GameFinale_FatesGroupDialogues(_)
AND
DB_END_GameFinale_DeathOfKarlachAvatar(_Avatar)
AND
GetFlag((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Avatar, 1)
AND
QRY_DEBUG_PASSEDGENERAL()
THEN
DB_END_GameFinale_PlayedAvernus(1);
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e);

PROC
PROC_END_GameFinale_BeginFatesGroupDialogues()
AND
NOT DB_END_GameFinale_PlayedAvernus(1)
AND
NOT DB_END_GameFinale_QueuedDialogAttempt(1)
AND
NOT DB_END_GameFinale_FatesGroupDialogues(_)
AND
DB_ORI_Partnered(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Partner)
AND
GetFlag(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Partner, 1)
AND
QRY_DEBUG_PASSEDPARTNER()
THEN
DB_END_GameFinale_PlayedAvernus(1);
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e);

QRY
QRY_DEBUG_PASSEDGENERAL()
THEN
DB_NOOP(1);

QRY
QRY_DEBUG_PASSEDPARTNER()
THEN
DB_NOOP(1);

PROC
PROC_END_GameFinale_BeginFatesGroupDialogues()
AND
SysCount("DB_END_GameFinale_FatesGroupDialogues", 1, _Length)
AND
SysFactAtIndex("DB_END_GameFinale_FatesGroupDialogues", 1, _Length, "DB_END_GameFinale_QueuedFatesDialog")
AND
DB_END_GameFinale_QueuedFatesDialog(_Dialogue)
THEN
DB_END_GameFinale_QueuedDialogAttempt(1);
PROC_END_GameFinale_PlayQueuedDialog(_Dialogue);
NOT DB_END_GameFinale_QueuedFatesDialog(_Dialogue);

PROC
PROC_END_GameFinale_BeginFatesGroupDialogues()
AND
NOT DB_END_GameFinale_QueuedDialogAttempt(1)
AND
NOT DB_END_GameFinale_FatesGroupDialogues(_)
THEN
PROC_END_GameFinale_StartEpilogue();

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)_Dialogue)
AND
DB_END_GameFinale_QueuedPartneredSpeakers(_Dialogue, _Avatar, _Partner)
THEN
PROC_CancelDisappearOutOfSight(_Partner);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
Transform((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTERROOT)ORIGIN_Gale_God_458fa72d-10e7-46bd-896b-0bb60e71bb29, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
IsTagged((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
THEN
Transform((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTERROOT)Mindflayer_Form_Player_Gale_God_ee59c821-1372-4530-a4a6-1a22962c9fc5, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3)
AND
DB_Players(_Player)
THEN
TeleportTo(_Player, TheHerosRevelry_PlayerLocation_2ff3e244-c7c6-452f-b849-182f067b1989);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)_Dialogue)
AND
_Dialogue != END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb
AND
DB_END_GameFinale_QueuedPartneredSpeakers(_Dialogue, _Avatar, _Partner)
THEN
TeleportTo(_Avatar, (TRIGGER)S_END_FatesAvatar_02a0aaa1-1801-4d52-95f9-d685809a7f24);
TeleportTo(_Partner, (TRIGGER)S_END_FatesPartner_0154876d-39fa-4c82-b64d-e16a4c998265);
PROC_SetArmourSet(_Avatar, ARMOURSET.Vanity);
PROC_SetArmourSet(_Partner, ARMOURSET.Vanity);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)_Dialogue)
AND
DB_END_GameFinale_QueuedSoloSpeaker(_Dialogue, _Avatar)
THEN
TeleportTo(_Avatar, (TRIGGER)S_END_FatesAvatar_02a0aaa1-1801-4d52-95f9-d685809a7f24, "", 0, 0, 0);
PROC_SetArmourSet(_Avatar, ARMOURSET.Vanity);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_END_GameFinale_DeathOfKarlachAvatar((CHARACTER)_Avatar)
THEN
NOT DB_END_GameFinale_DeathOfKarlachAvatar(_Avatar);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
NOT DB_GlobalFlag((FLAG)END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1)
AND
DB_END_GameFinale_QueuedPartneredSpeakers((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _Avatar, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
PROC_SetArmourSet(_Avatar, ARMOURSET.Normal);
PROC_SetArmourSet(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
NOT DB_PartyMembers((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
PROC_SetArmourSet(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_GlobalFlag((FLAG)END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1)
AND
DB_END_GameFinale_QueuedPartneredSpeakers((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _Avatar, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
PROC_SetArmourSet(_Avatar, ARMOURSET.Normal);
PROC_SetArmourSet(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_GlobalFlag((FLAG)END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1)
AND
DB_ORI_Partnered((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Companion)
THEN
PROC_SetArmourSet(_Companion, ARMOURSET.Normal);
PROC_SetArmourSet(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_END_GameFinale_QueuedPartneredSpeakers((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _Avatar, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
TeleportTo(_Avatar, (TRIGGER)S_END_DeathOfKarlach_KarlachPoint_3166c3d4-c6fb-4c9b-a1ab-755e440916d5, "", 0, 0, 0);
TeleportTo(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_END_DeathOfKalach_AvatarPoint_c96d7a62-93f3-413b-8919-354bfc28e6df, "", 0, 0, 0);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3)
AND
NOT QRY_END_GameFinale_SkipSeque()
AND
DB_END_GameFinale_QueuedSoloSpeaker(END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3, (CHARACTER)_Character)
AND
QRY_StartDialog(END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3, _Character)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);

//Avatar Karlach.
PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_GlobalFlag((FLAG)END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1)
AND
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
PROC_SetArmourSet(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_END_General_MainDialogAnchor(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_END_GameFinale_QueuedDialogAttempt(1)
THEN
TeleportTo(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_END_DeathOfKarlach_KarlachPoint_3166c3d4-c6fb-4c9b-a1ab-755e440916d5, "", 0, 0, 0);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_END_GameFinale_QueuedSoloSpeaker(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_END_GameFinale_QueuedDialogAttempt(1)
AND
QRY_StartDialog(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, NULL_00000000-0000-0000-0000-000000000000, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_END_GameFinale_QueuedPartneredSpeakers(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_END_GameFinale_QueuedDialogAttempt(1)
AND
QRY_StartDialog(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, NULL_00000000-0000-0000-0000-000000000000, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_END_RealPartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_END_GameFinale_QueuedPartneredSpeakers(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _Avatar, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
QRY_END_GameFinale_CharacterCannotFinale(_Avatar)
AND
DB_END_General_MainDialogAnchor(_NewAvatar)
AND
NOT DB_GlobalFlag((FLAG)END_BrainBattle_Event_GaleExplodedMidBattle_993173dd-a519-c8aa-67d7-b4fecfd2b5dc)
AND
DB_END_GameFinale_QueuedDialogAttempt(1)
AND
QRY_StartDialog(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _NewAvatar)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);
DB_END_GameFinale_DeathOfKarlachAvatar(_NewAvatar);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
AND
DB_END_RealPartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_END_GameFinale_QueuedPartneredSpeakers(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _Avatar, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_GlobalFlag((FLAG)END_BrainBattle_Event_GaleExplodedMidBattle_993173dd-a519-c8aa-67d7-b4fecfd2b5dc)
AND
DB_END_GameFinale_QueuedDialogAttempt(1)
AND
QRY_StartDialog(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Avatar)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);
DB_END_GameFinale_DeathOfKarlachAvatar(_Avatar);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e)
AND
DB_GlobalFlag((FLAG)ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
_Avatar != S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d
AND
GetFlag((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Avatar, 1)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Avatar, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);
PROC_SetArmourSet((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);
PROC_SetArmourSet((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, ARMOURSET.Normal);
PROC_SetArmourSet(_Avatar, ARMOURSET.Normal);
TeleportTo(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_END_GodsAndMonsters_KarlachPoint_bd04365f-2e25-4c16-94e7-7889f266e740);
TeleportTo((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (TRIGGER)S_END_GodsAndMonsters_WyllPoint_eba0ce04-3fe1-4543-8331-85bd03b1118e);
TeleportTo(_Avatar, (TRIGGER)S_END_GodsAndMonsters_PartnerPoint_eba0ce04-3fe1-4543-8331-85bd03b1118e);
Equip(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_END_KarlachGreatAxe_9b08e8e4-589a-496e-a4a1-561304ffecb2, 0, 0, 1);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e)
AND
DB_GlobalFlag((FLAG)ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
AND
DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
GetFlag((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 1)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);
PROC_SetArmourSet((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);
PROC_SetArmourSet((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, ARMOURSET.Normal);
TeleportTo(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_END_GodsAndMonsters_KarlachPoint_bd04365f-2e25-4c16-94e7-7889f266e740);
TeleportTo(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (TRIGGER)S_END_GodsAndMonsters_PartnerPoint_eba0ce04-3fe1-4543-8331-85bd03b1118e);
Equip(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_END_KarlachGreatAxe_9b08e8e4-589a-496e-a4a1-561304ffecb2, 0, 0, 1);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e)
AND
DB_GlobalFlag((FLAG)ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
AND
DB_END_GameFinale_DeathOfKarlachAvatar((CHARACTER)_Avatar)
AND
GetFlag((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Avatar, 0)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Avatar, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);
NOT DB_END_GameFinale_DeathOfKarlachAvatar(_Avatar);
PROC_SetArmourSet((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);
PROC_SetArmourSet((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, ARMOURSET.Normal);
TeleportTo(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_END_GodsAndMonsters_KarlachPoint_bd04365f-2e25-4c16-94e7-7889f266e740);
TeleportTo((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (TRIGGER)S_END_GodsAndMonsters_PartnerPoint_eba0ce04-3fe1-4543-8331-85bd03b1118e);
Equip(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_END_KarlachGreatAxe_9b08e8e4-589a-496e-a4a1-561304ffecb2, 0, 0, 1);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e)
AND
NOT DB_GlobalFlag((FLAG)ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
GetFlag((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Avatar, 1)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Avatar)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);
PROC_SetArmourSet((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);
PROC_SetArmourSet(_Avatar, ARMOURSET.Normal);
TeleportTo(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_END_GodsAndMonsters_KarlachPoint_bd04365f-2e25-4c16-94e7-7889f266e740);
TeleportTo(_Avatar, (TRIGGER)S_END_GodsAndMonsters_PartnerPoint_eba0ce04-3fe1-4543-8331-85bd03b1118e);
Equip(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_END_KarlachGreatAxe_9b08e8e4-589a-496e-a4a1-561304ffecb2, 0, 0, 1);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e)
AND
DB_GlobalFlag((FLAG)END_GameFinale_Event_KarlachReturnedToHell_bbec205a-5b1e-8488-f03a-10f0caaa5471)
AND
DB_ORI_Partnered(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Partner)
AND
GetFlag(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Partner, 1)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Partner)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);
PROC_SetArmourSet((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);
PROC_SetArmourSet((CHARACTER)_Partner, ARMOURSET.Normal);
TeleportTo(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_END_GodsAndMonsters_KarlachPoint_bd04365f-2e25-4c16-94e7-7889f266e740);
TeleportTo((CHARACTER)_Partner, (TRIGGER)S_END_GodsAndMonsters_PartnerPoint_eba0ce04-3fe1-4543-8331-85bd03b1118e);
Equip(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_END_KarlachGreatAxe_9b08e8e4-589a-496e-a4a1-561304ffecb2, 0, 0, 1);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e)
AND
DB_GlobalFlag((FLAG)END_GameFinale_SoloFates_Karlach_ChoseAvernus_c5ffd6ad-7749-6eb8-992e-48d66766f6b6)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);
PROC_SetArmourSet((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, ARMOURSET.Normal);
TeleportTo(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_END_GodsAndMonsters_KarlachPoint_bd04365f-2e25-4c16-94e7-7889f266e740);
Equip(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_END_KarlachGreatAxe_9b08e8e4-589a-496e-a4a1-561304ffecb2, 0, 0, 1);

//Only try with the designated speakers, otherwise move on.
PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)_Dialogue)
AND
DB_END_GameFinale_QueuedPartneredSpeakers(_Dialogue, _Avatar, _Partner)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Avatar)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Partner)
AND
DB_END_GameFinale_QueuedDialogAttempt(1)
AND
QRY_StartDialog_Fixed(_Dialogue, _Partner, _Avatar)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)_Dialogue)
AND
DB_END_GameFinale_QueuedSoloSpeaker(_Dialogue, _Avatar)
AND
NOT QRY_END_GameFinale_DialogueCannotPlay(_Dialogue, _Avatar)
AND
NOT QRY_END_GameFinale_CharacterCannotFinale(_Avatar)
AND
DB_END_GameFinale_QueuedDialogAttempt(1)
AND
QRY_StartDialog(_Dialogue, _Avatar)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)_Dialogue)
AND
DB_END_GameFinale_QueuedDialogAttempt(1)
THEN
NOT DB_END_GameFinale_QueuedDialogAttempt(1);
PROC_END_GameFinale_ChooseNextDialog(_Dialogue);

PROC
PROC_END_GameFinale_PlayQueuedDialog((DIALOGRESOURCE)_Dialogue)
AND
DB_END_GameFinale_FatesPositions(_Character, _Trigger)
AND
NOT DB_END_GameFinale_QueuedPartneredSpeakers(_Dialogue, _, _Character)
AND
NOT DB_END_GameFinale_QueuedPartneredSpeakers(_Dialogue, _Character, _)
THEN
TeleportTo(_Character, _Trigger);

IF
DialogEnded((DIALOGRESOURCE)_Dialogue, _ID)
AND
DB_END_GameFinale_FatesGroupDialogues(_Dialogue)
THEN
PROC_END_GameFinale_ChooseNextDialog(_Dialogue);

IF
DialogEnded((DIALOGRESOURCE)_Dialogue, _ID)
AND
DB_END_GameFinale_FatesGroupDialogues(_Dialogue)
AND
DB_END_GameFinale_QueuedPartneredSpeakers(_Dialogue, _Avatar, _Partner)
AND
DB_END_GameFinale_FatesPositions(_Partner, _PartnerTrigger)
THEN
TeleportTo(_Avatar, (TRIGGER)S_END_AvatarWaitPoint_634f76b1-2325-4ed5-91f0-554f09ef5f5b, "", 0, 0, 0);
TeleportTo(_Partner, _PartnerTrigger, "", 0, 0, 0);
PROC_SetArmourSet(_Avatar, ARMOURSET.Vanity);
PROC_SetArmourSet(_Partner, ARMOURSET.Vanity);

IF
DialogEnded((DIALOGRESOURCE)_Dialogue, _ID)
AND
DB_END_GameFinale_FatesGroupDialogues(_Dialogue)
AND
DB_END_GameFinale_QueuedSoloSpeaker(_Dialogue, _Avatar)
THEN
TeleportTo(_Avatar, (TRIGGER)S_END_AvatarWaitPoint_d15cbfdc-fa3f-41c8-9f98-008038cd258e, "", 0, 0, 0);
PROC_SetArmourSet(_Avatar, ARMOURSET.Vanity);

IF
DialogEnded((DIALOGRESOURCE)END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb, _)
THEN
RemoveTransforms(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
DialogEnded((DIALOGRESOURCE)END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3, _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Event_GaveCrownToMystra_3375fd8b-4958-421d-2d51-ff9af5beaaa0)
AND
IsTagged(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
THEN
Transform((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTERROOT)Mindflayer_Form_Player_ba20ee39-92ed-4aad-830d-4871103f48c2, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

IF
DialogEnded((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e, _)
AND
DB_Players(_Player)
THEN
ScreenFadeTo(_Player, 0.1, 1, "END_GameFinale_KarlachInAvernus_Completed");

IF
ScreenFadeDone(_, "END_GameFinale_KarlachInAvernus_Completed")
AND
DB_Players(_Player)
THEN
ClearScreenFade(_Player, 1.0, "END_GameFinale_KarlachInAvernus_Completed", 0);

PROC
PROC_END_GameFinale_ChooseNextDialog((DIALOGRESOURCE)_Dialogue)
AND
NOT DB_END_GameFinale_FatesGroupDialogues(_)
THEN
PROC_END_GameFinale_StartEpilogue();

PROC
PROC_END_GameFinale_ChooseNextDialog((DIALOGRESOURCE)_Dialogue)
AND
DB_END_GameFinale_FatesGroupDialogues(_Dialogue)
THEN
NOT DB_END_GameFinale_FatesGroupDialogues(_Dialogue);
PROC_END_GameFinale_BeginFatesGroupDialogues();
//END_REGION

//REGION Gale Seque speaker

//If Gale is an avatar and one of his final flags his set, skip Seque if there are no other main dialog anchors.
//EX: Player 1 is avatar mindflayer, kill themselves during CombatOver, baton passes to Player 2 Gale. Gale gets his Mystra scene and chooses to become a god. Skip seque.
QRY
QRY_END_GameFinale_SkipSeque()
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_END_GameFinale_NoSeque((FLAG)_Flag) //WARNING: These flags are for AVATAR GALE ONLY. We need to change the DB and patch it in if we have to expand this to more cases.
AND
DB_GlobalFlag(_Flag)
AND
NOT DB_END_General_MainDialogAnchor(_)
THEN
DB_NOOP(1);
//END_REGION

//REGION Death Of Karlach dialog
IF
FlagSet(ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d, _, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
ClearFlag((FLAG)ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d);
PROC_END_General_MakeAvatarUnavailable((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
FlagSet(END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1, _, _)
AND
DB_END_GameFinale_FatesGroupDialogues((DIALOGRESOURCE)END_GameFinale_SoloFates_Karlach_0181cc77-4b25-dd9a-025b-b08e85387645)
THEN
DB_END_GameFinale_QueuedSoloSpeaker(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_END_GameFinale_FatesGroupDialogues(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4);

IF
FlagSet(END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1, _, _)
AND
NOT QRY_END_GameFinale_MoreRomanceFatesToPlay()
AND
DB_ORI_Partnered(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Partner)
THEN
DB_END_GameFinale_QueuedPartneredSpeakers(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Partner);
DB_END_GameFinale_FatesGroupDialogues(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4);

IF
FlagSet(END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1, _, _)
AND
NOT QRY_END_GameFinale_MoreRomanceFatesToPlay()
AND
DB_ORI_Partnered_Secondary(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Partner)
AND
NOT DB_END_GameFinale_FatesGroupDialogues(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4)
THEN
DB_END_GameFinale_QueuedPartneredSpeakers(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Partner);
DB_END_GameFinale_FatesGroupDialogues(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4);

IF
FlagSet((FLAG) END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, (CHARACTER)_Player, _ID)
AND
DB_Avatars(_Player)
THEN
DB_END_GameFinale_DeathOfKarlachAvatar(_Player);
PROC_END_General_MakeAvatarUnavailable(_Player, 1);

QRY
QRY_END_GameFinale_MoreRomanceFatesToPlay()
AND
GetFlag((FLAG)ORI_State_PartneredWithHalsinSecondary_6af0be74-d032-4a20-876a-11bab5f86db2, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 1)
AND
SysCount("DB_END_GameFinale_FatesGroupDialogues", 1, _Length)
AND
IntegerSubtract(_Length, 1, _NextDialogueIndex)
AND
_NextDialogueIndex >= 0
AND
SysFactAtIndex("DB_END_GameFinale_FatesGroupDialogues", 1, _NextDialogueIndex, "DB_END_GameFinale_NextQueuedDialog")
AND
DB_END_GameFinale_NextQueuedDialog(_NextDialogue)
AND
DB_END_GameFinale_CharacterPartneredDialogs(_, _NextDialogue, _)
AND
DB_END_GameFinale_QueuedPartneredSpeakers(_NextDialogue, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _)
THEN
NOT DB_END_GameFinale_NextQueuedDialog(_NextDialogue);
ClearFlag((FLAG)END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1);
//END_REGION

//REGION Avatar Finale Blocking (Building DB)
QRY
QRY_END_GameFinale_CharacterCannotFinale((CHARACTER)_Character)
AND
DB_END_General_ForcedListener(_Character, _)
THEN
DB_NOOP(1);

QRY
QRY_END_GameFinale_CharacterCannotFinale((CHARACTER)_DarkUrgeAvatar)
AND
IsTagged(_DarkUrgeAvatar, (TAG)REALLY_DARK_URGE_cd611d7d-b67d-42b4-a75c-a0c6091ef8a2, 1)
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_GoMadEnding_a0bea44c-be8a-26e4-ded5-c6c5827d4190)
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalResisted_74944ac3-1ea0-4eae-9653-1f1319f8646b)
THEN
DB_NOOP(1);
//END_REGION

//REGION Block Dialogue Playing
QRY
QRY_END_GameFinale_DialogueCannotPlay((DIALOGRESOURCE)_Dialogue, (CHARACTER)_Avatar)
AND
_Avatar != S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c
AND
IsTagged(_Avatar, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
AND
DB_END_GameFinale_UnpartneredOriginDialogues(_, _Dialogue)
THEN
DB_NOOP(1);

QRY
QRY_END_GameFinale_DialogueCannotPlay((DIALOGRESOURCE)_Dialogue, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
IsTagged(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
AND
NOT DB_END_GameFinale_QueuedSoloSpeaker((DIALOGRESOURCE)END_GameFinale_SoloFates_Karlach_0181cc77-4b25-dd9a-025b-b08e85387645, _)
AND
NOT DB_ORI_Partnered((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _)
THEN
DB_NOOP(1);
//END_REGION

//REGION Add Romance partner if DeathOfKarlach is starting from RomanceFates
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _ID)
AND
DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_GlobalFlag((FLAG)END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1)
AND
DB_ORI_Partnered(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Partner)
THEN
PROC_DialogAddSpeakingActorAt(_ID, _Partner, 12);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _ID)
AND
DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_GlobalFlag((FLAG)END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1)
AND
DB_ORI_Partnered_Secondary(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Partner)
THEN
PROC_DialogAddSpeakingActorAt(_ID, _Partner, 12);
//END_REGION

//REGION
IF
FlagSet(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _)
THEN
SetFlag(ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e, NULL_00000000-0000-0000-0000-000000000000, 0);

//Relationship ended during END dialog
IF
FlagCleared(_Flag, _Avatar, _ID)
AND
DB_END_GameFinale_CharacterPartneredDialogs(_Flag, _, _Char)
AND
DB_END_GameFinale_CharacterPartnershipEndedFlags(_Char, _PartnershipEndedFlag)
AND
DB_END_GameFinale_FatesGroupDialogues(_Dialog)
AND
DB_DialogName(_Dialog, _ID)
THEN
SetFlag(_PartnershipEndedFlag, _Avatar);

PROC
PROC_END_GameFinale_EndRelationship((CHARACTER)_Avatar)
AND
DB_Avatars(_Avatar)
AND
DB_ORI_Partnered(_Avatar, _Companion)
THEN
PROC_END_GameFinale_EndRelationship((CHARACTER)_Avatar,(CHARACTER)_Companion);

PROC
PROC_END_GameFinale_EndRelationship((CHARACTER)_Companion)
AND
NOT DB_Avatars(_Companion)
AND
DB_ORI_Partnered(_Avatar, _Companion)
THEN
PROC_END_GameFinale_EndRelationship((CHARACTER)_Avatar,(CHARACTER)_Companion);

PROC
PROC_END_GameFinale_EndRelationship((CHARACTER)_Avatar,(CHARACTER)_Companion)
AND
DB_Avatars(_Avatar)
AND
DB_Origins(_Companion)
AND
DB_ORI_Partnered(_Avatar, _Companion)
AND
DB_END_GameFinale_CharacterPartneredDialogs(_PartneredFlag, _, _Partner)
AND
DB_END_GameFinale_CharacterPartnershipEndedFlags(_Companion, _PartnershipEndedFlag)
THEN
ClearFlag(_PartneredFlag,_Avatar);
SetFlag(_PartnershipEndedFlag, _Avatar);

//End relationship when Gale becomes a God
IF
FlagSet((FLAG)ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d, _, _)
THEN
PROC_END_GameFinale_EndRelationship((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

//Gith Rebellion
// - Orpheus Alive and NOT Mindflayer - he's the leader
PROC
PROC_END_BrainBattle_Over()
AND
NOT DB_GlobalFlag((FLAG)END_General_State_OrpheusDefeated_f502054a-3668-4e54-b742-6266d00c4ec1)
AND
NOT DB_GlobalFlag((FLAG)END_General_State_OrpheusIsMindFlayer_2b638127-f30a-424e-9d4a-a9f8f100a307)
AND
NOT DB_GlobalFlag((FLAG)END_GameFinale_State_GithRebellionStarted_c97cce94-0ba5-48a0-afaa-77ad7b240793)
THEN
SetFlag((FLAG)END_GameFinale_State_GithRebellionStarted_c97cce94-0ba5-48a0-afaa-77ad7b240793);
SetFlag((FLAG)END_GameFinale_State_GithRebellionLeaderOrpheus_eaebc71e-988a-439b-b8bc-76977b19e7a0);

// - Orpheus Dead or Mindflayer, but Laezel takes his place - Laezel's the leader
PROC
PROC_END_BrainBattle_Over()
AND
DB_GlobalFlag((FLAG)END_GameFinale_State_LaezelOrpheusPath_a74531fa-52d8-13e8-562f-d3a528e73f82)
AND
NOT DB_GlobalFlag((FLAG)END_GameFinale_State_GithRebellionStarted_c97cce94-0ba5-48a0-afaa-77ad7b240793)
THEN
SetFlag((FLAG)END_GameFinale_State_GithRebellionStarted_c97cce94-0ba5-48a0-afaa-77ad7b240793);
SetFlag((FLAG)END_GameFinale_State_GithRebellionLeaderLaezel_7b292311-5c41-43a3-902f-8fb781dba360);

// - Orpheus Dead or Mindflayer, Laezel does not take his place, but Voss is alive - Voss's the leader
PROC
PROC_END_BrainBattle_Over()
AND
NOT DB_Dead((CHARACTER)S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
AND
NOT DB_GlobalFlag((FLAG)END_GameFinale_State_GithRebellionStarted_c97cce94-0ba5-48a0-afaa-77ad7b240793)
THEN
SetFlag((FLAG)END_GameFinale_State_GithRebellionStarted_c97cce94-0ba5-48a0-afaa-77ad7b240793);
SetFlag((FLAG)END_GameFinale_State_GithRebellionLeaderVoss_68461905-b8da-4fe7-a561-aa0bb76bcd3f);

//Gith Egg epilogue state
// - Egg hatched in Act3
PROC
PROC_END_BrainBattle_Over()
AND
DB_GlobalFlag(LOW_TheLodge_State_GithKidMassacreHappened_05ef4654-5aa3-4482-8cc9-1880b0b7e1e1)
AND
QRY_OnlyOnce("EPI_Epilogue_GithEggFinalFate")
THEN
SetFlag((FLAG)EPI_Epilogue_State_GithEggHatchedInAct3_5d45cfd6-5812-41a9-a3f1-19535774abb4);

// - Egg was taken to the Astral Plane
PROC
PROC_END_BrainBattle_Over()
AND
DB_GlobalFlag((FLAG)END_GameFinale_State_LaezelOrpheusPath_a74531fa-52d8-13e8-562f-d3a528e73f82)
AND
Exists(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94, 1)
AND
GetDirectInventoryOwner(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
QRY_OnlyOnce("EPI_Epilogue_GithEggFinalFate")
THEN
SetFlag((FLAG)EPI_Epilogue_State_GithEggInAstralPlane_c31cdccc-70e0-4e46-94d0-ff154d79735c);

PROC
PROC_END_BrainBattle_Over()
AND
DB_Avatars(_Avatar)
AND
GetFlag((FLAG)ORI_Laezel_State_PlayerLaezelOrpheus_9bbf4067-fcb1-0c74-088d-ff887ca2abe5, _Avatar, 1)
AND
Exists(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94, 1)
AND
GetDirectInventoryOwner(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94, _Avatar)
AND
QRY_OnlyOnce("EPI_Epilogue_GithEggFinalFate")
THEN
SetFlag((FLAG)EPI_Epilogue_State_GithEggInAstralPlane_c31cdccc-70e0-4e46-94d0-ff154d79735c);

// - Egg remained in Faerun
PROC
PROC_END_BrainBattle_Over()
AND
Exists(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94, 1)
AND
GetDirectInventoryOwner(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94, _Chest)
AND
DB_Camp_UserCampChest(_, (ITEM)_Chest)
AND
QRY_OnlyOnce("EPI_Epilogue_GithEggFinalFate")
THEN
SetFlag((FLAG)EPI_Epilogue_State_GithEggInFaerun_4402da85-aefa-493f-a9ab-be4d6a822228);

PROC
PROC_END_BrainBattle_Over()
AND
DB_Players(_Player)
AND
GetFlag((FLAG)CRE_Hatchery_State_HasGithYankiEgg_30e136f5-b082-419f-9675-5310edaf782c, (CHARACTER)_Player, 1)
AND
NOT QRY_END_GameFinale_GithEggState_InCharacterWhoLeftFaerun(_Player)
AND
QRY_OnlyOnce("EPI_Epilogue_GithEggFinalFate")
THEN
SetFlag((FLAG)EPI_Epilogue_State_GithEggInFaerun_4402da85-aefa-493f-a9ab-be4d6a822228);

QRY
QRY_END_GameFinale_GithEggState_InCharacterWhoLeftFaerun((CHARACTER)_Player)
AND
GetFlag((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_END_GameFinale_GithEggState_InCharacterWhoLeftFaerun((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
IsTagged(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
THEN
DB_NOOP(1);

QRY
QRY_END_GameFinale_GithEggState_InCharacterWhoLeftFaerun((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)ORI_Wyll_State_AvernusWithPlayer_15059894-8ec9-157d-bbd6-2f820ec213bf)
AND
GetFlag((FLAG)ORI_State_PartneredWithWyll_5db4c1b6-3c42-43ae-aa85-1844acbf5a1d, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_END_GameFinale_GithEggState_InCharacterWhoLeftFaerun((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_GlobalFlag((FLAG)ORI_Wyll_State_InAvernusAlone_93e65371-daf0-846d-11a8-b4dec6cc2230)
THEN
DB_NOOP(1);

QRY
QRY_END_GameFinale_GithEggState_InCharacterWhoLeftFaerun((CHARACTER)_Character)
AND
DB_END_General_ForcedListener(_Character, _)
THEN
DB_NOOP(1);

QRY
QRY_END_GameFinale_GithEggState_InCharacterWhoLeftFaerun((CHARACTER)_Player)
AND
GetFlag((FLAG)ORI_Laezel_State_PlayerLaezelVlaakith_bf95c085-fe78-9cda-7aac-2d8e5b94a9cf, _Player, 1)
THEN
DB_NOOP(1);

// - Egg was lost or its last location is unknown
PROC
PROC_END_BrainBattle_Over()
AND
QRY_OnlyOnce("EPI_Epilogue_GithEggFinalFate")
THEN
SetFlag((FLAG)EPI_Epilogue_State_GithEggUnknownLocation_702a6f61-7722-4be7-9ef6-502b53307ed1);

// - Last character to have the egg
PROC
PROC_END_BrainBattle_Over()
AND
DB_Players(_Player)
AND
Exists(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94, 1)
AND
GetDirectInventoryOwner(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94, _Player)
THEN
SetFlag((FLAG)EPI_Epilogue_State_EndedGameWithGithEgg_8116a680-d8a2-4dd5-a281-ebd2705257f1, _Player);
//END_REGION


//REGION Epilogue

//Handle before EPI setup to avoid flag timing conflicts
//End relationship with partner if they went to Avernus without them
PROC
PROC_END_GameFinale_StartEpilogue()
AND
DB_Avatars((CHARACTER)_Avatar)
AND
GetFlag(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Avatar, 1)
AND
DB_ORI_Partnered(_Avatar, _Companion)
AND
NOT QRY_END_GameFinale_WillStayWithAvatarInAvernus((CHARACTER)_Companion)
THEN
PROC_END_GameFinale_EndRelationship(_Avatar, _Companion);

QRY
QRY_END_GameFinale_WillStayWithAvatarInAvernus((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_NOOP(1);

QRY
QRY_END_GameFinale_WillStayWithAvatarInAvernus((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_GlobalFlag(ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
THEN
DB_NOOP(1);

//Wyll went with Karlach without romanced player
PROC
PROC_END_GameFinale_StartEpilogue()
AND
DB_GlobalFlag(ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
DB_ORI_Partnered(_Avatar, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
_Avatar != S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c
AND
GetFlag(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Avatar, 0)
THEN
PROC_END_GameFinale_EndRelationship(_Avatar);
SetFlag(ORI_Wyll_State_TogetherButApart_87cd3adb-f4b0-44c0-9c35-d5fa1f0b0784, _Avatar);

//End relationship if they left with Lae'zel 
PROC
PROC_END_GameFinale_StartEpilogue()
AND
DB_Avatars((CHARACTER)_Avatar)
AND
GetFlag(ORI_Laezel_State_PlayerLaezelOrpheus_9bbf4067-fcb1-0c74-088d-ff887ca2abe5, _Avatar, 1)
AND
DB_ORI_Partnered(_Avatar, _Companion)
AND
_Companion != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
THEN
PROC_END_GameFinale_EndRelationship(_Avatar,_Companion);

//Comp Lae'zel ends relationship when she leaves to Vlaakith
PROC
PROC_END_GameFinale_StartEpilogue()
AND
NOT DB_GlobalFlag(ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56)
AND
DB_GlobalFlag(END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
GetFlag(ORI_Laezel_State_PlayerLaezelVlaakith_bf95c085-fe78-9cda-7aac-2d8e5b94a9cf, _Avatar, 0) //Didn't go with her
AND
DB_ORI_Partnered(_Avatar, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
PROC_END_GameFinale_EndRelationship(_Avatar,S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

//Avatar Lae'zel leaves without their partner
PROC
PROC_END_GameFinale_StartEpilogue()
AND
DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_ORI_Partnered(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Companion)
AND
DB_GlobalFlag(END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209)
THEN
PROC_END_GameFinale_EndRelationship(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Companion);

PROC
PROC_END_GameFinale_StartEpilogue()
AND
NOT DB_EPI_Epilogue_Disabled(1)
AND
QRY_OnlyOnce("EPI_Epilogue_Setup")
THEN
PROC_TeleportPartiesTo(S_EPI_LevelLoadToPoint_3e1909dc-d482-431f-a029-3c1ff97f4127, "EPI_Epilogue_PartyArrived");

PROC
PROC_END_GameFinale_StartEpilogue()
AND
QRY_OnlyOnce("EPI_Epilogue_Setup")
THEN
PROC_END_GodsAndMonsters_RollCredits("END_GodsAndMonsters_GameFinished");
//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3c"
