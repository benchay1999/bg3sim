Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Divine Bard
//TODO: Change flag names to match tracks once we have a track list
DB_EPI_Epilogue_DivineBardTracks("EPI_DIVINE_BARD_PERFORM_BALDURANALE", "EPI_BardScripted_CampBard_Ale_of_Balduran");
DB_EPI_Epilogue_DivineBardTracks("EPI_DIVINE_BARD_PERFORM_BARDDANCE", "EPI_BardScripted_CampBard_Bard_Dance");
DB_EPI_Epilogue_DivineBardTracks("EPI_DIVINE_BARD_PERFORM_NEWLIGHT", "EPI_BardScripted_CampBard_New_Light");
DB_EPI_Epilogue_DivineBardTracks("EPI_DIVINE_BARD_PERFORM_STREETSANDFACES", "EPI_BardScripted_CampBard_Streets_and_Faces");
DB_EPI_Epilogue_DivineBardTracks("EPI_DIVINE_BARD_PERFORM_WELIVE", "EPI_BardScripted_CamBard_We_Live_Another_Day");
DB_EPI_Epilogue_DivineBardTracks("EPI_DIVINE_BARD_PERFORM_EPILOGUESONG", "EPI_BardScripted_Endless_Spring");

DB_EPI_Epilogue_DivineBardInstruments(S_EPI_DivineBardLyre_74af38fc-39bc-447a-a303-95a9f1674fd9);
DB_EPI_Epilogue_DivineBardInstruments(S_EPI_DivineBardViolin_958ecdfa-d26b-44ed-abc1-eb77db80f2e5);
DB_EPI_Epilogue_DivineBardInstruments(S_EPI_DivineBardDrum_970d77bc-ef06-4072-b093-cbbc9ccecb73);
DB_EPI_Epilogue_DivineBardInstruments(S_EPI_DivineBardLute_e1f14b08-a678-4c84-8ebe-068875730b6d);

DB_GLO_ExclusiveFlag("EPI_Epilogue_ExlusiveDivineBardTracks", (FLAG)EPI_Epilogue_State_DivineBardTrack001_14fa0523-1e89-f332-5418-44784c5cde7c);
DB_GLO_ExclusiveFlag("EPI_Epilogue_ExlusiveDivineBardTracks", (FLAG)EPI_Epilogue_State_DivineBardTrack002_9deefcc1-3c78-761a-5998-e0d0df9b4e65);
DB_GLO_ExclusiveFlag("EPI_Epilogue_ExlusiveDivineBardTracks", (FLAG)EPI_Epilogue_State_DivineBardTrack003_a92b0fb8-d4a7-8e5c-b840-d4b630d5c049);
DB_GLO_ExclusiveFlag("EPI_Epilogue_ExlusiveDivineBardTracks", (FLAG)EPI_Epilogue_State_DivineBardTrack004_5dc969ee-9020-daab-6698-3445d6ed5ddb);
DB_GLO_ExclusiveFlag("EPI_Epilogue_ExlusiveDivineBardTracks", (FLAG)EPI_Epilogue_State_DivineBardTrack005_1b328c9b-64f8-a5db-d2da-f058ebc12797);
DB_GLO_ExclusiveFlag("EPI_Epilogue_ExlusiveDivineBardTracks", (FLAG)EPI_Epilogue_State_DivineBardTrack006_b3ba3ad3-af4a-40bc-a90f-0bdea8d93646);

DB_EPI_Epilogue_DEBUG_DivineBardTracks("EPI_BardScripted_CampBard_Ale_of_Balduran", 1);
DB_EPI_Epilogue_DEBUG_DivineBardTracks("EPI_BardScripted_CampBard_Bard_Dance", 2);
DB_EPI_Epilogue_DEBUG_DivineBardTracks("EPI_BardScripted_CampBard_New_Light", 3);
DB_EPI_Epilogue_DEBUG_DivineBardTracks("EPI_BardScripted_CampBard_Streets_and_Faces", 4);
DB_EPI_Epilogue_DEBUG_DivineBardTracks("EPI_BardScripted_CamBard_We_Live_Another_Day", 5);
DB_EPI_Epilogue_DEBUG_DivineBardTracks("EPI_BardScripted_Endless_Spring", 6);
//END_REGION

//REGION Characters
//DB_EPI_Epilogue_PresentNPC(_Char, _Dialog, _StandingPoint, _Config, _PresentFlag)
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)EPI_Epilogue_Astarion_15cbfbfa-48f6-46b9-7a6c-adc599950edb,(TRIGGER)S_EPI_StartPointAstarion_9376b48c-5f8f-4ac9-b89c-65609d9f8478, "EPI_Astarion",(FLAG)EPI_Epilogue_State_AstarionPresent_d742f00c-889a-4d7b-acaa-343f8a354607);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)EPI_Epilogue_Gale_307db971-b5c4-9e20-cf18-dc1290d31a70,(TRIGGER)S_EPI_StartPointGale_eb5481f4-5b2e-485f-ba3d-7cb3cd066872, "EPI_Gale",(FLAG)EPI_Epilogue_State_GalePresent_5693605b-02e5-4076-8555-f546ad08eb53);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)EPI_Epilogue_Karlach_a1c25678-51e5-6ae4-c0c0-221d83efff39,(TRIGGER)S_EPI_StartPointKarlach_5f2aeaee-e1ab-4670-a93d-43b59f250a37, "EPI_Karlach",(FLAG)EPI_Epilogue_State_KarlachPresent_fec802e3-7904-4859-bc5e-c63bfd4b3783);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (DIALOGRESOURCE)EPI_Epilogue_Laezel_6f90acb4-5eec-9c0b-9f00-142afb62be6f,(TRIGGER)S_EPI_StartPointLaezel_a81f6790-a4b6-4ee0-a23e-a64d6a23980f, "EPI_Laezel",(FLAG)EPI_Epilogue_State_LaezelPresent_614de8c3-2df5-43c6-b0e9-b8dbd8c3bb37);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)EPI_Epilogue_Shadowheart_f591e79a-c6e0-6b0e-b1f7-99fca36a7449,(TRIGGER)S_EPI_StartPointShadowheart_18c42a94-a57a-4a55-9d7c-dd67a49d8bbb, "EPI_Shadowheart",(FLAG)EPI_Epilogue_State_ShadowheartPresent_60d0df30-0d71-4cf9-8808-13c4612014b6);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (DIALOGRESOURCE)EPI_Epilogue_Wyll_21596d94-3150-60a6-4c08-3bab006fb4ce,(TRIGGER)S_EPI_StartPointWyll_698f8e46-535d-4693-9213-8f3bde665e66, "EPI_Wyll",(FLAG)EPI_Epilogue_State_WyllPresent_98163450-fd0a-4807-a872-a5afc0f54ed4);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)EPI_Epilogue_Minsc_63303e23-2eaa-a2e3-3ff8-dfda0d5a6fd8,(TRIGGER)S_EPI_StartPointMinsc_69064f06-ab8a-4ce1-974b-1645f441de0f, "EPI_Minsc",(FLAG)EPI_Epilogue_State_MinscPresent_4248df42-fb07-4266-9731-2a8b01e3935b);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (DIALOGRESOURCE)EPI_Epilogue_Minthara_6abc74c0-ee44-e624-a60b-0bff0d993f29,(TRIGGER)S_EPI_StartPointMinthara_872081ff-efc2-4829-bef9-9877490c79c2, "EPI_Minthara",(FLAG)EPI_Epilogue_State_MintharaPresent_62daf94d-8677-4ce8-8cd4-f50afadb0017);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)EPI_Epilogue_Halsin_18b51f0c-25b6-cde8-193d-2b9aaa807434,(TRIGGER)S_EPI_StartPointHalsin_133cd1e7-9c15-4593-84fa-e9b5cec484a2, "EPI_Halsin",(FLAG)EPI_Epilogue_State_HalsinPresent_e6847fa6-678a-4b4c-bb3b-4cfa61fbeb40);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (DIALOGRESOURCE)EPI_Epilogue_Jaheira_9bb34a4a-9632-079a-6286-7a0e234eaa3e,(TRIGGER)S_EPI_StartPointJaheira_f0ef51bf-c1ff-4053-92eb-9ac86da25305, "EPI_Jaheira",(FLAG)EPI_Epilogue_State_JaheiraPresent_2b037230-1c7e-4064-815c-b97f08f1d0d9);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, (DIALOGRESOURCE)EPI_Epilogue_Tara_e072e162-4f02-7f72-9bfc-373d867844a1,(TRIGGER)S_EPI_StartPointTara_276ebe78-44d3-4fe7-8a75-5ba55c628799, "EPI_Tara",(FLAG)EPI_Epilogue_State_TaraPresent_3a3c5588-9b88-42bd-9357-8596543cbb36);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, (DIALOGRESOURCE)EPI_Epilogue_Withers_a778eace-f227-ac58-c231-75716eaba156,(TRIGGER)S_EPI_StartPointWithers_37a4d86e-a04c-4776-a556-be67d0624017, "EPI_Withers",(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, (DIALOGRESOURCE)EPI_Epilogue_Scratch_8dab6df1-2b84-89f2-1a3d-13b667bf0096,(TRIGGER)S_EPI_StartPointScratch_e291d47d-b809-4004-96b5-aa9ca519c32e, "EPI_Scratch",(FLAG)EPI_Epilogue_State_ScratchPresent_e0c535d3-9610-4073-9047-73b40c5b8631);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, (DIALOGRESOURCE)EPI_Epilogue_Owlbear_b672742d-ac9d-179e-c0ab-0f7e3d271e51,(TRIGGER)S_EPI_StartPointOwlbear_c35155d5-12ed-4ea4-9c92-232212ab8ff2, "EPI_Owlbear",(FLAG)EPI_Epilogue_State_OwlbearPresent_c82fdbb9-6a15-4f06-95d2-7e4babf2a982);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa, (DIALOGRESOURCE)EPI_Epilogue_Volo_48cbeefa-9f5a-e5f3-08a9-44791fc03a8b,(TRIGGER)S_EPI_StartPointVolo_4cb13df7-fa3a-445e-a46a-07a3fe8da9a1, "EPI_Volo",(FLAG)EPI_Epilogue_State_VoloPresent_d0b1685b-3f6b-4b83-a8c3-b72d6d6e7bcb);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c, (DIALOGRESOURCE)EPI_Epilogue_TerrifiedThief_84e18005-dd2d-07cc-f766-200bed4a580f,(TRIGGER)S_EPI_StartPointTerrifiedThief_7fe87a2c-b620-47da-862c-99ef33772baf, "EPI_TerrifiedThief",(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, (DIALOGRESOURCE)EPI_Epilogue_DivineBard_638b3683-ac20-9a7f-4af0-c1c0fa5fb98e,(TRIGGER)S_EPI_DivineBardPoint_1f79f72a-6688-4dc9-9d42-b45b89dded2e, "EPI_DivineBard",(FLAG)NULL_00000000-0000-0000-0000-000000000000);

DB_GLO_Minsc_BooDialogs((DIALOGRESOURCE)EPI_Epilogue_Minsc_63303e23-2eaa-a2e3-3ff8-dfda0d5a6fd8);
DB_GLO_Minsc_BooDialogs((DIALOGRESOURCE)EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd);
DB_GLO_Minsc_BooDialogs((DIALOGRESOURCE)EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771);

DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,(FACTION)ACT3_EPI_Astarion_4bd71e30-d5c7-497e-a608-4a9ed18ed475);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,(FACTION)ACT3_EPI_Gale_e4a4cea5-fedd-4fc7-b707-b8da95dfd099);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d,(FACTION)ACT3_EPI_SpectralVoiceGale_ce3575b5-b454-4c31-88f6-668c37f308ec);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,(FACTION)ACT3_EPI_Karlach_964cf3a0-c1ca-48f1-96ee-53e4d8a44a6b);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(FACTION)ACT3_EPI_Laezel_76d5d487-f4a8-4275-bd4b-2d8962ec676d);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FACTION)ACT3_EPI_Shadowheart_06958d14-41f3-40c6-8382-3c729c5da176);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(FACTION)ACT3_EPI_Wyll_187fe82f-1d76-4b95-b1b1-bff2295d57b4);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(FACTION)ACT3_EPI_Minsc_bbbaecd6-6f85-4d86-ab16-1078292a158a);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,(FACTION)ACT3_EPI_Minthara_ffa4626a-2853-4263-b4eb-3afc2a9ae27f);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,(FACTION)ACT3_EPI_Halsin_4e561cc7-792f-4ad1-85f4-ff340707f647);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(FACTION)ACT3_EPI_Jaheira_fc2e2f1d-b9c7-4272-96f1-f38c837ff119);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236,(FACTION)ACT3_EPI_Tara_94cd152c-dc60-48c3-ac32-a4f455092bd0);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,(FACTION)ACT3_EPI_Withers_d352b7cf-9202-4894-9ccd-d9db3d1596fa);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901,(FACTION)ACT3_EPI_Scratch_da4da548-7e6a-4d45-b30d-43b2068b81a5);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,(FACTION)ACT3_EPI_Owlbear_1a37c526-9372-4156-b6aa-2a9f91ee4efc);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,(FACTION)ACT3_EPI_Volo_b8ec627b-972d-4811-874c-a90637c9c061);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c,(FACTION)ACT3_EPI_TerrifiedThief_681e3c48-9203-474c-8793-ee565c98771f);
DB_EPI_Epilogue_CharacterFaction((CHARACTER)S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c,(FACTION)ACT3_EPI_DivineBard_4ab7ca06-aab6-42d1-a135-0f72b296a983);

DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Astarion", 		(CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 	 (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeAstarion_289f64f4-8169-2707-fdcf-846baec27d36);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Gale", 			(CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 	 	 (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeGale_22a33f6d-9c09-b660-b9ea-94dee5a0e805);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Halsin", 		(CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 		 (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeHalsin_3e90e86a-865b-c800-3494-35a0222603ce);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Jaheira", 		(CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 	 (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeJaheira_2e98b32f-6410-2d3b-6d49-f96c1beb490d);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Karlach", 		(CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 	 (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeKarlach_0e5bbd39-5ae8-afb3-3917-1ea555cb657a);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Laezel", 		(CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 	 (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeLaezel_e0175ab4-5ba0-b0dc-1aa8-0f5cfce27a53);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Minsc", 		(CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, 		 (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeMinsc_05f2bb9a-a615-3fc1-5249-7b677bca2738);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Minthara", 		(CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,  (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeMinthara_d562dad5-9bc3-4b8d-406e-fb6f378c8b35);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Shadowheart", 	(CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeShadowheart_14d83d94-5b35-6ac7-b8e4-3758bf04d1d6);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Volo", 			(CHARACTER)S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa, 			 (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeVolo_926715f8-c2e0-a7d3-c8f9-a8735581ad1b);
DB_EPI_Epilogue_WelcomeADs("EPI_Welcome_Wyll", 			(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 		 (DIALOGRESOURCE)EPI_Epilogue_AD_WelcomeWyll_663c36ed-368c-d853-a329-025a74ddb1ae);

DB_SceneAllowAllDisturbances("EPI_Epilogue_ViolentClosureScene");
SetTag((CHARACTER)S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa, 			 (TAG)ACT3_EPI_VOLO_REACTTOGHOST_a422c0f0-d5ba-4e4a-889c-e637a0f78b9e);
SetTag((CHARACTER)S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c, (TAG)ACT3_EPI_TERRIFIEDTHIEF_REACTTOGHOST_1a501762-06c7-4399-9f20-05e5ab0881d4);
PROC_SetOnStage(S_EPI_KarlachDoo_7786dad6-3e8c-4c3e-895d-6486e7ffbe14, 0);

//Halsin and Astarion can be wildshaped as part of their EPI behaviours - talking to them should drop the status and not restore it. Dialog is already added to DropMutingStatuses
DB_Dialogs_DialogBlockRestoreMutingStatuses((DIALOGRESOURCE)EPI_Epilogue_Halsin_18b51f0c-25b6-cde8-193d-2b9aaa807434, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs_DialogBlockRestoreMutingStatuses((DIALOGRESOURCE)EPI_Epilogue_Astarion_Lord_fea2b09f-0667-ea1f-a410-3afca64b95cd, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
//END_REGION

//REGION Party Gear
//DB_EPI_Epilogue_PartyEquipment(_Char, _Flag, _Bool, _Itemroot)
//Astarion
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,(FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, 0,(ITEMROOT)EPI_Camp_Spawn_13084436-5d19-4cef-ae53-02857497fc28);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,(FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, 0,(ITEMROOT)EPI_Camp_Shoes_Spawn_5fdac3e9-455c-49e0-83a0-3222108f5651);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,(FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, 1,(ITEMROOT)EPI_Camp_Ascendant_76f26388-daff-440a-a4f3-dba4f78e548c);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,(FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, 1,(ITEMROOT)EPI_Camp_Shoes_Ascendant_8b6555b8-fcf1-4535-b9cd-7e94208ce840);
//Gale
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,(FLAG)ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d, 0,(ITEMROOT)EPI_Camp_Gale_1cb24313-5ed1-43b7-ab4a-cdf2118422ea);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,(FLAG)ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d, 0,(ITEMROOT)EPI_Camp_Shoes_Gale_dbe8fe69-736f-4ceb-8a98-57d1f9a639be);
//Karlach
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,(FLAG)NULL_00000000-0000-0000-0000-000000000000, 1,(ITEMROOT)EPI_Camp_Avernus_24149d5d-c509-48dc-b026-491c11e60a5c);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,(FLAG)NULL_00000000-0000-0000-0000-000000000000, 1,(ITEMROOT)EPI_Camp_Shoes_Avernus_c36967e4-26c5-4f2f-b25b-f351a6bac804);
//Lae'zel
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(FLAG)END_GameFinale_State_LaezelInFaerun_3cb6879c-f4e7-bb31-584a-63bea28ecb75, 1,(ITEMROOT)EPI_Camp_Laezel_Faerun_9747dbb0-0f92-483e-80fc-391390d416f9);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(FLAG)END_GameFinale_State_LaezelInFaerun_3cb6879c-f4e7-bb31-584a-63bea28ecb75, 1,(ITEMROOT)EPI_Camp_Shoes_Laezel_Faerun_cba5d95b-d2a6-4253-abe1-c81da0391c0c);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(FLAG)END_GameFinale_State_LaezelInFaerun_3cb6879c-f4e7-bb31-584a-63bea28ecb75, 0,(ITEMROOT)EPI_Camp_Laezel_Gith_8c953ad4-1103-4215-9a09-ff95e51cc8e4);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(FLAG)END_GameFinale_State_LaezelInFaerun_3cb6879c-f4e7-bb31-584a-63bea28ecb75, 0,(ITEMROOT)EPI_Camp_Shoes_Laezel_Gith_a8f1228b-1cdc-4b5c-abf4-d19f41b6bc30);
//Shadowheart
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)ORI_Shadowheart_State_Shar_KilledParents_3a3b0ecf-a1ed-4733-8548-0348befc6bac, 1,(ITEMROOT)EPI_Camp_Shar_8fc09773-7083-466a-8988-e030b6d647e3);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)ORI_Shadowheart_State_Shar_KilledParents_3a3b0ecf-a1ed-4733-8548-0348befc6bac, 1,(ITEMROOT)EPI_Camp_Shoes_Shar_e3b092c6-82e8-49df-843c-40d643410171);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)ORI_Shadowheart_State_Shar_SavedParents_8a0fad17-1615-4a0d-a045-21661d9a2aa0, 1,(ITEMROOT)EPI_Camp_Selune_79bb5a64-2019-4818-a898-de179b6bc44c);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)ORI_Shadowheart_State_Shar_SavedParents_8a0fad17-1615-4a0d-a045-21661d9a2aa0, 1,(ITEMROOT)EPI_Camp_Shoes_Selune_4f7febc5-fadd-45f2-96c1-d2447fec12bd);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)ORI_Shadowheart_State_RejectShar_KilledParents_e9060caf-66b0-4701-8dfd-5ae1125f5afd, 1,(ITEMROOT)EPI_Camp_Selune_79bb5a64-2019-4818-a898-de179b6bc44c);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)ORI_Shadowheart_State_RejectShar_KilledParents_e9060caf-66b0-4701-8dfd-5ae1125f5afd, 1,(ITEMROOT)EPI_Camp_Shoes_Selune_4f7febc5-fadd-45f2-96c1-d2447fec12bd);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)ORI_Shadowheart_State_RejectShar_SavedParents_486d69d4-a7c2-4cb5-8fcb-8f2cb738ada9, 1,(ITEMROOT)EPI_Camp_Selune_79bb5a64-2019-4818-a898-de179b6bc44c);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)ORI_Shadowheart_State_RejectShar_SavedParents_486d69d4-a7c2-4cb5-8fcb-8f2cb738ada9, 1,(ITEMROOT)EPI_Camp_Shoes_Selune_4f7febc5-fadd-45f2-96c1-d2447fec12bd);
//Wyll
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd, 1,(ITEMROOT)EPI_Camp_Wyll_Duke_7f89e3b8-61ef-498b-bd1b-77f996c5ec42);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd, 1,(ITEMROOT)EPI_Camp_Shoes_Wyll_Duke_4aa0dbb1-f51a-45bc-8a58-814ac5063035);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1, 1,(ITEMROOT)EPI_Camp_Wyll_Blade_46c97e62-7d3e-449f-a130-586e8e871947);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1, 1,(ITEMROOT)EPI_Camp_Shoes_Wyll_Blade_c3f02e6c-d519-40d1-b686-a241a9f9972e);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137, 1,(ITEMROOT)EPI_Camp_Avernus_24149d5d-c509-48dc-b026-491c11e60a5c);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137, 1,(ITEMROOT)EPI_Camp_Shoes_Avernus_c36967e4-26c5-4f2f-b25b-f351a6bac804);
//Minsc
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(FLAG)LOW_Guildhall_State_PostCoup_GuildControlled_596f7f8b-2de2-4550-87fd-9535c2a07635, 1,(ITEMROOT)EPI_Camp_Minsc_54c4b72d-0f2d-40be-bab7-c70c5f3adb97);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(FLAG)LOW_Guildhall_State_PostCoup_GuildControlled_596f7f8b-2de2-4550-87fd-9535c2a07635, 1,(ITEMROOT)EPI_Camp_Shoes_Minsc_19963131-982a-44b2-afd8-c2edee9e1b3a);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(FLAG)LOW_Guildhall_State_PostCoup_GuildControlled_596f7f8b-2de2-4550-87fd-9535c2a07635, 0,(ITEMROOT)EPI_Camp_Prison_ffe2cacb-8073-4e6d-bf81-057da0c5030c);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(FLAG)LOW_Guildhall_State_PostCoup_GuildControlled_596f7f8b-2de2-4550-87fd-9535c2a07635, 0,(ITEMROOT)ARM_Camp_Shoes_Minsc_836e13ab-78a6-4ca3-ba8e-adc4c25205f1);
//Minthara
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,(FLAG)ORI_Minthara_State_SiezeBaldursGate_91693c25-e33d-a400-4414-39a45ebdd13d, 0,(ITEMROOT)EPI_Camp_Minthara_Drow_9c035563-05ee-47e1-a3e0-e0420a07f534);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,(FLAG)ORI_Minthara_State_SiezeBaldursGate_91693c25-e33d-a400-4414-39a45ebdd13d, 0,(ITEMROOT)EPI_Camp_Shoes_Minthara_Drow_7e633d92-271b-4aaf-9880-dd1643bd41a3);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,(FLAG)ORI_Minthara_State_SiezeBaldursGate_91693c25-e33d-a400-4414-39a45ebdd13d, 1,(ITEMROOT)EPI_Camp_Minthara_7d65044d-0d01-44c8-b665-165f0ecc768c);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,(FLAG)ORI_Minthara_State_SiezeBaldursGate_91693c25-e33d-a400-4414-39a45ebdd13d, 1,(ITEMROOT)EPI_Camp_Shoes_Minthara_00d8d8fc-1820-47de-9956-5d4a68a40700);
//Halsin
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,(FLAG)NULL_00000000-0000-0000-0000-000000000000, 1,(ITEMROOT)EPI_Camp_Halsin_d873fb44-94c7-4b74-a272-1d2e5e43a7ef);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,(FLAG)NULL_00000000-0000-0000-0000-000000000000, 1,(ITEMROOT)EPI_Camp_Shoes_Halsin_8a40655e-69df-45ab-b1cd-7164c2e29fd4);
//Jaheira
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(FLAG)ORI_Jaheira_State_Retired_5a034473-9b26-e8f6-28c2-9c012372c5de, 1,(ITEMROOT)EPI_Camp_Jaheira_e22c8a04-ab6b-4315-a784-81fabb2b8db9);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(FLAG)ORI_Jaheira_State_Retired_5a034473-9b26-e8f6-28c2-9c012372c5de, 1,(ITEMROOT)EPI_Camp_Shoes_Jaheira_6d7169af-9b41-42dc-be4f-ece1486cd70e);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(FLAG)ORI_Jaheira_State_Retired_5a034473-9b26-e8f6-28c2-9c012372c5de, 0,(ITEMROOT)EPI_Camp_Jaheira_Harper_bdef460b-374e-45d6-86f7-d272a927b380);
DB_EPI_Epilogue_PartyEquipment((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(FLAG)ORI_Jaheira_State_Retired_5a034473-9b26-e8f6-28c2-9c012372c5de, 0,(ITEMROOT)EPI_Camp_Shoes_Jaheira_Harper_f7018235-a244-43f0-86e9-25b38fcd11a6);


DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,(ITEMROOT)Underwear_Astarion_4b30a649-fd88-4f64-a57b-1149d7b9ac41);
DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,(ITEMROOT)Underwear_Gale_5cdc0fe0-dbda-4f31-89f8-9e16782daef1);
DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,(ITEMROOT)Underwear_Halsin_9ebb9117-a0ae-46f2-a243-8d67650e9586);
DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(ITEMROOT)Underwear_Jaheira_91259e65-dd71-4312-ba3c-c55757978788);
DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,(ITEMROOT)Underwear_Karlach_e865db4c-4df3-48e9-8cf3-5abad75510ba);
DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(ITEMROOT)Underwear_Laezel_185ab1be-e93d-4518-b053-d6d4d7168d68);
DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(ITEMROOT)Underwear_Minsc_48a3ffbe-f14e-4cfe-b45e-ebadb3af0fd4);
DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,(ITEMROOT)Underwear_Minthara_73874ef8-a3c4-4a68-8d2a-ed3d580dfb52);
DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(ITEMROOT)Underwear_Shadowheart_b460bd0c-58fe-4a56-831c-af92fd4ba7e2);
DB_EPI_Epilogue_PartyUnderwear((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(ITEMROOT)Underwear_Wyll_1930ceec-4a50-43d9-8589-94593c449be4);

DB_EPI_Epilogue_FallbackPartyEquipment((ITEMROOT)EPI_Camp_PartyTav_1_edb02b0e-3d91-4a81-a37d-f151bad68c6d, 1);
DB_EPI_Epilogue_FallbackPartyEquipment((ITEMROOT)EPI_Camp_Shoes_PartyTav_1_7dec9f3e-3a90-4588-a995-2986340866c6, 1);
DB_EPI_Epilogue_FallbackPartyEquipment((ITEMROOT)EPI_Camp_PartyTav_2_98cdd18d-2d8a-4aca-a46b-c4829833482f, 2);
DB_EPI_Epilogue_FallbackPartyEquipment((ITEMROOT)EPI_Camp_Shoes_PartyTav_2_ff7d64c3-3969-44f6-98ee-0add1fb69fef, 2);
DB_EPI_Epilogue_FallbackPartyEquipment((ITEMROOT)EPI_Camp_PartyTav_3_782e430e-caef-42eb-abc4-6406544e9714, 3);
DB_EPI_Epilogue_FallbackPartyEquipment((ITEMROOT)EPI_Camp_Shoes_PartyTav_3_773924ee-02cd-42e7-8480-0c42896f700e, 3);
DB_EPI_Epilogue_FallbackPartyEquipment((ITEMROOT)EPI_Camp_PartyTav_4_eedda7b5-c1f4-4633-8034-30e63f7ce581, 4);
DB_EPI_Epilogue_FallbackPartyEquipment((ITEMROOT)EPI_Camp_Shoes_PartyTav_4_810351d6-75ff-4c95-8f65-fcbfb5d0c19d, 4);

DB_EPI_Epilogue_FallbackPartySetIteration(0);

DB_EPI_Epilogue_FallbackPartyUnderwear((TAG)REALLY_DRAGONBORN_39783f17-8484-46a6-aa3b-f3d51122e5f3,(ITEMROOT)Underwear_Dragonborn_A_8494f6d9-d588-4d18-bb0d-c5a58e911771);
DB_EPI_Epilogue_FallbackPartyUnderwear((TAG)REALLY_DWARF_ad129444-0f41-4114-9ee5-2b9902d7ca8d,(ITEMROOT)Underwear_Dwarves_A_9fecf84d-911f-4986-9454-0429ac437f45);
DB_EPI_Epilogue_FallbackPartyUnderwear((TAG)REALLY_ELF_772b1dc6-14be-417f-afa3-c6cf364f45b4,(ITEMROOT)Underwear_Elves_A_0ec7d956-e65f-4bfa-b677-22f399f81a32);
DB_EPI_Epilogue_FallbackPartyUnderwear((TAG)REALLY_GITHYANKI_e49c027c-6ec6-4158-9afb-8b59236d10fd,(ITEMROOT)Underwear_Githyanki_A_1cb3fb1b-2dfc-446a-9c9b-666eb0de05d6);
DB_EPI_Epilogue_FallbackPartyUnderwear((TAG)REALLY_GNOME_42483542-7915-4de5-a7d9-ac0d15fe301c,(ITEMROOT)Underwear_Gnomes_A_d692d48f-9a39-4001-8a38-c01e397953dc);
DB_EPI_Epilogue_FallbackPartyUnderwear((TAG)REALLY_HALFORC_ab3eff19-d094-4102-88bd-d097b6b6e4f0,(ITEMROOT)Underwear_HalfOrcs_A_3caad2f1-719f-4070-b7f0-887c49c773d3);
DB_EPI_Epilogue_FallbackPartyUnderwear((TAG)REALLY_HALFLING_2b40a033-7a5c-47e9-92f0-7de9b5cd3a42,(ITEMROOT)Underwear_Halflings_A_78063154-288f-41aa-a99f-e56cbf601129);
DB_EPI_Epilogue_FallbackPartyUnderwear((TAG)REALLY_HUMAN_8e288154-e7ca-4277-b2df-e61639b1cce8,(ITEMROOT)Underwear_Humans_A_d40b567d-6b66-447e-8923-2bbd0d7aea00);
DB_EPI_Epilogue_FallbackPartyUnderwear((TAG)REALLY_TIEFLING_7bf7207f-7406-49c0-b501-eaaa2bb4efd7,(ITEMROOT)Underwear_Tieflings_A_498c155f-8675-4a55-9cb0-89dd7270469f);

//END_REGION

//REGION Dialogs
//Possible starting dialogs
DB_EPI_Epilogue_OpeningDialogs(EPI_Epilogue_AvatarLockedAway_d89bd31e-787a-0293-5314-42641d243b81);
DB_EPI_Epilogue_OpeningDialogs(EPI_Epilogue_AvatarLeftEarly_ae9cd608-5688-63d6-1ecc-355496e2a6be);
DB_EPI_Epilogue_OpeningDialogs(EPI_Epilogue_VlaakithAscension_0a3237fc-7a3c-6e32-6ffa-72d459ff49cb);

//Final Toast dialog
DB_DropMutingStatussesDialog(EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771);

//Possible closing dialogs that follow the final toast (mainly dead/missing avatars).
DB_EPI_Epilogue_ClosingDialogs(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5);
DB_EPI_Epilogue_ClosingDialogs(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887);


//Possible closing dialogs that follow the final toast (mainly dead/missing avatars).

DB_IgnoreMutingStatussesDialog(EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd);
DB_DropMutingStatussesDialog(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5);
DB_DropMutingStatussesDialog(EPI_Epilogue_VlaakithAscension_0a3237fc-7a3c-6e32-6ffa-72d459ff49cb);
DB_DropMutingStatussesDialog(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887);
DB_DropMutingStatussesDialog(EPI_Epilogue_AvatarLeftEarly_ae9cd608-5688-63d6-1ecc-355496e2a6be);
DB_DropMutingStatussesDialog(EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045);
DB_DropMutingStatussesDialog(EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771);

//DB_EPI_Epilogue_QueuedClosingDialogs(_Dialog, _Avatar)
//DB_EPI_Epilogue_ClosingDialogs is used for order

DB_DialogBlockTradeButton(EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045);
DB_DialogBlockAttackButton(EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045);
DB_DialogBlockTradeButton(EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771);
DB_DialogBlockAttackButton(EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771);
DB_DialogBlockTradeButton(EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd);
DB_DialogBlockAttackButton(EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd);

DB_FlagReactionAfterDialog((FLAG)EPI_Epilogue_State_EndEpilogue_72e1d047-ec76-4b10-b2f3-fb6929105059,(DIALOGRESOURCE)EPI_Epilogue_Withers_a778eace-f227-ac58-c231-75716eaba156);

DB_DialogStarted_IgnoreStopConditions(EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045);
DB_DialogStarted_IgnoreStopConditions(EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771);
DB_DialogStarted_IgnoreStopConditions(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887);
DB_DialogStarted_IgnoreStopConditions(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5);

DB_EPI_Epilogue_MindFlayerUrgeChance(0);
//END_REGION

DB_HasItemEvent(S_EPI_InertArtefact_c4a6e98b-3707-4111-833f-26c8cd45580e, (FLAG)EPI_Epilogue_State_HasInertArtefact_855ec61c-4c00-4e3f-8802-ba7b2d6a3958);

//Halsins Duck - Item lives in asylum because the dialog can't deal with pickpocketing in the middle of the flow
DB_GiveItemToEvent(S_EPI_HalsinsDuck_b59b5990-bdf3-475e-8284-baa9de260aa5, (FLAG)EPI_Epilogue_Halsin_Event_GivesDuck_f24a8111-0661-484c-98aa-a3b50542c570);
DB_HasItemEvent(S_EPI_HalsinsDuck_b59b5990-bdf3-475e-8284-baa9de260aa5, (FLAG)EPI_Epilogue_Halsin_State_HasDuck_11887434-f75a-4426-b40e-1fc1504fdea7);
DB_GLO_ItemInventoryLockFlag(S_EPI_HalsinsDuck_b59b5990-bdf3-475e-8284-baa9de260aa5, (FLAG)EPI_Epilogue_Halsin_State_DuckLocked_c18a7308-6bee-4179-91ec-c7c992e341a0, (FLAG)EPI_Epilogue_Halsin_State_DuckUnlocked_516b9407-0762-4317-9be7-d0043d60f2f6);

DB_HasItemEvent((ITEM)S_EPI_Clive_b3ca8632-91d8-415e-9eab-38f7feb30d87, (FLAG)EPI_Karlach_State_HasClive_0b52fc06-c291-4503-9475-3ed418bc816d);

DB_FlagReactionAfterDialog(EPI_Epilogue_Event_MindFlayerUrgeHostile_5d02848e-c58f-4a7c-b17e-058e31b7129f, EPI_Epilogue_MindFlayerUrge_0e7a5eec-5ab6-8f55-79a5-6c410cf15ebe);

//REGION Scratch and Owlbear food
PROC_SetOnStage(S_EPI_OwlbearCub_Bowl_452ab557-2114-4d20-b46e-ac5b71d6189e, 0);
PROC_SetOnStage(S_EPI_OwlbearCub_Food_23c1dddc-2fc3-45da-aef6-13cffa25f1f0, 0);
PROC_SetOnStage(S_EPI_Scratch_Bowl_7098fbad-af03-425b-9369-c9a769666e38, 0);
PROC_SetOnStage(S_EPI_Scratch_Food_040d2711-2717-4054-92ff-1b1e4ed38e30, 0);
//END_REGION

//REGION Violence
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa);
DB_EPI_Epilogue_ViolentSceneCharacters((CHARACTER)S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c);
//END_REGION

//REGION Dialog speaker slots

DB_EPI_Epilogue_IncludeAvatarDialogs((DIALOGRESOURCE)EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd, 14, 16);
DB_EPI_Epilogue_IncludeAvatarDialogs((DIALOGRESOURCE)EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045, 3, 5);
DB_EPI_Epilogue_IncludeAvatarDialogs((DIALOGRESOURCE)EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771, 18, 20);
DB_EPI_Epilogue_IncludeAvatarDialogs((DIALOGRESOURCE)EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887, 19, 21);

//END_REGION

//REGION Title

//DB_EPI_Title_FlaggedTitles(_Character, _Title, _Flag, _Type)
//_Type: 0 = character, 1 = global
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "EPI_Title_GodGale",(FLAG)ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "EPI_Title_GaleAvernus",(FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, 0);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "EPI_Title_GaleWaterdeep",(FLAG)ORI_Gale_State_ReturnedToWaterdeep_c7b41398-0b76-4c71-8825-2e16ff810199, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "EPI_Title_GaleWaterdeep",(FLAG)ORI_Gale_State_ReturnedToWaterdeepAlone_909dc6c8-dc89-b13b-f0a5-289fa294beb6, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "EPI_Title_GaleAstral",(FLAG)ORI_Laezel_State_PlayerLaezelOrpheus_9bbf4067-fcb1-0c74-088d-ff887ca2abe5, 0);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "EPI_Title_LaezelVlaakith",(FLAG)END_GameFinale_State_LaezelVlaakithPath_7acb346a-df49-8719-aa2a-124a1c04791f, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "EPI_Title_SHwithShar",(FLAG)ORI_Shadowheart_State_Shar_KilledParents_3a3b0ecf-a1ed-4733-8548-0348befc6bac, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "EPI_Title_SHNoSharNoParents",(FLAG)ORI_Shadowheart_State_RejectShar_KilledParents_e9060caf-66b0-4701-8dfd-5ae1125f5afd, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "EPI_Title_WyllGrandDuke",(FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "EPI_Title_WyllAvernus",(FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "EPI_Title_WyllHeart",(FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "EPI_Title_AstarionLord",(FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "EPI_Title_AstarionLeadSpawn",(FLAG)ORI_Astarion_State_LeadSpawnInUnderdark_e7ed1e66-171e-96d7-3ea9-61176713cbf9, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "EPI_Title_AstarionSpawn",(FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "EPI_Title_MinscGuild",(FLAG)LOW_Guildhall_State_PostCoup_GuildControlled_596f7f8b-2de2-4550-87fd-9535c2a07635, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "EPI_Title_JaheiraRetired",(FLAG)ORI_Jaheira_State_Retired_5a034473-9b26-e8f6-28c2-9c012372c5de, 1);
DB_EPI_Title_FlaggedTitles((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "EPI_Title_MintharaBG",(FLAG)ORI_Minthara_State_SiezeBaldursGate_91693c25-e33d-a400-4414-39a45ebdd13d, 1);

//Attempt to set these after specific flag setup, as fallbacks.
DB_EPI_Title_Default((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "EPI_Title_GaleOther");
DB_EPI_Title_Default((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "EPI_Title_KarlachAvernus");
DB_EPI_Title_Default((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "EPI_Title_LaezelFaerun");
DB_EPI_Title_Default((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "EPI_Title_SHNoShar");
DB_EPI_Title_Default((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "EPI_Title_WyllOther");
DB_EPI_Title_Default((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "EPI_Title_AstarionOther");
DB_EPI_Title_Default((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "EPI_Title_JaheiraOther");
DB_EPI_Title_Default((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "EPI_Title_MinscOther");
DB_EPI_Title_Default((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "EPI_Title_Halsin");
DB_EPI_Title_Default((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "EPI_Title_MintharaOther");
DB_EPI_Title_Default((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, "EPI_Title_Scratch");
DB_EPI_Title_Default((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, "EPI_Title_Owlbear");

//END_REGION

PROC_EPI_Epilogue_Setup();
KBSECTION
//REGION DEBUG

IF
TextEvent("epi_doubleme")
AND
GetHostCharacter(_Player)
THEN
Transform(S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, _Player, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
PROC_SetArmourSet(S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, ARMOURSET.Vanity);
ToInventory(S_EPI_PlayerGodClothing_b8f72c54-f0ab-48d3-9507-66cb2b4b44af, S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, 1, 0, 1);
TeleportTo(S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, _Player, "");

IF
TextEvent("epi_divinebardtrack") 
AND
GetTextEventParamInteger(1, _Int)
AND
DB_EPI_Epilogue_DEBUG_DivineBardTracks(_Track, _Int)
THEN
PROC_MusicPlayGeneral(_Track); 

//END_REGION

IF
LevelLoaded("EPI_Main_A")
THEN
SetFlag(CURRENTREGION_EPI_Main_A_49a342c4-59f2-4861-9048-8fe63a7b7cde);

//REGION Setup
PROC
PROC_EPI_Epilogue_Setup()
AND
DB_Players(_Player)
THEN
RemoveAllTadpolePowers(_Player);
SetTadpoleTreeState(_Player, 0);

PROC
PROC_EPI_Epilogue_Setup()
THEN
PROC_LockAllUnlockedWaypoints();
PROC_EPI_Epilogue_DismissHirelings();
PROC_EPI_Epilogue_RemoveFollowers();
PROC_EPI_Epilogue_CloseGoals();
PROC_EPI_Epilogue_SetFlags();
PROC_EPI_Epilogue_SetCharacters();

PROC
PROC_EPI_Epilogue_Setup()
THEN
TriggerSetSoundState((TRIGGER)Amb_SV_EPI_CampFire_DayAndNight_QD_000_7e93331d-40ca-43bf-9875-15b2689ba1f2,"AMB_TimeofDay","Night",0);

PROC
PROC_EPI_Epilogue_Setup()
AND
DB_END_RealPartOfTheTeam(_Player)
THEN
SetCanJoinCombat(_Player, 1);
SetCanFight(_Player, 1);

PROC
PROC_EPI_Epilogue_RemoveFollowers()
AND
DB_PartyFollowers(_Char)
AND
NOT DB_Avatars(_Char)
AND
CharacterGetOwner(_Char, _Player)
THEN
DB_EPI_Epilogue_RemovingFollower(_Char);
RemovePartyFollower(_Char, _Player);

IF
CharacterLeftParty(_Char)
AND
DB_EPI_Epilogue_RemovingFollower(_Char)
AND
NOT DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
THEN
NOT DB_EPI_Epilogue_RemovingFollower(_Char);
TeleportTo(_Char, S_EPI_EpilogueRejectPoint_94bffaa5-32b7-4add-837e-91ccf15962a7);
PROC_SetOnStage(_Char, 0);

PROC
PROC_EPI_Epilogue_DismissHirelings()
AND
DB_Hirelings_Hired(_Hireling)
THEN
PROC_Hirelings_Dismiss(_Hireling);

PROC
PROC_EPI_Epilogue_CloseGoals()
AND
DB_END_AllyAbilities_Abilities(_, _AllyStatus, _, _)
AND
DB_PartOfTheTeam(_Player)
AND
HasActiveStatus(_Player, _AllyStatus, 1)
THEN
RemoveStatus(_Player, _AllyStatus, _Player);

PROC
PROC_EPI_Epilogue_CloseGoals()
THEN
SysCompleteGoal("GLO_Origin_Gale_Death");
SysCompleteGoal("Act3c_END_MorphicPool");
SysCompleteGoal("Act3c_END_IllithidOptions");
SysCompleteGoal("Act3c_END_Courtyard");
SysCompleteGoal("Act3c_END_AllyAbilities");
SysCompleteGoal("Act3c_END_GameFinale");
SysCompleteGoal("Act3c_END_BrainBattle");
SysCompleteGoal("Act3c_END_GatherYourAllies");

PROC
PROC_EPI_Epilogue_SetFlags()
THEN
PROC_EPI_Epilogue_SetFallbackFlags();

//There is an inconsistent use in GameFinale that is setting Defeated if Orpheus is killed in dialog instead of PermaDefeated. This is to catch any cases so later dialogs don't break if they check one or the other
PROC
PROC_EPI_Epilogue_SetFlags()
AND
DB_GlobalFlag(END_General_State_OrpheusDefeated_f502054a-3668-4e54-b742-6266d00c4ec1)
AND
NOT DB_GlobalFlag(END_General_State_OrpheusPermaDefeated_9255d9c6-39b2-4436-bd03-c08d99526257)
THEN
SetFlag(END_General_State_OrpheusPermaDefeated_9255d9c6-39b2-4436-bd03-c08d99526257);

PROC
PROC_EPI_Epilogue_SetFlags()
AND
DB_GlobalFlag(END_General_State_OrpheusPermaDefeated_9255d9c6-39b2-4436-bd03-c08d99526257)
AND
NOT DB_GlobalFlag(END_General_State_OrpheusDefeated_f502054a-3668-4e54-b742-6266d00c4ec1)
THEN
SetFlag(END_General_State_OrpheusDefeated_f502054a-3668-4e54-b742-6266d00c4ec1);

PROC
PROC_EPI_Epilogue_SetCharacters()
THEN
DB_Dialogs(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, EPI_Epilogue_DivineBard_638b3683-ac20-9a7f-4af0-c1c0fa5fb98e);
SetImmortal(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, 1);
SetCanJoinCombat(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, 0);
SetCanFight(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, 0);
PROC_CharacterDisableAllCrimes(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c);
ObjectSetTitle(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, "EPI_Title_DivineBardUnknown");

PROC
PROC_EPI_Epilogue_SetCharacters()
THEN
PROC_CharacterFullRestore(S_GLO_Vlaakith_6b00f9fb-b932-4ac9-8ed8-1ca89dd7d247);
TeleportTo(S_GLO_Vlaakith_6b00f9fb-b932-4ac9-8ed8-1ca89dd7d247, S_EPI_VlaakitchPoint_abb12007-a649-4955-b290-69c750952cff);

PROC
PROC_EPI_Epilogue_SetCharacters()
THEN
TeleportTo(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, S_EPI_StartPointRaphael_02c087bb-d4a1-4027-8600-18399f375774);

PROC
PROC_EPI_Epilogue_SetCharacters()
AND
NOT DB_GlobalFlag(ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56) //Vlaakith Path
AND
IsTagged(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0) //Didn't transform (so not locked up)
AND
DB_GlobalFlag(END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209) //Can only be set in GameFinale, so if true then we can assume she was part of the team/alive/etc
AND
NOT DB_EPI_Epilogue_QueuedOpeningDialogs(_, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_EPI_Epilogue_QueuedOpeningDialogs(EPI_Epilogue_VlaakithAscension_0a3237fc-7a3c-6e32-6ffa-72d459ff49cb, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
NOT DB_END_General_ForcedListener(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1);
DB_END_General_ForcedListener(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0);
PROC_SetArmourSet(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, ARMOURSET.Normal);
PROC_EPI_Epilogue_SetAvatarVlaakithLaezelToDead();

PROC
PROC_EPI_Epilogue_SetAvatarVlaakithLaezelToDead()
AND
DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
NOT DB_END_General_UnavailableAvatar(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1);
DB_END_General_UnavailableAvatar(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0);

PROC
PROC_EPI_Epilogue_SetAvatarVlaakithLaezelToDead()
AND
NOT DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_EPI_Epilogue_WaitingForVlaakithLaezel(1);
TeleportTo(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_EPI_WaitingLaezelPoint_a91de472-d3eb-4ed4-b87d-130ba8050b2f, "EPI_Epilogue_LaakithLaezelArrived", 0, 0, 0, 1, 1); 

IF
EntityEvent(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "EPI_Epilogue_LaakithLaezelArrived")
AND
DB_EPI_Epilogue_WaitingForVlaakithLaezel(1)
THEN
NOT DB_EPI_Epilogue_WaitingForVlaakithLaezel(1);
PROC_EPI_Epilogue_CheckForReadyStartingDialogs(); //If in some weird case Lae'zel is the last to arrive

PROC
PROC_EPI_Epilogue_SetCharacters()
AND
DB_END_General_UnavailableAvatar(_Player, 1) //Only avatars can hitch a ride with Lae'zel
AND
GetFlag(END_GameFinale_State_PlayerLaezelVlaakith_bf95c085-fe78-9cda-7aac-2d8e5b94a9cf, _Player, 1)
AND
NOT DB_GlobalFlag(ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56)
AND
DB_GlobalFlag(END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209)
THEN
NOT DB_END_General_UnavailableAvatar(_Player, 1);
DB_END_General_UnavailableAvatar(_Player, 0);
NOT DB_END_General_ForcedListener(_Player, 1);
DB_END_General_ForcedListener(_Player, 0);

PROC
PROC_EPI_Epilogue_SetCharacters()
AND
DB_Avatars(_Player)
AND
DB_EPI_Epilogue_PresentNPC(_Player, _Dialog, _Trigger, _Config, _Flag)
THEN
NOT DB_EPI_Epilogue_PresentNPC(_Player, _Dialog, _Trigger, _Config, _Flag);
DB_EPI_Epilogue_OriginAvatarPresentFlag(_Player, _Flag);

PROC
PROC_EPI_Epilogue_SetCharacters()
AND
DB_END_General_UnavailableAvatar(_Player, 0) //Dead
THEN
PROC_EPI_Epilogue_MakeAvatarGhost(_Player);

PROC
PROC_EPI_Epilogue_SetCharacters()
AND
DB_END_General_UnavailableAvatar(_Player, 1)
AND
QRY_EPI_Epilogue_CharacterIsUnavailable(_Player)
THEN
PROC_EPI_Epilogue_LockAvatar(_Player);

PROC
PROC_EPI_Epilogue_SetCharacters()
AND
DB_END_General_ForcedListener(_Char, 0) //Dead
THEN
PROC_EPI_Epilogue_RemoveAndHideNPC(_Char);

//Origins never recruited
PROC
PROC_EPI_Epilogue_SetCharacters()
AND
DB_Origins(_Char)
AND
NOT DB_PartOfTheTeam(_Char)
THEN
PROC_EPI_Epilogue_RemoveAndHideNPC(_Char);

//Avatar Gale challanged Mystra
PROC
PROC_EPI_Epilogue_RemoveAndHideNPC((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(ORI_Gale_State_ChallengedMystra_d6dfa722-f85e-e191-a7e0-776d19c9f18a)
THEN
PROC_EPI_Epilogue_IncludeSpectralVoiceGale();

//Comp or Avatar Gale exploded
PROC
PROC_EPI_Epilogue_RemoveAndHideNPC((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(END_FinalDecisions_Event_GaleExploded_a32e3cb5-9536-3c3e-a4d2-1837ee3b6190)
THEN
PROC_EPI_Epilogue_IncludeSpectralVoiceGale();

//Comp or Avatar Gale attempted Godhood without completing his quest
PROC
PROC_EPI_Epilogue_RemoveAndHideNPC((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(ORI_Gale_State_ClaimedCrown_93279f0c-82f0-b1e5-ff24-34a47c47a85d)
AND
NOT DB_GlobalFlag(ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
THEN
PROC_EPI_Epilogue_IncludeSpectralVoiceGale();

PROC
PROC_EPI_Epilogue_RemoveAndHideNPC((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(END_BrainBattle_Event_GaleCompanionTryGod_22bffdc3-3cd8-9f3e-0e73-b04a586e24c3)
AND
NOT DB_GlobalFlag(ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
THEN
PROC_EPI_Epilogue_IncludeSpectralVoiceGale();

PROC
PROC_EPI_Epilogue_IncludeSpectralVoiceGale()
AND
NOT DB_EPI_Epilogue_PresentNPC(S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d, _, _, _, _)
THEN
DB_EPI_Epilogue_PresentNPC((CHARACTER)S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d, (DIALOGRESOURCE)EPI_Epilogue_SpectralVoiceGale_a4d46b4b-5080-396d-bf58-81711dada9e5,(TRIGGER)S_EPI_StartPointGale_eb5481f4-5b2e-485f-ba3d-7cb3cd066872, "EPI_Gale",(FLAG)EPI_Epilogue_State_SpectralGalePresent_fe6af825-0573-49e0-8dbb-ba2198f2be6b);

PROC
PROC_EPI_Epilogue_SetCharacters()
THEN
PROC_EPI_Epilogue_SetupAvatars();
PROC_EPI_Epilogue_SetupNPCs();


//REGION Avatar Setup
//If dead, make ghost. If not dead but still not present (appears in later dialog), set "locked" status
PROC
PROC_EPI_Epilogue_MakeAvatarGhost((CHARACTER)_Player)
AND
DB_END_General_ForcedListener(_Player, _State)
THEN
SetFlag(EPI_Epilogue_State_MissingAvatar_8a510a97-7d81-4b61-a22a-aaf1480e48ed);
NOT DB_END_General_ForcedListener(_Player, _State);
NOT DB_END_General_UnavailableAvatar(_Player, _State); 
PROC_EPI_Epilogue_ApplyGhostStatus(_Player);
SetFlag(EPI_Epilogue_State_DeadWispStatus_5adb682b-f6e6-4aac-9b8a-fb116eb80723, _Player, 0);
RemoveSummons(_Player, 0);
SetImmortal(_Player, 1);
SetCanFight(_Player, 0);
PROC_SetInvulnerable(_Player, 1);
SetCanJoinCombat(_Player, 0);

PROC
PROC_EPI_Epilogue_ApplyGhostStatus((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFLag(ORI_Gale_State_InElysium_d6c53ee8-ce94-4016-73ee-74d44d309837)
AND
NOT DB_EPI_Epilogue_GhostAvatar(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_EPI_Epilogue_QueuedStatuses(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,"EPI_GALE_ELYSIUM");
DB_EPI_Epilogue_GhostAvatar(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

PROC
PROC_EPI_Epilogue_ApplyGhostStatus((CHARACTER)_Player)
AND
NOT DB_EPI_Epilogue_GhostAvatar(_Player)
THEN
DB_EPI_Epilogue_QueuedStatuses(_Player,"EPI_AVATAR_GHOST");
DB_EPI_Epilogue_GhostAvatar(_Player);

PROC
PROC_EPI_Epilogue_MakeAvatarGhost((CHARACTER)_Player)
AND
QRY_EPI_Epilogue_ValidAvatarLeftEarlyCandidate(_Player)
THEN
DB_EPI_Epilogue_QueuedOpeningDialogs(EPI_Epilogue_AvatarLeftEarly_ae9cd608-5688-63d6-1ecc-355496e2a6be, _Player);

QRY
QRY_EPI_Epilogue_ValidAvatarLeftEarlyCandidate((CHARACTER)_Player)
AND
IsTagged(_Player, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
AND
GetFlag(END_BrainBattle_Event_Suicide_ad1258fa-27eb-537c-a113-91db07cb6590, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_ValidAvatarLeftEarlyCandidate((CHARACTER)_Player)
AND
DB_ORI_DarkUrge(_Player)
AND
GetFlag(END_BrainBattle_Event_Suicide_ad1258fa-27eb-537c-a113-91db07cb6590, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_ValidAvatarLeftEarlyCandidate((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag(ORI_Gale_State_InElysium_d6c53ee8-ce94-4016-73ee-74d44d309837)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_ValidAvatarLeftEarlyCandidate((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_LockAvatar((CHARACTER)_Player)
AND
DB_END_General_ForcedListener(_Player, _State)
THEN
SetFlag(EPI_Epilogue_State_MissingAvatar_8a510a97-7d81-4b61-a22a-aaf1480e48ed);
NOT DB_END_General_ForcedListener(_Player, _State);
NOT DB_END_General_UnavailableAvatar(_Player, _State); 
DB_EPI_Epilogue_LockedAvatar(_Player);
RemoveSummons(_Player, 0);
DB_EPI_Epilogue_QueuedStatuses(_Player,"EPI_DARKURGE_JAIL"); 
SetFlag(EPI_Epilogue_State_JailStatus_136719bb-e070-4346-97be-cd10e77e2743, _Player, 0); 
SetImmortal(_Player, 1);
SetCanFight(_Player, 0);
PROC_SetInvulnerable(_Player, 1);
SetCanJoinCombat(_Player, 0);

PROC
PROC_EPI_Epilogue_SetupAvatars()
AND
DB_Avatars(_Player)
AND
QRY_EPI_Epilogue_AvatarIsPresentAtParty(_Player)
THEN
DB_EPI_Epilogue_PresentAvatar(_Player);

PROC
PROC_EPI_Epilogue_SetupAvatars()
AND
DB_EPI_Epilogue_PresentAvatar(_Char)
THEN
PROC_EPI_Epilogue_SetAvailableAvatar(_Char);

PROC
PROC_EPI_Epilogue_SetupAvatars()
AND
DB_EPI_Epilogue_GhostAvatar(_Char)
THEN
PROC_EPI_Epilogue_SetGhostAvatar(_Char);

PROC
PROC_EPI_Epilogue_SetupAvatars()
AND
DB_EPI_Epilogue_LockedAvatar(_Char)
THEN
PROC_EPI_Epilogue_SetLockedAvatar(_Char);

PROC
PROC_EPI_Epilogue_SetAvailableAvatar((CHARACTER)_Char)
AND
DB_EPI_Epilogue_PresentAvatar(_Char)
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char)
THEN
PROC_CharacterFullRestore(_Char);
RemoveSummons(_Char, 0);
PROC_EPI_Epilogue_TryClearInventory(_Char);
PROC_EPI_Epilogue_AdditionalSetupCharacter(_Char); //If a character needs additional setup. Example: God Gale
PROC_EPI_Epilogue_CheckWaitingTeleportAvatars(); //Teleport avatars at the very end to avoid issues with deferred timing

PROC
PROC_EPI_Epilogue_SetAvailableAvatar((CHARACTER)_Char)
AND
DB_EPI_Epilogue_OriginAvatarPresentFlag(_Char, _Flag)
AND
_Flag != NULL_00000000-0000-0000-0000-000000000000
THEN
SetFlag(_Flag);

PROC
PROC_EPI_Epilogue_SetAvailableAvatar((CHARACTER)_Char)
AND
DB_EPI_Epilogue_OriginAvatarPresentFlag(_Char, _Flag)
THEN
NOT DB_EPI_Epilogue_OriginAvatarPresentFlag(_Char, _Flag);

PROC
PROC_EPI_Epilogue_SetGhostAvatar((CHARACTER)_Char)
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char)
THEN
PROC_CharacterFullRestore(_Char);
PROC_EPI_Epilogue_TryClearInventory(_Char);
PROC_EPI_Epilogue_CheckWaitingTeleportAvatars();

PROC
PROC_EPI_Epilogue_SetLockedAvatar((CHARACTER)_Char)
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char)
THEN
PROC_CharacterFullRestore(_Char);
PROC_EPI_Epilogue_TryClearInventory(_Char);
PROC_EPI_Epilogue_CheckWaitingTeleportAvatars();

QRY
QRY_EPI_Epilogue_AvatarIsPresentAtParty((CHARACTER)_Avatar)
AND
DB_Avatars(_Avatar)
AND
NOT DB_EPI_Epilogue_GhostAvatar(_Avatar)
AND
NOT DB_EPI_Epilogue_LockedAvatar(_Avatar)
THEN
DB_NOOP(1);

//END_REGION

//REGION NPC Setup
PROC
PROC_EPI_Epilogue_SetupNPCs()
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
AND
QRY_EPI_Epilogue_CharacterIsUnavailable(_Char)
THEN
PROC_EPI_Epilogue_RemoveAndHideNPC((CHARACTER)_Char);

PROC
PROC_EPI_Epilogue_RemoveAndHideNPC((CHARACTER)_Char)
AND
DB_EPI_Epilogue_PresentNPC(_Char, _Dialog, _Trigger, _Config, _Flag)
THEN
NOT DB_EPI_Epilogue_PresentNPC(_Char, _Dialog, _Trigger, _Config, _Flag);

PROC
PROC_EPI_Epilogue_RemoveAndHideNPC((CHARACTER)_Char)
AND
DB_Players(_Char)
THEN
DB_EPI_Epilogue_HidingPlayerNPC(_Char);
PROC_GLO_PartyMembers_MakeNPC(_Char);

PROC
PROC_GLO_PartyMembers_MakeNPCHook((CHARACTER)_Char)
AND
DB_EPI_Epilogue_HidingPlayerNPC(_Char)
THEN
NOT DB_EPI_Epilogue_HidingPlayerNPC(_Char);
TeleportTo(_Char, S_EPI_EpilogueRejectPoint_94bffaa5-32b7-4add-837e-91ccf15962a7);

PROC
PROC_EPI_Epilogue_RemoveAndHideNPC((CHARACTER)_Char)
AND
NOT DB_Players(_Char)
THEN
TeleportTo(_Char, S_EPI_EpilogueRejectPoint_94bffaa5-32b7-4add-837e-91ccf15962a7);

//Setup remaining NPCs
PROC
PROC_EPI_Epilogue_SetupNPCs()
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
AND
DB_Players(_Char)
THEN
DB_EPI_Epilogue_BecomingNPC(_Char);
PROC_GLO_PartyMembers_MakeNPC(_Char);

PROC
PROC_GLO_PartyMembers_MakeNPCHook((CHARACTER)_Char)
AND
DB_EPI_Epilogue_BecomingNPC(_Char)
THEN
PROC_EPI_Epilogue_SetAvailableNPC(_Char);

PROC
PROC_EPI_Epilogue_SetupNPCs()
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
AND
NOT DB_EPI_Epilogue_BecomingNPC(_Char) //Not waiting
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char) //Not already set
THEN
PROC_EPI_Epilogue_SetAvailableNPC(_Char);

PROC
PROC_EPI_Epilogue_SetAvailableNPC((CHARACTER)_Char)
THEN
PROC_EPI_Epilogue_SetNPCConditionals(_Char);

PROC
PROC_EPI_Epilogue_SetAvailableNPC((CHARACTER)_Char)
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _Trigger, _, _Flag)
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char)
AND
_Flag != NULL_00000000-0000-0000-0000-000000000000
THEN
SetFlag(_Flag);

PROC
PROC_EPI_Epilogue_SetAvailableNPC((CHARACTER)_Char)
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _Trigger, _, _Flag)
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char)
THEN
PROC_SetOnStage(_Char, 1);
ClearTag(_Char, (TAG)TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b);
PROC_RemoveDialog(_Char);
PROC_CharacterFullRestore(_Char);
PROC_EPI_Epilogue_TryClearInventory(_Char);
RemoveSummons(_Char, 0);
PROC_EPI_Epilogue_AdditionalSetupCharacter(_Char); //If a character needs additional setup. Example: God Gale
TeleportTo(_Char, _Trigger, "EPI_Epilogue_CharArrived", 0, 0, 0, 1, 1);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805)
AND
DB_Avatars(_Avatar)
THEN
PROC_ShowMarker(_Avatar, "EPI_Withers");

PROC
PROC_EPI_Epilogue_SetFaction((CHARACTER)_Char)
AND
DB_EPI_Epilogue_CharacterFaction(_Char, _Faction)
THEN
SetFaction(_Char,_Faction);
PROC_SetRelationMutual((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,_Faction, 100);


//To avoid some weirdness when debugging directly to
IF
EntityEvent(_Char, "EPI_Epilogue_CharArrived")
AND
DB_EPI_Epilogue_PresentNPC((CHARACTER)_Char, _Dialog, _, _Config, _)
THEN
RemoveHarmfulStatuses(_Char);
DB_Dialogs(_Char, _Dialog);
PROC_SetAnubisConfig(_Char, _Config);
PROC_EPI_Epilogue_SetFaction(_Char);
ObjectTimerLaunch(_Char, "EPI_SuppressPartyDialog", 5000);

IF
ObjectTimerFinished((CHARACTER)_Char, "EPI_SuppressPartyDialog")
THEN
PROC_PartyDialogSuppressed_Start(_Char);

//Transformation and spells is part of PROC_EPI_Epilogue_AdditionalSetupCharacter 
PROC
PROC_EPI_Epilogue_SetNPCConditionals((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_EPI_Epilogue_PresentNPC(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Dialog, _Trigger, _Config, _Flag)
AND
DB_GlobalFlag(ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d)
THEN
NOT DB_EPI_Epilogue_PresentNPC(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Dialog, _Trigger, _Config, _Flag);
DB_EPI_Epilogue_PresentNPC(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, EPI_Epilogue_GodGale_a88aeb0b-3e95-e8b0-7750-2609ab4746d4, _Trigger, _Config, _Flag);

PROC
PROC_EPI_Epilogue_SetNPCConditionals((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_EPI_Epilogue_PresentNPC(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Dialog, _Trigger, _Config, _Flag)
AND
DB_GlobalFlag(ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
THEN
NOT DB_EPI_Epilogue_PresentNPC(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Dialog, _Trigger, _Config, _Flag);
DB_EPI_Epilogue_PresentNPC(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, EPI_Epilogue_Astarion_Lord_fea2b09f-0667-ea1f-a410-3afca64b95cd, _Trigger, _Config, _Flag);

PROC
PROC_EPI_Epilogue_SetupNPCs()
AND
DB_EPI_Epilogue_PresentNPC(_Char, _Dialog, _, _, _)
AND
_Char != S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09 //Player in wildshape can talk to the Owlbear as if they have speak with animals
AND
_Char != S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901 //Player in wildshape can talk to Scratch as if they have speak with animals
THEN
DB_DropMutingStatussesDialog(_Dialog);

//END_REGION

//REGION Unavailable QRYs

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)_Player)
AND
DB_ORI_DarkUrge(_Player)
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_GoMadEnding_a0bea44c-be8a-26e4-ded5-c6c5827d4190)
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalResisted_74944ac3-1ea0-4eae-9653-1f1319f8646b)
AND
NOT DB_EPI_Epilogue_QueuedClosingDialogs(_, _Player)
THEN
DB_EPI_Epilogue_QueuedClosingDialogs(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887, _Player);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236)
AND
NOT DB_PartOfTheTeam(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)_Player)
AND
GetFlag(END_BrainBattle_Event_GoToJail_4a021214-a319-a17b-13f6-c3427c794684, _Player, 1)
AND
NOT DB_EPI_Epilogue_QueuedOpeningDialogs(_, _Player)
THEN
DB_EPI_Epilogue_QueuedOpeningDialogs(EPI_Epilogue_AvatarLockedAway_d89bd31e-787a-0293-5314-42641d243b81, _Player);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_GlobalFlag((FLAG)LOW_Guildhall_State_PostCoup_GuildControlled_596f7f8b-2de2-4550-87fd-9535c2a07635)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa)
AND
NOT DB_GlobalFlag(GLO_Volo_State_AtCamp_de1cadca-2eca-4cee-a3dc-e262bbb92277)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
NOT DB_GlobalFlag(CAMP_OwlbearCub_State_Friend_3b963a1c-ca06-db60-75c3-063592e84dc4)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901)
AND
NOT DB_GlobalFlag(CAMP_Courier_Dog_Moved2Camp_7dcb7732-1c76-463a-bec9-251f30860e6c)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901)
AND
DB_GlobalFlag(GLO_CourierDog_State_UnavailableForSummon_0fef1fa5-9216-4833-94c1-5fe1da7da7c7)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(ORI_Gale_State_InElysium_d6c53ee8-ce94-4016-73ee-74d44d309837)
THEN
DB_NOOP(1);

//Have to duplicate it here since he is not always set as dead in Forced Listener
//Avatar Gale challanged Mystra
QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(ORI_Gale_State_ChallengedMystra_d6dfa722-f85e-e191-a7e0-776d19c9f18a)
THEN
PROC_EPI_Epilogue_IncludeSpectralVoiceGale();

//Comp or Avatar Gale exploded
QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(END_FinalDecisions_Event_GaleExploded_a32e3cb5-9536-3c3e-a4d2-1837ee3b6190)
THEN
PROC_EPI_Epilogue_IncludeSpectralVoiceGale();

//Comp or Avatar Gale attempted Godhood without completing his quest
QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(ORI_Gale_State_ClaimedCrown_93279f0c-82f0-b1e5-ff24-34a47c47a85d)
AND
NOT DB_GlobalFlag(ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
THEN
PROC_EPI_Epilogue_IncludeSpectralVoiceGale();

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(END_BrainBattle_Event_GaleCompanionTryGod_22bffdc3-3cd8-9f3e-0e73-b04a586e24c3)
AND
NOT DB_GlobalFlag(ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
THEN
PROC_EPI_Epilogue_IncludeSpectralVoiceGale();

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)_Player)
AND
GetFlag(END_BrainBattle_Event_GoToJail_4a021214-a319-a17b-13f6-c3427c794684, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)_Char)
AND
DB_PermaDefeated(_Char)
THEN 
DB_NOOP(1);


//END_REGION 

//REGION Companion END Choice Fallback
//To handle the flags for non-romanced companions who did not make explicit end choices during Game Finale
PROC
PROC_EPI_Epilogue_SetFallbackFlags()
AND
DB_Origins(_Char)
AND
NOT DB_Avatars(_Char)
AND
DB_PartOfTheTeam(_Char)
AND
NOT DB_ORI_Partnered(_, _Char)
THEN
PROC_EPI_Epilogue_CheckForFallback(_Char);

PROC
PROC_EPI_Epilogue_CheckForFallback((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag(ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d)
AND
NOT DB_GlobalFlag(ORI_Gale_State_ClaimedCrown_93279f0c-82f0-b1e5-ff24-34a47c47a85d)
AND
NOT DB_GlobalFlag(ORI_Gale_State_ReturnedToWaterdeep_c7b41398-0b76-4c71-8825-2e16ff810199)
AND
NOT DB_GlobalFlag(ORI_Gale_State_StayInBaldursGate_9149f141-5d40-72e6-fc71-d0f7e343560c)
AND
NOT DB_GlobalFlag(END_FinalDecisions_Event_GaleExploded_a32e3cb5-9536-3c3e-a4d2-1837ee3b6190)
AND
NOT DB_GlobalFlag(ORI_Gale_Event_GaveCrownToMystra_3375fd8b-4958-421d-2d51-ff9af5beaaa0)
AND
NOT DB_GlobalFlag(END_BrainBattle_Event_GaleCompanionTryGod_22bffdc3-3cd8-9f3e-0e73-b04a586e24c3)
AND
NOT DB_GlobalFlag(ORI_Gale_Event_LeftCrown_1662925d-ec3b-54cb-a1cf-6639c6fa90ce)
AND
GetFlag(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0)
THEN
PROC_EPI_Epilogue_SetCompanionGaleFallback();

PROC
PROC_EPI_Epilogue_SetCompanionGaleFallback()
AND
NOT DB_GlobalFlag(ORI_Gale_State_SwayedTowardsCrown_76150a10-511d-4eeb-b263-46994bab0b48)
THEN
PROC_GlobalSetFlagAndCache(ORI_Gale_State_ReturnedToWaterdeepAlone_909dc6c8-dc89-b13b-f0a5-289fa294beb6);
PROC_GlobalSetFlagAndCache(ORI_Gale_Event_GaveCrownToMystra_3375fd8b-4958-421d-2d51-ff9af5beaaa0);

PROC
PROC_EPI_Epilogue_SetCompanionGaleFallback()
AND
DB_GlobalFlag(ORI_Gale_State_SwayedTowardsCrown_76150a10-511d-4eeb-b263-46994bab0b48)
AND
DB_GlobalFlag(ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
THEN
PROC_GlobalSetFlagAndCache(ORI_Gale_State_ClaimedCrown_93279f0c-82f0-b1e5-ff24-34a47c47a85d);
PROC_GlobalSetFlagAndCache(END_BrainBattle_Event_GaleCompanionTryGod_22bffdc3-3cd8-9f3e-0e73-b04a586e24c3);
PROC_GlobalSetFlagAndCache(ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d);

PROC
PROC_EPI_Epilogue_SetCompanionGaleFallback()
AND
DB_GlobalFlag(ORI_Gale_State_SwayedTowardsCrown_76150a10-511d-4eeb-b263-46994bab0b48)
AND
NOT DB_GlobalFlag(ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
THEN
PROC_GlobalSetFlagAndCache(ORI_Gale_State_ClaimedCrown_93279f0c-82f0-b1e5-ff24-34a47c47a85d);
PROC_GlobalSetFlagAndCache(END_BrainBattle_Event_GaleCompanionTryGod_22bffdc3-3cd8-9f3e-0e73-b04a586e24c3);

//Fallback 2.0 (This is to make sure his waterdeep flag if he's not enywhere else)
PROC
PROC_EPI_Epilogue_CheckForFallback((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag(ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d)
AND
NOT DB_GlobalFlag(ORI_Gale_State_ClaimedCrown_93279f0c-82f0-b1e5-ff24-34a47c47a85d)
AND
NOT DB_GlobalFlag(ORI_Gale_State_ReturnedToWaterdeep_c7b41398-0b76-4c71-8825-2e16ff810199)
AND
NOT DB_GlobalFlag(ORI_Gale_State_StayInBaldursGate_9149f141-5d40-72e6-fc71-d0f7e343560c)
AND
NOT DB_GlobalFlag(END_FinalDecisions_Event_GaleExploded_a32e3cb5-9536-3c3e-a4d2-1837ee3b6190)
AND
NOT DB_GlobalFlag(END_BrainBattle_Event_GaleCompanionTryGod_22bffdc3-3cd8-9f3e-0e73-b04a586e24c3)
AND
GetFlag(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0)
THEN
PROC_GlobalSetFlagAndCache(ORI_Gale_State_ReturnedToWaterdeepAlone_909dc6c8-dc89-b13b-f0a5-289fa294beb6);

//If Wyll is Blade of Avernus, assume he went to the hells alone
PROC
PROC_EPI_Epilogue_CheckForFallback((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_GlobalFlag(GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd)
AND
NOT DB_GlobalFlag(GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1)
AND
DB_GlobalFlag(GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137)
AND
GetFlag(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 0)
THEN
SetFlag(ORI_Wyll_State_InAvernusAlone_93e65371-daf0-846d-11a8-b4dec6cc2230);

//Assume Minthara returned to the Underdark 
PROC
PROC_EPI_Epilogue_CheckForFallback((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
NOT DB_GlobalFlag(ORI_Minthara_State_ConquerTheUnderdark_cfe9fb88-f8a7-4f8a-9635-10ccf42b64ee)
AND
NOT DB_GlobalFlag(ORI_Minthara_State_SiezeBaldursGate_91693c25-e33d-a400-4414-39a45ebdd13d)
THEN
SetFlag(ORI_Minthara_State_ConquerTheUnderdark_cfe9fb88-f8a7-4f8a-9635-10ccf42b64ee);
//END_REGION

//REGION Welcome ADs
IF
DialogEnded((DIALOGRESOURCE)EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd, _)
AND
DB_EPI_Epilogue_SetCharacters(_Char)
AND
NOT DB_Avatars((CHARACTER)_Char)
AND
DB_EPI_Epilogue_WelcomeADs(_Event, (CHARACTER)_Char, _)
THEN
DB_SpotPlayers_CustomRadius(_Char, _Event, 5.0);
DB_SpotPlayers(_Char, _Event, (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous(_Char, _Event);

IF
DB_SpotPlayers_Spotted(_Char, _Event, _Player)
AND
DB_EPI_Epilogue_WelcomeADs(_Event, _, _)
AND
NOT DB_EPI_Epilogue_WelcomedPlayer(_Char)
AND
NOT DB_EPI_Epilogue_WelcomeCooldown(1)
THEN
PROC_EPI_Epilogue_WelcomePlayer(_Char, _Player);

// Characters near the initiator (including the initiator themselves) will be considered as also welcoming the player.
// This is in order to avoid spamming welcome ADs.
PROC
PROC_EPI_Epilogue_WelcomePlayer((CHARACTER)_Char, (CHARACTER)_Player)
AND
NOT QRY_EPI_Epilogue_CannotWelcomePlayer(_Char, _Player)
THEN
PROC_EPI_Epilogue_WelcomePlayer_Internal(_Char);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)_Char, (CHARACTER)_Player)
AND
HasAppliedStatus(_Player, "EPI_AVATAR_GHOST", 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)_Char, (CHARACTER)_Player)
AND
HasAppliedStatus(_Player, "EPI_DARKURGE_JAIL", 1)
THEN
DB_NOOP(1);

//Don't greet the player they arrived with
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)_Char, (CHARACTER)_Player)
AND
DB_ORI_Partnered(_Player, _Char)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (CHARACTER)_Player)
AND
GetFlag(ORI_Laezel_State_PlayerLaezelOrpheus_9bbf4067-fcb1-0c74-088d-ff887ca2abe5, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTER)_Player)
AND
GetFlag(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Player, 1)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_WelcomePlayer_Internal((CHARACTER)_Char)
AND
DB_EPI_Epilogue_WelcomeADs(_Event, _OtherChar, _)
AND
GetDistanceTo(_Char, _OtherChar, _Dist)
AND
_Dist <= 8.0
THEN
DB_EPI_Epilogue_WelcomedPlayer(_OtherChar);
PROC_SpotPlayers_StopSpotting(_Event);

PROC
PROC_EPI_Epilogue_WelcomePlayer_Internal((CHARACTER)_Char)
AND
DB_EPI_Epilogue_WelcomeADs(_, _Char, _WelcomeAD)
THEN
PROC_TryStartAD(_WelcomeAD, _Char);
DB_EPI_Epilogue_WelcomeCooldown(1);
TimerLaunch("EPI_Epilogue_WelcomeCooldown", 10000);

IF
TimerFinished("EPI_Epilogue_WelcomeCooldown")
THEN
NOT DB_EPI_Epilogue_WelcomeCooldown(1);

// Avatars rushing to speak with an NPC will consider that they have already welcomed them.
PROC
PROC_DialogStarted(_Dialog, _)
AND
DB_EPI_Epilogue_PresentNPC(_Char, _Dialog, _, _, _)
THEN
DB_EPI_Epilogue_WelcomedPlayer(_Char);

//REGION Companion-specific welcomes
// If the avatar arrives to the epilogue with a companion to the party it doesn't make sense for the second to welcom them
// Player arrives with Laezel
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (CHARACTER)_Player)
AND
GetFlag((FLAG)ORI_Laezel_State_PlayerLaezelOrpheus_9bbf4067-fcb1-0c74-088d-ff887ca2abe5, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (CHARACTER)_Player)
AND
GetFlag((FLAG)END_GameFinale_State_PlayerLaezelVlaakith_bf95c085-fe78-9cda-7aac-2d8e5b94a9cf, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)END_GameFinale_State_LaezelInFaerun_3cb6879c-f4e7-bb31-584a-63bea28ecb75)
AND
GetFlag((FLAG)ORI_State_PartneredWithLaezel_d169a786-6e56-4f0d-a2eb-33c48d8d1160, _Player, 1)
THEN
DB_NOOP(1);

// Player arrives with Karlach
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTER)_Player)
AND
GetFlag((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Player, 1)
THEN
DB_NOOP(1);

// Player arrives with Karlach and Wyll
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
AND
GetFlag((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Player, 1)
THEN
DB_NOOP(1);

// Player arrives with Gale
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_PlayerAgreedToWaterdeep_a6d891da-234f-8b4a-2b75-36aecaa3a902)
AND
GetFlag((FLAG)ORI_State_PartneredWithGale_e008e20d-d642-42ed-9008-297b6273aa21, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_PlayerRefusedWaterdeep_52f7bb1c-9e32-25f7-f496-43362bf7ee14)
AND
GetFlag((FLAG)ORI_State_PartneredWithGale_e008e20d-d642-42ed-9008-297b6273aa21, _Player, 1)
THEN
DB_NOOP(1);

// Player arrives with Astarion
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
GetFlag((FLAG)ORI_State_PartneredWithAstarion_30819c8d-b39d-42e7-acd1-2a8c2c309994, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_LeadSpawnInUnderdark_e7ed1e66-171e-96d7-3ea9-61176713cbf9)
AND
GetFlag((FLAG)ORI_State_PartneredWithAstarion_30819c8d-b39d-42e7-acd1-2a8c2c309994, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
GetFlag((FLAG)ORI_State_PartneredWithAstarion_30819c8d-b39d-42e7-acd1-2a8c2c309994, _Player, 1)
THEN
DB_NOOP(1);

// Player arrives with Shadowheart
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (CHARACTER)_Player)
AND
GetFlag((FLAG)ORI_State_PartneredWithShadowheart_3808ae35-ad4e-465b-800b-63d32b77211e, _Player, 1)
THEN
DB_NOOP(1);

// Player arrives with Wyll
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_GlobalFlag((FLAG)ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd)
AND
GetFlag((FLAG)ORI_State_PartneredWithWyll_5db4c1b6-3c42-43ae-aa85-1844acbf5a1d, _Player, 1)
THEN
DB_NOOP(1);

// Player arrives with Halsin
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (CHARACTER)_Player)
AND
GetFlag((FLAG)EPI_Epilogue_Event_PlayerCameWithHalsin_9d43933d-cb7b-05f9-61ec-fe9a6e12c057, _Player, 1)
THEN
DB_NOOP(1);

// Player arrives with Minthara
QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)ORI_Minthara_State_AvatarMintharaReturnsToUnderdark_8a330af6-f3af-c567-006b-2a532daef87f)
AND
GetFlag((FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_CannotWelcomePlayer((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)ORI_Minthara_State_SiezeBaldursGate_91693c25-e33d-a400-4414-39a45ebdd13d)
AND
GetFlag((FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8, _Player, 1)
THEN
DB_NOOP(1);
//END_REGION Companion-specific welcomes

//END_REGION Welcome ADs

//REGION Additional Setup
PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_Avatar)
AND
DB_Avatars(_Avatar)
THEN
DB_EPI_Epilogue_QueuedStatuses(_Avatar, "EPI_SCRATCH_BLOCKED");

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_Player)
AND
HasSpell(_Player, "Shout_END_AllyAbilities_MultipleSummon", 1)
THEN
RemoveSpell(_Player, "Shout_END_AllyAbilities_MultipleSummon", 1);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_Char)
AND
HasAppliedStatus(_Char, "END_ALLYABILITIES_MULTIPLESUMMONS", 1)
THEN
RemoveStatus(_Char, "END_ALLYABILITIES_MULTIPLESUMMONS");

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_MindFlayer)
AND
HasSpell(_MindFlayer, "Target_END_Mindflayer_CrownDomination", 1)
THEN
RemoveSpell(_MindFlayer, "Target_END_Mindflayer_CrownDomination", 1);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
HasActiveStatus(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"END_ALLYBUFF_OWLBEARPOLYMORPH", 1)
THEN
RemoveStatus(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"END_ALLYBUFF_OWLBEARPOLYMORPH");

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
DB_GlobalFlag(END_GatherYourAllies_Event_OwlbearCubReinforcementsAwarded_e091bec3-e904-ad68-a2ee-d135bc37fa4a)
THEN
DB_EPI_Epilogue_QueuedStatuses(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"EPI_OWLBEAR_ARMOR");
PROC_LevelUpBy(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, 5);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
NOT DB_GlobalFlag(END_GatherYourAllies_Event_OwlbearCubReinforcementsAwarded_e091bec3-e904-ad68-a2ee-d135bc37fa4a)
THEN
DB_EPI_Epilogue_QueuedStatuses(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"EPI_OWLBEAR");

//Wyll becomes a ranger
PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_GlobalFlag(CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
AND
DB_GlobalFlag(ORI_Wyll_State_IsDevil_f83eee79-271b-4044-947a-d8eb699d734a)
THEN
DB_EPI_Epilogue_QueuedStatuses(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,"EPI_WYLL_HORNS");
CharacterGiveEquipmentSet((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "EQP_EPI_Wyll_Ranger");

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_GlobalFlag(CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
AND
NOT DB_GlobalFlag(ORI_Wyll_State_IsDevil_f83eee79-271b-4044-947a-d8eb699d734a)
THEN
DB_EPI_Epilogue_QueuedStatuses(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,"EPI_WYLL");
CharacterGiveEquipmentSet((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "EQP_EPI_Wyll_Ranger");

//If avatar Wyll went to the hells with Karlach, clear his state flags so characters do not assume he has been living as a Duke/Blade of Avernus/Blade of Frontiers. Pray that Wyll does not explode from this
PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_Avatars(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_GlobalFlag(ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
THEN
ClearFlag(GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1);
ClearFlag(GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137);
ClearFlag(GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(ORI_Gale_Event_GaveCrownToMystra_3375fd8b-4958-421d-2d51-ff9af5beaaa0)
AND
IsTagged(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
THEN
RemoveSpell((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "Target_END_Gale_ActivateNethereseOrb", 1);
RemoveSpell((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "Shout_END_Gale_ActivateNethereseOrb", 1);
Transform((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTERROOT)ORIGIN_Gale_EPI_NoTattoo_97c36197-f09d-4faa-889d-5a37bdb905df, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d)
AND
IsTagged(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, _IsMindFlayer)
THEN
PROC_EPI_Epilogue_ApplyGodGaleForm(_IsMindFlayer);

PROC
PROC_EPI_Epilogue_ApplyGodGaleForm((INTEGER)_)
THEN
RemoveSpell((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "Target_END_Gale_ActivateNethereseOrb", 1);
RemoveSpell((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "Shout_END_Gale_ActivateNethereseOrb", 1);
RemoveTransforms(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604); 
SetImmortal(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1);
PROC_SetInvulnerable(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1);

PROC
PROC_EPI_Epilogue_ApplyGodGaleForm(0)
THEN
DB_EPI_Epilogue_QueuedStatuses(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,"EPI_GALEGOD");

PROC
PROC_EPI_Epilogue_ApplyGodGaleForm(1)
THEN
DB_EPI_Epilogue_QueuedStatuses(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,"EPI_GALEGOD_MINDFLAYER");

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_GlobalFlag(ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56)
AND
DB_GlobalFlag(END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209)
THEN
SetFlag((FLAG)EPI_Epilogue_State_IsHologram_c26bf0f3-3d72-4bf2-b6cc-8a8c5029f656, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
DB_EPI_Epilogue_QueuedStatuses(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,"EPI_LAEZEL_ASTRALPROJECTION");
SetFlag(EPI_Epilogue_State_AstralProjectionStatus_f87a0329-fa61-4efe-9ce5-3e6a6fd32324, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
IsTagged(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
THEN
DB_EPI_Epilogue_QueuedStatuses(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "EPI_KARLACH_MINDFLAYER");

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
IsTagged(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
THEN
PROC_SetOnStage(S_EPI_KarlachDoo_7786dad6-3e8c-4c3e-895d-6486e7ffbe14, 1);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_EPI_Epilogue_GiveCliveOnLoad(1);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_TeamMember)
AND
DB_PartOfTheTeam(_TeamMember)
AND
NOT DB_Avatars(_TeamMember)
AND
DB_EPI_Epilogue_PresentNPC(_TeamMember, _, _, _, _)
THEN
SetLevel(_TeamMember, 12);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetLevel(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 20);

IF
LevelGameplayStarted("EPI_Main_A", _)
AND
DB_EPI_Epilogue_GiveCliveOnLoad(1)
THEN
NOT DB_EPI_Epilogue_GiveCliveOnLoad(1);
ToInventory(S_EPI_Clive_b3ca8632-91d8-415e-9eab-38f7feb30d87, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 1, 0, 1);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_Player)
AND
DB_Avatars(_Player)
AND
DB_GlobalFlag(ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56)
AND
DB_GlobalFlag(END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209)
AND
GetFlag(ORI_Laezel_State_PlayerLaezelOrpheus_9bbf4067-fcb1-0c74-088d-ff887ca2abe5, _Player, 1) 
THEN
SetFlag((FLAG)EPI_Epilogue_State_IsHologram_c26bf0f3-3d72-4bf2-b6cc-8a8c5029f656, _Player);
DB_EPI_Epilogue_QueuedStatuses(_Player,"EPI_LAEZEL_ASTRALPROJECTION");
SetFlag(EPI_Epilogue_State_AstralProjectionStatus_f87a0329-fa61-4efe-9ce5-3e6a6fd32324, _Player, 0);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901)
THEN
ToInventory((ITEM)S_EPI_InertArtefact_c4a6e98b-3707-4111-833f-26c8cd45580e, S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, 1, 0, 1);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_Char)
AND
DB_EPI_Epilogue_ViolentSceneCharacters(_Char)
THEN
DB_SceneManager(_Char, "EPI_Epilogue_ViolentClosureScene");


PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa)
THEN
SetCanJoinCombat(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa, 0);
PROC_SetCanFight(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa, 0);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c)
THEN
SetCanJoinCombat(S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c, 0);
PROC_SetCanFight(S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c, 0);

//Set true be default, will clear through dialog if the player decides to reject him (so not talking to him will still trigger the scene)
PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_Player)
AND
GetFlag(ORI_Gale_State_AcceptedBeMyGodProposal_3d452ca4-14e6-176a-88ad-47d0ef8271d3, _Player, 1)
AND
GetFlag(END_GameFinale_State_PartnershipEndedGale_fa62b0f8-c884-4f68-b507-b70b9277b6de, _Player, 1)
AND
NOT QRY_EPI_Epilogue_CharacterIsUnavailable((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(EPI_Epilogue_State_AscendWithGodGale_1efb2c8d-498e-4978-b904-b5bc6fa695d2, _Player);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d)
THEN
SetVisible(S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d, 1);
SetDetached(S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d, 0);
PROC_SpotPlayers_StopSpotting((CHARACTER)S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d, "GLO_Gale_DeathVoice");
DB_EPI_Epilogue_QueuedStatuses(S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d,"EPI_SPECTRALVOICEVFX");
DB_EPI_Epilogue_QueuedStatuses(S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d,"EPI_EPILOGUE_SPECTRAL_GALE");

//REGION Owlbear / Scratch setup
PROC
PROC_EPI_Epilogue_SetAvailableNPC((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901)
THEN
PROC_SetOnStage(S_EPI_Scratch_Bowl_7098fbad-af03-425b-9369-c9a769666e38, 1);
PROC_SetOnStage(S_EPI_Scratch_Food_040d2711-2717-4054-92ff-1b1e4ed38e30, 1);

PROC
PROC_EPI_Epilogue_SetAvailableNPC((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901)
THEN
PROC_SetOnStage(S_EPI_Scratch_Bowl_7098fbad-af03-425b-9369-c9a769666e38, 1);
PROC_SetOnStage(S_EPI_Scratch_Food_040d2711-2717-4054-92ff-1b1e4ed38e30, 1);
//END_REGION

//END_REGION
PROC
PROC_EPI_Epilogue_CheckWaitingTeleportAvatars()
AND
NOT QRY_EPI_Epilogue_WaitingForNPCSet()
THEN
PROC_EPI_Epilogue_TeleportAvatars();

PROC
PROC_EPI_Epilogue_TeleportAvatars()
AND
DB_EPI_Epilogue_PresentAvatar(_Char)
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char)
THEN
TeleportTo(_Char, S_EPI_LevelLoadToPoint_3e1909dc-d482-431f-a029-3c1ff97f4127, "EPI_Epilogue_CharArrived", 0, 0, 0, 1, 1); 

QRY
QRY_EPI_Epilogue_WaitingForNPCSet()
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char)
THEN
DB_NOOP(1);

IF
EntityEvent(_Char, "EPI_Epilogue_CharArrived")
THEN
DB_EPI_Epilogue_SetCharacters((CHARACTER)_Char);
SetCombatGroupID(_Char, "");
PROC_EPI_Epilogue_CheckWaitingTeleportAvatars();
PROC_EPI_Epilogue_CheckForReadyStartingDialogs();

//REGION Clear all items and set party gear

PROC
PROC_EPI_Epilogue_TryClearInventory((CHARACTER)_Char)
AND
_Char != S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c //Wyll and Karlach are already handled, this is for anyone who joins them
AND
QRY_EPI_Epilogue_IsInAvernusWithKarlachorWyll(_Char)
THEN
PROC_EPI_Epilogue_SwapToAvernusClothing(_Char);

QRY
QRY_EPI_Epilogue_IsInAvernusWithKarlachorWyll((CHARACTER)_Char)
AND
GetFlag(END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Char, 1)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_IsInAvernusWithKarlachorWyll((CHARACTER)_Char)
AND
DB_Avatars(_Char)
AND
DB_GlobalFlag(ORI_Wyll_State_AvernusWithPlayer_15059894-8ec9-157d-bbd6-2f820ec213bf)
AND
DB_ORI_Partnered(_Char, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_SwapToAvernusClothing((CHARACTER)_Char)
AND
DB_EPI_Epilogue_PartyEquipment(_Char, _Flag, _Bool, _Clothing)
THEN
NOT DB_EPI_Epilogue_PartyEquipment(_Char, _Flag, _Bool, _Clothing);

PROC
PROC_EPI_Epilogue_SwapToAvernusClothing((CHARACTER)_Char)
THEN
DB_EPI_Epilogue_PartyEquipment(_Char, NULL_00000000-0000-0000-0000-000000000000, 1, EPI_Camp_Avernus_24149d5d-c509-48dc-b026-491c11e60a5c);
DB_EPI_Epilogue_PartyEquipment(_Char, NULL_00000000-0000-0000-0000-000000000000, 1, EPI_Camp_Shoes_Avernus_c36967e4-26c5-4f2f-b25b-f351a6bac804);

PROC
PROC_EPI_Epilogue_TryClearInventory((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT QRY_EPI_Epilogue_HasValidVanitySet((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_GlobalFlag(CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227)
THEN
DB_EPI_Epilogue_PartyEquipment(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, NULL_00000000-0000-0000-0000-000000000000, 1, EPI_Camp_Wyll_Blade_46c97e62-7d3e-449f-a130-586e8e871947);
DB_EPI_Epilogue_PartyEquipment(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, NULL_00000000-0000-0000-0000-000000000000, 1, EPI_Camp_Shoes_Wyll_Blade_c3f02e6c-d519-40d1-b686-a241a9f9972e);

PROC
PROC_EPI_Epilogue_TryClearInventory((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT QRY_EPI_Epilogue_HasValidVanitySet((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_GlobalFlag(CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227)
THEN
DB_EPI_Epilogue_PartyEquipment(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, NULL_00000000-0000-0000-0000-000000000000, 1, EPI_Camp_Avernus_24149d5d-c509-48dc-b026-491c11e60a5c);
DB_EPI_Epilogue_PartyEquipment(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, NULL_00000000-0000-0000-0000-000000000000, 1, EPI_Camp_Shoes_Avernus_c36967e4-26c5-4f2f-b25b-f351a6bac804);

//Dead/Unavailable avatars
PROC
PROC_EPI_Epilogue_TryClearInventory((CHARACTER)_Char)
AND
DB_Avatars(_Char)
AND
NOT QRY_EPI_Epilogue_AvatarIsPresentAtParty(_Char)
THEN
DB_EPI_Epilogue_IgnoredPartyGear(_Char);
MoveAllItemsTo(_Char, S_EPI_ChestOfGearBanishment_fe6caedc-1122-4041-aec7-d8cc1b1fa49e, 0, 1, 1, 0);

//Vlaakith Lae'zel
PROC
PROC_EPI_Epilogue_TryClearInventory((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_GlobalFlag(END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209)
AND
NOT DB_GlobalFlag(ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56)
AND
NOT DB_EPI_Epilogue_IgnoredPartyGear(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_EPI_Epilogue_IgnoredPartyGear(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
MoveAllItemsTo(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, S_EPI_ChestOfGearBanishment_fe6caedc-1122-4041-aec7-d8cc1b1fa49e, 0, 0, 1, 0);

PROC
PROC_EPI_Epilogue_TryClearInventory((CHARACTER)_Char)
AND
QRY_EPI_Epilogue_HasValidVanitySet((CHARACTER)_Char)
AND
NOT DB_EPI_Epilogue_IgnoredPartyGear(_Char)
THEN
PROC_EPI_Epilogue_SwapEquipment(_Char, 1);

PROC
PROC_EPI_Epilogue_TryClearInventory((CHARACTER)_Char)
AND
NOT QRY_EPI_Epilogue_HasValidVanitySet((CHARACTER)_Char)
AND
NOT DB_EPI_Epilogue_IgnoredPartyGear(_Char)
AND
DB_Origins(_Char)
THEN
PROC_EPI_Epilogue_SwapEquipment(_Char, 0);

PROC
PROC_EPI_Epilogue_TryClearInventory((CHARACTER)_Char)
AND
NOT QRY_EPI_Epilogue_HasValidVanitySet((CHARACTER)_Char)
AND
NOT DB_EPI_Epilogue_IgnoredPartyGear(_Char)
AND
DB_Avatars(_Char)
THEN
PROC_EPI_Epilogue_SwapEquipment(_Char, 0);

PROC
PROC_EPI_Epilogue_SwapEquipment((CHARACTER)_Char,(INTEGER)_)
THEN
MoveAllItemsTo(_Char, S_EPI_ChestOfGearBanishment_fe6caedc-1122-4041-aec7-d8cc1b1fa49e, 0, 0, 1, 0);
PROC_SetArmourSet(_Char, ARMOURSET.Vanity);
PROC_EPI_Epilogue_SetPartyUnderwear(_Char);

PROC
PROC_EPI_Epilogue_SwapEquipment((CHARACTER)_Char,(INTEGER)_)
AND
GetEquippedItem(_Char, "Melee Main Weapon", _Item)
AND
IsTorch(_Item, 1)
THEN
Unequip(_Char, _Item);

PROC
PROC_EPI_Epilogue_SwapEquipment((CHARACTER)_Char, 1)
THEN
PROC_EPI_Epilogue_SetPartyEquipment(_Char);

PROC
PROC_EPI_Epilogue_SwapEquipment((CHARACTER)_Char, 0)
THEN
PROC_EPI_Epilogue_SetFallbackPartyEquipment(_Char);

QRY
QRY_EPI_Epilogue_HasValidVanitySet((CHARACTER)_Char)
AND
NOT DB_EPI_Epilogue_IgnoredPartyGear(_Char)
AND
DB_EPI_Epilogue_PartyEquipment(_Char, _Flag, _Bool, _)
AND
_Flag != NULL_00000000-0000-0000-0000-000000000000
AND
GetFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000, _Bool)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_HasValidVanitySet((CHARACTER)_Char)
AND
NOT DB_EPI_Epilogue_IgnoredPartyGear(_Char)
AND
DB_EPI_Epilogue_PartyEquipment(_Char, NULL_00000000-0000-0000-0000-000000000000, 1, _)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_SetPartyEquipment((CHARACTER)_Char)
AND
DB_EPI_Epilogue_PartyEquipment(_Char, _, _, _ItemTemplate)
AND
QRY_EPI_Epilogue_VanityTemplateIsValid(_Char, _ItemTemplate)
THEN
PROC_EPI_Epilogue_TemplateAddTo(_ItemTemplate, _Char);

QRY
QRY_EPI_Epilogue_VanityTemplateIsValid((CHARACTER)_Char,(ITEMROOT)_ItemTemplate)
AND
DB_EPI_Epilogue_PartyEquipment(_Char, _Flag, _Bool, _ItemTemplate)
AND
_Flag != NULL_00000000-0000-0000-0000-000000000000
AND
GetFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000, _Bool)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_VanityTemplateIsValid((CHARACTER)_Char,(ITEMROOT)_ItemTemplate)
AND
DB_EPI_Epilogue_PartyEquipment(_Char, NULL_00000000-0000-0000-0000-000000000000, 1, _ItemTemplate)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_SetFallbackPartyEquipment((CHARACTER)_)
AND
DB_EPI_Epilogue_FallbackPartySetIteration(_Count)
AND
_Count >= 4
THEN
NOT DB_EPI_Epilogue_FallbackPartySetIteration(_Count);
DB_EPI_Epilogue_FallbackPartySetIteration(0);

PROC
PROC_EPI_Epilogue_SetFallbackPartyEquipment((CHARACTER)_)
AND
DB_EPI_Epilogue_FallbackPartySetIteration(_OldCount)
AND
IntegerSum(_OldCount, 1, _NewCount)
THEN
NOT DB_EPI_Epilogue_FallbackPartySetIteration(_OldCount);
DB_EPI_Epilogue_FallbackPartySetIteration(_NewCount);

PROC
PROC_EPI_Epilogue_SetFallbackPartyEquipment((CHARACTER)_Char)
AND
DB_EPI_Epilogue_FallbackPartySetIteration(_Index)
AND
DB_EPI_Epilogue_FallbackPartyEquipment((ITEMROOT)_ItemTemplate, _Index)
THEN
PROC_EPI_Epilogue_TemplateAddTo(_ItemTemplate, _Char);

PROC
PROC_EPI_Epilogue_TemplateAddTo((ITEMROOT)_ItemTemplate,(CHARACTER)_Char)
THEN
DB_EPI_Epilogue_IntermItemRoot(_ItemTemplate,_Char);
TemplateAddTo((ITEMROOT)_ItemTemplate, _Char, 1, 0);

IF
TemplateAddedTo(_ItemTemplate, _Item, _Char, _)
AND
DB_EPI_Epilogue_IntermItemRoot((ITEMROOT)_ItemTemplate,(CHARACTER)_Char)
THEN
Equip(_Char, (ITEM)_Item);
NOT DB_EPI_Epilogue_IntermItemRoot(_ItemTemplate,_Char);

PROC
PROC_EPI_Epilogue_SetPartyUnderwear((CHARACTER)_Char)
AND
DB_EPI_Epilogue_PartyUnderwear(_Char, _ItemTemplate)
THEN
PROC_EPI_Epilogue_TemplateAddTo(_ItemTemplate, _Char);

PROC
PROC_EPI_Epilogue_SetPartyUnderwear((CHARACTER)_Char)
AND
NOT DB_EPI_Epilogue_PartyUnderwear(_Char, _)
AND
DB_EPI_Epilogue_FallbackPartyUnderwear(_Tag, _ItemTemplate)
AND
IsTagged(_Char, _Tag, 1)
THEN
PROC_EPI_Epilogue_TemplateAddTo(_ItemTemplate, _Char);

//END_REGION

//REGION Party Start
PROC
PROC_EPI_Epilogue_CheckForReadyStartingDialogs()
AND
NOT QRY_EPI_Epilogue_WaitingForCharacterSet()
AND
QRY_OnlyOnce("EPI_Epilogue_StartOpeningSequence")
THEN
PROC_EPI_Epilogue_StartOpeningSequence();

PROC
PROC_EPI_Epilogue_StartOpeningSequence()
AND
DB_OnlyOnce("EPI_Epilogue_SelectedOpeningDialog")
THEN
NOT DB_OnlyOnce("EPI_Epilogue_SelectedOpeningDialog");

PROC
PROC_EPI_Epilogue_StartOpeningSequence()
AND
NOT QRY_EPI_Epilogue_AnyOpeningDialogAvailable()
AND
QRY_OnlyOnce("EPI_Epilogue_StartPartyOnce")
THEN
PROC_EPI_Epilogue_TryStartEnterParty();

PROC
PROC_EPI_Epilogue_StartOpeningSequence()
AND
QRY_EPI_Epilogue_AnyOpeningDialogAvailable()
THEN
PROC_EPI_Epilogue_SelectOpeningDialog();

QRY
QRY_EPI_Epilogue_AnyOpeningDialogAvailable()
AND
DB_EPI_Epilogue_QueuedOpeningDialogs(_, _)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_SelectOpeningDialog()
AND
DB_EPI_Epilogue_OpeningDialogs(_Dialog)
AND
DB_EPI_Epilogue_QueuedOpeningDialogs(_Dialog, _Speaker)
AND
NOT DB_OnlyOnce("EPI_Epilogue_SelectedOpeningDialog")
THEN
DB_OnlyOnce("EPI_Epilogue_SelectedOpeningDialog");
DB_EPI_Epilogue_SelectedOpeningDialog(_Dialog, _Speaker);
NOT DB_EPI_Epilogue_QueuedOpeningDialogs(_Dialog, _Speaker);
PROC_EPI_Epilogue_ReadyOpeningSpeakers();

PROC
PROC_EPI_Epilogue_ReadyOpeningSpeakers()
AND
DB_EPI_Epilogue_SelectedOpeningDialog(_Dialog, _Speaker)
THEN
NOT DB_EPI_Epilogue_SelectedOpeningDialog(_Dialog, _Speaker);
PROC_EPI_Epilogue_StartOpeningDialog((DIALOGRESOURCE)_Dialog,(CHARACTER)_Speaker);

PROC
PROC_EPI_Epilogue_StartOpeningDialog((DIALOGRESOURCE)EPI_Epilogue_AvatarLeftEarly_ae9cd608-5688-63d6-1ecc-355496e2a6be,(CHARACTER)_Speaker)
AND
NOT QRY_StartDialogCustom(EPI_Epilogue_AvatarLeftEarly_ae9cd608-5688-63d6-1ecc-355496e2a6be, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _Speaker, 0, 0, 0, 0)
THEN
PROC_EPI_Epilogue_StartOpeningSequence();

PROC
PROC_EPI_Epilogue_StartOpeningDialog((DIALOGRESOURCE)EPI_Epilogue_AvatarLockedAway_d89bd31e-787a-0293-5314-42641d243b81,(CHARACTER)_Speaker)
AND
NOT QRY_StartDialogCustom(EPI_Epilogue_AvatarLockedAway_d89bd31e-787a-0293-5314-42641d243b81, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _Speaker, 0, 0, 0, 0)
THEN
PROC_EPI_Epilogue_StartOpeningSequence();

PROC
PROC_EPI_Epilogue_StartOpeningDialog((DIALOGRESOURCE)EPI_Epilogue_AvatarLockedAway_d89bd31e-787a-0293-5314-42641d243b81,(CHARACTER)_DarkUrge)
AND
DB_ORI_DarkUrge(_DarkUrge)
THEN
PROC_SetArmourSet(_DarkUrge, ARMOURSET.Vanity);
ToInventory(S_EPI_DarkUrgePrisonClothes_b13218f0-5d14-4d5c-a12a-dbfcbaf52864,_DarkUrge, 1, 0, 1);

IF
AddedTo(S_EPI_DarkUrgePrisonClothes_b13218f0-5d14-4d5c-a12a-dbfcbaf52864, _DarkUrge, _)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
Equip(_DarkUrge, (ITEM)S_EPI_DarkUrgePrisonClothes_b13218f0-5d14-4d5c-a12a-dbfcbaf52864);

PROC
PROC_EPI_Epilogue_StartOpeningDialog((DIALOGRESOURCE)EPI_Epilogue_VlaakithAscension_0a3237fc-7a3c-6e32-6ffa-72d459ff49cb,(CHARACTER)_Speaker)
AND
NOT QRY_StartDialogCustom(EPI_Epilogue_VlaakithAscension_0a3237fc-7a3c-6e32-6ffa-72d459ff49cb, S_GLO_Vlaakith_6b00f9fb-b932-4ac9-8ed8-1ca89dd7d247, _Speaker, 0, 0, 0, 0)
THEN
PROC_EPI_Epilogue_StartOpeningSequence();

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_VlaakithAscension_0a3237fc-7a3c-6e32-6ffa-72d459ff49cb,_ID)
AND
NOT DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_Avatars(_Player)
AND
GetFlag(END_GameFinale_State_PlayerLaezelVlaakith_bf95c085-fe78-9cda-7aac-2d8e5b94a9cf, _Player, 1) 
THEN
PROC_SetArmourSet(_Player, ARMOURSET.Normal);
DB_EPI_Epilogue_VlaakithAscensionAvatarSelected(_Player);
PROC_DialogAddSpeakingActor(_ID, _Player, 1, 1);

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_VlaakithAscension_0a3237fc-7a3c-6e32-6ffa-72d459ff49cb,_ID)
AND
NOT DB_Avatars(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_Avatars(_Player)
AND
NOT DB_EPI_Epilogue_VlaakithAscensionAvatarSelected(_Player)
THEN
PROC_DialogAddSpeakingActor(_ID, _Player, 1, 1);

PROC
PROC_StartDialog_AddExtraSpeakers(_Dialog,_ID)
AND
DB_EPI_Epilogue_OpeningDialogs(_Dialog)
AND
DB_Avatars(_Player)
THEN
PROC_DialogAddSpeakingActor(_ID, _Player, 1, 1);

IF
DialogEnded(_Dialog, _ID)
AND
DB_EPI_Epilogue_OpeningDialogs(_Dialog)
THEN
PROC_EPI_Epilogue_StartOpeningSequence();

QRY
QRY_EPI_Epilogue_WaitingForCharacterSet()
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_WaitingForCharacterSet()
AND
DB_EPI_Epilogue_PresentAvatar(_Char)
AND
NOT DB_EPI_Epilogue_SetCharacters(_Char)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_WaitingForCharacterSet()
AND
DB_EPI_Epilogue_WaitingForVlaakithLaezel(1)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_TryStartEnterParty()
AND
NOT QRY_EPI_Epilogue_AnyNonAvatarsPresent()
THEN
SetFlag(EPI_Epilogue_State_OnlyAvatars_1f53592c-fe6a-440b-bbdb-44691638e9fa);

QRY
QRY_EPI_Epilogue_AnyNonAvatarsPresent()
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
AND
_Char != S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805
AND
_Char != S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_TryStartEnterParty()
AND
DB_EPI_Epilogue_PresentAvatar(_Avatar)
AND
DB_ORI_Partnered(_Avatar, _Char)
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
AND
NOT QRY_EPI_Epilogue_AnyNonPartneredNPCPresent()
AND
NOT DB_GlobalFlag(EPI_Epilogue_State_OnlyAvatarsAndPartners_1814c187-b1ab-4f3d-9513-5af7416fdb1d)
THEN
SetFlag(EPI_Epilogue_State_OnlyAvatarsAndPartners_1814c187-b1ab-4f3d-9513-5af7416fdb1d);

QRY
QRY_EPI_Epilogue_AnyNonPartneredNPCPresent()
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
AND
_Char != S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805
AND
_Char != S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c
AND
NOT DB_ORI_Partnered(_, _Char)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_TryStartEnterParty()
AND
NOT QRY_EPI_Epilogue_SkipParty() 
THEN
PROC_EPI_Epilogue_SetupGazettes();
PROC_EPI_Epilogue_SetupLetters();
PROC_EPI_Epilogue_RestoreCharacters();
PROC_EPI_Epilogue_StartEnterPartyDialog();
SetFlag(GLO_DisableRelationshipDialogsPermanently_1b1d90ae-583f-4e91-9016-6cf6446a055a); //No relationship dialogs should happen in Epilogue

PROC
PROC_EPI_Epilogue_RestoreCharacters()
AND
DB_EPI_Epilogue_SetCharacters(_Char)
THEN
DB_EPI_Epilogue_RestorePartyRequest(1);
RestoreParty((CHARACTER)_Char);
RealtimeObjectTimerLaunch(_Char, "EPI_Epilogue_RestorePartyTimer", 500);

IF
RestorePartyFinished()
AND
DB_EPI_Epilogue_RestorePartyRequest(1)
AND
DB_EPI_Epilogue_QueuedStatuses(_Char, _Status)
THEN
NOT DB_EPI_Epilogue_RestorePartyRequest(1);
ApplyStatus(_Char, _Status,-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

IF
ObjectTimerFinished(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, "EPI_Epilogue_RestorePartyTimer")
THEN
PROC_SetInvulnerable(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, 1);

// the following is here for saved game compatibility where someone saved before the timer expired
// but RestorePartyFinished possibly was already called
IF
ObjectTimerFinished(_Char, "EPI_Epilogue_CheckStatusApplyTimer")
AND
DB_EPI_Epilogue_QueuedStatuses(_Char, _Status)
THEN
ApplyStatus(_Char, _Status,-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

IF
ObjectTimerFinished(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, "EPI_Epilogue_CheckStatusApplyTimer")
THEN
PROC_SetInvulnerable(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, 1);

PROC
PROC_EPI_Epilogue_TryStartEnterParty()
AND
QRY_EPI_Epilogue_SkipParty()
THEN
SetFlag(EPI_Epilogue_State_SkippedParty_179216e1-7892-4fe2-8d0b-d556193e9722);
PROC_EPI_Epilogue_StartClosingSequence();

//TODO: Add checks
//Things to check for:
//  - If the avatars the only ones present at the party, skip?
//  - If there are any characters besides romance partners and avatars (might be able to cover this state with just RomanceFates)
//  - If Raphael is the only one present, should he force a solo dialog with the avatar?
//  - What if no origins, but Volo, Scratch, Owlbear?
QRY
QRY_EPI_Epilogue_SkipParty()
AND
NOT QRY_EPI_Epilogue_AnyAvailableAvatar()
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_AnyAvailableAvatar()
AND
DB_EPI_Epilogue_PresentAvatar(_Player)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_StartEnterPartyDialog()
AND
QRY_EPI_Epilogue_GetEnterPartyPrimarySpeaker()
AND
DB_QRYRTN_EPI_Epilogue_EnterPartyPrimarySpeaker(_Player)
AND
QRY_StartDialogCustom(EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _Player, 0, 0, 0, 0)
THEN
DB_EPI_Epilogue_EnterPartyDialogStarted(1);
SetFlag(EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e);

//If Main Dialog Anchor is still valid
QRY
QRY_EPI_Epilogue_GetEnterPartyPrimarySpeaker()
AND
DB_END_General_MainDialogAnchor(_Player)
AND
QRY_EPI_Epilogue_AvatarIsPresentAtParty(_Player)
AND
NOT DB_QRYRTN_EPI_Epilogue_EnterPartyPrimarySpeaker(_)
THEN
DB_QRYRTN_EPI_Epilogue_EnterPartyPrimarySpeaker(_Player);

//Prefer an avatar who has a partner
QRY
QRY_EPI_Epilogue_GetEnterPartyPrimarySpeaker()
AND
DB_Avatars(_Player)
AND
QRY_EPI_Epilogue_AvatarIsPresentAtParty(_Player)
AND
DB_ORI_Partnered(_Player, _)
AND
NOT DB_QRYRTN_EPI_Epilogue_EnterPartyPrimarySpeaker(_)
THEN
DB_QRYRTN_EPI_Epilogue_EnterPartyPrimarySpeaker(_Player);

//Any available avatar
QRY
QRY_EPI_Epilogue_GetEnterPartyPrimarySpeaker()
AND
DB_Avatars(_Player)
AND
QRY_EPI_Epilogue_AvatarIsPresentAtParty(_Player)
AND
NOT DB_QRYRTN_EPI_Epilogue_EnterPartyPrimarySpeaker(_)
THEN
DB_QRYRTN_EPI_Epilogue_EnterPartyPrimarySpeaker(_Player);

PROC
PROC_EPI_Epilogue_StartEnterPartyDialog()
AND
NOT DB_EPI_Epilogue_EnterPartyDialogStarted(1)
THEN
DB_EPI_Epilogue_EnterPartyDialogFailed(1);

IF
DB_EPI_Epilogue_EnterPartyDialogFailed(1)
THEN
SetFlag(EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e);

//Add Avatar Partner to reserved GROUP_Players speaker slot. 
PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd,_ID)
AND
DB_QRYRTN_EPI_Epilogue_EnterPartyPrimarySpeaker(_Avatar)
AND
DB_ORI_Partnered(_Avatar, _Partner)
AND
DB_EPI_Epilogue_SetCharacters(_Partner)
THEN
PROC_DialogAddSpeakingActorAt(_ID, _Partner, 11);

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd,_ID)
AND
DB_QRYRTN_EPI_Epilogue_EnterPartyPrimarySpeaker(_Player)
THEN
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog(EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd, _ID, _Player);

PROC
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog((DIALOGRESOURCE)_, (INTEGER)_, (CHARACTER)_)
AND
DB_EPI_Epilogue_ActiveDialogID(_ID)
THEN
NOT DB_EPI_Epilogue_ActiveDialogID(_ID);

PROC
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog((DIALOGRESOURCE)_, (INTEGER)_ID, (CHARACTER)_)
THEN
DB_EPI_Epilogue_ActiveDialogID(_ID);

PROC
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog((DIALOGRESOURCE)_Dialog, (INTEGER)_ID, (CHARACTER)_Player)
AND
DB_Avatars(_Avatar)
AND
_Player != _Avatar
AND
DB_EPI_Epilogue_IncludeAvatarDialogs(_Dialog, _StartSlot, _EndSlot)
AND
_StartSlot <= _EndSlot
AND
IntegerSum(_StartSlot, 1, _NewSlot)
THEN
PROC_DialogAddSpeakingActorAt(_ID, _Avatar, _StartSlot);
NOT DB_EPI_Epilogue_IncludeAvatarDialogs(_Dialog, _StartSlot, _EndSlot);
DB_EPI_Epilogue_IncludeAvatarDialogs(_Dialog, _NewSlot, _EndSlot);

PROC
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog((DIALOGRESOURCE)_Dialog, (INTEGER)_ID, (CHARACTER)_Player)
AND
DB_EPI_Epilogue_SetCharacters(_Char)
AND
_Char != S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d //Don't want him showing up in dialogs in Gale's speaker slot
AND
NOT DB_Defeated(_Char)
AND
NOT DB_EPI_Epilogue_ActiveEpilogueDialogAndSpeaker(_, (CHARACTER)_Char)
THEN
PROC_DialogAddSpeakingActor(_ID,_Char, 1, 1);

PROC
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog((DIALOGRESOURCE)_Dialog, (INTEGER)_ID, (CHARACTER)_Player)
AND
DB_Downed(_Speaker)
AND
NOT DB_DialogEnding(_,_ID)
AND
QRY_DownedSpeakerIsAvailable((GUIDSTRING)_Speaker, 1)
AND
DB_DialogRequestCache_DialogInstance(_Dialog,_ID)
AND
QRY_PrepForInteractiveDialog_IfInteractive(_Dialog,_ID,_Speaker)
THEN
DialogAddActorAtReservedSlot(_ID,_Speaker,1,0,1);
PROC_DialogRequestCache_MakeSpeakerLists_Evaluate(_Dialog,_ID,_Speaker);

QRY
QRY_DialogStarted_CheckPlayerForStopConditions_IgnoreDowned((INTEGER)_ID,(CHARACTER)_Player)
AND
DB_Players(_Player)
AND
DB_EPI_Epilogue_ActiveDialogID(_ID)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog((DIALOGRESOURCE)_Dialog, (INTEGER)_ID, (CHARACTER)_Player)
AND
DB_Avatars(_Avatar)
AND
_Player != _Avatar
AND
DB_Defeated(_Avatar)
AND
NOT DB_Downed(_Avatar)
AND
DialogAllowDeadSpeakers(_Dialog, 1)
THEN
PROC_DialogAddSpeakingActor(_ID,_Avatar, 1, 1);

PROC
PROC_DialogStarted((DIALOGRESOURCE)EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd, _ID)
AND
NOT QRY_EPI_Epilogue_AnyOtherNonEntryCharactersInParty((INTEGER)_ID)
THEN
PROC_GlobalSetFlagAndCache(EPI_Epilogue_State_OnlyEnterPartySpeakers_9118ef62-439d-4465-be76-fc2414130f61);

IF
FlagSet(EPI_Epilogue_State_EnterPartySpeaker1_006f97b2-6077-4a6c-8ea0-61be88b1502e, _Char, _ID) //These flags are set on the greeting nodes to know who the primary speaker arrived with
AND
NOT QRY_EPI_Epilogue_AnyOtherNonEntryCharactersInParty((INTEGER)_ID)
THEN
PROC_GlobalSetFlagAndCache(EPI_Epilogue_State_OnlyEnterPartySpeakers_9118ef62-439d-4465-be76-fc2414130f61);

IF
FlagSet(EPI_Epilogue_State_EnterPartySpeaker2_825b66a4-d99c-4c23-9845-6b8f4362ea30, _Char, _ID)
AND
NOT QRY_EPI_Epilogue_AnyOtherNonEntryCharactersInParty((INTEGER)_ID)
THEN
PROC_GlobalSetFlagAndCache(EPI_Epilogue_State_OnlyEnterPartySpeakers_9118ef62-439d-4465-be76-fc2414130f61);

QRY
QRY_EPI_Epilogue_AnyOtherNonEntryCharactersInParty((INTEGER)_ID)
AND
DB_EPI_Epilogue_PresentNPC(_Char, _, _, _, _)
AND
DB_Origins(_Char)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
_Char != _Player
AND
GetFlag(EPI_Epilogue_State_EnterPartySpeaker1_006f97b2-6077-4a6c-8ea0-61be88b1502e, _Char, 0)
AND
GetFlag(EPI_Epilogue_State_EnterPartySpeaker2_825b66a4-d99c-4c23-9845-6b8f4362ea30, _Char, 0)
THEN
DB_NOOP(1);

//We can assume when Withers speaks of meeting friends, this can include other Avatars
QRY
QRY_EPI_Epilogue_AnyOtherNonEntryCharactersInParty((INTEGER)_ID)
AND
DB_EPI_Epilogue_PresentAvatar(_OtherAvatar)
AND
DB_DialogPlayers(_ID, _MainSpeaker, 1)
AND
_MainSpeaker != _OtherAvatar
AND
GetFlag(EPI_Epilogue_State_EnterPartySpeaker1_006f97b2-6077-4a6c-8ea0-61be88b1502e, _OtherAvatar, 0)
AND
GetFlag(EPI_Epilogue_State_EnterPartySpeaker2_825b66a4-d99c-4c23-9845-6b8f4362ea30, _OtherAvatar, 0)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)EPI_Epilogue_EnterParty_94884506-7f00-14de-c738-239c3e60e2cd, _)
THEN
PROC_CharacterMoveTo(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, S_EPI_WithersSecludedPoint_978dc7d8-12fc-4861-8e60-dbd4b1cd7633, "Walk", "");
AutoSave();

//END_REGION

//Block CRDs in EPI.
QRY
QRY_DisabledCRDs()
THEN
DB_NOOP(1);

//END_REGION Setup

//REGION Divine Bard

IF
DialogStarted(EPI_Epilogue_DivineBard_638b3683-ac20-9a7f-4af0-c1c0fa5fb98e, _)
THEN
PROC_MusicPlayGeneral("EPI_BardScripted_Off"); 
PROC_GlobalClearFlagAndCache(EPI_Epilogue_DivineBard_State_PlayingSong_262657bd-c979-4994-bb16-8266a3d2c146);

IF
DialogEnded(EPI_Epilogue_DivineBard_638b3683-ac20-9a7f-4af0-c1c0fa5fb98e, _)
THEN
PROC_MusicPlayGeneral("EPI_BardScripted_On"); 

IF
EntityEvent(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, "EPI_Epilogue_CharArrived")
AND
CreateAtObject(TOOL_GEN_Music_Guitar_Lute_B_f2487101-548f-4494-9ec8-b20fa3ad6f7b, S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, 0, 0, "", 0, _Lute)
THEN
Equip((CHARACTER)S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, (ITEM)_Lute, 1, 0, 0);

IF
StatusApplied(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, _SongStatus, _, _)
AND
DB_EPI_Epilogue_DivineBardTracks(_SongStatus, _MusicTrack)
THEN
PROC_EPI_Epilogue_ChangeBardTrack(_MusicTrack);

PROC
PROC_EPI_Epilogue_ChangeBardTrack((STRING)_MusicTrack)
THEN
PROC_MusicPlayGeneral(_MusicTrack); 

IF
AttackedBy(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, _Player, _, _, _, _, _)
AND
DB_Avatars((CHARACTER)_Player)
AND
QRY_EPI_Epilogue_AvatarIsPresentAtParty(_Player)
AND
NOT DB_EPI_Epilogue_DivineBardWaitingToADBeforeLeaving(1)
THEN
UseSpell(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c,"Target_EPI_DivineViciousMockery",_Player);
SetFlag(EPI_Epilogue_State_AttackedDivineBard_c71f72bc-3ca3-4420-aec3-ed7f975bbee1);

IF
UsingSpellOnTarget((CHARACTER)S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c,(CHARACTER)_Target,"Target_EPI_DivineViciousMockery",_,_,_)
THEN
PROC_TryStartAD((DIALOGRESOURCE)EPI_Epilogue_AD_AttackedDivineBard_f78c7fba-334b-f4c4-8c2a-72f0119d3f71,S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c,_Target);

IF
CastedSpell((GUIDSTRING)S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, "Target_EPI_DivineViciousMockery", _, _, _)
THEN
PROC_EPI_Epilogue_TryDivineBardLeave();

PROC
PROC_EPI_Epilogue_TryDivineBardLeave()
AND
DB_GlobalFlag(EPI_Epilogue_State_DivineBardWasAttacked_27f4fcf8-dc46-49c1-b75f-bface8abb7a4)
AND
NOT DB_EPI_Epilogue_DivineBardWaitingToADBeforeLeaving(1)
THEN
DB_EPI_Epilogue_DivineBardWaitingToADBeforeLeaving(1);
PROC_RemoveDialog(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c);
ObjectTimerLaunch(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, "EPI_Epilogue_DivineBardLeaving", 5000);

IF
ObjectTimerFinished(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, "EPI_Epilogue_DivineBardLeaving")
THEN
PROC_GlobalSetFlagAndCache(EPI_Epilogue_Event_DivineBardLeaving_fa7225bb-458a-bb3a-7f70-4f9e5fed95d0);
PROC_TryStartAD((DIALOGRESOURCE)EPI_Epilogue_AD_AttackedDivineBard_f78c7fba-334b-f4c4-8c2a-72f0119d3f71,S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c);

PROC
PROC_EPI_Epilogue_TryDivineBardLeave()
AND
NOT DB_GlobalFlag(EPI_Epilogue_State_DivineBardWasAttacked_27f4fcf8-dc46-49c1-b75f-bface8abb7a4)
THEN
SetFlag(EPI_Epilogue_State_DivineBardWasAttacked_27f4fcf8-dc46-49c1-b75f-bface8abb7a4);

IF
AutomatedDialogEnded(EPI_Epilogue_AD_AttackedDivineBard_f78c7fba-334b-f4c4-8c2a-72f0119d3f71, _)
AND
DB_GlobalFlag(EPI_Epilogue_Event_DivineBardLeaving_fa7225bb-458a-bb3a-7f70-4f9e5fed95d0)
THEN
PROC_EPI_EPilogue_PoofAwayDivineBard();

PROC
PROC_EPI_EPilogue_PoofAwayDivineBard()
THEN
PROC_Poof(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c);

PROC
PROC_EPI_EPilogue_PoofAwayDivineBard()
AND
DB_EPI_Epilogue_DivineBardInstruments(_Instrument)
THEN
PROC_Poof(_Instrument);
//END_REGION

//REGION Ghost reactions
IF
MovedBy(_Evidence, _Avatar)
AND
DB_EPI_Epilogue_GhostAvatar(_Avatar)
THEN
PROC_CRIME_Distraction(_Evidence, _Avatar, NULL_00000000-0000-0000-0000-000000000000, "EPI_Epilogue_GhostReaction"); //PROC_CRIME_Distraction((GUIDSTRING)_DistractionEvidence,(CHARACTER)_Caster,(CHARACTER)_Victim,(STRING)_DisturbanceName)

IF
OnThrown(_Evidence, _, (CHARACTER)_Avatar, _, _, _, _)
AND
DB_EPI_Epilogue_GhostAvatar(_Avatar)
THEN
PROC_CRIME_Distraction(_Evidence, _Avatar, NULL_00000000-0000-0000-0000-000000000000, "EPI_Epilogue_GhostReaction"); //PROC_CRIME_Distraction((GUIDSTRING)_DistractionEvidence,(CHARACTER)_Caster,(CHARACTER)_Victim,(STRING)_DisturbanceName)

IF
TextEvent("makeghost")
AND
DB_Avatars(_Avatar)
THEN
DB_END_General_ForcedListener(_Avatar, 0);
PROC_EPI_Epilogue_MakeAvatarGhost(_Avatar);
//END_REGION Ghost reactions

//REGION
IF
LevelGameplayStarted("EPI_Main_A", _)
AND
DB_PartOfTheTeam(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
QRY_OnlyOnce("EPI_Halsin_GiveDuck")
THEN
ToInventory(S_EPI_HalsinsDuck_b59b5990-bdf3-475e-8284-baa9de260aa5, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1, 0, 1);

IF
FlagSet(EPI_Epilogue_Event_GiveInertArtefact_0173b9d6-e9d9-49ae-90dd-ff9118ed23de, _, _)
THEN
ClearFlag(EPI_Epilogue_Event_GiveInertArtefact_0173b9d6-e9d9-49ae-90dd-ff9118ed23de);
PROC_EPI_Epilogue_TryDropInertArtefact();

PROC
PROC_EPI_Epilogue_TryDropInertArtefact()
AND
GetFlag(EPI_Epilogue_State_HasInertArtefact_855ec61c-4c00-4e3f-8802-ba7b2d6a3958, S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, 1)
THEN
Drop(S_EPI_InertArtefact_c4a6e98b-3707-4111-833f-26c8cd45580e);
ClearOwnership(S_EPI_InertArtefact_c4a6e98b-3707-4111-833f-26c8cd45580e);

PROC
PROC_FOR_CourierDog_ReturnFetchItemToPlayer((ITEM)S_EPI_InertArtefact_c4a6e98b-3707-4111-833f-26c8cd45580e,(CHARACTER)_)
THEN
PROC_EPI_Epilogue_TryDropInertArtefact();

QRY
QRY_FOR_CourierDog_BlockReturnFetchedItem()
AND
DB_CurrentLevel("EPI_Main_A")
THEN
DB_NOOP(1);
//END_REGION

//REGION Mind Flayer Urge

IF
DialogEnded(_Dialog, _ID)
AND
NOT DB_GlobalFlag(EPI_Epilogue_State_MindFlayerUrgeOccurred_955722e3-e36b-49b0-a12d-09a157fc6c96)
AND
DB_EPI_Epilogue_PresentNPC(_Char, _Dialog, _, _, _)
AND
DB_Origins(_Char)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
IsTagged(_Player, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
AND
NOT QRY_EPI_Epilogue_InvalidBrain(_Char)
THEN
PROC_EPI_Epilogue_TryMindFlayerUrgeDialog(_Char,(CHARACTER)_Player);

QRY
QRY_EPI_Epilogue_InvalidBrain((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_InvalidBrain((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_GlobalFlag(END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_TryMindFlayerUrgeDialog((CHARACTER)_,(CHARACTER)_)
AND
DB_EPI_Epilogue_MindFlayerUrgeChance(_Int)
AND
_Int < 100
AND
IntegerSum(_Int, 10, _NewChance)
THEN
NOT DB_EPI_Epilogue_MindFlayerUrgeChance(_Int);
DB_EPI_Epilogue_MindFlayerUrgeChance(_NewChance);

PROC
PROC_EPI_Epilogue_TryMindFlayerUrgeDialog((CHARACTER)_Char,(CHARACTER)_Player)
AND
DB_EPI_Epilogue_MindFlayerUrgeChance(_Chance)
AND
Random(100, _Int)
AND
_Int <= _Chance 
AND
IsTagged(_Player, HUMANOID_7fbed0d4-cabc-4a9d-804e-12ca6088a0a8, 0) //Not disguised
AND
QRY_StartDialog(EPI_Epilogue_MindFlayerUrge_0e7a5eec-5ab6-8f55-79a5-6c410cf15ebe, _Char, _Player)
THEN
DB_DialogDeath(_Char);

PROC
PROC_FlagReactionAfterDialog(_Char, EPI_Epilogue_Event_MindFlayerUrgeHostile_5d02848e-c58f-4a7c-b17e-058e31b7129f, EPI_Epilogue_MindFlayerUrge_0e7a5eec-5ab6-8f55-79a5-6c410cf15ebe)
AND
DB_Avatars(_Player)
AND
IsTagged(_Player, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
THEN
PROC_EPI_Epilogue_GetViolentInterruptOwner((CHARACTER)_Char,(CHARACTER)_Player);
PROC_SceneOver("EPI_Epilogue_ViolentClosureScene");

//END_REGION

//REGION General Party Dialog Handling
//Minsc
PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_Minsc_63303e23-2eaa-a2e3-3ff8-dfda0d5a6fd8,_ID)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_DialogAddSpeakingActor(_ID, S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c)
AND
GetFlag(EPI_Epilogue_Minsc_PartneredWithNineFingers_HasMet_08d8bedf-d70c-6818-abda-2d39558a63b8, _Player, 0)
THEN
DB_SelectedDialog((DIALOGRESOURCE)EPI_Epilogue_Minsc_63303e23-2eaa-a2e3-3ff8-dfda0d5a6fd8, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, _Player, S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c);

//Astarion
PROC
PROC_DialogStarted(_Dialog, _ID) //Needs to be PROC as DB_DialogPlayers may not be populated in time
AND
DB_EPI_Epilogue_PresentNPC(_Char, _Dialog, _, _, _)
AND
_Char != S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805
AND
_Char != S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c
AND
_Char != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
GetFlag(ORI_State_PartneredWithAstarion_30819c8d-b39d-42e7-acd1-2a8c2c309994, _Player, 1)
AND
GetFlag(EPI_Epilogue_State_TalkedWithOthersNonAstarion_783b9156-005e-4726-a83c-9567b1f44edd, _Player, 0)
THEN
SetFlag(EPI_Epilogue_State_TalkedWithOthersNonAstarion_783b9156-005e-4726-a83c-9567b1f44edd, _Player);

IF
FlagSet((FLAG)EPI_Epilogue_Wyll_PlayerGrandDuke_4f8116cf-e08a-b0de-5669-036f5f08f3ac, _Player, _)
THEN
ObjectSetTitle(_Player, "EPI_Epilogue_DukeGrantedTitle");
//END_REGION

//REGION Party End
IF
FlagSet(EPI_Epilogue_State_AscendWithGodGale_1efb2c8d-498e-4978-b904-b5bc6fa695d2, _Player, _)
THEN
DB_EPI_Epilogue_QueuedClosingDialogs(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
FlagCleared(EPI_Epilogue_State_AscendWithGodGale_1efb2c8d-498e-4978-b904-b5bc6fa695d2, _Player, _)
AND
DB_EPI_Epilogue_QueuedClosingDialogs(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
NOT DB_EPI_Epilogue_QueuedClosingDialogs(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

PROC
PROC_DialogStarted((DIALOGRESOURCE)EPI_Epilogue_Withers_a778eace-f227-ac58-c231-75716eaba156, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_EPI_Epilogue_SetFinalToastSpeaker((CHARACTER)_Player);

PROC
PROC_EPI_Epilogue_SetFinalToastSpeaker((CHARACTER)_)
AND
DB_EPI_Epilogue_FinalToastSpeaker(_Player)
THEN
NOT DB_EPI_Epilogue_FinalToastSpeaker(_Player);

PROC
PROC_EPI_Epilogue_SetFinalToastSpeaker((CHARACTER)_Player)
THEN
DB_EPI_Epilogue_FinalToastSpeaker(_Player);

PROC
PROC_FlagReactionAfterDialog(_Player, EPI_Epilogue_State_EndEpilogue_72e1d047-ec76-4b10-b2f3-fb6929105059)
AND
GetUserCount(_Count)
AND
_Count > 1
THEN
ClearFlag((FLAG)EPI_Epilogue_State_EndEpilogue_72e1d047-ec76-4b10-b2f3-fb6929105059, _Player, 0);
ReadyCheckGlobal("EPI_ReadyCheck_FinalToast", "EPI_ReadyMessage_FinalToast", 1, (CHARACTER)_Player);

PROC
PROC_FlagReactionAfterDialog(_Player, EPI_Epilogue_State_EndEpilogue_72e1d047-ec76-4b10-b2f3-fb6929105059)
AND
GetUserCount(_Count)
AND
_Count <= 1
THEN
PROC_EPI_Epilogue_StartFinalToast();

IF
ReadyCheckPassed("EPI_ReadyCheck_FinalToast")
THEN
PROC_EPI_Epilogue_StartFinalToast();

PROC
PROC_EPI_Epilogue_StartFinalToast()
AND
IsOnStage(S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d, 1)
THEN
PROC_SetOnStage(S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d, 0);

PROC
PROC_EPI_Epilogue_StartFinalToast()
AND
DB_EPI_Epilogue_FinalToastSpeaker(_Player)
AND
QRY_StartDialogCustom(EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _Player, 0, 0, 0, 0)
THEN
DB_EPI_Epilogue_FinalToastPartyDialogStarted(1);

PROC
PROC_EPI_Epilogue_StartFinalToast()
AND
NOT DB_EPI_Epilogue_FinalToastPartyDialogStarted(1)
THEN
PROC_EPI_Epilogue_StartClosingSequence();

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771,_ID)
AND
DB_EPI_Epilogue_FinalToastSpeaker(_Player)
THEN
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog(EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771, _ID, _Player);

IF
DialogEnded(EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771,_ID)
THEN
PROC_EPI_Epilogue_StartClosingSequence();

PROC
PROC_EPI_Epilogue_StartClosingSequence()
AND
IsOnStage(S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d, 1)
THEN
PROC_SetOnStage(S_GLO_Gale_DeathVoice_736c736b-34d8-4dc6-98ac-3f78378ad06d, 0);

PROC
PROC_EPI_Epilogue_StartClosingSequence()
AND
DB_OnlyOnce("EPI_Epilogue_SelectedClosingDialog")
THEN
NOT DB_OnlyOnce("EPI_Epilogue_SelectedClosingDialog");

PROC
PROC_EPI_Epilogue_StartClosingSequence()
AND
QRY_EPI_Epilogue_AnyClosingDialogAvailable()
THEN
PROC_EPI_Epilogue_SelectClosingDialog();

PROC
PROC_EPI_Epilogue_SelectClosingDialog()
AND
DB_EPI_Epilogue_ClosingDialogs(_Dialog)
AND
DB_EPI_Epilogue_QueuedClosingDialogs(_Dialog, _Speaker)
AND
NOT DB_OnlyOnce("EPI_Epilogue_SelectedClosingDialog")
THEN
DB_OnlyOnce("EPI_Epilogue_SelectedClosingDialog");
DB_EPI_Epilogue_SelectedClosingDialog(_Dialog, _Speaker);
NOT DB_EPI_Epilogue_QueuedClosingDialogs(_Dialog, _Speaker);
PROC_EPI_Epilogue_ReadyClosingSpeakers();

PROC
PROC_EPI_Epilogue_ReadyClosingSpeakers()
AND
NOT QRY_EPI_Epilogue_ClosingCharactersWaitingForSetup() //TODO: Handling for if there is a wait
AND
DB_EPI_Epilogue_SelectedClosingDialog(_Dialog, _Speaker)
THEN
NOT DB_EPI_Epilogue_SelectedClosingDialog(_Dialog, _Speaker);
PROC_EPI_Epilogue_StartClosingDialog((DIALOGRESOURCE)_Dialog,(CHARACTER)_Speaker);

//TODO: Add checks
QRY
QRY_EPI_Epilogue_ClosingCharactersWaitingForSetup()
AND
DB_EPI_Epilogue_SelectedClosingDialog(_, _Speaker)
AND
IsOnStage(_Speaker, 0)
THEN
PROC_SetOnStage(_Speaker, 1);

IF
WentOnStage(_Speaker, 1)
AND
DB_EPI_Epilogue_SelectedClosingDialog(_,(CHARACTER)_Speaker)
THEN
PROC_EPI_Epilogue_ReadyClosingSpeakers();

PROC
PROC_EPI_Epilogue_SelectClosingDialog()
AND
NOT DB_EPI_Epilogue_QueuedClosingDialogs(_, _)
AND
NOT DB_OnlyOnce("EPI_Epilogue_SelectedClosingDialog")
THEN
PROC_EPI_Epilogue_StartClosingSequence();

PROC
PROC_EPI_Epilogue_StartClosingDialog((DIALOGRESOURCE)_Dialog,(CHARACTER)_Speaker)
THEN
DB_EPI_Epilogue_ActiveEpilogueDialogAndSpeaker(_Dialog, _Speaker);

IF
DialogStarted(_Dialog, _)
AND
DB_EPI_Epilogue_ActiveEpilogueDialogAndSpeaker(_Dialog, _Speaker)
THEN
NOT DB_EPI_Epilogue_ActiveEpilogueDialogAndSpeaker(_Dialog, _Speaker);

PROC
PROC_EPI_Epilogue_StartClosingDialog((DIALOGRESOURCE)EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5,(CHARACTER)_Speaker)
AND
DB_Avatars(_Avatar)
AND
GetFlag(EPI_Epilogue_State_AscendWithGodGale_1efb2c8d-498e-4978-b904-b5bc6fa695d2, _Avatar, 1)
AND
NOT QRY_StartDialogCustom(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5, _Speaker, _Avatar, 0, 0, 0, 0)
THEN
PROC_EPI_Epilogue_StartClosingSequence();

PROC
PROC_EPI_Epilogue_StartClosingDialog((DIALOGRESOURCE)EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887,(CHARACTER)_Speaker)
AND
NOT QRY_StartDialogCustom(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887, _Speaker, 0, 0, 0, 0)
THEN
PROC_EPI_Epilogue_StartClosingSequence();

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5,_ID)
AND
DB_Avatars(_Player)
AND
GetFlag(EPI_Epilogue_State_AscendWithGodGale_1efb2c8d-498e-4978-b904-b5bc6fa695d2, _Player, 1)
AND
IsTagged(_Player, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
THEN
Transform(S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, _Player, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
PROC_SetArmourSet(S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, ARMOURSET.Vanity);
ToInventory(S_EPI_PlayerGodClothing_b8f72c54-f0ab-48d3-9507-66cb2b4b44af, S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, 1, 0, 1);
PROC_DialogAddSpeakingActor(_ID, S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f);

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5,_ID)
AND
DB_Avatars(_Player)
AND
GetFlag(EPI_Epilogue_State_AscendWithGodGale_1efb2c8d-498e-4978-b904-b5bc6fa695d2, _Player, 1)
AND
IsTagged(_Player, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
THEN
Transform(S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, S_EPI_MindFlayerGodPlayer_f8313336-c142-4a1b-ae9b-50428736d29b, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
PROC_DialogAddSpeakingActor(_ID, S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f);

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5,_ID)
AND
DB_GlobalFlag(GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
PROC_DialogAddSpeakingActor(_ID, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

IF
AddedTo(S_EPI_PlayerGodClothing_b8f72c54-f0ab-48d3-9507-66cb2b4b44af, S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, _)
THEN
Equip(S_EPI_PlayerAscensionBodyDouble_8a9038e8-16cd-4adc-bd49-08724368b05f, (ITEM)S_EPI_PlayerGodClothing_b8f72c54-f0ab-48d3-9507-66cb2b4b44af);

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887,_ID)
AND
DB_EPI_Epilogue_SetCharacters(_Char)
AND
GetFlag(ORI_DarkUrge_State_WasPartneredGoneMad_fb3ab877-e2c3-4887-8e27-7050dc1b5171, _Char, 1)
THEN
PROC_DialogAddSpeakingActorAt(_ID, _Char, 11);

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887,_ID)
AND
DB_ORI_DarkUrge(_DarkUrge)
THEN
RemoveStatus(S_CampSetup_LTS_GEN_Torch_A_003_3d2f1ea1-210c-4f99-aa02-a4e7869baadb,"BURNING",NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_CampSetup_LTS_GEN_Torch_A_009_72c7fb38-7a63-4195-8c2f-753aaf964cbd,"BURNING",NULL_00000000-0000-0000-0000-000000000000);
PROC_SetArmourSet(_DarkUrge, ARMOURSET.Vanity);
ToInventory(S_EPI_DarkUrgeRags_2e0bf0cc-66d5-424b-8a7d-3c95735ac344,_DarkUrge, 1, 0, 1);
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887, _ID, _DarkUrge);

IF
AddedTo(S_EPI_DarkUrgeRags_2e0bf0cc-66d5-424b-8a7d-3c95735ac344, _DarkUrge, _)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
Equip(_DarkUrge, (ITEM)S_EPI_DarkUrgeRags_2e0bf0cc-66d5-424b-8a7d-3c95735ac344);

IF
DialogEnded(_Dialog, _ID)
AND
DB_EPI_Epilogue_ClosingDialogs(_Dialog)
THEN
PROC_EPI_Epilogue_StartClosingSequence();

PROC
PROC_EPI_Epilogue_StartClosingSequence()
AND
NOT QRY_EPI_Epilogue_AnyClosingDialogAvailable()
AND
NOT DB_OnlyOnce("EPI_Epilogue_SelectedClosingDialog")
THEN
PROC_EPI_Epilogue_StartCredits();

//So we don't have any dead characters for after credit scenes
PROC
PROC_EPI_Epilogue_StartCredits()
AND
DB_Avatars(_Player)
THEN
RemoveStatusesWithType(_Player, "DOWNED", _Player);
PROC_CharacterFullRestore(_Player);

PROC
PROC_EPI_Epilogue_StartCredits()
THEN
PROC_END_GodsAndMonsters_RollCredits("END_GodsAndMonsters_GameFinished");

QRY
QRY_EPI_Epilogue_AnyClosingDialogAvailable()
AND
DB_EPI_Epilogue_QueuedClosingDialogs(_, _)
THEN
DB_NOOP(1);

//REGION ViolentClosure
PROC
PROC_SceneInterrupted(_Victim,_Player,"EPI_Epilogue_ViolentClosureScene",_ViolentReason)
AND
DB_PartyMembers(_Player)
AND
NOT DB_PartyMembers((CHARACTER)_Victim)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_ViolentReason)
AND
QRY_EPI_Epilogue_ReachedHostileThreshold((CHARACTER)_Victim)
THEN
PROC_EPI_Epilogue_GetViolentInterruptOwner((CHARACTER)_Victim,(CHARACTER)_Player);
PROC_SceneOver("EPI_Epilogue_ViolentClosureScene");

PROC
PROC_EPI_Epilogue_GetViolentInterruptOwner((CHARACTER)_Victim,(CHARACTER)_Char)
AND
DB_PlayerSummons(_Char)
AND
CharacterGetOwner(_Char,_Owner)
THEN
PROC_EPI_Epilogue_ViolenceReaction((CHARACTER)_Victim,(CHARACTER)_Owner);

PROC
PROC_EPI_Epilogue_GetViolentInterruptOwner((CHARACTER)_Victim,(CHARACTER)_Char)
AND
NOT DB_PlayerSummons(_Char)
THEN
PROC_EPI_Epilogue_ViolenceReaction((CHARACTER)_Victim,(CHARACTER)_Char);

PROC
PROC_EPI_Epilogue_ViolenceReaction((CHARACTER)_,(CHARACTER)_)
AND
DB_EPI_Epilogue_SetCharacters(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa)
AND
NOT DB_PermaDefeated(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa)
AND
NOT DB_EPI_Epilogue_Fleeing(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa)
THEN
DB_EPI_Epilogue_Fleeing(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa);
PROC_NotifyWhenReadyToMoveOn(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa, "EPI_Epilogue_ReadyToFlee");

PROC
PROC_EPI_Epilogue_ViolenceReaction((CHARACTER)_,(CHARACTER)_)
AND
DB_EPI_Epilogue_SetCharacters(S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c)
AND
NOT DB_PermaDefeated(S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c)
AND
NOT DB_EPI_Epilogue_Fleeing(S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c)
THEN
DB_EPI_Epilogue_Fleeing(S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c);
PROC_NotifyWhenReadyToMoveOn(S_EPI_TerrifiedThief_85d6a92c-dc66-4f26-b6b7-1feb8301fa4c, "EPI_Epilogue_ReadyToFlee");

PROC
PROC_ReadyToMoveOn(_Char, "EPI_Epilogue_ReadyToFlee")
AND
DB_EPI_Epilogue_Fleeing(_Char)
THEN
PROC_DisappearOutOfSight(_Char, "Sprint", 0, "");

QRY
QRY_EPI_Epilogue_ReachedHostileThreshold((CHARACTER)_Char)
AND
GetHitpointsPercentage(_Char, _Percentage)
AND
_Percentage <= 45.0
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_ReachedHostileThreshold((CHARACTER)_Char)
AND
DB_Defeated(_Char)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_ViolenceReaction((CHARACTER)_,(CHARACTER)_Player)
AND
DB_EPI_Epilogue_ViolentSceneCharacters(_Char)
AND
DB_EPI_Epilogue_SetCharacters(_Char)
AND
NOT DB_EPI_Epilogue_Fleeing(_Char)
AND
NOT DB_ORI_Partnered(_Player, _Char)
AND
GetFaction(_Char, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 0);

PROC
PROC_EPI_Epilogue_ViolenceReaction((CHARACTER)_Victim,(CHARACTER)_Player)
AND
DB_EPI_Epilogue_SetCharacters(_Char)
AND
DB_ORI_Partnered(_Player, (CHARACTER)_Char)
AND
_Char != _Victim
AND
GetFaction(_Char, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 100);

PROC
PROC_EPI_Epilogue_ViolenceReaction((CHARACTER)_Victim,(CHARACTER)_Player)
AND
DB_ORI_Partnered(_Player, _Victim)
AND
GetFaction(_Victim, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 0);

IF
RelationChanged(_EpilogueFaction, _AvatarFaction, 0, _)
AND
DB_EPI_Epilogue_CharacterFaction(_, _EpilogueFaction)
AND
DB_AvatarFactions(_AvatarFaction)
AND
NOT DB_GlobalFlag(EPI_Epilogue_State_AvatarStartedCombat_d7553916-b89e-48ba-83d0-985e1ee3192b)
THEN
PROC_GlobalSetFlagAndCache(EPI_Epilogue_State_AvatarStartedCombat_d7553916-b89e-48ba-83d0-985e1ee3192b);

IF
RelationChanged(_EpilogueFaction, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, _)
AND
DB_EPI_Epilogue_CharacterFaction(_, _EpilogueFaction)
AND
NOT DB_GlobalFlag(EPI_Epilogue_State_AvatarStartedCombat_d7553916-b89e-48ba-83d0-985e1ee3192b)
THEN
PROC_GlobalSetFlagAndCache(EPI_Epilogue_State_AvatarStartedCombat_d7553916-b89e-48ba-83d0-985e1ee3192b);

IF
CombatStarted(_ID)
AND
DB_GlobalFlag(EPI_Epilogue_State_AvatarStartedCombat_d7553916-b89e-48ba-83d0-985e1ee3192b)
AND
NOT DB_EPI_Epilogue_CombatID(_ID)
THEN
DB_EPI_Epilogue_CombatID(_ID);

IF
CombatRoundStarted(_ID, _Round)
AND
DB_EPI_Epilogue_CombatID(_ID)
AND
_Round >= 2
THEN
SetFlag(EPI_Epilogue_Event_WithersInterruptedCombat_6e167b63-d17f-4c4b-8463-47a09b67ee34);
PROC_EPI_Epilogue_TryStartViolentClosureDialog();

IF
DownedChanged(_DownedChar,1)
AND
NOT DB_Avatars(_DownedChar)
AND
DB_EPI_Epilogue_SetCharacters(_DownedChar)
THEN
PROC_EPI_Epilogue_TryStartViolentClosureDialog();

IF
KilledBy((CHARACTER)_Char, _, _, _) 
AND
NOT DB_Avatars(_Char)
AND
DB_EPI_Epilogue_SetCharacters(_Char)
THEN
PROC_EPI_Epilogue_TryStartViolentClosureDialog();

PROC
PROC_EPI_Epilogue_TryStartViolentClosureDialog()
AND
QRY_OnlyOnce("EPI_Epilogue_StartViolentClosureOnce")
THEN
PROC_EPI_Epilogue_StartViolentClosureDialog();

IF
FlagSet(EPI_Epilogue_State_AvatarStartedCombat_d7553916-b89e-48ba-83d0-985e1ee3192b, _, _)
THEN
DB_SpotPlayers(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "EPI_ViolentClosureSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "EPI_ViolentClosureSpotting", _Player)
THEN
PROC_EPI_Epilogue_TryStartViolentClosureDialog();

PROC
PROC_EPI_Epilogue_StartViolentClosureDialog()
THEN
PROC_SpotPlayers_StopSpotting("EPI_ViolentClosureSpotting");

//Cancle DU & God Gale scene if party ended with combat
PROC
PROC_EPI_Epilogue_StartViolentClosureDialog()
AND
DB_EPI_Epilogue_QueuedClosingDialogs(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887, _Player)
THEN
NOT DB_EPI_Epilogue_QueuedClosingDialogs(EPI_Epilogue_MadDarkUrge_e927d5bd-61d9-e9f3-f1df-7a3e2e481887, _Player);

PROC
PROC_EPI_Epilogue_StartViolentClosureDialog()
AND
DB_EPI_Epilogue_QueuedClosingDialogs(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
NOT DB_EPI_Epilogue_QueuedClosingDialogs(EPI_Epilogue_GodGaleAscension_02facfbb-3e44-8f5a-296b-ae3e869e37f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

QRY
QRY_EPI_GetNearestAvatarToWithers()
AND
DB_EPI_Epilogue_PresentAvatar(_Avatar)
AND
NOT DB_CantTalk_IgnoreStatusesCombat(_Avatar)
AND
GetDistanceTo(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _Avatar, _Dist)
THEN
DB_QRYRTN_EPI_NearestAvatarToWithers(_Avatar, _Dist);

IF
DB_QRYRTN_EPI_NearestAvatarToWithers(_AvatarA, _DistA)
AND
DB_QRYRTN_EPI_NearestAvatarToWithers(_AvatarB, _DistB)
AND
_AvatarA != _AvatarB
AND
_DistA <= _DistB
THEN
NOT DB_QRYRTN_EPI_NearestAvatarToWithers(_AvatarB, _DistB);

PROC
PROC_EPI_Epilogue_StartViolentClosureDialog()
AND
DB_EPI_Epilogue_CombatID(_ID)
THEN
EndCombat(_ID);

PROC
PROC_EPI_Epilogue_StartViolentClosureDialog()
AND
DB_EPI_Epilogue_CharacterFaction(_Char, _Faction)
AND
DB_EPI_Epilogue_SetCharacters(_Char)
THEN
PROC_SetRelationToPlayers((FACTION)_Faction, 50);
PROC_SetRelationToPlayers_ClearHostileToPlayerGroup((FACTION)_Faction);

IF
CombatEnded(_ID)
AND
DB_EPI_Epilogue_CombatID(_ID)
THEN
PROC_EPI_Epilogue_TryStartViolentClosureDialog();

PROC
PROC_EPI_Epilogue_StartViolentClosureDialog()
THEN
PROC_ClearStoryMove(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);

PROC
PROC_EPI_Epilogue_StartViolentClosureDialog()
AND
QRY_EPI_GetNearestAvatarToWithers()
AND
DB_QRYRTN_EPI_NearestAvatarToWithers(_Avatar, _)
AND
NOT DB_EPI_Epilogue_StartedViolentClosureDialog(1)
AND
QRY_StartDialogCustom(EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _Avatar, 0, 0, 0, 0)
THEN
DB_EPI_Epilogue_StartedViolentClosureDialog(1);

PROC
PROC_EPI_Epilogue_StartViolentClosureDialog()
AND
NOT DB_EPI_Epilogue_StartedViolentClosureDialog(1)
THEN
PROC_EPI_Epilogue_StartClosingSequence();

IF
DialogEnded(EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045, _)
THEN
PROC_EPI_Epilogue_StartClosingSequence();

PROC
PROC_StartDialog_AddExtraSpeakers(EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045,_ID)
AND
DB_QRYRTN_EPI_NearestAvatarToWithers(_Player, _)
THEN
PROC_EPI_Epilogue_AddAllNPCsAndAvatarsToDialog(EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045, _ID, _Player);
//END_REGION 

//Trigger a game over if all living available avatars are killed
IF
DB_Defeated(_Player)
AND
DB_Avatars((CHARACTER)_Player)
AND
DB_GlobalFlag(EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e)
AND
QRY_EPI_Epilogue_AnyNonCombatAvatars() //No need for this handling if there are no locked/ghost avatars
AND
NOT QRY_EPI_Epilogue_AnyLivingAvailableAvatars()
THEN
DB_EPI_Epilogue_GameOverActive(1);
MusicPlayGeneral("Music_Game_Over");
ShowGameOverMenu();

//To handle players making a save file during a game over menu
IF
LevelLoaded("EPI_MAIN_A")
AND
DB_EPI_Epilogue_GameOverActive(1)
THEN
RealtimeObjectTimerLaunch(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "EPI_Epilogue_GameOverUI", 1000); //Needs delay, otherwise menu will fail to load

IF
ObjectTimerFinished(_, "EPI_Epilogue_GameOverUI")
THEN
MusicPlayGeneral("Music_Game_Over");
ShowGameOverMenu();

QRY
QRY_EPI_Epilogue_AnyNonCombatAvatars()
AND
DB_EPI_Epilogue_GhostAvatar(_Player)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_AnyNonCombatAvatars()
AND
DB_EPI_Epilogue_LockedAvatar(_Player)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_AnyLivingAvailableAvatars()
AND
DB_Avatars(_Player)
AND
QRY_EPI_Epilogue_AvatarIsPresentAtParty(_Player)
AND
NOT DB_Defeated(_Player)
THEN
DB_NOOP(1);
//END_REGION

//REGION Misc

IF
DB_EPI_Epilogue_PresentNPC(_Character, _Dialog, _, _, _)
THEN
DB_DialogBlockTradeButton(_Dialog);

IF
DB_EPI_Epilogue_OpeningDialogs(_Dialog)
THEN
DB_DialogBlockTradeButton((DIALOGRESOURCE)_Dialog);
DB_DialogBlockAttackButton((DIALOGRESOURCE)_Dialog);

IF
DB_EPI_Epilogue_ClosingDialogs(_Dialog)
THEN
DB_DialogBlockTradeButton((DIALOGRESOURCE)_Dialog);
DB_DialogBlockAttackButton((DIALOGRESOURCE)_Dialog);

QRY
QRY_CAMP_VanityArmour_BlockChangeForCharacterDuringFight(_)
THEN
DB_NOOP(1);


//END_REGION

//REGION Journal Cleanup
IF
FlagSet((FLAG)EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e, _, _)
THEN
PROC_EPI_Epilogue_CloseOutstandingQuests();

PROC
PROC_EPI_Epilogue_CloseOutstandingQuests()
AND
DB_QuestDef_LevelLoaded(_QuestTitle, _QuestUpdate, "END_Main")
AND
DB_QuestIsOpened(_QuestTitle)
THEN
QuestUpdate(_QuestTitle, _QuestUpdate);

PROC
PROC_EPI_Epilogue_CloseOutstandingQuests()
AND
DB_QuestIsOpened("GLO_RaphaelDeal")
AND
NOT DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
QuestUpdate("GLO_RaphaelDeal", "ReachedEpilogue");

PROC
PROC_EPI_Epilogue_CloseOutstandingQuests()
AND
DB_QuestIsOpened("GLO_RaphaelDeal")
AND
DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
QRY_EPI_Epilogue_RaphaelDeniedCrown()
THEN
QuestUpdate("GLO_RaphaelDeal", "DeniedCrown_Fulfill");
QuestUpdate("GLO_RaphaelDeal", "DeniedCrown");

PROC
PROC_EPI_Epilogue_CloseOutstandingQuests()
AND
DB_QuestIsOpened("GLO_RaphaelDeal")
AND
DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
NOT QRY_EPI_Epilogue_RaphaelDeniedCrown()
THEN
QuestUpdate("GLO_RaphaelDeal", "GaveCrown_Fulfill");
QuestUpdate("GLO_RaphaelDeal", "GaveCrown");

QRY
QRY_EPI_Epilogue_RaphaelDeniedCrown()
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_RaphaelDeniedCrown()
AND
DB_GlobalFlag((FLAG)ORI_Gale_Event_GaveCrownToMystra_3375fd8b-4958-421d-2d51-ff9af5beaaa0)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_RaphaelDeniedCrown()
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_ChallengedMystra_d6dfa722-f85e-e191-a7e0-776d19c9f18a)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_CloseOutstandingQuests()
AND
DB_QuestIsOpened("ORI_COM_Wyll")
THEN
PROC_EPI_Epilogue_CloseWyllQuest();

PROC
PROC_EPI_Epilogue_CloseWyllQuest()
AND
DB_GlobalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd)
AND
QRY_EPI_Epilogue_RavenguardDeathState(0)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_CloseWyllQuest()
AND
DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227)
AND
QRY_EPI_Epilogue_RavenguardDeathState(1)
THEN
DB_NOOP(1);

PROC
PROC_EPI_Epilogue_CloseWyllQuest()
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227)
AND
QRY_EPI_Epilogue_RavenguardDeathState(2)
THEN
DB_NOOP(1);

QRY
QRY_EPI_Epilogue_RavenguardDeathState(0)
AND
IsDead((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
THEN
QuestUpdate("ORI_COM_Wyll", "RavengardWyllGrandDuke");

QRY
QRY_EPI_Epilogue_RavenguardDeathState(0)
AND
IsDead((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 0)
THEN
QuestUpdate("ORI_COM_Wyll", "WyllGrandDuke");

QRY
QRY_EPI_Epilogue_RavenguardDeathState(1)
AND
IsDead((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
THEN
QuestUpdate("ORI_COM_Wyll", "RavengardWyllAvernus");

QRY
QRY_EPI_Epilogue_RavenguardDeathState(1)
AND
IsDead((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 0)
THEN
QuestUpdate("ORI_COM_Wyll", "WyllAvernus");

QRY
QRY_EPI_Epilogue_RavenguardDeathState(2)
AND
IsDead((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
THEN
QuestUpdate("ORI_COM_Wyll", "RavengardWyllFrontiers");

QRY
QRY_EPI_Epilogue_RavenguardDeathState(2)
AND
IsDead((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 0)
THEN
QuestUpdate("ORI_COM_Wyll", "WyllFrontiers");

PROC
PROC_EPI_Epilogue_CloseOutstandingQuests()
AND
DB_QuestIsOpened(_QuestTitle)
AND
_QuestTitle != "EPI_EnjoyParty"
THEN
QuestClose(_QuestTitle);
//END_REGION

//REGION Dialog vanity swap

PROC
PROC_StartDialog_ChangeClothing((DIALOGRESOURCE)_Dialog,(INTEGER)_DialogInstance)
AND
DialogIsAutomated(_Dialog, 0)
AND
DB_DialogRequestCache_SpeakerList_Players(_Dialog,_DialogInstance,_Player,_)
AND
NOT DB_Camp_TempVanityArmour((CHARACTER)_Player,_)
AND
NOT DB_EPI_Epilogue_IgnoredPartyGear(_Player)
AND
QRY_GetArmourSet((CHARACTER)_Player)
AND
DB_QRYRTN_GetArmourSet(ARMOURSET.Normal)
THEN
PROC_SetArmourSet((CHARACTER)_Player,ARMOURSET.Vanity);
DB_Camp_TempVanityArmour((CHARACTER)_Player,_DialogInstance);

//END_REGION

//REGION

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
IsTagged(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TAG)FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
THEN
DB_EPI_Epilogue_TitleSet(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
ObjectSetTitle(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "EPI_Title_KarlachMF");

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_GlobalFlag(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_GlobalFlag((FLAG)END_General_State_OrpheusPermaDefeated_9255d9c6-39b2-4436-bd03-c08d99526257)
THEN
DB_EPI_Epilogue_TitleSet(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
ObjectSetTitle(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "EPI_Title_LaezelOrpheusDead");

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_GlobalFlag(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_GlobalFlag((FLAG)END_General_State_OrpheusPermaDefeated_9255d9c6-39b2-4436-bd03-c08d99526257)
THEN
DB_EPI_Epilogue_TitleSet(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
ObjectSetTitle(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "EPI_Title_LaezelOrpheusAlive");

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_Character)
AND
NOT DB_EPI_Epilogue_TitleSet(_Character)
AND
DB_EPI_Title_FlaggedTitles(_Character, _Title, _Flag, 0)
AND
GetFlag(_Flag, _Character, 1)
THEN
DB_EPI_Epilogue_TitleSet(_Character);
ObjectSetTitle(_Character, _Title);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_Character)
AND
NOT DB_EPI_Epilogue_TitleSet(_Character)
AND
DB_EPI_Title_FlaggedTitles(_Character, _Title, _Flag, 1)
AND
DB_GlobalFlag(_Flag)
THEN
DB_EPI_Epilogue_TitleSet(_Character);
ObjectSetTitle(_Character, _Title);

PROC
PROC_EPI_Epilogue_AdditionalSetupCharacter((CHARACTER)_Character)
AND
NOT DB_EPI_Epilogue_TitleSet(_Character)
AND
DB_EPI_Title_Default(_Character, _Title)
THEN
DB_EPI_Epilogue_TitleSet(_Character);
ObjectSetTitle(_Character, _Title);

IF
FlagSet((FLAG)EPI_Epilogue_DivineBard_AskedTrueIdentity_041a5fd0-52dd-c808-afcf-705a7747ab2e, _, _)
THEN
ObjectSetTitle(S_EPI_DivineBard_4a0c8230-f2f0-4bf0-89bc-b16989ea824c, "EPI_Title_DivineBardKnown");

//END_REGION

//REGION Remove ! marks

PROC
PROC_StartLoopEffectsForRegion("EPI_Main_A")
AND
DB_EPI_Epilogue_PresentNPC(_Character, _, _, _, _)
THEN
PROC_EPI_ExclamationMark_Hide(_Character, "GLO_Camp_RequiredTalk");
PROC_EPI_ExclamationMark_Hide(_Character, "RelationshipMarker");

//HIDE EXCLAMATION MARK
//Use RelationshipMarker as identifier unless otherwise specified
PROC
PROC_EPI_ExclamationMark_Hide((GUIDSTRING)_Character)
AND
DB_LoopEffect(_Character,_,"RelationshipMarker",_,VFX_UI_ExclamationMark_01_a3018cf0-3a25-06ee-206a-3dd079332d80,_,_)
THEN
PROC_EPI_ExclamationMark_Hide((GUIDSTRING)_Character,"RelationshipMarker");

PROC
PROC_EPI_ExclamationMark_Hide((GUIDSTRING)_Character,(STRING)_Identifier)
THEN
PROC_StopLoopEffect(_Character,_Identifier);

PROC
PROC_EPI_ExclamationMark_Hide((GUIDSTRING)_Character,(STRING)_)
AND
NOT DB_LoopEffect(_Character,_,_,_,VFX_UI_ExclamationMark_01_a3018cf0-3a25-06ee-206a-3dd079332d80,_,_)
AND
IsTagged(_Character,HAS_EXCLAMATION_DIALOG_e45ea222-a86f-4e00-a1ca-98d8b258b1ce,1)
THEN
ClearTag(_Character,HAS_EXCLAMATION_DIALOG_e45ea222-a86f-4e00-a1ca-98d8b258b1ce);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3c_EPI"
