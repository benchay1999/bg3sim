Version 1
SubGoalCombiner SGC_AND
INITSECTION
NOT DB_FOR_CourierDog_IsFetching((CHARACTER)NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)NULL_00000000-0000-0000-0000-000000000000); // Only here to get rid of these DBs
NOT DB_DEN_Apprentice_ImportantItems((ITEM)NULL_00000000-0000-0000-0000-000000000000);
KBSECTION
//REGION GUS-298316
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
NOT DB_DEN_DruidAttack_IdolCrimes("MoveForbiddenItem", "DEN_DruidAttack_FallbackIdolCrime",GEB_DEN_DruidAttack_AD_NoticedIdolTampered_1eff316c-1568-f1ca-48a7-2e7962830553)
THEN
DB_DEN_DruidAttack_IdolCrimes("MoveForbiddenItem", "DEN_DruidAttack_FallbackIdolCrime",GEB_DEN_DruidAttack_AD_NoticedIdolTampered_1eff316c-1568-f1ca-48a7-2e7962830553);
DB_BUGFIX_Marker("GUS-298316");
//END_REGION

//REGION GUS-314113/GUSX-7301

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_InCamp(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_DarkUrge_MurderOfAlfira_b0e97b06-b2f8-4376-829f-23d4b4bcf78d)
AND
DB_GlobalFlag(CAMP_DarkUrge_Event_RecruitAlfira_a61d6b2a-73a1-3f12-60b0-a5e3025cbeac)
THEN
SetFlag((FLAG)CAMP_DarkUrge_Event_AlfiraJoined_3a8bfe66-3b29-97af-c941-9ba4bfd1d0d2);

//END_REGION

//REGION GUSX-7301

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "WLD_Main_A", "GUSX-7301");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-7301")
AND
NOT DB_GLO_CompoundFlag((FLAG)CAMP_DarkUrge_Event_AlfiraJoined_3a8bfe66-3b29-97af-c941-9ba4bfd1d0d2, (FLAG)CAMP_DarkUrge_Event_RecruitAlfira_a61d6b2a-73a1-3f12-60b0-a5e3025cbeac)
THEN
DB_GLO_CompoundFlag((FLAG)CAMP_DarkUrge_Event_AlfiraJoined_3a8bfe66-3b29-97af-c941-9ba4bfd1d0d2, (FLAG)CAMP_DarkUrge_Event_RecruitAlfira_a61d6b2a-73a1-3f12-60b0-a5e3025cbeac);
DB_BUGFIX_Marker("GUSX-7301");

//END_REGION

//REGION GUS-304797
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_ActiveLevel("WLD_Main_A")
AND
HasActiveStatus(S_UND_KethericCity_AdamantineGolem_2a5997fc-5f2a-4a13-b309-bed16da3b255, "UND_ADAMANTINEGOLEM_SUPERHEATED", 1)
THEN
DB_UND_AdamantineForge_ConstructSuperheated(1);
DB_BUGFIX_Marker("GUS-304797");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_ActiveLevel("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-304797-2");

IF
DB_ActiveLevel("WLD_Main_A")
AND
DB_BUGFIX_Marker("GUS-304797-2")
AND
HasActiveStatus(S_UND_KethericCity_AdamantineGolem_2a5997fc-5f2a-4a13-b309-bed16da3b255, "UND_ADAMANTINEGOLEM_SUPERHEATED", 1)
THEN
NOT DB_BUGFIX_Marker("GUS-304797-2");
DB_UND_AdamantineForge_ConstructSuperheated(1);
DB_BUGFIX_Marker("GUS-304797-3");

IF
DB_ActiveLevel("WLD_Main_A")
AND
DB_BUGFIX_Marker("GUS-304797-2")
AND
HasActiveStatus(S_UND_KethericCity_AdamantineGolem_2a5997fc-5f2a-4a13-b309-bed16da3b255, "UND_ADAMANTINEGOLEM_SUPERHEATED", 0)
THEN
NOT DB_BUGFIX_Marker("GUS-304797-2");
DB_BUGFIX_Marker("GUS-304797-4");

//END_REGION

//REGION GUS-304127 Rewrite Goblin Hunt Celebration Romance System
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
THEN
DB_CampNight_AvatarDream((FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121,(DIALOGRESOURCE)CAMP_GoblinHuntCelebration_SD_SelectNight_750df06d-5a74-8f6b-cd1f-947055afbc2e);
DB_CampNight_AvatarDream((FLAG)NIGHT_GoblinHunt_RaiderCelebration_86fee25f-1069-4f17-89fa-4c5b69f82e0b,(DIALOGRESOURCE)CAMP_GoblinHuntCelebration_SD_SelectNight_750df06d-5a74-8f6b-cd1f-947055afbc2e);
SysClear("DB_CAMP_GoblinHuntCelebration_SelfReflectionFlags",1);
SysClear("DB_CAMP_GoblinHuntCelebration_PotentialRomanceFlag",2);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_CampNight_SoloDream(_Flag,_Player, (DIALOGRESOURCE)CAMP_GoblinHuntCelebration_SD_SelectNight_750df06d-5a74-8f6b-cd1f-947055afbc2e)
THEN
DB_BUGFIX_Marker("GUS-304127 Goblin Hunt Celebration Romance - Removed Solodream");
NOT DB_CampNight_SoloDream(_Flag,_Player, (DIALOGRESOURCE)CAMP_GoblinHuntCelebration_SD_SelectNight_750df06d-5a74-8f6b-cd1f-947055afbc2e);
DB_Camp_QueuedSoloDream((CHARACTER)_Player, (DIALOGRESOURCE)CAMP_GoblinHuntCelebration_SD_SelectNight_750df06d-5a74-8f6b-cd1f-947055afbc2e);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_Camp_QueuedNight((FLAG)NIGHT_GoblinHunt_RaiderCelebration_86fee25f-1069-4f17-89fa-4c5b69f82e0b)
AND
DB_Avatars(_Avatar)
AND
GetFlag(CAMP_GoblinHunt_State_DrowPartner_d60f30bb-0fca-54ec-1028-860021d6de55, _Avatar, 1)
THEN
DB_BUGFIX_Marker("GUS-304127 Goblin Hunt Celebration Romance - Set SkipMintharaFallback");
DB_GoblinHuntCelebration_SkipMintharaFallback(1);
//END_REGION

//REGION GUS-298431
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
DB_DialogMoneyTransfer(1, DEN_AdventurersQuest_LeaderAtCorpses_753a0b1e-b28d-e00a-f77f-340cca458dc0, 5000);
DB_DialogMoneyTransfer(1, DEN_AdventurerLeader_46fea64f-e098-2df5-f4ee-825080ef9728, 5000);
NOT DB_DialogMoneyTransfer(1, DEN_AdventurersQuest_LeaderAtCorpses_753a0b1e-b28d-e00a-f77f-340cca458dc0, 10000);
NOT DB_DialogMoneyTransfer(1, DEN_AdventurerLeader_46fea64f-e098-2df5-f4ee-825080ef9728, 10000);
DB_BUGFIX_Marker("GUS-298431");
//END_REGION

//REGION GUS-295245
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
NOT DB_SceneManager(S_GOB_NerdyGoblinSage_5f5c8416-8118-4619-8fc9-442304ff0a3d,"GOB_NerdyGoblinSage_Scene")
THEN
DB_SceneManager(S_GOB_NerdyGoblinSage_5f5c8416-8118-4619-8fc9-442304ff0a3d,"GOB_NerdyGoblinSage_Scene");
DB_BUGFIX_Marker("GUS-295245");
//END_REGION


//REGION GUS-271931

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
NOT QRY_AnyPlayerInTrigger((TRIGGER)S_GOB_SpiderNest_EventTrigger_764aa320-8fd2-40f2-b6c5-fa3b82fa79ef)
THEN
PROC_SetRelationMutual((FACTION)ACT1_GOB_SpiderNest_Spiders_153d18a3-3fc5-9b92-0039-04f8953f68a9, (FACTION)ACT1_GOB_Goblins_General_633245e8-cbb8-b0c4-12ec-32d2ff9424e2, 100);

//END_REGION

//REGION GUS-298065

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_GlobalFlag(GLO_AttackOnDen_State_RaidReady_eb361773-da88-dee4-f4c8-a22acae60948)
AND
DB_DEN_AttackOnDen_Raiders(_Raider, _, _, _)
AND
DB_CRIME_Guards_RegionGuard(_Region, _Pool, _Raider)
THEN
NOT DB_CRIME_Guards_RegionGuard(_Region, _Pool, _Raider);
DB_BUGFIX_Marker("GUS-298065");

//END_REGION


//REGION GUS-296462

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_ORI_Gale_NeedsMagicItemIPRDFlags(_, _IPRDFlag, _)
THEN
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IPRDFlag);

//END_REGION

//REGION GUS-301564

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
DB_Dead(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT QRY_HAG_DoublesPresent()
THEN
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 50);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
DB_KnockedOut(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT QRY_HAG_DoublesPresent()
THEN
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 50);

//END_REGION GUS-301564

//REGION GUS-299296

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
AND
DB_CampNight_ExpiresAfter((FLAG)NIGHT_Shadowheart_Romance1_AfterCelebration_f8193afc-a7cd-4d3c-a6d8-dd4270701d96,5)
THEN
NOT DB_CampNight_ExpiresAfter((FLAG)NIGHT_Shadowheart_Romance1_AfterCelebration_f8193afc-a7cd-4d3c-a6d8-dd4270701d96,5);
DB_CampNight_CancelledBy((FLAG)NIGHT_Shadowheart_Romance1_AfterCelebration_f8193afc-a7cd-4d3c-a6d8-dd4270701d96, (FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3);
DB_BUGFIX_Marker("GUS-299296");

//END_REGION GUS-299296
//REGION GUS-298004
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
THEN
DB_LevelUnreachable_TrackEntity((ITEM)S_FOR_DangerousBook_Key_000_123c268d-ad0c-4df5-905b-a78dacbed80b);
DB_LevelUnreachable_TrackEntity((ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507);
//END_REGION

//REGION GUS-213685

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
NOT DB_PartOfTheTeam(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_State_Current(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment", "BEACH")
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_GLO_Shadowheart_Equipment(_Slot, _Template, _Replacement)
AND
NOT QRY_GLO_Shadowheart_HasEquipped((STRING)_Slot, (ITEMROOT)_Template)
AND
TemplateIsInInventory(_Template, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Count)
AND
GetItemByTemplateInInventory(_Template, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Armor)
THEN
DB_BUGFIX_Marker("GUS-213685");
Equip(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Armor);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
NOT DB_PartOfTheTeam(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_State_Current(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment", "BEACH")
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_GLO_Shadowheart_Equipment(_Slot, _Template, _Replacement)
AND
NOT QRY_GLO_Shadowheart_HasEquipped((STRING)_Slot, (ITEMROOT)_Template)
AND
TemplateIsInInventory(_Template, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0)
THEN
DB_BUGFIX_Marker("GUS-213685");
DB_GLO_Shadowheart_ArmorQueue(_Replacement);

//END_REGION GUS-213685

//REGION GUS-270768
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_GlobalFlag(UND_UnfortunateGnome_Event_GoCamp_ce63b2ca-4692-551f-db78-0bff8dd0da6d)
THEN
NOT DB_Inclusion_Object((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,(FLAG)UND_GnomeForeman_UnfortunateGnome_InclusionStart_722c413e-800a-46c4-9382-bc21d63a09b3,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_Inclusion_NPCDialog((DIALOGRESOURCE)UND_GnomeForeman_a59832df-8838-e23b-3106-bb65e599f7fa,(CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
NOT DB_CustomDialogRange((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,20);
DB_BUGFIX_Marker("GUS-270768");
//END_REGION GUS-270768

//REGION GUS-295929
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
NOT DB_PartOfTheTeam(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
DB_CAMP_Halsin_HasMetHalsinFlags((FLAG)GOB_WolfPens_State_HalsinIntroHappened_7d0751b9-1055-4a54-9ccd-f5e95e2a1f69);
DB_CAMP_Halsin_HasMetHalsinFlags((FLAG)GLO_Halsin_Event_TalkedWithDruidLeader_b337012e-aabc-3a99-1f27-225ebb185d58);
DB_CAMP_Halsin_HasMetHalsinFlags((FLAG)DEN_AttackOnDen_HasMet_Halsin_cf151bc0-9f70-bead-5dff-9341a1fdc39f);
DB_BUGFIX_Marker("GUS-295929");

//END_REGION
//REGION GUS-298668
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
THEN
Transform(S_FOR_GnomeGoblin5_0e54fa5d-e2dd-4e15-acbb-82a4e0c63012, Goblins_Female_Ranger_Tier2_28eb9dbc-af0e-4272-b921-67363eeafede, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
DB_TrespassTrigger(FOR_UnfortunateGnome_Trespass_Combat_2639acb2-11c3-480b-87ae-34d99421ae32, NULL_00000000-0000-0000-0000-000000000000, "WLD_FOR_UnfortunateGnome_ApproachHighPerch");
//END_REGION GUS-298668

//REGION GUS-299762

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_OffStage(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_DEN_NPC(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _Role, _Dialog)
THEN
NOT DB_DEN_NPC(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _Role, _Dialog);
DB_BUGFIX_Marker("GUS-299762");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_DEN_AttackOnDen_TieflingDefeatCounters(_Counter)
AND
DB_GLO_DefeatCounter(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _Counter)
AND
NOT DB_DEN_NPC(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _, _)
THEN
NOT DB_GLO_DefeatCounter(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _Counter);
PROC_GLO_DefeatCounter_CheckFinished(_Counter);
DB_BUGFIX_Marker("GUS-299762");

//END_REGION

//REGION GUS-299736
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
THEN
DB_BUGFIX_Marker("GUS-299736");

IF
DB_BUGFIX_Marker("GUS-299736")
AND
DB_GlobalFlag((FLAG)ORI_Astarion_Knows_PoemInfernal_256ed5ae-356b-255c-bd82-e1cf2aa35c55)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8)
THEN
PROC_GlobalSetFlagAndCache(ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8);

IF
DB_BUGFIX_Marker("GUS-299736")
AND
DB_GlobalFlag((FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9);
//END_REGION
//REGION GUS-297765
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
THEN
PROC_SetOnStage((ITEM)S_GOB_Tripwire_A_000_54443088-de46-4382-9695-699ab07f4538, 0);
PROC_SetOnStage((ITEM)S_PLA_BanditCave_Tripwire_A_000_c054443a-8d91-4c02-8fd2-1350cd634841, 0);
//END_REGION GUS-297765

//REGION GUS-299653
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_ORI_Shadowheart_TryWolfDreamInvite();
DB_BUGFIX_Marker("GUS-299653");
//END_REGION GUS-299653

//REGION GUS-299672
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
QRY_QuestUpdateIsUnlockedForAny("UND_MyconidRevenge", "Rewarded")
THEN
DB_BUGFIX_Marker("GUS-299672");
PROC_GlobalSetFlagAndCache((FLAG)UND_MyconidRevenge_State_QuestCompleted_355c9984-d0fe-8de3-8337-ae2eaceb9c57);
//END_REGION

//REGION GUS-299672


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_ORI_Gale_Companion_AteMagicItemIPRDs(_, _Flag)
THEN
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _Flag);
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate3Items_a8e84a1d-7cfe-574a-b92d-34c58a02ba8b, (FLAG)ORI_Gale_Knows_LearnedBackstory_0a9731cf-4769-249f-818d-b4c6e542083d);
NOT DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate3Items_a8e84a1d-7cfe-574a-b92d-34c58a02ba8b, (FLAG)ORI_Gale_Knows_Lord_28c06aa3-59e5-65b8-91fa-493e60af810d);


//END_REGION

//REGION GUS-300429

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
NOT DB_GlobalFlag(DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
THEN
DB_DEN_AttackOnDen_LeaveNPCs(S_DEN_CharmedKid_3b92c689-6024-4446-a6c9-584e9e8d77ca);
DB_BUGFIX_Marker("GUS-300429");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag(DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
AND
DB_DEN_NPC(S_DEN_CharmedKid_3b92c689-6024-4446-a6c9-584e9e8d77ca, _, _)
THEN
SetOnStage(S_DEN_CharmedKid_3b92c689-6024-4446-a6c9-584e9e8d77ca, 0);
SetEntityEvent(S_DEN_CharmedKid_3b92c689-6024-4446-a6c9-584e9e8d77ca, "DEN_NPC_LeftDen", 1);
DB_BUGFIX_Marker("GUS-300429");

//END_REGION

//REGION GUS-313317
PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_Players((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_OnlyOnce("RecruitedFirstTime_Gale")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","WLD_Main_A","GUS-313317");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-313317")
AND
IsInvisibleByScript(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1)
AND
IsOnStage(S_CHA_WaypointShrine_Top_PreRecruitment_b3c94e77-15ab-404c-b215-0340e398dac0, 1)
THEN
SetCanSpotSneakers((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);
DB_BUGFIX_Marker("GUS-313317");

//END_REGION

//REGION GUS-300176

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
NOT DB_GlobalFlag((FLAG)VISITEDREGION_CRE_Main_A_c22062f9-2a42-4e19-8c72-34a2d9ff9c0a)
THEN
SetFlag((FLAG)ORI_Laezel_State_HasNotPassedCreche_946ca251-adb9-4177-9e12-64499d02cff1, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION GUS-300762


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_DarkUrge_MurderOfAlfira_b0e97b06-b2f8-4376-829f-23d4b4bcf78d)
AND
DB_ORI_DarkUrge_AlfiraMurderVictim((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);
DB_Dialogs((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, (DIALOGRESOURCE)DEN_Bard_InParty_3c71c397-b378-340b-0da9-ef3d17d14423);

//END_REGION GUS-300762



//REGION GUS-300514

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_ORI_Dating((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Companion)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_State_StartedRomance_f725b333-9846-4e6c-8123-35330f3e7aa5)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_StartedRomance_f725b333-9846-4e6c-8123-35330f3e7aa5);
DB_BUGFIX_Marker("GUS-300514");

//END_REGION GUS-300514

//REGION GUS-294963. Merge fix
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
THEN
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e, (TRIGGER)S_UND_DarkLake_BoatAtCampArea_467f81f9-f1d6-4c2a-a3d5-1ac0d8897b76, 1);
DB_BUGFIX_Marker("GUS-294963.Fix");
//END_REGION

//REGION GUS-300364
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag((FLAG)PLA_GithChokepoint_State_Cancelled_125f66fd-d046-4daa-ac1c-eb4fc29cfb1c)
AND
NOT DB_PLA_GithChokepoint_Cancelled(1)
THEN
DB_PLA_GithChokepoint_Cancelled(1);
DB_BUGFIX_Marker("GUS-300364");
//END_REGION

//REGION GUS-300980

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag(_IPRDFlag, _CancelFlag)
AND
DB_ORI_Gale_AteMagicItemIRPD_DelayUntilDialogEnd(_IRPDFlag, _ID)
AND
DB_GlobalFlag(_CancelFlag)
THEN
NOT DB_ORI_Gale_AteMagicItemIRPD_DelayUntilDialogEnd(_IRPDFlag, _ID);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag(_IPRDFlag, _CancelFlag)
AND
DB_ORI_Gale_AteMagicItemIRPD_DelayUntilDialogEnd(_IRPDFlag, _ID)
AND
DB_GlobalFlag(_CancelFlag)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IPRDFlag);



//END_REGION


//REGION GUS-301031

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotTwoMagicItems_c757086e-4696-441d-b19c-fdb65982776f)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars(_Avatar)
AND
QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
ChangeApprovalRating((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)_Avatar, 0, 10, _)
THEN
DB_BUGFIX_Marker("GUS-300364 - Approval 1");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars(_Avatar)
AND
QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
ChangeApprovalRating((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)_Avatar, 0, 10, _)
THEN
DB_BUGFIX_Marker("GUS-300364 - Approval 2");

//END_REGION

//REGION Fix Broken Lighting settings for WLD Camps
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_BUGFIX_Marker("Fix Broken Lighting settings for WLD Camps");
NOT DB_Camp_Ambiance("WLDCAVGRN",
		(TRIGGER)S_CAMP_WLDCAVGRN_AtmosphereTrigger_d4d2354d-9f6f-44a5-8051-40271052b0ec,
		"afeb993b-462c-994d-00e3-995e04154ee4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Day_afeb993b-462c-994d-00e3-995e04154ee4
		"063b0188-7089-f2f6-2ad9-ad9766e429c4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Night_063b0188-7089-f2f6-2ad9-ad9766e429c4
		(TRIGGER)S_CAMP_WLDCAVGRN_LightingTrigger_318c5a40-5628-4f2e-9560-e213a76d8517,
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		(TRIGGER)S_Amb_SV_Camp_CaveGranite_Global_QD_017a3158-8ccb-4b01-a962-0fb49280c3f2);
DB_Camp_Ambiance("WLDCAVGRN",
		(TRIGGER)S_CAMP_WLDCAVGRN_AtmosphereTrigger_d4d2354d-9f6f-44a5-8051-40271052b0ec,
		"afeb993b-462c-994d-00e3-995e04154ee4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Day_afeb993b-462c-994d-00e3-995e04154ee4
		"063b0188-7089-f2f6-2ad9-ad9766e429c4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Night_063b0188-7089-f2f6-2ad9-ad9766e429c4
		(TRIGGER)S_CAMP_WLDCAVGRN_LightingTrigger_318c5a40-5628-4f2e-9560-e213a76d8517,
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit	9f666037-8330-b11f-bea6-2d534abe7dee
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit	9f666037-8330-b11f-bea6-2d534abe7dee
		(TRIGGER)S_Amb_SV_Camp_CaveGranite_Global_QD_017a3158-8ccb-4b01-a962-0fb49280c3f2);
NOT DB_Camp_Ambiance("WLDCAVSND",
		(TRIGGER)S_CAMP_WLDCAVSND_AtmosphereTrigger_29fa58d1-6f17-4981-98e2-9d866abcb22e,
		"01b5553f-a13b-992b-1da8-ccc163c44235", //(ATMOSPHERERESOURCE)ATM_Camp_Dungeon_A_SandstoneCave_A_01b5553f-a13b-992b-1da8-ccc163c44235
		"d3a81cfc-64c0-0c3b-179d-50e740d41458", //(ATMOSPHERERESOURCE)ATM_Camp_Dungeon_A_SandstoneCave_A_Night_d3a81cfc-64c0-0c3b-179d-50e740d41458
		(TRIGGER)S_CAMP_WLDCAVSND_LightingTrigger_b8d55dc5-fe27-4aef-a021-c710a8e63019,
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		(TRIGGER)S_Amb_SV_Camp_CaveSandStone_QD_aab991d3-1eb6-44f2-a61b-48b054d4096f);
DB_Camp_Ambiance("WLDCAVSND",
		(TRIGGER)S_CAMP_WLDCAVSND_AtmosphereTrigger_29fa58d1-6f17-4981-98e2-9d866abcb22e,
		"01b5553f-a13b-992b-1da8-ccc163c44235", //(ATMOSPHERERESOURCE)ATM_Camp_Dungeon_A_SandstoneCave_A_01b5553f-a13b-992b-1da8-ccc163c44235
		"d3a81cfc-64c0-0c3b-179d-50e740d41458", //(ATMOSPHERERESOURCE)ATM_Camp_Dungeon_A_SandstoneCave_A_Night_d3a81cfc-64c0-0c3b-179d-50e740d41458
		(TRIGGER)S_CAMP_WLDCAVSND_LightingTrigger_b8d55dc5-fe27-4aef-a021-c710a8e63019,
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit	9f666037-8330-b11f-bea6-2d534abe7dee
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit	9f666037-8330-b11f-bea6-2d534abe7dee
		(TRIGGER)S_Amb_SV_Camp_CaveSandStone_QD_aab991d3-1eb6-44f2-a61b-48b054d4096f);
NOT DB_Camp_Ambiance("WLDDUNABB",
		(TRIGGER)S_CAMP_WLDDUNABB_AtmosphereTrigger_37584bb3-36cf-4fbc-8898-dd3f5087c960,
		"afeb993b-462c-994d-00e3-995e04154ee4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Day_afeb993b-462c-994d-00e3-995e04154ee4
		"063b0188-7089-f2f6-2ad9-ad9766e429c4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Night_063b0188-7089-f2f6-2ad9-ad9766e429c4
		(TRIGGER)S_CAMP_WLDDUNABB_LightingTrigger_51bbeeea-7123-4178-aa35-21b65fd5565e,
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		(TRIGGER)S_Amb_SV_Camp_DungeonAbbey_QD_f2ce5f69-ba23-4a0e-a0e7-d2d1ab79131f);
DB_Camp_Ambiance("WLDDUNABB",
		(TRIGGER)S_CAMP_WLDDUNABB_AtmosphereTrigger_37584bb3-36cf-4fbc-8898-dd3f5087c960,
		"afeb993b-462c-994d-00e3-995e04154ee4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Day_afeb993b-462c-994d-00e3-995e04154ee4
		"063b0188-7089-f2f6-2ad9-ad9766e429c4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Night_063b0188-7089-f2f6-2ad9-ad9766e429c4
		(TRIGGER)S_CAMP_WLDDUNABB_LightingTrigger_51bbeeea-7123-4178-aa35-21b65fd5565e,
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit	9f666037-8330-b11f-bea6-2d534abe7dee
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit	9f666037-8330-b11f-bea6-2d534abe7dee
		(TRIGGER)S_Amb_SV_Camp_DungeonAbbey_QD_f2ce5f69-ba23-4a0e-a0e7-d2d1ab79131f);
NOT DB_Camp_Ambiance("WLDDUNSHA",
		(TRIGGER)S_CAMP_WLDDUNSHA_AtmosphereTrigger_3e8b7ef4-a2ab-4c0a-bae5-0b0bb1178678,
		"b4beaa1b-d4e8-c3b9-137f-5bb7e4d02d2f", //(ATMOSPHERERESOURCE)ATM_CMP_Camp_DungeonShar_A_Day_b4beaa1b-d4e8-c3b9-137f-5bb7e4d02d2f
		"ffac1538-e28e-1dd2-6b67-b886d5128b37", //(ATMOSPHERERESOURCE)ATM_CMP_Camp_DungeonShar_A_Night_ffac1538-e28e-1dd2-6b67-b886d5128b37
		(TRIGGER)S_CAMP_WLDDUNSHA_LightingTrigger_5bc92d8c-ba76-41f5-92ee-afbf551b7e70,
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		(TRIGGER)S_Amb_SV_Camp_DungeonShar_QD_000_c561f9f7-63ac-4b7f-b85a-21a2b18a056d);
DB_Camp_Ambiance("WLDDUNSHA",
		(TRIGGER)S_CAMP_WLDDUNSHA_AtmosphereTrigger_3e8b7ef4-a2ab-4c0a-bae5-0b0bb1178678,
		"b4beaa1b-d4e8-c3b9-137f-5bb7e4d02d2f", //(ATMOSPHERERESOURCE)ATM_CMP_Camp_DungeonShar_A_Day_b4beaa1b-d4e8-c3b9-137f-5bb7e4d02d2f
		"ffac1538-e28e-1dd2-6b67-b886d5128b37", //(ATMOSPHERERESOURCE)ATM_CMP_Camp_DungeonShar_A_Night_ffac1538-e28e-1dd2-6b67-b886d5128b37
		(TRIGGER)S_CAMP_WLDDUNSHA_LightingTrigger_5bc92d8c-ba76-41f5-92ee-afbf551b7e70,
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit	9f666037-8330-b11f-bea6-2d534abe7dee
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit	9f666037-8330-b11f-bea6-2d534abe7dee
		(TRIGGER)S_Amb_SV_Camp_DungeonShar_QD_000_c561f9f7-63ac-4b7f-b85a-21a2b18a056d);
NOT DB_Camp_Ambiance("WLDUND",
		(TRIGGER)S_CAMP_WLDUND_AtmosphereTrigger_0dfac787-c185-45ae-9233-fa3e0062bc74,
		"7c8b1d8e-6afb-503f-dde2-1fcd56ff53ed", //(ATMOSPHERERESOURCE)ATM_WLD_CMP_Underdark_A_Day_7c8b1d8e-6afb-503f-dde2-1fcd56ff53ed
		"0e4ad092-d07c-c2ae-3492-ebaa6422ab47", //(ATMOSPHERERESOURCE)ATM_WLD_CMP_Underdark_A_Night_0e4ad092-d07c-c2ae-3492-ebaa6422ab47
		(TRIGGER)S_CAMP_WLDUND_LightingTrigger_6e557460-ed1b-4888-95d3-4f9cf1669eea,
		"3a74aec6-8588-5d14-6550-f338d24bc617", //(LIGHTINGRESOURCE)LTN_Default_EV10_Underdark_A_3a74aec6-8588-5d14-6550-f338d24bc617
		"3a74aec6-8588-5d14-6550-f338d24bc617", //(LIGHTINGRESOURCE)LTN_Default_EV10_Underdark_A_3a74aec6-8588-5d14-6550-f338d24bc617
		(TRIGGER)S_Amb_SV_Camp_Underdark_QD_8da5524e-3ddf-4362-bd3b-e18fc4e4f5e1);
DB_Camp_Ambiance("WLDUND",
		(TRIGGER)S_CAMP_WLDUND_AtmosphereTrigger_0dfac787-c185-45ae-9233-fa3e0062bc74,
		"7c8b1d8e-6afb-503f-dde2-1fcd56ff53ed", //(ATMOSPHERERESOURCE)ATM_WLD_CMP_Underdark_A_Day_7c8b1d8e-6afb-503f-dde2-1fcd56ff53ed
		"0e4ad092-d07c-c2ae-3492-ebaa6422ab47", //(ATMOSPHERERESOURCE)ATM_WLD_CMP_Underdark_A_Night_0e4ad092-d07c-c2ae-3492-ebaa6422ab47
		(TRIGGER)S_CAMP_WLDUND_LightingTrigger_6e557460-ed1b-4888-95d3-4f9cf1669eea,
		"fe300fdd-5f6f-8d5d-c07a-13393abfdd27", //(LIGHTINGRESOURCE)LTN_WLD_CMP_Underdark_A	fe300fdd-5f6f-8d5d-c07a-13393abfdd27
		"fe300fdd-5f6f-8d5d-c07a-13393abfdd27", //(LIGHTINGRESOURCE)LTN_WLD_CMP_Underdark_A	fe300fdd-5f6f-8d5d-c07a-13393abfdd27
		(TRIGGER)S_Amb_SV_Camp_Underdark_QD_8da5524e-3ddf-4362-bd3b-e18fc4e4f5e1);
//END_REGION

//REGION
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_DropMutingStatussesDialog(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7)
THEN
NOT DB_DropMutingStatussesDialog(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7);
DB_IgnoreMutingStatussesDialog(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7);
//END_REGION

//REGION GUS-300284

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_CAMP_GoblinHuntCelebration_BetraylFightComplete(1)
AND
NOT DB_GlobalFlag(CAMP_GoblinHuntCelebration_State_DrowBetrayalOver_75aa1308-f580-e495-4893-09d215528472)
AND
IsOnStage(S_GOB_AftermathTrader_5e3467b4-9186-4ab2-81b8-cf379bcbd982,1) // Just an additional check for sanity
THEN
PROC_GOB_Misc_MakeFestivitiesDead();
DB_BUGFIX_Marker("GUS-300284");

//END_REGION

//REGION GUS-300926
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
DB_MovingTo(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, S_GOB_Checkpoint_CapturedGoblinWaitingPosition_0691f7e0-da49-4390-9c10-bcccd715d230, _, _)
THEN
DB_BUGFIX_Marker("GUS-300926");
PROC_CRIME_DisableDangerousShapeshiftReactions((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
GetFlag(GOB_Checkpoint_State_WaitingForPlayer_1da9e319-6f34-48f8-875a-48bb863c81d1, S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, 1)
THEN
DB_BUGFIX_Marker("GUS-300926");
PROC_CRIME_DisableDangerousShapeshiftReactions((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
//END_REGION

//REGION GUS-300524
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
NOT DB_CampNight_Completed((FLAG)NIGHT_WyllConfrontation_NotRecruited_b35ff12a-ceae-4bf8-94e2-5050576e4d6e)
THEN
DB_CampNight_CRD((FLAG)NIGHT_WyllConfrontation_NotRecruited_b35ff12a-ceae-4bf8-94e2-5050576e4d6e,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
NOT DB_CampNight_Completed((FLAG)NIGHT_WyllConfrontation_2576ba4e-90a9-4da0-bb40-6f012ed4a888)
THEN
DB_CampNight_CRD((FLAG)NIGHT_WyllConfrontation_2576ba4e-90a9-4da0-bb40-6f012ed4a888,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
NOT DB_CampNight_Completed((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2)
THEN
DB_CampNight_CRD((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty_Event_PostJudgementReflection_6d93654c-15c2-cf9f-a48c-868602ec76d4);

//END_REGION

//REGION GUS-301116
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
NOT DB_Defeated(S_UND_SharFort_Minotaur_Bait_b63c0d26-7c5f-4dc5-a3d1-2cc99367c809)
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
CanJoinCombat(S_UND_SharFort_Minotaur_Bait_b63c0d26-7c5f-4dc5-a3d1-2cc99367c809, 0)
THEN
SetCanFight(S_UND_SharFort_Minotaur_Bait_b63c0d26-7c5f-4dc5-a3d1-2cc99367c809, 0);
SetCanJoinCombat(S_UND_SharFort_Minotaur_Bait_b63c0d26-7c5f-4dc5-a3d1-2cc99367c809, 1);
DB_BUGFIX_Marker("GUS-301116");
//END_REGION GUS-301116


//REGION GUS-300428
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
NOT DB_GlobalFlag((FLAG)PLA_KarlachRecruitmentTollhouse_Knows_RefugeesAreCultists_8b18c014-7558-4bab-aa35-37d135fc8630)
AND
DB_PartOfTheTeam(_Char)
AND
GetFlag((FLAG)PLA_KarlachRecruitment_Quest_ToldZarielFollowers_b3724866-2e00-14e2-7c7b-55b27f310a6e, _Char, 1)
THEN
DB_BUGFIX_Marker("GUS-300428");
SetFlag((FLAG)PLA_KarlachRecruitmentTollhouse_Knows_RefugeesAreCultists_8b18c014-7558-4bab-aa35-37d135fc8630, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION GUS-300428


//REGION GUS-301398
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
DB_GlobalFlag((FLAG)NIGHT_PaladinsOfTyr_Forced_3a1be30d-8a75-4bee-b717-0b2e4d7bd1e9)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_QuestIsAccepted("ORI_COM_Karlach_SUB_ForgingOfTheHeart")
THEN
DB_BUGFIX_Marker("GUS-301398");
SetFlag((FLAG)ORI_Karlach_State_InSearchOfMechanic_9943b467-dff2-4a15-abbc-e380e0b8f794, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION GUS-301398

//REGION GUS-301741
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,14,0)
AND
DB_QuestDef_State((FLAG)UND_HiddenGnome_HasVial_c21860d0-c8af-430e-aa42-de81ff020568,"UND_CaveIn","PhilomeenGaveVial")
THEN
NOT DB_QuestDef_State((FLAG)UND_HiddenGnome_HasVial_c21860d0-c8af-430e-aa42-de81ff020568,"UND_CaveIn","PhilomeenGaveVial");
//END_REGION GUS-301741


//REGION GUS-302014

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,14,0)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_DarkUrge_MurderOfAlfira_b0e97b06-b2f8-4376-829f-23d4b4bcf78d)
AND
DB_GlobalFlag(ORI_DarkUrge_Event_HideAlfiraCorpse_c5e208f3-862b-bf96-1814-552b983149a1)
AND
DB_ORI_DarkUrge(_DarkUrge)
THEN
NOT DB_Camp_QueuedMorningIVB((VOICEBARKRESOURCE)CAMP_DarkUrge_MurderOfAlfira_GD_IVB_MorningAfter_Backup_f28df493-b622-b1a2-6c91-feeb040e2db8, _DarkUrge);

//END_REGION

//REGION GUS-301004


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag((FLAG)FOR_GnomeGoblinsPacified_385336a9-30d7-f4f8-fa62-32dff47ff714)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","WLD_Main_A","GUS-301004");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-301004")
AND
DB_FOR_GnomeGoblins((CHARACTER)_Goblin, NULL_00000000-0000-0000-0000-000000000000, _Dialog, _Time)
AND
IsOnStage(_Goblin, 0)
AND
NOT DB_PermaDefeated(_Goblin)
THEN
PROC_PeacefulResolve((CHARACTER)_Goblin);

//END_REGION

//REGION GUS-302048

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,14,0)
AND
DB_Players(_Player)
AND
GetFlag(PLA_StuckHalfElf_State_HasDowry_464445ee-74e3-4838-98dc-435074439303, _Player, 1)
AND
QuestUpdateIsUnlocked(_Player, "PLA_StuckHalfElf", "KnowDowry", 1)
THEN
QuestUpdate((CHARACTER)_Player, "PLA_StuckHalfElf", "DowryGold");
DB_BUGFIX_Marker("GUS-302048");

//END_REGION

//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,14,0)
AND
DB_DEN_AttackOnDen_EmptyLair(1)
AND
DB_GlobalFlag(DEN_AttackOnDen_Event_Start_c641da6a-b3f5-4873-bd34-c53768d30d6f)
AND
NOT DB_GlobalFlag((FLAG)DEN_AttackOnDen_State_DruidsAreDefeated_3c6d8a2c-dd85-48d1-b48d-f0c6d37959e4)
THEN
SetFlag(DEN_AttackOnDen_State_DruidsAreDefeated_3c6d8a2c-dd85-48d1-b48d-f0c6d37959e4, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION GUS-302913

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 3")
AND
DB_GlobalFlag((FLAG)NIGHT_Gale_TressymJoin_7ca98d47-e9fa-4f87-8728-8e56c4ee652d)
AND
DB_ORI_Gale_BlockWorsenBomb(1)
AND
NOT DB_Camp_NightMode(1)
THEN
NOT DB_ORI_Gale_BlockWorsenBomb(1);
DB_BUGFIX_Marker("GUS-302913");

//END_REGION

//REGION GUS-159206

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_AddCharactersInTriggerToDialog(FOR_UnfortunateGnome_SlowDown_NoGoblins_8859f0e0-0d0b-e54f-c141-7dff95ae05a4, S_FOR_UnfortunateGnome_SlowDown_NoGoblins_Trigger_5ee4c342-324b-4931-bd1b-24c95a1ea306, 1, 1, 1, 1);
DB_BUGFIX_Marker("GUS-159206");

//END_REGION

//REGION GUS-302682
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 2")
THEN
PROC_ApplySavegamePatches_GUS_302682_ApplyFix();
DB_BUGFIX_Marker("GUS-302682");

PROC
PROC_ApplySavegamePatches_GUS_302682_ApplyFix()
AND
DB_CurrentLevel("WLD_Main_A")
AND
IsOnStage(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 0)
AND
IsOnStage(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 1)
THEN
PROC_PLA_GithChokepoint_DragonEvent_FinishDragonLeaving();

PROC
PROC_ApplySavegamePatches_GUS_302682_ApplyFix()
AND
NOT DB_CurrentLevel("WLD_Main_A")
AND
DB_PLA_GithChokepoint_Outcome(_Outcome)
THEN
NOT DB_CustomDialogRange(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 20);
NOT DB_CustomDialogRange(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 20);
NOT DB_PLA_GithChokepoint_Outcome(_Outcome);
ClearFlag(PLA_GithChokepoint_State_ConfrontationIsOngoing_9c3fc7db-3ac3-4b6d-b895-106601db5d4a, NULL_00000000-0000-0000-0000-000000000000);
PROC_PLA_GithChokepoint_MakeKnightAndDragonMortals();
SetCanJoinCombat((CHARACTER)S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 1);
SetDetached(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f, 0);
PROC_PLA_GithChokepoint_CleanUp();
DB_ApplySavegamePatches_GUS_302682_CleanUpChokepoint(1);

//Offstage only happening if you return to WLD_Main_A to avoid them being put off stage in future acts if players make a safe in an unfortunate timing
IF
DB_ApplySavegamePatches_GUS_302682_CleanUpChokepoint(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_ApplySavegamePatches_GUS_302682_CleanUpChokepoint(1);
PROC_SetOnStage(S_GLO_GithDragon_9e21fba4-5a6d-4ca0-9738-2add3c967b3f,0);
PROC_SetOnStage(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea,0);

//END_REGION

//REGION GUS-302317
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_GlobalFlag(Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
THEN
PROC_GOB_FestivSleepers_CompleteGoal();
PROC_GOB_Festivities_CompleteGoal();
DB_BUGFIX_Marker("GUS-302317");
//END_REGION GUS-302317

//REGION GUS-302863

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_GlobalFlag((FLAG)DEN_GruntingKid_State_NoticedDoor_5e0abedc-87d2-230d-2b3b-748a8d1e9399)
AND
NOT DB_GlobalFlag((FLAG)DEN_GruntingKid_State_HatchOpened_0ff8129d-c04b-4b7d-bf9b-60b55b40fbcc)
THEN
PROC_GlobalSetFlagAndCache((FLAG)DEN_GruntingKid_State_HatchOpened_0ff8129d-c04b-4b7d-bf9b-60b55b40fbcc);
DB_BUGFIX_Marker("GUS-302863");

//END_REGION

//REGION GUS-302903

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 3")
THEN
DB_BUGFIX_Marker("GUS-302903");
DB_BUGFIX_GUS302903_FixOwnership((ITEM)DLC_DD_Painting_Portrait_Lohse_000_c474a3fe-0e04-41cc-94e2-8978c15033da,(CHARACTER)S_DEN_Apprentice_7cabf226-e34b-4556-8903-a45d0fe26caf);
DB_BUGFIX_GUS302903_FixOwnership((ITEM)DLC_DD_Painting_Portrait_Sebille_000_5b2b57cc-1c10-49f9-990f-6347060e11bb,(CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
DB_ActiveLevel("WLD_Main_A")
AND
DB_BUGFIX_GUS302903_FixOwnership((ITEM)_Painting,(CHARACTER)_Owner)
AND
GetOwner(_Painting,(CHARACTER)_Owner)
THEN
ClearOwnership(_Painting);
DB_ItemOwnerShipClearItem("WLD_Main_A",_Painting);
NOT DB_BUGFIX_GUS302903_FixOwnership((ITEM)_Painting,(CHARACTER)_Owner);

//END_REGION

//REGION GUS-302794
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 3")
AND
NOT DB_DropMutingStatussesDialog(DEN_General_Squirrel_910734d1-dfb8-2aaf-2913-e15466181f73)
THEN
DB_DropMutingStatussesDialog(DEN_General_Squirrel_910734d1-dfb8-2aaf-2913-e15466181f73);
DB_BUGFIX_Marker("GUS-302794");
//END_REGION

//REGION GUS-203631
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
DB_GlobalFlag(GOB_GoblinHeretic_RaidersDead_4e7261b8-9510-45ae-bb94-3d2e3b191e40)
THEN
DB_BUGFIX_Marker("GUS-203631");
DB_GOB_GoblinHeretic_RaidersGone(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
NOT DB_GlobalFlag(GOB_GoblinHeretic_RaidersDead_4e7261b8-9510-45ae-bb94-3d2e3b191e40)
AND
NOT QRY_GOB_GoblinHeretic_AnyRaiderInArea()
THEN
DB_GOB_GoblinHeretic_RaidersGone(1);
DB_BUGFIX_Marker("GUS-203631");
//END_REGION GUS-203631


//REGION GUS-302427
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(DEN_AttackOnDen_State_RaiderVictory_abe1bce8-c234-4afe-a490-76210d98a078)
AND
DB_QuestIsOpened("GLO_Tadpole")
THEN
QuestUpdate("GLO_Tadpole", "Betrayal_DruidDead_Halsin");
DB_BUGFIX_Marker("GUS-302427");

//END_REGION GUS-302427
//REGION GUS-298057
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-298057");

IF
DB_BUGFIX_Marker("GUS-298057")
AND
DB_CurrentLevel("WLD_Main_A")
THEN
PROC_SavegamePatch_GUS298057_FixZhentMines();

// Fix floating home trigger
PROC
PROC_SavegamePatch_GUS298057_FixZhentMines()
THEN
TeleportToPosition(S_PLA_ZhentDungeon_Zhent07_Home_1ae849ae-82d0-488d-976f-9c3da1ae3fc6, 298.512, 3.913, -183.954);

// Build list of mines to check weither or not the CombatTraps_State_Active flag should be set
PROC
PROC_SavegamePatch_GUS298057_FixZhentMines()
THEN
DB_SavegamePatch_GUS298057_ZhentMines((ITEM)S_PLA_ZhentDungeon_Defense_ProximityExplosive_000_8738875b-3226-4dea-abdb-ea6130aa5385);
DB_SavegamePatch_GUS298057_ZhentMines((ITEM)S_PLA_ZhentDungeon_Defense_ProximityExplosive_001_29426765-9764-4ae6-a231-b3dc270db9c9);
DB_SavegamePatch_GUS298057_ZhentMines((ITEM)S_PLA_ZhentDungeon_Defense_ProximityExplosive_002_ebbba95b-0423-4d2a-b7ef-2ced78b098aa);
// skipping mine 03 because this one starts on.
DB_SavegamePatch_GUS298057_ZhentMines((ITEM)S_PLA_ZhentDungeon_Defense_ProximityExplosive_004_dd3d0fb6-eb71-499e-ab25-e425ae96ca10);
DB_SavegamePatch_GUS298057_ZhentMines((ITEM)S_PLA_ZhentDungeon_Defense_ProximityExplosive_005_117a61b5-f6be-4926-b466-fc4f28dc6299);
DB_SavegamePatch_GUS298057_ZhentMines((ITEM)S_PLA_ZhentDungeon_Defense_ProximityExplosive_006_78c6e701-ea3a-4133-ba4f-200e77254f0c);

// check if any of the mines in the list are on
PROC
PROC_SavegamePatch_GUS298057_FixZhentMines()
AND
DB_SavegamePatch_GUS298057_ZhentMines(_Mine)
AND
GetVarInteger(_Mine, "On", 1)
AND
QRY_OnlyOnce("SavegamePatch_GUS298057_SetActiveFlag")
THEN
PROC_GlobalSetFlagAndCache(PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07);

// Disable mine 03 if it is the only one that is on.
PROC
PROC_SavegamePatch_GUS298057_FixZhentMines()
AND
NOT DB_GlobalFlag(PLA_ZhentDungeon_CombatTraps_State_Active_2badbd06-c41e-4210-85f5-c021b6f54d07)
AND
IsDestroyed(S_PLA_ZhentDungeon_Defense_ProximityExplosive_003_821be27b-97ab-4108-8a0c-2e34eb452fdd, 0)
THEN
SetForceUpdate(S_PLA_ZhentDungeon_Defense_ProximityExplosive_003_821be27b-97ab-4108-8a0c-2e34eb452fdd, 1);
ObjectTimerLaunch(S_PLA_ZhentDungeon_Defense_ProximityExplosive_003_821be27b-97ab-4108-8a0c-2e34eb452fdd, "SavegamePatch_GUS298057_DisableMine", 1000);

IF
ObjectTimerFinished(S_PLA_ZhentDungeon_Defense_ProximityExplosive_003_821be27b-97ab-4108-8a0c-2e34eb452fdd, "SavegamePatch_GUS298057_DisableMine")
THEN
SetEntityEvent(S_PLA_ZhentDungeon_MineDisabler_5b1653f7-9341-4676-9665-9506ceeafa79, "CNST_ProximityMine_Disable", 1);
ObjectTimerLaunch(S_PLA_ZhentDungeon_Defense_ProximityExplosive_003_821be27b-97ab-4108-8a0c-2e34eb452fdd, "SavegamePatch_GUS298057_DisableForceUpdate", 1000);

IF
ObjectTimerFinished(S_PLA_ZhentDungeon_Defense_ProximityExplosive_003_821be27b-97ab-4108-8a0c-2e34eb452fdd, "SavegamePatch_GUS298057_DisableForceUpdate")
THEN
SetForceUpdate(S_PLA_ZhentDungeon_Defense_ProximityExplosive_003_821be27b-97ab-4108-8a0c-2e34eb452fdd, 0);
//END_REGION



//REGION GUS-303341
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_PartOfTheTeam(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_PartOfTheTeam(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
PROC_Origins_CompanionLeavePermanently(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
Die(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, DEATHTYPE.Physical, 0);
DB_BUGFIX_Marker("GUS-303341");
//END_REGION GUS-303341

//REGION GUS-299961
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag((FLAG)LOW_VoloFate_State_VoloArrivedInBG_5faacb8c-836d-4626-bb7d-418c643e494d)
AND
DB_AD_Dialog((CHARACTER)S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,_AD)
THEN
DB_BUGFIX_Marker("GUS-299961");
PROC_RemoveNPCADs(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa);
//END_REGION

//REGION GUS-303733
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_OnlyOnce("PLA_KarlachRecruitmentTollhouse_RefugeesLeft")
AND
GetFlag(PLA_KarlachRecruitmentTollhouse_Event_GiveHead_d4e8a331-084c-42b7-a2b3-99e587f8679e, S_PLA_Refugee_001_a43d1d6c-d397-4d2d-adb4-ead3b10cb189, 0)
AND
NOT DB_PLA_PaladinsOfTyr_TryResolve(1)
THEN
DB_BUGFIX_Marker("GUS-303733");
NOT DB_OnlyOnce("PLA_KarlachRecruitmentTollhouse_RefugeesLeft");
ClearFlag((FLAG)PLA_KarlachRecruitmentTollhouse_State_RefugeesLeft_04c9162c-0ade-45d8-87a7-40f88796219a, NULL_00000000-0000-0000-0000-000000000000);
PROC_SavegamePatch_GUS303733_BringPaladinsBack();

PROC
PROC_SavegamePatch_GUS303733_BringPaladinsBack()
THEN
DB_SavegamePatch_GUS303733_PaladinsSafePositions((CHARACTER)S_PLA_Refugee_001_a43d1d6c-d397-4d2d-adb4-ead3b10cb189, (TRIGGER)S_PLA_Refugee_000_SafePosition_22099fe1-f79b-434d-aa99-3b544ba606e2);
DB_SavegamePatch_GUS303733_PaladinsSafePositions((CHARACTER)S_PLA_Refugee_002_97ae38c5-550d-4585-9f9e-a0494ecb863a, (TRIGGER)S_PLA_Refugee_002_SafePosition_481b7648-5324-43ad-b448-ae4a01c105a9);
DB_SavegamePatch_GUS303733_PaladinsSafePositions((CHARACTER)S_PLA_Refugee_003_bf6a657e-091c-43e5-b18a-a2ca7ca7e511, (TRIGGER)S_PLA_Refugee_003_SafePosition_715a0a34-cdde-43f0-b4ce-3104c0031fed);

PROC
PROC_SavegamePatch_GUS303733_BringPaladinsBack()
AND
DB_SavegamePatch_GUS303733_PaladinsSafePositions(_Refugee, _SafePositon)
AND
NOT DB_PermaDefeated(_Refugee)
THEN
AppearAt(_Refugee, _SafePositon, 0, NULL_00000000-0000-0000-0000-000000000000, "");

PROC
PROC_SavegamePatch_GUS303733_BringPaladinsBack()
AND
DB_SavegamePatch_GUS303733_PaladinsSafePositions(_Refugee, _SafePositon)
AND
DB_PermaDefeated(_Refugee)
THEN
SetOnStage(_Refugee, 1);
//END_REGION GUS-303733

//REGION GUS-303771

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
PROC_CRIME_Guards_MakePeace("WLD_Main_A_SHED","DEN_StorageShedGuards");
PROC_CRIME_Guards_MakePeace("WLD_Main_A_HIDEOUT", "DEN_ThieflingHideout");
DB_CRIME_Guards_NoGuardKiller("WLD_Main_A_SHED","DEN_StorageShedGuards");
DB_CRIME_Guards_NoGuardKiller("WLD_Main_A_HIDEOUT", "DEN_ThieflingHideout");
DB_BUGFIX_Marker("GUS-303771");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_CRIME_GuardKillerCombatWitness(_Killer,_Witness,_GuardFaction,"WLD_Main_A_SHED",_Pool,_GuardIterator)
THEN
NOT DB_CRIME_GuardKillerCombatWitness(_Killer,_Witness,_GuardFaction,"WLD_Main_A_SHED",_Pool,_GuardIterator);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_CRIME_GuardKillerCombatWitness(_Killer,_Witness,_GuardFaction,"WLD_Main_A_HIDEOUT",_Pool,_GuardIterator)
THEN
NOT DB_CRIME_GuardKillerCombatWitness(_Killer,_Witness,_GuardFaction,"WLD_Main_A_HIDEOUT",_Pool,_GuardIterator);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_CRIME_GuardKiller_Witness(_Witness,_Killer,_Guard,"WLD_Main_A_SHED",_Pool,_GuardFaction)
THEN
NOT DB_CRIME_GuardKiller_Witness(_Witness,_Killer,_Guard,"WLD_Main_A_SHED",_Pool,_GuardFaction);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_CRIME_GuardKiller_Witness(_Witness,_Killer,_Guard,"WLD_Main_A_HIDEOUT",_Pool,_GuardFaction)
THEN
NOT DB_CRIME_GuardKiller_Witness(_Witness,_Killer,_Guard,"WLD_Main_A_HIDEOUT",_Pool,_GuardFaction);

//END_REGION

//REGION GUS-302705
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
THEN
NOT DB_GLO_Backgrounds_Goal((TAG)HAUNTED_ONE_ce00b3b6-238e-4524-851b-3d1f2d2b1189, "Act1_HauntedOne_NascentIntellectDevourerHindered", 6d36f2a0-6570-42ba-b299-2b7762e16652);
NOT DB_GLO_Backgrounds_Goal((TAG)HAUNTED_ONE_ce00b3b6-238e-4524-851b-3d1f2d2b1189, "Act1_HauntedOne_NascentIntellectDevourerHindered", 6d36f2a0-6570-42ba-b299-2b7762e16652, "Global");
NOT DB_GLO_Backgrounds_Goal((TAG)HAUNTED_ONE_ce00b3b6-238e-4524-851b-3d1f2d2b1189, "Act1_HauntedOne_PinnedMindFlayer", c7fb7dbd-1513-4d65-8b25-d136ea39af9e);
NOT DB_GLO_Backgrounds_Goal((TAG)HAUNTED_ONE_ce00b3b6-238e-4524-851b-3d1f2d2b1189, "Act1_HauntedOne_PinnedMindFlayer", c7fb7dbd-1513-4d65-8b25-d136ea39af9e, "Global");
DB_GLO_Backgrounds_Goal((TAG)HAUNTED_ONE_ce00b3b6-238e-4524-851b-3d1f2d2b1189, "Act1_HauntedOne_PinnedMindFlayer", 6d36f2a0-6570-42ba-b299-2b7762e16652);
DB_BUGFIX_Marker("GUS-302705");
//END_REGION GUS-302705

//REGION GUS-125247

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7","WLD_Main_A","GUS-125247");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-125247")
THEN
TeleportToPosition(HAG_BHVR_WRLD_CleaningTable_HUM_F_TimelineSceneTrigger_7485bc97-7638-4ef5-a6fc-a12e9b922edd, -57.331, 7.182, 249.901, "", 0, 0, 0, 0, 1);

//END_REGION

//REGION GUS-303450
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Defeated((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_GlobalFlag((FLAG)Wyll_Recruitment_Event_QueueNight_08a74992-a350-42b8-80d3-2685898281ba)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
PROC_ORI_Wyll_LeaveDen();

//END_REGION GUS-303450

//REGION GUS-303815
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("WLD_Main_A")
THEN
DB_GLO_CompoundFlag((FLAG)CAMP_ShadowheartLaezelFight_State_AgainstShadowheart_31c9f64a-9aba-4207-a678-6d1b6d42d607, (FLAG)CAMP_ShadowheartLaezelFight_State_SeenFight_3e1cb3f3-208f-4ecf-b116-e3b653140ac4);
DB_GLO_CompoundFlag((FLAG)CAMP_ShadowheartLaezelFight_State_AgainstLaezel_f9524477-f8f6-4fb2-98fb-d228676ac613, (FLAG)CAMP_ShadowheartLaezelFight_State_SeenFight_3e1cb3f3-208f-4ecf-b116-e3b653140ac4);
DB_GLO_CompoundFlag((FLAG)CAMP_ShadowheartLaezelFight_State_ResolvedPeacefully_f212b8b3-0490-1663-4645-e4fa7ca350e4, (FLAG)CAMP_ShadowheartLaezelFight_State_SeenFight_3e1cb3f3-208f-4ecf-b116-e3b653140ac4);
DB_CAMP_ShadowheartLaezelFight_PatchUpdate(1);
DB_BUGFIX_Marker("GUS-303815");

IF
DB_CAMP_ShadowheartLaezelFight_PatchUpdate(1)
AND
DB_GLO_CompoundFlag(_Flag, (FLAG)CAMP_ShadowheartLaezelFight_State_SeenFight_3e1cb3f3-208f-4ecf-b116-e3b653140ac4)
AND
DB_GlobalFlag(_Flag)
THEN
NOT DB_CAMP_ShadowheartLaezelFight_PatchUpdate(1);
PROC_GlobalSetFlagAndCache(_Flag);

//END_REGION GUS-303815

//REGION GUS-303246
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_DropMutingStatussesDialog(DEN_HarpyMeal_AfterHarpyEncounter_4632f7e4-5423-2308-858d-b62b3f525ca5)
THEN
DB_DropMutingStatussesDialog(DEN_HarpyMeal_AfterHarpyEncounter_4632f7e4-5423-2308-858d-b62b3f525ca5);
DB_BUGFIX_Marker("GUS-303246");
//END_REGION

//REGION GUS-301854

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_Surrender_BlockPermaDefeatedOnFlee(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
THEN
DB_Surrender_BlockPermaDefeatedOnFlee(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404);
DB_BUGFIX_Marker("GUS-301854");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(FOR_GnomeGoblin1_State_SurrenderWait_afe2158b-f792-73e7-ea12-3b4584a0adb6)
AND
NOT DB_MOO_GnomeGoblins(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, _)
AND
NOT DB_PermaDefeated(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404)
AND
NOT DB_MOO_Execution_Goblin(S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, _)
THEN
PROC_FOR_UnfortunateGnome_LeaderUnsurrender();
DB_BUGFIX_Marker("GUS-301854");

//END_REGION

//REGION GUS-301926
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-301926");
DB_QuestDef_State_ConditionalFlag((FLAG)HAG_GurHunter_Event_MentionedAstarionQuestUpdate_f9d1a178-f643-480f-bc76-86ef1145dc7c, "ORI_COM_Astarion", "MetGur_LearnedVampire", 0, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
DB_QuestDef_State_ConditionalFlag((FLAG)HAG_GurHunter_Event_MentionedAstarionQuestUpdate_f9d1a178-f643-480f-bc76-86ef1145dc7c, "ORI_COM_Astarion", "MetGur_LearnedVampire_AlreadyKnew", 1, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
//END_REGION

//REGION GUS-303396
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Camp_QueuedNight((FLAG)NIGHT_DarkUrge_MurderOfAlfira_b0e97b06-b2f8-4376-829f-23d4b4bcf78d)
AND
DB_ORI_DarkUrge_AlfiraMurderVictim(_Victim)
THEN
DB_DontCreateMurder((CHARACTER)_Victim);
DB_BUGFIX_Marker("GUS-303396");


//END_REGION

//REGION GUS-300613
// we only update the swarm groups / alarm priority if the checkpoint guards have never been in combat
// and aren't in combat currently, to avoid introducing bugs
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
NOT QRY_GLO_Bugfix_300613_CombatAtCheckpointHappened()
THEN
DB_BUGFIX_Marker("GUS-300613");
DB_GLO_Bugfix_300613_UpdateCheckpointData(1);

IF
DB_GLO_Bugfix_300613_UpdateCheckpointData(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_GLO_Bugfix_300613_UpdateCheckpointData(1);
PROC_GLO_Bugfix_300613_UpdateCheckpointData();

PROC
PROC_GLO_Bugfix_300613_UpdateCheckpointData()
THEN
NOT DB_GOB_Checkpoint_AlarmGuardPriority((CHARACTER)S_GOB_Checkpoint_Guard_001_6d69a347-9b3f-4b64-818e-013f849c6ae4);
NOT DB_GOB_Checkpoint_AlarmGuardPriority((CHARACTER)S_GOB_Checkpoint_Guard_002_022f8eb4-62ff-4770-b5b6-87eeed807f44);
RequestSetSwarmGroup((CHARACTER)S_GOB_Checkpoint_Guard_003_bbeb9839-47c5-419d-9a44-9217b9e8892f, "");
RequestSetSwarmGroup((CHARACTER)S_GOB_Checkpoint_Guard_004_a70d559c-24e3-409d-b964-34811092ecac, "");
RequestSetSwarmGroup((CHARACTER)S_GOB_Checkpoint_Guard_005_c82d1d05-0bf6-4dac-a484-e597644ed8cd, "");
SysClear("DB_GOB_Checkpoint_SwarmGroups", 1);

QRY
QRY_GLO_Bugfix_300613_CombatAtCheckpointHappened()
AND
DB_GOB_Checkpoint_Guards(_Guard)
AND
DB_Was_InCombat(_Guard, _)
THEN
DB_NOOP(1);

QRY
QRY_GLO_Bugfix_300613_CombatAtCheckpointHappened()
AND
DB_GOB_Checkpoint_Guards(_Guard)
AND
DB_Is_InCombat(_Guard, _)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUSX-12575

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8","WLD_Main_A","GUSX-12575");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUSX-12575")
AND
NOT DB_SelectedDialog(CAMP_Night2_CRD_Gale_adae2da4-11a7-2966-db5a-8342d8e64e15, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
NOT DB_ORI_Gale_DoubleOnStage(1)
AND
NOT DB_GlobalFlag(ORI_Gale_State_ShowGaleDouble_ad1aabf8-690d-4f54-a674-717b515dc08d)
AND
IsOnStage(S_ORI_GaleDouble_ddf3dd37-fa65-4351-9f55-e50b1211fcfe, 1)
THEN
PROC_Poof(S_ORI_GaleDouble_ddf3dd37-fa65-4351-9f55-e50b1211fcfe, VFX_Script_Gale_Double_Poof_01_5aec34ad-c864-c27d-1c4e-bb941014b75d);
DB_BUGFIX_Marker("GUSX-12575");

//END_REGION

//REGION GUSX-8841

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Dialog, _Flag, _, _, _)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Dialog, _Flag);
DB_BUGFIX_Marker("GUSX-8841");

//END_REGION

//REGION GUS-149425
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
GetFlag((FLAG)PLA_KarlachRecruitmentTollhouse_Event_GiveHead_d4e8a331-084c-42b7-a2b3-99e587f8679e, S_PLA_Refugee_001_a43d1d6c-d397-4d2d-adb4-ead3b10cb189, 1)
THEN
DB_BUGFIX_Marker("GUS-149425");
SetFlag((FLAG)PLA_KarlachRecruitmentTollhouse_State_AndersReceivedHead_447bda62-ee5b-3580-3003-f63690db8849, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION GUS-149425

//REGION GUS-304023

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_BUGFIX_Marker("GUS-304023")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
NOT DB_GOB_SpiderNest_SpidersHostileToFaction(_, _)
THEN
PROC_SetRelationMutual((FACTION)ACT1_GOB_SpiderNest_Spiders_153d18a3-3fc5-9b92-0039-04f8953f68a9, (FACTION)ACT1_GOB_Goblins_General_633245e8-cbb8-b0c4-12ec-32d2ff9424e2, 50);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_BUGFIX_Marker("GUS-304023")
AND
NOT DB_GOB_SpiderNest_SpidersHostileToFaction(_, _)
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT QRY_AnyPlayerInTrigger((TRIGGER)S_GOB_SpiderNest_EventTrigger_764aa320-8fd2-40f2-b6c5-fa3b82fa79ef)
THEN
PROC_SetRelation((FACTION)ACT1_GOB_Goblins_General_633245e8-cbb8-b0c4-12ec-32d2ff9424e2, (FACTION)ACT1_GOB_SpiderNest_Spiders_153d18a3-3fc5-9b92-0039-04f8953f68a9, 100);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_BUGFIX_Marker("GUS-304023")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
DB_GOB_SpiderNest_SpidersHostileToFaction(_, _)
THEN
DB_GOB_SpiderNest_GoblinsNoLikeySpidersAnymore(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_BUGFIX_Marker("GUS-304023")
THEN
DB_BUGFIX_Marker("GUS-304023");

//END_REGION

//REGION GUS-303194
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_QuestIsOpened("GLO_Tadpole")
AND
NOT DB_GlobalFlag(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec)
AND
DB_InCamp(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
PROC_GlobalSetFlagAndCache(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec);
DB_BUGFIX_Marker("GUS-303194");
//END_REGION GUS-303194

//REGION GUS-303335
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFLag((FLAG)GLO_Volo_State_AtCamp_de1cadca-2eca-4cee-a3dc-e262bbb92277)
AND
NOT DB_GlobalFLag((FLAG)GLO_Volo_State_VoloLeftCampWithNote_12ff6177-2744-4040-a4a5-6e50d3801e01)
AND
NOT DB_GlobalFLag((FLAG)GLO_Volo_State_LeftAfterOperation_fec19c09-93c5-40f3-a6e9-b242076e68bf)
AND
NOT DB_GlobalFLag((FLAG)LOW_VoloFate_State_VoloArrivedInBG_5faacb8c-836d-4626-bb7d-418c643e494d)
AND
NOT DB_InCamp(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa)
AND
IsOnStage(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,0)
THEN
PROC_Camp_SetVoloOnStageAfterEscape();

PROC
PROC_Camp_SetVoloOnStageAfterEscape()
AND
NOT DB_Camp_PlayerInBed(_,_,_)
THEN
DB_BUGFIX_Marker("GUS-303335");

PROC_SetOnStage(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,1);
PROC
PROC_Camp_SetVoloOnStageAfterEscape()
AND
DB_Camp_PlayerInBed(_,_,_)
AND
NOT DB_Camp_SetVoloOnStageAfterEscape(1)
THEN
DB_Camp_SetVoloOnStageAfterEscape(1);

PROC
PROC_LongRest()
AND
DB_Camp_SetVoloOnStageAfterEscape(1)
THEN
DB_BUGFIX_Marker("GUS-303335");
NOT DB_Camp_SetVoloOnStageAfterEscape(1);
PROC_SetOnStage(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,1);
//END_REGION

//REGION GUS-302841

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(DEN_Thieflings_Event_HideoutTrespassCrimeResolved_8778b66b-4219-878c-42ac-94b5656bf450)
AND
DB_PartOfTheTeam(_Character)
THEN
CharacterStopCrime(_Character, "DEN_HideoutKidAlarm", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-302841");

//END_REGION

//REGION GUS-303908
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
PROC_RemoveDBTrespassTrigger(S_GOB_Quartermaster_OwnershipTrigger_d7721e24-de44-4ec8-b388-522bfd5e8d79);
DB_TrespassTrigger((TRIGGER)S_GOB_Quartermaster_ForbiddenArea_bb26fde1-2c83-4ecd-8d7c-305e52666bbc,S_GOB_Quartermaster_OutStorageTrigger_e5462b9f-9c27-4cda-91ab-6117693cc156);
DB_BUGFIX_Marker("GUS-303908");
//END_REGION

//REGION GUS-303650
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Dead((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_State_Dead_90aeb953-d39f-413a-81ba-55df6672d1ca);
DB_BUGFIX_Marker("GUS-303650");
//END_REGION

//REGION GUS-302907
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_CurrentLevel("WLD_Main_A")
THEN
PROC_TriggerRegisterForPlayers(S_Tutorials_GateCombatArea_add9f8e2-e578-42eb-b1bd-859f26ab7c9b);
DB_BUGFIX_Marker("GUS-302907");
//END_REGION

//REGION GUS-303990
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GLO_HeadRemoval_NotFreshButFineDeathType(_)
THEN
NOT DB_GLO_HeadRemoval_NotFreshButFineDeathType("Electrocution");
NOT DB_GLO_HeadRemoval_NotFreshButFineDeathType("Cold");
NOT DB_GLO_HeadRemoval_NotFreshButFineDeathType("Incinerate");
DB_GLO_HeadRemoval_RestrictedDeathType("Explode");
DB_GLO_HeadRemoval_RestrictedDeathType("Chasm");
DB_GLO_HeadRemoval_RestrictedDeathType("Disintegrate");
DB_BUGFIX_Marker("GUS-303990");
//END_REGION GUS-303990

//REGION GUS-303836
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
NOT DB_GlobalFlag((FLAG)UND_State_LeaderFreedGnomes_49acb531-d0c4-d3d1-6af4-c79e246e4327)
AND
NOT DB_GlobalFlag((FLAG)UND_GnomeWorkers_State_PermaDefeated_99fa547a-d3c9-46fe-b53f-7cceb510cd6f)
AND
DB_GlobalFlag(UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
AND
DB_OnlyOnce("UND_DuergarCamp_RemoveNeutralNPCs")
THEN
PROC_UND_GnomeWorkersToPatch((CHARACTER)S_UND_GnomeWorkerSilly_e63ee5da-32cc-4574-849b-e2b61ca9586e, (DIALOGRESOURCE)UND_GnomeWorkerSilly_04c2bc70-2dac-a170-85dc-d7eb36bdd047);
PROC_UND_GnomeWorkersToPatch((CHARACTER)S_GLO_GnomeWorkerDaffy_fdaeccaa-d903-4568-ac36-a0a0ec24977d, (DIALOGRESOURCE)UND_GnomeWorkerDaffy_fae83730-13d3-892a-91b5-0dbaef3d92e7);
PROC_UND_GnomeWorkersToPatch((CHARACTER)S_UND_GnomeForeman_42abeae0-3ccd-4b02-94d7-08175b343321, (DIALOGRESOURCE)UND_GnomeForeman_a59832df-8838-e23b-3106-bb65e599f7fa);
PROC_UND_GnomeWorkersToPatch((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, (DIALOGRESOURCE)UND_TheDrowNere_FollowUp_6b0c0d3d-91b3-84af-3704-8edad589d983);
DB_BUGFIX_Marker("GUS-303836");

PROC
PROC_UND_GnomeWorkersToPatch((CHARACTER)_Gnome, (DIALOGRESOURCE)_Dialog)
AND
DB_UND_GnomeWorkers(_Gnome,_,_,_,_)
AND
NOT DB_PermaDefeated(_Gnome)
AND
DB_OffStage(_Gnome)
THEN
PROC_SetOnStage(_Gnome, 1);
DB_Dialogs(_Gnome, _Dialog);
//END_REGION GUS-303836

//REGION GUS-297338

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_DEN_CapturedGoblin_GrieflingsAndGoblin(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
DB_DEN_CapturedGoblin_GrieflingsAndGoblin(S_DEN_GrieflingFriend_c3334ee5-38dc-4197-aacc-4aa55803ff52);
DB_DEN_CapturedGoblin_GrieflingsAndGoblin(S_DEN_Griefling_7ce0afc2-e8f2-4f2e-82d8-27df98acc3d8);
DB_BUGFIX_Marker("GUS-297338");
//END_REGION

//REGION GUS-304249
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
SysActivateGoal("Act1_UND_ChestOfMundane");
DB_BUGFIX_Marker("GUS-304249");
PROC_GLO_Bugfix_304249_RestoreItems();

// if items were moved from the chest in act 3 we need to restore them
PROC
PROC_GLO_Bugfix_304249_RestoreItems()
AND
DB_UND_ChestOfMundane(_, (ITEM)_Item)
AND
IsInInventoryOf(_Item, S_UND_ChestOfMundane_fd56efe0-fbd4-471d-9661-856f732a77ef, 0)
THEN
RemoveTransforms(_Item);
//END_REGION

//REGION GUS-302142
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
DB_DEN_Thiefling_RobbedAdventurerPlayers(_Player)
AND
DB_DialogPlayers(_DialogInstance,_Player,_)
THEN
DB_BUGFIX_Marker("GUS-302142",_Player);
NOT DB_DEN_Thiefling_RobbedAdventurerPlayers(_Player);
//END_REGION

//REGION GUS-303548 - Karlach's Engine Problems NIGHT
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2 Rev 1")
AND
NOT DB_GlobalFlag((FLAG)GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c)
AND
NOT DB_GlobalFlag((FLAG)VISITEDREGION_INT_Main_A_a2e1a618-d211-484e-9389-6b37308b8da1)
THEN
DB_BUGFIX_Marker("GUS-303548");
PROC_ORI_Karlach_EngineProblemsNight();

//END_REGION GUS-303548 - Karlach's Engine Problems NIGHT

//REGION GUS-302526
PROC //partial fix and minor improvement
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_GLO_Tutorials_CampTravellerChestRoots(_)
THEN
DB_GLO_Tutorials_CampTravellerChestRoots((ITEMROOT)CONT_PlayerCampChest_A_96eab9d1-74b1-42f7-b1ad-061a9fcea8c4);
DB_GLO_Tutorials_CampTravellerChestRoots((ITEMROOT)CONT_PlayerCampChest_B_f68b5862-887c-4adf-b9f8-bb29e4d73b0f);
DB_GLO_Tutorials_CampTravellerChestRoots((ITEMROOT)CONT_PlayerCampChest_C_b5de2260-8e6b-4c2f-91eb-6f3133682a2f);
DB_GLO_Tutorials_CampTravellerChestRoots((ITEMROOT)CONT_PlayerCampChest_D_9b293d36-29f0-460c-bc81-2bdd4610a478);

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 8","WLD_Main_A","GUS-302526");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-302526")
AND
DB_GLO_Tutorials_CampTravellerChest_AllTriggers(_Trigger)
THEN
TriggerUnregisterForItems(_Trigger);

//END_REGION

//REGION GUS-303678
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_QuestIsClosed("TUT_NautiloidEscape")
THEN
QuestUpdate("TUT_NautiloidEscape", "EscapedHell");
DB_BUGFIX_Marker("GUS-303678");
//END_REGION

//REGION GUS-302468
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)GOB_HappyTorturers_Event_ClearSpearOwnership_be662c90-b121-8981-9c94-597bdfa07c56)
THEN
DB_GOB_ClearOwnershipOnTortureItems(1);

IF
DB_GOB_ClearOwnershipOnTortureItems(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-302468");
NOT DB_GOB_ClearOwnershipOnTortureItems(1);
ClearOwnership((ITEM)GOB_TorturerSpear_003_8e89b27e-2c35-4f08-a0b1-01433a72f0c8);
ClearOwnership((ITEM)WPN_GOB_Spear_A_002_e7171b5c-37cd-49cc-b3d5-daa38b4b537e);
ClearOwnership((ITEM)WPN_GOB_Spear_A_003_fb74badf-3882-49f5-bdfb-928ec66ef326);
ClearOwnership((ITEM)WPN_Torture_Club_d4a216a4-6359-4290-a682-3626f7076af3);
ClearOwnership((ITEM)TOOL_Tong_A_000_a60fbd34-0b4b-4fd4-9e8e-3f1995df33b0);
//END_REGION

//REGION GUS-303305

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
GetFaction(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (FACTION)Origin_Laezel_Hostile_5d2675e2-6d65-4292-bd4b-269fa83d9e07)
AND
IsTagged(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6, 1)
AND
DB_GlobalFlag((FLAG)CHA_LaezelRecruitment_Event_PersuadedKillLaezel_a3a395fa-8744-8e7b-0bd4-eaf0fee1736a)
AND
DB_GlobalFlag(ORI_LaezelRecruitment_Event_InvitedToCamp_5ac352a5-58c2-a8ed-1957-199d8bc284da)
AND
NOT DB_GlobalFlag((FLAG)CAMP_LaezelBeforeDream_Event_AttackedLaezel_dffe4643-709e-ac8c-ad62-450db550ca61)
AND
NOT DB_GlobalFlag((FLAG)CAMP_LaezelBeforeDream_Event_LaezelKilledPlayer_83012c3a-bce6-fd00-f1c9-51dc86eb49da)
THEN
PROC_CHA_LaeZelRecruitment_DecideOnHostileLaezel();
DB_BUGFIX_Marker("GUS-303305");

PROC
PROC_CHA_LaeZelRecruitment_DecideOnHostileLaezel()
AND
DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "CompanionHostile");

PROC
PROC_CHA_LaeZelRecruitment_DecideOnHostileLaezel()
AND
NOT DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
ClearTag(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
SetFaction(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (FACTION)Origin_Laezel_bee8449b-d682-93c8-e7da-9e4bad369476);

//END_REGION

//REGION GUS-303659
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2")
AND
DB_LevelLoadedOnce("WLD_Main_A")
THEN
DB_CampNight_CancelledBy((FLAG)NIGHT_Shadowheart_Romance1_AfterCelebration_f8193afc-a7cd-4d3c-a6d8-dd4270701d96, (FLAG)CAMP_GoblinHuntCelebration_SD_ROM_NightWithShadowheart_State_Happened_96508d74-26f3-c8a1-da78-b17c10a5ef11);
DB_BUGFIX_Marker("GUS-303659");

//END_REGION GUS-303659

//REGION GUS-304332
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-304332");
DB_DialogBlockAttackButton((DIALOGRESOURCE)GOB_WolfPens_GroupDialogWithBear_2f6674c3-e4a8-7715-4ce5-d44261ad7c10);
DB_DialogBlockTradeButton((DIALOGRESOURCE)GOB_WolfPens_GroupDialogWithBear_2f6674c3-e4a8-7715-4ce5-d44261ad7c10);
//END_REGION

//REGION GUS-185488
// DeepRothe neutral to Duergar, Duegar however allied to DeepRothe. EG: Duegar will help DeepRothe if DeepRothe are attack. But DeepRothe won't suddenly come to the aid of the Duegar if they were attacked.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-185488");
PROC_SetRelation((FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db, (FACTION)ACT1_UND_DeepRothe_f291b19a-8ede-405a-9432-95648f741bbe, 100);
//END_REGION

//REGION GUS-303127
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
AND
QRY_ORI_Karlach_ToldOrKnowsAboutDammon()
THEN
DB_BUGFIX_Marker("GUS-303127");
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("TieflingsLeft");
//END_REGION GUS-303127

//REGION GUS-292813
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-292813");

IF
DB_BUGFIX_Marker("GUS-292813")
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_BG3_SaveGamePatches("GUS-292813_Patched")
THEN
DB_BG3_SaveGamePatches("GUS-292813_Patched");
PROC_GLO_DifficultyModes_AddHPBoostedEntity(S_DEN_Gate_567055bf-ffeb-4236-8a61-e53877397fde);
PROC_GLO_DifficultyModes_AddHPBoostedEntity(S_DEN_RepairedGate_de5708cf-758e-47d2-aef7-b7d7162ba69e);
PROC_GLO_DifficultyModes_AddHPBoostedEntity(S_HAG_HagLair_MayrinaCage_29699087-a606-8430-27fb-f4a68c1c3a23);
PROC_GLO_DifficultyModes_AddHPBoostedEntity(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);
//END_REGION GUS-292813

//REGION GUS-303426
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_TriggerEvents_TriggerSet("UND_Grymforge",(TRIGGER)S_UND_DuergarCamp_SUB_05c3bf1f-29a6-437c-9a98-c1ff0ec53a53);
DB_TriggerEvents_TriggerSet("UND_Grymforge",(TRIGGER)S_CAMP_WLDDUNSHA_Area_b4c3e703-7d8a-42f0-8364-f62affef2a47);
DB_TriggerEvents_AllPlayersLeftAllTriggersInSet("UND_Grymforge","UND_Grymforge_Empty");
DB_BUGFIX_Marker("GUS-303426");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_Knows_NereIsTrapped_15aa7866-313f-fc0a-9d49-885ca83649ad)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_TriedLeavingOnce_6ac9eaf7-f778-9b2c-c6c2-884420cf1203)
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
NOT DB_GlobalFlag((FLAG)UND_TheDrowNere_Event_HadMindMeld_698b418b-a9be-b13a-6af7-a1628fedf1a3)
THEN
ClearFlag((FLAG)UND_DuergarCamp_State_TriedLeavingOnce_6ac9eaf7-f778-9b2c-c6c2-884420cf1203);
DB_BUGFIX_Marker("GUS-303426");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedDrow_9c15716b-2e73-3bde-7e1c-8580aa4b1850)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarGuards_Excavation_State_PermaDefeated_3f30c825-10f1-4fa5-84b8-073f293e6650)
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
THEN
DB_DangerZone(S_UND_DuergarCamp_SUB_05c3bf1f-29a6-437c-9a98-c1ff0ec53a53,"UND_NereConfrontation");
DB_BUGFIX_Marker("GUS-303426");

//END_REGION

//REGION GUS-300600
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GLO_HeadRemoval(_Character, _, _HeadItem)
AND
DB_Dead(_Character)
AND
NOT DB_GLO_HeadRemoval_HeadPicked(_Character)
AND
NOT QRY_GLO_HeadRemoval_CanRemoveHeadCinematic(_Character)
AND
NOT QRY_GLO_HeadRemoval_CanRemoveHeadInventory(_Character)
THEN
DB_GLO_HeadRemoval_HeadInaccessible((CHARACTER)_Character);
DB_BUGFIX_Marker("GUS-300600-A");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(UND_MyconidRevenge_State_SentKillNere_d8d606e6-d565-ed2f-bd4e-f2de1e719618)
AND
DB_GlobalFlag(UND_MyconidRevenge_State_HeadInaccessible_4623532f-89fe-4622-a57a-63f792ef4fac)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_State_KingBringer_9f4b33e2-2030-c370-d748-f8067e356623)
AND
DB_GlobalFlag(UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8)
AND
NOT DB_GlobalFlag(UND_MyconidRevenge_State_QuestCompleted_355c9984-d0fe-8de3-8337-ae2eaceb9c57)
THEN
PROC_GlobalSetFlagAndCache(UND_MyconidRevenge_State_QuestCompleted_355c9984-d0fe-8de3-8337-ae2eaceb9c57);
DB_BUGFIX_Marker("GUS-300600-B");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_GnomeHeads", "NoHead")
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_Ironhand_State_HeadInaccessible_953499fd-7a01-bafb-0a76-ed4ec25b548e);
//END_REGION GUS-300600

//REGION GUS-302389
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-302389");
DB_GlobalFlagInverter((FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_1c57cad6-408a-4adf-96a5-62468a7c0549, (FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_NotSet_b8f1fa95-6005-4e27-9a07-0043222ecdab);
PROC_GLO_Bugfix_302389();

PROC
PROC_GLO_Bugfix_302389()
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_1c57cad6-408a-4adf-96a5-62468a7c0549)
THEN
SetFlag((FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_NotSet_b8f1fa95-6005-4e27-9a07-0043222ecdab);

PROC
PROC_GLO_Bugfix_302389()
AND
DB_GlobalFlag((FLAG)MOO_BloodMerchant_State_BloodMerchantOMHappened_450f215e-ab01-4583-b62a-87542873abb3)
THEN
SetFlag((FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_NotSet_b8f1fa95-6005-4e27-9a07-0043222ecdab);

// drunk bear
PROC
PROC_GLO_Bugfix_302389()
AND
QRY_GLO_Bugfix_302389_NeedToUpdateCampNight((FLAG)NIGHT_Astarion_DrunkBear_ed0578fa-7aa8-48e0-86dd-9fa161a7971e)
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Astarion_DrunkBear_ed0578fa-7aa8-48e0-86dd-9fa161a7971e, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_DrunkBear_ed0578fa-7aa8-48e0-86dd-9fa161a7971e, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_NotSet_b8f1fa95-6005-4e27-9a07-0043222ecdab);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_DrunkBear_ed0578fa-7aa8-48e0-86dd-9fa161a7971e, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)NIGHT_Astarion_Romance1_AfterCelebration_a032c2da-0fb1-4600-a97e-2ea416c5435a);

// tasting party
PROC
PROC_GLO_Bugfix_302389()
AND
QRY_GLO_Bugfix_302389_NeedToUpdateCampNight((FLAG)NIGHT_Astarion_TastingParty_52c2c940-2645-4cf9-9991-758a579fc7bd)
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Astarion_TastingParty_52c2c940-2645-4cf9-9991-758a579fc7bd,
	(FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5,
	(FLAG)ORI_Astarion_State_InPartyWithBiteTarget_cb2eda5a-2443-4cb4-9c85-5359fd68cac2,
	(FLAG)ORI_Astarion_State_TwoTargetsForTastingPartyInCamp_03853625-f648-4162-93d5-043b86cd7e74);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_TastingParty_52c2c940-2645-4cf9-9991-758a579fc7bd,
	(FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5,
	(FLAG)ORI_Astarion_State_InPartyWithBiteTarget_cb2eda5a-2443-4cb4-9c85-5359fd68cac2,
	(FLAG)ORI_Astarion_State_TwoTargetsForTastingPartyInCamp_03853625-f648-4162-93d5-043b86cd7e74,
	(FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_NotSet_b8f1fa95-6005-4e27-9a07-0043222ecdab);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_TastingParty_52c2c940-2645-4cf9-9991-758a579fc7bd,
	(FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5,
	(FLAG)ORI_Astarion_State_InPartyWithBiteTarget_cb2eda5a-2443-4cb4-9c85-5359fd68cac2,
	(FLAG)ORI_Astarion_State_TwoTargetsForTastingPartyInCamp_03853625-f648-4162-93d5-043b86cd7e74,
	(FLAG)NIGHT_Astarion_Romance1_AfterCelebration_a032c2da-0fb1-4600-a97e-2ea416c5435a);

// mirror
PROC
PROC_GLO_Bugfix_302389()
AND
QRY_GLO_Bugfix_302389_NeedToUpdateCampNight((FLAG)NIGHT_Astarion_Mirror_8232e0bb-a97e-4eec-8b07-59d4d2cd58cd)
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Astarion_Mirror_8232e0bb-a97e-4eec-8b07-59d4d2cd58cd, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_Mirror_8232e0bb-a97e-4eec-8b07-59d4d2cd58cd, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_NotSet_b8f1fa95-6005-4e27-9a07-0043222ecdab);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_Mirror_8232e0bb-a97e-4eec-8b07-59d4d2cd58cd, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)NIGHT_Astarion_Romance1_AfterCelebration_a032c2da-0fb1-4600-a97e-2ea416c5435a);

// scar reading
PROC
PROC_GLO_Bugfix_302389()
AND
QRY_GLO_Bugfix_302389_NeedToUpdateCampNight((FLAG)NIGHT_Astarion_ScarReading_31c28982-5ef7-416d-8b77-6042545b3e68)
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Astarion_ScarReading_31c28982-5ef7-416d-8b77-6042545b3e68, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8, (FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Astarion_ScarReading_31c28982-5ef7-416d-8b77-6042545b3e68, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8, (FLAG)NIGHT_GoblinHunt_RaiderCelebration_86fee25f-1069-4f17-89fa-4c5b69f82e0b);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_ScarReading_31c28982-5ef7-416d-8b77-6042545b3e68, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8, (FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121, (FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_NotSet_b8f1fa95-6005-4e27-9a07-0043222ecdab);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_ScarReading_31c28982-5ef7-416d-8b77-6042545b3e68, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8, (FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121, (FLAG)NIGHT_Astarion_Romance1_AfterCelebration_a032c2da-0fb1-4600-a97e-2ea416c5435a);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_ScarReading_31c28982-5ef7-416d-8b77-6042545b3e68, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8, (FLAG)NIGHT_GoblinHunt_RaiderCelebration_86fee25f-1069-4f17-89fa-4c5b69f82e0b, (FLAG)ORI_Astarion_Romance1_AfterCelebration_State_QueueInvitation_NotSet_b8f1fa95-6005-4e27-9a07-0043222ecdab);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_ScarReading_31c28982-5ef7-416d-8b77-6042545b3e68, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, (FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8, (FLAG)NIGHT_GoblinHunt_RaiderCelebration_86fee25f-1069-4f17-89fa-4c5b69f82e0b, (FLAG)NIGHT_Astarion_Romance1_AfterCelebration_a032c2da-0fb1-4600-a97e-2ea416c5435a);

QRY
QRY_GLO_Bugfix_302389_NeedToUpdateCampNight((FLAG)_NightFlag)
AND
NOT DB_GlobalFlag(_NightFlag) // has not happened yet
AND
NOT DB_Camp_QueuedNight(_NightFlag) // is not happening now
AND
DB_CampNight(_NightFlag, _) // and can still happen
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-301679
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
DB_PermaDefeated(S_UND_KuoToaGod_BOOOAL_abede50d-0d73-412b-8912-c9a4b900493f)
THEN
DB_BUGFIX_Marker("GUS-301679");
DB_GLO_Bugfix_301679(1);

IF
DB_GLO_Bugfix_301679(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_GLO_Bugfix_301679(1);
PROC_GLO_Bugfix_301679(1);

PROC
PROC_GLO_Bugfix_301679(1)
AND
DB_UND_KuoToaGod_BOOOALFollowers(_Follower)
AND
HasActiveStatus(_Follower, "UND_BOOOALSERVANT", 1)
THEN
RemoveStatus(_Follower, "UND_BOOOALSERVANT");
//END_REGION

//REGION GUS-301065
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
DB_OnlyOnce("CHA_JergalRoomJournalUpdate")
AND
DB_CHA_Crypt_JergalLeftTomb(1)
AND
NOT DB_QuestIsClosed("CHA_Chapel")
AND
QRY_QuestUpdateIsUnlockedForAny("CHA_Chapel", "FoundSarcophagus_Sealed")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("CHA_Chapel", "ReadSarcophagusPlaque")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("CHA_Chapel", "OpenedSarcophagus")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("CHA_Chapel", "ConfrontJergal")
THEN
DB_BUGFIX_Marker("GUS-301065");
QuestUpdate("CHA_Chapel", "FoundSarcophagus_Opened"); //Edge-case: Update if players visited already the sarcophagus but didn't meet Jergal and he is at the camp.
//END_REGION GUS-301065

//REGION GUS-301125
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_OwnedCorpse(_Mindflayer,_SameMindflayer)
AND
_Mindflayer == S_CRA_Escape_Mindflayer_d5385cd0-f371-43dc-a0a2-50381fc50ea4
AND
_SameMindflayer == S_CRA_Escape_Mindflayer_d5385cd0-f371-43dc-a0a2-50381fc50ea4
THEN
NOT DB_OwnedCorpse(_Mindflayer,_SameMindflayer);
DB_OwnedCorpse(_Mindflayer,(CHARACTER)S_GOB_GoblinKing_11337af0-6a57-426b-a820-c4b00923dd54);
DB_BUGFIX_Marker("GUS-301125");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_OwnedCorpse(_Mindflayer,_SameMindflayer)
AND
_Mindflayer == S_GOB_Scrying_BackupMindflayer_a043a111-4a15-4d4a-ac83-5dc93bc8ee76
AND
_SameMindflayer == S_GOB_Scrying_BackupMindflayer_a043a111-4a15-4d4a-ac83-5dc93bc8ee76
THEN
NOT DB_OwnedCorpse(_Mindflayer,_SameMindflayer);
DB_OwnedCorpse(_Mindflayer,(CHARACTER)S_GOB_GoblinKing_11337af0-6a57-426b-a820-c4b00923dd54);
DB_BUGFIX_Marker("GUS-301125");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_OnlyOnce("GOB_Scrying_TeleportMindflayer")
AND
NOT DB_GlobalFlag((FLAG)GOB_GoblinKing_Event_ScryingEnded_d4740537-1b80-21d2-f2dc-cc875502139a)
AND
NOT DB_GOB_Scrying_Mindflayer(_)
THEN
DB_BUGFIX_GOB_RestoreMindflayerDB(1);

IF
DB_BUGFIX_GOB_RestoreMindflayerDB(1)
AND
DB_CurrentLevel("WLD_Main_A")
AND
IsInInventory(S_CRA_Escape_Mindflayer_d5385cd0-f371-43dc-a0a2-50381fc50ea4,0)
AND
IsInTrigger(S_CRA_Escape_Mindflayer_d5385cd0-f371-43dc-a0a2-50381fc50ea4,S_GOB_ThroneRoom_SUB_bb81678b-641c-43fc-bd41-53295d59be03,1)
THEN
DB_GOB_Scrying_Mindflayer(S_CRA_Escape_Mindflayer_d5385cd0-f371-43dc-a0a2-50381fc50ea4);
NOT DB_BUGFIX_GOB_RestoreMindflayerDB(1);
DB_BUGFIX_Marker("GUS-301125");

IF
DB_BUGFIX_GOB_RestoreMindflayerDB(1)
AND
DB_CurrentLevel("WLD_Main_A")
AND
IsInInventory(S_GOB_Scrying_BackupMindflayer_a043a111-4a15-4d4a-ac83-5dc93bc8ee76,0)
AND
IsInTrigger(S_CRA_Escape_Mindflayer_d5385cd0-f371-43dc-a0a2-50381fc50ea4,S_GOB_ThroneRoom_SUB_bb81678b-641c-43fc-bd41-53295d59be03,0)
THEN
DB_GOB_Scrying_Mindflayer(S_GOB_Scrying_BackupMindflayer_a043a111-4a15-4d4a-ac83-5dc93bc8ee76);
NOT DB_BUGFIX_GOB_RestoreMindflayerDB(1);
DB_BUGFIX_Marker("GUS-301125");

//END_REGION

//REGION GUS-305041
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)GOB_ChickenChase_State_OwlbearReplacedChicken_aabd6c48-57e4-12bb-8123-912f747f1f07)
AND
NOT DB_GlobalFlag((FLAG)GOB_ChickenChase_Event_OwlbearAcquired_775e6984-4640-41d3-97e5-b1f96c572ddd)
AND
NOT DB_PermaDefeated(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
IsInTrigger(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,S_FOR_OwlBear_LeaveAreaTrigger_beef9aac-fda9-4bc1-baad-2b2f974ba61e,1)
THEN
DB_FOR_BUGFIX_SendOwlbearCubToGOB(1);

IF
DB_FOR_BUGFIX_SendOwlbearCubToGOB(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-305041");
NOT DB_FOR_BUGFIX_SendOwlbearCubToGOB(1);
AppearAt(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, S_GOB_ChickenChase_OwlbearAppearPosition_10a6b193-be30-4094-84ac-c968d2a0e810, 0, NULL_00000000-0000-0000-0000-000000000000, "GOB_ChickenChase_Event_OwlbearCubTeleported");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)GOB_ChickenChase_State_OwlbearReplacedChicken_aabd6c48-57e4-12bb-8123-912f747f1f07)
AND
NOT DB_PermaDefeatedOrOffstage(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785)
THEN
DB_BUGFIX_Marker("GUS-305041");
Die(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 0);
TeleportTo(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, S_GOB_ChickenChase_DeadChickenPosition_b123645f-bfcb-4d49-95ce-fa106834a14e, "", 0, 0, 0);
SetOnStage(S_GOB_ChickenBall_d17d3d8e-cf4a-48cd-a5ab-de0083110785, 0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_FOR_OwlBear_GoblinsCame(1)
AND
NOT DB_PermaDefeated((CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
THEN
NOT DB_FOR_OwlBear_GoblinsCame(1);
DB_FOR_BUGFIX_OwlBear_GoblinsCame(1);

IF
DB_FOR_BUGFIX_OwlBear_GoblinsCame(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_FOR_BUGFIX_OwlBear_GoblinsCame(1);
DB_BUGFIX_Marker("GUS-305041");
PROC_FOR_OwlBear_GoblinsCome();
//END_REGION

//REGION GUS-305046
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)GOB_Torturers_State_AfterLongRest_78b07dee-8461-9d1b-028a-1e7cf8d39532)
THEN
DB_GOB_BUGFIX_TorturersRatsState(1);

IF
DB_GOB_BUGFIX_TorturersRatsState(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_GOB_BUGFIX_TorturersRatsState(1);
DB_BUGFIX_Marker("GUS-305046");
RemoveStatus(S_GOB_TorturedAdventurer_0dd6e9f1-d32d-41f1-b230-d540558e0847,"GOB_TORTURED_SCREAMING_ANIMATIONOVERRIDE");
SetFlag(GOB_Torturers_State_MovedOut_a20ec730-dfec-56a7-6cc3-71ff51e16502,CHARACTERGUID_S_GOB_Torturers_Rat_000_ccde6943-0165-4885-b888-b4e44c8054bc,0);
SetFlag(GOB_Torturers_State_MovedOut_a20ec730-dfec-56a7-6cc3-71ff51e16502,CHARACTERGUID_S_GOB_Torturers_Rat_001_720df859-7592-4f34-9000-1a2c0a313b94,0);
//END_REGION

//REGION GUS-299682
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_SavegamePatch_GUS299682(1);

IF
DB_SavegamePatch_GUS299682(1)
AND
DB_CurrentLevel("WLD_Main_A")
AND
IsDestroyed(S_PLA_EscapingZhentarim_HiddenEntrance_216fae68-3bff-486c-b32d-5bbb378d1335, 1)
AND
GetCanInteract(S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6, 0)
THEN
SetCanInteract(S_PLA_EscapingZhentarim_EntranceToCave_8a3d943f-fda7-4044-a40c-184e221d5ea6, 1);
DB_BUGFIX_Marker("GUS-299682");

IF
DB_SavegamePatch_GUS299682(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_SavegamePatch_GUS299682(1);
//END_REGION

//REGION GUS-303742

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
NOT DB_GlobalFlag((FLAG)FOR_SeluneStash_State_KnowShrineCheckSuccess_20782b30-1471-9548-3c1e-458d02d16fbb)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)S_FOR_SeluneStash_NoticeShrineTrigger_d5c8dda2-590d-4199-a06e-d12cf285ac2b);
NOT DB_KnowledgeCheckTrigger_AD("FOR_SeluneStash_NoticeShrineTrigger", (TRIGGER)S_FOR_SeluneStash_NoticeShrineTrigger_d5c8dda2-590d-4199-a06e-d12cf285ac2b, "Religion", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)FOR_SeluneStash_PAD_NoticeShrine_09eb5576-754b-a6ef-fea0-ca83704370de, (FLAG)FOR_SeluneStash_State_KnowShrineCheckSuccess_20782b30-1471-9548-3c1e-458d02d16fbb);
DB_BUGFIX_Marker("GUS-303742");

//END_REGION GUS-303742

//REGION GUS-303122
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_OnlyOnce("FOR_OwlBear_Enrage")
AND
NOT DB_Defeated(S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08)
AND
QRY_FOR_OwlbearCubOrEggDefeated()
THEN
DB_BUGFIX_Marker("GUS-303122");
SetFlag((FLAG)FOR_Owlbear_State_EnragedBecauseCubOrEggDefeated_14fd06c1-9642-4117-8f1f-fbcb9a509950);

QRY
QRY_FOR_OwlbearCubOrEggDefeated()
AND
DB_Defeated(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
THEN
DB_NOOP(1);

QRY
QRY_FOR_OwlbearCubOrEggDefeated()
AND
DB_Defeated(S_FOR_OwlBear_Egg_cac64420-e7d7-4ac2-aac9-5ed22cbe4272)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-299682
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
NOT DB_PermaDefeated(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e)
THEN
DB_SavegamePatch_GUS303616(1);

IF
DB_SavegamePatch_GUS303616(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_SavegamePatch_GUS303616(1);
SetEntityEvent(S_CHA_FL1_BanditLockpick_8409e274-4a4a-4de6-b34c-e701847ed86e, "CHA_GUS303616_ReassignSanctumDoor", 1);
DB_BUGFIX_Marker("GUS-303616");
//END_REGION

//REGION GUS-300492
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_SavegamePatch_GUS300492(1);

IF
DB_SavegamePatch_GUS300492(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_SavegamePatch_GUS300492(1);
TeleportToPosition(S_CHA_FL1_LockDownTrapSpot_5ccd0778-d5d5-4526-b36f-af4b1e48cfa9, -161.169, 20.833, -291.346, "", 0);
DB_BUGFIX_Marker("GUS-300492");
//END_REGION

//REGION GUS-304653
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
THEN
NOT DB_Achievements("BG3_Quest18",-1,"PER_USER");
DB_Achievements("BG3_Quest18",-1,"GLOBAL");
DB_BUGFIX_Marker("GUS-304653");
//END_REGION

//REGION GUS-303677
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Karlach", "Recruited_PaladinsNotDefeated")
THEN
DB_OnlyOnce("ORI_Karlach_RecruitedUpdate");
DB_BUGFIX_Marker("GUS-303677");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Karlach", "Recruited_PaladinsDefeated")
THEN
DB_OnlyOnce("ORI_Karlach_RecruitedUpdate");
DB_BUGFIX_Marker("GUS-303677");
//END_REGION GUS-303677

//REGION GUS-305717
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_PartOfTheTeam(_TeamMember)
AND
GetFlag((FLAG)PLA_KarlachRecruitment_Quest_ToldZarielFollowers_b3724866-2e00-14e2-7c7b-55b27f310a6e, _TeamMember, 1)
THEN
DB_BUGFIX_Marker("GUS-305717");
SetFlag((FLAG)PLA_KarlachRecruitmentTollhouse_Knows_RefugeesAreCultists_8b18c014-7558-4bab-aa35-37d135fc8630, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION GUS-305717

//REGION GUS-302729
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_GUS302729_MoveBoulderTrigger(1);

IF
DB_BUGFIX_GUS302729_MoveBoulderTrigger(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-302729");
NOT DB_BUGFIX_GUS302729_MoveBoulderTrigger(1);
TeleportToPosition(S_CHA_Outside_BoulderTrigger_302cbb0d-fea6-493d-b997-baa10b3e607d, 285.029, 19.58, 342.308, "", 0);
//END_REGION GUS-302729
//REGION GUS-305011
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-305011");
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_UND_NereIsTrapped_04aba7cf-62c8-4792-8d3f-680bd9f3935b,(FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_TopicalGreeting_Current((FLAG)TG_UND_NereIsTrapped_04aba7cf-62c8-4792-8d3f-680bd9f3935b)
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
THEN
DB_BUGFIX_Marker("GUS-305011");
PROC_TopicalGreeting_ClearOldTopic();

//END_REGION

//REGION GUS-305268 GUS-305256

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_QuestDef_LevelUnloading("WLD_Main_A", "DEN_Conflict", "LeftRegion")
THEN
NOT DB_QuestDef_LevelUnloading("WLD_Main_A", "DEN_Conflict", "LeftRegion");
/*   We don't need this patching
DB_QuestDef_LevelUnloading("DEN_Conflict", "LeftRegion", "WLD_Main_A");
*/
DB_BUGFIX_Marker("GUS-305268");

IF
DB_BUGFIX_Marker("GUS-305268")
AND
NOT DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_GlobalFlag((FLAG)DEN_AttackOnDen_State_DenVictory_71c7f23e-3ff1-c9b8-3ef5-d75fa1b42c8d)
AND
DB_QuestIsOpened("DEN_Conflict")
THEN
QuestUpdate("DEN_Conflict", "LeftRegion");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(DEN_AttackOnDen_State_UnderAttack_4ebba932-b9cf-41c5-b897-e77a63b93511)
AND
DB_State_Current(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_AttackOnDen")
THEN
DB_BUGFIX_Marker("GUS-305256");
PROC_SavegamePatch_GUS305256_CheckFixGrove();

PROC
PROC_SavegamePatch_GUS305256_CheckFixGrove()
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-305256");
DB_SavegamePatch_GUS305256_FixGrove(1);

PROC
PROC_SavegamePatch_GUS305256_CheckFixGrove()
AND
DB_LevelLoadedOnce("CRE_Main_A")
THEN
DB_BUGFIX_Marker("GUS-305256");
DB_SavegamePatch_GUS305256_FixGrove(1);

IF
DB_SavegamePatch_GUS305256_FixGrove(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_SavegamePatch_GUS305256_FixGrove(1);
PROC_DEN_AttackOnDen_ForceDefeat();

//END_REGION

//REGION GUS-303563
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
NOT DB_GlobalFlag((FLAG)CRA_HarperBooster_Event_RockMovable_731541b8-b2d0-4477-b0fd-132bec81e83f)
THEN
DB_BUGFIX_GUS303563_BlockInteraction(1);

IF
DB_BUGFIX_GUS303563_BlockInteraction(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-303563");
NOT DB_BUGFIX_GUS303563_BlockInteraction(1);
SetCanInteract((ITEM)S_CRA_HarperTreasureBox_89b85f26-c282-40e2-bfdc-bf0932649443, 0);
//END_REGION GUS-303563

//REGION GUS-305497

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_DialogSpeakers(_Inst,_Companion,_)
AND
DB_DialogSpeakers(_Inst,_Avatar,_SpeakerIndex)
AND
DB_ApprovalRating((CHARACTER)_Companion,(CHARACTER)_Avatar,_)
THEN
PROC_ApprovalRating_SetThresholdEvents(_Companion,_Avatar,_SpeakerIndex);
DB_BUGFIX_Marker("GUS-303563", _Companion);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
THEN
NOT DB_CampNight_Requirement_Approval(NIGHT_Gale_LearnSpell_393b05ff-d866-4115-8ece-872232ce44cf, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 30);
DB_CampNight_Requirement_Approval(NIGHT_Gale_LearnSpell_393b05ff-d866-4115-8ece-872232ce44cf, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 35);
//No patching for CRD itself, as that might lead to players being in the night (because they're already above 30), unable to trigger the CRD (because they're below 35), and thus locked out of the romance.
DB_BUGFIX_Marker("GUS-303563");

//END_REGION

//REGION GUS-303488
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_GLO_Backgrounds_ChainAfterBookClosed((ITEM)S_CHA_Crypt_BookOfRestoredGods_a480a240-b8ea-4e6a-b4b9-a8edc8fd4a3d, "Act1_Sage_BookOfTheDead")
THEN
DB_BUGFIX_Marker("GUS-303488");
NOT DB_GLO_Backgrounds_ChainAfterBookClosed((ITEM)S_CHA_Crypt_BookOfRestoredGods_a480a240-b8ea-4e6a-b4b9-a8edc8fd4a3d, "Act1_Sage_BookOfTheDead");
//END_REGION GUS-303488

//REGION GUS-304322
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_PartOfTheTeam(_Player)
AND
GetFlag(UND_TheDrowNere_GiveDagger_065e0499-3538-41f2-b849-ac541e7d89a6, _Player, 1) //There is no real nice way to know if Nere left the absolute beside if he gave the dagger
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
THEN
ClearFlag((FLAG)UND_TheDrowNere_State_WentMT_e118cea2-da4d-4a4a-a761-0dd096699a43);
PROC_GlobalSetFlagAndCache((FLAG)UND_TheDrowNere_State_LeftAbsolute_1bcd2c89-b50c-45f3-a1fb-c2a1ea3d77b9);
SetOnStage((CHARACTER)S_SHA_Necromancer_NereZombie_7e0ee67a-d2a4-48d2-bca0-a9ae373f4f75, 0);
NOT DB_SHA_Necromancer_Ghouls((CHARACTER)S_SHA_Necromancer_NereZombie_7e0ee67a-d2a4-48d2-bca0-a9ae373f4f75);
DB_BUGFIX_Marker("GUS-304322");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_GlobalFlag(UND_TheDrowNere_State_LeftAbsolute_1bcd2c89-b50c-45f3-a1fb-c2a1ea3d77b9)
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
DB_GlobalFlag(UND_TheDrowNere_Event_Leave_d12183d4-3907-4325-8913-988bb88e4377)
THEN
SetFlag((FLAG)UND_TheDrowNere_State_MentionedBalthazar_29ff0466-87ef-4342-95f0-b0b0f6db8dc8);
DB_BUGFIX_Marker("GUS-304322");
//END_REGION

//REGION GUS-302278, GUS-305809

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_TryFix("GUS-302278, GUS-305809");

IF
DB_BUGFIX_TryFix("GUS-302278, GUS-305809")
AND
DB_CurrentLevel("WLD_Main_A")
THEN
DB_BUGFIX_TryFix("GUS-302278, GUS-305809");
NOT DB_BUGFIX_Marker("GUS-302278, GUS-305809");
PROC_HAG_BugFix_GUS_302278_GUS_305809();

PROC
PROC_HAG_BugFix_GUS_302278_GUS_305809()
AND
IsOnStage(S_HAG_HagLair_IllusionWall_UndFaerieRing_Blocker_5719b68c-f30b-457f-b129-f3147ea3fc6f, 0)
THEN
Open(S_HAG_HagLair_IllusionWall_UndFaerieRing_PortalHelper_e921fcf6-c626-4a32-a200-49691dae0938);

PROC
PROC_HAG_BugFix_GUS_302278_GUS_305809()
AND
DB_HAG_HagLair_TalkingDoorFxSpamPrevent(1)
THEN
Open(S_HAG_HagLair_HelperPortal_TalkingDoor_e196ac7e-fb6b-4298-884f-7c2165eb7704);

PROC
PROC_HAG_BugFix_GUS_302278_GUS_305809()
AND
HasActiveStatus(S_HAG_HagLair_TalkingDoor_54c9fbfc-53d6-4509-a002-c1070c441611, "HAG_MASK_ILLUSION", 1)
THEN
Open(S_HAG_HagLair_HelperPortal_TalkingDoor_e196ac7e-fb6b-4298-884f-7c2165eb7704);

PROC
PROC_HAG_BugFix_GUS_302278_GUS_305809()
AND
DB_GlobalFlag(HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
Open(S_HAG_HagLair_HelperPortal_TalkingDoor_e196ac7e-fb6b-4298-884f-7c2165eb7704);

PROC
PROC_HAG_BugFix_GUS_302278_GUS_305809()
AND
DB_GlobalFlag(HAG_LairEntranceEvent_Event_DropIllusion_a5ec3b10-5876-4a19-8cc6-59fd8dc31982)
THEN
Open(S_DOORPROXY_HagFireplace_66ba8103-b253-46c7-b603-862a290a5aa0);

//END_REGION

//REGION GUS-304050
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
NOT DB_OffStage(S_UND_HarperSpy_HarperStash_e776f2aa-0a7f-40b7-a4ec-7f951c7a5724)
THEN
PROC_HidePartyMarker("UND_HarperSpy_SecretChestLocation");
DB_BUGFIX_Marker("GUS-304050");
//END_REGION

//REGION GUS-306343
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_Destroyed((ITEM)S_UND_HarperSpy_HarperStash_e776f2aa-0a7f-40b7-a4ec-7f951c7a5724)
THEN
DB_GLO_Bugfix_306343(1);
DB_BUGFIX_Marker("GUS-306343");

IF
DB_CurrentLevel(_Region)
AND
DB_GLO_Bugfix_306343(1)
AND
GetRegion(S_UND_HarperSpy_HarperStash_e776f2aa-0a7f-40b7-a4ec-7f951c7a5724, _Region)
THEN
NOT DB_GLO_Bugfix_306343(1);
SetVarInteger(S_UND_HarperSpy_HarperStash_e776f2aa-0a7f-40b7-a4ec-7f951c7a5724, "IsOneShot", 1);
//END_REGION

//REGION GUS-297397
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
THEN
DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_Romance1_AfterCelebration_c970265f-56e2-46e8-812d-06e0ac0a0fe4, (FLAG)CAMP_GoblinHuntCelebration_SD_ROM_NightWithLaezel_State_Happened_8860bafa-bdb3-2854-b664-50868c13c9a3);
DB_BUGFIX_Marker("GUS-297397");
//END_REGION

//REGION GUS-304819
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-304819");
DB_GLO_Bugfix_304819(1);

IF
DB_GLO_Bugfix_304819(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_GLO_Bugfix_304819(1);
PROC_GLO_Bugfix_304819();

PROC
PROC_GLO_Bugfix_304819()
AND
DB_UND_PetrifiedDrow_PetrifiedCreatures(_Drow, _, _, _, _, _, _, _)
AND
NOT DB_PermaDefeated(_Drow)
AND
_Drow != S_UND_PetrifiedDrow_Wizard_1f86d2de-db96-4662-a360-6ba5ad902fd7
THEN
SetTag(_Drow, (TAG)BADASSCIVILIAN_91f4b379-63a2-40e9-a509-7b9b2f90e4c8);
//END_REGION

//REGION GUS-305734
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
THEN
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_PLA_KarlachRecruitment_NoWyll_f3448ace-822c-47ca-9570-3bbc0a600f3c,(FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_PLA_KarlachRecruitment_WyllAvatar_73acd5a3-cfd4-47cb-984f-c55ecda5664c,(FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_PLA_KarlachRecruitment_WyllCompanion_d694775c-fe26-41c2-9322-337f4e63818a,(FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);
DB_BUGFIX_Marker("GUS-305734");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_TopicalGreeting_Current((FLAG)TG_PLA_KarlachRecruitment_NoWyll_f3448ace-822c-47ca-9570-3bbc0a600f3c)
AND
DB_GlobalFlag((FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2)
THEN
DB_BUGFIX_Marker("GUS-305734");
PROC_TopicalGreeting_ClearOldTopic();

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_TopicalGreeting_Current((FLAG)TG_PLA_KarlachRecruitment_WyllAvatar_73acd5a3-cfd4-47cb-984f-c55ecda5664c)
AND
DB_GlobalFlag((FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2)
THEN
DB_BUGFIX_Marker("GUS-305734");
PROC_TopicalGreeting_ClearOldTopic();

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_TopicalGreeting_Current((FLAG)TG_PLA_KarlachRecruitment_WyllCompanion_d694775c-fe26-41c2-9322-337f4e63818a)
AND
DB_GlobalFlag((FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2)
THEN
DB_BUGFIX_Marker("GUS-305734");
PROC_TopicalGreeting_ClearOldTopic();

//END_REGION

//REGION GUS-301250
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
// Lyre
SetStoryItem(S_SCL_SpidersLyre_0054e844-cc8a-4b4e-89f0-b79dafcef0e5, 1);
NOT DB_HasItemEvent((ITEM)S_SCL_SpidersLyre_0054e844-cc8a-4b4e-89f0-b79dafcef0e5, (FLAG)SCL_Drider_State_HasItem_SpidersLyre_bdffc46f-be1c-4a88-bab2-a5692a2604df);
DB_HasItemTemplateScriptFlag(1, (DIALOGRESOURCE)SCL_Drider_Caravan_HalfOrcCaster_865adfae-1b72-1ed2-f961-d55abd4fb7b1, UNI_SCL_SpidersLyre_98282bec-aeaa-4490-ae43-0c27bed58c74, 2, 1);
DB_HasItemEvent((ITEM)S_UND_TheDrowNere_SpidersLyre_a9dcae28-c5ee-497c-91bd-d510efdf6099, (FLAG)SCL_Drider_State_HasNereSpidersLyre_bdffc46f-be1c-4a88-bab2-a5692a2604df);
DB_GiveItemToEvent(S_UND_TheDrowNere_SpidersLyre_a9dcae28-c5ee-497c-91bd-d510efdf6099, (FLAG)UND_TheDrowNere_Event_GiveSpidersLyre_769a260f-9f93-4187-a535-ccc427d2babb);
ToInventory(S_UND_TheDrowNere_SpidersLyre_a9dcae28-c5ee-497c-91bd-d510efdf6099, S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, 1, 0, 0);
// Journal
NOT DB_QuestDef_State((FLAG)SCL_EntryPoint_State_GoblinInvited_bfb98886-3a98-9afa-2336-f45d045c9ce1, "GLO_Moonrise", "CaravanMetGoblin");
DB_QuestDef_State((FLAG)UND_TheDrowNere_Event_GiveSpidersLyre_769a260f-9f93-4187-a535-ccc427d2babb, "GLO_PathToMoonrise", "Underdark_NereGaveLyre");
NOT DB_QuestDef_State(DEN_AttackOnDen_State_RaiderVictory_abe1bce8-c234-4afe-a490-76210d98a078, "GLO_PathToMoonrise", "Mountain_GoblinCelebration");
NOT DB_QuestDef_State_ConditionalFlag(UND_TheDrowNere_Quest_SentToMinthara_c11385de-dd08-d0c3-0b52-49c2b80c3fe8, "GLO_PathToMoonrise", "ToldMoonrise_Nere", 1, GLO_DrowCommander_State_Dead_bf904558-1898-4d27-9526-9cef185cc9e1);
NOT DB_QuestDef_State_ConditionalFlag(UND_TheDrowNere_Quest_SentToMinthara_c11385de-dd08-d0c3-0b52-49c2b80c3fe8, "GLO_PathToMoonrise", "Mountain_NereSentToMinthara", 0, GLO_DrowCommander_State_Dead_bf904558-1898-4d27-9526-9cef185cc9e1);
NOT DB_QuestDef_State_ConditionalFlag(GLO_DrowCommander_State_Dead_bf904558-1898-4d27-9526-9cef185cc9e1, "GLO_PathToMoonrise", "Mountain_MintharaBecameUnavailable", 1, UND_TheDrowNere_Quest_SentToMinthara_c11385de-dd08-d0c3-0b52-49c2b80c3fe8);
DB_GLO_PathToMoonrise_MintharaBecameUnavailable_Patched(1);
DB_BUGFIX_Marker("GUS-301250");

IF
DB_BUGFIX_Marker("GUS-301250")
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_BUGFIX_Marker("GUS-301250-B")
AND
TemplateIsInPartyInventory(UNI_SCL_SpidersLyre_98282bec-aeaa-4490-ae43-0c27bed58c74, _Player, _Count, 0)
AND
_Count > 0
AND
DB_GlobalFlag((FLAG)SCL_Drider_State_ToldMintharaHasLyre_c0600f2e-12e8-ae1e-3e6e-dc542e97bb71)
AND
NOT DB_GlobalFlag((FLAG)SCL_Drider_State_WaitAtCaravanStart_c2414538-2e56-428e-935e-35d0b11a1ff8)
THEN
DB_BUGFIX_Marker("GUS-301250-B");
QuestUpdate("GLO_Moonrise", "CaravanGotLyre");
//END_REGION GUS-301250

//REGION GUS-302317-B
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_GlobalFlag(Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
DB_GOB_FestivSleepers_JumpTrigger(_Trigger)
THEN
PROC_TriggerRegisterForParty(_Trigger); // this may trigger for people who started new game post hotfix3 but before patch3 while the triggers were registered already, but it will not hurt anyone to do it again
DB_BUGFIX_Marker("GUS-302317-B");
//END_REGION GUS-302317-B
//REGION GUS-305073
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_CampNight_Completed((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2)
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2,(FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206, ORI_WyllConfrontation_State_DifferentUsers_45fabcc9-7d06-4ac5-a54e-12888151194e);
DB_BUGFIX_Marker("GUS-305073");

//If players are still in WLD - re-register the night, it will trigger only as fallback on leaving region, though
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_CampNight_Completed((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_GlobalFlag((FLAG)ORI_WyllConfrontation_State_ResolvedPeacefuly_fa3b8420-26bc-361d-8fbf-c6da37353446)
AND
NOT DB_GlobalFlag((FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2)
THEN
PROC_GlobalClearFlagAndCache((FLAG)CAMP_MizorasJudgement_Event_Judged_c6d2140f-312d-65d4-e66e-92de4258b3f4);
DB_CampNight((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,5260 /*6260 for avatar*/,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"WLDBAS");
//Karlach was killed
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,(FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206,(FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);
//Karlach was spared
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,(FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206, (FLAG)ORI_WyllConfrontation_State_ResolvedPeacefuly_fa3b8420-26bc-361d-8fbf-c6da37353446);
DB_CampNight_CFM((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,(DIALOGRESOURCE)CAMP_MizorasJudgement_CFM_a5324441-1d70-43a9-d4e5-45b960823d54);
DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)CAMP_MizorasJudgement_CFM_a5324441-1d70-43a9-d4e5-45b960823d54,(GUIDSTRING)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,(GUIDSTRING)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampfireMoment_OptionalSpeakers((DIALOGRESOURCE)CAMP_MizorasJudgement_CFM_a5324441-1d70-43a9-d4e5-45b960823d54,S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
//Wyll_MizorasJudgement
DB_CampNight_ForceOnLevelSwap((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"ReadyCheck_ToCrecheFromGoblinCamp",0,1);
DB_CampNight_ForceOnLevelSwap((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"ReadyCheck_ToCrecheFromPlains",0,1);
DB_CampNight_ForceOnLevelSwap((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,"ReadyCheck_ToSCLFromUnderdark",0,1);
DB_CampNight_ResurrectWhenForced((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

//Wyll_MizorasJudgement
QRY
QRY_FallbackCamp_CampNightMeetsRequirements((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasJudgement_Event_Judged_c6d2140f-312d-65d4-e66e-92de4258b3f4)
AND
NOT DB_GlobalFlag((FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2)
THEN
PROC_GlobalSetFlagAndCache(ORI_WyllConfrontation_State_ResolvedPeacefuly_fa3b8420-26bc-361d-8fbf-c6da37353446);

//Wyll_MizorasJudgement
QRY
QRY_FallbackCamp_CampNightMeetsRequirements((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasJudgement_Event_Judged_c6d2140f-312d-65d4-e66e-92de4258b3f4)
AND
DB_GlobalFlag((FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2)
THEN
DB_NOOP(1);


//If players are already past WLD - assume default peaceful resolution outcome
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_CampNight_Completed((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2)
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_CurrentLevel("WLD_Main_A")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_GlobalFlag((FLAG)ORI_Wyll_State_IsDevil_f83eee79-271b-4044-947a-d8eb699d734a)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_WyllConfrontation_State_ResolvedPeacefuly_fa3b8420-26bc-361d-8fbf-c6da37353446);
PROC_GlobalSetFlagAndCache((FLAG)ORI_Wyll_State_IsDevil_f83eee79-271b-4044-947a-d8eb699d734a);
SetTag(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,WYLL_DEVIL_5e844f0e-d822-4210-a28e-6af149a7bd4b);

//Clean lingering CampNight CRD
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0,_,_,_)
AND
NOT DB_GlobalFlag((FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2)
AND
NOT DB_GlobalFlag((FLAG)GLO_WyllConfrontation_Event_WyllConfrontedKarlach_b20ae4fa-17df-bd3d-0630-8bef82761600)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0);

//END_REGION

//REGION GUS-306001
// Hidden gnome faction fix
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
NOT DB_PermaDefeatedOrOffstage(S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e)
AND
NOT DB_GlobalFlag(UND_EscapedGnome_State_GnomeSaved_c5fe7588-a178-3d13-7303-332689b4941a)
THEN
DB_BUGFIX_Marker("GUS-306001-A");
SetFaction(S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e, (FACTION)ACT1_UND_HiddenGnome_4e4bc946-a2d8-4d11-b0f7-f8ef7f704213);
PROC_BUGFIX_30600_ForceUpdateRelation();

PROC
PROC_BUGFIX_30600_ForceUpdateRelation()
AND
DB_GlobalFlag(UND_PanicRoom_Event_GnomeSuicide_b230716c-ca7d-4a41-9980-e0c8b8655a72)
AND
NOT DB_Defeated(S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e)
AND
NOT DB_UND_PanicRoom_GnomeSuicided(1)
AND
NOT DB_InteractiveDialogSpeaker(_, S_GLO_HiddenGnome_6cacd488-c479-47a9-9a39-1cfb2bf6836e)
THEN
DB_BUGFIX_Marker("GUS-306001-B");
PROC_SetRelationToPlayers((FACTION)ACT1_UND_HiddenGnome_4e4bc946-a2d8-4d11-b0f7-f8ef7f704213, 0);

PROC
PROC_BUGFIX_30600_ForceUpdateRelation()
AND
NOT DB_BUGFIX_Marker("GUS-306001-B")
THEN
DB_BUGFIX_Marker("GUS-306001-C");
PROC_SetRelationToPlayers((FACTION)ACT1_UND_HiddenGnome_4e4bc946-a2d8-4d11-b0f7-f8ef7f704213, 50);

// Markers
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
THEN
DB_BUGFIX_306001_DoFix(1);

IF
DB_BUGFIX_306001_DoFix(1)
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_PartyMembers(_Player)
THEN
NOT DB_BUGFIX_306001_DoFix(1);
DB_BUGFIX_Marker("GUS-306001-C");
PROC_HideMarker(_Player, "UND_Smokepowder_PanicRoom"); // the book that sets this marker is next to it, no point to even have it
//END_REGION GUS-306001

//REGION GUS-306955
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-306955");
DB_GLO_Bugfix_306955(1);

IF
DB_GLO_Bugfix_306955(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_GLO_Bugfix_306955(1);
PROC_GLO_Bugfix_306955();

PROC
PROC_GLO_Bugfix_306955()
AND
DB_UND_ArcaneTurrets(_Turret, _)
AND
HasActiveStatus(_Turret, "UND_ARCANE_TURRET_DEACTIVATED", 1)
THEN
SetCanJoinCombat(_Turret, 0);
SetCanFight(_Turret, 0);
//END_REGION

//REGION GUS-307744
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
THEN
//Topicl 187 - Wyll is Devil
DB_TopicalGreeting((FLAG)TG_ORI_Wyll_IsDevil_99a1d725-805f-48c9-a0bc-e7fecfc9ce34);
DB_TopicalGreetingStartCondition_FlagSet((FLAG)TG_ORI_Wyll_IsDevil_99a1d725-805f-48c9-a0bc-e7fecfc9ce34,(FLAG)ORI_Wyll_State_IsDevil_f83eee79-271b-4044-947a-d8eb699d734a);
DB_BUGFIX_Marker("GUS-307744");

//END_REGION

//REGION GUS-306678

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-306678");

IF
DB_BUGFIX_Marker("GUS-306678")
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_BUGFIX_Marker("GUS-306678-2")
THEN
PROC_BUGFIX_306678();
DB_BUGFIX_Marker("GUS-306678-2");

PROC
PROC_BUGFIX_306678()
AND
NOT DB_KnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_Dead((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
THEN
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"PREVENT_KNOCKED_OUT",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_BUGFIX_306678()
AND
DB_KnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"KNOCKED_OUT");
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"PREVENT_KNOCKED_OUT",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
PROC_CrimeTryForceStopDialog((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
NOT DB_DEN_HagTrader_LeaveSpeed("Walk");
DB_DEN_HagTrader_LeaveSpeed("Run");
PROC_TryStartAD((DIALOGRESOURCE)DEN_HagTrader_AD_Flee_5c058817-e0e5-883d-857a-4440a7749c49, (CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_CharacterDisableAllCrimes(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_GlobalSetFlagAndCache((FLAG)DEN_HagTrader_State_LeaveDen_a203db46-2bac-4590-8d0b-13acafedc92e); // flagType: Global
PROC_DEN_HagTrader_TransferShop();

PROC
PROC_BUGFIX_306678()
AND
DB_KnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_Act1_HAG_HagSpawn_Init(1)
AND
NOT DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
THEN
PROC_BUGFIX_306678_RestoreQuestInHAG();

PROC
PROC_BUGFIX_306678()
AND
DB_Dead((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_Act1_HAG_HagSpawn_Init(1)
AND
NOT DB_State_Current(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HagTea","TraderAtDen")
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"KNOCKED_OUT");
PROC_BUGFIX_306678_RestoreQuestInHAG();

PROC
PROC_BUGFIX_306678_RestoreQuestInHAG()
THEN
PROC_HAG_TeaSceneOver();

PROC
PROC_BUGFIX_306678_RestoreQuestInHAG()
AND
DB_Dead((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
DB_SpotPlayers((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8, "HAG_HagLair_MaskedVictim01", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_CustomRadius((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8, "HAG_HagLair_MaskedVictim01", 9.5);


PROC
PROC_BUGFIX_306678_RestoreQuestInHAG()
AND
QRY_QuestUpdateIsUnlockedForAny("HAG_HagSpawn", "SavedMayrina")
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07, 1)
THEN
SetHasDialog(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, 0);
PROC_CharacterMoveTo(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagLair_DoublesSpawnPoint_004_bf2efd3b-0fc8-4239-ba6d-dfc57c9662a5, "Walk", "HAG_SurrogateMother_AppearAtResurrection_Safe");

PROC
PROC_BUGFIX_306678_RestoreQuestInHAG()
AND
QRY_QuestUpdateIsUnlockedForAny("HAG_HagSpawn", "SavedMayrina")
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07, 0)
AND
GetDistanceTo(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_Resurrection_MotherPos_36560fcb-e9e7-40f0-8112-2191e4277b6d, _Dist)
AND
_Dist > 33
THEN
PROC_DisappearOutOfSightTo(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_Resurrection_MotherPos_36560fcb-e9e7-40f0-8112-2191e4277b6d, "Walk", 0, "HAG_SurrogateMother_AppearAtResurrection");

PROC
PROC_BUGFIX_306678_RestoreQuestInHAG()
AND
QRY_QuestUpdateIsUnlockedForAny("HAG_HagSpawn", "SavedMayrina")
AND
IsInTrigger(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_HagLair_f84e3319-4a1d-483c-a718-dee3bff70d07, 0)
AND
GetDistanceTo(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, S_HAG_Resurrection_MotherPos_36560fcb-e9e7-40f0-8112-2191e4277b6d, _Dist)
AND
_Dist <= 33
THEN
SetEntityEvent(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, "HAG_SurrogateMother_AppearedAtResurrection");


PROC
PROC_BUGFIX_306678_RestoreQuestInHAG()
AND
DB_GlobalFlag(HAG_Hagspawn_Quest_PromisedBaby_94408504-f658-9616-97ac-d610ecb1f639) // flagType: Global
THEN
SetFlag((FLAG)HAG_Hagspawn_Knows_SurrogatePromisedBaby_74c25c6c-d82c-5e0b-3949-900162a76781, NULL_00000000-0000-0000-0000-000000000000, 0); // flagType: Global

PROC
PROC_BUGFIX_306678_RestoreQuestInHAG()
AND
DB_GlobalFlag(HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
SetCanInteract(S_HAG_HusbandGrave_11f47099-24f3-4e40-b905-c45c55fd46a6, 1);
PROC_SetInvulnerable(S_HAG_HusbandGrave_11f47099-24f3-4e40-b905-c45c55fd46a6, 0);
SetOnStage(S_HAG_HusbandForcefield_9b9f7ce6-5cd9-49a8-8cd7-57f661bde17f, 0);


//END_REGION


//REGION GUS-307699

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_GLO_MonitorIntro_HadIntro(1)
AND
DB_OnlyOnce("FOR_Monitor_MonitorVanish")
AND
NOT DB_GLO_Monitor_DismissToCamp(1)
THEN
PROC_GLO_MonitorIntro_FixRaphaelIntro();

PROC
PROC_GLO_MonitorIntro_FixRaphaelIntro()
AND
DB_GLO_MonitorAppear_Requirement(_)
AND
QRY_OnlyOnce("GLO_MonitorIntro_FixRegisteredTriggers")
THEN
PROC_GLO_MonitorAppearUnregisterAll();

PROC
PROC_GLO_MonitorIntro_FixRaphaelIntro()
AND
IsOnStage(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 1)
THEN
PROC_GLO_Monitor_Poof();

//END_REGION

//REGION GUS-307253
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("307523");
DB_GLO_Bugfix_307523(1);

IF
DB_GLO_Bugfix_307523(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
NOT DB_GLO_Bugfix_307523(1);
PROC_GLO_Bugfix_307523();

// S_UND_DarkLake_BoatPositionAtCamp is not the default position of the boat, but close enough for comparison
PROC
PROC_GLO_Bugfix_307523()
AND
GetDistanceTo(S_UND_EbonLake_RaftAtCamp_FullRaft_eec3661a-7173-48c2-8793-2970d2c9618d, S_UND_DarkLake_BoatPositionAtCamp_d4cf00f1-941b-40aa-b81c-0d1c9edefec0, _Dist)
AND
_Dist > 2.0
THEN
TeleportToPosition(S_UND_EbonLake_RaftAtCamp_FullRaft_eec3661a-7173-48c2-8793-2970d2c9618d, -632.206, 0.369, 407.278, "", 0, 0, 0, 0, 0);
//END_REGION

//REGION GUS-306546
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
DB_GOB_FestivSleepers_CanReactToNoise(_Character)
THEN
DB_BUGFIX_Marker("GUS-306546");
DB_CustomDialogRange(_Character,20);
//END_REGION

//REGION GUS-303154
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
THEN
NOT DB_GLO_Backgrounds_ChainAfterDialogEndedWithGlobalFlag(HAG_ForestIllusion_Illusioncheck_ad27b62d-9b83-dd71-4298-1a29a73b69bd, HAG_ForestIllusion_Event_DropIllusion_c8a36ee5-68eb-a944-8295-55188d026506, "Act1_Outlander_HagIllusion");
DB_GlobalFlagReactionAfterDialog(HAG_ForestIllusion_Event_DropIllusion_c8a36ee5-68eb-a944-8295-55188d026506, HAG_ForestIllusion_Illusioncheck_ad27b62d-9b83-dd71-4298-1a29a73b69bd);
DB_BUGFIX_Marker("GUS-303154");
//END_REGION GUS-303154

//REGION GUS-308004
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_CampNight_Completed((FLAG)NIGHT_WyllConfrontation_2576ba4e-90a9-4da0-bb40-6f012ed4a888)
AND
NOT DB_GlobalFlag((FLAG)GLO_WyllConfrontation_Event_WyllConfrontedKarlach_b20ae4fa-17df-bd3d-0630-8bef82761600)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasJudgement_Event_Judged_c6d2140f-312d-65d4-e66e-92de4258b3f4) //Always happens on leaving WLD_Main, unless triggered before (which also means confrontation is no longer needed)
THEN
DB_CampNight((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8, 8010);
DB_CampNight_ExclusiveMoment((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8);
DB_CampNight_Camp((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,"WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,"WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,"WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,"WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,"WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,"WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,"WLDBAS");
DB_CampNight_Requirement((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8, (FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206, (FLAG)KARLACHCOMPANION_c97e0ee2-e8f1-4593-95ed-1e32a08b146d, (FLAG)ORI_WyllConfrontation_State_CampMomentCanTrigger_649f5b59-54c5-4107-a482-3ea5b2758d60);
DB_CampNight_Requirement_SameUser((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_CampNight_CancelledBy((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,(FLAG)ORI_WyllConfrontation_State_ResolvedPeacefuly_fa3b8420-26bc-361d-8fbf-c6da37353446);
DB_CampNight_Cancels((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,(FLAG)NIGHT_WyllConfrontation_NotRecruited_b35ff12a-ceae-4bf8-94e2-5050576e4d6e);
DB_CampNight_IVB((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8, (VOICEBARKRESOURCE)CAMP_WyllConfrontation_IVB_4d3b59af-491b-9326-4024-421e9a375ced,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampNight_CRD((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0);
DB_BUGFIX_Marker("GUS-308004");

IF
DB_Camp_QueuedNight((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8)
AND
QRY_ORI_KarlachOrWyllInCampPatch()
THEN
DB_NOOP(1);

QRY
QRY_ORI_KarlachOrWyllInCampPatch()
AND
GetReservedUserID(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,-65536)
AND
NOT GetReservedUserID(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,-65536)
THEN
NOT DB_CampNight_IVB((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8, (VOICEBARKRESOURCE)CAMP_WyllConfrontation_IVB_4d3b59af-491b-9326-4024-421e9a375ced,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampNight_IVB((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8, (VOICEBARKRESOURCE)CAMP_WyllConfrontation_IVB_4d3b59af-491b-9326-4024-421e9a375ced,(CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

QRY
QRY_ORI_KarlachOrWyllInCampPatch()
AND
GetReservedUserID(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,-65536)
AND
NOT GetReservedUserID(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,-65536)
THEN
NOT DB_CampNight_IVB((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8, (VOICEBARKRESOURCE)CAMP_WyllConfrontation_IVB_4d3b59af-491b-9326-4024-421e9a375ced,(CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_CampNight_IVB((FLAG)NIGHT_WyllConfrontationPatch_cf3af9b1-557b-4f88-860a-31fbd9a8c3e8, (VOICEBARKRESOURCE)CAMP_WyllConfrontation_IVB_4d3b59af-491b-9326-4024-421e9a375ced,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

//END_REGION

//REGION GUS-300821
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelLoadedOnce("CRE_Main_A")
AND
NOT DB_GlobalFlag(DEN_Hideout_Event_TurnedKidsHostile_17cfabeb-f1d7-9432-0e29-5aecfcef1a18)
AND
DB_GlobalFlag(DEN_Thieflings_Event_PlayerRobbed_ec548492-a88e-ae81-ca4d-7970d804ec5b)
THEN
DB_DEN_Thieflings_LooseStash_DefaultItems((ITEM)S_DEN_Thieflings_Stash_Shield_d705df85-f41e-404e-82a1-fa8858e5d08d);
DB_DEN_Thieflings_LooseStash_DefaultItems(S_DEN_Thieflings_Stash_Cup_a8840bc3-f728-448b-97f4-d365103c3d1e);
DB_DEN_Thieflings_LooseStash_DefaultItems(S_DEN_Thieflings_Stash_Bear_515f163b-7bbe-49c6-bb63-94a619f3a330);
DB_DEN_Thieflings_LooseStash_DefaultItems(S_DEN_Thieflings_Stash_Bottle_00bcdaca-7174-409a-b22c-3003d1987d47);
DB_DEN_Thieflings_LooseStash_DefaultItems(S_DEN_Thieflings_Stash_Plate_0d74a2ad-5314-407d-be23-37c9835513be);
DB_DEN_Thieflings_LooseStash_DefaultItems(S_DEN_Thieflings_Stash_Pouch_5b5a68bd-4f54-48d7-a011-a4ea0f38cde2);
PROC_DEN_Thieflings_LooseStash_PatchCheck();

PROC
PROC_DEN_Thieflings_LooseStash_PatchCheck()
AND
DB_DEN_Thieflings_LooseStash(_ItemInStash)
AND
NOT DB_DEN_Thieflings_LooseStash_DefaultItems(_ItemInStash)
AND
NOT DB_DEN_Thieflings_StolenItems(_, _ItemInStash, _)
AND
ItemGetGoldValue(_ItemInStash, _Value)
THEN
DB_DEN_Thieflings_StolenItems(S_DEN_Pickpocket_540ddc1f-42c6-4347-ba03-b3cf3d3942ab, _ItemInStash, _Value);
DB_BUGFIX_Marker("GUS-300821");

PROC
PROC_DEN_Thieflings_LooseStash_PatchCheck()
AND
DB_DEN_Thieflings_LooseStash_DefaultItems(_Item)
THEN
NOT DB_DEN_Thieflings_LooseStash_DefaultItems(_Item);
//END_REGION GUS-300821

//REGION GUS-302026
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
THEN
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Known_Talked", "LearnedHalsin");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Unknown_Talked", "LearnedHalsin");
DB_GLO_Halsin_StartingEntries("HalsinAtGrove_Known_Asharak");
DB_GLO_Halsin_StartingEntries("HalsinAtGrove_Known_Cerys");
DB_GLO_Halsin_StartingEntries("HalsinAtGrove_Unknown_Asharak");
DB_GLO_Halsin_StartingEntries("HalsinAtGrove_Unknown_Cerys");
DB_GLO_Halsin_StartingEntries("HalsinAtGrove_Known_Talked");
DB_GLO_Halsin_StartingEntries("HalsinAtGrove_Unknown_Talked");
DB_GLO_TadpoleQuest_Druid_HalsinLeaderEntries(NULL_00000000-0000-0000-0000-000000000000, "HalsinAtGrove", 1, "HalsinAtGrove_Known_Talked");
DB_GLO_TadpoleQuest_Druid_HalsinLeaderEntries(NULL_00000000-0000-0000-0000-000000000000, "HalsinAtGrove", 0, "HalsinAtGrove_Unknown_Talked");
DB_GLO_TadpoleQuest_Druid_HalsinLeaderEntries(NULL_00000000-0000-0000-0000-000000000000, "HalsinSentToRath", 0, "HalsinSentToRath_Talked");
NOT DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Known_Talked", "LearnedHalsin");
NOT DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Unknown_Talked", "LearnedHalsin");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Unknown_Talked", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Known_Talked", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_BUGFIX_Marker("GUS-302026");
//END_REGION GUS-302026

//REGION GUS-300821
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_QuestDef_State((FLAG)PLA_KarlachRecruitmentTollhouse_Event_CorpseToldZarielFollowers_92a42412-66f7-f6df-6006-6cd6ae45acf9, "PLA_PaladinsOfTyr", "LearntZarielFollowers_Corpse");
//END_REGION

//REGION GUS-305774
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_DEN_Thieflings_HideoutKids((CHARACTER)_Child)
AND
NOT DB_InRegion(_Child, (TRIGGER)S_DEN_Hideout_SUB_8016de65-4be3-4083-960f-4d14a7455d4b)
THEN
DB_BUGFIX_Marker("GUS-305774");
PROC_CharacterDisableCrime(_Child, "DEN_WaitForMol");
//END_REGION

//REGION GUS-299863
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
DB_GlobalFlag(DEN_ShadowDruid_State_KaghaKnowsZevlorDead_03d8e7f5-28b0-fd4f-b752-36a779543c04)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("DEN_Conflict", "MetKagha_ZevlorDead")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("DEN_Conflict", "ToldKaghaZevlorDead_After")
THEN
QuestUpdate("DEN_Conflict", "ToldKaghaZevlorDead_After");
DB_BUGFIX_Marker("GUS-299863");
//END_REGION GUS-299863

//REGION GUS-308150
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
Exists(S_FOR_Courier_Ball_c9602f79-27a8-4f79-b0f2-3aba300bd80f, 1)
THEN
PROC_SavegamePatch_GUS308150();
DB_BUGFIX_Marker("GUS-308150");

PROC
PROC_SavegamePatch_GUS308150()
THEN
SetStoryItem(S_FOR_Courier_Ball_c9602f79-27a8-4f79-b0f2-3aba300bd80f, 1);

PROC
PROC_SavegamePatch_GUS308150()
THEN
PROC_FOR_CourierDog_ReturnBallCheck();

//END_REGION

//REGION GUS-307870
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
QRY_GLO_Bugfix_307870_NeedToUpdateCombatGroup()
THEN
DB_BUGFIX_Marker("GUS-307870");
IterateCharactersAround(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, 50.0, "GLO_Bugfix_307870_CharacterIterated", "");

QRY
QRY_GLO_Bugfix_307870_NeedToUpdateCombatGroup()
AND
DB_Was_InCombat(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _CombatID)
THEN
DB_NOOP(1);

QRY
QRY_GLO_Bugfix_307870_NeedToUpdateCombatGroup()
AND
DB_Is_InCombat(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, _CombatID)
THEN
DB_NOOP(1);

IF
EntityEvent(_Zombie, "GLO_Bugfix_307870_CharacterIterated")
AND
HasActiveStatus(_Zombie, "UND_LONEDUERGAR_ZOMBIE", 1)
THEN
SetCombatGroupID(_Zombie, "147151c3-c960-029b-9505-e87a334fa0fc");
//END_REGION

//REGION GUS-308303
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
NOT DB_GLO_Halsin_WildshapeSpells("Shout_DEN_Halsin_WildShape_Bear", "GOB_WolfPens_WILDSHAPE_BEAR_4")
THEN
DB_GLO_Halsin_WildshapeSpells("Shout_DEN_Halsin_WildShape_Bear", "GOB_WolfPens_WILDSHAPE_BEAR_4");
DB_BUGFIX_Marker("GUS-308303");

//Checks if Halsin needs his Follower dialog reset to Elf-form version if currently following
IF
DB_BUGFIX_Marker("GUS-308303")
AND
HasActiveStatus(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "GOB_WolfPens_WILDSHAPE_BEAR_4", 0)
AND
IsPartyFollower(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1)
AND
DB_Dialogs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_Halsin_Following_4c8c0646-03ab-6449-15be-a8a32a31da49)
THEN
PROC_RemoveDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_Halsin_Following_Elf_26317dd0-f609-1b72-27d0-602d4b3e1013);

//END_REGION GUS-308303

//REGION GUS-288123
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","WLD_Main_A","GUS-288123");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-288123")
AND
NOT DB_PermaDefeated(S_GOB_VoloGuard_c25f0e79-b9f7-453c-8138-964bca267d93)
THEN
SetTag(S_GOB_VoloGuard_c25f0e79-b9f7-453c-8138-964bca267d93,(TAG)AGGRESSIVE_GUARD_9753e2e5-34be-48d5-bf05-c6ae9a616f3b);
//END_REGION

//REGION GUS-306161
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","WLD_Main_A","GUS-306161");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-306161")
THEN
DB_ShovelArea((ITEM)S_HAG_BuriedMound_03_7ddd8253-a568-4a19-adbe-0e48f6ca7934,(ITEM)S_HAG_BuriedChest_03_4a6d940c-e6e6-484a-ae4a-0725de09ad22);
//END_REGION GUS-306161

//REGION GUS-306633
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "WLD_Main_A", "GUS-306633");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-306633")
AND
NOT DB_PermaDefeated(S_PLA_Refugee_001_a43d1d6c-d397-4d2d-adb4-ead3b10cb189)
THEN
PROC_SetAnubisConfig((CHARACTER)S_PLA_Refugee_001_a43d1d6c-d397-4d2d-adb4-ead3b10cb189, "PLA_Refugee_001");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-306633")
AND
NOT DB_PermaDefeated(S_PLA_Refugee_002_97ae38c5-550d-4585-9f9e-a0494ecb863a)
THEN
PROC_SetAnubisConfig((CHARACTER)S_PLA_Refugee_002_97ae38c5-550d-4585-9f9e-a0494ecb863a, "PLA_Refugee_002");
//END_REGION GUS-306633

//REGION GUS-308937
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "WLD_Main_A", "GUS-308937");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-308937")
AND
DB_InRegion(_Player, (TRIGGER)S_FOR_ThayanCellar_DangerZone_5978a2ae-581a-4063-a953-f0713aca5bbe)
AND
DB_Players(_Player)
AND
QuestIsAccepted(_Player, "FOR_DangerousBook", 1)
THEN
QuestUpdate(_Player, "FOR_DangerousBook", "SearchLabAfterJournal");
//END_REGION GUS-308937

//REGION GUS-303079

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_GlobalFlag(CHA_LaezelRecruitment_State_Freed_0fe8e284-83a6-c1ad-9f18-20ed58985cf0)
AND
DB_InRegion(_Player, S_CHA_LaezelProximityBox_5ddb309f-8ceb-4517-8465-16e5c850faf8)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("CHA_LaezelRecruitment_SetSpotting")
THEN
DB_BUGFIX_Marker("GUS-303079");
PROC_CHA_LaezelRecruitment_SetSpotting();

//END_REGION

//REGION GUS-306444
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag(UND_InjuredGnome_State_SporeServant_4a1d7911-e00d-4e32-8dff-3352a0a7af63)
AND
NOT DB_PermaDefeated(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "WLD_Main_A", "GUS-306444");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-306444")
AND
DB_UND_MyconidCircle_CurrentSovereign((CHARACTER)_Sovereign)
AND
GetFaction(_Sovereign, _Faction)
THEN
SetFaction(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, _Faction);
//END_REGION GUS-306444


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
DB_SceneManager(_, "CHA_OutsideBandit")
AND
NOT DB_BUGFIX_Marker("GUS-300659")
THEN
DB_BUGFIX_Marker("GUS-300659");
DB_SceneAllowAllDisturbances("CHA_OutsideBandit");

//REGION GUS-310018

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "WLD_Main_A", "GUS-310018");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-310018")
THEN
TeleportToPosition(S_PLA_ZhentDungeon_EntityEvent_Out1_13578a83-1886-440e-b427-bdffca6eeb48, 293.303, 24.305, -277.79, "", 0, 0, 0, 0, 0);
TeleportToPosition(S_PLA_ZhentDungeon_EntityEvent_Out2_0f4fb5c7-3bd2-4290-9277-db80e29bd2c8, 291.733, 24.452, -278.119, "", 0, 0, 0, 0, 0);

//END_REGION

//REGION GUS-288557

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-288557");
PROC_SetRelation((FACTION)ACT1_DEN_CapturedGoblin_40d6a49e-806c-4bce-8214-6228cc0ded72, (FACTION)ACT1_GOB_BattleStations_55f55a92-c2bf-4d69-a9aa-03f1178e5812, 100);

//END_REGION

//REGION GUS-306028
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_FOR_Courier_Fetch_Tags((TAG)WEIGHT_TINY_9360d001-0cef-49e0-a2e0-4d715d4976ea);
DB_FOR_Courier_Fetch_Tags((TAG)SCRATCH_FETCH_31d621af-5add-48a5-9afa-3c3156ba7171);
DB_BUGFIX_Marker("GUS-306028");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_FOR_CourierDog_IsFetching(_Player, _Scratch)
THEN
NOT DB_FOR_CourierDog_IsFetching(_Player, _Scratch);
//END_REGION GUS-306028

//REGION GUS-309252
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("FOR_IncompleteMasterwork_JournalPatch")
THEN
PROC_IncompleteMasterwork_UpdateJournalReward(_Player);
DB_BUGFIX_Marker("GUS-309252");

//END_REGION GUS-309252

//REGION GUS-309129
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Players(_Player)
AND
GetFlag((FLAG)FOR_DangerousBook_State_BookOwner_06022678-24ed-35af-de93-bd91abc02452, _Player, 1)
AND
IsDestroyed(S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507, 0)
AND
GetDirectInventoryOwner(S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507, _InventoryOwner)
AND
NOT DB_Players((CHARACTER)_InventoryOwner)
THEN
DB_FOR_DangerousBook_MoveTome(_Player); // will trigger book to get moved to player inventory after status is removed.
RemoveStatus(S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507, "FOR_DANGEROUSBOOK_BOUNDTO", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-309129");
//END_REGION GUS-309129

//REGION GUS-309751

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag(DEN_CapturedGoblin_State_LeftDen_2a64c50f-45b6-8bd2-e980-77fb4b11fce3)
AND
DB_DEN_NPC((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_,_)
THEN
PROC_DEN_RemoveFromDenNPCs((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
DB_BUGFIX_Marker("GUS-309751");

//END_REGION GUS-309751


//REGION GUS-308544
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_HAG_Hag_DroppedIllusionInCombat(_ID)
AND
NOT DB_Is_InCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
AND
IsActive(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 1)
THEN
DB_BUGFIX_Marker("GUS-308544-0");
SetEntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "GLO_CancelCombatWait", 1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_HAG_Hag_DroppedIllusionInCombat(_ID)
AND
NOT DB_Is_InCombat((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, _ID)
AND
IsActive(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 0)
THEN
DB_BUGFIX_Marker("GUS-308544");

IF
Activated(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_BUGFIX_Marker("GUS-308544")
THEN
NOT DB_BUGFIX_Marker("GUS-308544");
DB_BUGFIX_Marker("GUS-308544-1");
SetEntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "GLO_CancelCombatWait", 1);

//END_REGION GUS-308544

//REGION GUS-145784
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "WLD_Main_A", "GUS-145784");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-145784")
THEN
TeleportToPosition((TRIGGER)S_PLA_ZhentDungeon_Zhent08_Rope01_5c01c1f8-a297-4e82-a1fc-bdf5d3f5cab9, 286.97, -4.919, -198.796, "", 0);
TeleportToPosition((TRIGGER)S_PLA_ZhentDungeon_Zhent08_Rope02_28cbafac-9d4c-431c-985e-90d26801fdb0, 283.399, -4.837, -196.85, "", 0);
//END_REGION GUS-145784


//REGION GUS-307213

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GLO_Tadpole_Apprentice_AntidoteFix")
AND
QuestUpdateIsUnlocked(_Player, "GLO_Tadpole", "LearnedCureDaleland", 0)
THEN
PROC_DEN_Apprentice_AntidoteFix(_Player);
DB_BUGFIX_Marker("GUS-307213");

PROC
PROC_DEN_Apprentice_AntidoteFix((CHARACTER)_Player)
THEN
NOT DB_QuestDef_BookReadState("GLO_Tadpole", "LearnedCureDaleland", (ITEM)S_DEN_AntidoteRecipeBook_6557e2a7-ee82-4c5a-a26b-9056e4eb03df);

PROC
PROC_DEN_Apprentice_AntidoteFix((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "GLO_Tadpole", "PoisonedByApprentice", 1)
AND
HasRecipeUnlocked(_Player, "ALCH_Potion_Antidote_Mugwort", 1)
THEN
QuestUpdate("GLO_Tadpole", "LearnedCureDaleland");

//END_REGION

//REGION GUS-306920
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_ForceRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9);
DB_ForceRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_GOB_GoblinKing_11337af0-6a57-426b-a820-c4b00923dd54);
DB_BUGFIX_Marker("GUS-306920");
//END_REGION GUS-306920

//REGION
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_DropMutingStatussesDialog((DIALOGRESOURCE)PLA_GithChokepoint_Confrontation_81aa25b6-850b-16bf-81c9-68c19208db5e);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)PLA_GithChokepoint_OM_Laezel_COM_f2710677-54ec-4c88-ea70-df755e0f730f);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)PLA_GithChokepoint_OM_Laezel_AOM_OOM_af67b6d8-d1a0-61f9-e74b-a3535279cb94);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)PLA_GithChokepoint_ConfrontationLaezel_dfb80d70-8cfe-1a55-bae7-826f164def60);
//END_REGION

//REGION GUS-304610

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(DEN_Hideout_Event_BefriendedThieflings_a1a932ee-f66a-08af-4bf0-bf77790052f7)
THEN
PROC_RemoveDBTrespassTrigger(S_DEN_Thieflings_HideoutCrimeRegion_5e96478b-d5df-41d3-a20e-4ae522f75144, NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(DEN_Hideout_Event_TurnedKidsHostile_17cfabeb-f1d7-9432-0e29-5aecfcef1a18)
THEN
PROC_RemoveDBTrespassTrigger(S_DEN_Thieflings_HideoutCrimeRegion_5e96478b-d5df-41d3-a20e-4ae522f75144, NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(DEN_Hideout_Event_LeaveCountdown_e51c07b5-b27b-0614-c38e-feebb0d28f2a)
THEN
PROC_RemoveDBTrespassTrigger(S_DEN_Thieflings_HideoutCrimeRegion_5e96478b-d5df-41d3-a20e-4ae522f75144, NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(DEN_Hideout_State_GivenWarning_0abd66e5-6337-025e-6def-a5d456e5e310)
THEN
PROC_RemoveDBTrespassTrigger(S_DEN_Thieflings_HideoutCrimeRegion_5e96478b-d5df-41d3-a20e-4ae522f75144, NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925);

//END_REGION

//REGION GUS-310078
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-310078");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-310078")
THEN
DB_CampNight_CancelledBy((FLAG)NIGHT_AstarionHungerC_SneakOff_c048cfa0-1459-4d26-931a-5b063ca6719e, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
DB_CampNight_CancelledBy((FLAG)NIGHT_AstarionHungerC_Bite_fe3fd3a0-70d1-4bc4-8a7f-4614f89ac23d, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
//END_REGION

//REGION GUS-309139
//If the player is currently not in the chokepoint combat (with enemies from the chokepoint combat group), and they still have the combatgroup ID, remove it.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
NOT QRY_PlayerIsInCombatWithCombatGroup("fc52998f-783d-b3ab-e533-bc914db98c7a")
AND
DB_PLA_GithChokepoint_Interrupted(_Player)
AND
GetCombatGroupID(_Player, "fc52998f-783d-b3ab-e533-bc914db98c7a")
THEN
NOT DB_PLA_GithChokepoint_Interrupted(_Player);
SetCombatGroupID(_Player, "");
DB_BUGFIX_Marker("GUS-309139");

QRY
QRY_PlayerIsInCombatWithCombatGroup((STRING)_GroupID)
AND
DB_Players(_Players)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
DB_Is_InCombat(_Others, _CombatID)
AND
NOT DB_Players((CHARACTER)_Others)
AND
GetCombatGroupID(_Others, _GroupID)
THEN
DB_NOOP(1);
//END_REGION GUS-309139


//REGION GUS-309377
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-309377");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-309377")
THEN
DB_CampNight_CancelledBy((FLAG)NIGHT_Astarion_Romance1_AfterCelebration_a032c2da-0fb1-4600-a97e-2ea416c5435a, (FLAG)CAMP_GoblinHuntCelebratrion_SD_ROM_NightWithAstarion_State_Happened_3d7ec52b-fc71-a510-770e-3e27f2235f0d);
//END_REGION

//REGION GUS-301351
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-301351");

// saved during combat - simply call the proc, it will do everything
PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-301351")
AND
DB_GOB_DrunkGoblin_FistFightId(_)
THEN
PROC_GOB_DrunkGoblin_SetPreventPermaDefeatedAfterKnockOut();

// saved during combat or after combat with some (all) of the goblins broken (alive, but in DB_PermaDefeated)
PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-301351")
AND
QRY_GLO_Bugfix_301151_AnyGoblinIsBroken()
THEN
PROC_GLO_Bugfix_301351_FixFlags();
PROC_GLO_Bugfix_301351_FixDrunkGoblin();
PROC_GLO_Bugfix_301351_FixFriends();

QRY
QRY_GLO_Bugfix_301151_AnyGoblinIsBroken()
AND
DB_GOB_DrunkGoblin_SceneParticipants(_Goblin)
AND
QRY_GLO_Bugfix_301151_GoblinIsBroken(_Goblin)
THEN
DB_NOOP(1);

QRY
QRY_GLO_Bugfix_301151_GoblinIsBroken((CHARACTER)_Goblin)
AND
DB_PermaDefeated(_Goblin)
AND
NOT DB_DefeatedCauses(_Goblin, _, _)
AND
IsDead(_Goblin, 0)
THEN
DB_NOOP(1);

PROC
PROC_GLO_Bugfix_301351_FixFlags()
AND
QRY_GLO_Bugfix_301151_GoblinIsBroken((CHARACTER)S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
AND
DB_GOB_DrunkGoblin_Friends(_Friend)
AND
GetFlag(GOB_DrunkGoblin_Knows_Dead_ed00186e-0f4e-4aeb-90e9-01ffb404b7ff, _Friend, 1)
THEN
ClearFlag(GOB_DrunkGoblin_Knows_Dead_ed00186e-0f4e-4aeb-90e9-01ffb404b7ff, _Friend);

PROC
PROC_GLO_Bugfix_301351_FixFlags()
AND
QRY_GLO_Bugfix_301151_GoblinIsBroken((CHARACTER)S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
AND
DB_GOB_DrunkGoblin_Friends(_Friend)
AND
GetFlag((FLAG)GOB_DrunkGoblin_Mourning_07bffc4e-cdb6-4bf6-ac5f-55ae1688d419, _Friend, 1)
THEN
ClearFlag((FLAG)GOB_DrunkGoblin_Mourning_07bffc4e-cdb6-4bf6-ac5f-55ae1688d419, _Friend);

PROC
PROC_GLO_Bugfix_301351_FixFriends()
THEN
DB_GLO_Bugfix_301351_CorrectDialogs((CHARACTER)S_GOB_PartyingGoblin_000_69ab2a7d-9035-4e4e-97e5-2d005c9662ee, (DIALOGRESOURCE)GOB_DrunkGoblin_Friend0_a7c2fe80-3d92-1eeb-329d-26affcfb4148);
DB_GLO_Bugfix_301351_CorrectDialogs((CHARACTER)S_GOB_PartyingGoblin_001_4aa22ae0-1f97-42e3-8fd7-474f2f3b7269, (DIALOGRESOURCE)GOB_DrunkGoblin_Friend1_c98b1e63-afa5-fdd1-5169-bfa124d62cc5);
DB_GLO_Bugfix_301351_CorrectDialogs((CHARACTER)S_GOB_PartyingGoblin_002_bedb5fe5-2fa7-42f4-82c0-dda23883ff7c, (DIALOGRESOURCE)GOB_DrunkGoblin_Friend2_7bcb89fa-97db-ee09-1616-4dd060ee7dba);

PROC
PROC_GLO_Bugfix_301351_FixFriends()
AND
DB_GOB_DrunkGoblin_Friends(_Goblin)
AND
QRY_GLO_Bugfix_301151_GoblinIsBroken(_Goblin)
AND
DB_GLO_Bugfix_301351_CorrectDialogs(_Goblin, _GoblinDialog)
THEN
NOT DB_PermaDefeated(_Goblin);
ClearTag(_Goblin, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_Dialogs(_Goblin, _GoblinDialog);

PROC
PROC_GLO_Bugfix_301351_FixDrunkGoblin()
AND
QRY_GLO_Bugfix_301151_GoblinIsBroken((CHARACTER)S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
THEN
SetImmortal(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, 0);
NOT DB_PermaDefeated(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86);
ClearTag(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);

// fix position
PROC
PROC_GLO_Bugfix_301351_FixDrunkGoblin()
AND
DB_GOB_DrunkGoblin_WasKnockedOut(1)
THEN
NOT DB_GOB_DrunkGoblin_WasKnockedOut(1);
PROC_GOB_DrunkGoblin_MoveToSecludedPlaceWithDelay();
//END_REGION

//REGION GUS-307253
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-307523-2");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-307523-2")
AND
GetDistanceTo(S_UND_EbonLake_RaftAtCamp_FullRaft_eec3661a-7173-48c2-8793-2970d2c9618d, S_UND_DarkLake_BoatPositionAtCamp_d4cf00f1-941b-40aa-b81c-0d1c9edefec0, _Dist)
AND
_Dist > 2.0
THEN
TeleportToPosition(S_UND_EbonLake_RaftAtCamp_FullRaft_eec3661a-7173-48c2-8793-2970d2c9618d, -632.206, 0.369, 407.278, "", 0, 0, 0, 0, 0);
//END_REGION

//REGION GUS-311377
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-311377");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311377")
THEN
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_UND_BuriedChest_03_603e0c53-d27c-48fa-a974-4609638cf07a, 123.686, 44.897, -232.782);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_UND_BuriedMound_03_8b85a118-451b-4dc5-b3fe-0215e3aaa746, 123.729, 44.932, -232.633);
//END_REGION

//REGION GUS-311387
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-311387");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311387")
AND
DB_Players((CHARACTER)_Player)
AND
GetFlag((FLAG)DEN_Hideout_State_GivenWarning_0abd66e5-6337-025e-6def-a5d456e5e310, _Player, 1)
AND
DB_TrespassTrigger((TRIGGER)S_DEN_Thieflings_HideoutCrimeRegion_5e96478b-d5df-41d3-a20e-4ae522f75144,NULL_00000000-0000-0000-0000-000000000000,"DEN_ThieflingHideoutTrespass", (CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925)
THEN
ClearFlag((FLAG)DEN_Hideout_State_GivenWarning_0abd66e5-6337-025e-6def-a5d456e5e310, _Player);
NOT DB_TrespassTrigger((TRIGGER)S_DEN_Thieflings_HideoutCrimeRegion_5e96478b-d5df-41d3-a20e-4ae522f75144,NULL_00000000-0000-0000-0000-000000000000,"DEN_ThieflingHideoutTrespass", (CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925);
//END_REGION

//REGION GUS-300222

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_TopicalGreeting((FLAG)TG_ORI_Gale_LearnedBackstory_2857a62a-e31b-4913-b26d-92cf074ad969);

//END_REGION

//REGION GUS-310418
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-310418");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-310418")
AND
DB_PartyMembers(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_Dialogs((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)GOB_WolfPens_Halsin_Following_4c8c0646-03ab-6449-15be-a8a32a31da49)
THEN
PROC_RemoveDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)Halsin_InParty_890c2586-6b71-ca01-5bd6-19d533181c71);
DB_BUGFIX_Marker("GUS-310418");


//END_REGION GUS-310418

//REGION GUS-308360
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_Destroyed(S_UND_SussurBark_ec9aee1d-4965-4620-a81a-a05ccefd8b05)
AND
DB_QuestIsOpened("FOR_IncompleteMasterwork")
THEN
QuestUpdate("FOR_IncompleteMasterwork", "BarkDestroyed");
DB_BUGFIX_Marker("GUS-308360");
//END_REGION

//REGION GUS-310617
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-310617");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-310617")
THEN
NOT DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_012_47bcc82d-b403-48b9-8df7-d99a62974a8c);
NOT DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_013_dd035235-28ec-4b32-a8fd-c73d36078223);
NOT DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_HAG_HagLair_DoublesSpawnPoint_014_0462eb8a-c7f4-4297-bade-28cd5f4f5e31);
//END_REGION

//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(DEN_AttackOnDen_State_RaidersAtDen_29f372ac-f9f1-4d54-bc9e-7eb493fa09d8)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
DB_DEN_AttackOnDen_RaiderExclusionInEffect(1);

//END_REGION

//REGION GUS-309248
// No need to check for level, she is a global character and seh can even end up in act 3 with the potion
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag((FLAG)UND_InjuredGnome_State_Healed_6dd9c64e-a6b0-47d5-87f6-b1a1c49d3ab4)
AND
GetFlag((FLAG)UND_InjuredGnome_Event_AteNoblestalk_fe616c56-097e-49ee-aa9b-e1b68a9917e9, S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, 0)
AND
QRY_GLO_BUGFIX_309248_ThullaHasPotion()
THEN
DB_BUGFIX_Marker("GUS-309248");

QRY
QRY_GLO_BUGFIX_309248_ThullaHasPotion()
AND
TemplateIsInInventory((ITEMROOT)CONS_Potion_Antitoxin_f0c7d8bb-85e9-4937-96bb-49ba69d28631, S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, _Count)
AND
_Count > 0
AND
QRY_OnlyOnce("BUGFIX_309248_PotionDeleted")
THEN
TemplateRemoveFrom((ITEMROOT)CONS_Potion_Antitoxin_f0c7d8bb-85e9-4937-96bb-49ba69d28631, S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, 1);

QRY
QRY_GLO_BUGFIX_309248_ThullaHasPotion()
AND
TemplateIsInInventory((ITEMROOT)UNI_Apprentice_Antidote_25fea821-5ec1-4052-bd6c-60c249e72a79, S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, _Count)
AND
_Count > 0
AND
QRY_OnlyOnce("BUGFIX_309248_PotionDeleted")
THEN
TemplateRemoveFrom((ITEMROOT)UNI_Apprentice_Antidote_25fea821-5ec1-4052-bd6c-60c249e72a79, S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96, 1);
//END_REGION GUS-309248

//REGION GUS-310752
PROC
PROC_ApplySavegamePatches()
AND
NOT DB_GlobalFlag(UND_MushroomHunter_State_Saved_cd1f8012-322b-4135-bb40-54580bf5cea1)
AND
NOT DB_PermaDefeated(S_GLO_Baelen_711bd763-780d-4132-9662-3a8a06da6b1b)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-310752");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-310752")
THEN
PROC_CharacterDisableCrime(S_GLO_Baelen_711bd763-780d-4132-9662-3a8a06da6b1b, "Assault_Zero_Damage");
//END_REGION

//REGION GUS-307299

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
SetStoryItem(S_HAG_GaleMagicItem_f2aac5a4-6449-4c6c-af18-7dd334b76d73, 0);

//END_REGION

//REGION GUS-306958
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-306958");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-306958")
AND
NOT DB_PermaDefeatedOrOffstage(S_GOB_GoblinHeretic_3af8a55b-903a-43cd-84d3-9cb7ca8f69de)
THEN
CharacterDisableCrime(S_GOB_GoblinHeretic_3af8a55b-903a-43cd-84d3-9cb7ca8f69de, "UseForbiddenItem");
PROC_SetRelation((FACTION)ACT1_GOB_Heretic_f5d96348-623f-41e5-9e4c-2454a536a618, (FACTION)ACT1_GOB_RaidersNearHeretic_1f30d2dc-3034-4237-9aed-0edf1e1f1c36, 51);
PROC_SetRelation((FACTION)ACT1_GOB_Heretic_f5d96348-623f-41e5-9e4c-2454a536a618, (FACTION)ACT1_GOB_ScryingEyes_b9a148f1-9120-4ab0-a8f2-b6d37ff32b43, 51);
PROC_SetRelation((FACTION)ACT1_GOB_Heretic_f5d96348-623f-41e5-9e4c-2454a536a618, (FACTION)ACT1_GOB_Goblins_General_633245e8-cbb8-b0c4-12ec-32d2ff9424e2, 51);
PROC_SetRelation((FACTION)ACT1_GOB_Heretic_f5d96348-623f-41e5-9e4c-2454a536a618, (FACTION)ACT1_GOB_Raiders_281782f3-dc5d-be45-4fda-72b5ee1017e3, 51);
PROC_SetRelation((FACTION)ACT1_GOB_Heretic_f5d96348-623f-41e5-9e4c-2454a536a618, (FACTION)ACT1_GOB_Bravado_83d9ecec-772f-487a-85f9-79aaee46befb, 51);
PROC_SetRelation((FACTION)ACT1_GOB_Heretic_f5d96348-623f-41e5-9e4c-2454a536a618, (FACTION)ACT1_GOB_Guards_f75246c5-0984-ec12-ee44-954231e0a219, 51);
//END_REGION GUS-306958

//REGION GUS-308239

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-308239");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-308239")
THEN
PROC_FOR_BottomlessWell_SetChasmImmunity(S_FOR_Bottomless_SpiderQueen_e6b2f3ba-2d02-4507-8680-6047322e1a4b);

//END_REGION

//REGION GUS-292478
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-292478");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-292478")
AND
NOT DB_PermaDefeatedOrOffstage(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
AND
NOT DB_GlobalFlag((FLAG)UND_InjuredGnome_State_SporeServant_4a1d7911-e00d-4e32-8dff-3352a0a7af63)
AND
NOT DB_GlobalFlag((FLAG)UND_MyconidCircle_InjuredGnome_Healed_6dd9c64e-a6b0-47d5-87f6-b1a1c49d3ab4)
THEN
DB_HasItemTemplateScriptFlag(3, (DIALOGRESOURCE)UND_MyconidCircle_InjuredGnome_7752324a-db86-dfd3-30b5-4a2edde65d6c, (ITEMROOT)ALCH_Solution_Potion_Remedy_ae9a9360-7cbe-4f72-8bea-1dd5747c180d, 2, 1);
DB_GiveTemplateFromPlayerDialogEvent((ITEMROOT)ALCH_Solution_Potion_Remedy_ae9a9360-7cbe-4f72-8bea-1dd5747c180d, (FLAG)UND_InjuredGnome_Event_GiveRemedy_690c267c-e4c4-4636-be80-5700520f6539, NULL_00000000-0000-0000-0000-000000000000, 1);
DB_HasItemTemplateScriptFlag(4, (DIALOGRESOURCE)UND_MyconidCircle_InjuredGnome_7752324a-db86-dfd3-30b5-4a2edde65d6c, (ITEMROOT)CONS_Potion_Poison_Resistance_ae28b14c-0881-45fe-8237-9fcb1c951d3d, 2, 1);
DB_GiveTemplateFromPlayerDialogEvent((ITEMROOT)CONS_Potion_Poison_Resistance_ae28b14c-0881-45fe-8237-9fcb1c951d3d, (FLAG)UND_InjuredGnome_Event_GivePoisonResistance_f6b94c44-5168-4330-a1d3-434bda4b71d1, NULL_00000000-0000-0000-0000-000000000000, 1);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-292478")
AND
Exists(S_UND_InjuredGnome_DuergarAntidote_a176e33f-37f4-4035-a172-310749dcebfa, 1)
AND
IsDestroyed(S_UND_InjuredGnome_DuergarAntidote_a176e33f-37f4-4035-a172-310749dcebfa, 0)
THEN
SetStoryItem(S_UND_InjuredGnome_DuergarAntidote_a176e33f-37f4-4035-a172-310749dcebfa, 0);
//END_REGION GUS-292478

//REGION GUS-302294
// Reset position of Scratch if he's not yet recruited, alive, and too far from the courier
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-302294");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-302294")
AND
NOT DB_GlobalFlag((FLAG)CAMP_Courier_Dog_Moved2Camp_7dcb7732-1c76-463a-bec9-251f30860e6c)
AND
NOT DB_PermaDefeated(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901)
AND
GetDistanceTo(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, FOR_Courier_Dog_SceneTrigger_d0e0424e-4d19-4b48-b0ee-5f5166b55f5d, _Distance)
AND
_Distance > 50.0
THEN
TeleportTo(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, FOR_Courier_Dog_SceneTrigger_d0e0424e-4d19-4b48-b0ee-5f5166b55f5d);
//END_REGION

//REGION GUS-306795
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
PROC_ApplySavegamePatches_GUS_306795();
DB_BUGFIX_Marker("GUS-306795");

//Character not in underdark
PROC
PROC_ApplySavegamePatches_GUS_306795()
AND
DB_GLO_Sussur_Flowers((ITEM)_Item)
AND
GetInventoryOwner(_Item, _Owner)
AND
NOT QRY_GLO_Sussur_InUnderdark(_Owner)
THEN
PROC_GLO_Sussur_Wither(_Item);

//Character in underdark
PROC
PROC_ApplySavegamePatches_GUS_306795()
AND
DB_GLO_Sussur_Flowers((ITEM)_Item)
AND
GetInventoryOwner(_Item, _Owner)
AND
QRY_GLO_Sussur_InUnderdark(_Owner)
AND
DB_GLO_Sussur_UnderdarkRegion((TRIGGER)_Trigger)
THEN
TriggerRegisterForCharacter(_Trigger, (CHARACTER)_Owner);

//Not in any inventory - taken from one of the traders in future acts and then dropped on the floor
//Just in case - it shouldn't be possible as the sussur whithers away as soons as it goes into a player's inventory
PROC
PROC_ApplySavegamePatches_GUS_306795()
AND
DB_GLO_Sussur_Flowers((ITEM)_Item)
AND
GetInventoryOwner(_Item, _Owner)
AND
_Owner == NULL_00000000-0000-0000-0000-000000000000
AND
NOT QRY_GLO_Sussur_InUnderdark(_Item) //uses a GUIDSTRING so works with the item too
THEN
PROC_GLO_Sussur_Wither(_Item);
//END_REGION

//REGION GUS-312820

PROC
PROC_ApplySavegamePatches()
AND
DB_HAG_Hagspawn_JakeResurrected(1)
AND
DB_Defeated(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5)
AND
NOT DB_GlobalFlag(HAG_Hagspawn_Event_RecruitHusband_dcb4aadc-ab53-4641-b5d9-7c61da0b6dbc)
AND
DB_LevelLoadedOnce(_Level)
AND
NOT DB_LevelUnreachable(_Level)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", _Level, "GUS-312820");

PROC
PROC_ApplySavegamePatchInLevel(_Level, "GUS-312820")
AND
NOT DB_BUGFIX_Marker_GUS_312820(_)
AND
Exists(S_HAG_Wand_SummonHusband_70bc9907-91c1-4e69-ad50-53e402eca22f, 1)
AND
GetRegion(S_HAG_Wand_SummonHusband_70bc9907-91c1-4e69-ad50-53e402eca22f, _Level)
THEN
DB_BUGFIX_Marker_GUS_312820(_Level);
PROC_BUGFIX_GUS_312820();

PROC
PROC_BUGFIX_GUS_312820()
AND
GetInventoryOwner(S_HAG_Wand_SummonHusband_70bc9907-91c1-4e69-ad50-53e402eca22f, _Owner)
THEN
TeleportTo(S_HAG_Wand_SummonHusband_70bc9907-91c1-4e69-ad50-53e402eca22f, _Owner);//Force out of inventory

PROC
PROC_BUGFIX_GUS_312820()
THEN
SetOnStage(S_HAG_Wand_SummonHusband_70bc9907-91c1-4e69-ad50-53e402eca22f, 0);

//END_REGION GUS-312820

//REGION GUS-312806

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "HAG_HagSpawn", "EnteredLair", 1)
THEN
DB_OnlyOnce("HAG_HagSpawn_FledLair");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "HAG_HagSpawn", "FledLair", 1)
THEN
DB_OnlyOnce("HAG_HagSpawn_FledLair");


//END_REGION


//REGION GUS-311560
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-311560");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311560")
THEN
TeleportToPosition(S_PLA_DesirePathb_008_ae737c1e-f1c8-4d44-95df-259a18d38a26, -64.434, 37.767, 608.701);
TeleportToPosition(S_PLA_DesirePathb_009_33b81a03-170b-4feb-a8f0-a14d286345a8, -63.073, 37.767, 605.095);
//END_REGION GUS-311560

//REGION GUS-310824
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND //We check on this as to not cause asserts with object being still in WLD_Main
GetFlag((FLAG)UND_IdolOfShar_State_HasIdol_f5858c41-cb2a-45c6-8093-8a0545979cc6, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
AND
GetInventoryOwner((ITEM)S_UND_IdolOfShar_18d2c483-c9eb-49be-a6d1-0d8961c13e87, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_SheHasIdol_1a419d44-74c7-4b20-bb3f-03f9cc7e7459);
DB_BUGFIX_Marker("GUS-310824");
//END_REGION GUS-310824

/////////////////////////////// PATCH 6 ///////////////////////////////

//REGION GUS-311031
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-311031");
PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311031")
AND
NOT DB_GlobalFlag(DEN_SacredPond_State_BirdLeft_9858f80e-2973-41cf-9118-24c9a1e0c743)
THEN
PROC_TriggerRegisterForPlayers(S_DEN_Sender_PlayerApproach_4c5333fd-c4ea-4ddd-8819-eb72e4783793);
//END_REGION GUS-311031

//REGION GUS-309512
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-309512");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-309512")
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95, (FACTION)ACT1_UND_Myconids_5a3114c3-1a49-4cd8-2b4e-92f536913e30, 0);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-309512")
AND
DB_QuestIsAccepted("UND_GnomeRescue")
THEN
PROC_GlobalSetFlagAndCache((FLAG)UND_InjuredGnome_State_GaveQuest_2e8e3582-bd63-4edb-f305-cd9cd8dd85ce);
//END_REGION GUS-309512

//REGION GUS-306770
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag(DEN_PartyProgress_EnteredGrove_18cfaaeb-c0df-46ac-962d-0c300f816d73)
AND
NOT DB_GlobalFlag(DEN_GroveConflict_State_TooLowTieflings_ed9fe6c4-5037-4f74-968c-a166aeb29d9c)
AND
QRY_DEN_CheckPeaceState()
THEN
DB_BUGFIX_Marker("GUS-306770");
SetFlag(DEN_General_State_EntranceBanterAvailable_43136ce2-1f9a-404c-af9e-8904b480255e, NULL_00000000-0000-0000-0000-000000000000, 0);
//END_REGION

//REGION GUS-311702
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-311702");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-311702")
AND
QRY_GOB_AdventurerWasFreed()
AND
NOT GetRelation((FACTION)ACT1_GOB_Torturers_8a9e7e9a-1e72-eed1-8175-6c8d50ef7372,(FACTION)ACT1_GOB_TortureredAdventurer_64035579-5958-e356-bd99-8369fa439a40,0)
THEN
PROC_GOB_AdventurerFreed_ProgressTorturers();

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-311702")
AND
NOT QRY_GOB_AdventurerWasFreed()
THEN
SetCanJoinCombat(S_GOB_TorturedAdventurer_0dd6e9f1-d32d-41f1-b230-d540558e0847,0);

QRY
QRY_GOB_AdventurerWasFreed()
AND
DB_GOB_AdventurerFreedFlags(_AdventurerFreedFlag)
AND
DB_GlobalFlag(_AdventurerFreedFlag)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-312333

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag(DEN_AttackOnDen_State_UnderAttack_4ebba932-b9cf-41c5-b897-e77a63b93511)
AND
DB_DEN_AttackOnDen_TieflingDefeatCounters(_Combat)
AND
NOT DB_GLO_DefeatCounter_State(_, _Combat, _)
THEN
DB_DEN_AttackOnDen_DefeatCounterComplete(_Combat);
PROC_DEN_AttackOnDen_EndOfCombat(_Combat);

//END_REGION

//REGION GUS-307254
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GLO_Moonrise_UnderdarkSUB((STRING)_SUB)
THEN
NOT DB_GLO_Moonrise_UnderdarkSUB((STRING)_SUB);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GLO_Tadpole_SUB_Moonrise_CheckEnteredUnderdark((INTEGER)_Value)
THEN
NOT DB_GLO_Tadpole_SUB_Moonrise_CheckEnteredUnderdark((INTEGER)_Value);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_QuestIsOpened("GLO_PathToMoonrise_SUB_UnderdarkPath")
AND
DB_GlobalFlag((FLAG)GLO_Underdark_EverEnteredBefore_dd5cd5b4-2ad5-4dbd-4972-2afaa7538994)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Underdark_LearnedSearch")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Underdark_NereGaveLyre")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Underdark_DuergarToldAboutCurse")
THEN
QuestUpdate("GLO_PathToMoonrise", "Underdark_EnteredUnderdark");
DB_BUGFIX_Marker("GUS-307254-A");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_QuestIsClosed("GLO_PathToMoonrise_SUB_UnderdarkPath")
THEN
DB_QuestDef_State((FLAG)GLO_Underdark_EverEnteredBefore_dd5cd5b4-2ad5-4dbd-4972-2afaa7538994, "GLO_PathToMoonrise", "Underdark_EnteredUnderdark");
DB_BUGFIX_Marker("GUS-307254-B");
//END_REGION GUS-307254

//REGION GUS-310761
// As Volo is a global char, we can patch him getting stuck this way up until players reach INT_Main_A
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelLoadedOnce("INT_Main_A")
AND
QRY_BUGFIX_VoloGuardDefeatedWhileKickingVoloFromStage()
AND
NOT DB_PermaDefeated(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa)
THEN
DB_BUGFIX_Marker("GUS-310761_VoloStuck");
PROC_DisappearOutOfSight(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa, "Run", 0, "GOB_VoloBallad_VoloFled");

QRY
QRY_BUGFIX_VoloGuardDefeatedWhileKickingVoloFromStage()
AND
DB_Defeated(S_GOB_VoloGuard_c25f0e79-b9f7-453c-8138-964bca267d93)
AND
DB_GOB_VoloBallad_EscortInProcess(1)
AND
NOT DB_GlobalFLag((FLAG)GOB_Volo_State_BeingEscorted_d5a9c68f-bf66-4462-b2bd-066b4547cd19)
THEN
DB_NOOP(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
QRY_BUGFIX_ShouldStopForceUpdatingVoloAndGuard()
THEN
PROC_BUGFIX_VoloAndGuardForceUpdate();

QRY
QRY_BUGFIX_ShouldStopForceUpdatingVoloAndGuard()
AND
DB_GlobalFlag((FLAG)GOB_VoloBallad_State_VoloEscaped_13ae819f-b0b7-434d-9ebb-cee412b1a407)
THEN
DB_NOOP(1);

QRY
QRY_BUGFIX_ShouldStopForceUpdatingVoloAndGuard()
AND
QRY_BUGFIX_VoloGuardDefeatedWhileKickingVoloFromStage()
THEN
DB_NOOP(1);

PROC
PROC_BUGFIX_VoloAndGuardForceUpdate()
AND
IsForceUpdate(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,1)
THEN
SetForceUpdate(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,0);
DB_BUGFIX_Marker("GUS-310761_VoloForceUpdate");

PROC
PROC_BUGFIX_VoloAndGuardForceUpdate()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","WLD_Main_A","GUS-310761_VoloGuardForceUpdate");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-310761_VoloGuardForceUpdate")
AND
IsForceUpdate(S_GOB_VoloGuard_000_c25f0e79-b9f7-453c-8138-964bca267d93,1)
THEN
SetForceUpdate(S_GOB_VoloGuard_000_c25f0e79-b9f7-453c-8138-964bca267d93,0);
//END_REGION

//REGION GUS-313260

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_CampNight_Completed(NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121)
AND
DB_DEN_CurrentDefenderLeader((CHARACTER)S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892)
AND
NOT DB_HAV_SavingPrisoners_InHaven(S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892)
AND
IsOnStage(S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892, 1)
THEN
SetOnStage(S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892, 0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_Camp_QueuedNight(NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121)
AND
DB_DEN_CurrentDefenderLeader((CHARACTER)S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892)
THEN
DB_CAMP_GoblinHuntCelebration_SceneActors(S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892);

//END_REGION

//REGION GUS-300490
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","WLD_Main_A","GUS-300490");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-300490")
THEN
DB_Origins_BlockTransferReasons("LaezelRanToKnight");

//END_REGION

//REGION GUS-310038
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-310038");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-310038")
AND
NOT DB_Dialogs(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, _)
THEN
DB_Dialogs(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, (DIALOGRESOURCE)DEN_CapturedGoblin_db2b1587-8297-6a2c-4355-86664ddb3264);
SetHasDialog(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, 1);
//END_REGION GUS-310038

//REGION GUS-283754
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-283754");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-283754")
AND
DB_GlobalFlag(GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746)
THEN
TriggerSetSoundRTPC((TRIGGER)Amb_SV_Forest_QD_727b95fa-f30c-3d41-cbe2-dc0d67f8f105, "SE_Windmill_A_Speed", 0.0, 1);


PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-283754")
AND
NOT DB_GlobalFlag(GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746)
AND
NOT DB_GlobalFlag((FLAG)WLD_FOR_UnfortunateGnome_State_Fast_ad363172-0964-4f0c-9f1d-4fea67834e60)
THEN
TriggerSetSoundRTPC((TRIGGER)Amb_SV_Forest_QD_727b95fa-f30c-3d41-cbe2-dc0d67f8f105, "SE_Windmill_A_Speed", 50.0, 1);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-283754")
AND
NOT DB_GlobalFlag(GLO_UnfortunateGnome_State_Still_d58850bc-2eac-8105-99b1-fec5d247b746)
AND
DB_GlobalFlag((FLAG)WLD_FOR_UnfortunateGnome_State_Fast_ad363172-0964-4f0c-9f1d-4fea67834e60)
THEN
TriggerSetSoundRTPC((TRIGGER)Amb_SV_Forest_QD_727b95fa-f30c-3d41-cbe2-dc0d67f8f105, "SE_Windmill_A_Speed", 100.0, 1);


//END_REGION

//REGION GUS-313413
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_PermaDefeated(S_GOB_GoblinKing_11337af0-6a57-426b-a820-c4b00923dd54)
AND
DB_PermaDefeated(S_GOB_GoblinPriest_b983c336-9a14-4e9b-adb9-4689e7e0afa9)
THEN
PROC_GlobalSetFlagAndCache(GOB_State_LeadersAreDead_a1c5b01f-4b7f-47ab-82b0-d24d9c6d8bc6);
DB_BUGFIX_Marker("GUS-313413");
//END_REGION GUS-313413

//REGION GUS-304039
PROC
PROC_ApplySavegamePatches()
AND
DB_GlobalFlag((FLAG)FOR_GoblinAmbush_GoblinsPacified_1268cab6-b501-bb0e-f9b0-f8fe7b6d7139)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-304039");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304039")
AND
NOT DB_PermaDefeated(S_FOR_Ambush_Goblins_Ranger_01_8e553c24-5100-4939-9041-4dec8499d553)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_FOR_Ambush_Goblins_Ranger_01_8e553c24-5100-4939-9041-4dec8499d553);
DB_Dialogs(S_FOR_Ambush_Goblins_Ranger_01_8e553c24-5100-4939-9041-4dec8499d553,(DIALOGRESOURCE)GEB_AD_CantTalkNow_ae991ba1-8a2e-9cc7-b4c2-379af7f058c5);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304039")
AND
NOT DB_PermaDefeated(S_FOR_Ambush_Goblins_Ranger_02_70a50383-e377-45c0-a793-b44d36d2df55)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_FOR_Ambush_Goblins_Ranger_02_70a50383-e377-45c0-a793-b44d36d2df55);
DB_Dialogs(S_FOR_Ambush_Goblins_Ranger_02_70a50383-e377-45c0-a793-b44d36d2df55,(DIALOGRESOURCE)GEB_AD_CantTalkNow_ae991ba1-8a2e-9cc7-b4c2-379af7f058c5);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304039")
AND
NOT DB_PermaDefeated(S_FOR_Ambush_Goblins_Ranger_03_e3d96e92-39fa-4ec1-9503-bd00f40285aa)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_FOR_Ambush_Goblins_Ranger_03_e3d96e92-39fa-4ec1-9503-bd00f40285aa);
DB_Dialogs(S_FOR_Ambush_Goblins_Ranger_03_e3d96e92-39fa-4ec1-9503-bd00f40285aa,(DIALOGRESOURCE)GEB_AD_CantTalkNow_ae991ba1-8a2e-9cc7-b4c2-379af7f058c5);
//END_REGION GUS-304039

//REGION GUS-307218
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-307218");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-307218")
AND
Exists(S_DEN_Antidote_3d02e275-1530-455c-9d58-bfac847e105a, 1)
THEN
SetStoryItem(S_DEN_Antidote_3d02e275-1530-455c-9d58-bfac847e105a, 0);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-307218")
AND
Exists(S_DEN_Antidote_3d02e275-1530-455c-9d58-bfac847e105a, 1)
AND
IsInInventoryOf(S_DEN_Antidote_3d02e275-1530-455c-9d58-bfac847e105a, S_DEN_Apprentice_7cabf226-e34b-4556-8903-a45d0fe26caf, 1)
THEN
SetIsTradable(S_DEN_Antidote_3d02e275-1530-455c-9d58-bfac847e105a, TRADABLETYPE.NonTradable);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-307218")
THEN
SetStoryItem(S_UND_TimmaskIntroArea_000_Timmask_001_6fd54a16-72a3-403f-ad17-e31eb3a02736, 0);
SetStoryItem(S_UND_TimmaskIntroArea_000_Timmask_000_29604fef-61fa-4521-9f7d-685b9e7a7338, 0);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-307218")
AND
NOT DB_GlobalFlag(PLA_ConflictedFlind_State_Gone_4152beef-e7d1-e10f-7b06-62584d3571f2)
THEN
TeleportToPosition(S_PLA_ConflictedFlind_LeaveToTrigger_c30f35ca-ae9f-4861-b32a-f69c88de273c, 30.0, 44.0, 571.0);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-307218")
AND
NOT DB_GlobalFlag((FLAG)GOB_Orpheus_State_HadVoiceOfAbsoluteEvent_9546407d-19e3-4f26-88af-5970896997d7)
THEN
TeleportToPosition(S_GOB_Orpheus_PlainsEntrance_AddToDialogArea_fc5a15cd-c698-4707-ad85-390914145b10, -134.4, 31.6, 486.4);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_PLA_ConflictedFlind_LeftGnoll((CHARACTER)_Gnoll)
THEN
NOT DB_PLA_ConflictedFlind_LeftGnoll((CHARACTER)_Gnoll);
//END_REGION GUS-307218

//REGION GUS-307082
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-307082");

// if we find the Sussur Tree before starting the quest
// then we should unlock "TakeSussurBark" update as soon as the player
// learns they need it
PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-307082")
AND
DB_QuestIsOpened("FOR_IncompleteMasterwork")
AND
NOT DB_OneShot_VoiceBarkTrigger(S_UND_SussurTree_VB_f7723a0a-72f0-4519-8b20-8c35ddb0a990, UND_SussurTree_VB_Approach_73f84915-8dd1-4e68-d1e0-3a2fd78d09f5, _)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("FOR_IncompleteMasterwork", "TakeSussurBark")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("FOR_IncompleteMasterwork", "FoundSussurBark")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("FOR_IncompleteMasterwork", "FoundSussurBarkBeforePlans")
AND
QRY_QuestUpdateIsUnlockedForAny("FOR_IncompleteMasterwork", "FindPlansBeforeJournal")
THEN
QuestUpdate("FOR_IncompleteMasterwork", "TakeSussurBark_AfterTree");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-307082")
AND
DB_QuestIsOpened("FOR_IncompleteMasterwork")
AND
NOT DB_OneShot_VoiceBarkTrigger(S_UND_SussurTree_VB_f7723a0a-72f0-4519-8b20-8c35ddb0a990, UND_SussurTree_VB_Approach_73f84915-8dd1-4e68-d1e0-3a2fd78d09f5, _)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("FOR_IncompleteMasterwork", "TakeSussurBark")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("FOR_IncompleteMasterwork", "FoundSussurBark")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("FOR_IncompleteMasterwork", "FoundSussurBarkBeforePlans")
AND
QRY_QuestUpdateIsUnlockedForAny("FOR_IncompleteMasterwork", "FindPlansAfterJournal")
THEN
QuestUpdate("FOR_IncompleteMasterwork", "TakeSussurBark_AfterTree");

//END_REGION GUS-307082

//REGION GUS-312811
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_GlobalFlag((FLAG)GLO_Origin_PartOfTheTeam_Karlach_b1e6f12a-600a-4e2e-9871-b08a9fe3a617)
AND
NOT DB_Avatars((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
GetFlag((FLAG)TG_MonitorIntro_e35b7017-eb09-4319-ba1e-934f1862c7ef, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 1)
THEN
DB_BUGFIX_Marker("GUS-312811");
ClearFlag((FLAG)TG_MonitorIntro_e35b7017-eb09-4319-ba1e-934f1862c7ef, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
//END_REGION GUS-312811

//REGION GUS-185942
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-185942");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-185942")
AND
DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_SidedLoyal_74c05609-77b6-4f62-b9e0-9bcb24908d4b)
THEN
PROC_ClearCorpseOwner((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);
//END_REGION GUS-185942

//REGION GUS-312159
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_Tadpole", "PoisonedByApprentice")
THEN
NOT DB_QuestDef_ChainedState("GLO_Tadpole", "PoisonedByApprentice",    "PoisonedByApprentice_ParentCompletion");
DB_QuestDef_ChainedState("GLO_Tadpole", "PoisonedByApprentice",    "PoisonedByApprenticeSuccess_ParentCompletion");
DB_BUGFIX_Marker("GUS-312159");
//END_REGION GUS-312159

//REGION GUS-310957
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
QRY_BG3_SaveGamePatches_GUS310957_QuestAdvancedFarEnough(_Player)
THEN
SetFlag((FLAG)FOR_ThayanCellar_State_CellarDiscovered_308aa3f8-f4f2-4c48-88e9-59d36b1778e8);
DB_BUGFIX_Marker("GUS-310957-A");

QRY
QRY_BG3_SaveGamePatches_GUS310957_QuestAdvancedFarEnough((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "FOR_DangerousBook", "SearchLabAfterJournal", 1)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatches_GUS310957_QuestAdvancedFarEnough((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "FOR_DangerousBook", "FindTome", 1)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatches_GUS310957_QuestAdvancedFarEnough((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "FOR_DangerousBook", "InvestigateTome", 1)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatches_GUS310957_QuestAdvancedFarEnough(_Player)
AND
QuestIsClosed("FOR_DangerousBook", 1)
THEN
DB_NOOP(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
GetFlag(FOR_DangerousBook_State_HasTome_4a6e2b36-8bcc-a067-6d1c-51c5cba542d3, _Player, 1)
THEN
QuestUpdate(_Player, "FOR_DangerousBook", "InvestigateTome");
SetFlag((FLAG)FOR_ThayanCellar_State_CellarDiscovered_308aa3f8-f4f2-4c48-88e9-59d36b1778e8);
DB_BUGFIX_Marker("GUS-310957-B");
//END_REGION GUS-310957

//REGION GUS-311295
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
HasActiveStatus(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "TIED_TO_CHAIR", 1)
THEN
SetFaction(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, (FACTION)Act1_PLA_ZhentDungeon_CapturedZhent_c0b1ad4c-f7cb-4db0-a472-4289162f8b54);
PROC_SetRelationMutual((FACTION)ACT1_PLA_HideoutZhents_339b19c5-f1fb-1389-44b9-a9d31965b560, (FACTION)Act1_PLA_ZhentDungeon_CapturedZhent_c0b1ad4c-f7cb-4db0-a472-4289162f8b54, 51);
PROC_CharacterDisableCrime(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4, "Trespassing");
DB_BUGFIX_Marker("GUS-311295");
//END_REGION GUS-311295

//REGION GUS-311148
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-311148");

// we saved the dwarf and then he died, we know who he was
PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311148")
AND
DB_QuestIsOpened("UND_MushroomHunter")
AND
DB_GlobalFlag(UND_MushroomHunter_State_SawDeadBaelen_Global_ae1d68bb-08b2-4b2c-a9d1-18b0d234b57a)
AND
QRY_UND_MushroomHunter_KnowsDwarfIsBaelen()
AND
NOT QRY_QuestUpdateIsUnlockedForAny("UND_MushroomHunter", "BaelenDied")
THEN
QuestUpdate("UND_MushroomHunter", "BaelenDied");

// we saved the dwarf and then he died, we know who he was (fallback in case we didn't learn about his name, but already unlocked an update that mentions his name)
PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311148")
AND
DB_QuestIsOpened("UND_MushroomHunter")
AND
DB_GlobalFlag(UND_MushroomHunter_State_SawDeadBaelen_Global_ae1d68bb-08b2-4b2c-a9d1-18b0d234b57a)
AND
NOT QRY_UND_MushroomHunter_KnowsDwarfIsBaelen()
AND
QRY_QuestUpdateIsUnlockedForAny("UND_MushroomHunter", "SavedBaelen")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("UND_MushroomHunter", "BaelenDied")
THEN
QuestUpdate("UND_MushroomHunter", "BaelenDied");

// we saved the dwarf and then he died, we don't know who he was
// only update if we don't have the incorrect update already
PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311148")
AND
DB_QuestIsOpened("UND_MushroomHunter")
AND
DB_GlobalFlag(UND_MushroomHunter_State_SawDeadBaelen_Global_ae1d68bb-08b2-4b2c-a9d1-18b0d234b57a)
AND
NOT QRY_UND_MushroomHunter_KnowsDwarfIsBaelen()
AND
QRY_QuestUpdateIsUnlockedForAny("UND_MushroomHunter", "SavedDwarf")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("UND_MushroomHunter", "DwarfSavedDied")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("UND_MushroomHunter", "DwarfSavedDied_New")
THEN
QuestUpdate("UND_MushroomHunter", "DwarfSavedDied_New");
//END_REGION

//REGION GUS-311279
PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("WLD_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-311279");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311279")
THEN
DB_DropMutingStatussesDialog(DEN_RaidingParty_Confrontation_9f62049b-025f-c424-debf-c4a133a02da9);
DB_DropMutingStatussesDialog(CHA_LaeZelRecruitment_TieflingsScene_e08f550a-8f06-89f7-40ed-98b02eb515e4);


PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311279")
AND
DB_CHA_LaezelRecruit_Cager(_Cager,_,_)
THEN
DB_SpotPlayers_IncludeWildshapedPlayers(_Cager, "CHA_LaezelRecruit_TieflingSpot");
DB_SpotPlayers_IncludeWildshapedPlayers(_Cager, "CHA_LaezelRecruitment_SpottingEvent");
//END_REGION GUS-311279

//REGION GUS-285787

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-285787");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-285787")
THEN
DB_BUGFIX_GUS_285787_PatchStalactites((ITEM)S_FOR_OwlbearCave_Stalactite_01_7b369d79-8741-4fdf-b4fe-305cf7cface6,(ITEM)S_FOR_OwlbearCave_Stalactite_01_PATCH_e1c837e6-2105-430d-8f55-01c2777de554);
DB_BUGFIX_GUS_285787_PatchStalactites((ITEM)S_FOR_OwlbearCave_Stalactite_02_bea76203-5824-4538-8a3e-d802b5809e37,(ITEM)S_FOR_OwlbearCave_Stalactite_02_PATCH_1c396ffb-deb0-47f2-b822-a6ca07c1f61a);
DB_BUGFIX_GUS_285787_PatchStalactites((ITEM)S_FOR_OwlbearCave_Stalactite_03_a269d9cb-a880-4e57-923b-898dea81e347,(ITEM)S_FOR_OwlbearCave_Stalactite_03_PATCH_f5522321-048a-4f18-8706-74e353c2d0ef);
DB_BUGFIX_GUS_285787_PatchStalactites((ITEM)Quest_ThayGuardian_Stalactite_01_8ffd570c-6e3f-4042-bdf2-1b28e3322c92,(ITEM)Quest_ThayGuardian_Stalactite_01_PATCH_9dc1c603-0853-4dd9-b79e-4058a974310d);
DB_BUGFIX_GUS_285787_PatchStalactites((ITEM)Quest_ThayGuardian_Stalactite_02_5589fab1-63e7-49fc-a4d1-3a242dfed744,(ITEM)Quest_ThayGuardian_Stalactite_02_PATCH_9b7fa8b6-1c3c-43c0-994a-ef7dc0100a14);
DB_BUGFIX_GUS_285787_PatchStalactites((ITEM)Quest_ThayGuardian_Stalactite_03_7261181b-e91e-45ae-868f-0acc41db6a24,(ITEM)Quest_ThayGuardian_Stalactite_03_PATCH_58b61694-1e2b-466b-8bf3-0f507db343df);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-285787")
AND
DB_BUGFIX_GUS_285787_PatchStalactites((ITEM)_Stalactite,(ITEM)_StalactiteNew)
AND
NOT DB_Destroyed(_Stalactite)
AND
NOT DB_BUGFIX_Marker("GUS_285787",_Stalactite)
THEN
SetOnStage(_Stalactite,0);
NOT DB_BUGFIX_GUS_285787_PatchStalactites(_Stalactite,_StalactiteNew);
DB_BUGFIX_Marker("GUS_285787",(ITEM)_Stalactite);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-285787")
AND
DB_BUGFIX_GUS_285787_PatchStalactites((ITEM)_Stalactite,(ITEM)_StalactiteNew)
AND
DB_Destroyed(_Stalactite)
AND
NOT DB_BUGFIX_Marker("GUS_285787",_Stalactite)
THEN
SetOnStage(_StalactiteNew,0);
NOT DB_BUGFIX_GUS_285787_PatchStalactites(_Stalactite,_StalactiteNew);
DB_BUGFIX_Marker("GUS_285787",(ITEM)_Stalactite);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-285787")
AND
DB_BUGFIX_GUS_285787_PatchStalactites((ITEM)_Stalactite,(ITEM)_StalactiteNew)
THEN
NOT DB_BUGFIX_GUS_285787_PatchStalactites(_Stalactite,_StalactiteNew);

//END_REGION

//REGION GUS-310612
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-310612");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-310612")
AND
DB_CMB_SporeServantFollower((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, _, _Caster)
AND
IsPartyFollower(_Caster, 0)
THEN
Die(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, DEATHTYPE.DoT, 0);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-310612")
AND
NOT DB_Is_InCombat(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, _)
AND
NOT DB_CMB_SporeServantFollower(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, _,_)
AND
NOT DB_Dead(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
HasActiveStatus(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, "CREATURE_SPORE_SERVANT", 1)
THEN
Die(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, DEATHTYPE.DoT, 0);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-310612")
AND
DB_Is_InCombat(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, _)
AND
NOT DB_CMB_SporeServantFollower(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, _,_)
AND
NOT DB_Dead(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
HasActiveStatus(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, "CREATURE_SPORE_SERVANT", 1)
AND
CharacterGetOwner(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, _Owner)
THEN
DB_CMB_SporeServantNPCFollower((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, (CHARACTER)_Owner);
//END_REGION GUS-310612

//REGION GUS-306870

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag(GOB_BattleStations_Event_ToStation_03a8bd66-c23f-4989-9a7b-775cf475104b)
THEN
PROC_SetRelationToPlayers(ACT1_GOB_ScryingEyes_b9a148f1-9120-4ab0-a8f2-b6d37ff32b43, 0);

//END_REGION

//REGION GUS-314651

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
NOT DB_GlobalFlag((FLAG)NIGHT_Astarion_Romance1_AfterCelebration_a032c2da-0fb1-4600-a97e-2ea416c5435a)
THEN
DB_BUGFIX_Marker("GUS-314651");
DB_CampNight_Requirement_CanStartDating((FLAG)NIGHT_Astarion_Romance1_AfterCelebration_a032c2da-0fb1-4600-a97e-2ea416c5435a, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

//END_REGION

//REGION GUS-314816
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-314816");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-314816")
AND
NOT DB_GLO_Backgrounds_Blocked("Act1_Outlander_BoulderTrap")
AND
NOT DB_PLA_BanditCave_BoulderTrap_TrapActivated(_)
THEN
DB_GLO_Backgrounds_Outlander_BoulderTrapZones((TRIGGER)S_PLA_BanditCave_TrapZone_A_7dbeb14f-881e-4200-a8c1-c2b94b403d43);
DB_GLO_Backgrounds_Outlander_BoulderTrapZones((TRIGGER)S_PLA_BanditCave_TrapZone_B_9bbe3d04-a1a3-45eb-a422-456af1b4a32c);
DB_GLO_Backgrounds_Outlander_BoulderTrapZones((TRIGGER)S_PLA_BanditCave_TrapZone_C_81f387e2-400e-4bf4-a776-cbda4dd59c60);
DB_GLO_Backgrounds_Outlander_BoulderTrapWires((ITEM)S_PLA_BanditCave_Trap_Tripwire_C_001_222325f6-8657-496a-8e34-1215ec1d58b6);
DB_GLO_Backgrounds_Outlander_BoulderTrapWires((ITEM)S_PLA_BanditCave_Trap_Tripwire_C_000_3de7f2e9-3f0b-4b43-a96e-a3688b207b33);
PROC_TriggerRegisterForPlayers(S_PLA_BanditCave_TrapZone_C_81f387e2-400e-4bf4-a776-cbda4dd59c60);
TeleportToPosition(S_PLA_BanditCave_TrapZone_A_7dbeb14f-881e-4200-a8c1-c2b94b403d43, 51.8, 33.3, 591.3);
TeleportToPosition(S_PLA_BanditCave_TrapZone_B_9bbe3d04-a1a3-45eb-a422-456af1b4a32c, 51.4, 34.0, 598.2);

IF
DB_BUGFIX_Marker("GUS-314816")
AND
DB_PLA_BanditCave_WasInA((CHARACTER)_Player)
THEN
NOT DB_PLA_BanditCave_WasInA((CHARACTER)_Player);

IF
DB_BUGFIX_Marker("GUS-314816")
AND
DB_PLA_BanditCave_WasInB((CHARACTER)_Player)
THEN
NOT DB_PLA_BanditCave_WasInB((CHARACTER)_Player);
//END_REGION GUS-314816

//REGION GUS-314757
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
NOT DB_GlobalFlag(UND_FurnaceSearch_State_FoundForgeManual_ca7f9a3c-119e-4564-aa5a-267b5b84a0fb)
THEN
DB_BUGFIX_Marker("GUS-314757");
NOT DB_QuestDef_BookReadState("UND_AdamantineForge", "LearnedManual", S_UND_FurnaceSearch_MyconidDrowJournal_b437af92-c9f1-4657-961b-32ad0dbf39d9);
//END_REGION GUS-314757

//REGION GUS-310883

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_QuestDef_LevelUnloading("DEN_Conflict", "LeftRegion", "WLD_Main_A")
THEN
NOT DB_QuestDef_LevelUnloading("DEN_Conflict", "LeftRegion", "WLD_Main_A");
DB_BUGFIX_Marker("GUS-310883");

//END_REGION

//REGION GUS-189499
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-189499");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-189499")
THEN
DB_ItemOwnerShipTriggers("WLD_Main_A", S_UND_MyconidCircle_MushroomFieldOwnership_07_9b6cf50f-d156-4804-95cd-691c4b54e276, S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265);
DB_ItemOwnerShipTriggers("WLD_Main_A", S_UND_MyconidCircle_MushroomFieldOwnership_08_b8cb3587-43f8-43ee-a4ff-0b9b0a471d24, S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265);
DB_ItemOwnerShipTriggers("WLD_Main_A", S_UND_MyconidCircle_MushroomFieldOwnership_09_8b6ed749-42a1-4eed-9c1d-b95b8c64c548, S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265);
DB_ItemOwnerShipTriggers("WLD_Main_A", S_UND_MyconidCircle_MushroomFieldOwnership_10_81f6da32-c822-4e40-8490-df4bb4b6a4af, S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-189499")
AND
IsInTrigger(LOOT_Mushroom_Bullywugtrumpet_B_004_b2be45e2-9ef4-46b2-8850-31f2fedf2b37, S_UND_MyconidCircle_MushroomFieldOwnership_10_81f6da32-c822-4e40-8490-df4bb4b6a4af, 1)
AND
IsInInventory(LOOT_Mushroom_Bullywugtrumpet_B_004_b2be45e2-9ef4-46b2-8850-31f2fedf2b37, 0)
THEN
TeleportToPosition(LOOT_Mushroom_Bullywugtrumpet_B_004_b2be45e2-9ef4-46b2-8850-31f2fedf2b37, 70.742, 37.844, -103.967); // was unreachable
//END_REGION

//REGION GUS-184247
PROC
PROC_ApplySavegamePatches()
AND
QRY_ShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A")
THEN
DB_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-184247");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-184247")
THEN
NOT DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidCircle_DirectToSovereign_2c551ac0-c261-2268-c0d0-bdd251c99b89);
NOT DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidSovereign_934d97d0-922c-7c31-05fe-054bcc630447);
NOT DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c);
NOT DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca);
NOT DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)UND_Myconid_BroodingSovereign_Raft_f6f33683-5889-e6b0-e6a9-0810856ec3ea);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidCircle_DirectToSovereign_2c551ac0-c261-2268-c0d0-bdd251c99b89);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidSovereign_934d97d0-922c-7c31-05fe-054bcc630447);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_4a1577b3-2d32-68a1-3092-e9014053b35c);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)UND_MyconidCircle_BroodingSovereign_Leave_d7968940-c47a-7f64-28d6-6cd9a6c0aaca);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)UND_Myconid_BroodingSovereign_Raft_f6f33683-5889-e6b0-e6a9-0810856ec3ea);
//END_REGION

//REGION GUS-309155
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-309155");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-309155")
THEN
PROC_TriggerRegisterForPlayers(S_PLA_ChokePoint_LaezelInvolveZone_c4ef3fa8-7468-41a2-b46a-14b0d8bc2307);
//END_REGION GUS-309155

//REGION GUS-293954
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-293954");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-293954")
AND
IsInInventory(BOOK_GEN_Races_WarlockLetter_000_2606047a-c164-41a9-ae7e-07d01e9e5f46, 0)
AND
QRY_IsInRange(BOOK_GEN_Races_WarlockLetter_000_2606047a-c164-41a9-ae7e-07d01e9e5f46, S_DEN_HarpyNest_a5c87ab6-b38b-4c2b-bf4f-a1f5f391f79f, 10.0)
THEN
ToInventory(BOOK_GEN_Races_WarlockLetter_000_2606047a-c164-41a9-ae7e-07d01e9e5f46, S_DEN_HarpyNest_a5c87ab6-b38b-4c2b-bf4f-a1f5f391f79f);
DB_BUGFIX_Marker("GUS-293954", BOOK_GEN_Races_WarlockLetter_000_2606047a-c164-41a9-ae7e-07d01e9e5f46);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-293954")
AND
IsInInventory(BOOK_GEN_Planes_Annihilation_000_bbfbbb4a-6169-4d56-9ae5-4d554329ab82, 0)
AND
QRY_IsInRange(BOOK_GEN_Planes_Annihilation_000_bbfbbb4a-6169-4d56-9ae5-4d554329ab82, S_DEN_HarpyNest_a5c87ab6-b38b-4c2b-bf4f-a1f5f391f79f, 10.0)
THEN
ToInventory(BOOK_GEN_Planes_Annihilation_000_bbfbbb4a-6169-4d56-9ae5-4d554329ab82, S_DEN_HarpyNest_a5c87ab6-b38b-4c2b-bf4f-a1f5f391f79f);
DB_BUGFIX_Marker("GUS-293954", BOOK_GEN_Planes_Annihilation_000_bbfbbb4a-6169-4d56-9ae5-4d554329ab82);
//END_REGION GUS-293954

//REGION GUS-306857
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelLoadedOnce("INT_Main_A")
AND
NOT DB_GlobalFlag(GOB_ChickenChase_State_OwlbearAcquired_da704027-02ea-717c-4390-f538e5e5cd7a)
AND
DB_CAMP_GoblinHuntCelebration_BetraylFightComplete(1)
AND
NOT DB_GlobalFlag(CAMP_GoblinHuntCelebration_State_DrowBetrayalOver_75aa1308-f580-e495-4893-09d215528472)
AND
DB_GlobalFlag((FLAG)GOB_ChickenChase_State_OwlbearReplacedChicken_aabd6c48-57e4-12bb-8123-912f747f1f07)
AND
NOT DB_PermaDefeated(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
THEN
DB_BUGFIX_Marker("GUS-306857");
PROC_DisappearOutOfSight(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"Run",0,"");
PROC_GlobalSetFlagAndCache((FLAG)GOB_ChickenChase_State_OwlbearAcquired_da704027-02ea-717c-4390-f538e5e5cd7a);
//END_REGION

//REGION GUS-316506

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_State_Current(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment","DEN")
AND
DB_GlobalFlag((FLAG)ORI_ShadowHeart_HasMet_d06842a4-248e-7f83-da87-4eec7606178e)
AND
NOT DB_TopicalGreeting_Current(TG_ORI_ShadowheartRecruited_714a755a-0257-4f85-bc05-86464f531581)
AND
NOT DB_TopicalGreeting_Old(TG_ORI_ShadowheartRecruited_714a755a-0257-4f85-bc05-86464f531581)
AND
NOT DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-316506");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-316506")
THEN
PROC_TriggerUnregisterForPlayers(S_DEN_ShadowHeartSphere_ebe5b328-4bcd-431a-8507-a073b06fbe3c);
DB_SpotPlayers((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "Recruitment_Den", NULL_00000000-0000-0000-0000-000000000000, DEN_ShadowHeart_HasMet_9e9b8ecd-d618-7501-5bea-31355bf41d06);
DB_SpotPlayers_Continuous((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "Recruitment_Den");
DB_SpotPlayers_SpotTrigger((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "Recruitment_Den", S_DEN_ShadowHeartSphere_ebe5b328-4bcd-431a-8507-a073b06fbe3c);

//END_REGION

//REGION GUS-303563-B
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-303563-B");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-303563-B")
AND
GetCanInteract(S_UND_HiddenStash_LooseStone_121a4fd7-d1f0-4e11-b250-71f4ea1e6679, 0)
THEN
SetCanInteract(S_UND_HiddenStash_Bag_fec2dad1-307e-4923-ba03-bef084116767, 0);
DB_BUGFIX_Marker("GUS-303563-B");
//END_REGION GUS-303563-B

//REGION GUS-306966
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-306966");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-306966")
AND
DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedMutineers_581443f0-b4bd-d3c2-7122-a4d2aa7fb5f9)
AND
NOT DB_SceneManager((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30,"PROC_UND_KethericCity_Mutiny_Scene")
THEN
PROC_SetRelationMutual((FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95,(FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);
DB_BUGFIX_Marker("GUS-306966");
//END_REGION GUS-306966

//REGION GUS-290131
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-290131");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-290131")
AND
NOT DB_PermaDefeated(S_UND_FearfulRothe_Guard_001_90780cde-9241-478f-83a8-58a4a7d151fe)
AND
NOT DB_OffStage(S_UND_FearfulRothe_Guard_001_90780cde-9241-478f-83a8-58a4a7d151fe)
THEN
DB_BUGFIX_Marker("GUS-290131");
TemplateRemoveFrom(WPN_Duergar_Shield_B_0_747387ac-0dc7-47ab-8c69-75269ffc4dbc, S_UND_FearfulRothe_Guard_001_90780cde-9241-478f-83a8-58a4a7d151fe, 1);
//END_REGION GUS-290131

//REGION GUS-188785
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-188785");

// Gur Hunter shouldn't prefer Astarion until he meets him and learns that it is in fact Astarion
PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-188785")
AND
NOT DB_GlobalFlag((FLAG)HAG_GurHunter_State_Hostile_a6f13f9a-26ff-455e-9fdb-adc90777b0bd)
THEN
DB_BUGFIX_Marker("GUS-188785");
RemovePreferredAiTargetTag((CHARACTER)S_GLO_GurHunter_0e47fcb9-c0c4-4b0c-902b-2d13d209e760, (TAG)ASTARION_23a46e79-e73c-4043-940f-cb0aace9ab2e);
//END_REGION

//REGION GUS-204162
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-204162");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-204162")
THEN
DB_BUGFIX_Marker("GUS-204162");
PROC_UND_CheckDuergarCampLeave();

PROC
PROC_UND_CheckDuergarCampLeave()
AND
DB_UND_ElevatorGuards(_Rebel)
AND
DB_OffStage(_Rebel)
AND
DB_PermaDefeated(_Rebel)
THEN
PROC_SetOnStage(_Rebel, 1);

PROC
PROC_UND_CheckDuergarCampLeave()
AND
DB_UND_DuergarCamp_Rebels(_Rebel)
AND
DB_OffStage(_Rebel)
AND
DB_PermaDefeated(_Rebel)
THEN
PROC_SetOnStage(_Rebel, 1);

PROC
PROC_UND_CheckDuergarCampLeave()
AND
DB_UND_DuergarCamp_Absolutists(_Loyal)
AND
DB_OffStage(_Loyal)
AND
DB_PermaDefeated(_Loyal)
THEN
PROC_SetOnStage(_Loyal, 1);

//END_REGION GUS-204162

//REGION GUS-314803
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_UND_AdamantineGolem_Phase2_Spells("Shout_UND_Phase2_AdamantineGolem")
AND
NOT DB_UND_AdamantineGolem_Phase2_Spells("Shout_UND_Phase2_AdamantineGolem_Hardcore")
THEN
DB_UND_AdamantineGolem_Phase2_Spells("Shout_UND_Phase2_AdamantineGolem");
DB_UND_AdamantineGolem_Phase2_Spells("Shout_UND_Phase2_AdamantineGolem_Hardcore");
//END_REGION GUS-314803

//REGION GUS-310396
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_SaidPassword_8ac97f58-902c-a3b1-d360-e6b5aaa9b54d) // flagType: Global
AND
DB_GlobalFlag(PLA_ZhentShipment_State_ChestLost_a672d90e-72fa-4ce3-8152-6969e39ab521)
AND
DB_GlobalFlag(PLA_ZhentShipment_Rugan_Knows_Thief_26f50a78-b9bf-43f2-bedd-d7d7347a9128)
AND
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_GnollZhentsPresent_2fe0f447-2276-a930-90c0-ab99b4dc8a2a)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d)
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentDungeon_StopSpot_e62bcfd1-0407-4905-9361-3d6dba40a575)
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
NOT DB_SpotPlayers_SpotTrigger(CHARACTERGUID_S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca, "PLA_ZhentDungeon", S_PLA_ZhentDungeon_Dialog1Start_becd018b-0606-4610-b03b-4d3779023b67);
DB_BUGFIX_Marker("GUS-310396a");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)PLA_ZhentDungeon_State_FallBack_7a94f079-2bc8-495e-99f2-5b04b03a7d1d)
AND
DB_PLA_ZhentDungeon_SpotEvents(_, _Dialog)
AND
DB_DialogName(_Dialog, _ID)
THEN
PROC_ForceStopDialog(S_PLA_ZhentDungeon_Zhent02_8a064abd-3582-4a32-a9f8-748ad60f63ca);
DB_BUGFIX_Marker("GUS-310396b");

//END_REGION

//REGION GUS-315579
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
PROC_BG3_SavegamePatch_GUS315579_SetActiveScratchDB();
DB_BUGFIX_Marker("GUS-315579");

PROC
PROC_BG3_SavegamePatch_GUS315579_SetActiveScratchDB()
AND
DB_FOR_CourierDog_ActiveSummon(_Scratch)
THEN
DB_FOR_CourierDog_ActiveScratch(_Scratch);

PROC
PROC_BG3_SavegamePatch_GUS315579_SetActiveScratchDB()
AND
NOT DB_FOR_CourierDog_ActiveSummon(_)
THEN
DB_FOR_CourierDog_ActiveScratch((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901);
//END_REGION GUS-315579

//REGION GUS-306370
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-306370");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-306370")
AND
DB_UND_MyconidCircle_Dialogs(_SporeDuargar, _Dialog)
AND
NOT DB_Dead(_SporeDuargar)
AND
IsTagged(_SporeDuargar, (TAG)DWARF_486a2562-31ae-437b-bf63-30393e18cbdd, 1)
THEN
PROC_RemoveDialogEntryForSpeaker(_SporeDuargar,_Dialog);
DB_Dialogs(_SporeDuargar, _Dialog);
DB_BUGFIX_Marker("GUS-306370");
//END_REGION GUS-306370

//REGION GUS-306595
QRY
QRY_BUGFIX_GUS306595_HasBusyDialog((CHARACTER)_Character)
AND
DB_UND_InjuredGnome_Busy(_Character)
THEN
DB_NOOP(1);
//END_REGION GUS-306595

//REGION GUS-315508

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_DEN_GraveQueue((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
DB_BUGFIX_Marker("GUS-315508");
NOT DB_DEN_GraveQueue((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_DEN_OccupiedGraves(_Marker, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _Grave, _OpenGrave)
THEN
DB_BUGFIX_Marker("GUS-315508");
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-315508");
SetOnStage(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 1);
PROC_GUS315508_MoveWyllToCamp();

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-315508")
AND
DB_DEN_OccupiedGraves(_Marker, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _Grave, _OpenGrave)
THEN
NOT DB_DEN_OccupiedGraves(_Marker, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _Grave, _OpenGrave);
SetOnStage(_Marker, 0);
SetOnStage(_Grave, 0);
SetOnStage(_OpenGrave, 0);

PROC
PROC_GUS315508_MoveWyllToCamp()
AND
QRY_Camp_GetCamperPos(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_QRYRTN_Camp_GetCamperPos(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(TRIGGER)_CampPos)
THEN
PROC_Camp_TeleportToCamp(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _CampPos);

//END_REGION

//REGION GUS-314403
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_Surrender_BlockPermaDefeatedOnFlee((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
DB_BUGFIX_Marker("GUS-314403");
DB_PreventKnockedOutPermaDefeated((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_Surrender_BlockPermaDefeatedOnFlee((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
//END_REGION

//REGION GUS-314304
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_QuestIsClosed("HIDDEN_WLD_Rewards") // if the quest was incorrectly closed before (it should have always stayed open)
AND
DB_UND_ArcaneTower_SecretRevealed(1) // and Bernard tried to give the ring to the player
AND
IsInInventoryOf(S_UND_ArcaneTower_SecretRing_a5903973-28eb-4d41-a0b9-478680492145, S_UND_Automaton_5038c0f2-0022-4699-82ce-a319b30616bb, 1) // but failed
AND
DB_Players(_AnyPlayer) // let's give the reward to a random character from the party (normally - avatar of the host, since it's the first entry in DB_Players)
AND
NOT DB_BUGFIX_Marker("GUS-314304")
THEN
DB_BUGFIX_Marker("GUS-314304");
QuestUpdate(_AnyPlayer, "HIDDEN_WLD_Rewards_New", "UND_ArcaneTower_SecretRing");
//END_REGION

//REGION GUS-315022
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_Camp_QueuedNight(_Flag)
AND
DB_CAMP_GoblinHuntCelebration_NightFlags(_Flag)
AND
DB_InCamp(_Follower)
AND
DB_CAMP_GoblinHuntCelebration_DialogsForFollowers(_Follower, _Dialog)
THEN
DB_BUGFIX_Marker("GUS-315022");
PROC_CAMP_GoblinHuntCelebration_CancelRelationshipDialog(_Follower);
//END_REGION

//REGION GUS-160446

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
THEN
DB_ORI_Gale_DoubleBHVRTrigger("WLDDUNABB", c8093b0e-c397-8c35-50b5-5306276ce038);
DB_ORI_Gale_DoubleBHVRTrigger("WLDBAS", bc0853da-e8c1-81b6-5fbc-8b2857a9ce25);
DB_ORI_Gale_DoubleBHVRTrigger("WLDCAVGRN", 76a88bef-4c6c-881c-31db-50e141aa976e);
DB_ORI_Gale_DoubleBHVRTrigger("WLDDUNSHA", d9ad528e-6cfb-8d74-41bc-ceeb1dcb17c6);
DB_ORI_Gale_DoubleBHVRTrigger("WLDMAIN" , 6ce4f604-398f-843a-5ff5-8841a46cda42);
DB_ORI_Gale_DoubleBHVRTrigger("WLDCAVSND", 697807f2-124b-8512-3505-e0a86896058f);
DB_ORI_Gale_DoubleBHVRTrigger("WLDUND", 19b48e09-38a1-85c3-315b-0439f501eb89);
DB_BUGFIX_Marker("GUS-160446");

//END_REGION

//REGION GUS-318025

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
GetBaseFaction(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, (FACTION)NeutralNPC_cfb709b3-220f-9682-bcfb-6f0d8837462e)
THEN
SetFaction(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, (FACTION)GLO_Desire_be958ea7-9eae-f629-4450-f0b6cadfea1a);
DB_BUGFIX_Marker("GUS-318025");

//END_REGION

//REGION GUS-316064

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT DB_GlobalFlag(UND_MonkAmulet_Event_OfferedQuest_1226f854-c4f6-af9f-6863-e7c3d013647f)
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-316064");
QuestSetCategory("UND_MonkAmulet","Underdark");

//END_REGION GUS-316064

//REGION GUS-315805
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
DB_Camp_RequiredTalks(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _)
AND
NOT DB_InCamp((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_BUGFIX_Marker("GUS-315805");
PROC_Camp_RequiredTalks_Complete(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
//END_REGION GUS-315805

//REGION GUS-316388
PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_PermaDefeated(S_DEN_PickpocketTrader_e1fda08b-45d4-41db-84b5-20e9931ba5af)
AND
DB_DEN_Thieflings_MattisHasMetFlags(_Flag)
AND
DB_PartOfTheTeam(_Player)
AND
GetFlag(_Flag, _Player, 1)
THEN
SetFlag((FLAG)GLO_Thieflings_State_MetMattis_0ad4e872-ff86-4024-918f-de5823c85845, _Player);
DB_BUGFIX_Marker("GUS-316388");
//END_REGION GUS-316388
//REGION GUS-316191
// If Scratch exists, make sure his config is set correctly
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
Exists(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, 1)
AND
NOT GetAnubisConfig(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, "GLO_CourierDog_Act1")
THEN
DEV_EnableAnubis(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, "GLO_CourierDog_Act1");
DB_BUGFIX_Marker("GUS-316191-A");

// Send missing GoblinHuntCelebration clear event to Scratch if TieflingCelebration is over
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121)
AND
NOT DB_Camp_QueuedNight((FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121)
THEN
SetEntityEvent(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, "CAMP_GoblinHuntCelebration_ClearDog");
DB_BUGFIX_Marker("GUS-316191-B");

// Send missing GoblinHuntCelebration clear event to Scratch if RaiderCelebration is over
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)NIGHT_GoblinHunt_RaiderCelebration_86fee25f-1069-4f17-89fa-4c5b69f82e0b)
AND
NOT DB_Camp_QueuedNight((FLAG)NIGHT_GoblinHunt_RaiderCelebration_86fee25f-1069-4f17-89fa-4c5b69f82e0b)
THEN
SetEntityEvent(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, "CAMP_GoblinHuntCelebration_ClearDog");
DB_BUGFIX_Marker("GUS-316191-C");
//END_REGION GUS-316191

//REGION GUS-315367
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GLO_HeadRemoval((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTERROOT)UNI_PLA_Karlach_Headless_3c3bedb4-917a-4663-9a8a-d18611aaac95, (ITEM)S_GLO_KarlachHead_931f6df2-b546-422c-beff-fe91682bdf49)
AND
NOT DB_GLO_HeadRemoval_InaccessibleIfOffstage((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_GLO_HeadRemoval_InaccessibleIfOffstage((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_BUGFIX_Marker("GUS-315367-Head");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT DB_GlobalFlag((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2)
AND
DB_CampNight((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2,_,_)
THEN
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2,(FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206, (FLAG)ORI_WyllConfrontation_State_KnockedOutKarlach_8c23b5fe-732f-40e8-a0cb-bf165b7bf5c7);
DB_BUGFIX_Marker("GUS-315367-Night");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_KnockedOut((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
IsOnStage(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0)
THEN
SetFlag((FLAG)ORI_WyllConfrontation_State_KnockedOutKarlach_8c23b5fe-732f-40e8-a0cb-bf165b7bf5c7, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-315367-KO");
//END_REGION GUS-315367

//REGION GUS-314918
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("WLD_Main_A")
THEN
DB_DEN_DangerzoneStates("DEN_State_AttackOnDen");
DB_DEN_DangerzoneStates("DEN_State_DruidAttack");
DB_BUGFIX_Marker("GUS-314918");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
DB_State_Current(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", _DangerState)
AND
DB_DEN_DangerzoneStates(_DangerState)
AND
DB_DEN_InDenTriggers(_Trigger)
THEN
DB_DangerZone(_Trigger, "DEN_DangerStateActive");
//END_REGION

//REGION GUS-318878

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6 Hotfix 5")
AND
DB_InDangerZone(_Player,_ID)
AND
NOT QRY_DangerZone_IsInDangerZoneTrigger(_Player, _ID)
THEN
PROC_DangerZone_Dirty(_Player);

//END_REGION

//REGION GUS-318931

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6 Hotfix 4")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
GetHostCharacter(_Character)
AND
QuestIsAccepted(_Character, "ORI_COM_Wyll", 0)
THEN
QuestUpdate(_Character, "ORI_COM_Wyll", "RecruitedWyll");

//END_REGION

//REGION GUS-313587
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-313587");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-313587")
THEN
DB_GLO_Sussur_UnderdarkRegion(S_UND_SussurZone_006_fadac617-d688-42cf-8ccb-747b027337eb);
DB_BUGFIX_Marker("GUS-313587");
//END_REGION

//REGION GUS-314003
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","WLD_Main_A","GUS-314003");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-314003")
THEN
RequestSetBaseArchetype((CHARACTER)S_FOR_GnomeGoblin1_b2c582af-bc69-48b3-a004-648562dab404, "Act1_FOR_Fezzerk");
//END_REGION

//REGION GUS-316687

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
DB_GLO_Playable(_Character)
AND
DB_PartOfTheTeam(_Character)
AND
NOT QRY_GLO_Sussur_InUnderdark(_Character)
THEN
DB_BUGFIX_Marker("GUS-316687", _Character);
RealtimeObjectTimerLaunch(_Character,"Timer_GLO_Sussur_Wither",1000);

//END_REGION

//REGION GUS-311425
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-311425");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-311425")
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagGaveReward_72881644-628d-0a3f-4de1-3f6dce1078b7)
THEN
DB_HAG_HagLair_HagHairRootTemplate((ROOT)Quest_HAG_HagHair_Charisma_eec5de82-c988-40e6-8f10-474d5675c550);
DB_HAG_HagLair_HagHairRootTemplate((ROOT)Quest_HAG_HagHair_Constitution_d16922ba-a36b-4015-8072-27610821fb53);
DB_HAG_HagLair_HagHairRootTemplate((ROOT)Quest_HAG_HagHair_Dexterity_7e3afbf6-4e1a-444e-826d-f8e0e0a8308f);
DB_HAG_HagLair_HagHairRootTemplate((ROOT)Quest_HAG_HagHair_Intelligence_9abbab89-d29f-47c0-9ffe-f12018dd83d9);
DB_HAG_HagLair_HagHairRootTemplate((ROOT)Quest_HAG_HagHair_Strength_8f6b0c08-d1b1-4ae7-ade2-da3c679ce323);
DB_HAG_HagLair_HagHairRootTemplate((ROOT)Quest_HAG_HagHair_Wisdom_de2c9582-fab5-4d5e-9a81-44d67af6a681);
DB_BUGFIX_Marker("GUS-311425");

IF
TemplateAddedTo(_HagHairItemTemplate, _HagHairItem, _Player, _)
AND
DB_HAG_HagLair_HagHairRootTemplate(_HagHairItemTemplate)
AND
DB_Players((CHARACTER)_Player)
AND
DB_BUGFIX_Marker("GUS-311425")
AND
QRY_OnlyOnce("DB_HAG_HagLair_HagHairRootTemplateChanged")
THEN
Transform(_HagHairItem, _HagHairItemTemplate, (SHAPESHIFTRULE)PHYSICAL_4acc6277-6dcd-4110-9450-b9379beaedac);
PROC_DB_HAG_HagLair_ClearHairDB();

PROC
PROC_DB_HAG_HagLair_ClearHairDB()
AND
DB_HAG_HagLair_HagHairRootTemplate(_HairTemplate)
THEN
NOT DB_HAG_HagLair_HagHairRootTemplate(_HairTemplate);
//END_REGION GUS-311425

//REGION GUS-307257
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-307257");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-307257")
AND
DB_GlobalFlag((FLAG)UND_MyconidCircle_State_GainedAccess_fb9b0ee2-a499-cef2-fd3e-d9556050ea6a)
AND
NOT DB_GlobalFlag((FLAG)UND_MyconidCircle_SpokeWithSovereign_155b4ce9-fd7b-445a-afbd-64cb5bf2d707)
AND
NOT DB_GlobalFlag((FLAG)UND_MyconidCircle_Sovereign_State_PermaDefeated_bcfa3d32-7250-4c44-9eff-fbf30cef2b6e)
THEN
DB_BUGFIX_Marker("GUS-307257");
PROC_UnlockPartyMarker("UND_MyconidCircle_Spaw");
//END_REGION

//REGION GUSX-8925
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "WLD_Main_A", "GUSX-8925");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-8925")
AND
DB_UND_AdamantineForge_LavaCreated(1)
AND
DB_UND_AdamantineForge_PlatformDown(1)
AND
NOT DB_UND_AdamantineForge_AnvilDown(1)
AND
DB_UND_AdamantineForgeReceptacle(_, _Forge, _, _)
AND
GetCanInteract(_Forge,0)
THEN
SetCanInteract(_Forge, 1);
DB_BUGFIX_Marker("GUSX-8925_PlatformDown");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-8925")
AND
NOT DB_UND_AdamantineForge_PlatformDown(1)
AND
DB_State_Current(S_UND_AdamantineForge_Forge_7a42a62c-0352-4f94-bf72-b3809cc83a1d, "UND_AdamantineForge_Craft", _State)
AND
NOT DB_UND_AdamantineForge_MoldFilledStates(_State)
AND
DB_UND_AdamantineForgeReceptacle("Mold", _Mold, _, _)
AND
GetCanInteract(_Mold,0)
THEN
SetCanInteract(_Mold, 1);
DB_BUGFIX_Marker("GUSX-8925_PlatformUp_Mold");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-8925")
AND
NOT DB_UND_AdamantineForge_PlatformDown(1)
AND
DB_State_Current(S_UND_AdamantineForge_Forge_7a42a62c-0352-4f94-bf72-b3809cc83a1d, "UND_AdamantineForge_Craft", _State)
AND
NOT DB_UND_AdamantineForge_CrucibleFilledStates(_State)
AND
DB_UND_AdamantineForgeReceptacle("Crucible", _Crucible, _, _)
AND
GetCanInteract(_Crucible,0)
THEN
SetCanInteract(_Crucible, 1);
DB_BUGFIX_Marker("GUSX-8925_PlatformUp_Crucible");

//END_REGION GUSX-8925

//REGION GUS-207793
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "WLD_Main_A", "GUS-313587");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-313587")
AND
DB_PermaDefeated((CHARACTER)S_UND_Minotaur_001_19edd11d-fde0-4aa9-95f6-fb2e3f2bc570)
AND
DB_PermaDefeated((CHARACTER)S_UND_Minotaur_002_9e58f686-0534-4234-8805-180118533810)
AND
DB_PermaDefeated((CHARACTER)S_UND_SharFort_Minotaur_Bait_b63c0d26-7c5f-4dc5-a3d1-2cc99367c809)
AND
IsInCombat((CHARACTER)S_UND_Bulette_307934b5-6fb5-4fdc-a7ff-433a7ba175b3, 0)
AND
NOT DB_WorldGossipTrigger(S_PartyBanterTrigger_UND_MinotaursCleared_e7207a90-3c21-4e0a-92c6-1c2128436e69,_,_)
THEN
DB_BUGFIX_Marker("GUS-207793");
PROC_RegisterWorldGossipTrigger((TRIGGER)S_PartyBanterTrigger_UND_MinotaursCleared_e7207a90-3c21-4e0a-92c6-1c2128436e69);
//END_REGION GUS-207793

//REGION GUS-314799
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)PLA_KarlachRecruitmentTollhouse_Quest_AcceptedSearch_3b379a18-9b46-4f66-9baf-0e7ce938c1d0)
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_GLO_HeadRemoval((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTERROOT)UNI_PLA_Karlach_Headless_3c3bedb4-917a-4663-9a8a-d18611aaac95, (ITEM)S_GLO_KarlachHead_931f6df2-b546-422c-beff-fe91682bdf49)
THEN
DB_GLO_HeadRemoval_Dialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)PLA_KarlachRecruitment_HeadLoot_25793061-8650-7d0e-9b79-d98ecaee9ca7);
DB_GLO_HeadRemoval((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTERROOT)UNI_PLA_Karlach_Headless_3c3bedb4-917a-4663-9a8a-d18611aaac95, (ITEM)S_GLO_KarlachHead_931f6df2-b546-422c-beff-fe91682bdf49);
DB_GLO_HeadRemoval_InaccessibleIfOffstage((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_BUGFIX_Marker("GUS-314799");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
QRY_QuestUpdateIsUnlockedForAny("PLA_PaladinsOfTyr", "TakeHead")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_GLO_HeadRemoval((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTERROOT)UNI_PLA_Karlach_Headless_3c3bedb4-917a-4663-9a8a-d18611aaac95, (ITEM)S_GLO_KarlachHead_931f6df2-b546-422c-beff-fe91682bdf49)
THEN
DB_GLO_HeadRemoval_Dialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)PLA_KarlachRecruitment_HeadLoot_25793061-8650-7d0e-9b79-d98ecaee9ca7);
DB_GLO_HeadRemoval((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTERROOT)UNI_PLA_Karlach_Headless_3c3bedb4-917a-4663-9a8a-d18611aaac95, (ITEM)S_GLO_KarlachHead_931f6df2-b546-422c-beff-fe91682bdf49);
DB_GLO_HeadRemoval_InaccessibleIfOffstage((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_BUGFIX_Marker("GUS-314799");
//END_REGION GUS-314799

//REGION GUS-231343
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "WLD_Main_A", "GUS-231343");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-231343")
THEN
DB_BUGFIX_Marker("GUS-231343");
DB_UND_MyconidCircle_CrimeDialogs((DIALOGRESOURCE)NGB_Myconids_Crimes_03ae7a90-8857-cb30-0399-7dc606f14f9b);
DB_UND_MyconidCircle_CrimeDialogs((DIALOGRESOURCE)NGB_Myconids_Trespass_96142562-d495-9262-8133-9da2bb86817b);
//END_REGION

//REGION GUS-317123
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelUnreachable("TUT_Avernus_C")
AND
DB_OnlyOnce("TUT_LowerDeck_GuidePartyFollower")
AND
NOT DB_Dead((CHARACTER)S_TUT_GithGuide_201a0ee6-6411-4564-aaea-1ca057bfea04)
THEN
Die(S_TUT_GithGuide_201a0ee6-6411-4564-aaea-1ca057bfea04, DEATHTYPE.DoT, 1);
DB_BUGFIX_Marker("GUS-317123");
//END_REGION

//REGION GUS-315148
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "WLD_Main_A", "GUS-315148");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-315148")
THEN
DB_BUGFIX_Marker("GUS-315148");
PROC_SetRelation((FACTION)ACT1_UND_ElevatorGnome_c71c6d74-33a4-41c8-8256-f85a7c763b20, (FACTION)ACT1_UND_DuergarRebels_ElevatorGuards_a14e975e-df2c-4a93-874a-311e45969a79, 51);
//END_REGION GUS-315148

//REGION GUS-316622
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "WLD_Main_A", "GUS-316622");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-316622")
THEN
DB_BUGFIX_Marker("GUS-316622");
TeleportToPosition(S_DEN_DruidGaspit_Cave_001_4b2dbe37-efd9-411d-a59c-749b1e47e348,-452.599, 0.662, 34.931);
TeleportToPosition(S_GOB_Checkpoint_CapturedGoblinStash_Pile_d9f47d17-8234-4947-952a-aa5a70b479fb, -133.855, 6.415, 396.001);
//END_REGION GUS-316622

//REGION GUS-317358
// One time fix for the Tome not being in the inventory of the owner.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_PartOfTheTeam(_Player)
AND
GetFlag((FLAG)FOR_DangerousBook_State_BookOwner_06022678-24ed-35af-de93-bd91abc02452, _Player, 1)
AND
Exists((ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507, 1)
AND
IsDestroyed((ITEM)S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507, 0)
AND
NOT GetDirectInventoryOwner(S_FOR_DangerousBook_Tome_73ea8888-ed82-4ca5-b9f9-0c9119873507, _Player)
THEN
DB_FOR_DangerousBook_MoveTome(_Player); // will trigger book to get moved to player inventory after status is removed.
PROC_FOR_DangerousBook_MoveTome();
DB_BUGFIX_Marker("GUS-317358");
//END_REGION GUS-317358

//REGION GUS-315038
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)FOR_DangerousBook_State_BookFinished_489a23a0-758a-97bd-bd0c-d6b417c20af3,"Act1_Sage_NecromancerTomeFinished")
THEN
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)FOR_DangerousBook_State_BookFinished_489a23a0-758a-97bd-bd0c-d6b417c20af3,"Act1_Sage_NecromancerTomeFinished");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_SorcerousSundries_State_LastPageThayRead_e25f4165-2aa7-464c-a9aa-ca12715505de,"Act1_Sage_NecromancerTomeFinished");
DB_BUGFIX_Marker("GUS-315038");

//END_REGION

//REGION GUS-318841

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_ORI_DarkUrge_AlfiraMurderVictim(_Victim)
AND
NOT DB_Dead(_Victim)
AND
Exists(_Victim, 1)
AND
DB_ORI_DarkUrge(_DarkUrge)
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_MurderedAlfiraOrAlternativeInSleep_1b2a9aa5-7cc1-42d3-98d1-a254d612c37a)
THEN
Die(_Victim, DEATHTYPE.DoT, _DarkUrge, 1, 1, 0.0);

//END_REGION

//REGION

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "WLD_Main_A", "RemoveApprenticeStoryItems");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "RemoveApprenticeStoryItems")
AND
DB_DEN_Apprentice_ImportantItems((ITEM)_Item)
AND
Exists(_Item,1)
AND
IsStoryItem(_Item,1)
THEN
DB_BUGFIX_Marker("RemoveApprenticeStoryItems",_Item);
NOT DB_DEN_Apprentice_ImportantItems(_Item);
SetStoryItem(_Item, 0);

//END_REGION

//REGION GUS-319699

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-319699");
PROC_CRA_Escape_CheckDone();

//END_REGION

//REGION GUS-317156
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
IsOnStage(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, 0)
AND
DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_GlobalFlag((FLAG)GOB_CapturedGoblin_State_Executed_5505345c-482d-cfc5-3a2b-987611beb4e3)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "DEN_CapturedGoblin", "SavedFromSpider");
//END_REGION GUS-317156

//REGION GUS-303835

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_OnlyOnce("MOO_Execution_Minthara")
THEN
PROC_GOB_ClearGoblinFestivitiesFallback();
DB_BUGFIX_Marker("GUS-303835");

//END_REGION GUS-303835

//REGION GUS-314526
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 1")
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_Is_InCombat(S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0, _Combat)
AND
NOT DB_InteractiveDialogSpeaker(_, S_PLA_ConflictedFlind_Boss_34464430-fed8-4f50-86d5-bd35846920a0)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _Combat)
AND
QRY_OnlyOnce("GUS-314526")
THEN
ResumeCombat(_Combat);
DB_BUGFIX_Marker("GUS-314526");
//END_REGION GUS-314526

//REGION GUS-318811
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 4")
AND
DB_BUGFIX_Marker("GUS-306857")
AND
DB_GlobalFlag((FLAG)CAMP_OwlbearCub_State_BecameCampFollower_a9742288-21b5-428a-9efa-a2e73981c02f)
THEN
DB_BUGFIX_Marker("GUS-318811");
PROC_SetOnStage(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFLag((FLAG)CAMP_OwlbearCub_State_BecameCampFollower_a9742288-21b5-428a-9efa-a2e73981c02f)
AND
NOT DB_InCamp(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
NOT DB_PermaDefeated(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
DB_ActiveCamp(_ActiveCamp)
AND
DB_ORI_OriginCampData(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,_ActiveCamp,_Trigger)
THEN
TeleportTo(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,_Trigger);
PROC_SetOnStage(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,1);
DB_BUGFIX_Marker("GUS-318811_FixedCubMissingInCamp");
//END_REGION

//REGION GUS-318804

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 4")
AND
DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_ORI_Minthara_RemoveKnockedOutLater(1)
AND 
NOT DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
AND
IsOnStage(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0)
THEN
DB_ORI_Minthara_RemoveKnockedOutLater(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 4")
AND
DB_ORI_Minthara_RemoveKnockedOutLater(1)
THEN
NOT DB_GLO_DefeatCounter(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GOB_GoblinHunt_Leaders");
PROC_GLO_DefeatCounter_CheckFinished("GOB_GoblinHunt_Leaders");
DB_BUGFIX_Marker("GUS-318804");
//END_REGION GUS-318804

//REGION GUS-311607
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Players(_Player)
AND
GetFlag((FLAG)DEN_Hideout_State_GivenWarning_0abd66e5-6337-025e-6def-a5d456e5e310, _Player, 1)
THEN
DB_BUGFIX_Marker("GUS-318804");
ClearFlag(DEN_Hideout_State_GivenWarning_0abd66e5-6337-025e-6def-a5d456e5e310, _Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Players(_Player)
AND
GetFlag((FLAG)DEN_Thieflings_Event_HideoutTrespassCrimeResolved_8778b66b-4219-878c-42ac-94b5656bf450, _Player, 1)
THEN
DB_BUGFIX_Marker("GUS-318804");
DB_PATCH_HideoutKidsConfigs((CHARACTER)S_DEN_TieflingKid_004_6644185d-385e-4dfc-973c-bb854cbfd540, "DEN_TieflingKid_004");
DB_PATCH_HideoutKidsConfigs((CHARACTER)S_DEN_RobberKid_94e865e9-790d-4633-a378-8fb50832b5e9, "DEN_RobberKid");
DB_PATCH_HideoutKidsConfigs((CHARACTER)S_DEN_Pickpocket_540ddc1f-42c6-4347-ba03-b3cf3d3942ab, "DEN_Pickpocket");
DB_PATCH_HideoutKidsConfigs((CHARACTER)S_DEN_PickpocketTrader_e1fda08b-45d4-41db-84b5-20e9931ba5af, "DEN_PickpocketTrader");
PROC_DEN_Thiefling_HideoutCrimeDisableFix();

PROC
PROC_DEN_Thiefling_HideoutCrimeDisableFix()
THEN
PROC_CharacterDisableCrime((CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925, "DEN_ThieflingHideoutTrespass");
PROC_RemoveDBTrespassTrigger(S_DEN_Thieflings_HideoutCrimeRegion_5e96478b-d5df-41d3-a20e-4ae522f75144, NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925);

PROC
PROC_DEN_Thiefling_HideoutCrimeDisableFix()
AND
DB_PATCH_HideoutKidsConfigs((CHARACTER)_Child, _AnubisConfig)
AND
GetAnubisConfig(_Child, "")
AND
GetFlag((FLAG)DEN_Thieflings_Event_Abandoning_883a6c02-9091-4b29-8bc3-99e070e3648b, _Child, 1)
THEN
PROC_SetAnubisConfig(_Child, _AnubisConfig);
PROC_DEN_Thiefling_RestartAbandon(_Child);

PROC
PROC_DEN_Thiefling_RestartAbandon((CHARACTER)_Child)
AND
GetFlag((FLAG)DEN_Thieflings_State_AtHideoutPoint_5f768dc1-8294-49ee-b2d2-964fcb22f5ff, _Child, 1)
THEN
PROC_DEN_Thieflings_CollectTreasures();
PROC_DEN_ThieflingHideout_GiveKidItem();

PROC
PROC_DEN_Thiefling_RestartAbandon((CHARACTER)S_DEN_RobberKid_94e865e9-790d-4633-a378-8fb50832b5e9)
AND
GetFlag((FLAG)DEN_Thieflings_State_AtHideoutPoint_5f768dc1-8294-49ee-b2d2-964fcb22f5ff, S_DEN_RobberKid_94e865e9-790d-4633-a378-8fb50832b5e9, 1)
THEN
PROC_CharacterMoveTo((CHARACTER)S_DEN_RobberKid_94e865e9-790d-4633-a378-8fb50832b5e9, S_DEN_Thieflings_RobberKidAbandonArea_b61af23c-a905-4c93-a0ea-94c410b7278d, "Run", "");

PROC
PROC_DEN_Thiefling_HideoutCrimeDisableFix()
AND
DB_DEN_Thieflings_HideoutKids(_Child)
THEN
PROC_CharacterDisableCrime((CHARACTER)_Child, "DEN_HideoutKidAlarm_Investigate");
PROC_CharacterDisableCrime((CHARACTER)_Child, "DEN_WaitForMol");

PROC
PROC_DEN_Thiefling_HideoutCrimeDisableFix()
AND
DB_GlobalFlag((FLAG)DEN_Hideout_Event_TurnedKidsHostile_17cfabeb-f1d7-9432-0e29-5aecfcef1a18)
THEN
ClearFlag(DEN_Hideout_Event_TurnedKidsHostile_17cfabeb-f1d7-9432-0e29-5aecfcef1a18);

IF
FlagCleared((FLAG)DEN_Hideout_Event_TurnedKidsHostile_17cfabeb-f1d7-9432-0e29-5aecfcef1a18, _, _)
THEN
PROC_GlobalSetFlagAndCache((FLAG)DEN_Hideout_Event_TurnedKidsHostile_17cfabeb-f1d7-9432-0e29-5aecfcef1a18);
//END_REGION

//REGION GUS-318344
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_StartDialog_StuckTimelineLoad_StuckDetected((DIALOGRESOURCE)ORI_AstarionHunger_BoarExamine_2fa501df-bef4-31ed-9ff0-07b08a4474f5)
THEN
PROC_BUGFIX_318344_TryClearBoarDialog();

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_StartDialog_StuckTimelineLoad_StuckDetected((DIALOGRESOURCE)ORI_AstarionHunger_BoarExamine_POM_Astarion_9b32382e-53a9-d78d-4e16-ce30daf584fc)
THEN
PROC_BUGFIX_318344_TryClearBoarDialog();

PROC
PROC_BUGFIX_318344_TryClearBoarDialog()
AND
DB_ORI_AstarionHunger_Boars((CHARACTER)_Boar, _)
THEN
DB_BUGFIX_Marker("GUS-318344");
PROC_ForceStopDialog(_Boar);
//END_REGION GUS-318344

//REGION GUS-319486
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
AND
DB_GlobalFlag(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
NOT DB_GlobalFlag((FLAG)UND_TheDrowNere_Event_Leave_d12183d4-3907-4325-8913-988bb88e4377)
AND
NOT DB_Dialogs(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, UND_TheDrowNere_FollowUp_6b0c0d3d-91b3-84af-3704-8edad589d983)
AND
GetRelation((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)ACT1_UND_Drow_43f9502c-b3f7-fb74-0065-b8723be2dc95, _Relation)
AND
_Relation > 0
THEN
DB_BUGFIX_Marker("GUS-319486");
PROC_RemoveDialog((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);
DB_Dialogs(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, UND_TheDrowNere_FollowUp_6b0c0d3d-91b3-84af-3704-8edad589d983);
//END_REGION GUS-319486

//REGION GUS-320052
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_GlobalFlag(DEN_AttackOnDen_Event_Start_c641da6a-b3f5-4873-bd34-c53768d30d6f)
AND
NOT DB_GlobalFlag(DEN_AttackOnDen_State_RaiderVictory_abe1bce8-c234-4afe-a490-76210d98a078)
AND
NOT DB_GlobalFlag(DEN_AttackOnDen_State_DenVictory_71c7f23e-3ff1-c9b8-3ef5-d75fa1b42c8d)
AND
DB_DEN_AttackOnDen_TieflingDefeatCounters(_Combat)
THEN
PROC_GUS320052_CheckTieflingDefeatState(_Combat);

PROC
PROC_GUS320052_CheckTieflingDefeatState((STRING)_Combat)
AND
NOT DB_DEN_AttackOnDen_DefeatCounterComplete(_Combat)
AND
NOT DB_GLO_DefeatCounter_State(_, _Combat, _)
THEN
PROC_GLO_DefeatCounter_CheckFinished(_Combat);
DB_BUGFIX_Marker("GUS-320052");

//END_REGION

//REGION GUSX-739

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "HAG_HagSpawn", "LairFight", 1)
THEN
QuestUpdate(_Player, "GLO_Tadpole", "HagHostile");

//END_REGION

//REGION GUS-320076

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_QuestIsOpened("DEN_IdolTheft")
THEN
DB_BUGFIX_Marker("GUS-320076");
QuestUpdate("DEN_IdolTheft", "GroveChanged");

//END_REGION

//REGION 
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_CAMP_HalsinMorningAfterScene(1)
AND
DB_Dead(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
NOT DB_CAMP_HalsinMorningAfterScene(1);
NOT DB_InCamp(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
PROC_SetOnStage(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0);
DB_BUGFIX_Marker("GUS-319541");
//END_REGION

//REGION GUSX-5661

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "WLD_Main_A", "GUSX-5661");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-5661")
THEN
SetCanInteract((ITEM)TOOL_Ladder_Web_10n5H_A_000_399920b9-8948-45be-b0ec-2c8d838536dd, 0);
SetCanInteract((ITEM)TOOL_Web_Ladder_10n5H_A_000_d92bbd40-84eb-404b-8b7f-97690ab10dff, 0);
SetCanInteract((ITEM)TOOL_Ladder_Web_10n5H_A_002_272ee7f8-92be-402b-9667-5ceab523e39b, 0);

//END_REGION

//REGION GUSX-1068
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)CAMP_Astarion_SecondNight_AnyCelebration_a7bbbb0d-a3f4-4e8c-afcf-c6bc366bf2a5)
AND
DB_CAMP_GoblinHuntCelebration_SexScenes(_, (DIALOGRESOURCE)CAMP_Astarion_SD_ROM_SecondNight_693a16c6-9b9d-fee9-db37-7207ab63c913, _) // the default scene has been replaced
AND
DB_Players(_Player)
AND
GetFlag((FLAG)CAMP_GoblinHunt_State_AstarionPartnerChosen_b7d63377-4329-4199-3140-7f09875cf5b2, _Player, 1)
AND
GetFlag((FLAG)CAMP_GoblinHunt_State_AstarionPartner_457198bf-8e87-3365-e546-3c6828e5941b, _Player, 1)
AND
GetFlag((FLAG)ORI_Astarion_State_AgreedOnSecondNight_a3cfc89a-77c4-485d-9e40-a724b2fa965e, _Player, 1)
THEN
DB_BUGFIX_Marker("GUSX-1068");
// we store the player with possible incorrect flag combination, but to prevent possible errors
// we don't fix immediately, only when dialog CAMP_GoblinHuntCelebration_SD_SelectNight is triggered
// if the save was made during that dialog or immediately after - we don't change anything to avoid messing
// up already queued nights
DB_BUGFIX_GUSX_1068_PlayerWithIncorrectFlag((CHARACTER)_Player);

PROC
PROC_DialogFlagSetup((DIALOGRESOURCE)CAMP_GoblinHuntCelebration_SD_SelectNight_750df06d-5a74-8f6b-cd1f-947055afbc2e, _)
AND
DB_BUGFIX_GUSX_1068_PlayerWithIncorrectFlag((CHARACTER)_Player)
THEN
ClearFlag((FLAG)CAMP_GoblinHunt_State_AstarionPartnerChosen_b7d63377-4329-4199-3140-7f09875cf5b2, _Player);
NOT DB_CampNight_RomanceNight((FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121, _Player, (DIALOGRESOURCE)CAMP_Astarion_SD_ROM_SecondNight_693a16c6-9b9d-fee9-db37-7207ab63c913, (FLAG)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_CampNight_RomanceNight((FLAG)NIGHT_GoblinHunt_RaiderCelebration_86fee25f-1069-4f17-89fa-4c5b69f82e0b, _Player, (DIALOGRESOURCE)CAMP_Astarion_SD_ROM_SecondNight_693a16c6-9b9d-fee9-db37-7207ab63c913, (FLAG)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_Camp_QueuedRomanceNight((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)CAMP_Astarion_SD_ROM_SecondNight_693a16c6-9b9d-fee9-db37-7207ab63c913, _Player);
NOT DB_BUGFIX_GUSX_1068_PlayerWithIncorrectFlag((CHARACTER)_Player);
//END_REGION 

//REGION GUSX-1266
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_CurrentLevel("WLD_Main_A")
AND
DB_Camp(_, _, _CampArea, _)
AND
IsInTrigger(S_PLA_StuckHalfElf_5fcc3167-5a0c-41e7-b44c-d629d34370cb, _CampArea, 1)
THEN
TeleportTo(S_PLA_StuckHalfElf_5fcc3167-5a0c-41e7-b44c-d629d34370cb, S_PLA_StuckHalfElf_OutsideTrigger01_8eeba639-9a9f-410f-88ad-b571d48402a9, "", 0, 0, 0, 1, 1);
DB_BUGFIX_Marker("GUSX-1266");

PROC
PROC_ApplySavegamePatches()
AND
NOT DB_CurrentLevel("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "WLD_Main_A", "GUSX-1266_LoadedOutsideWLD");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-1266_LoadedOutsideWLD")
AND
DB_Camp(_, _, _CampArea, _)
AND
IsInTrigger(S_PLA_StuckHalfElf_5fcc3167-5a0c-41e7-b44c-d629d34370cb, _CampArea, 1)
THEN
TeleportTo(S_PLA_StuckHalfElf_5fcc3167-5a0c-41e7-b44c-d629d34370cb, S_PLA_StuckHalfElf_OutsideTrigger01_8eeba639-9a9f-410f-88ad-b571d48402a9, "", 0, 0, 0, 1, 1);
DB_BUGFIX_Marker("GUSX-1266_LoadedOutsideWLD");
//END_REGION

//REGION GUSX-7021
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Players((CHARACTER)_Player)
AND
GetFlag((FLAG)GOB_DrowCommander_HasMet_4cdf4899-bd4e-569d-44b6-236e815ec000, _Player, 1)
AND
NOT DB_GlobalFlag((FLAG)DEN_GroveConflict_Knows_LeaderNameDrow_20f20de4-4f03-b2b9-6a6b-e96f5e190160)
THEN
SetFlag((FLAG)DEN_GroveConflict_Knows_LeaderNameDrow_20f20de4-4f03-b2b9-6a6b-e96f5e190160);
//END_REGION

//REGION GUSX-4241

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_IgnoreMutingStatussesDialog(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7)
THEN
DB_BUGFIX_Marker("GUSX-4241");
NOT DB_IgnoreMutingStatussesDialog(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7);
DB_DropMutingStatussesDialog(DEN_ShadowDruid_SnakesCourt_459ca406-18ce-99f7-6dbe-492ea6268bb7);

//END_REGION

//REGION GUSX-6949

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_OnlyOnce("RaidingParty_OpenGate")
AND
NOT DB_GlobalFlag(DEN_RaidingParty_Event_OpenDenGate_1018a5ed-3543-a4c2-9dd7-138517d55e5e)
THEN
DB_BUGFIX_Marker("GUSX-6949");
SetFlag(DEN_RaidingParty_Event_OpenDenGate_1018a5ed-3543-a4c2-9dd7-138517d55e5e, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION GUSX-8277


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_Camp_QueuedNight(_Night)
AND
DB_CampNight_Requirement_CanStartDating(_Night, _Companion)
AND
DB_CampNight_CRD(_Night, _Companion, _Dialog, _Flag)
AND
DB_HandlingRelationshipDialog((CHARACTER)_Companion, _Dialog, _Flag, _, _, _)
AND
NOT QRY_CampNight_MeetsRequirements_StartDating((FLAG)_Night)
THEN
PROC_CancelRelationshipDialog(_Companion, _Dialog, _Flag);
DB_BUGFIX_Marker("GUSX-8277", _Companion, _Dialog, _Flag);

//END_REGION

//REGION GUSX-7023
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_QuestIsOpened("GLO_Tadpole")
AND
NOT DB_GlobalFlag(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec)
AND
DB_InCamp(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
PROC_GlobalSetFlagAndCache(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec);
DB_BUGFIX_Marker("GUSX-7023-A");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CRE_Main_A")
AND
DB_QuestIsOpened("GLO_Tadpole")
AND
NOT DB_GlobalFlag(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec)
AND
DB_InCamp(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
PROC_GlobalSetFlagAndCache(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec);
DB_BUGFIX_Marker("GUSX-7023-B");
//END_REGION GUSX-7023

//REGION GUS-319481
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
THEN
TriggerRegisterForCharacter((TRIGGER)S_GOB_DrowCommander_KnockedOutRecruitmentBox_2a19441e-2c24-4b62-b35e-08f53089ffaa, (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
//END_REGION

//REGION GUS-319481
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
THEN
DB_BUGFIX_Marker("GUS-319481");
DB_PATCH_KnockedOutStatuses("KNOCKED_OUT");
DB_PATCH_KnockedOutStatuses("KNOCKED_OUT_PERMANENTLY");
DB_PATCH_KnockedOutStatuses("KNOCKED_OUT_TEMPORARILY");
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7","WLD_Main_A","GUS-319481");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-319481")
AND
DB_ORI_Minthara_RemoveKnockedOutLater(_)
AND
DB_PATCH_KnockedOutStatuses(_KnockedOutStatus)
AND
HasActiveStatus(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _KnockedOutStatus, 0)
AND
IsOnStage(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1)
THEN
DB_BUGFIX_Marker("GUS-319481");
ScatterStoryItems(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_SetOnStage(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0);
NOT DB_GLO_DefeatCounter(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GOB_GoblinHunt_Leaders");
//END_REGION

//REGION GUS-303194
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_QuestIsOpened("GLO_Tadpole")
AND
NOT DB_GlobalFlag(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec)
AND
DB_InCamp(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
PROC_GlobalSetFlagAndCache(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec);
DB_BUGFIX_Marker("GUS-303194");
//END_REGION GUS-303194

//REGION GUSX-1211
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_QuestIsOpened("GLO_Tadpole")
AND
NOT DB_GlobalFlag(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec)
AND
DB_InCamp(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
PROC_GlobalSetFlagAndCache(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec);
DB_BUGFIX_Marker("GUSX-1211");
//END_REGION GUSX-1211

//REGION GUSX-7889
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
IsDead((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0)
THEN
DB_BUGFIX_Marker("GUSX-7889");
ClearTag(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
NOT DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_BUGFIX_ORI_InitMoonriseMinthara();

PROC
PROC_BUGFIX_ORI_InitMoonriseMinthara()
AND
DB_GlobalFlag((FLAG)GLO_MoonriseTower_EverEnteredBefore_26aeabb0-7644-4897-9bbd-7a95e3e8930f)
AND
NOT DB_GlobalFlag(MOO_Execution_Knows_Executioner_53052e40-df9b-90a0-ad65-f2c06f996666)
THEN
PROC_MOO_Execution_DrowInit();
//END_REGION

//REGION GUSX-9964

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "WLD_Main_A", "GUSX-9964");


PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-9964")
AND
IsInTrigger(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, S_GOB_ThroneRoom_SUB_bb81678b-641c-43fc-bd41-53295d59be03, 1)
AND
QRY_QuestUpdateIsUnlockedForAny("DEN_CapturedGoblin", "SavedFromSpider")
AND
NOT DB_GOB_SpiderNest_VictimDialog(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, GOB_SpiderNest_CapturedGoblin_88941bf9-f6bc-7b9c-9f77-20a684bdf7a0)
THEN
DB_BUGFIX_Marker("GUSX-9964");
PROC_GOB_SpiderNest_TryFreeCapturedGoblin();
PROC_SpotPlayers_RestartSpotting(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, "GOB_SpiderNest_Freed");

//END_REGION

//REGION GUSX-8166
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_Defeated((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
QRY_GOB_BUGFIX_IsExecutionerDead()
AND
DB_GlobalFlag(GOB_CapturedGoblin_State_Executed_5505345c-482d-cfc5-3a2b-987611beb4e3)
AND
IsDead((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, 0)
AND
QuestIsClosed("DEN_CapturedGoblin", 0)
THEN
PROC_GOB_SpiderNest_FreedCapturedGoblinJournalEntry();

QRY
QRY_GOB_BUGFIX_IsExecutionerDead()
AND
DB_GOB_SpiderNest_ExecutionGoblins(_Executioner)
AND
DB_PermaDefeated(_Executioner)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUSX-10343

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "WLD_Main_A", "GUSX-10343");


PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-10343")
AND
DB_GlobalFlag(DEN_AttackOnDen_State_DenVictory_71c7f23e-3ff1-c9b8-3ef5-d75fa1b42c8d)
AND
DB_DEN_NPC(_Character, _, _)
AND
DB_Players(_Player)
AND
GetAttitudeTowardsPlayer(_Character, _Player, _Attitude)
AND
_Attitude < 0
THEN
DB_BUGFIX_Marker("GUSX-10343");
PROC_SetAttitude(_Character, _Player, 0);


//END_REGION

//REGION GUSX-10239
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
QRY_BUGFIX_GUSX_10239_NeedToDisableCrime()
THEN
PROC_CharacterDisableCrime((CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, "UND_LoneDuergar_ForbiddenRaft");
DB_BUGFIX_Marker("GUSX-10239");

QRY
QRY_BUGFIX_GUSX_10239_NeedToDisableCrime()
AND
DB_Dead((CHARACTER)S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18)
THEN
DB_NOOP(1);

QRY
QRY_BUGFIX_GUSX_10239_NeedToDisableCrime()
AND
HasActiveStatus(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18, "CREATURE_SPORE_SERVANT", 1)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUSX-10548
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "WLD_Main_A", "GUSX-10548");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-10548")
AND
DB_GlobalFlag(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
AND
NOT DB_SceneManager(_, "PROC_UND_KethericCity_Mutiny_Scene")
AND
NOT DB_DuergarCamp_MutinyBattle_CombatID(_)
AND
NOT DB_GlobalFlag((FLAG)UND_TheDrowNere_State_DiedDeserted_d9349fbe-a9bd-45f1-8c9e-8f97cf648841)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarGuards_Excavation_State_PermaDefeated_3f30c825-10f1-4fa5-84b8-073f293e6650)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedNone_c17245d9-ecb7-4562-a9fe-74a6759ff47b)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedDrow_9c15716b-2e73-3bde-7e1c-8580aa4b1850)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedLoyal_74c05609-77b6-4f62-b9e0-9bcb24908d4b)
AND
NOT DB_GlobalFlag((FLAG)UND_DuergarCamp_State_SidedMutineers_581443f0-b4bd-d3c2-7122-a4d2aa7fb5f9)
THEN
PROC_GlobalSetFlagAndCache((FLAG)UND_DuergarCamp_State_SidedNone_c17245d9-ecb7-4562-a9fe-74a6759ff47b);
PROC_SceneOver("PROC_UND_KethericCity_Mutiny_Scene");
DB_BUGFIX_Marker("GUSX-10548-A");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-10548")
AND
NOT DB_DuergarCamp_MutinyBattle_CombatID(_)
AND
DB_Is_InCombat(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30, _CombatID)
AND
DB_GlobalFlag(UND_DuergarCamp_State_BattleStarted_ff6b8579-5926-4406-a983-b9843f875159)
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_BattleEnded_beb0173e-61e5-4a4e-a13f-6a5bf74f1582)
THEN
DB_DuergarCamp_MutinyBattle_CombatID(_CombatID);
DB_BUGFIX_Marker("GUSX-10548-B");
//END_REGION

//REGION GUSX-8227
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "WLD_Main_A", "GUSX-8227");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-8227") 
AND
DB_BUGFIX_Marker("GUSX-10548-A") // related to the previous fix so they should always come hand in hand
AND
DB_UND_DuergarGuards_Excavation(_Duergar,_)
AND
DB_KnockedOut(_Duergar)
AND
HasAppliedStatus(_Duergar, "KNOCKED_OUT_TEMPORARILY", 1)
THEN
RemoveStatus(_Duergar, "KNOCKED_OUT");
DB_BUGFIX_GUSX_8227_DuergarReKnockOut(_Duergar);

IF
StatusRemoved(_Duergar, "KNOCKED_OUT_TEMPORARILY", _,_)
AND
DB_BUGFIX_GUSX_8227_DuergarReKnockOut((CHARACTER)_Duergar)
AND
GetTechnicalName(_Duergar, _Name)
AND
Concatenate("GUSX-8227_", _Name, _Result)
THEN
NOT DB_BUGFIX_GUSX_8227_DuergarReKnockOut((CHARACTER)_Duergar);
ApplyStatus(_Duergar, "KNOCKED_OUT", -1.0, 1);
DB_BUGFIX_Marker(_Result);
//END_REGION

//REGION GUSX-12006

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_Players((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
THEN
DB_GLO_Playable((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);
DB_Dialogs((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, (DIALOGRESOURCE)DEN_Bard_InParty_3c71c397-b378-340b-0da9-ef3d17d14423);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_MurderedAlfiraOrAlternative_6bb5bfcc-e762-40d4-a05b-9bdf860ba099)
AND
DB_ORI_DarkUrge_AlfiraMurderVictim(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
AND
NOT DB_Dead((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
PROC_Origins_CompanionLeavePermanently(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "CompanionMurdered");
Die(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, DEATHTYPE.DoT, _DarkUrge, 1, 1, 0.0);
PROC_ORI_DarkUrge_DeathRitualCircle(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);
DB_BUGFIX_Marker("GUSX-12006");//Be aware this marker was added late.


//END_REGION

//REGION GUSX-11195

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_ORI_DarkUrge(_Character)
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "WLD_Main_A", "GUSX-11195");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-11195")
THEN
RemoveStatus(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "BLOCK_LEVELUP", NULL_00000000-0000-0000-0000-000000000000);
ClearTag(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed);
ClearTag(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, (TAG)BALDURIAN_f15e9b0d-676c-4f52-9abf-365cff89ef0f);
DB_BUGFIX_Marker("GUSX-11195");

//END_REGION

//REGION GUSX-8433
PROC
PROC_ApplySavegamePatches()
AND
DB_OnlyOnce("UND_MushroomHunter_CommentOnGettingScroll")
AND
NOT DB_OnlyOnce("UND_MushroomHunter_EscapeViaSpell")
AND
NOT DB_UND_MushroomHunter_ShouldCheckInventory(1)
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "WLD_Main_A", "GUSX-8433");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-8433") 
THEN
DB_BUGFIX_Marker("GUSX-8433");
PROC_NotifyWhenReadyToTalk((CHARACTER)S_GLO_Baelen_711bd763-780d-4132-9662-3a8a06da6b1b, "UND_MushroomHunter_ReadyToAD");
//END_REGION

//REGION GUSX-9144 (WLD)
PROC
PROC_ApplySavegamePatches()
THEN
// global characters introduced in Act 1
PROC_Bugfix_GUSX_9144_CheckChangeFactionWithBugfixMarker((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, (FACTION)GLO_DarkUrge_Butler_06c42a65-d1f0-494e-ba8d-898a8495ff30, "GUSX-9144-BUTLER");
PROC_Bugfix_GUSX_9144_CheckChangeFactionWithBugfixMarker((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, (FACTION)ACT1_GOB_Mizora_8b312e02-80de-4f6d-a2b2-3825ddb64ad7, "GUSX-9144-MIZORA");
PROC_Bugfix_GUSX_9144_CheckChangeFactionWithBugfixMarker((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, (FACTION)ACT1_GOB_Warlock_6dce77c9-8dbb-7f2c-a865-86aa893a820b, "GUSX-9144-KORILLA");
PROC_Bugfix_GUSX_9144_CheckChangeFactionWithBugfixMarker((CHARACTER)S_DEN_Bard_Backup_8ef4c8ea-317d-4539-aa5b-c5e899cf0f31, (FACTION)ACT1_DEN_Bard_Backup_cf6f5352-74fa-4774-9d51-705c4ec7340c, "GUSX-9144-BACKUP_BARD");
// local Act 1 characters
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "WLD_Main_A", "GUSX-9144-WLD");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-9144-WLD")
THEN
// re-using an existing PROC
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_CAMP_TieflingBackup_001_39feb630-73d6-414c-a5cd-d02366ff26d7, (FACTION)ACT1_DEN_Tieflings_ca9de2d9-9022-9215-6d9b-676d916dcb5a);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_CAMP_TieflingBackup_002_92c6f58c-767a-4654-b300-50bbcbecbc93, (FACTION)ACT1_DEN_Tieflings_ca9de2d9-9022-9215-6d9b-676d916dcb5a);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_CAMP_TieflingBackup_003_7dcf0fa8-650f-4419-9dd0-ba165795aebe, (FACTION)ACT1_DEN_Tieflings_ca9de2d9-9022-9215-6d9b-676d916dcb5a);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_CAMP_TieflingBackup_004_6b8d4e0c-c29a-4a08-9e48-e44d6da4a568, (FACTION)ACT1_DEN_Tieflings_ca9de2d9-9022-9215-6d9b-676d916dcb5a);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_CAMP_TieflingBackup_005_ffb9c0cf-a478-40c1-b1fb-d362ae608ce0, (FACTION)ACT1_DEN_Tieflings_ca9de2d9-9022-9215-6d9b-676d916dcb5a);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_CAMP_TieflingBackup_006_9ad714f0-83a4-40a5-bc5e-06b82aadcca5, (FACTION)ACT1_DEN_Tieflings_ca9de2d9-9022-9215-6d9b-676d916dcb5a);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_DEN_Rat_b61c2b37-da0d-47ad-ba9f-a4f8230f3b53, (FACTION)ACT1_DEN_Rat_1295edcb-3896-48bc-adcc-1a531f9f926d);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_DEN_SenderBird_bf90aa40-232b-40fd-a43e-699bb964e337, (FACTION)ACT1_DEN_Bird_be96bbc1-5bf6-4efd-ba5f-6ca7d40cdae8);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_DEN_Snake_001_af2ff867-467e-4765-a66c-fed091af4a09, (FACTION)ACT1_DEN_Snake_ab596dca-50d7-4a25-989d-91f65bfe1e82);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_DEN_Squirrel_35ed8eab-1e0b-4ec8-92f2-1b8510cb3ad8, (FACTION)ACT1_DEN_Squirrel_fafeeea9-abba-4b59-9cba-ef5aade62309);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_GOB_Torturers_Rat_000_ccde6943-0165-4885-b888-b4e44c8054bc, (FACTION)ACT1_GOB_Rats_5d2305e3-a748-f074-2fdb-e6a59206c783);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_GOB_Torturers_Rat_001_720df859-7592-4f34-9000-1a2c0a313b94, (FACTION)ACT1_GOB_Rats_5d2305e3-a748-f074-2fdb-e6a59206c783);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_UND_KethericCity_LavaElemental_1c47b089-3e59-41ca-a300-47dfd941b5a0, (FACTION)ACT1_UND_LavaElemental_719f09eb-1b54-46a9-a142-ce92a5cd2f22);
DB_BUGFIX_Marker("GUSX-9144-WLD");

PROC
PROC_Bugfix_GUSX_9144_CheckChangeFactionWithBugfixMarker((CHARACTER)_Character, (FACTION)_Faction, (STRING)_Marker)
AND
NOT DB_PermaDefeated(_Character)
AND
GetBaseFaction(_Character, (FACTION)cfb709b3-220f-9682-bcfb-6f0d8837462e)
THEN
SetFaction(_Character, _Faction);
DB_BUGFIX_Marker(_Marker);
//END_REGION

//REGION GUSX-7764

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "WLD_Main_A", "GUSX-7764");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-7764")
AND
DB_GlobalFlag(HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_SpotPlayers_StopSpotting(CHARACTERGUID_S_HAG_HagLair_EntranceDouble_d6e7f76b-9922-43b2-a44d-d9f91f9d9fd6, "HAG_HagLair_EntranceDoubleStartDialog");
DB_BUGFIX_Marker("GUSX-7764-1");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-7764")
AND
DB_GlobalFlag(HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
IsOnStage(S_HAG_HagLair_EntranceDouble_d6e7f76b-9922-43b2-a44d-d9f91f9d9fd6, 1)
THEN
SetOnStage(S_HAG_HagLair_EntranceDouble_d6e7f76b-9922-43b2-a44d-d9f91f9d9fd6, 0);
DB_BUGFIX_Marker("GUSX-7764-2");

//END_REGION

//REGION GUSX-8085


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7 Hotfix 2")
THEN
ClearTag(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed);
ClearTag(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, (TAG)ILLITHID_HIDDEN_CHECK_4835ba9d-c0d6-40fb-ad62-88f875b536c2);
NOT DB_TadPole_TadpoleBurstQueued((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);
NOT DB_Tadpole_StillTadpoled((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);
DB_BUGFIX_Marker("GUSX-8085");

//END_REGION

//REGION GUSX-11438
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
AND
NOT DB_PermaDefeated(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
NOT DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8)
THEN
DB_UND_BroodingSpovereign_UnderdarkWaypoints("WAYP_UND_Beach");
DB_UND_BroodingSpovereign_UnderdarkWaypoints("WAYP_UND_Sussur");
DB_UND_BroodingSpovereign_UnderdarkWaypoints("WAYP_UND_Fort");
DB_UND_BroodingSpovereign_UnderdarkWaypoints("WAYP_UND_Myconid");
DB_BUGFIX_Marker("GUSX-11438-A");
DB_BUGFIX_GUSX_11438_FixGlut(1);

IF
DB_ActiveLevel("WLD_Main_A")
AND
DB_BUGFIX_GUSX_11438_FixGlut(1)
AND
Exists(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, 1)
AND
NOT DB_PermaDefeated(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
NOT DB_GlobalFlag((FLAG)UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8)
AND
NOT QRY_UND_BroodingSovereign_StillUND(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
THEN
PROC_BUGFIX_GUSX_11438_ReturnGlut();

PROC
PROC_BUGFIX_GUSX_11438_ReturnGlut()
AND
DB_UND_BroodingSovereign_WaitingForLeader(_Player)
THEN
PROC_UND_BroodingSovereign_QuestUpdate_LeftUND(_Player);
ClearFlag(UND_MyconidCircle_BroodingSovereign_State_WaitingForParty_acaea6bf-9bf1-436f-ab41-c2f77ded4a41,NULL_00000000-0000-0000-0000-000000000000,0);
NOT DB_UND_BroodingSovereign_WaitingForLeader(_Player);

PROC
PROC_BUGFIX_GUSX_11438_ReturnGlut()
AND
DB_UND_BroodingSovereign_Leader(_Player)
THEN
PROC_UND_BroodingSovereign_QuestUpdate_LeftUND(_Player);
PROC_UND_BroodingSovereign_GoHome(_Player);

PROC
PROC_BUGFIX_GUSX_11438_ReturnGlut()
THEN
DB_BUGFIX_Marker("GUSX-11438-B");
NOT DB_BUGFIX_GUSX_11438_FixGlut(1);
PROC_BroodingSovereign_TeleportHome();

IF
DB_ActiveLevel("WLD_Main_A")
AND
DB_BUGFIX_GUSX_11438_FixGlut(1)
AND
Exists(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, 1)
AND
QRY_UND_BroodingSovereign_StillUND(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
THEN
NOT DB_BUGFIX_GUSX_11438_FixGlut(1);

PROC
PROC_StateSet_PermaDefeated(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_BUGFIX_GUSX_11438_FixGlut(1)
THEN
NOT DB_BUGFIX_GUSX_11438_FixGlut(1);

IF
FlagSet((FLAG)UND_MyconidCircle_BroodingSovereign_Done_f80e93f9-53b5-4537-96a7-583508ba1cb8,_,_)
AND
DB_BUGFIX_GUSX_11438_FixGlut(1)
THEN
NOT DB_BUGFIX_GUSX_11438_FixGlut(1);
//END_REGION GUSX-11438

//REGION GUSX-11524
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_PermaDefeated(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
IsPartyFollower(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, 1)
AND
CharacterGetOwner(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Player)
THEN
PROC_UND_BroodingSovereign_GoHome(_Player);
DB_BUGFIX_Marker("GUSX-11524");
//END_REGION GUSX-11524

//REGION GUS-320052
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_DEN_AttackOnDen_TieflingDefeatCounters(_DefeatCounter)
AND
DB_GLO_DefeatCounter_State(_Character, _DefeatCounter, "Active")
AND
DB_OffStage(_Character)
THEN
DB_BUGFIX_Marker("GUS-320052", _Character); 
NOT DB_GLO_DefeatCounter(_Character, _DefeatCounter);
PROC_GLO_DefeatCounter_CheckFinished(_DefeatCounter);

//END_REGION GUSX-11507


//REGION GUSX-11507
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_QuestIsOpened("GLO_Tadpole")
AND
NOT DB_QuestIsClosed("GLO_Tadpole_SUB_Apprentice") // this also means we havent reached the point of no return in act2
AND
NOT DB_GlobalFlag(DEN_Apprentice_Knows_HeardAboutNettie_07818e31-1a13-0dd8-f02c-c27984614d17)
AND
DB_Avatars(_Avatar) // only avatars can trigger this branch
AND
GetFlag(Wyll_InParty2_Event_AskedHealer_67beea4c-b23a-4c55-be7d-bdca7c55f241, _Avatar, 1)
THEN
QuestUpdate(_Avatar, "GLO_Tadpole", "LearnedApprentice");
DB_BUGFIX_Marker("GUSX-11507");
//END_REGION GUSX-11507
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "__Start"
