Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION
//REGION GUS-298241
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
DB_WYR_South_AccessGrantedPatched(1); // we re-evaluate the flags rule in the WYR goal
DB_BUGFIX_Marker("GUS-298241");
//END_REGION GUS-298241

//REGION GUS-298427
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_COM_ShadowHeart", "SharPath_LearnedCultLocation", 0)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfGrief_Knows_IsSharCult_6aa0816f-5827-4669-b3d3-b6dd71a6b95e)
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_SharPath_bf9ae334-ff6a-458d-b898-3074bca0bdfb)
THEN
QuestUpdate((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_COM_ShadowHeart", "SharPath_LearnedCultLocation");
DB_BUGFIX_Marker("GUS-298427");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_COM_ShadowHeart", "EnemyOfShar_LearnedCultLocation", 0)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfGrief_Knows_IsSharCult_6aa0816f-5827-4669-b3d3-b6dd71a6b95e)
AND
DB_DialogName((DIALOGRESOURCE)WYR_RefugeeCamp_OM_Shadowheart_COM_64277eb5-3c13-6da6-9184-0cfe7805c5c3, _ID)
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c)
THEN
QuestUpdate((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_COM_ShadowHeart", "EnemyOfShar_LearnedCultLocation");
DB_BUGFIX_Marker("GUS-298427");
//END_REGION GUS-298427

//REGION GUS-299778
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_Origins(_Origin)
AND
DB_PermaDefeated(_Origin)
AND
DB_LoopEffect(_Origin, _,"RelationshipMarker",_,_, _,_)
THEN
DB_BUGFIX_Marker("GUS-299778");
PROC_ExclamationMark_Hide(_Origin);
//END_REGION


//REGION GUS-298227
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
DB_GlobalFlag(CAMP_Yenna_State_PostAbductionCampChat_d30c5b6a-eada-4c8c-927d-a50de178ec29)
AND
DB_InCamp(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
THEN
PROC_SetCustomTradeTreasure((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, "LOW_Yenna_SoupTrader");
DB_BUGFIX_Marker("GUS-298227");
//END_REGION GUS-298227

//REGION GUS-298824
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
THEN
DB_BUGFIX_Marker("GUS-298824");
DB_GLO_ExclusiveFlag("WYR_WyrmRock_SouthBridgeState", (FLAG)WYR_WyrmRock_SouthBridge_State_BridgeLowered_b2ef324c-0a5b-447d-be7e-9d6a84550f68);
DB_GLO_ExclusiveFlag("WYR_WyrmRock_SouthBridgeState", (FLAG)WYR_WyrmRock_SouthBridge_State_BridgeRaised_0a37f68f-2983-4e22-8d0b-33f209fb8c7b);
PROC_GLO_Bugfix_298824_InitBridgeState();

PROC
PROC_GLO_Bugfix_298824_InitBridgeState()
AND
DB_GlobalFlag((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9)
AND
NOT DB_GlobalFlag((FLAG)WYR_WyrmRock_SouthBridge_State_BridgeRaised_0a37f68f-2983-4e22-8d0b-33f209fb8c7b)
AND
NOT DB_GlobalFlag((FLAG)WYR_WyrmRock_SouthBridge_State_BridgeLowered_b2ef324c-0a5b-447d-be7e-9d6a84550f68)
THEN
SetFlag((FLAG)WYR_WyrmRock_SouthBridge_State_BridgeRaised_0a37f68f-2983-4e22-8d0b-33f209fb8c7b);
//END_REGION

//REGION GUS-298853
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_GlobalFlag((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_AcceptedGortashAlliance_361e5553-4dc9-4f0f-2e2f-0b3ef8f50385);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_RejectedGortashAlliance_e990a351-329f-4723-bdcc-62ca2217ed22);
DB_BUGFIX_Marker("GUS-298853");
//END_REGION GUS-298853

//REGION GUS-298378

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
NOT DB_LOW_OskarsBeloved_GUS_298378_ClosingSteps(_)
THEN
DB_LOW_OskarsBeloved_GUS_298378_ClosingSteps("PossessedOskarCombat_LeftCombat");
DB_LOW_OskarsBeloved_GUS_298378_ClosingSteps("PossessedOskarCombat_KilledOskar");
DB_LOW_OskarsBeloved_GUS_298378_ClosingSteps("LetKerriKillOskar");
DB_LOW_OskarsBeloved_GUS_298378_ClosingSteps("ConvincedKerri_OskarGivesSketchbook");
DB_LOW_OskarsBeloved_GUS_298378_ClosingSteps("KilledKerri_OskarGivesSketchbook");
DB_LOW_OskarsBeloved_GUS_298378_ClosingSteps("OskarMadePortrait");
DB_BUGFIX_Marker("GUS-298378");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_QuestIsOpened("GLO_DoubtingArtist")
AND
DB_LOW_OskarsBeloved_GUS_298378_ClosingSteps(_Step)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_DoubtingArtist",_Step)
THEN
QuestClose("GLO_DoubtingArtist");
DB_BUGFIX_Marker("GUS-298378");

//END_REGION GUS-298378

//REGION GUS-299949

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
GetFlag((FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1)
AND
NOT DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _, _, _, _)
THEN
ClearFlag((FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

//END_REGION

//REGION GUS-297024
// bridge was turned into a door, but that can't be patched
// we'll have to support the old implementation as well
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
THEN
DB_BUGFIX_Marker("GUS-297024");
DB_WYR_WyrmRock_UseOldImplementationOfBridges(1);

IF
DB_BUGFIX_Marker("GUS-297024")
AND
DB_GlobalFlag((FLAG)CURRENTREGION_BGO_Main_A_11239767-48ad-4879-8312-b9164b6e4978)
THEN
SetCanInteract((ITEM)S_WYR_WyrmRock_SouthBridge_9e8dab1b-b39e-4c73-8621-9bbeee61baab, 0);
SetCanInteract((ITEM)S_WYR_WyrmRock_NorthBridge_4f437ef7-6c97-4ad5-bb46-3e7ebbd872ac, 0);
//END_REGION

//REGION GUS-295872
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
AND
DB_GlobalFlag((FLAG)CAMP_VlaakithVisit_Event_VlaakithCameToCamp_82dcf5f6-1bc0-ee82-d0cb-fd90de88a077)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_Knows_MetVlaakith_c93015c2-6ae4-4013-b439-433b588f881c)
THEN
SetFlag((FLAG)ORI_Laezel_Knows_MetVlaakith_c93015c2-6ae4-4013-b439-433b588f881c);
DB_BUGFIX_Marker("GUS-295872");
//END_REGION

//REGION GUS-300772
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,12,0)
AND
DB_GlobalFlag(IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
THEN
PROC_IRN_KillRavengard();
DB_BUGFIX_Marker("GUS-300772");
//END_REGION GUS-300772

//REGION GUS-300177
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
THEN
DB_GLO_Bugfix_300177_RestoreDialogs(1);

IF
DB_GLO_Bugfix_300177_RestoreDialogs(1)
AND
DB_GlobalFlag((FLAG)CURRENTREGION_BGO_Main_A_11239767-48ad-4879-8312-b9164b6e4978)
AND
NOT DB_GlobalFlag((FLAG)WYR_VampireSpawns_State_MovedToCazador_a03cf538-552c-a672-db83-10e9ceaf99e2)
AND
NOT DB_Dialogs(S_WYR_VampireSpawns_Dalyria_204a74d2-e6ad-4e9b-a275-f03cb5f3d975, (DIALOGRESOURCE)WYR_VampireSpawns_Dalyria_6b2df18f-a498-146e-13c3-c2a5d3c02287)
THEN
DB_Dialogs(S_WYR_VampireSpawns_Dalyria_204a74d2-e6ad-4e9b-a275-f03cb5f3d975, (DIALOGRESOURCE)WYR_VampireSpawns_Dalyria_6b2df18f-a498-146e-13c3-c2a5d3c02287);
DB_BUGFIX_Marker("GUS-300177");

IF
DB_GLO_Bugfix_300177_RestoreDialogs(1)
AND
DB_GlobalFlag((FLAG)CURRENTREGION_BGO_Main_A_11239767-48ad-4879-8312-b9164b6e4978)
AND
NOT DB_GlobalFlag((FLAG)WYR_VampireSpawns_State_MovedToCazador_a03cf538-552c-a672-db83-10e9ceaf99e2)
AND
NOT DB_Dialogs(S_WYR_VampireSpawns_Petra_6fb6e85e-ccd0-42ef-a37d-1e256a433f3b, (DIALOGRESOURCE)WYR_VampireSpawns_Petra_4270d451-e31a-9da8-e0bb-d9ee8aa5a5e4)
THEN
DB_Dialogs(S_WYR_VampireSpawns_Petra_6fb6e85e-ccd0-42ef-a37d-1e256a433f3b, (DIALOGRESOURCE)WYR_VampireSpawns_Petra_4270d451-e31a-9da8-e0bb-d9ee8aa5a5e4);
DB_BUGFIX_Marker("GUS-300177");
//END_REGION

//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_ORI_DarkUrge(_DarkUrge)
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_DarkUrge_BloodWeddingFollowup_993943d4-8774-41b4-8875-94b4600ad232,  (FLAG)ORI_DarkUrge_State_BloodWeddingFallback_9b4bcdba-adbe-c189-8bb5-08bcdbb15eaf, (FLAG)DARKURGE_68888003-acaa-49d5-b4f2-0c6293797e59, (FLAG)JAHEIRA_8b7fd8c6-4d49-4932-b525-7dda10cf4a1b);
NOT DB_CampNight_CFM((FLAG)NIGHT_DarkUrge_BloodWeddingFollowup_993943d4-8774-41b4-8875-94b4600ad232, (DIALOGRESOURCE)CAMP_DarkUrge_CFM_BloodweddingFollowup_2111a7a8-1f57-4e72-f518-acdaaddc0a67);
NOT DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)CAMP_DarkUrge_CFM_BloodweddingFollowup_2111a7a8-1f57-4e72-f518-acdaaddc0a67,  S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
NOT DB_CampfireMoment_OptionalSpeakers((DIALOGRESOURCE)CAMP_DarkUrge_CFM_BloodweddingFollowup_2111a7a8-1f57-4e72-f518-acdaaddc0a67, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
NOT DB_CampfireMoment_FixedPlayer((DIALOGRESOURCE)CAMP_DarkUrge_CFM_BloodweddingFollowup_2111a7a8-1f57-4e72-f518-acdaaddc0a67,_DarkUrge);
DB_CampNight_Requirement((FLAG)NIGHT_DarkUrge_BloodWeddingFollowup_993943d4-8774-41b4-8875-94b4600ad232, (FLAG)ORI_DarkUrge_State_BloodWeddingFallback_9b4bcdba-adbe-c189-8bb5-08bcdbb15eaf, (FLAG)NIGHT_DarkUrge_BloodWeddingFollowup_Requirement_6a4360d8-913b-41c6-a56a-c476ee276186, (FLAG)DARKURGE_68888003-acaa-49d5-b4f2-0c6293797e59, (FLAG)JAHEIRA_8b7fd8c6-4d49-4932-b525-7dda10cf4a1b);
DB_CampNight_SoloDream((FLAG)NIGHT_DarkUrge_BloodWeddingFollowup_993943d4-8774-41b4-8875-94b4600ad232, _DarkUrge, CAMP_DarkUrge_CFM_BloodweddingFollowup_2111a7a8-1f57-4e72-f518-acdaaddc0a67);

//END_REGION

//REGION GUS-311549

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
GetRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,(STRING)_NewDifficulty)
AND
DB_PartyMembers(_PartyMember)
AND
DB_LOW_PhilgravesMansion_DifficultyLairCurses(_OldStatus,_OldDifficulty)
AND
DB_LOW_PhilgravesMansion_DifficultyLairCurses(_NewStatus,_NewDifficulty)
AND
HasActiveStatus(_PartyMember,_OldStatus,1)
THEN
RemoveStatus(_PartyMember,_OldStatus);
ApplyStatus(_PartyMember, _NewStatus, -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);


//END_REGION

//REGION GUS-309163

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-309163");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-309163")
AND
IsOnStage(S_WYR_SkeletalDragonBlocker_67511a5c-75f8-496c-81c6-17d4820c2b38, _OnStage)
THEN
SetOnStage(S_WYR_SkeletalDragonBlocker_001_68f502f3-0833-4d48-ac34-38f800a54c63, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_002_342df486-09b7-4259-bc4e-ddc96a010571, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_003_2826c2c1-f846-4320-a76a-8b88558773dc, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_004_6bcdd409-9503-4b1b-a69f-b284b2e4b644, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_005_50bbde3b-48a2-4dcd-be67-f19f612372b3, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_006_e49292d1-3320-47ad-a0a1-c6aea3b839c1, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_007_7215d6ab-0c4f-4c6c-84fe-8a087152078d, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_008_a11d3452-8ac9-4441-8077-54e8d30c046e, _OnStage);
SetVisible(S_WYR_SkeletalDragonBlocker_000_bdf56ccd-6990-4988-a9ee-792f9fc69a24, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_001_68f502f3-0833-4d48-ac34-38f800a54c63, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_002_342df486-09b7-4259-bc4e-ddc96a010571, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_003_2826c2c1-f846-4320-a76a-8b88558773dc, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_004_6bcdd409-9503-4b1b-a69f-b284b2e4b644, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_005_50bbde3b-48a2-4dcd-be67-f19f612372b3, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_006_e49292d1-3320-47ad-a0a1-c6aea3b839c1, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_007_7215d6ab-0c4f-4c6c-84fe-8a087152078d, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_008_a11d3452-8ac9-4441-8077-54e8d30c046e, 0);
ItemMoveTo(S_WYR_SkeletalDragonBlocker_67511a5c-75f8-496c-81c6-17d4820c2b38, S_WYR_SkeletalDragonBlockerPos_309163_866310d4-3d41-4c42-88cb-38b8f615d77f, 1000.0, 1000.0, 1, "");

//END_REGION

//REGION GUSX-756


PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "BGO_Main_A", "GUSX-756");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUSX-756")
AND
IsOnStage(S_WYR_SkeletalDragonBlocker_67511a5c-75f8-496c-81c6-17d4820c2b38, _OnStage)
THEN
SetOnStage(S_WYR_SkeletalDragonBlocker_009_e7162ac4-22f9-4c15-8afb-2a4817982c4d, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_010_b22845fa-8463-4b71-bb25-4e9bc68376e9, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_011_ada3a431-2465-40c6-a380-9afac2bcd128, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_012_c6a9a13e-3fb6-4b88-a6c9-5b7180d463ed, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_014_0ea74d6a-1644-40e2-9fb5-6e88b8445536, _OnStage);
SetOnStage(S_WYR_SkeletalDragonBlocker_015_cf2f3042-76d5-4868-b8f5-20413f1b52e5, _OnStage);
SetVisible(S_WYR_SkeletalDragonBlocker_009_e7162ac4-22f9-4c15-8afb-2a4817982c4d, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_010_b22845fa-8463-4b71-bb25-4e9bc68376e9, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_011_ada3a431-2465-40c6-a380-9afac2bcd128, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_012_c6a9a13e-3fb6-4b88-a6c9-5b7180d463ed, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_014_0ea74d6a-1644-40e2-9fb5-6e88b8445536, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_015_cf2f3042-76d5-4868-b8f5-20413f1b52e5, 0);


//END_REGION GUSX-756

//REGION GUS-300411
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
THEN
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61,"PLA_GrandDukeRescue","Dead",1,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
DB_BUGFIX_Marker("GUS-300411");


//END_REGION

//REGION GUS-301055
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,11,0)
THEN
DB_BUGFIX_Marker("GUS-301055");

IF
DB_BUGFIX_Marker("GUS-301055")
AND
DB_GlobalFlag((FLAG)CURRENTREGION_BGO_Main_A_11239767-48ad-4879-8312-b9164b6e4978)
AND
DB_WYR_WyrmRock_UseOldImplementationOfBridges(1)
THEN
PROC_GLO_Bugfix_301055_CheckUpdateSavegame();

// If Door component is present (either IsOpened or IsClosed return true)
// then we must disable the old implementation
PROC
PROC_GLO_Bugfix_301055_CheckUpdateSavegame()
AND
IsOpened(S_WYR_WyrmRock_SouthBridge_9e8dab1b-b39e-4c73-8621-9bbeee61baab, 1)
THEN
NOT DB_WYR_WyrmRock_UseOldImplementationOfBridges(1);

PROC
PROC_GLO_Bugfix_301055_CheckUpdateSavegame()
AND
IsClosed(S_WYR_WyrmRock_SouthBridge_9e8dab1b-b39e-4c73-8621-9bbeee61baab, 1)
THEN
NOT DB_WYR_WyrmRock_UseOldImplementationOfBridges(1);

PROC
PROC_GLO_Bugfix_301055_CheckUpdateSavegame()
AND
DB_GlobalFlag((FLAG)WYR_WyrmRock_SouthBridge_State_GainedAccess_4002c43d-55f3-4d1c-b170-f0ffa1f6b5fd)
AND
NOT DB_GlobalFlag((FLAG)WYR_WyrmRock_State_AlertState_3d238a15-bb39-411a-8023-23385c98f2b8)
AND
IsClosed(S_WYR_WyrmRock_SouthBridge_9e8dab1b-b39e-4c73-8621-9bbeee61baab, 1)
THEN
PROC_WYR_WyrmRock_LowerBridge((ITEM)S_WYR_WyrmRock_SouthBridge_9e8dab1b-b39e-4c73-8621-9bbeee61baab);
//END_REGION


//REGION GUS-299860
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,12,0)
AND
NOT DB_CampNight_Completed((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3)
THEN
DB_CampNight_CRD((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c);

//END_REGION

//REGION GUS-300825
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,12,0)
THEN
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCOMPANION_9c5bc0ce-cb2e-4685-b597-89a290837535, (FLAG)WYR_RaphaelTango_Event_BeganSoloScene_1048973a-9ed0-89e5-ce68-11e03fafc22c);
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCAMP_3a157c66-db4a-48ad-95e5-9659c42c4aa0, (FLAG)WYR_RaphaelTango_Event_BeganSoloScene_1048973a-9ed0-89e5-ce68-11e03fafc22c);
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCOMPANION_9c5bc0ce-cb2e-4685-b597-89a290837535, (FLAG)GLO_Orpheus_Knows_OrphicHammerIsTheKey_980541fb-1483-ea1a-3387-64405eace9a2);
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCAMP_3a157c66-db4a-48ad-95e5-9659c42c4aa0, (FLAG)GLO_Orpheus_Knows_OrphicHammerIsTheKey_980541fb-1483-ea1a-3387-64405eace9a2);
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCOMPANION_9c5bc0ce-cb2e-4685-b597-89a290837535, (FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e);
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCAMP_3a157c66-db4a-48ad-95e5-9659c42c4aa0, (FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e);
DB_BUGFIX_Marker("GUS-300825");
//END_REGION

//REGION GUS-301388
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,12,0)
AND
NOT DB_GlobalFlag((FLAG)DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_WYR_RefugeeCamp_TieflingRefugees(_Tiefling, _,_,_,_,_)
THEN
PROC_SetOnStage(_Tiefling, 0);
DB_BUGFIX_Marker("GUS-301388");
//END_REGION GUS-301388

//REGION GUS-301568
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_WasAbductedYenna_ff8e1e49-dcb0-4671-a747-dce5c704207b)
THEN
DB_BUGFIX_Marker("GUS-301568");
NOT DB_YennaDismissedFromCamp(1); // to make sure Yenna doesn't reappear in camp.
PROC_GLO_Bugfix_301568_RestoreYennaToTemple();

PROC
PROC_GLO_Bugfix_301568_RestoreYennaToTemple()
AND
DB_InCamp(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
THEN
TeleportTo((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, S_GLO_BhaalTemple_AbductionSacrifice_TriggerPos_891c74a5-0ba0-4e09-83d5-f4f4fba200c2, "", 0, 0, 0, 0, 0);
PROC_GEN_OrinsAbduction_CompanionLeaves();

//END_REGION

//REGION GUS-301666
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
AND
DB_QuestDef_State((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769, "WYR_GetGortashGem", "GortashDefeated")
THEN
NOT DB_QuestDef_State((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769, "WYR_GetGortashGem", "GortashDefeated");
NOT DB_QuestDef_State_ConditionalFlag(
	(FLAG)WYR_KillDirectorGortash_State_HasNetherstone_27dbf056-29ee-4d43-9ad9-4831fa2c8739, "WYR_GetGortashGem", "ElderBrain",
	1, (FLAG)END_MorphicPool_Event_GortashHeadPop_a596f4f1-fcce-416c-bf0e-31037a1f4fb0);
DB_QuestDef_ChainedState("GLO_DealWithTheBrain", "GortashDead", "WYR_GetGortashGem", "ElderBrain");
DB_QuestDef_State_ConditionalFlag(
	(FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769, "WYR_GetGortashGem", "GortashDefeated",
	0, (FLAG)END_MorphicPool_Event_GortashHeadPop_a596f4f1-fcce-416c-bf0e-31037a1f4fb0);
//END_REGION GUS-301666

//REGION GUS-301879
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
THEN
SetFaction(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, (FACTION)ACT3_WYR_GalesTressym_88983ca6-c2ed-4c17-9db5-825db4275091);
SetDetached(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
PROC_SetInvulnerable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
DB_BUGFIX_Marker("GUS-301879");
//END_REGION

//REGION GUS-302277

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,15,0)
THEN
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da);
DB_BUGFIX_Marker("GUS-302277");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,15,0)
AND
DB_RelationshipDialog_Queue((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da,"WORLD",_PartnerDateOnly, _MinApproval)
THEN
NOT DB_RelationshipDialog_Queue((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da,"WORLD",_PartnerDateOnly, _MinApproval);
DB_RelationshipDialog_Queue((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da, "WORLDORCAMP",_PartnerDateOnly, _MinApproval);
DB_BUGFIX_Marker("GUS-302277-1");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,15,0)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da,"WORLD",_PartnerDateOnly, _MinApproval)
THEN
NOT DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da,"WORLD",_PartnerDateOnly, _MinApproval);
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da, "WORLDORCAMP",_PartnerDateOnly, _MinApproval);
DB_BUGFIX_Marker("GUS-302277-2");


//END_REGION

//REGION GUS-302410
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
THEN
NOT DB_CampNight_Requirement((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,(FLAG)WYLLAVATAR_b0d1be97-c501-4a9d-8718-e473210a4694,(FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c);
DB_CampNight_Requirement((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,(FLAG)WYLLAVATAR_b0d1be97-c501-4a9d-8718-e473210a4694,(FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_CampNight_CancelledBy((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,(FLAG)CAMP_Ravengard_Event_TurnedInQuest_d7e46c3c-e6a1-b962-d7c8-04fa3eaa2242);


//END_REGION

//REGION GUS-302407
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
THEN
DB_BUGFIX_Marker("302407");
PROC_CAMP_Ravengard_RestoreRavengard();
//END_REGION

//REGION GUS-303010
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_WasInRegion(_Player, S_WYR_Flophouse_KillersLair_0791081e-aaae-46ee-ba27-50a6562fdef8)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag(WYR_OpenHand_State_PickedUpBloodiedKey_c3e0ca6c-32e9-47f6-8a54-b362ad43079a)
THEN
QuestUpdate("WYR_OpenHandMurder", "FollowTheKeyBecauseAlradyEnterLair");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_WasInRegion(_Player, S_WYR_Flophouse_FlowerTrigger_c93fb7b7-9807-4b72-b9a7-71ca9f79e524)
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "FindKeyOrigin")
THEN
QuestUpdate("WYR_OpenHandMurder", "FollowTheKeyBecauseFlophouse");
PROC_TriggerUnregisterForPlayers(S_WYR_Flophouse_FlowerTrigger_c93fb7b7-9807-4b72-b9a7-71ca9f79e524);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_Players(_Player)
AND
TemplateIsInPartyInventory(PUZ_GEN_Key_Flower_A_837fd379-2765-4436-a1d7-f0535a69effe, _Player, _, 0)
AND
DB_GlobalFlag(WYR_OpenHand_State_PickedUpBloodiedKey_c3e0ca6c-32e9-47f6-8a54-b362ad43079a)
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "FindKeyOrigin")
THEN
QuestUpdate("WYR_OpenHandMurder", "FollowTheKeyBecauseKey");
//END_REGION GUS-303010

//REGION GUS-301545

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_CurrentLevel("CTY_Main_A")
THEN
TeleportToPosition(S_LOW_KurwinCoffin_BuriedManSpawnPoint_fc62d2f9-a3c4-4351-8efd-68d5861cf6eb, 17.411, 42.213, 25.242, "", 0);
DB_BUGFIX_Marker("301545");

//END_REGION GUS-301545


//REGION GUS-302407
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
THEN
DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, "WYR_CazadorPalace", "Ascended_NoGur", 0, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, "WYR_CazadorPalace", "Ascended_GurQuest", 1, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
DB_BUGFIX_Marker("GUS-302407");
PROC_GLO_Bugfix_302407();

PROC
PROC_GLO_Bugfix_302407()
AND
DB_OriginDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212)
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_FoundCazador_7021887c-c303-49dc-bb29-71bf88d7157d)
THEN
PROC_GlobalSetFlagAndCache(LOW_CazadorsPalace_RitualRoom_State_FoundCazador_7021887c-c303-49dc-bb29-71bf88d7157d);
QuestUpdate("WYR_CazadorPalace", "FoundCazador");

PROC
PROC_GLO_Bugfix_302407()
AND
DB_QuestIsOpened("WYR_CazadorPalace")
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
DB_GlobalFlag((FLAG)WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0)
THEN
QuestUpdate("WYR_CazadorPalace", "Ascended_GurQuest");

PROC
PROC_GLO_Bugfix_302407()
AND
DB_QuestIsOpened("WYR_CazadorPalace")
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
NOT DB_GlobalFlag((FLAG)WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0)
THEN
QuestUpdate("WYR_CazadorPalace", "Ascended_NoGur");
//END_REGION

//REGION GUS-303483
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_PartOfTheTeam(_Player)
AND
NOT DB_GLO_SteelWatch_EnemyOfAbsoluteCrimeEnabled(_Player, _)
THEN
CharacterStopCrime(_Player, "EnemyOfAbsolute", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-303483");
//END_REGION GUS-303483

//REGION GUS-301585
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag((FLAG)WYR_WyrmRockPrison_State_FlorrickTeleportedToPrison_82a4cbc6-a9ac-4350-be47-043d1691e8de)
AND
NOT DB_PermaDefeated(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9)
AND
NOT DB_OnlyOnce("WYR_WyrmRockPrison_EnableFlorrickEscapeInProgressDialog")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-301585");
DB_GLO_Bugfix_301585_DisableSpottingSneakers(1);

IF
DB_GLO_Bugfix_301585_DisableSpottingSneakers(1)
AND
DB_CurrentLevel("BGO_Main_A")
AND
DB_InRegion(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, S_WYR_WyrmRockPrison_FlorricksCell_db3096d9-3177-4245-93a6-f01c8bb6889f)
THEN
NOT DB_GLO_Bugfix_301585_DisableSpottingSneakers(1);
SetCanSpotSneakers((CHARACTER)S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9, 0);
//END_REGION

//REGION GUS-301584
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
NOT DB_CampNight_ExclusiveMoment((FLAG)NIGHT_Shadowheart_Skinnydipping_9f583304-0a1a-498c-acf9-3c8dcc30ee3d);
NOT DB_CampNight_ExclusiveMoment((FLAG)NIGHT_Shadowheart_NightfallRitual_8f1697d4-2402-4283-802a-ef7e1ebd8aa1);
DB_BUGFIX_Marker("GUS-301584");

//END_REGION GUS-301584

//REGION GUS-303980
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_WYR_South_AccessGrantedPatched(2); // re-evaluates the flags rule in the WYR goal
DB_BUGFIX_Marker("GUS-303980");
//END_REGION GUS-303980

//REGION GUS-302256-B
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_PermaDefeated(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
AND
DB_WYR_Ironhand_Gnomes(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
THEN
PROC_CharacterEnableAllCrimes(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96);
DB_BUGFIX_Marker("GUS-302256-B");
//END_REGION GUS-302256-B

//REGION GUS-303851
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_WYR_RefugeeCamp_AwaitingInterrogation(_)
AND
DB_GlobalFlag(WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417)
THEN
ClearFlag((FLAG)WYR_RefugeeCamp_Event_BigBarnTrespassReact_787c870a-3e4c-2bde-ab0d-d54b14784012, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);
DB_BUGFIX_Marker("GUS-303851");
//END_REGION GUS-303851

//REGION GUS-300213
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_GlobalFlagReactionAfterDialog(WYR_SentientAmulet_Event_SurprisePlayersInCombat_8ccbee09-c0fb-a542-8909-aea7b1980ddb,(DIALOGRESOURCE)WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed);

//END_REGION GUS-300213

//REGION GUS-304184
// Avoid soft-locking players if they try to leave WYR and Karlach was arrested
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_IsArrested(S_WYR_AudienceHall_SteelWatcher_003_6622cf7f-a119-4c42-9a1e-b7cc4543dd19, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_RegionPrison_CustomCell((TRIGGER)S_WYR_WyrmRockPrison_PlayerCell_6792230e-f319-4870-8778-5f7bfae74489, (TRIGGER)S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_WYR_KarlachsCellPos_d1d61fae-69e8-4000-8ba1-6f6b7ea42514, (ITEM)S_WYR_WyrmRockPrison_KarlachsCellDoor_ca3f8d0e-b59c-4281-9174-f10f40f612bf, "WYR_WyrmRockPrison_PrisonDoor")
AND
DB_PlayerPrison((TRIGGER)S_WYR_WyrmRockPrison_PlayerCell_6792230e-f319-4870-8778-5f7bfae74489,(STRING)_PrisonCrimeName,(STRING)_PrisonCrimeNameAD,(STRING)_FugitiveStatus)
AND
DB_CRIME_PrisonArrestedNonShapeshifted(_Player, S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768, _ArrestedNotShapeshifted)
THEN
DB_BUGFIX_Marker("GUS-304184");
NOT DB_CRIME_PrisonArrestedNonShapeshifted(_Player, S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768, _ArrestedNotShapeshifted);
PROC_CRIME_Prison_Escaped(_Player, S_WYR_AudienceHall_SteelWatcher_003_6622cf7f-a119-4c42-9a1e-b7cc4543dd19, S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768, _ArrestedNotShapeshifted, _PrisonCrimeName, _PrisonCrimeNameAD, _FugitiveStatus);
//END_REGION GUS-304184

//REGION GUS-297025
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "DaggerFound", 1);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "DolorIsKiller", 1);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "DolorKillerNotBrilgor", 1);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "EnterCaves", 1);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Key", "FindKeyOrigin", 2);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Key", "DaggerFoundAfterKey", 2);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseKey", 3);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseFlophouse", 3);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseDoppelganger", 3);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseAlradyEnterLair", 3);
DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps("WYR_OpenHandMurder_InvestigateCrimeScene", "TalkedValeria_OnlyDagger");
DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps("WYR_OpenHandMurder_Key", "TalkedValeriaDagger_KeyFound");
DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps("WYR_OpenHandMurder_Flophouse", "TalkerValeriaDagger_Flophouse");
DB_WYR_OpenHand_DaggerObjectiveDatabase_CurrentObjective("Base", "Base", 0);
DB_BUGFIX_Marker("GUS-297025");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(WYR_SerialKiller_State_ToldValeriaAboutDagger_39b8c37f-9e84-4750-82a6-6c966c644765)
AND
QRY_OnlyOnce_Reset("WYR_LOW_OpenHandMurder_ValeriaDagger")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("WYR_LOW_OpenHandMurder_ValeriaDagger")
AND
QRY_WYR_OpenHand_PickDaggerObjective(_Player)
THEN
PROC_WYR_OpenHand_FinishEvaluation();
//END_REGION GUS-297025

//REGION GUS-303965
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_TalkedAboutHeart_12fecc65-b6f4-4dc3-3832-2f81314fc22d,_,_,_)
AND
DB_GlobalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_TalkedAboutHeart_12fecc65-b6f4-4dc3-3832-2f81314fc22d);
DB_BUGFIX_Marker("GUS-303965");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_TalkedAboutHeart_12fecc65-b6f4-4dc3-3832-2f81314fc22d,_,_,_)
AND
DB_GlobalFlag((FLAG)CAMP_Ravengard_Event_TurnedInQuest_d7e46c3c-e6a1-b962-d7c8-04fa3eaa2242)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_TalkedAboutHeart_12fecc65-b6f4-4dc3-3832-2f81314fc22d);
DB_BUGFIX_Marker("GUS-303965");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_IPRD_Event_Finale_1569ec67-be68-4227-8ed4-d6c2f96ead52,_,_,_)
AND
NOT DB_GlobalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_IPRD_Event_Finale_1569ec67-be68-4227-8ed4-d6c2f96ead52);
DB_BUGFIX_Marker("GUS-303965");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_IPRD_Event_Finale_1569ec67-be68-4227-8ed4-d6c2f96ead52,_,_,_)
AND
DB_GlobalFlag((FLAG)CAMP_Ravengard_Event_TurnedInQuest_d7e46c3c-e6a1-b962-d7c8-04fa3eaa2242)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_IPRD_Event_Finale_1569ec67-be68-4227-8ed4-d6c2f96ead52);
DB_BUGFIX_Marker("GUS-303965");

//END_REGION GUS-303965

//REGION GUS-304284

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-304284");
DB_BUGFIX_304284_DoFix(1);

IF
DB_BUGFIX_304284_DoFix(1)
AND
DB_ActiveLevel("BGO_Main_A")
AND
DB_WYR_SentientAmulet_Zombies_Tombs((CHARACTER)_,(ITEM)_Bed,(ITEM)_,(TRIGGER)_)
THEN
SetVisible(_Bed,0);

IF
DB_BUGFIX_304284_DoFix(1)
AND
DB_ActiveLevel("BGO_Main_A")
THEN
NOT DB_BUGFIX_304284_DoFix(1);

//END_REGION GUS-304284

//REGION GUS-303548 - Karlach's Back at Home NIGHT
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2 Rev 1")
AND
DB_GlobalFlag((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9)
AND
NOT DB_GlobalFlag((FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac)
THEN
DB_BUGFIX_Marker("GUS-303548");
PROC_ORI_Karlach_BackAtHomeNight();

//END_REGION GUS-303548 - Karlach's Engine Problems NIGHT

//REGION GUS-304291
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2 Rev 1")
THEN
PROC_SavegamePatch_GUS304291();

PROC
PROC_SavegamePatch_GUS304291()
AND
DB_GlobalFlag((FLAG)WYR_Posthouse_State_DogVisitedPosthouse_47f6f7a4-7c94-41fd-84dd-fb558b08b531)
AND
NOT DB_GlobalFlag((FLAG)WYR_Posthouse_State_EquerryReclaimedDog_56d9cc7b-861d-9ffd-7eed-d83f95419e4d)
AND
NOT DB_GlobalFlag((FLAG)WYR_Posthouse_State_PlayerReclaimedDog_513268de-0000-f621-2e77-13bb6c5fd74f)
AND
NOT DB_GlobalFlag((FLAG)WYR_Posthouse_State_PlayerAttacksEquerry_98a9b541-a924-1a4c-b7d0-b384fd2281f7)
THEN
ClearFlag((FLAG)WYR_Posthouse_State_DogVisitedPosthouse_47f6f7a4-7c94-41fd-84dd-fb558b08b531);
DB_BUGFIX_Marker("GUS-304291");

PROC
PROC_SavegamePatch_GUS304291()
AND
DB_CurrentLevel("BGO_Main_A")
AND
DB_StartDialog_StuckTimelineLoad_StuckDetected((DIALOGRESOURCE)WYR_Posthouse_EquerryGroom_cf775f02-1bf8-d214-3843-49d2f39c3f34)
THEN
DialogRequestStopForDialog((DIALOGRESOURCE)WYR_Posthouse_EquerryGroom_cf775f02-1bf8-d214-3843-49d2f39c3f34, S_WYR_Posthouse_Equerry_800e7e52-64f1-4a52-a2a2-5a409e8aab53);
DialogRequestStopForDialog((DIALOGRESOURCE)WYR_Posthouse_EquerryGroom_cf775f02-1bf8-d214-3843-49d2f39c3f34, S_WYR_Posthouse_Groom_1b61a7e3-0973-4bb1-9793-7735a8ea12b3);
DB_BUGFIX_Marker("GUS-304291");
//END_REGION GUS-304291

//REGION GUS-303827-B
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_CAMP_OrthonVisit_NeedsPatching(1); // for Orthon pos teleport
NOT DB_WYR_Circus_Statue_CampPosTriggers("ELFSONG", (TRIGGER)S_CAMP_ELFSONG_CircusStatuePos_7a01b784-e1a3-416b-8ca2-38cc64db0666,(ITEM)S_CAMP_ELFSONG_CircusStatuePedestal_f99160d4-ddea-4387-a646-1a54cc22aea9);
DB_WYR_Circus_Statue_CampPosTriggers("ELFSONG", (TRIGGER)S_CAMP_ELFSONG_CircusStatuePos_Patched_641a86bf-4d48-42da-993b-14c6ce4543d7,(ITEM)S_CAMP_ELFSONG_CircusStatuePedestal_f99160d4-ddea-4387-a646-1a54cc22aea9);
DB_BUGFIX_Marker("GUS-303827-B");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_WYR_Circus_StatueSentToCamp(_Player)
THEN
NOT DB_ORI_OriginCampData(S_WYR_Circus_StatueDummy_c2ef6bde-3dbe-4ff5-99ca-8120445a8309, "ELFSONG", S_CAMP_ELFSONG_CircusStatuePos_7a01b784-e1a3-416b-8ca2-38cc64db0666);
DB_ORI_OriginCampData(S_WYR_Circus_StatueDummy_c2ef6bde-3dbe-4ff5-99ca-8120445a8309, "ELFSONG", S_CAMP_ELFSONG_CircusStatuePos_Patched_641a86bf-4d48-42da-993b-14c6ce4543d7);
PROC_ORI_SetupCamp((CHARACTER)S_WYR_Circus_StatueDummy_c2ef6bde-3dbe-4ff5-99ca-8120445a8309, 1);
DB_InCamp(S_WYR_Circus_StatueDummy_c2ef6bde-3dbe-4ff5-99ca-8120445a8309);
PROC_SetArmourSet(S_WYR_Circus_StatueDummy_c2ef6bde-3dbe-4ff5-99ca-8120445a8309, ARMOURSET.Normal);

// Orthon visit patching
IF
DB_ActiveCamp("SLUMS")
AND
DB_CAMP_OrthonVisit_NeedsPatching(1)
AND
DB_InCamp((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_OffStage(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
THEN
TeleportTo(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, S_CAMP_SLUMS_Orthon_TriggerPatchPos_e3a0c4f1-c3f1-48bd-9fc5-61461a24db0a);

IF
DB_ActiveCamp("SLUMS")
AND
DB_CAMP_OrthonVisit_NeedsPatching(1)
THEN
NOT DB_CAMP_OrthonVisit_NeedsPatching(1);
TeleportTo(S_CAMP_SLUMS_Orthon_9fa37f75-35e4-4171-8af9-ce080df080ff, S_CAMP_SLUMS_Orthon_TriggerPatchPos_e3a0c4f1-c3f1-48bd-9fc5-61461a24db0a);
//END_REGION GUS-303827-B

//REGION GUS-304544
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
THEN
NOT DB_QuestDef_State((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c,"PLA_GrandDukeRescue","ReachedIRN");
DB_QuestDef_State_ConditionalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c,"PLA_GrandDukeRescue","ReachedIRN",1,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61,"ORI_COM_Wyll","DiedIRN",1,(FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61,"ORI_COM_Wyll","DiedIRN",1,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61,"ORI_Avatar_Wyll","DiedIRN",1,(FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61,"ORI_Avatar_Wyll","DiedIRN",1,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
DB_BUGFIX_Marker("GUS-304544");

//END_REGION GUS-304544

//REGION GUS-304234
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(GLO_EmperorPrelude_State_AllStonesPickedUp_f5f28f14-985f-449d-a9de-95ee46d2fca8)
AND
NOT DB_GlobalFlag(END_MorphicPool_State_UnlockedAccess_b65fedb8-ed89-4ccf-b20f-3338474bda18)
THEN
SetFlag(END_MorphicPool_State_UnlockedAccess_b65fedb8-ed89-4ccf-b20f-3338474bda18);
DB_BUGFIX_Marker("GUS-304234");
//END_REGION

//REGION GUS-298601
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-298601");
NOT DB_PrisonReactionTrigger((TRIGGER)S_WYR_WyrmRock_PlayerCell_6792230e-f319-4870-8778-5f7bfae74489, (TRIGGER)S_WYR_WyrmRockPrison_FortressCrimeRegionTrigger_438d4010-b1ab-4851-a785-9e9f1d1198ab);
PROC_GLO_Bugfix_298601_RemoveFugitiveStatus();

PROC
PROC_GLO_Bugfix_298601_RemoveFugitiveStatus()
AND
DB_Players(_Player)
AND
NOT DB_InRegion(_Player, (TRIGGER)S_WYR_Prison_SUB_cd67276d-52e4-44b9-a237-0e2cd45106d8)
AND
HasActiveStatus(_Player, "GB_FUGITIVE_WYR", 1)
THEN
PROC_CRIME_PrisonRemoveFugitiveStatuses(_Player);
//END_REGION
//REGION GUS-304504
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381)
AND
DB_CampNight_Completed((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3)
THEN
PROC_GLO_Monitor_EntityPoof(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c);
DB_CanBeResurrected(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"FARM",(TRIGGER)S_CAMP_Ravengard_e50982fd-0b00-4287-b183-20eddeb3069b);
DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"SLUMS",(TRIGGER)S_CAMP_SLUMS_Ravengard_81249232-3284-4e78-9de8-4c4407914c8e);
DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"ELFSONG",(TRIGGER)S_CAMP_ELFSONG_Ravengard_6cace9b7-a095-44cf-98df-c5a6c7a3e090);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,"FARM",(TRIGGER)S_FARM_MizorasPact_Devil01_Point_71b54b5c-eb8b-477b-9129-28cb4864aa8c);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,"SLUMS",(TRIGGER)S_CAMP_MizorasPact_Devil01_Point_ba130696-019b-4717-a66e-9c4c50141a85);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,"ELFSONG",(TRIGGER)S_ELFSONG_MizorasPact_Devil01_Point_6b07a6a1-6048-4229-8b69-b85c1d531130);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,"FARM",(TRIGGER)S_FARM_MizorasPact_Devil02_Point_ac0544cf-3920-4467-a35c-9173f97df6a0);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,"SLUMS",(TRIGGER)S_CAMP_MizorasPact_Devil02_Point_67b32487-681b-4b21-9311-0cb39537e10b);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,"ELFSONG",(TRIGGER)S_ELFSONG_MizorasPact_Devil02_Point_d108a198-f1cc-4474-951e-7d98364c1f29);
DB_CampNight((FLAG)NIGHT_Wyll_MizorasPactPatch_222fdd82-6b57-440f-b5ce-02152adf3554,5240 /* 6240 for avatar */, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasPactPatch_222fdd82-6b57-440f-b5ce-02152adf3554,"FARM");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasPactPatch_222fdd82-6b57-440f-b5ce-02152adf3554,"SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasPactPatch_222fdd82-6b57-440f-b5ce-02152adf3554,"ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizorasPactPatch_222fdd82-6b57-440f-b5ce-02152adf3554,(FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206,(FLAG)WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e);
DB_CampNight_CFM((FLAG)NIGHT_Wyll_MizorasPactPatch_222fdd82-6b57-440f-b5ce-02152adf3554,(DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2);
DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2,
								(GUIDSTRING)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,
								(GUIDSTRING)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,
								(GUIDSTRING)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,
								(GUIDSTRING)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampfireMoment_OptionalSpeakers((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2,S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_CampNight_CRD((FLAG)NIGHT_Wyll_MizorasPactPatch_222fdd82-6b57-440f-b5ce-02152adf3554,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c);
DB_BUGFIX_Marker("GUS-304504");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
DB_GlobaLFlag((FLAG)WYR_KillDirectorGortash_State_RavengardForceRemoval_cda5ec5a-5614-45d5-aa60-f99e210dab5d)
AND
NOT DB_OnlyOnce("WYR_KillDirectorGortash_RemoveRavengardFromAudienceHall")
THEN
PROC_WYR_KillDirectorGortash_RavengardReadyToDisappear();
DB_BUGFIX_Marker("GUS-304504");

//END_REGION

//REGION GUS-305211

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-305211 2");
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_BeMyGod_0c7cb6c2-4097-9bb1-aa0e-6edfaa7abb2e);

//END_REGION

//REGION GUS-303127
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)PLA_KarlachRecruitment_State_DammonUnavailable_96af4ae3-496d-497f-afb5-fec042fe6f27)
THEN
DB_BUGFIX_Marker("GUS-303127");
PROC_ORI_Karlach_CloseForgingOfTheHeartQuest();
//END_REGION GUS-303127

//REGION GUS-304901
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GUS-304901_WYR_Endgame_DarkUrge")//To avoid check for multiple players
AND
QuestUpdateIsUnlocked(_Player, "WYR_OpenHandMurder", "WYR_Endgame_DarkUrge", 1)
THEN
QuestClose("WYR_OpenHandMurder");
DB_BUGFIX_Marker("GUS-304901");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GUS-304901_WYR_FinishMurderTribunal")//To avoid check for multiple players
AND
QuestUpdateIsUnlocked(_Player, "WYR_OpenHandMurder", "WYR_FinishMurderTribunal", 1)
THEN
QuestClose("WYR_OpenHandMurder");
DB_BUGFIX_Marker("GUS-304901");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GUS-304901_WYR_ValeriaIsDead")//To avoid check for multiple players
AND
QuestUpdateIsUnlocked(_Player, "WYR_OpenHandMurder", "WYR_ValeriaIsDead", 1)
THEN
QuestClose("WYR_OpenHandMurder");
DB_BUGFIX_Marker("GUS-304901");
//END_REGION GUS-304901

//REGION GUS-306931
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_BUGFIX_DoFix("306001-1");
DB_BUGFIX_DoFix("306001-2");

IF
LevelGameplayStarted(_,_)
AND
DB_BUGFIX_DoFix("306001-1")
AND
Exists(S_WYR_PaintingPuzzle_SolutionPainting1_Solved_05a742e1-efad-4f97-af99-47852aaf8bc8, 1)
THEN
Transform(S_WYR_PaintingPuzzle_SolutionPainting1_Solved_05a742e1-efad-4f97-af99-47852aaf8bc8, S_WYR_PaintingPuzzle_SolutionPainting1_31746c94-4f33-4bc2-8348-5952c6bf0947, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
NOT DB_BUGFIX_DoFix("306001-1");
DB_BUGFIX_Marker("306001-1");

IF
LevelGameplayStarted(_,_)
AND
DB_BUGFIX_DoFix("306001-2")
AND
Exists(S_WYR_PaintingPuzzle_SolutionPainting2_Solved_800c97ea-3c4b-4fc4-bc91-f042c6047e93, 1)
THEN
Transform(S_WYR_PaintingPuzzle_SolutionPainting2_Solved_800c97ea-3c4b-4fc4-bc91-f042c6047e93, S_WYR_PaintingPuzzle_SolutionPainting2_b878885e-8efa-42c7-a9bd-8238e08d5fad, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
NOT DB_BUGFIX_DoFix("306001-2");
DB_BUGFIX_Marker("306001-2");

//END_REGION

//REGION GUS-300963
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_OnlyOnce("WYR_SmugglersCave_Resolved")
THEN
PROC_WYR_BUGFIX_RemoveOffstageCharsFromInventories();
DB_WYR_BUGFIX_SmugglersCaveLongRestCleanup(1);

// Removing offstaged characters in case they are accessible and are in inventories. Doing it for them not in current level is too much of hassle for what it gives
PROC
PROC_WYR_BUGFIX_RemoveOffstageCharsFromInventories()
AND
DB_WYR_SmugglersCave_SmugglersList(_Character)
THEN
PROC_WYR_BUGFIX_RemoveOffstageCharsFromInventories_Internal(_Character);

PROC
PROC_WYR_BUGFIX_RemoveOffstageCharsFromInventories()
AND
DB_WYR_SmugglersCave_AttackersList(_Character)
THEN
PROC_WYR_BUGFIX_RemoveOffstageCharsFromInventories_Internal(_Character);

PROC
PROC_WYR_BUGFIX_RemoveOffstageCharsFromInventories_Internal((CHARACTER)_Character)
AND
DB_OffStage(_Character)
AND
IsInInventory(_Character,1)
THEN
DB_BUGFIX_Marker("GUS-300963");
TeleportTo(_Character,S_Debug_Teleport_WYR_SmugglersCave_f8b3cf2c-6481-4ea8-9526-451861f648db);

// Ensuring that smuggler's cave entities are set offstage in this state in case it previously didn't work due to being called not on BGO_Main_A
IF
DB_WYR_BUGFIX_SmugglersCaveLongRestCleanup(1)
AND
DB_CurrentLevel("BGO_Main_A")
THEN
NOT DB_WYR_BUGFIX_SmugglersCaveLongRestCleanup(1);
PROC_WYR_BUGFIX_SmugglersCaveLongRestCleanup();

PROC
PROC_WYR_BUGFIX_SmugglersCaveLongRestCleanup()
THEN
DB_BUGFIX_Marker("GUS-300963");
PROC_WYR_Smugglers_ClearCave();
PROC_WYR_SmugglersCave_ClearCave_Smugglers();
PROC_WYR_SmugglersCave_ClearCave_Attackers();
//END_REGION

//REGION GUS-304723
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
GetRegion(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _Region) // can be in WYR or LOW
THEN
DB_BUGFIX_Marker("GUS-304723");
NOT DB_SurrenderOnKnockedOutDialog((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, (DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
DB_GLO_Bugfix_304723_FixGortash(_Region);
DB_GLO_Bugfix_304723_FixTrigger(1);

IF
DB_GLO_Bugfix_304723_FixGortash(_Region)
AND
DB_CurrentLevel(_Region)
THEN
NOT DB_GLO_Bugfix_304723_FixGortash(_Region);
PROC_GLO_Bugfix_304723_FixGortash();

PROC
PROC_GLO_Bugfix_304723_FixGortash()
AND
HasActiveStatus(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, "SURRENDERED", 1)
THEN
PROC_RemoveDialog(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac);

IF
DB_GLO_Bugfix_304723_FixTrigger(1)
AND
DB_CurrentLevel("BGO_Main_A")
THEN
NOT DB_GLO_Bugfix_304723_FixTrigger(1);
PROC_TriggerRegisterForPlayers((TRIGGER)S_WYR_KillDirectorGortash_RavengardRemovalArea_Bridge_77770f96-ebfa-4e9e-9a27-a3ef0090d7ba);
//END_REGION

//REGION GUS-304412
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Shadowheart_Skinnydipping_9f583304-0a1a-498c-acf9-3c8dcc30ee3d)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (FLAG)ORI_Shadowheart_State_FirstRomanceHappened_9d075859-2653-4026-85d0-2c3687259f0c, "CAMP", 1, -100 )
THEN
DB_BUGFIX_Marker("GUS-304412");
PROC_CancelRelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (FLAG)ORI_Shadowheart_State_FirstRomanceHappened_9d075859-2653-4026-85d0-2c3687259f0c);
PROC_CampRelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)CAMP_Shadowheart_CRD_SkinnyDippingRomance_dfb63080-93da-035a-0435-56eee35a63c0, NULL_00000000-0000-0000-0000-000000000000, 1, 40);
PROC_Try_CampRelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);
//END_REGION GUS-304412

//REGION GUS-304734
// Merchants house
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_PermaDefeatedFlag(S_WYR_MerchantsHouse_Merchant_b2a50d09-709a-483c-9818-acebcff2b977, WYR_MerchantsHouse_Merchant_State_PermaDefeated_9c5cdc84-7fa5-8499-dc3b-63df44288d3c);
DB_BUGFIX_Marker("GUS-304734-E");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_PermaDefeated(S_WYR_MerchantsHouse_Merchant_b2a50d09-709a-483c-9818-acebcff2b977)
THEN
PROC_GlobalSetFlagAndCache(WYR_MerchantsHouse_Merchant_State_PermaDefeated_9c5cdc84-7fa5-8499-dc3b-63df44288d3c);
DB_BUGFIX_Marker("GUS-304734-F");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(WYR_MerchantsHouse_Merchant_Event_ToPrison_fd34ea4a-fb0a-1f11-9bd5-ff66d0901c5f)
AND
NOT DB_GlobalFlag(WYR_MerchantsHouse_Merchant_State_InPrison_e96b73b9-1e15-75f1-e61d-af9b713d6b25)
AND
NOT DB_WYR_MerchantsHouse_MerchantDestinationEvent(_,_,_,_)
THEN
PROC_GlobalClearFlagAndCache((FLAG)WYR_MerchantsHouse_Merchant_State_InSharessCaress_0705f4a6-48c2-afbd-8e4c-a4cf1d2c09e6);
DB_WYR_MerchantsHouse_MerchantDestinationEvent(
	(TRIGGER)S_WYR_WyrmRockPrison_MerchantPos_cb54085d-6f26-4bcb-8907-e3dc32b03970,
	(FLAG)WYR_MerchantsHouse_Merchant_State_InPrison_e96b73b9-1e15-75f1-e61d-af9b713d6b25,
	(TRIGGER)S_WYR_Prison_SUB_cd67276d-52e4-44b9-a237-0e2cd45106d8,
	(TRIGGER)S_WYR_Rivington_SUB_40c3661e-99a1-4189-aa69-c006e77e3db8);
DB_BUGFIX_Marker("GUS-304734-A");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_WYR_MerchantsHouse_FindObjectiveSteps(_)
THEN
NOT DB_WYR_MerchantsHouse_FindObjectiveSteps("FoundToys_Knows_SC");
NOT DB_WYR_MerchantsHouse_FindObjectiveSteps("FoundBlackmail_After_SC");
NOT DB_WYR_MerchantsHouse_FindObjectiveSteps("Confront_WentToSC");
DB_WYR_MerchantsHouse_FindArfurObjectiveSteps("BanitesDefeated_BeforeArfur_DoesntKnow", "KnowsLikesSC_After", 1);
DB_WYR_MerchantsHouse_FindArfurObjectiveSteps("FoundToys_Knows_SC", "KnowsLikesSC", 0);
DB_WYR_MerchantsHouse_FindArfurObjectiveSteps("FoundBlackmail_After_SC", "KnowsLikesSC", 0);
DB_WYR_MerchantsHouse_FindArfurObjectiveSteps("Confront_WentToSC", "KnowsLikesSC", 0);
DB_WYR_MerchantsHouse_InvestigateObjectiveSteps("LearnedGortashBehind");
DB_WYR_MerchantsHouse_InvestigateObjectiveSteps("ConfessedNoPassword");
DB_WYR_MerchantsHouse_InvestigateObjectiveSteps("ConfessedAfterFireworks");
DB_WYR_MerchantsHouse_InvestigateObjectiveSteps("EnteredFireworksFoundBlackmail");
DB_GlobalFlagReactionAfterDialog((FLAG)WYR_MerchantsHouse_State_MerchantConfessed_b9c702f4-ed9c-4fe5-0250-8bd96d21a044, (DIALOGRESOURCE)WYR_MerchantsHouse_Merchant_90252ba6-d583-c79d-f60d-211a72e496bb);
DB_BUGFIX_Marker("GUS-304734-A2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_PermaDefeatedOrOffstage(S_WYR_MerchantsHouse_Merchant_b2a50d09-709a-483c-9818-acebcff2b977)
THEN
PROC_GlobalClearFlagAndCache((FLAG)WYR_MerchantsHouse_Merchant_State_InSharessCaress_0705f4a6-48c2-afbd-8e4c-a4cf1d2c09e6);
DB_BUGFIX_Marker("GUS-304734-A3");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_QuestIsOpened("WYR_Donations")
AND
DB_WYR_MerchantsHouse_InvestigateObjectiveSteps(_QuestUpdate)
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_Donations", _QuestUpdate)
THEN
NOT DB_WYR_MerchantsHouse_Journal_OnFireworksObjecitve(0);
DB_WYR_MerchantsHouse_Journal_OnFireworksObjecitve(1);
DB_BUGFIX_Marker("GUS-304734-A4");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_WYR_MerchantsHouse_Journal_PatchReEvaluate(1);
DB_BUGFIX_Marker("GUS-304734-A5");

// Fireworks Shop
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_BookFlags(S_LOW_FireworksHouse_IronThroneExplosives_91807efb-a734-4e10-9020-3eef1f938dc5, LOW_FireworksHouse_Knows_GortashBehind_2aece2e5-2a24-4e5b-a67f-670fb4173c76);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_InRegion(_Player, S_LOW_FireworksHouse_SUB_61e0aab9-16a2-44c7-b063-e789899baa2c)
AND
DB_PartyMembers(_Player)
THEN
PROC_GlobalSetFlagAndCache(LOW_FireworksHouse_State_EverEnteredBefore_6cbdebba-535e-4b49-b501-2d17e2ad2461);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_FireworksHouse_Knows_GortashBehind_2aece2e5-2a24-4e5b-a67f-670fb4173c76)
THEN
PROC_GlobalSetFlagAndCache(LOW_FireworksHouse_State_EverEnteredBefore_6cbdebba-535e-4b49-b501-2d17e2ad2461);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
GetRelation((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)ACT3_LOW_FireworksHouse_Banites_f1aedb53-13e0-4a04-a037-1be782d39392, 0)
THEN
DB_LOW_FireworksHouse_BanitesHostile(1);
PROC_GLO_DefeatCounter_CheckFinished("LOW_FireworksHouse_Banites");
DB_BUGFIX_Marker("GUS-304734-B");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_FireworksHouse_BanitesHostile(1)
AND
NOT DB_OffStage(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462)
AND
NOT DB_Defeated(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462)
THEN
PROC_SetOnStage(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462, 0);
DB_BUGFIX_Marker("GUS-304734-C");

// Journal patching
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)WYR_MerchantsHouse_Merchant_Event_DisappearAfterConfession_a05ed7d5-c109-6ff9-2b19-0ace8d409bac)
AND
DB_GlobalFlag((FLAG)WYR_MerchantsHouse_State_MerchantConfessed_b9c702f4-ed9c-4fe5-0250-8bd96d21a044)
AND
NOT DB_GlobalFlag(LOW_FireworksHouse_Knows_GortashBehind_2aece2e5-2a24-4e5b-a67f-670fb4173c76)
AND
NOT DB_GlobalFlag(LOW_FireworksHouse_Knows_Password_dcf4bb90-caf1-079f-d9bb-c51c3463b79e)
AND
NOT DB_LOW_FireworksHouse_BanitesPermaDefeated(1)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_Donations", "BanitesAttacked")
THEN
QuestUpdate("WYR_Donations", "ConfessedNoPassword");
DB_BUGFIX_Marker("GUS-304734-D1");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)WYR_MerchantsHouse_State_MerchantConfessed_b9c702f4-ed9c-4fe5-0250-8bd96d21a044)
AND
DB_GlobalFlag(LOW_FireworksHouse_State_EverEnteredBefore_6cbdebba-535e-4b49-b501-2d17e2ad2461)
AND
DB_GlobalFlag((FLAG)LOW_FireworksHouse_Knows_GortashBehind_2aece2e5-2a24-4e5b-a67f-670fb4173c76)
AND
NOT DB_GlobalFlag(LOW_FireworksHouse_Knows_Password_dcf4bb90-caf1-079f-d9bb-c51c3463b79e)
AND
NOT DB_LOW_FireworksHouse_BanitesPermaDefeated(1)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_Donations", "BanitesAttacked")
THEN
QuestUpdate("WYR_Donations", "ConfessedAfterFireworks");
DB_BUGFIX_Marker("GUS-304734-D2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)WYR_MerchantsHouse_State_MerchantConfessed_b9c702f4-ed9c-4fe5-0250-8bd96d21a044)
AND
DB_LOW_FireworksHouse_BanitesPermaDefeated(1)
THEN
QuestUpdate("WYR_Donations", "ArfurConfessed_AfterFireworks");
DB_BUGFIX_Marker("GUS-304734-D3");
//END_REGION GUS-304734

//REGION GUS-304828
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_PartyMembers((CHARACTER)_Char)
AND
DB_GLO_GlobalItems_FacePaints(_FacePaint, _MaterialID)
AND
HasAppliedStatus(_Char, _FacePaint, 0)
THEN
RemoveCustomMaterialOverride(_Char, _MaterialID);
DB_BUGFIX_Marker("GUS-304828");
//END_REGION GUS-304828

//REGION GUS-305279
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)ORI_Karlach_Event_ClearAfterGortashDefeatCRDAndIPRD_bbc8076f-bdd6-f53a-d9c3-3cfd87df1baf)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_AfterDefeatingGortash_585a4ee6-b04f-2559-2bc5-ae99a1f57ff2, _, _, _)
THEN
DB_BUGFIX_Marker("GUS-304412");
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_AfterDefeatingGortash_585a4ee6-b04f-2559-2bc5-ae99a1f57ff2);
//END_REGION GUS-305279

//REGION GUS-305515
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_PermaDefeated(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
AND
DB_WYR_Ironhand_Gnomes(S_GLO_InjuredGnome_fcf53ac7-1805-4e57-b6ed-4f7b0f90cf96)
THEN
PROC_SceneOver("UND_InjuredGnome_SceneDialogOnly");
DB_BUGFIX_Marker("GUS-305515");
//END_REGION GUS-305515

//REGION GUS-300421
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(LOW_BhaalTemple_State_OrinLaezelKillsYenna_84065b20-4337-4010-87d7-0a62f855298c)
THEN
PROC_GEN_OrinsAbduction_Yenna_Killcat();
NOT DB_YennaDismissedFromCamp(1); // to make sure Yenna doesn't reappear dead in camp once she's been killed by Orin.
NOT DB_InCamp(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
DB_BUGFIX_Marker("GUS-300421");
//END_REGION GUS-300421

//REGION GUS-305346
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-305346");
PROC_GLO_Bugfix_305346_RestoreOrin();

// for when she's revealed herself after being attacked but is just standing there, or is in combat with the player due to them commiting a crime near her.
PROC
PROC_GLO_Bugfix_305346_RestoreOrin()
AND
DB_GEN_OrinsAbduction_OrinAttacker(_) // if attacker was never cleared most likely she never teleport out.
AND
DB_WYR_OrinsImpersonation_OrinCurrentImpersonation("FlamingFist") // and the current impersonation is still the flaming fist
AND
NOT DB_GEN_OrinsAbduction_IsTransformed(1) // she is no longer transformed.
AND
IsTagged(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (TAG)ACT3_LOW_ORIN_fd10b344-0360-412c-acd1-a12529acd673, 1) // she has her Orin tag therefore for sure she has revealed herself.
AND
NOT QRY_GLO_Bugfix_305346_IsInAttackedDialog() // Orin is not in the Attacked dialog which is a legitimate state.
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // if temple combat has somehow begun, doubt its possible but no harm in making sure.
THEN
PROC_WYR_OrinsImpersonation_EndImpersonationByAttack();

QRY
QRY_GLO_Bugfix_305346_IsInAttackedDialog()
AND
DB_DialogNPCs(_ID, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _)
AND
DB_DialogName((DIALOGRESOURCE)WYR_OrinsImpersonation_LINE_OrinAttacked_54169b5d-e726-4f5f-6211-f583081f26ff, _ID)
THEN
DB_NOOP(1);
//END_REGION
//REGION GUS-303980
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_WYR_South_AccessGrantedPatched(_Version)
THEN
NOT DB_WYR_South_AccessGrantedPatched(_Version);
DB_BUGFIX_Marker("GUS-303980-B");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_WYR_KillDirectorGortash_CalmSteelWatch_Patched(1)
THEN
DB_WYR_KillDirectorGortash_CalmSteelWatch_Patched(1); // re-evaluates the flags rule in the WYR goal
DB_BUGFIX_Marker("GUS-303980-C");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(WYR_KillDirectorGortash_State_AcceptedAlliance_92e647a6-4625-4a2b-a143-35cba456fe50)
THEN
PROC_GlobalClearFlagAndCache((FLAG)GLO_SteelWatchers_State_EnemyOfAbsolute_1e72bf66-e983-42e5-bd41-10b03eb9e713);
DB_BUGFIX_Marker("GUS-303980-D");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_Players(_Player)
AND
GetFlag(WYR_South_Event_AgreedCustody_a85fefb5-6f59-4709-b310-b82a1e13411f, _Player, 1)
THEN
ClearFlag(WYR_South_Event_AgreedCustody_a85fefb5-6f59-4709-b310-b82a1e13411f, _Player);
DB_BUGFIX_Marker("GUS-303980-E");
//END_REGION GUS-303980

//REGION GUS-306013
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-306013");
PROC_GLO_BrainEscalation_ForceUpdateDBSees();
//END_REGION
//REGION GUS-305130
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CTY_ForrickConfrontationSetupDone(_Version)
AND
NOT DB_GlobalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61)
AND
NOT DB_GlobalFlag((FLAG)LOW_FlorrickFighFallback_Event_Occurred_06b38288-ee5f-630c-153d-39c2e90ae55f)
AND
NOT DB_GlobalFlag((FLAG)LOW_FlorrickFight_Event_FlorrickFightStarted_dd53d2e3-09f8-edaf-162c-1ecd6a2f27d3)
THEN
PROC_ClearOriginMoment(LOW_FlorrickFightFallback_OM_Wyll_dfd8fab6-e0b2-bc4e-903b-f8f639b6244f);
PROC_LOW_FlorrickConfrontation_Cleanup(1);
NOT DB_CTY_ForrickConfrontationSetupDone(_Version);
DB_BUGFIX_Marker("GUS-305130");

//END_REGION

//REGION GUS-306097
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_GLO_BrainEscalation_WatchersBrainControlled(1)
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_GLO_BUGFIX_SetSteelwatcherGuardTag("CTY_Main_A");
DB_GLO_BUGFIX_SetSteelwatcherGuardTag("BGO_Main_A");

IF
DB_GLO_BrainEscalation_WatchersBrainControlled(1)
AND
DB_GLO_BUGFIX_SetSteelwatcherGuardTag(_Level)
THEN
NOT DB_GLO_BUGFIX_SetSteelwatcherGuardTag(_Level);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_GLO_BUGFIX_SetSteelwatcherGuardTag("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-306097");
NOT DB_GLO_BUGFIX_SetSteelwatcherGuardTag("CTY_Main_A");
PROC_GLO_BUGFIX_SetSteelwatcherGuardTag();

IF
DB_CurrentLevel("BGO_Main_A")
AND
DB_GLO_BUGFIX_SetSteelwatcherGuardTag("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-306097");
NOT DB_GLO_BUGFIX_SetSteelwatcherGuardTag("BGO_Main_A");
PROC_GLO_BUGFIX_SetSteelwatcherGuardTag();

PROC
PROC_GLO_BUGFIX_SetSteelwatcherGuardTag()
AND
DB_GLO_SteelWatchers(_SteelWatcher)
AND
HasActiveStatus(_SteelWatcher,"STEELWATCHER_GUARD_TAG",0)
THEN
ApplyStatus(_SteelWatcher,"STEELWATCHER_GUARD_TAG",-1.0);
//END_REGION

//REGION GUS-272113
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_FlagReactionAfterDialog((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1, (DIALOGRESOURCE)WYR_Posthouse_CrimeReaction_GalesTressym_467e36fe-9e91-67db-2a56-305018c641e4);
DB_FlagReactionAfterDialog((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1, (DIALOGRESOURCE)WYR_Posthouse_Tara_OM_Gale_AOM_COM_OOM_999ecebb-967d-172b-0411-3d455cdf27e6);
DB_FlagReactionAfterDialog((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1, (DIALOGRESOURCE)WYR_Posthouse_GalesTressym_6bbdb0cc-9a74-63c4-ec0b-21d26e65714e);
DB_BUGFIX_Marker("GUS-272113");
//END_REGION

//REGION GUS-305740
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_RelationshipDialog_Queue((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (FLAG)ORI_Shadowheart_State_FirstRomanceHappened_9d075859-2653-4026-85d0-2c3687259f0c, "CAMP", 1, -100)
THEN
DB_BUGFIX_Marker("GUS-305740");
PROC_CancelRelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, (FLAG)ORI_Shadowheart_State_FirstRomanceHappened_9d075859-2653-4026-85d0-2c3687259f0c);
//END_REGION GUS-305740

//REGION GUS-305214
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
QRY_GLO_Bugfix_GUS_305214_EncounteredGortash()
THEN
SetFlag(GLO_Gortash_State_Encountered_01d67e4c-32c6-4ea8-bf4d-a499467692f7);
DB_BUGFIX_Marker("GUS_305214");

QRY
QRY_GLO_Bugfix_GUS_305214_EncounteredGortash()
AND
DB_GlobalFlag(GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769)
THEN
DB_NOOP(1);

QRY
QRY_GLO_Bugfix_GUS_305214_EncounteredGortash()
AND
DB_GlobalFlag(GLO_Gortash_HasMet_74cffb8f-fc93-4c67-a12e-aa2cc8890291)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-305925
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_WYR_Gortash_WarnedImpostor_fdb6ca98-8bb0-4196-bf6d-945526e56114, (FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d);
PROC_GLO_Bugfix_305925_CheckDisableImpostorTopic();
DB_BUGFIX_Marker("GUS-305925");

PROC
PROC_GLO_Bugfix_305925_CheckDisableImpostorTopic()
AND
DB_TopicalGreeting_Current((FLAG)TG_WYR_Gortash_WarnedImpostor_fdb6ca98-8bb0-4196-bf6d-945526e56114)
AND
DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d)
THEN
PROC_TopicalGreeting_ClearOldTopic();
//END_REGION

//REGION GUS-305962

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_GlobalFlag((FLAG)WYR_RaphaelTango_Event_TeleportPartyOut_45e8b74d-184f-c3f4-ea72-c93319cf004f)
THEN
DB_BUGFIX_Marker("GUS-305962");
NOT DB_TopicalGreetingStartCondition_FlagSet((FLAG)TG_WYR_RaphaelTango_DealRefused_c6d00648-4122-45d3-8b24-9e696e91d3b6, (FLAG)WYR_RaphaelTango_Event_TeleportPartyOut_45e8b74d-184f-c3f4-ea72-c93319cf004f);

//END_REGION

//REGION GUS-304472

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_Destroyed(S_WYR_KillDirectorGortash_IllithidJar_5f01dce4-7d62-4914-bfb8-ec34f7d483bf)
THEN
DB_BUGFIX_Marker("GUS-304472");
DB_GLO_Bugfix_304472(1);

IF
DB_GLO_Bugfix_304472(1)
AND
DB_CurrentLevel(_Region)
AND
GetRegion(S_WYR_KillDirectorGortash_IllithidJar_5f01dce4-7d62-4914-bfb8-ec34f7d483bf, _Region)
THEN
NOT DB_GLO_Bugfix_304472(1);
PROC_GLO_Bugfix_304472();

PROC
PROC_GLO_Bugfix_304472()
AND
IsInInventory(S_WYR_KillDirectorGortash_IllithidJar_5f01dce4-7d62-4914-bfb8-ec34f7d483bf, 0)
AND
GetPosition(S_WYR_KillDirectorGortash_IllithidJar_5f01dce4-7d62-4914-bfb8-ec34f7d483bf, _X, _Y, _Z)
AND
CreateAt(UNI_TadpolePowerJar_1ec327be-3b7f-4502-9586-860e057e09ae, _X, _Y, _Z, 0, 0, "", _Jar)
THEN
RequestDelete((ITEM)S_WYR_KillDirectorGortash_IllithidJar_5f01dce4-7d62-4914-bfb8-ec34f7d483bf);

PROC
PROC_GLO_Bugfix_304472()
AND
IsInInventory(S_WYR_KillDirectorGortash_IllithidJar_5f01dce4-7d62-4914-bfb8-ec34f7d483bf, 1)
AND
GetDirectInventoryOwner(S_WYR_KillDirectorGortash_IllithidJar_5f01dce4-7d62-4914-bfb8-ec34f7d483bf, _Owner)
THEN
RequestDelete((ITEM)S_WYR_KillDirectorGortash_IllithidJar_5f01dce4-7d62-4914-bfb8-ec34f7d483bf);
TemplateAddTo(UNI_TadpolePowerJar_1ec327be-3b7f-4502-9586-860e057e09ae, _Owner, 1, 0);

//END_REGION

//REGION GUS-306579
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelUnreachable("SCL_Main_A") // SCL is no longer reachable.
AND
DB_SCL_Drider_EscortedPlayer(_) // this DB was NOT cleared and therefore Escorting is most likely still enabled on some characters.
AND
NOT DB_BUGFIX_Marker("GUS-306579")
THEN
DB_BUGFIX_Marker("GUS-306579");
PROC_SCL_Drider_RemovePlayersFromEscort();
//END_REGION

//REGION GUS-280526
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_ItemOwnerShipTriggers("BGO_Main_A", (TRIGGER)S_WYR_SharessCaress_Mamzell_OwnershipArea_d9525d53-06d7-49f1-8eeb-d085b338ba49, (CHARACTER)S_WYR_SharessCaress_Mamzell_fff7fecf-d6c0-478d-92fb-3aa854298cd2);
DB_BUGFIX_Marker("GUS-280526");
//END_REGION

//REGION GUS-308700

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalAccepted_904c45e0-bb06-40ed-b5d7-4f1c851b9d86)
THEN
CharacterDisableAllCrimes(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10);

//END_REGION

//REGION GUS-302788

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_BUGFIX_302788_DoFix(1);

IF
DB_BUGFIX_302788_DoFix(1)
AND
DB_CurrentLevel("BGO_Main_A")
THEN
SetGravity(CONS_FOOD_Vegetable_Carrot_A_006_719500b1-64fc-4f8c-8593-257245c128e8,GRAVITYTYPE.Disabled,NULL_00000000-0000-0000-0000-000000000000);
SetGravity(CONS_FOOD_Vegetable_Carrot_A_006_85f3c076-735d-4be0-a0b6-662a6d32d658,GRAVITYTYPE.Disabled,NULL_00000000-0000-0000-0000-000000000000);

IF
DB_BUGFIX_302788_DoFix(1)
AND
DB_CurrentLevel("BGO_Main_A")
AND
GetAnubisConfig(S_WYR_Circus_DressingRoomWorker_1985a13e-b870-4618-8c19-09f79667c598,"WYR_Circus_DressingRoomWorker")
THEN
NOT DB_BUGFIX_302788_DoFix(1);
DEV_EnableAnubis(S_WYR_Circus_DressingRoomWorker_1985a13e-b870-4618-8c19-09f79667c598,"WYR_Circus_DressingRoomWorker_2");

//END_REGION GUS-302788

//REGION GUS-306224
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_GortashInColony_80314a56-b334-48fe-9055-54bcd2efc5b6);
DB_BUGFIX_Marker("GUS-306224");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_AfterCeremony_a05a6945-21ad-400d-80bc-7b4934571c57)
AND
NOT DB_BUGFIX_Marker("GUS-306224")
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_GortashInColony_80314a56-b334-48fe-9055-54bcd2efc5b6);
DB_BUGFIX_Marker("GUS-306224");
//END_REGION GUS-306224

//REGION GUS-307262

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag((FLAG)WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "UND_MonkAmulet", "FoughtMadMonk", 0)
THEN
QuestUpdate((CHARACTER)_Player, "UND_MonkAmulet", "FoughtMadMonk");

//END_REGION GUS-307262

//REGION GUS-297507
//Cleans up players who have multiples of the boat world timelines playing at once in BGO/CTY. Code change prevents further duplicates form starting.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-305740");
DB_GLO_Bugfix_BoatWorldTimelineCleanup(1);
DB_GLO_Bugfix_BoatWorldTimelineCleanup(2);

IF
LevelGameplayStarted("CTY_Main_A", _)
AND
DB_GLO_Bugfix_BoatWorldTimelineCleanup(1)
THEN
PROC_GLO_Debug_WorldTimelineCleanUp(1);
NOT DB_GLO_Bugfix_BoatWorldTimelineCleanup(1);

IF
LevelGameplayStarted("BGO_Main_A", _)
AND
DB_GLO_Bugfix_BoatWorldTimelineCleanup(2)
THEN
PROC_GLO_Debug_WorldTimelineCleanUp(2);
NOT DB_GLO_Bugfix_BoatWorldTimelineCleanup(2);


PROC
PROC_GLO_Debug_WorldTimelineCleanUp(1)
AND
DB_DialogName(LOW_WRLD_ShippingLane_17be9a7b-6506-a693-1bad-42330ef3a171, _ID)
THEN
StopWorldTimeline(_ID);
PROC_GLO_Debug_WorldTimelineRestart((DIALOGRESOURCE)LOW_WRLD_ShippingLane_17be9a7b-6506-a693-1bad-42330ef3a171, "CTY_Main_A", TimelineSceneTrigger_LOW_WRLD_ShippingLane_a5baa5cf-db69-41bd-8269-3845e1bfe5f9);

PROC
PROC_GLO_Debug_WorldTimelineCleanUp(2)
AND
DB_DialogName(WRLD_GLO_BGO_Boats_c2669ffc-aa1c-7268-f8b0-d611103594ca, _ID)
THEN
StopWorldTimeline(_ID);
PROC_GLO_Debug_WorldTimelineRestart((DIALOGRESOURCE)WRLD_GLO_BGO_Boats_c2669ffc-aa1c-7268-f8b0-d611103594ca, "BGO_Main_A", TimelineSceneTrigger_GLO_BGO_Boats_b40c56ad-2c12-44f6-86fe-012e66200316);

PROC
PROC_GLO_Debug_WorldTimelineRestart((DIALOGRESOURCE)_Dialog, (STRING)_Level, (TRIGGER)_SceneTrigger)
AND
NOT DB_GLO_ActiveWorldTimelines(_Dialog, _Level, _)
AND
StartWorldTimeline(_Dialog, _SceneTrigger, _, _ID)
THEN
DB_GLO_ActiveWorldTimelines(_Dialog, _Level, _ID);

//END_REGION GUS-297507

//REGION GUS-275685/GUS-275679/GUS-275186/GUS-275411/GUS-275417/GUS-275690

//Minthara patching
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GLO_LevelTraveler((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Level, "GLO_DrowCommander_Act2")
THEN
NOT DB_GLO_LevelTraveler((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Level, "GLO_DrowCommander_Act2");
DB_GLO_LevelTraveler((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Level, "GLO_DrowCommander_Act2_2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
GetAnubisConfig(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GLO_DrowCommander_Act2")
THEN
DEV_EnableAnubis(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GLO_DrowCommander_Act2_2");



//Halsin patching
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_Main_A", "GLO_Halsin_Act2")
THEN
NOT DB_GLO_LevelTraveler((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_Main_A", "GLO_Halsin_Act2");
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_Main_A", "GLO_Halsin_Act2_2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "BGO_Main_A", "DefaultCharacter")
THEN
NOT DB_GLO_LevelTraveler((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "BGO_Main_A", "DefaultCharacter");
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "BGO_Main_A", "GLO_Halsin_Act3");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "CTY_Main_A", "DefaultCharacter")
THEN
NOT DB_GLO_LevelTraveler((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "CTY_Main_A", "DefaultCharacter");
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "CTY_Main_A", "GLO_Halsin_Act3");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
GetAnubisConfig(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,"DefaultCharacter")
THEN
PROC_SetAnubisConfig(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,"GLO_Halsin_Act3");



//Shadowheart patching
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GLO_LevelTraveler((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "CTY_Main_A", "DefaultCharacter")
THEN
NOT DB_GLO_LevelTraveler((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "CTY_Main_A", "DefaultCharacter");
DB_GLO_LevelTraveler((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "CTY_Main_A", "GLO_Shadowheart");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
GetAnubisConfig(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"DefaultCharacter")
THEN
DEV_EnableAnubis(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"GLO_Shadowheart");

//END_REGION GUS-275685/GUS-275679/GUS-275186/GUS-275411/GUS-275417/GUS-275690

//REGION GUS-275501/GUS-275489/GUS-275484

//Jaheira patching

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A", "GUS-275501");
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-275489");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-275501")
AND
DB_GLO_LevelTraveler((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,"SCL_Main_A","GLO_Jaheira_Act2")
THEN
NOT DB_GLO_LevelTraveler((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,"SCL_Main_A","GLO_Jaheira_Act2");
DB_GLO_LevelTraveler((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,"SCL_Main_A","GLO_Jaheira_Act2_2");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-275501")
AND
GetAnubisConfig((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "GLO_Jaheira_Act2")
THEN
DEV_EnableAnubis((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "GLO_Jaheira_Act2_2");
DB_BUGFIX_Marker("GUS-275501");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-275489")
AND
DB_GLO_LevelTraveler((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "CTY_Main_A", "GLO_Jaheira_Act3")
THEN
NOT DB_GLO_LevelTraveler((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "CTY_Main_A", "GLO_Jaheira_Act3");
DB_GLO_LevelTraveler((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "CTY_Main_A", "GLO_Jaheira_Act3_2");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-275489")
AND
GetAnubisConfig((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "GLO_Jaheira_Act3")
THEN
DEV_EnableAnubis((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "GLO_Jaheira_Act3_2");
DB_BUGFIX_Marker("GUS-275489");

//END_REGION

//REGION GUS-307309
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_ApplySavegamePatches_GUS_307309();
DB_BUGFIX_Marker("GUS-307309");

//-- Before loading IRN_Main_A - Ravengard will not be moved to the Iron Throne if he was already resurrected
PROC
PROC_ApplySavegamePatches_GUS_307309()
AND
NOT DB_LevelLoadedOnce("IRN_Main_A")
AND
NOT DB_LevelUnreachable("IRN_Main_A")
AND
DB_GlobalFlag((FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
THEN
ClearFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
PROC_SetOnStage(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);

//-- After loading IRN_Main_A but then having returned to CTY - Ravengard was already moved to IRN incorrectly, bringing him back to camp
PROC
PROC_ApplySavegamePatches_GUS_307309()
AND
DB_LevelLoadedOnce("IRN_Main_A")
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
NOT DB_LevelUnreachable("IRN_Main_A")
AND
DB_GlobalFlag((FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
THEN
PROC_ApplySavegamePatches_GUS_307309_RevertSetupCharacters();

//Revert Mizora setup
PROC
PROC_ApplySavegamePatches_GUS_307309_RevertSetupCharacters()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_MizoraEnemy_bfbf3d9c-2db7-443e-aceb-784bb45bc4ff)
THEN
ClearFlag((FLAG)IRN_IronThrone_State_MizoraEnemy_bfbf3d9c-2db7-443e-aceb-784bb45bc4ff);

PROC
PROC_ApplySavegamePatches_GUS_307309_RevertSetupCharacters()
AND
DB_IRN_MizoraKeepsRavengardAlive(1)
THEN
NOT DB_IRN_MizoraKeepsRavengardAlive(1);

PROC
PROC_ApplySavegamePatches_GUS_307309_RevertSetupCharacters()
THEN
ClearTag(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, (TAG)IGNORE_COMBAT_LATE_JOIN_PENALTY_6d60bed7-10cc-4b52-8fb7-baa75181cd49);
PROC_SetOnStage(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, 1);
TeleportTo(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, S_LOW_RavengardCampPos_GUS_307309_be3f0ec0-980b-44e8-ab54-e42460351615, "", 0, 0, 0, 1, 1);
DB_ApplySavegamePatches_GUS_307309_MizoraBuggedIRNState(1);

PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
DB_ApplySavegamePatches_GUS_307309_MizoraBuggedIRNState(1)
THEN
NOT DB_ApplySavegamePatches_GUS_307309_MizoraBuggedIRNState(1);
PROC_SetOnStage(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, 1);

//Revert Ravengard setup
PROC
PROC_ApplySavegamePatches_GUS_307309_RevertSetupCharacters()
THEN
ClearFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
NOT DB_DoNotFaceDialog(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (DIALOGRESOURCE)IRN_IronThrone_PAD_PlayersSeeRavengard_964b9c39-9ab3-8258-0fc3-dd3a33df3834);
RemoveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_PRISONER_RAVENGARD", NULL_00000000-0000-0000-0000-000000000000);
CharacterGiveEquipmentSet((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "EQP_GLO_Longsword_Shield_Plate_Ravengard");
NOT DB_IRN_PrisonerGroup(10, (CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
NOT DB_IRN_MapMarkers("IRN_HostageRavengard", (CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
DB_Dialogs(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (DIALOGRESOURCE)CAMP_Ravengard_c9e72a15-7691-102d-4f00-f20b7ab8ff95);
PROC_CAMP_Ravengard_RestoreRavengard();
//SetFaction((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (FACTION)ACT3_LOW_IronThrone_Ravengard_d884141d-e554-4ab8-a209-cad8c8fbdad7);
ClearTag(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (TAG)IGNORE_COMBAT_LATE_JOIN_PENALTY_6d60bed7-10cc-4b52-8fb7-baa75181cd49);
ClearTag(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (TAG)NO_LEVELTEMPLATE_TRANSFER_577229d7-a806-40c9-81fc-3e843d1955c0); //Temporary added since the submersible is a persistent template and causes issues when loading between IRN_Main_A and CTY_Main_A
PROC_SelfHealing_Enable((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
PROC_CharacterFullRestore((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
NOT DB_PreventPermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
RemoveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "LOW_IRONTHRONE_MIZORA_FIENDISHCHARM", NULL_00000000-0000-0000-0000-000000000000);
ClearTag(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (TAG)ACT3_LOW_IRONTHRONE_RAVENGARDTARGET_6953dce2-8f2f-4ff4-bb29-78cbb3dc5638);
PROC_SetOnStage(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
TeleportTo(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, S_LOW_RavengardCampPos_GUS_307309_be3f0ec0-980b-44e8-ab54-e42460351615, "", 0, 0, 0, 1, 1);

//Revert guards setup
PROC
PROC_ApplySavegamePatches_GUS_307309_RevertSetupCharacters()
AND
DB_IRN_IronThrone_Guards(_Guard)
THEN
SetForceUpdate(_Guard, 0);

//Revert prisoners setup
PROC
PROC_ApplySavegamePatches_GUS_307309_RevertSetupCharacters()
AND
DB_IRN_PrisonerGroup(_, _Prisoner)
THEN
SetForceUpdate(_Prisoner, 0);

PROC
PROC_ApplySavegamePatches_GUS_307309_RevertSetupCharacters()
AND
DB_IRN_DoorsLevers(_Door, _Lever)
THEN
SetForceUpdate(_Door, 0);
SetForceUpdate(_Lever, 0);

//-- After visiting the Iron Throne after turning back once - Ravengard will be teleproted to camp by the Camper system while the game still expects him to be in the Iron Throne, which causes a number of issues
//-- Teleporting him back to the Iron Throne if players ended up in this bugged state as it would be very difficult to clean up once they are there
PROC
PROC_ApplySavegamePatches_GUS_307309()
AND
DB_CurrentLevel("IRN_Main_A")
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_LeftWithoutEntering_9530d1e4-8740-423b-a989-d7912a5de9bc)
AND
QRY_State_IsBeforeState(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "CountdownFinished")
AND
DB_GlobalFlag((FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
THEN
TeleportTo(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, S_IRN_Ravengard_Pos_3d27f038-b773-4abd-bf3f-f569e0d93d28, "", 0, 0, 0, 0, 1);
PROC_SetOnStage(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);

//-- After returning from the Iron Throne where Ravengard was bugged - no need for patching, it should all work

//-- Iron Throne was blown up without visiting it while Ravengard was still there in his unintended bugged state
PROC
PROC_ApplySavegamePatches_GUS_307309()
AND
DB_GlobalFlag((FLAG)IRN_Ravengard_State_KilledOffscreenByMizoraBeforePactScene_f4a0eace-8c06-4d5e-a446-7b5e64d3b80f)
AND
DB_GlobalFlag((FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1)
AND
DB_PermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
NOT DB_PermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
Resurrect((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
PROC_SetOnStage(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
//END_REGION

//REGION GUS-304318
// Missing anubis configs
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
SetFlag(GLO_State_NoCower_8180293e-4d0d-4e9b-9dfc-b195d4c67ddb, S_WYR_MissingRedcaps_FlamingFist_62ac4bbf-bb18-48b7-b32f-ebc20e1aed04);
DB_BUGFIX_304318_DoFix(1);
DB_BUGFIX_304318_DoFix(2);

IF
DB_BUGFIX_304318_DoFix(1)
AND
DB_CurrentLevel("BGO_Main_A")
AND
NOT DB_PermaDefeatedOrOffstage(S_WYR_Circus_EntranceGuard_63ef213e-7a72-4126-9d5f-2f7d60ee9178)
THEN
NOT DB_BUGFIX_304318_DoFix(1);
DB_BUGFIX_Marker("GUS-304318-A");
PROC_SetAnubisConfig(S_WYR_Circus_EntranceGuard_63ef213e-7a72-4126-9d5f-2f7d60ee9178, "WYR_Circus_EntranceGuard");

IF
DB_BUGFIX_304318_DoFix(2)
AND
DB_CurrentLevel("BGO_Main_A")
AND
NOT DB_PermaDefeatedOrOffstage(S_WYR_Circus_GhoulSniffer_cda5ce1f-c0d1-4e15-b1c5-0d785fa935bf)
THEN
NOT DB_BUGFIX_304318_DoFix(2);
DB_BUGFIX_Marker("GUS-304318-B");
PROC_SetAnubisConfig(S_WYR_Circus_GhoulSniffer_cda5ce1f-c0d1-4e15-b1c5-0d785fa935bf, "WYR_Circus_GhoulSniffer");

// Bag of Molding visual update
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_OffStage(S_WYR_Circus_WheelPrize_BagOfMolding_4e08dac7-f6b4-42ac-b4b1-e217387892d2) // we dont need to patch if its offstage, because it will transform when picked up from the djinni
THEN
DB_BUGFIX_304318_DoFix(3);

IF
LevelGameplayStarted(_,_)
AND
DB_BUGFIX_304318_DoFix(3)
AND
Exists(S_WYR_Circus_WheelPrize_BagOfMolding_4e08dac7-f6b4-42ac-b4b1-e217387892d2, 1)
THEN
Transform(S_WYR_Circus_WheelPrize_BagOfMolding_4e08dac7-f6b4-42ac-b4b1-e217387892d2, UNI_WYR_Circus_BagOfMolding_Old_5c53c59a-37e7-4a9d-b157-1c84c71e3c0d, DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);
NOT DB_BUGFIX_304318_DoFix(3);
DB_BUGFIX_Marker("GUS-304318-C");

// Journal
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-304318-D");
NOT DB_QuestDef_State((FLAG)WYR_Circus_State_ClownPiecesHasHand_025d9d68-2786-9bb3-eeed-a89bf0f2ecc4, "WYR_Clown", "FoundHand");
NOT DB_QuestDef_State((FLAG)WYR_Circus_Knows_MerchantHasHand_ae4d6d60-9541-388b-7e32-4233567480f1, "WYR_Clown", "FoundHand");
DB_QuestDef_State((FLAG)WYR_Circus_Clown_Dead_Event_MentionedBodyparts_8875c65c-6bc5-710a-2662-80811effc00e, "WYR_Clown", "LearnedSplit_SwD");
DB_BUGFIX_304318_DoFix(4);

// rat message
IF
DB_CurrentLevel("BGO_Main_A")
AND
DB_BUGFIX_304318_DoFix(4)
AND
Exists(S_WYR_BuriedChest_01_e103309e-14c9-423b-9dd9-faa070bc2dd4, 1)
AND
IsDestroyed(S_WYR_BuriedChest_01_e103309e-14c9-423b-9dd9-faa070bc2dd4, 0)
THEN
ToInventory(S_WYR_Circus_DeadRat_46d134e1-6529-48ae-b199-25f8e7cac78e, S_WYR_BuriedChest_01_e103309e-14c9-423b-9dd9-faa070bc2dd4, 1, 0, 0);
ToInventory(S_WYR_Circus_RatNote_df0a0f97-5306-4cd2-a2f0-375eda71d27a, S_WYR_BuriedChest_01_e103309e-14c9-423b-9dd9-faa070bc2dd4);
DB_BookFlags((ITEM)S_WYR_Circus_RatNote_df0a0f97-5306-4cd2-a2f0-375eda71d27a, (FLAG)WYR_Circus_Merchant_Knows_RatNote_be3e481d-0710-095e-a60d-aad444bc8515);
NOT DB_BUGFIX_304318_DoFix(4);
DB_BUGFIX_Marker("GUS-304318-D");

IF
DB_CurrentLevel("BGO_Main_A")
AND
DB_BUGFIX_304318_DoFix(4)
AND
Exists(S_WYR_BuriedChest_01_e103309e-14c9-423b-9dd9-faa070bc2dd4, 0)
THEN
NOT DB_BUGFIX_304318_DoFix(4);

IF
DB_CurrentLevel("BGO_Main_A")
AND
DB_BUGFIX_304318_DoFix(4)
AND
IsDestroyed(S_WYR_BuriedChest_01_e103309e-14c9-423b-9dd9-faa070bc2dd4, 1)
THEN
NOT DB_BUGFIX_304318_DoFix(4);

// FoundHalf
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_Event_ClownPiecesOneLeft_b058bb0e-e7f1-0c0f-8e69-7c7ace5cad4d)
AND
QRY_WYR_Circus_ClownPieces_LeftFindLessThan(4)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "WYR_Clown", "FoundHalf", 0)
AND
GetFlag((FLAG)WYR_Circus_State_ClownPiecesHasAll_73f56db8-afa1-4b5f-a7a6-611afddcf435, _Player, 0)
THEN
QuestUpdate(_Player, "WYR_Clown", "FoundHalf");
DB_BUGFIX_Marker("GUS-304318-E");

// Statue
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_WYR_Circus_StatueSentToCamp(_)
THEN
ApplyStatus(S_WYR_Circus_StatueDummy_c2ef6bde-3dbe-4ff5-99ca-8120445a8309, "WYR_CIRCUS_STATUEVISAGE", -1.0);
DB_BUGFIX_Marker("GUS-304318-F");

// Tradable ring
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_BUGFIX_304318_DoFix(5);

IF
DB_CurrentLevel("BGO_Main_A")
AND
DB_BUGFIX_304318_DoFix(5)
AND
IsInInventoryOf(S_WYR_Circus_DjinniWheelRing_f5b64ba3-3ad2-461d-a4e6-993aed1a738d, S_WYR_Circus_FortuneWheelWorker_21aa8a76-40ac-4d3a-881f-d6871487df6f, 1)
THEN
SetIsTradable(S_WYR_Circus_DjinniWheelRing_f5b64ba3-3ad2-461d-a4e6-993aed1a738d, TRADABLETYPE.NonTradable);
DB_BUGFIX_Marker("GUS-304318-G");

IF
DB_CurrentLevel("BGO_Main_A")
AND
DB_BUGFIX_304318_DoFix(5)
THEN
NOT DB_BUGFIX_304318_DoFix(5);
//END_REGION GUS-304318

//REGION GUS-307567
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_GlobalFlag(WYR_Circus_State_AcquiredHand_90c6a782-e37d-4a9e-bd79-102636f749b2)
AND
QRY_ItemInTeamMagicPocketsOrCampChest(S_WYR_Circus_DribblesBodyPart_Hand_dedf021f-478c-4a06-9150-f442e1cd2ecd)
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_Circus_State_GotHandByStealHand_f6a0460e-881a-49c6-9107-2d39e9558ca4);
PROC_GlobalSetFlagAndCache((FLAG)WYR_Circus_State_AcquiredHand_90c6a782-e37d-4a9e-bd79-102636f749b2);
DB_BUGFIX_Marker("GUS-307567");
//END_REGION GUS-307567

//REGION GUS-307928
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","BGO_Main_A","GUS-307928");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A","GUS-307928")
THEN
TeleportTo(S_WYR_SharessCaress_MerchantPos_d2547b3d-9525-4b66-9404-7d984704f4ef, S_WYR_SharessCaress_MerchantPos_PatchedPos_31b79423-b6cc-4791-8e79-e20d74f0f2ea);

//END_REGION GUS-307928

//REGION GUS-308306
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
NOT DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)WYR_SharessCaress_BoastingCrooks_Rat_ba171f3b-5f7a-3bb1-e743-6bde055960df, 50, 2);
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)WYR_SharessCaress_BoastingCrooks_Rat_ba171f3b-5f7a-3bb1-e743-6bde055960df, 100, 2);
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)WYR_SharessCaress_BoastingCrooks_Threeway_968d248c-af8e-6546-80f4-ba8bd60eea4f, 100, 3, 2);
DB_BUGFIX_Marker("GUS-308306");
//END_REGION GUS-308306

//REGION GUS-300734
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_FlorrickEltanWyrm_49cdaaf3-805f-cba6-e0af-ec167bd803d7,_,_,_)
AND
DB_GlobalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_FlorrickEltanWyrm_49cdaaf3-805f-cba6-e0af-ec167bd803d7);
DB_BUGFIX_Marker("GUS-300734");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_TalkedAboutHeart_12fecc65-b6f4-4dc3-3832-2f81314fc22d,_,_,_)
AND
NOT QRY_BUGFIX_Wyll_InParty2_Event_TalkedAboutHeart_Validate()
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_TalkedAboutHeart_12fecc65-b6f4-4dc3-3832-2f81314fc22d);
DB_BUGFIX_Marker("GUS-300734");

QRY
QRY_BUGFIX_Wyll_InParty2_Event_TalkedAboutHeart_Validate()
AND
DB_GlobalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c)
AND
DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
AND
DB_GlobalFlag((FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381)
THEN
DB_NOOP(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_IPRD_Event_Finale_1569ec67-be68-4227-8ed4-d6c2f96ead52,_,_,_)
AND
NOT QRY_BUGFIX_Wyll_IPRD_Event_Finale_Validate()
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_IPRD_Event_Finale_1569ec67-be68-4227-8ed4-d6c2f96ead52);
DB_BUGFIX_Marker("GUS-300734");

QRY
QRY_BUGFIX_Wyll_IPRD_Event_Finale_Validate()
AND
DB_GlobalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c)
AND
DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
AND
DB_GlobalFlag((FLAG)LOW_FlorrickFight_Event_FlorrickFightStarted_dd53d2e3-09f8-edaf-162c-1ecd6a2f27d3)
THEN
DB_NOOP(1);

QRY
QRY_BUGFIX_Wyll_IPRD_Event_Finale_Validate()
AND
DB_GlobalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c)
AND
DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
AND
DB_GlobalFlag((FLAG)LOW_FlorrickFighFallback_Event_Occurred_06b38288-ee5f-630c-153d-39c2e90ae55f)
THEN
DB_NOOP(1);

//END_REGION GUS-300734

//REGION GUS-275172
// A new behavior was implemented for FFOfficeGuard_002 in BGO_Main_A,
// but if the level has already been loaded, the items won't be in the correct position, and teleporting them isn't an option, so we disable the new behavior.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
SetFlag((FLAG)WYR_WyrmRock_State_FFOfficeGuard_002_BlockBehavior_ecde4ddf-3873-4e41-b554-bfe44218865a);
//END_REGION GUS-275172

//REGION GUS-308000
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "BGO_Main_A", "GUS-308000");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-308000")
THEN
DB_AutoSaveTrigger((TRIGGER)S_WYR_RefugeeCamp_Autosave_29ffc8fb-70f5-4d27-8570-a019ca051445);
DB_AutoSaveTrigger((TRIGGER)S_WYR_GurCamp_Autosave_23197969-6522-4b47-a97d-e6f85af63cf6);
DB_AutoSaveTrigger((TRIGGER)S_WYR_Circus_Autosave_ccd4a0b9-6a13-4af9-80c0-f4e32e12730c);
DB_AutoSaveTrigger((TRIGGER)S_WYR_SmugglerTunnel_Autosave_d0a20c78-d103-4784-8ad3-0d9f76aa5f7c);
DB_AutoSaveTrigger((TRIGGER)S_WYR_RaphaelTango_RoomArea_f0e79982-9e74-4c85-9f7b-46012cc79f26);
//END_REGION GUS-308000

//REGION GUS-308507
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A") // have reached act 3.
AND
NOT DB_LevelUnreachable("CTY_Main_A") // haven't left act 3.
AND
DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d) // abduction had occurred
AND
NOT DB_GEN_OrinsAbduction_ChosenName("Yenna") // abduction was not on Yenna
AND
NOT DB_PermaDefeated(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f) // Yenna was not already killed somehow
AND
NOT DB_GlobalFlag(CAMP_Yenna_State_DismissYennaPermanently_28b1eb24-33c3-48e3-b347-fa454d737840) // she was not already dismissed permanently
AND
QRY_GLO_Bugfix_308507_WasInWorldAbduction() // was an In-World Abduction and not an In-Camp abduction
THEN
PROC_ORI_SetupCamp((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
DB_BUGFIX_Marker("GUS-308507");

QRY
QRY_GLO_Bugfix_308507_WasInWorldAbduction()
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_Slums_b63ceee7-ac3f-4d8e-a696-88a1996d5d69)
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_Elfsong_f815b894-0a28-40a9-aba7-b59418311eaa)
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_Farm_2a32cb87-e14b-49d3-ad6b-88016d8bc137)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-305038
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "BGO_Main_A", "GUS-305038");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-305038")
AND
DB_Defeated((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
NOT DB_OnlyOnce("WYR_KillDirectorGortash_RemoveRavengardFromAudienceHall") // hasn't been removed from the Audience Hall - defeated during the ceremony
AND
DB_DefeatedCauses((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _DefeatCause, _)
AND
NOT DB_GameOver_DefeatCausesNotGameOver(_DefeatCause)
THEN
PROC_ApplySavegamePatch_305038_KillRavengard();

// standard flow
PROC
PROC_ApplySavegamePatch_305038_KillRavengard()
AND
GetClosestAlivePlayer(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Player, _Dist)
AND
_Dist <= 30.0
THEN
TimerLaunch("WYR_KillDirectorGortash_RavengardDiesInFlames", 500);

// too far away - no VB
PROC
PROC_ApplySavegamePatch_305038_KillRavengard()
AND
GetClosestAlivePlayer(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Player, _Dist)
AND
_Dist > 30.0
THEN
SetFlag((FLAG)GLO_Ravengard_State_KilledByMizoraInWyrmsRock_3934a26b-64ff-4d1a-9ead-cb7040c195f6);
SetFlag((FLAG)WYR_Ravengard_State_KilledBeforeIRN_bb43c67a-cc36-4498-9e76-1faaf010cc2a);
PROC_GlobalSetFlagAndCache((FLAG)WYR_KillDirectorGortash_State_RavengardKilledDuringCeremony_40b81270-9d42-4e46-bd96-6295c8b2b7e2);
Die(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, DEATHTYPE.Incinerate, S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, 1, 0, 1.0);
//END_REGION

//REGION GUS-308857
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "BGO_Main_A", "GUS-308857");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-308857")
AND
IsLocked(CONT_GEN_Chest_Common_B_001_d02ca12b-9fee-43e4-968c-bbfc86ebbeb4, 1)
THEN
Unlock(CONT_GEN_Chest_Common_B_001_d02ca12b-9fee-43e4-968c-bbfc86ebbeb4);
Lock(CONT_GEN_Chest_Common_B_001_d02ca12b-9fee-43e4-968c-bbfc86ebbeb4, "WYR_WyrmRock_SerrikChest");
//END_REGION GUS-308857

//REGION GUS-306369-2
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("CTY_Main_A") // have reached Lowercity
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575) // Orin was defeated already.
THEN
PROC_GLO_Bugfix_306369_2_TryRemoveDeadAbductee();

PROC
PROC_GLO_Bugfix_306369_2_TryRemoveDeadAbductee()
AND
DB_GEN_OrinsAbduction_ChosenChar(_AbducteeChar) // abductee's character
AND
_AbducteeChar != S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f // make sure its not Yenna
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9) // wasn't already killed in dialog with Orin
AND
DB_PermaDefeated(_AbducteeChar) // character was actually killed during the temple fight.
AND
DB_PartOfTheTeam(_AbducteeChar) // and also re-registered as a companion despite being perma-defeated.
AND
QRY_GLO_Bugfix_306369_2_IsInCampOrInventory(_AbducteeChar)
THEN
DB_BUGFIX_Marker("GUS-306369-2");
UnregisterAsCompanion(_AbducteeChar);
NOT DB_PartOfTheTeam(_AbducteeChar);
PROC_SetOnStage(_AbducteeChar, 0);

QRY
QRY_GLO_Bugfix_306369_2_IsInCampOrInventory((GUIDSTRING)_AbducteeChar)
AND
IsInInventory(_AbducteeChar, 1) // is in someone's inventory
THEN
DB_NOOP(1);

QRY
QRY_GLO_Bugfix_306369_2_IsInCampOrInventory((GUIDSTRING)_AbducteeChar)
AND
DB_InCamp((CHARACTER)_AbducteeChar) // was accidentally added back into camp
AND
IsOnStage(_AbducteeChar, 1)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-308832
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A") // have reached Act 3
THEN
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper01_003_15d7b11b-5c66-4644-a597-e92541ff1e9e, "LOW_Gazette_Issue76");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper01_002_be10333e-eb11-43eb-b345-b17e2bc8dcd6, "LOW_Gazette_Issue76");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper01_001_e0feac7a-b77d-4478-a1be-853fc3850332, "LOW_Gazette_Issue76");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper01_000_0ac7c402-26db-47dc-9b19-ae2a7442682d, "LOW_Gazette_Issue76");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper02_000_ab4db5ee-8245-4fe8-81bf-7468f4419aed, "LOW_Gazette_Issue79");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper02_002_3f9e4f15-4efc-49bb-b631-87306e5e832a, "LOW_Gazette_Issue79");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper02_003_d68e12ca-4d33-47ef-9c58-8114a5578db5, "LOW_Gazette_Issue79");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper02_001_cbabd06b-a5aa-47b7-9b42-0fa17cf8b81d, "LOW_Gazette_Issue79");
DB_SavePatch308832_Data(S_WYR_OpenHand_DailyPaper_000_a625aab7-2d7e-4509-b0bc-85b412ba3cab, "LOW_Gazette_Issue80");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper03_003_d225d699-69a3-45d0-a5ba-3493b1d06929, "LOW_Gazette_Issue81");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper03_000_db72bc60-fbd3-4192-a666-e540bcd74897, "LOW_Gazette_Issue81");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper03_002_5e44d0ae-83bc-41e8-9800-a06d6ba76c8f, "LOW_Gazette_Issue81");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper03_001_e396592a-d8af-4a02-9e68-8d14dc649158, "LOW_Gazette_Issue81");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper04_001_2439575e-3ba7-4d3d-822a-8ac5e917579d, "LOW_Gazette_Issue82");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper04_002_ed1fed6d-b0f8-4c59-8feb-df5e719ee27d, "LOW_Gazette_Issue82");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper04_003_e17d9f97-c73d-4729-805e-ead481ea2049, "LOW_Gazette_Issue82");
DB_SavePatch308832_Data(Book_LOW_Gazette_OldPaper04_000_41d4264d-2d4c-40f1-b09b-79757b8baa7d, "LOW_Gazette_Issue82");
DB_SavePatch308832_Data(Book_WYR_Gazette_OldPaper03_e885eaee-24af-4df2-ba5c-3516a1c20621, "LOW_Gazette_Issue83");
DB_SavePatch308832_Data(Book_WYR_Gazette_OldPaper01_55356347-2f40-47e9-afdb-13f463123264, "LOW_Gazette_Issue83");
DB_BUGFIX_Marker("GUS-308832");

IF
DB_SavePatch308832_Data(_Paper, _Issue)
AND
NOT DB_Act3_GLO_Gazette_OwnedPapers(_Paper, _)
THEN
DB_Act3_GLO_Gazette_OwnedPapers(_Paper, _Issue);
NOT DB_SavePatch308832_Data(_Paper, _Issue);

IF
DB_SavePatch308832_Data(_Paper, _Issue)
AND
DB_Act3_GLO_Gazette_OwnedPapers(_Paper, _)
THEN
NOT DB_SavePatch308832_Data(_Paper, _Issue);

//END_REGION GUS-308832

//REGION GUS-306723
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "BGO_Main_A", "GUS-306723");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-306723")
THEN
TeleportToPosition(S_WYR_Jungle_SUB_8bb03671-b130-4b2f-877b-bc7eb8cc4d49, -1549.0, 12.0, -1483.0);
//END_REGION GUS-306723

//REGION GUS-310041

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_Achievements_BG3_Quest37_TrapStatuses("WYR_GORTASH_GRENADE_DETONATE")
THEN
DB_Achievements_BG3_Quest37_TrapStatuses("WYR_GORTASH_GRENADE_DETONATE");
DB_BUGFIX_Marker("GUS-310041");

//END_REGION GUS-310041

//REGION GUS-307826
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "BGO_Main_A", "GUS-307826");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-307826")
AND
DB_WYR_RefugeeCamp_TieflingRefugee_DeathFlag(_Refugee, _Flag)
AND
DB_PermaDefeated(_Refugee)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-307826")
AND
DB_WYR_RefugeeCamp_TieflingRefugee_DeathFlag(_Refugee, _Flag)
AND
NOT DB_WYR_RefugeeCamp_TieflingRefugees_Placed(_Refugee,_,_)
THEN
PROC_GlobalSetFlagAndCache(_Flag);
//END_REGION GUS-307826

//REGION GUS-307259
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_GlobalFlag((FLAG)WYR_RaphaelTango_State_DiscussedDeal_9896c94b-431e-4b0e-90ce-80293ffb1198)
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_SharessCaress_Knows_RaphaelInSharess_63e92afc-0fad-0d53-fa28-b995cadf9d68);
DB_BUGFIX_Marker("GUS-307259");
//END_REGION GUS-307259

//REGION GUS-301029
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
THEN
PROC_ApplySavegamePatches_GUS_301029();
DB_BUGFIX_Marker("GUS-301029");

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_PermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
PROC_GlobalSetFlagAndCache((FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_Defeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
SetFlag((FLAG)WYR_Ravengard_State_KilledBeforeIRN_bb43c67a-cc36-4498-9e76-1faaf010cc2a);

PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_PermaDefeatedFlag(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
DB_GlobalFlagReactionAfterDialog((FLAG)CAMP_Mizora_State_ResurrectedRavengardAfterIRNDestruction_64816ccb-c284-4f53-b730-565997635054, CAMP_Mizora_TalkToResurrectRavengard_a3881b60-bec8-0f55-99fe-7b22f6e93592);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381,(FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac,(FLAG)WYR_Ravengard_State_KilledBeforeIRN_bb43c67a-cc36-4498-9e76-1faaf010cc2a);
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381,(FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac,(FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_GlobalFlag((FLAG)IRN_Ravengard_State_KilledOffscreenByMizoraBeforePactScene_f4a0eace-8c06-4d5e-a446-7b5e64d3b80f)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
THEN
ClearFlag((FLAG)IRN_Ravengard_State_KilledOffscreenByMizoraBeforePactScene_f4a0eace-8c06-4d5e-a446-7b5e64d3b80f); //Flag should only be set if Ravengard is killed offscreen by Mizora, poor naming

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
THEN
SetFlag((FLAG)CAMP_Mizora_State_WantsToResurrectRavengardAfterIRNDestruction_ac394670-1bb9-4e9e-92dc-8fa9382d4a64);

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
THEN
DB_PreventPermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
AND
DB_Defeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
NOT DB_PermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03); //Depending on circumstances it can be set or not, when it shouldn't ever be set. Clearing regardless
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6, (FLAG)Wyll_InParty2_Event_ReactedRavengardDeath_374e2383-f0e9-4353-3e35-9dd10c03eb9a);
//ToDo: Clear incorrect completing Journal Update for the Duke being perma defeated once we have the tech for it

PROC
PROC_ApplySavegamePatches_GUS_301029()
THEN
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61,"PLA_GrandDukeRescue","Dead",0,(FLAG)GLO_Origin_PartOfTheTeam_Wyll_24e24ca7-3446-440b-b645-19404845e108);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61,"PLA_GrandDukeRescue","Dead",1,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e,"PLA_GrandDukeRescue","Dead",0,(FLAG)GLO_Origin_PartOfTheTeam_Wyll_24e24ca7-3446-440b-b645-19404845e108);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e,"PLA_GrandDukeRescue","Dead",0,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e,"PLA_GrandDukeRescue","Dead",1,(FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61,"ORI_Avatar_Wyll","DiedIRN",1,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e,"ORI_Avatar_Wyll","DiedIRN",0,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e,"ORI_Avatar_Wyll","DiedIRN",1,(FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61,"ORI_COM_Wyll","DiedIRN",1,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e,"ORI_COM_Wyll","DiedIRN",0,(FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e,"ORI_COM_Wyll","DiedIRN",1,(FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6,"PLA_GrandDukeRescue","BrokenDead",1,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6,"PLA_GrandDukeRescue","BrokenAbandoned");
NOT DB_QuestDef_ChainedState("PLA_GrandDukeRescue","BrokenDead","ORI_COM_Wyll","BrokenDied");
DB_QuestDef_ChainedState("PLA_GrandDukeRescue","BrokenAbandoned","ORI_COM_Wyll","BrokenAbandoned");
NOT DB_QuestDef_ChainedState("PLA_GrandDukeRescue","BrokenDead","ORI_Avatar_Wyll","BrokenDied");
DB_QuestDef_ChainedState("PLA_GrandDukeRescue","BrokenAbandoned","ORI_Avatar_Wyll","BrokenAbandoned");
DB_QuestDef_State((FLAG)GLO_Ravengard_State_SeenDeadRavengardDuringIRN_43cea123-9650-46f3-99d4-64c6d284ef1f,"PLA_GrandDukeRescue","FoundDeadInIRN");
DB_QuestDef_ChainedState("PLA_GrandDukeRescue","FoundDeadInIRN","ORI_COM_Wyll","FoundDeadInIRN");
DB_QuestDef_ChainedState("PLA_GrandDukeRescue","FoundDeadInIRN","ORI_Avatar_Wyll","FoundDeadInIRN");
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Ravengard_Knows_KilledDuringIRNDestruction_479fc5e6-daa9-4e82-b1c4-3dd282e130de,"PLA_GrandDukeRescue","LearnedRavengardDiedInIRNDestruction", 0, (FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);
DB_QuestDef_ChainedState("PLA_GrandDukeRescue","LearnedRavengardDiedInIRNDestruction","ORI_COM_Wyll","LearnedRavengardDiedInIRNDestruction");
DB_QuestDef_ChainedState("PLA_GrandDukeRescue","LearnedRavengardDiedInIRNDestruction","ORI_Avatar_Wyll","LearnedRavengardDiedInIRNDestruction");
DB_QuestDef_ChainedState("PLA_GrandDukeRescue","LeftWithoutSeeingDeadRavengard","ORI_COM_Wyll","LeftWithoutSeeingDeadRavengard");
DB_QuestDef_ChainedState("PLA_GrandDukeRescue","LeftWithoutSeeingDeadRavengard","ORI_Avatar_Wyll","LeftWithoutSeeingDeadRavengard");

//Been to Iron Throne before pact scene while he was killed by Mizora but never saw him - trigger journal update, unless the pact scene has already happened
PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
DB_GlobalFlag((FLAG)IRN_Ravengard_State_KilledOffscreenByMizoraBeforePactScene_f4a0eace-8c06-4d5e-a446-7b5e64d3b80f)
AND
NOT DB_GlobalFlag((FLAG)GLO_Ravengard_State_SeenDeadRavengardDuringIRN_43cea123-9650-46f3-99d4-64c6d284ef1f)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player,"PLA_GrandDukeRescue","LeftWithoutSeeingDeadRavengard");

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
THEN
SetFlag((FLAG)IRN_Ravengard_State_KilledOffscreenByIRNDestructionBeforeVisiting_c8ac38de-2fe6-4fee-a3d1-a63a8ad6ce79);

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_State_Current(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "CountdownOngoing")
AND
NOT DB_IRN_MizoraKeepsRavengardAlive(1)
AND
DB_Defeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
DB_Players(_Player)
AND
DB_Sees(_Player,S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
NOT DB_GlobalFlag(GLO_Ravengard_State_SeenDeadRavengardDuringIRN_43cea123-9650-46f3-99d4-64c6d284ef1f)
THEN
PROC_GlobalSetFlagAndCache((FLAG)GLO_Ravengard_State_SeenDeadRavengardDuringIRN_43cea123-9650-46f3-99d4-64c6d284ef1f);
QuestUpdate((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "PLA_GrandDukeRescue","FoundDeadInIRN");

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_IRN_PrisonerGroup(_, _Prisoner)
AND
DB_Defeated(_Prisoner)
AND
GetFlag(IRN_IronThrone_State_IndividualPrisonerFree_4c120f58-ad6c-438a-b35b-1bb3d4ed5e87, _Prisoner, 1)
AND
GetFlag(IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, _Prisoner, 0)
THEN
ClearFlag(IRN_IronThrone_State_IndividualPrisonerFree_4c120f58-ad6c-438a-b35b-1bb3d4ed5e87, _Prisoner);

PROC
PROC_ApplySavegamePatches_GUS_301029()
AND
DB_GlobalFlag((FLAG)IRN_Ravengard_State_KilledOffscreenByMizoraBeforePactScene_f4a0eace-8c06-4d5e-a446-7b5e64d3b80f)
AND
DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
THEN
ClearTag(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (TAG)ACT3_LOW_IRONTHRONE_RAVENGARDTARGET_6953dce2-8f2f-4ff4-bb29-78cbb3dc5638);
SetCanJoinCombat(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
RemoveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_PRISONER_RAVENGARD", NULL_00000000-0000-0000-0000-000000000000);
PROC_CAMP_Ravengard_RestoreEquipmentAfterIRN();
//END_REGION

//REGION GUS-291973
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A") // have reached Act 3
AND
NOT DB_LevelUnreachable("CTY_Main_A") // haven't left act 3.
THEN
DB_BUGFIX_Marker("GUS-291973");
PROC_GLO_Bugfix_291973_Orin_UpdateDifficultyStat();

PROC
PROC_GLO_Bugfix_291973_Orin_UpdateDifficultyStat()
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2) // Orin isn't in the temple yet.
AND
HasActiveStatus(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,"LEGENDARY_RESISTANCE_CROWD_CONTROL", 1) // but was already given the Hard difficulty stat
THEN
RemoveStatus(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,"LEGENDARY_RESISTANCE_CROWD_CONTROL", S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//END_REGION
//REGION GUS-309850
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "BGO_Main_A", "GUS-309850");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-309850")
THEN
NOT DB_FlagReactionAfterDialog((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1, (DIALOGRESOURCE)WYR_Posthouse_CrimeReaction_GalesTressym_467e36fe-9e91-67db-2a56-305018c641e4);
NOT DB_FlagReactionAfterDialog((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1, (DIALOGRESOURCE)WYR_Posthouse_Tara_OM_Gale_AOM_COM_OOM_999ecebb-967d-172b-0411-3d455cdf27e6);
NOT DB_FlagReactionAfterDialog((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1, (DIALOGRESOURCE)WYR_Posthouse_GalesTressym_6bbdb0cc-9a74-63c4-ec0b-21d26e65714e);
DB_GlobalFlagReactionAfterDialog((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1, (DIALOGRESOURCE)WYR_Posthouse_CrimeReaction_GalesTressym_467e36fe-9e91-67db-2a56-305018c641e4);
DB_GlobalFlagReactionAfterDialog((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1, (DIALOGRESOURCE)WYR_Posthouse_Tara_OM_Gale_AOM_COM_OOM_999ecebb-967d-172b-0411-3d455cdf27e6);
DB_GlobalFlagReactionAfterDialog((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1, (DIALOGRESOURCE)WYR_Posthouse_GalesTressym_6bbdb0cc-9a74-63c4-ec0b-21d26e65714e);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-309850")
AND
DB_GlobalFlag((FLAG)WYR_Posthouse_Event_TressymFliesAway_ceb74fcd-4eea-645b-79a4-6c31cde125e1)
AND
NOT DB_OnlyOnce("GEN_TressymTrade_TressymLeavesForLOW")
THEN
PROC_SetOnStage(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
//END_REGION GUS-309850

//REGION GUS-256958
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "BGO_Main_A", "GUS-256958");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-256958")
THEN
SetFaction(S_WYR_SharessCaress_FlamingFist_01_350212e9-a8d6-43aa-8595-61e0d69b46f1, (FACTION)ACT3_WYR_SharessCaress_FlamingFists_df86c6b4-fc04-4866-8348-71810cb4b01d);
SetFaction(S_WYR_SharessCaress_Nymph_01_662b787e-d5f1-4bd2-b398-36961bda0ab4, (FACTION)ACT3_WYR_SharessCaress_d297b028-75a3-4a37-bb7b-f8c837d60ad8);
SetFaction(S_WYR_SharessCaress_Dancer_01_1dd894e0-73fb-4a5f-a698-939df72a4c09, (FACTION)ACT3_WYR_SharessCaress_d297b028-75a3-4a37-bb7b-f8c837d60ad8);
SetFaction(S_WYR_SharessCaress_Musician_01_b5e63e7f-30c4-4d62-9eca-7c12d7baf69d, (FACTION)ACT3_WYR_SharessCaress_d297b028-75a3-4a37-bb7b-f8c837d60ad8);
SetFaction(WYR_SharessCaress_Chef_3c2a809f-1ce8-6614-8fe5-67f4fee7eeb7, (FACTION)ACT3_WYR_SharessCaress_d297b028-75a3-4a37-bb7b-f8c837d60ad8);
//END_REGION GUS-256958

//REGION GUS-310354
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "BGO_Main_A", "GUS-310354");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310354")
AND
NOT DB_Defeated(S_WYR_RefugeeCamp_HobgoblinOutcast_b75bfef3-187e-495a-b0d4-4903d18e21d2)
AND
IsReposedOnEntity(S_WYR_RefugeeCamp_HobgoblinOutcast_b75bfef3-187e-495a-b0d4-4903d18e21d2, S_WYR_RefugeeCamp_Bedroll_Open_C_008_ebc5fe5c-ad04-4904-84dd-de69ceeccc28, 1)
AND
HasActiveStatus(S_WYR_RefugeeCamp_HobgoblinOutcast_b75bfef3-187e-495a-b0d4-4903d18e21d2, "SLEEPING", 0)
THEN
ApplyStatus(S_WYR_RefugeeCamp_HobgoblinOutcast_b75bfef3-187e-495a-b0d4-4903d18e21d2, "SLEEPING", -1.0, 1);
//END_REGION GUS-310354

//REGION GUS-31035
PROC
PROC_ApplySavegamePatches()
AND
DB_WYR_KillDirectorGortash_PatriarsKilled(1)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "BGO_Main_A", "GUS-310351");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310351")
THEN
PROC_WYR_KillDirectorGortash_KillPatriars();
//END_REGION

//REGION GUS-310212

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
AND
HasAppliedStatusWithGroup(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SG_Incapacitated", 1)
THEN
ApplyStatus(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "LOW_RAPHAEL_WILLPOWER", 1.0); //This will make Raphael lose any Incapacitated statuses
DB_BUGFIX_Marker("GUS-310212-1");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
AND
NOT DB_PermaDefeated(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8)
THEN
DB_BUGFIX_Marker("GUS-310212-2");
PROC_LOW_HouseOfHope_GUS310212_DecideRaphaelsFate();

PROC
PROC_LOW_HouseOfHope_GUS310212_DecideRaphaelsFate()
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c)
AND
NOT QRY_TriggerEvents_AnyPlayerInTriggerSet("LOW_HouseOfHope")
THEN
Die(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,DEATHTYPE.DoT,0);
DB_LOW_HouseOfHope_GUS310212_RaphaelIsDead(1);

PROC
PROC_LOW_HouseOfHope_GUS310212_DecideRaphaelsFate()
AND
NOT DB_LOW_HouseOfHope_GUS310212_RaphaelIsDead(1)
AND
DB_State_Current(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", _CurrentState)
THEN
PROC_State_Changed(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor",_CurrentState,"GLO_Monitor_HouseOfHope");
ClearFlag((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75);

IF
DB_LOW_HouseOfHope_GUS310212_RaphaelIsDead(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_HouseOfHope_RaphaelArrived();

IF
DB_LOW_HouseOfHope_GUS310212_RaphaelIsDead(1)
AND
DB_LOW_HouseOfHope_HopeRescuer(_Rescuer)
THEN
RemovePartyFollower((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, _Rescuer);
NOT DB_LOW_HouseOfHope_HopeRescuer(_Rescuer);

IF
DB_LOW_HouseOfHope_GUS310212_RaphaelIsDead(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
IsPartyFollower((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 1)
THEN
TeleportTo((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, S_LOW_HouseOfHope_FeastHallWander01_f618ff1c-7468-4c63-a42e-e8a24cea206f,"",0);

IF
DB_LOW_HouseOfHope_GUS310212_RaphaelIsDead(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_GLO_DefeatCounter(_RaphaelEnemy, "LOW_HouseOfHope_RaphaelCombat")
AND
NOT DB_PermaDefeated(_RaphaelEnemy)
THEN
Die(_RaphaelEnemy,DEATHTYPE.DoT,0);

IF
DB_LOW_HouseOfHope_GUS310212_RaphaelIsDead(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_HouseOfHope_GUS310212_RaphaelIsDead(1);

//END_REGION

//REGION GUS-310045
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_GLO_CompoundFlag(WYR_Ironhand_BombDestroyed_8ed705b5-6f86-4cff-8c14-cc1c7b87ad9c, (FLAG)LOW_SteelWatchFoundry_State_WastedRunePowderBomb_4cbe2c62-5a28-431d-8f09-43f4c0e92ab6);
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_SteelWatchFoundry_State_WastedRunePowderBomb_4cbe2c62-5a28-431d-8f09-43f4c0e92ab6, "Act3_Sage_WulbrenRunepowderBombUsed");
DB_BUGFIX_Marker("GUS-310045");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(WYR_Ironhand_BombDestroyed_8ed705b5-6f86-4cff-8c14-cc1c7b87ad9c)
THEN
SetFlag((FLAG)LOW_SteelWatchFoundry_State_WastedRunePowderBomb_4cbe2c62-5a28-431d-8f09-43f4c0e92ab6);
//END_REGION GUS-310045

//REGION GUS-309687
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-309687");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-309687")
THEN
TeleportTo((GUIDSTRING)TeleportTrigger_SkeletonOutdoors_9e9d3f3d-7d16-4a30-b33d-356c10f0c81d, S_WYR_WyrmsRockPrison_TeleportTriggerPatchHelper_1d39b285-17c7-42dc-97ab-70365fc9f656, "", 0, 0, 0, 0, 0);
//END_REGION

//REGION GUS-298095
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-298095");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-298095")
THEN
NOT DB_QuestDef_State_ConditionalFlag((FLAG)WYR_OpenHand_State_YannisAskedToInvestigate_394409f9-a450-4f9e-b396-7e861da8287f, "WYR_OpenHandMurder", "YannisStartPoint", 0, WYR_OpenHand_Knows_Murder_69cba284-da0f-47cd-800d-d9939d0a4c98);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)WYR_OpenHand_State_YannisAskedToInvestigate_394409f9-a450-4f9e-b396-7e861da8287f, "WYR_OpenHandMurder", "TalkYannisNotStart", 1, WYR_OpenHand_Knows_Murder_69cba284-da0f-47cd-800d-d9939d0a4c98);
NOT DB_QuestDef_State((FLAG)WYR_OpenHand_State_GoToFlophouse_8a7a226b-7fad-d253-e2c9-ed21890dbe02, "WYR_OpenHandMurder", "FollowTheKeyBecauseDoppelganger");
//END_REGION GUS-298095

//REGION GUS-310316

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-310316");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc, "Act3_Noble_EndgameDealAccepted");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
DB_Players(_Player)
AND
NOT DB_GLO_Backgrounds_Blocked("Act3_Noble_EndgameDealAccepted")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Noble_EndgameDealAccepted");


//END_REGION

//REGION GUS-300734
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_RavengardWyrm_9c7bcda3-56f2-c1f8-13fb-cecd5f4c88fd,_,_,_)
AND
DB_GlobalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_RavengardWyrm_9c7bcda3-56f2-c1f8-13fb-cecd5f4c88fd);
DB_BUGFIX_Marker("GUS-300734");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_RavengardWyrm_9c7bcda3-56f2-c1f8-13fb-cecd5f4c88fd,_,_,_)
AND
DB_GlobalFlag((FLAG)WYR_Wyrmway_State_EntryOpened_d8cad828-82f3-4a9b-ad0d-6f1637792d4e)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_RavengardWyrm_9c7bcda3-56f2-c1f8-13fb-cecd5f4c88fd);
DB_BUGFIX_Marker("GUS-300734");

//END_REGION

//REGION GUS-310750
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_Dialogs((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (DIALOGRESOURCE)Minthara_InParty_13d72d55-0d47-c280-9e9c-da076d8876d8)
AND
QRY_GetHasDialogAny((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_QRYRTN_GetHasDialogAny(0)
THEN
SetHasDialog(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1);
//END_REGION

//REGION GUS-292030
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-292030");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-292030")
THEN
DB_GLO_Cinematic_PositionedDialog((DIALOGRESOURCE)WYR_WyrmRockPrison_Florrick_40d9f384-7637-91b7-01aa-556a76ac20e1, "WYR_Florrick");
DB_GLO_Cinematic_PositionFlags("WYR_Florrick", (TRIGGER)S_WYR_WyrmRockPrison_FlorricksCell_ForCinematic_d0b91948-fa3d-4398-bbaa-e499de7913c4, (FLAG)WYR_WyrmRockPrison_Florrick_State_PlayerInsideCell_733d505e-d277-436d-b668-e62be6bb91bf);
//END_REGION

//REGION GUS-310870
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-310870");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310870")
AND
DB_GlobalFlag(WYR_Circus_State_Gone_151fd307-4cb8-44ba-8998-40e1d748b707)
AND
SysIsCompleted("Act3_WYR_Circus")
AND
DB_WYR_Circus_Workers(_NPC)
AND
NOT DB_PermaDefeatedOrOffstage(_NPC)
AND
QRY_OnlyOnce("Patch_GUS-310870_OnlyOnce")
THEN
SysActivateGoal("Act3_WYR_Circus");
PROC_WYR_Circus_MakeCircusDisappear();

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310870")
AND
NOT DB_GlobalFlag(WYR_Circus_State_Gone_151fd307-4cb8-44ba-8998-40e1d748b707)
AND
DB_GlobalFlag((FLAG)WYR_Circus_Clown_State_Hostile_59c1f674-0985-4d4d-9679-b8a1e4982f45)
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_State_PostCombat_ee4b2f6e-9d52-4bc5-bde6-bc0e1c015de4)
AND
NOT DB_GlobalFlag(WYR_Circus_State_AboutToLeave_39876ea2-3a3a-441d-96be-f907b6226239)
AND
NOT DB_PermaDefeatedOrOffstage(S_WYR_Circus_Ringmaster_c95af77b-6fc3-4c73-ac7c-087124f4b1e4)
THEN
PROC_WYR_Circus_LeftCombat_CircusWon();
//END_REGION GUS-310870

//REGION GUS-310950
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-310950");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310950")
AND
DB_GlobalFlag(WYR_Rivington_Knows_PileOfCorpses_54a5526f-9129-44ec-8a6f-7117e037a545)
AND
SysIsCompleted("Act3_WYR_BattlefieldBlock")
THEN
UnloadLevelTemplate(LT_PLT_BGO_Battlefield_A_000_ba443dcd-a60a-4778-a667-713eff097d83);
//END_REGION GUS-310950

//REGION GUS-310433
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-310433");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310433")
THEN
DB_RegionPrison("BGO_Main_A_WyrmRock_Fortress", (TRIGGER)S_WYR_WyrmRockPrison_PlayerCell_6792230e-f319-4870-8778-5f7bfae74489, S_WYR_WyrmRockPrison_PlayerCell_6792230e-f319-4870-8778-5f7bfae74489);
DB_CRIME_Guards_RegionInfo("BGO_Main_A_WyrmRock", "WYR_WyrmsRock_FlamingFist", (FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_CRIME_Guards_RegionSpawnPool("BGO_Main_A_WyrmRock", "WYR_WyrmsRock_FlamingFist", S_WYR_WyrmRockPrison_PlayerCell_6792230e-f319-4870-8778-5f7bfae74489, (ITEM)S_WYR_WyrmRockPrison_EvidenceChest_5d640504-3872-4404-8410-34f84fe45a6e, 20, 0);
TeleportToPosition(S_WYR_FortressCrimeArea_da7ed679-19f6-4b2a-b86b-6c42b5cb35c7, 3.507, 50.675, 209.555);
//END_REGION

//REGION GUS-308974
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-308974");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-308974")
THEN
PROC_SetOnStage((ITEM)DEC_Dungeon_Skeleton_Crawling_B_000_1c8af3a6-dcf3-4c7f-abf7-b7f538b226fb, 0);
//END_REGION

//REGION GUS-293218
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-293218");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-293218")
THEN
PROC_SetOnStage((ITEM)S_WYR_FinalRoomEntrance_Statue_2867a964-6f66-46a0-b430-ec28a1b1d04d, 0);
PROC_RemoveAllDialogEntriesForSpeaker((ITEM)S_WYR_FinalRoomEntrance_Statue_2867a964-6f66-46a0-b430-ec28a1b1d04d);
DB_Dialogs(S_WYR_FinalRoomEntrance_Statue_Indestructible_3bcbf351-946b-4c72-b313-ce4b491b5902,  WYR_FinalRoomEntrance_Statue_fb1b38bf-70e0-e884-5d5d-c014b0163557);

//END_REGION

//REGION GUS-312602
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-312602");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-312602")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_WYR_Circus_Patron_03_37934c16-3809-4f22-8584-892f5c474fcb);
PROC_RemoveAllDialogEntriesForSpeaker(S_WYR_Circus_FanClubKid_01_554160c9-77fb-4d6e-b108-86c07dd3de56);
PROC_RemoveAllDialogEntriesForSpeaker(S_WYR_Circus_FanClubKid_02_6afc0210-436a-4ec0-99b1-f95140b3557d);
DB_Dialogs(S_WYR_Circus_Patron_03_37934c16-3809-4f22-8584-892f5c474fcb, GEB_AD_CantTalkNow_ae991ba1-8a2e-9cc7-b4c2-379af7f058c5);
DB_Dialogs(S_WYR_Circus_FanClubKid_01_554160c9-77fb-4d6e-b108-86c07dd3de56, GEB_AD_CantTalkNow_ae991ba1-8a2e-9cc7-b4c2-379af7f058c5);
DB_Dialogs(S_WYR_Circus_FanClubKid_02_6afc0210-436a-4ec0-99b1-f95140b3557d, GEB_AD_CantTalkNow_ae991ba1-8a2e-9cc7-b4c2-379af7f058c5);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-312602")
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_Clown_State_Hostile_59c1f674-0985-4d4d-9679-b8a1e4982f45)
AND
DB_WYR_Circus_ShowPatrons(_Patron, "Run", _)
THEN
SetFlag((FLAG)GEB_DontAppearAfter_a1085866-f30e-4165-865c-9992feec580e, _Patron, 0);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-312602")
AND
DB_WYR_Circus_ShowPatrons_DisappearGroup(_, (CHARACTER)_Character, _, _)
THEN
SetFlag((FLAG)GEB_DontAppearAfter_a1085866-f30e-4165-865c-9992feec580e, _Character, 0);
//END_REGION GUS-312602

//REGION GUS-304475
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-304475");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-304475")
THEN
DB_WYR_Circus_VignetteCharacters((CHARACTER)S_WYR_CircusKid_TieflingBoy_2c4f376b-6501-42ee-9881-d68c40a1391b);
DB_WYR_Circus_VignetteCharacters(S_WYR_CircusKid_HumanGirl_73d0a6bf-9323-4b8c-ac09-f78097753868);
DB_WYR_Circus_VignetteCharacters(S_WYR_MissingRedcaps_FlamingFist_62ac4bbf-bb18-48b7-b32f-ebc20e1aed04);
DB_WYR_Circus_VignetteCharacters(S_WYR_MissingRedcaps_Halfling_a8068534-c5b1-4d9d-9491-59be28acf4a0);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-304475")
AND
DB_GlobalFlag(WYR_Circus_State_Gone_151fd307-4cb8-44ba-8998-40e1d748b707)
AND
DB_WYR_Circus_VignetteCharacters(_Character)
AND
NOT DB_PermaDefeatedOrOffstage(_Character)
THEN
SetOnStage(_Character, 0);
//END_REGION GUS-304475

//REGION GUS-309741
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-309741");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-309741")
AND
DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_InOffice_12233623-2dc3-4dbe-b493-b491fdf6321d)
AND
NOT DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
GetCombatGroupID(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, "")
AND
GetCombatGroupID(S_WYR_KillDirectorGortash_GortashsBodyguard_001_8b142ad1-8ca5-487c-9ecd-93fb4172ea25, _CombatGroupID)
THEN
SetCombatGroupID(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _CombatGroupID);
//END_REGION

//REGION GUS-221865

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-221865_Repatch");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-221865_Repatch")
AND
GetAnubisConfig(S_LOW_CoffinMaker_e78e15fe-f131-49b3-8b88-87b33cebf694, "GLO_VignetteCharacter")
THEN
PROC_SetAnubisConfig(S_LOW_CoffinMaker_e78e15fe-f131-49b3-8b88-87b33cebf694, "LOW_KurwinCoffin_CoffinMaker");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-221865_Repatch")
THEN
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, PUZ_LOW_KoboldHoleItem004_422ffd36-8314-4c8f-b016-0c03db4e40d2);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc, PUZ_LOW_KoboldHoleItem005_d1771acc-becd-4bdf-96af-fe02073b2a4e);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc,PUZ_LOW_KoboldHoleItem002_468a7ce1-bcb2-4ea8-ad17-a4c5a6c18153);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc,PUZ_LOW_KoboldHoleItem006_fe6c5226-2e2e-4767-9658-793c51bc3668);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc,PUZ_LOW_KoboldHoleItem003_0b97635b-8082-44c0-b2cd-f8853408194f);
AiAddInterestingItem(S_LOW_KurwinCoffin_KelemvorPriestess_74f08242-30d7-4ad5-a0d7-36aa75b213cc,PUZ_LOW_KoboldHoleItem001_aa9fb237-7e97-4c23-bdd8-3c8e4c5cf5b9);

//END_REGION GUS-221865

//REGION GUS-311211
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
PROC_ApplySavegamePatches_GUS_311211();
DB_BUGFIX_Marker("GUS-311211");

PROC
PROC_ApplySavegamePatches_GUS_311211()
AND
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,(FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206,(FLAG)WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e)
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,(FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206,(FLAG)WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e);
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,(FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206,(FLAG)WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e, (FLAG)GLO_Origin_PartOfTheTeam_Wyll_24e24ca7-3446-440b-b645-19404845e108);

PROC
PROC_ApplySavegamePatches_GUS_311211()
AND
DB_CampNight_Requirement((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,(FLAG)WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e,(FLAG)CAMP_Mizora_State_ReadyForRomance_50326103-dae1-818a-3705-046d864c3386)
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,(FLAG)WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e,(FLAG)CAMP_Mizora_State_ReadyForRomance_50326103-dae1-818a-3705-046d864c3386);
DB_CampNight_Requirement((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,(FLAG)WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e,(FLAG)CAMP_Mizora_State_ReadyForRomance_50326103-dae1-818a-3705-046d864c3386, (FLAG)GLO_Origin_PartOfTheTeam_Wyll_24e24ca7-3446-440b-b645-19404845e108);

PROC
PROC_ApplySavegamePatches_GUS_311211()
AND
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizoraResurrectsRavengardAfterIRNDestruction_b8407ecd-e429-4218-bf44-dcae2d047c9c,(FLAG)CAMP_Mizora_State_WantsToResurrectRavengardAfterIRNDestruction_ac394670-1bb9-4e9e-92dc-8fa9382d4a64)
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizoraResurrectsRavengardAfterIRNDestruction_b8407ecd-e429-4218-bf44-dcae2d047c9c,(FLAG)CAMP_Mizora_State_WantsToResurrectRavengardAfterIRNDestruction_ac394670-1bb9-4e9e-92dc-8fa9382d4a64);
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizoraResurrectsRavengardAfterIRNDestruction_b8407ecd-e429-4218-bf44-dcae2d047c9c,(FLAG)CAMP_Mizora_State_WantsToResurrectRavengardAfterIRNDestruction_ac394670-1bb9-4e9e-92dc-8fa9382d4a64, (FLAG)GLO_Origin_PartOfTheTeam_Wyll_24e24ca7-3446-440b-b645-19404845e108);

//If Ravengard was rescued before Wyll left the party, he should disappear. If he was rescued after Wyll left the party, he should remain.
PROC
PROC_ApplySavegamePatches_GUS_311211()
AND
GetFlag((FLAG)GLO_Companion_Leave_363c71f4-8b46-c0c0-4bbb-0e5a85e4652d, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 1)
AND
QRY_ApplySavegamePatches_GUS_311211_SpokeToRavengardWithWyllInCamp()
AND
DB_InCamp((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
PROC_DisappearOutOfSight((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "ORI_Wyll_WyllLeftTeam_TeleportToAsylum", 0, "Walk");
ClearFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);
NOT DB_PartOfTheTeam(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
DB_ORI_Wyll_WyllLeftTeam_CharacterShouldLeaveCamp((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
//ToDo(Patch6): Drop letter

QRY
QRY_ApplySavegamePatches_GUS_311211_SpokeToRavengardWithWyllInCamp()
AND
DB_GlobalFlag((FLAG)CAMP_Ravengard_Event_HasMetWyll_234fcc9d-b7bd-3ddb-cd16-e842b8a03988)
THEN
DB_NOOP(1);

QRY
QRY_ApplySavegamePatches_GUS_311211_SpokeToRavengardWithWyllInCamp()
AND
DB_Players(_Player)
AND
GetFlag((FLAG)CAMP_Ravengard_Event_WyllDefeatedHasMet_7d15d70a-47e1-6434-02dd-dfab99481019, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_ApplySavegamePatches_GUS_311211_SpokeToRavengardWithWyllInCamp()
AND
DB_GlobalFlag((FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1)
THEN
DB_NOOP(1);

QRY
QRY_ApplySavegamePatches_GUS_311211_SpokeToRavengardWithWyllInCamp()
AND
DB_GlobalFlag((FLAG)GLO_Wyll_Event_RavengardWyrmwayQuest_a0383a14-5576-656c-1030-2439279ffc82)
THEN
DB_NOOP(1);

PROC
PROC_ApplySavegamePatches_GUS_311211()
AND
GetFlag((FLAG)GLO_Companion_Leave_363c71f4-8b46-c0c0-4bbb-0e5a85e4652d, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 1)
AND
DB_InCamp((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a)
THEN
PROC_GLO_MizoraDisappear((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, "ORI_Wyll_WyllLeftTeam_MizoraDisappearFromCamp");
NOT DB_PartOfTheTeam((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);
DB_ORI_Wyll_WyllLeftTeam_CharacterShouldLeaveCamp((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);

//END_REGION

//REGION GUS-310308
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "BGO_Main_A", "GUS-310308_BGO");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310308_CTY");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310308_BGO")
THEN
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)WYR_SmugglersCave_State_SmugglersDefeated_d6acc249-bd57-4076-ad5f-954c5eaad5c7, "Act3_Noble_SidedWithGuildSmugglers");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310308_BGO")
AND
DB_Players(_Player)
AND
DB_GlobalFlag(WYR_SmugglersCave_State_SmugglersDefeated_d6acc249-bd57-4076-ad5f-954c5eaad5c7)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Noble_SidedWithGuildSmugglers");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310308_CTY")
THEN
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Noble_SidedWithGuildSmugglers");
//END_REGION GUS-310308

//REGION GUS-309988

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
DB_GlobalFlag((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769)
AND
NOT DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_GortashBecameHostile_990f1c60-6ecb-4898-ab2e-0a92d2dc0a2c)
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_KillDirectorGortash_State_GortashBecameHostile_990f1c60-6ecb-4898-ab2e-0a92d2dc0a2c);
DB_BUGFIX_Marker("GUS-309988-GortashBecameHostile");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(WYR_KillDirectorGortash_State_AcceptedAlliance_92e647a6-4625-4a2b-a143-35cba456fe50)
AND
DB_GlobalFlag(WYR_KillDirectorGortash_State_GortashBecameHostile_990f1c60-6ecb-4898-ab2e-0a92d2dc0a2c)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Charlatan_AllianceBetrayed");
DB_BUGFIX_Marker("GUS-309988-GortashBetrayed");

//END_REGION

//REGION GUS-312812
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_PartyMembers((CHARACTER)_Player)
AND
NOT DB_InteractiveDialogSpeaker(_, _Player)
AND
GetFlag(WYR_Axe_PlayerInDialog_eab7d2d2-8a14-41ff-a0bc-a970d4279692, _Player, 1)
THEN
ClearFlag(WYR_Axe_PlayerInDialog_eab7d2d2-8a14-41ff-a0bc-a970d4279692,_Player, 0);
DB_BUGFIX_Marker("GUS-312812");
//END_REGION GUS-312812

//REGION GUS-311003
// Patching for CL3858130 (patch 5)
// Fixing statue being stuck in the vanity armour and couldnt reset to normal (due to the statue not being in the DB_Camp_StoredArmourSet but having vanity armour on it)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_WYR_Circus_StatueSentToCamp(_)
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_Sculptor_Event_RequestedVanity_0333cb3a-07c2-4fa7-a40c-46d4353b5659)
AND
QRY_GetArmourSet(S_WYR_Circus_StatueDummy_c2ef6bde-3dbe-4ff5-99ca-8120445a8309)
AND
DB_QRYRTN_GetArmourSet(ARMOURSET.Vanity)
THEN
PROC_SetArmourSet(S_WYR_Circus_StatueDummy_c2ef6bde-3dbe-4ff5-99ca-8120445a8309, ARMOURSET.Normal);
DB_BUGFIX_Marker("GUS-311003");
//END_REGION GUS-311003

//////////////////////////////// PATCH 6 ////////////////////////////////

//REGION GUS-310721
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "BGO_Main_A", "GUS-310721");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310721")
AND
DB_GlobalFlag(WYR_Circus_Ringmaster_State_TalkedPostCombat_9534cdaf-4085-4562-b333-4081f1adef00)
THEN
PROC_GlobalSetFlagAndCache(WYR_Circus_Knows_Ringmaster_96af2d82-718f-7b90-7335-4f8c6d8f70e2);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310721")
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_Knows_Ringmaster_96af2d82-718f-7b90-7335-4f8c6d8f70e2)
AND
GetFlag(WYR_Circus_HasMet_Ringmaster_6c732f57-46dc-454d-b03a-1833506f2564, _Player, 1)
THEN
PROC_GlobalSetFlagAndCache(WYR_Circus_Knows_Ringmaster_96af2d82-718f-7b90-7335-4f8c6d8f70e2);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-310721")
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_Knows_Ringmaster_96af2d82-718f-7b90-7335-4f8c6d8f70e2)
AND
GetFlag(WYR_Circus_HasMet_Ringmaster_PostCombat_1a20f64a-6b5d-4abf-9ac3-e4f279ea876c, _Player, 1)
THEN
PROC_GlobalSetFlagAndCache(WYR_Circus_Knows_Ringmaster_96af2d82-718f-7b90-7335-4f8c6d8f70e2);
//END_REGION GUS-310721

//REGION GUS-313471

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
THEN
DB_BUGFIX_Marker("GUS-313471");
NOT DB_GLO_LevelTraveler((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "CTY_Main_A", "DefaultCharacter");
DB_GLO_LevelTraveler((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "CTY_Main_A", "WYR_RaphaelTango_Warlock");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_CurrentLevel("BGO_Main_A")
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_LeftBaldursGate")
AND
NOT QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_InviteToRaphael")
THEN
DB_BUGFIX_Marker("GUS-313471-BGO");
PROC_SetAnubisConfig((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "WYR_RaphaelTango_Warlock");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_CurrentLevel("CTY_Main_A")
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_LeftBaldursGate")
THEN
DB_BUGFIX_Marker("GUS-313471-CTY");
PROC_SetAnubisConfig((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "WYR_RaphaelTango_Warlock");

//END_REGION

//REGION GUS-303604

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1") //Fixing this for patch 6, but the original issue was fixed in patch 1. Just couldn't savegame patch it them.
AND
DB_OnlyOnce("WYR_CourageTest_General")
AND
DB_ActiveLevel("BGO_Main_A")
AND
DB_WYR_CourageTest_Tester(_Character, _)
AND
NOT DB_WYR_Wyrmway_Solved((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
AND
NOT DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
AND
NOT DB_WYR_Wyrmway_Solved((ITEM)S_WYM_Wyrmway_CourageIndicator_d020f6ee-1acf-4027-966e-f9049746452f)
AND
NOT DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYM_Wyrmway_CourageIndicator_d020f6ee-1acf-4027-966e-f9049746452f)
AND
ObjectTimerExists(_Character, "WYR_CourageTest_General", 0)
THEN
PROC_BUGFIX_SavegamePatch_303604();

PROC
PROC_BUGFIX_SavegamePatch_303604()
THEN
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12);

PROC
PROC_BUGFIX_SavegamePatch_303604()
AND
DB_WYR_CourageTest_Tester(_Character, _)
THEN
RemoveStatus(_Character, "WYR_COURAGEBRIGHT", S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);



//END_REGION

//REGION GUS-310461


PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-310461");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310461")
AND
DB_UndercityRuins_AppearingCandles(_Trigger, S_LOW_BhaalApproach_Candle005_944e05f8-a8b7-4839-a73e-21596e7ba507)
THEN
TeleportToPosition(S_LOW_BhaalApproach_Candle005_944e05f8-a8b7-4839-a73e-21596e7ba507, -5.966, -44.796, 1000.835, "", 0);
DB_UndercityRuins_CandleTeleportLocations(S_LOW_BhaalApproach_Candle005_944e05f8-a8b7-4839-a73e-21596e7ba507, S_LOW_BhaalApproach_Candle005Trigger_dd9d1b69-4c58-417f-b4be-763527fa8c5a);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310461")
AND
DB_UndercityRuins_AppearingCandles(_Trigger, S_LOW_BhaalApproach_Candle006_04e73c9d-bcde-4964-ab70-d6514af7feb2)
THEN
TeleportToPosition(S_LOW_BhaalApproach_Candle006_04e73c9d-bcde-4964-ab70-d6514af7feb2, -6.17, -44.802, 1010.706, "", 0);
DB_UndercityRuins_CandleTeleportLocations(S_LOW_BhaalApproach_Candle006_04e73c9d-bcde-4964-ab70-d6514af7feb2, S_LOW_BhaalApproach_Candle006Trigger_85020b2c-f460-44d5-925e-7cf0ee0d0960);
//END_REGION


//REGION GUS-312579

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)WYR_RaphaelTango_Warlock_State_TalkedAfterDeal_2faafab6-31b0-5db9-824f-b79ff9cc2073)
AND
IsOnStage(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, 1)
AND
DB_State_Current(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_LeftBaldursGate")
THEN
PROC_GEN_Warlock_GUS312579_FixCurrentFlag();

PROC
PROC_GEN_Warlock_GUS312579_FixCurrentFlag()
AND
DB_CurrentLevel("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-312579-BGO");
PROC_GlobalSetFlagAndCache((FLAG)GLO_Warlock_State_InSharessCaress_e3682219-f9b6-482f-9419-cc2adaf037c0);

PROC
PROC_GEN_Warlock_GUS312579_FixCurrentFlag()
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-312579-CTY");
PROC_GlobalSetFlagAndCache((FLAG)GLO_Warlock_State_InElfsongTavern_05c25ac8-f10f-49f1-8d7e-c0c48d6772c9);

//END_REGION

//REGION GUS-308837
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "BGO_Main_A", "GUS-308837");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-308837")
AND
DB_GlobalFlag((FLAG)WYR_Circus_Clown_State_Hostile_59c1f674-0985-4d4d-9679-b8a1e4982f45)
AND
DB_GLO_DefeatCounter(S_WYR_Circus_Beast_01_4d909cad-9b9b-4f34-ba27-6584bc8b4e20, "WYR_Circus_Absolutists")
AND
GetFaction(S_WYR_Circus_Beast_01_4d909cad-9b9b-4f34-ba27-6584bc8b4e20, (FACTION)ACT3_WYR_Circus_PacifiedBeast_379cb629-2a67-4844-9c77-d8f1bac8bd31)
THEN
SetFaction(S_WYR_Circus_Beast_01_4d909cad-9b9b-4f34-ba27-6584bc8b4e20, (FACTION)ACT3_WYR_Circus_Beasts_5afda7e4-e61a-4d23-af6d-86fdef9322a8);
DB_BUGFIX_308837_DoFix(1);

IF
DB_BUGFIX_308837_DoFix(1)
AND
DB_GlobalFlag((FLAG)WYR_Circus_State_PostCombat_ee4b2f6e-9d52-4bc5-bde6-bc0e1c015de4)
THEN
NOT DB_BUGFIX_308837_DoFix(1);
PROC_SetRelationMutual(Act3_WYR_Circus_Beasts_5afda7e4-e61a-4d23-af6d-86fdef9322a8, ACT3_WYR_Circus_Ringmaster_c8ee67a5-f6c1-46ab-8957-b1e4018adbf8, 0);
//END_REGION GUS-308837

//REGION GUS-311777
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_Knows_FoundryDestroyedByBrain_2274d648-53f4-4107-9256-a5c6332dc283, "LOW_Foundry", "DiscoveredDestroyedFoundry");
DB_BUGFIX_Marker("GUS-311777");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_Knows_FoundryDestroyedByBrain_2274d648-53f4-4107-9256-a5c6332dc283)
THEN
QuestUpdate("LOW_Foundry", "DiscoveredDestroyedFoundry");

//END_REGION GUS-311777

//REGION GUS-313450
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
THEN
NOT DB_QuestDef_State((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306, "LOW_Foundry", "TalkedWithWulbren");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_WulbrenToldSteelWatch_48b3c3f0-e78a-4277-8ef9-b9cc0a4d8960, "LOW_Foundry", "TalkedWithWulbren");
DB_QuestDef_State((FLAG)WYR_Wulbren_State_InterruptedByBarcus_f2211dd4-5494-66b1-5e7b-01664f7287b0, "LOW_Foundry", "TalkedToBarcus");
DB_BUGFIX_Marker("GUS-313450-A");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
DB_GlobalFlag(WYR_KillDirectorGortash_State_WulbrenToldSteelWatch_48b3c3f0-e78a-4277-8ef9-b9cc0a4d8960)
THEN
QuestUpdate("LOW_Foundry", "TalkedWithWulbren");
DB_BUGFIX_Marker("GUS-313450-B");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
DB_GlobalFlag(WYR_Wulbren_State_InterruptedByBarcus_f2211dd4-5494-66b1-5e7b-01664f7287b0)
THEN
QuestUpdate("LOW_Foundry", "TalkedToBarcus");
DB_BUGFIX_Marker("GUS-313450-C");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
DB_GlobalFlag(WYR_Ironhand_Event_InvestigateQuest_Offered_bf4bd7b5-8a79-43a6-bc7b-4ae62cfe4302)
AND
DB_GlobalFlag(WYR_KillDirectorGortash_State_WulbrenToldSteelWatch_48b3c3f0-e78a-4277-8ef9-b9cc0a4d8960)
THEN
QuestUpdate("LOW_Foundry", "TalkedToBarcus");
DB_BUGFIX_Marker("GUS-313450-D");
//END_REGION GUS-313450

//REGION GUS-308902

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-308902");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308902")
AND
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_InformerGoodsAvailable_a8b387b1-c404-48ef-840f-0d23af63083e)
THEN
PROC_SetCustomTradeTreasure((CHARACTER)S_GLO_SharranInformer_b2cf2efe-ec06-48cd-8fb7-ad596d61164f, "WYR_SharranInformer_Extended");

//END_REGION GUS-308902

//REGION GUS-291971
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "BGO_Main_A", "GUS-291971");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-291971")
AND
NOT DB_PermaDefeatedOrOffstage(S_GLO_YoungLover_02_dcf597c0-36c5-4c81-957a-6fe9fca50a68)
THEN
PROC_SetAnubisConfig(S_GLO_YoungLover_02_dcf597c0-36c5-4c81-957a-6fe9fca50a68, "WYR_TieflingRefugee_YoungLover_02_Patch6");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-291971")
AND
NOT DB_PermaDefeatedOrOffstage(S_GLO_YoungLover_02_dcf597c0-36c5-4c81-957a-6fe9fca50a68)
THEN
PROC_SetAnubisConfig(S_DEN_PickpocketTrader_e1fda08b-45d4-41db-84b5-20e9931ba5af, "WYR_TieflingRefugee_PickpocketTrader_Patch6");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-291971")
AND
NOT DB_PermaDefeatedOrOffstage(S_WYR_RefugeeCamp_Refugee_14_62986827-cf46-492b-a32e-27a168e47846)
THEN
PROC_SetAnubisConfig(S_WYR_RefugeeCamp_Refugee_14_62986827-cf46-492b-a32e-27a168e47846, "WYR_RefugeeCamp_Refugee_14_Patch6");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-291971")
AND
NOT DB_PermaDefeatedOrOffstage(S_WYR_RefugeeCamp_Refugee_08_92b0f2b2-0f50-4bb0-af35-05c8b877fce5)
THEN
PROC_SetAnubisConfig(S_WYR_RefugeeCamp_Refugee_08_92b0f2b2-0f50-4bb0-af35-05c8b877fce5, "WYR_RefugeeCamp_Refugee_08_Patch6");
//END_REGION GUS-291971

//REGION GUS-309996
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "BGO_Main_A", "GUS-309996");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-309996")
AND
DB_WYR_PaintingPuzzle_SolutionPaintings(_Painting, _, _, _, _, _)
AND
HasActiveStatus(_Painting, "WYR_PAINTINGPUZZLE_HIDDEN", 1)
THEN
ApplyStatus(_Painting, "WYR_WYRMWAY_PAINTINGSHROUD", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION GUS-287042
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "BGO_Main_A", "GUS-287042");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-287042")
AND
DB_State_Current(S_WYR_MerchantsHouse_Merchant_b2a50d09-709a-483c-9818-acebcff2b977, "WYR_MerchantsHouse", "Conflict")
THEN
DB_SceneManager(S_WYR_MerchantsHouse_RefugeeDaughter_a31e1798-ab61-4b2c-9e06-c66c56d2edb5, "WYR_MerchantsHouse_ConflictScene");
DB_SceneManager(S_WYR_MerchantsHouse_RefugeeWife_0d9c9a7c-3f15-4b86-990f-2b5dd65b4dc7, "WYR_MerchantsHouse_ConflictScene");
//END_REGION GUS-287042

//REGION GUS-309087
PROC
PROC_ApplySavegamePatches()
AND
DB_KnockedOut(S_WYR_WyrmRock_BarracksGuard_003_c57ca6b4-de77-4230-b85c-06fd284e0ec6)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "BGO_Main_A", "GUS-309087");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-309087")
THEN
ObjectTimerCancel(S_WYR_WyrmRock_BarracksGuard_003_c57ca6b4-de77-4230-b85c-06fd284e0ec6, "Timer_WYR_WyrmRock_BarracksGuard_003_SayAD");
PROC_ForceStopDialog(S_WYR_WyrmRock_BarracksGuard_003_c57ca6b4-de77-4230-b85c-06fd284e0ec6);
//END_REGION

//REGION GUS-305743
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_GlobalFlag(WYR_Circus_Checkpoint_State_GainedAccess_6c332552-395f-6f80-a0e7-d2450ab0812d)
THEN
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)WYR_Circus_Checkpoint_State_GainedAccess_6c332552-395f-6f80-a0e7-d2450ab0812d, "Act3_Charlatan_PassedCircusEntrance");
NOT DB_GLO_Backgrounds_ChainAfterGoal("Act3_Charlatan_PassedCircusEntrance", "Act3_Noble_CircusAccessed");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)WYR_Circus_Checkpoint_State_GainedAccess_6c332552-395f-6f80-a0e7-d2450ab0812d, "Act3_Noble_CircusAccessed");
DB_BUGFIX_Marker("GUS-305743");
//END_REGION GUS-305743

//REGION GUS-310178

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_PartOfTheTeam(_Player)
AND
GetFlag(WYR_MerchantsHouse_Merchant_Event_GiveAllGold_e5c7e21e-0c67-423b-a71f-e7ed7cddb611, _Player, 1)
THEN
DB_BUGFIX_310178_DoFix(_Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_BUGFIX_310178_DoFix(_)
THEN
DB_GLO_Backgrounds_Goal((TAG)CRIMINAL_74ed9de3-fff5-419a-949b-18bd5e17944e, "Act3_Criminal_BlackmailedArfur", 9314fdf2-1990-4e28-8174-61071c1af791);
NOT DB_GLO_Backgrounds_Goal((TAG)CRIMINAL_74ed9de3-fff5-419a-949b-18bd5e17944e, "Act3_Criminal_BlackmailedBenni", 9314fdf2-1990-4e28-8174-61071c1af791);
DB_BUGFIX_Marker("GUS-310178-A");

IF
DB_BUGFIX_310178_DoFix(_Player)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_BlackmailedArfur");
NOT DB_BUGFIX_310178_DoFix(_Player);
DB_BUGFIX_Marker("GUS-310178-B");
//END_REGION GUS-310178

//REGION GUS-314136
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5 Hotfix 5")
THEN
PROC_ApplySavegamePatches_GUS_314136_BGO();
DB_BUGFIX_Marker("GUS-314136_BGO");

PROC
PROC_ApplySavegamePatches_GUS_314136_BGO()
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("IRN_Main_A")
AND
NOT DB_GLO_LevelTraveler((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_Main_A", "IRN_IronThrone_Ravengard")
THEN
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_Main_A", "IRN_IronThrone_Ravengard");

//END_REGION

//REGION GUS-307065
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "BGO_Main_A", "GUS-307065");

// if the player already reached Wyrm's Crossing we don't add these two bodyguards at all
PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-307065")
THEN
PROC_SetOnStage(S_WYR_KillDirectorGortash_GortashsBodyguard_007_dd7a49bb-afb0-4425-8922-a94c3e91928b, 0);
PROC_SetOnStage(S_WYR_KillDirectorGortash_GortashsBodyguard_008_b0751f2b-2109-4c29-b3f0-6b3153be7a7c, 0);
//END_REGION

//REGION GUS-309059
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
NOT DB_GLO_Backgrounds_ChainAfterQuestUpdate("LOW_Foundry", "DestroyedFoundry", "Act3_Soldier_DeepGnomesAided");
DB_BUGFIX_Marker("GUS-309059");
//END_REGION GUS-309059

//REGION GUS-313016
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
THEN
PROC_BG3_SavegamePatch_GUS313016();

PROC
PROC_BG3_SavegamePatch_GUS313016()
THEN
DB_QuestDef_State((FLAG)WYR_Posthouse_Event_PostmasterGivesMoneyUpfront_eb12835d-c262-4625-f7e6-e8f9d7a4fe47, "WYR_Posthouse", "DanzoGivesGoldUpfront");
DB_BUGFIX_Marker("GUS-313016");

PROC
PROC_BG3_SavegamePatch_GUS313016()
AND
DB_Players(_Player)
AND
GetFlag((FLAG)WYR_Posthouse_Event_PostmasterGivesMoneyUpfront_eb12835d-c262-4625-f7e6-e8f9d7a4fe47, _Player, 1)
THEN
PROC_QuestDef_QuestUpdate(_Player, "WYR_Posthouse", "DanzoGivesGoldUpfront");
//END_REGION GUS-313016

//REGION GUS-309558
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "BGO_Main_A", "GUS-309558");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-309558")
AND
QRY_IsOpeneding((ITEM)S_WYR_WyrmRock_SouthBridge_9e8dab1b-b39e-4c73-8621-9bbeee61baab)
THEN
DB_BUGFIX_Marker("GUS-309558");
PROC_SetOnStage(S_WYR_WyrmRock_SouthBridge_Blocker_f014b3e9-7d96-4cda-be36-eb251b0fb325, 0);
//END_REGION

//REGION GUS-312593
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 5 Hotfix 5", "BGO_Main_A", "GUS-312593");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-312593")
THEN
DB_BUGFIX_Marker("GUS-312593");
PROC_DeclareCounter("WYR_GortashsGrenades");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-312593")
AND
DB_Is_InCombat(_Grenade, _)
AND
GetTemplate(_Grenade, PUZ_Trap_Gortash_GrenadeInstantiator_Grenade_98f2cb6a-e268-4f99-aac3-62edabd8774c)
THEN
PROC_IncreaseCounter("WYR_GortashsGrenades");
DB_GLO_Bugfix_312593((ITEM)_Grenade);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-312593")
AND
DB_GlobalCounter("WYR_GortashsGrenades", _Count)
AND
_Count > 20
THEN
PROC_GLO_Bugfix_312593_RemoveGrenades();

PROC
PROC_GLO_Bugfix_312593_RemoveGrenades()
AND
DB_GLO_Bugfix_312593(_Grenade)
THEN
RequestDelete(_Grenade);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-312593")
THEN
SysClear("DB_GLO_Bugfix_312593", 1);
//END_REGION

//REGION GUS-315202
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5 Hotfix 5")
AND
DB_GlobalFlag(WYR_OpenHand_State_YannisAskedToInvestigate_394409f9-a450-4f9e-b396-7e861da8287f)
AND
NOT DB_QuestIsOpened("WYR_OpenHandMurder")
THEN
DB_BUGFIX_Marker("GUS-315202");
QuestUpdate("WYR_OpenHandMurder", "YannisStartPoint");
//END_REGION GUS-315202

//REGION GUS-315694
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_CurrentLevel("BGO_Main_A") // we dont need to patch it if the player in another level, since the default scripting will take care of that
AND
DB_GlobalFlag(LOW_MinscHideout_State_ZhentLeaderEscaping_4333a451-024f-4c41-aea1-7046afdf0b4a)
AND
NOT DB_GlobalFlag(WYR_BoastingCrooks_State_Leaving_837d4b7f-b3dc-11ba-f725-2ef927f21916)
THEN
DB_BUGFIX_Marker("GUS-315202");
PROC_SceneOver("WYR_SharessCaress_CrooksScene"); // they will not offstage but instead walk away
//END_REGION GUS-315694

//REGION GUS-307557
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelLoadedOnce("END_Main")
AND
DB_CampNight((FLAG)NIGHT_Halsin_Romance_Execution_a9634ef4-27ec-4a75-be9d-7c738d9768ed, 4240)
THEN
DB_CampNight_Requirement((FLAG)NIGHT_Halsin_Romance_Execution_a9634ef4-27ec-4a75-be9d-7c738d9768ed, (FLAG)CAMP_Halsin_State_WaitForKarlachUpgraded_9e2e8aaa-dcb6-3541-8e51-dd23cdac16b0, (FLAG)GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c);
DB_BUGFIX_Marker("GUS-307557");
//END_REGION GUS-307557

//REGION GUS-315133

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("INT_Main_A")
AND
NOT DB_OnlyOnce("END_General_StonesCombined")
AND
GetRegion(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,"SCL_Main_A")
AND
DB_Avatars(_Player)
AND
NOT DB_BUGFIX_Marker("GUS-315133") //breaks out of DB_Avatars loop
THEN
PROC_ToInventoryAndOnStage(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,_Player,1,1,1);
DB_BUGFIX_Marker("GUS-315133");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("INT_Main_A")
AND
NOT DB_OnlyOnce("END_General_StonesCombined")
AND
GetRegion(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,"SCL_Main_A")
AND
DB_Avatars(_Player)
AND
NOT DB_BUGFIX_Marker("GUSX-7746") //breaks out of DB_Avatars loop
THEN
PROC_ToInventoryAndOnStage(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,_Player,1,1,1);
DB_BUGFIX_Marker("GUSX-7746");

//END_REGION GUS-315133

//REGION GUS-315393 GUS-315394 GUS-315396 GUS-315397

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","BGO_Main_A","GUS-315393");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","CTY_Main_A","GUS-315393");

//GEN
PROC
PROC_ApplySavegamePatchInLevel(_,"GUS-315393")
AND
NOT DB_GLO_CompoundFlag((FLAG)CAMP_Ravengard_Event_ToldAboutBalduran_a16ce8d1-e40d-fa3f-6aad-5a7b692c02a3,(FLAG)CAMP_Ravengard_State_Dejected_ca0cb55f-d5b7-4e13-a28a-27bbc6522229) //used as an "only once"
AND
DB_GlobalFlag((FLAG)CAMP_Ravengard_State_KnowsFlorrickDead_0dfac2ac-29b0-8b44-c0a8-c81e487ef757)
THEN
PROC_GlobalSetFlagAndCache((FLAG)CAMP_Ravengard_State_Dejected_ca0cb55f-d5b7-4e13-a28a-27bbc6522229);

PROC
PROC_ApplySavegamePatchInLevel(_,"GUS-315393")
AND
NOT DB_GLO_CompoundFlag((FLAG)CAMP_Ravengard_Event_ToldAboutBalduran_a16ce8d1-e40d-fa3f-6aad-5a7b692c02a3,(FLAG)CAMP_Ravengard_State_Dejected_ca0cb55f-d5b7-4e13-a28a-27bbc6522229) //used as an "only once"
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_Dejected_ca0cb55f-d5b7-4e13-a28a-27bbc6522229)
AND
DB_GLO_Playable((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_Dejected_ca0cb55f-d5b7-4e13-a28a-27bbc6522229) //to stop the loop if the flag gets set
AND
GetFlag((FLAG)CAMP_Ravengard_Event_ToldAboutBalduran_a16ce8d1-e40d-fa3f-6aad-5a7b692c02a3,_Player,1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)CAMP_Ravengard_State_Dejected_ca0cb55f-d5b7-4e13-a28a-27bbc6522229);

PROC
PROC_ApplySavegamePatchInLevel(_,"GUS-315393")
AND
NOT DB_GLO_CompoundFlag((FLAG)CAMP_Ravengard_Event_ToldAboutBalduran_a16ce8d1-e40d-fa3f-6aad-5a7b692c02a3,(FLAG)CAMP_Ravengard_State_Dejected_ca0cb55f-d5b7-4e13-a28a-27bbc6522229) //used as an "only once"
THEN
DB_GLO_CompoundFlag((FLAG)CAMP_Ravengard_Event_ToldAboutBalduran_a16ce8d1-e40d-fa3f-6aad-5a7b692c02a3,(FLAG)CAMP_Ravengard_State_Dejected_ca0cb55f-d5b7-4e13-a28a-27bbc6522229);
DB_GLO_CompoundFlag((FLAG)CAMP_Ravengard_State_KnowsFlorrickDead_0dfac2ac-29b0-8b44-c0a8-c81e487ef757,(FLAG)CAMP_Ravengard_State_Dejected_ca0cb55f-d5b7-4e13-a28a-27bbc6522229);

//BGO_Main_A
PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A","GUS-315393")
THEN
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, "BGO_Main_A", "WYR_Mizora");
NOT DB_GLO_LevelTraveler((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"BGO_Main_A","HAV_Isobel");
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"BGO_Main_A","WYR_Isobel");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A","GUS-315393")
AND
GetRegion(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"BGO_Main_A")
AND
NOT GetAnubisConfig(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"WYR_Mizora")
THEN
PROC_SetAnubisConfig(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"WYR_Mizora");
DB_BUGFIX_Marker("GUS-315397_BGO");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A","GUS-315393")
AND
GetRegion(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"BGO_Main_A")
AND
NOT GetAnubisConfig(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"WYR_Isobel")
THEN
PROC_SetAnubisConfig(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"WYR_Isobel");
DB_BUGFIX_Marker("GUS-315394_BGO");

//CTY_Main_A
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315393")
THEN
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "CTY_Main_A", "DefaultCharacter");
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "CTY_Main_A", "WYR_Isobel");
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "CTY_Main_A", "DefaultCharacter");
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "CTY_Main_A", "WYR_Ravengard");
DB_GLO_LevelTraveler((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, "CTY_Main_A", "WYR_Mizora");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315393")
AND
GetRegion(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"CTY_Main_A")
AND
NOT GetAnubisConfig(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"WYR_Isobel")
THEN
PROC_SetAnubisConfig(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"WYR_Isobel");
DB_BUGFIX_Marker("GUS-315394_CTY");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315393")
AND
GetRegion(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"CTY_Main_A")
AND
NOT GetAnubisConfig(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"WYR_Ravengard")
THEN
PROC_SetAnubisConfig(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"WYR_Ravengard");
DB_BUGFIX_Marker("GUS-315396_CTY");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315393")
AND
GetRegion(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"CTY_Main_A")
AND
NOT GetAnubisConfig(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"WYR_Mizora")
THEN
PROC_SetAnubisConfig(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"WYR_Mizora");
DB_BUGFIX_Marker("GUS-315397_CTY");

//END_REGION GUS-315393 GUS-315394 GUS-315396 GUS-315397

//REGION GUS-294944
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_State_Gone_151fd307-4cb8-44ba-8998-40e1d748b707)
THEN
DB_BUGFIX_Marker("GUS-294944");
PROC_RemoveAllDialogEntriesForSpeaker(S_WYR_Circus_BackupBard_02_c6761d3e-62f4-4a43-a593-771b670b583d);
DB_Dialogs(S_WYR_Circus_BackupBard_02_c6761d3e-62f4-4a43-a593-771b670b583d, WYR_Circus_BackupBard_02_f6aa46c5-51ed-7b83-e925-2a1d94697742);
//END_REGION GUS-294944

//REGION GUS-316070
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
NOT DB_WYR_MerchantsHouse_Journal_OnFireworksObjecitve(_)
THEN
DB_BUGFIX_Marker("GUS-316070");
DB_WYR_MerchantsHouse_Journal_OnFireworksObjecitve(0);
//END_REGION GUS-316070

//REGION GUS-316206
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_AfterRavengardTadpoled_8cb4a17e-5611-3866-3d59-20edd8e106ce,_,_,_)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_AfterRavengardTadpoled_8cb4a17e-5611-3866-3d59-20edd8e106ce);
DB_BUGFIX_Marker("GUS-316206");

//END_REGION

//REGION GUS-315629
//Not checking the level and only the quest state because this check should happen on WYR or on CTY_Main_A
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
DB_QuestDef_State((FLAG)WYR_SerialKiller_State_ValeriaSendToDevella_65f1a97d-1656-da36-6417-be1e44a87663, "LOW_FindBhaalTemple", "StopMurders_ValeriaSendUsToDevella")
THEN
DB_BUGFIX_Marker("GUS-315629");
NOT DB_QuestDef_State((FLAG)WYR_SerialKiller_State_ValeriaSendToDevella_65f1a97d-1656-da36-6417-be1e44a87663, "LOW_FindBhaalTemple", "StopMurders_ValeriaSendUsToDevella");
NOT DB_QuestDef_State_ConditionalFlag((FLAG)LOW_SerialKiller_Knows_TargetList_262314d1-43bf-4ea5-ae23-4a77bfab2671, "LOW_FindBhaalTemple", "StopMurders_GetTargetListAfterTalkingToDevella", 1, (FLAG)LOW_Elfsong_Devella_Event_StelmaneMurdered_6f9a5052-b6f0-8452-2149-5f0781d192d4);
//END_REGION GUS-315629

//REGION GUS-274166
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "BGO_Main_A", "GUS-274166");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-274166")
THEN
DB_BUGFIX_Marker("GUS-274166");
TeleportToPosition(BHVR_WRLD_GLO_WritingOnBook_Table_DWR_M_SceneTrigger_f5753e0d-8001-4b54-b84a-2e81263a4931, 62.303, 43.819, -112.546, "", 0, 0, 0, 0, 0);
TeleportToPosition(S_WYR_BigBarn_DonationRecord_7123fb6a-e295-4c4c-a149-36e86d668232, 62.184, 44.704, -112.11, "", 0, 0, 0, 0, 0);
//END_REGION GUS-274166

//REGION GUS-315915
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-315915");
DB_WYR_DapperDrow_BlindImmunityPassives("DevilsSight", (FLAG)WYR_DapperDrow_Event_ImmuneToBlind_b48f7bc4-1eac-4a64-9e5a-c282edc690f2);
DB_WYR_DapperDrow_BlindImmunityPassives("DevilsSight", (FLAG)WYR_DapperDrow_Event_ImmuneToBlind_DevilSight_bfd05724-f2cb-47e3-a94c-6eaef982812e);
DB_WYR_DapperDrow_BlindImmunityPassives("MAG_Shadow_BlindImmunity_Ring_Passive", (FLAG)WYR_DapperDrow_Event_ImmuneToBlind_b48f7bc4-1eac-4a64-9e5a-c282edc690f2);
DB_WYR_DapperDrow_BlindImmunityPassives("MAG_Infernal_Metal_Helmet_InfernalSight_Passive", (FLAG)WYR_DapperDrow_Event_ImmuneToBlind_b48f7bc4-1eac-4a64-9e5a-c282edc690f2);
DB_WYR_DapperDrow_BlindImmunityPassives("MAG_Watcher_Helmet_Darkvision_Passive", (FLAG)WYR_DapperDrow_Event_ImmuneToBlind_b48f7bc4-1eac-4a64-9e5a-c282edc690f2);
DB_WYR_DapperDrow_BlindImmunityPassives("MAG_SHA_SharBlessing_Spear_Passive", (FLAG)WYR_DapperDrow_Event_ImmuneToBlind_SharSpear_71875fee-c7e7-479d-b02e-13ac6d7dcaab);
//END_REGION GUS-315915

//REGION GUS-304849

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "BGO_Main_A", "GUS-304849");
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-304849");

//Check NPCs
PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-304849")
THEN
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)S_WYR_CourageTest_Myrmidon1_f76893c2-c5ad-4124-8e45-472241a3671e);
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)S_WYR_CourageTest_Myrmidon3_8a6b3d1d-49da-431b-90e7-a87e7bdb8394);
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)S_WYR_CourageTest_Myrmidon6_ce4ff3ce-29ef-47a4-8214-8449a59bffd9);
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)S_WYR_CourageTest_Myrmidon8_ce2bb9f5-a90b-4a9c-ac98-ad1ee33b3f4c);
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)S_WYR_SkeletonDragon_Minion_01_9bb09a03-955a-4ecb-b1ea-4a5d83ec2b7e);
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)S_WYR_SkeletonDragon_Minion_02_df015249-8648-46a7-9fe7-8ea64342eb59);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304849")
THEN
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)S_LOW_WaterElemental_4cb61416-f095-4fbb-aece-51f37b6bb4d6);
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)S_LOW_LorroakanWaterMyrmidon_b9ed09f3-e67e-4498-aa24-5fecec718c07);

PROC
PROC_ApplySavegamePatchInLevel(_, "GUS-304849")
AND
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)_Character)
AND
Exists(_Character,1)
AND
NOT DB_PermaDefeated(_Character)
THEN
NOT DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)_Character);
DB_BUGFIX_Marker("GUS-304849",_Character);
SetTag(_Character,(TAG)CHASM_IMMUNE_SWIM_b7018e56-3185-4dde-8605-48bd9e782969);

PROC
PROC_ApplySavegamePatchInLevel(_, "GUS-304849")
AND
DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)_Character)
THEN
NOT DB_BUGFIX_304849_PatchChasmImmunityTag((GUIDSTRING)_Character);

//Check player summons
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT QRY_IsEmptyDB("DB_PlayerSummons",1)
THEN
PROC_BUGFIX_304849_CheckSummonsImmunity();

PROC
PROC_BUGFIX_304849_CheckSummonsImmunity()
THEN
DB_BUGFIX_304849_ChasmImmuneRoots_Summons((ROOT)Elemental_Water_ConjureElemental_f21e144a-3237-4faa-a99c-a15e1937bc2c);
DB_BUGFIX_304849_ChasmImmuneRoots_Summons((ROOT)Myrmidon_Water_ConjureElemental_b79527a1-a83d-4b23-82d5-a02b01638469);

PROC
PROC_BUGFIX_304849_CheckSummonsImmunity()
AND
DB_PlayerSummons(_Summon)
AND
GetTemplate(_Summon,_SummonTemplate)
AND
DB_BUGFIX_304849_ChasmImmuneRoots_Summons((ROOT)_SummonTemplate)
THEN
DB_BUGFIX_Marker("GUS-304849",_Summon);
SetTag(_Summon,(TAG)CHASM_IMMUNE_SWIM_b7018e56-3185-4dde-8605-48bd9e782969);

PROC
PROC_BUGFIX_304849_CheckSummonsImmunity()
AND
DB_BUGFIX_304849_ChasmImmuneRoots_Summons((ROOT)_Root)
THEN
NOT DB_BUGFIX_304849_ChasmImmuneRoots_Summons((ROOT)_Root);

//END_REGION GUS-304849


//REGION GUS-312032
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A") // check it see if players has at least reached Lowercity, therefore these 2 CTY potions should already exist
THEN
PROC_GLO_Bugfix_312032_CheckToPatchPotion((GUIDSTRING)7ef43db5-652c-44f9-9a75-aa9d8e924b1d, (ITEMROOT)91da7fe8-a5f7-4132-9096-e8da4916a42e, "GUS-304849-1"); // Potion in CTY_Main_A SorcerersSundries (in art level template)
PROC_GLO_Bugfix_312032_CheckToPatchPotion((GUIDSTRING)314db530-6245-4872-995b-4982be25b1df, (ITEMROOT)cc1a8802-675a-426b-a791-ec1d5a5b6328, "GUS-304849-2"); // Potion in CTY_Main_A

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("END_Main") // have gone to END, therefore this END potion should already exist.
THEN
PROC_GLO_Bugfix_312032_CheckToPatchPotion((GUIDSTRING)c5ea8498-065e-493f-8f7c-cb9ba8c500e0, (ITEMROOT)cc1a8802-675a-426b-a791-ec1d5a5b6328, "GUS-304849-3"); // Potion in END_Highhall_C

// if the potion exists at the point of patching, means they are in the same level as the potion, or is in the inventory, and has not beed used yet.
PROC
PROC_GLO_Bugfix_312032_CheckToPatchPotion((GUIDSTRING)_Potion, (ITEMROOT)_NewPotionTemplate, (STRING)_BugfixMarker)
AND
Exists(_Potion, 1) // if it exists, means its available in the current level or already in player's current inventory.
THEN
PROC_GLO_Bugfix_312032_TryCreateReplacementPotion(_Potion, _NewPotionTemplate, _BugfixMarker); // generate a new one and place in its spot.

// if the potion doesn't exist, it could because its in different level, or was already used.
PROC
PROC_GLO_Bugfix_312032_CheckToPatchPotion((GUIDSTRING)_Potion, (ITEMROOT)_NewPotionTemplate, (STRING)_BugfixMarker)
AND
Exists(_Potion, 0) // potion doesn't exist, therefore it could have already been used, or currently in a different level at the point of patching.
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", _BugfixMarker);
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "BGO_Main_A", _BugfixMarker);

// only the 2 CTY Potion could be moved into BGO and placed on the ground there, but players are in CTY when patching occurred. So we need to wait till they are back in BGO to check again there.
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304849-1")
THEN
PROC_GLO_Bugfix_312032_TryCreateReplacementPotion((GUIDSTRING)7ef43db5-652c-44f9-9a75-aa9d8e924b1d, (ITEMROOT)91da7fe8-a5f7-4132-9096-e8da4916a42e, "GUS-304849-1"); // Potion in CTY_Main_A SorcerersSundries (in art level template)

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-304849-1")
THEN
PROC_GLO_Bugfix_312032_TryCreateReplacementPotion((GUIDSTRING)7ef43db5-652c-44f9-9a75-aa9d8e924b1d, (ITEMROOT)91da7fe8-a5f7-4132-9096-e8da4916a42e, "GUS-304849-1"); // Potion in CTY_Main_A SorcerersSundries (in art level template)

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304849-2")
THEN
PROC_GLO_Bugfix_312032_TryCreateReplacementPotion((GUIDSTRING)314db530-6245-4872-995b-4982be25b1df, (ITEMROOT)cc1a8802-675a-426b-a791-ec1d5a5b6328, "GUS-304849-2"); // Potion in CTY_Main_A

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-304849-2")
THEN
PROC_GLO_Bugfix_312032_TryCreateReplacementPotion((GUIDSTRING)314db530-6245-4872-995b-4982be25b1df, (ITEMROOT)cc1a8802-675a-426b-a791-ec1d5a5b6328, "GUS-304849-2"); // Potion in CTY_Main_A

// If its in the world
PROC
PROC_GLO_Bugfix_312032_TryCreateReplacementPotion((GUIDSTRING)_OldPotion, (ITEMROOT)_NewPotionTemplate, (STRING)_BugfixMarker)
AND
NOT IsInInventory(_OldPotion, 1) // if its not in players inventory
AND
GetPosition(_OldPotion, _PosX, _PosY, _PosZ)
AND
NOT DB_BUGFIX_Marker(_BugfixMarker) // do this only once.
THEN
PROC_CreateAt(_NewPotionTemplate, _PosX, _PosY, _PosZ); // create a potion at the same spot as the old potion
RequestDelete((ITEM)_OldPotion); // delete the old potion
DB_BUGFIX_Marker(_BugfixMarker); // add a bugfix marker if any potion was patched

// If its in the player's inventory
PROC
PROC_GLO_Bugfix_312032_TryCreateReplacementPotion((GUIDSTRING)_OldPotion, (ITEMROOT)_NewPotionTemplate, (STRING)_BugfixMarker)
AND
IsInInventory(_OldPotion, 1) // if its already in players inventory
AND
GetDirectInventoryOwner(_OldPotion, _Owner) // get the owner of whoever is holding on to the potion
AND
NOT DB_BUGFIX_Marker(_BugfixMarker) // do this only once.
THEN
TemplateAddTo((ITEMROOT)_NewPotionTemplate, _Owner, 1, 0); // add the potion template to the former owner.
RequestDelete((ITEM)_OldPotion); // delete the old potion
DB_BUGFIX_Marker(_BugfixMarker); // add a bugfix marker if any potion was patched
//END_REGION

//REGION GUS-316534
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
DB_WYR_Circus_ClownPieces(_Item, _Flag,_,_)
AND
_Item != S_WYR_Circus_DribblesBodyPart_Hand_dedf021f-478c-4a06-9150-f442e1cd2ecd
AND
DB_Players((CHARACTER)_Char)
AND
NOT DB_WYR_Circus_ClownPieces_PickedPieces(_Item)
AND
GetFlag(_Flag, _Char, 1)
THEN
DB_WYR_Circus_ClownPieces_PickedPieces(_Item);
DB_BUGFIX_Marker("GUS-316534-A");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
DB_WYR_Circus_ClownPieces_PickedPieces(_Item)
THEN
DB_WYR_Circus_FoundClownCorpseVB_Played(_Item);
DB_BUGFIX_Marker("GUS-316534-B");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-316534-C");
DB_GLO_CompoundFlag((FLAG)WYR_Circus_State_ClownPiecesHasAny_4fec1a52-6650-a377-983c-04e2c01d84cf, WYR_Circus_State_ClownPiecesFoundAny_42d65dc1-e187-4484-8418-fec83083bff9);

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "BGO_Main_A", "GUS-316534-G");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-316534-G")
AND
IsInInventoryOf(S_WYR_Circus_DjinniWheelRing_f5b64ba3-3ad2-461d-a4e6-993aed1a738d, S_WYR_Circus_FortuneWheelWorker_21aa8a76-40ac-4d3a-881f-d6871487df6f, 1)
THEN
SetIsTradable(S_WYR_Circus_DjinniWheelRing_f5b64ba3-3ad2-461d-a4e6-993aed1a738d, TRADABLETYPE.NonTradable); // needs to be patched again, the value from the characters inventory overrode the property of the item
DB_BUGFIX_Marker("GUS-316534-G");
//END_REGION GUS-316534

//REGION GUS-308330
//Swapping Defeated to PermaDefeated
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
NOT DB_QuestDef_State_ConditionalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6,"PLA_GrandDukeRescue","PactBroken",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6,"PLA_GrandDukeRescue","PactBroken",0,(FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227,"PLA_GrandDukeRescue","MizoraHint",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227,"PLA_GrandDukeRescue","MizoraHint",0,(FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
NOT DB_CampNight_Requirement((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,(FLAG)WYLLAVATAR_b0d1be97-c501-4a9d-8718-e473210a4694,(FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_CampNight_Requirement((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,(FLAG)WYLLAVATAR_b0d1be97-c501-4a9d-8718-e473210a4694,(FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,(FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
DB_QuestDef_LevelLoaded("PLA_GrandDukeRescue","LeftAct_Duke","END_Main");
DB_BUGFIX_Marker("GUS-308330-Duke");

//Companion Wyll journal updates
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
NOT DB_QuestDef_State_ConditionalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_COM_Wyll","WyrmwaySolved",1,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_COM_Wyll","WyrmwaySolved",1,(FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_COM_Wyll","WyrmwayReportRavengard",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_COM_Wyll","WyrmwayReportRavengard",1,(FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);

NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd,"ORI_COM_Wyll","RavengardWyllGrandDuke",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1,"ORI_COM_Wyll","RavengardWyllFrontiers",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137,"ORI_COM_Wyll","RavengardWyllAvernus",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd,"ORI_COM_Wyll","RavengardWyllGrandDuke",1,(FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1,"ORI_COM_Wyll","RavengardWyllFrontiers",1,(FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137,"ORI_COM_Wyll","RavengardWyllAvernus",1,(FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);

NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd,"ORI_COM_Wyll","WyllGrandDuke",1,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1,"ORI_COM_Wyll","WyllFrontiers",1,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137,"ORI_COM_Wyll","WyllAvernus",1,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd,"ORI_COM_Wyll","WyllGrandDuke",1,(FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1,"ORI_COM_Wyll","WyllFrontiers",1,(FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137,"ORI_COM_Wyll","WyllAvernus",1,(FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6);

DB_QuestDef_LevelLoaded("ORI_COM_Wyll","ReachedEND","END_Main");
DB_QuestDef_LevelLoaded("ORI_COM_Wyll","LeftAct_Duke","END_Main");
DB_BUGFIX_Marker("GUS-308330-COM");


//Avatar Wyll journal updates
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
NOT DB_QuestDef_State_ConditionalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_Avatar_Wyll","WyrmwaySolved",1,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_Avatar_Wyll","WyrmwaySolved",1,(FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_Avatar_Wyll","WyrmwayReportRavengard",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_Avatar_Wyll","WyrmwayReportRavengard",1,(FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);

NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd,"ORI_Avatar_Wyll","RavengardWyllGrandDuke",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1,"ORI_Avatar_Wyll","RavengardWyllFrontiers",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137,"ORI_Avatar_Wyll","RavengardWyllAvernus",0,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd,"ORI_Avatar_Wyll","RavengardWyllGrandDuke",1,(FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1,"ORI_Avatar_Wyll","RavengardWyllFrontiers",1,(FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137,"ORI_Avatar_Wyll","RavengardWyllAvernus",1,(FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);

NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd,"ORI_Avatar_Wyll","WyllGrandDuke",1,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1,"ORI_Avatar_Wyll","WyllFrontiers",1,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137,"ORI_Avatar_Wyll","WyllAvernus",1,(FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_GrandDuke_0e223e4d-be63-89f4-380f-5cc755817abd,"ORI_Avatar_Wyll","WyllGrandDuke",1,(FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfFrontiers_8c46322f-7965-94c7-1318-62c391f1c8f1,"ORI_Avatar_Wyll","WyllFrontiers",1,(FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6);
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_Wyll_State_BladeOfAvernus_faeb73da-a609-dc56-7745-ac07f795c137,"ORI_Avatar_Wyll","WyllAvernus",1,(FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6);

DB_QuestDef_LevelLoaded("ORI_Avatar_Wyll","ReachedEND","END_Main");
DB_QuestDef_LevelLoaded("ORI_Avatar_Wyll","LeftAct_Duke","END_Main");
DB_BUGFIX_Marker("GUS-308330-Avatar");

//END_REGION

//REGION GUS-305115
//Companion Wyrmway change
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
NOT DB_QuestDef_BookReadState("ORI_COM_Wyll","WyrmwayFromBook",(ITEM)S_GLO_AnsurGhost_LegendOfAnsurBook_b0ecc3d5-85ad-48fa-bc47-988107507e6c);
NOT DB_QuestDef_State((FLAG)WYR_Balduran_Event_OpenDoor_99e8c929-4b71-3e03-2b43-6e7421896f7a,"ORI_COM_Wyll","WyrmwayReached");
DB_QuestDef_BookReadState("ORI_COM_Wyll","WyrmwaySubStarted",(ITEM)S_GLO_AnsurGhost_LegendOfAnsurBook_b0ecc3d5-85ad-48fa-bc47-988107507e6c);

DB_QuestDef_BookReadState("ORI_COM_Wyll","FromBook",(ITEM)S_GLO_AnsurGhost_LegendOfAnsurBook_b0ecc3d5-85ad-48fa-bc47-988107507e6c);
DB_QuestDef_State((FLAG)WYR_Wyrmway_State_InWyrmway_d4bc7aa7-82ff-5a3e-df31-8153b372839a,"ORI_COM_Wyll","Reached_Knows");
DB_QuestDef_State((FLAG)WYR_Balduran_Event_OpenDoor_99e8c929-4b71-3e03-2b43-6e7421896f7a,"ORI_COM_Wyll","TalkedStatue");
DB_QuestDef_State((FLAG)WYR_WyrmwayTrials_State_AllSucceeded_af019736-1d77-4609-a33b-dcd8360e5191,"ORI_COM_Wyll","PuzzlesSolved");
DB_QuestDef_State((FLAG)WYR_Wyrmway_State_EnteredLair_NoSolution_aa27b11f-0645-4591-b144-a225fe8067ed,"ORI_COM_Wyll","Entered_NoSolution");
DB_QuestDef_ChainedState("HIDDEN_BGO_Boosters","WYR_Wyrmway_SolvedTrials","ORI_COM_Wyll","Entered");
DB_QuestDef_State((FLAG)WYR_SkeletalDragon_State_Found_5150ff2a-2cee-4a57-bdca-02727a736a39,"ORI_COM_Wyll","DragonFound");
DB_QuestDef_State((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_COM_Wyll","DragonKilled");
DB_QuestDef_LevelLoaded("ORI_COM_Wyll","LeftAct_Wyrmway","END_Main");
DB_BUGFIX_Marker("GUS-305115-COM");

//Avatar Wyrmway change
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
NOT DB_QuestDef_BookReadState("ORI_Avatar_Wyll","WyrmwayFromBook",(ITEM)S_GLO_AnsurGhost_LegendOfAnsurBook_b0ecc3d5-85ad-48fa-bc47-988107507e6c);
NOT DB_QuestDef_State((FLAG)WYR_Balduran_Event_OpenDoor_99e8c929-4b71-3e03-2b43-6e7421896f7a,"ORI_Avatar_Wyll","WyrmwayReached");
DB_QuestDef_BookReadState("ORI_Avatar_Wyll","WyrmwaySubStarted",(ITEM)S_GLO_AnsurGhost_LegendOfAnsurBook_b0ecc3d5-85ad-48fa-bc47-988107507e6c);

DB_QuestDef_BookReadState("ORI_Avatar_Wyll","FromBook",(ITEM)S_GLO_AnsurGhost_LegendOfAnsurBook_b0ecc3d5-85ad-48fa-bc47-988107507e6c);
DB_QuestDef_State((FLAG)WYR_Wyrmway_State_InWyrmway_d4bc7aa7-82ff-5a3e-df31-8153b372839a,"ORI_Avatar_Wyll","Reached_Knows");
DB_QuestDef_State((FLAG)WYR_Balduran_Event_OpenDoor_99e8c929-4b71-3e03-2b43-6e7421896f7a,"ORI_Avatar_Wyll","TalkedStatue");
DB_QuestDef_State((FLAG)WYR_WyrmwayTrials_State_AllSucceeded_af019736-1d77-4609-a33b-dcd8360e5191,"ORI_Avatar_Wyll","PuzzlesSolved");
DB_QuestDef_State((FLAG)WYR_Wyrmway_State_EnteredLair_NoSolution_aa27b11f-0645-4591-b144-a225fe8067ed,"ORI_Avatar_Wyll","Entered_NoSolution");
DB_QuestDef_ChainedState("HIDDEN_BGO_Boosters","WYR_Wyrmway_SolvedTrials","ORI_Avatar_Wyll","Entered");
DB_QuestDef_State((FLAG)WYR_SkeletalDragon_State_Found_5150ff2a-2cee-4a57-bdca-02727a736a39,"ORI_Avatar_Wyll","DragonFound");
DB_QuestDef_State((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,"ORI_Avatar_Wyll","DragonKilled");
DB_QuestDef_LevelLoaded("ORI_Avatar_Wyll","LeftAct_Wyrmway","END_Main");
DB_BUGFIX_Marker("GUS-305115-Avatar");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
NOT DB_GlobalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c)
AND
DB_GlobalFlag((FLAG)WYR_AnsurGhost_Knows_ReadAnsurBook_f3b0cdca-7994-499f-bb8e-528240fdf0a3)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
QuestUpdate((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,"ORI_COM_Wyll","FromBook");
DB_BUGFIX_Marker("GUS-305115-COM-Open");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
NOT DB_GlobalFlag((FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c)
AND
DB_GlobalFlag((FLAG)WYR_AnsurGhost_Knows_ReadAnsurBook_f3b0cdca-7994-499f-bb8e-528240fdf0a3)
AND
DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
QuestUpdate((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,"ORI_Avatar_Wyll","FromBook");
DB_BUGFIX_Marker("GUS-305115-Avatar-Open");

//END_REGION

//REGION GUS-315164
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "BGO_Main_A", "GUS-315164");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315164")
THEN
DB_BUGFIX_Marker("GUS-315164");
DB_WYR_OpenHandCave_EntranceBoulders((ITEM)S_WYR_OpenHandCave_EntranceBoulder_01_88f670bc-92c4-4754-854a-0d6fdf0e7b96);
DB_WYR_OpenHandCave_EntranceBoulders((ITEM)S_WYR_OpenHandCave_EntranceBoulder_02_00da9a74-38d0-4811-9e81-ebcb6170d4ba);
PROC_SetOnStage(S_WYR_OpenHandCave_EntranceBoulder_004_f3d9edb8-a10a-43c2-a274-af7c9ba94ead, 0); // This is anti-patching: we dont want to put a rock where player may have characters or items
PROC_SetOnStage(S_WYR_OpenHandCave_EntranceBoulder_005_d66e68ef-17cd-41e4-8fae-2f1d2ce37e98, 0);
//END_REGION

//REGION GUS-316878

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "BGO_Main_A", "GUS-316878");
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-316878");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-316878")
THEN
TeleportToPosition(S_CAMP_FARM_Mizora_e1dd2822-3c52-4995-bdcc-86485b27c24a, 384.253, 5.758, -751.87);
DB_BUGFIX_Marker("GUS-316878-a");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316878")
THEN
TeleportToPosition(S_CAMP_ELFSONG_Mizora_4fdcf21b-0d9d-4336-a6c3-2f6dd1c57d02, -1591.371, 3.681, 781.116);
TeleportToPosition(S_CAMP_SLUMS_Mizora_c62e3caa-769c-4182-b749-d047e8488396, -1435.719, 7.039, -2584.68);
DB_BUGFIX_Marker("GUS-316878-b");

//END_REGION

//REGION GUS-315239
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "BGO_Main_A", "GUS-315239");

// one incinerator has its helper & trigger at incorrect positions
// another one wasn't in the DB and wasn't receving ACTIVE status
// plus, an update for a position of a helper
PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315239")
THEN
DB_BUGFIX_Marker("GUS-315239");
TeleportToPosition(S_WYR_PUZ_Gortash_Office_Incinerator_01_Box_4b2a8fdf-3e4e-4ce7-be4f-b8c20df0fbcf, -18.861, 73.011, 215.353, "", 0, 0, 0, 0, 0);
TeleportToPosition(S_WYR_PUZ_Gortash_Office_Incinerator_01_Helper_6d95a757-0078-4e45-95df-6789fc7f9fcd, -19.012, 73.011, 215.524, "", 0, 0, 0, 0, 0);
TeleportToPosition(S_WYR_PUZ_Gortash_Office_Incinerator_08_Helper_5ae147c5-8998-43f0-9f40-4dfe20c0c6d6, -12.228, 73.011, 214.098, "", 0, 0, 0, 0, 0);
DB_WYR_Gortash_Incinerators(S_WYR_PUZ_Gortash_Office_Incinerator_08_8da32daa-27e6-4b68-95ed-c9ad84b58fda,S_WYR_PUZ_Gortash_Office_Incinerator_08_Helper_5ae147c5-8998-43f0-9f40-4dfe20c0c6d6);

// add "ACTIVE" status to grenade launchers and incinerators if they are in combat
PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315239")
AND
DB_WYR_Gortash_Incinerators(_Item, _)
AND
DB_Is_InCombat(_Item, _)
AND
HasActiveStatus(_Item, "WYR_GORTASH_ACTIVE_INCINERATOR", 0)
THEN
ApplyStatus(_Item, "WYR_GORTASH_ACTIVE_INCINERATOR", -1.0);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315239")
AND
DB_WYR_Gortash_GrLaunchers(_Item)
AND
IsInCombat(_Item, 1)
AND
HasActiveStatus(_Item, "WYR_GORTASH_ACTIVE_GRENADELAUNCHER", 0)
THEN
ApplyStatus(_Item, "WYR_GORTASH_ACTIVE_GRENADELAUNCHER", -1.0);

// remove "ACTIVE" status from grenade launchers and incinerators if they aren't in combat
PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315239")
AND
DB_WYR_Gortash_Incinerators(_Item, _)
AND
NOT DB_Is_InCombat(_Item, _)
AND
HasActiveStatus(_Item, "WYR_GORTASH_ACTIVE_INCINERATOR", 1)
THEN
RemoveStatus(_Item, "WYR_GORTASH_ACTIVE_INCINERATOR");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315239")
AND
DB_WYR_Gortash_GrLaunchers(_Item)
AND
IsInCombat(_Item, 0)
AND
HasActiveStatus(_Item, "WYR_GORTASH_ACTIVE_GRENADELAUNCHER", 1)
THEN
RemoveStatus(_Item, "WYR_GORTASH_ACTIVE_GRENADELAUNCHER");

// disable shield capacitors if they aren't in the same combat as Gortash
PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315239")
AND
DB_WYR_Gortash_ShCap(_Item)
AND
IsInCombat(_Item, 0)
AND
HasActiveStatus(_Item, "WYR_GORTASH_ACTIVE_SHIELDCAPACITOR", 1)
THEN
RemoveStatus(_Item, "WYR_GORTASH_ACTIVE_SHIELDCAPACITOR", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315239")
AND
DB_WYR_Gortash_ShCap(_Item)
AND
IsInCombat(_Item, 1)
AND
CombatGetGuidFor(_Item, _CombatID)
AND
NOT DB_Is_InCombat(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _CombatID)
AND
HasActiveStatus(_Item, "WYR_GORTASH_ACTIVE_SHIELDCAPACITOR", 1)
THEN
RemoveStatus(_Item, "WYR_GORTASH_ACTIVE_SHIELDCAPACITOR", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315239")
AND
DB_WYR_Gortash_ShCap_Broken(_Item)
AND
IsInCombat(_Item, 0)
AND
HasActiveStatus(_Item, "WYR_GORTASH_ACTIVE_SHIELDCAPACITOR_MALFUNCTIONING", 1)
THEN
RemoveStatus(_Item, "WYR_GORTASH_ACTIVE_SHIELDCAPACITOR_MALFUNCTIONING", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-315239")
AND
DB_WYR_Gortash_ShCap_Broken(_Item)
AND
IsInCombat(_Item, 1)
AND
CombatGetGuidFor(_Item, _CombatID)
AND
NOT DB_Is_InCombat(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _CombatID)
AND
HasActiveStatus(_Item, "WYR_GORTASH_ACTIVE_SHIELDCAPACITOR_MALFUNCTIONING", 1)
THEN
RemoveStatus(_Item, "WYR_GORTASH_ACTIVE_SHIELDCAPACITOR_MALFUNCTIONING", NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION GUS-315319
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
DB_PartOfTheTeam((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
DB_BUGFIX_Marker("GUS-315319_RavengardPartOfTheTeam");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_GortashBecameArchduke_b91a5012-d49b-429d-9b86-b75686fa7582)
AND
NOT DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_RavengardForceRemoval_cda5ec5a-5614-45d5-aa60-f99e210dab5d)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a) //It's possible to get him in camp in this state if you kill him and have Mizora resurrect him, or if you blow up the Iron Throne and then have Mizora resurrect him
AND
NOT DB_LevelUnreachable("BGO_Main_A")
THEN
PROC_ApplySavegamePatches_GUS_315319_CheckRavengardFix();

//If there are no players in the audience hall, remove Ravengard from there
PROC
PROC_ApplySavegamePatches_GUS_315319_CheckRavengardFix()
AND
DB_CurrentLevel("BGO_Main_A")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d) //If Wyll is not part of the team, rely on Fallback to mimic original logic
AND
NOT QRY_AnyPlayerInTrigger(S_WYR_WyrmRock_AudienceHallArea_a078f420-9f5e-452b-9391-e96e754b61c8)
THEN
PROC_ApplySavegamePatches_GUS_315319_CheckIRNState();
DB_BUGFIX_Marker("GUS-315319_BGO_NoPlayerInAudienceHallArea");

//If there is at least one player, wait for all players to leave and then move him out
PROC
PROC_ApplySavegamePatches_GUS_315319_CheckRavengardFix()
AND
DB_CurrentLevel("BGO_Main_A")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d) //If Wyll is not part of the team, rely on Fallback to mimic original logic
AND
QRY_AnyPlayerInTrigger(S_WYR_WyrmRock_AudienceHallArea_a078f420-9f5e-452b-9391-e96e754b61c8)
AND
QRY_OnlyOnce("GUS_315319_WaitForAllPlayersToLeaveAudienceHall")
THEN
DB_TriggerEvents_AllPartyMembersLeft(S_WYR_WyrmRock_AudienceHallArea_a078f420-9f5e-452b-9391-e96e754b61c8, "WYR_KillDirectorGortash_WaitForAllPartyMembersToLeaveAudienceHall_SavegamePatch"); //Different from normal trigger event in order to account for Iron Throne being already destroyed
DB_BUGFIX_Marker("GUS-315319_BGO_WaitToLeaveAudienceHallArea");

IF
EntityEvent(_, "WYR_KillDirectorGortash_WaitForAllPartyMembersToLeaveAudienceHall_SavegamePatch")
AND
QRY_OnlyOnce("WYR_KillDirectorGortash_WaitForAllPartyMembersToLeaveAudienceHall_SavegamePatch")
THEN
PROC_ApplySavegamePatches_GUS_315319_CheckIRNState();
NOT DB_TriggerEvents_AllPartyMembersLeft(S_WYR_WyrmRock_AudienceHallArea_a078f420-9f5e-452b-9391-e96e754b61c8, "WYR_KillDirectorGortash_WaitForAllPartyMembersToLeaveAudienceHall_SavegamePatch");

PROC
PROC_ApplySavegamePatches_GUS_315319_CheckRavengardFix()
AND
NOT DB_CurrentLevel("BGO_Main_A") //Could be CTY or IRN
//We don't check for Wyll here at all
AND
DB_WYR_KillDirectorGortash_CeremonyAutoCompletionConditions(_Flag)
AND
DB_GlobalFlag(_Flag)
AND
NOT DB_OnlyOnce("WYR_KillDirectorGortash_CeremonyAftermath")
AND
QRY_OnlyOnce("GUS_315319_QueueUpFixToEndCeremonyInBGO")
THEN
PROC_ApplySavegamePatches_GUS_315319_CheckIRNState();
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6","BGO_Main_A","GUS-315319_EndRestOfCeremonyInBGO");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A","GUS-315319_EndRestOfCeremonyInBGO")
THEN
DB_OnlyOnce("WYR_KillDirectorGortash_CeremonyAftermath");
PROC_GlobalSetFlagAndCache((FLAG)WYR_KillDirectorGortash_State_CeremonyEnded_9aeab401-c087-4f2e-9894-859df23680dc);
PROC_WYR_KillDirectorGortash_RemoveServantsFromAudienceHall();
PROC_WYR_KillDirectorGortash_RemovePatriarsFromAudienceHall();
PROC_WYR_KillDirectorGortash_ReplaceFlamingFistsInAudienceHall();
PROC_WYR_KillDirectorGortash_ReplaceBodyguardsInOffice();
DB_BUGFIX_Marker("GUS-315319_NotBGO_EndRestOfCreemonyInBGO");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A","GUS-315319_EndRestOfCeremonyInBGO")
AND
NOT DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
THEN
PROC_WYR_KillDirectorGortash_TeleportGortashToOffice();
DB_BUGFIX_Marker("GUS-315319_NotBGO_EndRestOfCreemonyInBGO_GortashMoveToOffice");

PROC
PROC_ApplySavegamePatches_GUS_315319_CheckIRNState()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
AND
DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227)
THEN
DB_PreventPermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
SetFlag((FLAG)CAMP_Mizora_State_WantsToResurrectRavengardAfterIRNDestruction_ac394670-1bb9-4e9e-92dc-8fa9382d4a64);

PROC
PROC_ApplySavegamePatches_GUS_315319_CheckIRNState()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
THEN
SetFlag(WYR_KillDirectorGortash_State_RavengardForceRemoval_cda5ec5a-5614-45d5-aa60-f99e210dab5d, NULL_00000000-0000-0000-0000-000000000000, 0, 0); //Don't sent flag event
Die(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
PROC_SetOnStage(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 0);
DB_BUGFIX_Marker("GUS-315319_NotBGO_RavengardDeadAfterIrnIsDestroyed");

PROC
PROC_ApplySavegamePatches_GUS_315319_CheckIRNState()
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
THEN
SetFlag(WYR_KillDirectorGortash_State_RavengardForceRemoval_cda5ec5a-5614-45d5-aa60-f99e210dab5d, NULL_00000000-0000-0000-0000-000000000000, 0, 0); //Don't sent flag event
PROC_TriggerUnregisterForPlayers(S_WYR_KillDirectorGortash_RavengardRemovalArea_244e4e54-52bd-4812-bac7-6206166e5195);
PROC_ForceStopDialog(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
SetCanFight(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
SetCanJoinCombat(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
PROC_WYR_KillDirectorGortash_RemoveRavengardFromAudienceHall();
DB_BUGFIX_Marker("GUS-315319_NotBGO_RavengardMovedToIrnBeforeStarted");

PROC
PROC_ApplySavegamePatches_GUS_315319_CheckIRNState()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
THEN
SetFlag(WYR_KillDirectorGortash_State_RavengardForceRemoval_cda5ec5a-5614-45d5-aa60-f99e210dab5d, NULL_00000000-0000-0000-0000-000000000000, 0, 0); //Don't sent flag event
PROC_TriggerUnregisterForPlayers(S_WYR_KillDirectorGortash_RavengardRemovalArea_244e4e54-52bd-4812-bac7-6206166e5195);
PROC_ForceStopDialog(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
SetCanFight(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
SetCanJoinCombat(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
PROC_WYR_KillDirectorGortash_RemoveRavengardFromAudienceHall();
PROC_IRN_SetupRavengard();
DB_BUGFIX_Marker("GUS-315319_NotBGO_RavengardMovedToIrnWhileOngoing");
//END_REGION

//REGION GUS-317383
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
THEN
DB_QuestDef_State((FLAG)GLO_Tadpole_Event_AstralTouchedTadpoleDestroyed_7c43d181-2bb0-ed4d-5fed-c19752617955, "GLO_UnleashPowers", "NotUsedAstralTadpole");
DB_BUGFIX_Marker("GUS-317383");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)GLO_Tadpole_Event_AstralTouchedTadpoleDestroyed_7c43d181-2bb0-ed4d-5fed-c19752617955)
THEN
QuestUpdate("GLO_UnleashPowers", "NotUsedAstralTadpole");
DB_BUGFIX_Marker("GUS-317383");
//END_REGION

//REGION GUS-316622
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "BGO_Main_A", "GUS-316622");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-316622")
THEN
DB_BUGFIX_Marker("GUS-316622");
TeleportToPosition(PUZ_GEN_Trap_Gaspit_Cave_A_002_8a1b4277-bf2a-4007-91cf-93eb05695d0c, 88.483, -13.336, -1009.422);
TeleportToPosition(S_WYR_WyrmRock_Roof_StunTrap_008_b66b9fb1-9377-4a58-83c8-6c40c3cfb38c, -15.833, 84.981, 207.35);
//END_REGION GUS-316622

//REGION GUS-275155
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "BGO_Main_A", "GUS-275155");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-275155")
AND
NOT DB_PermaDefeated(S_WYR_RefugeeCamp_Refugee_13_c077fb56-7f29-4693-8ebf-3571a01d689b)
THEN
PROC_SetAnubisConfig(S_WYR_RefugeeCamp_Refugee_13_c077fb56-7f29-4693-8ebf-3571a01d689b, "WYR_RefugeeCamp_Refugee_13_Patch7");
DB_BUGFIX_Marker("GUS-275155-A");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-275155")
AND
Exists(S_WYR_RefugeeCamp_Kitchen_Pot_Cauldron_Covered_A_012_d95d0666-ae6c-41ff-8dc7-1ea184d4ffc2, 1)
AND
IsDestroyed(S_WYR_RefugeeCamp_Kitchen_Pot_Cauldron_Covered_A_012_d95d0666-ae6c-41ff-8dc7-1ea184d4ffc2, 0)
AND
IsInInventory(S_WYR_RefugeeCamp_Kitchen_Pot_Cauldron_Covered_A_012_d95d0666-ae6c-41ff-8dc7-1ea184d4ffc2, 0)
THEN
PROC_SetOnStage(S_WYR_RefugeeCamp_Kitchen_Pot_Cauldron_Covered_A_012_d95d0666-ae6c-41ff-8dc7-1ea184d4ffc2, 0);
DB_BUGFIX_Marker("GUS-275155-B");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-275155")
AND
NOT DB_PermaDefeated(S_DEN_Trainee_002_bd7f31a6-98e8-46cd-97be-4347fa45d387)
THEN
PROC_SetAnubisConfig(S_DEN_Trainee_002_bd7f31a6-98e8-46cd-97be-4347fa45d387, "WYR_TieflingRefugee_Trainee_002_Patch7");
DB_BUGFIX_Marker("GUS-275155-C");
//END_REGION GUS-275155

//REGION GUS-314212
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A") // haven't left act 3.
THEN
DB_BUGFIX_Marker("GUS-314212");
PROC_GLO_Bugfix_305346_RestoreOrin(); // this issue is similar to 305346, so we can reuse this PROC to restore Orin.
//END_REGION

//REGION GUS-306256
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
THEN
DB_Act3_FlorrickExecution_MeddleWithHangedBody_DamageTypeWhitelist("Psychic");
DB_Act3_FlorrickExecution_MeddleWithHangedBody_DamageTypeWhitelist("Necrotic");
DB_Act3_FlorrickExecution_MeddleWithHangedBody_DamageTypeWhitelist("Poison");
DB_BUGFIX_Marker("GUS-306256");
//END_REGION GUS-306256

//REGION GUS-319160
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
THEN
PROC_ORI_Wyll_Bugfix_ClearLingeringCRDs();

PROC
PROC_ORI_Wyll_Bugfix_ClearLingeringCRDs()
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0,_,_,_)
AND
QRY_ORI_Wyll_Bugfix_ClearLingeringCRDs((FLAG)Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0);
DB_BUGFIX_Marker("GUS-319160");

PROC
PROC_ORI_Wyll_Bugfix_ClearLingeringCRDs()
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_DiscussedLemure_b9e7a27f-b1a3-6f3b-32e7-dddbf17d589c,_,_,_)
AND
DB_GlobalFlag((FLAG)COL_MizorasRescue_State_SavedMizora_148bcec2-5367-2b72-3c93-29fb32fc0181)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_DiscussedLemure_b9e7a27f-b1a3-6f3b-32e7-dddbf17d589c);
DB_BUGFIX_Marker("GUS-319160");

PROC
PROC_ORI_Wyll_Bugfix_ClearLingeringCRDs()
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c,_,_,_)
AND
QRY_ORI_Wyll_Bugfix_ClearLingeringCRDs((FLAG)Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c);
DB_BUGFIX_Marker("GUS-319160");

QRY
QRY_ORI_Wyll_Bugfix_ClearLingeringCRDs((FLAG)Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0)
AND
DB_GlobalFlag((FLAG)ORI_Wyll_State_AwaitingJudgement_fc1db24a-f2c5-4ac2-a807-6acc320ac98b)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Wyll_Bugfix_ClearLingeringCRDs((FLAG)Wyll_InParty2_Event_PostConfrontation_eb938f58-a165-503d-660e-6498218d18c0)
AND
DB_GlobalFlag((FLAG)CAMP_MizorasJudgement_Event_Judged_c6d2140f-312d-65d4-e66e-92de4258b3f4)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Wyll_Bugfix_ClearLingeringCRDs((FLAG)Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Wyll_Bugfix_ClearLingeringCRDs((FLAG)Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c)
AND
DB_GlobalFlag((FLAG)LOW_FlorrickFight_Event_FlorrickFightStarted_dd53d2e3-09f8-edaf-162c-1ecd6a2f27d3)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Wyll_Bugfix_ClearLingeringCRDs((FLAG)Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c)
AND
DB_GlobalFlag((FLAG)LOW_FlorrickFighFallback_Event_Occurred_06b38288-ee5f-630c-153d-39c2e90ae55f)
THEN
DB_NOOP(1);

//END_REGION

//REGION GUS-308153
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "BGO_Main_A", "GUS-308153");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-308153")
THEN
PROC_SetOnStage(PUZ_Trap_Gortash_ShieldCapacitor_000_f548f678-6e8b-496f-a5d9-3cdd7abb3cde, 0);
PROC_SetOnStage(PUZ_Trap_Gortash_GrenadeInstantiator_007_a39fa5e2-90cb-48be-b1fe-ce2c18f63691, 0);
PROC_SetOnStage(PUZ_Trap_Gortash_GrenadeInstantiator_006_f6695ac3-02b3-414e-87e4-a3cf6c6eba0b, 0);
PROC_SetOnStage(PUZ_Trap_Gortash_ShieldCapacitor_003_f3a194c7-d87e-44d2-a3fe-a707d2e7c707, 0);
PROC_SetOnStage(PUZ_Trap_Gortash_ShieldCapacitor_002_7ea8300e-afb6-49c9-b2c1-086abae80905, 0);
PROC_SetOnStage(PUZ_Trap_Gortash_GrenadeInstantiator_003_256e2f97-7d59-4498-a26c-5f304a345439, 0);
PROC_SetOnStage(PUZ_Trap_Gortash_GrenadeInstantiator_002_16fb8595-fcf0-4ac9-b643-6a047739256a, 0);
PROC_SetOnStage(PUZ_Trap_Gortash_ShieldCapacitor_001_52038f5b-9922-448f-9855-cbba35775a6b, 0);
//END_REGION GUS-308153

//REGION GUS-319900
// EnvelopedLetters should be off stage
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "BGO_Main_A", "GUS-319900");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-319900")
AND
DB_WYR_Posthouse_EnvelopedLetters(_Envelope, _Letter)
AND
NOT DB_WYR_Posthouse_RemovingEnvelope(_Envelope)
AND
NOT DB_OffStage(_Letter)
THEN
PROC_SetOnStage(_Letter, 0);
DB_SavegamePatch_GUS319900_DroppingLetter(_Letter);
DB_BUGFIX_Marker("GUS-319900", _Letter);

IF
WentOnStage(_Letter, 0)
AND
DB_SavegamePatch_GUS319900_DroppingLetter((ITEM)_Letter)
AND
IsInInventory(_Letter, 1)
THEN
Drop(_Letter);

IF
WentOnStage(_Letter, 0)
AND
DB_SavegamePatch_GUS319900_DroppingLetter((ITEM)_Letter)
THEN
NOT DB_SavegamePatch_GUS319900_DroppingLetter(_Letter);
//END_REGION GUS-319900


//REGION GUS-319629
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
NOT DB_PermaDefeatedFlag(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, (FLAG)GLO_GithKnight_State_PermaDefeated_c354b407-b88d-4920-96a2-80555d6fc0b0)
THEN
DB_PermaDefeatedFlag(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, (FLAG)GLO_GithKnight_State_PermaDefeated_c354b407-b88d-4920-96a2-80555d6fc0b0);
DB_BUGFIX_Marker("GUS-319629");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_PermaDefeated(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
THEN
SetFlag(GLO_GithKnight_State_PermaDefeated_c354b407-b88d-4920-96a2-80555d6fc0b0, NULL_00000000-0000-0000-0000-000000000000, 0, 0);
//END_REGION GUS-319629

//REGION GUSX-1328
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "BGO_Main_A", "GUSX-1328");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUSX-1328")
AND
DB_WYR_Gortash_Incinerators(_Turret, _)
THEN
SetCanJoinCombat(_Turret, 1);
//END_REGION GUSX-1328

//REGION GUSX-7034
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
CrimeGetNewID(_HighestCrimeID)
THEN
PROC_BUGFIX_GUSX_7034_CheckCrime(_HighestCrimeID);

PROC
PROC_BUGFIX_GUSX_7034_CheckCrime((INTEGER)_HighestCrimeID)
AND
_HighestCrimeID < 65000
AND
QRY_DoNTimes(_HighestCrimeID)
AND
DB_QRY_RTN_DoNTimes(_CrimeID)
AND
CrimeGetType(_CrimeID, "WYR_RefugeeCamp_BigBarnTrespass")
AND
CrimeGetEvidence(_CrimeID, 1, NULL_00000000-0000-0000-0000-000000000000)
THEN
PROC_BUGFIX_GUSX_7034_StopCrime(_CrimeID);

PROC
PROC_BUGFIX_GUSX_7034_CheckCrime((INTEGER)_HighestCrimeID)
AND
_HighestCrimeID >= 65000
THEN
DB_BUGFIX_Marker("GUSX-7034_FixOnConfrontationDone");

IF
OnCrimeConfrontationDone(_CrimeID, _Guard, _, _Player, _, _, _)
AND
DB_BUGFIX_Marker("GUSX-7034_FixOnConfrontationDone")
AND
CrimeGetType(_CrimeID, "WYR_RefugeeCamp_BigBarnTrespass")
AND
CrimeGetEvidence(_CrimeID, 1, NULL_00000000-0000-0000-0000-000000000000)
THEN
PROC_BUGFIX_GUSX_7034_StopCrime(_CrimeID);

PROC
PROC_BUGFIX_GUSX_7034_StopCrime((INTEGER)_CrimeID)
AND
DB_Crime_CombatID(_CrimeID, _CombatID)
THEN
EndCombat(_CombatID);

PROC
PROC_BUGFIX_GUSX_7034_StopCrime((INTEGER)_CrimeID)
THEN
DB_BUGFIX_Marker("GUSX-7034");
PROC_CRIME_StopForAllCriminals(_CrimeID);
//END_REGION GUSX-7034

//REGION GUSX-5315
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "BGO_Main_A", "GUSX-5315");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUSX-5315")
AND
NOT DB_PermaDefeatedOrOffstage(S_WYR_Circus_EntranceGuard_63ef213e-7a72-4126-9d5f-2f7d60ee9178)
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_Checkpoint_State_GainedAccess_6c332552-395f-6f80-a0e7-d2450ab0812d)
THEN
DB_BUGFIX_Marker("GUSX-5315");
SetTag(S_WYR_Circus_EntranceGuard_63ef213e-7a72-4126-9d5f-2f7d60ee9178, (TAG)ACT3_WYR_CIRCUS_CANTOPEN_FRONTGATE_a26aebde-e284-4ee6-8103-79fcea12fe95);
//END_REGION GUSX-5315

//REGION GUSX-1325
//If the night triggered, but the dialog did not start, queue the night again
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_CampNight_Completed((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Wyll_Act3Romance_Event_Began_cb51446f-3a3e-62e7-00ee-0484f90f64b7)
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUSX-1325_ReaddCampNight");
NOT DB_CampNight_Completed((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231);
DB_CampNight((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,4090);
DB_CampNight_Camp((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,"FARM");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,"SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,"ELFSONG");
DB_CampNight_Requirement_Partner((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381,(FLAG)CAMP_Wyll_Act3Romance_Event_CanStart_d27dc3e6-e856-4e87-8140-a25f4d5ba57d);
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381,(FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac,(FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381,(FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac,(FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1);
DB_CampNight_CRD((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)CAMP_Wyll_CRD_Act3Romance_599fe884-f39f-a3b5-7a86-ca239e016a05,(FLAG)NULL_00000000-0000-0000-0000-000000000000);

//Reduce the time a little to reduce player confusion for it not happening immediately (only an issue if you save Ravengard and defeat Ansur in the same day or two - for most players it would already trigger immediately after Ansur)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LongRestCountDown(2,CAMP_Wyll_Act3Romance_Event_CanStart_d27dc3e6-e856-4e87-8140-a25f4d5ba57d)
THEN
DB_BUGFIX_Marker("GUSX-1325_ReducedLongRestCountdown");
NOT DB_LongRestCountDown(2,CAMP_Wyll_Act3Romance_Event_CanStart_d27dc3e6-e856-4e87-8140-a25f4d5ba57d);
DB_LongRestCountDown(1,CAMP_Wyll_Act3Romance_Event_CanStart_d27dc3e6-e856-4e87-8140-a25f4d5ba57d);

//END_REGION

//REGION GUSX-576
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_DialogName((DIALOGRESOURCE)WYR_KillDirectorGortash_NetherbrainMindmeld_673f3fd9-0e41-8d53-153b-72af69991378, _DialogID)
AND
DB_DialogNPCs(_DialogID, _NotPlayerAnymore, _)
AND
DB_DialogRequestCache_SpeakerList_Players((DIALOGRESOURCE)WYR_KillDirectorGortash_NetherbrainMindmeld_673f3fd9-0e41-8d53-153b-72af69991378, _DialogID, _NotPlayerAnymore, _)
THEN
PROC_ForceStopDialog(_NotPlayerAnymore);
DB_BUGFIX_Marker("GUSX-576");
//END_REGION GUSX-576

//REGION GUSX-1854
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag(WYR_KillDirectorGortash_State_GortashBecameArchduke_b91a5012-d49b-429d-9b86-b75686fa7582)
AND
NOT ObjectGetTitle(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, "WYR_KillDirectorGortash_GortashAfterCeremony")
THEN
DB_BUGFIX_Marker("GUSX-1854");
ObjectSetTitle(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, "WYR_KillDirectorGortash_GortashAfterCeremony");
//END_REGION

//REGION GUSX-591
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_InCamp(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
AND
DB_GlobalFlag(CAMP_Yenna_State_PostAbductionCampChat_d30c5b6a-eada-4c8c-927d-a50de178ec29)
THEN
DB_BUGFIX_Marker("GUSX-591");
UnregisterAsCompanion((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
DB_GLO_Bugfix_GUSX_591_MoveNonFoodToCampChest_WaitLevelLoaded(1);

IF
UserCampChestChanged(_, _)
AND
DB_GLO_Bugfix_GUSX_591_MoveNonFoodToCampChest_WaitLevelLoaded(1)
THEN
NOT DB_GLO_Bugfix_GUSX_591_MoveNonFoodToCampChest_WaitLevelLoaded(1);
PROC_Bugfix_GUSX_591_MoveNonFoodToCampChest();

PROC
PROC_Bugfix_GUSX_591_MoveNonFoodToCampChest()
THEN
IterateInventory(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, "LOW_BhaalTemple_Yenna_Inventory_MoveToChest", "LOW_BhaalTemple_Yenna_Inventory_MoveToChest_Finished");

IF
EntityEvent((ITEM)_Item, "LOW_BhaalTemple_Yenna_Inventory_MoveToChest")
AND
GetHostCharacter(_HostPlayer)
AND
QRY_Bugfix_GUSX_591_CheckValidToMove(_Item, _HostPlayer)
THEN
DB_NOOP(1);

QRY
QRY_Bugfix_GUSX_591_CheckValidToMove((ITEM)_Item, (CHARACTER)_HostPlayer)
AND
IsTagged(_Item, (TAG)FOOD_c86e0114-a5ab-48f6-b497-de321ebff577, 0)
THEN
SendToCampChest(_Item, _HostPlayer);

QRY
QRY_Bugfix_GUSX_591_CheckValidToMove((ITEM)_Item, (CHARACTER)_HostPlayer)
AND
IsTagged(_Item, (TAG)FOOD_c86e0114-a5ab-48f6-b497-de321ebff577, 1)
AND
IsStoryItem(_Item, 1)
THEN
SendToCampChest(_Item, _HostPlayer);
//END_REGION

//REGION GUSX-7714
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("END_Main")
THEN
DB_BUGFIX_Marker("GUSX-7714");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_FLAMINGFISTALLYINTERDICTED", "END_ALLYABILITIES_FLAMINGFISTALLYCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_HARPERABILITYINTERDICTED", "END_ALLYABILITIES_HARPERALLIESCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_WATCHALLIESINTERDICTED", "END_ALLYABILITIES_WATCHALLIESCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILTIES_KEENEALLIESINTERDICTED", "END_ALLYABILTIES_KEENEALLIESCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_VETERANALLIESINTERDICTED", "END_ALLYABILITIES_VERTERANALLIESCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_GURALLIESINTERDICTED", "END_ALLYABILITIES_GURALLIESCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_VAMPIREALLIESINTERDICTED", "END_ALLYABILTIES_VAMPIREALLIESCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILTIES_ZHENTARIMALLIESINTERDICTED", "END_ALLYABILTIES_ZHENTARIMALLIESCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_GRENADIERALLIESINTERDICTED", "END_ALLYABILITIES_GRENADIERALLIESCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_SHARALLIESINTERDICTED", "END_ALLYABILITIES_SHARALLIESCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_WATCHERALLYINTERDICTED", "END_ALLYABILITIES_WATCHERALLYCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_ORTHONALLYINTERDICTED", "END_ALLYABILITIES_ORTHONALLYCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_NIGHTSONGALLYINTERDICTED", "END_ALLYABILITIES_NIGHTSONGALLYCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_OWLBEARALLYINTERDICTED", "END_ALLYABILITIES_OWLBEARALLYCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_PHASMALLYINTERDICTED", "END_ALLYABILITIES_PHASMALLYCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_MIZORAALLYINTERDICTED", "END_ALLYABILITIES_MIZORAALLYCONSUMED");
PROC_Bugfix_GUSX_7714_FixAllyStatus("END_ALLYABILITIES_KUOTOAINTERDICTED", "END_ALLYABILITIES_KUOTOACONSUMED");
PROC_Bugfix_GUSX_7714_FixDeadAllyInParty((CHARACTER)S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674);
PROC_Bugfix_GUSX_7714_FixDeadAllyInParty((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
PROC_Bugfix_GUSX_7714_FixDeadAllyInParty((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_Bugfix_GUSX_7714_FixDeadAllyInParty((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);
PROC_Bugfix_GUSX_7714_FixDeadAllyInParty((CHARACTER)S_GLO_DevilishOx_49eb5b4b-c6ed-4d37-8f68-97b1128b7d56);
PROC_Bugfix_GUSX_7714_FixDeadAllyInParty((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);

PROC
PROC_Bugfix_GUSX_7714_FixAllyStatus((STRING)_InterdictingStatus, (STRING)_ConsumeStatus)
AND
DB_PartyMembers((CHARACTER)_Character)
AND
HasActiveStatus(_Character, _InterdictingStatus, 1)
AND
HasActiveStatus(_Character, _ConsumeStatus, 1)
THEN
RemoveStatus(_Character, _InterdictingStatus, _Character);


PROC
PROC_Bugfix_GUSX_7714_FixDeadAllyInParty((CHARACTER)_Ally)
AND
IsPartyFollower(_Ally, 1)
AND
IsDead(_Ally, 1)
AND
CharacterGetOwner((CHARACTER)_Ally,_Character)
THEN
RemovePartyFollower(_Ally, _Character);

//END_REGION

//REGION GUSX-9728
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_LevelLoadedOnce("END_Main")
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9)
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
AND
IsInInventoryOf(S_GLO_PuzzleBox_326324f9-0920-8f0f-3e85-3781fbf48282, _TargetChar, 1)
THEN
DB_BUGFIX_Marker("GUSX-9728", _TargetChar);
PROC_GLO_InfernalBox_SendToAvatarFrom(_TargetChar);
//END_REGION GUSX-9728

//REGION GUSX-9144 (WYR)
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "BGO_Main_A", "GUSX-9144-WYR");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUSX-9144-WYR")
THEN
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RoughSleepers_HalfOrc_03dc8542-1d40-471b-89cc-f28950b5ba2b, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RoughSleepers_Tiefling_d0beddaa-790d-4c43-8229-7ecc44557e25, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RivingtonMilitia_HumanCivilian02_1f78c52d-57a4-4761-909d-c85b4329386f, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RivingtonMilitia_HumanChild_4b0b7255-b530-4fe9-9fa1-ac4aac961ca1, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RivingtonMilitia_HumanCivilian01_65f01434-696b-4c2d-a224-c1deed72b28b, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_ScaredLocals_Mother02_2501fe05-28c3-40b5-9913-ea35dfa274a9, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_ScaredLocals_Mother01_655c601f-b123-429b-9b48-0ab39c491cb6, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_ScaredLocals_Child_785c016f-7136-41b6-9e23-a6001a9313b5, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_TiredWalkers_Child_0a1d26ce-7ba9-4ab1-80c2-e701de1a26b6, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_TiredWalkers_Father_c58204cf-c1c1-4fd8-a901-827c0394b243, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_TiredWalkers_Mother_51d12be7-131c-4a07-9d38-57b88a6f56bf, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_HornyStupidTeenagers_Human_77bec94d-c6ef-42c6-b0f0-9a5cb97321d0, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_HornyStupidTeenagers_Dragonborn_092a3e8c-36e1-4bef-b577-1c0df7703727, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_OHTDesperateRefugees_TieflingBoy_6f2b6538-2bbd-441a-9194-c1ea5cec2d39, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_OHTDesperateRefugees_TieflingFather_0cba99e9-d50a-4c77-a597-778ab8ea77fe, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_OHTDesperateRefugees_TieflingMother_40342209-9d20-4a4a-b2d8-cc320294db1b, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_OHTDesperateRefugees_TieflingGirl_46ca383b-61b8-415b-8d03-3cb3faef9f8b, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_LeavingAdventurers_Tiefling_07ac75ba-275e-4cd9-8a38-e2efc49cfee2, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_LeavingAdventurers_Gnome_64902b56-38a6-47c4-aafd-1318bd7730e3, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_LeavingAdventurers_HalfOrc_c5a17687-c6d5-4c57-a114-c0e83834d830, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_LeavingAdventurers_Elf_d06c4a37-ca6f-400f-bb73-9ccd1d0c1a6a, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_MissingLetters_FemaleHalfling_8da69a0e-fa94-49ee-9a8c-2d8d01fabe11, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_MissingLetters_MaleHalfling_a8d2a84f-1e26-4f59-bae4-94cf0cd6dece, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_MissingLetters_MaleDwarf_2eebd33d-8588-47d0-9a52-43013d1724a3, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_DepressedRefugees_HumanCivilian_fd31b0a4-ebfb-4c59-946b-435320f2df49, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_DepressedRefugees_DwarfCivilian_cfa6268d-134a-4392-835f-3f3a4d3f0492, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_BusinessIsBusiness_Dwarf02_2f0f30de-a38c-4a8f-bfc2-ff7a3811c436, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_BusinessIsBusiness_Dwarf01_8e867dff-c807-4868-8568-9570d0d11d57, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_BruisedLocal_MaleCivilian_085a2908-3136-45d7-a372-56e6f36570e2, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_BruisedLocal_FemaleCivilian_d0ac67c6-5bb2-4e95-af46-0432a9d8582d, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_FamishedRefugees_FemaleHalfling01_9ba6f691-d53d-42f2-b4f8-39a9ea9d5499, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_FamishedRefugees_FemaleHalfling02_a9667ae2-3df0-455a-b2e7-ff7e4683fbb8, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_FamishedRefugees_MaleHalfling_7bfe72be-fe13-4350-b205-b5b43238734f, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CircusKid_TieflingBoy_2c4f376b-6501-42ee-9881-d68c40a1391b, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CircusKid_HumanGirl_73d0a6bf-9323-4b8c-ac09-f78097753868, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_ShoppingDate_Human_41ae6cd6-5934-4a09-93ac-83d45a1365c0, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_ShoppingDate_HalfElf_e99c01aa-85b2-48ff-9c18-68d2f1ce5150, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_SteelWatcherNerds_Gnome_256dbbf7-237a-4ef1-a640-ba9585b0660d, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_SteelWatcherNerds_Elf_a0d13662-0abd-4e16-b8d5-c2a55f6b7bb2, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_SteelWatcherNerds_Human_ea910cbb-9a38-4066-ad09-1958f173dcdc, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_PerformanceBooster_Human_d97b5c78-9f70-42b3-9553-af40fc4b73ae, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_PerformanceBooster_Dragonborn_f0aca921-b4de-4f23-94a0-32df42dccedb, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_SourBirthdayBoy_Friend02_1565d1d3-aad3-4368-8ff0-54926154e8dd, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_SourBirthdayBoy_SourDwarf_2641f7d8-c50e-4ce4-9221-731638caef35, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_SourBirthdayBoy_Friend01_e91fe01b-c590-4f27-8471-5c4b3af571f9, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_FoodDrive_Gnome_11be71bb-d4d0-42e7-9831-f680dde23f2c, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_FoodDrive_Dwarves_c5b8e813-675c-4d8d-ae3d-8f75df76af55, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_Bridge_AlchemyMerchant_208167c3-e4ea-4308-b232-97236b1738ec, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_Circus_BackupBard_01_acac9e7e-c7f1-47dc-b87e-247005a641d9, (FACTION)ACT3_WYR_Circus_Workers_1c52504e-5262-4670-a834-6248e68534ad);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_Circus_BackupBard_02_c6761d3e-62f4-4a43-a593-771b670b583d, (FACTION)ACT3_WYR_Circus_Workers_1c52504e-5262-4670-a834-6248e68534ad);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_Circus_BackupPerformer_02_892f9260-502e-4987-8438-1e4714c6586c, (FACTION)ACT3_WYR_Circus_Workers_1c52504e-5262-4670-a834-6248e68534ad);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_Circus_BackupPerformer_01_df3fcab6-63af-43c7-a1a5-2f3267d3e9c9, (FACTION)ACT3_WYR_Circus_Workers_1c52504e-5262-4670-a834-6248e68534ad);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_Circus_DressingRoomWorker_1985a13e-b870-4618-8c19-09f79667c598, (FACTION)ACT3_WYR_Circus_Workers_1c52504e-5262-4670-a834-6248e68534ad);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_Circus_DressingRoomSleeper_29846481-7c1a-449d-8e66-0017cbcd484e, (FACTION)ACT3_WYR_Circus_Workers_1c52504e-5262-4670-a834-6248e68534ad);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HumanElf001_1684311f-5bfa-41fc-a8e6-86a96540bc1e, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HumanMale003_5b35db9c-db51-42b7-af5d-799efe847b2b, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HumanFemale001_6d20aeb4-41de-42a8-9cdb-1faebbfaab9e, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HumanMale001_79507657-f0fc-42a1-aaa2-51262439643c, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HumanFemale002_9b0013d5-5d66-4524-9c51-2120f2e5c035, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HumanMale004_35a641d2-0d92-413a-9db6-150e8a68c54d, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HumanMale002_c88fbe83-be3d-4ca1-b0fb-c22a12ba401a, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HalflinfMale001_5ece04b3-8947-4a05-86b8-b463c6fbbb96, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_DwarfFemale001_e0577386-697e-471b-a7d3-0fd702f6c420, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_FemaleDwarf_7e930a44-e60b-4c39-9dab-da7135f320c7, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HumanFemale004_d04b488d-e882-4ba5-942b-beab867491e4, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(WYR_SharessCaress_FakeCrowds_HumanFemale003_f7e133d4-7000-4412-98f1-4fe649003534, (FACTION)ACT3_WYR_SharessCaress_Patrons_c0eab719-6095-4591-89e1-523c8eed0597);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_SharessCaress_BasementRat_33aaee0d-037b-4e21-9f26-2d1751bc78d8, (FACTION)ACT3_WYR_SharessCaress_Beasts_6aa53790-e938-42be-9190-5b32e914b93b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_SharessCaress_Cat_905545cf-04b9-4340-a501-f8f5fa201b87, (FACTION)ACT3_WYR_SharessCaress_Beasts_6aa53790-e938-42be-9190-5b32e914b93b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Protester_001_77bc8a1b-1c6e-4627-8a24-99c33f743709, (FACTION)ACT3_WYR_Rivington_Protesters_3d58db3f-7921-4511-8017-c093dd8e411a);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Protester_003_80c5f32e-038a-4233-8d53-b509221b58ff, (FACTION)ACT3_WYR_Rivington_Protesters_3d58db3f-7921-4511-8017-c093dd8e411a);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Protester_002_d61bafe9-67aa-4a79-a6a3-901839c44e6a, (FACTION)ACT3_WYR_Rivington_Protesters_3d58db3f-7921-4511-8017-c093dd8e411a);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_11_0d26695f-0e9c-406b-aa42-eb3debb04529, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_DibbsWife_4c22257a-4729-47eb-ae4b-61305033be95, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_10_04af618f-ab75-48d0-968c-e2474897d8de, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_RefugeeChild_04_0514bca7-a892-470a-a3f0-5318ffb67824, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_05_0caf9e68-3da5-48d1-b633-17df143c7978, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_07_0d542335-e415-4350-b2f3-01b0291e9b61, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_HobgoblinOutcast_b75bfef3-187e-495a-b0d4-4903d18e21d2, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_04_c4d3a57b-4117-4531-aff1-56542344900c, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_14_62986827-cf46-492b-a32e-27a168e47846, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Dibbs_72d61688-13bd-4aa3-a027-915cf1e66497, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_RefugeeChild_03_eb54aa92-8123-42a0-9b4a-10545565f380, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_WoundedRefugee_7799795e-1477-4857-8cb7-ca5db3c50f47, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_15_92801b00-ec09-4d0d-990b-960c07de43e3, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_08_92b0f2b2-0f50-4bb0-af35-05c8b877fce5, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_06_9a800b94-b74f-4586-8f9a-a6cc84e19aa6, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_RefugeeChild_02_9c53fa6c-fe75-4ecb-9755-776dbde97a0e, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_RefugeeChild_01_ab237788-d58f-434f-bcda-4ba0e56b0291, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_09_acbb99cd-21db-4003-af18-2158e4a58645, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_03_add9a282-42e6-4c73-8eeb-dbeaa257cf09, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_DibbsDog_bc33e4d2-a37e-41bc-8082-1cc6055dcec4, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_13_c077fb56-7f29-4693-8ebf-3571a01d689b, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_Refugee_12_fc0cf3c5-cd5a-4156-8024-6eeb67db98a3, (FACTION)ACT3_WYR_RefugeeCamp_Refugees_cca66e8a-9eec-4b13-9dd4-01b5b534df69);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_RefugeeCamp_BarnPig_f35e27df-72a6-44ba-96d0-3f69b13ad580, (FACTION)ACT3_WYR_RefugeeCamp_Pig_52a32847-e2ab-4321-b575-f1ff131e3ca7);
PROC_SetCanFight(S_WYR_Circus_BackupPerformer_01_df3fcab6-63af-43c7-a1a5-2f3267d3e9c9, 0);
DB_BUGFIX_Marker("GUSX-9144-WYR");

PROC
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)_Character, (FACTION)_Faction)
AND
NOT DB_PermaDefeated(_Character)
AND
GetBaseFaction(_Character, (FACTION)cfb709b3-220f-9682-bcfb-6f0d8837462e) // "Neutral NPC" faction has a space in its name
THEN
SetFaction(_Character, _Faction);
//END_REGION

//REGION GUSX-11941

PROC
PROC_ApplySavegamePatches()
AND
DB_Players((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
AND
DB_CampNight_Completed((FLAG)NIGHT_DarkUrge_MurderOfAlfira_b0e97b06-b2f8-4376-829f-23d4b4bcf78d)
AND
NOT DB_Camp_QueuedNight((FLAG)NIGHT_DarkUrge_MurderOfAlfira_b0e97b06-b2f8-4376-829f-23d4b4bcf78d)
THEN
PROC_Origins_CompanionLeavePermanently(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "CompanionMurdered");
Die(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 0.0);

//The night is already over, no new night has started, thus PROC_CampNight_DecideCampNight has not reset Queued Night.
PROC
PROC_ApplySavegamePatches()
AND
DB_Players((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
AND
DB_CampNight_Completed((FLAG)NIGHT_DarkUrge_MurderOfAlfira_b0e97b06-b2f8-4376-829f-23d4b4bcf78d)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_DarkUrge_MurderOfAlfira_b0e97b06-b2f8-4376-829f-23d4b4bcf78d)
AND
NOT DB_Camp_NightMode(1)
THEN
PROC_Origins_CompanionLeavePermanently(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "CompanionMurdered");
Die(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 0.0);

//END_REGION 

//REGION GUSX-10360
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
AND
NOT DB_BUGFIX_Marker("GUS-316534-C")
THEN
DB_BUGFIX_Marker("GUSX-10360");
NOT DB_GLO_CompoundFlag((FLAG)WYR_Circus_State_ClownPiecesFoundAny_42d65dc1-e187-4484-8418-fec83083bff9, WYR_Circus_State_ClownPiecesFoundAny_42d65dc1-e187-4484-8418-fec83083bff9);
DB_GLO_CompoundFlag((FLAG)WYR_Circus_State_ClownPiecesHasAny_4fec1a52-6650-a377-983c-04e2c01d84cf, WYR_Circus_State_ClownPiecesFoundAny_42d65dc1-e187-4484-8418-fec83083bff9);
//END_REGION

//REGION GUSX-9959
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "BGO_Main_A", "GUSX-9959");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUSX-9959")
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_State_Gone_151fd307-4cb8-44ba-8998-40e1d748b707)
AND
NOT DB_Defeated(S_WYR_Circus_Ringmaster_c95af77b-6fc3-4c73-ac7c-087124f4b1e4)
THEN
PROC_SetRelationMutual((FACTION)ACT3_WYR_Circus_Workers_1c52504e-5262-4670-a834-6248e68534ad, (FACTION)ACT3_WYR_Circus_Ringmaster_c8ee67a5-f6c1-46ab-8957-b1e4018adbf8, 100);
DB_BUGFIX_Marker("GUSX-10360-A");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUSX-9959")
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_State_PostCombat_ee4b2f6e-9d52-4bc5-bde6-bc0e1c015de4)
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_State_Gone_151fd307-4cb8-44ba-8998-40e1d748b707)
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_Clown_State_Hostile_59c1f674-0985-4d4d-9679-b8a1e4982f45)
AND
DB_WYR_Circus_Absolutists((CHARACTER)_Thug)
AND
NOT DB_PermaDefeated(_Thug)
AND
IsTagged(_Thug, (TAG)ACT3_WYR_CIRCUS_CAGEOPENER_f3acc92a-eb22-4076-940b-e52988d0dbdf, 1)
THEN
ClearTag(_Thug, ACT3_WYR_CIRCUS_CAGEOPENER_f3acc92a-eb22-4076-940b-e52988d0dbdf);
DB_BUGFIX_Marker("GUSX-10360-B");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUSX-9959")
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_State_PostCombat_ee4b2f6e-9d52-4bc5-bde6-bc0e1c015de4)
AND
NOT DB_GlobalFlag((FLAG)WYR_Circus_State_Gone_151fd307-4cb8-44ba-8998-40e1d748b707)
AND
DB_GlobalFlag((FLAG)WYR_Circus_Clown_State_Hostile_59c1f674-0985-4d4d-9679-b8a1e4982f45)
AND
NOT DB_PermaDefeatedOrOffstage(S_WYR_Circus_BackupPerformer_01_df3fcab6-63af-43c7-a1a5-2f3267d3e9c9)
AND
NOT DB_Is_InCombat(S_WYR_Circus_Ringmaster_c95af77b-6fc3-4c73-ac7c-087124f4b1e4, _)
THEN
SetTag(S_WYR_Circus_BackupPerformer_01_df3fcab6-63af-43c7-a1a5-2f3267d3e9c9, (TAG)AI_UNPREFERRED_TARGET_9787450d-f34d-43bd-be88-d2bac00bb8ee);
DB_BUGFIX_Marker("GUSX-10360-C");
//END_REGION

//REGION GUSX-9961
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "BGO_Main_A", "GUSX-9961");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUSX-9961")
THEN
DB_BUGFIX_Marker("GUSX-9961");
DEV_EnableAnubis(S_WYR_WyrmRock_MessHallBodyguard_001_2c553951-81ba-472e-98e3-7e688116c8c0, "WYR_WyrmRock_MessHallBodyguard_001");
//END_REGION

//REGION GUSX-7940
PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_BUGFIX_GUSX_7940("BGO_Main_A");
DB_BUGFIX_GUSX_7940("CTY_Main_A");

// when a savegame is loaded scripting clears DB_Camp_UserCampChest and then fills it again
// so we need to wait to make sure the DB is not empty
IF
LevelGameplayStarted(_LevelName, _)
AND
DB_BUGFIX_GUSX_7940(_LevelName)
THEN
SysClear("DB_BUGFIX_GUSX_7940", 1);
TimerLaunch("BUGFIX_GUS_7940_MoveGortashGauntletsToPlayer", 1000);

IF
TimerFinished("BUGFIX_GUS_7940_MoveGortashGauntletsToPlayer")
THEN
PROC_BUGFIX_GUS_7940_MoveGortashGauntletsToPlayer();

PROC
PROC_BUGFIX_GUS_7940_MoveGortashGauntletsToPlayer()
AND
DB_Camp_UserCampChest(_, _CampChest)
AND
TemplateIsInInventory(MAG_Gortash_Gloves_f7d87a7a-e5aa-4bc9-ba51-4e2df3e0bae0, _CampChest, 1)
AND
GetItemByTemplateInInventory(MAG_Gortash_Gloves_f7d87a7a-e5aa-4bc9-ba51-4e2df3e0bae0, _CampChest, _GortashGloves)
AND
QRY_GetClosestAvailableCharacterTo(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, 0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Char, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _)
THEN
DB_BUGFIX_Marker("GUSX-7940");
ToInventory(_GortashGloves, _Char);
//END_REGION

//REGION GUSX-9144 (WYR)
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "BGO_Main_A", "GUSX-9144-WYR-2");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUSX-9144-WYR-2")
THEN
// global
PROC_Bugfix_GUSX_9144_CheckChangeFactionWithBugfixMarker((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (FACTION)Act3_Yenna_c4e1029a-c4ed-4fc1-819e-12a44f7b7969, "GUSX-9144-YENNA");
PROC_Bugfix_GUSX_9144_CheckChangeFactionWithBugfixMarker((CHARACTER)S_GLO_YennasCat_6583b752-ac47-4ae9-ab9d-d75cebaf9b71, (FACTION)Act3_YennasCat_7ec1869b-fbfa-4f8b-abdf-4577b6573a5e, "GUSX-9144-YENNASCAT");
// local
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CoronationHallWitness_01_b3048943-8bf0-4819-b13a-90a9aa9d44eb, (FACTION)ACT3_WYR_WyrmRock_CoronationWitnesses_84804e10-1689-411b-a1f1-7ddeee53a87b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CoronationHallWitness_02_44646c53-a11f-4430-9bd3-57b154ebe40d, (FACTION)ACT3_WYR_WyrmRock_CoronationWitnesses_84804e10-1689-411b-a1f1-7ddeee53a87b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CoronationHallWitness_03_e30086c1-9717-4f9d-9752-4b9d69505ed3, (FACTION)ACT3_WYR_WyrmRock_CoronationWitnesses_84804e10-1689-411b-a1f1-7ddeee53a87b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CoronationHallWitness_04_f6903d56-6f4b-4574-a9d6-4c07c87e0924, (FACTION)ACT3_WYR_WyrmRock_CoronationWitnesses_84804e10-1689-411b-a1f1-7ddeee53a87b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CoronationHallWitness_05_9d4dcc39-79c0-4451-8445-6e55d2ca6e02, (FACTION)ACT3_WYR_WyrmRock_CoronationWitnesses_84804e10-1689-411b-a1f1-7ddeee53a87b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CoronationHallWitness_06_2df6edc3-6a62-43d7-bf18-4041f7507175, (FACTION)ACT3_WYR_WyrmRock_CoronationWitnesses_84804e10-1689-411b-a1f1-7ddeee53a87b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CoronationHallWitness_07_254b0dba-2d9c-4a2b-8296-e1464be21fef, (FACTION)ACT3_WYR_WyrmRock_CoronationWitnesses_84804e10-1689-411b-a1f1-7ddeee53a87b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CoronationHallWitness_08_e944f197-5db8-42ca-a506-66ec0db0607e, (FACTION)ACT3_WYR_WyrmRock_CoronationWitnesses_84804e10-1689-411b-a1f1-7ddeee53a87b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_CoronationHallWitness_09_b12eff34-7557-4eed-9279-5c143ce46b71, (FACTION)ACT3_WYR_WyrmRock_CoronationWitnesses_84804e10-1689-411b-a1f1-7ddeee53a87b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_FigaroSister_Carmen_99c32d1b-838c-4db2-8150-d4112aedc636, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_FigaroSister_Naaber_fa22f4a3-53ba-4a35-9dec-a402244a5203, (FACTION)ACT3_WYR_Bridge_Civilians_4bd6fc5c-99d6-4340-b90f-68a01afa022b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_Posthouse_BroadsheetSeller_ef30ef8d-d89b-4914-816c-5354ff74f516, (FACTION)ACT3_WYR_Rivington_Civilians_723d5659-bc6b-4322-bc12-d9d9dacfe45b);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_TerrifiedLocal_Man_be670f38-bfd4-4a26-8143-d21f7107ae6f, (FACTION)ACT3_WYR_WyrmRock_TerrifiedLocals_5f483a75-4997-438e-8a86-19e19b6ed918);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WYR_TerrifiedLocal_Woman_adcbb246-87d6-46b8-a1a1-56ffced39b72, (FACTION)ACT3_WYR_WyrmRock_TerrifiedLocals_5f483a75-4997-438e-8a86-19e19b6ed918);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WyrmRock_Lawyered_FemaleElf_d69fceaf-1a8f-4fc3-b6d9-68d90e4fcfb0, (FACTION)ACT3_WYR_WyrmRock_Lawyered_4dd42826-a412-4ae8-aca8-6f58149b6bc3);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WyrmRock_Lawyered_HalfOrc_43b5176f-b2d8-4d60-b901-d90194d50181, (FACTION)ACT3_WYR_WyrmRock_Lawyered_4dd42826-a412-4ae8-aca8-6f58149b6bc3);
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction(S_WyrmRock_Lawyered_MaleElf_ccd96056-c992-439b-88b2-2989f158383b, (FACTION)ACT3_WYR_WyrmRock_Lawyered_4dd42826-a412-4ae8-aca8-6f58149b6bc3);
DB_BUGFIX_Marker("GUSX-9144-WYR-2");
//END_REGION

//REGION GUSX-9480
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_Bugfix_GUSX_9480_CheckIfDBShouldBeDeleted();

PROC
PROC_Bugfix_GUSX_9480_CheckIfDBShouldBeDeleted()
AND
DB_TriggerEvents_AllPartyMembersLeft(S_WYR_WyrmRock_AudienceHallArea_a078f420-9f5e-452b-9391-e96e754b61c8, "WYR_KillDirectorGortash_WaitForAllPartyMembersToLeaveAudienceHall_SavegamePatch")
AND
QRY_Bugfix_GUSX_9480_CheckIRNStateAlreadyApplied()
THEN
NOT DB_TriggerEvents_AllPartyMembersLeft(S_WYR_WyrmRock_AudienceHallArea_a078f420-9f5e-452b-9391-e96e754b61c8, "WYR_KillDirectorGortash_WaitForAllPartyMembersToLeaveAudienceHall_SavegamePatch");
DB_OnlyOnce("WYR_KillDirectorGortash_WaitForAllPartyMembersToLeaveAudienceHall_SavegamePatch");
DB_BUGFIX_Marker("GUSX-9480");

QRY
QRY_Bugfix_GUSX_9480_CheckIRNStateAlreadyApplied()
AND
DB_BUGFIX_Marker("GUS-315319_NotBGO_RavengardDeadAfterIrnIsDestroyed")
THEN
DB_NOOP(1);

QRY
QRY_Bugfix_GUSX_9480_CheckIRNStateAlreadyApplied()
AND
DB_BUGFIX_Marker("GUS-315319_NotBGO_RavengardMovedToIrnBeforeStarted")
THEN
DB_NOOP(1);

QRY
QRY_Bugfix_GUSX_9480_CheckIRNStateAlreadyApplied()
AND
DB_BUGFIX_Marker("GUS-315319_NotBGO_RavengardMovedToIrnWhileOngoing")
THEN
DB_NOOP(1);
//END_REGION

//REGION GUSX-5898
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)ORI_Jaheira_State_PromisedFindMinsc_d8e6770d-d948-5a2a-8f17-324e4232ae30)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_InCamp((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
DB_BUGFIX_Marker("GUSX-5898_MinscProtected");
DB_GLO_PaladinOathbreaker_ProtectedNPCs((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, (CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
//END_REGION GUSX-5898

//REGION GUSX-13287
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_PartOfTheTeam(_Player)
THEN
CharacterStopCrime(_Player, "WYR_WyrmRockPrison_InnerAreaTrespassing", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUSX-13287");
//END_REGION GUSX-13287
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "__Start"
