Version 1
SubGoalCombiner SGC_AND
INITSECTION
//Deprecated DBs
NOT DB_GLO_ThrallOfTheAbsolute_WaitingForAvailability(NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GLO_ThrallOfTheAbsolute_RecoveredPlayer(NULL_00000000-0000-0000-0000-000000000000);
KBSECTION
//REGION GUS-296803
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
NOT DB_DialogDeath(S_END_LastStandGuard_005_09eec5b4-d504-4c46-8410-ec180722456b)
AND
NOT DB_DialogDeath(S_END_LastStandGuard_006_e9abe20a-60df-4807-8582-ecc2f9b80525)
THEN
DB_DialogDeath(S_END_LastStandGuard_005_09eec5b4-d504-4c46-8410-ec180722456b);
DB_DialogDeath(S_END_LastStandGuard_006_e9abe20a-60df-4807-8582-ecc2f9b80525);
DB_BUGFIX_Marker("GUS-296803");
//END_REGION

//REGION GUS-298143

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
DB_END_General_FullPartyDialog((DIALOGRESOURCE)END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3, 1, 1, 1, 1, 1, 1, 2);
DB_BUGFIX_Marker("GUS-298143");
//END_REGION

//REGION GUS-298691

//Checking if Orpheus has been chosen to transform, but no one is a Mind Flayer
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
AND
DB_GlobalFlag(END_IllithidOptions_State_ExitPortalAvailable_b97872a1-59cc-40cd-8963-e06be614adc0)
AND
DB_GlobalFlag(END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb)
AND
NOT DB_PermaDefeated(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
NOT DB_GlobalFlag(END_General_State_SupremeTadpoleAvailable_0177c452-90cc-4c29-83b8-4acaa2902b27)
AND
NOT DB_GlobalFlag(END_General_State_PartyMemberIsMindFlayer_3c42b03b-c51c-4f06-a5a3-a5ee416d9d8b)
AND
NOT DB_GlobalFlag(END_General_State_OrpheusIsMindFlayer_2b638127-f30a-424e-9d4a-a9f8f100a307)
AND
DB_GlobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9)
THEN
PROC_END_General_ApplyMindFlayerForm((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
DB_BUGFIX_Marker("GUS-298691");

//END_REGION

//REGION GUS-298912
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
THEN
DB_END_GatherYourAllies_FollowUpDialogue((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)END_GatherYourAllies_NightsongFollowUp_2262a52c-acb4-b632-bda8-372cc46c6a76, "END_Nightsong");
DB_END_GatherYourAllies_FollowUpDialogue((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (DIALOGRESOURCE)END_GatherYourAllies_IsobelFollowUp_93bcdd2b-5caf-4a83-0c8e-2675ef6492c3, "END_Isobel");
DB_BUGFIX_Marker("GUS-298912");

//END_REGION GUS-298912

//REGION GUS-296968
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
DB_END_AllyAbilities_PlayerSummonAllyAD("Target_END_AllyAbility_PhasmSummon", (DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-296968");
//END_REGION

//REGION GUS-299615

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
THEN
PROC_END_DEBUG_FixRealPartOfTheTeam();
DB_BUGFIX_Marker("GUS-299615");

PROC
PROC_END_DEBUG_FixRealPartOfTheTeam()
AND
DB_Avatars(_Avatar)
THEN
DB_END_RealPartOfTheTeam((CHARACTER)_Avatar);

PROC
PROC_END_DEBUG_FixRealPartOfTheTeam()
AND
DB_Origins(_Character)
AND
DB_PartOfTheTeam(_Character)
THEN
DB_END_RealPartOfTheTeam((CHARACTER)_Character);

//Just in case, for hirelings.
PROC
PROC_END_DEBUG_FixRealPartOfTheTeam()
AND
DB_Players(_Character)
AND
NOT DB_END_RealPartOfTheTeam(_Character)
THEN
DB_END_RealPartOfTheTeam((CHARACTER)_Character);

//Just in case, for hirelings.
PROC
PROC_END_DEBUG_FixRealPartOfTheTeam()
AND
DB_END_RealPartOfTheTeam(_Character)
AND
NOT DB_PartOfTheTeam(_Character)
THEN
NOT DB_END_RealPartOfTheTeam((CHARACTER)_Character);
//END_REGION

//REGION GUS-285535

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
AND
DB_CurrentLevel("END_Main")
THEN
PROC_BG3_SaveGamePatches_GUS_285535_InitNautiloidStrikeDBs();
DB_BUGFIX_Marker("GUS-285535");

PROC
PROC_BG3_SaveGamePatches_GUS_285535_InitNautiloidStrikeDBs()
AND
NOT DB_END_NautiloidStrike_CastSpacingTime(_)
THEN
DB_END_NautiloidStrike_CastSpacingTime(200);

PROC
PROC_BG3_SaveGamePatches_GUS_285535_InitNautiloidStrikeDBs()
AND
NOT DB_END_NautiloidStrike_TotalBufferTime(_)
THEN
DB_END_NautiloidStrike_TotalBufferTime(0);

PROC
PROC_BG3_SaveGamePatches_GUS_285535_InitNautiloidStrikeDBs()
AND
NOT DB_END_NautiloidStrike_EntityHitTime(_)
THEN
DB_END_NautiloidStrike_EntityHitTime(0);

//END_REGION

//REGION GUS-296005 
// - Globe from Intermezzo can be seen when entering END
// - Emperor still has Intermezzo config
// - Move Orpheus back to his inteded and shift the helpers to give more space for him
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,2,0)
AND
DB_CurrentLevel("END_Main")
THEN
TeleportToPosition(S_EmperorRevealed_GlobeOfDomination_Small_8950891c-ad3a-434c-a463-615b5ab90ea7, -1919.0, 0.0, 2687.0);
SetOnStage(S_EmperorRevealed_GlobeOfDomination_Small_8950891c-ad3a-434c-a463-615b5ab90ea7, 0);
PROC_BG3_SaveGamePatches_GUS_296005_SetEmperorBehaviourState();
PROC_BG3_SaveGamePatches_GUS_296005_MoveAndDetachOrpheus();
DB_BUGFIX_Marker("GUS-296005");

PROC
PROC_BG3_SaveGamePatches_GUS_296005_SetEmperorBehaviourState()
AND
GetAnubisConfig(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _CurrentConfig)
AND
_CurrentConfig != "END_Emperor"
THEN
PROC_SetAnubisConfig(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, "END_Emperor");

//Making sure he is only set to his assimilation behaviour once he's made it past the previous states
PROC
PROC_BG3_SaveGamePatches_GUS_296005_SetEmperorBehaviourState()
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_EmperorMovingToAssimilation_7575a81a-f7dc-43ee-b066-11b75ebbf769) 
AND
NOT DB_DialogName(END_IllithidOptions_EmperorProposal_6769199a-452f-5a13-9178-55a899cccf59, _)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd) 
AND
DB_GlobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9) 
THEN
RealtimeObjectTimerLaunch(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, "END_IllithidOptions_PATCH_SetArrivedAssimilation", 500);

//Small delay so Emperor can enter state
IF
ObjectTimerFinished(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, "END_IllithidOptions_PATCH_SetArrivedAssimilation")
THEN
SetEntityEvent(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,"END_IllithidOptions_ArrivedAtAssimilation"); 

PROC
PROC_BG3_SaveGamePatches_GUS_296005_MoveAndDetachOrpheus()
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
AND
NOT DB_PermaDefeated(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_MiniDominationOrbRemoved_05db0c72-bfc8-45a9-8c29-04d11eaa986b)
THEN
TeleportToPosition(S_END_OrbBoundHelper_002_d825c26a-6004-4dcb-acbc-1de1fa678762, 50.194, -25.149, 3241.005);
TeleportToPosition(S_END_OrbBoundHelper_005_c3ea9213-82f4-4b51-8f97-8528bf9d751e, 50.351, -25.065, 3239.638);
TeleportToPosition(S_END_OrbBoundHelper_006_e2c0aeac-b48f-4108-bff3-bfa5be31654c, 50.307, -25.234, 3241.988);
TeleportToPosition(S_END_OrbBoundHelper_008_13317d06-bd74-43eb-9f18-0ca72ca06353, 51.752, -25.149, 3239.204);
SetDetached(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,1);
SetEntityEvent(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, "END_IllithidOptions_PATCH_MoveOrpheus", 1);

//A small frame delay in the case set detached is deferred
IF
EntityEvent(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, "END_IllithidOptions_PATCH_MoveOrpheus")
THEN
TeleportTo(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, S_INT_OrpheusPos_13dd190c-9097-4c0e-be8e-1d9a743cbe02);

//In the case Raphael appeared more than once
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,2,0)
AND
DB_CurrentLevel("END_Main")
AND
NOT QRY_END_IllithidOptions_RaphaelCanAppear()
AND
IsOnStage(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 1)
AND
DB_GlobalFlag(END_IllithidOptions_State_AcceptedRaphaelDeal_c4d409ef-d70e-9934-edf2-d6bd66201c19)
THEN
PROC_GLO_Monitor_Poof();
PROC_SceneOver("END_IllithidOptions_RaphaelScene");
DB_BUGFIX_Marker("GUS-296005");
//END_REGION

//REGION GUS-299109

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,6,0)
AND
DB_CurrentLevel("END_Main")
THEN
PROC_SetAnubisConfig(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, "END_Orpheus");

//END_REGION

//REGION GUS-285535

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
AND
DB_CurrentLevel("END_Main")
AND
NOT DB_END_NautiloidHelper_Position(_, _, _, _)
THEN
PROC_END_HighHallInterior_GetCannonHelperOrigin();
DB_BUGFIX_Marker("GUS-285535");

//END_REGION

//REGION GUS-300308

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
THEN
NOT DB_GLO_CompoundFlag((FLAG)END_GameFinale_State_LaezelOrpheusPath_a74531fa-52d8-13e8-562f-d3a528e73f82, END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209);
NOT DB_GLO_CompoundFlag((FLAG)END_GameFinale_State_LaezelVlaakithPath_7acb346a-df49-8719-aa2a-124a1c04791f, END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209);
NOT DB_GLO_CompoundFlag((FLAG)END_GameFinale_State_PlayerLaezelOrpheus_9bbf4067-fcb1-0c74-088d-ff887ca2abe5, END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209);
NOT DB_GLO_CompoundFlag((FLAG)END_GameFinale_State_PlayerLaezelVlaakith_bf95c085-fe78-9cda-7aac-2d8e5b94a9cf, END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209);

//END_REGION

//REGION GUS-300923; GUS-300917

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_WYR_CourageTest_Tester(_, _)
AND
DB_GlobalCounter("WYR_CourageTrial", 2)
THEN
NOT DB_GlobalCounter("WYR_CourageTrial", 2);
DB_GlobalCounter("WYR_CourageTrial", 1);
//Go down one step because the counter ticks twice.

//END_REGION

//REGION GUS-300127

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
THEN
TriggerRegisterForCharacter(S_END_EmperorImmortalArea_80996c6e-72ff-43be-a2f1-53a2f87e929b, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
DB_BUGFIX_Marker("GUS-300127");

//END_REGION

//REGION GUS-300701
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag(END_General_State_CurrentlyInMorphicPool_06208edf-4c61-44a2-932b-b158d9ddd2f0)
AND
NOT DB_OneShotPlayerTrigger(S_END_NearNetherbrainPoolBox_49aa0cac-17aa-476d-8844-db78966ff698)
THEN
DB_OneShotPlayerTrigger(S_END_NearNetherbrainPoolBox_49aa0cac-17aa-476d-8844-db78966ff698);
DB_BUGFIX_Marker("GUS-300701");
//END_REGION

//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
NOT DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_Nested_AfterGithLeave_a7c18482-0cc0-7b5a-420b-28974c3e1dc8, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12)
THEN
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_Nested_AfterGithLeave_a7c18482-0cc0-7b5a-420b-28974c3e1dc8, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_Nested_Conclusion_6a5c5975-8e27-c58f-1a26-64e8685464c0, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_Nested_EmperorSolo_113aa7cc-d0cd-5c19-eb5d-b9f6e77136b5, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_Nested_GaleExplodedIntro_32b59231-2f78-df56-f3b8-4bf3674641ad, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_Nested_GithAreLeaving_b7f3c52d-364c-e740-404f-fb84d34763be, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_Nested_StandardIntro_48d64086-0da8-289a-c2a1-cdaa4f7349b2, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_Nested_VlaakithLaezel_5b64b0bb-70f3-0873-2982-aedee8a4582b, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_Nested_WhatNext_9187b124-548b-3da3-ca48-4ad22d613207, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12);

//END_REGION

//REGION GUS-302069

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_END_General_FullPartyDialog(END_BrainBattle_GaleExplosion_3b9653f5-17c7-6716-2919-3ad3a9c137fc, 1, 1, 1, 1, 1, 1, 2)
THEN
NOT DB_END_General_FullPartyDialog(END_BrainBattle_GaleExplosion_3b9653f5-17c7-6716-2919-3ad3a9c137fc, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_ROM_RomanceFates_Astarion_73fb7151-e772-cae7-8d7a-bb5eb8e8860a, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Gale_81fc2269-0613-259c-b950-c0dcebbb7934, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Laezel_523b1bb2-0443-79bf-cf3e-8f435ff5f2e9, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Shadowheart_b9ebb9af-ad65-4e64-6015-105e831d49c0, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Wyll_32de9167-3489-9257-e3c1-e430f2f455ab, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Minthara_699ad056-06a4-db4f-53c4-6706dbb7c544, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Halsin_a853d059-2572-04c4-88db-d737e4a264f7, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Karlach_091af35d-0d30-a4bf-b056-9eda505138b5, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Astarion_9a09777b-c0ac-d3d3-c2f4-5e6794fa2ca0, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_CustomAvatar_f346a423-c718-45ca-3a0d-cc228b92abe6, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Laezel_fbee59b9-cb3a-c1f2-66b4-b0fb82cf24fa, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Shadowheart_bdc19865-8e61-2db2-f135-4a611b15cae1, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Wyll_1667181c-2c0a-5255-ecfd-bd0752b4639c, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Karlach_0181cc77-4b25-dd9a-025b-b08e85387645, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_TheHerosRevelry_ecd7cb66-d650-d92a-118f-6be977c4b0b2, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3, 1, 1, 1, 1, 1, 1, 2);
NOT DB_END_General_FullPartyDialog(END_GodsAndMonsters_WithersMeeting_037b2c4f-d8cd-b3bb-1471-a9dee232217d, 1, 1, 1, 1, 1, 1, 1);
NOT DB_END_General_FullPartyDialog(END_GameFinale_RaphaelCrownUpdate_b7ee667d-d550-7115-37f3-ce900ca80cbd, 1, 1, 1, 1, 1, 1, 1);
DB_BUGFIX_Marker("GUS-302069");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
NOT DB_END_General_FullPartyDialog(END_BrainBattle_GaleExplosion_3b9653f5-17c7-6716-2919-3ad3a9c137fc, 0, 1, 1, 1, 1, 1, 2)
THEN
DB_END_General_FullPartyDialog(END_BrainBattle_GaleExplosion_3b9653f5-17c7-6716-2919-3ad3a9c137fc, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_ROM_RomanceFates_Astarion_73fb7151-e772-cae7-8d7a-bb5eb8e8860a, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Gale_81fc2269-0613-259c-b950-c0dcebbb7934, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Laezel_523b1bb2-0443-79bf-cf3e-8f435ff5f2e9, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Shadowheart_b9ebb9af-ad65-4e64-6015-105e831d49c0, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Wyll_32de9167-3489-9257-e3c1-e430f2f455ab, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Minthara_699ad056-06a4-db4f-53c4-6706dbb7c544, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Halsin_a853d059-2572-04c4-88db-d737e4a264f7, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_RomanceFates_Karlach_091af35d-0d30-a4bf-b056-9eda505138b5, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Astarion_9a09777b-c0ac-d3d3-c2f4-5e6794fa2ca0, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_CustomAvatar_f346a423-c718-45ca-3a0d-cc228b92abe6, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Gale_7674e0c3-ca25-e924-9c17-3058796f87c3, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Laezel_fbee59b9-cb3a-c1f2-66b4-b0fb82cf24fa, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Shadowheart_bdc19865-8e61-2db2-f135-4a611b15cae1, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Wyll_1667181c-2c0a-5255-ecfd-bd0752b4639c, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_SoloFates_Karlach_0181cc77-4b25-dd9a-025b-b08e85387645, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_MystraGaleConfrontation_06f1e7cd-25bf-492a-be6d-5fe608de4bbb, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_TheHerosRevelry_ecd7cb66-d650-d92a-118f-6be977c4b0b2, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GameFinale_SequeToElfsong_7633bf1a-a3e5-d33c-8986-a5fe85f680f3, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_GodsAndMonsters_WithersMeeting_037b2c4f-d8cd-b3bb-1471-a9dee232217d, 0, 1, 1, 1, 1, 1, 1);
DB_END_General_FullPartyDialog(END_GameFinale_RaphaelCrownUpdate_b7ee667d-d550-7115-37f3-ce900ca80cbd, 0, 1, 1, 1, 1, 1, 1);
DB_BUGFIX_Marker("GUS-302069");

//END_REGION

//REGION GUS-302401
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 1")
AND
DB_GlobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9)
AND
DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961) 
AND
DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
THEN
PROC_BG3_SaveGamePatches_GUS_302401_OpenPortalOrThrallOfTheAbsolute();

PROC
PROC_BG3_SaveGamePatches_GUS_302401_OpenPortalOrThrallOfTheAbsolute()
AND
NOT QRY_END_IllithidOptions_EmperorIsRequiredToContinue()
AND
QRY_END_IllithidOptions_PlayerCanOpenPortal()
THEN
PROC_END_IllithidOptions_FallbackPortalCheck();
DB_BUGFIX_Marker("GUS-302401");

PROC
PROC_BG3_SaveGamePatches_GUS_302401_OpenPortalOrThrallOfTheAbsolute()
AND
QRY_END_IllithidOptions_EmperorIsRequiredToContinue()
THEN
PROC_END_IllithidOptions_CheckEmperorLeftThrallOfTheAbsolute();
DB_BUGFIX_Marker("GUS-302401");

//END_REGION

//REGION GUS-300470

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
THEN
DB_GLO_RestorationStation_CustomDistance((ITEM)S_END_HighHallExterior_ResotrationPod_424a5497-b958-4360-b826-f93eb9f88690,55.0);
DB_GLO_RestorationStation_CustomDistance((ITEM)S_END_HighHallInterior_ResotrationPod_1933944a-7724-4091-9c88-1e501516b890,55.0);
DB_BUGFIX_Marker("GUS-300470");

//END_REGION

//REGION GUS-303217

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GLO_ThrallOfTheAbsolute_RecoveredPlayer(_Char)
THEN
NOT DB_GLO_ThrallOfTheAbsolute_RecoveredPlayer(_Char);
DB_BUGFIX_Marker("GUS-303217");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GLO_ThrallOfTheAbsolute_WaitingForAvailability(_Char)
THEN
NOT DB_GLO_ThrallOfTheAbsolute_WaitingForAvailability(_Char);
DB_BUGFIX_Marker("GUS-303217");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_OnlyOnce("GLO_ThrallOfTheAbsolute_EndStarted")
AND
NOT DB_GlobalFlag(GLO_ThrallOfTheAbsolute_Event_TransformPlayers_fe6b74e7-fe16-4ec0-bdf1-101abf00e79d)
THEN
NOT DB_OnlyOnce("GLO_ThrallOfTheAbsolute_EndStarted");
DB_BUGFIX_Marker("GUS-303217");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_GlobalFlag(GLO_ThrallOfTheAbsolute_Event_TransformPlayers_fe6b74e7-fe16-4ec0-bdf1-101abf00e79d)
THEN
PROC_BG3_SaveGamePatches_GUS_303217_ClearThrallOfTheAbsoluteFlags();

PROC
PROC_BG3_SaveGamePatches_GUS_303217_ClearThrallOfTheAbsoluteFlags()
AND
DB_PartOfTheTeam(_Player)
AND
DB_GLO_ThrallOfTheAbsolute_ActivationFlags(_EventFlag, _, _)
AND
GetFlag(_EventFlag, _Player, 1)
THEN
ClearFlag(_EventFlag, _Player, 0);
DB_BUGFIX_Marker("GUS-303217");

PROC
PROC_BG3_SaveGamePatches_GUS_303217_ClearThrallOfTheAbsoluteFlags()
AND
DB_Origins(_Char)
AND
DB_GLO_ThrallOfTheAbsolute_ActivationFlags(_EventFlag, _, _)
AND
GetFlag(_EventFlag, _Char, 1)
THEN
ClearFlag(_EventFlag, _Char, 0);
DB_BUGFIX_Marker("GUS-303217");

PROC
PROC_BG3_SaveGamePatches_GUS_303217_ClearThrallOfTheAbsoluteFlags()
AND
DB_Avatars(_Char)
AND
DB_GLO_ThrallOfTheAbsolute_ActivationFlags(_EventFlag, _, _)
AND
GetFlag(_EventFlag, _Char, 1)
THEN
ClearFlag(_EventFlag, _Char, 0);
DB_BUGFIX_Marker("GUS-303217");

PROC
PROC_BG3_SaveGamePatches_GUS_303217_ClearThrallOfTheAbsoluteFlags()
AND
DB_GLO_ThrallOfTheAbsolute_ActivationFlags(_, _StateFlag, _)
AND
DB_GlobalFlag(_StateFlag)
THEN
ClearFlag(_StateFlag);
DB_BUGFIX_Marker("GUS-303217");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(END_MorphicPool_Event_ConfrontationStarted_5f683240-a9ab-449d-9847-a3ed0dc9a23f)
AND
NOT DB_DialogName(END_MorphicPool_NetherbrainConfrontation_ce5161a9-9580-379a-6e1f-476a4ca688cf, _)
AND
NOT DB_GlobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9)
AND
DB_GlobalFlag(END_General_State_CurrentlyInMorphicPool_06208edf-4c61-44a2-932b-b158d9ddd2f0)
THEN
PROC_TeleportPartiesTo(S_END_ToAstralPlanePoint_66edc6ed-1584-47ac-983c-c6119ea7ddd4, "END_IllithidOptions_PlayersArrived");
DB_BUGFIX_Marker("GUS-303217");

//END_REGION


//REGION GUS-303246

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_LeftAstralPrism_db4fa8cd-9901-bda6-b5ee-b341075c02ce)
THEN
NOT DB_Defeated(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
NOT DB_Dead(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
NOT DB_PermaDefeated(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
PROC_CharacterFullRestore(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
PROC_RemoveMutingStatusses(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
ClearFlag(END_IllithidOptions_State_EmperorPermaDefeated_784fecdf-4d89-4e03-9cea-8fa45e1b2897);
ClearFlag(END_General_State_EmperorPermaDefeated_e47e6440-b7e2-4941-bb95-622ebdbdbbef);
PROC_SaveGamePatch_GUS_303921_CheckPlayerProgressToAstralPlane();
DB_BUGFIX_Marker("GUS-303246");

//END_REGION

//REGION GUS-303916

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_DialogStarted_IgnoreStopConditions(END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd)
THEN
DB_DialogStarted_IgnoreStopConditions(END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd);

//END_REGION

//REGION GUS-303922
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(END_IllithidOptions_State_LeftAstralPrism_db4fa8cd-9901-bda6-b5ee-b341075c02ce)
AND
DB_GlobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9)
AND
DB_END_IllithidOptions_WaitingForFollowerToJoin(1)
THEN
NOT DB_END_IllithidOptions_WaitingForFollowerToJoin(1);
DB_BUGFIX_Marker("GUS-303922");
//END_REGION

//REGION GUS-303917
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Hotfix 1")
AND
DB_GlobalFlag(END_IllithidOptions_Event_TadpoleGroupDiscussion_55831e5e-9916-4099-a397-37f5e6967d2e)
THEN
SetFlag(END_IllithidOptions_State_DiscussedOptions_0cbca6d6-8b48-455d-9c1e-f67cbc3f7735);
DB_BUGFIX_Marker("GUS-303917");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Hotfix 1")
AND
DB_GlobalFlag(END_General_State_PartyMemberIsMindFlayer_3c42b03b-c51c-4f06-a5a3-a5ee416d9d8b)
THEN
SetFlag(END_IllithidOptions_State_DiscussedOptions_0cbca6d6-8b48-455d-9c1e-f67cbc3f7735);
DB_BUGFIX_Marker("GUS-303917");
//END_REGION

//REGION GUS-304588
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
DB_Camp_Unlocked(1)
THEN
NOT DB_Camp_Unlocked(1);
DB_BUGFIX_Marker("GUS-304588");
//END_REGION

//REGION GUS-303921
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("END_Main")
AND
NOT DB_GlobalFlag(END_General_State_CurrentlyInBrainBattle_0d7205b2-0d55-4540-8737-543253873cd6)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_EmperorInParty_0e7f8da7-1dce-411e-83ff-e74af6b7601e)
AND
QRY_SaveGamePatch_GUS_303921_EmperorIsInDefeatedState()
THEN
PROC_SaveGamePatch_GUS_303921_RestoreEmperor();
ClearFlag(END_IllithidOptions_State_EmperorPermaDefeated_784fecdf-4d89-4e03-9cea-8fa45e1b2897);
ClearFlag(END_General_State_EmperorPermaDefeated_e47e6440-b7e2-4941-bb95-622ebdbdbbef);
PROC_SaveGamePatch_GUS_303921_CheckPlayerProgressToAstralPlane();
DB_BUGFIX_Marker("GUS-303921-END-A");

QRY
QRY_SaveGamePatch_GUS_303921_EmperorIsInDefeatedState()
AND
HasActiveStatus(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, "KNOCKED_OUT", 1)
THEN
RemoveStatus(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, "KNOCKED_OUT", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-303921-END-B");

QRY
QRY_SaveGamePatch_GUS_303921_EmperorIsInDefeatedState()
AND
DB_Defeated(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
DB_BUGFIX_Marker("GUS-303921-END-C");

PROC
PROC_SaveGamePatch_GUS_303921_CheckPlayerProgressToAstralPlane()
AND
DB_PartyMembers(_Player)
AND
DB_END_MorphicPool_ConfrontationSpeaker(_Player)
AND
NOT DB_GlobalFlag(END_MorphicPool_Event_ConfrontationStarted_5f683240-a9ab-449d-9847-a3ed0dc9a23f)
AND
NOT DB_DialogName(END_MorphicPool_NetherbrainConfrontation_ce5161a9-9580-379a-6e1f-476a4ca688cf, _)
AND
NOT DB_GlobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9)
AND
DB_GlobalFlag(END_General_State_CurrentlyInMorphicPool_06208edf-4c61-44a2-932b-b158d9ddd2f0)
THEN
PROC_END_MorphicPool_TryStartConfrontationDialog((CHARACTER)_Player);
DB_BUGFIX_Marker("GUS-303921-END-D");
//END_REGION 

//REGION GUS-302615
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("END_Main")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5)
THEN
DB_BUGFIX_Marker("GUS-302615");
SysCompleteGoal("Act3b_LOW_BlushingMermaid");
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_MAGICRESISTANCE");
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_RESURRECTING");
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_AWAKENING");
SetImmortal(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,0);
PROC_END_BUGFIX_ClearHagScenes();

PROC
PROC_END_BUGFIX_ClearHagScenes()
AND
DB_SceneManager(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HagScene)
THEN
PROC_SceneOver(_HagScene);
//END_REGION

//REGION GUS-304414

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("END_Main")
THEN
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_OrpheusPathLaezelBetrayed_2be665c6-da32-4e78-bae2-a83fb1b72368,(DIALOGRESOURCE)Laezel_InPartyEND_10e8ff26-dea4-7ef3-ff8e-274ecb3e2868);
DB_BUGFIX_Marker("GUS-304414");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
DB_CurrentLevel("END_Main")
AND
DB_GlobalFlag((FLAG)END_IllithidOptions_Event_OrpheusPathLaezelBetrayed_2be665c6-da32-4e78-bae2-a83fb1b72368)
AND
NOT DB_END_IllithidOptions_LaezelBetrayed(1)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_LeftAstralPrism_db4fa8cd-9901-bda6-b5ee-b341075c02ce)
THEN
PROC_END_IllithidOptions_BetrayedLaezel();

// Fallback if someone went ahead with this bug, 
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
DB_CurrentLevel("END_Main")
AND
DB_GlobalFlag((FLAG)END_IllithidOptions_Event_OrpheusPathLaezelBetrayed_2be665c6-da32-4e78-bae2-a83fb1b72368)
AND
NOT DB_END_IllithidOptions_LaezelBetrayed(1)
AND
DB_GlobalFlag(END_IllithidOptions_State_LeftAstralPrism_db4fa8cd-9901-bda6-b5ee-b341075c02ce)
THEN
SetFlag((FLAG)END_IllithidOptions_State_SwayedLaezelForAssimilation_873e4e9d-8042-78d7-8275-666bd92be830);
ClearFlag((FLAG)END_IllithidOptions_Event_OrpheusPathLaezelBetrayed_2be665c6-da32-4e78-bae2-a83fb1b72368);

//END_REGION

//REGION GUS-302421

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("END_Main")
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_GROUNDED", 1)
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_GROUNDED");
DB_BUGFIX_Marker("GUS-302421");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_Dead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_GlobalFlag(LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
AND
NOT DB_GLO_Nightsong_AwaitsResurrection(1)
AND
QRY_SHA_NightsongPrison_NightsongCanResurrect()
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION", 0)
AND
GetFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Faction)
THEN
PROC_SetRelationToPlayers(_Faction, 100);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION", 6.0, 0, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_BUGFIX_Marker("GUS-302421");

//END_REGION GUS-302421

//REGION GUS-295942

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("END_Main")
AND
DB_END_Courtyard_HelpGuards(_Guard, _, _, _)
THEN
PROC_CharacterDisableCrime(_Guard, "VandaliseNoOwner");
PROC_CharacterDisableCrime(_Guard, "Vandalise");
DB_BUGFIX_Marker("GUS-295942");

//END_REGION

//REGION GUS-289385
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnBox_4c502fa0-0dda-4e58-b55e-56b363256448,(TRIGGER)S_END_SwarmStartPoint_001_3019c755-71d2-47b8-9ade-ded0eb8f4f0c, 0);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnBox_4c502fa0-0dda-4e58-b55e-56b363256448,(TRIGGER)S_END_SwarmStartPoint_002_ba4fb053-5e8c-4df7-b18b-68dcb0390ec0, 1);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnBox_4c502fa0-0dda-4e58-b55e-56b363256448,(TRIGGER)S_END_SwarmStartPoint_003_d45f52a1-1284-493b-a6f8-0f4b9517618c, 2);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnBox_4c502fa0-0dda-4e58-b55e-56b363256448,(TRIGGER)S_END_SwarmStartPoint_004_53aa949c-5bfe-4b85-9120-09a9290d6b5d, 3);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L1_b79fffcb-0b27-4d0b-8ebe-8f034a279034,(TRIGGER)S_END_SwarmStartPoint_005_56b8ab1d-614b-43ce-a1a3-0255121c5e77, 0);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L1_b79fffcb-0b27-4d0b-8ebe-8f034a279034,(TRIGGER)S_END_SwarmStartPoint_006_12fff5df-3cfc-4100-9744-eb2676a81deb, 1);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L1_b79fffcb-0b27-4d0b-8ebe-8f034a279034,(TRIGGER)S_END_SwarmStartPoint_007_40973176-2fb7-46fb-9d80-9528373807d9, 2);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L1_b79fffcb-0b27-4d0b-8ebe-8f034a279034,(TRIGGER)S_END_SwarmStartPoint_008_f516da89-9a71-4c1a-89f6-ef8e2ffdc4e5, 3);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R1_dcf40887-9cc9-4a86-8b4d-0610336162b8,(TRIGGER)S_END_SwarmStartPoint_017_ff3667ab-9c7e-4abb-87e7-c2e76a950f59, 0);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R1_dcf40887-9cc9-4a86-8b4d-0610336162b8,(TRIGGER)S_END_SwarmStartPoint_018_2cbd32e9-94b6-4bcb-85ff-a7d6edccae59, 1);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R1_dcf40887-9cc9-4a86-8b4d-0610336162b8,(TRIGGER)S_END_SwarmStartPoint_019_820df6fe-bb79-43eb-abbb-c5301ce4b782, 2);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R1_dcf40887-9cc9-4a86-8b4d-0610336162b8,(TRIGGER)S_END_SwarmStartPoint_020_a7369106-0951-44da-ab40-d49b86972295, 3);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L2_32624262-58e0-4c71-a44b-d6ff3f93484f,(TRIGGER)S_END_SwarmStartPoint_009_91672eba-4b66-40b2-93d8-6136af0141f9, 0);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L2_32624262-58e0-4c71-a44b-d6ff3f93484f,(TRIGGER)S_END_SwarmStartPoint_010_29db7338-2d18-4840-9d22-2333218de613, 1);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L2_32624262-58e0-4c71-a44b-d6ff3f93484f,(TRIGGER)S_END_SwarmStartPoint_011_4d2ba4c0-eb84-4f45-84f5-19ad7f6fe65c, 2);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L2_32624262-58e0-4c71-a44b-d6ff3f93484f,(TRIGGER)S_END_SwarmStartPoint_012_b0d7e5dc-8282-416d-a7c7-19275fdc677f, 3);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R2_f2a22886-8cac-4ca9-87d5-39a65cfaaee8,(TRIGGER)S_END_SwarmStartPoint_021_f0464ba5-531b-4f64-bc3a-59f91a406f92, 0);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R2_f2a22886-8cac-4ca9-87d5-39a65cfaaee8,(TRIGGER)S_END_SwarmStartPoint_022_a0eca5d9-b81e-4723-aa5e-af4ce44cb430, 1);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R2_f2a22886-8cac-4ca9-87d5-39a65cfaaee8,(TRIGGER)S_END_SwarmStartPoint_023_f0f1dac9-6bbb-4aae-96c9-0d21c9ffacc6, 2);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R2_f2a22886-8cac-4ca9-87d5-39a65cfaaee8,(TRIGGER)S_END_SwarmStartPoint_024_21dd561c-7912-4576-9a5b-5e1cc493a83e, 3);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L3_6e98f720-05db-4e97-975f-a625997233da,(TRIGGER)S_END_SwarmStartPoint_013_75f2baa8-15ec-4e8c-9d9a-eb10769a8422, 0);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L3_6e98f720-05db-4e97-975f-a625997233da,(TRIGGER)S_END_SwarmStartPoint_014_a64ab66b-7cf1-4e60-993d-226381b1a124, 1);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L3_6e98f720-05db-4e97-975f-a625997233da,(TRIGGER)S_END_SwarmStartPoint_015_61852a44-afbd-46f4-a605-f962f1c3a1b2, 2);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_L3_6e98f720-05db-4e97-975f-a625997233da,(TRIGGER)S_END_SwarmStartPoint_016_60e23074-cfe2-4db4-9737-46a9efd55d83, 3);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R3_3e017c8e-121e-4cbb-bc42-16fb6b6dfc2c,(TRIGGER)S_END_SwarmStartPoint_025_f327640c-979b-4cf4-a844-6eaa8c9bc40e, 0);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R3_3e017c8e-121e-4cbb-bc42-16fb6b6dfc2c,(TRIGGER)S_END_SwarmStartPoint_026_ad29fda6-fcde-43bd-bb50-890c8759c86d, 1);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R3_3e017c8e-121e-4cbb-bc42-16fb6b6dfc2c,(TRIGGER)S_END_SwarmStartPoint_027_f7885109-7dad-43e3-b8db-c791a8c98e48, 2);
DB_END_HighHallInterior_IntDevSubSpawnPoints((TRIGGER)S_END_IntDevSwarmSpawnPoint_R3_3e017c8e-121e-4cbb-bc42-16fb6b6dfc2c,(TRIGGER)S_END_SwarmStartPoint_028_d4ec64c2-f291-4709-8117-fef67cffa8fa, 3);
DB_BUGFIX_Marker("GUS-289385");
//END_REGION

//REGION GUS-302809
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-302809");
PROC_END_AllyAbility_CacheConfiggedSummons();

PROC
PROC_END_AllyAbility_CacheConfiggedSummons()
AND
DB_END_AllyAbilities_Summons(_, _, _Summon, _)
AND
NOT GetAnubisConfig(_Summon, "")
THEN
DB_END_AllyAbility_ConfiggedSummons(_Summon);
//END_REGION

//REGION GUS-206692
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_END_GatherYourAllies_PresentCharacter((CHARACTER)_Character)
THEN
DB_BUGFIX_Marker("GUS-206692");
SetCombatGroupID(_Character, "");
//END_REGION

//REGION GUS-307320
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_END_AllyAbilities_Summons(_, _, (CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _)
THEN
DB_BUGFIX_Marker("GUS-307320");
ApplyStatus((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "TUT_RESTORATION", 6.0, 1, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
//END_REGION

//REGION GUS-306369

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_END_RealPartOfTheTeam(_Character)
AND
DB_GEN_OrinsAbduction_ChosenChar(_Character)
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9)
THEN
DB_BUGFIX_Marker("GUS-306369");
NOT DB_END_RealPartOfTheTeam(_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_CurrentLevel("END_Main")
AND
DB_END_RealPartOfTheTeam(_Character)
AND
NOT DB_PartyMembers(_Character)
THEN
DB_BUGFIX_Marker("GUS-306369");
PROC_CharacterFullRestore(_Character);

//END_REGION

//REGION 
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
GetRelation((FACTION)ACT3_END_GatheredAllies_4bc4ab0d-e405-4559-9ab6-f58feab2160f, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 100)
THEN
DB_BUGFIX_Marker("GUS-308370");
PROC_SetRelationToPlayers(ACT3_END_GatheredAllies_4bc4ab0d-e405-4559-9ab6-f58feab2160f, 50);
//END_REGION

//REGION GUS-302123

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_InRegion(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad)
THEN
DB_BUGFIX_Marker("GUS-302123");
TriggerUnregisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

//END_REGION

//REGION GUS-308787
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_END_GatherYourAllies_PotentialCharacter((CHARACTER)S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, (TRIGGER)S_END_AstarionGroupPoint_3d35339f-0048-42f3-836e-a6ea5098e952, (FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546)
THEN
DB_BUGFIX_Marker("GUS-308787");
NOT DB_END_GatherYourAllies_PotentialCharacter((CHARACTER)S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, (TRIGGER)S_END_AstarionGroupPoint_3d35339f-0048-42f3-836e-a6ea5098e952, (FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546);
DB_END_GatherYourAllies_PotentialCharacter((CHARACTER)S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, (TRIGGER)S_END_AstarionGroupPoint_3d35339f-0048-42f3-836e-a6ea5098e952, (FLAG)LOW_GurFollowUp_State_PeacefulResolution_260836ee-6f67-4ea4-9e2c-ccae94a75035);
PROC_END_AllyAbility_AddGurAbility();

PROC
PROC_END_AllyAbility_AddGurAbility()
AND
DB_GlobalFlag((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
DB_GlobalFlag((FLAG)LOW_GurFollowUp_State_PeacefulResolution_260836ee-6f67-4ea4-9e2c-ccae94a75035)
AND
DB_Players(_Player)
AND
GetFlag(END_GatherYourAllies_State_BeyondHirelings_7b3f93f8-274d-4803-a9bc-5023590c91c4, _Player, 1)
AND
HasSpell(_Player, "Shout_END_AllyAbilities_MultipleSummon", 1)
THEN
AddSpell(_Player, "Target_END_AllyAbilities_GurSummon", 1, 0);
DB_END_AllyAbilities_Summons("Target_END_AllyAbilities_GurSummon", "END_ALLYABILITIES_GURALLIESINTERDICTED", (CHARACTER)S_END_GurHunter_001_4a0d7314-d355-40ff-95d3-eca357dd305c, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
DB_END_AllyAbilities_Summons("Target_END_AllyAbilities_GurSummon", "END_ALLYABILITIES_GURALLIESINTERDICTED", (CHARACTER)S_END_GurHunter_002_b971a780-74ae-45ae-ac12-3bd81fc72696, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
DB_END_AllyAbilities_Summons("Target_END_AllyAbilities_GurSummon", "END_ALLYABILITIES_GURALLIESINTERDICTED", (CHARACTER)S_END_GurHunter_003_57695b10-4011-46fa-b2a7-8cbb0a98423c, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
SetCanJoinCombat((CHARACTER)S_END_GurHunter_001_4a0d7314-d355-40ff-95d3-eca357dd305c, 0);
SetCanJoinCombat((CHARACTER)S_END_GurHunter_002_b971a780-74ae-45ae-ac12-3bd81fc72696, 0);
SetCanJoinCombat((CHARACTER)S_END_GurHunter_003_57695b10-4011-46fa-b2a7-8cbb0a98423c, 0);

PROC
PROC_END_AllyAbility_AddGurAbility()
THEN
SetFaction((CHARACTER)S_END_GurHunter_001_4a0d7314-d355-40ff-95d3-eca357dd305c, (FACTION)ACT3_END_AllyAbilities_Summon_ab4018cf-9f02-48aa-9c52-469b279c651a);
SetTag((CHARACTER)S_END_GurHunter_001_4a0d7314-d355-40ff-95d3-eca357dd305c, (TAG)ACT3_END_MINDPORTALDISABLED_6f7d24c4-ffdf-4258-bf74-bb7f155ef83e);
SetFaction((CHARACTER)S_END_GurHunter_002_b971a780-74ae-45ae-ac12-3bd81fc72696, (FACTION)ACT3_END_AllyAbilities_Summon_ab4018cf-9f02-48aa-9c52-469b279c651a);
SetTag((CHARACTER)S_END_GurHunter_002_b971a780-74ae-45ae-ac12-3bd81fc72696, (TAG)ACT3_END_MINDPORTALDISABLED_6f7d24c4-ffdf-4258-bf74-bb7f155ef83e);
SetFaction((CHARACTER)S_END_GurHunter_003_57695b10-4011-46fa-b2a7-8cbb0a98423c, (FACTION)ACT3_END_AllyAbilities_Summon_ab4018cf-9f02-48aa-9c52-469b279c651a);
SetTag((CHARACTER)S_END_GurHunter_003_57695b10-4011-46fa-b2a7-8cbb0a98423c, (TAG)ACT3_END_MINDPORTALDISABLED_6f7d24c4-ffdf-4258-bf74-bb7f155ef83e);
//END_REGION

//REGION GUS-307543
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
THEN
DB_BUGFIX_Marker("GUS-307543");
PROC_END_GameFinale_PopulateDeathOfKarlachAvatar();

PROC
PROC_END_GameFinale_PopulateDeathOfKarlachAvatar()
AND
NOT DB_END_GameFinale_DeathOfKarlachAvatar(_)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
GetFlag((FLAG)END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, _Avatar, 1)
THEN
DB_END_GameFinale_DeathOfKarlachAvatar(_Avatar);

PROC
PROC_END_GameFinale_PopulateDeathOfKarlachAvatar()
AND
NOT DB_END_GameFinale_DeathOfKarlachAvatar(_)
AND
DB_END_GameFinale_QueuedPartneredSpeakers(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _Avatar, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
QRY_END_GameFinale_CharacterCannotFinale(_Avatar)
AND
DB_END_General_MainDialogAnchor(_NewAvatar)
THEN
DB_END_GameFinale_DeathOfKarlachAvatar((CHARACTER)_NewAvatar);

PROC
PROC_END_GameFinale_PopulateDeathOfKarlachAvatar()
AND
NOT DB_END_GameFinale_DeathOfKarlachAvatar(_)
AND
DB_END_GameFinale_QueuedPartneredSpeakers(END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, _Avatar, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_END_GameFinale_DeathOfKarlachAvatar((CHARACTER)_Avatar);
//END_REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_CurrentLevel("END_Main")
AND
DB_PartOfTheTeam(_Character)
AND
NOT DB_PartyMembers(_Character)
AND
NOT DB_PermaDefeated(_Character)
THEN
PROC_CharacterFullRestore(_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_END_GameFinale_NoSeque(END_GameFinale_Event_GaleBecameGod_e85955a3-58d0-17ea-2d31-ed3713121d9b)
THEN
NOT DB_END_GameFinale_NoSeque(END_GameFinale_Event_GaleBecameGod_e85955a3-58d0-17ea-2d31-ed3713121d9b);
DB_END_GameFinale_NoSeque(ORI_Gale_State_ClaimedCrown_93279f0c-82f0-b1e5-ff24-34a47c47a85d);


//REGION GUS-306148

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_END_General_MakeUnavailableFlag((CHARACTER)_Character, (FLAG)_Flag)
THEN
NOT DB_END_General_MakeUnavailableFlag(_Character, _Flag);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_END_General_MakeUnavailableCharacterFlag((FLAG)_Flag)
THEN
DB_BUGFIX_Marker("GUS-306148");
NOT DB_END_General_MakeUnavailableCharacterFlag(_Flag);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
THEN
DB_END_General_MakeUnavailableFlag((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (FLAG)END_GameFinale_State_LaezelLeavesFaerun_896fb62a-4f56-41d8-a173-7d06c4cb9209, 1);
DB_END_General_MakeUnavailableFlag(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, END_BrainBattle_Event_KillKarlach_796fc0c1-607e-fc25-2eca-845c453f9afc, 1);
DB_END_General_MakeUnavailableFlag(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, ORI_Gale_State_InElysium_d6c53ee8-ce94-4016-73ee-74d44d309837, 1);
DB_END_General_MakeUnavailableFlag(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, ORI_Gale_State_ChallengedMystra_d6dfa722-f85e-e191-a7e0-776d19c9f18a, 0);
DB_END_General_MakeUnavailableFlag(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, END_CombatOver_State_PlayerKilledLaezel_dc67028e-f26e-a092-ae9a-809234a6bc6d, 0);
DB_END_General_MakeUnavailableFlag(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, GLO_END_GameFinale_DeathofKarlach_KarlachWentWithNonRomanceWyll_a552e386-af26-eb98-d198-a84221e467b0, 1);
DB_END_General_MakeUnavailableFlag(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,  END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, 1);
DB_END_General_MakeUnavailableFlag(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, GLO_END_GameFinale_DeathofKarlach_KarlachWentWithNonRomanceWyll_a552e386-af26-eb98-d198-a84221e467b0, 1);
DB_END_General_MakeUnavailableCharacterFlag(END_BrainBattle_Event_Suicide_ad1258fa-27eb-537c-a113-91db07cb6590, 0);
DB_END_General_MakeUnavailableCharacterFlag(END_BrainBattle_Event_GoToJail_4a021214-a319-a17b-13f6-c3427c794684, 1);
NOT DB_END_General_MakeUnavailableFlag(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, ORI_Gale_State_ClaimedCrown_93279f0c-82f0-b1e5-ff24-34a47c47a85d, 1);

//END_REGION

//REGION GUS-302328
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_Avatars(_Avatar)
AND
GetFaction(_Avatar, _AvatarFaction)
AND
DB_AvatarFactions(_AvatarFaction)
AND
DB_CompanionFactions(_CompanionFaction)
AND
GetRelation(_AvatarFaction, _CompanionFaction, 100)
THEN
SetRelation(_AvatarFaction, _CompanionFaction, 100);
//END_REGION

//REGION GUS-
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
THEN
DB_LOW_MurderTribunal_StartedTrialDialog(1);
//END_REGION

//REGION GUS-309896

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_CurrentLevel("END_Main")
AND
NOT DB_ItemShopTrigger((TRIGGER)S_END_KossOwnershipBox_c9525524-4ee2-4679-8ae0-e64bda1defa4, (CHARACTER)S_END_CircusTrader_c94a8e45-b601-4193-bb6a-aed77692c981)
THEN
DB_BUGFIX_Marker("GUS-309896");
DB_ItemShopTrigger((TRIGGER)S_END_KossOwnershipBox_c9525524-4ee2-4679-8ae0-e64bda1defa4, (CHARACTER)S_END_CircusTrader_c94a8e45-b601-4193-bb6a-aed77692c981);

//END_REGION

//REGION GUS-307551

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_END_BrainBattle_Start(1)
AND
NOT DB_END_BrainBattle_PausedCombat(_)
AND
NOT DB_END_BrainBattle_PausedMindCombat(_)
AND
IsDead(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, 0)
THEN
PROC_END_BrainBattle_GUS307551_RestartCombat();

PROC
PROC_END_BrainBattle_GUS307551_RestartCombat()
AND
DB_Is_InCombat(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, _ID)
THEN
DB_BUGFIX_Marker("GUS-307551");
ResumeCombat(_ID);

PROC
PROC_END_BrainBattle_GUS307551_RestartCombat()
AND
DB_Is_InCombat(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, _ID)
AND
NOT DB_BUGFIX_Marker("GUS-307551")
THEN
DB_BUGFIX_Marker("GUS-307551");
ResumeCombat(_ID);

//END_REGION

//REGION GUS-313403

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
THEN
PROC_EPI_Epilogue_CheckDisable();

PROC
PROC_EPI_Epilogue_CheckDisable()
AND
DB_GlobalFlag(END_BrainBattle_Event_EvilFinalDecision_71617aed-6f56-ad38-5657-189de2628cc8)
THEN
DB_EPI_Epilogue_Disabled(1);

PROC
PROC_EPI_Epilogue_CheckDisable()
AND
DB_GlobalFlag(END_FinalDecisions_Event_PlayerDestroyedBrain_86f3e51d-873b-204d-7328-0c982f83e623)
THEN
DB_EPI_Epilogue_Disabled(1);

PROC
PROC_EPI_Epilogue_CheckDisable()
AND
DB_GlobalFlag(END_FinalDecisions_Event_EmperorDestroyedBrain_30d7e102-fff0-6988-70ce-9ef85112b7e9)
THEN
DB_EPI_Epilogue_Disabled(1);

PROC
PROC_EPI_Epilogue_CheckDisable()
AND
DB_GlobalFlag(END_FinalDecisions_Event_OrpheusDestroyedBrain_a523e52b-3c07-0625-bd23-e23eef8fbf77)
THEN
DB_EPI_Epilogue_Disabled(1);

PROC
PROC_EPI_Epilogue_CheckDisable()
AND
DB_GlobalFlag(END_FinalDecisions_Event_GaleExploded_a32e3cb5-9536-3c3e-a4d2-1837ee3b6190)
THEN
DB_EPI_Epilogue_Disabled(1);

PROC
PROC_EPI_Epilogue_CheckDisable()
AND
DB_GlobalFlag(END_BrainBattle_Event_GaleAscendsTheStalkAlone_217731da-1297-09b6-52b0-e9ee8580e70c)
THEN
DB_EPI_Epilogue_Disabled(1);

//END_REGION GUS-307052

//REGION GUS-307052

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
QRY_OnlyOnce("END_BlockNewPlayers")
THEN
SetJoinBlock(JOINBLOCKTYPE.BlockNew);
DB_BUGFIX_Marker("GUS-307052");

//END_REGION GUS-307052

//REGION GUS-314165

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_END_BrainBattle_Start(1)
AND
NOT DB_InRegion(_, S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad)
AND
DB_PartyMembers(_Character)
AND
IsSummon(_Character, 1)
AND
IsInTrigger(_Character, S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, 1)
THEN
DB_BUGFIX_Marker("GUS-314165");
SetOnStage(_Character, 0);

//END_REGION

//REGION
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_END_RealPartOfTheTeam((CHARACTER)_Character)
AND
NOT DB_ApprovalRating(_, _Character, _)
AND
DB_Avatars((CHARACTER)_Avatar)
THEN
DB_ApprovalRating(_Character, _Avatar, 0);
//END_REGION

//REGION GUS-312131
// Set DB so Karlach can be considered dead if she dies in END
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "END_Main", "GUS-312131");

PROC
PROC_ApplySavegamePatchInLevel("END_Main","GUS-312131")
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
THEN
DB_ORI_EPIPermaDefeatedFlags((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (FLAG)ORI_Karlach_State_EngineBurnedOut_2cd8d398-d6ec-3227-2dfb-975127fb5393);
//END_REGION GUS-312131

//REGION GUS-315463

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_END_General_FullPartyDialog(_Dialog, _IncludeTeam, _AddAfterStart, _BlockAttack, _BlockTrade, _IgnoreDefeated, _IgnoreCombat, 1)
AND
NOT DB_IgnoreMutingStatussesDialog(_Dialog)
THEN
DB_BUGFIX_Marker("GUS-315463");
DB_IgnoreMutingStatussesDialog(_Dialog);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_END_General_FullPartyDialog(_Dialog, _IncludeTeam, _AddAfterStart, _BlockAttack, _BlockTrade, _IgnoreDefeated, _IgnoreCombat, 2)
AND
NOT DB_DropMutingStatussesDialog(_Dialog)
THEN
DB_BUGFIX_Marker("GUS-315463");
DB_DropMutingStatussesDialog(_Dialog);


//END_REGION

//REGION GUS-315705

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_END_BrainBattle_Start(1)
AND
NOT DB_Dead(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1)
AND
GetRelation((FACTION)ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 100)
THEN
DB_BUGFIX_Marker("GUS-315705");
PROC_SetRelationToPlayers((FACTION)ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, 0);

//END_REGION

//REGION GUS-313922
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("END_Main")
THEN
DB_END_General_FullPartyDialog((DIALOGRESOURCE)END_GameFinale_AvatarLaezelFinalChoice_d10594c3-607a-0b0c-bd1d-96b1ee614091, 0, 1, 1, 1, 1, 1, 2);
DB_BUGFIX_Marker("GUS-313922");
//END_REGION

//REGION GUS-309900
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_END_KossLooseItems((ITEM)MAG_Illithid_MindOverload_Weapon_Longsword_000_10e6fd01-2813-4d5c-a823-686c960ac33f)
THEN
DB_END_KossLooseItems((ITEM)MAG_Illithid_MindOverload_Weapon_Longsword_000_10e6fd01-2813-4d5c-a823-686c960ac33f);
DB_END_KossLooseItems((ITEM)LOOT_SCROLL_CharmPerson_000_1e00dc8f-3e21-4c5a-bfd0-9c546b50d6bd);
DB_END_KossLooseItems((ITEM)QUEST_FOR_Village_Blacksmith_FineWeapon_000_5d30e1f7-e715-4844-99a9-9a3931f445cc);
DB_END_KossLooseItems((ITEM)MAG_Fire_HeatOnWeaponDamage_Battleaxe_000_272c65af-1847-43c9-8ab4-ce5a11e86903);
DB_END_KossLooseItems((ITEM)CONS_Potion_Antitoxin_000_762bc4c5-7fd3-45ea-9521-c2d8b30f7fc9);
DB_END_KossLooseItems((ITEM)LOOT_SCROLL_ArcaneLock_000_4001df83-0421-4426-b9ec-71284173d117);
DB_END_KossLooseItems((ITEM)LOOT_SCROLL_BestowCurse_000_9afed2fb-3779-46c0-b165-7cb782f3c28c);
DB_END_KossLooseItems((ITEM)LOOT_SCROLL_AcidArrow_000_82bb11eb-3e64-446b-8d16-da96451a0900);
DB_END_KossLooseItems((ITEM)LOOT_SCROLL_Blindness_000_8d2b7796-9860-49c6-858a-92223f13b98b);
DB_END_KossLooseItems((ITEM)CONS_Potion_Cloud_Giant_Strength_000_e8d87d22-f2a8-4c18-a510-a2d7c6884b84);
DB_END_KossLooseItems((ITEM)CONT_GEN_Burlap_Sack_F_9ed0cdae-e9ed-4eea-b1cc-6af862c1b678);
DB_END_KossLooseItems((ITEM)CONS_Potion_Barkskin_A_000_c5ea8498-065e-493f-8f7c-cb9ba8c500e0);
DB_END_KossLooseItems((ITEM)MAG_Healer_HealSelfPoisonWeapon_Amulet_000_cecc84c0-b051-4752-b45a-6da91a147433);
//END_REGION

//REGION GUS-314787

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
NOT DB_END_BrainBattle_EvilEndingFlag((FLAG)END_FinalDecision_Event_QueueEvilAvatar_982afed6-1f17-57a6-dc65-aaf5eb1685d9, (DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilAvatar_e0069683-63a6-f619-cf62-5dc4105a11ba)
THEN
DB_BUGFIX_Marker("GUS-314787");
DB_END_BrainBattle_EvilEndingFlag((FLAG)END_FinalDecision_Event_QueueEvilAvatar_982afed6-1f17-57a6-dc65-aaf5eb1685d9, (DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilAvatar_e0069683-63a6-f619-cf62-5dc4105a11ba);
DB_END_BrainBattle_EvilEndingFlag((FLAG)END_FinalDecision_Event_QueueEvilDU_aa66f591-0de6-dabb-059b-bc4fc04df2bd, (DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilDurge_dee4fb08-6170-7221-fb87-51733bbd7220);
DB_END_BrainBattle_EvilEndingFlag((FLAG)END_FinalDecision_Event_QueueEvilEmperor_f4b9c398-2f07-e21a-e7fc-e569f844211b, (DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilEmperor_b5525d0a-e217-9ed9-bc06-e98e2ce1b362);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilDurge_dee4fb08-6170-7221-fb87-51733bbd7220, (FLAG)END_FinalDecision_State_State_EvilDurgeHasCompanions_7d6b03eb-1a4b-4db3-b77f-a1bc0c2a077c, 2, 11); 
DB_END_General_FullPartyDialog(END_BrainBattle_FinalDecision_Nested_EvilAvatar_e0069683-63a6-f619-cf62-5dc4105a11ba, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_BrainBattle_FinalDecision_Nested_EvilDurge_dee4fb08-6170-7221-fb87-51733bbd7220, 0, 1, 1, 1, 1, 1, 2);
DB_END_General_FullPartyDialog(END_BrainBattle_FinalDecision_Nested_EvilEmperor_b5525d0a-e217-9ed9-bc06-e98e2ce1b362, 0, 1, 1, 1, 1, 1, 2);

//END_REGION

//REGION GUS-GUS-314514
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
NOT DB_END_GatherYourAllies_PotentialCharacter((CHARACTER)S_END_KuotoaPointOfContact_265239be-2489-496d-936d-e78240ce2165, (TRIGGER)S_END_KuoToaGroupPoint_d0db2d7d-260f-40a2-a276-4a91a8b58021, (FLAG)END_GatherYourAllies_Event_KuotoaPromisedENDSupport_099fbdae-4e4f-eecd-6747-8d5a9f59fe22)
THEN
DB_END_GatherYourAllies_PotentialCharacter((CHARACTER)S_END_KuotoaPointOfContact_265239be-2489-496d-936d-e78240ce2165, (TRIGGER)S_END_KuoToaGroupPoint_d0db2d7d-260f-40a2-a276-4a91a8b58021, (FLAG)END_GatherYourAllies_Event_KuotoaPromisedENDSupport_099fbdae-4e4f-eecd-6747-8d5a9f59fe22);
DB_END_GatherYourAllies_FollowUpDialogue((CHARACTER)S_END_KuotoaPointOfContact_265239be-2489-496d-936d-e78240ce2165, (DIALOGRESOURCE)END_GatherYourAllies_KuoToaFollowUp_202d3335-9349-1f52-563b-86f7f4395c9c, "END_KuoToa");
DB_END_GatherYourAllies_AllyAwardFlags((FLAG)END_GatherYourAllies_Event_KuoToaReinforcementAwarded_f253beab-073b-4bf3-9199-f0437174bc13, (CHARACTER)S_END_KuotoaPointOfContact_265239be-2489-496d-936d-e78240ce2165);
DB_END_AllyAbilities_Abilities((FLAG)END_GatherYourAllies_Event_KuoToaReinforcementAwarded_f253beab-073b-4bf3-9199-f0437174bc13, "Target_END_AllyAbilities_KuoToaSummon", 7, "END_ALLYABILITIES_KUOTOAABILITY");
DB_END_AllyAbility_PermanentAbilityRemoval("Target_END_AllyAbilities_KuoToaSummon", "END_ALLYABILITIES_KUOTOACONSUMED");
DB_END_AllyAbilities_PotentialSummons("Target_END_AllyAbilities_KuoToaSummon", "END_ALLYABILITIES_KUOTOAINTERDICTED", (CHARACTER)S_END_KuoToaSummon_001_db8ace21-4e28-4c81-a009-4b3cd2ad3618, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
DB_END_AllyAbilities_PotentialSummons("Target_END_AllyAbilities_KuoToaSummon", "END_ALLYABILITIES_KUOTOAINTERDICTED", (CHARACTER)S_END_KuoToaSummon_002_7f8ab817-ccfe-447c-a410-133dfacb3e72, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
DB_END_AllyAbilities_PotentialSummons("Target_END_AllyAbilities_KuoToaSummon", "END_ALLYABILITIES_KUOTOAINTERDICTED", (CHARACTER)S_END_KuoToaSummon_003_71279257-240c-497e-b81c-4e4dcc41e350, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
DB_END_AllyAbilities_PotentialSummons("Target_END_AllyAbilities_KuoToaSummon", "END_ALLYABILITIES_KUOTOAINTERDICTED", (CHARACTER)S_END_KuoToaSummon_004_53e1fe36-1208-4f8f-9920-0edead602882, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
DB_END_AllyAbilities_PotentialSummons("Target_END_AllyAbilities_KuoToaSummon", "END_ALLYABILITIES_KUOTOAINTERDICTED", (CHARACTER)S_END_KuoToaSummon_005_73a973da-0c0e-41d3-916e-90bba5e38cab, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
DB_END_AllyAbilities_PotentialSummons("Target_END_AllyAbilities_KuoToaSummon", "END_ALLYABILITIES_KUOTOAINTERDICTED", (CHARACTER)S_END_KuoToaSummon_006_c43d718c-1600-4e0a-a335-0a88fb1fc038, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
DB_END_AllyAbilities_PotentialSummons("Target_END_AllyAbilities_KuoToaSummon", "END_ALLYABILITIES_KUOTOAINTERDICTED", (CHARACTER)S_END_KuoToaSummon_007_94d7df25-a5cd-46f6-b1b4-895bb2539c4a, (ANIMATION)NULL_00000000-0000-0000-0000-000000000000);
DB_END_AllyAbilities_SummonedAllyAD((CHARACTER)S_END_KuotoaPointOfContact_265239be-2489-496d-936d-e78240ce2165, (DIALOGRESOURCE)END_GatherYourAllies_AD_KuoToaSummonResponse_f136e5c2-3b5f-9293-59ee-3bd02a952597);
DB_QuestDef_State((FLAG)END_GatherYourAllies_Event_KuotoaPromisedENDSupport_099fbdae-4e4f-eecd-6747-8d5a9f59fe22, "GLO_GatherYourAllies", "KuotoaPromisesSupport");
DB_END_GatherYourAllies_GoodAllyFlags((FLAG)END_GatherYourAllies_Event_KuotoaPromisedENDSupport_099fbdae-4e4f-eecd-6747-8d5a9f59fe22);
//END_REGION

//REGION GUS-309413
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_END_Reinforcements_Characters(_, _Char)
AND
DB_KnockedOut(_Char)
AND
CanJoinCombat(_Char, 1)
THEN
PROC_SetCanFight(_Char, 0);
SetCanJoinCombat(_Char, 0);
DB_BUGFIX_Marker("GUS-309413", _Char);
//END_REGION GUS-309413

//REGION GUS-317097
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("END_Main")
THEN
DB_END_GatherYourAllies_PartyAlly_Clothes((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (ITEMROOT)ARM_Camp_Body_Shadowheart_7062410b-439c-4f2f-bc48-1c16ab1ace20);
DB_END_GatherYourAllies_PartyAlly_Clothes((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (ITEMROOT)ARM_Camp_Body_Jaheira_0d0d9c0f-e9aa-4ba4-a0a9-1a0b7b7069ca);
DB_END_GatherYourAllies_PartyAlly_Clothes((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (ITEMROOT)ARM_Camp_Body_Halsin_dc74db6c-14b2-44fa-8415-0dd1194e90e2);
DB_END_GatherYourAllies_PartyAlly_Clothes((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (ITEMROOT)ARM_Camp_Body_Astarion_b7392453-6569-4c24-9a1b-cbaea7cebac8);
DB_BUGFIX_Marker("GUS-317097");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_END_GatherYourAllies_PartyAlly_Clothes(_Character, _)
AND
DB_END_GatherYourAllies_PresentCharacter(_Character)
THEN
PROC_END_GatherYourAllies_PartyAlly_CheckClothes(_Character);
DB_BUGFIX_Marker("GUS-317097", _Character);
//END_REGION GUS-317097

//REGION GUS-318771
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 3")
AND
DB_GlobalFlag(END_General_State_CurrentlyInHighHall_118b3dc5-dab8-4872-92da-ab01c15fa55e)
AND
DB_PartyMembers(_Player)
AND
DB_Is_InCombat(_Player, _ID)
AND
NOT DB_END_HighHallInterior_PausedCombatPlayer(_Player, _ID)
AND
NOT DB_END_BrainBattle_PausedCombat(_ID)
AND
NOT DB_END_BrainBattle_PausedMindCombat(_ID)
THEN
ResumeCombat(_ID);
DB_BUGFIX_Marker("GUS-318771", _Player);
//END_REGION GUS-318771

//REGION GUS-318633
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_InRegion(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_END_NetherbrainArena_001_SUB_a79f975d-d33a-455b-a444-9a0d08f59c57)
AND
DB_ORI_Gale_SuicideSpell(_Spell)
AND
HasSpell((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Spell, 1)
THEN
DB_BUGFIX_Marker("GUS-318633");
RemoveSpell((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Spell, 1);
//END_REGION GUS-318633

//REGION GUSX-7344
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_CurrentLevel("END_Main")
AND
DB_PermaDefeated(S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_GainedGondianENDSupport_1bb09a8b-001d-4b43-9f39-ba89eb3aece9)
AND
NOT DB_GlobalFlag(END_GatherYourAllies_State_BeyondHirelings_7b3f93f8-274d-4803-a9bc-5023590c91c4)
AND
NOT QRY_AnyPlayerInTrigger(S_END_PartyMemberTeleport_b8d5ff34-ccc2-425c-a712-172497273dc0)
THEN
DB_BUGFIX_Marker("GUSX-7344");
DB_END_SteelwatchAllyBeingResurrected(1);
Resurrect(S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674);


IF
Resurrected(S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674)
AND
DB_END_SteelwatchAllyBeingResurrected(1)
THEN
NOT DB_END_SteelwatchAllyBeingResurrected(1);
AddPassive(END_GatherYourAllies_State_BeyondHirelings_7b3f93f8-274d-4803-a9bc-5023590c91c4,"SelfDestruct_SteelWatcher");
ApplyStatus(END_GatherYourAllies_State_BeyondHirelings_7b3f93f8-274d-4803-a9bc-5023590c91c4,"STEELWATCHER_BIPED_SELFDESTRUCT_BEGIN_DEATHWARD", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(END_GatherYourAllies_State_BeyondHirelings_7b3f93f8-274d-4803-a9bc-5023590c91c4,"STEELWATCHER_BIPED_SELFDESTRUCT_BEGIN_TECHNICAL", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(END_GatherYourAllies_State_BeyondHirelings_7b3f93f8-274d-4803-a9bc-5023590c91c4,"STEELWATCHER_QUADRUPED_SELFDESTRUCT_BEGIN_TECHNICAL", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(END_GatherYourAllies_State_BeyondHirelings_7b3f93f8-274d-4803-a9bc-5023590c91c4, "LOW_STEELWATCH_DEACTIVATED", NULL_00000000-0000-0000-0000-000000000000);
PROC_SetOnStage(S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674, 1);
PROC_CharacterFullRestore(S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674);
ClearTag(S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
NOT DB_PermaDefeated(S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674);
DB_END_GatherYourAllies_PotentialCharacter((CHARACTER)S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674, (TRIGGER)S_END_GondianReinforcementGroupPoint_c87d3764-ee83-441b-b0ab-52a50f75c114, (FLAG)LOW_SteelWatchFoundry_State_GainedGondianENDSupport_1bb09a8b-001d-4b43-9f39-ba89eb3aece9);
//END_REGION GUSX-7344

//REGION GUS-319159
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag(END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_IPRD_Event_Finale_1569ec67-be68-4227-8ed4-d6c2f96ead52,_,_,_)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_IPRD_Event_Finale_1569ec67-be68-4227-8ed4-d6c2f96ead52);
DB_BUGFIX_Marker("GUS-319159");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag(END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_MusedGrandDuke_9624400b-e075-f015-b90b-beff3d6adae6,_,_,_)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_MusedGrandDuke_9624400b-e075-f015-b90b-beff3d6adae6);
DB_BUGFIX_Marker("GUS-319159");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag(END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_MusedBlade_879e7ec6-56a5-bada-f54f-14fd5e5ffe07,_,_,_)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_MusedBlade_879e7ec6-56a5-bada-f54f-14fd5e5ffe07);
DB_BUGFIX_Marker("GUS-319159");

//END_REGION

//REGION GUSX-7174
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag(ORI_Wyll_State_FollowKarlachToHells_e91a4ad5-e2f5-b336-f583-9f480ee7544e)
AND
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
GetFlag(ORI_Wyll_State_TogetherButApart_87cd3adb-f4b0-44c0-9c35-d5fa1f0b0784, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 1)
THEN
ClearFlag(ORI_Wyll_State_TogetherButApart_87cd3adb-f4b0-44c0-9c35-d5fa1f0b0784, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
SetFlag(ORI_State_PartneredWithWyll_5db4c1b6-3c42-43ae-aa85-1844acbf5a1d, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_BUGFIX_Marker("GUSX-7174");

//END_REGION GUSX-7174

//REGION GUS-7480

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_CurrentLevel("END_Main")
AND
IsDead(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, 1)
AND
NOT DB_END_BrainBattle_BlockChainGameOver(1)
AND
DB_Is_InCombat(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, _ID)
THEN
DB_BUGFIX_Marker("GUS-7480");
PROC_END_MindBattle_MindDeathSetup(_ID);

IF
Died(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759)
AND 
DB_BUGFIX_Marker("GUS-7480")
AND
DB_END_BrainBattle_DominationCharacter(_DominationCharacter)
THEN
PROC_END_BrainBattle_QueueFullRestore(_DominationCharacter);
DB_END_BrainBattle_DominationCompletedReady(1);

//END_REGION

//REGION GUSX-7668

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
THEN
DB_ORI_Gale_GoalForceFlag(0, 0, (FLAG)ORI_Gale_Event_ForceSetUnwillingToDie_5b3fd6a1-0942-42c1-9913-90efa3588315);
DB_BUGFIX_Marker("GUSX-7668");

//END_REGION GUSX-7668

//REGION GUSX-440
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "END_Main", "GUSX-440");

PROC
PROC_ApplySavegamePatchInLevel("END_Main", "GUSX-440")
AND
DB_GlobalFlag(END_HighHallInterior_State_NautiloidLeft_ed57695e-adb6-4a4e-8f84-4e9dfc28f318)
THEN
QuestMessageHide("END_HighHallInterior_ReachNetherbrainID");
DB_BUGFIX_Marker("GUSX-440");
//END_REGION GUSX-440

//REGION GUSX-7959

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
NOT DB_Level_InaccessibleAfterLoading("IRN_Main_A","END_Main")
THEN
DB_Level_InaccessibleAfterLoading("IRN_Main_A","END_Main");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("END_Main")
AND
DB_LevelLoadedOnce("IRN_Main_A")
AND
NOT QRY_LevelCache_BlockDelete("IRN_Main_A")
THEN
DeleteLevelCache("IRN_Main_A");
DB_BUGFIX_Marker("GUSX-7959");

//END_REGION GUSX-7959

//REGION GUSX-8077
//Remove endgame ally from Steel watcher DB that handles all other watchers in the game
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GLO_SteelWatchers((CHARACTER)S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674)
THEN
NOT DB_GLO_SteelWatchers((CHARACTER)S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674);
DB_BUGFIX_Marker("GUSX-8077a");

//Fix endgame ally if already in endgame
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_CurrentLevel("END_Main")
THEN
SetFaction(S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674, (FACTION)ACT3_END_AllyAbilities_Summon_ab4018cf-9f02-48aa-9c52-469b279c651a);
PROC_SpotPlayers_StopSpotting((CHARACTER)S_END_SteelWatcherAlly_cb20c38a-38f7-46f7-840d-b64b4d363674, "GLO_BrainEscalation_SteelWatcherHostility");
DB_BUGFIX_Marker("GUSX-8077b");
//END_REGION GUSX-8077

//REGION GUSX-7812
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d)
THEN
DB_BUGFIX_Marker("GUSX-7812");
DB_BUGFIX_GaleNotGodFlags((FLAG)ORI_Gale_State_ChallengedMystra_d6dfa722-f85e-e191-a7e0-776d19c9f18a);
DB_BUGFIX_GaleNotGodFlags((FLAG)ORI_Gale_Event_GaveCrownToMystra_3375fd8b-4958-421d-2d51-ff9af5beaaa0);
DB_BUGFIX_GaleNotGodFlags((FLAG)ORI_Gale_State_MystrasChosen_dd2611c4-62e6-9a05-c2a4-f797c9e2692f);
DB_BUGFIX_GaleNotGodFlags((FLAG)ORI_Gale_State_InElysium_d6c53ee8-ce94-4016-73ee-74d44d309837);
PROC_END_BUGFIX_GameFinale_GodGaleFix();

PROC
PROC_END_BUGFIX_GameFinale_GodGaleFix()
AND
DB_BUGFIX_GaleNotGodFlags(_Flag)
AND
DB_GlobalFlag(_Flag)
AND
DB_GlobalFlag(CURRENTREGION_EPI_Main_A_49a342c4-59f2-4861-9048-8fe63a7b7cde)
THEN
ClearFlag((FLAG)ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d);
RemoveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "EPI_GALEGOD", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "EPI_GALEGOD_BUFF_AURA", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "INVULNERABLE_NOT_SHOWN", NULL_00000000-0000-0000-0000-000000000000);
RemoveTransforms(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetLevel(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 12);
NOT DB_BUGFIX_GaleNotGodFlags((FLAG)ORI_Gale_State_ChallengedMystra_d6dfa722-f85e-e191-a7e0-776d19c9f18a);
NOT DB_BUGFIX_GaleNotGodFlags((FLAG)ORI_Gale_Event_GaveCrownToMystra_3375fd8b-4958-421d-2d51-ff9af5beaaa0);
NOT DB_BUGFIX_GaleNotGodFlags((FLAG)ORI_Gale_State_MystrasChosen_dd2611c4-62e6-9a05-c2a4-f797c9e2692f);
NOT DB_BUGFIX_GaleNotGodFlags((FLAG)ORI_Gale_State_InElysium_d6c53ee8-ce94-4016-73ee-74d44d309837);
//END_REGION GUSX-7812

//REGION GUSX-9543
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("END_Main")
AND
NOT DB_OnlyOnce("END_IllithidOptions_AstralArrival")
AND
DB_GlobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9)
AND
DB_END_IllithidOptions_NetherstoneCasterArrived(_Player)
AND
DB_Is_InCombat(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _ID)
THEN
NOT DB_Is_InCombat(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _ID);
PROC_NotifyWhenReadyToTalk(_Player, "END_IllithidOptions_ArrivalDialogReady");
DB_BUGFIX_Marker("GUSX-9543");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("END_Main")
AND
DB_GlobalFlag(END_General_State_CurrentlyInMorphicPool_06208edf-4c61-44a2-932b-b158d9ddd2f0)
AND
DB_Is_InCombat(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _ID)
THEN
NOT DB_Is_InCombat(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _ID);
DB_BUGFIX_Marker("GUSX-9543");
//END_REGION

//REGION GUSX-10197
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
NOT DB_END_General_MakeUnavailableFlag((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (FLAG)ORI_Karlach_State_AvernusAlone_c5ffd6ad-7749-6eb8-992e-48d66766f6b6, 1)
THEN
DB_BUGFIX_Marker("GUSX-10197");
ClearFlag((FLAG)END_GameFinale_Event_KarlachChoseDeath_f9900bec-33dc-44db-ac8c-666dd5b8eec1);
DB_END_General_MakeUnavailableFlag((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (FLAG)ORI_Karlach_State_AvernusAlone_c5ffd6ad-7749-6eb8-992e-48d66766f6b6, 1);
NOT DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithAstarion_30819c8d-b39d-42e7-acd1-2a8c2c309994, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Astarion_73fb7151-e772-cae7-8d7a-bb5eb8e8860a, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
NOT DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithGale_e008e20d-d642-42ed-9008-297b6273aa21, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Gale_81fc2269-0613-259c-b950-c0dcebbb7934, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
NOT DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithHalsin_7b53fe60-bb16-48a9-ae5c-9bce1dfac1a9, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Halsin_a853d059-2572-04c4-88db-d737e4a264f7, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
NOT DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithHalsinSecondary_6af0be74-d032-4a20-876a-11bab5f86db2, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Halsin_a853d059-2572-04c4-88db-d737e4a264f7, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
NOT DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithLaezel_d169a786-6e56-4f0d-a2eb-33c48d8d1160, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Laezel_523b1bb2-0443-79bf-cf3e-8f435ff5f2e9, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
NOT DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Minthara_699ad056-06a4-db4f-53c4-6706dbb7c544, (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
NOT DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithShadowheart_3808ae35-ad4e-465b-800b-63d32b77211e, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Shadowheart_b9ebb9af-ad65-4e64-6015-105e831d49c0, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
NOT DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithWyll_5db4c1b6-3c42-43ae-aa85-1844acbf5a1d, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Wyll_32de9167-3489-9257-e3c1-e430f2f455ab, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
NOT DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithKarlach_d9ff60fa-0af9-45d7-99b4-bd7c3f80ed12, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Karlach_091af35d-0d30-a4bf-b056-9eda505138b5, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithHalsinSecondary_6af0be74-d032-4a20-876a-11bab5f86db2, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Halsin_a853d059-2572-04c4-88db-d737e4a264f7, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithHalsin_7b53fe60-bb16-48a9-ae5c-9bce1dfac1a9, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Halsin_a853d059-2572-04c4-88db-d737e4a264f7, (CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithAstarion_30819c8d-b39d-42e7-acd1-2a8c2c309994, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Astarion_73fb7151-e772-cae7-8d7a-bb5eb8e8860a, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithGale_e008e20d-d642-42ed-9008-297b6273aa21, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Gale_81fc2269-0613-259c-b950-c0dcebbb7934, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithLaezel_d169a786-6e56-4f0d-a2eb-33c48d8d1160, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Laezel_523b1bb2-0443-79bf-cf3e-8f435ff5f2e9, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Minthara_699ad056-06a4-db4f-53c4-6706dbb7c544, (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithShadowheart_3808ae35-ad4e-465b-800b-63d32b77211e, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Shadowheart_b9ebb9af-ad65-4e64-6015-105e831d49c0, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithWyll_5db4c1b6-3c42-43ae-aa85-1844acbf5a1d, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Wyll_32de9167-3489-9257-e3c1-e430f2f455ab, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_END_GameFinale_CharacterPartneredDialogs((FLAG)ORI_State_PartneredWithKarlach_d9ff60fa-0af9-45d7-99b4-bd7c3f80ed12, (DIALOGRESOURCE)END_GameFinale_RomanceFates_Karlach_091af35d-0d30-a4bf-b056-9eda505138b5, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
//END_REGION

//REGION GUSX-7672
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
NOT DB_GlobalFlag((FLAG)SCE_IsobelNightsongReunion_JoiningCamp_cea17782-fc15-19d3-e658-7f2f955ebd9f)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
THEN
//DB_BUGFIX_END_NightsongIsobel((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "Target_END_AllyAbility_NightsongSummon", 1, "END_ALLYABILITIES_NIGHTSONGSUMMON");
//DB_BUGFIX_END_NightsongIsobel((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "Target_END_AllyAbility_IsobelHeal", 0, "END_ALLYABILITIES_ISOBELHEAL");
DB_BUGFIX_END_NightsongIsobel((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_BUGFIX_END_NightsongIsobel((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_END_GatherYourAllies_PotentialCharacter((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (TRIGGER)S_END_IsobelGroupPoint_f8db4a96-c2c1-4e74-9423-5753754babfc, (FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b);
DB_END_GatherYourAllies_PotentialCharacter((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (TRIGGER)S_END_NightsongGroupPoint_494f1aa2-c0a0-4cce-9b65-7234391f4caf, (FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b);
PROC_BUGFIX_END_GiveNightsongIsobel();

//In the ally house post dialogue
PROC
PROC_BUGFIX_END_GiveNightsongIsobel()
AND
DB_Players(_Player)
AND
DB_WasInRegion(_Player, S_END_GatherYourAllies_SUB_6651c6b2-90b2-4380-90f1-7cfd4f5f5c47)
AND
NOT DB_WasInRegion(_Player, S_END_AlliesExitArea_d70ddde8-3aa6-4167-b9d7-eeea5d7f0fc8)
AND
DB_InRegion(_Player, S_END_AlliesHouse_SUB_bc061ec6-3f6f-4057-93ec-bcd1340c79f6)
AND
HasSpell(_Player, "Target_END_AllyAbility_NightsongSummon", 0)
THEN
PROC_BUGFIX_END_SetupNightsongIsobelAllyHouse();
PROC_BUGFIX_END_AddAllyAbility();

//Post Allies House
PROC
PROC_BUGFIX_END_GiveNightsongIsobel()
AND
DB_Players(_Player)
AND
DB_WasInRegion(_Player, S_END_AlliesExitArea_d70ddde8-3aa6-4167-b9d7-eeea5d7f0fc8)
AND
HasSpell(_Player, "Target_END_AllyAbility_NightsongSummon", 0)
THEN
PROC_BUGFIX_END_AddAllyAbility();

//Post Loading zone, pre allies house
PROC
PROC_BUGFIX_END_GiveNightsongIsobel()
AND
DB_Players(_Player)
AND
NOT DB_InRegion(_Player, S_END_AlliesHouse_SUB_bc061ec6-3f6f-4057-93ec-bcd1340c79f6)
AND
HasSpell(_Player, "Target_END_AllyAbility_NightsongSummon", 0)
THEN
PROC_BUGFIX_END_SetupNightsongIsobelAllyHouse();

PROC
PROC_BUGFIX_END_AddAllyAbility()
AND
NOT DB_PermaDefeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
PROC_AllyAbilities_SummonsDBIteration("Target_END_AllyAbility_NightsongSummon", 1);
SetFlag((FLAG)END_GatherYourAllies_Event_IsobelReinforcementsAwarded_e514a07c-81fe-6c48-6f90-2333b475d201);
SetFlag((FLAG)END_GatherYourAllies_Event_NightsongReinforcementsAwarded_e6d46345-982d-4450-8a35-0b958746f119);

PROC
PROC_BUGFIX_END_AddAllyAbility()
AND
DB_PermaDefeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
PROC_AllyAbilities_SummonsDBIteration("Target_END_AllyAbility_NightsongSummon", 1);
SetFlag((FLAG)END_GatherYourAllies_Event_NightsongReinforcementsAwarded_e6d46345-982d-4450-8a35-0b958746f119);

PROC
PROC_BUGFIX_END_SetupNightsongIsobelAllyHouse()
AND
DB_BUGFIX_END_NightsongIsobel(_Character)
AND
DB_END_GatherYourAllies_PotentialCharacter(_Character, _Trigger, _)
AND
DB_END_GatherYourAllies_FollowUpDialogue(_Character, _Dialog, _AnubisConfig)
THEN
PROC_END_GatherYourAllies_SetupCharacter(_Character, _Trigger, _Dialog, _AnubisConfig);
//END_REGION

//REGION GUSX-9342
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
NOT DB_END_BrainBattle_Thralls((TAG)NULL_00000000-0000-0000-0000-000000000000, QUEST_END_Thrall_Fallback_ef0ef83b-56af-4203-a984-28a74975adf5, "END_SUPERTHRALL_FALLBACK", "EQP_END_Thrall_Fallback")
THEN
DB_BUGFIX_Marker("GUSX-9342");
DB_END_BrainBattle_Thralls((TAG)NULL_00000000-0000-0000-0000-000000000000, QUEST_END_Thrall_Fallback_ef0ef83b-56af-4203-a984-28a74975adf5, "END_SUPERTHRALL_FALLBACK", "EQP_END_Thrall_Fallback");
//END_REGION  GUSX-12147

//REGION GUSX-12147
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "END_Main", "GUSX-12147");

PROC
PROC_ApplySavegamePatchInLevel("END_Main", "GUSX-12147")
AND
NOT DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_FinalDecision_e5feae67-c6f1-1827-e9d6-a6b34647c8ea, (FLAG)END_FinalDecision_State_HasCompanions_71509891-35c2-4e80-a107-e7c21a0028db, 4, 13)
THEN
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_FinalDecision_e5feae67-c6f1-1827-e9d6-a6b34647c8ea, (FLAG)END_FinalDecision_State_HasCompanions_71509891-35c2-4e80-a107-e7c21a0028db, 4, 13);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_8cb159d3-3390-4e58-a0ae-8414628bb813, (FLAG)END_CombatOver_State_HasCompanions_d4e1d74a-ac07-7d10-07dc-3dbd24d3d260, 3, 12);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_GameFinale_DeathofKarlach_e419b950-b6ba-64bc-f041-1d07a602dfc4, (FLAG)END_DeathOfKarlach_State_HasCompanions_c60948cb-3c9b-491b-bccf-618a7c5bdc26, 1, 10);
DB_END_General_InterjectionDialog((DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilAvatar_e0069683-63a6-f619-cf62-5dc4105a11ba, (FLAG)END_FinalDecision_State_EvilAvatarHasCompanions_a894824a-ad1b-41a4-841e-0f9745c325bf, 2, 11); 
//END_REGION  GUSX-12147

//REGION GUSX-10684
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8 Beta Hotfix 2")
AND
DB_GlobalFlag((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
NOT DB_END_AllyAbilities_PlayerSummonAllyAD("Target_END_AllyAbilities_KuoToaSummon", (DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000)
THEN
DB_BUGFIX_Marker("GUSX-10718");
DB_END_AllyAbilities_PlayerSummonAllyAD("Target_END_AllyAbilities_KuoToaSummon", (DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "__Start"
