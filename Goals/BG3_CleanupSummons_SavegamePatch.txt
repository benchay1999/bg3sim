Version 1
SubGoalCombiner SGC_AND
INITSECTION
NOT DB_SavegamePatches_SelectedSummon((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000);
KBSECTION
PROC
PROC_ApplySavegamePatches()
AND
NOT QRY_BG3_SaveGameIsOlderThan("Release Patch 5 Hotfix 6")
AND
NOT DB_SavegamePatches_ClearSummon(_)
THEN
GoalCompleted;

PROC
PROC_SavegamePatches_CleanUpSummonsTemplatesDB()
AND
DB_SavegamePatches_SummonRootTemplates(_RootTemplateName)
THEN
NOT DB_SavegamePatches_SummonRootTemplates(_RootTemplateName);

//REGION Clear summons
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5 Hotfix 6")
THEN
DB_SavegamePatches_SummonRootTemplates("BearCompanion_Summon");
DB_SavegamePatches_SummonRootTemplates("CatFamiliar_Summon");
DB_SavegamePatches_SummonRootTemplates("CrabFamiliar_Summon");
DB_SavegamePatches_SummonRootTemplates("DogFamiliar_Scratch_Summon");
DB_SavegamePatches_SummonRootTemplates("FrogFamiliar_Summon");
DB_SavegamePatches_SummonRootTemplates("GiantBadgerCompanion_Summon");
DB_SavegamePatches_SummonRootTemplates("Hollyphant_Summon");
DB_SavegamePatches_SummonRootTemplates("Imp_Summon");
DB_SavegamePatches_SummonRootTemplates("LOW_BasiliskGate_WolfCompanion_Summon_Final");
DB_SavegamePatches_SummonRootTemplates("LOW_GreaseWizard_FireMephit_Summon");
DB_SavegamePatches_SummonRootTemplates("LOW_Thay_Undead_Zombie_Melee");
DB_SavegamePatches_SummonRootTemplates("MEPHIT_Ice_A_Summon");
DB_SavegamePatches_SummonRootTemplates("MEPHIT_Mud_A_ConjureElementals_Summon");
DB_SavegamePatches_SummonRootTemplates("MEPHIT_Mud_A_Summon");
DB_SavegamePatches_SummonRootTemplates("QUEST_FOR_QuasitSummon");
DB_SavegamePatches_SummonRootTemplates("QUEST_HAG_Mud_A_Summon");
DB_SavegamePatches_SummonRootTemplates("Quasit_Summon");
DB_SavegamePatches_SummonRootTemplates("Quest_COL_Necromite_Summon");
DB_SavegamePatches_SummonRootTemplates("RangedSpiderCompanion_Summon");
DB_SavegamePatches_SummonRootTemplates("RatFamiliar_Summon");
DB_SavegamePatches_SummonRootTemplates("RavenCompanion_Summon");
DB_SavegamePatches_SummonRootTemplates("RavenFamiliar_Summon");
DB_SavegamePatches_SummonRootTemplates("Shadow_A_Summon");
DB_SavegamePatches_SummonRootTemplates("SpiderCompanion_Summon");
DB_SavegamePatches_SummonRootTemplates("SpiderFamiliar_Summon");
DB_SavegamePatches_SummonRootTemplates("Surgeon_Nightmare_Nurse_A_Summon");
DB_SavegamePatches_SummonRootTemplates("UNI_TWN_LiftingTheCurse_Shadow_Summon");
DB_SavegamePatches_SummonRootTemplates("Undead_DarkJusticiar_Melee_Mace_Shield_Summon");
DB_SavegamePatches_SummonRootTemplates("Undead_DarkJusticiar_Melee_Scimitar_DW_Summon");
DB_SavegamePatches_SummonRootTemplates("Undead_DarkJusticiar_Melee_Scimitar_Shield_Summon");
DB_SavegamePatches_SummonRootTemplates("Undead_DarkJusticiar_Ranger_Summon");
DB_SavegamePatches_SummonRootTemplates("Unique_FlamingSphere_Summon");
DB_SavegamePatches_SummonRootTemplates("WolfCompanion_Summon");
DB_SavegamePatches_SummonRootTemplates("WorgCompanion_Summon");
DB_SavegamePatches_SummonRootTemplates("VFX_Static_Wall_Spell_Fire_A");
DB_SavegamePatches_SummonRootTemplates("UNI_LTS_Moonbeam_01");
DB_SavegamePatches_SummonRootTemplates("HAND_Mage_NOTAPPROVED");
DB_SavegamePatches_SummonRootTemplates("Female_InvokeDuplicity"); //Addresses all races and subraces
DB_SavegamePatches_SummonRootTemplates("Male_InvokeDuplicity");
DB_SavegamePatches_SummonRootTemplates("Cat_MinorIllusion");
DB_SavegamePatches_SummonRootTemplates("LTS_DancingLights_01");
DB_SavegamePatches_SummonRootTemplates("Undead_Ghoul_AnimateDead"); // Adding them individually to avoid problems with LOOT_SCROLL_AnimateDead
DB_SavegamePatches_SummonRootTemplates("Undead_Ghoul_Flying_AnimateDead");
DB_SavegamePatches_SummonRootTemplates("Undead_Skeleton_Ranger_AnimateDead");
DB_SavegamePatches_SummonRootTemplates("Undead_Skeleton_Ranger_AnimateDead");
DB_SavegamePatches_SummonRootTemplates("Undead_Zombie_Melee_AnimateDead");
DB_SavegamePatches_SummonRootTemplates("Undead_Zombie_Melee_AnimateDead");
DB_SavegamePatches_SummonRootTemplates("Undead_Zombie_Melee_AnimateDead");
DB_SavegamePatches_SummonRootTemplates("PUZ_Trap_Spell_GlyphOfWarding");
DB_SavegamePatches_SummonRootTemplates("Helper_Spell_CloudOfDaggers");
DB_SavegamePatches_SummonRootTemplates("LTS_Daylight_01");
DB_SavegamePatches_SummonRootTemplates("Helper_Spell_HungerOfHadar");
DB_SavegamePatches_SummonRootTemplates("Helper_Spell_Silence");
DB_SavegamePatches_SummonRootTemplates("Helper_Spell_SleetStorm");
DB_SavegamePatches_SummonRootTemplates("PUZ_ArcaneGate");
DB_SavegamePatches_SummonRootTemplates("Displacer_Beast_PlayerWildshape_Illusion");
DB_SavegamePatches_SummonRootTemplates("Spider_Tiny");
DB_SavegamePatches_SummonRootTemplates("Helper_Invisible_Summon");
DB_SavegamePatches_SummonRootTemplates("Helpers_Character_Countercharm");
DB_SavegamePatches_SummonRootTemplates("Undead_Zombie_Melee_FungalInfestation");
DB_SavegamePatches_SummonRootTemplates("Monk_Ice_Cube");
DB_SavegamePatches_SummonRootTemplates("Helper_Spell_SpreadingSpores");
DB_SavegamePatches_SummonRootTemplates("Flumph_Wildmagic");
DB_SavegamePatches_SummonRootTemplates("Elemental_Air_ConjureElemental");
DB_SavegamePatches_SummonRootTemplates("Elemental_Earth_ConjureElemental");
DB_SavegamePatches_SummonRootTemplates("Elemental_Fire_ConjureElemental");
DB_SavegamePatches_SummonRootTemplates("Elemental_Water_ConjureElemental");
DB_SavegamePatches_SummonRootTemplates("Myrmidon_Air_ConjureElemental");
DB_SavegamePatches_SummonRootTemplates("Myrmidon_Earth_ConjureElemental");
DB_SavegamePatches_SummonRootTemplates("Myrmidon_Fire_ConjureElemental");
DB_SavegamePatches_SummonRootTemplates("Myrmidon_Water_ConjureElemental");
DB_SavegamePatches_SummonRootTemplates("Bipedal_Elemental_Azer");
DB_SavegamePatches_SummonRootTemplates("Intellect_Devourer_PlayerWildshape");
DB_SavegamePatches_SummonRootTemplates("Bipedal_Fey_Dryad_ConjureWoodlandBeings");
DB_SavegamePatches_SummonRootTemplates("Boo_FindFamiliar");
DB_SavegamePatches_SummonRootTemplates("RavenCompanion_Summon_SpellFlock");
DB_SavegamePatches_SummonRootTemplates("DarkVine_Tentacle_GraspingVine");
DB_SavegamePatches_SummonRootTemplates("Cambion_Male_PlanarAlly");
DB_SavegamePatches_SummonRootTemplates("Deva_Male_PlanarAlly");
DB_SavegamePatches_SummonRootTemplates("Deva_Male_PlanarAlly_Banite");
DB_SavegamePatches_SummonRootTemplates("Djinni_PlanarAlly");
DB_SavegamePatches_SummonRootTemplates("Spiritual_Weapon");
DB_SavegamePatches_SummonRootTemplates("Helper_Spell_InsectPlague");
DB_SavegamePatches_SummonRootTemplates("Helper_Spell_MagicCircle");
DB_SavegamePatches_SummonRootTemplates("Helper_Invisible_MindSanctuary");
DB_SavegamePatches_SummonRootTemplates("Undead_Ghoul_WakeTheDead");
DB_SavegamePatches_SummonRootTemplates("Helper_Netherbrain_ObliterationOrb");
DB_SavegamePatches_SummonRootTemplates("Cloaker_Phantasm");
DB_SavegamePatches_SummonRootTemplates("UNI_CONS_Goodberry");
DB_SavegamePatches_SummonRootTemplates("LOOT_Throwable_Spell_FrozenOrb");
DB_SavegamePatches_SummonRootTemplates("LOOT_Spell_TransmutersStone_");
DB_SavegamePatches_SummonRootTemplates("UNI_HUM_ShadowBlade");
DB_SavegamePatches_SummonRootTemplates("UNI_WPN_HUM_Scimitar_FlameBlade");
DB_SavegamePatches_SummonRootTemplates("WPN_HUM_Battleaxe_Pact");
DB_SavegamePatches_SummonRootTemplates("WPN_HUM_Glaive_Pact");
DB_SavegamePatches_SummonRootTemplates("WPN_HUM_Greatsword_Pact");
DB_SavegamePatches_SummonRootTemplates("WPN_HUM_Rapier_Pact");
DB_SavegamePatches_SummonRootTemplates("WPN_HUM_Trident_Pact");
DB_SavegamePatches_SummonRootTemplates("WPN_HUM_Warhammer_Pact");
DB_SavegamePatches_SummonRootTemplates("WPN_Grenade_Orthon_A");
DB_SavegamePatches_SummonRootTemplates("Undead_Zombie_Dwarf_Melee");
DB_SavegamePatches_SummonRootTemplates("Gremishka_Spawn");
DB_SavegamePatches_SummonRootTemplates("Cambion_Male_WildMagic");
DB_SavegamePatches_SummonRootTemplates("Cat_Wildmagic");
DB_SavegamePatches_SummonRootTemplates("Dog_Wildmagic");
DB_SavegamePatches_SummonRootTemplates("MEPHIT_Magma_WildMagic");
DB_SavegamePatches_SummonRootTemplates("MEPHIT_Mud_WildMagic");
PROC_SavegamePatches_CleanUpSummons();

PROC
PROC_SavegamePatches_CleanUpSummons()
AND
DB_PermaDefeated(_Summon)
AND
GUIDToString(_Summon,_SummonName)
AND
DB_SavegamePatches_SummonRootTemplates(_RootTemplateName)
AND
IsSubstring(_SummonName, _RootTemplateName, 1)
THEN
DB_SavegamePatches_ClearSummon(_Summon);

PROC
PROC_SavegamePatches_CleanUpSummons()
THEN
TimerLaunch("SavegamePatches_ClearSummons",500);

IF
TimerFinished("SavegamePatches_ClearSummons")
AND
QRY_DoNTimes(10)
AND
DB_QRY_RTN_DoNTimes(_Index)
AND
// Not the fastest way to get an individual element, but prevents server hickups
// when this DB contains 35000 elements and we have to iterate over all remaining
// ones every time to select the ones we want to clear this timeslice)
SysFactAtIndex("DB_SavegamePatches_ClearSummon",1,1,"DB_SavegamePatches_SelectedSummon")
AND
DB_SavegamePatches_SelectedSummon(_Summon)
THEN
NOT DB_SavegamePatches_ClearSummon(_Summon);
PROC_Summons_ClearDBs_Execute(_Summon);

IF
TimerFinished("SavegamePatches_ClearSummons")
AND
NOT QRY_IsEmptyDB("DB_SavegamePatches_ClearSummon",1)
AND
Random(100,_Variance)
AND
IntegerSum(450,_Variance,_Delay)
THEN
TimerLaunch("SavegamePatches_ClearSummons",_Delay);

IF
TimerFinished("SavegamePatches_ClearSummons")
AND
NOT DB_SavegamePatches_ClearSummon(_)
THEN
GoalCompleted;
//END_REGION Clear summons
EXITSECTION
PROC_SavegamePatches_CleanUpSummonsTemplatesDB();
ENDEXITSECTION
