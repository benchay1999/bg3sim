Version 1
SubGoalCombiner SGC_AND
INITSECTION
//DO NOT USE!!! Has been deprecated and replaced with DB_DaisyAD_TriggeredOnProfile and DB_EmperorAD_TriggeredOnProfile.
//Is needed here so the transfer can happen to the new DBs
NOT DB_DaisyAD_Triggered((DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000, 0);
NOT DB_EmperorAD_Triggered((DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000, 0);

// Used for transfering old face paint DB to new one.
NOT DB_GLO_GlobalItems_FacePaintApplied((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000);

NOT DB_DefeatedEvent((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000,(FLAG)NULL_00000000-0000-0000-0000-000000000000); //DO NOT USE! USE DB_DefeatedOnceFlag INSTEAD!
NOT DB_DeadEvent((CHARACTER)NULL_00000000-0000-0000-0000-000000000000,(FLAG)NULL_00000000-0000-0000-0000-000000000000); //DO NOT USE! USE DB_DeadOnceFlag INSTEAD!
NOT DB_PermaDefeatedEvent((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000,(FLAG)NULL_00000000-0000-0000-0000-000000000000); //DO NOT USE! USE DB_PermaDefeatedFlag INSTEAD!

NOT DB_GLO_DifficultyClasses("", (FLAG)NULL_00000000-0000-0000-0000-000000000000); //DO NOT USE! Deprecated version of DB

NOT DB_GLO_AvatarKickableFlags_Assigned((CHARACTER)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000, "");
NOT DB_CrimeWarner(0, (CHARACTER)NULL_00000000-0000-0000-0000-000000000000, (DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000); // DEPRECATED, USE THE VERSION WITH 4 parameters instead

NOT DB_CRIME_Guards_SpawnedGuard_WaitOnStage((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000, "", "");
KBSECTION
//REGION Pre-release patches

//REGION Cancelling RDs
IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,1,0)
AND
DB_RelationshipDialog_Queue( (CHARACTER)_Companion, _Dialog, (FLAG)GLO_IPRD_RomanceConflict_55fcfaed-dfaa-cc31-39bc-c7b163a53c4a, _, _, _)
AND
NOT DB_OriginInPartyDialog(_Companion, _Dialog)
THEN
PROC_CancelRelationshipDialog((CHARACTER)_Companion, _Dialog, (FLAG)GLO_IPRD_RomanceConflict_55fcfaed-dfaa-cc31-39bc-c7b163a53c4a);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,1,0)
AND
DB_HandlingRelationshipDialog( (CHARACTER)_Companion, _Dialog, (FLAG)GLO_IPRD_RomanceConflict_55fcfaed-dfaa-cc31-39bc-c7b163a53c4a, _, _, _)
AND
NOT DB_OriginInPartyDialog(_Companion, _Dialog)
THEN
PROC_CancelRelationshipDialog((CHARACTER)_Companion, _Dialog, (FLAG)GLO_IPRD_RomanceConflict_55fcfaed-dfaa-cc31-39bc-c7b163a53c4a);
//END_REGION

//REGION GUS-294120
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
DB_DialogNPCs(_ID, S_LOW_SerialKiller_FigaroDoor_Near_6a089d5e-febd-4d0c-84b1-52610a4a7bb1, _)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
QRY_OnlyOnce("GUS-294120_Fix")
THEN
PROC_ForceStopDialog(S_LOW_SerialKiller_FigaroDoor_Far_02e41e0d-6b50-44dd-8dfd-1d135762903c);
SetFlag((FLAG)LOW_SerialKiller_State_SoliloquyCannotBeTriggered_2daea396-6a7d-4f79-9f1d-f8e40f968e64);
PROC_LOW_SerialKiller_HostilityAtFigaro((CHARACTER)_Player);
RemoveStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", NULL_00000000-0000-0000-0000-000000000000);//Removing the unlimited paralysis
ApplyStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, "LOW_SERIALKILLER_PARALYZED", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-294120");
//END_REGION GUS-294120

//REGION GUS-296998
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
THEN
DB_GOB_GoblinPriest_StatueInUse(S_GoblinPriestess_Statue_03_554a7eef-6b57-4b3f-a844-673b300a8f8a, S_GoblinPriestess_StatueDamageBox_03_22060e18-3820-43fb-b794-6fa5319e7c90, S_GoblinPriestess_InvisHelper_03_c9852772-1f95-4489-9ea6-20ea531b3099, "GOB_GoblinPriest_Statue_03");
DB_GOB_GoblinPriest_StatueInUse(S_GoblinPriestess_Statue_04_d00851b1-cc9f-4c72-bb26-477be47ac005, S_GoblinPriestess_StatueDamageBox_04_9aceb6ed-1b96-468e-9b5b-4ac48a7d7658, S_GoblinPriestess_InvisHelper_04_96afadca-bc9d-4dd8-99fb-52bf19bb3a45, "GOB_GoblinPriest_Statue_04");
DB_BUGFIX_Marker("GUS-296998");

//END_REGION GUS-296998

//REGION GUS-304180

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Patch Release 1")
AND
DB_GlobalFlag(ORI_Minsc_State_SavedButNotRecruited_8d437b31-7b27-478a-8c76-4cc095006d3f)
AND
DB_PartOfTheTeam(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_GlobalSetFlagAndCache(GLO_Jaheira_State_InPartyNoMinsc_5f2602fe-b638-40e1-ae66-43636ebe4648);
PROC_Origins_ForceLowApprovalLeavingDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_BUGFIX_Marker("GUS-304180");

//END_REGION GUS-304180

//REGION GUS-297311 - Orin not being added into DB_PermaDefeated
// if door has been opened, but Orin is still alive
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
DB_LOW_BhaalTemple_OpenedMainDoorFirstTime(1)
AND
NOT DB_Dead(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
NOT DB_PreventPermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
DB_BUGFIX_Marker("GUS-297311");

// if door was already opened and was already Orin defeated, but not PermaDefeated due to the DB_PreventPermaDefeated
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
DB_LOW_BhaalTemple_OpenedMainDoorFirstTime(1)
AND
DB_Dead(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
NOT DB_PreventPermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
DB_BUGFIX_Marker("GUS-297311");
//END_REGION

//REGION GUS-297006
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
DB_CurrentLevel("TUT_Avernus_C")
AND
DB_Avatars(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
DB_BUGFIX_Marker("GUS-297006");
RemoveSpell((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "Target_VampireBite_Astarion", 0);
PROC_GlobalClearFlagAndCache((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
//END_REGION

//REGION GUS-302076

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
THEN
DB_GLO_Minsc_BooDialogs((DIALOGRESOURCE)Minsc_InPartyEND_5f5091d1-3514-6f4e-e542-5e49a6a07bea);
DB_BUGFIX_Marker("GUS-302076");
//END_REGION


//REGION GUS-293377
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
THEN
DB_BUGFIX_Marker("GUS-293377");

IF
DB_BUGFIX_Marker("GUS-293377")
AND
DB_GlobalFlag((FLAG)CURRENTREGION_WLD_Main_A_797d21c8-b2a9-4c86-a1e4-8ca3833a32ef)
AND
NOT DB_BG3_SaveGamePatches("GUS-293377_Patched")
THEN
DB_BG3_SaveGamePatches("GUS-293377_Patched");
PROC_BG3_SaveGamePatches_GUS_293377();

PROC
PROC_BG3_SaveGamePatches_GUS_293377()
AND
NOT DB_Destroyed(S_GOB_PrisonEscapeTunnelBlockedNoBody_1a020f31-7612-4a79-87a9-846d838bf30e)
AND
HasActiveStatus(S_GOB_PrisonEscapeTunnelBlockedNoBody_1a020f31-7612-4a79-87a9-846d838bf30e, "DEBRIS_THRESHOLD_LESSER", 1)
THEN
RemoveStatus(S_GOB_PrisonEscapeTunnelBlockedNoBody_1a020f31-7612-4a79-87a9-846d838bf30e, "DEBRIS_THRESHOLD_LESSER");
//END_REGION

//REGION GUS-301527
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
THEN
DB_BG3_SaveGamePatches("GUS-301527");
DB_OriginMayLeaveDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, CAMP_DarkUrge_CFM_BloodweddingFollowup_2111a7a8-1f57-4e72-f518-acdaaddc0a67);
DB_OriginMayLeaveDialog(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, CAMP_DarkUrge_CFM_BloodweddingFollowup_2111a7a8-1f57-4e72-f518-acdaaddc0a67);

//END_REGION GUS-301527

//REGION GUS-294873
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
DB_CMB_SporeServantFollower(_SporeServant, _, (CHARACTER)S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
AND
DB_InCamp(_SporeServant)
AND
NOT DB_InCamp(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46)
THEN
DB_BUGFIX_Marker("GUS-294873");
PlayEffect(_SporeServant, VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416);
TeleportTo(_SporeServant, S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, "");
PlayEffect(_SporeServant, VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416);
//END_REGION

//REGION GUS-294963
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 2, 0)
THEN
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e, (TRIGGER)S_UND_DarkLake_BoatAtCampArea_467f81f9-f1d6-4c2a-a3d5-1ac0d8897b76, 1);
DB_AddCharactersInTriggerToDialog(LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03, 1, 1, 0);
DB_AddCharactersInTriggerToDialog_IgnoreHidden((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_NoAstarion_061da20f-7611-e738-999b-ab05089626d6);
DB_AddCharactersInTriggerToDialog(LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03, 1, 1, 0);
DB_AddCharactersInTriggerToDialog_IgnoreHidden((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PreCombat_OM_Astarion_AOM_COM_OOM_6f574f0c-848b-522f-b104-1e1488b2e212);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, (TRIGGER)S_LOW_CazadorsPalace_RitualRoom_RitualArea_60e2e3a7-f648-427b-86d3-96e9621fab03, 1, 1, 0);
DB_BUGFIX_Marker("GUS-294963");
//END_REGION

//REGION GUS-296517

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 2, 0)
AND
DB_GlobalFlag((FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e)
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
NOT DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_KethericDefeated")
THEN
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_KethericDefeated");

//END_REGION

//REGION GUS-296611
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
IsInInventory(S_GLO_GortashsHand_25d5cee5-79d2-4d73-917c-34184b3641c8, 0)
AND
GetInventoryOwner(S_WYR_CrownController_Gortash_383be300-d328-4152-86df-4927482d1fd7, _InventoryOwner) //This will work even if the item is on a chest
THEN
ToInventory(S_GLO_GortashsHand_25d5cee5-79d2-4d73-917c-34184b3641c8, _InventoryOwner, 1, 1, 1);
DB_GLO_SerialKiller_GortashHandSended(1);
DB_BUGFIX_Marker("GUS-296611");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
THEN
DB_BUGFIX_Marker("GUS-296611");
SetStoryItem(S_GLO_GortashsHand_25d5cee5-79d2-4d73-917c-34184b3641c8, 1);

//END_REGION GUS-296611

//REGION GUS-296711
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
NOT DB_CurrentLevel("TUT_Avernus_C")
AND
DB_Dialogs((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFollower_5c77b381-e606-12b7-1379-89db17e4a6d5)
THEN
DB_BUGFIX_Marker("GUS-296711");
NOT DB_Dialogs((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFollower_5c77b381-e606-12b7-1379-89db17e4a6d5);
//END_REGION GUS-296711

//REGION GUS-296625, GUS-297251
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
THEN
DB_BUGFIX_Marker("GUS-296625");
DB_BUGFIX_Marker("GUS-297251");
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch((FLAG)GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, 1);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch((FLAG)GLO_ForgingOfTheHeart_State_KarlachUpgraded_a818e2f5-9e0c-4ab3-8c1e-00765d3b892f, 1);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch((FLAG)HAV_ForgingOfTheHeart_State_ReadyForSecondUpgrade_edce0ffd-21d1-7a6c-2b55-a3e749d06fca, 1);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch((FLAG)GLO_ForgingOfTheHeart_Quest_WaitForNextAct_29c86e0b-100f-5a32-31d6-6bd4e287af71, 0);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch((FLAG)HAV_ForgingOfTheHeart_State_UnlockUpgradeNextDay_40dd7a6c-89a8-b301-a935-915059472061, 0);
PROC_BG3_SaveGamePatches_GUS_296625();

PROC
PROC_BG3_SaveGamePatches_GUS_296625()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
DB_GlobalFlag(_Flag)
AND
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch(_Flag, _Unlock)
THEN
PROC_BG3_SaveGamePatches_GUS_296625_UpdateInfernalBranch(_Unlock);

PROC
PROC_BG3_SaveGamePatches_GUS_296625_UpdateInfernalBranch((INTEGER)_Unlock)
AND
DB_ORI_Karlach_ForgingOfTheHeart_UnlockInfernalMetalBranch(_PrevUnlock)
THEN
NOT DB_ORI_Karlach_ForgingOfTheHeart_UnlockInfernalMetalBranch(_PrevUnlock);

PROC
PROC_BG3_SaveGamePatches_GUS_296625_UpdateInfernalBranch((INTEGER)_Unlock)
THEN
DB_ORI_Karlach_ForgingOfTheHeart_UnlockInfernalMetalBranch(_Unlock);

PROC
PROC_BG3_SaveGamePatches_GUS_296625()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
DB_ORI_Karlach_ForgingOfTheHeart_UnlockInfernalMetalBranch(0)
THEN
SetFlag((FLAG)GLO_ForgingOfTheHeart_State_BlockInfernalMetalQuestion_8095c7e4-d365-d4f2-2f95-69da62ddb0a4, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION GUS-296625, GUS-297251

//REGION GUS-296419
//Laezel COM with the Zaithisk, the device should get destroyed
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
GetFlag(CRE_GithInfirmary_State_CharacterUsedDevice_23fd1f32-7850-466e-a77a-75cd48bdaa21, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1)
AND
NOT DB_GlobalFlag(CRE_GithInfirmary_State_DeviceBroken_a3b2721c-b6c4-4e7a-868c-1af9cb036bd4)
THEN
Transform(S_CRE_InfirmaryDevice_df843052-358f-487e-a3e2-8dafa0aaf6a6, BLD_GTY_Purifier_A_Destruct_6d6797ec-12bc-4ae2-8b21-368c8c0b936d, (SHAPESHIFTRULE)Physical_4acc6277-6dcd-4110-9450-b9379beaedac);
SetFlag(CRE_GithInfirmary_State_DeviceBroken_a3b2721c-b6c4-4e7a-868c-1af9cb036bd4);
DB_BUGFIX_Marker("GUS-296419");

//If you haven't used the Zaithisk yet, register it so it can trigger the main script as intended
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
NOT DB_GlobalFlag((FLAG)CRE_GithInfirmary_State_DeviceBroken_a3b2721c-b6c4-4e7a-868c-1af9cb036bd4)
THEN
DB_GlobalFlagReactionAfterDialog(CRE_GithInfirmary_State_DeviceBroken_a3b2721c-b6c4-4e7a-868c-1af9cb036bd4, CRE_GithInfirmary_Device_OM_Laezel_COM_444edbd9-75ee-14c2-0d30-3e2efe7866db);
DB_BUGFIX_Marker("GUS-296419");
//END_REGION

//REGION GUS-297080
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080();
DB_BUGFIX_Marker("GUS-297080");

//Voss Camp Confrontation already happened
PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
AND
DB_Camp_WokeUpAtNight(1)
THEN
SetFlag((FLAG)ORI_Laezel_State_MetVossInAct2_26563f96-bf5a-4895-b63b-036c7571bbbc);

PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_GlobalFlag((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
THEN
SetFlag((FLAG)ORI_Laezel_State_MetVossInAct2_26563f96-bf5a-4895-b63b-036c7571bbbc);

PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_GlobalFlag((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_RefusedVossInAct2_7ff16fd5-fa94-4ae7-ba2d-e4cef09c9b82)
THEN
SetFlag((FLAG)ORI_Laezel_State_AgreedWithVossInAct2_63f1a107-a2af-46ec-ac49-a10d0166ac2e);

//Voss Camp Confrontation currently ongoing
PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
AND
DB_Camp_WokeUpAtNight(1)
AND
NOT DB_DialogName((DIALOGRESOURCE)CAMP_Laezel_VossCampConfrontation_SCO_LaezelCom_a85065d0-f5ec-cb25-31cd-5354f0c0614c, _)
AND
NOT DB_DialogName((DIALOGRESOURCE)CAMP_Laezel_VossCampConfrontation_SCO_LaezelAvatar_e43d9a2a-7ea7-41a7-78cb-a62ccdc582b4, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_RefusedVossInAct2_7ff16fd5-fa94-4ae7-ba2d-e4cef09c9b82)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_AgreedWithVossInAct2_63f1a107-a2af-46ec-ac49-a10d0166ac2e)
THEN
SetFlag((FLAG)ORI_Laezel_State_AgreedWithVossInAct2_63f1a107-a2af-46ec-ac49-a10d0166ac2e);

//Only set the flag if the VossCampConfrtation has finished but players have not reached
PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_GlobalFlag((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_RefusedVossInAct2_7ff16fd5-fa94-4ae7-ba2d-e4cef09c9b82)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_AcceptedVlaakithsFinalMission_bead5ab3-c319-4bb3-a5ff-f56e2a48000f)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_RefusedVlaakithsFinalMission_7abf62d6-f7ac-4fc1-9001-f55c04f99b5b)
THEN
SetFlag((FLAG)ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56);

PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
AND
DB_Camp_WokeUpAtNight(1)
AND
NOT DB_DialogName((DIALOGRESOURCE)CAMP_Laezel_VossCampConfrontation_SCO_LaezelCom_a85065d0-f5ec-cb25-31cd-5354f0c0614c, _)
AND
NOT DB_DialogName((DIALOGRESOURCE)CAMP_Laezel_VossCampConfrontation_SCO_LaezelAvatar_e43d9a2a-7ea7-41a7-78cb-a62ccdc582b4, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_RefusedVossInAct2_7ff16fd5-fa94-4ae7-ba2d-e4cef09c9b82)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_AgreedWithVossInAct2_63f1a107-a2af-46ec-ac49-a10d0166ac2e)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_AcceptedVlaakithsFinalMission_bead5ab3-c319-4bb3-a5ff-f56e2a48000f)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_RefusedVlaakithsFinalMission_7abf62d6-f7ac-4fc1-9001-f55c04f99b5b)
THEN
SetFlag((FLAG)ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56);

PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
AND
DB_Camp_WokeUpAtNight(1)
THEN
SetFlag((FLAG)ORI_Laezel_State_MetVossInAct2_26563f96-bf5a-4895-b63b-036c7571bbbc);

PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_DialogName((DIALOGRESOURCE)CAMP_Laezel_VossCampConfrontation_SCO_LaezelCom_a85065d0-f5ec-cb25-31cd-5354f0c0614c, _)
THEN
DB_ORI_Laezel_VossCampConfrontation_CheckFlagsAfterDialog(1);
DB_ORI_Laezel_VossCampConfrontation_ResetCRDAfterOnStageEvent(1);

IF
DialogEnded(CAMP_Laezel_VossCampConfrontation_SCO_LaezelCom_a85065d0-f5ec-cb25-31cd-5354f0c0614c, _)
AND
DB_ORI_Laezel_VossCampConfrontation_CheckFlagsAfterDialog(1)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_RefusedVossInAct2_7ff16fd5-fa94-4ae7-ba2d-e4cef09c9b82)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_AgreedWithVossInAct2_63f1a107-a2af-46ec-ac49-a10d0166ac2e)
THEN
SetFlag((FLAG)ORI_Laezel_State_AgreedWithVossInAct2_63f1a107-a2af-46ec-ac49-a10d0166ac2e);
SetFlag((FLAG)ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56);

IF
DialogEnded(CAMP_Laezel_VossCampConfrontation_SCO_LaezelCom_a85065d0-f5ec-cb25-31cd-5354f0c0614c, _)
AND
DB_ORI_Laezel_VossCampConfrontation_CheckFlagsAfterDialog(1)
THEN
NOT DB_ORI_Laezel_VossCampConfrontation_CheckFlagsAfterDialog(1);

//Laezel is put off stage if she's not in the active party, temporarily removing her from DB_InCamp. She is set back to InCamp too late for the CRD to be applied, so if that's the case, it restarts the CRD when she gets readded to Camp
IF
DB_InCamp((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_ORI_Laezel_VossCampConfrontation_ResetCRDAfterOnStageEvent(1)
THEN
NOT DB_ORI_Laezel_VossCampConfrontation_ResetCRDAfterOnStageEvent(1);
PROC_CampRelationshipDialog((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(DIALOGRESOURCE)GLO_Laezel_WRD_AfterVossCampConfrontation_320ec283-5803-0bf5-5c1f-77fe0961bef6,(FLAG)NULL_00000000-0000-0000-0000-000000000000, 0, 0);
PROC_Try_CampRelationshipDialog((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1);

//After the Voss Confrontation dialog, but before the night ended. If the CRD discussion has not been had, queue the CRD again since it would have failed if Laezel wasn't an active party member
PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
AND
DB_Camp_WokeUpAtNight(1)
AND
NOT DB_DialogName((DIALOGRESOURCE)CAMP_Laezel_VossCampConfrontation_SCO_LaezelCom_a85065d0-f5ec-cb25-31cd-5354f0c0614c, _)
AND
NOT QRY_ORI_Laezel_VossCampConfrontation_Patch_AtLeastOnePlayerHasFlag((FLAG)Laezel_InParty_Event_DiscussedVossCampConfrontation_f13a3956-ab58-4713-a3e2-7b55aa7ab6da)
THEN
PROC_CampRelationshipDialog((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(DIALOGRESOURCE)GLO_Laezel_WRD_AfterVossCampConfrontation_320ec283-5803-0bf5-5c1f-77fe0961bef6,(FLAG)NULL_00000000-0000-0000-0000-000000000000, 0, 0);
PROC_Try_CampRelationshipDialog((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1);

QRY
QRY_ORI_Laezel_VossCampConfrontation_Patch_AtLeastOnePlayerHasFlag((FLAG)_Flag)
AND
DB_Players(_Player)
AND
GetFlag(_Flag, _Player, 1)
THEN
DB_NOOP(1);

//Vlaakith Visit came to camp flag fix
PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_RefusedVlaakithsFinalMission_7abf62d6-f7ac-4fc1-9001-f55c04f99b5b)
AND
NOT DB_GlobalFlag((FLAG)CAMP_VlaakithVisit_Event_VlaakithCameToCamp_82dcf5f6-1bc0-ee82-d0cb-fd90de88a077)
THEN
SetFlag((FLAG)CAMP_VlaakithVisit_Event_VlaakithCameToCamp_82dcf5f6-1bc0-ee82-d0cb-fd90de88a077);

PROC
PROC_ORI_Laezel_VossCampConfrontation_ApplyPatch_GUS_297080()
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_AcceptedVlaakithsFinalMission_bead5ab3-c319-4bb3-a5ff-f56e2a48000f)
AND
NOT DB_GlobalFlag((FLAG)CAMP_VlaakithVisit_Event_VlaakithCameToCamp_82dcf5f6-1bc0-ee82-d0cb-fd90de88a077)
THEN
SetFlag((FLAG)CAMP_VlaakithVisit_Event_VlaakithCameToCamp_82dcf5f6-1bc0-ee82-d0cb-fd90de88a077);

//END_REGION

//REGION GUS-297204
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
IsOnStage(S_WYR_Posthouse_Groom_1b61a7e3-0973-4bb1-9793-7735a8ea12b3, 0)
AND
GetFlag((FLAG)GEB_FleeOutOfSight_f488cbb2-9aca-452f-9b8d-652e07561785, S_WYR_Posthouse_Groom_1b61a7e3-0973-4bb1-9793-7735a8ea12b3, 0)
THEN
SetFlag((FLAG)WYR_Posthouse_State_GroomRanAway_ac724a83-f780-4275-82c0-a4092390ba81);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
THEN
PROC_SetAnubisConfig(S_WYR_Posthouse_Equerry_800e7e52-64f1-4a52-a2a2-5a409e8aab53, "S_WYR_Posthouse_Equerry");
DB_BUGFIX_Marker("GUS-297204");
//END_REGION

//REGION GUS-3490810
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
THEN
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_TUT_TransformChamber_DrainVictim_000_5bc43df4-6274-4b73-baed-c7f5268b2fc7);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_TUT_TransformChamber_DrainVictim_001_dd1d4bcf-da0e-441a-b700-7273bad6579e);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_FirstFight_Imp_Melee_01_07f1512b-efe9-4eb8-8ade-783435e9d7c9);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_FirstFight_Imp_Ranged_01_38d1ce2f-4f19-4266-971d-61f08bc1a895);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_FirstFight_Imp_Melee_02_5c5bd50b-147e-42e5-93cb-59a754df91ec);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_FirstFight_Imp_Ranged_02_df44fa65-5399-47d6-b5bb-70e4b8e63314);

//END_REGION

//REGION GUS-297472  - Halsin not getting his faction assigned correctly sometimes on joining the party
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,2,0)
AND
DB_OnlyOnce("RecruitedFirstTime_Halsin")
THEN
SetFaction(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (FACTION)Companion10_fd96559f-010a-6e27-8689-eb29795ff2af);
DB_BUGFIX_Marker("GUS-297472");

//END_REGION

//REGION GUS-297428

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 4, 0)
AND
DB_Origins(_Character)
THEN
DB_GLO_Playable(_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 4, 0)
AND
DB_Avatars(_Character)
THEN
DB_GLO_Playable(_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 4, 0)
AND
DB_Hirelings_HACK_Classes(_, _Character, _)
THEN
DB_GLO_Playable(_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 4, 0)
AND
DB_GLO_Playable(_Character)
THEN
SetTag(_Character, (TAG)PLAYABLE_25bf5042-5bf6-4360-8df8-ab107ccb0d37);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 4, 0)
THEN
DB_BUGFIX_Marker("GUS-297472-2");

//END_REGION


//REGION GUS-297579
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
THEN
PROC_UND_SocietyOfBrilliance_LeftAct();
DB_BUGFIX_Marker("GUS-297579");
//END_REGION

//REGION GUS-256574
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_PermaDefeated((CHARACTER)S_WYR_SharessCaress_BoastingCrooks_RivingtonRat_59f97331-f6bc-45b5-bf21-03ea4341e99e)
THEN
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)WYR_SharessCaress_BoastingCrooks_Rat_ba171f3b-5f7a-3bb1-e743-6bde055960df, 50, 2); // Player (speaker 2) paying to the NPC (default speaker 1)
DB_BUGFIX_Marker("GUS-256574");
//END_REGION

//REGION GUS-297681
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_WYR_MeetingMizoraSetupDone(1)
AND
IsOnStage(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,1)
THEN
SetOnStage(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,0);
DB_BUGFIX_Marker("GUS-297681");

//END_REGION

//REGION GUS-287661

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_LOW_OskarsBeloved_HauntBooksOwner((ITEM)S_LOW_OskarsBeloved_TarhunSendAway_35e2561f-0f2f-40cb-b5a1-02ef116c3f13, S_LOW_TarhunMnemonis_2d1b98a0-01a9-4c21-8bc2-9738c47f6966);
DB_LOW_OskarsBeloved_HauntBooksOwner((ITEM)S_LOW_OskarsBeloved_ClericApology_4155cc38-3891-4282-bb89-4f09776968c0, S_LOW_OskarsBeloved_MailBox_9ff1fe4e-62d4-4061-b685-aa58e1736379);
DB_LOW_OskarsBeloved_HauntBooks((ITEM)S_LOW_OskarsBeloved_SendAwayStaff_000_d714600b-9c21-4f0d-b7f0-6367f5755df4);
DB_LOW_OskarsBeloved_HauntBooks((ITEM)S_LOW_LetterFatherCarrion_c4aae84c-c9b5-4941-a94f-c5c8ead07205);
DB_LOW_OskarsBeloved_HauntBooks((ITEM)S_LOW_OskarsBeloved_GoodbyeKerri_000_98893e7f-3118-4f9f-a3fc-727607d126da);
DB_LOW_OskarsBeloved_NotHauntBooksOwner((ITEM)S_LOW_OskarsBeloved_JannathSecurityNote_d3ab6895-9615-4dce-9b5c-7ef5847af0b4,LOW_Jannath_Safe_762cde37-8b25-47d1-9119-5baea6bb9004);
DB_LOW_OskarsBeloved_NotHauntBooksOwner((ITEM)S_LOW_OskarsBeloved_WhereaboutsTip_08c3ddcd-6f2c-4ca1-85fb-6d0a77a3fc51,S_LOW_OskarsBeloved_MailBox_9ff1fe4e-62d4-4061-b685-aa58e1736379);

PROC
PROC_ApplySavegamePatches()
AND
DB_OnlyOnce("LOW_OskarsBeloved_CheckState")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_LOW_OskarsBeloved_CheckStateBooks();

//END_REGION

//REGION GUS-296588
//On the offchance you have attacked Jaheira's kids, and never got this result, we make it go through the setting of the spotting so she can get mad at the player.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("4,0,3,0")
AND
DB_GlobalFlag(LOW_JaheirasHouse_State_PlayerAttackedFamily_f505ff06-486a-4d8d-9986-95f4f91f9094)
AND
DB_PartOfTheTeam(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_LOW_JaheiraConfrontsAboutKids();
DB_BUGFIX_Marker("GUS-296588");
//END_REGION

//REGION GUS-296827

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_ORI_OriginCampData((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,"WLDDUNSHA",(TRIGGER)S_CAMP_VoloPoint_fd5b7cbb-c4f4-41b8-89b6-88d97cafa5d8)
THEN
NOT DB_ORI_OriginCampData((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,"WLDDUNSHA",(TRIGGER)S_CAMP_VoloPoint_fd5b7cbb-c4f4-41b8-89b6-88d97cafa5d8);
DB_BUGFIX_Marker("GUS-296827");
//END_REGION

//REGION GUS-296640

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
PROC_END_BrainBattle_PATCH_SetupNautiloidCannons();

PROC
PROC_END_BrainBattle_PATCH_SetupNautiloidCannons()
THEN
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_007_7cd54f7c-21af-49f1-87cb-97e13f26bf27);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_008_28db1262-a6b9-47cd-af6b-44cb694b17ba);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_009_987dcf83-3ca5-4372-b2d9-fec950c2e5a6);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_010_29edd32f-571c-4d6b-b5f4-3fd36cd8ad77);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_011_ba70658b-84f2-4cc1-bd30-dadb3efd5402);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_012_717fd538-8263-4a85-9d0f-15b5cf58e99d);

PROC
PROC_END_BrainBattle_PATCH_SetupNautiloidCannons()
AND
DB_END_BrainBattle_Enemies(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a)
AND
DB_END_BrainBattle_NautiloidCannons(_Cannon)
THEN
SetOnStage(_Cannon, 1);
SetForceUpdate(_Cannon, 1);

//END_REGION

//REGION GUS-297800

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_END_HellFromAbove_SetTarget(_Helper)
THEN
NOT DB_END_HellFromAbove_SetTarget(_Helper);
DB_BUGFIX_Marker("GUS-297800");

//END_REGION

//REGION GUS-301238

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
THEN
DB_ORI_Gale_RepeatTG((FLAG)TG_GLO_FirstUseTadpole_d17c7aa5-c1e6-4c24-bc5d-91b3e7c3c54c);
DB_BUGFIX_Marker("GUS-301238");

//END_REGION

//REGION GUS-297729

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("Act3b_ORI_Gale")
AND
IsOnStage(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, 1)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_Met_ElminsterInWYR_82b0cbde-1d3b-1f67-86a8-d05744462209)
THEN
DB_BUGFIX_Marker("GUS-297729");
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)LOW_Elminster_7628b6be-27be-1b51-5190-a6e7d6a86fec, (TAG)REALLY_GALE_9b0354c0-56d9-4723-8034-918ac9abab19, (DIALOGRESOURCE)LOW_Elminster_OM_Gale_AOM_OOM_2768779f-052b-7aca-93ba-932edf69b150, (DIALOGRESOURCE)LOW_Elminster_OM_Gale_COM_3fc2ca5a-f3ff-9951-1356-cfd026d2351d, (DIALOGRESOURCE)LOW_Elminster_OM_Gale_AOM_OOM_2768779f-052b-7aca-93ba-932edf69b150);

//END_REGION


//REGION GUS-296462


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("GLO_Origin_Gale_Death_PostEA")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalCounter("ORI_Gale_MagicItemNeed", _)
THEN
NOT DB_ORI_Gale_RegionCounter(5, (FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8);
DB_ORI_Gale_RegionCounter_New((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8);
DB_ORI_Gale_RegionCounter_New((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("GLO_Origin_Gale_Death_PostEA")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d)
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
_Need != 1
AND
QRY_OnlyOnce("ORI_Gale_MagicItemNeed_Setup")
THEN
PROC_RemoveCounter("ORI_Gale_MagicItemNeed");
DB_GlobalCounter("ORI_Gale_MagicItemNeed", 1);
//REGION GUS-173074
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_GlobalFlag(UND_GnomeWorkers_State_PermaDefeated_99fa547a-d3c9-46fe-b53f-7cceb510cd6f)
AND
DB_GlobalFlag(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);
DB_BUGFIX_Marker("GUS-173074");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_GlobalFlag(UND_DebrisCleaners_State_PermaDefeated_c74816bf-a62c-49b7-80a8-4e0f95020f91)
AND
NOT DB_GlobalFlag(UND_DuergarCamp_State_CaveInCleared_e0d8a48b-e0cf-4cc8-96bc-b637b79ce9bd)
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5,0);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarRebels_018d62a0-5ce2-45fd-857f-7ca88b3095db,0);
DB_BUGFIX_Marker("GUS-173074");
//END_REGION GUS-173074

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("GLO_Origin_Gale_Death_PostEA")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d)
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
_Need != 2
AND
QRY_OnlyOnce("ORI_Gale_MagicItemNeed_Setup")
THEN
PROC_RemoveCounter("ORI_Gale_MagicItemNeed");
DB_GlobalCounter("ORI_Gale_MagicItemNeed", 2);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("GLO_Origin_Gale_Death_PostEA")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d)
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
_Need != 3
AND
QRY_OnlyOnce("ORI_Gale_MagicItemNeed_Setup")
THEN
PROC_RemoveCounter("ORI_Gale_MagicItemNeed");
DB_GlobalCounter("ORI_Gale_MagicItemNeed", 3);


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("GLO_Origin_Gale_Death_PostEA")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotTwoMagicItems_c757086e-4696-441d-b19c-fdb65982776f)
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
_Need != 1
AND
QRY_OnlyOnce("ORI_Gale_MagicItemNeed_Setup")
THEN
PROC_RemoveCounter("ORI_Gale_MagicItemNeed");
DB_GlobalCounter("ORI_Gale_MagicItemNeed", 1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("GLO_Origin_Gale_Death_PostEA")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotTwoMagicItems_c757086e-4696-441d-b19c-fdb65982776f)
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
_Need != 2
AND
QRY_OnlyOnce("ORI_Gale_MagicItemNeed_Setup")
THEN
PROC_RemoveCounter("ORI_Gale_MagicItemNeed");
DB_GlobalCounter("ORI_Gale_MagicItemNeed", 2);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("GLO_Origin_Gale_Death_PostEA")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotTwoMagicItems_c757086e-4696-441d-b19c-fdb65982776f)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307)
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
_Need != 1
AND
QRY_OnlyOnce("ORI_Gale_MagicItemNeed_Setup")
THEN
PROC_RemoveCounter("ORI_Gale_MagicItemNeed");
DB_GlobalCounter("ORI_Gale_MagicItemNeed", 1);


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("GLO_Origin_Gale_Death_PostEA")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalCounter("ORI_Gale_MagicItemNeed", _)
AND
QRY_OnlyOnce("ORI_Gale_MagicItemNeed_Setup")
THEN
PROC_DeclareCounter("ORI_Gale_MagicItemNeed");


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 3, 0)
AND
SysIsActive("GLO_Origin_Gale_Death_PostEA")
THEN
DB_CampNight(NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, 800);
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "WLDBAS");

DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "CREMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "CREINSIDE");

DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "SHARTEMPLE");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, "MOONRISE");

DB_CampNight_Requirement(NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, (FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906);
DB_CampNight_CancelledBy(NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, (FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d);
DB_CampNight_CancelledBy(NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, (FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c);
DB_CampNight_CRD((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574,(FLAG)ORI_Gale_IPRD_NeedMagicItem1_c1899c40-e4c4-72d6-4360-444cea41e72f);

DB_CampNight_ForceOnLevelSwap((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac,"ReadyCheck_ToCrecheFromGoblinCamp",0,1);
DB_CampNight_ForceOnLevelSwap((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac,"ReadyCheck_ToCrecheFromPlains",0,1);
DB_CampNight_ForceOnLevelSwap((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac,"ReadyCheck_ToSCLFromUnderdark",0,1);


//END_REGION


//REGION GUS-284616

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_CAMP_Elfsong_WaypointDoors(S_CAMP_Elfsong_DoorToCity_65660857-e257-4bab-a128-136cf609b145, "LOW_ElfsongTavern_DoorToCity");
DB_CAMP_Elfsong_WaypointDoors(S_CAMP_DoorToCity_Secondary_fecd87f1-ca28-46c7-8088-64ca98273d46, "LOW_ElfsongTavern_DoorToCity"); //This DB entry will be removed after launch
DB_CAMP_Elfsong_WaypointDoors(S_LOW_Elfsong_DoorToCamp_001_c8f1a919-481f-4958-a048-61c604ec9620, "LOW_ElfsongTavern_DoorToCamp");
DB_CAMP_Elfsong_WaypointDoors(S_LOW_Elfsong_DoorToCamp_d6c943ae-ac6a-4f3b-9805-1f11a6d32b18, "LOW_ElfsongTavern_DoorToCamp");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_GlobalFlag(CAMP_Elfsong_PaymentDone_fd063151-f443-4b87-80bf-6a9441b2b4d7)
AND
DB_CAMP_Elfsong_WaypointDoors(_Door, _Name)
THEN
SetStoryDisplayName(_Door, _Name);
//END_REGION GUS-284616

//REGION GUS-297476
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_SCL_ShadowCurse_Undead(_Char, _)
AND
NOT DB_CustomDefeatedState(_Char, "SCL_Shadowcurse")
THEN
DB_BUGFIX_Marker("GUS-297476");
DB_CustomDefeatedState(_Char, "SCL_Shadowcurse");
//END_REGION GUS-297476

//REGION GUS-297599
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_ActiveLevel("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-297599");
SetGravity((ITEM)S_SHA_PathOfDarknessTrial_Goal_26c3ff42-4e78-4e4c-a700-bf17052714f6, GRAVITYTYPE.DisabledUntilMove, NULL_00000000-0000-0000-0000-000000000000);
TeleportTo(S_SHA_PathOfDarknessTrial_Goal_26c3ff42-4e78-4e4c-a700-bf17052714f6, S_SHA_PathOfDarknessTrial_GoalFixedPos_555f860b-3679-45b6-8442-461dfb53f4c3, "", 0, 0, 0, 0, 0); // We don't want to snap to ground.
//END_REGION GUS-297599

//REGION GUS-297438
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_GlobalFlag(GLO_LiftingTheCurse_State_HalsinRecruitable_2c8b6be0-558d-485c-b4f2-93ec1926a2fa)
AND
DB_QuestDef_SawDefeatedState("GLO_Tadpole", "HalsinDiedEarly", S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
NOT DB_QuestDef_SawDefeatedState("GLO_Tadpole", "HalsinDiedEarly", S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
NOT DB_QuestDef_SawDeadState("GLO_Tadpole", "HalsinDiedEarly", S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_BUGFIX_Marker("GUS-297438");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
THEN
NOT DB_QuestDef_State((FLAG)GLO_LiftingTheCurse_Event_TravelToHaven_a946f0b8-badb-435d-915d-2e6a45845c7c, "SCL_LiftingTheCurse", "HalsinMetArt");
NOT DB_QuestDef_State((FLAG)GLO_LiftingTheCurse_Event_TravelToLakeside_e06813a1-899a-498e-bd18-d22bee7d30e6, "SCL_LiftingTheCurse", "HalsinRitualReady");
NOT DB_GlobalFlagReactionAfterDialog((FLAG)GLO_LiftingTheCurse_Event_TravelToLakeside_e06813a1-899a-498e-bd18-d22bee7d30e6, (DIALOGRESOURCE)CAMP_Halsin_c0ab0f6f-3ffc-d06d-0d6d-d1aaef70dfe4);
DB_GlobalFlagReactionAfterDialog((FLAG)GLO_LiftingTheCurse_Event_TravelToLakeside_e06813a1-899a-498e-bd18-d22bee7d30e6, (DIALOGRESOURCE)HAV_CursedFist_d19739b9-c366-4272-7306-6ad04076916d);
DB_GlobalFlagReactionAfterDialog((FLAG)GLO_LiftingTheCurse_Event_TravelToLakeside_e06813a1-899a-498e-bd18-d22bee7d30e6, (DIALOGRESOURCE)SCE_Halsin_12ef293e-01cc-8884-ad52-22231c24fc1f);
DB_GlobalFlagReactionAfterDialog((FLAG)GLO_LiftingTheCurse_Event_TravelToLakeside_e06813a1-899a-498e-bd18-d22bee7d30e6, (DIALOGRESOURCE)CAMP_Halsin2_c0ab0f6f-3ffc-d06d-0d6d-d1aaef70dfe4);
DB_BUGFIX_Marker("GUS-297438");

//END_REGION GUS-297438

//REGION GUS-297278
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
NOT DB_END_GodsAndMonsters_SceneSetup("END_GodsAndMonsters_GameFinished", (TRIGGER)NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_END_GodsAndMonsters_SceneFades("END_GodsAndMonsters_GameFinished", "", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-297278");
//END_REGION

//REGION GUS-297035
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_END_General_MakeUnavailableFlag(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, END_CombatOver_State_PlayerKilledLaezel_dc67028e-f26e-a092-ae9a-809234a6bc6d, 0);
DB_END_General_MakeUnavailableFlag(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (FLAG)END_GameFinale_Event_GaleBecameGod_e85955a3-58d0-17ea-2d31-ed3713121d9b, 1);
//END_REGION

//REGION GUS-297945
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_QuestIsOpened("LOW_FindMol")
AND
DB_LOW_FindMol_ChangeCategoryEntries(_QuestUpdate)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindMol", _QuestUpdate)
THEN
QuestSetCategory("LOW_FindMol", "BaldursGate");
DB_BUGFIX_Marker("GUS-GUS-297945");
//END_REGION GUS-297945

//REGION GUS-297887

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_Avatars(_Avatar)
AND
DB_CompanionCanPartner((CHARACTER)_Companion, _DateFlag, _PartnerFlag, _ExFlag, _, _, _)
AND
GetFlag(_ExFlag, _Avatar, 1)
THEN
ClearFlag(_DateFlag, _Avatar, 0, 1);
DB_BUGFIX_Marker("GUS-297887");

//END_REGION

//REGION GUS-297481

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_BUGFIX_Marker("GUS-297481");
DB_WYR_WyrmRock_EnteredFortressTriggers((TRIGGER)S_WYR_Fortress_SUB_94ca5a54-0813-48b4-9f55-4cb039a63c82);
DB_WYR_WyrmRock_EnteredFortressTriggers((TRIGGER)S_WYR_Prison_SUB_cd67276d-52e4-44b9-a237-0e2cd45106d8);
//END_REGION

//REGION GUS-297008
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_BookTemplateFlags(BOOK_UNI_LC_MurderTableauNote02_0a5f7f38-1d03-43f3-a531-4fc0001d1d87, LOW_SerialKiller_State_ReadTableauxNote_bb2abe19-22dd-4773-9c1c-d916645fc24e);
DB_BookTemplateFlags(BOOK_UNI_LC_MurderTableauNote03_e663acb5-4336-4d46-8d56-95ecbec91077, LOW_SerialKiller_State_ReadTableauxNote_bb2abe19-22dd-4773-9c1c-d916645fc24e);
DB_BookTemplateFlags(BOOK_UNI_LC_MurderTableauNote04_57164bd6-6549-4fba-b6f8-1a8caf56d759, LOW_SerialKiller_State_ReadTableauxNote_bb2abe19-22dd-4773-9c1c-d916645fc24e);
DB_BookTemplateFlags(BOOK_UNI_LC_MurderTableauNote05_779bf83a-4335-4891-8414-d1dd59ce8176, LOW_SerialKiller_State_ReadTableauxNote_bb2abe19-22dd-4773-9c1c-d916645fc24e);
DB_BookTemplateFlags(BOOK_UNI_LC_MurderTableauNote06_de35359e-7c45-45f7-a9ce-6266eafb1c1f, LOW_SerialKiller_State_ReadTableauxNote_bb2abe19-22dd-4773-9c1c-d916645fc24e);
DB_BookTemplateFlags(BOOK_UNI_WYR_MurderTableauNote01_0a061583-2dae-41db-82e1-54e0ddc02726, LOW_SerialKiller_State_ReadTableauxNote_bb2abe19-22dd-4773-9c1c-d916645fc24e);
DB_QuestDef_State((FLAG)LOW_SerialKiller_State_ReadTableauxNote_bb2abe19-22dd-4773-9c1c-d916645fc24e, "LOW_FindBhaalTemple", "FindBhaalTemple_TableauxOfMurder");
DB_BUGFIX_Marker("GUS-297008");

//END_REGION GUS-297008

//REGION GUS-297936
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_BUGFIX_Marker("GUS-297936");
DB_LOW_SharGrotto_RemoveKey(1);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_SharGrotto_RemoveKey(1)
AND
GetInventoryOwner(PUZ_GEN_Key_Threshold_of_Loss_b49e15a1-e63f-488a-9649-6140c363fe5b,_Owner)
AND
_Owner != NULL_00000000-0000-0000-0000-000000000000
THEN
TeleportTo(PUZ_GEN_Key_Threshold_of_Loss_b49e15a1-e63f-488a-9649-6140c363fe5b,_Owner,"");

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_SharGrotto_RemoveKey(1)
AND
IsOnStage((ITEM)PUZ_GEN_Key_Threshold_of_Loss_b49e15a1-e63f-488a-9649-6140c363fe5b, 1)
THEN
NOT DB_LOW_SharGrotto_RemoveKey(1);
SetOnStage((ITEM)PUZ_GEN_Key_Threshold_of_Loss_b49e15a1-e63f-488a-9649-6140c363fe5b, 0);

//END_REGION GUS-297936

//REGION GUS-296789

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_BUGFIX_Marker("GUS-296789");

IF
DB_BUGFIX_Marker("GUS-296789")
AND
DB_CurrentLevel("WLD_Main_A")
THEN
DB_PartyDialogSuppressionZone(S_PLA_TG_InTavern_3d3f482f-8e20-4f33-b927-5cdb96971390);

//END_REGION

//REGION GUS-297422
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_GlobalFlag((FLAG)SHA_Orthon_State_Defeated_f9b8bab6-c2ce-4051-9a3f-5b6c7846ff34)
AND
NOT DB_GlobalFlag((FLAG)SHA_OrthonLair_Event_OrthonKillsSelf_5779d2a2-1676-463d-905b-699e9c7b1bc7)
THEN
DB_BUGFIX_Marker("GUS-297422");
QuestUpdate("SHA_OldEnemy", "DefeatedOrphon");
//END_REGION GUS-297422

//REGION GUS-274891
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_ORI_Karlach_InfernalMetalTemplates(_Template)
AND
NOT DB_PermaDefeated(S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79)
AND
TemplateIsInInventory(_Template, S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, _Count)
AND
_Count > 0
THEN
DB_BUGFIX_Marker("GUS-274891");
TemplateRemoveFrom(_Template, S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, _Count);
//END_REGION GUS-274891

//REGION GUS-297933, GUS-298002, GUS-297617
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_QuestDef_State((FLAG)SCL_LiftingTheCurse_State_OliverAgreedToReturnToThaniel_3073ae92-8e87-42d1-a426-fe3e6c5e6deb, "SCL_LiftingTheCurse", "TalkToThaniel");
DB_QuestDef_State((FLAG)HAV_LiftingTheCurse_State_HalsinGoToLake_bc4cd1f7-5e60-40e1-a583-aa886fe5b682, "SCL_LiftingTheCurse", "HalsinRitualReady");
NOT DB_QuestDef_State((FLAG)GLO_LiftingTheCurse_Event_TravelToLakeside_e06813a1-899a-498e-bd18-d22bee7d30e6, "SCL_LiftingTheCurse", "HalsinRitualReady");
DB_BUGFIX_Marker("GUS-297933");
DB_BUGFIX_Marker("GUS-298002");
DB_BUGFIX_Marker("GUS-297617");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
AND
DB_PermaDefeated(S_SCL_OliverFight_Nightdome_d5ca84a9-98a4-47e4-ab5f-ee8b245c48d5)
AND
NOT DB_InCamp(S_HAV_SpiritOfTheLand_1403cdfd-0660-4592-90c6-bfe4607ccd3a)
AND
NOT DB_LevelLoadedOnce("INT_Main_A")
THEN
DB_InCamp(S_HAV_SpiritOfTheLand_1403cdfd-0660-4592-90c6-bfe4607ccd3a);

//END_REGION GUS-297933, GUS-298002, GUS-297617

//REGION GUS-297140
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Target_PommelStrike");
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Target_Slash_New");
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Projectile_HamstringShot");
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Rush_SpringAttack");
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Target_SneakAttack");
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Projectile_SneakAttack");
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Target_PiercingThrust");
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Target_OpeningAttack");
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Zone_Cleave");
DB_GLO_TutorialEvents_EndTheDayTutorial_ShortRestSpells("Target_VampireBite_Astarion");
DB_BUGFIX_Marker("GUS-297140");
//END_REGION GUS-297140

//REGION GUS-295168
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,3,0)
THEN
DB_CompanionCaredFaction_IgnoredNPC((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);
DB_BUGFIX_Marker("GUS-295168");

//END_REGION GUS-295168

//REGION GUS-297679

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
PROC_END_General_FindMainAvatar();
DB_DialogDeath(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759);
DB_BUGFIX_Marker("GUS-297679");

//END_REGION

//REGION GUS-298061

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
DB_END_BrainBattle_QueuedRestoreCharacters(_Character)
AND
NOT DB_CantAct(_Character)
AND
NOT DB_Defeated(_Character)
THEN
NOT DB_END_BrainBattle_QueuedRestoreCharacters(_Character);
DB_BUGFIX_Marker("GUS-298061");

//END_REGION

//REGION GUS-294500

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
NOT DB_GLO_Cinematic_PositionFlags("DEN_GuardedEntrance_ParentsScene",(TRIGGER)S_DEN_SacredPond_SUB_2303e19f-549f-434f-bee0-b886fb34c46a,(FLAG)DEN_GuardedEntrance_Event_ApproachingFromPool_2cd5b87c-9d1c-48f1-acca-3200bd781396);
NOT DB_GLO_Cinematic_PositionFlags("DEN_GuardedEntrance",(TRIGGER)S_DEN_PondTrespassBox_d99e1d87-6753-4fc0-8138-9cd7c15f9d84,(FLAG)DEN_GuardedEntrance_Event_ApproachingFromPool_2cd5b87c-9d1c-48f1-acca-3200bd781396);
DB_GLO_Cinematic_PositionFlags("DEN_GuardedEntrance_ParentsScene",(TRIGGER)S_DEN_InPondCineBox_aa3df728-e88d-434d-8913-94ddd5273a4a,(FLAG)DEN_GuardedEntrance_Event_ApproachingFromPool_2cd5b87c-9d1c-48f1-acca-3200bd781396);
DB_GLO_Cinematic_PositionFlags("DEN_GuardedEntrance",(TRIGGER)S_DEN_InPondCineBox_aa3df728-e88d-434d-8913-94ddd5273a4a,(FLAG)DEN_GuardedEntrance_Event_ApproachingFromPool_2cd5b87c-9d1c-48f1-acca-3200bd781396);
DB_BUGFIX_Marker("GUS-294500");

//END_REGION
//REGION GUS-258003
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem001_aa9fb237-7e97-4c23-bdd8-3c8e4c5cf5b9, S_LOW_KurwinCoffin_KoboldSpawn001_7994ac58-4731-4fa0-9a67-aa4344fe6779);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem002_468a7ce1-bcb2-4ea8-ad17-a4c5a6c18153, S_LOW_KurwinCoffin_KoboldSpawn002_c21fe2ed-913b-47ae-b11c-eed803d77115);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem003_0b97635b-8082-44c0-b2cd-f8853408194f, S_LOW_KurwinCoffin_KoboldSpawn003_f2f32380-c9c5-449d-8c8f-faa56a6f8ddb);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem004_422ffd36-8314-4c8f-b016-0c03db4e40d2, S_LOW_KurwinCoffin_KoboldSpawn004_b650b1a8-967d-4482-ad86-ce218772ef1d);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem005_d1771acc-becd-4bdf-96af-fe02073b2a4e, S_LOW_KurwinCoffin_KoboldSpawn005_0dd30c36-a1fd-4841-bde5-d4e40f9a2172);
DB_LOW_KurwinCoffin_KoboldGang_Hole((ITEM)PUZ_LOW_KoboldHoleItem006_fe6c5226-2e2e-4767-9658-793c51bc3668, S_LOW_KurwinCoffin_KoboldSpawn006_8eacd75a-745e-4d1c-8168-6a6dc8dffe89);
PROC_LOW_KurwinCoffin_KoboldGang_PatchUpdate();
DB_LOW_KurwinCoffin_KoboldGang_Kobolds((CHARACTER)S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15);
DB_BUGFIX_Marker("GUS-258003");

PROC
PROC_LOW_KurwinCoffin_KoboldGang_PatchUpdate()
AND
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_Cemetery_Kobolds_Inventor_596e6013-a425-4556-98f2-df11074d634e)
THEN
NOT DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_Cemetery_Kobolds_Inventor_596e6013-a425-4556-98f2-df11074d634e);
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_KurwinCoffin_Kobolds_Inventor_f464fb6a-ff22-4ba6-9a33-d9608b67c044);

PROC
PROC_LOW_KurwinCoffin_KoboldGang_PatchUpdate()
AND
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_Cemetery_Kobolds_Melee_2daa2279-7433-4fa3-a7b0-6eebcdd8a6cb)
THEN
NOT DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_Cemetery_Kobolds_Melee_2daa2279-7433-4fa3-a7b0-6eebcdd8a6cb);
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_KurwinCoffin_Kobolds_Melee_339b7a9b-fce9-42d3-a542-2cb116c174aa);

PROC
PROC_LOW_KurwinCoffin_KoboldGang_PatchUpdate()
AND
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_Cemetery_Kobolds_Ranger_895f246d-bf19-4f45-b69a-2352be412a3e)
THEN
NOT DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_Cemetery_Kobolds_Ranger_895f246d-bf19-4f45-b69a-2352be412a3e);
DB_LOW_KurwinCoffin_KoboldRootList((CHARACTERROOT)LOW_KurwinCoffin_Kobolds_Ranger_592f90cc-f9bd-4916-a493-0439935a2c04);

PROC
PROC_LOW_KurwinCoffin_KoboldGang_PatchUpdate()
AND
DB_LOW_KurwinCoffin_KoboldGang(_OldHole, _Trigger)
AND
DB_LOW_KurwinCoffin_KoboldGang_Hole(_CorrespondingHole, _Trigger)
AND
IsOnStage (_OldHole, 1)
AND
NOT DB_Defeated(_OldHole)
THEN
DB_LOW_KurwinCoffin_KoboldGang_PatchUpdate_UpdateNewHole((ITEM)_CorrespondingHole);

IF
DB_LOW_KurwinCoffin_KoboldGang_PatchUpdate_UpdateNewHole(_CorrespondingHole)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_SetOnStage(_CorrespondingHole, 1);
ApplyStatus(_CorrespondingHole, "LOW_KOBOLDHOLE_SPAWNKOBOLD", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_LOW_KurwinCoffin_KoboldGang_PatchUpdate()
AND
DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)_Character, _Trigger)
AND
_Character != S_LOW_KurwinCoffin_KoboldLooter_7f85b5a5-6912-4776-abd0-5282bc8fef15
THEN
DB_LOW_KurwinCoffin_KoboldGang_PatchUpdate_UpdateOldHole((CHARACTER)_Character);

IF
DB_LOW_KurwinCoffin_KoboldGang_PatchUpdate_UpdateOldHole((CHARACTER)_Character)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_SetOnStage(_Character, 0);

PROC
PROC_LOW_KurwinCoffin_KoboldGang_PatchUpdate()
AND
DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)_Character, _Trigger)
THEN
NOT DB_LOW_KurwinCoffin_KoboldGang((CHARACTER)_Character, _Trigger);
//END_REGION


//REGION GUS-298429

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
NOT DB_QuestDef_State((FLAG)ORI_Gale_State_Met_ElminsterInWYR_82b0cbde-1d3b-1f67-86a8-d05744462209, "ORI_Avatar_Gale", "MetElminsterCTY");
NOT DB_QuestDef_State((FLAG)ORI_Gale_State_Met_ElminsterInWYR_82b0cbde-1d3b-1f67-86a8-d05744462209, "ORI_Avatar_Gale", "MeetElminsterCTY");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_Met_ElminsterInWYR_82b0cbde-1d3b-1f67-86a8-d05744462209)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
QuestUpdate((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "MeetElminsterCTY");

//END_REGION

//REGION GUS-294796, GUS-294796, GUS-298127, GUS-298028
//Making sure Arabella is NOT showing up in act3 camps
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
DB_GLO_Levels_RemoveArabellaFromCamp("INT_Main_A");
DB_GLO_Levels_RemoveArabellaFromCamp("BGO_Main_A");
DB_GLO_Levels_RemoveArabellaFromCamp("BGO_Main_A");
DB_BUGFIX_Marker("GUS-294796");
DB_BUGFIX_Marker("GUS-294796");
DB_BUGFIX_Marker("GUS-298127");
DB_BUGFIX_Marker("GUS-298028");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
DB_CurrentLevel(_Level)
AND
DB_GLO_Levels_RemoveArabellaFromCamp(_Level)
AND
DB_InCamp((CHARACTER)S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f)
THEN
NOT DB_InCamp(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f);
PROC_SetOnStage(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f, 0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
DB_CurrentLevel(_Level)
AND
DB_GLO_Levels_RemoveArabellaFromCamp(_Level)
AND
DB_CampLevelSwap_WasInCamp((CHARACTER)S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f)
THEN
NOT DB_CampLevelSwap_WasInCamp(S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f);

//IF you are in CTY_MAIN_A and haven't met Arabella in the Sewers yet, send her back there
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LOW_Sewers_ArabellaWaitingForEndgame(1)
THEN
PROC_LOW_Sewers_ArabellaSetup();
//END_REGION

//REGION GUS-286846

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
DB_FugitiveArea((TRIGGER)S_DEN_PrisonPlayerCell_e15271a6-7b38-49cb-b0f2-7ce9ed754af1, (TRIGGER)S_DEN_Cave_SUB_adecafa4-27c6-4b2f-bf9e-6ffd7c81a766);
DB_FugitiveArea((TRIGGER)S_GOB_PrisonPlayerCell_0d2ab4af-1776-4363-9200-f3a45e883046, (TRIGGER)S_GOB_WolfPens_SUB_a9a4a7c2-87c6-4031-9859-7eddb0528ff6);
DB_FugitiveArea((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, (TRIGGER)S_HAV_FugitiveTravelBlockArea_f70c44f6-3abc-4cc9-bcd5-f57a95709118);
DB_FugitiveArea((TRIGGER)S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7, (TRIGGER)S_MOO_CrimeRegionTrigger_Prison_0e3f7ebc-9932-488b-aef0-f55660b03cda);
DB_FugitiveArea((TRIGGER)S_WYR_WyrmRockPrison_PlayerCell_6792230e-f319-4870-8778-5f7bfae74489, (TRIGGER)S_WYR_Prison_SUB_cd67276d-52e4-44b9-a237-0e2cd45106d8);
DB_FugitiveArea((TRIGGER)S_LOW_Prison_PlayerCell_5e186d0c-b640-4239-8174-b58eb1dd3b86, (TRIGGER)S_LOW_BasiliskGate_Prison_SUB_02fab939-1f5f-4cc5-8fe8-acae0b864576);
DB_BUGFIX_Marker("GUS-286846");

//END_REGION

//REGION GUS-298503
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_ORI_Partnered(_Avatar, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
GetFlag(ORI_Karlach_State_SleptWithMizora_e0c36221-366c-d689-58b9-de92dc651cbe, _Avatar, 1)
AND
NOT DB_OnlyOnce("ORI_Karlach_ConfrontPlayerAboutMizoraRomance")
THEN
DB_ORI_Karlach_ConfrontAvatarAboutMizora((CHARACTER)_Avatar);
DB_BUGFIX_Marker("GUS-298503");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_ORI_Karlach_ConfrontAvatarAboutMizora((CHARACTER)_Avatar)
AND
NOT DB_InCamp((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_OnlyOnce("ORI_Karlach_ConfrontPlayerAboutMizoraRomance")
THEN
PROC_ORI_Karlach_TryConfrontPlayerAboutMizoraRomance(_Avatar);
DB_BUGFIX_Marker("GUS-298503");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,(DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_MizoraPartnerFollowup_de1c1b7e-3eb4-11dc-6217-bf8e236d1166,_,_,_)
THEN
DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_MizoraPartnerFollowup_de1c1b7e-3eb4-11dc-6217-bf8e236d1166);
DB_BUGFIX_Marker("GUS-298503");
//END_REGION GUS-298503

//REGION GUS-3591644

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
AND
DB_Achievements_BG3_Quest37_TrapStatuses("WYR_GORTASH_SHIELD_BUFF")
THEN
NOT DB_Achievements_BG3_Quest37_TrapStatuses("WYR_GORTASH_SHIELD_BUFF");

//END_REGION

//REGION GUS-297987

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
AND
DB_TopicalGreetingEndCondition_LeaveTriggerSet(_,_TriggerSet)
AND
NOT DB_TriggerEvents_AllPlayersLeftAllTriggersInSet(_TriggerSet, "TopicalGreeting_LeftTriggerSet")
THEN
DB_TriggerEvents_AllPlayersLeftAllTriggersInSet(_TriggerSet, "TopicalGreeting_LeftTriggerSet");

//END_REGION

//REGION GUS-298873
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
AND
NOT DB_BUGFIX_Marker("GUS-298873")
AND
GetFaction(S_GLO_Expeditioner_5f4048ba-72ef-43c2-9528-1c9a12f3f82f,(FACTION)ACT1_UND_SocietyOfBrilliance_e367e82e-d7c3-40ad-ad92-bf59486af503)
THEN
SetFaction(S_GLO_Expeditioner_5f4048ba-72ef-43c2-9528-1c9a12f3f82f,(FACTION)Act1B_CRE_Expeditioner_fca20c33-0180-44bc-ae98-99928c327979);
DB_BUGFIX_Marker("GUS-298873");
PROC_UND_ResetNeutralRelationsForSoB();

PROC
PROC_UND_ResetNeutralRelationsForSoB()
AND
DB_BUGFIX_Marker("GUS-298873")
AND
NOT DB_PermaDefeated(S_GLO_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09)
AND
NOT DB_PermaDefeated(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53)
AND
DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_Hostile_610268dd-8c8e-7492-db38-b37f08c36685)
AND
NOT DB_GlobalFlag((FLAG)UND_SocietyOfBrilliance_State_Retreated_19eb5da8-b26b-470d-bc12-4e7df3ba2b77)
AND
DB_PartOfTheTeam(_Character)
AND
GetFaction(_Character,_Faction)
AND
GetRelation((FACTION)ACT1_UND_SocietyOfBrilliance_e367e82e-d7c3-40ad-ad92-bf59486af503,_Faction,0)
THEN
ClearFlag((FLAG)UND_SocietyOfBrilliance_State_Hostile_610268dd-8c8e-7492-db38-b37f08c36685);
PROC_SetRelationToPlayers((FACTION)ACT1_UND_SocietyOfBrilliance_e367e82e-d7c3-40ad-ad92-bf59486af503,50);
PROC_SetRelationMutual((FACTION)ACT1_UND_SocietyOfBrilliance_e367e82e-d7c3-40ad-ad92-bf59486af503,_Faction,50);
//END_REGION

//REGION GUS-296200

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
THEN
NOT DB_END_GameFinale_UnpartneredOriginDialogues((CHARACTER)NULL_00000000-0000-0000-0000-000000000000, (DIALOGRESOURCE)END_GameFinale_SoloFates_CustomAvatar_f346a423-c718-45ca-3a0d-cc228b92abe6);

//END_REGION

//REGION GUS-300409

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,11,0)
AND
DB_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_PartOfTheTeam(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
DB_BUGFIX_Marker("GUS-300409");
PROC_Origins_ForceLowApprovalLeavingDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

//END_REGION GUS-300409

//REGION Clear some potentially lingering
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
THEN
DB_Origins_NestedFlags((FLAG)ORI_InParty_Event_EnterFromNestedEnd_d0b9336e-628d-9882-92f4-1e8333733573);
DB_Origins_NestedFlags((FLAG)ORI_InParty_Event_EnterFromNestedNoComment_9b25b086-d73c-4ae4-8099-d995a740be2d);
DB_Origins_NestedFlags((FLAG)ORI_InParty_Event_EnterFromNestedWithComment_1eed37c0-2301-440f-bf0e-842d49aacf5b);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
AND
DB_Origins_NestedFlags(_NestedFlag)
AND
DB_Origins(_Origin)
AND
GetFlag(_NestedFlag,_Origin,1)
THEN
DB_Origins_NestedFlagSet(_NestedFlag,_Origin);
//END_REGION

//REGION GUS-298204 The astral tadpole should also set the flag that you've consumed tadpoles.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
AND
DB_PartOfTheTeam(_TeamMember)
AND
IsTagged(_TeamMember,(TAG)PARTIAL_CEREMORPH_c0cd4ed8-11d1-4fb1-ae3a-3a14e41267c8,1)
THEN
SetFlag((FLAG)GLO_Tadpole_Event_FirstConsumed_fab5ae97-23b5-4bf2-88ae-0b1bd57523d8,_TeamMember,0);
DB_BUGFIX_Marker("GUS-298204 The astral tadpole should also set the flag that you've consumed tadpoles.");
//END_REGION

//REGION GUS-300482 Clean up stuck DB_Camp_WaitingForPlayersCleaned
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_Camp_WaitingForPlayersCleaned(_String)
THEN
DB_BUGFIX_Marker("GUS-300482-1 Cleaned up stuck DB_Camp_WaitingForPlayersCleaned");
NOT DB_Camp_WaitingForPlayersCleaned(_String);
//END_REGION

//REGION GUS-300482 Clean up stuck DB_Camp_AtLeastOnePlayerHasSleepCutscene
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_Camp_AtLeastOnePlayerHasSleepCutscene(1)
AND
NOT DB_DialogPlayers(_,_,_)
AND
NOT DB_DialogRequestCache_SpeakerList_Players(_,_,_,_)
THEN
DB_BUGFIX_Marker("GUS-300482-2 Cleaned up stuck DB_Camp_AtLeastOnePlayerHasSleepCutscene");
NOT DB_Camp_AtLeastOnePlayerHasSleepCutscene(1);
//END_REGION

//REGION GUS-300968 New avatars that join after tadpole powers are unlocked didn't have them unlocked.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_Tadpole_AllowUIEvents(1)
AND
DB_Tadpole_Activated(_Player)
AND
DB_GLO_TadpoleTreeEnabled(1)
AND
DB_GLO_DaisyAccepted(_Player)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
AND
NOT DB_GLO_TadpoleTreeEnabledForPlayer(_Player)
THEN
DB_GLO_TadpoleTreeEnabledForPlayer(_Player);
SetTadpoleTreeState(_Player,2);
AddTadpole(_Player,1);
AddTadpolePower(_Player,"TAD_IllithidPersuasion",1);
SetTag(_Player, (TAG)TADPOLE_TREE_UNLOCKED_efedb058-d4f5-4ab8-8add-bd5e32cdd9cd);
//END_REGION

//REGION GUS-300679 Stuck DB_Camper_TeleportOnLevelTemplateLoad
//Need to do this one before the regular PROC_ApplySavegamePatches() because the level templates load before patches are applied.
IF
SavegameLoadStarted()
AND
DB_Camper_TeleportOnLevelTemplateLoad((CHARACTER)_Camper, (STRING)_ActiveCamp)
THEN
DB_BUGFIX_Marker("GUS-300679 Cleaned up stuck DB_Camper_TeleportOnLevelTemplateLoad");
NOT DB_Camper_TeleportOnLevelTemplateLoad((CHARACTER)_Camper, (STRING)_ActiveCamp);
//END_REGION

//REGION GUS-301830 Stuck DB_Camp_ForceNextLongRest(1)
//Empty Fallback Nights would leave DB_Camp_ForceNextLongRest(1) up.
//This will fix most cases. However for savegames where the players are already in a CampNight, it's impossible to know if the force next long rest is intended or not.
//Worst case: They might get a free and dreamless night while maybe expecting a certain dream to trigger.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_Camp_ForceNextLongRest(1)
AND
NOT DB_Camp_NightMode(1)
THEN
NOT DB_Camp_ForceNextLongRest(1);
DB_BUGFIX_Marker("GUS-301830 Cleaned up stuck DB_Camp_ForceNextLongRest(1)");
//END_REGION

//REGION GUS-296200

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_OriginPartOfTheTeamFlag(_Companion,_,_, _)
AND
NOT DB_Avatars(_Companion)
AND
GetFlag(ORI_DarkUrge_Knows_BraggedSlayerForm_ffcc134e-c197-5727-cf61-66e7480d39f2, _Companion, 1)
THEN
ClearFlag((FLAG)TG_DarkUrge_SlayerForm_2784c68b-bbd0-4a7a-b382-61b11554e3bb, _Companion, 0);

//END_REGION
//REGION GUS-298734 Convincing Companions of Tadpoles too soon.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_GLO_TadpoleTreeEnabled(1)
THEN
SetFlag((FLAG)GLO_Tadpole_State_TreeUnlocked_f7691d3d-345b-4984-8eed-6f238a9f84be,NULL_00000000-0000-0000-0000-000000000000,0);
DB_BUGFIX_Marker("GUS-298734 Convincing Companions of Tadpoles too soon");
//END_REGION

//REGION GUS-294331 Wrong bed assignment in Elfsong
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Camp_BedAlternative((ITEM)S_CAMP_ELFSONG_Bed3_01c09d6c-388c-4355-9a78-71f223622edf,(TRIGGER)S_CAMP_Elfsong_Sleeptrigger4_3f77c951-f09c-4598-a2b0-94c6252c90c8)
THEN
NOT DB_Camp_BedAlternative((ITEM)S_CAMP_ELFSONG_Bed3_01c09d6c-388c-4355-9a78-71f223622edf,(TRIGGER)S_CAMP_Elfsong_Sleeptrigger4_3f77c951-f09c-4598-a2b0-94c6252c90c8);
NOT DB_Camp_BedAlternative((ITEM)S_CAMP_ELFSONG_Bed4_270c3922-0f3b-48c7-bd66-1177694aa915,(TRIGGER)S_CAMP_Elfsong_Sleeptrigger3_397e3d62-0a2b-4801-9ef7-957804618f67);
DB_Camp_BedAlternative((ITEM)S_CAMP_ELFSONG_Bed3_01c09d6c-388c-4355-9a78-71f223622edf,(TRIGGER)S_CAMP_Elfsong_Sleeptrigger3_397e3d62-0a2b-4801-9ef7-957804618f67);
DB_Camp_BedAlternative((ITEM)S_CAMP_ELFSONG_Bed4_270c3922-0f3b-48c7-bd66-1177694aa915,(TRIGGER)S_CAMP_Elfsong_Sleeptrigger4_3f77c951-f09c-4598-a2b0-94c6252c90c8);
//END_REGION

//REGION GUS-302100 Players stuck in LONG_REST status after cancelled fallback camp
PROC
PROC_ApplySavegamePatches()
AND //No version checking. This situation should never be possible and always be corrected.
NOT DB_Camp_NightMode(1)
AND
DB_Disturbance_PerformWhenAvailable_Incapacitated(_Player,"LONG_REST")
THEN
DB_BUGFIX_Marker("GUS-302100 Players stuck in LONG_REST status during day");
RemoveStatus(_Player,"LONG_REST");
//END_REGION

//REGION GUS-302549 Fix for Withers CRD breaking fallback regionswap
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 2")
AND
NOT DB_FallbackCamp_InCamp(_)
AND
DB_FallbackCamp_QueuedLevelswap( _Player, _CheckID, _Level )
THEN
DB_BUGFIX_Marker("GUS-302549 Fix for Withers CRD breaking fallback regionswap");
NOT DB_FallbackCamp_QueuedLevelswap( _Player, _CheckID, _Level );
//END_REGION

//REGION NOJIRA Incorrect clearing of DB_AddCharactersInTriggerToDialog
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704, 1, 1, 1, _)
AND
NOT DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704, 1, 1, 1)
THEN
PROC_AddCharactersInTriggerToDialog_Clear((DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704, 1, 1, 1, _)
AND
NOT DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704, 1, 1, 1)
THEN
PROC_AddCharactersInTriggerToDialog_Clear((DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)INT_EmperorRevealed_AfterOrpheus_b66e7115-ecea-7fc0-5a33-61a6eed77ab2,(TRIGGER)S_INT_AstralPlaneArea_37dec4e1-9db0-44a9-bd39-a5f4362d2ab2,1,1,_,_)
AND
NOT DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)INT_EmperorRevealed_AfterOrpheus_b66e7115-ecea-7fc0-5a33-61a6eed77ab2,(TRIGGER)S_INT_AstralPlaneArea_37dec4e1-9db0-44a9-bd39-a5f4362d2ab2,1,1)
THEN
PROC_AddCharactersInTriggerToDialog_Clear((DIALOGRESOURCE)INT_EmperorRevealed_AfterOrpheus_b66e7115-ecea-7fc0-5a33-61a6eed77ab2,(TRIGGER)S_INT_AstralPlaneArea_37dec4e1-9db0-44a9-bd39-a5f4362d2ab2);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_AddCharactersInTriggerToDialog(CAMP_MonitorIntro_CFM_6aa2bfc3-d9e6-a2d8-d017-25d59d9f757a,_Trigger,1,_,_,_)
AND
NOT DB_AddCharactersInTriggerToDialog(CAMP_MonitorIntro_CFM_6aa2bfc3-d9e6-a2d8-d017-25d59d9f757a,_Trigger,1)
THEN
PROC_AddCharactersInTriggerToDialog_Clear(CAMP_MonitorIntro_CFM_6aa2bfc3-d9e6-a2d8-d017-25d59d9f757a,_Trigger);
PROC_AddCharactersInTriggerToDialog_Clear(FOR_Monitor_Dinner_c6618ea4-f1a5-086f-936e-402f4d74fa38,_Trigger);
//END_REGION


//REGION GUS-297961
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
THEN
NOT DB_GLO_Inclusion_DisableForDialog((DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)CAMP_Laezel_WRD_AfterVlaakithVisit_733e7f87-f3b7-902a-487b-9af85c13590d);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)CRE_Laezel_WRD_PostCrecheDestruction_379c8d83-89d6-18dd-c48a-75a360f8a76c);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)CRE_Laezel_WRD_PostZaithisk_bafb04ca-e293-d07b-9b46-5a8578de9846);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)GLO_Laezel_WRD_AfterVossCampConfrontation_320ec283-5803-0bf5-5c1f-77fe0961bef6);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)GLO_Laezel_WRD_LearnedAboutOrphicHammer_ebc25934-7068-3bc2-f997-79b7d03b4737);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)GLO_Laezel_WRD_ProgressInAct2WithoutCreche_aa6fdbc8-6a7f-dd46-4a6f-366e36eeb4ab);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)INT_Laezel_WRD_AboutOrpheusAfterIntermezzo_54bd43a1-faf4-0143-8d75-2318ea061fbc);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)LOW_HouseOfHope_WRD_LaezelTookHammerFromHoH_154f0dd8-568c-5631-a8f8-85ffebbfcfa3);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)LOW_Laezel_WRD_GotSilverSword_61a02700-e193-7b09-29bc-aee682d06a15);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)LOW_Laezel_WRD_SavedFromOrin_00a838b2-a850-0c36-7231-6969601f1348);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)LOW_Laezel_WRD_VossWentToSewers_1ef8c879-6669-24f8-2aa9-4af6e54989f5);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)PLA_GithChokepoint_WRD_LaezelAfterVossAtChokepoint_05b0a5cc-5ea2-1c67-acff-a048b3eeb679);
DB_GLO_Inclusion_DisableForDialogInCamp((DIALOGRESOURCE)WYR_RaphaelTango_WRD_LaezelAfterRaphaelSoloScene_f540d320-bebb-2f8f-9a24-a734d1e47f5c);
DB_BUGFIX_Marker("GUS-297961");
//END_REGION

//REGION GUS-299737
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
THEN
DB_END_GameFinale_NoSeque((FLAG)END_GameFinale_State_GaleInElysium_d6c53ee8-ce94-4016-73ee-74d44d309837);
DB_END_GameFinale_NoSeque((FLAG)END_GameFinale_state_GaleChallengedMystra_d6dfa722-f85e-e191-a7e0-776d19c9f18a);
DB_END_GameFinale_NoSeque((FLAG)END_GameFinale_Event_GaleBecameGod_e85955a3-58d0-17ea-2d31-ed3713121d9b);
DB_END_General_MakeUnavailableFlag((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (FLAG)GLO_END_GameFinale_DeathofKarlach_KarlachWentWithNonRomanceWyll_a552e386-af26-eb98-d198-a84221e467b0, 1);
DB_END_General_MakeUnavailableFlag((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (FLAG) END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135, 1);
DB_END_General_MakeUnavailableFlag((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (FLAG)GLO_END_GameFinale_DeathofKarlach_KarlachWentWithNonRomanceWyll_a552e386-af26-eb98-d198-a84221e467b0, 1);
//END_REGION

//REGION GUS-299503
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
THEN
DB_OnlyOnce("SCL_ShadowCurse_OintmentRemindedTryVB");
DB_OnlyOnce("SHA_NightsongPrison_EntrancePlaqueReaction");
PROC_RemoveOneShotVoiceBarkTrigger(S_LOW_DevilsFee_VB_ArrivingDevilsFee_508b0ddc-9d86-4b46-b75e-86c3ff60c827,(VOICEBARKRESOURCE)LOW_DevilsFee_VB_ArrivingDevilsFee_412a027b-f609-51fe-74a1-a1ee0861e49e);
PROC_RemoveOneShotVoiceBarkTrigger(S_LOW_GuildhallEntrance_VB_MyKindOfAlley_c6513aaa-5eb2-4edf-94fd-04698a2e61e3, (VOICEBARKRESOURCE)LOW_GuildhallEntrance_VB_MyKindOfAlley_27d1a96c-9a92-ad32-65bf-92eadb1ae00b);
PROC_RemoveOneShotVoiceBarkTrigger(S_LOW_OneShotVB_Minsc_GiantSpaceHamsters_Trigger_ed2f8d68-a1db-4ff1-9fcf-242bfd995311,(VOICEBARKRESOURCE)LOW_OneShotVB_VB_Minsc_GiantSpaceHamsters_25327384-adf5-cdd2-9f9d-dcf2cf014054);
PROC_RemoveOneShotVoiceBarkTrigger(S_LOW_OneShotVB_Minsc_OnlyWhenCooked_Trigger_325f99d9-e33b-4e2c-b00f-94866d698504,(VOICEBARKRESOURCE)LOW_OneShotVB_VB_Minsc_OnlyWhenCooked_b11a5964-6977-0878-aa36-511a8ef9bbe6);
PROC_RemoveOneShotVoiceBarkTrigger(S_LOW_OneShotVB_Minsc_WizardlyBeards_Trigger_2081b23b-f7ff-4897-88cc-4cd534e2fede,(VOICEBARKRESOURCE)LOW_OneShotVB_VB_Minsc_WizardlyBeards_f6e6db83-4e59-2332-58a6-f63841d50410);
PROC_RemoveOneShotVoiceBarkTrigger(S_LOW_Docks_VB_ViewInDaylight_d95ca39a-d048-4931-9476-a330b469af72, (VOICEBARKRESOURCE)LOW_Docks_VB_ViewAtDaylight_8fbd99cb-117e-d6f7-cd4f-1ce5d241defe);
PROC_RemoveOneShotVoiceBarkTrigger(S_LOW_Park_VB_BloomridgePark_cd7ceadb-a69b-4229-a64e-951818822860, (VOICEBARKRESOURCE)LOW_Park_VB_BloomridgePark_1f307c01-f5de-22ee-fbaa-d461d403815f);
DB_BUGFIX_Marker("GUS-299503");
//END_REGION GUS-299503

//REGION GUS-300496
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
THEN
DB_BUGFIX_Marker("GUS-300496");
NOT DB_TopicalGreetingStartCondition_FlagSet((FLAG)TG_GEN_Orin_MetImpersonation_810a4ccf-5133-4e8f-a697-e73512677373, (FLAG)WYR_OrinsImpersonation_State_MetOrinOnce_5f82392a-6e8f-4c9b-a927-b9d77ee263ec);
DB_TopicalGreetingStartCondition_FlagSet((FLAG)TG_GEN_Orin_MetImpersonation_810a4ccf-5133-4e8f-a697-e73512677373, (FLAG)WYR_OrinsImpersonation_State_MetOrinOnce_EnableTG_4f3080c7-7324-4326-9daf-a8f8ffa96551);
NOT DB_TopicalGreetingEndCondition_LeaveCamp((FLAG)TG_GEN_Orin_MetImpersonation_810a4ccf-5133-4e8f-a697-e73512677373);
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_GEN_Orin_MetImpersonation_810a4ccf-5133-4e8f-a697-e73512677373, (FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d);
//END_REGION

//REGION GUS-300318
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
NOT DB_OneTimeEventFlag((FLAG)GLO_HeadRemoval_Event_HeadToInventory_65952066-e8d5-4f06-a685-9997e3b7e918)
THEN
DB_BUGFIX_Marker("GUS-300318");
DB_OneTimeEventFlag((FLAG)GLO_HeadRemoval_Event_HeadToInventory_65952066-e8d5-4f06-a685-9997e3b7e918);
PROC_GLO_ClearHeadRemovalEventFlag();

PROC
PROC_GLO_ClearHeadRemovalEventFlag()
AND
DB_PartOfTheTeam(_Character)
AND
GetFlag((FLAG)GLO_HeadRemoval_Event_HeadToInventory_65952066-e8d5-4f06-a685-9997e3b7e918,_Character,1)
THEN
ClearFlag((FLAG)GLO_HeadRemoval_Event_HeadToInventory_65952066-e8d5-4f06-a685-9997e3b7e918,_Character);
//END_REGION

//REGION GUS-296605
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_HandlingRelationshipDialog(_Companion, _Dialog, (FLAG)GLO_IPRD_RomanceConflict_55fcfaed-dfaa-cc31-39bc-c7b163a53c4a, _, _, _)
AND
NOT DB_ORI_Dating(_, _Companion)
THEN
DB_BUGFIX_Marker("GUS-296605");
PROC_CancelRelationshipDialog(_Companion, _Dialog, (FLAG)GLO_IPRD_RomanceConflict_55fcfaed-dfaa-cc31-39bc-c7b163a53c4a);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_RelationshipDialog_Queue(_Companion, _Dialog, (FLAG)GLO_IPRD_RomanceConflict_55fcfaed-dfaa-cc31-39bc-c7b163a53c4a, _, _, _)
AND
NOT DB_ORI_Dating(_, _Companion)
THEN
DB_BUGFIX_Marker("GUS-296605");
PROC_CancelRelationshipDialog(_Companion, _Dialog, (FLAG)GLO_IPRD_RomanceConflict_55fcfaed-dfaa-cc31-39bc-c7b163a53c4a);
//END_REGION GUS-296605

//REGION GUS-300182
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_Knows_RitualsPurpose_d1dc0f8a-b77d-4e40-a501-a66e163b8376)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_RitualGeneralInfo_abfca940-2838-41f1-b7dd-142ebba67137)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_Knows_RitualGeneralInfo_abfca940-2838-41f1-b7dd-142ebba67137);
DB_BUGFIX_Marker("GUS-300182");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag((FLAG)WYR_VampireSpawns_State_ToldAscension_a48047ea-da16-4451-838d-d129ed8ecbae)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_RitualGeneralInfo_abfca940-2838-41f1-b7dd-142ebba67137)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_Knows_RitualGeneralInfo_abfca940-2838-41f1-b7dd-142ebba67137);
DB_BUGFIX_Marker("GUS-300182");
//END_REGION

//REGION GUS-301134
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 1") // bumped to Release Hotfix 1 because this was accidentally missed out during an integrate.
THEN
DB_BUGFIX_Marker("GUS-301134");
PROC_GLO_Bugfix_301134_SceneOver();

PROC
PROC_GLO_Bugfix_301134_SceneOver()
AND
DB_LevelUnreachable("SCL_Main_A")
AND
NOT DB_Dialogs(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, (DIALOGRESOURCE)END_GatherYourAllies_WithersFollowUp_8ad51e88-b148-0813-f2f8-f21360853888)
THEN
PROC_SceneOver("CAMP_JergalArabellaThreeWay");
PROC_GLO_Jergal_SetDialog((DIALOGRESOURCE)CAMP_Jergal_7f4acd9b-15c0-81fe-9409-623634ec3ed3);
//END_REGION GUS-301134

//REGION GUS-302301
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 3") // bumped to Release Hotfix 3 from 1, since the savegamepatch is the same, its the fix that was added.
AND
DB_LevelUnreachable("SCL_Main_A")
AND
NOT DB_Dialogs(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, (DIALOGRESOURCE)END_GatherYourAllies_WithersFollowUp_8ad51e88-b148-0813-f2f8-f21360853888)
THEN
DB_BUGFIX_Marker("GUS-302301");
PROC_SceneOver("CAMP_JergalArabellaThreeWay");
DB_Dialogs(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, (DIALOGRESOURCE)CAMP_Jergal_7f4acd9b-15c0-81fe-9409-623634ec3ed3);
//END_REGION

//REGION GUS-300338
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_END_PartyMemberTeleport_b8d5ff34-ccc2-425c-a712-172497273dc0);
PROC_TriggerRegisterForParty((TRIGGER)S_END_PartyMemberTeleport_b8d5ff34-ccc2-425c-a712-172497273dc0);
//END_REGION

//REGION GUS-301010

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_RelationshipDialog_Queue((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)ORI_Resurrected_WRD_Gale_6ed0f4c2-5324-08bd-bf27-22237a90da64, _, _, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)ORI_Resurrected_WRD_Gale_6ed0f4c2-5324-08bd-bf27-22237a90da64, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)ORI_Resurrected_WRD_Gale_6ed0f4c2-5324-08bd-bf27-22237a90da64, _, _, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)ORI_Resurrected_WRD_Gale_6ed0f4c2-5324-08bd-bf27-22237a90da64, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION GUS-299880
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
THEN
DB_BUGFIX_Marker("GUS-299880");
DB_CampNight((FLAG)NIGHT_Karlach_AfterDefeatingGortash_b8e239e4-e73e-433e-9550-e4a56bdbffd1, 5500); // Unfortunately we don't have a way to know if this scene happened before or not
DB_CampNight_Camp((FLAG)NIGHT_Karlach_AfterDefeatingGortash_b8e239e4-e73e-433e-9550-e4a56bdbffd1, "FARM");
DB_CampNight_Camp((FLAG)NIGHT_Karlach_AfterDefeatingGortash_b8e239e4-e73e-433e-9550-e4a56bdbffd1, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Karlach_AfterDefeatingGortash_b8e239e4-e73e-433e-9550-e4a56bdbffd1, "ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Karlach_AfterDefeatingGortash_b8e239e4-e73e-433e-9550-e4a56bdbffd1, (FLAG)WYR_GortashConfrontation_Event_SendKarlachToCamp_7a52ef44-835d-4af9-0388-cdd1036a09ed);
DB_CampNight_CancelledBy((FLAG)NIGHT_Karlach_AfterDefeatingGortash_b8e239e4-e73e-433e-9550-e4a56bdbffd1, (FLAG)ORI_Karlach_Event_ClearAfterGortashDefeatCRDAndIPRD_bbc8076f-bdd6-f53a-d9c3-3cfd87df1baf);
DB_CampNight_CRD((FLAG)NIGHT_Karlach_AfterDefeatingGortash_b8e239e4-e73e-433e-9550-e4a56bdbffd1, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_AfterDefeatingGortash_585a4ee6-b04f-2559-2bc5-ae99a1f57ff2);
//END_REGION GUS-299880

//REGION GUS-295030
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag((FLAG)VOLO_15d40b07-e13a-404b-bf6c-f8fef5c1680b)
AND
QRY_BUGFIX_VoloStateFlagStuckInDenOrGob()
AND
NOT DB_BUGFIX_Marker("GUS-295030")
THEN
DB_BUGFIX_Marker("GUS-295030");
PROC_GOB_VoloBallad_MoveVoloToCamp((DIALOGRESOURCE)CAMP_VoloOperation_ba7c506d-c743-5dc9-7d98-eeea7b4ef2a2);

QRY
QRY_BUGFIX_VoloStateFlagStuckInDenOrGob()
AND
DB_GlobalFLag((FLAG)GLO_Volo_State_AtDen_c1bb44ab-c358-46d1-a261-34356bf1d071)
THEN
DB_NOOP(1);

QRY
QRY_BUGFIX_VoloStateFlagStuckInDenOrGob()
AND
DB_GlobalFLag((FLAG)GLO_Volo_State_AtGoblinCamp_fc815506-028d-582d-a953-4182d682aa07)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-300824

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c)
AND
IsTagged(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)CLERIC_EVIL_aa9f126f-ac9a-48d9-a128-1394fae8f4e8, 0)
THEN
DB_BUGFIX_Marker("GUS-300824");
ClearTag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, ALIGN_EVIL_6d08632e-0300-4587-80b9-8e411b0efb3b);

//END_REGION GUS-300824

//REGION GUS-300992
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
THEN
DB_BUGFIX_Marker("GUS-300992");
NOT DB_CampNight_Requirement_Approval((FLAG)NIGHT_Astarion_ScarReading_Fallback_bd01fc04-00ce-4e32-bbee-aa248728a116, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 50);
DB_CampNight_Requirement_Approval((FLAG)NIGHT_Astarion_ScarReading_Fallback_bd01fc04-00ce-4e32-bbee-aa248728a116, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 30);
NOT DB_CampNight_Requirement_Approval((FLAG)NIGHT_Astarion_Act2RomanceFallback_7c169c4d-c675-483c-8861-c96954ecaa46, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 90);
DB_CampNight_Requirement_Approval((FLAG)NIGHT_Astarion_Act2RomanceFallback_7c169c4d-c675-483c-8861-c96954ecaa46, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 50);
//END_REGION


//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
THEN
DB_ORI_WasDatingFlag((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (FLAG)ORI_Gale_State_WasDating_88021437-235d-4e0f-8abb-b3083cb26ddb);
DB_Dialogs_StartDatingDialog((DIALOGRESOURCE)CAMP_GoblinHuntTieflingCelebration_CRD_Gale3b_a65afd51-538b-3b92-e09a-ea0bb06c36cb);
NOT DB_CampNight_Requirement(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3, (FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121, ORI_Gale_State_NotDating_21f19438-754d-4ad2-883e-fd3f8814b917);
DB_CampNight_Requirement(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3, (FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121);
DB_CampNight_Requirement_CanStartDating(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

//END_REGION


//REGION GUS-301076
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
IsTagged(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (TAG)WYLL_DEVIL_5e844f0e-d822-4210-a28e-6af149a7bd4b, 1)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_BUGFIX_Marker("GUS-301076");
DB_PLA_PaladinsOfTyr_TryResolve(1);
//END_REGION GUS-301076

//REGION GUS-301267

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
NOT DB_HandlingRelationshipDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _, _, _, _, _)
THEN
DB_BUGFIX_Marker("GUS-301267");
PROC_ExclamationMark_Hide((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

//END_REGION GUS-301267

//REGION GUS-301286

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
DB_Avatars(_Player)
AND
GetFlag((FLAG)ORI_State_DatingShadowheart_e87f1e21-a758-47ae-8c0e-9e715eb289b5, _Player, 1)
THEN
DB_BUGFIX_Marker("GUS-301286");
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_StartedRomance_f725b333-9846-4e6c-8123-35330f3e7aa5);
SetFlag((FLAG)ORI_Shadowheart_RomancingShadowheart_6fc310b9-5602-49ec-96b2-189365d142d0, _Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
DB_Avatars(_Player)
AND
GetFlag((FLAG)ORI_State_PartneredWithShadowheart_3808ae35-ad4e-465b-800b-63d32b77211e, _Player, 1)
THEN
DB_BUGFIX_Marker("GUS-301286");
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_StartedRomance_f725b333-9846-4e6c-8123-35330f3e7aa5);
SetFlag((FLAG)ORI_Shadowheart_RomancingShadowheart_6fc310b9-5602-49ec-96b2-189365d142d0, _Player);


//END_REGION GUS-301286

//REGION GUS-299763
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,14,0)
AND
DB_END_GodsAndMonsters_SceneSetup("END_GodsAndMonsters_RaphaelCrownUpdateFadeTo", (TRIGGER)S_END_GodMonRaphaelPoint_2512ae68-f8ab-448f-ae04-5fc6fa3b6b5e, (TRIGGER)S_END_RaphaelComeuppancePlayerPoint_20c9a3b8-eaff-4f86-9c65-7918c47bd42e)
AND
DB_END_GodsAndMonsters_SceneFades("END_GodsAndMonsters_RaphaelCrownUpdateFadeTo", "END_GameFinale_TeleportToRaphael", (DIALOGRESOURCE)END_GameFinale_RaphaelCrownUpdate_b7ee667d-d550-7115-37f3-ce900ca80cbd, (CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8)
THEN
DB_BUGFIX_Marker("GUS-299763");
NOT DB_END_GodsAndMonsters_SceneSetup("END_GodsAndMonsters_RaphaelCrownUpdateFadeTo", (TRIGGER)S_END_GodMonRaphaelPoint_2512ae68-f8ab-448f-ae04-5fc6fa3b6b5e, (TRIGGER)S_END_RaphaelComeuppancePlayerPoint_20c9a3b8-eaff-4f86-9c65-7918c47bd42e);
NOT DB_END_GodsAndMonsters_SceneFades("END_GodsAndMonsters_RaphaelCrownUpdateFadeTo", "END_GameFinale_TeleportToRaphael", (DIALOGRESOURCE)END_GameFinale_RaphaelCrownUpdate_b7ee667d-d550-7115-37f3-ce900ca80cbd, (CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);
DB_END_GodsAndMonsters_SceneSetup("END_GameFinale_TeleportToRaphael", (TRIGGER)S_END_GodMonRaphaelPoint_2512ae68-f8ab-448f-ae04-5fc6fa3b6b5e, (TRIGGER)S_END_RaphaelComeuppancePlayerPoint_20c9a3b8-eaff-4f86-9c65-7918c47bd42e);
DB_END_GodsAndMonsters_SceneFades("END_GameFinale_TeleportToRaphael", (DIALOGRESOURCE)END_GameFinale_RaphaelCrownUpdate_b7ee667d-d550-7115-37f3-ce900ca80cbd, (CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,14,0)
AND
DB_END_GodsAndMonsters_SceneSetup("END_GodsAndMonsters_WithersSceneFadeTo", (TRIGGER)S_END_GodMonWithersPoint_4017bacc-a1ab-49fd-bee4-1aa3f0326140, (TRIGGER)S_END_MeetingPlayerPoint_afa87cc8-c43a-4610-8b4e-98bf30c90735)
AND
DB_END_GodsAndMonsters_SceneFades("END_GodsAndMonsters_WithersSceneFadeTo", "END_GameFinale_TeleportToWithers", (DIALOGRESOURCE)END_GodsAndMonsters_WithersMeeting_037b2c4f-d8cd-b3bb-1471-a9dee232217d, (CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805)
THEN
DB_BUGFIX_Marker("GUS-299763");
NOT DB_END_GodsAndMonsters_SceneSetup("END_GodsAndMonsters_WithersSceneFadeTo", (TRIGGER)S_END_GodMonWithersPoint_4017bacc-a1ab-49fd-bee4-1aa3f0326140, (TRIGGER)S_END_MeetingPlayerPoint_afa87cc8-c43a-4610-8b4e-98bf30c90735);
NOT DB_END_GodsAndMonsters_SceneFades("END_GodsAndMonsters_WithersSceneFadeTo", "END_GameFinale_TeleportToWithers", (DIALOGRESOURCE)END_GodsAndMonsters_WithersMeeting_037b2c4f-d8cd-b3bb-1471-a9dee232217d, (CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
DB_END_GodsAndMonsters_SceneSetup("END_GameFinale_TeleportToWithers", (TRIGGER)S_END_GodMonWithersPoint_4017bacc-a1ab-49fd-bee4-1aa3f0326140, (TRIGGER)S_END_MeetingPlayerPoint_afa87cc8-c43a-4610-8b4e-98bf30c90735);
DB_END_GodsAndMonsters_SceneFades("END_GameFinale_TeleportToWithers", (DIALOGRESOURCE)END_GodsAndMonsters_WithersMeeting_037b2c4f-d8cd-b3bb-1471-a9dee232217d, (CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
//END_REGION

//REGION GUS-300070
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
CanJoinCombat(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 1)
THEN
DB_BUGFIX_Marker("GUS-300070");
SetCanJoinCombat(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 0);
//END_REGION GUS-300070

//REGION  GUS-301328

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,13,0)
AND
DB_InRegion(_Character, _BoxTrigger)
AND
DB_Players(_Character)
AND
DB_UND_Teleporter(_, _, _BoxTrigger, _Dialog, _PastTrigger)
AND
DB_UND_CinematicTriggerExit(_BoxTrigger, _PastTrigger)
AND
NOT DB_DialogName(_Dialog, _)
AND
NOT DB_DialogRequestCache_DialogInstance(_Dialog, _)
THEN
PROC_UND_TransitionCinematic_PassingTo(_PastTrigger);
TeleportTo(_Character, _PastTrigger, "", 0, 0, 1);
DB_BUGFIX_Marker("GUS-301328-1");


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,13,0)
AND
DB_UND_Teleporter(_, _, _BoxTrigger, _Dialog, _PastTrigger)
THEN
DB_DropMutingStatussesDialog(_Dialog);
DB_BUGFIX_Marker("GUS-301328-2");

//END_REGION

//REGION GUS-301378
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
DB_PlayerSlotReserved(_NegativeCount)
AND
_NegativeCount < 0
THEN
DB_BUGFIX_Marker("GUS-301378");
NOT DB_PlayerSlotReserved(_NegativeCount);
DB_PlayerSlotReserved(0);
PROC_CheckPartyFull();
//END_REGION

//REGION GUS-301167
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
THEN
DB_QuestDef_State(MOO_MintharaFate_State_Freed_b77a54f6-a1e8-20a7-b932-9a0c10547a39, "MOO_MintharaFate", "EscapeMoonrise");
DB_QuestDef_State(MOO_MintharaFate_Event_FightTorturers_9533b62a-0146-a079-76ca-789288c2d6b6, "MOO_MintharaFate", "DefeatTorturers");
DB_QuestDef_PermaDefeatedState("MOO_MintharaFate", "MintharaPermaDefeated", (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_QuestDef_State(HAV_MintharaFate_Event_LeavesForCamp_e4c67b18-4d1b-ed53-174b-ff8d7accd24d, "MOO_MintharaFate", "MintharaEscapedToCamp");
//END_REGION

//REGION GUS-301450
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,13,0)
AND
DB_GlobalFlag((FLAG)VISITEDREGION_SCL_Main_A_f6e72539-9bc6-42e1-a20f-390f3a17ad8d)
AND
DB_HAV_TieflingSurvivors(_Category, (CHARACTER)S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, _, _, _)
AND
NOT DB_HAV_TieflingSurvivors_ReachedHaven(_Category)
AND
QRY_HAV_TieflingSurvivors_CheckProdigyGroup((CHARACTER)S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79)
THEN
DB_BUGFIX_Marker("GUS-301450");
PROC_ORI_Karlach_CloseForgingOfTheHeartQuest();
//END_REGION GUS-301450

//REGION GUS-301544

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
AND
DB_WorldGossip_RegionTrigger((TRIGGER)S_PartyBanterTrigger_Grymforge_fcdff3ab-819a-49d1-8596-f93dc9185cd7,(FLAG)BANTERREGION_WLD_Grymforge_527edebb-25ff-4271-9b69-b355c72e6b4c)
THEN
NOT DB_WorldGossip_RegionTrigger((TRIGGER)S_PartyBanterTrigger_Grymforge_fcdff3ab-819a-49d1-8596-f93dc9185cd7,(FLAG)BANTERREGION_WLD_Grymforge_527edebb-25ff-4271-9b69-b355c72e6b4c);
DB_WorldGossip_RegionTrigger((TRIGGER)S_PartyBanterTrigger_Grymforge_fcdff3ab-819a-49d1-8596-f93dc9185cd6,(FLAG)BANTERREGION_WLD_Grymforge_527edebb-25ff-4271-9b69-b355c72e6b4c);
PROC_RegisterWorldGossipTrigger((TRIGGER)S_PartyBanterTrigger_Grymforge_fcdff3ab-819a-49d1-8596-f93dc9185cd6);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
THEN
DB_BUGFIX_Marker("GUS-301544");
DB_BUGFIX_HarvardItemsBGO_DoFix(1);

//Items not set offstage when they are supposed to be
IF
DB_BUGFIX_HarvardItemsBGO_DoFix(1)
AND
DB_ActiveLevel("BGO_Main_A")
AND
NOT DB_Harvard_Enable(1)
AND
IsOnStage(CONT_Egg_Owlbear_A_000_8410036e-3b67-451c-9e71-71e8687cf04e,1)
THEN
NOT DB_BUGFIX_HarvardItemsBGO_DoFix(1);
SetOnStage(CONT_GEN_Nest_Small_A_000_14b05f3d-6f08-46ad-8ed8-c1d82aed42f0,0);
SetOnStage(CONT_Egg_Owlbear_A_000_8410036e-3b67-451c-9e71-71e8687cf04e,0);

//END_REGION

//REGION GUS-301706
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
AND
DB_GlobalFlag(END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
THEN
DB_BUGFIX_Marker("GUS-301706");
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_SignedContractWithRaphael_b0bca668-7f2d-4ce7-acb6-b5ff96880388);
//END_REGION

//REGION GUS-301517
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
THEN
DB_BUGFIX_Marker("GUS-301517");
PROC_GLO_Bugfix_301517_RemoveUnneededDBs();

PROC
PROC_GLO_Bugfix_301517_RemoveUnneededDBs()
AND
DB_GEN_OrinsMessages_MovedMessage(1)
THEN
NOT DB_GEN_OrinsMessages_MovedMessage(1);

PROC
PROC_GLO_Bugfix_301517_RemoveUnneededDBs()
AND
DB_GEN_OrinsMessages_BloodSurfaceCreated(1)
THEN
NOT DB_GEN_OrinsMessages_BloodSurfaceCreated(1);
//END_REGION

//REGION
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_GLO_CompoundFlag((FLAG)LOW_BaldursMouth_Event_BoughtPaper_8ae9c432-8eb0-4959-bf42-3962e745853e, (FLAG)ORI_Minthara_Knows_BaldursMouthPropoganda_e493eab7-d363-42c7-9184-64b508510b2c)
THEN
NOT DB_GLO_CompoundFlag((FLAG)LOW_BaldursMouth_Event_BoughtPaper_8ae9c432-8eb0-4959-bf42-3962e745853e, (FLAG)ORI_Minthara_Knows_BaldursMouthPropoganda_e493eab7-d363-42c7-9184-64b508510b2c);
//END_REGION

//END_REGION

//REGION Post-release patches

//REGION GUS-306374
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LeaveCamp_ReturnPos(_Player,_X, _Y, _Z)
AND
QRY_CAMP_PositionIsInACamp(_X, _Y, _Z)
THEN
NOT DB_LeaveCamp_ReturnPos(_Player,_X, _Y, _Z);
DB_BUGFIX_Marker("GUS-306374",_Player);
//END_REGION

//REGION GUS-302328

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 2")
AND
DB_GLO_PartyMembers_DefaultFaction(_PlayerInCamp, _PlayerFaction)
THEN
PROC_ResetRelationMutual(_PlayerFaction, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 2")
AND
DB_PartyMembers(_Character)
AND
GetBaseFaction(_Character, _Faction)
AND
GetRelation(_Faction, Hero_a1542c81-6895-929e-4522-10ce218bb360, 50)
THEN
PROC_ResetRelationMutual(_Faction, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360);

//END_REGION

//REGION GUS-302763

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
PROC_FallbackCamp_DefineTeleporterCamps();

//END_REGION

//REGION GUS-305267
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
HasTadpolePower((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "TAD_PsionicBacklash" ,1)
THEN
DB_OnlyOnce("MintharaGetsHerTadpolePowers");
DB_BUGFIX_Marker("GUS-305267");
//END_REGION

//REGION Dead Avatar Dismissal - Soul Echo in the Cabinet
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_DismissedAvatar(_Avatar)
AND
HasActiveStatus(_Avatar, "DEAD_WILL_O_WISP", 1)
THEN
RemoveStatus(_Avatar,"DEAD_WILL_O_WISP",NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("Soul Echo in the Cabinet",_Avatar);
//END_REGION

//REGION GUSX-7440
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelUnreachable(_Level)
AND
DB_ActivePartyTriggers(_Level,_Trigger,_PlayerOnly)
THEN
NOT DB_ActivePartyTriggers(_Level,_Trigger,_PlayerOnly);
//END_REGION


//REGION GUS-302049

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_DaisyAD_Triggered(_DaisyAD, _UserID)
THEN
PROC_BG3_SaveGamePatches_GUS_302049_MigrateOldDaisyDBToNew(_DaisyAD);
NOT DB_DaisyAD_Triggered(_DaisyAD, _UserID);

PROC
PROC_BG3_SaveGamePatches_GUS_302049_MigrateOldDaisyDBToNew((DIALOGRESOURCE)_DaisyAD)
AND
DB_Avatars(_Player)
AND
GetReservedUserID(_Player,_UserID)
AND
GetUserProfileID(_UserID, _Profile)
AND
NOT DB_DaisyAD_TriggeredOnProfile(_DaisyAD,_Profile)
THEN
DB_DaisyAD_TriggeredOnProfile(_DaisyAD,_Profile);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_EmperorAD_Triggered(_DaisyAD, _UserID)
THEN
PROC_BG3_SaveGamePatches_GUS_302049_MigrateOldEmperorDBToNew(_DaisyAD);
NOT DB_EmperorAD_Triggered(_DaisyAD, _UserID);

PROC
PROC_BG3_SaveGamePatches_GUS_302049_MigrateOldEmperorDBToNew((DIALOGRESOURCE)_DaisyAD)
AND
DB_Avatars(_Player)
AND
GetReservedUserID(_Player,_UserID)
AND
GetUserProfileID(_UserID, _Profile)
AND
NOT DB_EmperorAD_TriggeredOnProfile(_DaisyAD,_Profile)
THEN
DB_EmperorAD_TriggeredOnProfile(_DaisyAD,_Profile);

//END_REGION

//REGION GUS-303683
//Clean up stuck dialogue databases.
PROC
PROC_ApplySavegamePatches()
AND
DB_DialogName(_Dialog,_Instance)
AND
NOT DialogGetCategory(_Instance,_)
THEN
DB_BUGFIX_Marker("GUS-303683",_Dialog,_Instance);
PROC_ClearDialogPlayers(_Instance);
PROC_ClearDialogNPCs(_Instance);
PROC_ClearDialogSpeakers(_Instance);
PROC_ClearDialogCounts(_Instance);
NOT DB_DialogName(_Dialog,_Instance);
NOT DB_DialogRequestFailed(_Dialog,_Instance);
NOT DB_DialogEnding(_Dialog,_Instance);
//END_REGION

//REGION GUS-302552
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
THEN
PROC_SavegamePatch_GUS_302552();

// Collect all players not currently being confronted for/interrogated about a crime.
// The issue is that the CurrentCrime for the players is set, but they're not being
// confronted/interrogated. In that case, GetHandlingCrimeID will still fail.
// We'll also collect players that are not broken, but that's fine.
PROC
PROC_SavegamePatch_GUS_302552()
AND
DB_Players(_Player)
AND
NOT GetHandlingCrimeID(_Player,_)
THEN
DB_BUGFIX_GUS_302552_Players(_Player);

PROC
PROC_SavegamePatch_GUS_302552()
THEN
PROC_UnpackDB("DB_BUGFIX_GUS_302552_Players","DB_BUGFIX_GUS_302552",NULL_00000000-0000-0000-0000-000000000000,4,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_UnpackDB_Callback("DB_BUGFIX_GUS_302552", NULL_00000000-0000-0000-0000-000000000000,(GUIDSTRING)_Criminal1,(GUIDSTRING)_Criminal2,(GUIDSTRING)_Criminal3,(GUIDSTRING)_Criminal4)
AND
_Criminal1 != NULL_00000000-0000-0000-0000-000000000000
AND
CrimeGetNewID(_CrimeID)
AND
CharacterRegisterCrime((CHARACTER)_Criminal1,"DummyHighPriorityCrime",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,_CrimeID,1)
THEN
CrimeInterrogationDone(_CrimeID,NULL_00000000-0000-0000-0000-000000000000,1,(CHARACTER)_Criminal1,(CHARACTER)_Criminal2,(CHARACTER)_Criminal3,(CHARACTER)_Criminal4);
DB_BUGFIX_Marker("GUS-302552");

PROC
PROC_UnpackDB_Callback("DB_BUGFIX_GUS_302552", NULL_00000000-0000-0000-0000-000000000000,(GUIDSTRING)_Criminal1,(GUIDSTRING)_Criminal2,(GUIDSTRING)_Criminal3,(GUIDSTRING)_Criminal4)
AND
DB_BUGFIX_Marker("GUS-302552")
AND
DB_BUGFIX_GUS_302552_Players(_Player)
THEN
NOT DB_BUGFIX_GUS_302552_Players(_Player);
DB_BUGFIX_Marker("GUS-302552",_Player);
//END_REGION

//REGION GUS-303108
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_GlobalFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
HasSpell((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "Target_VampireBite_Astarion", 0)
THEN
DB_BUGFIX_Marker("GUS-303108");
AddSpell(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "Target_VampireBite_Astarion", 1, 0);
//END_REGION

//REGION GUS-300198

//Restore off-staged DLC rewards that didn't need to go off stage
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
DB_DLC_StageObjects(_DLC,_Object,_OnStageWhenInstalled,_CurrentLevel)
AND
GetTemplate(_Object,_Template)
AND
DB_DLC_OneTimeRewards((DLC)_DLC,(ROOT)_Template,(INTEGER)_,(INTEGER)_,(INTEGER)_)
THEN
DB_BUGFIX_Marker_300198_RestoredDLCItems(_Object);
PROC_DLC_StageObjects_SetOnStage(_Object,1);

PROC
PROC_DLC_StageObjects_SetOnStage_Internal(_Object,1) //will trigger whether already on stage or not
AND
DB_BUGFIX_Marker_300198_RestoredDLCItems(_Object)
AND
DB_DLC_StageObjects(_DLC,_Object,_OnStageWhenInstalled,_CurrentLevel)
THEN
NOT DB_DLC_StageObjects(_DLC,_Object,_OnStageWhenInstalled,_CurrentLevel);

//END_REGION

//REGION GUS-302277

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Gale_LearnSpell_393b05ff-d866-4115-8ece-872232ce44cf,(FLAG)NIGHT_Gale_LearnSpell_Ready_52b7bd3d-97bc-4954-ab3b-b9eac520ea05);
DB_CampNight_Requirement((FLAG)NIGHT_Gale_LearnSpell_393b05ff-d866-4115-8ece-872232ce44cf,(FLAG)NIGHT_Gale_LearnSpell_Ready_52b7bd3d-97bc-4954-ab3b-b9eac520ea05, (FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735);
NOT DB_CampNight_Requirement(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3, (FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121);
DB_CampNight_Requirement(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3, (FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121, (FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735);
DB_CampNight_CancelledBy(NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac, (FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060);

DB_CampNight(NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, 810);
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "WLDBAS");

DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "CREMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "CREINSIDE");

DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "SHARTEMPLE");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, "MOONRISE");

DB_CampNight_Requirement(NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906);
DB_CampNight_CancelledBy(NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, (FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d);
DB_CampNight_CancelledBy(NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, (FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac);
DB_CampNight_CancelledBy(NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, (FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735);
DB_CampNight_CancelledBy(NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, (FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c);
DB_CampNight_Requirement_Approval(NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 20);
DB_CampNight_CRD((FLAG)NIGHT_Gale_Fallback_AskFirstMagicItem_Approval_5c61949f-e522-4a6d-8f39-9d45e859e060, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574,(FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);


DB_CampNight((FLAG)NIGHT_Gale_HasKarsusNotes_f9259b80-0a76-48cc-b8e9-ae4fcb1b827d, 4200);
DB_CampNight_Camp((FLAG)NIGHT_Gale_HasKarsusNotes_f9259b80-0a76-48cc-b8e9-ae4fcb1b827d, "FARM");
DB_CampNight_Camp((FLAG)NIGHT_Gale_HasKarsusNotes_f9259b80-0a76-48cc-b8e9-ae4fcb1b827d, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Gale_HasKarsusNotes_f9259b80-0a76-48cc-b8e9-ae4fcb1b827d, "ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Gale_HasKarsusNotes_f9259b80-0a76-48cc-b8e9-ae4fcb1b827d, (FLAG)ORI_Gale_State_HasKarsusNotes_NightRequirement_3b1c8482-253b-47e6-998b-0551da43272b, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906);
DB_CampNight_CRD((FLAG)NIGHT_Gale_HasKarsusNotes_f9259b80-0a76-48cc-b8e9-ae4fcb1b827d, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574,(FLAG)ORI_Gale_IPRD_HasKarsusNotes_9e7fb0cb-1ea5-23fa-9850-31422f42f0da);

DB_CampNight((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, 4205);
DB_CampNight_Camp((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, "FARM");
DB_CampNight_Camp((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, "ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906, ORI_Gale_Knows_BrainHasCrownOfKarsus_FromRaphael_4451456b-6f9b-7de2-9fae-68fc5a86f9d9);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, (FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, (FLAG)ORI_Gale_State_DiscussedLearnedCrownFromRaphael_6aa1cd78-e408-3aef-b055-a735e5bc90db);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, (FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff);//Minor mismatch with in-world conditions, but in this case it's a rather minor dialogue that we can miss.
DB_CampNight_CRD((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_BrainHasCrownOfKarsus_FromRaphael_0de0d760-e60f-8cab-6b0d-66c2ad67c638);

DB_CampNight((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, 4210);
DB_CampNight_Camp((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, "FARM");
DB_CampNight_Camp((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, "ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc, (FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff);
DB_CampNight_CancelledBy(NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, (FLAG)HoH_Warlock_State_ContractDestroyed_528a9080-f162-4a8c-bcc7-120db8fbd63f);
DB_CampNight_CancelledBy(NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, (FLAG)ORI_Gale_State_ComplainedContract_6b53fe80-58bd-9f22-d75c-e4b98e7388f8);
DB_CampNight_CRD((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_SignedContract_bdc786ed-fa49-abf3-407e-b94bfab30b3c);

DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicReminder_3834abc3-f70e-7bbf-b286-32b795cfc3c4);


DB_CampNight((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, 4020);
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2,"WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2,"WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2,"WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2,"WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2,"WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2,"WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2,"WLDBAS");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, "SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, "HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, "MOONRISE");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, "SHARTEMPLE");
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, (FLAG)ORI_Gale_State_GotTwoMagicItems_c757086e-4696-441d-b19c-fdb65982776f);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, (FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, (FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, (FLAG)ORI_Gale_Event_ThankedForItem1_06b9cd61-8d37-721d-784e-b5f2a4cf0cb2);
DB_CampNight_Requirement((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, (FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906);
DB_CampNight_CRD((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3);

DB_CampNight((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, 4030);
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132,"WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132,"WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132,"WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132,"WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132,"WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132,"WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132,"WLDBAS");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, "SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, "HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, "MOONRISE");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, "SHARTEMPLE");
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, (FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, (FLAG)ORI_Gale_Event_ThankedForItem2_2c6edb9b-ce0e-359b-abcc-412520192560);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, (FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c);
DB_CampNight_Requirement((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, (FLAG)ORI_Gale_State_GotTwoMagicItems_c757086e-4696-441d-b19c-fdb65982776f, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906);
DB_CampNight_CRD((FLAG)NIGHT_Gale_Ate2Items_4ced08e2-8635-4e67-b3f8-deb7288dc132, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_Ate2Items_359f4afc-378f-83f0-3602-21f1ec6511a0);


DB_CampNight((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0, 4040);
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0,"WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0,"WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0,"WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0,"WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0,"WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0,"WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0,"WLDBAS");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0, "SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0, "HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0, "MOONRISE");
DB_CampNight_Camp((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0, "SHARTEMPLE");
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0, (FLAG)ORI_Gale_Knows_LearnedBackstory_0a9731cf-4769-249f-818d-b4c6e542083d);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0, (FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c);
DB_CampNight_Requirement((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0, (FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906);
DB_CampNight_CRD((FLAG)NIGHT_Gale_Ate3Items_2f9bef51-e342-4741-84ba-2d4ba49e27b0, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_Ate3Items_a8e84a1d-7cfe-574a-b92d-34c58a02ba8b);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
DB_RelationshipDialogsFinished((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_NeedMagicItem1_c1899c40-e4c4-72d6-4360-444cea41e72f)
THEN
PROC_CampNight_ClearCampNight(NIGHT_Gale_Fallback_AskFirstMagicItem_7ee4663c-cabf-4b57-b092-99e6b6eadbac);

//END_REGION

//REGION GUS-304812

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2")
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Gale_LearnSpell_393b05ff-d866-4115-8ece-872232ce44cf,(FLAG)NIGHT_Gale_LearnSpell_Ready_52b7bd3d-97bc-4954-ab3b-b9eac520ea05, (FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735);
DB_CampNight_Requirement((FLAG)NIGHT_Gale_LearnSpell_393b05ff-d866-4115-8ece-872232ce44cf, (FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc, (FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff);
DB_CampNight_Requirement((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc, (FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff);

//END_REGION


//REGION GUS-307501
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-305317");
NOT DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3, (FLAG)ORI_Gale_Event_ThankedForItem1_Global_b64a5b68-42a4-4136-85e3-db588cf21871);
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3, (FLAG)ORI_Gale_Event_ThankedForItem1_06b9cd61-8d37-721d-784e-b5f2a4cf0cb2);
NOT DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, (FLAG)ORI_Gale_Event_ThankedForItem1_06b9cd61-8d37-721d-784e-b5f2a4cf0cb2);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_Ate1Item_ab1b5018-e0d7-4f2e-a1f5-c79defbda1a2, (FLAG)ORI_Gale_Event_ThankedForItem1_Global_b64a5b68-42a4-4136-85e3-db588cf21871);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3, (FLAG)ORI_Gale_Event_ThankedForItem1_06b9cd61-8d37-721d-784e-b5f2a4cf0cb2)
THEN
DB_BUGFIX_Marker("GUS-307501");
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3, (FLAG)ORI_Gale_Event_ThankedForItem1_Global_b64a5b68-42a4-4136-85e3-db588cf21871);
NOT DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3, (FLAG)ORI_Gale_Event_ThankedForItem1_06b9cd61-8d37-721d-784e-b5f2a4cf0cb2);


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_Avatars(_Avatar)
AND
GetFlag(ORI_Gale_Event_ThankedForItem1_06b9cd61-8d37-721d-784e-b5f2a4cf0cb2, _Avatar, 1)
THEN
DB_BUGFIX_Marker("GUS-305317 - Set Flag");
SetFlag(ORI_Gale_Event_ThankedForItem1_Global_b64a5b68-42a4-4136-85e3-db588cf21871, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3, _, _, _)
AND
DB_Avatars(_Avatar)
AND
GetFlag(ORI_Gale_Event_ThankedForItem1_06b9cd61-8d37-721d-784e-b5f2a4cf0cb2, _Avatar, 1)
THEN
DB_BUGFIX_Marker("GUS-305317 - Cancelled CRD");
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3);


//END_REGION

//REGION Avatar Dismissal via Withers
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
THEN
DB_GLO_Jergal_DismissedAvatarResurrectionFlags("CAMP_Jergal_DismissedAvatarToResurrect_1_539f07ee-87de-e8eb-9bac-ad94453a5cec", (FLAG)CAMP_Jergal_State_CanResurrect_DismissedAvatar1_59e0f109-ebdb-c096-feb0-191cb26bb134, (FLAG)CAMP_Jergal_Event_WillResurrect_DismissedAvatar1_e5ab9c33-4593-5d43-3889-2900cb57b11c);
DB_GLO_Jergal_DismissedAvatarResurrectionFlags("CAMP_Jergal_DismissedAvatarToResurrect_2_ab7994b8-7f12-6bf1-0c9b-d8ed4d3432ac", (FLAG)CAMP_Jergal_State_CanResurrect_DismissedAvatar2_09e7f4be-dda6-3c6c-116d-eb61aad7dfb0, (FLAG)CAMP_Jergal_Event_WillResurrect_DismissedAvatar2_3f7c3257-4d47-52fb-b526-41b6231a948b);
DB_GLO_Jergal_DismissedAvatarResurrectionFlags("CAMP_Jergal_DismissedAvatarToResurrect_3_78fa02c7-a3d4-4101-e2de-a5bd18d187fd", (FLAG)CAMP_Jergal_State_CanResurrect_DismissedAvatar3_414f6b9c-fe03-df96-3406-e38998cb97f3, (FLAG)CAMP_Jergal_Event_WillResurrect_DismissedAvatar3_73448a6b-1e44-0bde-36a3-fa40bc35acc4);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_DismissedAvatar(_)
THEN
SetFlag((FLAG)CAMP_Jergal_State_DismissedDeadAvatar_fbafc0bc-4292-4ac4-ab9d-44135d6db1ea,NULL_00000000-0000-0000-0000-000000000000,1);
//END_REGION

//REGION GUS-302977 Fix Double Genital Tags
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GenitalTagAdded(_Player)
AND
IsTagged(_Player,(TAG)GENITAL_PENIS_d27831df-2891-42e4-b615-ae555404918b,1)
AND
IsTagged(_Player,(TAG)GENITAL_VULVA_a0738fdf-ca0c-446f-a11d-6211ecac3291,1)
AND
NOT QRY_GenitalTagFix_HasPenis(_Player)
THEN
DB_BUGFIX_Marker("GUS-302977 Fix Double Genital Tags");
ClearTag(_Player,(TAG)GENITAL_PENIS_d27831df-2891-42e4-b615-ae555404918b);

QRY
QRY_GenitalTagFix_HasPenis((CHARACTER)_Player)
AND
HasAppearanceVisualTag(_Player,(TAG)GENITAL_PENIS_d27831df-2891-42e4-b615-ae555404918b,1)
THEN
DB_BUGFIX_Marker("GUS-302977 Fix Double Genital Tags");
ClearTag(_Player,(TAG)GENITAL_VULVA_a0738fdf-ca0c-446f-a11d-6211ecac3291);
//END_REGION


//REGION GUS-303683
//Clean up stuck dialogue databases.
PROC
PROC_ApplySavegamePatches()
AND
DB_DialogName(_Dialog,_Instance)
AND
NOT DialogGetCategory(_Instance,_)
THEN
DB_BUGFIX_Marker("GUS-303683 Clean up stuck dialogue databases",_Dialog,_Instance);
PROC_ClearDialogPlayers(_Instance);
PROC_ClearDialogNPCs(_Instance);
PROC_ClearDialogSpeakers(_Instance);
PROC_ClearDialogCounts(_Instance);
NOT DB_DialogName(_Dialog,_Instance);
NOT DB_DialogRequestFailed(_Dialog,_Instance);
NOT DB_DialogEnding(_Dialog,_Instance);

IF
DB_BUGFIX_Marker("DATABASE DEFINITION COMPILATION WARNING WORKAROUND",_Dialog,_Instance)
THEN
DB_NOOP(1);

//END_REGION

//REGION GUS-308416 Magic Mirror disable Examine
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_MagicMirrorInstance("WLD_Main_A",(ITEM)UNI_MagicMirror_ccb05ed5-ec6e-817c-1fa5-4e593c2fe4e2); //WLDMAIN
DB_MagicMirrorInstance("WLD_Main_A",(ITEM)UNI_MagicMirror_7b3ba493-0a68-89f7-4e94-0faa348f6d8e); //WLDBAS
DB_MagicMirrorInstance("WLD_Main_A",(ITEM)UNI_MagicMirror_786aa1c3-3bb9-8121-48a6-2a252ed9f803); //WLDDUNABB
DB_MagicMirrorInstance("WLD_Main_A",(ITEM)UNI_MagicMirror_5cf6a0fe-111f-84ee-26d9-9c44928c99d1); //WLDCAVGRN
DB_MagicMirrorInstance("WLD_Main_A",(ITEM)UNI_MagicMirror_2d6fe559-0884-8e75-3eeb-ec4aafa5ecbc); //WLDDUNSHA
DB_MagicMirrorInstance("WLD_Main_A",(ITEM)UNI_MagicMirror_8d873252-3477-89d4-4391-e666f3b5f717); //WLDCAVSND
DB_MagicMirrorInstance("WLD_Main_A",(ITEM)UNI_MagicMirror_1d103deb-970d-8387-32d6-fe9400ef3433); //WLDUND
DB_MagicMirrorInstance("CRE_Main_A",(ITEM)UNI_MagicMirror_e5d472fc-5003-82ae-4205-b403c4a1d64b); //CREMAIN
DB_MagicMirrorInstance("CRE_Main_A",(ITEM)UNI_MagicMirror_c003aaef-2958-84fb-3dc4-3dd75b367973); //CREINSIDE
DB_MagicMirrorInstance("SCL_Main_A",(ITEM)UNI_MagicMirror_d53821dd-a26c-8605-1ff3-cabc120a0c8d); //SCLMAIN
DB_MagicMirrorInstance("SCL_Main_A",(ITEM)UNI_MagicMirror_a7616c24-2dac-8ed3-3981-fa2bc8724c07); //HAVEN
DB_MagicMirrorInstance("SCL_Main_A",(ITEM)UNI_MagicMirror_1de869fb-df6a-862c-32dd-89625957c32a); //MOONRISE
DB_MagicMirrorInstance("SCL_Main_A",(ITEM)UNI_MagicMirror_84a1e50d-c5f1-8fc4-1516-44da610e7be1); //SHARTEMPLE
DB_MagicMirrorInstance("INT_Main_A",(ITEM)UNI_MagicMirror_6753b856-7d20-878f-1fb9-9caa68482511); //INTMAIN
DB_MagicMirrorInstance("BGO_Main_A",(ITEM)UNI_MagicMirror_39276c12-5fe7-8b96-2979-909017c727ec); //FARM
DB_MagicMirrorInstance("CTY_Main_A",(ITEM)UNI_MagicMirror_4a9e4ae1-d06e-828b-4915-b8505077412b); //SLUMS
DB_MagicMirrorInstance("CTY_Main_A",(ITEM)UNI_MagicMirror_6b020a57-7917-8e67-2dd1-884529b24645); //ELFSONG
//END_REGION

//REGION GUS-303762 (symptom fix)
PROC
PROC_ApplySavegamePatches()
AND
DB_AttemptingMutingStatuses(_Char,"SG_DropForNonMutingDialog_Dummy",NULL_00000000-0000-0000-0000-000000000000)
AND
HasAppliedStatusWithGroup(_Char,"SG_DropForNonMutingDialog",0)
THEN
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus(_Char,"SG_DropForNonMutingDialog_Dummy",NULL_00000000-0000-0000-0000-000000000000,"GUS-303108");

PROC
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus((GUIDSTRING)_Char,(STRING)_StatusName,(GUIDSTRING)_Cause,(STRING)_JIRA)
AND
DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Char,_Speaker2,_Speaker3,_Speaker4,_Speaker5,_Speaker6,_ShowAttackButton)
THEN
NOT DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Char,_Speaker2,_Speaker3,_Speaker4,_Speaker5,_Speaker6,_ShowAttackButton);
NOT DB_DialogStart_SpeakerReserved(_Char);
NOT DB_DialogStart_SpeakerReserved(_Speaker2);
NOT DB_DialogStart_SpeakerReserved(_Speaker3);
NOT DB_DialogStart_SpeakerReserved(_Speaker4);
NOT DB_DialogStart_SpeakerReserved(_Speaker5);
NOT DB_DialogStart_SpeakerReserved(_Speaker6);

PROC
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus((GUIDSTRING)_Char,(STRING)_StatusName,(GUIDSTRING)_Cause,(STRING)_JIRA)
AND
DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Char,_Speaker3,_Speaker4,_Speaker5,_Speaker6,_ShowAttackButton)
THEN
NOT DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Char,_Speaker3,_Speaker4,_Speaker5,_Speaker6,_ShowAttackButton);
NOT DB_DialogStart_SpeakerReserved(_Speaker1);
NOT DB_DialogStart_SpeakerReserved(_Char);
NOT DB_DialogStart_SpeakerReserved(_Speaker3);
NOT DB_DialogStart_SpeakerReserved(_Speaker4);
NOT DB_DialogStart_SpeakerReserved(_Speaker5);
NOT DB_DialogStart_SpeakerReserved(_Speaker6);


PROC
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus((GUIDSTRING)_Char,(STRING)_StatusName,(GUIDSTRING)_Cause,(STRING)_JIRA)
AND
DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Speaker2,_Char,_Speaker4,_Speaker5,_Speaker6,_ShowAttackButton)
THEN
NOT DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Speaker2,_Char,_Speaker4,_Speaker5,_Speaker6,_ShowAttackButton);
NOT DB_DialogStart_SpeakerReserved(_Speaker1);
NOT DB_DialogStart_SpeakerReserved(_Speaker2);
NOT DB_DialogStart_SpeakerReserved(_Char);
NOT DB_DialogStart_SpeakerReserved(_Speaker4);
NOT DB_DialogStart_SpeakerReserved(_Speaker5);
NOT DB_DialogStart_SpeakerReserved(_Speaker6);

PROC
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus((GUIDSTRING)_Char,(STRING)_StatusName,(GUIDSTRING)_Cause,(STRING)_JIRA)
AND
DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Speaker2,_Speaker3,_Char,_Speaker5,_Speaker6,_ShowAttackButton)
THEN
NOT DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Speaker2,_Speaker3,_Char,_Speaker5,_Speaker6,_ShowAttackButton);
NOT DB_DialogStart_SpeakerReserved(_Speaker1);
NOT DB_DialogStart_SpeakerReserved(_Speaker2);
NOT DB_DialogStart_SpeakerReserved(_Speaker3);
NOT DB_DialogStart_SpeakerReserved(_Char);
NOT DB_DialogStart_SpeakerReserved(_Speaker5);
NOT DB_DialogStart_SpeakerReserved(_Speaker6);

PROC
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus((GUIDSTRING)_Char,(STRING)_StatusName,(GUIDSTRING)_Cause,(STRING)_JIRA)
AND
DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Speaker2,_Speaker3,_Speaker4,_Char,_Speaker6,_ShowAttackButton)
THEN
NOT DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Speaker2,_Speaker3,_Speaker4,_Char,_Speaker6,_ShowAttackButton);
NOT DB_DialogStart_SpeakerReserved(_Speaker1);
NOT DB_DialogStart_SpeakerReserved(_Speaker2);
NOT DB_DialogStart_SpeakerReserved(_Speaker3);
NOT DB_DialogStart_SpeakerReserved(_Speaker4);
NOT DB_DialogStart_SpeakerReserved(_Char);
NOT DB_DialogStart_SpeakerReserved(_Speaker6);

PROC
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus((GUIDSTRING)_Char,(STRING)_StatusName,(GUIDSTRING)_Cause,(STRING)_JIRA)
AND
DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Speaker2,_Speaker3,_Speaker4,_Speaker5,_Char,_ShowAttackButton)
THEN
NOT DB_DialogStart_WaitingForDroppedMutingStatus(_Dialog,_Speaker1,_Speaker2,_Speaker3,_Speaker4,_Speaker5,_Char,_ShowAttackButton);
NOT DB_DialogStart_SpeakerReserved(_Speaker1);
NOT DB_DialogStart_SpeakerReserved(_Speaker2);
NOT DB_DialogStart_SpeakerReserved(_Speaker3);
NOT DB_DialogStart_SpeakerReserved(_Speaker4);
NOT DB_DialogStart_SpeakerReserved(_Speaker5);
NOT DB_DialogStart_SpeakerReserved(_Char);

PROC
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus((GUIDSTRING)_Char,(STRING)_StatusName,(GUIDSTRING)_Cause,(STRING)_JIRA)
AND
DB_DialogStart_WaitingForDroppedMutingStatus_Speaker(_Dialog,_Char)
THEN
DB_BUGFIX_Marker_DualGuid(_JIRA,(GUIDSTRING)_Char,(GUIDSTRING)_Dialog);
NOT DB_DialogStart_WaitingForDroppedMutingStatus_Speaker((DIALOGRESOURCE)_Dialog,_Char);

PROC
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus((GUIDSTRING)_Char,(STRING)_StatusName,(GUIDSTRING)_Cause,(STRING)_JIRA)
AND
DB_AttemptingMutingStatuses(_Char,_StatusName,_Cause)
THEN
NOT DB_AttemptingMutingStatuses(_Char,_StatusName,_Cause);
DB_BUGFIX_Marker(_JIRA,_Char);
//END_REGION

//REGION GUS-309507

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_DialogStart_SpeakerReserved((GUIDSTRING)_Speaker)
AND
NOT DB_DialogStart_WaitingForDroppedMutingStatus((DIALOGRESOURCE)_,(GUIDSTRING)_Speaker,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(INTEGER)_)
AND
NOT DB_DialogStart_WaitingForDroppedMutingStatus((DIALOGRESOURCE)_,(GUIDSTRING)_,(GUIDSTRING)_Speaker,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(INTEGER)_)
AND
NOT DB_DialogStart_WaitingForDroppedMutingStatus((DIALOGRESOURCE)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_Speaker,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(INTEGER)_)
AND
NOT DB_DialogStart_WaitingForDroppedMutingStatus((DIALOGRESOURCE)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_Speaker,(GUIDSTRING)_,(GUIDSTRING)_,(INTEGER)_)
AND
NOT DB_DialogStart_WaitingForDroppedMutingStatus((DIALOGRESOURCE)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_Speaker,(GUIDSTRING)_,(INTEGER)_)
AND
NOT DB_DialogStart_WaitingForDroppedMutingStatus((DIALOGRESOURCE)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_,(GUIDSTRING)_Speaker,(INTEGER)_)
THEN
NOT DB_DialogStart_SpeakerReserved(_Speaker);
DB_BUGFIX_Marker("GUS-309507",_Speaker);

//END_REGION GUS-309507

//REGION GUS-302212
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_AttemptingMutingStatuses(_Char,_Status,_Cause)
AND
Exists(_Char,0)
THEN
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus(_Char,_Status,_Cause,"GUS-302212");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_AttemptingMutingStatuses(_Char,_Status,_Cause)
AND
Exists(_Char,1)
AND
NOT HasAppliedStatus(_Char,_Status,1)
THEN
PROC_SavegamePatch_ClearStuckWaitingForDroppedMutingStatus(_Char,_Status,_Cause,"GUS-302212");
//END_REGION

//REGION GUS-302508
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
PROC_SavegamePatch_GUS302508_FixBrokenMounds();
DB_BUGFIX_Marker("GUS-302508");

PROC
PROC_SavegamePatch_GUS302508_FixBrokenMounds()
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act1(1);

IF
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act1(1)
AND
DB_CurrentLevel("WLD_Main_A")
THEN
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_DEN_BuriedChest_01_13b181e2-8eea-44ad-9d8f-6ea29773096e, 258.119, 32.343, 460.031);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_DEN_BuriedMound_01_97b15275-7065-492f-9713-9bffb776dbf8, 257.850, 32.301, 459.688);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_DEN_BuriedChest_03_9cfd06ac-15ef-41c1-a8cc-eedc33abb04d, -450.767, 7.581, -179.666);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_DEN_BuriedMound_03_5b26f9dc-202b-488c-959b-698df512fc69, -451.009, 7.725, -179.701);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_FOR_BuriedChest_01_d8f8eb6a-e3ce-4532-972c-4ee7a5a6deba, -2.921, 33.741, 481.076);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_FOR_BuriedMound_01_de4592c0-5fc1-4b85-9aa1-b1117fb6bc9c, -2.383, 33.935, 481.513);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_FOR_BuriedChest_02_668a1d68-e748-47d6-93fe-b9d24dc2c221, -45.527, 23.356, 402.633);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_FOR_BuriedMound_02_411f4bf1-ce8f-4b01-bb3f-b6a943e7f2f6, -45.528, 23.335, 402.424);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_FOR_BuriedChest_03_615ea955-cefe-45d5-8a95-e9e1da42a2df, 25.772, 15.732, 310.272);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_FOR_BuriedMound_03_09910e93-7960-4a26-a880-c4c9603e710b, 25.640, 15.708, 310.106);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_FOR_BuriedChest_04_35da276f-5641-412d-8b4b-a266fecf39d6, -358.689, 7.167, -102.581);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_FOR_BuriedMound_04_cf86f949-da4b-42f0-b480-c2a2f6db75eb, -359.037, 7.075, -102.403);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_PLA_BuriedChest_02_eac24ada-41ca-4e4f-9d14-8ba22f439349, 74.226, 26.876, 548.151);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_PLA_BuriedMound_02_92dfcc8f-ca3a-44c8-a5d0-4284b944d6d0, 74.139, 26.786, 548.149);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_PLA_BuriedChest_04_0d85e2f5-8552-4625-aa47-efbced850671, -74.811, 34.930, 539.923);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_PLA_BuriedMound_04_8bae8504-d8b0-4839-bfd4-3bcbd246d95c, -74.639, 34.840, 539.453);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_PLA_BuriedChest_05_7dc65fce-ecfb-4da7-b35e-8e85469fd955, 319.446, 5.722, -214.676);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_PLA_BuriedMound_05_39a0b4d4-9d5e-45e0-b4ce-3f3dfcf323c9, 319.833, 5.473, -214.314);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_GOB_BuriedChest_02_a276d029-79fe-405a-8687-ae04841c0acb, -135.723, 15.427, 425.393);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_GOB_BuriedMound_02_051d672e-3f83-4216-8b01-467e4d247f84, -135.778, 15.330, 425.380);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_GOB_BuriedChest_03_d1514d12-e841-44b7-9344-d1ef4dbb4149, -75.259, 4.877, 401.493);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_GOB_BuriedMound_03_94a1e35c-3583-488c-a2ed-6c95716fd8b9, -75.268, 4.796, 401.223);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_HAG_BuriedChest_02_4cf9ba95-47cf-4c9c-808d-aa896f9c260a, 90.575, 0.733, 281.489);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_HAG_BuriedMound_02_905fa10e-69a5-45b5-b52b-d660b6137104, 90.200, 0.649, 281.561);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_UND_BuriedChest_03_603e0c53-d27c-48fa-a974-4609638cf07a, 106.552, 46.300, -224.749);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_UND_BuriedMound_03_8b85a118-451b-4dc5-b3fe-0215e3aaa746, 106.486, 46.220, -225.022);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_UND_BuriedChest_06_3f605d49-8f2e-4678-bbfc-8064a178876e, -40.337, 25.403, -205.251);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_UND_BuriedMound_06_f65bf660-f8cd-4bc1-8653-f03f4b068b3e, -40.270, 25.295, -205.431);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_UND_BuriedChest_07_304f9e5b-a658-4787-b085-a4d8527fa934, 138.052, 48.820, -121.199);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_UND_BuriedMound_07_d020b6ec-cf45-491e-8e45-93c556700288, 137.741, 48.652, -121.140);
NOT DB_SavegamePatch_GUS302508_FixBrokenMounds_Act1(1);

PROC
PROC_SavegamePatch_GUS302508_FixBrokenMounds()
AND
DB_LevelLoadedOnce("CRE_Main_A")
AND
NOT DB_LevelUnreachable("CRE_Main_A")
THEN
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act1b(1);

IF
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act1b(1)
AND
DB_CurrentLevel("CRE_Main_A")
THEN
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_CRE_BuriedChest_01_9dc16fc4-9f80-448f-ad43-74c6a9ffb5a0, -118.397, 57.834, -134.234);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_CRE_BuriedMound_01_ebfd3008-856c-4573-b2c4-4fd8560fbbcc, -118.444, 57.809, -134.275);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_CRE_BuriedChest_04_d8e9d8d1-065d-4b63-887d-0b753f5169f1, 78.578, 24.545, 86.44);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_CRE_BuriedMound_04_08a623c4-6a2f-4d17-8271-948f3352cee0, 78.654, 24.303, 86.223);
NOT DB_SavegamePatch_GUS302508_FixBrokenMounds_Act1b(1);

PROC
PROC_SavegamePatch_GUS302508_FixBrokenMounds()
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act2(1);

IF
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act2(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_SCL_BuriedChest_01_3c663b7c-8442-415f-a656-240dcc77506b, 83.309, 50.300, 121.845);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_SCL_BuriedMound_01_d0258839-416c-48e8-b801-5051b3f630c1, 82.816, 50.323, 121.839);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_SCL_BattlefieldDigChest_01_a261d11a-fbd1-4e87-82b9-52f75c593b40, 41.94, 44.913, 1.539);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_SCL_BattlefieldDigMound_01_8f04d2aa-69a2-466c-822f-c7db9a37a8ae, 41.825, 44.856, 1.583);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_SCL_BuriedChest_02_efc19d43-1cb4-4cfd-881f-b63fa8c9a9de, 135.78, 60.581, 182.251);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_SCL_BuriedMound_02_fb8b1461-4821-40d3-bb29-60cb75aece50, 135.723, 60.577, 182.022);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_SCL_BuriedChest_04_8d6c3f7c-7d33-4aeb-9e44-1b049cfe23cf, 92.551, 50.625, -100.496);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_SCL_BuriedMound_04_001c7f19-1621-4e55-862a-f6497ca826a2, 92.609, 50.613, -100.678);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_SCL_BuriedChest_05_b7c63931-0d42-4a98-99b5-aaf8f2aed49b, -2.726, 30.688, -58.279);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_SCL_BuriedMound_05_7f019506-a748-441e-a3a0-a20dac52c197, -2.266, 30.823, -58.047);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_TWN_BuriedChest_01_46a098e7-157f-4515-8f07-8dcc8d68d914, -237.721, 21.073, -86.007);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_TWN_BuriedMound_01_5f7e506e-ecfc-4029-90b0-47558e24ef99, -237.765, 21.036, -86.128);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_TWN_BuriedChest_02_e49fff27-1978-464d-ad23-54cbb40c859a, -169.769, 39.545, 99.112);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_TWN_BuriedMound_02_84dce2aa-48e3-4263-bd62-40c354098cf9, -170.0, 39.468, 99.07);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_TWN_BuriedChest_03_c4a856c3-486e-4fba-aeb3-5a1603632e2f, -256.92, 35.619, 25.972);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_TWN_BuriedMound_03_0f48dd86-a8ff-4a0e-809e-e33dbf029896, -257.12, 35.53, 26.175);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_TWN_BuriedChest_04_6dd2d7a8-192b-4f06-908a-484b41c7f0a4, -183.909, 18.755, -51.546);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_TWN_BuriedMound_04_32dfbb28-1622-47e8-9cab-3a1d38e35a26, -183.709, 18.749, -51.601);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_TWN_BuriedChest_05_1fe35865-d370-4237-855a-c49da0906f1e, -159.187, 11.711, -113.906);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_TWN_BuriedMound_05_458b43a5-2139-46c6-a807-b38f0e975809, -159.409, 11.702, -113.639);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_TWN_BuriedChest_06_a96c1cff-8a05-4d06-8153-6ce154ea5435, -31.203, 17.796, -96.981);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_TWN_BuriedMound_06_74e9d735-f158-4dd9-9069-e87ae49e864e, -31.19, 17.722, -97.075);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_TWN_BuriedChest_07_9325b281-a1b9-425e-a90c-f6a243759330, -265.869, 33.391, 14.667);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_TWN_BuriedMound_07_177a292d-0ea6-44be-9b76-ecc1d2877f14, -266.027, 33.337, 14.466);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_HAV_BuriedChest_01_443a6dbe-e60f-44f9-b359-6eb3e615ad62, 25.49, 21.591, 168.999);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_HAV_BuriedMound_01_f6520599-f20e-4093-822d-e751ae1c2f0a, 25.542, 21.482, 169.057);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_HAV_BuriedChest_02_c7ec6825-b72c-4052-bf1f-474b3e75d2f8, -55.958, 18.634, 202.002);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_HAV_BuriedMound_02_5d787cf5-522c-4358-93c2-ec8926658941, -55.987, 18.438, 201.727);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_HAV_BuriedChest_03_507e31b1-4cac-49cd-be15-8a049dd879b3, -62.587, 23.19, 170.895);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_HAV_BuriedMound_03_da715010-b1fb-4dc0-8499-4f497a67ff13, -62.414, 23.123, 170.578);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_HAV_BuriedChest_04_34e9a11a-e5ad-4b06-a0d4-dd8ce5135b7f, 25.550, -2.452, -726.902);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_HAV_BuriedMound_04_1f9e8e65-ef3d-4a59-8ef9-5192429c84fa, 25.495, -2.476, -726.982);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_SHA_BuriedChest_01_40edd247-d65a-42f4-af01-cc70d4740704, -260.024, -31.357, -864.292);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_SHA_BuriedMound_01_c88f62ac-13ee-4a94-8893-5c5cdb453b8c, -260.165, -31.441, -864.203);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_SHA_BuriedChest_02_4f6af1ca-f73e-4d07-bf52-79faa62bb99e, -273.039, -31.355, -818.167);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_SHA_BuriedMound_02_b89de03f-e325-45ec-a0fd-6ac8e64a9a1d, -272.77, -31.315, -818.089);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_MOO_BuriedChest_01_8c63026c-236b-4e40-ab68-a7bb29469bc5, 552.748, 23.05, -623.445);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_MOO_BuriedMound_01_bd1df26a-7a1e-4a1b-8c01-85259a04979f, 552.704, 22.965, -623.467);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_MOO_BuriedChest_02_b2c03e1e-ead4-457c-b1a8-d68ac6f919e7, 585.505, 23.329, -587.802);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_MOO_BuriedMound_02_635e4ec7-0bd1-4c6f-847f-9c1500d62efb, 585.479, 23.267, -587.626);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_MOO_BuriedChest_03_88d9919f-9f56-43c0-a556-c144cab2c995, 517.405, 22.632, -610.14);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_MOO_BuriedMound_03_02bc8586-fbfb-4b64-bc54-0cbf07fff6a2, 517.963, 22.66, -610.465);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_MOO_BuriedChest_04_af9e7774-3be2-4e2e-9919-5ad7978a4dcf, 664.533, 31.698, -115.961);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_MOO_BuriedMound_04_bd503424-e9cb-436b-af5c-255bd40945cd, 664.258, 31.705, -116.418);
NOT DB_SavegamePatch_GUS302508_FixBrokenMounds_Act2(1);

PROC
PROC_SavegamePatch_GUS302508_FixBrokenMounds()
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
THEN
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act3(1);

IF
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act3(1)
AND
DB_CurrentLevel("BGO_Main_A")
THEN
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_02_48cf3b49-2506-4c51-bae5-2fe99e410dcf, -80.891, -0.108, 201.039);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_02_a2b0e7d1-f688-40a8-b67a-ddc922934d2e, -80.813, -0.159, 201.2);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_01_e103309e-14c9-423b-9dd9-faa070bc2dd4, -27.186, 45.373, -29.956);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_01_5c94b467-e56f-4627-832a-494baa8f8d35, -27.257, 45.395, -30.407);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_03_f3993122-b413-4337-a767-dd51f3226ed4, 66.779, 1.374, 89.134);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_03_6379ded3-5479-4898-a866-152582b73228, 66.696, 1.363, 88.772);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_04_4e050169-ee4e-4a69-968b-e137e6bae73a, 46.477, 2.353, 82.745);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_04_e1c537ac-fc65-4cf8-b3f1-cb2ff9e90b23, 46.352, 2.325, 82.405);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_05_f39ee735-4a2d-41af-97ce-27666a73171d, 42.113, 15.768, -877.648);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_05_6538fca2-705c-4241-b27f-3ad18a7587f4, 41.927, 15.721, -877.847);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_06_6e3343e1-4fa8-478d-a4c2-f0c897afdd2d, 95.727, 54.894, -37.147);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_06_d5811f26-5556-4875-b15a-008e728b10ce, 96.121, 54.906, -37.154);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_07_c269c8d8-183b-47f1-8381-bca653c46939, -55.163, 12.858, 63.844);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_07_de85d4d2-94e0-4927-b9aa-a7d4161ce74d, -55.24, 12.813, 63.631);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_10_05af945f-580d-49c2-af61-dec0e5d772fe, 32.629, 51.488, -138.274);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_10_9ffaa713-965b-4a43-890a-4c34d33fd527, 32.486, 51.402, -138.596);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_11_0d14701c-dbdb-4644-8739-e1aa8168c694, -44.894, 42.521, 14.407);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_11_51d86c93-cf69-44f4-afb0-c958d4e91efc, -45.428, 42.55, 13.81);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_WYR_BuriedChest_12_28ad0189-f57e-42cf-b923-544212e0ba47, 36.163, 52.612, -149.923);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_WYR_BuriedMound_12_edd0f76b-d47e-46c9-a7df-a7c6c5b3fc14, 36.021, 52.508, -150.077);
NOT DB_SavegamePatch_GUS302508_FixBrokenMounds_Act3(1);

PROC
PROC_SavegamePatch_GUS302508_FixBrokenMounds()
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act3b(1);

IF
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act3b(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_02_a4479b36-29ab-4c76-b9de-3ac7ec7e05ac, -34.392, 0.83, -163.681);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_02_9729da90-e71b-4a23-a8ab-00f68274ea67, -34.28, 0.585, -163.621);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_01_c336d1f9-bd24-4486-b06b-31d61d4a43ce, -166.369, 28.709, 7.099);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_01_d90dec55-c0e4-4334-903c-0c52701ad0dd, -166.744, 28.495, 7.031);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_03_2797f4fa-b8dc-40a3-b2a1-fbdcece6d56f, 30.073, 1.619, -166.103);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_03_0091c8d2-1318-457d-8726-96cf3b868537, 29.914, 1.189, -166.252);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_04_1b1d35ef-3898-4dba-907e-55aba341e9c0, -126.9, 17.444, 771.848);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_04_9b661211-5e2d-462d-b720-5f10f769fe19, -127.119, 17.335, 771.743);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_05_cd755a48-91a5-4dc2-923b-45327b327cc3, -2355.594, 2.893, -146.79);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_05_cd452fe0-5f91-4bc9-bcc7-7e9ca2f6d8b6, -2355.872, 2.821, -146.716);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_06_15bb0e46-0e11-46d4-9fc1-c847842e0d0c, 24.393, 8.156, -167.23);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_06_29f00296-1ffa-41ba-aa08-22dfd525d081, 24.162, 7.793, -167.209);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_07_5182f231-b07e-49ce-8089-153bd7ee99aa, -143.898, 21.925, -83.056);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_07_7726f589-3ae9-41ac-9d85-c03e23f47df6, -143.643, 21.603, -82.95);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_08_fade0365-5986-424f-848a-af469b6ae07c, -244.477, 1.547, -276.567);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_08_64b5ca83-a9e7-46b6-ad32-3f158ba1ab5f, -244.525, 1.514, -276.549);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_09_8f255f0c-ee68-476d-aeba-e648e0b1ed72, -243.247, 25.055, -30.594);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_09_6a7e9493-4b9e-45d6-9618-25490569fd27, -243.243, 25.013, -30.531);
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_LOW_BuriedChest_10_ec4ab559-eb9f-46d2-8385-58d9cee372b8, -130.919, 31.05, -20.029);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_LOW_BuriedMound_10_984069f5-10cd-4b25-8d01-c5b9cb6c16a7, -130.919, 30.853, -20.029);
NOT DB_SavegamePatch_GUS302508_FixBrokenMounds_Act3b(1);

PROC
PROC_SavegamePatch_GUS302508_FixBrokenMound((ITEM)_Mound, (REAL)_X, (REAL)_Y, (REAL)_Z)
AND
DB_ShovelArea(_Mound, _) // Only teleport if mound was not discovered yet
THEN
TeleportToPosition(_Mound, _X, _Y, _Z, "", 0, 0, 0, 0, 0);

PROC
PROC_SavegamePatch_GUS302508_FixBrokenChest((ITEM)_Item, (REAL)_X, (REAL)_Y, (REAL)_Z)
AND
DB_ShovelArea(_, _Item) // Only teleport if item was not discovered yet
THEN
TeleportToPosition(_Item, _X, _Y, _Z, "", 0, 0, 0, 0, 0);
//END_REGION

//REGION GUS-303355
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
NOT QRY_State_IsBeforeState(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "DEN", "DEN_State_AttackOnDen")
AND
IsImmortal((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1)
THEN
DB_BUGFIX_Marker("GUS-303355");
SetImmortal((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0);
//END_REGION

//REGION GUS-299517
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
THEN
DB_BUGFIX_Marker("GUS-299517");
DB_GLO_GlobalItems_FacePaints("WYR_FACEPAINT_CLOWN", "84be66ac-53ae-4243-9436-aca6c8d8de32");
DB_GLO_GlobalItems_FacePaints("GLO_PIXIECURSE", "bcd624e2-8347-4f97-a7ec-5fd52a6b49e4");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
DB_GLO_GlobalItems_FacePaintApplied(_Char)
THEN
NOT DB_GLO_GlobalItems_FacePaintApplied(_Char);
DB_GLO_GlobalItems_FacePaintApplied((CHARACTER)_Char, "WYR_FACEPAINT_CLOWN", "84be66ac-53ae-4243-9436-aca6c8d8de32");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
DB_PartOfTheTeam(_Char)
AND
HasAppliedStatus(_Char, "GLO_PIXIECURSE", 1)
THEN
PROC_GLO_GlobalItems_ApplyFacePaint(_Char, "GLO_PIXIECURSE");
//END_REGION GUS-299517

//REGION GUS-303191
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_QuestDef_State((FLAG)SCE_GnomeFollowUp_State_PlayerInvitedToIronhandHideout_e2546bb4-5ec6-40db-aef4-5c4680cf3c9c, "LOW_Foundry", "HadAct2Epilogue")
THEN
DB_QuestDef_State((FLAG)SCE_GnomeFollowUp_State_PlayerInvitedToIronhandHideout_e2546bb4-5ec6-40db-aef4-5c4680cf3c9c, "LOW_Foundry", "HadAct2Epilogue");
DB_BUGFIX_Marker("GUS-303191");

//END_REGION

//REGION GUS-304028
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_BUGFIX_Marker("GUS-304028");
PROC_ORI_Minthara_ClearWeaponActionBlock();

PROC
PROC_ORI_Minthara_ClearWeaponActionBlock()
AND
NOT QRY_State_IsBeforeState(S_DEN_RangerDen_SUB_50062397-bf9c-4765-9cbc-e40b5148f211, "DEN", "DEN_State_AttackOnDen")
AND
IsTagged(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TAG)AI_BLOCKWEAPONACTIONS_53c3304c-032d-4c49-86df-00b3b03a6b13, 1)
THEN
ClearTag(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TAG)AI_BLOCKWEAPONACTIONS_53c3304c-032d-4c49-86df-00b3b03a6b13);

PROC
PROC_ORI_Minthara_ClearWeaponActionBlock()
AND
QRY_MOO_IsInMOO((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
ClearTag(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TAG)AI_BLOCKWEAPONACTIONS_53c3304c-032d-4c49-86df-00b3b03a6b13);

PROC
PROC_ORI_Minthara_ClearWeaponActionBlock()
AND
DB_PartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
ClearTag(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (TAG)AI_BLOCKWEAPONACTIONS_53c3304c-032d-4c49-86df-00b3b03a6b13);

//END_REGION

//REGION GUS-302197
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("END_Main")
AND
DB_END_AllyAbilities_Summons(_, _, (CHARACTER)_Summon, _)
THEN
SetFaction(_Summon, (FACTION)ACT3_END_AllyAbilities_Summon_ab4018cf-9f02-48aa-9c52-469b279c651a);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_BUGFIX_Marker("GUS-302197");
SetRelation((FACTION)ACT3_END_AllyAbilities_Summon_ab4018cf-9f02-48aa-9c52-469b279c651a, (FACTION)ACT3_END_ffa63e8c-5ca2-4897-a698-5f68189c7ccb, 50);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
DB_END_AllyAbilities_Summons(_, _, (CHARACTER)_Summon, _)
AND
DB_Is_InCombat(_Summon, _ID)
AND
DB_Players(_Player)
AND
QRY_IsEnemy(_Summon, _Player)
THEN
LeaveCombat(_Summon);
//END_REGION

//REGION GUS-302103
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_BUGFIX_Marker("GUS-302103");
PROC_END_AllyAbilities_PatchEnterCombat();

PROC
PROC_END_AllyAbilities_PatchEnterCombat()
AND
DB_GlobalFlag((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
DB_Players((CHARACTER)_Player)
AND
DB_Is_InCombat(_Player, _CombatGUID)
AND
DB_END_AllyAbilities_Summons(_, (STRING)_InterdictingStatus, _Summon, _)
AND
HasActiveStatus(_Player, _InterdictingStatus, 1)
AND
DB_Is_InCombat(_Enemy, _CombatGUID)
AND
NOT DB_END_AllyAbilities_Summons(_, _, (CHARACTER)_Enemy, _)
AND
NOT DB_END_AllyAbilities_SummonFixed(_Summon)
AND
QRY_IsEnemy(_Enemy, _Player)
AND
GetCombatGroupID(_Enemy, _CombatGroupID)
AND
NOT DB_END_AllyAbilities_SummonFixed(_Summon)
THEN
DB_END_AllyAbilities_SummonFixed(_Summon);
SetCombatGroupAndEnterCombat(_Summon, _CombatGroupID, _Enemy);

PROC
PROC_END_AllyAbilities_PatchEnterCombat()
AND
DB_END_AllyAbilities_SummonFixed(_Summon)
THEN
NOT DB_END_AllyAbilities_SummonFixed(_Summon);
//END_REGION

//REGION GUS-303621
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_END_AllyAbilities_Abilities(_Flag, _, _, _)
AND
DB_GlobalFlag(_Flag)
AND
_Flag != END_VossEncounter_Event_GithReinforcementsAwarded_b5147ee9-ec6e-461e-8849-7d9af26c3d54
AND
QRY_OnlyOnce("END_GatherYourAllies_UnregisterGYATrigger")
THEN
DB_BUGFIX_Marker("GUS-303621");
PROC_TriggerUnregisterForParty((TRIGGER)S_END_PartyMemberTeleport_b8d5ff34-ccc2-425c-a712-172497273dc0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Players(_Player)
AND
GetFlag((FLAG)END_GatherYourAllies_State_BeyondHirelings_7b3f93f8-274d-4803-a9bc-5023590c91c4, _Player, 1)
AND
QRY_OnlyOnce("END_GatherYourAllies_TriggerUnregistered")
THEN
DB_BUGFIX_Marker("GUS-303621");
PROC_TriggerUnregisterForParty((TRIGGER)S_END_PartyMemberTeleport_b8d5ff34-ccc2-425c-a712-172497273dc0);
//END_REGION

//REGION GUS-303357

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_PermaDefeated(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
DB_PermaDefeatedFlag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, GLO_Prodigy_State_PermaDefeated_d9ddfe5f-6658-4c63-bacc-bbcd50940c21);
DB_BUGFIX_Marker("GUS-303357");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_PermaDefeated(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
SetFlag(GLO_Prodigy_State_PermaDefeated_d9ddfe5f-6658-4c63-bacc-bbcd50940c21, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_BUGFIX_Marker("GUS-303357");

//END_REGION

//REGION GUS-303066

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_LevelLoadedOnce("EPI_Main_A")
AND
GetFlag(GLO_InfernalBox_State_BoxBoundedTo_f4d2be66-0443-4069-8ca2-570143f17e27, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
AND
Exists(S_GLO_PuzzleBox_326324f9-0920-8f0f-3e85-3781fbf48282,1)
THEN
ToInventory(S_GLO_PuzzleBox_326324f9-0920-8f0f-3e85-3781fbf48282, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_BUGFIX_Marker("GUS-303066");

//END_REGION GUS-303066

//REGION GUS-304060
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_GlobalFlag((FLAG)GOB_CapturedGoblin_State_AtDrow_0ed79536-5635-2538-8a2e-240a4778b1d6)
THEN
ClearFlag(GOB_CapturedGoblin_State_AtDrow_0ed79536-5635-2538-8a2e-240a4778b1d6);
DB_BUGFIX_Marker("GUS-304060");
//END_REGION

//REGION GUS-304022
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Players(_Player)
AND
GetFlag((FLAG)UND_MyconidCircle_SovereignOfferedSpores_593897e0-3322-4dd3-d70d-2f92e1e6db3d, _Player, 1)
THEN
DB_BUGFIX_Marker("GUS-304022");
TemplateAddTo((ITEMROOT)ALCH_Solution_Grenade_SporesHaste_6008231b-9f5a-44f6-8050-14586b7626fd,_Player,2,0);
//END_REGION

//REGION GUS-304230, GUS-304116
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_BUGFIX_Marker("GUS-304230");
DB_BUGFIX_Marker("GUS-304116");
PROC_ResetPlayerFactionRelationToParentFaction();

PROC
PROC_ResetPlayerFactionRelationToParentFaction()
AND
DB_AvatarFactions(_Faction)
THEN
PROC_ResetRelationMutual(_Faction, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360);

PROC
PROC_ResetPlayerFactionRelationToParentFaction()
AND
DB_Hirelings_Factions(_Faction)
THEN
PROC_ResetRelationMutual(_Faction, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360);

PROC
PROC_ResetPlayerFactionRelationToParentFaction()
AND
DB_CompanionFactions(_Faction)
THEN
PROC_ResetRelationMutual(_Faction, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360);
//END_REGION

//REGION GUS-303988
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
DB_CRIME_Casting(_AnyCaster,_AnyStoryActionID)
THEN
// No sysclear, we still want added/removed events for this DB as it's still used
NOT DB_CRIME_Casting(_AnyCaster,_AnyStoryActionID);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
THEN
SysClear("DB_UND_MyconidCircle_ToxicWall_SpellActionID",2);
SysClear("DB_LOW_OskarsBeloved_FirstPlayerTargetedInRoom",2);
SysClear("DB_LOW_PhilgravesMansion_SpellOnLairTrigger",2);
SysClear("DB_CMB_FrogReflectiveMucus_SpellActionID",2);
//END_REGION

//REGION GUS-303022
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_RelationChangingToHostile(_Faction1, _Faction2)
AND
GUIDToString(_Faction1, _Faction1String)
AND
GUIDToString(_Faction2, _Faction2String)
AND
Concatenate(_Faction1String, "_CheckHostileChangingTimer_", _Out)
AND
Concatenate(_Out, _Faction2String, _Timer)
THEN
DB_BUGFIX_Marker("GUS-303022");
DB_SavegamePatch_GUS303022(_Faction1, _Faction2, _Timer);
TimerLaunch(_Timer, 1000);

IF
TimerFinished(_Timer)
AND
DB_SavegamePatch_GUS303022(_Faction1, _Faction2, _Timer)
THEN
NOT DB_SavegamePatch_GUS303022(_Faction1, _Faction2, _Timer);
NOT DB_RelationChangingToHostile(_Faction1, _Faction2);	//If that DB is still filled when the timer expires, it means it's stuck

//END_REGION

//REGION GUS-293926

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_PartyMembers(_PartyMember)
AND
NOT QRY_SavegamePatch_GUS293926_HasShapeshiftDisturbance(_PartyMember)
THEN
CharacterStopCrime(_PartyMember, "DangerousMonsterReaction_Beast", NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_PartyMember, "DangerousMonsterReaction_Beast_Spider", NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_PartyMember, "DangerousMonsterReaction", NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_PartyMember, "DangerousMonsterReactionFallback_Beast", NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_PartyMember, "DangerousMonsterReactionFallback_Beast_Spider", NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_PartyMember, "DangerousMonsterReactionFallback", NULL_00000000-0000-0000-0000-000000000000);
CharacterStopCrime(_PartyMember, "ShapeshiftIntDev", NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_SavegamePatch_GUS293926_HasShapeshiftDisturbance((CHARACTER)_Character)
AND
DB_CRIME_ShapeshiftDisturbance(_Tag, _, _, _)
AND
IsTagged(_Character, _Tag, 1)
THEN
DB_NOOP(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-293926");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)BEAR_298e9df0-bd3c-40f4-82ae-14adb77d7c2e, "DangerousMonsterReaction_Beast", "DangerousMonsterReactionFallback_Beast", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)WOLF_5f38a755-e386-4a3a-a145-d22c9d6bf6b7, "DangerousMonsterReaction_Beast", "DangerousMonsterReactionFallback_Beast", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)BADGER_c00895b9-7d92-4848-af0b-477a231e00f5, "DangerousMonsterReaction_Beast", "DangerousMonsterReactionFallback_Beast", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)SPIDER_8c8932c5-45f7-4d45-8f62-182db82ddcb0, "DangerousMonsterReaction_Beast_Spider", "DangerousMonsterReactionFallback_Beast_Spider", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)DEEPROTHE_bba2bcc8-eb3c-435d-97dd-f522ec43ee67, "DangerousMonsterReaction_Beast", "DangerousMonsterReactionFallback_Beast", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)DINOSAUR_c485baa6-d363-462b-856d-d946b60aab61, "DangerousMonsterReaction_Beast", "DangerousMonsterReactionFallback_Beast", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)BOAR_aa120bba-b749-4b54-8457-62ceae41688c, "DangerousMonsterReaction_Beast", "DangerousMonsterReactionFallback_Beast", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)PANTHER_e1ad9942-fa0e-467b-bfe9-c6e7c6680a83, "DangerousMonsterReaction_Beast", "DangerousMonsterReactionFallback_Beast", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)SABERTOOTH_83485d43-2f1a-4916-b428-ab3f37aafedf, "DangerousMonsterReaction_Beast", "DangerousMonsterReactionFallback_Beast", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)OWLBEAR_70913187-25ac-4301-9c12-16baf3634c65, "DangerousMonsterReaction_Beast", "DangerousMonsterReactionFallback_Beast", "DangerousBeast");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)ELEMENTAL_196351e2-ff25-4e2b-8560-222ac6b94a54, "DangerousMonsterReaction", "DangerousMonsterReactionFallback", "DangerousMonster");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)UNDEAD_33c625aa-6982-4c27-904f-e47029a9b140, "DangerousMonsterReaction", "DangerousMonsterReactionFallback", "DangerousMonster");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)SLAYER_ff6e2e2e-198c-40e3-ae79-4499c5a59eea, "DangerousMonsterReaction", "DangerousMonsterReactionFallback", "DangerousMonster");
NOT DB_CRIME_DangerousShapeshiftTypes("IntDevHostile");
NOT DB_CRIME_ShapeshiftDisturbance((TAG)INTELLECT_DEVOURER_69901347-23cb-4f60-abf3-527f23cdf0db, "ShapeshiftIntDev", "", "IntDevHostile");

//END_REGION

//REGION GUS-303629
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 1")
THEN
PROC_GLO_303629_TryRestoreCompanion();

// Scenario 1: Already tried to res with Withers, in camp, while party was not full. Therefore they are in current party, but invisible since they are offstaged.
// Scenario 2: Already tried to res with Withers, in camp, while party currently full. Therefore they will be in camp, but just offstaged.
PROC
PROC_GLO_303629_TryRestoreCompanion()
AND
DB_CAMP_WalkingToCamp(_Player) // was in the process of returning to camp
AND
IsOnStage(_Player, 0) // was offstaged due to being pushed in chasm
AND
NOT DB_Dead(_Player) // should no longer be dead since Withers rezzed them
THEN
PROC_SetOnStage(_Player, 1);
SetHasDialog(_Player, 1); // have to restore this, since their death disabled it.
DB_BUGFIX_Marker("GUS-303629");

// Scenario 3: Dismissed, and pushed into chasm. But haven't tried to rez. Therefore they're just offstaged and dead.
// Set them back on stage, and clear their DB_CAMP_WalkingToCamp. So they can be rezzed normally by Withers.
// In theory the fix with Withers would also put them onstage, and this isn't necessary. But its to account for other possible ways players may try to rez them.
PROC
PROC_GLO_303629_TryRestoreCompanion()
AND
DB_CAMP_WalkingToCamp(_Player) // was in the process of returning to camp
AND
IsOnStage(_Player, 0) // was offstaged due to being pushed in chasm
AND
DB_Dead(_Player)
THEN
PROC_SetOnStage(_Player, 1);
NOT DB_CAMP_WalkingToCamp(_Player); // can clear this since they're no longer trying to return to camp.
DB_BUGFIX_Marker("GUS-303629");

//END_REGION

//REGION GUS-303232

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
DB_DialogStart_WaitingForDroppedMutingStatus_Speaker(_Dialog,_Speaker)
AND
HasAppliedStatusWithGroup(_Speaker, "SG_DropForNonMutingDialog", 1)
THEN
DB_BUGFIX_Marker("GUS-303232");
PROC_DialogStart_WaitingForDroppedMutingStatus_FallbackTimer(_Dialog, _Speaker);

//END_REGION

//REGION GUS-302491

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)UND_MonkAmulet_Event_OfferedQuest_1226f854-c4f6-af9f-6863-e7c3d013647f)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "UND_MonkAmulet", "FoundAmulet",1)
THEN
QuestUpdate((CHARACTER)_Player, "UND_MonkAmulet", "ToldAboutShirra");

//END_REGION

//REGION GUS-231074 Avatar Dismissal
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 3")
AND
DB_Avatars(_Avatar)
THEN
DB_BlockDismissable(_Avatar); //If this is incorrect, the DB rule will quickly unset it again but we need at least one set to trigger it.
//END_REGION

//REGION GUS-150499


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
DB_GLO_AvatarKickableFlags((FLAG)GLO_CompanionSwap_State_Avatar1ControlledByUser_e15a7358-59fa-1464-e443-d2f0c05be7b8,(FLAG)GLO_Avatar1_Event_Kick_0c8260f1-e574-498c-8967-7195738ca570, (FLAG)GLO_Avatar1_State_CanBeKicked_b8862a4a-3a57-4619-91da-baf103809026, "GLO_CompanionSwap_AvatarName1_938ab998-0908-f7de-0f9f-3d34dbf5808f");
DB_GLO_AvatarKickableFlags((FLAG)GLO_CompanionSwap_State_Avatar2ControlledByUser_f00c1231-0994-966f-93af-aafaec816838,(FLAG)GLO_Avatar2_Event_Kick_812fb4c0-ff19-4b79-a4d3-74ad534e901e, (FLAG)GLO_Avatar2_State_CanBeKicked_0d93a22f-cdc1-4642-bf72-1015c9d8c3d1, "GLO_CompanionSwap_AvatarName2_1cbefe6a-48c2-e77d-4a66-ab7524b61dbe");
DB_GLO_AvatarKickableFlags((FLAG)GLO_CompanionSwap_State_Avatar3ControlledByUser_3aa71922-adc8-9432-2315-3fe6f8b92943,(FLAG)GLO_Avatar3_Event_Kick_34c922d5-fd6f-40d4-91eb-59de831e92ea, (FLAG)GLO_Avatar3_State_CanBeKicked_97f72b05-aa49-47ff-9e31-aba0ecea7191, "GLO_CompanionSwap_AvatarName3_d8706512-5c01-67d4-db8b-6c383dc02331");
DB_GLO_AvatarKickableFlags((FLAG)GLO_CompanionSwap_State_Avatar4ControlledByUser_2c08aa4d-ce1f-41d7-a06d-30d48302c0a6,(FLAG)GLO_Avatar4_Event_Kick_34c4dd02-fcfb-4d5d-a486-bd6aea9a35f8, (FLAG)GLO_Avatar4_State_CanBeKicked_75ff445e-f072-446b-8352-2dc753653796, "GLO_CompanionSwap_AvatarName4_fc31b1ba-d511-0552-070f-b57b2b9e6bf7");
DB_GLO_CompanionSwapDialogue((DIALOGRESOURCE)GLO_CompanionSwap_Camp_002e501b-6f1b-8357-1fde-20b1b4b7c1b9);
DB_GLO_CompanionSwapDialogue((DIALOGRESOURCE)GLO_CompanionSwap_Hirelings_a22a9d2a-5164-741f-cb59-10551521c41a);
DB_GLO_CompanionSwapDialogue((DIALOGRESOURCE)GLO_CompanionSwap_Recruitment_f02d36d9-1f59-33ee-b87d-82f4c13c501f);

PROC
PROC_ApplySavegamePatches()
AND
NOT QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
THEN
PROC_GUS_318626_UpdateAvatarFlags();

//Only update unassigned slots, otherwise we'll reassign already-assigned (and already-removed) entries to newly-joining Avatars.
PROC
PROC_GUS_318626_UpdateAvatarFlags()
AND
DB_GLO_AvatarKickableFlags((FLAG)GLO_Avatar1_Event_Kick_0c8260f1-e574-498c-8967-7195738ca570, (FLAG)GLO_Avatar1_State_CanBeKicked_b8862a4a-3a57-4619-91da-baf103809026, "GLO_CompanionSwap_AvatarName1_938ab998-0908-f7de-0f9f-3d34dbf5808f")
THEN
DB_GLO_AvatarKickableFlags((FLAG)GLO_CompanionSwap_State_Avatar1ControlledByUser_e15a7358-59fa-1464-e443-d2f0c05be7b8,(FLAG)GLO_Avatar1_Event_Kick_0c8260f1-e574-498c-8967-7195738ca570, (FLAG)GLO_Avatar1_State_CanBeKicked_b8862a4a-3a57-4619-91da-baf103809026, "GLO_CompanionSwap_AvatarName1_938ab998-0908-f7de-0f9f-3d34dbf5808f");
NOT DB_GLO_AvatarKickableFlags((FLAG)GLO_Avatar1_Event_Kick_0c8260f1-e574-498c-8967-7195738ca570, (FLAG)GLO_Avatar1_State_CanBeKicked_b8862a4a-3a57-4619-91da-baf103809026, "GLO_CompanionSwap_AvatarName1_938ab998-0908-f7de-0f9f-3d34dbf5808f");
DB_BUGFIX_Marker("GUS_318626-1");

PROC
PROC_GUS_318626_UpdateAvatarFlags()
AND
DB_GLO_AvatarKickableFlags((FLAG)GLO_Avatar2_Event_Kick_812fb4c0-ff19-4b79-a4d3-74ad534e901e, (FLAG)GLO_Avatar2_State_CanBeKicked_0d93a22f-cdc1-4642-bf72-1015c9d8c3d1, "GLO_CompanionSwap_AvatarName2_1cbefe6a-48c2-e77d-4a66-ab7524b61dbe")
THEN
DB_GLO_AvatarKickableFlags((FLAG)GLO_CompanionSwap_State_Avatar2ControlledByUser_f00c1231-0994-966f-93af-aafaec816838,(FLAG)GLO_Avatar2_Event_Kick_812fb4c0-ff19-4b79-a4d3-74ad534e901e, (FLAG)GLO_Avatar2_State_CanBeKicked_0d93a22f-cdc1-4642-bf72-1015c9d8c3d1, "GLO_CompanionSwap_AvatarName2_1cbefe6a-48c2-e77d-4a66-ab7524b61dbe");
NOT DB_GLO_AvatarKickableFlags((FLAG)GLO_Avatar2_Event_Kick_812fb4c0-ff19-4b79-a4d3-74ad534e901e, (FLAG)GLO_Avatar2_State_CanBeKicked_0d93a22f-cdc1-4642-bf72-1015c9d8c3d1, "GLO_CompanionSwap_AvatarName2_1cbefe6a-48c2-e77d-4a66-ab7524b61dbe");
DB_BUGFIX_Marker("GUS_318626-2");

PROC
PROC_GUS_318626_UpdateAvatarFlags()
AND
DB_GLO_AvatarKickableFlags((FLAG)GLO_Avatar3_Event_Kick_34c922d5-fd6f-40d4-91eb-59de831e92ea, (FLAG)GLO_Avatar3_State_CanBeKicked_97f72b05-aa49-47ff-9e31-aba0ecea7191, "GLO_CompanionSwap_AvatarName3_d8706512-5c01-67d4-db8b-6c383dc02331")
THEN
DB_GLO_AvatarKickableFlags((FLAG)GLO_CompanionSwap_State_Avatar3ControlledByUser_3aa71922-adc8-9432-2315-3fe6f8b92943,(FLAG)GLO_Avatar3_Event_Kick_34c922d5-fd6f-40d4-91eb-59de831e92ea, (FLAG)GLO_Avatar3_State_CanBeKicked_97f72b05-aa49-47ff-9e31-aba0ecea7191, "GLO_CompanionSwap_AvatarName3_d8706512-5c01-67d4-db8b-6c383dc02331");
NOT DB_GLO_AvatarKickableFlags((FLAG)GLO_Avatar3_Event_Kick_34c922d5-fd6f-40d4-91eb-59de831e92ea, (FLAG)GLO_Avatar3_State_CanBeKicked_97f72b05-aa49-47ff-9e31-aba0ecea7191, "GLO_CompanionSwap_AvatarName3_d8706512-5c01-67d4-db8b-6c383dc02331");
DB_BUGFIX_Marker("GUS_318626-3");

PROC
PROC_GUS_318626_UpdateAvatarFlags()
AND
DB_GLO_AvatarKickableFlags((FLAG)GLO_Avatar4_Event_Kick_34c4dd02-fcfb-4d5d-a486-bd6aea9a35f8, (FLAG)GLO_Avatar4_State_CanBeKicked_75ff445e-f072-446b-8352-2dc753653796, "GLO_CompanionSwap_AvatarName4_fc31b1ba-d511-0552-070f-b57b2b9e6bf7")
THEN
DB_GLO_AvatarKickableFlags((FLAG)GLO_CompanionSwap_State_Avatar4ControlledByUser_2c08aa4d-ce1f-41d7-a06d-30d48302c0a6,(FLAG)GLO_Avatar4_Event_Kick_34c4dd02-fcfb-4d5d-a486-bd6aea9a35f8, (FLAG)GLO_Avatar4_State_CanBeKicked_75ff445e-f072-446b-8352-2dc753653796, "GLO_CompanionSwap_AvatarName4_fc31b1ba-d511-0552-070f-b57b2b9e6bf7");
NOT DB_GLO_AvatarKickableFlags((FLAG)GLO_Avatar4_Event_Kick_34c4dd02-fcfb-4d5d-a486-bd6aea9a35f8, (FLAG)GLO_Avatar4_State_CanBeKicked_75ff445e-f072-446b-8352-2dc753653796, "GLO_CompanionSwap_AvatarName4_fc31b1ba-d511-0552-070f-b57b2b9e6bf7");
DB_BUGFIX_Marker("GUS_318626-4");

PROC
PROC_GUS_318626_UpdateAvatarFlags()
AND
DB_GLO_AvatarKickableFlags_Assigned(_Avatar, GLO_Avatar1_Event_Kick_0c8260f1-e574-498c-8967-7195738ca570, (FLAG)GLO_Avatar1_State_CanBeKicked_b8862a4a-3a57-4619-91da-baf103809026, "GLO_CompanionSwap_AvatarName1_938ab998-0908-f7de-0f9f-3d34dbf5808f")
THEN
NOT DB_GLO_AvatarKickableFlags_Assigned(_Avatar, GLO_Avatar1_Event_Kick_0c8260f1-e574-498c-8967-7195738ca570, (FLAG)GLO_Avatar1_State_CanBeKicked_b8862a4a-3a57-4619-91da-baf103809026, "GLO_CompanionSwap_AvatarName1_938ab998-0908-f7de-0f9f-3d34dbf5808f");
DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_CompanionSwap_State_Avatar1ControlledByUser_e15a7358-59fa-1464-e443-d2f0c05be7b8, GLO_Avatar1_Event_Kick_0c8260f1-e574-498c-8967-7195738ca570, (FLAG)GLO_Avatar1_State_CanBeKicked_b8862a4a-3a57-4619-91da-baf103809026, "GLO_CompanionSwap_AvatarName1_938ab998-0908-f7de-0f9f-3d34dbf5808f");
DB_BUGFIX_Marker("GUS_318626-5");

PROC
PROC_GUS_318626_UpdateAvatarFlags()
AND
DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_Avatar2_Event_Kick_812fb4c0-ff19-4b79-a4d3-74ad534e901e, (FLAG)GLO_Avatar2_State_CanBeKicked_0d93a22f-cdc1-4642-bf72-1015c9d8c3d1, "GLO_CompanionSwap_AvatarName2_1cbefe6a-48c2-e77d-4a66-ab7524b61dbe")
THEN
NOT DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_Avatar2_Event_Kick_812fb4c0-ff19-4b79-a4d3-74ad534e901e, (FLAG)GLO_Avatar2_State_CanBeKicked_0d93a22f-cdc1-4642-bf72-1015c9d8c3d1, "GLO_CompanionSwap_AvatarName2_1cbefe6a-48c2-e77d-4a66-ab7524b61dbe");
DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_CompanionSwap_State_Avatar2ControlledByUser_f00c1231-0994-966f-93af-aafaec816838, (FLAG)GLO_Avatar2_Event_Kick_812fb4c0-ff19-4b79-a4d3-74ad534e901e, (FLAG)GLO_Avatar2_State_CanBeKicked_0d93a22f-cdc1-4642-bf72-1015c9d8c3d1, "GLO_CompanionSwap_AvatarName2_1cbefe6a-48c2-e77d-4a66-ab7524b61dbe");
DB_BUGFIX_Marker("GUS_318626-6");

PROC
PROC_GUS_318626_UpdateAvatarFlags()
AND
DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_Avatar3_Event_Kick_34c922d5-fd6f-40d4-91eb-59de831e92ea, (FLAG)GLO_Avatar3_State_CanBeKicked_97f72b05-aa49-47ff-9e31-aba0ecea7191, "GLO_CompanionSwap_AvatarName3_d8706512-5c01-67d4-db8b-6c383dc02331")
THEN
NOT DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_Avatar3_Event_Kick_34c922d5-fd6f-40d4-91eb-59de831e92ea, (FLAG)GLO_Avatar3_State_CanBeKicked_97f72b05-aa49-47ff-9e31-aba0ecea7191, "GLO_CompanionSwap_AvatarName3_d8706512-5c01-67d4-db8b-6c383dc02331");
DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_CompanionSwap_State_Avatar3ControlledByUser_3aa71922-adc8-9432-2315-3fe6f8b92943, (FLAG)GLO_Avatar3_Event_Kick_34c922d5-fd6f-40d4-91eb-59de831e92ea, (FLAG)GLO_Avatar3_State_CanBeKicked_97f72b05-aa49-47ff-9e31-aba0ecea7191, "GLO_CompanionSwap_AvatarName3_d8706512-5c01-67d4-db8b-6c383dc02331");
DB_BUGFIX_Marker("GUS_318626-7");

PROC
PROC_GUS_318626_UpdateAvatarFlags()
AND
DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_Avatar4_Event_Kick_34c4dd02-fcfb-4d5d-a486-bd6aea9a35f8, (FLAG)GLO_Avatar4_State_CanBeKicked_75ff445e-f072-446b-8352-2dc753653796, "GLO_CompanionSwap_AvatarName4_fc31b1ba-d511-0552-070f-b57b2b9e6bf7")
THEN
NOT DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_Avatar4_Event_Kick_34c4dd02-fcfb-4d5d-a486-bd6aea9a35f8, (FLAG)GLO_Avatar4_State_CanBeKicked_75ff445e-f072-446b-8352-2dc753653796, "GLO_CompanionSwap_AvatarName4_fc31b1ba-d511-0552-070f-b57b2b9e6bf7");
DB_GLO_AvatarKickableFlags_Assigned(_Avatar, (FLAG)GLO_CompanionSwap_State_Avatar4ControlledByUser_2c08aa4d-ce1f-41d7-a06d-30d48302c0a6, (FLAG)GLO_Avatar4_Event_Kick_34c4dd02-fcfb-4d5d-a486-bd6aea9a35f8, (FLAG)GLO_Avatar4_State_CanBeKicked_75ff445e-f072-446b-8352-2dc753653796, "GLO_CompanionSwap_AvatarName4_fc31b1ba-d511-0552-070f-b57b2b9e6bf7");
DB_BUGFIX_Marker("GUS_318626-8");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_BlockDismissable(_Player)
AND
NOT DB_CantTalk(_Player)
THEN
NOT DB_BlockDismissable(_Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
DB_InDangerZone(_Player,_)
THEN
DB_BlockDismissable_IgnoreDialog(_Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
DB_PartyDialogSuppressed(_Player,_)
THEN
DB_BlockDismissable_IgnoreDialog(_Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
DB_FastTravelBlock_BlockedZone_StatusSet(_Player)
THEN
DB_BlockDismissable_IgnoreDialog(_Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
DB_Is_EngineBlock_Move(_Player)
THEN
DB_BlockDismissable_IgnoreDialog(_Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
DB_FastTravelBlock_Arrested_StatusSet(_Player)
THEN
DB_BlockDismissable_IgnoreDialog(_Player);

//FastTravelBlock_FugitiveInPrison
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
NOT DB_BlockDismissable_IgnoreDialog(_Player)
AND
DB_FastTravelBlock_FugitiveInPrison_StatusSet(_Player, _FugitiveStatus)
THEN
DB_BlockDismissable_IgnoreDialog(_Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
DB_CantTalk(_Player)
AND
NOT DB_BlockDismissable_IgnoreDialog(_Player)
THEN
DB_BlockDismissable(_Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_CantTalk_IgnoreDialogsCombat((GUIDSTRING)_Speaker)
THEN
DB_CantTalk_IgnoreDialogs((GUIDSTRING)_Speaker);
PROC_StateSet_CantTalk_IgnoreDialogs((GUIDSTRING)_Speaker);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Is_InCombat((GUIDSTRING)_Speaker, _)
THEN
DB_CantTalk_IgnoreDialogs((GUIDSTRING)_Speaker);
PROC_StateSet_CantTalk_IgnoreDialogs((GUIDSTRING)_Speaker);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
SetFlag(Hireling_State_AllowReplace_a8bffa48-dffb-4615-a318-cc2df8b8a551, NULL_00000000-0000-0000-0000-000000000000, 0, 1);

//END_REGION

//REGION GUS-289222, GUSX-13841

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
THEN
PROC_Achievements_BG3_Quest29_DefineMultiAttackSpells();
DB_BUGFIX_Marker("GUSX-13841_Quest29");

//END_REGION GUS-289222, GUSX-13841

//REGION GUS-304993
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Crime_CombatEndsInArrest(_CombatID)
AND
GUIDToString(_CombatID, _CombatString)
AND
Concatenate("Crime_Arrest_Fade_", _CombatString, _FadeEvent)
THEN
NOT DB_Crime_CombatEndsInArrest(_CombatID);
DB_Crime_CombatEndsInArrest(_CombatID, _FadeEvent);
DB_BUGFIX_Marker("GUS-304993");
//END_REGION

//REGION GUS-304083
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_PartOfTheTeam(_Follower)
AND
NOT DB_Avatars(_Follower)
AND
HasNoFollowFlag(_Follower, 1)
THEN
SetNoFollowFlag(_Follower, 0);
DB_BUGFIX_Marker("GUS-304083");
//END_REGION

//REGION GUS-302130
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_GlobalFlag((FLAG)GLO_GithCreche_State_EverEnteredBefore_3ebdfeaa-4e83-4878-90db-01adb9fdf629)
AND
DB_CanBeResurrected(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
SetTag(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
DB_BUGFIX_Marker("GUS-302130");
//END_REGION

//REGION Stuck AllowNewPlayers(0) (old call for what's now SetJoinBlock(JOINBLOCKTYPE.BlockAll))
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 3")
AND
NOT DB_Camp_NightMode(1)
AND
NOT DB_InDangerZone(_,"AstralPrism")
THEN
SetJoinBlock(JOINBLOCKTYPE.None);	
//END_REGION

//REGION GUS-303084
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
PROC_ApplySavegamePatches_GUS_303084();
DB_BUGFIX_Marker("GUS-303084");

PROC
PROC_ApplySavegamePatches_GUS_303084()
AND
NOT DB_OriginMayLeaveDialog((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (DIALOGRESOURCE)CAMP_Daisy1_CRD_Laezel_BeforeDream_1375618b-f1e6-7f74-4748-beabc24cdc96)
THEN
DB_OriginMayLeaveDialog((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (DIALOGRESOURCE)CAMP_Daisy1_CRD_Laezel_BeforeDream_1375618b-f1e6-7f74-4748-beabc24cdc96);

PROC
PROC_ApplySavegamePatches_GUS_303084()
AND
DB_GlobalFlag((FLAG)CAMP_LaezelBeforeDream_Event_AttackedLaezel_dffe4643-709e-ac8c-ad62-450db550ca61)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
AND
DB_Avatars(_Avatar)
AND
QRY_OnlyOnce("ORI_Laezel_FixLaezelBrokenStateAfter_BeforeDream")
THEN
PROC_GLO_PartyMembers_TransferStoryItems((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Avatar);
Die(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);

PROC
PROC_ApplySavegamePatches_GUS_303084()
AND
DB_GlobalFlag((FLAG)CAMP_LaezelBeforeDream_Event_LaezelKilledPlayer_83012c3a-bce6-fd00-f1c9-51dc86eb49da)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
AND
DB_Avatars(_Avatar)
AND
QRY_OnlyOnce("ORI_Laezel_FixLaezelBrokenStateAfter_BeforeDream")
THEN
PROC_GLO_PartyMembers_TransferInventoryToPlayer((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Avatar, ""); //In case some items got stuck in her and she was left behind in previous acts unable to be looted
Die(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);

PROC
PROC_ApplySavegamePatches_GUS_303084()
AND
DB_GlobalFlag((FLAG)CAMP_LaezelBeforeDream_Event_ExecuteLaezel_1a3d618c-b80e-78f2-d766-442f121ee540)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
AND
DB_Avatars(_Avatar)
AND
QRY_OnlyOnce("ORI_Laezel_FixLaezelBrokenStateAfter_BeforeDream")
THEN
PROC_GLO_PartyMembers_TransferInventoryToPlayer((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Avatar, ""); //In case some items got stuck in her and she was left behind in previous acts unable to be looted
Die(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
//END_REGION

//REGION GUS-302095
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CRIME_Guards_Called(_CrimeID,_InterrogationCrimeID,_Caller,_Guard,_Criminal,_InterrogationType,_Region,_X,_Y,_Z)
AND
CrimeGetVictim(_CrimeID,_Victim)
THEN
DB_BUGFIX_Marker("GUS-301450",(GUIDSTRING)_Guard);
DB_CRIME_Guards_Victim((CHARACTER)_Guard,_Victim);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CRIME_Guards_CalledReinforcement(_CrimeID,_InvestigateCrimeID,_Caller,_Guard,_Criminal,_,_Region,_X,_Y,_Z)
AND
CrimeGetVictim(_CrimeID,_Victim)
THEN
DB_BUGFIX_Marker("GUS-301450",(GUIDSTRING)_Guard);
DB_CRIME_Guards_Victim((CHARACTER)_Guard,_Victim);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CrimeEluding_MethodFlagSet(_Method,_DisabledFlag,(CHARACTER)_Interrogator,(CHARACTER)_Criminal,_Dialog)
AND
NOT DB_PartyMembers(_Criminal)
THEN
NOT DB_CrimeEluding_MethodFlagSet(_Method,_DisabledFlag,(CHARACTER)_Interrogator,(CHARACTER)_Criminal,_Dialog);
ClearFlag(_DisabledFlag,_Criminal);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CrimeBribes_PairEludes(_Method,_Interrogator,_Criminal,_Race,_Dialog)
AND
NOT DB_PartyMembers(_Criminal)
THEN
NOT DB_CrimeBribes_PairEludes(_Method,_Interrogator,_Criminal,_Race,_Dialog);
//END_REGION

//REGION GUS-303895
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
NOT DB_END_GodsAndMonsters_KarlachFlags((FLAG) END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135)
THEN
DB_BUGFIX_Marker("GUS-303895");
DB_END_GodsAndMonsters_KarlachFlags((FLAG) END_GameFinale_Event_AccompanyKarlachToHell_35150cbf-2c72-1049-37ed-14dbc3736135);
DB_END_GodsAndMonsters_KarlachFlags((FLAG)GLO_END_GameFinale_DeathofKarlach_KarlachWentWithNonRomanceWyll_a552e386-af26-eb98-d198-a84221e467b0);
DB_END_GodsAndMonsters_KarlachFlags((FLAG)END_GameFinale_SoloFates_Karlach_ChoseAvernus_c5ffd6ad-7749-6eb8-992e-48d66766f6b6);
DB_END_GodsAndMonsters_KarlachFlags((FLAG)END_GameFinale_Event_KarlachReturnedToHell_bbec205a-5b1e-8488-f03a-10f0caaa5471);
DB_END_General_FullPartyDialog((DIALOGRESOURCE)END_GameFinale_KarlachInAvernus_b02dc7ba-cc1b-0260-182f-53daffeac30e, 0, 1, 1, 1, 1, 1, 2);
//END_REGION

//REGION GUS-303566
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 1")
AND
DB_MutingStatuses_Restoring(_Character,_Status,_Causee)
AND
NOT QRY_RestoreMutingStatuses_CauseeStillExists(_Causee)
AND
DB_RemovedMutingStatusRestoreInfo(_Character,_Status,_Duration,_Causee)
THEN
NOT DB_MutingStatuses_Restoring(_Character,_Status,_Causee);
NOT DB_RemovedMutingStatusRestoreInfo(_Character,_Status,_Duration,_Causee);
// Also remove the status if it has been re-applied (e.g. a stuck silenced)
RemoveStatus(_Character,_Status);
DB_BUGFIX_Marker("GUS-303566",_Character);
//END_REGION

//REGION GUS-292813
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-292813");
PROC_GLO_DifficultyModes_AddHPBoostedEntity(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
PROC_GLO_DifficultyModes_AddHPBoostedEntity(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
//END_REGION GUS-292813

//REGION GUS-305117
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2 Rev 1")
AND
DB_GlobalFlag(GLO_PaladinOathbreaker_State_OathbreakerPresent_2925b66d-d306-4034-bf11-6c0cdca36edc)
AND
NOT DB_PermaDefeated(S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231)
AND
IsOnStage(S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231, 0)
THEN
DB_BUGFIX_Marker("GUS-305117");
PROC_Foop(S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2 Rev 1")
AND
DB_GlobalFlag(GLO_PaladinOathbreaker_State_OathbreakerPresent_2925b66d-d306-4034-bf11-6c0cdca36edc)
AND
NOT DB_InCamp((CHARACTER)S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231)
AND
NOT DB_PermaDefeated(S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231)
AND
QRY_Camp_GetCamperPos((CHARACTER)S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231)
AND
DB_QRYRTN_Camp_GetCamperPos((CHARACTER)S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231,_CampPos)
THEN
DB_BUGFIX_Marker("GUS-305117");
TeleportTo(S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231,_CampPos);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2 Rev 1")
THEN
DB_BUGFIX_Marker("GUS-305117");
PROC_SetAnubisConfig((CHARACTER)S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231, "GLO_OathbreakerKnight");
SetFaction(S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231, (FACTION)GLO_OathbreakerKnight_82d51a65-669c-4c23-b26b-cc90cbc8af4a);
//END_REGION GUS-305117

//REGION GUS-304743
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2 Rev 2")
AND
DB_PartyMembers(_Party)
AND
QRY_DEN_IsInDen((CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925)
AND
GetFlag((FLAG)DEN_HideoutLeader_HasMet_d018a0dc-99de-2652-813c-19450c65a6a3, _Party, 1)
AND
DB_GlobalFlag((FLAG)DEN_Hideout_Event_BefriendedThieflings_a1a932ee-f66a-08af-4bf0-bf77790052f7)
AND
NOT DB_BUGFIX_Marker("GUS-304743")
THEN
SetHasDialog(S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925, 1);
//END_REGION GUS-304743

//REGION GUS-305301

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_ORI_DarkUrge_LeastFavouriteCharacter(_Character)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_ORI_DarkUrge_FavouriteCharacter((CHARACTER)_Character)
AND
SysStatus("GLO_Origin_DarkUrge_KillFavourite", 2)
THEN
NOT DB_ORI_DarkUrge_LeastFavouriteCharacter(_Character);
PROC_ORI_DarkUrge_FindNewDarkUrgeLeastFavouriteCharacter();
DB_BUGFIX_Marker("GUS-305301");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
SysStatus("GLO_Origin_DarkUrge_KillFavourite", 2)
THEN
PROC_ORI_DarkUrge_RecheckFavourite();
DB_BUGFIX_Marker("GUS-305301");

//END_REGION

//REGION GUS-299568
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_SecondNight_37bc82ff-e71b-4723-b7d0-bf0d660ec5b6, (FLAG)ORI_Laezel_State_EnteredHaven_940dbf33-3265-4b23-84a1-f53e478cb407)
THEN
NOT DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_SecondNight_37bc82ff-e71b-4723-b7d0-bf0d660ec5b6, (FLAG)ORI_Laezel_State_EnteredHaven_940dbf33-3265-4b23-84a1-f53e478cb407);
DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_Romance1_AfterCelebration_c970265f-56e2-46e8-812d-06e0ac0a0fe4, (FLAG)ORI_Laezel_State_EnteredHaven_940dbf33-3265-4b23-84a1-f53e478cb407);
DB_BUGFIX_Marker("GUS-299568");
//END_REGION

//REGION GUS-305511

PROC
PROC_ApplySavegamePatches()
AND
NOT DB_BUGFIX_Marker("GUS-318707")
THEN
PROC_BUGFIX_GUS305511_FixBusyDialog();

PROC
PROC_BUGFIX_GUS305511_FixBusyDialog()
AND
DB_ObjectCountHelper(_Character, "GEB_BusyDialog", _Count)
AND
_Count > 0
AND
IsCharacter(_Character, 1)
THEN
DB_BUGFIX_GUS305511_TempBusyCount(0);
PROC_BUGFIX_GUS305511_RecountBusyDialog((CHARACTER)_Character, _Count);

PROC
PROC_BUGFIX_GUS305511_RecountBusyDialog((CHARACTER)_Character, (INTEGER)_SaveFileCount)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount)
THEN
NOT DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount);
DB_BUGFIX_GUS305511_TempBusyCount(0);

//Scene manager
PROC
PROC_BUGFIX_GUS305511_RecountBusyDialog((CHARACTER)_Character, (INTEGER)_SaveFileCount)
AND
DB_InternScene_LeftTriggerDialogsBlocked(_Character, _)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount)
AND
IntegerSum(_CurrentCount, 1, _NewCount)
THEN
NOT DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount);
DB_BUGFIX_GUS305511_TempBusyCount(_NewCount);

//Crime handling
PROC
PROC_BUGFIX_GUS305511_RecountBusyDialog((CHARACTER)_Character, (INTEGER)_SaveFileCount)
AND
DB_CRIME_RestoreDialogAfterCrimeHandling(_, _Character)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount)
AND
IntegerSum(_CurrentCount, 1, _NewCount)
THEN
NOT DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount);
DB_BUGFIX_GUS305511_TempBusyCount(_NewCount);

//Situation specific
PROC
PROC_BUGFIX_GUS305511_RecountBusyDialog((CHARACTER)_Character, (INTEGER)_SaveFileCount)
THEN
PROC_BUGFIX_GUS306595_RecountBusyDialog_Boosters((CHARACTER)_Character, (INTEGER)_SaveFileCount);

//Disappear out of sight
PROC
PROC_BUGFIX_GUS305511_RecountBusyDialog((CHARACTER)_Character, (INTEGER)_SaveFileCount)
AND
DB_DisappearedOutOfSight(_Character, _, _, _, _, _, _)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount)
AND
IntegerSum(_CurrentCount, 1, _NewCount)
THEN
NOT DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount);
DB_BUGFIX_GUS305511_TempBusyCount(_NewCount);

PROC
PROC_BUGFIX_GUS305511_RecountBusyDialog((CHARACTER)_Character, (INTEGER)_SaveFileCount)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_ActualCount)
AND
_SaveFileCount != _ActualCount
THEN
DB_BUGFIX_Marker("GUS-305511");
DB_BUGFIX_Marker("GUS-306595"); // Includes patch 6 fix
NOT DB_ObjectCountHelper(_Character, "GEB_BusyDialog", _SaveFileCount);
DB_ObjectCountHelper(_Character, "GEB_BusyDialog", _ActualCount);

PROC
PROC_BUGFIX_GUS305511_RecountBusyDialog((CHARACTER)_Character, (INTEGER)_SaveFileCount)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_ActualCount)
THEN
NOT DB_BUGFIX_GUS305511_TempBusyCount(_ActualCount);
//END_REGION

//REGION GUS-306595
// Patch again to take situations into account too
PROC
PROC_ApplySavegamePatches()
AND
NOT DB_BUGFIX_Marker("GUS-306595")
AND
NOT QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_BUGFIX_Marker("GUS-305511")
THEN
DB_BUGFIX_Marker("GUS-306595");
PROC_BUGFIX_GUS306595_ForceFixBusyDialog();

PROC
PROC_BUGFIX_GUS306595_ForceFixBusyDialog()
AND
DB_BUGFIX_GUS305511_TempBusyCount(_PrevCount)
THEN
NOT DB_BUGFIX_GUS305511_TempBusyCount(_PrevCount);

PROC
PROC_BUGFIX_GUS306595_ForceFixBusyDialog()
AND
DB_ObjectCountHelper(_Character, "GEB_BusyDialog", _Count)
AND
QRY_BUGFIX_GUS306595_HasBusyDialog((CHARACTER)_Character) // Only do it for characters who could de broken.
THEN
DB_BUGFIX_GUS305511_TempBusyCount(0);
PROC_BUGFIX_GUS305511_RecountBusyDialog((CHARACTER)_Character, _Count);

QRY
QRY_BUGFIX_GUS306595_HasBusyDialog((CHARACTER)_Character)
AND
0 == 1
THEN
DB_NOOP(1);

PROC
PROC_BUGFIX_GUS306595_RecountBusyDialog_Boosters((CHARACTER)_Character, (INTEGER)_SaveFileCount)
AND
QRY_BUGFIX_GUS306595_HasBusyDialog(_Character)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount)
AND
IntegerSum(_CurrentCount, 1, _NewCount)
THEN
NOT DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount);
DB_BUGFIX_GUS305511_TempBusyCount(_NewCount);
//END_REGION GUS-306595

//REGION GUS-297159
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_SavegamePatch_GUS297159(1);	// Hide mound if the chest was already loaded
DB_SavegamePatch_GUS302508_FixBrokenMounds_Act3b(1); // Fix broken chests in LOW
DB_BUGFIX_Marker("GUS-297159");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("END_Main")
AND
NOT DB_LevelUnreachable("END_Main")
THEN
DB_SavegamePatch_GUS297159_FixBrokenMounds_Act3c(1); // Fix broken chest in END
DB_BUGFIX_Marker("GUS-297159");

IF
DB_SavegamePatch_GUS297159(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_SetOnStage(S_LOW_CAZ_BuriedMound_01_031e07b7-acd9-4596-8755-e011d9888951, 0);
NOT DB_SavegamePatch_GUS297159(1);

IF
DB_SavegamePatch_GUS297159_FixBrokenMounds_Act3c(1)
AND
DB_CurrentLevel("END_Main")
THEN
PROC_SavegamePatch_GUS302508_FixBrokenChest(S_END_MorphicDigChest_c8ee9c37-e074-4397-aab3-b654763c7d91, -913.26501, -13.786, 3682.113);
PROC_SavegamePatch_GUS302508_FixBrokenMound(S_END_MorphicDiggingMound_8e1a5cea-23c3-4507-af54-15be96145e60, -913.26508, -13.786025, 3682.113);
ApplyStatus(S_END_MorphicDiggingMound_8e1a5cea-23c3-4507-af54-15be96145e60, "DIG_AURA", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SavegamePatch_GUS297159_FixBrokenMounds_Act3c(1);
//END_REGION

//REGION GUS-303622
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_END_AllyAbilities_Abilities((FLAG)END_GatherYourAllies_Event_WithersReinforcementAwarded_c25ba4e8-ec7c-4203-a6ec-867022374133, "Teleportation_END_AllyAbilities_WithersResurrection", 0, "END_ALLYABILITY_WITHERSRESURRECTION");
DB_END_AllyAbility_PermanentAbilityRemoval("Teleportation_END_AllyAbilities_WithersResurrection", "END_ALLYABILITY_WITHERSINTERDICTED");
DB_END_GatherYourAllies_AllyAwardFlags((FLAG)END_GatherYourAllies_Event_WithersReinforcementAwarded_c25ba4e8-ec7c-4203-a6ec-867022374133, (CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
//END_REGION

//REGION GUS-305347
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_BUGFIX_Marker("GUS-305347")
THEN
DB_BUGFIX_Marker("GUS-305347");
PROC_GLO_Bugfix_305347_TryRestoreMessages();

// Try to restore SteelWatchFought if it was triggered but not sent.
PROC
PROC_GLO_Bugfix_305347_TryRestoreMessages()
AND
DB_OnlyOnce("GEN_OrinsMessages_SteelWatchFought") // message was triggered already.
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsMessages_State_SteelWatchFought_3b5949f1-5bce-43d0-9579-1e261f13ae2c) // but not sent.
THEN
PROC_GEN_OrinsMessages_SteelWatchLeftCombat();

// Try to restore SteelWatchDestroyed if it was triggeed but not sent yet.
PROC
PROC_GLO_Bugfix_305347_TryRestoreMessages()
AND
DB_OnlyOnce("GEN_OrinsMessages_SteelWatchFoundryDestroyed") // message was triggered already.
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsMessages_State_SteelWatchFoundryDestroyed_894e276b-fcfd-46d7-8b23-a5ba9a45c595) // but not sent.
THEN
PROC_GEN_OrinsMessages_SteelWatchFoundryDestroyed();

// Try to restore GortashKilled if it was triggeed but not sent yet.
PROC
PROC_GLO_Bugfix_305347_TryRestoreMessages()
AND
DB_OnlyOnce("GEN_OrinsMessages_GortashKilled") // message was triggered already.
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsMessages_State_GortashKilled_c6e7b755-119e-48cf-8698-67ebf3d09044) // but not sent.
AND
QRY_GEN_OrinsMessages_MurderTribunalCleared()
THEN
PROC_GEN_OrinsMessages_SetupMessageInCamp("GEN_OrinsMessages_GortashKilled_NoTribunal");

// Try to restore GortashKilled if it was triggeed but not sent yet.
PROC
PROC_GLO_Bugfix_305347_TryRestoreMessages()
AND
DB_OnlyOnce("GEN_OrinsMessages_GortashKilled") // message was triggered already.
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsMessages_State_GortashKilled_c6e7b755-119e-48cf-8698-67ebf3d09044) // but not sent.
AND
NOT QRY_GEN_OrinsMessages_MurderTribunalCleared()
THEN
PROC_GEN_OrinsMessages_SetupMessageInCamp("GEN_OrinsMessages_GortashKilled");

//END_REGION

//REGION GUS-304268
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2 Hotfix 1")
AND
NOT DB_CompanionCanPartner((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (FLAG)ORI_State_DatingMinthara_de1360cd-894b-40ea-95a7-1166d675d040, (FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8, (FLAG)ORI_State_WasPartneredWithMinthara_8d0460d6-b00a-4947-bbd0-ad0c085a530f, (FLAG)ORI_State_HandledBreakupWithMinthara_6a880802-bf76-4ece-816e-82cf90fa97be, (FLAG)ORI_State_ChosePartnerOverMinthara_25202f13-55d3-4d13-b0c2-1245a90d99f2, "dateminthara")
THEN
DB_BUGFIX_Marker("GUS-304268");
DB_CompanionCanPartner((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (FLAG)ORI_State_DatingMinthara_de1360cd-894b-40ea-95a7-1166d675d040, (FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8, (FLAG)ORI_State_WasPartneredWithMinthara_8d0460d6-b00a-4947-bbd0-ad0c085a530f, (FLAG)ORI_State_HandledBreakupWithMinthara_6a880802-bf76-4ece-816e-82cf90fa97be, (FLAG)ORI_State_ChosePartnerOverMinthara_25202f13-55d3-4d13-b0c2-1245a90d99f2, "dateminthara");
//END_REGION

//REGION GUS-300581

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_Avatars(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143)
AND
NOT DB_CurrentLevel("SCL_Main_A")
THEN
TemplateAddTo((ITEMROOT)MAG_SHA_SeluneBlessing_Spear_2eeabe97-8f29-4f4f-827e-6cfcd8fd1779, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1, 1);
DB_BUGFIX_Marker("GUS-300581");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_Avatars(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
ToInventory(S_SCE_SeluniteSpear_134ac3a4-2a65-4baf-93eb-3de91c314558, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1, 1, 1);
DB_BUGFIX_Marker("GUS-300581");
//END_REGION GUS-300581

//REGION GUS-250381
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_LinkedCrimes("Steal", "LootOwnedCorpse");
DB_LinkedCrimes("Steal", "SneakLootOwnedCorpse");
DB_LinkedCrimes("Steal", "EmptyPocketNoticed");
DB_LinkedCrimes("Steal", "EmptyPocketNoticedInvestigation");
DB_BUGFIX_Marker("GUS-250381");
//END_REGION

//REGION GUS-306171
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Hotfix 1")
AND
DB_BUGFIX_Marker_DualGuid(_JIRA,(GUIDSTRING)_Char,(GUIDSTRING)_Dialog)
AND
DB_DialogStart_SpeakerReserved(_Char)
AND
NOT DB_AttemptingMutingStatuses(_Char,_,_)
THEN
NOT DB_DialogStart_SpeakerReserved(_Char);
DB_BUGFIX_Marker("GUS-306171",_Char);
//END_REGION

//REGION GUS-297099
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_Combat_ExplodeOnDeath(LOW_GreaseWizard_FireMephit_c00e7115-966b-429d-9098-0baad3fb6570, 1180, 2.0, "Projectile_DeathBurst_MagmaMephit");
DB_Combat_ExplodeOnDeath(LOW_GreaseWizard_FireMephit_Summon_22309308-6060-42d5-acd3-02e0ab01c2c1, 1180, 2.0, "Projectile_DeathBurst_MagmaMephit");
DB_Combat_ExplodeOnDeath(LOW_Sewers_MagmaMephit_04e6250d-aa38-4402-8568-46d3590c024b, 1180, 2.0, "Projectile_DeathBurst_MagmaMephit");
DB_BUGFIX_Marker("GUS-297099");
//END_REGION

//REGION GUS-307093
//If the player is already hunted, give them the status. when it ticks down, the existing script will kick in and remove the crime.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GLO_SteelWatch_EnemyOfAbsoluteCrimeEnabled(_Player,_)
THEN
ApplyStatus(_Player, "LOW_STEELWATCH_ENEMYOFABSOLUTE", 120.0, 0, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-307093");
//END_REGION GUS-307093

//REGION GUS-305894

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_ORI_Shadowheart_PartneringOpportunityFlags((FLAG)Shadowheart_InParty_Event_DiscussedEnemyOfShar_9cbca564-9d38-97c6-b2a7-fabece8f9ce8);
DB_ORI_Shadowheart_PartneringOpportunityFlags((FLAG)Shadowheart_InParty_DiscussedSharPath_5582b71a-8c40-465f-85b8-55b224d8e283);
DB_BUGFIX_Marker("GUS-305894");
//END_REGION

//REGION GUS-305528
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_SCE_Debrief_Dialogues(_, _)
THEN
DB_BUGFIX_Marker("GUS-305528");
NOT DB_SCE_Debrief_Dialogues((DIALOGRESOURCE)SCE_Jaheira_Debrief_7eb6a35a-656a-78db-57c8-4d5178ef880b, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
NOT DB_SCE_Debrief_Dialogues((DIALOGRESOURCE)SCE_Minthara_b9533573-31a6-bcfe-9f91-fa720373e102, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
NOT DB_SCE_Debrief_Dialogues((DIALOGRESOURCE)SCE_Jergal_Debrief_40bfba6f-d321-0d1e-1d14-5092544d96ea, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
//END_REGION

//REGION GUS-305894
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_Players(_Player)
AND
DB_ORI_Shadowheart_PartneringOpportunityFlags((FLAG)_Flag)
AND
GetFlag((FLAG)_Flag, _Player, 1)
AND
DB_ORI_Dating((CHARACTER)_Player, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_ORI_Partnered(_Player, _OtherComp)
AND
_OtherComp != S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679
THEN
SetFlag((FLAG)ORI_Shadowheart_State_MissedPartneringOpportunity_8615e8c7-211f-dec9-69dd-119738cab6ea, _Player, 0);
DB_BUGFIX_Marker("GUS-305894", _Player);

//END_REGION

//REGION GUS-305768
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
QuestIsAccepted((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_Avatar_ShadowHeart_SUB_ChosenOfShar", 1)
THEN
DB_ORI_Shadowheart_JournalFix((FLAG)ORI_Shadowheart_Knows_JusticiarMurals_87dea9e2-c18c-40a0-98cf-96cf2804cf4e, "JusticiarHint_Murals_Update");
DB_ORI_Shadowheart_JournalFix((FLAG)ORI_Shadowheart_Knows_SeenTempleVista_81608e92-ac2f-4440-834c-585b0c228c7a, "JusticiarHint_TempleVista_Update");
DB_ORI_Shadowheart_JournalFix((FLAG)ORI_Shadowheart_State_IdolHint_5e2d4403-e9e9-4ee2-a2fb-5d7f45aa71cb, "JusticiarHint_SharIdol_Update");
DB_ORI_Shadowheart_JournalFix((FLAG)ORI_Shadowheart_Knows_CurseResistant_1c40f83c-99d1-4777-a8f7-95377f6561b8, "JusticiarHint_ShadowCurse_Update");
DB_ORI_Shadowheart_JournalFix((FLAG)ORI_Shadowheart_State_TempleApproachHint_c0aa296e-fa16-4ddf-8e2d-ecfe5b5b32e2, "JusticiarHint_TempleApproach_Update");
DB_ORI_Shadowheart_JournalFix((FLAG)Shadowheart_InParty_InterestInDarkJusticiars_4d45b833-582d-c7a6-9936-0922e78e36d9, "JusticiarHint_Halsin_Update");
DB_ORI_Shadowheart_JournalFix((FLAG)ORI_Shadowheart_State_SeluneJusticiarHint_6c8ac0f9-e182-4a62-aeab-52e6dcf6a5ef, "JusticiarHint_Selune_Update");
DB_ORI_Shadowheart_JournalFix((FLAG)UND_DarkJusticiarsCorpses_Recognized_6926ad12-4a89-35c9-3d70-2ec613b25c8d, "JusticiarHint_CityCorpses_Update");
DB_ORI_Shadowheart_JournalFix((FLAG)ORI_Shadowheart_State_TownCorpseHint_e2059455-ab53-49d3-aac5-775453ff9468, "JusticiarHint_TownCorpses_Update");

IF
DB_ORI_Shadowheart_JournalFix(_Flag, _Update)
AND
QRY_ORI_Shadowheart_JournalFix((FLAG)_Flag, (STRING)_Update)
THEN
DB_BUGFIX_Marker("GUS-305768");
NOT DB_ORI_Shadowheart_JournalFix(_Flag, _Update);

QRY
QRY_ORI_Shadowheart_JournalFix((FLAG)_Flag, (STRING)_Update)
AND
DB_GlobalFlag(_Flag)
AND
DB_State_Current(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_DarkJusticiarHints", "ORI_DarkJusticiarHints_DarkJusticiarDream")
THEN
QuestUpdate((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_Avatar_ShadowHeart", _Update);

QRY
QRY_ORI_Shadowheart_JournalFix((FLAG)_Flag, (STRING)_Update)
THEN
DB_NOOP(1);

//END_REGION GUS-305768

//REGION GUS-304777
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
NOT DB_QuestDef_State((FLAG)COL_KethericShowdown_Knows_KilledAvatarMyrkul_a9d5f8a5-341e-34e8-a6f7-f566e5666a4e, "ORI_COM_ShadowHeart", "SharPath_DefeatedKetheric");
NOT DB_QuestDef_State((FLAG)COL_KethericShowdown_Knows_KilledAvatarMyrkul_a9d5f8a5-341e-34e8-a6f7-f566e5666a4e, "ORI_Avatar_ShadowHeart", "SharPath_DefeatedKetheric");
DB_BUGFIX_Marker("GUS-304777");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
QuestIsAccepted((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_Avatar_ShadowHeart", 1)
AND
DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
THEN
QuestUpdate((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_Avatar_ShadowHeart", "SharPath_DefeatedKetheric");
DB_BUGFIX_Marker("GUS-304777");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
QuestIsAccepted((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_COM_ShadowHeart", 1)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
THEN
QuestUpdate((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_COM_ShadowHeart", "SharPath_DefeatedKetheric");
DB_BUGFIX_Marker("GUS-304777");

//END_REGION GUS-304777

//REGION GUS-155152
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_PLA_ZhentShipment_ContinueCrimeInvestigationAfterCombat((CHARACTER)_Zhent, (GUIDSTRING)_CombatID, (INTEGER)_CrimeID)
THEN
NOT DB_PLA_ZhentShipment_ContinueCrimeInvestigationAfterCombat(_Zhent, _CombatID, _CrimeID);
DB_PLA_ZhentShipment_ContinueCrimeInvestigationAfterCombat(_Zhent, _CombatID, _CrimeID, 0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CRIME_Guards_Called(_CrimeID,_InterrogationCrimeID,_Caller,_Guard,_Criminal,_InterrogationType,_Region,_X,_Y,_Z)
AND
CrimeGetType(_CrimeID,_CrimeType)
AND
_CrimeType != ""
AND
NOT DB_CRIME_ShapeshiftTracker_Known("CRIME_CallGuards",_Guard,_Criminal,_,_)
THEN
PROC_CRIME_Shapeshift_WitnessTrackCriminal("CRIME_CallGuards",_Guard,_Criminal);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CRIME_Guards_Patrolling(_Guard,_PatrolCrimeID)
AND
NOT DB_CRIME_Guards_Patrolling_OriginalCrimeType(_PatrolCrimeID,_)
THEN
// Dummy that will result in the generic arrest/interrogation dialog
DB_CRIME_Guards_Patrolling_OriginalCrimeType(_PatrolCrimeID,"Default");

//END_REGION

//REGION GUS-305491

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_ORI_Shadowheart_RemovedGloves((ITEM)_Gloves)
THEN
DB_BUGFIX_Marker("GUS-305491");
NOT DB_ORI_Shadowheart_RemovedGloves((ITEM)_Gloves);
Equip((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Gloves);

//END_REGION GUS-305491

//REGION GUS-303917 - clear stuck "registered for dialog" flag

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Hotfix 3")
AND
DB_PartyMembers(_Member)
AND
IsSpeakerReserved(_Member, 1)
AND
NOT SpeakerGetDialog(_Member,0,_,_)
THEN
//reserved, but no instance for the speaker.
PROC_GUS303917_TryClearDialogFlagFor(_Member);

PROC
PROC_GUS303917_TryClearDialogFlagFor((CHARACTER)_Speaker)
AND
StartDialog_Internal(CC_Wyll_Intro_22e1f2cd-17ab-0c1b-e679-015faa6456dd,0,_Speaker,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,_,_Instance,0)
THEN
StopWorldTimeline(_Instance);	//yes, we are abusing the call here
DB_BUGFIX_Marker("GUS-303917",_Speaker);
//END_REGION

//REGION GUS-306923
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(WYR_South_Event_GotTaskToTrackGnomes_717dceb3-3a0d-427d-b07d-77537a22439d)
THEN
DB_GLO_HeadRemoval_InaccessibleIfOffstage(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
DB_BUGFIX_Marker("GUS-306923-A");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(UND_MyconidRevenge_State_SentKillNere_d8d606e6-d565-ed2f-bd4e-f2de1e719618)
THEN
DB_GLO_HeadRemoval_InaccessibleIfOffstage(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);
DB_BUGFIX_Marker("GUS-306923-B");
//END_REGION

//REGION GUS-304648
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
CanJoinCombat(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0)
THEN
DB_BUGFIX_Marker("GUS-304648");
SetCanJoinCombat(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1);
//END_REGION

//REGION GUS-300162
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_DEN_Thieflings_StolenItems(_, _, _)
AND
NOT DB_GlobalFlag((FLAG)DEN_Thieflings_State_HoldingStolenGoods_b21939d8-362b-cafc-91ee-ad2fa26df511)
AND
NOT DB_GlobalFlag(DEN_Hideout_Event_TurnedKidsHostile_17cfabeb-f1d7-9432-0e29-5aecfcef1a18)
THEN
DB_BUGFIX_Marker("GUS-300162");
SetFlag((FLAG)DEN_Thieflings_State_HoldingStolenGoods_b21939d8-362b-cafc-91ee-ad2fa26df511, NULL_00000000-0000-0000-0000-000000000000, 0);
//END_REGION

//REGION GUS-305078
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-305078");
DB_GLO_StatusGroupCrime("SG_Mad","Assault_Maddened","Maddened_SelfReactOnEnd");
DB_LinkedCrimes( "Assault", "Assault_Maddened" );
DB_LinkedCrimes( "Assault", "Maddened_SelfReactOnEnd" );
//END_REGION

//REGION GUS-305498
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_ApplySavegamePatch_GUS_305498();
DB_BUGFIX_Marker("GUS-305498");

PROC
PROC_ApplySavegamePatch_GUS_305498()
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_LevelUnreachable("WLD_Main_A")
THEN
DB_PermaDefeatedFlag(S_FOR_SchoolOgre1_848b6f10-3ae5-41f6-b1a1-98c34a19ba3f, (FLAG)FOR_SchoolOgres_State_MainOgrePermaDefeated_5b3ea6f8-0d41-4388-9124-434e133362c2);

PROC
PROC_ApplySavegamePatch_GUS_305498()
AND
DB_CampNight_ExpiresAfter((FLAG)NIGHT_Laezel_Romance1_AfterCelebration_c970265f-56e2-46e8-812d-06e0ac0a0fe4,5)
THEN
NOT DB_CampNight_ExpiresAfter((FLAG)NIGHT_Laezel_Romance1_AfterCelebration_c970265f-56e2-46e8-812d-06e0ac0a0fe4,5);

PROC
PROC_ApplySavegamePatch_GUS_305498()
AND
DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_Romance1_AfterCelebration_c970265f-56e2-46e8-812d-06e0ac0a0fe4, (FLAG)ORI_Laezel_State_EnteredHaven_940dbf33-3265-4b23-84a1-f53e478cb407)
THEN
NOT DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_Romance1_AfterCelebration_c970265f-56e2-46e8-812d-06e0ac0a0fe4, (FLAG)ORI_Laezel_State_EnteredHaven_940dbf33-3265-4b23-84a1-f53e478cb407);

PROC
PROC_ApplySavegamePatch_GUS_305498()
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
//Cancelling Romance 2 if the fallback triggered
DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_Romance2_66c4c3b0-b608-46af-86b2-3e3dd4e44f5b, (FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9);
//Cancelling the Act1/1b counterpart to the fallback if Act2 happened
DB_CampNight_Cancels((FLAG)NIGHT_Laezel_Romance1_AfterCelebration_c970265f-56e2-46e8-812d-06e0ac0a0fe4, (FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9);
DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_Romance1_AfterCelebration_c970265f-56e2-46e8-812d-06e0ac0a0fe4, (FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9);
//Adding fallback night if romance is initiated in Act2
DB_CampNight((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, 4055);
DB_CampNight_Camp((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, "SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, "HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, "MOONRISE");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, "SHARTEMPLE");
DB_CampNight_Cancels((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, (FLAG)NIGHT_Laezel_SecondNight_37bc82ff-e71b-4723-b7d0-bf0d660ec5b6);
DB_CampNight_Cancels((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, (FLAG)NIGHT_Laezel_Romance1_AfterCelebration_c970265f-56e2-46e8-812d-06e0ac0a0fe4);
DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, (FLAG)CAMP_GoblinHuntCelebration_SD_ROM_NightWithLaezel_State_Happened_8860bafa-bdb3-2854-b664-50868c13c9a3);
DB_CampNight_Requirement_Dating((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12); //Dating is set during the invitation in the InParty dialog
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, (FLAG)ORI_Laezel_Romance1_AfterCelebration_State_QueueInvitation_d648c9ac-8453-4d28-95de-0a9c5f0d02a3);
DB_CampNight_RomanceNight((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, CAMP_Laezel_ROM_SD_Romance2_WokenUpByLaezel_ce8ea48c-688d-7484-283f-c801c82172b3, NULL_00000000-0000-0000-0000-000000000000);
//Defeating these enemies will prompt an IPRD reaction from Laezel about starting the romance and enable the question if it is missed
DB_ORI_Laezel_Romance1ActivationFlags((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720);
DB_ORI_Laezel_Romance1ActivationFlags((FLAG)FOR_Bottomless_SpiderQueen_State_PermaDefeated_b749271f-fbee-43ec-bbc7-b1199d0f794a);
DB_ORI_Laezel_Romance1ActivationFlags((FLAG)FOR_Owlbear_State_PermaDefeated_a2cd3c0f-95be-7155-d67c-edbdb2ca1104);
DB_ORI_Laezel_Romance1ActivationFlags((FLAG)FOR_SchoolOgres_State_MainOgrePermaDefeated_5b3ea6f8-0d41-4388-9124-434e133362c2);
//Entering one of those regions will enable the romance 1 question after one long rest
DB_ORI_Laezel_Romance1ActivationFlags_FallbackRegions((FLAG)GLO_Underdark_EverEnteredBefore_dd5cd5b4-2ad5-4dbd-4972-2afaa7538994);
DB_ORI_Laezel_Romance1ActivationFlags_FallbackRegions((FLAG)VISITEDREGION_CRE_Main_A_c22062f9-2a42-4e19-8c72-34a2d9ff9c0a);

PROC
PROC_ApplySavegamePatch_GUS_305498()
AND
DB_PermaDefeated((CHARACTER)S_FOR_SchoolOgre1_848b6f10-3ae5-41f6-b1a1-98c34a19ba3f)
THEN
PROC_GlobalSetFlagAndCache((FLAG)FOR_SchoolOgres_State_MainOgrePermaDefeated_5b3ea6f8-0d41-4388-9124-434e133362c2);

PROC
PROC_ApplySavegamePatch_GUS_305498()
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_CanAskStartRomance_cc04358c-256d-4f2c-bcdb-8b1ffa211874)
AND
DB_ORI_Laezel_Romance1ActivationFlags(_ActivationFlag)
AND
DB_GlobalFlag(_ActivationFlag)
THEN
SetFlag((FLAG)ORI_Laezel_State_CanAskStartRomance_cc04358c-256d-4f2c-bcdb-8b1ffa211874);

PROC
PROC_ApplySavegamePatch_GUS_305498()
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_CanAskStartRomance_cc04358c-256d-4f2c-bcdb-8b1ffa211874)
AND
DB_ORI_Laezel_Romance1ActivationFlags_FallbackRegions(_FallbackFlag)
AND
DB_GlobalFlag(_FallbackFlag)
THEN
SetFlag((FLAG)ORI_Laezel_State_CanAskStartRomance_cc04358c-256d-4f2c-bcdb-8b1ffa211874);
//END_REGION

//REGION GUS-307143
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
PROC_ApplySavegamePatch_GUS_307143();
DB_BUGFIX_Marker("GUS-307143");

PROC
PROC_ApplySavegamePatch_GUS_307143()
AND
NOT DB_DialogName((DIALOGRESOURCE)CAMP_Laezel_VossCampConfrontation_SCO_LaezelCom_a85065d0-f5ec-cb25-31cd-5354f0c0614c, _)
THEN
PROC_ApplySavegamePatch_GUS_307143_CheckRemoveLaezel();

PROC
PROC_ApplySavegamePatch_GUS_307143()
AND
DB_DialogName((DIALOGRESOURCE)CAMP_Laezel_VossCampConfrontation_SCO_LaezelCom_a85065d0-f5ec-cb25-31cd-5354f0c0614c, _)
THEN
DB_ApplySavegamePatch_GUS_307143_CheckRemoveLaezelAfterCampNight(1);

IF
DB_ApplySavegamePatch_GUS_307143_CheckRemoveLaezelAfterCampNight(1)
AND
NOT DB_DialogName((DIALOGRESOURCE)CAMP_Laezel_VossCampConfrontation_SCO_LaezelCom_a85065d0-f5ec-cb25-31cd-5354f0c0614c, _)
THEN
NOT DB_ApplySavegamePatch_GUS_307143_CheckRemoveLaezelAfterCampNight(1);
PROC_ApplySavegamePatch_GUS_307143_CheckRemoveLaezel();

PROC
PROC_ApplySavegamePatch_GUS_307143_CheckRemoveLaezel()
AND
DB_GlobalFlag((FLAG)CAMP_LaezelBeforeDream_Event_AttackedLaezel_dffe4643-709e-ac8c-ad62-450db550ca61)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
THEN
PROC_Origins_CompanionLeavePermanently(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "LaezelDied_KilledAtCampNight");
PROC_SetOnStage((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0);

PROC
PROC_ApplySavegamePatch_GUS_307143_CheckRemoveLaezel()
AND
DB_GlobalFlag((FLAG)CAMP_LaezelBeforeDream_Event_LaezelKilledPlayer_83012c3a-bce6-fd00-f1c9-51dc86eb49da)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
THEN
PROC_Origins_CompanionLeavePermanently(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "LaezelDied_KilledAtCampNight");
PROC_SetOnStage((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0);

PROC
PROC_ApplySavegamePatch_GUS_307143_CheckRemoveLaezel()
AND
DB_GlobalFlag((FLAG)CAMP_LaezelBeforeDream_Event_ExecuteLaezel_1a3d618c-b80e-78f2-d766-442f121ee540)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Is_InCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
THEN
PROC_Origins_CompanionLeavePermanently(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "LaezelDied_KilledAtCampNight");
PROC_SetOnStage((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0);
//END_REGION

//REGION GUS-307030
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_BUGFIX_Marker("GUS-307030");
PROC_GLO_Bugfix_307030_CleanUpOldDB();

PROC
PROC_GLO_Bugfix_307030_CleanUpOldDB()
AND
DB_Hirelings_Hired_OwnerAvatar((CHARACTER)_Hireling, (CHARACTER)_Avatar)
THEN
NOT DB_Hirelings_Hired_OwnerAvatar(_Hireling, _Avatar);
//END_REGION

//REGION GUS-306476
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
AND
DB_PartOfTheTeam(_TeamMember)
AND
GetFlag(Astarion_InParty_Asked_VampireReveal_5c3d958a-7b71-f5f1-6fec-3117418297e8, _TeamMember, 1)
THEN
DB_BUGFIX_Marker("GUS-306476");
SetFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
//END_REGION

//REGION GUS-306961
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_ApplySavegamePatch_GUS_306961();

PROC
PROC_ApplySavegamePatch_GUS_306961()
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_WasRecruited_34790d30-6331-484f-ae56-87f7dad3b57f)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_CurrentLevel("TUT_Avernus_C")
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Laezel_State_WasRecruited_34790d30-6331-484f-ae56-87f7dad3b57f);

PROC
PROC_ApplySavegamePatch_GUS_306961()
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_WasRecruited_34790d30-6331-484f-ae56-87f7dad3b57f)
THEN
DB_PreventKnockedOutPermaDefeated((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

PROC
PROC_ApplySavegamePatch_GUS_306961()
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_WasRecruited_34790d30-6331-484f-ae56-87f7dad3b57f)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12) //In case of an edge case where the WasRecruited Flag was not set if she was recruited directly to camp and never added to party
AND
DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_CanBeResurrected(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
PROC_SetOnStage((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0);
SetTag(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
DB_BUGFIX_Marker("GUS-306961");


//END_REGION

//REGION GUS-308201
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CRIME_FledOutOfSight((CHARACTER)_NPC)
AND
NOT DB_GEB_FledOutOfSight((GUIDSTRING)_NPC,_,_,_)
THEN
NOT DB_CRIME_FledOutOfSight((CHARACTER)_NPC);
DB_BUGFIX_Marker("GUS-308201",_NPC);
//END_REGION

//REGION GUS-305514

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_Splatters_Statuses("WYR_FACEPAINT_CLOWN");
DB_Splatters_Statuses("GLO_PIXIECURSE");

//Moved to stats
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_Splatters_Statuses((STRING)_Status)
AND
_Status != "WYR_FACEPAINT_CLOWN"
AND
_Status != "GLO_PIXIECURSE"
THEN
NOT DB_Splatters_Statuses(_Status);

//Moved to stats
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_Splatters_CleaningRoots((ITEMROOT)_Root)
THEN
NOT DB_Splatters_CleaningRoots(_Root);

//END_REGION GUS-305514

//REGION GUS-303514
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_CampNight_ExclusiveMoment((FLAG)NIGHT_Laezel_Romance2_66c4c3b0-b608-46af-86b2-3e3dd4e44f5b);
DB_CampNight_ExclusiveMoment((FLAG)NIGHT_Laezel_Romance2_Karlach_be83bf66-7298-42b2-8e80-9df60ad00989);
DB_CampNight_ExclusiveMoment((FLAG)NIGHT_Laezel_Romance2_SkippedRomance1_242309e0-a758-44b4-85cc-90fc24986df9);
DB_BUGFIX_Marker("GUS-303514");
//END_REGION

//REGION GUS-308109

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LoopEffect(_Character,_,_,_,VFX_UI_ExclamationMark_01_a3018cf0-3a25-06ee-206a-3dd079332d80,_,_)
AND
IsTagged(_Character,HAS_EXCLAMATION_DIALOG_e45ea222-a86f-4e00-a1ca-98d8b258b1ce,0)
THEN
SetTag(_Character,HAS_EXCLAMATION_DIALOG_e45ea222-a86f-4e00-a1ca-98d8b258b1ce);

//END_REGION GUS-308109

//REGION GUS-300825
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCOMPANION_9c5bc0ce-cb2e-4685-b597-89a290837535, (FLAG)ORI_Laezel_State_DiscussedOrpheusAfterIntermezzo_be2155c2-1e8d-4c74-9b15-567bd1bcfcfc);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCAMP_3a157c66-db4a-48ad-95e5-9659c42c4aa0, (FLAG)ORI_Laezel_State_DiscussedOrpheusAfterIntermezzo_be2155c2-1e8d-4c74-9b15-567bd1bcfcfc);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCOMPANION_9c5bc0ce-cb2e-4685-b597-89a290837535, (FLAG)WYR_RaphaelTango_Event_BeganSoloScene_1048973a-9ed0-89e5-ce68-11e03fafc22c);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCAMP_3a157c66-db4a-48ad-95e5-9659c42c4aa0, (FLAG)WYR_RaphaelTango_Event_BeganSoloScene_1048973a-9ed0-89e5-ce68-11e03fafc22c);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCOMPANION_9c5bc0ce-cb2e-4685-b597-89a290837535, (FLAG)GLO_Orpheus_Knows_OrphicHammerIsTheKey_980541fb-1483-ea1a-3387-64405eace9a2);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCAMP_3a157c66-db4a-48ad-95e5-9659c42c4aa0, (FLAG)GLO_Orpheus_Knows_OrphicHammerIsTheKey_980541fb-1483-ea1a-3387-64405eace9a2);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCOMPANION_9c5bc0ce-cb2e-4685-b597-89a290837535, (FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCAMP_3a157c66-db4a-48ad-95e5-9659c42c4aa0, (FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e);
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCOMPANION_9c5bc0ce-cb2e-4685-b597-89a290837535);
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_VlaakithVisit_254a4c0b-9fd2-4b41-97e9-5f60e338e062, (FLAG)LAEZELCAMP_3a157c66-db4a-48ad-95e5-9659c42c4aa0);
DB_ORI_Laezel_QuestPriorityStepList(3700, "ORI_COM_Laezel", "VlaakithVisited_TalkToLaezelAboutOrpheus_FinishedIntermezzo_OrpheusPath");
DB_ORI_Laezel_QuestPriorityStepList(3700, "ORI_COM_Laezel", "VlaakithVisited_TalkToLaezelAboutOrpheus_FinishedIntermezzo_VlaakithPath");
DB_BUGFIX_Marker("GUS-300825");
//END_REGION

//REGION GUS-308002

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","SCL_Main_A","GUS-308002_SCL");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","BGO_Main_A","GUS-308002_BGO");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-308002_CTY");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-308002_SCL")
THEN
DB_AutoSaveTrigger((TRIGGER)S_SHA_Autosave_Mausoleum_1c06684a-c3c4-4237-bcd5-d01753870cb3);
DB_AutoSaveTrigger((TRIGGER)S_MOO_Autosave_UpperFloorTrespass_c2588bb4-7731-413d-84de-4fc18a215228);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A","GUS-308002_BGO")
THEN
DB_AutoSaveTrigger((TRIGGER)S_WYR_SouthSpanCheckpoint_Beyond_Autosave_bc8b187f-6b8e-470d-a25b-df727389a67c);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-308002_CTY")
THEN
DB_AutoSaveTrigger((TRIGGER)LOW_AutoSave_HagCellar_b14320a8-1be4-47dd-a362-adff7a9ece3e);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
THEN
DB_OnlyOnce("LOW_CrownController_Gortash_AutoSave");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
DB_OnlyOnce("LOW_CrownController_Orin_AutoSave");

//END_REGION GUS-308002

//REGION GUS-306506
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_CRIME_GuardKiller(_, _Killer, _, _, _, _, _)
AND
NOT DB_BUGFIX_Marker("GUS-306506")
THEN
DB_BUGFIX_Marker("GUS-306506");
PROC_GLO_Bugfix_306506();

PROC
PROC_GLO_Bugfix_306506()
AND
DB_CRIME_GuardKiller(_,_Killer,_,_Region,_,_GuardFaction,_)
AND
NOT QRY_CRIME_GuardKillerNeedsToBeReported(_Killer, _GuardFaction)
THEN
PROC_CRIME_Guards_MakePeace((STRING)_Region, "");
//END_REGION

//REGION GUS-299218
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)ORI_Laezel_State_CanProceedToAct3_64850ffe-e278-4742-91f2-3cecd77d1257, (DIALOGRESOURCE)GLO_Laezel_WRD_ProgressInAct2WithoutCreche_aa6fdbc8-6a7f-dd46-4a6f-366e36eeb4ab);
DB_BUGFIX_Marker("GUS-299218");

//END_REGION

//END_REGION Post-release patches

//REGION GUS-305058
// After night is done, reset night.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag(NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54)
AND
NOT DB_GlobalFlag(GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc) //If the deal was actually made, let's pretend Gale complained at the appropriate time.
THEN
DB_BUGFIX_Marker("GUS-305058");
PROC_SavegamePatch_GUS305058_ResetNight();

// During night, reset CRD
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_SignedContract_bdc786ed-fa49-abf3-407e-b94bfab30b3c);
PROC_CampNight_ClearCampNight((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54);
NOT DB_CampNight_Completed((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54);
NOT DB_Camp_QueuedNight((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54);
DB_BUGFIX_Marker("GUS-305058");
PROC_SavegamePatch_GUS305058_ResetNight();

// Fix flag requirements
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Gale_BrainHasCrownOfKarsus_FromRaphael_91ee6123-9e14-4b61-b099-94e41b3c502b, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc, (FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff);
DB_CampNight_Requirement((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc, (FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff);

PROC
PROC_SavegamePatch_GUS305058_ResetNight()
THEN
ClearFlag(NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54);
DB_CampNight((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, 4210);
DB_CampNight_Camp((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, "FARM");
DB_CampNight_Camp((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, "ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, (FLAG)GALECOMPANION_53fe9349-fc4e-433f-8701-e0aabb414906, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc, (FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff);
DB_CampNight_CancelledBy(NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, (FLAG)HoH_Warlock_State_ContractDestroyed_528a9080-f162-4a8c-bcc7-120db8fbd63f);
DB_CampNight_CancelledBy(NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, (FLAG)ORI_Gale_State_ComplainedContract_6b53fe80-58bd-9f22-d75c-e4b98e7388f8);
DB_CampNight_CRD((FLAG)NIGHT_Gale_SignedContract_bf86bdc1-2ce5-489a-bf36-1344806e4c54, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_SignedContract_bdc786ed-fa49-abf3-407e-b94bfab30b3c);
NOT DB_RelationshipDialogsFinished((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_SignedContract_bdc786ed-fa49-abf3-407e-b94bfab30b3c);


//END_REGION

//REGION GUS-308727

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_PartOfTheTeam(_Character)
THEN
IterateInventoryByTemplate(_Character, UNI_DEN_StaffOfRain_28b38ae1-8d66-4d8e-a4f0-5d4c6c342c59, "ORI_Gale_GUS-308727", "ORI_Gale_GUS-308727_END");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
TimerLaunch("SavegamePatch_GUS-308727_CampChestTimer", 5000);

IF
TimerFinished("SavegamePatch_GUS-308727_CampChestTimer")
AND
DB_Camp_UserCampChest(_, _Chest)
THEN
IterateInventoryByTemplate(_Chest, UNI_DEN_StaffOfRain_28b38ae1-8d66-4d8e-a4f0-5d4c6c342c59, "ORI_Gale_GUS-308727", "ORI_Gale_GUS-308727_END");

IF
EntityEvent(_Staff, "ORI_Gale_GUS-308727")
THEN
RemoveStatus(_Staff, "ORI_GALE_CONSUMABLE", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-308727", _Staff);

//END_REGION

//REGION GUS-306027

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3 Hotfix 2")
THEN
DB_BUGFIX_306027_Roots(CONT_GEN_Keychain_ee329627-dbee-405f-b9a6-b260de9ad34c);
DB_BUGFIX_306027_Roots(CONT_GEN_AlchemyPouch_b7543ff4-5010-4c01-9bcd-4da1047aebfc);
DB_BUGFIX_306027_Roots(CONT_GEN_CampSupplySack_efcb70b7-868b-4214-968a-e23f6ad586bc);
DB_BUGFIX_Marker("GUS-306027");

IF
DB_BUGFIX_Marker("GUS-306027")
AND
DB_Players(_Player)
AND
NOT DB_BUGFIX_306027_Fixed_Player(_Player)
THEN
PROC_BUGFIX_306027_Fix(_Player);
DB_BUGFIX_306027_Fixed_Player(_Player);

PROC
PROC_BUGFIX_306027_Fix((CHARACTER)_Player)
AND
DB_BUGFIX_306027_Roots(_Root)
THEN
IterateInventoryByTemplate(_Player, _Root, "BUGFIX_306027_Found", "BUGFIX_306027_End");

IF
EntityEvent(_Object, "BUGFIX_306027_Found")
THEN
DB_BUGFIX_306027_Fixed(_Object);
SetStoryItem((ITEM)_Object, 0);

IF
TemplateAddedTo(_Root, _Object,  _Player, _)
AND
DB_BUGFIX_306027_Roots(_Root)
AND
DB_BUGFIX_Marker("GUS-306027")
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_BUGFIX_306027_Fixed(_Object)
THEN
DB_BUGFIX_306027_Fixed(_Object);
SetStoryItem((ITEM)_Object, 0);

//END_REGION

//REGION GUS-307246
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_BUGFIX_Marker("GUS-307246");
DB_ORI_Karlach_ForgingOfTheHeart_InfernalIrons("CTY_Main_A", (ITEM)S_LOW_InfernalPlate_000_d760af79-fd44-4516-81c3-02e599c9bfe0); // At the Guild Smugglers crate.
DB_ORI_Karlach_ForgingOfTheHeart_InfernalIrons("CTY_Main_A", (ITEM)S_LOW_InfernalPlate_001_7eb7e570-a5f7-4630-be02-8ae107fc02c5); // At the warehouse basement
//END_REGION GUS-307246

//REGION GUS-306921
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_QuestDef_State((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, "GLO_GatherYourAllies", "LordAstarionPromisesSupport")
THEN
DB_BUGFIX_Marker("GUS-306921");
NOT DB_QuestDef_State((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, "GLO_GatherYourAllies", "LordAstarionPromisesSupport");
NOT DB_QuestDef_State((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, "GLO_GatherYourAllies", "ShadowheartPromisesSupport");
//END_REGION

//REGION GUS-310349
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_Avatars(_Avatar)
THEN
DB_Tadpole_TadpoleBurstException(_Avatar);
//END_REGION

//REGION GUS-306804
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,4,0,0)	//code fix will only be in patch 4. Checking version because of integrates
AND
DB_PartOfTheTeam(_Member)
AND
GetAnubisConfig(_Member,"")
AND
IsInInventory(_Member,_InvState)
THEN
DB_GUS306804_PartyMembersToRestore(_Member,_InvState);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,4,0,0)
THEN
DB_GUS306804_RestoreAnubisConfigs(1);

PROC
PROC_ApplySavegamePatches()
AND
DB_GUS306804_RestoreAnubisConfigs(1)
THEN
DB_GUS306804_AnubisConfigs((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,"ORI_Astarion");
DB_GUS306804_AnubisConfigs(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,"ORI_Gale");
DB_GUS306804_AnubisConfigs(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,"ORI_Karlach_PostEA");
DB_GUS306804_AnubisConfigs(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"GLO_ShadowHeart");
DB_GUS306804_AnubisConfigs(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,"ORI_Wyll");
DB_GUS306804_AnubisConfigs(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,"ORI_Minsc");
DB_GUS306804_AnubisConfigs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "GLO_DrowCommander_Act2_2");
PROC_GUS306804_RestoreAnubisConfigs();

//for patch4 we don't have to do runtime script checks to restore configs.
PROC
PROC_ApplySavegamePatches()
AND
DB_BG3Version(_Major,_Minor,_Revision,_Build)
AND
NOT QRY_VersionIsOlderThan(_Major,_Minor,_Revision,_Build,4,4,0,0)
THEN
NOT DB_GUS306804_RestoreAnubisConfigs(1);

PROC
PROC_GUS306804_RestoreAnubisConfigs()
AND
DB_CurrentLevel("CRE_Main_A")
THEN
NOT DB_GUS306804_AnubisConfigs(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,"ORI_Laezel");
DB_GUS306804_AnubisConfigs(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,"ORI_Laezel_Act1b");

PROC
PROC_GUS306804_RestoreAnubisConfigs()
AND
NOT DB_CurrentLevel("CRE_Main_A")
THEN
NOT DB_GUS306804_AnubisConfigs(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,"ORI_Laezel_Act1b");
DB_GUS306804_AnubisConfigs(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,"ORI_Laezel");

PROC
PROC_GUS306804_RestoreAnubisConfigs()
AND
DB_GUS306804_PartyMembersToRestore(_Member, 0)
THEN
PROC_GUS306804_RestoreAnubisConfig(_Member);

IF
AddedTo((CHARACTER)_Character,_,_)
AND
DB_PartOfTheTeam(_Character)
AND
DB_GUS306804_RestoreAnubisConfigs(1)
THEN
DB_GUS306804_PartyMembersToRestore(_Character, 1);

IF
RemovedFrom((CHARACTER)_Member,_)
AND
DB_GUS306804_PartyMembersToRestore(_Member, 1)
THEN
NOT DB_GUS306804_PartyMembersToRestore(_Member, 1);
DB_GUS306804_PartyMembersToRestore(_Member, 0);
PROC_GUS306804_RestoreAnubisConfig(_Member);

PROC
PROC_GUS306804_RestoreAnubisConfig((CHARACTER)_Member)
AND
DB_GUS306804_AnubisConfigs(_Member,_Config)
THEN
DEV_EnableAnubis(_Member,_Config);
NOT DB_GUS306804_PartyMembersToRestore(_Member, 0);
DB_BUGFIX_Marker("GUS-306804",_Member);

PROC
PROC_GUS306804_RestoreAnubisConfig(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_CurrentLevel("WLD_Main_A")
THEN
DEV_EnableAnubis(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,"GLO_Halsin_Act2");
NOT DB_GUS306804_PartyMembersToRestore(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0);
DB_BUGFIX_Marker("GUS-306804",S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);

PROC
PROC_GUS306804_RestoreAnubisConfig(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_GUS306804_PartyMembersToRestore(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0)
AND
DB_LevelLoadedOnce("WLD_Main_A")
THEN
DEV_EnableAnubis(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,"GLO_Halsin_Act1");
NOT DB_GUS306804_PartyMembersToRestore(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0);
DB_BUGFIX_Marker("GUS-306804",S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);

PROC
PROC_GUS306804_RestoreAnubisConfig(_Member)
AND
DB_GUS306804_PartyMembersToRestore(_Member, 0)
THEN
DEV_EnableAnubis(_Member,"DefaultCharacter");
NOT DB_GUS306804_PartyMembersToRestore(_Member, 0);
DB_BUGFIX_Marker("GUS-306804",_Member);
//END_REGION

//REGION GUS-319142
PROC
PROC_ApplySavegamePatches()
AND
DB_Avatars(_Character)
AND
NOT DB_Origins(_Character)
AND
GetAnubisConfig(_Character, "")
AND
IsInInventory(_Character,0)
THEN
DB_BUGFIX_Marker("GUS-319142 Reset Anubis Config on a Tavatar",_Character);
PROC_SetAnubisConfig(_Character, "DefaultCharacter");

IF
RemovedFrom(_Character,_)
AND
DB_Avatars((CHARACTER)_Character)
AND
NOT DB_Origins(_Character)
AND
GetAnubisConfig(_Character, "")
AND
IsInInventory(_Character,0)
THEN
DB_BUGFIX_Marker("GUS-319142 Reset Anubis Config on a Tavatar",_Character);
PROC_SetAnubisConfig(_Character, "DefaultCharacter");
//END_REGION

//REGION GUS-305930
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_ORI_Minthara_DiscussedTeamFlags(_, _)
THEN
DB_ORI_Minthara_DiscussedTeamFlags((FLAG)ORI_Minthara_Asked_AboutAstarion_04752cc3-e93d-2ee1-167d-be67617ddcec, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_ORI_Minthara_DiscussedTeamFlags((FLAG)ORI_Minthara_Asked_AboutGale_14f0b219-9190-7e6a-d7d9-941348a2e4a8, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_ORI_Minthara_DiscussedTeamFlags((FLAG)ORI_Minthara_Asked_AboutJaheira_e3a47bf5-af86-d32e-58d8-f391bef3a233, (CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_ORI_Minthara_DiscussedTeamFlags((FLAG)ORI_Minthara_Asked_AboutKarlach_5eaf5548-594e-7423-7255-8f48d0500212, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_ORI_Minthara_DiscussedTeamFlags((FLAG)ORI_Minthara_Asked_AboutMinsc_9854165f-5093-d68c-1213-d311db131e1a, (CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
DB_ORI_Minthara_DiscussedTeamFlags((FLAG)ORI_Minthara_Asked_AboutLaezel_3e23b7be-6ff7-2331-2861-d5b4f0a7cfcb, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
DB_ORI_Minthara_DiscussedTeamFlags((FLAG)ORI_Minthara_Asked_AboutShadowheart_faa6017f-ed6d-8e73-aeea-8412dc38c357, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_ORI_Minthara_DiscussedTeamFlags((FLAG)ORI_Minthara_Asked_AboutWyll_b327e6ea-0532-2a7a-bfcd-3f8ea990f491, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
//END_REGION

//REGION GUS-318361

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_BlockDismissable_IgnoreDialog(_Player)
AND
NOT DB_InDangerZone(_Player,_)
AND
NOT DB_PartyDialogSuppressed(_Player,_)
AND
NOT DB_FastTravelBlock_BlockedZone_StatusSet(_Player)
AND
NOT DB_Is_EngineBlock_Move(_Player)
AND
NOT DB_Defeated(_Player)
AND
NOT DB_Is_EngineBlock_Talk(_Player)
AND
NOT DB_Is_InCombat(_Player, _)
AND
NOT DB_FastTravelBlock_Arrested_StatusSet(_Player)
AND
NOT DB_FastTravelBlock_FugitiveInPrison_StatusSet(_Player, _)
AND
NOT DB_CantTalk_IgnoreDialogsCombatStatusesDead(_Player)
THEN
NOT DB_BlockDismissable_IgnoreDialog(_Player);
DB_BUGFIX_Marker("GUS-318361");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_BUGFIX_Marker("GUS-318361")
AND
DB_DialogName(_Dialog, _ID)
AND
DB_GLO_CompanionSwapDialogue(_Dialog)
THEN
DB_BUGFIX_Marker("GUS-318361", _Dialog, _ID);
PROC_PartyMemberKickFromPartyFlags_Update(_ID);

//END_REGION

//REGION GUS-308248
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)GLO_ForgingOfTheHeart_Event_ToldToGetMoreMetal_b2c0ae25-b3d7-eea3-7468-4283334e9b6c)
AND
NOT DB_GlobalFlag((FLAG)GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c)
AND
NOT QRY_ORI_Karlach_HasForgingOfTheHeartUpdate("FindInfernalMetal_SecondUpgrade_Act2")
THEN
DB_BUGFIX_GUS308248_TryUpdateAct2FindMoreInfernalMetal(1);

IF
DB_BUGFIX_GUS308248_TryUpdateAct2FindMoreInfernalMetal(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
NOT DB_BUGFIX_GUS308248_TryUpdateAct2FindMoreInfernalMetal(1);
PROC_GLO_Bugfix_308248();

PROC
PROC_GLO_Bugfix_308248()
AND
NOT DB_PermaDefeated(S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79)
AND
GetFlag((FLAG)GLO_ForgingOfTheHeart_State_DammonInAct2_13d137f7-44ec-4217-8254-42691f3a8f63, S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, 1)
THEN
DB_BUGFIX_Marker("GUS-308248");
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindInfernalMetal_SecondUpgrade");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag((FLAG)ORI_Karlach_State_ToldKarlachAboutDammon_f2afec2f-95fb-a1c9-2976-9fb798144226)
AND
NOT DB_GlobalFlag((FLAG)PLA_KarlachRecruitment_State_DammonUnavailable_96af4ae3-496d-497f-afb5-fec042fe6f27)
AND
DB_GlobalFlag((FLAG)PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375)
AND
QRY_OnlyOnce("ORI_Karlach_Journal_ForgingOfTheHeartUpdated")
THEN
DB_BUGFIX_Marker("GUS-308248");
PROC_ORI_Karlach_UpdateJournal("ForgingOfTheHeart_KnowsDammon"); // Companion version

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag((FLAG)ORI_Karlach_State_ToldKarlachAboutDammon_f2afec2f-95fb-a1c9-2976-9fb798144226)
AND
NOT DB_GlobalFlag((FLAG)PLA_KarlachRecruitment_State_DammonUnavailable_96af4ae3-496d-497f-afb5-fec042fe6f27)
AND
NOT DB_GlobalFlag((FLAG)PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375)
AND
QRY_OnlyOnce("ORI_Karlach_Journal_ForgingOfTheHeartUpdated")
THEN
DB_BUGFIX_Marker("GUS-308248");
PROC_ORI_Karlach_UpdateJournal("ForgingOfTheHeart_KnowsDammon_BeforePaladins"); // Companion version

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag((FLAG)ORI_Karlach_State_InSearchOfMechanic_9943b467-dff2-4a15-abbc-e380e0b8f794)
AND
NOT DB_GlobalFlag((FLAG)PLA_KarlachRecruitment_State_DammonUnavailable_96af4ae3-496d-497f-afb5-fec042fe6f27)
AND
DB_GlobalFlag((FLAG)PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375)
AND
QRY_OnlyOnce("ORI_Karlach_Journal_ForgingOfTheHeartUpdated")
THEN
DB_BUGFIX_Marker("GUS-308248");
PROC_ORI_Karlach_UpdateJournal("ForgingOfTheHeart_DoesNotKnowDammon"); // Companion version

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag((FLAG)ORI_Karlach_State_InSearchOfMechanic_9943b467-dff2-4a15-abbc-e380e0b8f794)
AND
NOT DB_GlobalFlag((FLAG)PLA_KarlachRecruitment_State_DammonUnavailable_96af4ae3-496d-497f-afb5-fec042fe6f27)
AND
NOT DB_GlobalFlag((FLAG)PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375)
AND
QRY_OnlyOnce("ORI_Karlach_Journal_ForgingOfTheHeartUpdated")
THEN
DB_BUGFIX_Marker("GUS-308248");
PROC_ORI_Karlach_UpdateJournal("ForgingOfTheHeart_DoesNotKnowDammon_BeforePaladins"); // Companion version

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
QRY_ORI_Karlach_HasForgingOfTheHeartUpdate("FindInfernalMetal_FirstUpgrade")
AND
QRY_OnlyOnce("ORI_Karlach_Journal_ForgingOfTheHeartUpdated")
THEN
DB_BUGFIX_Marker("GUS-308248");
PROC_ORI_Karlach_UpdateJournal("ForgingOfTheHeart"); // Avatar version

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
QRY_ORI_Karlach_HasForgingOfTheHeartUpdate("FindInfernalMetal_FirstUpgrade")
AND
DB_GlobalFlag((FLAG)PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375)
AND
QRY_OnlyOnce("ORI_Karlach_Journal_ForgingOfTheHeartUpdated")
THEN
DB_BUGFIX_Marker("GUS-308248");
PROC_ORI_Karlach_UpdateJournal("ForgingOfTheHeart_KnowsDammon"); // Companion version

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
QRY_ORI_Karlach_HasForgingOfTheHeartUpdate("FindInfernalMetal_FirstUpgrade")
AND
NOT DB_GlobalFlag((FLAG)PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375)
AND
QRY_OnlyOnce("ORI_Karlach_Journal_ForgingOfTheHeartUpdated")
THEN
DB_BUGFIX_Marker("GUS-308248");
PROC_ORI_Karlach_UpdateJournal("ForgingOfTheHeart_KnowsDammon_BeforePaladins"); // Companion version

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_QuestDef_ChainedState("ORI_Avatar_Karlach", "FindInfernalMetal_FirstUpgrade", "ForgingOfTheHeart")
THEN
DB_BUGFIX_Marker("GUS-308248");
DB_QuestDef_ChainedState("ORI_Avatar_Karlach", "FindInfernalMetal_FirstUpgrade", "ForgingOfTheHeart");
//END_REGION GUS-308248

//REGION GUS-306450
// Delayed requeueing would unregister without cleaning up the DBs
// Rather than trying to restore everything, just clean up properly
// (will at most result in some NPCs not self-healing or picking up their weapon
//  after a combat that was previously finished)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Disturbance_PerformWhenAvailable_DelayedRequeue(_NPC,_DisturbanceType,_Evidence,_Victim)
AND
NOT DB_RegisteredLevelObjects("GEB_PerformWhenAvailable",_,_NPC)
THEN
NOT DB_Disturbance_PerformWhenAvailable_DelayedRequeue(_NPC,_DisturbanceType,_Evidence,_Victim);
NOT DB_Disturbance_PerformWhenAvailable_CurrentLevel(_NPC);
DB_BUGFIX_Marker("GUS-308248f1",_NPC);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Disturbance_PerformWhenAvailable_Queued(_NPC,_DisturbanceType,_Evidence,_Victim,_Delay)
AND
NOT DB_RegisteredLevelObjects("GEB_PerformWhenAvailable",_,_NPC)
THEN
NOT DB_Disturbance_PerformWhenAvailable_Queued(_NPC,_DisturbanceType,_Evidence,_Victim,_Delay);
NOT DB_Disturbance_PerformWhenAvailable_CurrentLevel(_NPC);
DB_BUGFIX_Marker("GUS-308248f2",_NPC);

// Add new TryCount DB for existing entries
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Disturbance_PerformWhenAvailable_Queued(_NPC,_DisturbanceType,_Evidence,_Victim,_Delay)
AND
NOT DB_Disturbance_PerformWhenAvailable_TryCount(_NPC,_DisturbanceType,_Evidence,_Victim,_)
THEN
DB_Disturbance_PerformWhenAvailable_TryCount(_NPC,_DisturbanceType,_Evidence,_Victim,0);
DB_BUGFIX_Marker("GUS-308248a",_NPC);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Disturbance_PerformWhenAvailable_DelayedRequeue(_NPC,_DisturbanceType,_Evidence,_Victim)
AND
NOT DB_Disturbance_PerformWhenAvailable_TryCount(_NPC,_DisturbanceType,_Evidence,_Victim,_)
THEN
DB_Disturbance_PerformWhenAvailable_TryCount(_NPC,_DisturbanceType,_Evidence,_Victim,1);
DB_BUGFIX_Marker("GUS-308248b",_NPC);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Disturbance_PerformWhenAvailable_Starting(_NPC,_DisturbanceType,_Evidence,_Victim,_)
AND
NOT DB_Disturbance_PerformWhenAvailable_TryCount(_NPC,_DisturbanceType,_Evidence,_Victim,_)
THEN
DB_Disturbance_PerformWhenAvailable_TryCount(_NPC,_DisturbanceType,_Evidence,_Victim,0);
DB_BUGFIX_Marker("GUS-308248c",_NPC);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Disturbance_PerformWhenAvailable_Ongoing(_NPC,_DisturbanceType,_Evidence,_Victim,_,_)
AND
NOT DB_Disturbance_PerformWhenAvailable_TryCount(_NPC,_DisturbanceType,_Evidence,_Victim,_)
THEN
DB_Disturbance_PerformWhenAvailable_TryCount(_NPC,_DisturbanceType,_Evidence,_Victim,0);
DB_BUGFIX_Marker("GUS-308248d",_NPC);

// Clean up stuck DB_Disturbance_PerformWhenAvailable_CurrentLevel DB
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_BUGFIX_Marker("GUS-308248e")
AND
DB_CurrentLevel(_Level)
AND
// Gets cleared on level swap, so guaranteed no NPCs from previous levels left
// But ones in current level may have teleported out
DB_Disturbance_PerformWhenAvailable_CurrentLevel((CHARACTER)_NPC)
AND
NOT GetRegion(_NPC,_Level)
THEN
PROC_Disturbance_PerformWhenAvailable_MaybeCleanup(_NPC);
DB_BUGFIX_Marker("GUS-308248e",_NPC);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_BUGFIX_Marker("GUS-308248e")
THEN
DB_BUGFIX_Marker("GUS-308248e");

// Fix non-incapacitated statuses ending up in DB_Disturbance_PerformWhenAvailable_Incapacitated
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Disturbance_PerformWhenAvailable_Incapacitated((GUIDSTRING)_Object,_Status)
AND
NOT QRY_IsStatusUnconsciousOrEquivalent(_Status)
THEN
NOT DB_Disturbance_PerformWhenAvailable_Incapacitated((GUIDSTRING)_Object,_Status);
//END_REGION


//REGION GUS-307868
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_BUGFIX_Marker("GUS-307868");
DB_CrimeAttitudeChange("Steal_NoCrimescene",-5);
DB_LinkedCrimes("Steal", "Steal_NoCrimescene");
//END_REGION

//REGION GUS-307760
// As this is rather minor improvement, we just prevent disappearance of masked victims due to KNOCK_OUT in case it hasn't already happened
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","WLD_Main_A","GUS-307760");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-307650");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-307760")
AND
DB_HAG_MaskedVictims(_Victim, _, _, _)
AND
NOT DB_PermaDefeated(_Victim)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
DB_ForceTemporaryKnockedOut(_Victim);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-307650")
AND
DB_HAG_MaskedVictims(_Victim, _, _, _)
AND
NOT DB_PermaDefeated(_Victim)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
THEN
DB_ForceTemporaryKnockedOut(_Victim);
//END_REGION

//REGION GUS-307629
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_BUGFIX_Marker("GUS-307629");
PROC_GLO_Bugfix_307629();

PROC
PROC_GLO_Bugfix_307629()
AND
DB_PlayerSummons(_Summon)
THEN
BlockNewCrimeReactions(_Summon, 1);

// combat already started and the player saved the game
// trespassing crimes only
PROC
PROC_GLO_Bugfix_307629()
AND
DB_GLO_Combat_TemporaryHostile(_Summon)
AND
DB_CAMP_WalkingToCamp(_SummonOwner)
AND
CharacterGetOwner((CHARACTER)_Summon, (CHARACTER)_SummonOwner)
AND
DB_Is_InCombat(_Summon, _CombatID)
AND
DB_CRIME_RecheckOnFastTravel_Criminals(_CrimeID, _Criminal)
AND
DB_Is_InCombat(_Criminal, _CombatID)
AND
CrimeGetType(_CrimeID, _CrimeType)
AND
QRY_CRIME_IsCrimeFamilyMember(_CrimeType, "Trespassing")
THEN
PROC_GLO_Bugfix_307629_StopCombat(_CombatID);

PROC
PROC_GLO_Bugfix_307629_StopCombat((GUIDSTRING)_CombatID)
AND
DB_Is_InCombat(_Char, _CombatID)
AND
HasActiveStatus(_Char, "TEMPORARILY_HOSTILE", 1)
THEN
LeaveCombat(_Char);
//END_REGION

//REGION GUS-308939
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_BUGFIX_Marker("GUS-308939");
NOT DB_GLO_LevelTraveler((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "SCL_Main_A", "ORI_Karlach_PostEA");
NOT DB_GLO_LevelTraveler((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "BGO_Main_A", "ORI_Karlach_PostEA");
NOT DB_GLO_LevelTraveler((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "CTY_Main_A", "ORI_Karlach_PostEA");
NOT DB_GLO_LevelTraveler((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "END_Main", "ORI_Karlach_PostEA");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
NOT DB_LevelLoadedOnce("EPI_Main_A")
THEN
PROC_SetAnubisConfig(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_Karlach_CampFix");
//END_REGION GUS-308939

//REGION GUS-309596

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
THEN
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_LearnSpell_393b05ff-d866-4115-8ece-872232ce44cf, (FLAG)ORI_Gale_State_TriedSpellteachingDuringParty_0530eacc-9c25-4f22-8a1a-b45bd94a7ed6);
NOT DB_CampNight_Requirement(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3, (FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121, (FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735);
DB_CampNight_Requirement(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3, (FLAG)NIGHT_GoblinHunt_TieflingCelebration_1ad8c357-2695-4d5c-b5f9-8b8c07803121, (FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735, (FLAG)ORI_Gale_State_ControlledByRomanceFallbackCandidate_d2a59d18-92fe-4a2c-b629-674b825ae56c);
NOT DB_CampNight_Requirement_Approval(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 30);
DB_CampNight_Requirement_Approval(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 35);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_Avatars(_Avatar)
AND
GetFlag((FLAG)CAMP_GoblinHunt_State_GalePartner_e36781b6-f9aa-b822-1e47-8944274190b4, _Avatar, 1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Gale_State_TriedSpellteachingDuringParty_0530eacc-9c25-4f22-8a1a-b45bd94a7ed6);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_Avatars(_Avatar)
AND
GetFlag((FLAG)CAMP_GoblinHunt_State_GaleAdditionalPartner_4e06a14a-b5db-9b92-4b21-7160ee3b0a50, _Avatar, 1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Gale_State_TriedSpellteachingDuringParty_0530eacc-9c25-4f22-8a1a-b45bd94a7ed6);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_Camp_QueuedNight(NIGHT_Gale_DatingStartFallback_0f359d48-14f4-4cfc-bbc9-22ecbfe026c3)
AND
NOT QRY_ORI_Gale_RomanceFallback()
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)CAMP_GoblinHuntTieflingCelebration_CRD_Gale3b_a65afd51-538b-3b92-e09a-ea0bb06c36cb,(FLAG)NULL_00000000-0000-0000-0000-000000000000, _, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)CAMP_GoblinHuntTieflingCelebration_CRD_Gale3b_a65afd51-538b-3b92-e09a-ea0bb06c36cb,(FLAG)NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_Camp_QueuedNight(NIGHT_Gale_LearnSpell_393b05ff-d866-4115-8ece-872232ce44cf)
AND
DB_GlobalFlag(ORI_Gale_State_TriedSpellteachingDuringParty_0530eacc-9c25-4f22-8a1a-b45bd94a7ed6)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)CAMP_Gale_CRD_SpellTeaching_4d0a0d4e-0812-98c1-f2a6-94013578ce97,(FLAG)NULL_00000000-0000-0000-0000-000000000000, _, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)CAMP_Gale_CRD_SpellTeaching_4d0a0d4e-0812-98c1-f2a6-94013578ce97,(FLAG)NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION GUS-316847

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Camp_SleepMomentsDone(_Player)
AND
NOT DB_Players(_Player)
THEN
NOT DB_Camp_SleepMomentsDone(_Player);
PROC_Camp_CheckSleepMomentsLoopDone();
DB_BUGFIX_Marker("GUS-316847");

//END_REGION GUS-316847

//REGION GUS-317829 Hireling was kicked while in dialogue (stayed stuck in dialogue, but not in party anymore)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_InteractiveDialogSpeaker(_, _Hireling)
AND
DB_Hirelings_Hired_Rehire(_Hireling)
AND
NOT DB_Hirelings_Hired((CHARACTER)_Hireling)
THEN
PROC_ForceStopDialog(_Hireling);
DB_BUGFIX_Marker("GUS-317829 Hireling was kicked while in dialogue (stayed stuck in dialogue, but not in party anymore)",_Hireling);
//END_REGION


//REGION
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3 Hotfix 3")
AND
DB_ORI_Dating(_Avatar, (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
GetApprovalRating((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Avatar, _Rating)
AND
_Rating > 39
THEN
SetFlag((FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8, _Avatar);
//END_REGION

//REGION
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_ORI_Minthara_KissPoisons(_)
THEN
DB_ORI_Minthara_KissPoisons("POISON_SIMPLE_CONDITION");
DB_ORI_Minthara_KissPoisons("ALCH_TOXIN_BASIC_CONDITION");
DB_ORI_Minthara_KissPoisons("ALCH_TOXIN_SERPENTVENOM_CONDITION");
DB_ORI_Minthara_KissPoisons("ALCH_TOXIN_WYVERN_CONDITION");
DB_ORI_Minthara_KissPoisons("ALCH_TOXIN_PURPLEWORM_CONDITION");
DB_ORI_Minthara_KissPoisons("POISON_DROW_CONDITION");
DB_ORI_Minthara_KissPoisons("POISON_CRAWLER_MUCUS_CONDITION");
DB_ORI_Minthara_KissPoisons("ALCH_TOXIN_BASIC_CONDITION");
DB_ORI_Minthara_KissPoisons("POISON_ASSASSINS_BLOOD_CONDITION");
//END_REGION

//REGION GUS-303364
// disabling a wrong-rootes mushroom
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-303364_CTY");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-303364_CTY")
AND
Exists(LOOT_Underdark_MushroomPieces_D_001_9e9a3311-fbe9-469e-9e6b-28c30e0e65a5, 1)
AND
IsInInventory(LOOT_Underdark_MushroomPieces_D_001_9e9a3311-fbe9-469e-9e6b-28c30e0e65a5, 0)
THEN
SetOnStage(LOOT_Underdark_MushroomPieces_D_001_9e9a3311-fbe9-469e-9e6b-28c30e0e65a5, 0);

// society of brilliance mushrooms
PROC
PROC_ApplySavegamePatches()
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_Tadpole", "AskedToDrink")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "WLD_Main_A", "GUS-303364_WLD");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-303364_WLD")
THEN
NOT DB_GiveTemplateFromPlayerDialogEvent(
	(ITEMROOT)UNI_UND_SocietyOfBrilliance_TimmaskSpore_8e2dd06c-c62f-4235-b0f8-f353c6b1ec9d,
	(FLAG)UND_SocietyOfBrilliance_Event_GiveMushrooms_62743a4d-28ee-4da3-a4cf-2347cd08ab24,
	(FLAG)UND_SocietyOfBrilliance_Event_GiveMushroomsSuccess_d5d178e9-eb29-4dfb-b761-d04ccf787c08,
	 1);
NOT DB_GiveTemplateFromPlayerDialogEvent(
	(ITEMROOT)UNI_UND_SocietyOfBrilliance_TongueOfMadness_714a8375-9eb4-438d-a191-f5b4b1e86cc3,
	(FLAG)UND_SocietyOfBrilliance_Event_GiveMushrooms_62743a4d-28ee-4da3-a4cf-2347cd08ab24,
	(FLAG)UND_SocietyOfBrilliance_Event_GiveMushroomsSuccess_d5d178e9-eb29-4dfb-b761-d04ccf787c08,
	 1);
DB_UND_SocietyOfBrilliance_MushroomsToFind((ROOT)ALCH_Extract_TongueOfMadness_50b5475a-7f63-45d5-8158-6cdc8c6de31c, "MadeExtract");
DB_UND_SocietyOfBrilliance_MushroomsToFind((ROOT)ALCH_Extract_MyconidSpore_Confusion_2ebad980-402d-4178-84dd-e41bb10155ce, "MadeExtract");
DB_UND_SocietyOfBrilliance_MushroomsToFind((ROOT)ALCH_Solution_Elixir_Tadpole_d44a454c-3a09-4b93-b982-79f7ee019703, "MadePotion");
DB_HasItemTemplateScriptFlag(3, (DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b, ALCH_Extract_MyconidSpore_Confusion_2ebad980-402d-4178-84dd-e41bb10155ce, 3, 1);
DB_HasItemTemplateScriptFlag(4, (DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b, ALCH_Extract_TongueOfMadness_50b5475a-7f63-45d5-8158-6cdc8c6de31c, 3, 1);
DB_HasItemTemplateScriptFlag(5, (DIALOGRESOURCE)UND_MyconidCircle_SocietyOfBrilliance_MindFlayer_f19b2530-4c10-e492-03a9-054c2db67c6b, ALCH_Solution_Elixir_Tadpole_d44a454c-3a09-4b93-b982-79f7ee019703, 3, 1);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-303364_WLD")
AND
DB_Players(_Player)
AND
DB_UND_SocietyOfBrilliance_MushroomsToFind(_Template, _StepUpdate)
AND
QRY_ItemTemplateInMagicPockets(_Player, (ITEMROOT)_Template)
THEN
QuestUpdate(_Player, "GLO_Tadpole", _StepUpdate);
//END_REGION GUS-303364

//REGION GUS-308437
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_HardcoreCharacter("WLD_Main_A",(CHARACTER)S_UND_AnimatedArmor_04_7946722f-4245-45ba-8a16-810f70131877,(CHARACTER)S_UND_Automaton_5038c0f2-0022-4699-82ce-a319b30616bb)
THEN
DB_HardcoreCharacter("WLD_Main_A",(CHARACTER)S_UND_AnimatedArmor_04_7946722f-4245-45ba-8a16-810f70131877,(CHARACTER)S_UND_Automaton_5038c0f2-0022-4699-82ce-a319b30616bb);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_HardcoreCharacter("WLD_Main_A",(CHARACTER)S_UND_AnimatedArmor_05_c9a4d8c3-0a1a-4d04-b2fd-38e542bf1b3c,(CHARACTER)S_UND_Automaton_5038c0f2-0022-4699-82ce-a319b30616bb)
THEN
DB_HardcoreCharacter("WLD_Main_A",(CHARACTER)S_UND_AnimatedArmor_05_c9a4d8c3-0a1a-4d04-b2fd-38e542bf1b3c,(CHARACTER)S_UND_Automaton_5038c0f2-0022-4699-82ce-a319b30616bb);
//END_REGION

//REGION GUS-304893
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
THEN
DB_GLO_GlobalItems_FacePaintsOverride("WYR_FACEPAINT_CLOWN", (TAG)DRAGONBORN_02e5e9ed-b6b2-4524-99cd-cb2bc84c754a, "80ba02f5-ce5b-4611-a745-1c9406e1d780");
DB_GLO_GlobalItems_FacePaintsOverride("GLO_PIXIECURSE", (TAG)DRAGONBORN_02e5e9ed-b6b2-4524-99cd-cb2bc84c754a, "67c4eed0-be5b-4e34-a9c1-bbd3fc88eccd");
DB_BUGFIX_Marker("GUS-304893");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_GLO_GlobalItems_FacePaintApplied(_Char, _FacePaint, _MaterialOverrideOld)
AND
DB_GLO_GlobalItems_FacePaintsOverride(_FacePaint, _Tag, _MaterialOverrideTagged)
AND
IsTagged(_Char, _Tag, 1)
THEN
PROC_GLO_GlobalItems_RemoveFacePaint(_Char, _FacePaint, _MaterialOverrideOld);
PROC_GLO_GlobalItems_ApplyMaterialOverride(_Char, _MaterialOverrideTagged);
DB_GLO_GlobalItems_FacePaintApplied(_Char, _FacePaint, _MaterialOverrideTagged);
//END_REGION GUS-304893

//REGION GUS-305364
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
NOT DB_Combat_NegativeAbilityScoreStatus("TAD_ABSORB_INTELLECT_1")
THEN
DB_Combat_NegativeAbilityScoreStatus("TAD_ABSORB_INTELLECT_1");
DB_Combat_NegativeAbilityScoreStatus("TAD_ABSORB_INTELLECT_2");
DB_Combat_NegativeAbilityScoreStatus("TAD_ABSORB_INTELLECT_3");
DB_Combat_NegativeAbilityScoreStatus("TAD_ABSORB_INTELLECT_4");
DB_Combat_NegativeAbilityScoreStatus("TAD_ABSORB_INTELLECT_5");
DB_Combat_NegativeAbilityScoreStatus("MF_ABSORB_INTELLECT_1");
DB_Combat_NegativeAbilityScoreStatus("MF_ABSORB_INTELLECT_2");
DB_Combat_NegativeAbilityScoreStatus("MF_ABSORB_INTELLECT_3");
DB_Combat_NegativeAbilityScoreStatus("MF_ABSORB_INTELLECT_4");
DB_Combat_NegativeAbilityScoreStatus("MF_ABSORB_INTELLECT_5");
DB_Combat_NegativeAbilityScoreStatus("DEVOURED_INT");
DB_Combat_NegativeAbilityScoreStatus("TREMBLINGFEET_ELEMENTAL_EARTH");
DB_Combat_NegativeAbilityScoreStatus("CURSEDTOME_THARCHIATE_CODEX");
DB_Combat_NegativeAbilityScoreStatus("INFECTIOUS_BITE_WOLF");
DB_Combat_NegativeAbilityScoreStatus("RAT_INFECTED");
DB_BUGFIX_Marker("GUS-305364");
//END_REGION GUS-305364

//REGION GUS-313608 Missing DB_Avatar on Character Created Player
PROC
PROC_ApplySavegamePatches()
AND
DB_Players(_Player)
AND
NOT DB_Avatars(_Player)
AND
IsTagged(_Player,(TAG)AVATAR_306b9b05-1057-4770-aa17-01af21acd650,1)
THEN
DB_Avatars(_Player);
DB_BUGFIX_Marker("GUS-313608-A Missing DB_Avatar on Character Created Player",_Player);

PROC
PROC_ApplySavegamePatches()
AND
DB_Camp_NightMode(1)
AND
DB_Players(_Player)
AND
NOT DB_FastTravelBlock_CampNightMode_StatusSet(_Player)
THEN
DB_FastTravelBlock_CampNightMode_StatusSet(_Player);
ApplyStatus(_Player,"TRAVELBLOCK_CAMPNIGHTMODE",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-313608-B Missing DB_FastTravelBlock_CampNightMode_StatusSet during Campnight",_Player);

PROC
PROC_ApplySavegamePatches()
AND
NOT DB_Camp_NightMode(1)
AND
DB_Players(_Player)
AND
DB_FastTravelBlock_CampNightMode_StatusSet(_Player)
THEN
NOT DB_FastTravelBlock_CampNightMode_StatusSet(_Player);
RemoveStatus(_Player,"TRAVELBLOCK_CAMPNIGHTMODE",NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-313608-C Removed DB_FastTravelBlock_CampNightMode_StatusSet that was active outside of Campnight",_Player);
//END_REGION

//REGION GUS-310053
//Adding headless karlach fix here for players who played the entire game with her headless version.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_GLO_HeadRemoval_HeadPicked((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
QRY_GLO_Bugfix_310053_KarlachIsInTeam()
THEN
DB_BUGFIX_Marker("GUS-310053");
TimerLaunch("GUS-310053_Fix", 100); // Using a timer for now to avoid bug in which Karlach stays in party with no valid user.

IF
TimerFinished("GUS-310053_Fix")
THEN
QuestUpdate("ORI_COM_Karlach", "ForgingOfTheHeart_KarlachPermanentlyDies");
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "Killed");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_GLO_HeadRemoval_HeadPicked((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
IsDead((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0)
THEN
DB_BUGFIX_Marker("GUS-310053");
Die(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

QRY
QRY_GLO_Bugfix_310053_KarlachIsInTeam()
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_NOOP(1);

QRY
QRY_GLO_Bugfix_310053_KarlachIsInTeam()
AND
DB_Players((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_NOOP(1);

QRY
QRY_GLO_Bugfix_310053_KarlachIsInTeam()
AND
DB_InCamp((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_NOOP(1);
//END_REGION GUS-310053

//REGION GUS-161494

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_BUGFIX_Marker("GUS-161494");
DB_IgnoreMutingStatussesDialog(GLO_PAD_TeleporterHole_Tiny_f339386b-8fdc-ff24-6a56-6ea1277aa284);
DB_IgnoreMutingStatussesDialog(GLO_PAD_TeleporterHole_Small_0095f76d-e360-607b-501a-dd9fcdccb24e);

//END_REGION

//REGION GUS-307948
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
DB_BUGFIX_Marker("GUS-307948");
DB_GLO_ThrallOfTheAbsolute_DangerZone("SCL_Main_A",(TRIGGER)S_SCL_ThrallOfTheAbsolute_DangerZone_f62e1c6c-ebdd-49d9-aaea-632f112c9f35, "SCL_ThrallOfTheAbsolute_DangerZone");
DB_GLO_ThrallOfTheAbsolute_DangerZone("INT_Main_A",(TRIGGER)S_INT_ThrallOfTheAbsolute_DangerZone_be4a4604-cdf2-4b8c-b3ad-7458ae39f0f2, "INT_ThrallOfTheAbsolute_DangerZone");
DB_GLO_ThrallOfTheAbsolute_DangerZone("BGO_Main_A",(TRIGGER)S_BGO_ThrallOfTheAbsolute_DangerZone_5d98df20-73a3-4417-88fe-276f6b068337, "BGO_ThrallOfTheAbsolute_DangerZone");
DB_GLO_ThrallOfTheAbsolute_DangerZone("CTY_Main_A",(TRIGGER)S_CTY_ThrallOfTheAbsolute_DangerZone_c663e577-5765-4694-9077-a8ec97d767d0, "CTY_ThrallOfTheAbsolute_DangerZone");
DB_GLO_ThrallOfTheAbsolute_DangerZone("END_Main",(TRIGGER)S_END_ThrallOfTheAbsolute_DangerZone_b2473b6b-4fd0-4527-90f5-ac41fc8c99a5, "END_ThrallOfTheAbsolute_DangerZone");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag(GLO_ThrallOfTheAbsolute_Event_TransformPlayers_fe6b74e7-fe16-4ec0-bdf1-101abf00e79d)
THEN
ClearFlag(GLO_ThrallOfTheAbsolute_Event_TransformPlayers_fe6b74e7-fe16-4ec0-bdf1-101abf00e79d);
PROC_BG3_SaveGamePatches_GUS_307948_RemoveMindFlayerForm();

PROC
PROC_BG3_SaveGamePatches_GUS_307948_RemoveMindFlayerForm()
AND
DB_PartOfTheTeam(_Player)
AND
NOT DB_END_General_PartyMindFlayer(_Player)
AND
HasAppliedStatus(_Player, "MIND_FLAYER_FORM", 1)
THEN
DB_BUGFIX_Marker("GUS-307948");
RemoveStatus(_Player, "MIND_FLAYER_FORM", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(_Player, "MF_MIND_SANCTUARY", NULL_00000000-0000-0000-0000-000000000000);
//END_REGION GUS-307948

//REGION GUS-169771

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_SeenDeadNPCPartyFlag(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(FLAG)HAG_Hagspawn_Knows_SurrogateMotherDefeated_8f4738c9-7877-86e4-316a-2447a949e136)
THEN
NOT DB_SeenDeadNPCPartyFlag(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(FLAG)HAG_Hagspawn_Knows_SurrogateMotherDefeated_8f4738c9-7877-86e4-316a-2447a949e136);
DB_SeenPermaDefeatedNPCPartyFlag(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(FLAG)HAG_Hagspawn_Knows_SurrogateMotherDefeated_8f4738c9-7877-86e4-316a-2447a949e136);
DB_BUGFIX_Marker("GUS-169771_SeenDatabases");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_SeenDeadNPCGlobalFlag((CHARACTER)S_LOW_Tolna_46aa02d8-28e9-4ebb-876c-82fe29262d35, (FLAG)LOW_Tolna_Knows_PermaDefeated_629cbe29-01fb-4fb6-81c3-23748fb4c03d)
THEN
NOT DB_SeenDeadNPCGlobalFlag((CHARACTER)S_LOW_Tolna_46aa02d8-28e9-4ebb-876c-82fe29262d35, (FLAG)LOW_Tolna_Knows_PermaDefeated_629cbe29-01fb-4fb6-81c3-23748fb4c03d);
DB_SeenPermaDefeatedNPCGlobalFlag((CHARACTER)S_LOW_Tolna_46aa02d8-28e9-4ebb-876c-82fe29262d35, (FLAG)LOW_Tolna_Knows_PermaDefeated_629cbe29-01fb-4fb6-81c3-23748fb4c03d);
DB_BUGFIX_Marker("GUS-169771_SeenDatabases");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_PermanentlyEvil((CHARACTER)_Character)
AND
NOT DB_Defeated((GUIDSTRING)_Character)
THEN
DB_Defeated((GUIDSTRING)_Character);
PROC_StateSet_Defeated((GUIDSTRING)_Character);
DB_BUGFIX_Marker("GUS-169771_PermanentlyEvilDefeated",_Character);


//Patch 5 fixes
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5","WLD_Main_A","GUS-169771_Patch5_WLD");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5","SCL_Main_A","GUS-169771_Patch5_SCL");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-169771_Patch5_WLD")
THEN
DB_PermaDefeatedFlag(S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265,UND_MyconidCircle_Sovereign_State_PermaDefeated_bcfa3d32-7250-4c44-9eff-fbf30cef2b6e);
DB_PermaDefeatedFlag(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46,UND_MyconidCircle_BroodingSovereign_State_PermaDefeated_da7ae2b1-fa67-0889-6003-48d6aef7271d);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-169771_Patch5_SCL")
AND
DB_QuestDef_DefeatedState("MOO_MintharaFate", "MintharaPermaDefeated", (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
DB_QuestDef_PermaDefeatedState("MOO_MintharaFate", "MintharaPermaDefeated", (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
NOT DB_QuestDef_DefeatedState("MOO_MintharaFate", "MintharaPermaDefeated", (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-169771_Patch5_SCL")
AND
DB_PermaDefeated(S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b)
AND
DB_QuestIsOpened("HAV_FindRolan")
THEN
QuestUpdate("HAV_FindRolan", "CalPermaDefeated");


//Patch 6 fixes
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","WLD_Main_A","GUS-169771_Patch6_WLD");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","CRE_Main_A","GUS-169771_Patch6_CRE");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","SCL_Main_A","GUS-169771_Patch6_SCL");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","BGO_Main_A","GUS-169771_Patch6_BGO");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","CTY_Main_A","GUS-169771_Patch6_CTY");

//Defined in global goal
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
PROC_BUGFIX_AddAndPatch_DB_DefeatedStateFlag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,GLO_Nightsong_State_Defeated_64cfde96-b6d3-4d55-86c2-993a97f82ea6);

//Flag used after level becomes unreachable
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_PermaDefeatedFlag(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,(FLAG)LOW_SerialKiller_State_DolorIsPermaDefeated_a1ca5851-fea5-4536-934a-b402ac8d92a6);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-169771_Patch6_WLD")
THEN
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("CHA_ChapelInsideBandits",(FLAG)CHA_FL1_State_BanditsDead_d92afbc6-b7ac-431b-b440-1c5fa30ea688);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("CHA_OutsideBandits",(FLAG)CHA_Outside_Event_BanditsPermaDefeated_c61f7816-570e-4012-a10a-3a6d63c77608);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("CHA_UndeadGuardians",(FLAG)CHA_FL0_State_AllSkeletonDead_a2c88791-9ff6-4bd8-8945-78e819389a3e);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDeadGlobalFlag("PLA_KarlachRecruitmentTollhouse_Cultists", (FLAG)PLA_KarlachRecruitmentTollhouse_State_PaladinsDead_1e26e9d9-7e48-419c-b3c4-d7a042483aad);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("PLA_ZhentDungeon_DefeatCounter",(FLAG)PLA_ZhentDungeon_State_AllPermaDefeated_4dcee939-9346-ebb7-d328-1342e3e1d326);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("PLA_ZhentDungeon_DefeatCounter",(FLAG)PLA_ZhentDungeon_State_AllDefeated_a870d184-006a-d1f5-9eb5-29b31cb0f30f);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("PLA_ZhentDungeon_FF",(FLAG)PLA_ZhentDungeon_FF_State_AllPermaDefeated_ff177da0-eedd-4627-abaf-166a56e2443e);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("PLA_ZhentDungeon_FF",(FLAG)PLA_ZhentDungeon_FF_State_AllDefeated_5cfeb5fc-1c58-47c2-b64c-d2f1c21dc5fe);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_DeadElevatorGuards",(FLAG)UND_ElevatorGuards_State_PermaDefeated_5f1f5c9b-e05d-46be-aca2-4e298f8ef4bd);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDeadGlobalFlag("UND_DeadElevatorGuards",(FLAG)UND_ELevatorGuards_State_Dead_15d7e621-ef8c-49fb-87f3-a1a1694990f3);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_PermaDefeatedDuergarExcavationGuards",(FLAG)UND_DuergarGuards_Excavation_State_PermaDefeated_3f30c825-10f1-4fa5-84b8-073f293e6650);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_PermaDefeatedGnomeWorkers",(FLAG)UND_GnomeWorkers_State_PermaDefeated_99fa547a-d3c9-46fe-b53f-7cceb510cd6f);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_PermaDefeatedDebrisCleaners",(FLAG)UND_DebrisCleaners_State_PermaDefeated_c74816bf-a62c-49b7-80a8-4e0f95020f91);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_FearfulRothe_Rothe",(FLAG)UND_FearfulRothe_State_RotheArePermaDefeated_3edcda99-833f-4f49-9aed-a493d451eec3);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDeadGlobalFlag("UND_FearfulRothe_Rothe",(FLAG)UND_FearfulRothe_State_RotheAreDead_da84586c-ca0f-42b4-8082-c0b19803d682);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_FearfulRothe_Guards",(FLAG)UND_FearfulRothe_State_GuardsArePermaDefeated_60c74db1-dd75-96b6-5c9e-fa1d9a83bf58);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_PermaDefeatedDuergarCityGuards",(FLAG)UND_DuergarGuards_City_State_PermaDefeated_4624085c-cc07-4671-af4f-c8983b66ad17);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_PermaDefeatedDuergarAbsolutists",(FLAG)UND_DuergarCamp_State_Absolutists_PermaDefeated_9d806192-5464-42ed-9a39-596698b33ae2);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_PermaDefeatedDuergarRebels",(FLAG)UND_DuergarCamp_State_Rebels_PermaDefeated_b6a21d83-2b49-45c6-a89d-ddccddcf413a);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_MyconidCircle_KillCounter",(FLAG)UND_MyconidCircle_State_Wiped_bf1fa066-a4cf-d28a-59a4-4adadb605bdd);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDeadGlobalFlag("PLA_KarlachRecruitmentTollhouse_Cultists", (FLAG)PLA_KarlachRecruitmentTollhouse_State_PaladinsDead_1e26e9d9-7e48-419c-b3c4-d7a042483aad);
//Part 2
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("DEN_HarpyMeal_Harpies",(FLAG)DEN_HarpyMeal_State_HarpiesAllDead_89fd908d-98b0-47d2-8f29-0d2ec34fea0a);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("DEN_HarpyMeal_Harpies",(FLAG)DEN_HarpyMeal_State_HarpyEncounterOver_48fd55cd-a79a-8b4a-8dd6-901910b5d739);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("FOR_GnomeGoblins",(FLAG)FOR_GnomeGoblinsDead_8910f084-c9ad-2336-c6a7-098d71914529);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("PLA_GithChokepoint_DefeatCounter",PLA_GithChokepoint_Event_AllGithsDefeated_b329e2d8-31c8-4861-ae87-224e86f51682);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDeadGlobalFlag("PLA_GithChokepoint_DefeatCounter",PLA_GithChokepoint_Event_AllGithsDead_1e596139-4b27-486d-8cd5-b4ff1b3451dc);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("PLA_FlamingFists",PLA_FlamingFists_State_DefeatCounter_e4c4ad77-ddc0-4802-9374-7971f0c1fd82);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_CorpseDisposers_Defeated",(FLAG)UND_DeadInTheWater_State_DuergarsPermaDefeated_d3b422e2-134d-44db-8dbd-77cdfa67191b);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("UND_BroodingSovereign_KillCounter_LoneDuergar", UND_MyconidCircle_Quest_LoneDuergar_PermaDefeated_414e8493-33b0-25e8-c83b-a34b8f128394);
NOT DB_QuestDef_DefeatedState("UND_MyconidCircle", "DefeatedDuergar", S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18);
DB_QuestDef_PermaDefeatedState("UND_MyconidCircle", "DefeatedDuergar", S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18);
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("DEN_DruidAttack_NonDruids",DEN_DruidAttack_State_PrepAfterDeathOfTieflings_79826e3c-1dd7-4a8b-a5ca-cf4dfde51d12); //doesn't need to be rechecked
PROC_BUGFIX_AddAndPatch_DB_DefeatedOnceFlag(S_DEN_BugbearNinja_4cb29070-a33c-4253-9f57-18d1c9a88523,DEN_BugbearNinja_Dead_cc673032-ad3b-484e-b2cb-57f67c901b3d);
NOT DB_QuestDef_DefeatedState("UND_MyconidRevenge", "SpawDefeated", S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265);
DB_QuestDef_PermaDefeatedState("UND_MyconidRevenge", "SpawDefeated", S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-169771_Patch6_WLD")
AND
NOT DB_QuestDef_DefeatedState("UND_MyconidRevenge", "SpawDefeated", S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265)
AND
NOT DB_PermaDefeated(S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30)
THEN
DB_QuestDef_DefeatedState("UND_MyconidRevenge", "SpawDefeated", S_UND_MyconidSovereign_ea0f222f-eaad-4d83-bbcd-cbae51ccf265);

PROC
PROC_ApplySavegamePatchInLevel("CRE_Main_A","GUS-169771_Patch6_CRE")
THEN
PROC_BUGFIX_AddAndPatch_DB_DeadOnceFlag(S_CRE_Templar_378ac93e-03a0-40b4-904c-f37989ac7a8c, (FLAG)CRE_Templar_State_Dead_a9546cba-cbcd-4776-9a5e-09d2f30bb004);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-169771_Patch6_SCL")
THEN
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("HAV_Destruction", (FLAG)HAV_GeneralHaven_State_HavenDestroyed_efc8a650-b68f-4041-b75a-2d44a8be60b4);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("SCL_Drider_Cultists", (FLAG)SCL_Drider_State_CaravanCultistsPermaDefeated_5915ab2e-7516-4d89-a7f2-458f1cf6b2b6);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("SCL_Drider_HarpersCombatGroup", (FLAG)SCL_Drider_State_HarpersPermaDefeated_be4a239e-0127-4916-a350-8704a86daea9);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("SCL_HarperScouts_ShadowsDefeated",(FLAG)SCL_HarperScouts_State_ShadowsDefeated_bae50f7d-7347-4fb7-ae8a-9fda8f84fc9f);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("SCL_HarperScouts_HarpersDefeated",(FLAG)SCL_HarperScouts_State_HarpersDefeated_40be395c-f852-49ee-a30c-6531fbacd59c);
//Part 2
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("HAV_Meelock_DefeatCounter",HAV_Misc_State_MeenlocksPermaDefeated_056f0eff-93f2-468a-94e6-fd8aacb54ce7);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("MOO_Assault_PrisonEnemies",MOO_Assault_State_PrisonCombatDefeated_3ca7d513-98ff-4a47-9a7a-7fb8b2b42377);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("MOO_Assault_HarperAlly",MOO_Assault_State_AllActiveFlamingFistDefeated_c0971579-7f0a-49ae-af62-1d3ee9235965);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("MOO_Assault_FlamingFistAlly",MOO_Assault_State_AllActiveHarpersDefeated_93c03711-7efc-44fb-b4ae-736606afe843);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("SCL_Drider_CaravanDefeatedVBFlag",SCL_Drider_State_PlayersDefeatedCaravan_e10200a0-2aaa-2e42-aa40-dce8b4063707);
NOT DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("TWN_MasonsGuild_RebelHideout", TWN_MasonsGuild_RebelHideout_State_Cleared_e67e4bf3-ba34-4411-8745-ea00c5d040a4);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("TWN_MasonsGuild_RebelHideout", TWN_MasonsGuild_RebelHideout_State_Cleared_e67e4bf3-ba34-4411-8745-ea00c5d040a4);

//Morgue could be empty, Us not perma-defeated and not saved, but not checking if its cage door is unlocked
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-169771_Patch6_SCL")
AND
DB_OnlyOnce("COL_KethericShowdown_ChosenThree")
AND
DB_GlobalFlag((FLAG)COL_Morgue_State_UsInColony_8e0a2351-4e88-0b3f-4088-6de33da0ddd4)
AND
NOT DB_GlobalFlag((FLAG)COL_Morgue_State_UsSaved_14440266-df48-ff1b-b65a-b661d79f523c)
AND
NOT DB_PermaDefeated(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
THEN
DB_COL_Morgue_CheckUsCageOpened(1);
DB_BUGFIX_Marker("GUS-169771_Patch6_SCL_UsNotSavedButAlone");


PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A","GUS-169771_Patch6_BGO")
THEN
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("WYR_Axe_Assassins",(FLAG)WYR_Axe_State_DoppelgangersDead_416b80ee-d87d-4980-90e4-bee004151544);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("WYR_MerchantsHouse_Thugs",(FLAG)WYR_MerchantsHouse_State_ThugsDefeated_cc82b4e7-f0f5-4cd3-8fb2-b5de9a3a9aed);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("WYR_SmugglersCave_SmugglersList",(FLAG)WYR_SmugglersCave_State_SmugglersDefeated_d6acc249-bd57-4076-ad5f-954c5eaad5c7);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("WYR_SmugglersCave_SmugglersList",(FLAG)WYR_SmugglersCave_State_SmugglersDead_24f5d15a-7c30-4e87-bd88-efcb53707572);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("WYR_SmugglersCave_AttackersList",(FLAG)WYR_SmugglersCave_State_AttackersDefeated_c9113226-cc30-48c0-896e-e7ed60080ac2);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("WYR_SmugglersCave_AttackersList",(FLAG)WYR_SmugglersCave_State_AttackersDead_e4c30333-03bc-4cdf-a18d-cdc94ad449af);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-169771_Patch6_CTY")
THEN
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_BlushingMermaid_RedcapsPermaDefeated",(FLAG)LOW_BlushingMermaid_State_DisguisedRedcaps_PermaDefeated_032aeb06-5eff-4459-8b1d-4ad796c15a8b);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_Elfsong_CellarRats",(FLAG)LOW_Elfsong_State_RatsKilledGlobal_7416b42a-3c5b-4e6d-a584-84812e61fd1a);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_Elfsong_KotS_GithyankiCombat",(FLAG)LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDeadGlobalFlag("LOW_PhilgravesMansion_UpperFloorEnemies",(FLAG)LOW_PhilgravesMansion_State_AllUpperFloorEnemiesDead_2ef71980-faae-49d0-8bd6-affa8b4164a5);
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_MurderTribunal_Bhaalists",LOW_MurderTribunal_State_BhaalistsDead_afe8bfd0-4369-4169-8191-109d2356051b);
NOT DB_QuestDef_DefeatedState("LOW_SaveHope", "HopeDefeated", S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);
DB_QuestDef_PermaDefeatedState("LOW_SaveHope", "HopeDefeated", S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);
DB_GLO_CompoundFlag((FLAG)WYR_OpenHand_Knows_KillersName_ce8dca23-7b94-4b18-81ef-ff40ca3d9bed,(FLAG)LOW_SerialKiller_Knows_DolorIsKiller_1f1adc6a-fb17-7f58-a510-3bf96289bd56);DB_DeadOnceFlag(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,(FLAG)LOW_FatherCarrion_State_HasBeenKilled_34a30ab8-c0e4-44a1-b2b4-31a5cc65bcea);
PROC_BUGFIX_AddAndPatch_DB_DeadStateFlag(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,(FLAG)LOW_FatherCarrion_State_IsTempDefeated_56356b1f-9ddc-4d34-a22b-3b92dc2b6e8b);
PROC_BUGFIX_AddAndPatch_DB_DeadOnceFlag(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,(FLAG)LOW_SerialKiller_State_DolorIsDead_fa48e3fe-dc3c-b5c5-09f1-039a5b6974cf);
PROC_BUGFIX_AddAndPatch_DB_DeadOnceFlag(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81,(FLAG)LOW_SerialKiller_State_DevellaIsDead_156d25aa-f1b8-47af-9fd5-da374420dc95);
PROC_BUGFIX_AddAndPatch_DB_PermaDefeatedFlag(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81,(FLAG)LOW_SerialKiller_State_DevellaIsPermaDefeated_944a98e2-fb7a-4259-9061-928793071330);

// Missed update for Gondians
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6 Hotfix 4","CTY_Main_A","GUS-318884");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-318884")
THEN
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_SteelWatchFoundry_Gondians",LOW_SteelWatchFoundry_Status_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5);

PROC
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag((STRING)_Identifier,(FLAG)_Flag)
THEN
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag((STRING)_Identifier,(FLAG)_Flag);

//Don't set flag if there are no defeat counter entries
PROC
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag((STRING)_Identifier,(FLAG)_Flag)
AND
QRY_GLO_DefeatCounter_Count(_Identifier,"Any")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_Count)
AND
_Count > 0
THEN
PROC_GLO_DefeatCounter_CheckFinished((STRING)_Identifier);

PROC
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag((STRING)_Identifier,(FLAG)_Flag)
THEN
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag((STRING)_Identifier,(FLAG)_Flag);

//Don't set flag if there are no defeat counter entries
PROC
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag((STRING)_Identifier,(FLAG)_Flag)
AND
DB_GLO_DefeatCounter_CountMet(_Identifier)
THEN
DB_GLO_DefeatCounter_CountMet(_Identifier);
PROC_GLO_DefeatCounter_AllDefeated(_Identifier);

PROC
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDefeatedGlobalFlag((STRING)_Identifier,(FLAG)_Flag)
AND
NOT DB_GLO_DefeatCounter_CountMet(_Identifier)
AND
QRY_GLO_DefeatCounter_Count(_Identifier,"Any")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_Count)
AND
_Count > 0
THEN
PROC_GLO_DefeatCounter_CheckFinished((STRING)_Identifier);

PROC
PROC_GLO_DefeatCounter_Notify((STRING)_ID,(INTEGER)_DesiredCount,(INTEGER)_DefeatedCount,(INTEGER)_PermaDefeatedCount)
AND
IntegerSum(_DefeatedCount,_PermaDefeatedCount,_TotalDefeated)
AND
_TotalDefeated >= _DesiredCount
AND
NOT DB_GLO_DefeatCounter_CountMet(_ID)
AND
NOT QRY_GLO_DefeatCounter_WaitForCombatEnd(_ID)
THEN
DB_GLO_DefeatCounter_CountMet(_ID);
PROC_GLO_DefeatCounter_AllDefeated(_ID);

PROC
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDeadGlobalFlag((STRING)_Identifier,(FLAG)_Flag)
THEN
DB_GLO_DefeatCounter_AllDeadGlobalFlag((STRING)_Identifier,(FLAG)_Flag);

PROC
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDeadGlobalFlag((STRING)_Identifier,(FLAG)_Flag)
AND
NOT DB_GLO_DefeatCounter_Target(_Identifier,_)
AND
QRY_GLO_DefeatCounter_Count(_Identifier,"Any")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_Count)
AND
_Count > 0
AND
QRY_GLO_DefeatCounter_Count(_Identifier,"Dead")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_DeadCount)
AND
QRY_GLO_DefeatCounter_Count(_Identifier,"Active")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_AliveCount)
AND
QRY_GLO_DefeatCounter_Count(_Identifier,"Defeated")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_DefeatedCount)
AND
QRY_GLO_DefeatCounter_Count(_Identifier,"PermaDefeated")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_PermaDefeatedCount)
AND
IntegerSum(_AliveCount,_DefeatedCount,_SubTotalCount)
AND
IntegerSum(_SubTotalCount,_PermaDefeatedCount,_DesiredCount)
AND
_DeadCount >= _DesiredCount
THEN
PROC_GLO_DefeatCounter_AllDead((STRING)_Identifier);

PROC
PROC_BUGFIX_AddAndPatch_DB_GLO_DefeatCounter_AllDeadGlobalFlag((STRING)_Identifier,(FLAG)_Flag)
AND
DB_GLO_DefeatCounter_Target(_Identifier,_DesiredCount)
AND
QRY_GLO_DefeatCounter_Count(_Identifier,"Any")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_Count)
AND
_Count > 0
AND
QRY_GLO_DefeatCounter_Count(_Identifier,"Dead")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_DeadCount)
AND
_DeadCount >= _DesiredCount
THEN
PROC_GLO_DefeatCounter_AllDead((STRING)_Identifier);

//Perma-defeated flag
PROC
PROC_BUGFIX_AddAndPatch_DB_PermaDefeatedFlag((GUIDSTRING)_Object,(FLAG)_Flag)
THEN
DB_PermaDefeatedFlag((GUIDSTRING)_Object,(FLAG)_Flag);

PROC
PROC_BUGFIX_AddAndPatch_DB_PermaDefeatedFlag((GUIDSTRING)_Object,(FLAG)_Flag)
AND
DB_PermaDefeated(_Object)
AND
NOT DB_GlobalFlag(_Flag)
THEN
PROC_GlobalSetFlagAndCache((FLAG)_Flag);

PROC
PROC_BUGFIX_AddAndPatch_DB_PermaDefeatedFlag((GUIDSTRING)_Object,(FLAG)_Flag)
AND
NOT DB_PermaDefeated(_Object)
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GlobalClearFlagAndCache((FLAG)_Flag);

//Defeated state flag
PROC
PROC_BUGFIX_AddAndPatch_DB_DefeatedStateFlag((GUIDSTRING)_Object,(FLAG)_Flag)
THEN
DB_DefeatedStateFlag((GUIDSTRING)_Object,(FLAG)_Flag);

PROC
PROC_BUGFIX_AddAndPatch_DB_DefeatedStateFlag((GUIDSTRING)_Object,(FLAG)_Flag)
AND
DB_Defeated(_Object)
AND
NOT DB_GlobalFlag(_Flag)
THEN
PROC_GlobalSetFlagAndCache((FLAG)_Flag);

PROC
PROC_BUGFIX_AddAndPatch_DB_DefeatedStateFlag((GUIDSTRING)_Object,(FLAG)_Flag)
AND
NOT DB_Defeated(_Object)
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GlobalClearFlagAndCache((FLAG)_Flag);

//Defeated once flag
PROC
PROC_BUGFIX_AddAndPatch_DB_DefeatedOnceFlag((GUIDSTRING)_Object,(FLAG)_Flag)
THEN
DB_DefeatedStateFlag((GUIDSTRING)_Object,(FLAG)_Flag);

PROC
PROC_BUGFIX_AddAndPatch_DB_DefeatedOnceFlag((GUIDSTRING)_Object,(FLAG)_Flag)
AND
DB_Defeated(_Object)
AND
NOT DB_GlobalFlag(_Flag)
THEN
PROC_GlobalSetFlagAndCache((FLAG)_Flag);

//Dead state flag
PROC
PROC_BUGFIX_AddAndPatch_DB_DeadStateFlag((CHARACTER)_Object,(FLAG)_Flag)
THEN
DB_DeadStateFlag((CHARACTER)_Object,(FLAG)_Flag);

PROC
PROC_BUGFIX_AddAndPatch_DB_DeadStateFlag((CHARACTER)_Object,(FLAG)_Flag)
AND
DB_Dead(_Object)
AND
NOT DB_GlobalFlag(_Flag)
THEN
PROC_GlobalSetFlagAndCache((FLAG)_Flag);

PROC
PROC_BUGFIX_AddAndPatch_DB_DeadStateFlag((CHARACTER)_Object,(FLAG)_Flag)
AND
NOT DB_Dead(_Object)
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GlobalClearFlagAndCache((FLAG)_Flag);

//Dead once flag
PROC
PROC_BUGFIX_AddAndPatch_DB_DeadOnceFlag((CHARACTER)_Object,(FLAG)_Flag)
THEN
DB_DeadOnceFlag((CHARACTER)_Object,(FLAG)_Flag);

PROC
PROC_BUGFIX_AddAndPatch_DB_DeadOnceFlag((CHARACTER)_Object,(FLAG)_Flag)
AND
DB_Dead(_Object)
AND
NOT DB_GlobalFlag(_Flag)
THEN
PROC_GlobalSetFlagAndCache((FLAG)_Flag);

//END_REGION GUS-169771

//REGION GUS-306974
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_BUGFIX_Marker("GUS-306974");
DB_QuestDef_State((FLAG)ORI_Astarion_Event_LearnedVampire_Act2Fallback_bda4c552-b8df-4b66-ae0b-1c653a56b3e8, "ORI_COM_Astarion", "LearnedVampire_Act2Fallback");
DB_QuestDef_State((FLAG)ORI_Astarion_Event_LearnedVampire_Act3Fallback_e051d5a7-cad0-4049-8110-1bf4605f8d89, "ORI_COM_Astarion", "LearnedVampire_Act3Fallback");
PROC_GLO_Bugfix_306974_CheckUpdateJournal();

PROC
PROC_GLO_Bugfix_306974_CheckUpdateJournal()
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
THEN
SetFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
SetFlag((FLAG)ORI_Astarion_Event_LearnedVampire_Act3Fallback_e051d5a7-cad0-4049-8110-1bf4605f8d89);

//END_REGION

//REGION GUS-310413

PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_BUGFIX_Marker("GUS-310413");
NOT DB_GLO_Backgrounds_Goal((TAG)GUILD_ARTISAN_baf9fb0e-f535-40a0-bb78-3ec289d84e66, "Act3_GuildArtisan_", 0e9f6b27-d7ec-48ad-b767-49eac4cba1ae);
NOT DB_GLO_Backgrounds_Goal((TAG)GUILD_ARTISAN_baf9fb0e-f535-40a0-bb78-3ec289d84e66, "Act3_GuildArtisan_", cc79ef68-36ad-475f-a8ca-75480d313592);
NOT DB_GLO_Backgrounds_Goal((TAG)GUILD_ARTISAN_baf9fb0e-f535-40a0-bb78-3ec289d84e66, "Act3_GuildArtisan_", 617b18de-e347-4362-bc12-9716184d2d4b);
DB_GLO_Backgrounds_Goal((TAG)GUILD_ARTISAN_baf9fb0e-f535-40a0-bb78-3ec289d84e66, "Act3_GuildArtisan_DevilRelicsIdentified", 0e9f6b27-d7ec-48ad-b767-49eac4cba1ae);
DB_BUGFIX_Marker("GUS-310406");
DB_GLO_Backgrounds_Goal((TAG)GUILD_ARTISAN_baf9fb0e-f535-40a0-bb78-3ec289d84e66, "Act3_GuildArtisan_PaintingBurned", cc79ef68-36ad-475f-a8ca-75480d313592);
DB_GLO_Backgrounds_Goal((TAG)GUILD_ARTISAN_baf9fb0e-f535-40a0-bb78-3ec289d84e66, "Act3_GuildArtisan_AccessedIronThrone", 617b18de-e347-4362-bc12-9716184d2d4b);
PROC_GLO_Background_GUS310413_FixGuildArtisanGoals();

PROC
PROC_GLO_Background_GUS310413_FixGuildArtisanGoals()
AND
DB_GLO_Backgrounds_Blocked("Act3_GuildArtisan_DevilRelicsIdentified")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GLO_Backgrounds_GUS310413_DevilRelicsIdentified")
THEN
NOT DB_GLO_Backgrounds_Blocked("Act3_GuildArtisan_DevilRelicsIdentified");
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_GuildArtisan_DevilRelicsIdentified");

PROC
PROC_GLO_Background_GUS310413_FixGuildArtisanGoals()
AND
DB_GLO_Backgrounds_Blocked("Act3_GuildArtisan_PaintingBurned")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GLO_Backgrounds_GUS310413_PaintingBurned")
THEN
DB_GLO_Backgrounds_Blocked("Act3_GuildArtisan_PaintingBurned");
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_GuildArtisan_PaintingBurned");

PROC
PROC_GLO_Background_GUS310413_FixGuildArtisanGoals()
AND
DB_GLO_Backgrounds_Blocked("Act3_GuildArtisan_AccessedIronThrone")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GLO_Backgrounds_GUS310413_AccessedIronThrone")
THEN
NOT DB_GLO_Backgrounds_Blocked("Act3_GuildArtisan_AccessedIronThrone");
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_GuildArtisan_AccessedIronThrone");

//END_REGION

//REGION GUS-309375, GUSX-13841

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8 Beta Hotfix 1")
THEN
PROC_Achievements_BG3_Quest30_DefineUnarmedAttackSpells();
DB_BUGFIX_Marker("GUSX-13841_Quest30");

//END_REGION GUS-309375, GUSX-13841

//REGION GUS-310908

IF
LevelLoaded("SCL_Main_A")
AND
DB_MovingTo((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_HAV_Jaheira_InnHome2_68f5d526-225a-4436-abc4-7047911be5d8, _, _ID)
THEN
PROC_CharacterMoveTo_Clear(S_HAV_Jaheira_InnHome2_68f5d526-225a-4436-abc4-7047911be5d8, _ID, "Cancelled");
TeleportTo((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_HAV_Jaheira_InnHome2_68f5d526-225a-4436-abc4-7047911be5d8, "HAV_Isobel_ArrivedHomeAfterIsobel");

//END_REGION


//REGION GUS-308985

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5","WLD_Main_A","GUS-300725_WLD");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5","SCL_Main_A","GUS-300725_SCL");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5","CTY_Main_A","GUS-300725_CTY");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_Combat_RemoveStatusOnLongRest("COL_MYRKULITE_BLESSING")
THEN
NOT DB_Combat_RemoveStatusOnLongRest("COL_MYRKULITE_BLESSING"); //deprecated status
NOT DB_Combat_RemoveStatusOnLongRest_TriggerException("COL_MYRKULITE_BLESSING",(TRIGGER)S_COL_Colony_SUB_c72269e5-0719-4379-a8ea-ca2ca199d0a3);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_OneShot_VoiceBarkTrigger((TRIGGER)_,(VOICEBARKRESOURCE)_,(STRING)_,(TRIGGER)_PassedTrigger)
AND
_PassedTrigger != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_ExecuteWhenObjectInCurrentLevel("OneShot_VoiceBarkTrigger_FixPassedTriggerRegistration",_PassedTrigger);

PROC
PROC_ExecuteWhenObjectInCurrentLevel("OneShot_VoiceBarkTrigger_FixPassedTriggerRegistration",_PassedTrigger)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)_PassedTrigger);

//WLD
PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-300725_WLD")
AND
DB_GlobalFlag((FLAG)GOB_DrunkGoblin_Quest_GoblinSparedInFight_9d6482a0-69d4-d83a-005e-7a62c302ad46)
AND
DB_KnockedOut(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
AND
NOT DB_PermaDefeated(S_GOB_DrunkGoblin_0c3404d4-af6f-4c3c-8873-101a79cc4d86)
AND
NOT DB_GOB_DrunkGoblin_WasKnockedOut(1)
THEN
DB_GOB_DrunkGoblin_WasKnockedOut(1);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-300725_WLD")
AND
DB_GlobalFlag((FLAG)UND_GnomeWorkers_Event_Leave_ad897c6f-87d5-4a30-88f0-41c92b965bc8)
AND
NOT DB_OffStage(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73)
THEN
SetOnStage(S_UND_ScryingEye_0bdd9214-953c-427a-87fa-7fdc25ef3b73,0);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-300725_WLD")
AND
DB_GlobalFlag((FLAG)UND_PetrifiedDrow_State_DrowLeft_1815af62-0ad7-461e-a61b-2986445bec36)
AND
QRY_UND_PetrifiedDrow_AtLeastOneDrowCanAct()
THEN
PROC_UND_PetrifiedDrow_RemoveAllAliveDrow();

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A","GUS-300725_WLD")
AND
DB_InCamp((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901)
THEN
PROC_ClearCorpseOwner((CHARACTER)S_FOR_Courier_bf842d88-0c39-48b8-b4a1-f9ab140ee6ca);

//SCL
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-300725_SCL")
AND
DB_GlobalFlag(HAV_EnteringHaven_State_ClawsKilledLongAgo_b26a5215-ac49-4755-bd58-1aac44595a64)
AND
DB_HAV_EnteringHaven_ClawsActive(1)
THEN
ClearFlag(HAV_EnteringHaven_State_ClawsKilledLongAgo_b26a5215-ac49-4755-bd58-1aac44595a64, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-300725_SCL")
AND
DB_OnlyOnce("TWN_Arabella_AppearInTownDead")
AND
DB_TWN_ArabellasPowers_DeathShadows(_Shadow,_)
AND
DB_OffStage(_Shadow)
THEN
SetOnStage(_Shadow,1);
ApplyStatus(_Shadow,"TWN_ARABELLAPOWERS_ARABELLAVINES",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-300725_SCL")
AND
DB_OnlyOnce("TWN_Arabella_AppearInTownDead")
AND
DB_TWN_ArabellasPowers_DeathShadows(_Shadow,1)
AND
NOT DB_Dead(_Shadow)
THEN
Die(_Shadow,DEATHTYPE.Physical,1);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-300725_SCL")
AND
DB_OnlyOnce("SCL_LiftingTheCurse_FlamingFistGone")
AND
NOT DB_OffStage(S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373)
THEN
PROC_DisappearOutOfSight(S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373, "Walk", 0, "SCL_LiftingTheCurse_FlamingFistGone");

//CTY
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-300725_CTY")
THEN
SetDoNotFaceFlag((CHARACTER)S_LOW_BramptonBeggars_Civilian1_fe489f75-7e61-469c-879b-dce765985502,1);
SetDoNotFaceFlag((CHARACTER)S_LOW_BramptonBeggars_Civilian2_8ebaddc2-505f-4dd1-944d-349ca5c802b3,1);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-300725_CTY")
AND
DB_OnlyOnce("LOW_BaldursMouth_SteelWatchActivated")
AND
DB_OffStage(S_LOW_BaldursMouth_WarningNote_6dedfb84-b858-4e42-8171-61554ddcc800)
THEN
NOT DB_OnlyOnce("LOW_BaldursMouth_SteelWatchActivated"); //next long rest will handle the fix

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-300725_CTY")
AND
DB_OnlyOnce("LOW_CazadorsPalace_CheckRemoveSpawns")
AND
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs(_Spawn, _)
AND
NOT DB_OffStage(_Spawn)
AND
NOT DB_PermaDefeated(_Spawn)
THEN
PROC_SetOnStage(_Spawn, 0);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-300725_CTY")
AND
DB_LOW_Park_Replacements(_Replacement)
AND
DB_OffStage(_Replacement)
THEN
SetOnStage(_Replacement, 1);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-300725_CTY")
AND
DB_OnlyOnce("LOW_Park_SwapCiviliansInPark")
AND
NOT DB_OffStage(S_LOW_Park_FlamingFist1_bbd05a60-77c7-48fe-9273-a9e5303c7c24)
THEN
NOT DB_OnlyOnce("LOW_Park_SwapCiviliansInPark"); //next long rest will handle the fix

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-300725_CTY")
AND
DB_DB_EastwayFoodCrisis_ChickenSetOffstage(1)
THEN
NOT DB_DB_EastwayFoodCrisis_ChickenSetOffstage(1);
DB_ExecuteInLevel_AfterLongRest("LOW_EastwayFoodCrisis_ChickenSetOffstage","CTY_Main_A");

//END_REGION GUS-308985

//REGION GUS-304514
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_Players(_Player)
AND
HasAppliedStatus(_Player, "TAD_PARTIAL_CEREMORPH", 1)
THEN
DB_BUGFIX_Marker("GUS-304514");
RemoveCustomMaterialOverride(_Player, "398ca8ae-c3c0-47f5-8e45-d9402e198389");
RealtimeObjectTimerLaunch(_Player, "SavegamePatch_GUS304514_Timer", 100);

IF
ObjectTimerFinished(_Player, "SavegamePatch_GUS304514_Timer")
THEN
AddCustomMaterialOverride(_Player, "398ca8ae-c3c0-47f5-8e45-d9402e198389");
//END_REGION GUS-304514

//REGION GUS-169771

//All DB_DefeatedEvent flags were already functioning as defeated state flags, so just transfer the database entries
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_DefeatedEvent((GUIDSTRING)_Object,(FLAG)_Flag)
THEN
DB_DefeatedStateFlag(_Object,_Flag);
NOT DB_DefeatedEvent(_Object,_Flag);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_DeadEvent((CHARACTER)_Character,(FLAG)_Flag)
THEN
DB_DeadOnceFlag(_Character,_Flag);
NOT DB_DeadEvent(_Character,_Flag);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_PermaDefeatedEvent((GUIDSTRING)_Object,(FLAG)_Flag)
THEN
DB_PermaDefeatedFlag(_Object,_Flag);
NOT DB_PermaDefeatedEvent(_Object,_Flag);

//Minthara
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_DeadOnceFlag(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, GLO_DrowCommander_State_Dead_bf904558-1898-4d27-9526-9cef185cc9e1)
THEN
DB_DeadStateFlag(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, GLO_DrowCommander_State_Dead_bf904558-1898-4d27-9526-9cef185cc9e1);
NOT DB_DeadOnceFlag(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, GLO_DrowCommander_State_Dead_bf904558-1898-4d27-9526-9cef185cc9e1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(GLO_DrowCommander_State_Dead_bf904558-1898-4d27-9526-9cef185cc9e1)
AND
NOT DB_Dead((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
ClearFlag((FLAG)GLO_DrowCommander_State_Dead_bf904558-1898-4d27-9526-9cef185cc9e1);

//Shadowheart
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_DeadOnceFlag((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)GLO_Shadowheart_State_Dead_49895e67-443f-46f0-96db-4f49706ac58d)
THEN
DB_DeadStateFlag((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)GLO_Shadowheart_State_Dead_49895e67-443f-46f0-96db-4f49706ac58d);
NOT DB_DeadOnceFlag((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)GLO_Shadowheart_State_Dead_49895e67-443f-46f0-96db-4f49706ac58d);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(GLO_Shadowheart_State_Dead_49895e67-443f-46f0-96db-4f49706ac58d)
AND
NOT DB_Dead((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
ClearFlag((FLAG)GLO_Shadowheart_State_Dead_49895e67-443f-46f0-96db-4f49706ac58d);

//Ettvard Needle
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_PermaDefeatedFlag(S_LOW_BaldursMouth_EttvardNeedle_c171c8b4-acb9-4633-9de4-a09176d21d73, LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b)
THEN
DB_DeadOnceFlag(S_LOW_BaldursMouth_EttvardNeedle_c171c8b4-acb9-4633-9de4-a09176d21d73, LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b);
DB_PermaDefeatedFlag(S_LOW_BaldursMouth_EttvardNeedle_c171c8b4-acb9-4633-9de4-a09176d21d73, LOW_BaldursMouth_State_EttvardIsPermaDefeated_3ea02616-030f-412f-a6bf-84bb11f573d0);
NOT DB_PermaDefeatedFlag(S_LOW_BaldursMouth_EttvardNeedle_c171c8b4-acb9-4633-9de4-a09176d21d73, LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b)
AND
DB_PermaDefeated(S_LOW_BaldursMouth_EttvardNeedle_c171c8b4-acb9-4633-9de4-a09176d21d73)
AND
NOT DB_Dead(S_LOW_BaldursMouth_EttvardNeedle_c171c8b4-acb9-4633-9de4-a09176d21d73)
THEN
ClearFlag(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
NOT DB_GlobalFlag((FLAG)LOW_BaldursMouth_State_EttvardIsPermaDefeated_3ea02616-030f-412f-a6bf-84bb11f573d0)
AND
DB_PermaDefeated(S_LOW_BaldursMouth_EttvardNeedle_c171c8b4-acb9-4633-9de4-a09176d21d73)
THEN
SetFlag(LOW_BaldursMouth_State_EttvardIsPermaDefeated_3ea02616-030f-412f-a6bf-84bb11f573d0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
NOT DB_BUGFIX_Marker("GUS-169771_DefeatedEventToState")
THEN
DB_BUGFIX_Marker("GUS-169771_DefeatedEventToState");

//END_REGION GUS-169771

//REGION GUS-310286

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
NOT DB_TopicalGreetingEndCondition_CharacterLeftParty((FLAG)TG_ORI_Astarion_CompanionStayedVampireSpawn_ec8e7305-1980-48c6-8237-2832539cc7d5, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
DB_BUGFIX_Marker("GUS-310286");
DB_TopicalGreetingEndCondition_CharacterLeftParty((FLAG)TG_ORI_Astarion_CompanionStayedVampireSpawn_ec8e7305-1980-48c6-8237-2832539cc7d5, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

//END_REGION GUS-310286

//REGION GUS-311655
//Stop Enemy of the Absolute on arrested players, so they are no longer stuck in a loop of getting arrested again and again.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_Players(_Player)
AND
DB_IsArrested(_, _Player)
AND
HasActiveStatus(_Player, "LOW_STEELWATCH_ENEMYOFABSOLUTE", 1)
THEN
RemoveStatus(_Player, "LOW_STEELWATCH_ENEMYOFABSOLUTE", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-311655");
//END_REGION GUS-311655


//REGION GUS-308735
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_DeadOnceFlag(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,(FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2)
THEN
NOT DB_DeadOnceFlag(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,(FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);
DB_DeadStateFlag(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,(FLAG)GLO_Karlach_State_Defeated_3f1f91aa-95d3-4d7f-a845-9fc962c8d1b9);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2)
AND
NOT DB_Dead((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
ClearFlag((FLAG)GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(CAMP_MizorasJudgement_Event_Judged_c6d2140f-312d-65d4-e66e-92de4258b3f4)
AND
NOT DB_GlobalFlag((FLAG)ORI_Wyll_State_IsDevil_f83eee79-271b-4044-947a-d8eb699d734a)
AND
NOT DB_Dead((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
SetTag(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(TAG)WYLL_DEVIL_5e844f0e-d822-4210-a28e-6af149a7bd4b);
SetFlag(ORI_Wyll_State_IsDevil_f83eee79-271b-4044-947a-d8eb699d734a);

//END_REGION

//REGION GUS-306013
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_BUGFIX_Marker("GUS-306013");
PROC_GLO_Bugfix_306013();

PROC
PROC_GLO_Bugfix_306013()
AND
DB_Sees(_Char1, _Char2)
AND
NOT CanSee(_Char1, _Char2, 1)
THEN
NOT DB_Sees(_Char1, _Char2);
//END_REGION

//REGION GUS-307168

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_BUGFIX_Marker("GUS-307168");
DB_Combat_IncapacitatingStatus("SG_Prone");
DB_Combat_IncapacitatingStatus("SG_Incapacitated");
DB_Combat_IncapacitatingStatus("SG_Unconscious");
DB_Combat_IncapacitatingStatus("SG_Stunned");
DB_Combat_IncapacitatingStatus("SG_Paralyzed");
DB_Combat_IncapacitatingStatus("SG_Petrified");

//END_REGION

//REGION GUS-311253
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_PlayerSummons(_Summon)
AND
NOT IsSummon(_Summon, 1)
THEN
NOT DB_PlayerSummons(_Summon);
DB_BUGFIX_Marker("GUS-311253");
//END_REGION

//REGION GUS-312263
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
THEN
DB_ORI_Shadowheart_HintFlag((FLAG)ORI_Shadowheart_Knows_JusticiarMurals_87dea9e2-c18c-40a0-98cf-96cf2804cf4e);
DB_ORI_Shadowheart_HintFlag((FLAG)ORI_Shadowheart_Knows_SeenTempleVista_81608e92-ac2f-4440-834c-585b0c228c7a);
DB_ORI_Shadowheart_HintFlag((FLAG)ORI_Shadowheart_State_IdolHint_5e2d4403-e9e9-4ee2-a2fb-5d7f45aa71cb);
DB_ORI_Shadowheart_HintFlag((FLAG)ORI_Shadowheart_Knows_CurseResistant_1c40f83c-99d1-4777-a8f7-95377f6561b8);
DB_ORI_Shadowheart_HintFlag((FLAG)ORI_Shadowheart_State_TempleApproachHint_c0aa296e-fa16-4ddf-8e2d-ecfe5b5b32e2);
DB_ORI_Shadowheart_HintFlag((FLAG)Shadowheart_InParty_InterestInDarkJusticiars_4d45b833-582d-c7a6-9936-0922e78e36d9);
DB_ORI_Shadowheart_HintFlag((FLAG)ORI_Shadowheart_State_SeluneJusticiarHint_6c8ac0f9-e182-4a62-aeab-52e6dcf6a5ef);
DB_ORI_Shadowheart_HintFlag((FLAG)UND_DarkJusticiarsCorpses_Recognized_6926ad12-4a89-35c9-3d70-2ec613b25c8d);
DB_ORI_Shadowheart_HintFlag((FLAG)ORI_Shadowheart_State_TownCorpseHint_e2059455-ab53-49d3-aac5-775453ff9468);
DB_BUGFIX_Marker("GUS-312263");
//END_REGION GUS-312263

//REGION GUS-308813
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotifx 5")
THEN
DB_BUGFIX_Marker("GUS-308813");
SysClear("DB_HasTaggedItem",4);
//END_REGION

//REGION GUS-308421
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
NOT DB_GlobalFlag((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18)
THEN
DB_CampNight_ForceOnLevelSwap((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18,"ReadyCheck_ToBGFromSCL",0,0);
DB_CampNight_ResurrectWhenForced((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18,(CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_BUGFIX_Marker("GUS-308421");
//END_REGION GUS-308421

//REGION Gale self-explode adjustment

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_ORI_Gale_SuicideSpell("Shout_END_Gale_ActivateNethereseOrb");
DB_ORI_Gale_SuicideSpell("Target_END_Gale_ActivateNethereseOrb");

//END_REGION
//REGION GUS-311027
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
THEN
NOT DB_OriginLeavingDialog(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(DIALOGRESOURCE)Jaheira_Leaving_9c96c524-5692-ee30-3ee8-9b1ad4262fb1);
NOT DB_OriginMayLeaveDialog(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(DIALOGRESOURCE)Jaheira_Leaving_9c96c524-5692-ee30-3ee8-9b1ad4262fb1);
NOT DB_OriginLeavingDependency(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(DIALOGRESOURCE)Jaheira_Leaving_9c96c524-5692-ee30-3ee8-9b1ad4262fb1);
DB_BUGFIX_Marker("GUS-311027");
//END_REGION GUS-311027

//REGION GUS-312151
// When players have read the Karsus notes, we assume that Gale has mentioned his aspirations to ascend to godhood.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff)
THEN
SetFlag((FLAG)ORI_Gale_State_MentionedGodhood_909eaec1-6c97-1de0-8055-0ab711b5de81);
//END_REGION GUS-312151

//REGION GUS-312611
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_Avatars(_Avatar)
AND
GetFlag((FLAG)ORI_State_WasPartneredWithMinthara_8d0460d6-b00a-4947-bbd0-ad0c085a530f, _Avatar, 1)
AND
GetFlag((FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8, _Avatar, 1)
THEN
DB_BUGFIX_Marker("GUS-312611");
ClearFlag((FLAG)ORI_State_WasPartneredWithMinthara_8d0460d6-b00a-4947-bbd0-ad0c085a530f, _Avatar, 0);
//END_REGION GUS-312611

//REGION GUS-311511
// When players have read the Karsus notes, we assume that Gale has mentioned his aspirations to ascend to godhood.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_CharacterMoveToAndTalk_Info((CHARACTER)_Character,(GUIDSTRING)_Target,(DIALOGRESOURCE)_Dialog,(STRING)_MoveEvent)
THEN
DB_BUGFIX_Marker("GUS-311511", _Character);
NOT DB_CharacterMoveToAndTalk_Info(_Character,_Target,_Dialog,_MoveEvent);
DB_CharacterMoveToAndTalk_Info(_Character,_Target,_Dialog,_MoveEvent,0);
//END_REGION

//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce(_Level)
AND
NOT DB_LevelUnreachable(_Level)
THEN
DB_ApplySavegamePatchInLevel(_Level,"GUS-306683");

PROC
PROC_ApplySavegamePatchInLevel(_Level,"GUS-306683")
AND
DB_IsOrWasInParty(_Character)
AND
NOT QRY_GUS_306683_ExcludeCharacter(_Character)
THEN
RemoveStatusesWithGroup(_Character,"SG_Disguise");
DB_BUGFIX_Marker("GUS-310759");

QRY
QRY_GUS_306683_ExcludeCharacter((CHARACTER)_Character)
AND
DB_GUS_306683_Skipped(_Character)
THEN
DB_NOOP(1);

QRY
QRY_GUS_306683_ExcludeCharacter((CHARACTER)_Character)
AND
Exists(_Character, 1)
AND
DB_PartyMembers(_Character)
THEN
DB_GUS_306683_Skipped(_Character);

QRY
QRY_GUS_306683_ExcludeCharacter((CHARACTER)_Character)
AND
DB_Origins(_Character)
THEN
DB_GUS_306683_Skipped(_Character);

//END_REGION

//REGION GUS-310759
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
THEN
DB_GLO_Tutorials_HonorModeBosses((CHARACTER)S_UND_KethericCity_AdamantineGolem_2a5997fc-5f2a-4a13-b309-bed16da3b255);
DB_GLO_Tutorials_HonorModeBosses((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_GLO_Tutorials_HonorModeBosses((CHARACTER)S_FOR_Bottomless_SpiderQueen_e6b2f3ba-2d02-4507-8680-6047322e1a4b);
DB_GLO_Tutorials_HonorModeBosses((CHARACTER)S_UND_TheDrowNere_06bf05c5-216b-4eaf-91f5-8f1dd3d57f30);
DB_GLO_Tutorials_HonorModeBosses((CHARACTER)S_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08);
DB_GLO_Tutorials_HonorModeBosses((CHARACTER)S_UND_Bulette_307934b5-6fb5-4fdc-a7ff-433a7ba175b3);
DB_GLO_Tutorials_HonorModeBosses((CHARACTER)S_UND_Automaton_5038c0f2-0022-4699-82ce-a319b30616bb);
DB_GLO_Tutorials_HonorModeBosses((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
DB_BUGFIX_Marker("GUS-310759");
//END_REGION GUS-310759

//REGION GUS-312638
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
NOT DB_QuestDef_LevelLoaded("LOW_AvengeWaveservant", "ReachedEND", "END_Main")
THEN
DB_QuestDef_LevelLoaded("LOW_AvengeWaveservant", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_PhilgravesMansion", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_ReachEmperorLair", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_RecoverRakathsGold", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_SaveOmeluum", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_StopTheGazette", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("WYR_FreeFlorrick", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("GLO_DoubtingArtist", "ReachedEND", "END_Main");
DB_QuestDef_State((FLAG)EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e, "EPI_EnjoyParty", "EnjoyTheParty");
//END_REGION

//REGION GUS-312823

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4 Hotfix 3")
AND
NOT DB_Camp_QueuedNight(_)
AND
DB_RelationshipDialog_Queue(_Camper,_RD,_Flag, "CAMP",_PartnerDateOnly, _MinApproval)
AND
GUIDToString(_RD, _GUIDString)
AND
Concatenate("GUS-312823 - 1 - ", _GUIDSTRING, _Marker)
THEN
NOT DB_RelationshipDialog_Queue(_Camper,_RD,_Flag, "CAMP",_PartnerDateOnly, _MinApproval);
DB_BUGFIX_Marker(_Marker);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4 Hotfix 3")
AND
DB_Camp_QueuedNight(_Night)
AND
DB_RelationshipDialog_Queue(_Camper,_RD,_Flag, "CAMP",_PartnerDateOnly, _MinApproval)
AND
NOT QRY_GUS_312823_RDFittingForNight(_RD)
AND
GUIDToString(_RD, _GUIDString)
AND
Concatenate("GUS-312823 - 2 - ", _GUIDSTRING, _Marker)
THEN
NOT DB_RelationshipDialog_Queue(_Camper,_RD,_Flag, "CAMP",_PartnerDateOnly, _MinApproval);
DB_BUGFIX_Marker(_Marker);

QRY
QRY_GUS_312823_RDFittingForNight((DIALOGRESOURCE)_RD)
AND
DB_CampNight_CRD(_Night, _Camper, _RD, _Flag)
AND
DB_Camp_QueuedNight(_Night)
THEN
DB_NOOP(1);

//END_REGION GUS-312823

//REGION GUS-312699
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4 Hotfix 3")
THEN
DB_BUGFIX_Marker("GUS-312699");
PROC_BUGFIX_FillDirectlySetAnubisConfigs();
PROC_BUGFIX_RevertedAnubisConfigsOnShapeshifted();

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
GetRegion(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "CRE_Main_A")
THEN
DB_BUGFIX_DirectlySetAnubis((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,"ORI_Laezel_Act1b");

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
NOT DB_BUGFIX_DirectlySetAnubis(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,_)
THEN
DB_BUGFIX_DirectlySetAnubis(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,"ORI_Laezel");

//Setup Halsin since he had savegame patches that manually set his config
PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
DB_CurrentLevel(_Level)
AND
DB_GLO_LevelTraveler(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,_Level,_Config)
THEN
DB_BUGFIX_DirectlySetAnubis(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,_Config);

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
NOT DB_BUGFIX_DirectlySetAnubis(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,_)
THEN
DB_BUGFIX_DirectlySetAnubis(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,"GLO_Halsin_Act1");

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
DB_CurrentLevel(_Level)
AND
DB_GLO_LevelTraveler(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_Level,_Config)
THEN
DB_BUGFIX_DirectlySetAnubis(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_Config);

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
DB_PartOfTheTeam(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
NOT DB_BUGFIX_DirectlySetAnubis(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_)
THEN
DB_BUGFIX_DirectlySetAnubis(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GLO_DrowCommander_Act2_2");

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
NOT DB_BUGFIX_DirectlySetAnubis(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_)
AND
DB_LevelLoadedOnce("END_Main")
THEN
DB_BUGFIX_DirectlySetAnubis(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"END_UndergroundMinthara");

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
NOT DB_BUGFIX_DirectlySetAnubis(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_)
THEN
DB_BUGFIX_DirectlySetAnubis(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"GLO_DrowCommander_Act1");

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_BUGFIX_DirectlySetAnubis(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,"ORI_Gale_Act3");	//this config checks flags for the shrine behaviour, so can just always use it in Act3

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
NOT DB_BUGFIX_DirectlySetAnubis(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,_)
THEN
DB_BUGFIX_DirectlySetAnubis(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,"ORI_Gale");

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
THEN
DB_BUGFIX_DirectlySetAnubis(S_WYR_Circus_DressingRoomWorker_1985a13e-b870-4618-8c19-09f79667c598,"WYR_Circus_DressingRoomWorker_2");

PROC
PROC_BUGFIX_FillDirectlySetAnubisConfigs()
AND
DB_OnlyOnce("KethericShowdown_CrownController")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_SCE_Debrief_Participant_Config(_Char,_Config)
THEN
DB_BUGFIX_DirectlySetAnubis(_Char,_Config);

// First, characters for which anubis was set with DEV_EnableAnubis are added to DB_AnubisConfigs to fix the mismatch with configs they actually have
PROC
PROC_BUGFIX_RevertedAnubisConfigsOnShapeshifted()
AND
DB_BUGFIX_DirectlySetAnubis(_Character,_DirectlySetAnubisConfig)
THEN
NOT DB_BUGFIX_DirectlySetAnubis(_Character,_DirectlySetAnubisConfig);
PROC_SetAnubisConfig_ClearTracking(_Character);	//clear our Anubis config tracking. This would be a bug if there'd be any entries in there, since our state tracking is out of sync.
DB_BUGFIX_RevertedAnubisConfigOnShapeshifted_AnubisConfigsToCheck(_Character,_DirectlySetAnubisConfig);

// Colony zombies are excluded as they got COL_ZOMBIE status that changed their anubis, so they don't need to be patched
PROC
PROC_BUGFIX_RevertedAnubisConfigsOnShapeshifted()
AND
DB_AnubisConfigs(_Character,_ScriptSetAnubisConfig)
AND
NOT DB_AnubisConfigsOverrideStack(_Character,_,_)
AND
NOT DB_COL_NecromancerLab_AllZombies(_Character)
THEN
DB_BUGFIX_RevertedAnubisConfigOnShapeshifted_AnubisConfigsToCheck(_Character,_ScriptSetAnubisConfig);

// Fix all already active chars when the save game is loaded as they won't send Activated events. Heavy, but done only once
PROC
PROC_BUGFIX_RevertedAnubisConfigsOnShapeshifted()
AND
DB_BUGFIX_RevertedAnubisConfigOnShapeshifted_AnubisConfigsToCheck(_Character,_ScriptSetAnubisConfig)
AND
IsActive(_Character,1)
THEN
PROC_BUGFIX_RevertedAnubisConfigsOnShapeshifted_PatchCharacter(_Character,_ScriptSetAnubisConfig);

IF
Activated((CHARACTER)_Character)
AND
DB_BUGFIX_RevertedAnubisConfigOnShapeshifted_AnubisConfigsToCheck(_Character,_ScriptSetAnubisConfig)
THEN
PROC_BUGFIX_RevertedAnubisConfigsOnShapeshifted_PatchCharacter(_Character,_ScriptSetAnubisConfig);

PROC
PROC_BUGFIX_RevertedAnubisConfigsOnShapeshifted_PatchCharacter((CHARACTER)_Character,(STRING)_ScriptSetAnubisConfig)
AND
DB_BUGFIX_RevertedAnubisConfigOnShapeshifted_AnubisConfigsToCheck(_Character,_ScriptSetAnubisConfig)
THEN
NOT DB_BUGFIX_RevertedAnubisConfigOnShapeshifted_AnubisConfigsToCheck(_Character,_ScriptSetAnubisConfig);

PROC
PROC_BUGFIX_RevertedAnubisConfigsOnShapeshifted_PatchCharacter((CHARACTER)_Character,(STRING)_ScriptSetAnubisConfig)
AND
GetAnubisConfig(_Character,_CurrentAnubisConfig)
AND
_ScriptSetAnubisConfig != _CurrentAnubisConfig
THEN
NOT DB_AnubisConfigs(_Character,_ScriptSetAnubisConfig);
PROC_SetAnubisConfig(_Character,_ScriptSetAnubisConfig);

// Needed for the save game patch logic not to overlap with level travellers and manual calls of PROC_SetAnubisConfig
PROC
PROC_SetAnubisConfig_Internal((CHARACTER)_Character,(STRING)_AnubisConfig)
AND
DB_BUGFIX_RevertedAnubisConfigOnShapeshifted_AnubisConfigsToCheck(_Character,_PatchAnubisConfig)
THEN
NOT DB_BUGFIX_RevertedAnubisConfigOnShapeshifted_AnubisConfigsToCheck(_Character,_PatchAnubisConfig);
//END_REGION

//REGION GUS-307787
// Remove previously applied statuses from STATS
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
HasAppliedStatus(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "PLAYER_BONUSES_EASYMODE", 1)
THEN
DB_BUGFIX_Marker("GUS-307787");
RemoveStatus(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "PLAYER_BONUSES_EASYMODE", S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
HasAppliedStatus(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "PLAYER_BONUSES_EASYMODE", 1)
THEN
DB_BUGFIX_Marker("GUS-307787");
RemoveStatus(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "PLAYER_BONUSES_EASYMODE", S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

// Apply new ones if needed
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GLO_DifficultyModes_BoostedEntities(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b) // This will only be true if players betrayed the tieflings
THEN
DB_BUGFIX_Marker("GUS-307787");
PROC_GLO_DifficultyModes_RemoveHPBoostedEntity(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_GLO_DifficultyModes_AddPlayerBonuses((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b); // Use player bonuses instead

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20)
THEN
DB_BUGFIX_Marker("GUS-307787");
PROC_GLO_DifficultyModes_AddPlayerBonuses((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
//END_REGION GUS-307787

//REGION GUS-318910 Osiris thinks Avatar is in party, but it is still an NPC
PROC
PROC_ApplySavegamePatches()
AND
DB_Avatars(_Avatar)
AND
IsPartyMember(_Avatar,1,0)
THEN
MakePlayer(_Avatar,NULL_00000000-0000-0000-0000-000000000000,1);
DB_BUGFIX_Marker("GUS-318910 Fixed Avatar that was not a partymember",_Avatar);
PROC_Bugfix_GUS318910_CheckForStuckSleep(_Avatar);

PROC
PROC_Bugfix_GUS318910_CheckForStuckSleep((CHARACTER)_Avatar)
AND
DB_Camp_WaitingforSleepMomentsDone(1)
THEN
DB_Camp_SleepMomentsDone(_Avatar);
PROC_Camp_CheckSleepMomentsLoopDone();
DB_BUGFIX_Marker("GUS-318910 Fixed Avatar that was not a partymember & stuck sleeping",_Avatar);
//END_REGION


//REGION GUS-313061
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_IsArrested(_Arrester, _Player)
AND
NOT QRY_CRIME_GUS313061_IsInAnyPrison(_Player)
THEN
DB_BUGFIX_Marker("GUS-313061", _Player);
ClearFlag((FLAG)IsInPrison_c9b75b21-6eba-065e-7680-fc9a0c5838e4, _Player, 0);
NOT DB_IsArrested(_Arrester,_Player);

QRY
QRY_CRIME_GUS313061_IsInAnyPrison((CHARACTER)_Player)
AND
DB_RegionPrison(_Area, _PrisonTrigger, _)
AND
IsInTrigger(_Player, _PrisonTrigger, 1)
THEN
DB_NOOP(1);

QRY
QRY_CRIME_GUS313061_IsInAnyPrison((CHARACTER)_Player)
AND
DB_RegionPrison_CustomCell(_Area, _PrisonTrigger, _Player, _, _, _)
AND
IsInTrigger(_Player, _PrisonTrigger, 1)
THEN
DB_NOOP(1);

//END_REGION

//REGION GUS-315764 Dismissed Dead Avatars resurrected by Withers didn't join party again after resurrection

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 6")
AND
DB_Avatars(_LostPlayer)
AND
GetReservedUserID(_LostPlayer,-65536)
THEN
DB_DismissedAvatar(_LostPlayer);
NOT DB_Players(_LostPlayer);
NOT DB_Avatars(_LostPlayer);
PROC_GLO_PartyMembers_DismissAvatar(_LostPlayer);
PROC_CheckPartyFull();
DB_BUGFIX_Marker("GUS-312586 Dismissed Dead Avatars resurrected by Withers didn't join party again after resurrection",_LostPlayer);
//END_REGION GUS-315764

//REGION GUS-312139

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_Achievements_BG3_Quest27_ImprovisedWeaponSpell("Throw_ImprovisedWeapon");
DB_Achievements_BG3_Quest27_ImprovisedWeaponSpell("Throw_ImprovisedWeaponBerserker");

//END_REGION GUS-312139

//REGION GUS-312586
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_CAMP_Laezel_Romance2_DuelOngoing(1)
AND
NOT DB_Camp_LaezelRomance2(1)
THEN
PROC_PROC_ApplySavegamePatches_GUS_312586();
DB_BUGFIX_Marker("GUS-312586");

PROC
PROC_PROC_ApplySavegamePatches_GUS_312586()
THEN
PROC_ORI_Laezel_Romance2_FallbackCleanup();

PROC
PROC_PROC_ApplySavegamePatches_GUS_312586()
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_InCamp((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
PROC_DismissToCamp((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

PROC
PROC_PROC_ApplySavegamePatches_GUS_312586()
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_InCamp((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
SetEntityEvent(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "Origin_RestoreDialog", 1);
//END_REGION

//REGION GUS-309255

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_Achievements_BG3_Quest16_Classes((TAG)BARBARIAN_02913f9a-f696-40cf-acdf-32032afab32c);
DB_Achievements_BG3_Quest16_Classes((TAG)BARD_d93434bd-6b71-4789-b128-ee24156057cc);
DB_Achievements_BG3_Quest16_Classes((TAG)CLERIC_1671b4bf-4f47-4bb7-9cb9-80bb1f6009d5);
DB_Achievements_BG3_Quest16_Classes((TAG)DRUID_44ac4317-4d38-4d28-80e2-94024c6e42f0);
DB_Achievements_BG3_Quest16_Classes((TAG)FIGHTER_1ae7017c-4884-4a43-bc4a-742fa0d201c0);
DB_Achievements_BG3_Quest16_Classes((TAG)MONK_e1e460bb-d0ae-4452-8529-c9e176558731);
DB_Achievements_BG3_Quest16_Classes((TAG)PALADIN_6d85ab2d-5c23-498c-a61e-98f05a00177a);
DB_Achievements_BG3_Quest16_Classes((TAG)RANGER_37a733c1-a862-4157-b92a-9cff46232c6a);
DB_Achievements_BG3_Quest16_Classes((TAG)ROGUE_f8a0608b-666c-4be6-a49c-03b369c10bd2);
DB_Achievements_BG3_Quest16_Classes((TAG)SORCERER_18266c0b-efbc-4c80-8784-ada4a37218d7);
DB_Achievements_BG3_Quest16_Classes((TAG)WIZARD_6fe3ae27-dc6c-4fc9-9245-710c790c396c);
DB_Achievements_BG3_Quest16_Classes((TAG)WARLOCK_5804f55a-93f7-4281-9512-8d548a9e2a22);

//END_REGION GUS-309255


//REGION GUS-313473
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
THEN
DB_GLO_CompoundFlag((FLAG)Jaheira_InParty_ScrollDiscussedAndBurned_1d39818b-cd91-45e7-91de-a3779c413014, (FLAG)ORI_Jaheira_State_Retired_5a034473-9b26-e8f6-28c2-9c012372c5de);
DB_BUGFIX_Marker("GUS-313473-A");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag((FLAG)Jaheira_InParty_ScrollDiscussedAndBurned_1d39818b-cd91-45e7-91de-a3779c413014)
THEN
SetFlag((FLAG)ORI_Jaheira_State_Retired_5a034473-9b26-e8f6-28c2-9c012372c5de);
DB_BUGFIX_Marker("GUS-313473-B");
//END_REGION

//REGION GUS-307787
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GLO_DifficultyClasses(_Difficulty, _Flag)
THEN
DB_BUGFIX_Marker("GUS-307787");
NOT DB_GLO_DifficultyClasses(_Difficulty, _Flag);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
THEN
DB_BUGFIX_Marker("GUS-307787");
DB_GLO_DifficultyClasses((RULESETMODIFIER)SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521, "EASY", 	(FLAG)GLO_DifficultyMode_Easy_8ff3ba67-ada2-442b-925c-ee2415359024);
DB_GLO_DifficultyClasses((RULESETMODIFIER)SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521, "MEDIUM", (FLAG)GLO_DifficultyMode_Medium_0fc95071-9342-44d5-988a-30e8a8c8b787);
DB_GLO_DifficultyClasses((RULESETMODIFIER)SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521, "HARD", 	(FLAG)GLO_DifficultyMode_Hard_aba45e0b-b623-404d-8bba-0ab65e480586);
DB_GLO_DifficultyClasses((RULESETMODIFIER)CHARACTER_STATS_DIFFICULTY_7d788f28-1df5-474b-b106-4f8d0b6de928, "STATUS_EASY", 	(FLAG)GLO_DifficultyMode_CharacterStats_Easy_73c9db9a-efcb-40cc-8815-5162b87d6b02);
DB_GLO_DifficultyClasses((RULESETMODIFIER)CHARACTER_STATS_DIFFICULTY_7d788f28-1df5-474b-b106-4f8d0b6de928, "STATUS_MEDIUM", (FLAG)GLO_DifficultyMode_CharacterStats_Medium_b2c46d86-0d5d-42ae-9f15-c1020a007123);
DB_GLO_DifficultyClasses((RULESETMODIFIER)CHARACTER_STATS_DIFFICULTY_7d788f28-1df5-474b-b106-4f8d0b6de928, "STATUS_HARD", 	(FLAG)GLO_DifficultyMode_CharacterStats_Hard_f6360070-ce41-41d7-8cbe-75ec3b6d6ddb);


// Remove previously applied statuses from STATS
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
HasAppliedStatus(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "PLAYER_BONUSES_EASYMODE", 1)
THEN
DB_BUGFIX_Marker("GUS-307787");
RemoveStatus(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "PLAYER_BONUSES_EASYMODE", S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
HasAppliedStatus(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "PLAYER_BONUSES_EASYMODE", 1)
THEN
DB_BUGFIX_Marker("GUS-307787");
RemoveStatus(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "PLAYER_BONUSES_EASYMODE", S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

// Apply new ones if needed
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GLO_DifficultyModes_BoostedEntities(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b) // This will only be true if players betrayed the tieflings
THEN
DB_BUGFIX_Marker("GUS-307787");
PROC_GLO_DifficultyModes_RemoveHPBoostedEntity(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_GLO_DifficultyModes_AddPlayerBonuses((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b); // Use player bonuses instead

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20)
THEN
DB_BUGFIX_Marker("GUS-307787");
PROC_GLO_DifficultyModes_AddPlayerBonuses((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
//END_REGION GUS-307787
//REGION GUS-312131
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
AND
DB_ORI_Partnered(_Avatar,_Companion)
AND
QRY_ORI_HasOnlyDeadPartners(_Avatar) // QRY will set the flag
THEN
DB_BUGFIX_Marker("GUS-312131", _Avatar);
//END_REGION GUS-312131

//REGION GUS-296403
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "WLD_Main_A", "GUS-296403-A");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-296403-B");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-296403-A")
THEN
TeleportToPosition(S_PLA_PaladinsOfTyr_RiverMapMarker_27e1fb4d-e98a-4100-adfc-49b12cb8746f, 105.0, 20.0, 508.0);
TeleportToPosition(S_PLA_Wyll_HuntKarlach_MapMarker_28c29cee-4320-4fc0-bf1a-c24632ec45f6, 104.0, 21.0, 516.0);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-296403-B")
THEN
TeleportToPosition(S_TWN_Distillery_AreaMapMarker_a6136385-8803-40c6-bcf2-d81bb2ee6eab, -225.0, 16.0, -73.0);
//END_REGION GUS-296403

//REGION GUS-281601

PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce(_Level)
AND
NOT DB_LevelUnreachable(_Level)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", _Level, "GUS-281601");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUS-281601")
THEN
PROC_SetOnStage(DEC_GEN_WaterPump_A_000_cbedf8b0-3789-81c7-643a-ea75c6478228, 0);
PROC_SetOnStage(DEC_GEN_WaterPump_A_000_259d2fc1-92ce-8dfc-121e-7344bea33508, 0);
PROC_SetOnStage(DEC_GEN_WaterPump_A_000_9b079f1d-b742-85fb-1850-6f225bc7e075, 0);
PROC_SetOnStage(DEC_GEN_WaterPump_A_000_fddc187a-8203-8aff-3825-4a40b27538e0, 0);
PROC_SetOnStage(DEC_GEN_WaterPump_A_000_ed7fa4f4-fcff-8f2f-2fa7-11c7efe83bdb, 0);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-281601")
THEN
PROC_SetOnStage(DEC_GEN_WaterPump_A_000_c7a1ab8b-6921-445c-8e81-033791d22c88, 0);

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-281601")
THEN
PROC_SetOnStage(DEC_GEN_WaterPump_A_000_3bc8fef7-9283-43f1-97f8-56d430ae1c59, 0);

//END_REGION

//REGION GUS-312057

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5")
THEN
PROC_BUGFIX_GUS312057_CollectCrimes();

//since we now interrupt all crimes from the previous level, we can safely finish anything that is not valid for the current level
PROC
PROC_BUGFIX_GUS312057_CollectCrimes()
AND
DB_InternScene_ContinuousDisturbance(_CrimeID)
THEN
DB_GUS312057_CrimeCollection(_CrimeID);

PROC
PROC_BUGFIX_GUS312057_CollectCrimes()
AND
DB_InternScene_DisturbanceAllowed(_CrimeID,_)
THEN
DB_GUS312057_CrimeCollection(_CrimeID);

PROC
PROC_BUGFIX_GUS312057_CollectCrimes()
AND
DB_InternScene_AllowDisturbanceForScene(_CrimeID,_)
THEN
DB_GUS312057_CrimeCollection(_CrimeID);

PROC
PROC_BUGFIX_GUS312057_CollectCrimes()
AND
DB_GUS312057_CrimeCollection(_CrimeID)
AND
// Won't assert if the crime no longer exists, but will fail
NOT CrimeGetTension(_CrimeID,_)
THEN
DB_GUS312057_Crime(_CrimeID);

PROC
PROC_BUGFIX_GUS312057_CollectCrimes()
THEN
SysClear("DB_GUS312057_CrimeCollection",1);

PROC
PROC_BUGFIX_GUS312057_CollectCrimes()
AND
DB_GUS312057_Crime(_CrimeID)
THEN
PROC_CRIME_Finished(_CrimeID);	//don't clear the DB_GUS312057_Crime just yet

//check if we can clear our DB_GUS312057_Crime DB
IF
LevelLoaded(_NewLevel)
AND
NOT DB_LevelLoadedOnce(_NewLevel)
AND
DB_Level_InaccessibleAfterLoading(_,_NewLevel)
THEN
DB_GUS312057_CanClearCrimes(1);		//we've reached a point of no return, so we're clearing our old level caches. That means we can't travel back to previous levels. That means that we won't restore the level cache or those crimes anymore
									//TODO: check what happens with global characters that might be investigating a crime from the cache still. Do we clear their crime when we teleport them outside of the level?
IF
LevelLoaded(_NewLevel)
AND
DB_LevelLoadedOnce(_NewLevel)
AND
NOT DB_GUS312057_CanClearCrimes(1)	//we loaded a previous level, but this one still has a valid level cache. We need to force resolve the crimes that are valid for this level, that way we reset the investigator states
AND
DB_GUS312057_Crime(_CrimeID)
AND
CrimeGetTension(_CrimeID,_)
THEN
DEV_CrimeForceResolve(_CrimeID);
NOT DB_GUS312057_Crime(_CrimeID);

IF
LevelLoaded(_)
AND
DB_GUS312057_CanClearCrimes(1)
AND
DB_GUS312057_Crime(_CrimeID)
THEN
NOT DB_GUS312057_Crime(_CrimeID);

IF
LevelLoaded(_)
THEN
NOT DB_GUS312057_CanClearCrimes(1);

//END_REGION GUS-312057

//REGION GUS-313660
// in the process of disappearing to the camp
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 5")
AND
DB_DisappearedOutOfSight(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _, _, _, "ORI_AstarionRecruitment_ToCamp", _, _)
AND
DB_ORI_Astarion_LastRecruiter(_LastRecruiter)
THEN
RegisterAsCompanion((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _LastRecruiter);
DB_BUGFIX_Marker("GUS-313660");

// already moved to the camp via custom scripting
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 5")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_OnlyOncePerPlayer((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "Recruitment_Respec")
AND
DB_ORI_Astarion_LastRecruiter(_LastRecruiter)
THEN
RegisterAsCompanion((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _LastRecruiter);
DB_BUGFIX_Marker("GUS-313660");
//END_REGION

//REGION GUS-311120

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 5")
THEN
PROC_QRY_DoNTimesInit();
//END_REGION

//REGION GUS-312637
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 4")
AND
DB_Disturbance_PerformWhenAvailable_Queued(_NPC,_DisturbanceType,_Evidence,_Victim,_Delay)
AND
DB_PermaDefeated(_NPC)
THEN
DB_BUGFIX_GUS312637_Queued(_NPC,_DisturbanceType,_Evidence,_Victim,_Delay);

IF
DB_BUGFIX_GUS312637_Queued(_NPC,_DisturbanceType,_Evidence,_Victim,_Delay)
AND
DB_CurrentLevel(_)
AND
Exists(_NPC,1)
THEN
NOT DB_BUGFIX_GUS312637_Queued(_NPC,_DisturbanceType,_Evidence,_Victim,_Delay);
DB_BUGFIX_Marker("GUS-312637",_NPC);
PROC_Disturbance_PerformWhenAvailable_Reevaluate(_NPC,_DisturbanceType,_Evidence,_Victim,_Delay);
//END_REGION

//REGION GUS-313502

//Achievement likely to have been blocked by becoming an oathbreaker paladin
//Forgive all respeccing just for this case, just this once
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_Achievements_BG3_Quest16_AchievementBlocked((CHARACTER)_Player)
AND
GetFlag(GLO_PaladinOathbreaker_State_HasBeenOathbreakerOnce_3f3ec686-bbc1-4fdd-a08b-984e6a3030a6,_Player,1)
THEN
NOT DB_Achievements_BG3_Quest16_AchievementBlocked((CHARACTER)_Player);
DB_BUGFIX_Marker("GUS-313502",_Player);

//END_REGION GUS-313502

//REGION GUS-311011
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_UND_KuoToaGod_BlessedCharacters(_Player)
AND
HasActiveStatus(_Player, "UND_BOOOALBLESSING", 0)
THEN
DB_BUGFIX_Marker("GUS-311011");
ApplyStatus(_Player, "UND_BOOOALBLESSING", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION GUS-GUS-313357
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
// Mainly to prevent compilation error regarding DB (un)set but never checked
DB_LootDistribution_Distributor("DEN_Tieflings", (CHARACTER)S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, (ITEM)S_DEN_LootDistributionChest_a2dce88f-f0a9-46a2-b404-f09844e695b9)
THEN
NOT DB_LootDistribution_Distributor("DEN_Tieflings", (CHARACTER)S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, (ITEM)S_DEN_LootDistributionChest_a2dce88f-f0a9-46a2-b404-f09844e695b9);
NOT DB_LootDistribution_Distributor("DEN_Tieflings", (CHARACTER)S_DEN_TieflingRefugee_RangerTrader_001_637d8d68-2a04-409e-a77d-cf31ac9478ee, (ITEM)S_DEN_LootDistributionChest_a2dce88f-f0a9-46a2-b404-f09844e695b9);
DB_LootDistribution_Distributor("WLD_Main_A", "DEN_Tieflings", (CHARACTER)S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, (ITEM)S_DEN_LootDistributionChest_a2dce88f-f0a9-46a2-b404-f09844e695b9, (TRIGGER)S_DEN_TeflingsLootStashTrigger_a504ed46-68b1-4ba5-921a-50e7a28f6e30, (TRIGGER)S_DEN_TeflingsLootStashTrigger_a504ed46-68b1-4ba5-921a-50e7a28f6e30);
DB_LootDistribution_Distributor("WLD_Main_A", "DEN_Tieflings", (CHARACTER)S_DEN_TieflingRefugee_RangerTrader_001_637d8d68-2a04-409e-a77d-cf31ac9478ee, (ITEM)S_DEN_LootDistributionChest_a2dce88f-f0a9-46a2-b404-f09844e695b9, (TRIGGER)S_DEN_TeflingsLootStashTrigger_a504ed46-68b1-4ba5-921a-50e7a28f6e30, (TRIGGER)S_DEN_TeflingsLootStashTrigger_a504ed46-68b1-4ba5-921a-50e7a28f6e30);
NOT DB_LootDistribution_Distributor("DEN_Druids", (CHARACTER)S_DEN_ServantPlight_005_13db744d-8a48-4131-8801-fd5fc289fdf6, (ITEM)S_DEN_DruidsLootDistributionStash_87f3cb9c-88d5-4d19-bfba-41955b585b6f);
NOT DB_LootDistribution_Distributor("DEN_Druids", (CHARACTER)S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, (ITEM)S_DEN_DruidsLootDistributionStash_87f3cb9c-88d5-4d19-bfba-41955b585b6f);
DB_LootDistribution_Distributor("WLD_Main_A", "DEN_Druids", (CHARACTER)S_DEN_ServantPlight_005_13db744d-8a48-4131-8801-fd5fc289fdf6, (ITEM)S_DEN_DruidsLootDistributionStash_87f3cb9c-88d5-4d19-bfba-41955b585b6f, (TRIGGER)S_DEN_Cave_SUB_adecafa4-27c6-4b2f-bf9e-6ffd7c81a766, (TRIGGER)S_DEN_DruidLairLootStashTrigger_cbcc67c1-c5aa-47ed-80f2-c4113a75f575);
DB_LootDistribution_Distributor("WLD_Main_A", "DEN_Druids", (CHARACTER)S_DEN_DruidLeader_95eb2b0b-a522-4ea5-8167-c5f4d1418156, (ITEM)S_DEN_DruidsLootDistributionStash_87f3cb9c-88d5-4d19-bfba-41955b585b6f, (TRIGGER)S_DEN_DruidLair_SUB_a9794f19-187a-4d79-b739-443548411d29, (TRIGGER)S_DEN_DruidLairLootStashTrigger_cbcc67c1-c5aa-47ed-80f2-c4113a75f575);
//END_REGION

//REGION GUS-309075/GUS-305895
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 5")
AND
DB_PartOfTheTeam(_Char)
AND
TemplateIsInInventory(UNI_CRE_HUM_Sun_Mace_BloodOfLathander_96a35552-0c05-4df0-9974-2a8f142e4be6, _Char, 0)
AND
HasAppliedStatus(_Char, "MAG_LATHANDERS_BLESSING_RESURRECT_RESOURCE", 1)
THEN
RemoveStatus(_Char, "MAG_LATHANDERS_BLESSING_RESURRECT_RESOURCE", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-305895", _Char);
DB_BUGFIX_Marker("GUS-309075", _Char);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 5")
AND
DB_PartOfTheTeam(_Char)
AND
TemplateIsInInventory(UNI_CRE_HUM_Sun_Mace_BloodOfLathander_96a35552-0c05-4df0-9974-2a8f142e4be6, _Char, _Count)
AND
_Count > 0
AND
GUIDToString(_Char, _Result)
AND
Concatenate("BG3_SaveGamePatch_GUS305895_Lathander_", _Result, _IterateEvent)
AND
Concatenate("BG3_SaveGamePatch_GUS305895_Lathander_Finish_", _Result, _IterateFinalEvent)
THEN
IterateInventoryByTemplate(_Char,UNI_CRE_HUM_Sun_Mace_BloodOfLathander_96a35552-0c05-4df0-9974-2a8f142e4be6,_IterateEvent,_IterateFinalEvent);
DB_BG3_SaveGamePatch_GUS305895_Lathander(_Char, _IterateEvent, _IterateFinalEvent);
//Checking for multiple copies in the case the player cloned the weapon

IF
EntityEvent(_Weapon, _IterateEvent)
AND
DB_BG3_SaveGamePatch_GUS305895_Lathander(_Char, _IterateEvent, _IterateFinalEvent)
THEN
DB_BG3_SaveGamePatch_GUS305895_LathanderHolder(_Char, _Weapon);

IF
EntityEvent(_, _IterateFinalEvent)
AND
DB_BG3_SaveGamePatch_GUS305895_Lathander(_Char, _, _IterateFinalEvent)
AND
NOT QRY_BG3_SaveGamePatch_GUS305895_AnyLathanderIsEquipped((CHARACTER)_Char)
AND
HasAppliedStatus(_Char, "MAG_LATHANDERS_BLESSING_RESURRECT_RESOURCE", 1)
THEN
RemoveStatus(_Char, "MAG_LATHANDERS_BLESSING_RESURRECT_RESOURCE", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-305895", _Char);
DB_BUGFIX_Marker("GUS-309075", _Char);

QRY
QRY_BG3_SaveGamePatch_GUS305895_AnyLathanderIsEquipped((CHARACTER)_Char)
AND
DB_BG3_SaveGamePatch_GUS305895_LathanderHolder(_Char, _Weapon)
AND
IsEquipped((ITEM)_Weapon, 1)
THEN
DB_NOOP(1);

//END_REGION GUS-309075/GUS-305895


//REGION GUS-314216
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 5")
THEN
DB_BUGFIX_Marker("GUS-314216");
PROC_GUS314216_DoFix();

PROC
PROC_GUS314216_DoFix()
AND
DB_AvatarFactions(_Faction)
THEN
PROC_SetRelationMutual(_Faction,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,100);
PROC_SetRelationToPlayers_ClearHostileToPlayerGroup(_Faction);
PROC_SetRelationToPlayers_ClearIndivPlayerRelations(_Faction);

PROC
PROC_GUS314216_DoFix()
AND
DB_CompanionFactions(_Faction)
THEN
PROC_SetRelationMutual(_Faction,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,100);
PROC_SetRelationToPlayers_ClearHostileToPlayerGroup(_Faction);
PROC_SetRelationToPlayers_ClearIndivPlayerRelations(_Faction);

PROC
PROC_GUS314216_DoFix()
AND
DB_Hirelings_Factions(_Faction)
THEN
PROC_SetRelationMutual(_Faction,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,100);
PROC_SetRelationToPlayers_ClearHostileToPlayerGroup(_Faction);
PROC_SetRelationToPlayers_ClearIndivPlayerRelations(_Faction);

//END_REGION

//REGION GUS-313669
// First, individual cases are checked where anubis could have been changed from scripts and mismatch with DB_GLO_LevelTraveler. Then configs are checked for all level travelers based on the region they are currently in
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 4")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5 Hotfix 4","CTY_Main_A","GUS-313669_RepeatedCTYLevelTravelers");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5 Hotfix 4","SCL_MAIN_A","GUS-313669_SCE_Debrief");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5 Hotfix 4","SCL_MAIN_A","GUS-313669_SCL_Prisoners");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5 Hotfix 4","CTY_Main_A","GUS-313669_LOW_ZhentAgent");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5 Hotfix 4","CTY_Main_A","GUS-313669_LOW_Lakrissa");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5 Hotfix 4","CRE_Main_A","GUS-313669_CRE_GithBattleStations");
PROC_BUGFIX_Patch5_AnubisConfigCheck();
DB_BUGFIX_Marker("GUS-313669");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313669_RepeatedCTYLevelTravelers")
THEN
NOT DB_GLO_LevelTraveler((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "CTY_Main_A", "DefaultCharacter");
NOT DB_GLO_LevelTraveler((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, "CTY_Main_A", "DefaultCharacter");
NOT DB_GLO_LevelTraveler((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, "CTY_Main_A", "DefaultCharacter");

// Gnomes have no DB_GLO_LevelTraveler for SCL_Main_A. In case debrief config should be set on them, we ignore the one from DB_HAV_SavingPrisoners_Returner
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-313669_SCE_Debrief")
AND
DB_GlobalFlag((FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e)
AND
DB_SCE_Debrief_Participant_Config(_Character,_DebriefConfig)
AND
DB_SCE_Debrief_CharactersInEpilogue(_Character)
AND
NOT DB_PermaDefeated(_Character)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(_Character,_DebriefConfig);

// When ending up in MOO prison, characters will have different configs from what they have in DB_GLO_LevelTraveler
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-313669_SCL_Prisoners")
AND
DB_MOO_Jailbreak_PotentialTiefling(_Character,_,_,_PrisonerConfig)
AND
DB_MOO_Jailbreak_Prisoner(_Character,_)
AND
DB_HAV_SavingPrisoners_Returner(_Character,_,_,_,_ReturnedFlag,_)
AND
NOT DB_GlobalFlag(_ReturnedFlag)
THEN
PROC_BUGFIX_MOO_TieflingPrisonersAnubis(_Character,_PrisonerConfig);

PROC
PROC_BUGFIX_MOO_TieflingPrisonersAnubis((CHARACTER)_Character,(STRING)_PrisonerConfig)
AND
NOT QRY_BUGFIX_MOO_BecameTieflingPrisonLeader(_Character)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(_Character,_PrisonerConfig);

PROC
PROC_BUGFIX_MOO_TieflingPrisonersAnubis((CHARACTER)_Character,(STRING)_PrisonerConfig)
AND
QRY_BUGFIX_MOO_BecameTieflingPrisonLeader(_Character)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(_Character,"MOO_ProdigySister");

QRY
QRY_BUGFIX_MOO_BecameTieflingPrisonLeader((CHARACTER)_Character)
AND
_Character != S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d
AND
GetFlag((FLAG)MOO_Jailbreak_State_TieflingLeader_fa806828-c5a4-2691-ad46-be5e2ced9d67,_Character,1)
THEN
DB_NOOP(1);

// In case of being saved from prison, characters will have different configs from what they have in DB_GLO_LevelTraveler
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-313669_SCL_Prisoners")
AND
NOT DB_GlobalFlag((FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e)
AND
DB_HAV_SavingPrisoners_Returner(_Character,_,_,_,_ReturnedFlag,_ReturnedConfig)
AND
NOT DB_PermaDefeated(_Character)
AND
DB_MOO_Jailbreak_FreedFlag(_Character,_FreedFlag)
AND
DB_GlobalFlag(_FreedFlag)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(_Character,_ReturnedConfig);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313669_LOW_ZhentAgent")
AND
DB_GlobalFlag((FLAG)LOW_Guildhall_Zhent_Agent001_OffDuty_753e16d5-eda1-ba9f-d110-4765195cfc60)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(S_PLA_ZhentShipment_Agent_001_fd9b4edd-7828-4e22-85a9-ead2ba9d29e4,"LOW_Guildhall_Zhent_Agent_001");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313669_LOW_Lakrissa")
AND
QRY_BUGFIX_Patch5_AnubisConfigCheck_LakrissaFix()
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c,"LOW_Elfsong_LakrissaOnRooftop");

QRY
QRY_BUGFIX_Patch5_AnubisConfigCheck_LakrissaFix()
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_Event_LakrissaGoingUpstairs_13b8ec89-1a9d-c766-31df-3fcd3fde81b9)
THEN
DB_NOOP(1);

QRY
QRY_BUGFIX_Patch5_AnubisConfigCheck_LakrissaFix()
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74)
AND
NOT DB_GlobalFlag((FLAG)LOW_Elfsong_State_TalkWithAlfiraLakrissaRooftopOnce_d1031d99-f9a4-4b01-ac96-6bc2619ceab6)
THEN
DB_NOOP(1);

PROC
PROC_ApplySavegamePatchInLevel("CRE_Main_A", "GUS-313669_CRE_GithBattleStations")
AND
DB_GlobalFlag((FLAG)CRE_General_State_CrecheTurnedHostile_e183e7dc-c07a-4093-91dc-7814375c9582)
AND
DB_CRE_BattleStations(_Gith, _)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(_Gith,"CRE_BattleStations");
TimerLaunch("CRE_BattleStations_ConfigReassignTimer", 5000);

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck()
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
AND
NOT DB_PermaDefeated(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "DefaultCharacter");

// Some characters in END get new anubis only from these DBs and not from DB_GLO_LevelTraveler
PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck()
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck_END();
DB_BUGFIX_Marker("GUS-313669_PatchedEND");

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck_END()
AND
DB_CurrentLevel("END_Main")
AND
DB_END_GatherYourAllies_FollowUpDialogue(_Character,_,_END_AnubisConfig)
AND
DB_END_GatherYourAllies_PresentCharacter(_Character)
AND
NOT DB_GLO_LevelTraveler(_Character,"END_Main",_END_AnubisConfig)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(_Character, _END_AnubisConfig);

// There is no DB_GLO_LevelTraveler for Minthara in END
PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck_END()
AND
DB_LevelLoadedOnce("END_Main")
AND
NOT DB_PartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "END_UndergroundMinthara");

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck()
AND
DB_MOO_Execution_Goblin(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb,_)
AND
NOT DB_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, "MOO_Execution_Goblin2");

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck()
AND
GetRegion(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10,_ButlerInLevel)
AND
QRY_ORI_DarkUrgeButler_Config(_ButlerInLevel)
AND
DB_QRYRTN_DarkUrgeButler_Config(_ButlerConfig)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, _ButlerConfig);

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck()
AND
DB_GlobalFlag((FLAG)NIGHT_OrthonVisit_0f675d1a-5b1b-4e44-99fb-628ee14016e9)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "DefaultCharacter");

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck()
AND
DB_CurrentLevel("CRE_Main_A")
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,"ORI_Laezel_Act1b");

// In the very end, all level travelers are checked
PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck()
AND
DB_GLO_LevelTraveler(_Character,_Level,_LevelTravelerConfig)
AND
NOT DB_BUGFIX_Patch5_AnubisConfigCheck_CheckedCharacter(_Character)
AND
GetRegion(_Character,_Level)
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(_Character,_LevelTravelerConfig);

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck()
AND
DB_BUGFIX_Patch5_AnubisConfigCheck_CheckedCharacter(_Character)
THEN
NOT DB_BUGFIX_Patch5_AnubisConfigCheck_CheckedCharacter(_Character);

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck((CHARACTER)_Character,(STRING)_AnubisConfigToPatch)
AND
GetAnubisConfig(_Character,_CurrentAnubisConfig)
AND
_CurrentAnubisConfig != _AnubisConfigToPatch
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck_PatchCharacter(_Character,_AnubisConfigToPatch);

// The DB is cleaned in the end of initial save game patch. Needed so characters are not patched multiple times in case they are both in DB_GLO_LevelTraveler and have custom patching
PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck((CHARACTER)_Character,(STRING)_AnubisConfigToPatch)
AND
NOT DB_BUGFIX_Marker("GUS-313669")
THEN
DB_BUGFIX_Patch5_AnubisConfigCheck_CheckedCharacter(_Character);

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck_PatchCharacter((CHARACTER)_Character,(STRING)_AnubisConfigToPatch)
AND
NOT DB_AnubisConfigsOverrideStack(_Character,_,_)
THEN
NOT DB_AnubisConfigs(_Character, _AnubisConfigToPatch);
PROC_SetAnubisConfig(_Character,_AnubisConfigToPatch);

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck_PatchCharacter((CHARACTER)_Character,(STRING)_AnubisConfigToPatch)
AND
DB_AnubisConfigsOverrideStack(_Character,_,_)
THEN
DB_BUGFIX_Patch5_AnubisConfigCheck_CharacterWithOverridenAnubis(_Character,_AnubisConfigToPatch);

PROC
PROC_AnubisRestoreBaseConfig(_Character)
AND
DB_BUGFIX_Patch5_AnubisConfigCheck_CharacterWithOverridenAnubis(_Character,_AnubisConfigToPatch)
THEN
NOT DB_BUGFIX_Patch5_AnubisConfigCheck_CharacterWithOverridenAnubis(_Character,_AnubisConfigToPatch);
NOT DB_AnubisConfigs(_Character, _AnubisConfigToPatch);
PROC_SetAnubisConfig(_Character,_AnubisConfigToPatch);
//END_REGION

//REGION GUS-314075
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_Origins(_Origin)
THEN
PROC_BG3_SaveGamePatches_GUS314075_ClearFlag(_Origin, (FLAG)GLO_ORI_Event_InvitedToCamp_Walk_6dfae0e0-e6c4-4d4f-8979-df320356ea03);
PROC_BG3_SaveGamePatches_GUS314075_ClearFlag(_Origin, (FLAG)GLO_ORI_Event_InvitedToCamp_Run_07c4d37e-fc82-4055-b768-167650be9956);

PROC
PROC_BG3_SaveGamePatches_GUS314075_ClearFlag((CHARACTER)_Character, (FLAG)_Flag)
AND
GetFlag(_Flag, _Character, 1)
THEN
DB_BUGFIX_Marker("GUS-314075");
ClearFlag(_Flag, _Character);
//END_REGION GUS-314075

//REGION GUS-313783
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GLO_BlockGameOver_Statuses("DEATH_WARD_DOWNED")
THEN
DB_BUGFIX_Marker("GUS-313783");
NOT DB_GLO_BlockGameOver_Statuses("DEATH_WARD_DOWNED");
NOT DB_GLO_BlockGameOver_Statuses("RELENTLESS_ENDURANCE_DOWNED");
NOT DB_GLO_BlockGameOver_Statuses("RELENTLESS_RAGE_DOWNED");
NOT DB_GLO_BlockGameOver_Statuses("SURVIVAL_INSTINCT_DOWNED");
NOT DB_GLO_BlockGameOver_Statuses("MAG_1HP");
NOT DB_GLO_BlockGameOver_Statuses("POTION_OF_UNDYING_DOWNED");
NOT DB_GLO_BlockGameOver_Statuses("MAG_DEATH_DO_SHADOW_POSSESION_DOWNED");
NOT DB_GLO_BlockGameOver_Statuses("MAG_LATHANDERS_BLESSING_RESURRECT_RESOURCE");
NOT DB_GLO_BlockGameOver_Statuses("MAG_LATHANDERS_BLESSING_RESURRECT_TECHNICAL");
DB_BUGFIX_GUS_313783_RecheckGameOver(1);

IF
LevelGameplayStarted(_,_)
AND
DB_BUGFIX_GUS_313783_RecheckGameOver(1)
THEN
NOT DB_BUGFIX_GUS_313783_RecheckGameOver(1);
// Calling ShowGameOverMenu here doesn't work yet :(
TimerLaunch("Savegamepatch_GUS-313783",5000);

IF
TimerFinished("Savegamepatch_GUS-313783")
THEN
PROC_GameOver_CheckGameOver();

//END_REGION

//REGION GUS-310473
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_BUGFIX_Marker("GUS-310473");
DB_GLO_Spells_TransmutationStoneRoots((ROOT)LOOT_Spell_TransmutersStone_Constitution_5e6c5da3-43cc-4502-8e29-99a51fe7f661);
DB_GLO_Spells_TransmutationStoneRoots(LOOT_Spell_TransmutersStone_Darkness_4b3afc03-01f2-43b6-88f8-bd22af6533d8);
DB_GLO_Spells_TransmutationStoneRoots(LOOT_Spell_TransmutersStone_MovementSpeed_9cb9fb55-772a-4df1-bf8b-5b6d81d67baa);
DB_GLO_Spells_TransmutationStoneRoots(LOOT_Spell_TransmutersStone_Resistance_Acid_dfc6b155-c3e1-4610-b412-f6ffecb14ebd);
DB_GLO_Spells_TransmutationStoneRoots(LOOT_Spell_TransmutersStone_Resistance_Cold_992925fb-c27c-4c5d-9845-07abf216376b);
DB_GLO_Spells_TransmutationStoneRoots(LOOT_Spell_TransmutersStone_Resistance_Fire_50966f21-977d-408f-95fc-8862e9572ce0);
DB_GLO_Spells_TransmutationStoneRoots(LOOT_Spell_TransmutersStone_Resistance_Lightning_8233e8e7-55c9-4f72-8e7b-5f3dc36e250f);
DB_GLO_Spells_TransmutationStoneRoots(LOOT_Spell_TransmutersStone_Resistance_Thunder_f4e4ecf9-9170-4264-a9d9-bd5e57044f38);

//END_REGION

//REGION GUS-275417

//Clear flag for behaviour if Spear of Night is already equipped
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag(ORI_Shadowheart_Behaviour_HasSpearOfNight_bd6f222d-e7fe-4d78-a72f-ed1f44a752e9)
AND
NOT GetItemByTemplateInInventory(WPN_HUM_SpearOfNight_A_bca0fca1-b81d-47a7-9be3-18e43a8fe626,S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,_)
THEN
PROC_GlobalClearFlagAndCache(ORI_Shadowheart_Behaviour_HasSpearOfNight_bd6f222d-e7fe-4d78-a72f-ed1f44a752e9);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag(ORI_Shadowheart_Behaviour_HasSpearOfNight_bd6f222d-e7fe-4d78-a72f-ed1f44a752e9)
AND
GetItemByTemplateInInventory(WPN_HUM_SpearOfNight_A_bca0fca1-b81d-47a7-9be3-18e43a8fe626,S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,_Spear)
AND
IsEquipped((ITEM)_Spear,1)
THEN
ClearFlag(ORI_Shadowheart_Behaviour_HasSpearOfNight_bd6f222d-e7fe-4d78-a72f-ed1f44a752e9);

//END_REGION GUS-275417

//REGION GUS-314781

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 5")
AND
DB_Camp_ForceEndTheDay_CampOverride(_Override)
THEN
DB_BUGFIX_Marker("GUS-314781");
NOT DB_Camp_ForceEndTheDay_CampOverride(_Override);

//END_REGION

//REGION GUS-313669

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("INT_Main_A")
AND
DB_GlobalFlag((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_Players((CHARACTER)_Player)
AND
TemplateIsInPartyInventory((ITEMROOT)Quest_SCE_SeluniteSpear_d2fe9a24-affd-464a-b757-a48d6f50dd7d, _Player, 0, 0)
AND
NOT DB_BUGFIX_Marker("GUS-313669")
THEN
DB_BUGFIX_Marker("GUS-313669");
TemplateAddTo(Quest_SCE_SeluniteSpear_d2fe9a24-affd-464a-b757-a48d6f50dd7d, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1, 1);

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-313669");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-313669")
AND
DB_GlobalFlag((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
SetFlag((FLAG)SCE_Shadowheart_Event_GiveSeluneSpear_2a8cea6f-4b97-4450-acaa-397363293daa, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0);


//END_REGION GUS-313669

//REGION GUS-314735

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
//Stabilised Gale's Netherese orb
NOT DB_Achievements("BG3_Quest46",-1,"PER_USER");
DB_Achievements("BG3_Quest46",-1,"GLOBAL");
//Allied with Kith'rak Voss
NOT DB_Achievements("BG3_Quest47",-1,"PER_USER");
DB_Achievements("BG3_Quest47",-1,"GLOBAL");
//Gave Shadowheart her favourite flower the Orchid in SCL
NOT DB_Achievements("BG3_Quest48",-1,"PER_USER");
DB_Achievements("BG3_Quest48",-1,"GLOBAL");
//Went on a totally normal, mundane date with Karlach
NOT DB_Achievements("BG3_Quest49",-1,"PER_USER");
DB_Achievements("BG3_Quest49",-1,"GLOBAL");
//Let Astarion bite you
NOT DB_Achievements("BG3_Quest50",-1,"PER_USER");
DB_Achievements("BG3_Quest50",-1,"GLOBAL");
//Broke Wyll's Pact with Mizora
NOT DB_Achievements("BG3_Quest51",-1,"PER_USER");
DB_Achievements("BG3_Quest51",-1,"GLOBAL");
//Received slayer Form
NOT DB_Achievements("BG3_Quest52",-1,"PER_USER");
DB_Achievements("BG3_Quest52",-1,"GLOBAL");

//END_REGION GUS-315248


//REGION GUS-314735
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 5")
AND
DB_Origins(_Origin)
THEN
ClearFlag(ORI_Kiss_StartRandom_2a98bc41-f6b7-4277-a282-1a91c4ef8a9b, _Origin, 0);
//END_REGION GUS-314735

//REGION GUS-315248

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_BUGFIX_Marker("GUS-309076");
DB_LinkedCrimes("Murder", "KnockOut");
//END_REGION

//REGION GUS-308730
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
TemplateIsInInventory((ITEMROOT)DEN_VoloOperation_ErsatzEye_000cfc9f-b973-48e7-a5c8-f2992a47a943,S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,1)
AND
DB_GlobalFlag((FLAG)GLO_Volo_Knows_Lobotomy_6f016a74-c28b-4a6a-919e-b58223cc14cb)
AND
GetItemByTemplateInInventory((ITEMROOT)DEN_VoloOperation_ErsatzEye_000cfc9f-b973-48e7-a5c8-f2992a47a943,S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,_ErsatzEye)
THEN
DB_BUGFIX_Marker("GUS-308730");
Die(_ErsatzEye);
//END_REGION

//REGION GUS-256631
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_BUGFIX_Marker("GUS-256631-SOB");
DB_GLO_PaladinOathbreaker_ProtectedNPCs(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);
DB_GLO_PaladinOathbreaker_ProtectedNPCs(S_UND_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09);
//END_REGION GUS-256631

//REGION GUS-303491
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
DB_CharacterMovement(_Player, "Origin_RestoreDialog", _ID)
AND
NOT DB_PlayerInCamp(_Player)
AND
NOT DB_CAMP_WalkingToCamp(_Player)
THEN
DB_BUGFIX_Marker("GUS-303491");
PROC_CharacterMoveTo_Clear(_Player, _ID, "Cancelled");
PROC_SetOnStage(_Player,1);
SetHasDialog(_Player,1);
//END_REGION

//REGION GUS-314052
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_BUGFIX_Marker("GUS-314052");
DB_GlobalFlagReactionAfterDialog((FLAG)CAMP_Jergal_Event_AttackedOption_c656b8ed-38e1-a6b9-be8d-de0b16b17023, (DIALOGRESOURCE)CAMP_Jergal_7f4acd9b-15c0-81fe-9409-623634ec3ed3);
//END_REGION GUS-314052

//REGION GUS-296194
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_GLO_Spells_FlamingSphere_Auras("FLAMING_SPHERE_AURA", "FlamingSphere_State");
DB_GLO_Spells_FlamingSphere_Auras("FLAMING_SPHERE_AURA3", "FlamingSphere_State_3");
DB_GLO_Spells_FlamingSphere_Auras("FLAMING_SPHERE_AURA4", "FlamingSphere_State_4");
DB_GLO_Spells_FlamingSphere_Auras("FLAMING_SPHERE_AURA5", "FlamingSphere_State_5");
DB_GLO_Spells_FlamingSphere_Auras("FLAMING_SPHERE_AURA6", "FlamingSphere_State_6");
DB_BUGFIX_Marker("GUS-296194");
//END_REGION GUS-296194

//REGION GUS-305359
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_PartOfTheTeam(_Character)
AND
HasPassive(_Character,"CAMP_Volo_ErsatzEye",1)
THEN
DB_BUGFIX_Marker("GUS-305359");
ApplyStatus(_Character,"MAG_SEE_INVISIBILITY_HIDDEN_IGNORE_RESTING",-1.0);
//END_REGION

//REGION GUS-315404
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
DB_BUGFIX_Marker("GUS-315404");
NOT DB_ORI_OriginCampData((CHARACTER)S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231, "UNDERCITY", (TRIGGER)S_CAMP_UC_Oathbreaker_a3ca326a-b61a-401c-91b7-8e0dab5a5f53);
NOT DB_ORI_OriginCampData((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,"FARM",(TRIGGER)S_CAMP_FARM_UnfortunateGnome_13455ecf-4fe1-481d-89ef-351a88567e6f);
NOT DB_ORI_OriginCampData((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,"ELFSONG",(TRIGGER)S_CAMP_ELFSONG_UnfortunateGnome_2dac2d08-675f-45ca-8b20-0c37ffd7b11b);
NOT DB_ORI_OriginCampData((CHARACTER)S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,"FARM",(TRIGGER)S_CAMP_FARM_ArabellaPoint_7ab9bacf-1e46-4824-aa61-8d3d0d888fb5);
NOT DB_ORI_OriginCampData((CHARACTER)S_DEN_SnakeKid_02257c1c-bbec-4ae3-9bcb-31c75a0a982f,"ELFSONG",(TRIGGER)S_CAMP_ELFSONG_ArabellaPoint_23a5637a-0d75-4184-855e-6a43ac2fe41f);
NOT DB_ORI_OriginCampData((CHARACTER)S_DEN_ParentA_d6d88c8b-6ba7-4350-b3b3-d60565a44e90,"SCLMAIN",(TRIGGER)S_CAMP_ArabellasFatherPoint_a111cdca-1a06-4993-b527-80449e0a96ee);
NOT DB_ORI_OriginCampData((CHARACTER)S_DEN_ParentA_d6d88c8b-6ba7-4350-b3b3-d60565a44e90,"FARM",(TRIGGER)S_CAMP_FARM_ArabellasFatherPoint_68fbbaaa-9665-4adc-81ef-13d2826fd2b4);
NOT DB_ORI_OriginCampData((CHARACTER)S_DEN_ParentA_d6d88c8b-6ba7-4350-b3b3-d60565a44e90,"ELFSONG",(TRIGGER)S_CAMP_ELFSONG_ArabellasFatherPoint_2961141e-a087-49cc-8c04-28f23ad6d4c6);
NOT DB_ORI_OriginCampData((CHARACTER)S_DEN_ParentA_d6d88c8b-6ba7-4350-b3b3-d60565a44e90,"HAVEN",(TRIGGER)S_CAMP_HAVEN_ArrabelasFatherPoint_6563f03e-79e1-45b9-a061-344c1c306a79);
NOT DB_ORI_OriginCampData((CHARACTER)S_DEN_ParentA_d6d88c8b-6ba7-4350-b3b3-d60565a44e90,"INTMAIN",(TRIGGER)S_CAMP_HAVEN_ArrabelasFatherPoint_43701a35-f3cb-4c81-9099-64eb6bf982c8);
NOT DB_ORI_OriginCampData((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, "UNDERCITY", S_CAMP_UC_DarkUrge_Butler_7f7cabbb-d040-4ae6-8a82-c5329f0e66f5);
NOT DB_Hirelings_CampPositions("UNDERCITY",1,(TRIGGER)S_CAMP_UC_Hireling_000_37bb82ea-f908-4a68-9756-68260cb999da);
NOT DB_Hirelings_CampPositions("UNDERCITY",2,S_CAMP_UC_Hireling_001_8d2d8339-b02e-4cc4-897a-68d32ac789cc);
NOT DB_Hirelings_CampPositions("UNDERCITY",3,S_CAMP_UC_Hireling_002_184f6c55-f0bb-4515-a29a-8e09c3423d42);
//END_REGION GUS-315404

//REGION GUS-315698
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 6")
THEN
DB_BUGFIX_Marker("GUS-315698-DB");
DB_FallbackCamp_TeleporterCampPairings("ReadyCheck_ToCrecheFromPlains","WLDMAIN");

// if the player is already stuck in a wrong camp
// we need to teleport Raphael to them
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_GLO_MonitorIntro_HadIntro(1)
AND
DB_GLO_Monitor_DismissToCamp(1)
AND
DB_Camp_RequiredTalks(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8)
AND
DB_GlobalFlag(CAMP_MonitorIntro_ForcedEncounter_532bba9f-d7e8-cf36-db86-87bf8c4d22c8)
AND
NOT DB_ActiveCamp("WLDMAIN")
AND
NOT DB_ActiveCamp("WLDDUNSHA")
AND
DB_ActiveCamp(_ActiveCamp)
AND
DB_Camp(_ActiveCamp, _, _, _CampEntrance)
THEN
DB_BUGFIX_Marker("GUS-315698-Raphael");
TeleportTo(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _CampEntrance, "", 0, 0, 0, 1, 1);
//END_REGION

//REGION GUS-314797

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Is_EngineBlock_Move((CHARACTER)_Character)
THEN
DB_CantMove_IgnoreDialog((GUIDSTRING)_Character);
PROC_StateSet_CantMove_IgnoreDialog((GUIDSTRING)_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Dead((CHARACTER)_Character)
AND
NOT DB_CantMove_IgnoreDialog((GUIDSTRING)_Character)
THEN
DB_CantMove_IgnoreDialog((GUIDSTRING)_Character);
PROC_StateSet_CantMove_IgnoreDialog((GUIDSTRING)_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_KnockedOut((CHARACTER)_Character)
AND
NOT DB_CantMove_IgnoreDialog((GUIDSTRING)_Character)
THEN
DB_CantMove_IgnoreDialog((GUIDSTRING)_Character);
PROC_StateSet_CantMove_IgnoreDialog((GUIDSTRING)_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Petrified((GUIDSTRING)_Object)
AND
NOT DB_CantMove_IgnoreDialog((GUIDSTRING)_Object)
THEN
DB_CantMove_IgnoreDialog((GUIDSTRING)_Object);
PROC_StateSet_CantMove_IgnoreDialog((GUIDSTRING)_Object);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_FeignDeath((GUIDSTRING)_Object)
AND
NOT DB_CantMove_IgnoreDialog((GUIDSTRING)_Object)
THEN
DB_CantMove_IgnoreDialog((GUIDSTRING)_Object);
PROC_StateSet_CantMove_IgnoreDialog((GUIDSTRING)_Object);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_IronFlasked((CHARACTER)_Character)
AND
NOT DB_CantMove_IgnoreDialog((GUIDSTRING)_Character)
THEN
DB_CantMove_IgnoreDialog((GUIDSTRING)_Character);
PROC_StateSet_CantMove_IgnoreDialog((GUIDSTRING)_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Downed((CHARACTER)_Character)
AND
NOT DB_CantMove_IgnoreDialog((GUIDSTRING)_Character)
THEN
DB_CantMove_IgnoreDialog((GUIDSTRING)_Character);
PROC_StateSet_CantMove_IgnoreDialog((GUIDSTRING)_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_OffStage((GUIDSTRING)_Object)
AND
NOT DB_CantMove_IgnoreDialog((GUIDSTRING)_Object)
THEN
DB_CantMove_IgnoreDialog((GUIDSTRING)_Object);
PROC_StateSet_CantMove_IgnoreDialog((GUIDSTRING)_Object);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Is_Banished((CHARACTER)_Character)
AND
NOT DB_CantMove_IgnoreDialog((GUIDSTRING)_Character)
THEN
DB_CantMove_IgnoreDialog((GUIDSTRING)_Character);
PROC_StateSet_CantMove_IgnoreDialog((GUIDSTRING)_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_CRIME_FledOutOfSight(_Character)
AND
NOT DB_DisappearedOutOfSight(_Character, _, _, _, "GEB_NPCFledOutOfSight", _, _)
THEN
NOT DB_CRIME_FledOutOfSight(_Character);

//END_REGION

//REGION GUS-316819;GUS-316817

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
NOT DB_Hirelings_DialogFlagsVars(1,(FLAG)Hirelings_Dialog_ShowHireling_1_98093c14-ad1b-43f3-913a-e69c27507701, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_1_28f20762-bce8-484c-a02d-b0973022a2d9, "HirelingName_1_03d3080c-4144-7335-8478-a4fb38a54eb9");
NOT DB_Hirelings_DialogFlagsVars(2,(FLAG)Hirelings_Dialog_ShowHireling_2_f8093dc8-66db-402d-822c-597056dfa2f4, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_2_f74c6e39-2f28-40f7-8a6d-a05c2fc40336, "HirelingName_2_c4187b58-a2f9-61d1-9899-e456945876fd");
NOT DB_Hirelings_DialogFlagsVars(3,(FLAG)Hirelings_Dialog_ShowHireling_3_a151b14d-8382-4f1a-b4a9-a635a27b9203, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_3_d4926cb5-ae5c-4c08-af1c-50d0c4435293, "HirelingName_3_0b5f9e73-cec6-e308-15f4-8e142147908d");
DB_Hirelings_DialogFlagsVars(1,(FLAG)Hireling1_State_ControlledByUser_5663c7ec-b3ab-6c7c-b15c-ee654e838466, (FLAG)Hirelings_Dialog_ShowHireling_1_98093c14-ad1b-43f3-913a-e69c27507701, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_1_28f20762-bce8-484c-a02d-b0973022a2d9, (FLAG)Hirelings_Event_ToCamp_1_1254b9c5-2b04-700a-3f89-aaa4d901789d, "HirelingName_1_03d3080c-4144-7335-8478-a4fb38a54eb9");
DB_Hirelings_DialogFlagsVars(2,(FLAG)Hireling2_State_ControlledByUser_b95a07e5-b2b8-83ba-0ee3-7b9865521d3a, (FLAG)Hirelings_Dialog_ShowHireling_2_f8093dc8-66db-402d-822c-597056dfa2f4, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_2_f74c6e39-2f28-40f7-8a6d-a05c2fc40336, (FLAG)Hirelings_Event_ToCamp_2_d147447b-a690-9b08-2ec1-d7601bef765b, "HirelingName_2_c4187b58-a2f9-61d1-9899-e456945876fd");
DB_Hirelings_DialogFlagsVars(3,(FLAG)Hireling3_State_ControlledByUser_96f99512-f6a9-14ea-c746-761978dd105e, (FLAG)Hirelings_Dialog_ShowHireling_3_a151b14d-8382-4f1a-b4a9-a635a27b9203, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_3_d4926cb5-ae5c-4c08-af1c-50d0c4435293, (FLAG)Hirelings_Event_ToCamp_3_ece2be9c-deda-37dc-a764-bb7b80542e3f, "HirelingName_3_0b5f9e73-cec6-e308-15f4-8e142147908d");

PROC
PROC_ApplySavegamePatches()
AND
NOT QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
THEN
NOT DB_Hirelings_DialogFlagsVars(1,(FLAG)Hirelings_Dialog_ShowHireling_1_98093c14-ad1b-43f3-913a-e69c27507701, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_1_28f20762-bce8-484c-a02d-b0973022a2d9, (FLAG)Hirelings_Event_ToCamp_1_1254b9c5-2b04-700a-3f89-aaa4d901789d, "HirelingName_1_03d3080c-4144-7335-8478-a4fb38a54eb9");
NOT DB_Hirelings_DialogFlagsVars(2,(FLAG)Hirelings_Dialog_ShowHireling_2_f8093dc8-66db-402d-822c-597056dfa2f4, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_2_f74c6e39-2f28-40f7-8a6d-a05c2fc40336, (FLAG)Hirelings_Event_ToCamp_2_d147447b-a690-9b08-2ec1-d7601bef765b, "HirelingName_2_c4187b58-a2f9-61d1-9899-e456945876fd");
NOT DB_Hirelings_DialogFlagsVars(3,(FLAG)Hirelings_Dialog_ShowHireling_3_a151b14d-8382-4f1a-b4a9-a635a27b9203, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_3_d4926cb5-ae5c-4c08-af1c-50d0c4435293, (FLAG)Hirelings_Event_ToCamp_3_ece2be9c-deda-37dc-a764-bb7b80542e3f, "HirelingName_3_0b5f9e73-cec6-e308-15f4-8e142147908d");
DB_Hirelings_DialogFlagsVars(1,(FLAG)Hireling1_State_ControlledByUser_5663c7ec-b3ab-6c7c-b15c-ee654e838466, (FLAG)Hirelings_Dialog_ShowHireling_1_98093c14-ad1b-43f3-913a-e69c27507701, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_1_28f20762-bce8-484c-a02d-b0973022a2d9, (FLAG)Hirelings_Event_ToCamp_1_1254b9c5-2b04-700a-3f89-aaa4d901789d, "HirelingName_1_03d3080c-4144-7335-8478-a4fb38a54eb9");
DB_Hirelings_DialogFlagsVars(2,(FLAG)Hireling2_State_ControlledByUser_b95a07e5-b2b8-83ba-0ee3-7b9865521d3a, (FLAG)Hirelings_Dialog_ShowHireling_2_f8093dc8-66db-402d-822c-597056dfa2f4, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_2_f74c6e39-2f28-40f7-8a6d-a05c2fc40336, (FLAG)Hirelings_Event_ToCamp_2_d147447b-a690-9b08-2ec1-d7601bef765b, "HirelingName_2_c4187b58-a2f9-61d1-9899-e456945876fd");
DB_Hirelings_DialogFlagsVars(3,(FLAG)Hireling3_State_ControlledByUser_96f99512-f6a9-14ea-c746-761978dd105e, (FLAG)Hirelings_Dialog_ShowHireling_3_a151b14d-8382-4f1a-b4a9-a635a27b9203, (FLAG)Hirelings_Dialog_ChoiceDismissHireling_3_d4926cb5-ae5c-4c08-af1c-50d0c4435293, (FLAG)Hirelings_Event_ToCamp_3_ece2be9c-deda-37dc-a764-bb7b80542e3f, "HirelingName_3_0b5f9e73-cec6-e308-15f4-8e142147908d");

//END_REGION

//REGION GUS-310588 //Jaheira can have two wildshape types if she's levelled into a Moon Druid, as a result of her having a hidden Shout_Wildshape that's applied in act 2 but not cleared when she stops following.
                    // If she has both, this will take away the full action one she shouldn't have as a Moon Druid
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
HasSpell((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Shout_WildShape", 1)
AND
HasSpell((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Shout_WildShape_Combat", 1)
THEN
RemoveSpell((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Shout_WildShape");
DB_BUGFIX_Marker("GUS-310588");

//END_REGION

//REGION GUS-300513
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_BUGFIX_Marker("GUS-300513");
DB_SeenDeadNPCPartyFlag((CHARACTER)S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, (FLAG)ORI_Karlach_State_SeenDammonDead_a39ffb36-e11c-4335-b721-9926e4cba0b5);
DB_SeenDeadNPCPartyFlag((CHARACTER)S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, (FLAG)ORI_Karlach_State_SeenDammonDeadSpotter_3f8853b9-97ee-41ac-bb87-2b0b6120e271); // Character flag
//END_REGION GUS-300513

//REGION GUS-315706
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_CRIME_WaitingForDialogStop(_,_)
THEN
PROC_BUGFIX_GUS315706_TryRemoveWaitingDialogs();

PROC
PROC_BUGFIX_GUS315706_TryRemoveWaitingDialogs()
AND
DB_CRIME_WaitingForDialogStop(_CrimeID,_DialogID)
AND
DB_CRIME_WaitingForInterruptedStoryDialogs(_,_CrimeID,_,_,_NPC,_,_,_,_)
AND
NOT SpeakerGetDialog(_NPC, 1, _, _DialogID)
THEN
NOT DB_CRIME_WaitingForDialogStop(_CrimeID,_DialogID);
DB_BUGFIX_GUS315706_RemovedWaitingForDialog(_CrimeID, _NPC);
DB_BUGFIX_Marker("GUS-315706");

PROC
PROC_BUGFIX_GUS315706_TryRemoveWaitingDialogs()
AND
DB_BUGFIX_GUS315706_RemovedWaitingForDialog(_CrimeID, _NPC)
AND
NOT DB_CRIME_RestoreDialogAfterCrimeHandling(_CrimeID, _NPC)
THEN
PROC_GenericsClearBusyDialog(_NPC);

PROC
PROC_BUGFIX_GUS315706_TryRemoveWaitingDialogs()
AND
DB_BUGFIX_GUS315706_RemovedWaitingForDialog(_CrimeID, _NPC)
THEN
NOT DB_BUGFIX_GUS315706_RemovedWaitingForDialog(_CrimeID, _NPC);
//END_REGION GUS-315706

//REGION GUS-315401
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_BUGFIX_Marker("GUS-315401");
PROC_SetAnubisConfig(S_GLO_OathbreakerKnight_3939625d-86cc-4395-9d50-4f8b846c4231, "GLO_OathbreakerKnight_New");
//END_REGION GUS-315401

//REGION GUS-316387
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "EPI_Main_A", "GUS-316387");

PROC
PROC_ApplySavegamePatchInLevel("EPI_Main_A", "GUS-316387")
AND
DB_EPI_Epilogue_PresentNPC(_Character,_,_,_AnubisConfig,_)
THEN
DB_BUGFIX_Marker("GUS-316387");
PROC_BUGFIX_Patch5_AnubisConfigCheck(_Character,_AnubisConfig);
//END_REGION

//REGION GUS-315901
// we need to Bane to speak instead of Gortash in Gortash's SwD
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
NOT DB_GLO_CharacterCorpseDialog((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, (DIALOGRESOURCE)WYR_KillDirectorGortash_Gortash_Dead_2bfcfcc8-b2a9-9e62-ad2b-a1d2fdea094a);
DB_GLO_CustomEntityCorpseDialog(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, (CHARACTER)S_GLO_BaneDummyForGortashSwD_c2e4f43d-c5e6-4f86-9bfc-2dd3804408f5, (DIALOGRESOURCE)WYR_KillDirectorGortash_Gortash_Dead_2bfcfcc8-b2a9-9e62-ad2b-a1d2fdea094a);
DB_GLO_CustomEntityCorpseDialog_IgnoreEntity((DIALOGRESOURCE)WYR_KillDirectorGortash_Gortash_Dead_2bfcfcc8-b2a9-9e62-ad2b-a1d2fdea094a);
Die((CHARACTER)S_GLO_BaneDummyForGortashSwD_c2e4f43d-c5e6-4f86-9bfc-2dd3804408f5, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 1.0); // SwD system requires the speaker to be dead
DB_BUGFIX_Marker("GUS-315901_DBs");

// update the dummy's visuals (no netherstone)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_OnlyOnce("GLO_Gortash_NetherstoneRemoved")
THEN
Transform(S_GLO_BaneDummyForGortashSwD_c2e4f43d-c5e6-4f86-9bfc-2dd3804408f5, GLO_Gortash_Stoneless_ForBaneDummy_238f77bd-45cf-4bc1-8ac8-6fc1201abbcd, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

// update the dummy's visuals (with netherstone)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_OnlyOnce("GLO_Gortash_NetherstoneRemoved")
THEN
Transform(S_GLO_BaneDummyForGortashSwD_c2e4f43d-c5e6-4f86-9bfc-2dd3804408f5, GLO_Gortash_ForBaneDummy_502e8dc1-cbf3-4d16-8d8b-ad3acaa66855, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

// teleport Bane to END_Main if Gortash is there
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
GetRegion(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, "END_Main")
THEN
TeleportTo(S_GLO_BaneDummyForGortashSwD_c2e4f43d-c5e6-4f86-9bfc-2dd3804408f5, S_GLO_Asylum_BanePos_10b37f93-057d-438c-8c73-ceda370b2b8e, "", 0, 0, 0, 0, 1);
DB_BUGFIX_Marker("GUS-315901_BanePos");
//END_REGION

//REGION GUS-315850
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_ORI_Laezel_EggEventsAllowedTriggersForReaction((FLAG)ORI_Laezel_State_WantsToTalkAboutGettingGithEgg_84048cd6-f418-4867-9915-406b76170504, (TRIGGER)S_CRE_Hatchery_SUB_f6f9d65c-c6e2-4aa6-a3f3-d6ad452298a8);
DB_TriggerEvents_TriggerSet("ORI_Laezel_GithEgg_SoldEggValidAreas", S_ORI_Laezel_NearExpeditionerArea_6ec218fd-7dd5-4ce3-892a-4541e2801e09);
DB_TriggerEvents_TriggerSet("ORI_Laezel_GithEgg_SoldEggValidAreas", S_LOW_TheLodge_GroundFloor_SUB_fe71f964-30ae-4030-8d57-764f29f87dfd);
DB_TriggerEvents_TriggerSet("ORI_Laezel_GithEgg_SoldEggValidAreas", S_LOW_TheLodge_SecondFloor_SUB_70d8f401-4eb1-41e9-8247-22668c0e232b);
DB_ORI_Laezel_EggEventsAllowedTriggerSetsForReaction((FLAG)RI_Laezel_State_WantsToTalkAboutSellingGithEgg_880bf97c-f68d-4544-bbf6-01bec9f2c684, "ORI_Laezel_GithEgg_SoldEggValidAreas");
DB_ORI_Laezel_EggEventsAllowedTriggersForReaction((FLAG)ORI_Laezel_State_WantsToTalkAboutPtaris_ce6a94c3-181a-4809-916e-4766a2ae448b, (TRIGGER)S_LOW_TheLodge_BasementDocks_SUB_b4e11373-49c4-43b4-a93f-12792187332a);
DB_GiveItemToEvent(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94, (FLAG)ORI_Laezel_Event_GiveEggToLaezel_8f3ef601-a408-43b8-a39a-beb6169939cd);
DB_CampNight((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, 2100);
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "WLDBAS");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "CREMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "CREINSIDE");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "MOONRISE");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "SHARTEMPLE");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "FARM");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, "ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, (FLAG)ORI_Laezel_State_WantsToTalkAboutLostGithEgg_a9048195-ecf7-4590-b2f7-e786c8b304d9);
DB_CampNight_CancelledBy((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, (FLAG)ORI_Laezel_State_DiscussedLostEgg_5205df84-cd67-4b71-9400-1afceeb7dd86);
DB_CampNight_CRD((FLAG)NIGHT_Laezel_EggIsGone_9e32ff31-1cf9-4a86-873a-c7af2a7c0469, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (DIALOGRESOURCE)GLO_Laezel_WRD_GithEggRelated_fad8e633-576a-f03d-38e8-4a4b5af4bc60, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-315850");
//END_REGION

//REGION GUS-304690
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
DB_CharacterBlockedFromSellingTemplate((CHARACTER)S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, (ROOT)MAG_Primeval_Silver_Longsword_20c66f8d-f455-42fc-8e48-543512247e75);
DB_BUGFIX_Marker("GUS-304690");
//END_REGION

//REGION GUS-309655
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_DismissedAvatar(_DismissedAvatar)
AND
IsInInventoryOf(S_GLO_PuzzleBox_326324f9-0920-8f0f-3e85-3781fbf48282, _DismissedAvatar, 1)
THEN
DB_BUGFIX_Marker("GUS-309655_Avatar");
PROC_GLO_InfernalBox_SendToAvatarFrom(_DismissedAvatar);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_Hirelings_HACK_Classes(_ ,_Hireling,_)
AND
NOT DB_PartOfTheTeam(_Hireling)
AND
IsInInventoryOf(S_GLO_PuzzleBox_326324f9-0920-8f0f-3e85-3781fbf48282, _Hireling, 1)
THEN
DB_BUGFIX_Marker("GUS-309655_Hireling");
PROC_GLO_InfernalBox_SendToAvatarFrom(_Hireling);

//END_REGION GUS-309655

//REGION GUS-314726
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-314726");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314726")
AND
DB_LOW_DevilsFee_HelsikInvocations(_Invocation)
AND
NOT DB_Is_Incombat(_Invocation, _)
THEN
DB_BUGFIX_Marker("GUS-314726");
PROC_Poof(_Invocation, (EFFECTRESOURCE)VFX_Script_InfernalPoofEffect_80bd6b0d-0fc6-d9f3-37b9-5b3d667180e3);
//END_REGION GUS-314726

//REGION GUS-314949
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-314949");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314949")
AND
DB_BUGFIX_Marker("GUS-313669_LOW_Lakrissa")
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_Event_LakrissaGoingUpstairs_13b8ec89-1a9d-c766-31df-3fcd3fde81b9)
AND
NOT DB_GlobalFlag(LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74)
THEN
DB_BUGFIX_Marker("GUS-314949");
PROC_SetAnubisConfig((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, "LOW_Elfsong_LakrissaOnRooftop");
//END_REGION GUS-314949

//REGION GUS-314807
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_PartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_RecruitableNpcHardCoreStatus(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_Difficulty,_Status)
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,_Difficulty,1)
AND
HasActiveStatus(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,_Status,0)
THEN
DB_BUGFIX_Marker("GUS-314807");
ApplyStatus(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Status, -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION GUS-317103

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
GetFlag(CAMP_Shadowheart_Event_Fight_9e208379-c14f-b65a-c4a2-a029162939cb, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_ShadowHeart_LaezelFight_a3445b22-7973-416b-b8a3-1856414589ea)
AND
DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT QRY_ShadowheartLaezelFight_CamperInCombat()
THEN
DB_BUGFIX_Marker("GUS-317103");
PROC_Camp_WakeUpAtNight();

//END_REGION GUS-317103

//REGION GUS-316549

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
THEN
DB_BUGFIX_Marker("GUS-316549_GLO");
NOT DB_StoryHideGodTags((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_QuestDef_State((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99, "GLO_UnleashPowers", "LeftToEND");

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "SCL_Main_A", "GUS-316549_SCL");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-316549_CTY");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "END_Main", "GUS-316549_END");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-316549_SCL")
THEN
DB_AmbushTrigger_CustomAmbushStatus((TRIGGER)S_SCL_BlightCombat1_AmbushTrigger_1ead9d72-5169-4f3f-907f-702be7c98b6d,"SCL_PLANTBLIGHT_AMBUSH");
DB_AmbushTrigger_CustomAmbushStatus((TRIGGER)S_SCL_BlightCombat2_AmbushTrigger_a071e764-c2dc-4429-b762-adee843de932,"SCL_PLANTBLIGHT_AMBUSH");
DB_AmbushTrigger_CustomAmbushStatus((TRIGGER)S_SCL_BlightCombat3_AmbushTrigger_56e30fd5-abd1-49a7-ae4b-e053d4cdc2f8,"SCL_PLANTBLIGHT_AMBUSH");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316549_CTY")
AND
NOT DB_Destroyed(S_LOW_PhilgravesMansion_ClientChest_ee7e8c08-5359-4cc2-932a-42edd01c4de6)
AND
GetDistanceTo(S_LOW_PhilgravesMansion_ClientChest_ee7e8c08-5359-4cc2-932a-42edd01c4de6,S_LOW_PhilgravesMansion_ClientChest_PATCH_Trigger_8468c295-4031-42cd-9a31-c2e4d65acaab,_Distance)
AND
_Distance < 2.0
THEN
TeleportTo(S_LOW_PhilgravesMansion_ClientChest_ee7e8c08-5359-4cc2-932a-42edd01c4de6,S_LOW_PhilgravesMansion_ClientChest_PATCH_Trigger_8468c295-4031-42cd-9a31-c2e4d65acaab,"");
DB_BUGFIX_Marker("GUS-316549_CTY_ClientChest");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316549_CTY")
THEN
ApplyStatus((CHARACTER)S_LOW_BhaalTemple_DarkUrgeClone_5a96d12a-f7b4-4628-8257-8a463b49852c, "BLOOD_COVERED_FULL", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_InRegionFlag((TRIGGER)S_CAMP_ELFSONG_Area_91cfb758-522c-4fa0-8439-2f7e20d15d96,(FLAG) CAMP_CTY_Elfsong_State_InRegion_b7342da0-7617-4912-a916-a099c8f89563);
DB_InRegionFlag((TRIGGER)S_CAMP_ELFSONG_Area_000_1f57deba-bbd8-4614-a77f-63a158d333d9,(FLAG) CAMP_CTY_Elfsong_State_InRegion_b7342da0-7617-4912-a916-a099c8f89563);
NOT DB_Subregion((TRIGGER)S_CAMP_ELFSONG_Area_91cfb758-522c-4fa0-8439-2f7e20d15d96,"CAMP_SUB",0, 1);
DB_Subregion((TRIGGER)S_CAMP_ELFSONG_Area_000_1f57deba-bbd8-4614-a77f-63a158d333d9,"CAMP_SUB",0, 1);
NOT DB_AutoSaveTrigger(S_LOW_JaheirasHouseAutosaveTrigger_7fd3d1fb-f7d3-4b91-b269-e8ff1fa803bd);

PROC
PROC_ApplySavegamePatchInLevel("END_Main", "GUS-316549_END")
THEN
NOT DB_END_Reinforcements_Characters(11, S_END_HelpCaller_006_305de790-2f30-41e3-a9fc-5602067c3a5f);

//END_REGION GUS-316549

//REGION GUS-315656

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "ReachedGrymforge", 1)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "NightsongWithBalthazar", 0)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "NightsongFreed", 0)
AND
QuestIsClosed("SHA_Nightsong", 0)
AND
NOT DB_BUGFIX_Marker("GUS-315656-SCL")
THEN
DB_BUGFIX_Marker("GUS-315656-SCL");
QuestSetCategory("SHA_Nightsong", "Shadowcurse");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "NightsongFreed", 1)
AND
QuestIsClosed("SHA_Nightsong", 0)
AND
NOT DB_BUGFIX_Marker("GUS-315656-Freed")
THEN
DB_BUGFIX_Marker("GUS-315656-Freed");
QuestSetCategory("SHA_Nightsong", "BaldursGate");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "NightsongWithBalthazar", 1)
AND
QuestIsClosed("SHA_Nightsong", 0)
AND
NOT DB_BUGFIX_Marker("GUS-315656-Balthazar")
THEN
DB_BUGFIX_Marker("GUS-315656-Balthazar");
QuestSetCategory("SHA_Nightsong", "BaldursGate");

//END_REGION GUS-315656

//REGION GUS-310409
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
NOT DB_GlobalFlag((FLAG)ORI_Wyll_Knows_RavengardFather_ef46f733-7028-8629-260a-d333d2ef3ad4)
THEN
NOT DB_GLO_Backgrounds_ChainAfterCharacterFlag(WyllInParty_Event_TalkedAboutFather_500b44e9-8f07-8861-d71f-61ab9c9d0434, "Act1_Noble_KnowsWyllNoble");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog(ORI_Wyll_Knows_RavengardFather_ef46f733-7028-8629-260a-d333d2ef3ad4, "Act1_Noble_KnowsWyllNoble");
DB_BUGFIX_Marker("GUS-310409-DB");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)ORI_Wyll_Knows_RavengardFather_ef46f733-7028-8629-260a-d333d2ef3ad4)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act1_Noble_KnowsWyllNoble");
DB_BUGFIX_Marker("GUS-310409-Goal");
//END_REGION
//REGION GUS-310183
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_InCamp(_Owner)
THEN
RemoveSummons(_Owner, 0);
DB_BUGFIX_Marker("GUS-310183");

//END_REGION GUS-310183

//REGION Performance Improvement: Replace TaggedItemTracker with Scriptflags

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
THEN
SysClear("DB_TaggedItemTracker",2);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_IsOrWasInParty(_Player)
THEN
RemoveStatus(_Player,"HAS_SHOVEL"); //No longer used, so clean up.
//END_REGION

//REGION GUS-170537
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
THEN
DB_CRIME_InvestigationStates("LookingForSuspectsToInterrogate");
DB_CRIME_InvestigationStates("LookingForSuspectsToConfront");
DB_CRIME_InvestigationStates("LookingForCriminalsToConfront");
DB_CRIME_NoImmediateInvestigationAbort("UseForbiddenItem");
DB_CRIME_NoImmediateInvestigationAbort("MusicalPerformance_Bad");
DB_CRIME_NoImmediateInvestigationAbort("MusicalPerformance_Good");

//END_REGION

//REGION GUS-231203
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
THEN
DB_BUGFIX_Marker("GUS-231203");
DB_CRIME_SavedAgainstHostileSpellStatuses("SAVED_AGAINST_HOSTILE_SPELL","Assault");
DB_CRIME_SavedAgainstHostileSpellStatuses("SAVED_AGAINST_HOSTILE_SPELL_BANISHMENT","Assault");
DB_CRIME_SavedAgainstHostileSpellStatuses("SAVED_AGAINST_HOSTILE_SPELL_CHARM","Charmed");
DB_CRIME_SavedAgainstHostileSpellStatuses("SAVED_AGAINST_HOSTILE_SPELL_CHARM_SUBTLE","Charmed");
DB_CRIME_SavedAgainstHostileSpellStatuses("SAVED_AGAINST_HOSTILE_SPELL_DOMINATED","Dominated");
DB_CRIME_SavedAgainstHostileSpellStatuses("SAVED_AGAINST_HOSTILE_SPELL_POLYMORPHED","Polymorphed_Saved");
//END_REGION

//REGION GUS-319843, GUSX-1181

//Wait for all players to be ReadyForSleepCutscene
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
QRY_Camp_QRY_GUS_319843_Try()
AND
SysCount("DB_Camp_SleepMomentsDone",1,_Count)
AND
SysCount("DB_Players",1,_PlayerCount)
AND
_PlayerCount != _Count
THEN
PROC_Camp_SleepMomentsDone_Recount();

QRY
QRY_Camp_QRY_GUS_319843_Try()
AND
DB_Camp_SleepingPlayer(_Character)
AND
NOT DB_InteractiveDialogSpeaker(_, _Character)
AND
NOT DB_Camp_Faded((CHARACTER)_Character, _)
THEN
DB_NOOP(1);

PROC
PROC_Camp_SleepMomentsDone_Recount()
AND
DB_Players(_Character)
AND
NOT DB_InteractiveDialogSpeaker(_, _Character)
THEN
DB_Camp_SleepMomentsDone_Recounted(_Character);

PROC
PROC_Camp_SleepMomentsDone_Recount()
AND
DB_Players(_Character)
AND
DB_InteractiveDialogSpeaker(_DialogID, _Character)
AND
NOT DB_InCamp(_Character)
THEN
DB_BG3_SaveGamePatches_GUSX_1181_WaitDialogEnd(_DialogID, _Character);

IF
DialogEnded(_Dialog, _DialogID)
AND
DB_BG3_SaveGamePatches_GUSX_1181_WaitDialogEnd(_DialogID, _Character)
THEN
NOT DB_BG3_SaveGamePatches_GUSX_1181_WaitDialogEnd(_DialogID, _Character);
DB_BUGFIX_Marker("GUSX-1181", _Character);
PROC_Camp_SleepMomentsDone_Recount(); // Recount again once the dialog finishes

PROC
PROC_Camp_SleepMomentsDone_Recount()
AND
DB_Camp_SleepMomentsDone(_Character)
AND
NOT DB_Camp_SleepMomentsDone_Recounted(_Character)
THEN
NOT DB_Camp_SleepMomentsDone(_Character);
DB_BUGFIX_Marker("GUS-319843-A", _Character);

PROC
PROC_Camp_SleepMomentsDone_Recount()
AND
DB_Camp_SleepMomentsDone_Recounted(_Character)
AND
NOT DB_Camp_SleepMomentsDone(_Character)
THEN
DB_Camp_SleepMomentsDone(_Character);
DB_BUGFIX_Marker("GUS-319843-B", _Character);

QRY
QRY_Camp_QRY_GUS_319843_NeedsRecheck()
AND
DB_BUGFIX_Marker("GUS-319843-A", _)
THEN
DB_NOOP(1);

QRY
QRY_Camp_QRY_GUS_319843_NeedsRecheck()
AND
DB_BUGFIX_Marker("GUS-319843-B", _)
THEN
DB_NOOP(1);

PROC
PROC_Camp_SleepMomentsDone_Recount()
AND
QRY_Camp_QRY_GUS_319843_NeedsRecheck()
THEN
PROC_Camp_CheckSleepMomentsLoopDone();
//END_REGION GUS-319843, GUSX-1181

//REGION GUSX-10235 //Players Stuck in camp (StartRest Fade Failed)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_Camp_LongRest_CodeIsWaiting(1)
AND
NOT DB_OnlyOnce("GLO_Camp_StartRest_Fade_Out")
THEN
DB_BUGFIX_Marker("GUSX-10235 Players Stuck in camp (StartRest Fade Failed)");
PROC_CAMP_SafeFadeOutDone("GLO_Camp_StartRest_Fade_Out");
//END_REGION


//REGION GUS-316535
// Withers was somehow (spam Talk to him as dialog ends with him) interrupted when he was trying to resurrect someone. So the player is stuck in limbo and needs savegame patching to ressurect them.
// DB_CAMP_Jergal_PlayersToResurrect will still have some values if this interruption occurred.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7") // temporarily as patch 6, need to change to patch 7 later.
AND
DB_CAMP_Jergal_PlayersToResurrect(_Player) // if this DB is still populated
AND
NOT DB_GlobalFlag(GLO_Jergal_Event_ResurrectDeadPlayers_a4d65ce6-df15-6ce8-3aa4-ce7ba678b86a) // Withers isn't currently trying to resurrect someone.
AND
DB_Defeated(_Player) // and the target player is still dead.
AND
NOT DB_BUGFIX_Marker("GUS-316535") // triggering this just once is enough.
THEN
DB_BUGFIX_Marker("GUS-316535");
PROC_GLO_Jergal_ResurrectPlayers();
//END_REGION

//REGION GUS-317000
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_CrimeWarner(_CrimeID, _NPC, _CrimeDialog)
AND
DB_DialogRequestCache_SpeakerList_Speakers(_CrimeDialog, _DialogID, _NPC, _)
THEN
DB_BUGFIX_Marker("GUS-317000");
NOT DB_CrimeWarner(_CrimeID, _NPC, _CrimeDialog);
DB_CrimeWarner(_CrimeID, _NPC, _CrimeDialog, _DialogID);
//END_REGION

//REGION GUS-317701
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag(CAMP_OwlbearCub_State_BecameCampFollower_a9742288-21b5-428a-9efa-a2e73981c02f)
AND
DB_ActiveCamp(_ActiveCamp)
THEN
PROC_CampSwap_UpdateAnubisCampPos(_ActiveCamp,S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);
DB_BUGFIX_Marker("GUS-317701");
//END_REGION GUS-317701

//REGION GUS-313976
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
THEN
DB_CompanionIsDating((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (FLAG)ORI_State_WyllIsDating_f7a14f81-6a3b-4199-81eb-8a45cca71155);
DB_CompanionIsDating((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (FLAG)ORI_State_MintharaIsDating_07338d12-2971-47b1-a5a1-1737b0bac1fb);
DB_CompanionIsDating((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (FLAG)ORI_State_HalsinIsDating_bacec26a-b4b9-40c3-825f-cc1fc2c7e5a9);
DB_CompanionIsDating((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (FLAG)ORI_State_ShadowheartIsDating_3b35c15c-465a-433b-876d-0717287629b3);
DB_CompanionIsDating((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (FLAG)ORI_State_LaezelIsDating_1ed37dec-5bd7-489b-bcc4-5185b12918fb);
DB_CompanionIsDating((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (FLAG)ORI_State_KarlachIsDating_003de74b-65fc-4f8a-a5e5-df8d5446ecf3);
DB_CompanionIsDating((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (FLAG)ORI_State_GaleIsDating_31f27899-b8c8-4688-a1a8-ec12c4d6f103);
DB_CompanionIsDating((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (FLAG)ORI_State_AstarionIsDating_532e4d60-1afe-47f0-9c51-c11aae22bd98);
DB_BUGFIX_Marker("GUS-313976");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_CompanionCanPartner((CHARACTER)_Companion, _,  _, _, _, _, _)
AND
GetFlag((FLAG)ORI_State_Partnered_6c1a31e8-1d3d-42a5-af4f-72ef7a798f74, _Companion, 1)
AND
DB_CompanionIsDating((CHARACTER)_Companion, _IsDating)
THEN
DB_BUGFIX_Marker("GUS-313976-Partnered");
PROC_GlobalSetFlagAndCache(_IsDating);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_CompanionCanPartner((CHARACTER)_Companion, _,  _, _, _, _, _)
AND
GetFlag((FLAG)ORI_State_Dating_a3346d5b-c54b-4c73-bf18-0a2bf90c35da, _Companion, 1)
AND
DB_CompanionIsDating((CHARACTER)_Companion, _IsDating)
THEN
DB_BUGFIX_Marker("GUS-313976-Dating");
PROC_GlobalSetFlagAndCache(_IsDating);

//END_REGION GUS-313976

//REGION GUS-317719
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_Origins(_Companion)
AND
GetFlag((FLAG)ORI_State_Partnered_6c1a31e8-1d3d-42a5-af4f-72ef7a798f74, _Companion, 0)
AND
DB_HandlingRelationshipDialog(_Companion,_RD,_Flag, _, 1, _)
THEN
DB_BUGFIX_Marker("GUS-317719");
PROC_CancelRelationshipDialog(_Companion,_RD,_Flag);
//END_REGION GUS-317719

//REGION GUS-318707

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
THEN
DB_BUGFIX_Marker("GUS-318707");
PROC_BUGFIX_GUS318707_FixBusyDialog();

PROC
PROC_BUGFIX_GUS318707_FixBusyDialog()
AND
DB_GlobalFlag(LOW_Evacuation_HasMet_MadeDealWithSailor_76df3b6e-c3c2-f9b3-d6b6-7e1dd160725f)
THEN
DB_LOW_SteepsEvactuation_BusyChildren((CHARACTER)S_LOW_SteepsEvacuation_Child1_4d171372-75ff-40d1-8ea0-7c80273db8e5);
DB_LOW_SteepsEvactuation_BusyChildren((CHARACTER)S_LOW_SteepsEvacuation_Child1_4d171372-75ff-40d1-8ea0-7c80273db8e5);

//Busy Gnomes
PROC
PROC_BUGFIX_GUS318707_FixBusyDialog()
AND
DB_UND_InjuredGnome_Busy(_Character)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount)
AND
IntegerSum(_CurrentCount, 1, _NewCount)
THEN
PROC_GenericsSetBusyDialog(_Character);

//Busy harper
PROC
PROC_BUGFIX_GUS318707_FixBusyDialog()
AND
DB_SCL_Drider_HarperIsBusy(_Character)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount)
AND
IntegerSum(_CurrentCount, 1, _NewCount)
THEN
PROC_GenericsSetBusyDialog(_Character);

//Busy LOW kids.
PROC
PROC_BUGFIX_GUS318707_FixBusyDialog()
AND
DB_LOW_SteepsEvactuation_BusyChildren(_Character)
AND
DB_BUGFIX_GUS305511_TempBusyCount(_CurrentCount)
AND
IntegerSum(_CurrentCount, 1, _NewCount)
THEN
PROC_GenericsSetBusyDialog(_Character);

//Busy LOW VoloFate characters
PROC
PROC_BUGFIX_GUS318707_FixBusyDialog()
AND
DB_GlobalFlag(LOW_VoloFate_State_AcceptedVolosFate_cdd3f96c-3b79-d4f7-cf60-a81c173d369a)
AND
DB_LOW_VoloFate_Characters(_Character)
AND
_Character != S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa
AND
_Character != S_LOW_VoloFate_Agitator_e896b270-21cd-4d5c-8b99-be87929f77f0
THEN
PROC_GenericsSetBusyDialog(_Character);

PROC
PROC_BUGFIX_GUS318707_FixBusyDialog()
AND
DB_ObjectCountHelper(_Character, "GEB_BusyDialog", _Count)
THEN
NOT DB_ObjectCountHelper(_Character, "GEB_BusyDialog", _Count);

//END_REGION

//REGION GUS-314619
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
CheckRulesetModifierBool(HONOUR_STATS_ef0506df-da9f-40e2-903a-1349523c1ae4,1,1)
AND
NOT DB_CMB_Spectator_EyebeamInterrupt_Statuses("SPECTATOR_EYEBEAM_INTERRUPT_PARALYZING")
THEN
DB_CMB_Spectator_EyebeamInterrupt_Statuses("SPECTATOR_EYEBEAM_INTERRUPT_PARALYZING");
DB_CMB_Spectator_EyebeamInterrupt_Statuses("SPECTATOR_EYEBEAM_INTERRUPT_CONFUSION");
DB_CMB_Spectator_EyebeamInterrupt_Statuses("SPECTATOR_EYEBEAM_INTERRUPT_FEAR");
DB_CMB_Spectator_EyebeamInterrupt_Statuses("SPECTATOR_EYEBEAM_INTERRUPT_WOUNDING");
DB_BUGFIX_Marker("GUS-314619");
//END_REGION GUS-314619

//REGION GUS-318710
// Enemy of Justice makes all guards attack you.
// It works per level - guards from one level shouldn't attack you because you killed guards in another level.
// Due to a bug we have savegames where that restriction didn't work and, for example, guards in LOW
// were hostile to you because you killed someone in MOO.
// All guard killers are stored in DB_CRIME_GuardKiller(_Level,_Killer,_Guard,_Region,_Pool,_GuardFaction,_CrimeID)
// which contains both _Level (SCL_Main_A) and _CrimeRegion (SCL_Main_A_MOO), so we can check for discrepancies like
// DB_CRIME_GuardKiller("CTY_Main_A",_,_,"SCL_Main_A_MOO",_,_,_).
// If we find any discrepancy we need to make peace with ALL guards in case the player
// has already encountered a bug and killed more guards as self-defense in another region
PROC 
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 4")
AND
DB_CRIME_GuardKiller(_Level, _Killer, _Guard, _Region, _Pool, _GuardFaction, _CrimeID)
AND
IsSubstring(_Region, _Level, 0)
AND
NOT DB_BUGFIX_Marker("GUS-318710")
THEN
DB_BUGFIX_Marker("GUS-318710");
PROC_GLO_Bugfix_318710_MakePeace(_Level);

PROC
PROC_GLO_Bugfix_318710_MakePeace((STRING)_Level)
AND
DB_CRIME_GuardKiller(_Level, _Killer, _Guard, _Region, _Pool, _GuardFaction, _CrimeID)
THEN
PROC_CRIME_Guards_MakePeace(_Region, _Pool);
//END_REGION GUS-316471

//REGION GUS-317665
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 7")
AND
NOT QRY_IsEmptyDB("DB_CRIME_Guards_SpawnedGuard_WaitOnStage", 3)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6 Hotfix 7", "BGO_Main_A", "GUS-317665");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6 Hotfix 7", "CTY_Main_A", "GUS-317665");

PROC
PROC_ApplySavegamePatchInLevel(_Level, "GUS-317665")
AND
DB_CRIME_Guards_SpawnedGuard_WaitOnStage(_Guard, _Region, _ID)
AND
IsSubstring(_Region, _Level, 1)
AND
DB_CRIME_Guards_SpawnGuards_WaitForSpawn(_, _, _, _, _Guard, _, _, _Type)
THEN
NOT DB_CRIME_Guards_SpawnedGuard_WaitOnStage(_Guard, _Region, _ID);
DB_GLO_Bugfix_317665(_Guard, _Type);
SetEntityEvent(_Guard, "CRIME_Guards_SpawnedGuard");

// after a guard is removed from WaitForSpawn DB we unsummon the guard
IF
DB_GLO_Bugfix_317665(_Guard, _Type)
AND
NOT DB_CRIME_Guards_SpawnGuards_WaitForSpawn(_, _, _, _, _Guard, _, _, _Type)
THEN
NOT DB_GLO_Bugfix_317665(_Guard, _Type);
PROC_GLO_Bugfix_317665_Unsummon(_Guard, _Type);

PROC
PROC_GLO_Bugfix_317665_Unsummon((GUIDSTRING)_Guard, "Spawn")
THEN
PROC_CRIME_Guards_UnsummonGuard((CHARACTER)_Guard);

PROC
PROC_GLO_Bugfix_317665_Unsummon((GUIDSTRING)_Guard, "SpawnReinforcement")
THEN
PROC_CRIME_Guards_UnsummonReinforcement((CHARACTER)_Guard);
//END_REGION

//REGION GUS-319700
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_StartedDialog(_Dialog, _, _, _, _, _, _)
AND
NOT DB_DialogName(_Dialog, _)
AND
QRY_BG3_SavegamePatches_GUS319700_ValidNightDialog(_Dialog)
AND
DB_QRYRTN_BG3_SavegamePatches_GUS319700_ValidNightDialog(_CampNight)
AND
NOT QRY_Camp_AnyAvatarInCamp()
THEN
PROC_CampNight_ClearCampNight(_CampNight);
PROC_Camp_SleepUntilMorning();
DB_BUGFIX_Marker("GUS-319700", _Dialog);

QRY
QRY_BG3_SavegamePatches_GUS319700_ValidNightDialog((DIALOGRESOURCE)_Dialog)
AND
DB_QRYRTN_BG3_SavegamePatches_GUS319700_ValidNightDialog(_CampNight)
THEN
NOT DB_QRYRTN_BG3_SavegamePatches_GUS319700_ValidNightDialog(_CampNight);

// Avatar dreams
QRY
QRY_BG3_SavegamePatches_GUS319700_ValidNightDialog((DIALOGRESOURCE)_Dialog)
AND
DB_CampNight_AvatarDream(_CampNight, _Dialog)
THEN
DB_QRYRTN_BG3_SavegamePatches_GUS319700_ValidNightDialog(_CampNight);

// Solo dreams
QRY
QRY_BG3_SavegamePatches_GUS319700_ValidNightDialog((DIALOGRESOURCE)_Dialog)
AND
DB_CampNight_SoloDream(_CampNight, _, _Dialog)
THEN
DB_QRYRTN_BG3_SavegamePatches_GUS319700_ValidNightDialog(_CampNight);

// Romance nights
QRY
QRY_BG3_SavegamePatches_GUS319700_ValidNightDialog((DIALOGRESOURCE)_Dialog)
AND
DB_CampNight_RomanceNight(_CampNight, _, _Dialog, _)
THEN
DB_QRYRTN_BG3_SavegamePatches_GUS319700_ValidNightDialog(_CampNight);

//END_REGION GUS-319700

//REGION GUS-320081

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag(ORI_DarkUrge_Event_KillFavouriteCharacter_65863750-e926-1f14-a3da-cda0b6ad1863)
THEN
DB_ORI_DarkUrge_FavouriteKillCandidateFlag((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (FLAG)ORI_DarkUrge_State_SparedIsobelWithGale_a318c0cd-f261-41c9-88c9-3cddceb477b7);
DB_ORI_DarkUrge_FavouriteKillCandidateFlag((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (FLAG)ORI_DarkUrge_State_SparedIsobelWithKarlach_40ad195b-2fa2-492d-9fc5-359fb363c65d);
DB_ORI_DarkUrge_FavouriteKillCandidateFlag((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (FLAG)ORI_DarkUrge_State_SparedIsobelWithLaezel_bcd9eb6c-4537-442b-bc28-d7010b8d96ff);
DB_ORI_DarkUrge_FavouriteKillCandidateFlag((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (FLAG)ORI_DarkUrge_State_SparedIsobelWithShadowheart_1dad6424-0946-45d5-a523-3428dd17c8e8);
DB_ORI_DarkUrge_FavouriteKillCandidateFlag((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (FLAG)ORI_DarkUrge_State_SparedIsobelWithWyll_150efcb9-0b87-4fbf-af6c-44fa3292fab7);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag(ORI_DarkUrge_Event_KillFavouriteCharacter_65863750-e926-1f14-a3da-cda0b6ad1863)
AND
DB_ORI_DarkUrge_FavouriteKillCandidateFlag(_Char, _Flag)
AND
DB_GlobalFlag(_Flag)
AND
NOT IsDead(_Char, 0)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
IsTagged((CHARACTER)_Char, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6, 1)
THEN
PROC_Origins_CompanionLeavePermanently(_Char, "Killed");
Die(_Char, DEATHTYPE.DoT, (CHARACTER)_DarkUrge, 0, 1, 0.0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag(ORI_DarkUrge_Event_KillFavouriteCharacter_65863750-e926-1f14-a3da-cda0b6ad1863)
THEN
SysClear("DB_ORI_DarkUrge_FavouriteKillCandidateFlag", 2);

//END_REGION GUS-320081

//REGION GUS-319370
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
THEN
DB_Shapeshifting_BlockDialogues("GASEOUS_FORM");
DB_Shapeshifting_BlockDialogues("POLYMORPH_CHEESE");
DB_Shapeshifting_BlockDialogues("SCL_PIXIEBELL_FROG");
DB_Shapeshifting_BlockDialogues("SCL_PIXIEBELL_BOAR");
DB_Shapeshifting_BlockDialogues("SCL_PIXIEBELL_DEEPROTHE");
DB_BUGFIX_Marker("GUS-319370_InitDBs");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_PolymorphedInto(_Char, _, _, _Status)
AND
DB_Shapeshifting_BlockDialogues(_Status)
AND
HasAppliedStatus(_Char, _Status, 1)
THEN
DB_Shapeshifting_DialoguesBlocked(_Char, _Status);
DB_BUGFIX_Marker("GUS-319370_AddedEntry", _Char);
//END_REGION GUS-319370

//REGION GUS-319691
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 7")
AND
DB_Players(_Player1)
AND
DB_Players(_Player2)
AND
_Player1 != _Player2
AND
NOT QRY_GLO_PartyAndPlayerSameRegion(_Player1, _Player2)
AND
NOT QRY_CombatFlee_TryFleeToCamp(_Player1)
AND
NOT QRY_CombatFlee_TryFleeToLevelStart(_Player1)
THEN
PROC_SetOnStage(_Player1, 1);
TeleportTo(_Player1, _Player2);

QRY
QRY_GLO_PartyAndPlayerSameRegion((CHARACTER)_Player1, (CHARACTER)_Player2)
AND
GetRegion(_Player1, _Player1Region)
AND
GetRegion(_Player2, _Player2Region)
AND
_Player1Region == _Player2Region
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-319036
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
QRY_BG3_GUS319036_AvatarListWasUpdated()
AND
QRY_BG3_GUS319036_WaitingForLongRestToFinish()
THEN
PROC_BG3_GUS319036_ForceSyncLongRestCharacters();

QRY
QRY_BG3_GUS319036_AvatarListWasUpdated()
AND
DB_BUGFIX_Marker("GUS-312586 Dismissed Dead Avatars resurrected by Withers didn't join party again after resurrection", _)
THEN
DB_NOOP(1);

QRY
QRY_BG3_GUS319036_WaitingForLongRestToFinish()
AND
DB_Camp_LongRest_CodeIsWaiting(1)
AND
DB_CAMP_CharacterLongRested(_)
THEN
DB_NOOP(1);

PROC
PROC_BG3_GUS319036_ForceSyncLongRestCharacters()
AND
DB_CAMP_CharacterLongRested(_Player)
AND
NOT DB_Players(_Player)
THEN
DB_BUGFIX_Marker("GUS-319036_RemovedFromLongRest", _Player);
NOT DB_CAMP_CharacterLongRested(_Player);

PROC
PROC_BG3_GUS319036_ForceSyncLongRestCharacters()
AND
DB_Players(_Player)
AND
NOT DB_CAMP_CharacterLongRested(_Player)
THEN
DB_BUGFIX_Marker("GUS-319036_AddedToLongRest", _Player);
RequestLongRest(_Player, 1);
//END_REGION GUS-319036

//REGION GUSX-1045

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
HasActiveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_NECROTICAURA", 1)
AND
IsDead(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0)
AND
HasActiveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "RESURRECTING", 0)
THEN
RemoveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_NECROTICAURA", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUSX-1045");

//END_REGION GUSX-1045

//REGION GUSX-1743
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_CampNight_SetPosition((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "CREMAIN", (TRIGGER)S_CAMP_Laezel_VossConfrontation_StartCombatPos_5fd79b56-40a8-403b-8b66-fc977171da4f)
THEN
NOT DB_CampNight_SetPosition((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "CREMAIN", (TRIGGER)S_CAMP_Laezel_VossConfrontation_StartCombatPos_5fd79b56-40a8-403b-8b66-fc977171da4f);
DB_BUGFIX_Marker("GUSX-1743");
//END_REGION GUSX-1743

//REGION GUSX-389
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_OnlyOnce("WYR_KillDirectorGortash_RemoveRavengardFromAudienceHall")
AND
CanFight(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 0)
THEN
SetCanFight(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
DB_BUGFIX_Marker("GUSX-389");
//END_REGION GUSX-389

//REGION GUSX-900
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_PartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
NOT ObjectGetTitle(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "ORI_Minthara_RecruitedTitle")
THEN
ObjectSetTitle(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "ORI_Minthara_RecruitedTitle");
//END_REGION

//REGION GUSX-7116


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 8")
AND
DB_PartyFollowers(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
AND
IsPartyFollower(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, 0)
AND
NOT QRY_GUSX_7116_UsInColony()
THEN
SetOnStage(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, 0);

QRY
QRY_GUSX_7116_UsInColony()
AND
DB_DeadOnceFlag((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,COL_Morgue_State_Us_IsDead_72a07a1d-a984-4f87-bd5a-730e99b6263a)
AND
DB_Players(_Player)
AND
IsInTrigger(_Player, S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b, 1)
THEN
DB_NOOP(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 8")
AND
DB_PartyFollowers(_Follower)
AND
IsPartyFollower(_Follower, 0)
THEN
NOT DB_PartyFollowers(_Follower);
MakeNPC(_Follower);


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6 Hotfix 9")
AND
DB_PartyFollowers(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
AND
NOT DB_CurrentLevel("TUT_Avernus_C")
THEN
PROC_GUSX_7116_RemoveUs();
DB_BUGFIX_Marker("GUSX-7116");

PROC
PROC_GUSX_7116_RemoveUs()
AND
IsPartyFollower(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, 1)
AND
CharacterGetOwner(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _Owner)
THEN
RemovePartyFollower(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _Owner);
DB_BUGFIX_Marker("GUSX-7116-1");

PROC
PROC_GUSX_7116_RemoveUs()
AND
NOT QRY_GUSX_7116_UsInColony()
THEN
SetOnStage(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, 0);
DB_BUGFIX_Marker("GUSX-7116-2");

//END_REGION 

//REGION GUSX-7126

//Fix Minthara wrong initialization. MintharaFate setup happened but not execution one. Cancel potential conflicting parts of the setup.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_State_Current(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_MintharaFate", "MOO_MintharaFate_State_Execution")
AND
NOT DB_SceneManager(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_Execution")
THEN
PROC_CharacterEnableAllCrimes(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);


//If Minthara is at Moonrise post Execution
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_State_Current(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_MintharaFate", _State)
AND
_State != "MOO_MintharaFate_State_Execution"
AND
QRY_OnlyOnce("GLO_GUSX7126_StopGoblinCelebrations")
THEN
DB_BUGFIX_Marker("GUSX-7126");
ClearFlag(DEN_AttackOnDen_Event_GoblinPartyInvitation_54e19b21-3fad-6a2e-c89a-9d5cf1b4773f, NULL_00000000-0000-0000-0000-000000000000, 0);

//If Minthara is at Moonrise for Execution
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_SceneManager(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_Execution")
AND
QRY_OnlyOnce("GLO_GUSX7126_StopGoblinCelebrations")
THEN
DB_BUGFIX_Marker("GUSX-7126");
ClearFlag(DEN_AttackOnDen_Event_GoblinPartyInvitation_54e19b21-3fad-6a2e-c89a-9d5cf1b4773f, NULL_00000000-0000-0000-0000-000000000000, 0);

//If Celebrations were started with a broken Minthara
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Camp_QueuedNight((FLAG)NIGHT_GoblinHunt_RaiderCelebration_86fee25f-1069-4f17-89fa-4c5b69f82e0b)
AND
DB_BUGFIX_Marker("GUSX-7126")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "SCL_Main_A", "GUSX7126_TryResetMinthara");
NOT DB_CAMP_DrowBetrayal(1);
DB_CAMP_GoblinHuntCelebration_BetraylFightComplete(1);
PROC_Camp_InstantLongRest();
PROC_GOB_GoblinHuntAftermath_Pacified();

//If Minthara was sent to camp, put her back on stage once SCL is entered. 
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX7126_TryResetMinthara")
AND
DB_State_Current(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_MintharaFate", "MOO_MintharaFate_State_ToCamp")
THEN
SetOnStage(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1);

//Send Minthara back to Execution scene. For other cases, ,such as between camp and execution, assume she was abandonned so keeping her off stage is fine.
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX7126_TryResetMinthara")
AND
DB_SceneManager(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_Execution")
THEN
SetOnStage(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1);
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_Dialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, MOO_MintharaFate_Drow_deaff457-a97a-fd8f-9c46-517d1488a42a);
TeleportTo(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, S_MOO_ExecutionerCommanderHome_e117172f-b384-4d1c-82ae-f73b04c6d9eb);
SetFaction(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, GLO_DrowCommander_f984f683-e819-439e-af7c-48906053c20b);
PROC_GLO_UnequipAllWeapons((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_MOO_Execution_Speakers(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_MOO_Denizens((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);


//END_REGION

//REGION GUSX-7015
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_InCamp((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_Dead((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
IsTagged(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_ENEMYOFSHARPATH_8eca8027-996c-4c61-bec6-77f853de295b, 1)
THEN
SetOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0);
DB_BUGFIX_Marker("GUSX-7015");

//END_REGION

//REGION GUSX-2958

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_TriggerEvents_AllPlayersLeftAllTriggersInSet(_TriggerSet, "TopicalGreeting_LeftTriggerSet")
AND
Concatenate("TopicalGreeting_LeftTriggerSet_",_TriggerSet,_StrId)
THEN
DB_BUGFIX_Marker("GUSX-2958-FixingLeftTriggerSetEvents");
NOT DB_TriggerEvents_AllPlayersLeftAllTriggersInSet(_TriggerSet, "TopicalGreeting_LeftTriggerSet");
DB_TriggerEvents_AllPlayersLeftAllTriggersInSet(_TriggerSet, _StrId);

// To bring back possible unregistered SUB triggers by previous LeaveTriggerSet logic

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_TopicalGreetingEndCondition_LeaveTriggerSet(_TG_Flag,_TriggerSet)
AND
NOT DB_TriggerEvents_AllPlayersLeftAllTriggersInSet(_TriggerSet, _)
AND
DB_TopicalGreeting_Old(_TG_Flag)
AND
Concatenate("TopicalGreeting_LeftTriggerSet_",_TriggerSet,_StrId)
THEN
DB_BUGFIX_Marker("GUSX-2958-RegisterTriggersBack_OldTG");
DB_TriggerEvents_AllPlayersLeftAllTriggersInSet(_TriggerSet, _StrId);
PROC_TriggerRegisterTriggerSetForPlayers((STRING)_TriggerSet);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_TopicalGreetingEndCondition_LeaveTriggerSet(_TG_Flag,_TriggerSet)
AND
NOT DB_TriggerEvents_AllPlayersLeftAllTriggersInSet(_TriggerSet, "TopicalGreeting_LeftTriggerSet")
AND
DB_TopicalGreeting_Current(_TG_Flag)
AND
Concatenate("TopicalGreeting_LeftTriggerSet_",_TriggerSet,_StrId)
THEN
DB_BUGFIX_Marker("GUSX-2958-RegisterTriggersBack_CurrentTG");
DB_TriggerEvents_AllPlayersLeftAllTriggersInSet(_TriggerSet, _StrId);
PROC_TriggerRegisterTriggerSetForPlayers((STRING)_TriggerSet);

//END_REGION

//REGION GUS-313669
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
NOT DB_BUGFIX_Marker("GUS-313669_PatchedEND")
THEN
DB_BUGFIX_Marker("GUS-313669_PatchedEND");
PROC_BUGFIX_Patch5_AnubisConfigCheck_END();

PROC
PROC_BUGFIX_Patch5_AnubisConfigCheck_END()
AND
DB_LevelLoadedOnce("END_Main")
AND
DB_BUGFIX_Marker("GUS-313669_PatchedEND")
AND
DB_GLO_LevelTraveler(_Character,"END_Main",_LevelTravelerConfig)
AND
GetRegion(_Character,"END_Main")
THEN
PROC_BUGFIX_Patch5_AnubisConfigCheck(_Character,_LevelTravelerConfig);
//END_REGION

//REGION GUSX-1226
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_DismissedAvatar(_Player)
THEN
DB_BUGFIX_Marker("GUSX-1226_DismissedAvatar", _Player);
PROC_CRIME_Prison_StopFugitiveCrimes(_Player);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_IsArrested(_Arrester, _Player)
AND
NOT QRY_CRIME_Prison_IsInAnyPrison(_Player)
THEN
PROC_BUGFIX_Marker_GUSX_1226_ClearPrison(_Arrester, _Player);

PROC
PROC_BUGFIX_Marker_GUSX_1226_ClearPrison((CHARACTER)_Arrester, (CHARACTER)_Player)
THEN
DB_BUGFIX_Marker("GUSX-1226_Clear_DB_IsArrested", _Player);
ClearFlag((FLAG)IsInPrison_c9b75b21-6eba-065e-7680-fc9a0c5838e4, _Player);
NOT DB_IsArrested(_Arrester, _Player);

PROC
PROC_BUGFIX_Marker_GUSX_1226_ClearPrison(_, (CHARACTER)_Player)
AND
DB_CRIME_PrisonArrestedNonShapeshifted(_Player,_PrisonTrigger,_ArrestedNotShapeshifted)
THEN
NOT DB_CRIME_PrisonArrestedNonShapeshifted(_Player,_PrisonTrigger,_ArrestedNotShapeshifted);
NOT DB_CRIME_PrisonKnowCurrentShape(_Player, _PrisonTrigger);
//END_REGION

//REGION GUSX-1257
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
QRY_BUGFIX_GUSX_1257_NeedToFixDuergarCamp()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7","WLD_Main_A", "GUSX-1257");

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-1257")
THEN
PROC_GlobalSetFlagAndCache(GLO_DuergarCamp_EverEnteredBefore_ac0bae57-7006-4676-88b8-7498dde79c41);

PROC
PROC_ApplySavegamePatchInLevel("WLD_Main_A", "GUSX-1257")
AND
DB_Players(_Player)
AND
QRY_UND_LoneDuergar_BootsJournalCheck(_Player)
AND
QuestUpdateIsUnlocked(_Player, "UND_LoneDuergar", "Report", 0)
THEN
QuestUpdate(_Player, "UND_LoneDuergar", "Report");

QRY
QRY_BUGFIX_GUSX_1257_NeedToFixDuergarCamp()
AND
DB_OnlyOnce("UND_DarkLake_RaftCaptainCampIntroductionDialog")
AND
NOT DB_GlobalFlag(GLO_DuergarCamp_EverEnteredBefore_ac0bae57-7006-4676-88b8-7498dde79c41)
THEN
DB_NOOP(1);

QRY
QRY_BUGFIX_GUSX_1257_NeedToFixDuergarCamp()
AND
DB_OnlyOnce("UND_DarkLake_NoRaftCaptainCampIntroductionDialog")
AND
NOT DB_GlobalFlag(GLO_DuergarCamp_EverEnteredBefore_ac0bae57-7006-4676-88b8-7498dde79c41)
THEN
DB_NOOP(1);
//END_REGION GUSX-1257

//REGION GUSX-7335

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_BUGFIX_Marker("GUSX-7335")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
DB_BUGFIX_Marker("GUSX-7335-ClearRD");
DB_BUGFIX_Marker("GUSX-7335-ClearNight");
PROC_CancelRelationshipDialog(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)CAMP_NightsongShadowheartVisit_CFM_3327ccbc-a1c6-47ee-05ac-e735523036a5, NULL_00000000-0000-0000-0000-000000000000);
PROC_RemoveDialog(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_Dialogs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)CAMP_Nightsong_60070e0f-0ab6-f653-7962-c2fff93b5a2d);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_BUGFIX_Marker("GUSX-7335")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_Camp_QueuedNight((FLAG)NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79)
AND
DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_CampNight_CRD((FLAG)NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79, _Camper, _CRD, _Flag)
THEN
DB_BUGFIX_Marker("GUSX-7335-ClearRD");
PROC_CancelRelationshipDialog((CHARACTER)_Camper,(DIALOGRESOURCE)_CRD, (FLAG)_Flag);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_BUGFIX_Marker("GUSX-7335")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_Camp_QueuedNight((FLAG)NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79)
AND
DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
DB_BUGFIX_Marker("GUSX-7335-ClearNight");
PROC_RemoveDialog(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_Dialogs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)CAMP_Nightsong_60070e0f-0ab6-f653-7962-c2fff93b5a2d);
PROC_CampNight_ClearCampNight((FLAG)NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79);
PROC_Camp_RequiredTalks_Complete(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_GlobalFlag((FLAG)SCE_IsobelNightsongReunion_JoiningCamp_cea17782-fc15-19d3-e658-7f2f955ebd9f)
AND
DB_InCamp((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
DB_BUGFIX_Marker("GUSX-7335-Isobel");
PROC_DisappearOutOfSight((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "Walk", 1, "GEN_GoOffStage");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_GlobalFlag((FLAG)SCE_IsobelNightsongReunion_JoiningCamp_cea17782-fc15-19d3-e658-7f2f955ebd9f)
AND
DB_InCamp((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
DB_BUGFIX_Marker("GUSX-7335-Nightsong");
PROC_DisappearOutOfSight((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "Walk", 1, "GEN_GoOffStage");
//END_REGION

//REGION GUSX-683
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_PartOfTheTeam(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_Players((CHARACTER)_Player)
AND
GetFlag((FLAG)GLO_Companion_Leave_363c71f4-8b46-c0c0-4bbb-0e5a85e4652d, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1)
THEN
DB_BUGFIX_Marker("GUSX-683");
DB_CompanionLeaving(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Player);
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_ClearOriginLeavingDialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_DisappearOutOfSight(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,"Run",1,"GLO_CompanionLeaves_LowRelation");
NOT DB_PartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
NOT DB_END_RealPartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
//END_REGION

//REGION GUSX-765
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
NOT QRY_BG3_SaveGamePatch_GUSX_765_AnyPlayerInDialogInCombat((GUIDSTRING)_CombatID)
AND
NOT QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause(_CombatID)
AND
NOT DB_BUGFIX_Marker("GUSX-765", _CombatID)
THEN
DB_BUGFIX_Marker("GUSX-765", _CombatID);
ResumeCombat(_CombatID);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_AnyPlayerInDialogInCombat((GUIDSTRING)_CombatID)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
DB_Players((CHARACTER)_Player)
AND
DB_DialogPlayers(_DialogID, _Player, _)
AND
DB_DialogName(_DialogName, _DialogID)
AND
DialogIsAutomated(_DialogName, 0)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_PLA_ConflictedFlind_GnollJoke_Caster(_,_CombatID)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_GOB_Gestivities_PausedCombat(_CombatID)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_END_HighHallInterior_PausedCombatPlayer(_, _CombatID)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_END_BrainBattle_PausedCombat(_CombatID)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_LOW_BhaalTemple_CombatID(_CombatID)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_WYR_RaphaelTango_CombatWithRaphaelPaused(_CombatID)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_MOO_Jailbreak_PausedCombat(_CombatID)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_MOO_Execution_PausedCombat(_ID)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_GLO_NarrativeCombat_ID("MOO_Assault_KethericRoofFight", _CombatID)
AND
DB_MOO_Assault_RoofNarrativeCombatIsPaused(1)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_HAV_TakingIsobel_MainRoomCombatDialog(_)
AND
DB_HAV_TakingIsobel_MainRoomCombat(_CombatID)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUSX_765_ScriptedPause((GUIDSTRING)_CombatID)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_CombatID)
AND
DB_TUT_Helm_FinalCombatPaused(1)
THEN
DB_NOOP(1);


//END_REGION

//REGION GUSX-7806
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
GetCombatGroupID(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "DEN_AttackOnDen_GateCombat")
THEN
DB_BUGFIX_Marker("GUSX-7806");
SetCombatGroupID(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "");
//END_REGION GUSX-7806

//REGION GUSX-9108

PROC
PROC_ApplySavegamePatches()
AND
DB_RemovedMutingStatusRestoreInfo(_Character, _Status, _Duration, _Causee)
AND
NOT DB_MutingStatuses_Restoring(_Character, _, _)
AND
NOT DB_DialogPlayers(_, _Character, _)
AND
NOT DB_DialogNPCs(_, _Character, _)
THEN
DB_BUGFIX_Marker("GUSX-9108");
NOT DB_RemovedMutingStatusRestoreInfo(_Character, _Status, _Duration, _Causee);

PROC
PROC_ApplySavegamePatches()
AND
DB_RemovedMutingStatusHPRestoreInfo(_Character, _HP)
AND
NOT DB_MutingStatuses_Restoring(_Character, _, _)
AND
NOT DB_DialogPlayers(_, _Character, _)
AND
NOT DB_DialogNPCs(_, _Character, _)
THEN
DB_BUGFIX_Marker("GUSX-9108");
NOT DB_RemovedMutingStatusHPRestoreInfo(_Character, _HP);

//END_REGION

//REGION GUSX-9795
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_Event_IncurableWoundFlared_9a1f4cad-75ec-48dd-a408-929af01136c9)
THEN
DB_BUGFIX_Marker("GUSX-9795");
PROC_GlobalClearFlagAndCache((FLAG)ORI_Shadowheart_Event_IncurableWoundFlared_9a1f4cad-75ec-48dd-a408-929af01136c9);
PROC_IncreaseCounter("ORI_Shadowheart_IncurableWoundFlares");
//END_REGION GUSX-9795

//REGION GUSX-9096
PROC
PROC_ApplySavegamePatches()
AND
DB_Camp_AtLeastOnePlayerHasSleepCutscene(1)
AND
DB_DialogPlayers(_DialogID, _Player, 1)
AND
NOT DB_Players((CHARACTER)_Player)
AND
DB_DialogName(_Dialog, _DialogID)
THEN
DB_BUGFIX_Marker_GUSX9096(_Player, _Dialog);
DialogRequestStop(_Player);
//END_REGION GUSX-9096

//REGION GUSX-9944
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
THEN
DB_BUGFIX_Marker("GUSX-9944");
DB_Bard_DLC_SongsMapping("Bard_Perform_MainTheme", "Bard_Perform_DOS2_1");
DB_Bard_DLC_SongsMapping("Bard_Perform_SingForMe", "Bard_Perform_DOS2_2");
DB_Bard_DLC_SongsMapping("Bard_Perform_QueensHighSeas", "Bard_Perform_DOS2_3");
//END_REGION

//REGION GUSX-10580

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_FallbackCamp_InCamp((STRING)_)
AND
DB_Camp_QueuedNight((FLAG)_NightFlag)
AND
DB_CampNight_ResurrectWhenForced((FLAG)_NightFlag,(CHARACTER)_Character)
AND
NOT DB_InCamp((CHARACTER)_Character)
AND
DB_PartOfTheTeam(_Character)
AND
NOT DB_PermaDefeated((CHARACTER)_Character)
THEN
DB_BUGFIX_Marker("GUSX-10580",_Character);
SetEntityEvent((CHARACTER)_Character,"Origin_RestoreDialog",1);

//END_REGION GUSX-10580

//REGION GUSX-8343

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_ShadowheartLaezelFight_Fight(1)
AND
GetFlag(CAMP_Shadowheart_Event_Fight_9e208379-c14f-b65a-c4a2-a029162939cb, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
IsOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
AND
DB_Avatars(_Player)
THEN
DB_BUGFIX_Marker("GUSX-8343-Shadowheart");
Die(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 1, 1);
MoveAllItemsTo(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Player, 1, 1, 1, 1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_ShadowheartLaezelFight_Fight(1)
AND
GetFlag(CAMP_Shadowheart_Event_Fight_9e208379-c14f-b65a-c4a2-a029162939cb, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1)
AND
NOT DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
IsOnStage(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1)
AND
DB_Avatars(_Player)
THEN
DB_BUGFIX_Marker("GUSX-8343-Laezel");
Die(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 1, 1);
MoveAllItemsTo(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _Player, 1, 1, 1, 1);

//END_REGION GUSX-8343

//REGION GUSX-11724

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_LevelLoadedOnce("END_Main_A")
AND
DB_GlobalCounter("ORI_Shadowheart_ParentPoints", _Value)
AND
_Value >= 2
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_State_ParentPoints_HasEnoughPoints_1bbdd0b8-c2de-4b2f-8ce8-6740812deb59)
THEN
DB_BUGFIX_Marker("GUSX-11724");
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_ParentPoints_HasEnoughPoints_1bbdd0b8-c2de-4b2f-8ce8-6740812deb59);

//END_REGION GUSX-11724

//REGION GUSX-10784
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag((FLAG)COL_Morgue_State_UsSaved_14440266-df48-ff1b-b65a-b661d79f523c)
THEN
DB_BUGFIX_GUSX_10784_FixUsStory(1);

IF
DB_BUGFIX_GUSX_10784_FixUsStory(1)
AND
DB_Avatars(_Player)
AND
NOT DB_BUGFIX_Marker("GUSX-10784")
AND
GetItemByTemplateInPartyInventory(UNI_COL_Us_Summon_Brain_dbc5b484-26d6-41f3-bd50-dc74b8f9cc9b, _Player, _Item)
THEN
SetStoryItem(_Item, 1);
DB_BUGFIX_Marker("GUSX-10784");
NOT DB_BUGFIX_GUSX_10784_FixUsStory(1);

// theres no way to get the item by its template or to iterate over all chests, so we have to do this instead
IF
TemplateAddedTo(UNI_COL_Us_Summon_Brain_dbc5b484-26d6-41f3-bd50-dc74b8f9cc9b, _Item, _,_)
AND
DB_BUGFIX_GUSX_10784_FixUsStory(1)
AND
NOT DB_BUGFIX_Marker("GUSX-10784")
THEN
SetStoryItem((ITEM)_Item, 1);
DB_BUGFIX_Marker("GUSX-10784");
NOT DB_BUGFIX_GUSX_10784_FixUsStory(1);
//END_REGION

//REGION GUSX-11217

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
THEN
DB_ORI_DarkUrge_GenderFlags((TAG)MALE_8f74d144-041e-4035-a9ac-72f41fc32de7, (FLAG)ORI_State_DU_Male_ed990e74-1cb2-8af5-58bc-2932aeeaa780);
DB_ORI_DarkUrge_GenderFlags((TAG)FEMALE_3806477c-65a7-4100-9f92-be4c12c4fa4f, (FLAG)ORI_State_DU_Female_ced5a147-785a-d927-39b1-f90f7c515f86);
DB_BUGFIX_Marker("GUSX-11217");

//END_REGION

//REGION GUSX-7172
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_OnlyOnce("END_BlockNewPlayers")
THEN
SetJoinBlock(JOINBLOCKTYPE.BlockNew);
DB_BUGFIX_Marker("GUSX-7172");
//END_REGION GUSX-7172

//REGION GUSX-11827
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_WYR_Posthouse_DogKennel((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, _, _Trigger) // functions as a check if the level was loaded and to fetch the trigger
AND
DB_GlobalFlag((FLAG)WYR_Posthouse_State_DogCapturedAtPostHouse_15be0be6-ef80-4593-8811-dda079f57247)
AND
GetFlag((FLAG)WYR_Posthouse_State_DogLoose_9ff746c2-47b3-4da7-9894-a5a7c8343bac, S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, 1)
THEN
PROC_FOR_CourierDog_ClearOldFetch();
TeleportTo(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, S_WYR_Posthouse_Point_CourierDog_bf887544-a6e2-4278-930c-d2996c6d2eb8);
ClearFlag((FLAG)WYR_Posthouse_State_DogLoose_9ff746c2-47b3-4da7-9894-a5a7c8343bac, S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901);
TriggerRegisterForCharacter(_Trigger, (CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901);
DB_BUGFIX_Marker("GUSX-11827");

PROC
PROC_FOR_CourierDog_ClearOldFetch()
AND
DB_FOR_CourierDog_IsFetching(_Player, _ScratchFamiliar, _ThrownObject)
THEN
PROC_FOR_CourierDog_ClearFetch(_Player, _ScratchFamiliar, _ThrownObject, 1);
//END_REGION GUSX-11827

//REGION GUSX-12224

PROC
PROC_ApplySavegamePatches()
AND
DB_PlayerSummons(_Character)
AND
Exists(_Character, 0)
THEN
NOT DB_IsOrWasInParty(_Character);
NOT DB_PlayerSummons(_Character);

//END_REGION

//REGION GUSX-406
PROC
PROC_ApplySavegamePatches() //Cause not found, so no savegame version checking
AND
DB_CAMP_CharacterLongRested(_)
THEN
PROC_Camp_EveryoneWakeup();
DB_BUGFIX_Marker("GUSX-406 Players failed to wake up in camp");
//END_REGION

//REGION GUSX-9144 (GLO)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
THEN
DB_GUSX_9144_HeroFactions((FACTION)6545a015-1b3d-66a4-6a0e-6ec62065cdb7, "Hero1");
DB_GUSX_9144_HeroFactions((FACTION)9fac6ec7-642b-3553-1bc8-6b8e0edae7d5, "Hero2");
DB_GUSX_9144_HeroFactions((FACTION)286958be-0845-b4ee-611f-1a9c27dcbe10, "Hero3");
DB_GUSX_9144_HeroFactions((FACTION)e69da880-4178-0d67-846d-bf65f8750ce3, "Hero4");
DB_GUSX_9144_HeroFactions((FACTION)42455b5c-c09b-ea83-4fee-5932dfd76525, "Hero5");
DB_GUSX_9144_HeroFactions((FACTION)1e359c81-966b-783e-1f5b-69600828513d, "Hero6");
DB_GUSX_9144_HeroFactions((FACTION)738620dc-b053-098a-4193-895e3516d93b, "Hero7");
DB_GUSX_9144_HeroFactions((FACTION)eaca69b1-71a6-1abd-a08c-4e57af77ad1a, "Hero8");
DB_GUSX_9144_HeroFactions((FACTION)a1542c81-6895-929e-4522-10ce218bb360, "Hero");
PROC_BUGFIX_GUSX_9144_CheckFactions();

PROC
PROC_BUGFIX_GUSX_9144_CheckFactions()
AND
DB_GUSX_9144_HeroFactions(_Faction, _Name)
AND
GetRelation(_Faction, (FACTION)cfb709b3-220f-9682-bcfb-6f0d8837462e, _Relation)
AND
_Relation != 50
AND
Concatenate("GUSX-9144", _Name, _Marker)
THEN
PROC_SetRelation(_Faction, cfb709b3-220f-9682-bcfb-6f0d8837462e, 50);
DB_BUGFIX_Marker(_Marker);
//END_REGION

//REGION GUSX_12378

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_Camp_NightMode(1)
AND
DB_Players(_Player)
AND
HasActiveStatus(_Player, "LONG_REST", 1)
THEN
RemoveStatus(_Player, "LONG_REST", NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUSX_12378-1");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
THEN
DB_GUSX_12378_Night((FLAG)NIGHT_Gale_TressymJoin_7ca98d47-e9fa-4f87-8728-8e56c4ee652d);
DB_GUSX_12378_Night((FLAG)NIGHT_ORI_Gale_ElminsterVisit_a58e9b3e-b458-48be-b32a-a88a2c65bed5);
DB_GUSX_12378_Night((FLAG)NIGHT_DarkUrge_SkippedTempleFinale_aa87947e-9ae0-4a2d-a3ed-fb2c9ca6be5c);
DB_GUSX_12378_Night((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9);
DB_GUSX_12378_Night((FLAG)NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79);
DB_GUSX_12378_Night((FLAG)NIGHT_InfernalBoxAppears_47942a99-c44e-4e90-a0a2-6956bed9dc5b);
DB_GUSX_12378_Night((FLAG)NIGHT_AstarionHungerA_ec01fb84-d9ef-47b6-8b32-6620edd67d50);
DB_GUSX_12378_Night((FLAG)NIGHT_AstarionHungerC_Bite_fe3fd3a0-70d1-4bc4-8a7f-4614f89ac23d);
DB_GUSX_12378_Night((FLAG)NIGHT_Astarion_RaphaelsRevelation_3a3b2dca-7e94-47af-b81f-93194944c633);
DB_GUSX_12378_Night((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2);
DB_GUSX_12378_Night((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_Gale_TressymJoin_7ca98d47-e9fa-4f87-8728-8e56c4ee652d)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_TressymJoined_c46cfbb6-2aad-47a9-81a1-bdd28a7919fb)
AND
NOT DB_LevelLoadedOnce("BGO_Main_A")
THEN
PROC_CampNight_GaleTressym_ToCamp(1);
PROC_Foop(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);
PROC_ORI_Gale_ResetVisitedRegions();
DB_ORI_Gale_RegionCounter(2, (FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8);
DB_ORI_Gale_RegionCounter(4, (FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_ORI_Gale_ElminsterVisit_a58e9b3e-b458-48be-b32a-a88a2c65bed5)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c)
THEN
SetFlag(ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_CanProceedToAct3_64850ffe-e278-4742-91f2-3cecd77d1257)
THEN
SetFlag(ORI_Laezel_State_CanProceedToAct3_64850ffe-e278-4742-91f2-3cecd77d1257);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag(ORI_Laezel_State_BetrayedByVlaakith_175d8487-99dc-4009-9b45-6e9f29708cd7)
AND
NOT DB_CurrentLevel("CRE_Main_A")
AND
NOT DB_CampNight_Completed(NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9)
THEN
DB_CampNight_Completed(NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9);
SetFlag(NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_GUSX_12378_Night_Recovered(NIGHT_Laezel_VossCampConfrontation_d6828c76-0e03-4aa1-b980-886fcf49f8a9);
SetFlag((FLAG)ORI_Laezel_State_CanProceedToAct3_64850ffe-e278-4742-91f2-3cecd77d1257, NULL_00000000-0000-0000-0000-000000000000, 0);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_DarkUrge_SkippedTempleFinale_aa87947e-9ae0-4a2d-a3ed-fb2c9ca6be5c)
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0)
THEN
SetFlag((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_DarkUrge_SkippedTempleFinale_aa87947e-9ae0-4a2d-a3ed-fb2c9ca6be5c)
AND
NOT DB_GlobalFlag((FLAG)ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3)
THEN
ClearFlag((FLAG)ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79)
AND
NOT DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143)
THEN
SetFlag((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143);
TemplateAddTo((ITEMROOT)MAG_SHA_SeluneBlessing_Spear_2eeabe97-8f29-4f4f-827e-6cfcd8fd1779, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1, 1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("INT_Main_A")
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c)
AND
NOT DB_CampNight_Completed((FLAG)NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79)
AND
NOT DB_PermaDefeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
DB_CampNight_Completed((FLAG)NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79);
SetFlag(NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_GUSX_12378_Night_Recovered((FLAG)NIGHT_NightsongShadowheartVisit_5cf06d9e-44ce-4431-a1c6-839bfdad5f79);
SetFlag((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143);
TemplateAddTo((ITEMROOT)MAG_SHA_SeluneBlessing_Spear_2eeabe97-8f29-4f4f-827e-6cfcd8fd1779, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1, 1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_CampNight_Completed(NIGHT_InfernalBoxAppears_47942a99-c44e-4e90-a0a2-6956bed9dc5b)
AND
DB_GlobalFlag(GLO_InfernalBox_Event_CampNightCanTrigger_02d4ce08-c435-499d-8109-d993cb9293dd) //Checks whether the Box is not currently assigned
AND
NOT DB_CurrentLevel("WLD_Main_A")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
GetHostCharacter(_Char)
THEN
SetFlag(NIGHT_InfernalBoxAppears_47942a99-c44e-4e90-a0a2-6956bed9dc5b, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_GLO_InfernalBox_SetPlayerOwner((CHARACTER)_Char);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_InfernalBoxAppears_47942a99-c44e-4e90-a0a2-6956bed9dc5b)
AND
DB_GlobalFlag(GLO_InfernalBox_Event_CampNightCanTrigger_02d4ce08-c435-499d-8109-d993cb9293dd)
AND
GetHostCharacter(_Char)
THEN
PROC_GLO_InfernalBox_SetPlayerOwner((CHARACTER)_Char);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_AstarionHungerA_ec01fb84-d9ef-47b6-8b32-6620edd67d50)
AND
GetFlag((FLAG)CAMP_Astarion_Event_AddCazadorToBiteScene_bf7abb2c-2e3c-4209-a9eb-5e772142c4f0, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
THEN
SetFlag(CAMP_Astarion_TheHungerA_HuntAnimal_ef9c902d-0940-4a39-a926-5717795b89fe, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_CampNight_Completed(NIGHT_AstarionHungerA_ec01fb84-d9ef-47b6-8b32-6620edd67d50)
AND
DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_CurrentLevel("WLD_Main_A")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
GetFlag((FLAG)CAMP_Astarion_Event_AddCazadorToBiteScene_bf7abb2c-2e3c-4209-a9eb-5e772142c4f0, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
THEN
SetFlag(NIGHT_AstarionHungerA_ec01fb84-d9ef-47b6-8b32-6620edd67d50, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(CAMP_Astarion_TheHungerA_HuntAnimal_ef9c902d-0940-4a39-a926-5717795b89fe, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_CampNight_Completed(NIGHT_AstarionHungerA_ec01fb84-d9ef-47b6-8b32-6620edd67d50);
DB_GUSX_12378_Night_Recovered(NIGHT_AstarionHungerA_ec01fb84-d9ef-47b6-8b32-6620edd67d50);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_AstarionHungerC_Bite_fe3fd3a0-70d1-4bc4-8a7f-4614f89ac23d)
AND
NOT DB_GlobalFlag(ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
THEN
SetFlag(ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_CampNight_Completed(NIGHT_AstarionHungerC_Bite_fe3fd3a0-70d1-4bc4-8a7f-4614f89ac23d)
AND
NOT DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_CurrentLevel("WLD_Main_A")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_GlobalFlag(ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
THEN
SetFlag(NIGHT_AstarionHungerC_Bite_fe3fd3a0-70d1-4bc4-8a7f-4614f89ac23d, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_CampNight_Completed(NIGHT_AstarionHungerC_Bite_fe3fd3a0-70d1-4bc4-8a7f-4614f89ac23d);
DB_GUSX_12378_Night_Recovered(NIGHT_AstarionHungerC_Bite_fe3fd3a0-70d1-4bc4-8a7f-4614f89ac23d);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_Astarion_RaphaelsRevelation_3a3b2dca-7e94-47af-b81f-93194944c633)
AND
NOT DB_GlobalFlag(ORI_Astarion_State_RaphaelToldRitual_7b30820e-92e5-4f64-a2f5-92edbd9a0e2f)
THEN
SetFlag(ORI_Astarion_State_RaphaelToldRitual_7b30820e-92e5-4f64-a2f5-92edbd9a0e2f, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(ORI_Astarion_Knows_RitualsPurpose_d1dc0f8a-b77d-4e40-a501-a66e163b8376, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_CampNight_Completed(NIGHT_Astarion_RaphaelsRevelation_3a3b2dca-7e94-47af-b81f-93194944c633)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_LevelLoadedOnce("INT_Main_A")
AND
DB_GlobalFlag((FLAG)SHA_Orthon_State_DefeatedOnce_8dd589d6-90fc-4a3b-b369-10440bd56520)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5)
THEN
SetFlag(ORI_Astarion_State_RaphaelToldRitual_7b30820e-92e5-4f64-a2f5-92edbd9a0e2f, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(ORI_Astarion_Knows_RitualsPurpose_d1dc0f8a-b77d-4e40-a501-a66e163b8376, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(NIGHT_Astarion_RaphaelsRevelation_3a3b2dca-7e94-47af-b81f-93194944c633, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_CampNight_Completed(NIGHT_Astarion_RaphaelsRevelation_3a3b2dca-7e94-47af-b81f-93194944c633);
DB_GUSX_12378_Night_Recovered(NIGHT_Astarion_RaphaelsRevelation_3a3b2dca-7e94-47af-b81f-93194944c633);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2)
AND
QRY_GUSX_12378_MizorasJudgement_Recover()
THEN
DB_NOOP(1);

QRY
QRY_GUSX_12378_Night_Recover((FLAG)NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6)
AND
QRY_GUSX_12378_MizorasJudgement_Recover()
THEN
DB_NOOP(1);

QRY
QRY_GUSX_12378_MizorasJudgement_Recover()
AND
NOT DB_GlobalFlag(CAMP_MizorasJudgement_Event_Judged_c6d2140f-312d-65d4-e66e-92de4258b3f4)
THEN
SetFlag(CAMP_MizorasJudgement_Event_Judged_c6d2140f-312d-65d4-e66e-92de4258b3f4, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_GUSX_12378_Night_Recovered(NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2);
DB_GUSX_12378_Night_Recovered(NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6);

QRY
QRY_GUSX_12378_MizorasJudgement_Recover()
AND
DB_GlobalFlag(ORI_WyllConfrontation_State_ResolvedPeacefuly_fa3b8420-26bc-361d-8fbf-c6da37353446)
AND
NOT DB_GlobalFlag(ORI_Wyll_State_IsDevil_f83eee79-271b-4044-947a-d8eb699d734a)
THEN
SetFlag(ORI_Wyll_State_IsDevil_f83eee79-271b-4044-947a-d8eb699d734a, NULL_00000000-0000-0000-0000-000000000000, 0);
SetTag(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, WYLL_DEVIL_5e844f0e-d822-4210-a28e-6af149a7bd4b);
DB_GUSX_12378_Night_Recovered(NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2);
DB_GUSX_12378_Night_Recovered(NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_CampNight_Completed(NIGHT_Wyll_MizorasJudgement_ad448187-17b4-45a1-9acc-eb8b016e1dd2)
AND
NOT DB_CampNight_Completed(NIGHT_Wyll_MizorasJudgementPatch_94d0b969-703d-4343-a0cb-cfd6dd1921a6)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_CurrentLevel("WLD_Main_A")
AND
DB_LevelLoadedOnce("WLD_Main_A")
AND
QRY_GUSX_12378_Wyll_MizorasJudgement()
AND
QRY_GUSX_12378_MizorasJudgement_Recover()
THEN
DB_NOOP(1);

QRY
QRY_GUSX_12378_Wyll_MizorasJudgement()
AND
DB_GlobalFlag(ORI_WyllConfrontation_State_ResolvedPeacefuly_fa3b8420-26bc-361d-8fbf-c6da37353446)
THEN
DB_NOOP(1);

QRY
QRY_GUSX_12378_Wyll_MizorasJudgement()
AND
DB_GlobalFlag(ORI_WyllConfrontation_State_KnockedOutKarlach_8c23b5fe-732f-40e8-a0cb-bf165b7bf5c7)
THEN
DB_NOOP(1);

//Can't rely on checking that Karlach is dead, because Karlach may have died under entirely different circumstances.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_GUSX_12378_Night(_Night)
AND
DB_CampNight_Completed(_Night)
AND
NOT DB_Camp_QueuedNight(_Night)
AND
NOT DB_GUSX_12378_Night_Recovered(_Night)
AND
QRY_GUSX_12378_Night_Recover(_Night)
THEN
DB_GUSX_12378_Night_Recovered(_Night);

//The night is already over, no new night has started, thus PROC_CampNight_DecideCampNight has not reset Queued Night.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_GUSX_12378_Night(_Night)
AND
DB_CampNight_Completed(_Night)
AND
DB_Camp_QueuedNight(_Night)
AND
NOT DB_Camp_NightMode(1)
AND
NOT DB_GUSX_12378_Night_Recovered(_Night)
AND
QRY_GUSX_12378_Night_Recover(_Night)
THEN
DB_GUSX_12378_Night_Recovered(_Night);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag((FLAG)CURRENTREGION_CRE_Main_A_bbc31a08-cfb0-4501-9401-4b12a78efa35)
AND
NOT DB_GUSX_12378_Night_Recovered(NIGHT_DaisyDream1_52669b07-9584-4c9d-8219-49679811fd4f)
AND
NOT DB_GLO_DaisyUnlocked(1) 
THEN
DB_GLO_DaisyUnlocked(1);
DB_CampNight_Completed(NIGHT_DaisyDream1_52669b07-9584-4c9d-8219-49679811fd4f);
SetFlag(NIGHT_DaisyDream1_52669b07-9584-4c9d-8219-49679811fd4f, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_GUSX_12378_Night_Recovered(NIGHT_DaisyDream1_52669b07-9584-4c9d-8219-49679811fd4f);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag((FLAG)CURRENTREGION_SCL_Main_A_f76b85b5-b557-4409-98fd-cc7b22f8292b)
AND
NOT DB_GUSX_12378_Night_Recovered(NIGHT_DaisyDream1_52669b07-9584-4c9d-8219-49679811fd4f)
AND
NOT DB_GLO_DaisyUnlocked(1) 
THEN
DB_GLO_DaisyUnlocked(1);
DB_CampNight_Completed(NIGHT_DaisyDream1_52669b07-9584-4c9d-8219-49679811fd4f);
SetFlag(NIGHT_DaisyDream1_52669b07-9584-4c9d-8219-49679811fd4f, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_GUSX_12378_Night_Recovered(NIGHT_DaisyDream1_52669b07-9584-4c9d-8219-49679811fd4f);

//END_REGION

//REGION GUSX-12027

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_DialogName((DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, _ID)
AND
NOT DB_DialogPlayers(_ID, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _)
AND
GetFlag((FLAG)Shadowheart_InParty_Event_VampireConfrontationStart_74a8e468-21e8-4fbf-a7c0-d5e88e2f2ba5, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
THEN
ClearFlag((FLAG)Shadowheart_InParty_Event_VampireConfrontationStart_74a8e468-21e8-4fbf-a7c0-d5e88e2f2ba5, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_BUGFIX_Marker("GUSX-12027");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_DialogName((DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, _)
AND
GetFlag((FLAG)Shadowheart_InParty_Event_VampireConfrontationStart_74a8e468-21e8-4fbf-a7c0-d5e88e2f2ba5, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
THEN
ClearFlag((FLAG)Shadowheart_InParty_Event_VampireConfrontationStart_74a8e468-21e8-4fbf-a7c0-d5e88e2f2ba5, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_BUGFIX_Marker("GUSX-12027");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_DialogName((DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, _ID)
AND
DB_DialogPlayers(_ID, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _)
AND
GetFlag((FLAG)Shadowheart_InParty_Event_VampireConfrontationStart_74a8e468-21e8-4fbf-a7c0-d5e88e2f2ba5, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1)
THEN
DB_BUGFIX_AstarionVampireSHConfession_Fix(1);

IF
DB_BUGFIX_AstarionVampireSHConfession_Fix(1)
AND
NOT DB_DialogName((DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5, _)
THEN
NOT DB_BUGFIX_AstarionVampireSHConfession_Fix(1);
ClearFlag((FLAG)Shadowheart_InParty_Event_VampireConfrontationStart_74a8e468-21e8-4fbf-a7c0-d5e88e2f2ba5, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_BUGFIX_Marker("GUSX-12027");


//END_REGION GUSX-12027

//REGION GUSX-9437
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-9437");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9437")
AND
DB_MOO_UnwelcomeVisitors_VisitorCrimeRegistered(_Visitor, _CrimeID)
AND
DB_Players(_Visitor)
AND
NOT QRY_UnwelcomeVisitors_IsInMOO(_Visitor)
AND
IntegerToString(_CrimeID, _StrCrimeID)
AND
Concatenate("GUSX-9437", _StrCrimeID, _Marker)
THEN
DB_BUGFIX_Marker(_Marker, _Visitor);
CharacterStopCrimeWithID(_Visitor, _CrimeID);
NOT DB_MOO_UnwelcomeVisitors_VisitorCrimeRegistered(_Visitor, _CrimeID);
//END_REGION

//REGION GUSX-10219
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan( 4, 8, 0, 0 )
AND
DB_Crime_WarningCount(_, "MOO_Trespass_UnaccompaniedIntruder", _Criminal, _Investigator)
AND
DB_MOO_UnwelcomeVisitors_Visitors(_Criminal)
AND
NOT QRY_UnwelcomeVisitors_IsInMOO(_Investigator)
THEN
PROC_BUGFIX_ClearUnwelcomeVisitorCrimeHostility();

PROC
PROC_BUGFIX_ClearUnwelcomeVisitorCrimeHostility()
AND
DB_Players((CHARACTER)_Character)
AND
GetFaction(_Character, _Faction)
AND
CombatGetGuidFor(_Character, (GUIDSTRING)_CombatId)
AND
NOT QRY_UnwelcomeVisitors_IsInMOO(_Character)
THEN
EndCombat(_CombatId);
DB_BUGFIX_Marker("GUSX-10219");
PROC_ResetRelationMutual(_Faction, (FACTION)Act2_HAV_Haven_e52bfc8c-7826-470d-a9f5-f6fae80dde82);
PROC_MOO_PlayerLeftMOO(_Character);

PROC
PROC_BUGFIX_ClearUnwelcomeVisitorCrimeHostility()
AND
DB_Players((CHARACTER)_Character)
AND
GetFaction(_Character, _Faction)
AND
NOT QRY_UnwelcomeVisitors_IsInMOO(_Character)
THEN
DB_BUGFIX_Marker("GUSX-10219");
PROC_ResetRelationMutual(_Faction, (FACTION)Act2_HAV_Haven_e52bfc8c-7826-470d-a9f5-f6fae80dde82);
PROC_MOO_PlayerLeftMOO(_Character);

PROC
PROC_BUGFIX_ClearUnwelcomeVisitorCrimeHostility()
AND
DB_MOO_UnwelcomeVisitors_Visitors(_Character)
AND
DB_PartOfTheTeam(_Character)
AND
NOT QRY_UnwelcomeVisitors_IsInMOO(_Character)
AND
DB_CompanionOnlyFaction(_Character, (FACTION)_Faction)
THEN
DB_BUGFIX_Marker("GUSX-10219");
PROC_ResetRelationMutual(_Faction, (FACTION)Act2_HAV_Haven_e52bfc8c-7826-470d-a9f5-f6fae80dde82);
PROC_MOO_PlayerLeftMOO(_Character);

//END_REGION

//REGION GUSX-9121
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan( 4, 8, 0, 0 )
AND
DB_Crime_DefeatedPlayers((CHARACTER)_Criminal, (GUIDSTRING)_CombatID)
AND
SysCount("DB_Crime_DefeatedPlayers", 2, _DefeatedPlayerCount)
AND
DB_Crime_CombatID(_CrimeID,_CombatID)
AND
CombatGetInvolvedPlayersCount(_CombatID, _PlayersInCombatCount)
AND
_DefeatedPlayerCount == _PlayersInCombatCount
AND
NOT QRY_CRIME_CombatHasNonDownedPlayers(_CombatID)
THEN
DB_BUGFIX_Marker("GUSX-9121");
PROC_Crime_RemoveAITags();
//END_REGION GUSX-9121

//REGION GUSX-5898
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
THEN
DB_BUGFIX_Marker("GUSX-5898_MainDBs");
DB_GLO_PaladinOathbreaker_SubclassOathBrokenFlags((FLAG)GLO_PaladinOathbreaker_Event_CrownBrokeOath_b6344b22-0d02-489f-acc8-04a18671fe5b, (TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91);
DB_GLO_PaladinOathbreaker_SubclassTags((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, (TAG)OATHBREAKER_CROWN_dc03261b-0480-4338-80e5-50c2b5ca230b);
DB_GLO_PaladinOathbreaker_CrimesToReact((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, "EludeArrest", (TAG)CIVILIAN_71120d5d-3853-46e4-9762-33f59aa6b4ae);
DB_GLO_PaladinOathbreaker_CrimesToReact((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, "EludeArrest", (TAG)CROWDSYS_NPC_1274ffab-2fa2-4d6f-801e-751664ceb771);
DB_GLO_PaladinOathbreaker_CrimesToReact((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, "EludeArrest", (TAG)KID_ee978587-6c68-4186-9bfc-3b3cc719a835);
DB_GLO_PaladinOathbreaker_CrimesToReact((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, "EludeArrest", (TAG)GUARD_0b52f35e-fb1f-4865-bcd2-5d21ef7343cd);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_GLO_PaladinOathbreaker_GenericCrimes(_Crime)
THEN
DB_GLO_PaladinOathbreaker_CrimesToReact((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, _Crime, (TAG)CIVILIAN_71120d5d-3853-46e4-9762-33f59aa6b4ae);
DB_GLO_PaladinOathbreaker_CrimesToReact((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, _Crime, (TAG)CROWDSYS_NPC_1274ffab-2fa2-4d6f-801e-751664ceb771);
DB_GLO_PaladinOathbreaker_CrimesToReact((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, _Crime, (TAG)KID_ee978587-6c68-4186-9bfc-3b3cc719a835);
DB_GLO_PaladinOathbreaker_CrimesToReact((TAG)PALADIN_CROWN_7efcadc0-9e88-4d0a-87b9-64a589e2df91, _Crime, (TAG)GUARD_0b52f35e-fb1f-4865-bcd2-5d21ef7343cd);
//END_REGION GUSX-5898

//REGION GUSX-13841

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_Achievements_BG3_Quest30_UnarmedSpells("Target_StunningStrike")
THEN
NOT DB_Achievements_BG3_Quest30_UnarmedSpells("Target_StunningStrike");
DB_BUGFIX_Marker("GUSX-13841_StunningStrike");

//END_REGION GUSX-13841

//REGION GUSX-13442

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8 Beta Hotfix 2")
THEN
DB_GLO_Spells_BladesongEquipSlots("Breast", EQUIPMENTSLOT.Breast);
DB_GLO_Spells_BladesongEquipSlots("Melee Main Weapon", EQUIPMENTSLOT.MeleeMainHand);
DB_GLO_Spells_BladesongEquipSlots("Melee Offhand Weapon", EQUIPMENTSLOT.MeleeOffHand);
DB_GLO_Spells_BladesongProficiencyBlockers("Shields", "BLADESONG_SHIELD");
DB_GLO_Spells_BladesongProficiencyBlockers("Shields", "BLADESONG_SHIELD_MESSAGE");
DB_GLO_Spells_BladesongProficiencyBlockers("MediumArmor", "BLADESONG_ARMOR_MESSAGE");
DB_GLO_Spells_BladesongProficiencyBlockers("HeavyArmor", "BLADESONG_ARMOR_MESSAGE");
DB_GLO_Spells_BladesongWeaponBlockers((TAG)WPN_DAGGER_7490e5d0-d346-4b0e-80c6-04e977160863);
DB_GLO_Spells_BladesongWeaponBlockers((TAG)WPN_SICKLE_bfdc63bd-b8f6-4eac-9363-0c71882ff46f);
DB_GLO_Spells_BladesongWeaponBlockers((TAG)WPN_SHORTSWORD_c826fd1e-4780-43d4-b49b-87f30c060fe6);
DB_GLO_Spells_BladesongWeaponBlockers((TAG)WPN_LONGSWORD_96a99a42-ec5d-4081-9d62-c9e3f0057136);
DB_GLO_Spells_BladesongWeaponBlockers((TAG)WPN_RAPIER_aeaf4e95-38d7-45ec-8900-40bc9e6106b0);
DB_GLO_Spells_BladesongWeaponBlockers((TAG)WPN_SCIMITAR_206f9701-7b24-4eaf-9ac4-a47746c251e2);
DB_GLO_Spells_BladesongStatuses("BLADESONG_UNARMED");
DB_GLO_Spells_BladesongStatuses("BLADESONG_UNARMED_MESSAGE");
DB_GLO_Spells_BladesongStatuses("BLADESONG_ARMOR_MESSAGE");
DB_GLO_Spells_BladesongStatuses("BLADESONG_WEAPON_MESSAGE");
DB_GLO_Spells_BladesongStatuses("BLADESONG_WEAPON");
DB_GLO_Spells_BladesongStatuses("BLADESONG_SHIELD_MESSAGE");
DB_GLO_Spells_BladesongStatuses("BLADESONG_SHIELD");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8 Beta Hotfix 2")
THEN
PROC_GUSX_13442_ResetBladesong();

PROC
PROC_GUSX_13442_ResetBladesong()
AND
DB_PartOfTheTeam(_Character)
AND
IsTagged(_Character, WIZARD_BLADESINGING_bc52a699-cf55-4dad-9710-927e655910fd, 1)
THEN
DB_BUGFIX_Marker("GUSX-13442", _Character);
RemoveStatus(_Character, "BLADESONG_UNARMED", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(_Character, "BLADESONG_UNARMED_MESSAGE", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(_Character, "BLADESONG_ARMOR_MESSAGE", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(_Character, "BLADESONG_WEAPON_MESSAGE", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(_Character, "BLADESONG_WEAPON", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(_Character, "BLADESONG_SHIELD_MESSAGE", NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(_Character, "BLADESONG_SHIELD", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GUSX_13442_ResetBladesong()
AND
DB_BUGFIX_Marker("GUSX-13442", _Character)
THEN
DB_GLO_Spells_Bladesong((CHARACTER)_Character);
PROC_GLO_Spells_BladesongInitCheck((CHARACTER)_Character, "Breast");
PROC_GLO_Spells_BladesongInitCheck((CHARACTER)_Character, "Melee Main Weapon");
PROC_GLO_Spells_BladesongInitCheck((CHARACTER)_Character, "Melee Offhand Weapon");
PROC_GLO_Spells_BladesongCheckUnarmed((CHARACTER)_Character);

//END_REGION GUSX-13442

//REGION GUSX-15310

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8 Beta Hotfix 3")
AND
DB_GLO_Spells_BladesongBlockingItem(_Character, _Item, "BLADESONG_WEAPON")
THEN
DB_BUGFIX_Marker("GUSX-15310");
NOT DB_GLO_Spells_BladesongBlockingItem(_Character, _Item, "BLADESONG_WEAPON");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8 Beta Hotfix 3")
THEN
NOT DB_GLO_Spells_BladesongStatuses("BLADESONG_WEAPON");

//END_REGION GUSX-15310
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "__Start"
