Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_GlobalFlagReactionAfterDialog((FLAG)GLO_Jergal_Event_JergalGoesToCamp_aab18775-d628-42ea-914b-e72b45ee9509, (DIALOGRESOURCE)CHA_Crypt_Jergal_732520d9-a5aa-b761-84ad-429d599559a5);
DB_GlobalFlagReactionAfterDialog((FLAG)CAMP_Jergal_Event_AttackedOption_c656b8ed-38e1-a6b9-be8d-de0b16b17023, (DIALOGRESOURCE)CAMP_Jergal_7f4acd9b-15c0-81fe-9409-623634ec3ed3);

SetFlag(GLO_Jergal_State_CanResurrect_736d598a-ab47-4a25-b9e0-d5499b19fef3, NULL_00000000-0000-0000-0000-000000000000);

//Ignore any crimes and make him invulnerable.
PROC_SetInvulnerable(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 1);
PROC_CharacterDisableAllCrimes(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,1);

DB_GLO_Jergal_HasMetFlags((FLAG)CHA_Jergal_HasMet_70b87ded-1ef6-a42e-dda5-2e0659fc5cec);
DB_GLO_Jergal_HasMetFlags((FLAG)SCE_Jergal_HasMet_10c004a4-8408-66be-3e56-8e5ddb297af3);
DB_GLO_Jergal_HasMetFlags((FLAG)CAMP_Jergal_HasMet_fdba7b59-851a-3edb-fe0f-d6045c5f8dd3);

//REGION Resurrection services
// DB_GLO_Jergal_ResurrectionDialogues(_Dialog, _Price)
DB_GLO_Jergal_ResurrectionDialogues((DIALOGRESOURCE)CAMP_Jergal_7f4acd9b-15c0-81fe-9409-623634ec3ed3, 200);
DB_GLO_Jergal_ResurrectionDiscount(0);

DB_GLO_Jergal_ResurrectionStringVariableAndFlags("CAMP_Jergal_PlayerToResurrect_1_c85cdca4-6579-776d-206d-6967e4999281", (FLAG)CAMP_Jergal_State_PlayerDead_1_CanBeResurrected_ce41c909-e150-47c2-b506-32715f1b5180, (FLAG)CAMP_Jergal_State_PlayerDead_1_f7c984fb-04b3-426b-b500-4c3f9e68e33c, (FLAG)CAMP_Jergal_Event_ResurrectPlayer_1_1aa10cc1-4399-4321-8196-8cb5e1c1a0db, (FLAG)CAMP_Jergal_State_CanDismiss_Player1_96587543-6ced-41cf-b74e-6204d189915b, (FLAG)CAMP_Jergal_Event_DismissDeadPlayer1_e3686b79-fdf4-4f85-a11d-5afc0bd9fd1d);
DB_GLO_Jergal_ResurrectionStringVariableAndFlags("CAMP_Jergal_PlayerToResurrect_2_b1161c91-1bde-6a1c-297e-ee0bfc1a57c4", (FLAG)CAMP_Jergal_State_PlayerDead_2_CanBeResurrected_cc359a91-c4db-4733-a78a-2895945b120a, (FLAG)CAMP_Jergal_State_PlayerDead_2_76f91e89-8e6d-4b83-8b0d-9b3742a726fd, (FLAG)CAMP_Jergal_Event_ResurrectPlayer_2_6ab66361-6787-4160-9346-4290336dbfd3, (FLAG)CAMP_Jergal_State_CanDismiss_Player2_45879163-6c0f-45ca-96a4-795b961e3d69, (FLAG)CAMP_Jergal_Event_DismissDeadPlayer2_2bc4634a-e422-4cf1-9af1-38e5dc84985a);
DB_GLO_Jergal_ResurrectionStringVariableAndFlags("CAMP_Jergal_PlayerToResurrect_3_56966d5e-534d-4930-264e-050a2345db3d", (FLAG)CAMP_Jergal_State_PlayerDead_3_CanBeResurrected_4b50f4fd-59a3-4805-9dda-8ddf8c678e72, (FLAG)CAMP_Jergal_State_PlayerDead_3_4b707fd4-318e-43b2-8ffe-29f0dac02a72, (FLAG)CAMP_Jergal_Event_ResurrectPlayer_3_a36160e6-98ec-4477-bd2c-dffc9d96b7c2, (FLAG)CAMP_Jergal_State_CanDismiss_Player3_532098ee-6d78-495f-b1ce-8df081116e6d, (FLAG)CAMP_Jergal_Event_DismissDeadPlayer3_8a8911f2-ef56-43f9-a6ba-3021ed616988);


// Resurrecting companions who are not in the active party.
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 	(FLAG)CAMP_Jergal_State_CanResurrectAstarion_1e23fcb6-90a5-42be-8365-b27a5df03bfb, 		(FLAG)CAMP_Jergal_State_WillResurrectAstarion_ebc60261-98d7-40c8-aec8-3cf2d5a2110a);
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 		(FLAG)CAMP_Jergal_State_CanResurrectGale_d9a0568f-c0b1-43ff-844c-ad140f248b5e, 			(FLAG)CAMP_Jergal_State_WillResurrectGale_4fe9fd56-5c86-4a0d-9b5b-3471686f9ba2);
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 			(FLAG)CAMP_Jergal_State_CanResurrectHalsin_41814487-c967-43c9-a001-a3f6615de23d, 		(FLAG)CAMP_Jergal_State_WillResurrectHalsin_3895bab4-3d4b-4a89-bc11-9d3a832fe029);
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 		(FLAG)CAMP_Jergal_State_CanResurrectJaheira_2f84e5b8-b2ae-410b-8931-dc78f3511882, 		(FLAG)CAMP_Jergal_State_WillResurrectJaheira_c28fd02c-06a4-48b6-ad9a-a218711992c7);
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 		(FLAG)CAMP_Jergal_State_CanResurrectKarlach_e0f009cb-6e6d-4f4f-b097-fa418ce7b430, 		(FLAG)CAMP_Jergal_State_WillResurrectKarlach_b5b85189-fe48-4a16-99fe-e76149c62432);
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 		(FLAG)CAMP_Jergal_State_CanResurrectLaezel_5a629c4e-911e-48c2-90ab-f94983a5da75, 		(FLAG)CAMP_Jergal_State_WillResurrectLaezel_62822cd8-3ecc-48f2-b9c9-04e00329fde4);
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, 		(FLAG)CAMP_Jergal_State_CanResurrectMinsc_f18139b2-0e0d-4fb4-b766-dd52808adc4d, 		(FLAG)CAMP_Jergal_State_WillResurrectMinsc_410287d3-f29b-4b7b-8f8f-0309f566f39a);
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 	(FLAG)CAMP_Jergal_State_CanResurrectMinthara_00f8006f-70d7-478d-8d3e-0f10ea9fb758, 		(FLAG)CAMP_Jergal_State_WillResurrectMinthara_d0d36d66-e2e5-417c-aa72-f62020f8c8d0);
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 	(FLAG)CAMP_Jergal_State_CanResurrectShadowheart_99d4fea1-9522-4eaa-a791-77213b1745ab, 	(FLAG)CAMP_Jergal_State_WillResurrectShadowheart_382bd554-7e94-4f22-a76d-cb43e430e94e);
DB_GLO_Jergal_CompanionResurrectionFlags((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 		(FLAG)CAMP_Jergal_State_CanResurrectWyll_ea496c74-0060-47ab-836e-8173388d48f6, 			(FLAG)CAMP_Jergal_State_WillResurrectWyll_f186ab7b-5468-4220-b7d0-9ce9c0722807);

DB_GLO_Jergal_HirelingResurrectionFlags("CAMP_Jergal_HirelingToResurrect_1_fa2171f8-8d13-5557-8df8-a7d8dd053dd9", (FLAG)CAMP_Jergal_State_CanResurrect_Hireling1_508a35fd-7026-49f6-bf2b-f70c3f70718d, (FLAG)CAMP_Jergal_State_WillResurrect_Hireling1_0c19f5fc-9b85-4208-bce4-43a48274cf84);
DB_GLO_Jergal_HirelingResurrectionFlags("CAMP_Jergal_HirelingToResurrect_2_d2808a7c-b7db-96a3-1c5f-e050b22a592b", (FLAG)CAMP_Jergal_State_CanResurrect_Hireling2_233ba52e-8ff6-4316-9db3-2492f21d1dcd, (FLAG)CAMP_Jergal_State_WillResurrect_Hireling2_bccda46b-6a29-46e0-9c6c-14affc26df6b);
DB_GLO_Jergal_HirelingResurrectionFlags("CAMP_Jergal_HirelingToResurrect_3_ba49d24f-75ee-10b0-57e1-b5fb5ee977bb", (FLAG)CAMP_Jergal_State_CanResurrect_Hireling3_b77e8111-b02f-4aa5-8b95-1fe2cd4b33c4, (FLAG)CAMP_Jergal_State_WillResurrect_Hireling3_a42958bf-5b9f-4bc1-8d11-f5cff3ece56d);

DB_GLO_Jergal_DismissedAvatarResurrectionFlags("CAMP_Jergal_DismissedAvatarToResurrect_1_539f07ee-87de-e8eb-9bac-ad94453a5cec", (FLAG)CAMP_Jergal_State_CanResurrect_DismissedAvatar1_59e0f109-ebdb-c096-feb0-191cb26bb134, (FLAG)CAMP_Jergal_Event_WillResurrect_DismissedAvatar1_e5ab9c33-4593-5d43-3889-2900cb57b11c);
DB_GLO_Jergal_DismissedAvatarResurrectionFlags("CAMP_Jergal_DismissedAvatarToResurrect_2_ab7994b8-7f12-6bf1-0c9b-d8ed4d3432ac", (FLAG)CAMP_Jergal_State_CanResurrect_DismissedAvatar2_09e7f4be-dda6-3c6c-116d-eb61aad7dfb0, (FLAG)CAMP_Jergal_Event_WillResurrect_DismissedAvatar2_3f7c3257-4d47-52fb-b526-41b6231a948b);
DB_GLO_Jergal_DismissedAvatarResurrectionFlags("CAMP_Jergal_DismissedAvatarToResurrect_3_78fa02c7-a3d4-4101-e2de-a5bd18d187fd", (FLAG)CAMP_Jergal_State_CanResurrect_DismissedAvatar3_414f6b9c-fe03-df96-3406-e38998cb97f3, (FLAG)CAMP_Jergal_Event_WillResurrect_DismissedAvatar3_73448a6b-1e44-0bde-36a3-fa40bc35acc4);
//END_REGION

//REGION Camp Data
DB_OriginCampFlags((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, (FLAG)JERGAL_22380f91-e71d-45d9-b4b4-99ff13645af0, (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_ORI_OriginCampData((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "WLDMAIN", (TRIGGER)S_CAMP_JergalDayPos_1a7f4258-1a12-4c0f-b05c-53571ecf3ec0);
DB_ORI_OriginCampData((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "WLDCAVGRN", (TRIGGER)S_CAMP_WLDCAVGRN_Priest_6b516945-9ce0-4874-bec1-8cc64b8334a9);
DB_ORI_OriginCampData((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "WLDCAVSND", (TRIGGER)S_CAMP_WLDCAVSND_Priest_138a6fa8-4654-47fd-b1ea-4b3cae21c4c5);
DB_ORI_OriginCampData((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "WLDDUNABB", (TRIGGER)S_CAMP_WLDDUNABB_Priest_1efcf77c-eafd-4895-9026-36a14aae6e1d);
DB_ORI_OriginCampData((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "WLDDUNSHA", (TRIGGER)S_CAMP_WLDDUNSHA_Priest_8dad37c7-c5aa-4095-9d18-32c19da604f7);
DB_ORI_OriginCampData((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "WLDUND", (TRIGGER)S_CAMP_WLDUND_Priest_e09ddb5c-dcc4-4494-86b3-392f1666a1b8);
DB_ORI_OriginCampData((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "WLDBAS", (TRIGGER)S_CAMP_WLDBAS_Priest_a9e6929b-fc6d-4484-bd46-c347f4709617);

//END_REGION

//Force Withers to camp
DB_GLO_Jergal_ForceToCampInLevel("CRE_Main_A");
DB_GLO_Jergal_ForceToCampInLevel("SCL_Main_A");
DB_GLO_Jergal_ForceToCampInLevel("BGO_Main_A");
DB_GLO_Jergal_ForceToCampInLevel("INT_Main_A");
DB_GLO_Jergal_ForceToCampInLevel("CTY_Main_A");
KBSECTION
//REGION Hooks
IF
TextEvent("CAMP_JergalToCamp")
THEN
PROC_GLO_Jergal_MoveToCamp();
PROC_GLO_Jergal_Appear();

IF
TextEvent("fullcamp")
THEN
PROC_GLO_Jergal_MoveToCamp();
PROC_GLO_Jergal_Appear();

IF
TextEvent("JergalRes")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,_Player);
PROC_GLO_Jergal_SetDeadPlayers();
DB_Debug_InJergalRes(1);
PROC_GLO_Jergal_PrepareAllPlayersResurrection();
NOT DB_Debug_InJergalRes(1);
PROC_GLO_Jergal_ResurrectPlayers();

QRY
QRY_GLO_Jergal_BlockResurrection(_Player)
AND
DB_Debug_InJergalRes(1)
THEN
DB_Noop(1);

IF
EntityEvent((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"DebugTeleportedToCamp")
THEN
PROC_GLO_Jergal_MoveToCamp();
PROC_GLO_Jergal_Appear();
//END_REGION

//REGION Jergal is thrown into a chasm
IF
EnteredChasm(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _, _, _, _, _)
THEN
PROC_GLO_Jergal_MoveToCamp();
PROC_GLO_Jergal_Appear();
PROC_TeleportSmoke(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
//END_REGION

//REGION Backup plan if player skipped Jergal
IF
DB_CurrentLevel("WLD_Main_A")
THEN
PROC_TriggerRegisterForPlayers(S_GOB_JergalAppear_BackupZone_13961b54-9126-4dea-abe0-175e66afba66);

IF
DB_GlobalFlag(GLO_Jergal_State_JergalAtCamp_1d7473f8-8651-4077-935e-ecafd78c945a)
THEN
DB_GLO_JergalCameToCamp(1);

IF
EnteredTrigger(_Player,S_GOB_JergalAppear_BackupZone_13961b54-9126-4dea-abe0-175e66afba66)
AND
DB_Players(_Player)
AND
NOT DB_GLO_JergalCameToCamp(1)
THEN
PROC_TriggerUnregisterForPlayers(S_GOB_JergalAppear_BackupZone_13961b54-9126-4dea-abe0-175e66afba66);
PROC_GLO_Jergal_MoveToCamp();
PROC_GLO_Jergal_Appear();
//END_REGION Backup plan if player skipped Jergal GUS-270670

//REGION Relation management
// Keep Jergal neutral
IF
RelationChanged(GLO_Jergal_bc9d422f-04a9-4338-93e5-1da13fda1407, Hero_a1542c81-6895-929e-4522-10ce218bb360, _, _)
THEN
PROC_SetRelationToPlayers(GLO_Jergal_bc9d422f-04a9-4338-93e5-1da13fda1407, 50);
//END_REGION

//REGION Blocking attack button during his dialogues
// Always block him from becoming hostile and stop his dialog.
QRY
QRY_DialogAttackRequested_CustomResponse(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _)
THEN
SetFlag(CHA_Jergal_Event_AttemptedAttack_c2fc2844-dfe7-4eb2-6ab6-301eea35fe4e, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
PROC_TryStopDialogFor(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);

QRY
QRY_DialogAttackRequested_CustomResponse(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _)
AND
DB_GLO_Jergal_PlayAttackADAfterDialog(_PrevDialogID)
THEN
NOT DB_GLO_Jergal_PlayAttackADAfterDialog(_PrevDialogID);

QRY
QRY_DialogAttackRequested_CustomResponse(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _)
AND
DB_DialogNPCs(_DialogID, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _)
AND
NOT DB_GLO_Jergal_BlockAttackedADDuringResurrection(1)
THEN
DB_GLO_Jergal_PlayAttackADAfterDialog(_DialogID);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CAMP_Jergal_Event_AttackedOption_c656b8ed-38e1-a6b9-be8d-de0b16b17023)
THEN
ClearFlag((FLAG)CAMP_Jergal_Event_AttackedOption_c656b8ed-38e1-a6b9-be8d-de0b16b17023, NULL_00000000-0000-0000-0000-000000000000);
PROC_TryStartAD(GLO_Jergal_AD_AttackFromDialog_851c058a-3223-3930-05aa-8558a0e36b04, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);

IF
DialogEnded(_, _DialogID)
AND
DB_GLO_Jergal_PlayAttackADAfterDialog(_DialogID)
THEN
NOT DB_GLO_Jergal_PlayAttackADAfterDialog(_DialogID);
PROC_TryStartAD(GLO_Jergal_AD_AttackFromDialog_851c058a-3223-3930-05aa-8558a0e36b04, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);

// Setting CHA_Jergal_Event_AttemptedAttack is usually used to pause behaviour. Remove it so he continues behaving as normal.
PROC
PROC_GLO_Jergal_RemoveAttackedFlagTimer((INTEGER)_Milliseconds)
THEN
ObjectTimerCancel(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "GLO_Jergal_RemovedAttackedTag");
ObjectTimerLaunch(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "GLO_Jergal_RemovedAttackedTag", _Milliseconds);

IF
ObjectTimerFinished(_, "GLO_Jergal_RemovedAttackedTag")
THEN
ClearFlag(CHA_Jergal_Event_AttemptedAttack_c2fc2844-dfe7-4eb2-6ab6-301eea35fe4e, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
//END_REGION

//REGION Camp management
PROC
PROC_GLO_Jergal_SetDialog((DIALOGRESOURCE)_Dialog)
AND
NOT QRY_GLO_Jergal_BlockSettingDialog()
THEN
PROC_RemoveDialog(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
DB_Dialogs(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _Dialog);

QRY
QRY_GLO_Jergal_BlockSettingDialog()
AND
0 == 1
THEN
DB_NOOP(1);

// Teleport Jergal to the camp when players also go there
PROC
PROC_GlobalFlagReactionAfterDialog(GLO_Jergal_Event_JergalGoesToCamp_aab18775-d628-42ea-914b-e72b45ee9509)
THEN
PROC_DisappearOutOfSight(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "Walk", 0, "GLO_Jergal_GoesToCamp");

IF
EntityEvent(_Jergal, "GLO_Jergal_GoesToCamp")
AND
NOT DB_InCamp((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805)
THEN
PROC_GLO_Jergal_MoveToCamp();
PROC_ORI_SetupCamp((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,0);

PROC
PROC_GLO_Jergal_MoveToCamp()
THEN
DB_CHA_Crypt_JergalLeftTomb(1);
PROC_Poof(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
PROC_DismissToCamp((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
DB_PartOfTheTeam((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
ClearFlag(GLO_Jergal_State_OutOfTomb_55294438-06e2-467c-9873-757f74d20645, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GLO_Jergal_Event_JergalGoesToCamp_aab18775-d628-42ea-914b-e72b45ee9509, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(GLO_Jergal_State_JergalAtCamp_1d7473f8-8651-4077-935e-ecafd78c945a, NULL_00000000-0000-0000-0000-000000000000);

IF
EntityEvent(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "Origin_RestoreDialog")
THEN
PROC_Foop(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
SetTag(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b);
PROC_GLO_Jergal_SetDialog((DIALOGRESOURCE)CAMP_Jergal_7f4acd9b-15c0-81fe-9409-623634ec3ed3);

// Wait for one night before appearing
PROC
PROC_LongRest()
AND
DB_GlobalFlag(GLO_Jergal_State_JergalAtCamp_1d7473f8-8651-4077-935e-ecafd78c945a)
AND
NOT DB_OnlyOnce("GLO_Jergal_WaitForOneNight") // Let's avoid calling a QRY each time that players long rest.
THEN
DB_OnlyOnce("GLO_Jergal_WaitForOneNight");
DB_OnlyOnce("GLO_Jergal_AppearAfterChasmDeath"); 
PROC_GLO_Jergal_Appear();

PROC
PROC_GLO_Jergal_Appear()
THEN
// Make sure Jergal is visible
SetFlag(GLO_Jergal_State_JergalVisibleAtCamp_617fe345-b808-4e68-b970-14039e21bdcd, NULL_00000000-0000-0000-0000-000000000000);
SetOnStage(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 1);
SetVisible(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 1);
SetDetached(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 0);

IF
DB_CurrentLevel(_Level)
AND
DB_GLO_Jergal_ForceToCampInLevel(_Level)
AND
DB_ActiveCamp(_)
AND
NOT DB_InCamp((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805)
THEN
PROC_GLO_Jergal_MoveToCamp();
PROC_GLO_Jergal_Appear();

IF
DB_InCamp((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805)
AND
DB_GLO_Jergal_ForceToCampInLevel((STRING)_Level)
THEN
NOT DB_GLO_Jergal_ForceToCampInLevel(_Level);

//END_REGION

//REGION Attack reactions
IF
AttackedBy(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _AttackerOwner, _Attacker, _, _, _, _)
AND
QRY_GetCharacterOwnerIfItemSummon(_AttackerOwner,_Attacker)
AND
DB_QRYRTN_GetCharacterOwnerIfItemSummon(_Player)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GLO_Jergal_ReactsToAttack")
THEN
PROC_TryStartAD(GLO_Jergal_AD_AttackedByPlayer_7686b4ed-307e-6843-e9b8-2c4343bd071c, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
TimerLaunch("GLO_Jergal_BlockAD", 6000);

IF
TimerFinished("GLO_Jergal_BlockAD")
THEN
NOT DB_OnlyOnce("GLO_Jergal_ReactsToAttack");

// Fallback in case for any reason Jergal is not at the camp when he should be
PROC
PROC_LongRest()
AND
NOT DB_InCamp(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805)
AND
DB_GlobalFlag(GLO_Jergal_State_JergalVisibleAtCamp_617fe345-b808-4e68-b970-14039e21bdcd)
THEN
PROC_DismissToCamp((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
DB_PartOfTheTeam((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);

IF
FlagCleared(CAMP_GLO_State_InCamp_161b7223-039d-4ebe-986f-1dcd9a66733f, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, _)
THEN
ClearFlag(GLO_Jergal_State_JergalVisibleAtCamp_617fe345-b808-4e68-b970-14039e21bdcd, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GLO_Jergal_State_JergalAtCamp_1d7473f8-8651-4077-935e-ecafd78c945a, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION Resurrection services
IF
FlagSet((FLAG)CAMP_Jergal_AskedAboutServices_0c357de7-be76-702d-36bc-e582ba10e4d8, _, _)
THEN
SetFlag((FLAG)CAMP_Jergal_State_ResurrectionServicesUnlocked_d115836f-1a9a-4361-841c-abc3f1c41021, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GLO_Jergal_ResurrectionDialogues(_Dialog, _Price)
THEN
PROC_GLO_Jergal_SetResurrectionPrice(_Price, _Dialog);
DB_DialogMoneyTransfer(2, (DIALOGRESOURCE)_Dialog, 0); // 1 = price for resurrecting one character. 2 = price for resurrecting multiple characters (see PROC_GLO_Jergal_SetDialogVariables)
DB_GlobalFlagReactionAfterDialog((FLAG)CAMP_Jergal_Event_ResurrectPlayer_1_1aa10cc1-4399-4321-8196-8cb5e1c1a0db, _Dialog);
DB_GlobalFlagReactionAfterDialog((FLAG)CAMP_Jergal_Event_ResurrectPlayer_2_6ab66361-6787-4160-9346-4290336dbfd3, _Dialog);
DB_GlobalFlagReactionAfterDialog((FLAG)CAMP_Jergal_Event_ResurrectPlayer_3_a36160e6-98ec-4477-bd2c-dffc9d96b7c2, _Dialog);
DB_GlobalFlagReactionAfterDialog((FLAG)CAMP_Jergal_Event_ResurrectAllDead_bcae756b-bd2a-47d0-8ab8-95c5e43cba03, _Dialog);

IF
DB_GLO_Jergal_CompanionResurrectionFlags(_, _, _WillResurrectFlag)
AND
DB_GLO_Jergal_ResurrectionDialogues(_Dialog, _)
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)_WillResurrectFlag, _Dialog);
DB_GlobalFlagReactionAfterDialog((FLAG)_WillResurrectFlag, _Dialog);

IF
DB_GLO_Jergal_HirelingResurrectionFlags(_, _, _WillResurrectFlag)
AND
DB_GLO_Jergal_ResurrectionDialogues(_Dialog, _)
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)_WillResurrectFlag, _Dialog);
DB_GlobalFlagReactionAfterDialog((FLAG)_WillResurrectFlag, _Dialog);

IF
DB_GLO_Jergal_DismissedAvatarResurrectionFlags(_, _, _WillResurrectFlag)
AND
DB_GLO_Jergal_ResurrectionDialogues(_Dialog, _)
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)_WillResurrectFlag, _Dialog);
DB_GlobalFlagReactionAfterDialog((FLAG)_WillResurrectFlag, _Dialog);

// Resurrected characters will follow the player that resurrects them when leaving the camp.
// That way if they die in a bad place (for example standing on lava) they won't go back to the same spot.
IF
DialogStarted(_Dialog, _ID)
AND
DB_GLO_Jergal_ResurrectionDialogues(_Dialog, _)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_GLO_Jergal_SaveReturnPosition((CHARACTER)_Player);

IF
DialogStarted(_Dialog, _ID)
AND
DB_GLO_Jergal_ResurrectionDialogues(_Dialog, _)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_GLO_Jergal_SetPlayerResurrectingOthers((CHARACTER)_Player);

PROC
PROC_GLO_Jergal_SetPlayerResurrectingOthers((CHARACTER)_Player)
AND
DB_GLO_Jergal_ResurrectedBy(_PrevPlayer)
THEN
NOT DB_GLO_Jergal_ResurrectedBy(_PrevPlayer);

// Being resurrected by an avatar.
PROC
PROC_GLO_Jergal_SetPlayerResurrectingOthers((CHARACTER)_Player)
AND
DB_Avatars(_Player)
THEN
DB_GLO_Jergal_ResurrectedBy(_Player);

// Being resurrected by a companion/hireling.
PROC
PROC_GLO_Jergal_SetPlayerResurrectingOthers((CHARACTER)_Player)
AND
NOT DB_GLO_Jergal_ResurrectedBy(_)
AND
NOT DB_Avatars(_Player)
AND
GetReservedUserID(_Player, _UserID1)
AND
DB_Avatars(_Avatar)
AND
NOT DB_GLO_Jergal_ResurrectedBy(_) // Mostly to avoid extra engine queries, works as DB_OnlyOnce if an avatar is found
AND
GetReservedUserID(_Avatar, _UserID2)
AND
_UserID1 == _UserID2
THEN
DB_GLO_Jergal_ResurrectedBy(_Avatar);

// If somehow none is found use the host
PROC
PROC_GLO_Jergal_SetPlayerResurrectingOthers((CHARACTER)_Player)
AND
NOT DB_GLO_Jergal_ResurrectedBy(_)
AND
GetHostCharacter(_Player)
THEN
DB_GLO_Jergal_ResurrectedBy(_Player);

PROC
PROC_GLO_Jergal_SaveReturnPosition((CHARACTER)_Player)
AND
DB_GLO_Jergal_ReturnPosition(_Player,_OldX, _OldY, _OldZ)
THEN
NOT DB_GLO_Jergal_ReturnPosition(_Player,_OldX, _OldY, _OldZ);

PROC
PROC_GLO_Jergal_SaveReturnPosition((CHARACTER)_Player)
AND
DB_LeaveCamp_ReturnPos((CHARACTER)_Player, _NewX, _NewY, _NewZ)
THEN
DB_GLO_Jergal_ReturnPosition(_Player,_NewX, _NewY, _NewZ);

PROC
PROC_GLO_Jergal_SetResurrectionPrice((INTEGER)_Price, (DIALOGRESOURCE)_Dialog)
AND
DB_DialogMoneyTransfer(1, _Dialog, _PrevPrice)
THEN
NOT DB_DialogMoneyTransfer(1, _Dialog, _PrevPrice);

PROC
PROC_GLO_Jergal_SetResurrectionPrice((INTEGER)_Price, (DIALOGRESOURCE)_Dialog)
THEN
DB_DialogMoneyTransfer(1, _Dialog, _Price);

PROC
PROC_DialogFlagSetup(_Dialog, _, _)
AND
DB_GLO_Jergal_ResurrectionDialogues(_Dialog, _)
THEN
PROC_GLO_Jergal_SetDeadPlayers();
PROC_GLO_Jergal_SetDialogVariables(_Dialog);

// Clear flags

PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_GLO_Jergal_ResurrectionStringVariableAndFlags(_, _CanBeResurrectedFlag, _PlayerDeadFlag, _ResurrectFlag, _CanDismissFlag, _DismissedFlag)
THEN
PROC_GlobalClearFlagAndCache(_CanBeResurrectedFlag);
PROC_GlobalClearFlagAndCache(_PlayerDeadFlag);
PROC_GlobalClearFlagAndCache(_ResurrectFlag);
PROC_GlobalClearFlagAndCache(_CanDismissFlag);
PROC_GlobalClearFlagAndCache(_DismissedFlag);

PROC
PROC_GLO_Jergal_SetDeadPlayers()
THEN
PROC_GlobalClearFlagAndCache(CAMP_Jergal_State_PartyMemberDead_9e29c6e8-d087-4235-9930-43e104277e29);
PROC_GlobalClearFlagAndCache(CAMP_Jergal_State_CanResurrectCompanion_d7c06056-eadd-4d9d-96c7-72fe63fa6498);
PROC_GlobalClearFlagAndCache(CAMP_Jergal_State_MoreThanOnePCDead_a4df19dd-d25b-4ee7-8a4c-2cd408f1bea2);
PROC_GlobalClearFlagAndCache(CAMP_Jergal_Event_ResurrectAllDead_bcae756b-bd2a-47d0-8ab8-95c5e43cba03);
PROC_GlobalClearFlagAndCache(CAMP_Jergal_State_CanDismissAPlayer_2bc77ddd-2f03-45f1-b710-19062535227c);

PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_GLO_Jergal_CompanionResurrectionFlags(_, _CanResurrectFlag, _WillResurrectFlag)
THEN
PROC_GlobalClearFlagAndCache(_CanResurrectFlag);
PROC_GlobalClearFlagAndCache(_WillResurrectFlag);

PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_GLO_Jergal_HirelingResurrectionFlags(_, _CanResurrectFlag, _WillResurrectFlag)
THEN
PROC_GlobalClearFlagAndCache(_CanResurrectFlag);
PROC_GlobalClearFlagAndCache(_WillResurrectFlag);

PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags(_, _CanResurrectFlag, _WillResurrectFlag)
THEN
PROC_GlobalClearFlagAndCache(_CanResurrectFlag);
PROC_GlobalClearFlagAndCache(_WillResurrectFlag);

// Clear previous dead players
PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_GLO_Jergal_DeadPlayers(_Player, _Variable, _ResurrectFlag, _DismissFlag)
THEN
NOT DB_GLO_Jergal_DeadPlayers(_Player, _Variable, _ResurrectFlag, _DismissFlag);

PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_GLO_Jergal_HirelingResurrectionFlags_Dead(_DialogVariable, _Hireling)
THEN
NOT DB_GLO_Jergal_HirelingResurrectionFlags_Dead(_DialogVariable, _Hireling);

PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags_Dead(_DialogVariable, _Hireling)
THEN
NOT DB_GLO_Jergal_DismissedAvatarResurrectionFlags_Dead(_DialogVariable, _Hireling);

// Get new dead players
// Characters in party
PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_Players(_Player)
AND
DB_Dead(_Player)
AND
NOT DB_CAMP_Jergal_PlayersToResurrect(_Player)
AND
NOT QRY_GLO_Jergal_BlockResurrection(_Player)
AND
DB_GLO_Jergal_ResurrectionStringVariableAndFlags(_Variable, _CanBeResurrectedFlag, _DeadFlag, _ResurrectFlag, _, _DismissFlag)
AND
NOT DB_GLO_Jergal_DeadPlayers(_Player, _, _, _)
AND
NOT DB_GLO_Jergal_DeadPlayers(_, _Variable, _, _) // Nor player and dialog variable are in the DB
THEN
DB_GLO_Jergal_DeadPlayers(_Player, _Variable, _ResurrectFlag, _DismissFlag);
SetFlag(_DeadFlag, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(_CanBeResurrectedFlag, NULL_00000000-0000-0000-0000-000000000000);
SetFlag((FLAG)CAMP_Jergal_State_PartyMemberDead_9e29c6e8-d087-4235-9930-43e104277e29, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GLO_Jergal_DeadPlayers(_Player, _Variable, _, _)
AND
DB_GLO_Jergal_ResurrectionStringVariableAndFlags(_Variable, _, _, _, _CanDismiss, _)
AND
NOT DB_Avatars(_Player)
THEN
SetFlag(_CanDismiss, NULL_00000000-0000-0000-0000-000000000000);
SetFlag((FLAG)CAMP_Jergal_State_CanDismissAPlayer_2bc77ddd-2f03-45f1-b710-19062535227c, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GLO_Jergal_DeadPlayers(_Player, _Variable, _, _)
AND
DB_GLO_Jergal_ResurrectionStringVariableAndFlags(_Variable, _, _, _, _CanDismiss, _)
AND
DB_Avatars(_Player)
AND
QRY_GLO_AvatarCanBeDismissed(_Player)
THEN
SetFlag(_CanDismiss, NULL_00000000-0000-0000-0000-000000000000);
SetFlag((FLAG)CAMP_Jergal_State_CanDismissAPlayer_2bc77ddd-2f03-45f1-b710-19062535227c, NULL_00000000-0000-0000-0000-000000000000);

// Characters not party - origins
PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_Origins(_Origin)
AND
NOT DB_DismissedAvatar(_Origin)
AND
DB_PartOfTheTeam(_Origin)
AND
NOT DB_Players(_Origin)
AND
DB_Dead(_Origin)
AND
NOT DB_CAMP_Jergal_PlayersToResurrect(_Origin)
AND
NOT QRY_GLO_Jergal_BlockResurrection(_Origin)
AND
DB_GLO_Jergal_CompanionResurrectionFlags(_Origin, _CanResurrectFlag, _)
THEN
SetFlag(_CanResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);
SetFlag((FLAG)CAMP_Jergal_State_CanResurrectCompanion_d7c06056-eadd-4d9d-96c7-72fe63fa6498, NULL_00000000-0000-0000-0000-000000000000);

// Characters not party - hirelings not in party
PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_Hirelings_CampPos(_Hireling, _)
AND
DB_PartOfTheTeam(_Hireling)
AND
NOT DB_Players(_Hireling)
AND
DB_Dead(_Hireling)
AND
NOT DB_CAMP_Jergal_PlayersToResurrect(_Hireling)
AND
NOT QRY_GLO_Jergal_BlockResurrection(_Hireling)
AND
DB_GLO_Jergal_HirelingResurrectionFlags(_DialogVariable, _CanResurrectFlag, _)
AND
NOT DB_GLO_Jergal_HirelingResurrectionFlags_Dead(_, _Hireling)
AND
NOT DB_GLO_Jergal_HirelingResurrectionFlags_Dead(_DialogVariable, _)
THEN
SetFlag(_CanResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);
SetFlag((FLAG)CAMP_Jergal_State_CanResurrectCompanion_d7c06056-eadd-4d9d-96c7-72fe63fa6498, NULL_00000000-0000-0000-0000-000000000000);
DB_GLO_Jergal_HirelingResurrectionFlags_Dead(_DialogVariable, _Hireling);

// Characters not party - dismissed avatars
PROC
PROC_GLO_Jergal_SetDeadPlayers()
AND
DB_DismissedAvatar(_Avatar)
AND
DB_Dead(_Avatar)
AND
NOT DB_CAMP_Jergal_PlayersToResurrect(_Avatar)
AND
NOT QRY_GLO_Jergal_BlockResurrection(_Avatar)
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags(_DialogVariable, _CanResurrectFlag, _)
AND
NOT DB_GLO_Jergal_DismissedAvatarResurrectionFlags_Dead(_, _Avatar)
AND
NOT DB_GLO_Jergal_DismissedAvatarResurrectionFlags_Dead(_DialogVariable, _)
THEN
SetFlag(_CanResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);
SetFlag((FLAG)CAMP_Jergal_State_CanResurrectCompanion_d7c06056-eadd-4d9d-96c7-72fe63fa6498, NULL_00000000-0000-0000-0000-000000000000);
DB_GLO_Jergal_DismissedAvatarResurrectionFlags_Dead(_DialogVariable, _Avatar);

// Get batch resurrection price for current dead players - only characters in active party
PROC
PROC_GLO_Jergal_SetDialogVariables((DIALOGRESOURCE)_Dialog)
AND
QRY_OnlyOnce_Reset("GLO_Jergal_ApplyDiscount")
AND
DB_GLO_Jergal_DeadPlayers(_, _, _, _)
AND
QRY_OnlyOnce("GLO_Jergal_ApplyDiscount")
AND
SysCount("DB_GLO_Jergal_DeadPlayers", 4, _Count)
AND
_Count > 1
AND
DB_DialogMoneyTransfer(1, _Dialog, _Price)
AND
IntegerProduct(_Count, _Price, _TotalPrice)
AND
DB_GLO_Jergal_ResurrectionDiscount(_Discount)
AND
IntegerSubtract(100, _Discount, _InvDiscount)
AND
IntegerProduct(_InvDiscount, _TotalPrice, _ProductPrice)
AND
IntegerDivide(_ProductPrice, 100, _DiscountedPrice)
AND
DB_DialogMoneyTransfer(2, _Dialog, _PrevResPrice)
THEN
NOT DB_DialogMoneyTransfer(2, _Dialog, _PrevResPrice); // Clear previous batch resurrection price
SetFlag(CAMP_Jergal_State_MoreThanOnePCDead_a4df19dd-d25b-4ee7-8a4c-2cd408f1bea2, NULL_00000000-0000-0000-0000-000000000000);
DB_DialogMoneyTransfer(2, _Dialog, _DiscountedPrice);

// If dialog is in progress force-update
PROC
PROC_GLO_Jergal_SetDialogVariables((DIALOGRESOURCE)_Dialog)
AND
DB_DialogName(_Dialog, _Instance)
THEN
PROC_SetDialogGoldCheckAmount(_Dialog, _Instance);

// Set dialog names variables - party members
PROC
PROC_GLO_Jergal_SetDialogVariables((DIALOGRESOURCE)_Dialog)
AND
DB_GLO_Jergal_DeadPlayers(_Player, _Variable, _, _)
AND
GetDisplayName(_Player, _TranslatedStringKey)
THEN
DialogSetVariableTranslatedString(_Dialog, _Variable, _TranslatedStringKey);

// Set dialog names variables - non-party members
PROC
PROC_GLO_Jergal_SetDialogVariables((DIALOGRESOURCE)_Dialog)
AND
DB_GLO_Jergal_HirelingResurrectionFlags_Dead(_DialogVariable, _Hireling)
AND
GetDisplayName(_Hireling, _TranslatedStringKey)
THEN
DialogSetVariableTranslatedString(_Dialog, _DialogVariable, _TranslatedStringKey);

// Set dialog names variables - dismissed avatars
PROC
PROC_GLO_Jergal_SetDialogVariables((DIALOGRESOURCE)_Dialog)
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags_Dead(_DialogVariable, _Avatar)
AND
GetDisplayName(_Avatar, _TranslatedStringKey)
THEN
DialogSetVariableTranslatedString(_Dialog, _DialogVariable, _TranslatedStringKey);

// Get if we have to resurrect one PC
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)_Flag)
AND
DB_GLO_Jergal_DeadPlayers(_, _, _Flag, _)
THEN
PROC_GLO_Jergal_PreparePlayerResurrection(_Flag);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)_Flag)
AND
DB_GLO_Jergal_CompanionResurrectionFlags(_, _, _Flag)
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GLO_Jergal_PreparePlayerResurrection(_Flag); // For characters not in party

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)_Flag)
AND
DB_GLO_Jergal_HirelingResurrectionFlags(_, _, _Flag)
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GLO_Jergal_PreparePlayerResurrection(_Flag); // For hirelings not in party

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)_Flag)
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags(_, _, _Flag)
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GLO_Jergal_PreparePlayerResurrection(_Flag); // For hirelings not in party

// Add PC to the resurrection DB
PROC
PROC_GLO_Jergal_PreparePlayerResurrection((FLAG)_Flag)
THEN
DB_GLO_Jergal_BlockAttackedADDuringResurrection(1);
PROC_GLO_Jergal_PreparePlayerResurrection_Internal(_Flag);

// Try start the dialog, if it fails resurrect the dead PC
PROC
PROC_GLO_Jergal_PreparePlayerResurrection((FLAG)_Flag)
AND
NOT QRY_StartDialog_Fixed(CAMP_Jergal_AD_PlayerResurrection_820a252c-013f-4531-7292-777db8e0c2fd, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805)
THEN
PROC_GLO_Jergal_ResurrectPlayers();

// Get if we have to resurrect all PCs
PROC
PROC_GlobalFlagReactionAfterDialog(CAMP_Jergal_Event_ResurrectAllDead_bcae756b-bd2a-47d0-8ab8-95c5e43cba03)
THEN
DB_GLO_Jergal_BlockAttackedADDuringResurrection(1);
PROC_GLO_Jergal_PrepareAllPlayersResurrection();

// Add all of them to the resurrection DB
PROC
PROC_GLO_Jergal_PrepareAllPlayersResurrection()
AND
DB_GLO_Jergal_DeadPlayers(_, _, _Flag, _)
THEN
PROC_GLO_Jergal_PreparePlayerResurrection_Internal(_Flag);

// Try start the dialog, if it fails resurrect the dead PCs
PROC
PROC_GLO_Jergal_PrepareAllPlayersResurrection()
AND
NOT QRY_StartDialog_Fixed(CAMP_Jergal_AD_PlayerResurrection_820a252c-013f-4531-7292-777db8e0c2fd, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805)
THEN
PROC_GLO_Jergal_ResurrectPlayers();

PROC
PROC_GLO_Jergal_PreparePlayerResurrection_Internal((FLAG)_Flag)
AND
DB_GLO_Jergal_DeadPlayers(_Player, _, _Flag, _)
THEN
PROC_GLO_Jergal_WillResurrect(_Player);

PROC
PROC_GLO_Jergal_PreparePlayerResurrection_Internal((FLAG)_Flag)
AND
DB_GLO_Jergal_HirelingResurrectionFlags(_DialogVariable, _, _Flag)
AND
DB_GLO_Jergal_HirelingResurrectionFlags_Dead(_DialogVariable, _Hireling)
THEN
PROC_GLO_Jergal_WillResurrect(_Hireling);

PROC
PROC_GLO_Jergal_PreparePlayerResurrection_Internal((FLAG)_Flag)
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags(_DialogVariable, _, _Flag)
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags_Dead(_DialogVariable, _Avatar)
THEN
PROC_GLO_Jergal_WillResurrect(_Avatar);

PROC
PROC_GLO_Jergal_PreparePlayerResurrection_Internal((FLAG)_Flag)
AND
DB_GLO_Jergal_CompanionResurrectionFlags(_Companion, _, _Flag)
THEN
PROC_GLO_Jergal_WillResurrect(_Companion);

PROC
PROC_GLO_Jergal_WillResurrect((CHARACTER)_Char)
THEN
DB_CAMP_Jergal_PlayersToResurrect(_Char);
DB_Camp_BlockCamperPosAdjustment(_Char);

IF
AutomatedDialogStarted(CAMP_Jergal_AD_PlayerResurrection_820a252c-013f-4531-7292-777db8e0c2fd, _)
THEN
SetHasDialog(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 0);
PROC_LoopEffect(VFX_Spells_Prepare_Arcane_Intent_Healing_Agressive_ChestFX_01_825de78f-b903-0f40-e31c-c51bfb12b8eb,S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_01","__ANY__","Dummy_BodyFX");
PROC_LoopEffect(VFX_Enemies_Withers_Healing_Agressive_Prepare_ChestFX_Textkey_01_a8473667-573d-ac3c-0252-658f0d28ddb0,S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_02","__ANY__","Dummy_BodyFX");
PROC_LoopEffect(VFX_Spells_Prepare_Arcane_Intent_Healing_Agressive_Root_Textkey_01_4bf9fd37-744c-8ed9-5c0f-a156d3e7292e,S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_03","__ANY__","");
PROC_LoopEffect(VFX_Spells_Prepare_Arcane_Intent_Healing_Agressive_HandFX_01_dcff1cf4-e344-a68d-01bc-5dcc2422d603,S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_04","__ANY__","Dummy_L_HandFX");
PROC_LoopEffect(VFX_Spells_Prepare_Arcane_Intent_Healing_Agressive_HandFX_01_dcff1cf4-e344-a68d-01bc-5dcc2422d603,S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_05","__ANY__","Dummy_R_HandFX");

IF
FlagSet(GLO_Jergal_Event_ResurrectDeadPlayers_a4d65ce6-df15-6ce8-3aa4-ce7ba678b86a, _, _)
THEN
PROC_GLO_Jergal_ResurrectPlayers();

IF
AutomatedDialogEnded(CAMP_Jergal_AD_PlayerResurrection_820a252c-013f-4531-7292-777db8e0c2fd, _)
THEN
SetHasDialog(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 1);

IF
AutomatedDialogForceStopping(CAMP_Jergal_AD_PlayerResurrection_820a252c-013f-4531-7292-777db8e0c2fd, _)
THEN
PROC_GLO_Jergal_ResurrectPlayers();

// AD couldn't start, so most likely players spammed the Talk button on controllers immediately after CAMP_Jergal ended and blocked the AD from starting. (or any other form of interruption of Withers immediately after dialog ended)
// So we just rez the players in DB_CAMP_Jergal_PlayersToResurrect immediately.
IF
AutomatedDialogRequestFailed(CAMP_Jergal_AD_PlayerResurrection_820a252c-013f-4531-7292-777db8e0c2fd, _)
THEN
PROC_GLO_Jergal_ResurrectPlayers();

// Clear DB entries of characters who can't be resurrected
PROC
PROC_GLO_Jergal_ResurrectPlayers()
AND
DB_CAMP_Jergal_PlayersToResurrect(_Player)
AND
QRY_GLO_Jergal_BlockResurrection(_Player)
THEN
NOT DB_CAMP_Jergal_PlayersToResurrect(_Player);

PROC
PROC_GLO_Jergal_ResurrectPlayers()
THEN
ClearFlag(GLO_Jergal_Event_ResurrectDeadPlayers_a4d65ce6-df15-6ce8-3aa4-ce7ba678b86a, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GLO_Jergal_BlockAttackedADDuringResurrection(1);
PROC_GLO_Jergal_ResurrectPlayers_Recursive();

//VFX
PROC
PROC_GLO_Jergal_ResurrectPlayers()
THEN
PROC_StopLoopEffect(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_01");
PROC_StopLoopEffect(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_02");
PROC_StopLoopEffect(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_03");
PROC_StopLoopEffect(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_04");
PROC_StopLoopEffect(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"GLO_Jergal_PlayerResurrection_VFX_05");

// Start resurrecting players
PROC
PROC_GLO_Jergal_ResurrectPlayers_Recursive()
AND
QRY_OnlyOnce_Reset("GLO_Jergal_ResurrectPlayer")
AND
DB_CAMP_Jergal_PlayersToResurrect(_Player)
AND
QRY_OnlyOnce("GLO_Jergal_ResurrectPlayer")
THEN
NOT DB_CAMP_Jergal_PlayersToResurrect(_Player);
PROC_GLO_Jergal_ResurrectPlayer(_Player);

// Player can't be resurrected but there are still others to resurrect.
PROC
PROC_GLO_Jergal_ResurrectPlayer((CHARACTER)_Player)
AND
NOT DB_Dead(_Player)
AND
DB_CAMP_Jergal_PlayersToResurrect(_)
THEN
PROC_GLO_Jergal_ResurrectPlayers_Recursive();

PROC
PROC_GLO_Jergal_ResurrectPlayer((CHARACTER)_Player)
AND
DB_Dead(_Player)
THEN
PROC_GLO_Jergal_Teleport(_Player, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "GLO_Jergal_ResurrectPlayer");

// Then resurrect them once they arrive
IF
EntityEvent((CHARACTER)_Player, "GLO_Jergal_ResurrectPlayer")
THEN
PROC_SetOnStage(_Player, 1);
//Add small delay
SetVisible(_Player, 1);
RealtimeObjectTimerLaunch(_Player, "GLO_Jergal_OverrideReturnPos", 100);
DB_GLO_Jergal_DoingResurrection(_Player);
UseSpell((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"Teleportation_TrueResurrection_Scroll",_Player,_Player);
RemoveStatus(_Player, "GLO_JERGAL_RESURRECTION_END_VFX");
TimerLaunch("GLO_Jergal_DelayNextResurrection", 4500);

IF
CastedSpell((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805,"Teleportation_TrueResurrection_Scroll",_,_,_)
AND
DB_GLO_Jergal_DoingResurrection(_Player)
THEN
Resurrect(_Player);
SetHitpointsPercentage(_Player,100.0);

IF
TimerFinished("GLO_Jergal_DelayNextResurrection")
AND
DB_GLO_Jergal_DoingResurrection(_Player)
AND
DB_Dead(_Player)
THEN
Resurrect(_Player);

IF
TimerFinished("GLO_Jergal_DelayNextResurrection")
AND
DB_GLO_Jergal_DoingResurrection(_Player)
THEN
NOT DB_GLO_Jergal_DoingResurrection(_Player);

IF
TimerFinished("GLO_Jergal_DelayNextResurrection")
THEN
PROC_GLO_Jergal_ResurrectPlayers_Recursive();

// If party is not full and not in the party add companion to avatar who is resurrecting them.
IF
EntityEvent((CHARACTER)_Player, "GLO_Jergal_ResurrectPlayer")
AND
DB_GLO_Jergal_ResurrectedBy(_Avatar)
AND
NOT DB_Players(_Player)
AND
NOT DB_Avatars(_Player)
AND
GetFlag((FLAG)GEN_MaxPlayerCountReached_823b5064-8aa4-c0b7-1b8c-657b46987ccd, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
PROC_GLO_Jergal_Recruit(_Player, _Avatar);

PROC
PROC_GLO_Jergal_Recruit((CHARACTER)_Hireling, (CHARACTER)_ResurrectedBy)
AND
DB_Hirelings_Hired(_Hireling)
THEN
PROC_Hirelings_TakeFromCamp(_Hireling, _ResurrectedBy); // This recruitment occurs after a resurrection, which sends the hireling to camp. Therefore it should be taking the hireling from camp as opposed to adding him directly to party.

PROC
PROC_GLO_Jergal_Recruit((CHARACTER)_Origin, (CHARACTER)_ResurrectedBy)
AND
DB_Origins(_Origin)
THEN
PROC_GLO_PartyMembers_Add(_Origin, _ResurrectedBy);

PROC
PROC_GLO_Jergal_Recruit((CHARACTER)_DismissedAvatar, (CHARACTER)_ResurrectedBy)
AND
NOT DB_Origins(_DismissedAvatar)
AND
DB_DismissedAvatar(_DismissedAvatar)
THEN
PROC_GLO_PartyMembers_Add(_DismissedAvatar, _ResurrectedBy);

// Override returning position from camp.
IF
ObjectTimerFinished(_ResurrectedPlayer, "GLO_Jergal_OverrideReturnPos")
AND
DB_Camp_BlockCamperPosAdjustment((CHARACTER)_ResurrectedPlayer)
THEN
NOT DB_Camp_BlockCamperPosAdjustment((CHARACTER)_ResurrectedPlayer);

IF
ObjectTimerFinished(_ResurrectedPlayer, "GLO_Jergal_OverrideReturnPos")
AND
DB_LeaveCamp_ReturnPos((CHARACTER)_ResurrectedPlayer, _OldX, _OldY, _OldZ)
AND
DB_GLO_Jergal_ReturnPosition(_Player,_NewX, _NewY, _NewZ)
THEN
NOT DB_LeaveCamp_ReturnPos((CHARACTER)_ResurrectedPlayer, _OldX, _OldY, _OldZ);
NOT DB_GLO_Jergal_ReturnPosition((CHARACTER)_ResurrectedPlayer, _NewX, _NewY, _NewZ);
DB_LeaveCamp_ReturnPos((CHARACTER)_ResurrectedPlayer, _NewX, _NewY, _NewZ);

// Use if for any reason a player can't be resurrected
QRY
QRY_GLO_Jergal_BlockResurrection((CHARACTER)_Char)
AND
IsTagged(_Char, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6, 1)
THEN
DB_NOOP(1);

//REGION Characters not in the active party
IF
FlagSet(_WillResurrectFlag, _, _)
AND
DB_GLO_Jergal_CompanionResurrectionFlags(_, _CanResurrectFlag, _WillResurrectFlag)
THEN
ClearFlag(_CanResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(_WillResurrectFlag, _, _)
AND
DB_GLO_Jergal_HirelingResurrectionFlags(_, _CanResurrectFlag, _WillResurrectFlag)
THEN
ClearFlag(_CanResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(_WillResurrectFlag, _, _)
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags(_, _CanResurrectFlag, _WillResurrectFlag)
THEN
ClearFlag(_CanResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION Characters not in the active party

//Resurrected before Jergal does it.
IF
Resurrected(_Char)
AND
DB_CAMP_Jergal_PlayersToResurrect(_Char)
THEN
PROC_GLO_Jergal_CancelResurrection(_Char);

PROC
PROC_GLO_Jergal_CancelResurrection((CHARACTER)_Char)
THEN
NOT DB_CAMP_Jergal_PlayersToResurrect(_Char);

PROC
PROC_GLO_Jergal_CancelResurrection((CHARACTER)_Char)
AND
DB_GLO_Jergal_DeadPlayers(_Char, _Variable, _ResurrectFlag, _DismissFlag)
THEN
NOT DB_GLO_Jergal_DeadPlayers(_Char, _Variable, _ResurrectFlag, _DismissFlag);

PROC
PROC_GLO_Jergal_CancelResurrection((CHARACTER)_Char)
AND
DB_GLO_Jergal_CompanionResurrectionFlags(_Char, _CanResurrectFlag, _WillResurrectFlag)
THEN
ClearFlag(_CanResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(_WillResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GLO_Jergal_CancelResurrection((CHARACTER)_Char)
AND
DB_GLO_Jergal_HirelingResurrectionFlags_Dead(_DialogVariable, _Char)
AND
DB_GLO_Jergal_HirelingResurrectionFlags(_DialogVariable, _CanResurrectFlag, _WillResurrectFlag)
THEN
NOT DB_GLO_Jergal_HirelingResurrectionFlags_Dead(_DialogVariable, _Char);
ClearFlag(_CanResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(_WillResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GLO_Jergal_CancelResurrection((CHARACTER)_Char)
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags_Dead(_DialogVariable, _Char)
AND
DB_GLO_Jergal_DismissedAvatarResurrectionFlags(_DialogVariable, _CanResurrectFlag, _WillResurrectFlag)
THEN
NOT DB_GLO_Jergal_DismissedAvatarResurrectionFlags_Dead(_DialogVariable, _Char);
ClearFlag(_CanResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(_WillResurrectFlag, NULL_00000000-0000-0000-0000-000000000000);

//REGION Dead Party management
IF
FlagSet(_DismissFlag, _, _ID)
AND
DB_GLO_Jergal_DeadPlayers(_Char, _, _, _DismissFlag)
THEN
DB_GLO_Jergal_DismissCharacter_AfterDialog(_ID,_Char);

IF
DialogEnded(_JergalDialog,_ID)
AND
DB_GLO_Jergal_DismissCharacter_AfterDialog(_ID,_Char)
THEN
PROC_GLO_Jergal_DismissCharacter(_Char);
NOT DB_GLO_Jergal_DismissCharacter_AfterDialog(_ID,_Char);

// for companions
PROC
PROC_GLO_Jergal_DismissCharacter((CHARACTER)_Char)
AND
NOT DB_Hirelings_Hired(_Char)
AND
NOT DB_Avatars(_Char)
AND
QRY_Camp_GetCamperPos(_Char)
AND
DB_QRYRTN_Camp_GetCamperPos(_Char, _Pos)
THEN
PROC_GLO_Jergal_Teleport(_Char, _Pos, "GLO_Jergal_CompanionDismissed");

// for hirelings
PROC
PROC_GLO_Jergal_DismissCharacter((CHARACTER)_Char)
AND
DB_Hirelings_Hired(_Char)
AND
QRY_Camp_GetCamperPos_Custom(_Char)
AND
DB_QRYRTN_Camp_GetCamperPos(_Char, _Pos)
THEN
PROC_GLO_Jergal_Teleport(_Char, _Pos, "GLO_Jergal_CompanionDismissed");

// for avatars
PROC
PROC_GLO_Jergal_DismissCharacter((CHARACTER)_Char)
AND
DB_Avatars(_Char)
AND
DB_GLO_Jergal_ResurrectedBy(_Dismisser)
THEN
PROC_GLO_PartyMembers_Remove(_Char,_Dismisser,0);

IF
DB_DismissedAvatar(_)
THEN
SetFlag((FLAG)CAMP_Jergal_State_DismissedDeadAvatar_fbafc0bc-4292-4ac4-ab9d-44135d6db1ea,NULL_00000000-0000-0000-0000-000000000000,1);

IF
DB_GlobalFlag((FLAG)CAMP_Jergal_State_DismissedDeadAvatar_fbafc0bc-4292-4ac4-ab9d-44135d6db1ea)
AND
NOT DB_DismissedAvatar(_)
THEN
ClearFlag((FLAG)CAMP_Jergal_State_DismissedDeadAvatar_fbafc0bc-4292-4ac4-ab9d-44135d6db1ea,NULL_00000000-0000-0000-0000-000000000000,1);

IF
TemplateUseFinished(_,(ITEMROOT)FUR_GEN_Wardrobe_Player_A_d94c7491-0868-4444-b83c-82f5454d4b64,_,_)
AND
NOT DB_GlobalFlag(CAMP_Jergal_State_UsedWithersWardrobe_0f1d591a-15fd-4810-b295-8ac697909447)
THEN
SetFlag(CAMP_Jergal_State_UsedWithersWardrobe_0f1d591a-15fd-4810-b295-8ac697909447,NULL_00000000-0000-0000-0000-000000000000);


IF
EntityEvent((CHARACTER)_Hireling, "GLO_Jergal_CompanionDismissed")
AND
DB_Hirelings_Hired(_Hireling)
THEN
PROC_Hirelings_SendToCampForStorage(_Hireling);
PROC_GLO_Jergal_SetDeadPlayers(); // Need to reevaluate dead players since the party composition changed.

IF
EntityEvent((CHARACTER)_Origin, "GLO_Jergal_CompanionDismissed")
AND
DB_Origins(_Origin)
AND
NOT DB_Avatars(_Origin)
THEN
PROC_GLO_PartyMembers_Remove(_Origin, 1);
PROC_GLO_Jergal_SetDeadPlayers(); // Need to reevaluate dead players since the party composition changed.

IF
EntityEvent(_, "GLO_Jergal_CompanionDismissed")
AND
DB_GLO_Jergal_ResurrectionDialogues(_Dialog, _)
AND
DB_DialogName(_Dialog, _)
THEN
PROC_GLO_Jergal_SetDialogVariables(_Dialog);
//END_REGION
//END_REGION

//REGION Block GLO_Tadpole_DaisyAD_TadpoleOnTrueSoulCorpse from playing when Jergal is resurrecting a companion.
QRY
QRY_Tadpole_BlockShowCorpseAD((CHARACTER)_Player,(CHARACTER)_ResurrectingChar)
AND
DB_GLO_Jergal_DoingResurrection(_ResurrectingChar)
THEN
DB_NOOP(1);
//END_REGION


//REGION Misc
IF
FlagSet(_Flag, _, _)
AND
DB_GLO_Jergal_HasMetFlags(_Flag)
THEN
SetFlag((FLAG)GLO_Jergal_HasMet_c8c4ec60-7a6a-4ab6-a6f8-3e6b75df1bc6, NULL_00000000-0000-0000-0000-000000000000); // Keep track if anyone in the party has met Jergal at least once.

IF
FlagSet((FLAG)CAMP_Jergal_HasMet_fdba7b59-851a-3edb-fe0f-d6045c5f8dd3, _, _)
THEN
SetFlag((FLAG)CAMP_Jergal_HasMet_AtCamp_838852f9-c395-43d0-b90e-20c15cfd8b14, NULL_00000000-0000-0000-0000-000000000000); // Keep track if anyone in the party has met Jergal at least once.

// Teleport effects
PROC
PROC_GLO_Jergal_Teleport((CHARACTER)_Char, (GUIDSTRING)_TeleportTo, (STRING)_TeleportEvent)
AND
NOT DB_GLO_Jergal_TeleportTo(_Char, _, _)
THEN
DB_GLO_Jergal_TeleportTo(_Char, _TeleportTo, _TeleportEvent);
ApplyStatus(_Char, "GLO_JERGAL_RESURRECTION_START_VFX", 1.0, 1); // We are using this mostly for the VFX overlay.
RealtimeObjectTimerLaunch(_Char, "GLO_Jergal_TeleportReady", 800);

IF
ObjectTimerFinished((CHARACTER)_Char, "GLO_Jergal_TeleportReady")
AND
DB_GLO_Jergal_TeleportTo(_Char, _TeleportTo, _TeleportEvent)
AND
NOT QRY_GLO_Jergal_TrySafeTeleportTo(_Char, _TeleportTo, _TeleportEvent)
THEN
RemoveStatus(_Char, "GLO_JERGAL_RESURRECTION_START_VFX");
TeleportTo(_Char, _TeleportTo, _TeleportEvent, 0, 0, 1);

QRY
QRY_GLO_Jergal_TrySafeTeleportTo((CHARACTER)_Char, (GUIDSTRING)_Target, (STRING)_Event)
AND
QRY_GLO_Jergal_GetNearRandomPosition(_Char, (GUIDSTRING)_Target)
AND
DB_QRYRTN_GLO_Jergal_GetNearRandomPosition(_X, _Y, _Z)
THEN
RemoveStatus(_Char, "GLO_JERGAL_RESURRECTION_START_VFX");
TeleportToPosition(_Char, _X, _Y, _Z, _Event, 0, 0, 1);

QRY
QRY_GLO_Jergal_GetNearRandomPosition((GUIDSTRING)_Char, (GUIDSTRING)_Target)
AND
DB_QRYRTN_GLO_Jergal_GetNearRandomPosition(_X, _Y, _Z)
THEN
NOT DB_QRYRTN_GLO_Jergal_GetNearRandomPosition(_X, _Y, _Z);

QRY
QRY_GLO_Jergal_GetNearRandomPosition((GUIDSTRING)_Char, (GUIDSTRING)_Target)
AND
GetPosition(_Target, _X, _Y, _Z)
AND
FindValidPosition(_X, _Y, _Z, 5.0, _Char, 1, _ValidX, _ValidY, _ValidZ)
THEN
DB_QRYRTN_GLO_Jergal_GetNearRandomPosition(_ValidX, _ValidY, _ValidZ);

QRY
QRY_GLO_Jergal_GetNearRandomPosition((GUIDSTRING)_Char, (GUIDSTRING)_Target)
AND
NOT DB_QRYRTN_GLO_Jergal_GetNearRandomPosition(_, _, _)
AND
GetPosition(_Target, _X, _Y, _Z)
THEN
DB_QRYRTN_GLO_Jergal_GetNearRandomPosition(_X, _Y, _Z);

IF
EntityEvent((CHARACTER)_Char, _TeleportEvent)
AND
DB_GLO_Jergal_TeleportTo(_Char, _TeleportTo, _TeleportEvent)
THEN
NOT DB_GLO_Jergal_TeleportTo(_Char, _TeleportTo, _TeleportEvent);
ApplyStatus(_Char, "GLO_JERGAL_RESURRECTION_END_VFX", 6.0, 1);
RealtimeObjectTimerLaunch(_Char, "GLO_Jergal_StopTeleportVFX", 4250);

IF
ObjectTimerFinished(_Char, "GLO_Jergal_StopTeleportVFX")
THEN
RemoveStatus(_Char, "GLO_JERGAL_RESURRECTION_END_VFX");

IF
TextEvent("Jergal_TestTeleport")
AND
GetHostCharacter(_Player)
THEN
PROC_GLO_Jergal_Teleport(_Player, (CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "Jergal_TestTeleport");

PROC
PROC_StartDialog_PreDialogStarted((DIALOGRESOURCE)CAMP_Jergal_7f4acd9b-15c0-81fe-9409-623634ec3ed3,1, _InstanceID, _, _Player, _, _, _, _)
AND
DB_Avatars((CHARACTER)_Player)
AND
NOT QRY_Jergal_HasDismissableAvatars(_Player)
THEN
ClearFlag((FLAG)CAMP_Jergal_State_PlayerHasDismissableAvatars_57fef7bf-e4f3-b1a7-0d85-b5639a41acdd,_Player);

QRY
QRY_Jergal_HasDismissableAvatars((CHARACTER)_Player)
AND
DB_AvatarHasDismissableDialog(_DismissableAvatar)
AND
QRY_SameUser(_Player,_DismissableAvatar)
THEN
SetFlag((FLAG)CAMP_Jergal_State_PlayerHasDismissableAvatars_57fef7bf-e4f3-b1a7-0d85-b5639a41acdd,_Player);


//END_REGION
EXITSECTION
PROC_TriggerUnregisterForPlayers(S_GOB_JergalAppear_BackupZone_13961b54-9126-4dea-abe0-175e66afba66);
ENDEXITSECTION
ParentTargetEdge "ModWrapper_Gustav"
