Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_TadpolePowers_UnlockedByDefault((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_GLO_CompoundFlag((FLAG)ORI_Astarion_Knows_CazadorMaster_7236c69b-fe20-afdb-a6fa-15c1fb9fb6ae, (FLAG)ORI_Astarion_Knows_HasMaster_38f33e31-9914-409e-a592-fb1f58ddd9fa);

//REGION Forced InParty discussions
DB_ORI_Astarion_ForcedInPartyDiscussionFlags((FLAG)ORI_Astarion_State_PartyNeedsToDiscussAstarionsIdentity_25ed2869-3fdc-4f74-8acd-0adaba69c41e);
DB_ORI_Astarion_ForcedInPartyDiscussionFlags((FLAG)ORI_Astarion_State_PartyNeedsToDiscussCampNightBite_4fb192a2-a068-461e-b23e-9dd517f77fda);
DB_ORI_Astarion_ForcedInPartyDiscussionFlags((FLAG)ORI_Astarion_State_PartyNeedsToDiscussGameplayBite_c3f96c88-b404-497f-b287-e3453e334c94);

DB_GlobalFlagReactionAfterDialog(ORI_Astarion_State_GurHunterForceReveal_21836280-71de-4895-8c47-c0b3e225c127, (DIALOGRESOURCE)HAG_GurHunter_OM_Astarion_AOM_OOM_607d464a-3738-9dd2-c716-6cf3bf507761);

DB_ORI_Astarion_ForceIdentityDiscussionTriggers((TRIGGER)S_CRE_Mountains_SUB_bb2094fe-5094-4dae-87a6-a8a9319d11fa);
DB_ORI_Astarion_ForceIdentityDiscussionTriggers((TRIGGER)S_SCL_AstarionForceRevealTrigger_d315831e-0a2c-4f11-b234-bc9b8bf43a97);
//END_REGION

//REGION Companion Journal
DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_State_RequestedConversationWithRaphael_0f717745-2fbf-465a-8ada-51bb94919378, "ORI_COM_Astarion", "AstarionToldRaphael_NoScars", 0, (FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9);
DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_State_RequestedConversationWithRaphael_0f717745-2fbf-465a-8ada-51bb94919378, "ORI_COM_Astarion", "AstarionToldRaphael", 1, (FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9);
DB_QuestDef_State((FLAG)HAV_MolsDeal_State_Lanceboard_ThreeWay_AstarionAskedRaphael_e1fabb89-91f2-d95f-a0e7-2870baebbaae, "ORI_COM_Astarion", "MetRaphaelHaven");
DB_QuestDef_State((FLAG)ORI_Astarion_State_RaphaelLeftHavenNoInfo_NoScars_051a4f2e-63bf-4578-a7ac-d8f35578ccd7, "ORI_COM_Astarion", "MetRaphaelHaven_NoInfo_NoScars");
DB_QuestDef_State((FLAG)ORI_Astarion_State_RaphaelLeftHavenNoInfo_dc012756-d655-4bae-803f-a7741d5cfdd8, "ORI_COM_Astarion", "MetRaphaelHaven_NoInfo");
DB_QuestDef_State((FLAG)ORI_Astarion_State_GotQuestFromRaphaelAtMasoleum_31f42f3f-78cd-48d8-a45a-ffb93f4345d1, "ORI_COM_Astarion", "MetRaphaelMasoleum");
DB_QuestDef_State((FLAG)ORI_Astarion_State_GotQuestFromRaphaelAtCamp_263aeee8-54c7-4a5b-8274-48fe7e530856, "ORI_COM_Astarion", "MetRaphaelCamp");
DB_QuestDef_State_ConditionalFlag((FLAG)SHA_Orthon_State_DefeatedOnce_8dd589d6-90fc-4a3b-b369-10440bd56520, "ORI_COM_Astarion", "KilledOrhon", 1, (FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5);
DB_QuestDef_State((FLAG)ORI_Astarion_State_RaphaelToldRitual_7b30820e-92e5-4f64-a2f5-92edbd9a0e2f, "ORI_COM_Astarion", "ScarsRevealed");

DB_GLO_CompoundFlag((FLAG)ORI_Astarion_State_GotQuestFromRaphaelAtMasoleum_31f42f3f-78cd-48d8-a45a-ffb93f4345d1, (FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5);
DB_GLO_CompoundFlag((FLAG)ORI_Astarion_State_GotQuestFromRaphaelAtCamp_263aeee8-54c7-4a5b-8274-48fe7e530856, (FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5);

DB_QuestDef_State((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9, "ORI_COM_Astarion", "ReachedBG");
DB_QuestDef_State((FLAG)WYR_GurCamp_State_AstarionPromisedToHelp_69b7e436-5e7a-4f53-8e51-fd8ede064a0e, "ORI_COM_Astarion", "Ulma_GurPeace");
DB_QuestDef_State((FLAG)WYR_GurCamp_State_AttackedGur_6f6d0421-e12e-7a1a-5658-64f85ef6b236, "ORI_COM_Astarion", "Ulma_GurHostile");
DB_QuestDef_State((FLAG)GLO_GurCamp_State_GurLeaderPermaDefeated_2dd63ae4-02c6-4360-8bdd-4d8d938a56e0, "ORI_COM_Astarion", "Ulma_Dead");
DB_QuestDef_State((FLAG)WYR_GurCamp_State_BetrayedAstarion_e9410d3a-0ade-4bfe-93b8-af51fb7fc399, "ORI_COM_Astarion", "Ulma_BetrayedAstarion");

DB_QuestDef_State((FLAG)CAMP_VampireAmbush_State_AmbushFailed_c7ad2cf7-59de-4310-aac1-2635d66474bf, "ORI_COM_Astarion", "MetAmbushSpawns_Failed");
DB_QuestDef_State((FLAG)CAMP_VampireAmbush_State_AstarionKidnapped_b52d681f-4722-4f43-ba95-ac9f49c173d8, "ORI_COM_Astarion", "MetAmbushSpawns_Succeeded");

DB_QuestDef_State((FLAG)ORI_Astarion_State_LeftKennelAfterKidnapping_378e24eb-7b5b-43f4-8662-1a7f4ffed5ed, "ORI_COM_Astarion", "EscapedFromKennel");

DB_QuestDef_State_ConditionalFlag((FLAG)LOW_CazadorsPalace_State_EnteredMansion_97df5c27-5740-4277-96e1-5fdd4c5e6699, "ORI_COM_Astarion", "EnteredPalace", 0, (FLAG)CAMP_VampireAmbush_State_AstarionKidnapped_b52d681f-4722-4f43-ba95-ac9f49c173d8);

DB_QuestDef_State((FLAG)LOW_CazadorsPalace_Event_TeleportToDungeonLevel_edece03f-595c-47ef-aebd-3eb516277956, "ORI_COM_Astarion", "EnteredDungeon");

DB_QuestDef_State((FLAG)ORI_Astarion_State_MetSebastian_b0158356-c6ca-4734-bc24-1d0b52c1d6bd, "ORI_COM_Astarion", "MetSebastian");
DB_QuestDef_State((FLAG)LOW_CazadorsPalace_Cells_Knows_StaffUnlocksCells_2aa3f8e1-1578-145e-40b0-8a69a20e9f7f, "ORI_COM_Astarion", "LearnedStaff");

DB_QuestDef_BookReadState("ORI_COM_Astarion", "LearnedRitual", (ITEM)S_LOW_CazadorsPalace_Crypt_Scroll_591d390d-68b7-4937-9103-3772493ab132);

DB_QuestDef_State((FLAG)LOW_CazadorsPalace_Cazador_State_FetchingAstarion_a2d019a4-164c-1028-e2ae-8651b3e4cf08, "ORI_COM_Astarion", "FoundCazador_Fetching");

DB_QuestDef_State((FLAG)ORI_Astarion_State_CapturedInCombat_705422ce-924a-4267-a16e-067aed0f3089, "ORI_COM_Astarion", "RitualCapture");
DB_QuestDef_State((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c, "ORI_COM_Astarion", "CazadorInCoffin");

DB_QuestDef_State((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, "ORI_COM_Astarion", "Ascended");
DB_QuestDef_State((FLAG)LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240, "ORI_COM_Astarion", "ReleasedPrisoners");
DB_QuestDef_State((FLAG)LOW_CazadorsPalace_RitualRoom_State_KilledPrisoners_a138792f-04ae-410b-afce-1bf661e9c868, "ORI_COM_Astarion", "KilledPrisoners");
DB_QuestDef_State((FLAG)LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5, "ORI_COM_Astarion", "LeftPrisoners");
DB_QuestDef_State((FLAG)ORI_Astarion_State_LeftToEndNoCazador_eb702db1-b81f-4316-8b1e-667500fa3ca8, "ORI_COM_Astarion", "LeftToEND");

// Fallback Journal Entries if we reach Act 1b (2) or Act 3 without learning that Astarion is a vampire
DB_QuestDef_State((FLAG)ORI_Astarion_Event_LearnedVampire_Act2Fallback_bda4c552-b8df-4b66-ae0b-1c653a56b3e8, "ORI_COM_Astarion", "LearnedVampire_Act2Fallback");
DB_QuestDef_State((FLAG)ORI_Astarion_Event_LearnedVampire_Act3Fallback_e051d5a7-cad0-4049-8110-1bf4605f8d89, "ORI_COM_Astarion", "LearnedVampire_Act3Fallback");

DB_QuestDef_State_ConditionalFlag((FLAG)HAG_GurHunter_Event_MentionedAstarionQuestUpdate_f9d1a178-f643-480f-bc76-86ef1145dc7c, "ORI_COM_Astarion", "MetGur_LearnedVampire", 0, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
DB_QuestDef_State_ConditionalFlag((FLAG)HAG_GurHunter_Event_MentionedAstarionQuestUpdate_f9d1a178-f643-480f-bc76-86ef1145dc7c, "ORI_COM_Astarion", "MetGur_LearnedVampire_AlreadyKnew", 1, (FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
//END_REGION 


//REGION Avatar Journal
// Act 1
DB_GLO_CompoundFlag((FLAG)CAMP_Astarion_TheHungerA_LeaveParty_cc3d051f-c334-f432-e618-5e0de55924bf, ORI_Astarion_State_Bite_CompanionLeft_ac7f524a-c51f-45be-8f51-cf66b5def2e9);

DB_QuestDef_State((FLAG)ORI_Astarion_State_FirstDreamEnded_872b076a-0475-4184-a756-b3a0c9d872ae, "ORI_Avatar_Astarion", "FirstDream");
DB_QuestDef_State((FLAG)CAMP_Astarion_TheHungerA_HuntAnimal_ef9c902d-0940-4a39-a926-5717795b89fe, "ORI_Avatar_Astarion", "Bite_Animal");
DB_QuestDef_State((FLAG)CAMP_Astarion_TheHungerA_Drain_cb67cffc-791b-c790-3a79-6c3d68ce3609, "ORI_Avatar_Astarion", "Bite_Stealth_Murder");
DB_QuestDef_State((FLAG)CAMP_Astarion_TheHungerA_HalfDrain_3f739f8d-d423-5020-eaf0-6f478b8cb1be, "ORI_Avatar_Astarion", "Bite_Stealth_HalfDrain");

DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_State_Bite_RevealSuccess_b460aa45-8b1e-44c9-bbc8-57726aac920e, "ORI_Avatar_Astarion", "Bite_Reveal_Success", 0, (FLAG)CAMP_AstarionAvatar_DrankGaleBlood_296a74f4-4a62-2a59-8363-8f99048b9204);

DB_QuestDef_State((FLAG)CAMP_Astarion_TheHungerA_BadDream_27d97b60-0e42-bb16-0606-803c17345576, "ORI_Avatar_Astarion", "Bite_Lie_Success");
DB_QuestDef_State((FLAG)ORI_Astarion_State_Bite_CompanionLeft_ac7f524a-c51f-45be-8f51-cf66b5def2e9, "ORI_Avatar_Astarion", "Bite_CompanionLeft");
DB_QuestDef_State((FLAG)CAMP_Astarion_TheHungerA_BiteAvatarFail_2b6d4686-a8df-44b5-8dfe-86560ac867f8, "ORI_Avatar_Astarion", "Bite_Avatar_Failure");

DB_QuestDef_State((FLAG)ORI_Astarion_State_MetGurHunter_e9d0ed27-506f-4295-89d2-448a4b46b174, "ORI_Avatar_Astarion", "MetGurHunter");
DB_QuestDef_State_ConditionalFlag((FLAG)GLO_GurHunter_State_PermaDefeated_90970c15-b3ac-4bde-a242-4d37abeec99a, "ORI_Avatar_Astarion", "MetGurHunter_Murder", 1, (FLAG)ORI_Astarion_State_MetGurHunter_e9d0ed27-506f-4295-89d2-448a4b46b174);
DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_Knows_MaidenFel_fe63f819-fcd1-fcaa-e611-64a631945fb6, "ORI_Avatar_Astarion", "MetGurHunter_LearnedEmployer", 1, (FLAG)ORI_Astarion_State_MetGurHunter_e9d0ed27-506f-4295-89d2-448a4b46b174);

DB_QuestDef_State(ORI_Astarion_State_PartyNeedsToDiscussBite_c3f96c88-b404-497f-b287-e3453e334c94, "ORI_Avatar_Astarion", "GameplayBiteReveal");
DB_QuestDef_State(ORI_Astarion_State_PartyNeedsToDiscussAstarionsIdentity_25ed2869-3fdc-4f74-8acd-0adaba69c41e, "ORI_Avatar_Astarion", "Act1LeftReveal");

// Act 2
DB_QuestDef_State((FLAG)NIGHT_Astarion_CazadorNightmare_SecondDream_c4214d0e-ed58-49ba-9d44-e1ce8366fc87, "ORI_Avatar_Astarion", "SecondDream");
DB_QuestDef_State((FLAG)HAV_MolsDeal_State_Lanceboard_ThreeWay_AstarionAskedRaphael_e1fabb89-91f2-d95f-a0e7-2870baebbaae, "ORI_Avatar_Astarion", "MetRaphaelHaven");
DB_QuestDef_State((FLAG)ORI_Astarion_State_RaphaelLeftHavenNoInfo_dc012756-d655-4bae-803f-a7741d5cfdd8, "ORI_Avatar_Astarion", "MetRaphaelHaven_NoInfo");
DB_QuestDef_State((FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5, "ORI_Avatar_Astarion", "MetRaphaelMasoleum");
DB_QuestDef_State_ConditionalFlag((FLAG)SHA_Orthon_State_DefeatedOnce_8dd589d6-90fc-4a3b-b369-10440bd56520, "ORI_Avatar_Astarion", "KilledOrhon", 1, (FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5);
DB_QuestDef_State((FLAG)ORI_Astarion_State_RaphaelToldRitual_7b30820e-92e5-4f64-a2f5-92edbd9a0e2f, "ORI_Avatar_Astarion", "ScarsRevealed");
DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_State_RaphaelLeftMasoleumEntrance_ee881edf-2d4d-40a2-a6f1-c790a01c9ed5, "ORI_Avatar_Astarion", "RaphaelLeftNoInfo", 0, (FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5);

// Act 3
DB_QuestDef_State((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9, "ORI_Avatar_Astarion", "ReachedBG");
DB_QuestDef_State((FLAG)WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0, "ORI_Avatar_Astarion", "Ulma_GurPeace");
DB_QuestDef_State((FLAG)WYR_GurCamp_State_AttackedGur_6f6d0421-e12e-7a1a-5658-64f85ef6b236, "ORI_Avatar_Astarion", "Ulma_GurHostile");
DB_QuestDef_State((FLAG)GLO_GurCamp_State_GurLeaderPermaDefeated_2dd63ae4-02c6-4360-8bdd-4d8d938a56e0, "ORI_Avatar_Astarion", "Ulma_Dead");

DB_QuestDef_State((FLAG)CAMP_VampireAmbush_State_AmbushFailed_c7ad2cf7-59de-4310-aac1-2635d66474bf, "ORI_Avatar_Astarion", "MetAmbushSpawns_Failed");
DB_QuestDef_State((FLAG)CAMP_VampireAmbush_State_AstarionKidnapped_b52d681f-4722-4f43-ba95-ac9f49c173d8, "ORI_Avatar_Astarion", "MetAmbushSpawns_Succeeded");

DB_QuestDef_State_ConditionalFlag((FLAG)LOW_CazadorsPalace_State_EnteredMansion_97df5c27-5740-4277-96e1-5fdd4c5e6699, "ORI_Avatar_Astarion", "EnteredPalace", 0, (FLAG)CAMP_VampireAmbush_State_AstarionKidnapped_b52d681f-4722-4f43-ba95-ac9f49c173d8);

DB_QuestDef_State((FLAG)LOW_CazadorsPalace_Event_TeleportToDungeonLevel_edece03f-595c-47ef-aebd-3eb516277956, "ORI_Avatar_Astarion", "EnteredDungeon");
DB_QuestDef_State((FLAG)ORI_Astarion_State_MetSebastian_b0158356-c6ca-4734-bc24-1d0b52c1d6bd, "ORI_Avatar_Astarion", "MetSebastian");

DB_QuestDef_BookReadState("ORI_Avatar_Astarion", "LearnedRitual", (ITEM)S_LOW_CazadorsPalace_Crypt_Scroll_591d390d-68b7-4937-9103-3772493ab132);
DB_QuestDef_State((FLAG)LOW_CazadorsPalace_Cells_Knows_StaffUnlocksCells_2aa3f8e1-1578-145e-40b0-8a69a20e9f7f, "ORI_Avatar_Astarion", "LearnedStaff");

DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_State_PreRitualSceneEnded_8e60ef2f-d3cc-49b2-a552-70a545caceed, "ORI_Avatar_Astarion", "FoundCazador_NoRitual", 0, LOW_CazadorsPalace_RitualRoom_Event_TeleportAstarion_1318f561-8b32-4ac2-bb85-a4f2b93f53d4);
DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_State_PreRitualSceneEnded_8e60ef2f-d3cc-49b2-a552-70a545caceed, "ORI_Avatar_Astarion", "FoundCazador_Ritual", 1, LOW_CazadorsPalace_RitualRoom_Event_TeleportAstarion_1318f561-8b32-4ac2-bb85-a4f2b93f53d4);

DB_QuestDef_State((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c, "ORI_Avatar_Astarion", "CazadorInCoffin");

DB_QuestDef_State((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, "ORI_Avatar_Astarion", "Ascended");
DB_QuestDef_State((FLAG)LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240, "ORI_Avatar_Astarion", "ReleasedPrisoners");
DB_QuestDef_State((FLAG)LOW_CazadorsPalace_RitualRoom_State_KilledPrisoners_a138792f-04ae-410b-afce-1bf661e9c868, "ORI_Avatar_Astarion", "KilledPrisoners");
DB_QuestDef_State((FLAG)LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5, "ORI_Avatar_Astarion", "LeftPrisoners");
DB_QuestDef_State((FLAG)ORI_Astarion_State_LeftToEndNoCazador_eb702db1-b81f-4316-8b1e-667500fa3ca8, "ORI_Avatar_Astarion", "LeftToEND");
//END_REGION

//REGION Camp
DB_CAMP_Astarion_StandingStillDialogs((DIALOGRESOURCE)CAMP_AstarionHunger_PAD_AftermathAvatarStealthDrain_775dcb4b-b054-c8b3-6154-958498252cab);
DB_CAMP_Astarion_StandingStillDialogs((DIALOGRESOURCE)CAMP_AstarionHunger_PAD_AftermathAvatarKilled_538b7717-cbee-b956-8fd0-78d3e97603ad);
DB_CAMP_Astarion_StandingStillDialogs((DIALOGRESOURCE)GLO_Astarion_PAD_AstarionKidnapped_6ce11a30-ad07-ef5e-7352-28fd78b75a92); //TODO: look at the avatar
NOT DB_CAMP_Astarion_StandingStillDialogs_SteerTo((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION Dark Urge IPRD

DB_ORI_Astarion_IPRDWorthyDarkUrgeMoment((FLAG)ORI_DarkUrge_State_TorturedWithGoblins_84ee880f-83cb-9c00-49d9-f2bed9a2a235);
DB_ORI_Astarion_IPRDWorthyDarkUrgeMoment((FLAG)ORI_DarkUrge_State_HackedGale_a18d0203-6c1e-b758-242a-c01c60b243a6);
DB_ORI_Astarion_IPRDWorthyDarkUrgeMoment((FLAG)ORI_DarkUrge_State_WoundedBird_PulledWings_f2d614bb-fc65-1356-8a75-502b6dcb4701);
DB_ORI_Astarion_IPRDWorthyDarkUrgeMoment((FLAG)ORI_DarkUrge_State_KilledSquirrel_d070da3d-d3e4-b686-07a7-a3d8d3b81ab2);

DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_DarkUrge_FirstDiscussion_49cf2a9e-341e-49f9-ac10-01e2490d556f);

//END_REGION

//REGION Astarion's bite for Tech QA
// It's unlocked in WLD_Main_A
// but they skip it in some flows
DB_ORI_Astarion_LevelsToUnlockBite("CRE_Main_A");
DB_ORI_Astarion_LevelsToUnlockBite("SCL_Main_A");
DB_ORI_Astarion_LevelsToUnlockBite("INT_Main_A");
DB_ORI_Astarion_LevelsToUnlockBite("BGO_Main_A");
DB_ORI_Astarion_LevelsToUnlockBite("CTY_Main_A");
DB_ORI_Astarion_LevelsToUnlockBite("IRN_Main_A");
DB_ORI_Astarion_LevelsToUnlockBite("END_Main");
//END_REGION
KBSECTION
//REGION Misc
IF
TextEvent("AstarionSwap")
THEN
PROC_RemoveDialogEntryForSpeaker(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46);
DB_Dialogs(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, Astarion_InPartyB_7f99620e-15fb-a35b-04fe-3d6faf708945);

IF
TextEvent("AstarionRestore")
THEN
PROC_RemoveDialogEntryForSpeaker(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, Astarion_InPartyB_7f99620e-15fb-a35b-04fe-3d6faf708945);
DB_Dialogs(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46);

PROC
PROC_GLO_PartyMembers_AddHook(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _)
AND
NOT DB_Avatars(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
SetFlag(ORI_Astarion_State_WasRecruited_e3021e44-45ad-475c-9456-0bc54d06accc);
//END_REGION

//REGION SwD (only if cannot be ressurected)
IF
DB_PermaDefeated(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
IsTagged(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6, 1)
THEN
DB_GLO_CharacterCorpseDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_Dead_0b569c55-f1bc-036a-2842-5b2bcc0d46c4);
//END_REGION

//REGION Handles Astarion feeding behaviour
PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_FeedingTonight_cda3fa90-4fae-4334-b5e0-dc833d473842)
AND
DB_Avatars(_Avatar)
AND
GetFlag((FLAG)ORI_Astarion_State_FeedingTarget_469b943c-d986-470f-bd2e-84077b458fdc, _Avatar, 1)
THEN
PROC_Astarion_Feeding(_Avatar);
PROC_GlobalClearFlagAndCache((FLAG)ORI_Astarion_State_FeedingTonight_cda3fa90-4fae-4334-b5e0-dc833d473842);
ClearFlag((FLAG)ORI_Astarion_State_FeedingTarget_469b943c-d986-470f-bd2e-84077b458fdc, _Avatar);

PROC
PROC_Astarion_Feeding((CHARACTER)_Avatar)
THEN
ApplyStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ASTARION_HAPPY", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(_Avatar, "ASTARION_WEAK", -1.0, 0, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
//END_REGION

//REGION Forced InParty discussions where Astarion's nature is revealed and/or discussed
IF
UsingSpellOnTarget(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (CHARACTER)_Target, "Target_VampireBite_Astarion", _, _, _)
AND
DB_Players(_Target)
AND
QRY_ORI_Astarion_NeedToBlockDefaultAssaultReaction(_Target)
THEN
PROC_BlockPartyDisturbanceReactions(_Target);

QRY
QRY_ORI_Astarion_NeedToBlockDefaultAssaultReaction((CHARACTER)_Target)
AND
_Target == S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
NOT DB_OnlyOnce("ORI_Astarion_GaleReactedToGameplayBite")
THEN
DB_NOOP(1);

QRY
QRY_ORI_Astarion_NeedToBlockDefaultAssaultReaction((CHARACTER)_Target)
AND
QRY_ORI_Astarion_IsKarlachNoTouch(_Target)
AND
NOT DB_OnlyOnce("ORI_Astarion_KarlachNoTouchReactedToGameplayBite")
THEN
DB_NOOP(1);

QRY
QRY_ORI_Astarion_NeedToBlockDefaultAssaultReaction((CHARACTER)_Target)
AND
DB_Players(_Target)
AND
_Target != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
NOT QRY_ORI_Astarion_IsKarlachNoTouch(_Target)
AND
NOT DB_GlobalFlag(ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
THEN
DB_NOOP(1);


PROC
PROC_CastedSpellOnTarget(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Target, "Target_VampireBite_Astarion", (STRING)_SpellType, (STRING)_SpellElement, (INTEGER)_StoryActionID)
THEN
PROC_ORI_Astarion_VampireBiteFinished((CHARACTER)_Target, _StoryActionID);

PROC
PROC_ORI_Astarion_VampireBiteFinished((CHARACTER)_Target, (INTEGER)_StoryActionID)
AND
DB_ORI_Astarion_GameplayBiteTarget(_PreviousTarget, _OldStoryActionID)
THEN
NOT DB_ORI_Astarion_GameplayBiteTarget(_PreviousTarget, _OldStoryActionID);
ClearFlag((FLAG)ORI_Astarion_State_GameplayBiteVictim_487360df-d763-4e22-bd0d-cf5aa4762843, _PreviousTarget);

PROC
PROC_ORI_Astarion_VampireBiteFinished(_Target,_StoryActionID)
THEN
DB_ORI_Astarion_GameplayBiteTarget((CHARACTER)_Target, _StoryActionID);

PROC
PROC_ORI_Astarion_VampireBiteFinished((CHARACTER)_Target, (INTEGER)_StoryActionID)
AND
DB_Players(_Target)
AND
IsTagged(_Target, (TAG)ASTARION_BITE_VICTIM_c912718b-b200-4305-80ef-4020de96356e, 0)
THEN
SetTag(_Target, (TAG)ASTARION_BITE_VICTIM_c912718b-b200-4305-80ef-4020de96356e);

PROC
PROC_ORI_Astarion_VampireBiteFinished((CHARACTER)_Target, (INTEGER)_StoryActionID)
AND
DB_Players(_Target)
AND
GetFlag((FLAG)ORI_Astarion_State_GameplayBiteVictim_487360df-d763-4e22-bd0d-cf5aa4762843, _Target, 0)
THEN
SetFlag((FLAG)ORI_Astarion_State_GameplayBiteVictim_487360df-d763-4e22-bd0d-cf5aa4762843, _Target); // checked in a dialog

PROC
PROC_ORI_Astarion_VampireBiteFinished((CHARACTER)_Target, (INTEGER)_StoryActionID)
AND
DB_Players(_Target)
AND
NOT DB_Avatars(_Target)
AND
ChangeApprovalRating(_Target, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0, -5, _)
THEN
DB_NOOP(1);

// first time we bite Gale we play a custom reaction because Gale's blood is disgusting for Astarion
// we do that even if we already had another character reacting to Astarion's bite before
PROC
PROC_ORI_Astarion_VampireBiteFinished((CHARACTER)_Target, (INTEGER)_StoryActionID)
AND
_Target == S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
DB_Sees((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
QRY_OnlyOnce("ORI_Astarion_GaleReactedToGameplayBite")
THEN
PROC_ORI_Astarion_BiteWitnessed_Intern(_Target, (DIALOGRESOURCE)ORI_AstarionIsAVamp_PAD_GaleWasBitten_529e12b5-dda9-fa5f-137d-413d003b85db);

// first time we bite Karlach we play a custom reaction because Karlach's body is hot and burns us
// we do that even if we already had another character reacting to Astarion's bite before
PROC
PROC_ORI_Astarion_VampireBiteFinished((CHARACTER)_Target, (INTEGER)_StoryActionID)
AND
QRY_ORI_Astarion_IsKarlachNoTouch(_Target)
AND
DB_Sees(_Target, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
QRY_OnlyOnce("ORI_Astarion_KarlachNoTouchReactedToGameplayBite")
THEN
PROC_ORI_Astarion_BiteWitnessed_Intern(_Target, (DIALOGRESOURCE)ORI_AstarionIsAVamp_PAD_KarlachWasBitten_3c6a6cb3-bec4-f9dc-a546-a3b7e36048ee);

// can't normally touch Karlach's body till she gets upgraded, her body is too hot
QRY
QRY_ORI_Astarion_IsKarlachNoTouch((CHARACTER)_Target)
AND
_Target == S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c
AND
NOT DB_GlobalFlag((FLAG)GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c)
THEN
DB_NOOP(1);

// if we bite Gale or Karlach No Touch, but they don't see us
// or if we bite someone else then flag PartyWitnessedBite is not set
// and we need to find another witness
// by default we prefer the target of the bite
PROC
PROC_ORI_Astarion_VampireBiteFinished((CHARACTER)_Target, (INTEGER)_StoryActionID)
AND
QRY_ORI_Astarion_GameplayBiteTargetIsWitness(_Target)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_PartyWitnessedBite_145d874f-db54-475e-98ab-edcc55c08262)
THEN
PROC_ORI_Astarion_BiteWitnessed_Intern(_Target, (DIALOGRESOURCE)ORI_AstarionIsAVamp_PAD_c992d43f-b55b-2e55-24e7-901f8ce46896);

PROC
PROC_ORI_Astarion_VampireBiteFinished((CHARACTER)_Target,(INTEGER)_StoryActionID)
AND
NOT QRY_ORI_Astarion_GameplayBiteTargetIsWitness(_Target)
AND
DB_Players(_Witness)
AND
_Witness != _Target
AND
_Witness != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
DB_Sees(_Witness, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_PartyWitnessedBite_145d874f-db54-475e-98ab-edcc55c08262)
THEN
PROC_ORI_Astarion_BiteWitnessed_Intern(_Witness, (DIALOGRESOURCE)ORI_AstarionIsAVamp_PAD_c992d43f-b55b-2e55-24e7-901f8ce46896);

QRY
QRY_ORI_Astarion_GameplayBiteTargetIsWitness((CHARACTER)_Target)
AND
DB_Players(_Target)
AND
_Target != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
DB_Sees(_Target, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
DB_NOOP(1);

PROC
PROC_ORI_Astarion_BiteWitnessed_Intern((CHARACTER)_Witness, (DIALOGRESOURCE)_WitnessPAD)
AND
NOT DB_GlobalFlag(ORI_Astarion_State_PartyWitnessedBite_145d874f-db54-475e-98ab-edcc55c08262)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_State_PartyWitnessedBite_145d874f-db54-475e-98ab-edcc55c08262);

PROC
PROC_ORI_Astarion_BiteWitnessed_Intern((CHARACTER)_Witness, (DIALOGRESOURCE)_WitnessPAD)
THEN
DB_ORI_Astarion_BiteWitness((CHARACTER)_Witness, (DIALOGRESOURCE)_WitnessPAD);
PROC_ORI_Astarion_BiteWitnessed(_Witness, (DIALOGRESOURCE)_WitnessPAD);

PROC
PROC_ORI_Astarion_BiteWitnessed((CHARACTER)_Witness, (DIALOGRESOURCE)_WitnessPAD)
AND
NOT QRY_StartDialog_Fixed(_WitnessPAD, _Witness, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255) // fallback in case the dialog fails (perhaps, victim dies from the bite)
THEN
NOT DB_ORI_Astarion_BiteWitness((CHARACTER)_Witness, (DIALOGRESOURCE)_WitnessPAD);
PROC_ORI_Astarion_CheckSetUpForcedPartyDiscussionAfterPAD((CHARACTER)_Witness);

// main flow when the dialog successfully starts
// after it ends we setup InParty discussion
IF
AutomatedDialogEnded(_WitnessPAD, _)
AND
DB_ORI_Astarion_BiteWitness(_Witness, _WitnessPAD)
THEN
NOT DB_ORI_Astarion_BiteWitness((CHARACTER)_Witness, (DIALOGRESOURCE)_WitnessPAD);
PROC_ORI_Astarion_CheckSetUpForcedPartyDiscussionAfterPAD((CHARACTER)_Witness);

PROC
PROC_ORI_Astarion_CheckSetUpForcedPartyDiscussionAfterPAD((CHARACTER)_Witness)
AND
DB_Avatars(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_State_PartyNeedsToDiscussBite_c3f96c88-b404-497f-b287-e3453e334c94);
PROC_ORI_Astarion_SetUpForcedPartyDiscussion(_Witness, 500);

// Force Reveal after Gur Hunter dialog for Avatar
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)ORI_Astarion_State_GurHunterForceReveal_21836280-71de-4895-8c47-c0b3e225c127)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
AND
DB_Players(_CompanionNearby)
AND
DB_Origins(_CompanionNearby)
AND
_CompanionNearby != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
GetDistanceTo(_CompanionNearby, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Dist)
AND
_Dist < 10
AND
QRY_OnlyOnce("ORI_Astarion_ForcedIdentityReveal")
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_State_PartyNeedsToDiscussAstarionsIdentity_25ed2869-3fdc-4f74-8acd-0adaba69c41e);
PROC_ORI_Astarion_SetUpForcedPartyDiscussion(_CompanionNearby, 1000);

// if we enter CRE or SCL without learning about Astarion's nature
// then we force an InParty discussion where the companions reveal
// that they know his nature
IF
DB_InRegion(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Trigger)
AND
DB_Avatars(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_ORI_Astarion_ForceIdentityDiscussionTriggers(_Trigger)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
AND
DB_Players(_OtherCompanion)
AND
_OtherCompanion != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
DB_OriginInPartyDialog(_OtherCompanion, _)
AND
QRY_OnlyOnce("ORI_Astarion_ForcedIdentityReveal")
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_State_PartyNeedsToDiscussAstarionsIdentity_25ed2869-3fdc-4f74-8acd-0adaba69c41e);
PROC_ORI_Astarion_SetUpForcedPartyDiscussion(_OtherCompanion, 5000); // big delay right after we transitioned to a new level

// we pretty much don't care what caused the forced in party discussion in scripting
// InParty dialogs have separate greeting nodes for each cause
PROC
PROC_ORI_Astarion_SetUpForcedPartyDiscussion((CHARACTER)_Companion, (INTEGER)_InitialTimer)
AND
QRY_ORI_Astarion_SelectCompanionForInPartyDiscussion(_Companion)
AND
DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion(_SelectedCompanion)
THEN
DB_ORI_Astarion_LaunchInPartyDiscussionAfterTimerIsFinished((CHARACTER)_SelectedCompanion);
ObjectTimerLaunch(_SelectedCompanion, "ORI_Astarion_ForcedInPartyDiscussion", _InitialTimer);
DB_ORI_Astarion_CompanionForInPartyDiscussion((CHARACTER)_SelectedCompanion);

QRY
QRY_ORI_Astarion_SelectCompanionForInPartyDiscussion((CHARACTER)_Companion)
AND
DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion(_SelectedCompanion)
THEN
NOT DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion(_SelectedCompanion);

// we prefer the target of the bite if it is a companion that belongs to the same user as Astarion and if it is in range
QRY
QRY_ORI_Astarion_SelectCompanionForInPartyDiscussion((CHARACTER)_Companion)
AND
DB_Players(_Companion)
AND
NOT DB_Avatars(_Companion)
AND
QRY_SameUser(_Companion, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
QRY_SpeakerIsInDialogRange(_Companion, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255) // it's ok if the companion is not currently available
THEN
DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion((CHARACTER)_Companion);

// if we couldn't take the initial target, then take the next best non-avatar companion of the same user
QRY
QRY_ORI_Astarion_SelectCompanionForInPartyDiscussion((CHARACTER)_Companion)
AND
DB_Players(_OtherCompanion)
AND
NOT DB_Avatars(_OtherCompanion)
AND 
_OtherCompanion != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
QRY_SameUser(_OtherCompanion, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
QRY_SpeakerIsInDialogRange(_OtherCompanion, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255) // it's fine if not available (e.g. in a fight)
AND
QRY_IsEmptyDB("DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion", 1)
THEN
DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion((CHARACTER)_OtherCompanion);

// if we failed to find a non-avatar companion for the same user for an interactive dialog
// then we try a voicebark between avatars instead, but this will only work if both avatars belong to the same user
// it's fine if it fails, it's a fallback voicebark
QRY
QRY_ORI_Astarion_SelectCompanionForInPartyDiscussion((CHARACTER)_Companion)
AND
DB_Avatars(_Companion)
AND 
_Companion != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
QRY_SpeakerIsInDialogRange(_Companion, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
QRY_IsEmptyDB("DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion", 1)
THEN
DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion((CHARACTER)_Companion);

// in case the initial target is no longer in the range we need to try other companions
QRY
QRY_ORI_Astarion_SelectCompanionForInPartyDiscussion((CHARACTER)_Companion)
AND
DB_Avatars(_OtherCompanion)
AND 
_OtherCompanion != _Companion
AND 
_OtherCompanion != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
QRY_SpeakerIsInDialogRange(_OtherCompanion, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
QRY_IsEmptyDB("DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion", 1)
THEN
DB_QRYTN_ORI_Astarion_SelectedCompanionForInPartyDiscussion((CHARACTER)_OtherCompanion);

// if the initial timer ended, but we didn't launch the dialog
// then we re-start the timer
IF
DB_ORI_Astarion_CompanionForInPartyDiscussion(_Companion)
AND
DB_Sees(_Companion, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_CantTalk(_Companion)
AND
NOT DB_CantTalk(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_ORI_Astarion_LaunchInPartyDiscussionAfterTimerIsFinished(_)
THEN
DB_ORI_Astarion_LaunchInPartyDiscussionAfterTimerIsFinished((CHARACTER)_Companion);
ObjectTimerLaunch(_Companion, "ORI_Astarion_ForcedInPartyDiscussion", 2000);

// companion left the party before the whole "Astarion is a Vampire" thing got resolved
IF
DB_ORI_Astarion_CompanionForInPartyDiscussion(_Companion)
AND
NOT DB_Players(_Companion)
THEN
NOT DB_ORI_Astarion_CompanionForInPartyDiscussion(_Companion);
NOT DB_ORI_Astarion_LaunchInPartyDiscussionAfterTimerIsFinished((CHARACTER)_Companion);
ObjectTimerCancel(_Companion, "ORI_Astarion_ForcedInPartyDiscussion");
PROC_ORI_Astarion_SetUpForcedPartyDiscussion(_Companion, 500); // this will find a new companion

// interactive dialog for a non-avatar char
IF
ObjectTimerFinished((CHARACTER)_Companion, "ORI_Astarion_ForcedInPartyDiscussion")
AND
DB_ORI_Astarion_LaunchInPartyDiscussionAfterTimerIsFinished(_Companion)
AND
NOT DB_Avatars(_Companion)
AND
DB_OriginInPartyDialog(_Companion, _Dialog)
AND
QRY_StartDialog_Fixed(_Dialog, _Companion, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
NOT DB_ORI_Astarion_CompanionForInPartyDiscussion(_Companion);

// if we start an InParty dialog before the timer is finished
// or QRY_StartDialog from the above failed, but actually started an InParty dialog
// we do the clean up
IF
DialogStarted(_Dialog, _)
AND
DB_OriginInPartyDialog(_, _Dialog)
AND
DB_ORI_Astarion_CompanionForInPartyDiscussion(_Companion)
THEN
NOT DB_ORI_Astarion_CompanionForInPartyDiscussion(_Companion);
ObjectTimerCancel(_Companion, "ORI_Astarion_ForcedInPartyDiscussion");

// voicebark for an avatar char
IF
ObjectTimerFinished((CHARACTER)_Companion, "ORI_Astarion_ForcedInPartyDiscussion")
AND
DB_ORI_Astarion_LaunchInPartyDiscussionAfterTimerIsFinished(_Companion)
AND
DB_Avatars(_Companion)
AND
DB_OriginInPartyDialog(_Companion, _Dialog)
THEN
StartVoiceBark((VOICEBARKRESOURCE)ORI_Astarion_VB_VampiricNatureDiscussion_355ac4b5-d0da-8527-0de2-fc4b49c1da85, _Companion);
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
NOT DB_ORI_Astarion_CompanionForInPartyDiscussion(_Companion);

IF
ObjectTimerFinished((CHARACTER)_Companion, "ORI_Astarion_ForcedInPartyDiscussion")
THEN
NOT DB_ORI_Astarion_LaunchInPartyDiscussionAfterTimerIsFinished((CHARACTER)_Companion);

IF
VoiceBarkEnded((VOICEBARKRESOURCE)ORI_Astarion_VB_VampiricNatureDiscussion_355ac4b5-d0da-8527-0de2-fc4b49c1da85, _)
THEN
PROC_ORI_Astarion_ClearForcedDiscussionFlags();

// voicebarks require separate handling for failures
IF
VoiceBarkFailed((VOICEBARKRESOURCE)ORI_Astarion_VB_VampiricNatureDiscussion_355ac4b5-d0da-8527-0de2-fc4b49c1da85)
THEN
PROC_ORI_Astarion_ClearForcedDiscussionFlags();

PROC
PROC_ORI_Astarion_ClearForcedDiscussionFlags()
AND
DB_ORI_Astarion_ForcedInPartyDiscussionFlags(_Flag)
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

// these flags are also cleared in the interactive dialog
IF
FlagCleared(_Flag, _, _)
AND
DB_ORI_Astarion_ForcedInPartyDiscussionFlags(_Flag)
THEN
PROC_ORI_Astarion_CleanUpForcedDiscussion();

PROC
PROC_ORI_Astarion_CleanUpForcedDiscussion()
AND
DB_ORI_Astarion_LaunchInPartyDiscussionAfterTimerIsFinished(_Companion)
THEN
ObjectTimerCancel(_Companion, "ORI_Astarion_ForcedInPartyDiscussion");
NOT DB_ORI_Astarion_LaunchInPartyDiscussionAfterTimerIsFinished(_Companion);

PROC
PROC_ORI_Astarion_CleanUpForcedDiscussion()
AND
DB_ORI_Astarion_CompanionForInPartyDiscussion(_Companion)
THEN
NOT DB_ORI_Astarion_CompanionForInPartyDiscussion(_Companion);

PROC
PROC_ORI_Astarion_CleanUpForcedDiscussion()
AND
DB_ORI_Astarion_BiteWitness(_Witness, _WitnessPAD)
THEN
NOT DB_ORI_Astarion_BiteWitness(_Witness, _WitnessPAD);
//END_REGION

//REGION Astarion wants to talk about Cazador
IF
DB_CurrentLevel("BGO_Main_A")
AND
DB_PartyMembers((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_DiscussedCazadorAfterSCL_1d23b665-e2c1-4d61-9c53-25aff637529f)
AND
NOT DB_GlobalFlag((FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac)
AND
NOT DB_RelationshipDialogsFinished((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_State_NeedsToDiscussCazadorAfterSCL_3c1b76cd-6d29-4780-b1b0-cfb5ffbb7bf6)
AND
NOT DB_OnlyOnce("ORI_Astarion_WYR_CazadorDiscussion")
THEN
DB_OnlyOnce("ORI_Astarion_WYR_CazadorDiscussion");
PROC_RelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, ORI_Astarion_State_NeedsToDiscussCazadorAfterSCL_3c1b76cd-6d29-4780-b1b0-cfb5ffbb7bf6, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0);
//END_REGION 

//REGION Companion Journal
//MetRaphaelHaven_NoInfo
IF
DialogStarted((DIALOGRESOURCE)HAV_MolsDeal_Raphael_f7a2c41b-2b2c-c91e-faf2-b8f6ccdede44, _)
THEN
SetFlag(ORI_Astarion_State_MetRaphaelAtHaven_89fe5dde-24f8-4ff8-9560-bfd667c18d64);

IF
DialogStarted((DIALOGRESOURCE)HAV_MolsDeal_Lanceboard_ThreeWay_3fc20a5a-83a6-e4a9-d9c2-536b0558ec2c, _)
THEN
SetFlag(ORI_Astarion_State_MetRaphaelAtHaven_89fe5dde-24f8-4ff8-9560-bfd667c18d64);

PROC
PROC_HAV_MolsDeal_MonitorPoof()
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_MetRaphaelAtHaven_89fe5dde-24f8-4ff8-9560-bfd667c18d64)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_RequestedConversationWithRaphael_0f717745-2fbf-465a-8ada-51bb94919378)
AND
NOT DB_GlobalFlag((FLAG)HAV_MolsDeal_State_Lanceboard_ThreeWay_AstarionAskedRaphael_e1fabb89-91f2-d95f-a0e7-2870baebbaae)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9)
THEN
SetFlag(ORI_Astarion_State_RaphaelLeftHavenNoInfo_dc012756-d655-4bae-803f-a7741d5cfdd8);

PROC
PROC_HAV_MolsDeal_MonitorPoof()
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_MetRaphaelAtHaven_89fe5dde-24f8-4ff8-9560-bfd667c18d64)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_RequestedConversationWithRaphael_0f717745-2fbf-465a-8ada-51bb94919378)
AND
NOT DB_GlobalFlag((FLAG)HAV_MolsDeal_State_Lanceboard_ThreeWay_AstarionAskedRaphael_e1fabb89-91f2-d95f-a0e7-2870baebbaae)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9)
THEN
SetFlag(ORI_Astarion_State_RaphaelLeftHavenNoInfo_NoScars_051a4f2e-63bf-4578-a7ac-d8f35578ccd7);

IF
FlagSet((FLAG)ORI_Astarion_State_RaphaelLeftMasoleumEntrance_ee881edf-2d4d-40a2-a6f1-c790a01c9ed5, _, _)
AND
DB_QuestIsOpened("ORI_COM_Astarion")
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9)
AND
QRY_ORI_Astarion_IsSeekingRaphael()
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "RaphaelLeftNoInfo");

IF
FlagSet((FLAG)ORI_Astarion_State_RaphaelLeftMasoleumEntrance_ee881edf-2d4d-40a2-a6f1-c790a01c9ed5, _, _)
AND
DB_QuestIsOpened("ORI_COM_Astarion")
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9)
AND
QRY_ORI_Astarion_IsSeekingRaphael()
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "RaphaelLeftNoInfo_NoScars");

QRY
QRY_ORI_Astarion_IsSeekingRaphael()
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "ORI_COM_Astarion", "AstarionToldRaphael_NoScars", 1)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Astarion_IsSeekingRaphael()
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "ORI_COM_Astarion", "AstarionToldRaphael", 1)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Astarion_IsSeekingRaphael()
AND
DB_GlobalFlag((FLAG)HAV_MolsDeal_State_Lanceboard_ThreeWay_AstarionAskedRaphael_e1fabb89-91f2-d95f-a0e7-2870baebbaae)
THEN
DB_NOOP(1);

PROC
PROC_LevelLoadedOnce("END_Main")
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438)
AND
DB_QuestIsOpened("ORI_COM_Astarion")
THEN
SetFlag((FLAG)ORI_Astarion_State_LeftToEndNoCazador_eb702db1-b81f-4316-8b1e-667500fa3ca8);

PROC
PROC_LevelLoadedOnce("END_Main")
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438)
AND
DB_QuestIsOpened("ORI_Avatar_Astarion")
THEN
SetFlag((FLAG)ORI_Astarion_State_LeftToEndNoCazador_eb702db1-b81f-4316-8b1e-667500fa3ca8);
//END_REGION

//REGION Avatar Journal
PROC
PROC_LevelLoadedOnce("WLD_Main_A")
AND
DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", "Start");

// Gale-specific
IF
DialogEnded(CAMP_AstarionHunger_IVB_SCO_Avatar_Choice_731b7b80-cbc9-9db4-dcc7-3e92b9c5087c, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_Bite_CompanionLeft_ac7f524a-c51f-45be-8f51-cf66b5def2e9)
AND
DB_GlobalFlag((FLAG)CAMP_AstarionAvatar_DrankGaleBlood_296a74f4-4a62-2a59-8363-8f99048b9204)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_Bomb_810e296b-f01b-6457-e2c9-43db5c5c140d)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", "Bite_Gale_KnowsBomb");

IF
DialogEnded(CAMP_AstarionHunger_IVB_SCO_Avatar_Choice_731b7b80-cbc9-9db4-dcc7-3e92b9c5087c, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_Bite_CompanionLeft_ac7f524a-c51f-45be-8f51-cf66b5def2e9)
AND
DB_GlobalFlag((FLAG)CAMP_AstarionAvatar_DrankGaleBlood_296a74f4-4a62-2a59-8363-8f99048b9204)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_Bomb_810e296b-f01b-6457-e2c9-43db5c5c140d)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", "Bite_Gale_NoBomb");


PROC
PROC_HAV_MolsDeal_MonitorPoof()
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_MetRaphaelAtHaven_89fe5dde-24f8-4ff8-9560-bfd667c18d64)
AND
DB_GlobalFlag((FLAG)NIGHT_Astarion_CazadorNightmare_SecondDream_c4214d0e-ed58-49ba-9d44-e1ce8366fc87)
AND
NOT DB_GlobalFlag((FLAG)HAV_MolsDeal_State_Lanceboard_ThreeWay_AstarionAskedRaphael_e1fabb89-91f2-d95f-a0e7-2870baebbaae)
THEN
SetFlag(ORI_Astarion_State_RaphaelLeftHavenNoInfo_dc012756-d655-4bae-803f-a7741d5cfdd8);

IF
FlagSet(ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, _, _ID)
AND
DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_PartyNeedsToDiscussAstarionsIdentity_25ed2869-3fdc-4f74-8acd-0adaba69c41e)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_PartyNeedsToDiscussCampNightBite_4fb192a2-a068-461e-b23e-9dd517f77fda)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_PartyNeedsToDiscussGameplayBite_c3f96c88-b404-497f-b287-e3453e334c94)
AND
NOT DB_DialogName((DIALOGRESOURCE)CAMP_AstarionHunger_IVB_SCO_Avatar_Choice_731b7b80-cbc9-9db4-dcc7-3e92b9c5087c, _ID)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", "GameplayBiteReveal", 0)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", "Act1LeftReveal", 0)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", "TruthReveal");

IF
FlagSet((FLAG)OR_Astarion_State_PreRitualSceneEnded_8e60ef2f-d3cc-49b2-a552-70a545caceed, _, _)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_Cazador_State_FetchingAstarion_a2d019a4-164c-1028-e2ae-8651b3e4cf08)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_TeleportAstarion_1318f561-8b32-4ac2-bb85-a4f2b93f53d4)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "FoundCazador_Fetching_Ritual");

IF
FlagSet((FLAG)OR_Astarion_State_PreRitualSceneEnded_8e60ef2f-d3cc-49b2-a552-70a545caceed, _, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_Cazador_State_FetchingAstarion_a2d019a4-164c-1028-e2ae-8651b3e4cf08)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_TeleportAstarion_1318f561-8b32-4ac2-bb85-a4f2b93f53d4)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "FoundCazador_Ritual");

IF
FlagSet((FLAG)OR_Astarion_State_PreRitualSceneEnded_8e60ef2f-d3cc-49b2-a552-70a545caceed, _, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_Cazador_State_FetchingAstarion_a2d019a4-164c-1028-e2ae-8651b3e4cf08)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_TeleportAstarion_1318f561-8b32-4ac2-bb85-a4f2b93f53d4)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "FoundCazador_NoRitual");
//END_REGION

//REGION Journal common
IF
FlagSet((FLAG)WYR_VampireSpawns_State_MovedToCazador_a03cf538-552c-a672-db83-10e9ceaf99e2, _, _)
AND
DB_GlobalFlag((FLAG)WYR_VampireSpawns_State_ToldAscension_a48047ea-da16-4451-838d-d129ed8ecbae)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_RitualLocation_9d64bed2-d3b1-8751-f208-2865fffa6129)
AND
QuestIsAccepted((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", 1)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", "MetFlophouseSpawns");

IF
FlagSet((FLAG)WYR_VampireSpawns_State_MovedToCazador_a03cf538-552c-a672-db83-10e9ceaf99e2, _, _)
AND
DB_GlobalFlag((FLAG)WYR_VampireSpawns_State_ToldAscension_a48047ea-da16-4451-838d-d129ed8ecbae)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_Knows_RitualLocation_9d64bed2-d3b1-8751-f208-2865fffa6129)
AND
QuestIsAccepted((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", 1)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Avatar_Astarion", "MetFlophouseSpawns_Ritual");

IF
FlagSet((FLAG)WYR_VampireSpawns_State_MovedToCazador_a03cf538-552c-a672-db83-10e9ceaf99e2, _, _)
AND
DB_GlobalFlag((FLAG)WYR_VampireSpawns_State_ToldAscension_a48047ea-da16-4451-838d-d129ed8ecbae)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_RitualLocation_9d64bed2-d3b1-8751-f208-2865fffa6129)
AND
QuestIsAccepted((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", 1)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "MetFlophouseSpawns");

IF
FlagSet((FLAG)WYR_VampireSpawns_State_MovedToCazador_a03cf538-552c-a672-db83-10e9ceaf99e2, _, _)
AND
DB_GlobalFlag((FLAG)WYR_VampireSpawns_State_ToldAscension_a48047ea-da16-4451-838d-d129ed8ecbae)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_Knows_RitualLocation_9d64bed2-d3b1-8751-f208-2865fffa6129)
AND
QuestIsAccepted((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", 1)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "MetFlophouseSpawns_Ritual");
//END_REGION

//REGION Camp
// Block the companions from moving to their default camp positions when they discuss something in PADs
IF
DialogActorJoined((DIALOGRESOURCE)_Dialog, _, _Actor, _)
AND
DB_CAMP_Astarion_StandingStillDialogs(_Dialog)
THEN
SetFlag((FLAG)GLO_CAMP_StandingStill_776de2de-871c-4cf4-bcbb-72d26f244489, _Actor);

IF
DialogActorJoined((DIALOGRESOURCE)_Dialog, _, _Actor, _)
AND
DB_CAMP_Astarion_StandingStillDialogs(_Dialog)
AND
DB_CAMP_Astarion_StandingStillDialogs_SteerTo(_Victim)
THEN
SteerTo((CHARACTER)_Actor, _Victim, 1);
NOT DB_CAMP_Astarion_StandingStillDialogs_SteerTo(_Victim);

IF
DialogActorLeft((DIALOGRESOURCE)_Dialog, _, _Actor, _)
AND
DB_CAMP_Astarion_StandingStillDialogs(_Dialog)
THEN
ClearFlag((FLAG)GLO_CAMP_StandingStill_776de2de-871c-4cf4-bcbb-72d26f244489, _Actor);

// Companion that we killed should be removed from the camp after the next long rest
IF
DB_CAMP_Astarion_BiteSceneMurderVictim(_Victim)
THEN
DB_CAMP_Astarion_CleanupCorpseAfterNextLongRest((CHARACTER)_Victim); // helper db, because DB_CAMP_Astarion_BiteSceneMurderVictim will be cleaned
DB_CAMP_Astarion_StandingStillDialogs_SteerTo(_Victim);
DB_CorpseCleanup_Ignore(_Victim);

// we need to remove the corpse before the next long rest
// ideally - remove as soon as all players leave the camp
IF
DB_CAMP_Astarion_CleanupCorpseAfterNextLongRest(_Victim)
AND
NOT DB_PlayerInCamp(_)
THEN
NOT DB_CorpseCleanup_Ignore(_Victim);
NOT DB_CAMP_Astarion_CleanupCorpseAfterNextLongRest(_Victim);
PROC_CAMP_Astarion_RemoveBiteVictim(_Victim);

// in case the player took another long rest without leaving the camp remove when switching to the night mode
PROC
PROC_Camp_SetModeToNight()
AND
DB_CAMP_Astarion_CleanupCorpseAfterNextLongRest(_Victim)
THEN
NOT DB_CorpseCleanup_Ignore(_Victim);
NOT DB_CAMP_Astarion_CleanupCorpseAfterNextLongRest(_Victim);
PROC_CAMP_Astarion_RemoveBiteVictim(_Victim);

// remove the corpse with some additional checks just in case
PROC
PROC_CAMP_Astarion_RemoveBiteVictim((CHARACTER)_Corpse)
AND
IsInInventory(_Corpse, 0)
AND
NOT DB_OffStage(_Corpse)
THEN
PROC_CorpseCleanup_RemoveCorpse((CHARACTER)_Corpse);
//END_REGION

//REGION Dark Urge IPRD
IF
FlagSet(_Flag, _, _)
AND
DB_ORI_Astarion_IPRDWorthyDarkUrgeMoment(_Flag)
THEN
PROC_ORI_Astarion_DUFirstDiscussion();

IF
DialogEnded((DIALOGRESOURCE)CAMP_FirstNight_AvD_PostEA_69e79939-6148-1b93-d654-e54374ef9353, _ID)
AND
DB_ORI_DarkUrge(_Urge)
AND
DB_DialogPlayers(_ID, _Urge, _)
THEN
DB_ORI_Astarion_ScheduleDarkUrgeFirstDiscussion(1);

PROC
PROC_CampNight_StartMorningMoments()
AND
DB_ORI_Astarion_ScheduleDarkUrgeFirstDiscussion(1)
THEN
NOT DB_ORI_Astarion_ScheduleDarkUrgeFirstDiscussion(1);
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_DarkUrge_FirstDiscussion_49cf2a9e-341e-49f9-ac10-01e2490d556f);
PROC_ORI_Astarion_DUFirstDiscussion();

PROC
PROC_ORI_Astarion_DUFirstDiscussion()
AND
DB_Players((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_ORI_DarkUrge(_Urge)
AND
QRY_SameUser((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Urge)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_DarkUrge_FirstDiscussion_49cf2a9e-341e-49f9-ac10-01e2490d556f, _Urge, 0, 0);


QRY
QRY_SelectCustomDialog(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Avatar)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_DarkUrge_FirstDiscussion_49cf2a9e-341e-49f9-ac10-01e2490d556f, _, _, _)
AND
QRY_SameUser((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Avatar)
AND
NOT DB_ORI_DarkUrge(_Avatar)
THEN
DB_SelectedDialog(GLO_AD_NonBondedCompanionDialog_62ba7c46-8d22-c591-f04c-2e99441cd02a, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

PROC
PROC_CAMP_LeftCamp((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_DarkUrge_FirstDiscussion_49cf2a9e-341e-49f9-ac10-01e2490d556f, _, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_DarkUrge_FirstDiscussion_49cf2a9e-341e-49f9-ac10-01e2490d556f);

IF
CharacterReservedUserIDChanged((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _, _)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_DarkUrge_FirstDiscussion_49cf2a9e-341e-49f9-ac10-01e2490d556f, _, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_DarkUrge_FirstDiscussion_49cf2a9e-341e-49f9-ac10-01e2490d556f);
//END_REGION

//REGION Sun Lance
IF
TextEvent("ast_sunlance")
THEN
Die(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 3.0);
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_State_WantsToDiscussSunLance_affe619d-8c66-4982-8273-22ee89f240e2);

//When Astarion dies in game, he is teleported to the camp
IF
Resurrected((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_WantsToDiscussSunLance_affe619d-8c66-4982-8273-22ee89f240e2)
THEN
PROC_GlobalClearFlagAndCache((FLAG)ORI_Astarion_State_WantsToDiscussSunLance_affe619d-8c66-4982-8273-22ee89f240e2);
DB_ORI_Astarion_ResurrectedAfterSunlance(1);

IF
DB_ORI_Astarion_ResurrectedAfterSunlance(1)
AND
NOT DB_CantTalk(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_InCamp(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
NOT DB_ORI_Astarion_ResurrectedAfterSunlance(1);
PROC_CampRelationshipDialog(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_Sunlance_ecefaa19-1962-42b0-9965-2fff07b44527, 0);
PROC_Try_CampRelationshipDialog(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1);

IF
DB_ORI_Astarion_ResurrectedAfterSunlance(1)
AND
NOT DB_CantTalk(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_InCamp(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
NOT DB_ORI_Astarion_ResurrectedAfterSunlance(1);
PROC_RelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_Sunlance_ecefaa19-1962-42b0-9965-2fff07b44527, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0);
//END_REGION

//REGION IPRD about Tadpole consumption
PROC
PROC_DialogFlagSetup( Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Player)
AND
GetFlag(ORI_Astarion_IPRD_TadpolePowers_State_HasTadpoleJar_f0b7c2d7-659c-4b95-a4d3-9bee3f64e725, _Player, 1)
THEN
ClearFlag(ORI_Astarion_IPRD_TadpolePowers_State_HasTadpoleJar_f0b7c2d7-659c-4b95-a4d3-9bee3f64e725, _Player);

PROC
PROC_DialogFlagSetup( Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Player)
AND
QRY_ORI_Astarion_HasTadpoleJar((CHARACTER)_Player)
THEN
SetFlag((FLAG)ORI_Astarion_IPRD_TadpolePowers_State_HasTadpoleJar_f0b7c2d7-659c-4b95-a4d3-9bee3f64e725, _Player);

QRY
QRY_ORI_Astarion_HasTadpoleJar((CHARACTER)_Player)
AND
DB_TadpolePowers_TadpolePowerJar_Templates(_TadpoleJar)
AND
QRY_ItemTemplateInMagicPockets(_Player, (ITEMROOT)_TadpoleJar)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Astarion_HasTadpoleJar((CHARACTER)_Player)
AND
PartyGetActionResourceValue(_Player, "TadpolePowerPoint", _Amount)
AND
_Amount >= 1.0
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)GLO_Tadpole_Consume_b8af6722-476f-9d04-d36d-484db6e0d56f, _ID)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
_Player != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
DB_Players(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1, 1)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Avatar)
AND
_Player == _Avatar
AND
QRY_OnlyOnce("ORI_Astarion_IPRD_TadpolePowers")
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_TadpolePowers_257a1233-7539-4e92-8a9e-d43d3df16935, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0);
//END_REGION

//REGION InParty branches
IF
FlagSet((FLAG)ORI_Astarion_State_RaphaelToldRitual_7b30820e-92e5-4f64-a2f5-92edbd9a0e2f, _, _)
THEN
DB_LongRestCountDown(2, (FLAG)ORI_Astarion_State_TwoDaysPassedAfterRaphaelToldRitual_11e1d367-03a8-421c-9618-9e8e9f654514);
//END_REGION

//REGION Gur Hunter global knowledge
IF
FlagSet((FLAG)HAG_GurHunter_HasMet_50a41bc8-ab94-463f-e403-0d10b8969087, _, _)
THEN
PROC_GlobalSetFlagAndCache(HAG_GurHunter_HasMet_Global_68eca456-15af-476f-954d-261364e03655);
//END_REGION

//REGION Quest Update about finding fellow spawns
IF
FlagSet((FLAG)ORI_Astarion_State_DiscussedCazadorAfterSCL_1d23b665-e2c1-4d61-9c53-25aff637529f, _, _)
AND
DB_GlobalFlag((FLAG)CURRENTREGION_INT_Main_A_7f78a1d7-3e5e-4cd2-8fcd-f751b01c0ee0)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "ToldOtherSpawns_INT");

IF
TextEvent("ast_spawns_int")
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "ToldOtherSpawns_INT");
DB_RelationshipDialogsFinished((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_State_NeedsToDiscussCazadorAfterSCL_3c1b76cd-6d29-4780-b1b0-cfb5ffbb7bf6);

IF
QuestUpdateUnlocked(_Player, "ORI_COM_Astarion", "ReachedBG")
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Astarion", "ToldOtherSpawns_INT")
THEN
QuestUpdate(_Player, "ORI_COM_Astarion", "ReachedBG_KnowSpawns");

IF
FlagSet((FLAG)ORI_Astarion_State_DiscussedCazadorAfterSCL_1d23b665-e2c1-4d61-9c53-25aff637529f, _, _)
AND
DB_GlobalFlag((FLAG)CURRENTREGION_BGO_Main_A_11239767-48ad-4879-8312-b9164b6e4978)
THEN
QuestUpdate((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_COM_Astarion", "ToldOtherSpawns_WYR");
//END_REGION

//REGION Scars Knowledge Fallback
// fallback in case PoemInfernal flag is somehow set, but the general Poem flag is not
// that should never be the case normally, but might occur due to an error in a dialog
IF
FlagSet((FLAG)ORI_Astarion_Knows_PoemInfernal_256ed5ae-356b-255c-bd82-e1cf2aa35c55, _, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8)
THEN
PROC_GlobalSetFlagAndCache(ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8);

// fallback in case the general Poem flag is set, but PartySawScars
// that should never be the case normally, but might occur due to an error in a dialog
IF
FlagSet((FLAG)ORI_Astarion_Knows_ScarsIsCazadorPoem_Global_e0384248-60ef-4ed3-9bbe-d751461c93b8, _, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_State_PartySawScars_32bbdc0b-6c04-2db1-75ce-df811a8646e9);
//END_REGION

//REGION General info about the ritual
IF
FlagSet((FLAG)ORI_Astarion_Knows_RitualsPurpose_d1dc0f8a-b77d-4e40-a501-a66e163b8376, _, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_RitualGeneralInfo_abfca940-2838-41f1-b7dd-142ebba67137)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_Knows_RitualGeneralInfo_abfca940-2838-41f1-b7dd-142ebba67137);

IF
FlagSet((FLAG)WYR_VampireSpawns_State_ToldAscension_a48047ea-da16-4451-838d-d129ed8ecbae, _, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_RitualGeneralInfo_abfca940-2838-41f1-b7dd-142ebba67137)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_Knows_RitualGeneralInfo_abfca940-2838-41f1-b7dd-142ebba67137);
//END_REGION

//REGION Astarion's bite for Tech QA
PROC
PROC_LevelLoadedOnce(_LevelName)
AND
DB_ORI_Astarion_LevelsToUnlockBite(_LevelName)
AND
DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
HasSpell((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "Target_VampireBite_Astarion", 0)
THEN
AddSpell(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "Target_VampireBite_Astarion", 0, 0);
//END_REGION

//REGION Unlocking the bite if Bite scene is skipped
IF
FlagSet((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5, _, _)
AND
NOT DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
HasSpell((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "Target_VampireBite_Astarion", 0)
THEN
AddSpell(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "Target_VampireBite_Astarion", 1, 0);
//END_REGION

//REGION Debug IPRDs
IF
TextEvent("ast_iprd_orthondone")
THEN
DB_RelationshipDialog_AutostartTryOnce((DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_OrthonDone_dad89770-bf05-4964-b2de-b5db12781c01);
PROC_RelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_IPRD_OrthonDone_dad89770-bf05-4964-b2de-b5db12781c01, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0);
//END_REGION

//REGION Tracking the "Dead" state for Astarion
// PermaDefeated doesn't work since he can be resurrected normally, just like the rest of the origins
IF
Died((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Astarion_State_Dead_90aeb953-d39f-413a-81ba-55df6672d1ca);

IF
Resurrected((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_Dead_90aeb953-d39f-413a-81ba-55df6672d1ca)
THEN
PROC_GlobalClearFlagAndCache((FLAG)ORI_Astarion_State_Dead_90aeb953-d39f-413a-81ba-55df6672d1ca);
//END_REGION

//REGION Learned Poem quest update
// due to the structure of the dialog both flags could be set during the dialog
// we only need to unlock one quest update
IF
DialogEnded((DIALOGRESOURCE)CAMP_GoblinHuntCelebration_SD_ROM_NightWithAstarion_f1f9ad82-3973-9307-7a9d-35c014ee2d68, _)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_Event_LearnedPoemInfernalForQuestUpdate_c54c2ac2-c8f7-49a3-8b82-c96e87d58cd4)
THEN
QuestUpdate("ORI_COM_Astarion", "NightPoem_Infernal");

IF
DialogEnded((DIALOGRESOURCE)CAMP_GoblinHuntCelebration_SD_ROM_NightWithAstarion_f1f9ad82-3973-9307-7a9d-35c014ee2d68, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Event_LearnedPoemInfernalForQuestUpdate_c54c2ac2-c8f7-49a3-8b82-c96e87d58cd4)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_Event_LearnedPoemNoInfernalForQuestUpdate_abe016a4-d1b6-429f-8ecf-da0ad89b0b76)
THEN
QuestUpdate("ORI_COM_Astarion", "NightPoem_NoInfernal");
//END_REGION

//REGION Fallback - we reached Act 3 without learning that Astarion is a vampire spawn
PROC
PROC_LevelLoadedOnce("BGO_Main_A")
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5)
THEN
SetFlag((FLAG)ORI_Astarion_Knows_Vampireness_43c71ab0-1aca-484a-950d-54106ae46da5);
SetFlag((FLAG)ORI_Astarion_Event_LearnedVampire_Act3Fallback_e051d5a7-cad0-4049-8110-1bf4605f8d89);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ModWrapper_Gustav"
