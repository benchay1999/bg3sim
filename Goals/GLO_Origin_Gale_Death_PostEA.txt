Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_ORI_Gale_SetupCurseProgression(1);

DB_ORI_Gale_WorsenCurse((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93);
DB_ORI_Gale_WorsenCurse((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8);
DB_ORI_Gale_WorsenCurse((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9);

DB_ORI_Gale_LastReactedToState(0);

DB_ORI_Gale_Avatar_BombStates(1, "ORI_GALE_BOMB1");
DB_ORI_Gale_Avatar_BombStates(2, "ORI_GALE_BOMB2");
DB_ORI_Gale_Avatar_BombStates(3, "ORI_GALE_BOMB3");

NOT DB_ORI_Gale_TradingMagicItem_TempGiven((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000, (ITEM)NULL_00000000-0000-0000-0000-000000000000, "");
DB_ORI_Gale_TradedItemCounterFlags(1, (FLAG)ORI_Gale_Event_TradedOneMagicItem_3a7705e0-7220-44c2-8a2a-2c261a6b8a3f);
DB_ORI_Gale_TradedItemCounterFlags(2, ORI_Gale_Event_TradedTwoMagicItems_7dc9b2d6-4b7d-4476-b2c1-ebdb2bf3b4e6);

DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicReminder_3834abc3-f70e-7bbf-b286-32b795cfc3c4);
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_MoonriseReminder_d0d39c07-f676-dafa-ab5f-d3c81fa3a9c0);
DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_MoonriseReminder_d0d39c07-f676-dafa-ab5f-d3c81fa3a9c0);
DB_ORI_Gale_ComplainADTimer(600000);

SetTag((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TAG)ORI_GALE_DONEWITHITEMS_f37724b5-9235-4ab2-8d65-78efcf50f95b);
KBSECTION
//REGION Setup - curse progression

IF
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_SetupCurseProgression(1)
AND
QRY_OnlyOnce("ORI_Gale_MagicItemNeed_Setup")
THEN
PROC_DeclareCounter("ORI_Gale_MagicItemNeed");
NOT DB_ORI_Gale_RegionCounter(5, (FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8);
DB_ORI_Gale_RegionCounter_New((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8);
DB_ORI_Gale_RegionCounter_New((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9);

IF
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_SetupCurseProgression(1)
AND
QRY_OnlyOnce("ORI_Gale_MagicItemNeed_Setup")
THEN
PROC_DeclareCounter("ORI_Gale_MagicItemNeed");
NOT DB_ORI_Gale_RegionCounter(3, (FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93);
DB_ORI_Gale_RegionCounter(2, (FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93);
NOT DB_ORI_Gale_RegionCounter(5, (FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8);
NOT DB_ORI_Gale_RegionCounter_New((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8);
NOT DB_ORI_Gale_RegionCounter_New((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9);

QRY
QRY_Camp_StartAvatarDream_CustomDialogStart(CAMP_FirstNight_AvD_PostEA_69e79939-6148-1b93-d654-e54374ef9353, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_CampNight_GaleTressym_ToGale()
AND
QRY_StartDialog_Fixed(CAMP_GaleTressymJoin_SD_75b4946d-4a78-bea3-e0d2-2dc9b5c05209, S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_CampNight_Completed((FLAG)NIGHT_FirstNightContemplation_9e5cfbe2-f4f3-4249-a1b7-142a7899277a); //Setting this so the Camp Clog Prevention system doesn't trigger because the normal dialog didn't load.
SetFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735);
SetFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93);
MakePlayerActive(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
DB_Camp_QueuedNight(NIGHT_FirstNightContemplation_9e5cfbe2-f4f3-4249-a1b7-142a7899277a)
AND
DB_ORI_Gale_BlockWorsenBomb(1)
THEN
DB_ORI_Gale_SkipWorsenBombDialog(1);

IF
DB_Camp_QueuedNight((FLAG)NIGHT_Gale_TressymJoin_7ca98d47-e9fa-4f87-8728-8e56c4ee652d)
AND
DB_ORI_Gale_BlockWorsenBomb(1)
THEN
DB_ORI_Gale_SkipWorsenBombDialog(1);

//END_REGION

//REGION Gale Avatar's state worsens
//Temp debug option.
IF
StatusApplied(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_AVATAR_CONSUMEITEM", _, _)
THEN
PROC_ORI_Gale_ConsumedMagicItem();

PROC
PROC_ORI_Gale_ConsumedMagicItem()
THEN
PROC_DecreaseCounter("ORI_Gale_MagicItemNeed");

IF
FlagSet(_Flag, _, _)
AND
DB_ORI_Gale_WorsenCurse(_Flag)
THEN
PROC_IncreaseCounter("ORI_Gale_MagicItemNeed");

IF
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotWorseOnce_0918e4e1-0ccd-678c-fdcf-70f197856d11)
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
_Need > _LastHandled
AND
NOT DB_Camp_NightMode(1)
AND
NOT DB_ORI_Gale_BlockWorsenBomb(1)
AND
DB_DialogSpeakers(_ID, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
DB_DialogName(_Dialog, _ID)
AND
NOT DB_ORI_Gale_SkipWorsenBombDialog(1)
AND
_Dialog != GLO_Gale_AvatarWorsens_b5c348c4-352b-fe86-da33-8fbacf1a13bc
AND
_Dialog != ORI_Gale_AD_AvatarWorsens_06cccefa-c1a3-f117-aaf1-cb43cbb76adb
THEN
PROC_ForceStopDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotWorseOnce_0918e4e1-0ccd-678c-fdcf-70f197856d11)
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
_Need > _LastHandled
AND
NOT DB_Camp_NightMode(1)
AND
NOT DB_ORI_Gale_BlockWorsenBomb(1)
AND
NOT DB_ORI_Gale_SkipWorsenBombDialog(1)
AND
NOT DB_DialogSpeakers(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
DB_DialogRequestCache_SpeakerList_Speakers(_Dialog, _, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
_Dialog != GLO_Gale_AvatarWorsens_b5c348c4-352b-fe86-da33-8fbacf1a13bc
AND
_Dialog != ORI_Gale_AD_AvatarWorsens_06cccefa-c1a3-f117-aaf1-cb43cbb76adb
THEN
PROC_ForceStopDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotWorseOnce_0918e4e1-0ccd-678c-fdcf-70f197856d11)
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
_Need > _LastHandled
AND
NOT DB_Camp_NightMode(1)
AND
NOT DB_ORI_Gale_BlockWorsenBomb(1)
AND
NOT DB_ORI_Gale_SkipWorsenBombDialog(1)
AND
NOT DB_DialogRequestCache_SpeakerList_Speakers(_, _, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
NOT DB_DialogSpeakers(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)GLO_Gale_AvatarWorsens_b5c348c4-352b-fe86-da33-8fbacf1a13bc, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)ORI_Gale_AD_AvatarWorsens_06cccefa-c1a3-f117-aaf1-cb43cbb76adb, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_ORI_Gale_Avatar_UpdateState();
PROC_ORI_Gale_Avatar_UpdateNeedFlag();

IF
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotWorseOnce_0918e4e1-0ccd-678c-fdcf-70f197856d11)
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
_Need > _LastHandled
AND
NOT DB_Camp_NightMode(1)
AND
NOT DB_ORI_Gale_BlockWorsenBomb(1)
AND
NOT DB_DialogRequestCache_SpeakerList_Speakers(_, _, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
DB_ORI_Gale_SkipWorsenBombDialog(1)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)ORI_Gale_AD_AvatarWorsens_06cccefa-c1a3-f117-aaf1-cb43cbb76adb, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_ORI_Gale_Avatar_UpdateState();
PROC_ORI_Gale_Avatar_UpdateNeedFlag();
NOT DB_ORI_Gale_SkipWorsenBombDialog(1);

IF
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
_Need > _LastHandled
THEN
PROC_ORI_Gale_Avatar_UpdateState();

IF
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
_Need < _LastHandled
THEN
PROC_ORI_Gale_Avatar_UpdateState();


PROC
PROC_DialogFlagSetup(GLO_Gale_AvatarWorsens_b5c348c4-352b-fe86-da33-8fbacf1a13bc, _)
THEN
PROC_ORI_Gale_Avatar_UpdateState();
MakePlayerActive(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

PROC
PROC_DialogFlagSetup(ORI_Gale_AD_AvatarWorsens_06cccefa-c1a3-f117-aaf1-cb43cbb76adb, _)
THEN
NOT DB_ORI_Gale_SkipWorsenBombDialog(1);
PROC_ORI_Gale_Avatar_UpdateState();
MakePlayerActive(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);


PROC
PROC_DialogFlagSetup((DIALOGRESOURCE)CAMP_GaleTressymJoin_SD_75b4946d-4a78-bea3-e0d2-2dc9b5c05209, _, _)
THEN
SetFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735);
SetFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93);
MakePlayerActive(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);


IF
DialogEnded((DIALOGRESOURCE)CAMP_GaleTressymJoin_SD_75b4946d-4a78-bea3-e0d2-2dc9b5c05209, _)
THEN
PROC_ORI_Gale_Avatar_UpdateState();
PROC_ORI_Gale_Avatar_UpdateNeedFlag();
NOT DB_ORI_Gale_SkipWorsenBombDialog(1);
NOT DB_ORI_Gale_BlockWorsenBomb(1);

IF
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
_Need > _LastHandled
AND
DB_Camp_NightMode(1)
AND
NOT DB_ORI_Gale_BlockWorsenBomb(1)
THEN
DB_ORI_Gale_BlockWorsenBomb(1);
ObjectTimerCancel(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_AvatarWorsen");

IF
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
_Need > _LastHandled
AND
NOT DB_Camp_NightMode(1)
AND
DB_ORI_Gale_BlockWorsenBomb(1)
AND
DB_ORI_Gale_SkipWorsenBombDialog(1)
THEN
ObjectTimerCancel(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_AvatarWorsen");
ObjectTimerLaunch(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_AvatarWorsen", 30000, 1);

IF
ObjectTimerFinished(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_AvatarWorsen")
THEN
NOT DB_ORI_Gale_BlockWorsenBomb(1);

IF
DB_ORI_Gale_SkipWorsenBombDialog(1)
AND
DB_ORI_Gale_BlockWorsenBomb(1)
AND
NOT DB_Camp_NightMode(1)
THEN
ObjectTimerCancel(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_AvatarWorsen");
NOT DB_ORI_Gale_BlockWorsenBomb(1);

PROC
PROC_ORI_Gale_Avatar_UpdateState()
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_ORI_Gale_Avatar_BombStates(_Need, _Status)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_ShowUnifiedTutorialForPlayer(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, AvatarGaleItems_4ca4813e-6aeb-4a99-9cb0-1d8ee2aeb0a8);

PROC
PROC_ORI_Gale_Avatar_UpdateState()
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_ORI_Gale_Avatar_BombStates(_Need, _Status)
THEN
ApplyStatus((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Status, -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ORI_Gale_Avatar_UpdateState()
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", 0)
THEN
SetTag((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TAG)ORI_GALE_DONEWITHITEMS_f37724b5-9235-4ab2-8d65-78efcf50f95b);

PROC
PROC_ORI_Gale_Avatar_UpdateState()
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
_Need > 0
THEN
ClearTag((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TAG)ORI_GALE_DONEWITHITEMS_f37724b5-9235-4ab2-8d65-78efcf50f95b);

IF
FlagSet((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735, _, _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
_Need > 0
THEN
ClearTag((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TAG)ORI_GALE_DONEWITHITEMS_f37724b5-9235-4ab2-8d65-78efcf50f95b);


PROC
PROC_ORI_Gale_Avatar_UpdateState()
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
DB_ORI_Gale_Avatar_BombStates(_LastHandled, _Status)
THEN
RemoveStatus((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Status, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ORI_Gale_Avatar_UpdateState()
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", _Need)
AND
DB_ORI_Gale_LastReactedToState(_LastHandled)
AND
_LastHandled != _Need
THEN
NOT DB_ORI_Gale_LastReactedToState(_LastHandled);
DB_ORI_Gale_LastReactedToState(_Need);

PROC
PROC_ORI_Gale_Avatar_UpdateNeedFlag()
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotWorseOnce_0918e4e1-0ccd-678c-fdcf-70f197856d11)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotWorseTwice_493bb861-5280-a342-e565-03038ea09518)
THEN
SetFlag((FLAG)ORI_Gale_State_GotWorseTwice_493bb861-5280-a342-e565-03038ea09518);

PROC
PROC_ORI_Gale_Avatar_UpdateNeedFlag()
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotWorseOnce_0918e4e1-0ccd-678c-fdcf-70f197856d11)
THEN
SetFlag((FLAG)ORI_Gale_State_GotWorseOnce_0918e4e1-0ccd-678c-fdcf-70f197856d11);

PROC
PROC_ORI_Gale_ConsumedMagicItem()
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)ORI_Gale_AvatarStrengthens_3bb10f5e-6bf9-8c53-7b5f-131a7c5787f3, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)ORI_Gale_AD_AvatarStrengthens_9000a8b2-2cf2-791e-d656-365d5c8efc99, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

// Once you progress too far, if you're in too bad shape, Elminster will come and rescue you.
PROC
PROC_OneShotTriggerEntered(_, S_ORI_Gale_LastNightAliveTrigger_943e6455-3aaa-4804-9fcf-24059ffa603f)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c)
AND
NOT DB_GlobalFlag(ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9)
THEN
//Counts as crossing two regions for distance - should trigger one increase in need.
PROC_ORI_Gale_IncreaseRegionsVisited();
PROC_ORI_Gale_IncreaseRegionsVisited();

PROC
PROC_OneShotTriggerEntered(_, S_ORI_Gale_LastNightAliveTrigger_943e6455-3aaa-4804-9fcf-24059ffa603f)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c)
AND
DB_ORI_Gale_SetupCurseProgression(2) //check if act 1 was visited beforehand.
THEN
SetFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9, NULL_00000000-0000-0000-0000-000000000000, 0);
ApplyStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_CRITICAL", 18.0, 0, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetTag(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);

PROC
PROC_GLO_LevelSwap_BlockSwap(_Player, _ReadyCheckID, "WLD_Main_A")
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
DB_ORI_Gale_SetupCurseProgression(2) //check if act 1 was visited beforehand.
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(ORI_Gale_State_DoingSCLReminder_d04bb117-38e2-43d4-959b-7838373c127a, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_MoonriseReminder_d0d39c07-f676-dafa-ab5f-d3c81fa3a9c0, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
FlagCleared(ORI_Gale_State_DoingSCLReminder_d04bb117-38e2-43d4-959b-7838373c127a, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_MoonriseReminder_d0d39c07-f676-dafa-ab5f-d3c81fa3a9c0);

//Debug flow
IF
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
DB_ORI_Gale_SetupCurseProgression(2) //check if act 1 was visited beforehand.
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(ORI_Gale_State_DoingSCLReminder_d04bb117-38e2-43d4-959b-7838373c127a, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_MoonriseReminder_d0d39c07-f676-dafa-ab5f-d3c81fa3a9c0, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);


IF
StatusRemoved(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_CRITICAL", _, _)
THEN
PROC_ORI_Gale_AvatarCriticalDie();

IF
StatusAttemptFailed(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_CRITICAL", _, _)
THEN
PROC_ORI_Gale_AvatarCriticalDie();

PROC
PROC_ORI_Gale_AvatarCriticalDie()
THEN
DB_ORI_Gale_AvatarCritical(1);

PROC
PROC_ORI_Gale_AvatarCriticalDie()
AND
NOT DB_Dead(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604) //Use DB_Dead because other means of Defeat may be unremovable (or not easily removed) by Jergal.
THEN
Die(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, DEATHTYPE.Necrotic, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0, 0, 0.0);

IF
DB_ORI_Gale_AvatarCritical(1)
AND
DB_Dead(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_InCamp((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
ObjectTimerLaunch(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_Critical", 5000, 1);

IF
ObjectTimerFinished(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_Critical")
AND
NOT DB_InCamp((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_TeleportToFromCamp((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

QRY
QRY_WaypointTeleport_PlayerBlocked_UserException((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_AvatarCritical(1)
AND
NOT DB_InCamp((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

QRY
QRY_GameOver_BlockGameOver()
AND
DB_ORI_Gale_AvatarCritical(1)
THEN
DB_NOOP(1);

IF
DB_ORI_Gale_AvatarCritical(1)
AND
DB_Dead(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_InCamp((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetEntityEvent((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "GLO_Jergal_GoesToCamp", 1);
ClearTag(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
DB_CAMP_Jergal_PlayersToResurrect((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
PROC_GLO_Jergal_ResurrectPlayers();

IF
Resurrected((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_AvatarCritical(1)
THEN
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)GLO_Elminster_CFM_GaleAlone_18fbb9de-dde3-bcdb-027e-f4c4dca138e4);
TeleportTo(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
SetOnStage(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, 1);

IF
Resurrected((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_AvatarCritical(1)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)GLO_Elminster_CFM_GaleAlone_18fbb9de-dde3-bcdb-027e-f4c4dca138e4, S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(ORI_Gale_Event_ElminsterToCamp_4859cfd1-2e50-5003-d459-ebbfd23c5b2d, NULL_00000000-0000-0000-0000-000000000000, 0);

QRY
QRY_SpeakerIsAvailable(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, _, _, _)
AND
DB_ORI_Gale_AvatarCritical(1)
AND
NOT DB_Defeated(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b)
THEN
DB_NOOP(1);

PROC
PROC_DialogFlagSetup(GLO_Elminster_CFM_GaleAlone_18fbb9de-dde3-bcdb-027e-f4c4dca138e4, _, _)
AND
DB_ORI_Gale_AvatarCritical(1)
THEN
SetFlag((FLAG)ORI_Gale_Event_ResurrectedByElminster_ce7af931-74d5-0e92-f966-74aea449e222);

IF
Resurrected((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_AvatarCritical(1)
THEN
NOT DB_ORI_Gale_AvatarCritical(1);

//END_REGION

//REGION Give magic items to Gale
/*
IF
FlagSet((FLAG)ORI_Gale_Event_MagicItemTrade_e7d075c8-286d-eae0-57fe-c0f8ab8bb65d, _Character, _ID)
AND
DB_EquippedItemSlots(_Slot)
AND
GetEquippedItem((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Slot, _Item)
AND
IsTagged(_Item, (TAG)ORI_GALE_CONSUMABLEARTEFACT_7b96246c-54ba-43ea-b01d-4e0b20ad35f1, 1)
THEN
DB_ORI_Gale_TradingMagicItem_TempGiven(_Character, _Item, _Slot);
ToInventory(_Item, _Character, -1, 0, 0);
*/

IF
FlagSet((FLAG)ORI_Gale_Event_MagicItemTrade_e7d075c8-286d-eae0-57fe-c0f8ab8bb65d, _Character, _ID)
THEN
DB_ORI_Gale_TradingMagicItem(_Character, _ID);
PROC_DeclareCounter("ORI_Gale_GivenMagicItems");
ClearFlag(ORI_Gale_Event_TradedOneMagicItem_3a7705e0-7220-44c2-8a2a-2c261a6b8a3f, _Character, _ID);
ClearFlag(ORI_Gale_Event_TradedTwoMagicItems_7dc9b2d6-4b7d-4476-b2c1-ebdb2bf3b4e6, _Character, _ID);

/*
IF
FlagSet((FLAG)ORI_Gale_Event_MagicItemTrade_e7d075c8-286d-eae0-57fe-c0f8ab8bb65d, _Character, _ID)
THEN
IterateInventoryByTag(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_CONSUMABLEARTEFACT_7b96246c-54ba-43ea-b01d-4e0b20ad35f1", "ORI_Gale_FoundConsumableInGaleInventory", "ORI_Gale_DoneFindingConsumableInGaleInventory");

IF
EntityEvent(_Item, "ORI_Gale_FoundConsumableInGaleInventory")
AND
DB_ORI_Gale_TradingMagicItem(_Character, _)
THEN
DB_ORI_Gale_TradingMagicItem_TempGiven(_Character, (ITEM)_Item, "");
ToInventory(_Item, _Character, -1, 0, 0);
*/

//See above disabled logic - if savegame was made before it was disabled, we still need to give the items back.
IF
FlagCleared((FLAG)ORI_Gale_Event_MagicItemTrade_e7d075c8-286d-eae0-57fe-c0f8ab8bb65d, _Character, _ID)
AND
DB_ORI_Gale_TradingMagicItem_TempGiven(_Character, _Item, _Slot)
THEN
PROC_ORI_Gale_ReturnToGale((CHARACTER)_Character, _Item, _Slot);

PROC
PROC_ORI_Gale_ReturnToGale((CHARACTER)_Character, (ITEM)_Item, (STRING)_Slot)
AND
IsItem(_Item, 1)
AND
_Slot != ""
AND
GetInventoryOwner(_Item, _Character)
THEN
Equip((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Item, 1, 0, 0);

PROC
PROC_ORI_Gale_ReturnToGale((CHARACTER)_Character, (ITEM)_Item, "")
AND
IsItem(_Item, 1)
AND
GetInventoryOwner(_Item, _Character)
THEN
ToInventory(_Item, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, -1, 0, 0);

PROC
PROC_ORI_Gale_ReturnToGale((CHARACTER)_Character, (ITEM)_Item, (STRING)_Slot)
THEN
NOT DB_ORI_Gale_TradingMagicItem_TempGiven(_Character, _Item, _Slot);

IF
FlagCleared((FLAG)ORI_Gale_Event_MagicItemTrade_e7d075c8-286d-eae0-57fe-c0f8ab8bb65d, _Character, _ID)
AND
DB_GlobalCounter("ORI_Gale_GivenMagicItems", 1)
AND
DB_ORI_Gale_TradedMagicItem(_Item)
THEN
PROC_ORI_Gale_ConsumedMagicItem();
RequestDelete(_Item);
NOT DB_ORI_Gale_TradedMagicItem(_Item);

IF
FlagCleared((FLAG)ORI_Gale_Event_MagicItemTrade_e7d075c8-286d-eae0-57fe-c0f8ab8bb65d, _Character, _ID)
AND
DB_GlobalCounter("ORI_Gale_GivenMagicItems", _Count)
AND
_Count > 0
AND
DB_ORI_Gale_TradingMagicItem(_Character, _ID)
AND
DB_ORI_Gale_TradedMagicItem(_Item)
THEN
ToInventory(_Item, _Character, 1, 0, 1);
NOT DB_ORI_Gale_TradedMagicItem(_Item);

IF
FlagCleared((FLAG)ORI_Gale_Event_MagicItemTrade_e7d075c8-286d-eae0-57fe-c0f8ab8bb65d, _Character, _ID)
THEN
NOT DB_ORI_Gale_TradingMagicItem(_Character, _ID);
PROC_RemoveCounter("ORI_Gale_GivenMagicItems");

IF
DialogEnded(_Dialog, _ID)
AND
DB_ORI_Gale_TradingMagicItem(_Character, _ID)
AND
DB_ORI_Gale_TradingMagicItem_TempGiven(_Character, (ITEM)_Item, _Slot)
THEN
PROC_ORI_Gale_ReturnToGale((CHARACTER)_Character, _Item, _Slot);

IF
DialogEnded(_Dialog, _ID)
AND
DB_ORI_Gale_TradingMagicItem(_Character, _ID)
THEN
NOT DB_ORI_Gale_TradingMagicItem(_Character, _ID);

IF
Donated(_Item, _, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
IsItem(_Item, 1)
AND
DB_ORI_Gale_TradingMagicItem(_Character, _ID)
AND
IsTagged((ITEM)_Item, (TAG)ORI_GALE_CONSUMABLEARTEFACT_7b96246c-54ba-43ea-b01d-4e0b20ad35f1, 1)
THEN
DB_ORI_Gale_TradedMagicItem(_Item);
PROC_IncreaseCounter("ORI_Gale_GivenMagicItems");

IF
MovedFromTo(_Item, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Character, 1)
AND
IsItem(_Item, 1)
AND
DB_ORI_Gale_TradedMagicItem((ITEM)_Item) //Taking an item back
AND
DB_ORI_Gale_TradingMagicItem(_Character, _ID)
THEN
NOT DB_ORI_Gale_TradedMagicItem(_Item);
PROC_DecreaseCounter("ORI_Gale_GivenMagicItems");

IF
DB_GlobalCounter("ORI_Gale_GivenMagicItems", _Num)
AND
DB_ORI_Gale_TradedItemCounterFlags(_Num, _Flag)
AND
DB_ORI_Gale_TradingMagicItem(_Character, _ID)
THEN
SetFlag(_Flag, _Character, _ID);

IF
DB_GlobalCounter("ORI_Gale_GivenMagicItems", _Num)
AND
DB_ORI_Gale_TradedItemCounterFlags(_NonNum, _Flag)
AND
_Num < _NonNum
AND
DB_ORI_Gale_TradingMagicItem(_Character, _ID)
THEN
ClearFlag(_Flag, _Character, _ID);


//END_REGION

//REGION If Gale is denied a magic item, he will remind players
PROC
PROC_ORI_Gale_IncreaseRegionsVisited()
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Event_DeniedMagicItemOnce_c5b5bce1-0342-7eb0-f185-dc736ea565c4)
AND
NOT DB_OnlyOnce("ORI_Gale_NeedMagicReminder")
AND
QRY_IncreaseCounter("ORI_Gale_NeedMagicReminder")
THEN
DB_NOOP(1);

IF
DB_GlobalCounter("ORI_Gale_NeedMagicReminder", 2)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_OnlyOnce("ORI_Gale_NeedMagicReminder")
THEN
NOT DB_GlobalCounter("ORI_Gale_NeedMagicReminder", 2);
DB_OnlyOnce("ORI_Gale_NeedMagicReminder");
SetFlag(ORI_Gale_State_DoingNeedMagicReminder_ef6faf7a-1170-4672-bb2d-54e53708e96f, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicReminder_3834abc3-f70e-7bbf-b286-32b795cfc3c4, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
FlagCleared(ORI_Gale_State_DoingNeedMagicReminder_ef6faf7a-1170-4672-bb2d-54e53708e96f, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicReminder_3834abc3-f70e-7bbf-b286-32b795cfc3c4);

IF
FlagSet((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d, _, _)
THEN
NOT DB_GlobalCounter("ORI_Gale_NeedMagicReminder", 2);
DB_OnlyOnce("ORI_Gale_NeedMagicReminder");
ClearFlag(ORI_Gale_State_DoingNeedMagicReminder_ef6faf7a-1170-4672-bb2d-54e53708e96f, NULL_00000000-0000-0000-0000-000000000000, 0);
ClearFlag(ORI_Gale_State_DoingSCLReminder_d04bb117-38e2-43d4-959b-7838373c127a, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicReminder_3834abc3-f70e-7bbf-b286-32b795cfc3c4);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_MoonriseReminder_d0d39c07-f676-dafa-ab5f-d3c81fa3a9c0);

IF
FlagSet((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8, _, _)
THEN
NOT DB_GlobalCounter("ORI_Gale_NeedMagicReminder", 2);
DB_OnlyOnce("ORI_Gale_NeedMagicReminder");
ClearFlag(ORI_Gale_State_DoingSCLReminder_d04bb117-38e2-43d4-959b-7838373c127a, NULL_00000000-0000-0000-0000-000000000000, 0);
ClearFlag(ORI_Gale_State_DoingNeedMagicReminder_ef6faf7a-1170-4672-bb2d-54e53708e96f, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicReminder_3834abc3-f70e-7bbf-b286-32b795cfc3c4);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_MoonriseReminder_d0d39c07-f676-dafa-ab5f-d3c81fa3a9c0);

//END_REGION

//REGION Gale loses his aura when resurrected

PROC
PROC_GLO_Jergal_ResurrectPlayers()
AND
DB_CAMP_Jergal_PlayersToResurrect((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
RemoveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,  "ORI_GALE_NECROTICAURA", S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);

//END_REGION

PROC
PROC_ORI_Gale_DisableDeathEffect()
THEN
RemoveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_BOMB1", GLO_Elminster_c3844cd6-5c8f-ce4f-fd3d-666afa6178cd);

PROC
PROC_ORI_Gale_DisableDeathEffect()
AND
DB_ORI_Gale_Avatar_BombStates(_Index, _Status)
AND
_Index != 1
AND
HasActiveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Status, 1)
THEN
PROC_ORI_Gale_ApplyPermanentBombDebuff();
RemoveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Status, GLO_Elminster_c3844cd6-5c8f-ce4f-fd3d-666afa6178cd);

PROC
PROC_ORI_Gale_ApplyPermanentBombDebuff()
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
ApplyStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_BOMB1", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

//REGION Gale complains about his state
IF
StatusApplied((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Status, _, _)
AND
DB_ORI_Gale_Avatar_BombStates(_, _Status)
AND
DB_ORI_Gale_ComplainADTimer(_Length)
THEN
DB_ORI_Gale_ComplainADTimer(600000);
ObjectTimerCancel(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_ComplainADTimer");
PROC_ORI_Gale_RelaunchComplainADTimer();

PROC
PROC_ORI_Gale_RelaunchComplainADTimer()
AND
DB_ORI_Gale_ComplainADTimer(_Duration)
AND
IntegerSum(_Duration, 300000, _NewDuration)
THEN
ObjectTimerLaunch(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_ComplainADTimer", _Duration);
NOT DB_ORI_Gale_ComplainADTimer(_Duration);
DB_ORI_Gale_ComplainADTimer(_NewDuration);


IF
ObjectTimerFinished(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_ComplainADTimer")
AND
NOT QRY_ORI_Gale_DoComplainAD()
THEN
ObjectTimerLaunch(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_ComplainADTimer", 180000); //Try again in 3 minutes.

QRY
QRY_ORI_Gale_DoComplainAD()
AND
NOT DB_DialogPlayers(_, _, _)
AND
NOT DB_CantTalk(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_TryStartAD(ORI_Gale_AD_BombComplain_9a070c05-44b4-5ec0-d408-09fb1fea19d8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
PROC_ORI_Gale_RelaunchComplainADTimer();

QRY
QRY_ORI_Gale_DoComplainAD()
AND
NOT DB_DialogPlayers(_, _, _)
AND
NOT DB_CantTalk_IgnoreCombat(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Is_InCombat(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
IsControlled(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1)
THEN
PROC_TryStartAD(ORI_Gale_AD_BombComplain_9a070c05-44b4-5ec0-d408-09fb1fea19d8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
PROC_ORI_Gale_RelaunchComplainADTimer();

PROC
PROC_ORI_Gale_Avatar_UpdateState()
AND
DB_GlobalCounter("ORI_Gale_MagicItemNeed", 0)
THEN
ObjectTimerCancel(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_ComplainADTimer");

//END_REGION

//REGION Gale asks for more magic items

PROC
PROC_ORI_Gale_ConsumedMagicItem()
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_ORI_Gale_ResetVisitedRegions();

PROC
PROC_ORI_Gale_ResetVisitedRegions()
AND
DB_ORI_Gale_TrackRegion_Disabled((TRIGGER)_Trigger, (STRING)_RegionName)
THEN
NOT DB_ORI_Gale_TrackRegion_Disabled(_Trigger, _RegionName);
DB_ORI_Gale_TrackRegion(_Trigger, _RegionName);

PROC
PROC_ORI_Gale_ResetVisitedRegions()
AND
DB_ORI_Gale_RegionCounter(_Threshold, _Flag)
THEN
NOT DB_ORI_Gale_RegionCounter(_Threshold, _Flag);

PROC
PROC_ORI_Gale_ResetVisitedRegions()
AND
DB_ORI_Gale_RegionsVisited(_Number)
THEN
NOT DB_ORI_Gale_RegionsVisited(_Number);

PROC
PROC_ORI_Gale_ResetVisitedRegions()
AND
DB_ORI_Gale_RegionTracking_VisitedCount(_Number)
THEN
NOT DB_ORI_Gale_RegionTracking_VisitedCount(_Number);
DB_ORI_Gale_RegionTracking_VisitedCount(0);

PROC
PROC_ORI_Gale_ResetVisitedRegions()
AND
SysFactAtIndex("DB_ORI_Gale_RegionCounter_New", 1, 1, "DB_ORI_Gale_RegionCounter_Reset")
AND
DB_ORI_Gale_RegionCounter_Reset((FLAG)_Flag)
THEN
NOT DB_ORI_Gale_RegionCounter_Reset(_Flag);
DB_ORI_Gale_RegionCounter(2, _Flag);
NOT DB_ORI_Gale_RegionCounter_New(_Flag);

PROC
PROC_ORI_Gale_VisitedTrackedRegion((STRING)_)
AND
DB_ORI_Gale_TrackRegion_Latest(_Trigger, _RegionName)
THEN
NOT DB_ORI_Gale_TrackRegion_Latest(_Trigger, _RegionName);
DB_ORI_Gale_TrackRegion_Disabled(_Trigger, _RegionName);

PROC
PROC_ORI_Gale_VisitedTrackedRegion((STRING)_RegionName)
AND
DB_ORI_Gale_TrackRegion(_Trigger, _RegionName)
THEN
DB_ORI_Gale_TrackRegion_Latest(_Trigger, _RegionName);

IF
FlagSet(_Flag, _, _)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_RegionCounter(_, _Flag)
AND
DB_ORI_Gale_NeedsMagicItemIPRDFlags(_Flag, _IPRDFlag, _CancelFlag)
AND
NOT DB_GlobalFlag(_CancelFlag)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IPRDFlag, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);

IF
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_ORI_Gale_RecheckNeedsmagicItemIPRD();

PROC
PROC_ORI_Gale_RecheckNeedsmagicItemIPRD()
AND
DB_GlobalFlag(_Flag)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_RegionCounter(_, _Flag)
AND
DB_ORI_Gale_NeedsMagicItemIPRDFlags(_Flag, _IPRDFlag, _CancelFlag)
AND
NOT DB_GlobalFlag(_CancelFlag)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IPRDFlag, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);

IF
DialogStarted((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _ID)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _Flag, _, _, _)
THEN
DB_ORI_Gale_CleanupMagicItemIPRDAfter(_ID);

IF
DialogEnded(_, _ID)
AND
DB_ORI_Gale_CleanupMagicItemIPRDAfter(_ID)
AND
DB_ORI_Gale_NeedsMagicItemIPRDFlags(_StartFlag, _IPRDFlag, _CancelFlag)
AND
DB_CampNight_CRD(_NightFlag, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IPRDFlag)
THEN
NOT DB_ORI_Gale_CleanupMagicItemIPRDAfter(_ID);
NOT DB_ORI_Gale_NeedsMagicItemIPRDFlags(_StartFlag, _IPRDFlag, _CancelFlag);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IPRDFlag);
PROC_CampNight_ClearCampNight(_NightFlag);

IF
FlagSet(_CancelFlag, _, _)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_NeedsMagicItemIPRDFlags(_, _IPRDFlag, _CancelFlag)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IPRDFlag);

IF
DB_ORI_Gale_NeedsMagicItemIPRDFlags(_, _IPRDFlag, _)
THEN
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IPRDFlag);



//END_REGION

//REGION Gale wants to inform the players of his condition


//If approval is high enough.

IF
ApprovalRatingChangeAttempt(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar, _, _, _Approval)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
_Approval >= 20
THEN
DB_ORI_Gale_AvatarHasApprovalToLearnOfBomb(_Avatar);

IF
ApprovalRatingChangeAttempt(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar, _, _, _Approval)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
DB_ORI_Gale_AvatarHasApprovalToLearnOfBomb(_Avatar)
AND
_Approval < 20
THEN
NOT DB_ORI_Gale_AvatarHasApprovalToLearnOfBomb(_Avatar);

IF
FlagSet((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735, _, _)
AND
DB_ORI_Gale_AvatarHasApprovalToLearnOfBomb(_Avatar)
THEN
NOT DB_ORI_Gale_AvatarHasApprovalToLearnOfBomb(_Avatar); 

IF
FlagSet((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735, _,_ID)
THEN
NOT DB_ORI_Gale_MagicItemApprovalIPRD(1);

IF
FlagSet((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735, _, _ID)
AND
NOT DB_DialogName(Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _ID)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);

IF
DB_ORI_Gale_AvatarHasApprovalToLearnOfBomb(_Avatar)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
DB_Players((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_ORI_Gale_MagicItemApprovalIPRD(1)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a, (GUIDSTRING)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0, 20);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem1_c1899c40-e4c4-72d6-4360-444cea41e72f);
DB_ORI_Gale_MagicItemApprovalIPRD(1);

IF
DB_ORI_Gale_AvatarHasApprovalToLearnOfBomb(_Avatar)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
NOT DB_Players((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_ORI_Gale_MagicItemApprovalIPRD(1)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a, (GUIDSTRING)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0, 20);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem1_c1899c40-e4c4-72d6-4360-444cea41e72f);
DB_ORI_Gale_MagicItemApprovalIPRD(1);

IF
FlagSet((FLAG)ORI_Gale_ND_IPRDs_MagicItem1Fallback_7b262ab0-d6a7-310f-dc6d-cd86cc69356f, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem1_c1899c40-e4c4-72d6-4360-444cea41e72f);

IF
CharacterReservedUserIDChanged(_Avatar, _, _)
AND
DB_ORI_Gale_AvatarHasApprovalToLearnOfBomb(_Avatar)
THEN
PROC_ORI_Gale_RecheckMagicItemApprovalIPRD();

IF
CharacterReservedUserIDChanged((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _)
THEN
PROC_ORI_Gale_RecheckMagicItemApprovalIPRD();

PROC
PROC_ORI_Gale_RecheckMagicItemApprovalIPRD()
THEN
NOT DB_ORI_Gale_MagicItemApprovalIPRD(1);

PROC
PROC_ORI_Gale_RecheckMagicItemApprovalIPRD()
AND
NOT DB_ORI_Gale_MagicItemApprovalIPRD(1)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);

IF
DB_ORI_Gale_MagicItemApprovalIPRD(1)
AND
DB_ORI_Gale_TrustMoments(_Flag, _WRD, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)_WRD, NULL_00000000-0000-0000-0000-000000000000);

//Avoid overlap of at least the trust moments with the truth-sharing logic.
IF
DB_ORI_Gale_MagicItemApprovalIPRD(1)
AND
DB_DialogSpeakers(_ID, _Avatar, _)
AND
DB_ORI_Gale_WRDAfterDialog(_ID, _WRD)
THEN
NOT DB_ORI_Gale_WRDAfterDialog(_ID, _WRD);


//END_REGION


PROC
PROC_ORI_Gale_DisableDeathEffect()
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem1_c1899c40-e4c4-72d6-4360-444cea41e72f);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem2_170a6564-a01e-f145-6958-bf84312d0e03);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem3_b2db2afd-74a2-b432-df34-6073d7c78b62);

PROC
PROC_ORI_Gale_DisableDeathEffect()
THEN
GoalCompleted;
EXITSECTION
NOT DB_ORI_Gale_SetupCurseProgression(1);

NOT DB_ORI_Gale_WorsenCurse((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93);
NOT DB_ORI_Gale_WorsenCurse((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8);
NOT DB_ORI_Gale_WorsenCurse((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9);

NOT DB_ORI_Gale_LastReactedToState(0);

NOT DB_ORI_Gale_Avatar_BombStates(1, "ORI_GALE_BOMB1");
NOT DB_ORI_Gale_Avatar_BombStates(2, "ORI_GALE_BOMB2");
NOT DB_ORI_Gale_Avatar_BombStates(3, "ORI_GALE_BOMB3");
ENDEXITSECTION
ParentTargetEdge "ModWrapper_Gustav"
