Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_GlobalFlagReactionAfterDialog((FLAG)TUT_Helm_State_GithMindControlled_d2872586-f053-4753-b793-1a7718ee5583, (DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84);
DB_GlobalFlagReactionAfterDialog((FLAG)TUT_Helm_State_StatedNerveFocus_f01cd6e7-f4c8-4a1c-9e8e-953a5560486c, (DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84);

DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)TUT_Helm_AD_CreatureCantUseTransponder_1e44dd42-e7ca-2792-7b05-86cb23b40668);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)TUT_Helm_PAD_PlayerOutsideHelm_2f7e5f09-381e-6b25-88b8-8cdcc05cc1b6);

DB_TUT_Helm_DisablingStatus("TUT_CHARACTERINPOD");
DB_TUT_Helm_DisablingStatus("TUT_SAPPED");

DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_TUT_TransformChamber_DrainVictim_000_5bc43df4-6274-4b73-baed-c7f5268b2fc7);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_TUT_TransformChamber_DrainVictim_001_dd1d4bcf-da0e-441a-b700-7273bad6579e);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_FirstFight_Imp_Melee_01_07f1512b-efe9-4eb8-8ade-783435e9d7c9);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_FirstFight_Imp_Ranged_01_38d1ce2f-4f19-4266-971d-61f08bc1a895);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_FirstFight_Imp_Melee_02_5c5bd50b-147e-42e5-93cb-59a754df91ec);
DB_TUT_Helm_NPCsFromOtherAreas((CHARACTER)S_FirstFight_Imp_Ranged_02_df44fa65-5399-47d6-b5bb-70e4b8e63314);

DB_TUT_Helm_RoundsRubble(2);
DB_TUT_Helm_RoundsRubble(3);
DB_TUT_Helm_RoundsRubble(5);

DB_TUT_Helm_Devils(S_TUT_Helm_Devil_000_1650c758-c9c2-d487-387d-22a269fd7918);
DB_TUT_Helm_Devils(S_TUT_Helm_Devil_001_8262153a-b469-d119-2041-8316e0648ae0);
DB_TUT_Helm_Devils(S_TUT_Helm_Devil_003_139971a8-86c5-4ee9-b201-18da4a2cb0ed);
DB_TUT_Helm_Devils(S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e);

DB_GLO_DefeatCounter_IgnoreWaitForCombatEnd("TUT_Helm_DevilsDefeated");

DB_TUT_Helm_Devils_BackUp((CHARACTER)S_TUT_Helm_DevilBackUp_001_c6b3a323-d7cf-4b02-8a21-fefeaf3e7a0a);
DB_TUT_Helm_Devils_BackUp((CHARACTER)S_TUT_Helm_DevilBackUp_002_4afad8cc-436e-4d16-8b33-7e59a470d4a8);
DB_TUT_Helm_Devils_BackUp((CHARACTER)S_TUT_Helm_DevilBackUp_003_a73bd45a-99b6-4486-a280-846ddd586b78);

DB_TUT_Helm_Devils_BackUpCambions((CHARACTER)S_TUT_Helm_BackUpCambion_001_dfd44248-1212-4eb9-a6b4-8d7335ad57f7);
DB_TUT_Helm_Devils_BackUpCambions((CHARACTER)S_TUT_Helm_BackUpCambion_002_5a7d3c96-3b98-4601-85ba-67f6bea52959);

DB_TUT_Helm_RoundCount(0);

PROC_TUT_Helm_Init();

DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)TUT_Helm_DragonAppears_6ffc2909-a928-4b8b-6901-02d823e68880, (TRIGGER)S_TUT_Helm_RoomArea_6806969b-43d7-40c2-95b9-49e9b21d2c04,1,1);

DB_TUT_Helm_TempUsStatus("TUT_LOBOTOMIZED_US");
DB_TUT_Helm_TempUsStatus("TUT_NEWBORN_INTDEV");

PROC_TriggerRegisterForParty(S_TUT_StartHelmNPCTrigger_fe1e10c1-20ba-4353-99e1-de7b8501dd46);
PROC_TriggerRegisterForPlayers(S_TUT_Helm_MindMeldTrigger_3e0656be-0613-4e7d-9c1b-894628e812f6);
PROC_TriggerRegisterForParty(S_TUT_Helm_MindflayerCall_StartTrigger_189c40a7-a355-467d-be80-dbfd754fc67b);
PROC_TriggerRegisterForParty(S_TUT_Helm_FinalCombatTeleportingTrigger_53dd14f6-1571-4cae-b223-83b42cd3bc3a);

DB_GlobalFlagReactionAfterDialog((FLAG)TUT_Helm_TransponderActivated_40d32a6d-8d41-4ceb-a4e9-bbd34d0664e4, (DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c);

DB_TUT_Helm_ClosestToGuide(NULL_00000000-0000-0000-0000-000000000000, 9999.0);
PROC_TriggerRegisterForPlayers(S_TUT_Helm_DragonTrigger_3ca543c8-75b7-4f1f-9415-941c83904fda);
PROC_TriggerRegisterForPlayers(S_TUT_Helm_RoomArea_6806969b-43d7-40c2-95b9-49e9b21d2c04);

// Mind flayer call scene
DB_Inclusion_CombatInclusionDialog((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, (TRIGGER)S_TUT_Helm_MindMeldTrigger_3e0656be-0613-4e7d-9c1b-894628e812f6, 1, 1); // Add everyone inside the room to the dialog
DB_Inclusion_NPCDialog((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, (CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84);

// Dragon scene in the helm
DB_Inclusion_CombatInclusionDialog((DIALOGRESOURCE)TUT_Helm_DragonAppears_6ffc2909-a928-4b8b-6901-02d823e68880);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)TUT_Helm_DragonAppears_6ffc2909-a928-4b8b-6901-02d823e68880, (TRIGGER)S_TUT_Helm_RoomArea_6806969b-43d7-40c2-95b9-49e9b21d2c04, 1, 1); // Add everyone inside the room to the dialog
DB_Inclusion_NPCDialog((DIALOGRESOURCE)TUT_Helm_DragonAppears_6ffc2909-a928-4b8b-6901-02d823e68880, (CHARACTER)S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846);

DB_TUT_Helm_CambionAndMindFlayer((CHARACTER)S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846);
DB_TUT_Helm_CambionAndMindFlayer((CHARACTER)S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e);

DB_DeadOnceFlag((CHARACTER)S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e, (FLAG)TUT_Helm_Event_CambionDies_fcfd8b70-e8ca-05b4-5cca-2c2190d6c459);

PROC_TriggerRegisterForPlayers(S_TUT_Helm_LastReminder_e0132d4a-3abb-4298-a688-c44e260d6a01);
DB_TUT_GuideDialogues("LastReminder", (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (DIALOGRESOURCE)TUT_Helm_AD_LaezelRemindsNerves_d4d65341-eba6-94a5-9aa1-6c5ee1ba973a);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_DialogStarted_IgnoreStopConditions((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c);

//REGION Ethereal Plane Transition

DB_TUT_Helm_ScrollingObjects(LT_GLO_TUT_Avernus_TemplateWrap_B_000_0495f79d-a9d3-409b-879a-2373cefa8f53);
DB_TUT_Helm_ScrollingObjects(LT_GLO_TUT_Avernus_TemplateWrap_D_000_452976b4-0c3e-4681-bd9d-f9585b98b44a);
DB_TUT_Helm_ScrollingObjects(LT_GLO_TUT_Avernus_TemplateWrap_E_000_934476c8-5556-4ba0-9c38-64c921467584);
DB_TUT_Helm_ScrollingObjects(LT_GLO_TUT_Avernus_TemplateWrap_C_000_dbc77f94-139a-4a92-bf95-27ac7634f918);
DB_TUT_Helm_ScrollingObjects(LT_GLO_TUT_Avernus_TemplateWrap_A_000_ade6c04e-70b8-41bf-a7c5-ffb70ae90948);

//END_REGION

//REGION Backtracking warning

DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_001_43298162-293c-4d8b-b3fe-88f3502d924e);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_002_e7912f51-5488-4a4e-902a-a8068dacb533);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_003_f878adff-8415-4bd0-bb2c-acb9d8898948);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_004_fc275a48-480c-4a31-8a33-cd05752803c3);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_005_c37ef025-f1c1-4179-bb26-046137436f1a);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_006_78956fc5-d270-4686-b7c4-4e63fd9a38f1);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_007_91041ca4-e253-4100-b4c9-9f7475c011df);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_008_7453b283-9815-446b-b201-5d647d54f6f6);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_009_50f89c9c-541e-4a79-a586-16330c7b92af);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_010_9d4b3513-5056-4034-ac65-3f5633d53ccc);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_011_7fab05ea-1372-4553-b77e-56625cdcd250);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_012_7132ec2d-7609-4573-bab2-1fd7baebca32);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_013_9bf31d73-5508-41cf-beca-579f9302ae0c);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_014_c2cdf0f6-6f70-4f0a-96bb-992ee818ccd9);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_015_1e03c83b-aac4-46fe-91c7-2d0ae4ea7511);
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)S_TUT_Helm_BacktrackingFireTrigger_016_f54db981-62fb-4f85-a489-9b0d9df4e5e4);

//END_REGION
//REGION Game over
PROC_TriggerRegisterForPlayers(S_TUT_Helm_PointOfNoReturn_6c4f1de5-89c5-4944-bda3-f1304c7fbc6a);
PROC_TriggerRegisterForPlayers(S_TUT_Helm_GameOverTrigger_c77c73c4-94e2-4cbc-9206-743777e3ed24);
PROC_TriggerRegisterForPlayers(S_TUT_Helm_GuideBacktrackWarning_41479227-6954-4a4d-a075-c00255c69399);
PROC_TriggerRegisterForParty(S_TUT_Helm_ScreenShake_7b08ca7a-3188-4b72-8120-1a39630a48b5);
PROC_TriggerRegisterForParty(S_TUT_IncinerateTrigger_2a7c57ad-970d-457a-a5aa-269e24c0fb5e);
TriggerRegisterForCharacter(S_TUT_IncinerateTrigger_2a7c57ad-970d-457a-a5aa-269e24c0fb5e, S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

DB_TUT_GuideDialogues("Backtrack", (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, (DIALOGRESOURCE)TUT_Helm_AD_LaezelGoToHelmReminder_47f1ebb2-7620-5deb-a402-cd8d984e641c);
DB_TUT_GuideDialogues("Backtrack", (CHARACTER)S_TUT_GithGuide_201a0ee6-6411-4564-aaea-1ca057bfea04, (DIALOGRESOURCE)TUT_Helm_AD_GuideWarningBacktrack_77856c6a-5ae5-16b9-6b77-6cfd1ab3236e);

DB_TUT_Helm_GameOverFire((TRIGGER)S_TUT_Helm_GameOverFire_007_30816f2b-c14c-41f0-a56a-f28d3a8ae9fb);
DB_TUT_Helm_GameOverFire((TRIGGER)S_TUT_Helm_GameOverFire_000_97034a53-7ec4-4495-ab7e-e3378e14194c);
DB_TUT_Helm_GameOverFire((TRIGGER)S_TUT_Helm_GameOverFire_001_85724e7e-3ac5-45f8-8950-ca2b99c69ac9);
DB_TUT_Helm_GameOverFire((TRIGGER)S_TUT_Helm_GameOverFire_002_150380e1-8c2d-4276-9028-2deba8cfd784);
DB_TUT_Helm_GameOverFire((TRIGGER)S_TUT_Helm_GameOverFire_003_245fe268-6c51-4800-905c-29d929cf9b07);
DB_TUT_Helm_GameOverFire((TRIGGER)S_TUT_Helm_GameOverFire_004_63e1ea95-928a-4cac-8956-f6bd73ac951a);
DB_TUT_Helm_GameOverFire((TRIGGER)S_TUT_Helm_GameOverFire_008_b4793870-68ea-482d-abdd-818fd0bf7ca4);

DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_000_d693b513-fade-45bb-8d7e-45c2deb121ed);
DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_008_b115ee39-ff67-4c77-b62c-25708952122a);
DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_007_15b7b7ad-3fd6-4389-9e23-0b6f34f365b4);
DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_006_a5faff6c-c386-47f3-bbaa-146f2f0c12d6);
DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_003_6da3ba92-beb7-495c-a20f-b394cff39fd7);
DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_001_ef90ef2f-df04-4e62-9c1c-c81c23eb82a4);
DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_002_4bf4d393-2302-4554-8d0a-27a65e2a8585);
DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_004_8cab90da-621f-47c3-ba8d-fce053999d5d);
DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_005_60a22421-0ebd-43ec-99a3-e690602432ec);
DB_TUT_Helm_GameOverExplosion((TRIGGER)S_TUT_Helm_GameOverExplosion_009_bdcc7b0b-6158-4973-a422-4ef8a9034645);

DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_GithGuide_201a0ee6-6411-4564-aaea-1ca057bfea04);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_LowerDeck_Devil_000_2c7caf64-3ae8-4d4e-b884-084541a043f7);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_InjuredThrall_002_ab4dc5a8-88d4-4b85-8c15-ae524874097d);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_InjuredThrall_000_97b94ef8-88b7-49e3-9e9d-030fe286a9e1);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_TransformChamber_DrainVictim_000_5bc43df4-6274-4b73-baed-c7f5268b2fc7);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_IntellectDevourer_001_04ec0756-f633-4ce4-85a2-87b0ebb642d7);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_Devil_006_06b30605-e1da-47a0-85da-370541af4976);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_DevilBackUp_003_a73bd45a-99b6-4486-a280-846ddd586b78);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_Thrall_002_2fa74de8-486e-476d-b184-d2265ceebd37);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_Devil_003_139971a8-86c5-4ee9-b201-18da4a2cb0ed);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_Thrall_001_5944faf9-c37e-4886-9dbc-1210e9de4911);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_LowerDeck_Mindflayer_001_21f24385-259d-4118-90ed-61d02620bc6a);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_BackUpCambion_001_dfd44248-1212-4eb9-a6b4-8d7335ad57f7);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_LowerDeck_IntellectDevourerDead_001_12afa6a2-8788-4adf-b078-7dcfcf3733c5);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_DevilBackUp_001_c6b3a323-d7cf-4b02-8a21-fefeaf3e7a0a);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_LowerDeck_IntellectDevourerDead_002_3d2cc1e0-4491-4dec-8aad-c1fb0ea28a15);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_MindFlayer_001_2e51d3cc-8102-4bb9-9272-d9846f2810af);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_TransformChamber_DrainVictim_001_dd1d4bcf-da0e-441a-b700-7273bad6579e);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_DevilBackUp_002_4afad8cc-436e-4d16-8b33-7e59a470d4a8);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_LowerDeck_MindflayerDead_001_16bebcc5-41d7-4fea-9e34-6f042fbc5ca2);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_BackUpCambion_002_5a7d3c96-3b98-4601-85ba-67f6bea52959);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_LowerDeck_Devil_003_7419e20d-39e1-43e3-8e77-6a7006379b19);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_RedDragon_9f961755-3f61-4458-a210-45cf9e40bec5);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_MindflayerThrall_002_d5881b05-f542-4bd7-86f6-402bd5e88f51);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_MindflayerThrall_001_aac007dc-1877-47fe-8f82-88c7dfdf463d);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_Imp_001_f5ffc471-aeab-4a86-942c-7fc8034a2773);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_UpperDeck_Imp_000_67fc495e-5938-4754-842e-5dc16cb26f92);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_LowerDeck_Devil_001_cbd409e7-2cc2-4c8a-bab6-117635c0ede2);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_Devil_004_307d7d95-96f3-40db-9c2b-65ed63aa5c1d);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_Devil_001_8262153a-b469-d119-2041-8316e0648ae0);
DB_TUT_Helm_GameOver_NPCSToDie((CHARACTER)S_TUT_Helm_Devil_000_1650c758-c9c2-d487-387d-22a269fd7918);

DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_MindFlayer_001_2e51d3cc-8102-4bb9-9272-d9846f2810af);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_Devil_000_1650c758-c9c2-d487-387d-22a269fd7918);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_Devil_001_8262153a-b469-d119-2041-8316e0648ae0);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_Devil_003_139971a8-86c5-4ee9-b201-18da4a2cb0ed);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_Devil_006_06b30605-e1da-47a0-85da-370541af4976);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_BackUpCambion_001_dfd44248-1212-4eb9-a6b4-8d7335ad57f7);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_BackUpCambion_002_5a7d3c96-3b98-4601-85ba-67f6bea52959);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_DevilBackUp_001_c6b3a323-d7cf-4b02-8a21-fefeaf3e7a0a);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_DevilBackUp_002_4afad8cc-436e-4d16-8b33-7e59a470d4a8);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_Helm_DevilBackUp_003_a73bd45a-99b6-4486-a280-846ddd586b78);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_TransformChamber_DrainVictim_000_5bc43df4-6274-4b73-baed-c7f5268b2fc7);
DB_TUT_Helm_GameOver_NPCSToIncinerate((CHARACTER)S_TUT_TransformChamber_DrainVictim_001_dd1d4bcf-da0e-441a-b700-7273bad6579e);
//END_REGION

// Combat NPC Reactivity
DB_CombatReact_AD_OnDeathOther(S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e, S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846,(DIALOGRESOURCE)TUT_Helm_AD_DevilAfterDeadMindFlayer_d882e17c-172d-ed4f-adac-02d858cc542e);
DB_CombatReact_AD_OnEntered(S_TUT_Helm_BackUpCambion_001_dfd44248-1212-4eb9-a6b4-8d7335ad57f7, (DIALOGRESOURCE)TUT_Helm_AD_CambionTaunt_001_15dc0137-4568-a263-7262-21178f5b5557);
DB_CombatReact_AD_OnNextTurn(S_TUT_Helm_BackUpCambion_001_dfd44248-1212-4eb9-a6b4-8d7335ad57f7, (DIALOGRESOURCE)TUT_Helm_AD_CambionTaunt_002_14f91e2f-5471-d6c1-124e-6a6532bea83b);
KBSECTION
//REGION Init

PROC
PROC_TUT_Helm_Init()
AND
DB_TUT_Helm_Devils(_Devil)
THEN
DB_GLO_DefeatCounter(_Devil, "TUT_Helm_Devils");

PROC
PROC_TUT_Helm_Init()
THEN
PROC_SetCanFight(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846,0);
PROC_SetCanFight(S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e,0);

PROC
PROC_TUT_Helm_Init()
AND
DB_TUT_Helm_Devils_BackUpCambions(_Cambion)
THEN
SetOnStage(_Cambion,0);

//Devils other than the Cambion want to focus players
PROC
PROC_TUT_Helm_Init()
AND
DB_TUT_Helm_Devils(_Devil)
AND
_Devil != S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e
THEN
AddPreferredAiTargetTag((CHARACTER)_Devil,(TAG)AVATAR_306b9b05-1057-4770-aa17-01af21acd650);
AddPreferredAiTargetTag((CHARACTER)_Devil,(TAG)REALLY_LAEZEL_b5682d1d-c395-489c-9675-1f9b0c328ea5);
AddPreferredAiTargetTag((CHARACTER)_Devil,(TAG)INTELLECT_DEVOURER_69901347-23cb-4f60-abf3-527f23cdf0db); // for the companion int dev
PROC_SetOnStage((CHARACTER)_Devil,0);


//Priority tags -> Cambion and MF want ot fight eachother unless there are no other targets
PROC
PROC_TUT_Helm_Init()
THEN
SetTag(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
AddPreferredAiTargetTag(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846,AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd);
SetTag(S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e,AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd);
AddPreferredAiTargetTag(S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
PROC_FaceEachother(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846,S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e);
DB_DoNotFace(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846);


PROC
PROC_TUT_Helm_Init()
THEN
SetTag(S_TUT_Helm_MindFlayer_001_2e51d3cc-8102-4bb9-9272-d9846f2810af,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
AddPreferredAiTargetTag(S_TUT_Helm_MindFlayer_001_2e51d3cc-8102-4bb9-9272-d9846f2810af,AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd);
SetTag((CHARACTER)S_TUT_Helm_Devil_006_06b30605-e1da-47a0-85da-370541af4976,AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd);
AddPreferredAiTargetTag((CHARACTER)S_TUT_Helm_Devil_006_06b30605-e1da-47a0-85da-370541af4976,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);


//END_REGION

//REGION Cambion and Mindflayer sohuld stay in their Hint trigger until one is killed
IF
DB_TUT_Helm_CambionAndMindFlayer(_Boss)
THEN
SetAiHint(_Boss,AI_HINT_UNIQUE_1902723d-dd16-4e7a-87d6-7b07f63add79);

IF
DB_Dead(_Boss)
AND
DB_TUT_Helm_CambionAndMindFlayer(_Boss)
AND
DB_TUT_Helm_CambionAndMindFlayer(_OtherBoss)
THEN
SetAiHint(_OtherBoss,NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION Mindmeld

IF
DB_TutorialCompanion(_Companion)
THEN
TriggerRegisterForCharacter(S_TUT_Helm_MindflayerCall_StartTrigger_189c40a7-a355-467d-be80-dbfd754fc67b, _Companion);

IF
UseStarted(_Player, (ITEM)S_TUT_Helm_Door_001_8a665e33-fcb6-4a94-a567-41b643e96c3a)
AND
QRY_TUT_Helm_PartyMember(_Player)
AND
DB_TUT_Helm_CallDialogPlayer(_Player)
THEN
NOT DB_TUT_Helm_CallDialogPlayer(_Player);

IF
UseStarted(_Player, (ITEM)S_TUT_Helm_Door_001_8a665e33-fcb6-4a94-a567-41b643e96c3a)
AND
QRY_TUT_Helm_PartyMember(_Player)
AND
NOT SysCount("DB_Avatars",1,1)
THEN
DB_TUT_Helm_CallDialogPlayer(_Player);
ReadyCheckGlobal("TUT_Helm_EnterHelmCheck", "TUT_Helm_EnterHelmCheck", 0, (CHARACTER)_Player);

IF
UseStarted(_Player, (ITEM)S_TUT_Helm_Door_001_8a665e33-fcb6-4a94-a567-41b643e96c3a)
AND
QRY_TUT_Helm_PartyMember(_Player)
AND
SysCount("DB_Avatars",1,1)
AND
QRY_OnlyOnce("TUT_Helm_MindflayerCall_DialogStartOnlyOnce")
THEN
DB_TUT_Helm_CallDialogPlayer(_Player);
PROC_TUT_Helm_EnterHelm((CHARACTER)_Player);

IF
ReadyCheckPassed("TUT_Helm_EnterHelmCheck")
AND
DB_TUT_Helm_CallDialogPlayer(_Player)
AND
QRY_OnlyOnce("TUT_Helm_MindflayerCall_DialogStartOnlyOnce")
THEN
DB_TUT_Helm_DidReadyCheck(1);
PROC_TUT_Helm_EnterHelm((CHARACTER)_Player);


PROC
PROC_TUT_Helm_EnterHelm((CHARACTER)_Player)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_TUT_Helm_Door_001_8a665e33-fcb6-4a94-a567-41b643e96c3a);
PROC_SetOnStage(S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e,1);
PROC_SetOnStage(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846,1);
SetCanInteract((ITEM)S_TUT_Helm_Door_001_8a665e33-fcb6-4a94-a567-41b643e96c3a,0);
PROC_TUT_Helm_StartCallDialog((CHARACTER)_Player);

IF
DB_InRegion((CHARACTER)_Char,S_TUT_Helm_MindflayerCall_StartTrigger_189c40a7-a355-467d-be80-dbfd754fc67b)
AND
QRY_TUT_Helm_PartyMember(_Char)
AND
QRY_OnlyOnce("TUT_Helm_MindflayerCall_DialogStartOnlyOnce")
THEN
DB_TUT_Helm_CallDialogPlayer(_Char);
PROC_TUT_Helm_StartCallDialog((CHARACTER)_Char);

IF
DB_InRegion((CHARACTER)_Char,S_TUT_Helm_MindflayerCall_StartTrigger_189c40a7-a355-467d-be80-dbfd754fc67b)
AND
NOT QRY_TUT_Helm_PartyMember(_Char)
AND
CharacterGetOwner(_Char, _CharOwner)
AND
QRY_IsPartyMember(_CharOwner, 1)
AND
QRY_OnlyOnce("TUT_Helm_MindflayerCall_DialogStartOnlyOnce")
THEN
TeleportTo(_CharOwner, (TRIGGER)S_TUT_NautiloidEscape_Helm_b784add8-f417-4650-aa47-080cb29dc6d0, "", 0, 0, 0, 0, 0);
DB_TUT_Helm_CallDialogPlayer(_CharOwner);
PROC_TUT_Helm_StartCallDialog((CHARACTER)_CharOwner);

PROC
PROC_TUT_Helm_StartCallDialog((CHARACTER)_Player)
AND
NOT QRY_StartDialogCustom((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846, _Player, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 0, 0)
THEN
PROC_TUT_Helm_StartFinalCombat();

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, (INTEGER)_ID)
AND
DB_TUT_Helm_CallDialogPlayer(_Player)
AND
DB_PartyMembers((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
AND
DB_InRegion(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,(TRIGGER)S_TUT_Helm_FinalCombatTeleportingTrigger_53dd14f6-1571-4cae-b223-83b42cd3bc3a)
THEN
PROC_DialogAddSpeakingActor(_ID, S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, (INTEGER)_ID)
AND
DB_TUT_Guide(_Char)
AND
DB_InRegion(_Char,(TRIGGER)S_TUT_Helm_FinalCombatTeleportingTrigger_53dd14f6-1571-4cae-b223-83b42cd3bc3a)
AND
DB_TUT_Helm_CallDialogPlayer(_Player)
AND
_Char != _Player
THEN
PROC_DialogAddSpeakingActor(_ID, _Char);

IF
AttackedBy((CHARACTER)_Character,_AttackerOwner,_Attacker,_,_,_,_)
AND
DB_TUT_Helm_CambionAndMindFlayer(_Character)
AND
NOT DB_GlobalFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54)
AND
QRY_GetCharacterOwnerIfItemSummon(_AttackerOwner,_Attacker)
AND
DB_QRYRTN_GetCharacterOwnerIfItemSummon(_ResolvedAttacker)
AND
QRY_TUT_Helm_PartyMember((CHARACTER)_ResolvedAttacker)
AND
QRY_OnlyOnce("TUT_Helm_MindflayerCall_DialogStartOnlyOnce")
AND
NOT QRY_StartDialogCustom((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846, _ResolvedAttacker, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 0, 0)
THEN
PROC_TUT_Helm_StartFinalCombat();

// Familiar or ranger companion case: start combat
IF
AttackedBy((CHARACTER)_Character,_AttackerOwner,_Attacker,_,_,_,_)
AND
DB_TUT_Helm_CambionAndMindFlayer(_Character)
AND
NOT DB_GlobalFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54)
AND
QRY_GetCharacterOwnerIfItemSummon(_AttackerOwner,_Attacker)
AND
DB_QRYRTN_GetCharacterOwnerIfItemSummon(_ResolvedAttacker)
AND
QRY_IsPartyMember(_ResolvedAttacker, 1)
AND
NOT QRY_TUT_Helm_PartyMember((CHARACTER)_ResolvedAttacker)
AND
QRY_OnlyOnce("TUT_Helm_MindflayerCall_DialogStartOnlyOnce")
THEN
PROC_TUT_Helm_StartFinalCombat();

IF
EnteredCombat(_Player,_ID)
AND
NOT DB_GlobalFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54)
AND
QRY_TUT_Helm_PartyMember((CHARACTER)_Player)
AND
DB_TUT_Helm_CambionAndMindFlayer((CHARACTER)_Character)
AND
DB_Is_InCombat(_Character,_CombatID)
AND
_ID == _CombatID
AND
QRY_OnlyOnce("TUT_Helm_MindflayerCall_DialogStartOnlyOnce")
AND
NOT QRY_StartDialogCustom((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846, _Player, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 0, 0)
THEN
PROC_TUT_Helm_StartFinalCombat();

// Familiar or ranger companion case: start combat
IF
EnteredCombat(_Char,_ID)
AND
QRY_IsPartyMember(_Char, 1)
AND
NOT DB_GlobalFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54)
AND
DB_TUT_Helm_CambionAndMindFlayer((CHARACTER)_Character)
AND
DB_Is_InCombat(_Character,_CombatID)
AND
_ID == _CombatID
AND
NOT QRY_TUT_Helm_PartyMember((CHARACTER)_Char)
AND
QRY_OnlyOnce("TUT_Helm_MindflayerCall_DialogStartOnlyOnce")
THEN
PROC_TUT_Helm_StartFinalCombat();

// Check if it's a player, Lae'zel or Us
QRY
QRY_TUT_Helm_PartyMember((CHARACTER)_Attacker)
AND
DB_Players(_Attacker)
THEN
DB_NOOP(1);

QRY
QRY_TUT_Helm_PartyMember((CHARACTER)_Attacker)
AND
DB_TutorialCompanion(_Attacker)
THEN
DB_NOOP(1);

IF
DB_Dead(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846)
THEN
PROC_ForceStopDialog(S_TUT_Helm_MindflayerHelper_efd4c6ae-90cb-4109-adb1-165b25387aac);

IF
DB_GlobalFlag((FLAG)TUT_Helm_Event_TeleportToHelm_da46bc45-e134-4be9-a8d2-19eb9d460f74)
AND
QRY_OnlyOnce("TUT_Helm_TeleportInside")
THEN
PROC_TUT_Helm_Teleport();

IF
DialogEnded((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, _ID)
AND
QRY_OnlyOnce("TUT_Helm_TeleportInside")
THEN
PROC_TUT_Helm_Teleport();

PROC
PROC_TUT_Helm_Teleport()
AND
DB_TUT_Helm_DidReadyCheck(1)
AND
DB_Players((CHARACTER)_Player)
AND
DB_InRegion(_Player,(TRIGGER)S_TUT_Helm_FinalCombatTeleportingTrigger_53dd14f6-1571-4cae-b223-83b42cd3bc3a)
THEN
TeleportTo(_Player, S_TUT_Helm_PointOfNoReturn_6c4f1de5-89c5-4944-bda3-f1304c7fbc6a,"",0,1,1,0,1);

PROC
PROC_TUT_Helm_Teleport()
AND
NOT DB_TUT_Helm_DidReadyCheck(1)
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
DB_InRegion(_PartyMember,(TRIGGER)S_TUT_Helm_FinalCombatTeleportingTrigger_53dd14f6-1571-4cae-b223-83b42cd3bc3a)
THEN
TeleportTo(_PartyMember, S_TUT_Helm_PointOfNoReturn_6c4f1de5-89c5-4944-bda3-f1304c7fbc6a,"",0,0,0,0,1);

PROC
PROC_TUT_Helm_StartWarningFires()
AND
DB_TUT_Helm_BacktrackingFireTriggers(_Trigger)
AND
Random(1500,_Random)
THEN
ObjectTimerLaunch(_Trigger, "TUT_Helm_MakeFireWarning",_Random);

IF
DialogEnded((DIALOGRESOURCE)TUT_Helm_MindflayerCall_de5c59ce-274f-0450-df3d-1d0754631c84, _ID)
THEN
PROC_TUT_Helm_StartFinalCombat();

PROC
PROC_TUT_Helm_StartFinalCombat()
AND
QRY_OnlyOnce("TUT_Helm_StartNarrativeCombat")
THEN
PROC_GLO_NarrativeCombat_StartCombat("TUT_Helm_FinalCombat");
PROC_TUT_Helm_HandleNarrativeCombat();

IF
DB_Sees(_Entity,_OtherEntity)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_)
AND
DB_GLO_NarrativeCombat_Participant("TUT_Helm_FinalCombat",_,_OtherEntity)
AND
NOT QRY_TUT_Helm_CantJoinNarrativeCombat(_Entity)
THEN
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",_Entity);

IF
StatusRemoved(_Entity,_Status,_,_)
AND
DB_TUT_Helm_DisablingStatus(_Status)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_)
AND
NOT DB_GLO_NarrativeCombat_Participant("TUT_Helm_FinalCombat",_,_Entity)
AND
DB_GLO_NarrativeCombat_Participant("TUT_Helm_FinalCombat",_,_OtherEntity)
AND
CanSee(_Entity,_OtherEntity,1)
THEN
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",_Entity);

PROC
PROC_GLO_NarrativeCombat_CharacterEnteredRegion(_Char,(TRIGGER)S_TUT_Helm_HelmNarrativeCombatRegion_5a670796-d16f-4b10-bea5-56393263d251)
AND
NOT DB_Defeated(_Char)
THEN
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",_Char);

QRY
QRY_TUT_Helm_CantJoinNarrativeCombat((GUIDSTRING)_Entity)
AND
DB_TUT_Helm_DisablingStatus(_Status)
AND
HasActiveStatus(_Entity, _Status,1)
THEN
DB_NOOP(1);


PROC
PROC_TUT_Helm_HandleNarrativeCombat()
AND
DB_TUT_Helm_Devils(_Devil)
AND
IsOnStage(_Devil, 0)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_)
THEN
PROC_Appear((CHARACTER)_Devil);
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",_Devil);

PROC
PROC_TUT_Helm_HandleNarrativeCombat()
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
THEN
PROC_SetCanFight(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846,1);
PROC_SetCanFight(S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e,1);
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846);
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e);

PROC
PROC_TUT_Helm_HandleNarrativeCombat()
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
THEN
PROC_TriggerRegisterForParty((TRIGGER)S_TUT_Helm_HelmNarrativeCombatRegion_5a670796-d16f-4b10-bea5-56393263d251);
DB_GLO_NarrativeCombat_Region("TUT_Helm_FinalCombat",(TRIGGER)S_TUT_Helm_HelmNarrativeCombatRegion_5a670796-d16f-4b10-bea5-56393263d251);
SetFlag(TUT_Misc_Quest_ReachedHelm_f61440b7-4118-4936-b165-40677fff1a9c, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_TUT_Helm_HandleNarrativeCombat()
AND
DB_TUT_Helm_NPCsFromOtherAreas(_Character)
AND
NOT DB_PermaDefeated(_Character)
AND
NOT DB_Defeated(_Character)
THEN
PROC_TUT_Helm_CheckNPCReachedHelm(_Character);

PROC
PROC_TUT_Helm_CheckNPCReachedHelm((CHARACTER)_Character)
AND
IsInTrigger(_Character,(TRIGGER)S_TUT_Helm_HelmNarrativeCombatRegion_5a670796-d16f-4b10-bea5-56393263d251,1)
THEN
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",_Character);


PROC
PROC_TUT_Helm_CheckNPCReachedHelm((CHARACTER)_Character)
AND
IsInTrigger(_Character,(TRIGGER)S_TUT_Helm_HelmNarrativeCombatRegion_5a670796-d16f-4b10-bea5-56393263d251,0)
THEN
TriggerRegisterForCharacter((TRIGGER)S_TUT_Helm_HelmNarrativeCombatRegion_5a670796-d16f-4b10-bea5-56393263d251,_Character);

PROC
PROC_TUT_Helm_HandleNarrativeCombat()
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_)
AND
DB_PartyMembers(_PartyMember)
AND
NOT DB_Defeated(_PartyMember)
AND
IsInTrigger(_PartyMember,(TRIGGER)S_TUT_Helm_PointOfNoReturn_6c4f1de5-89c5-4944-bda3-f1304c7fbc6a,1)
THEN
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",_PartyMember);

IF
EnteredCombat(_PartyMember,_ID)
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
AND
DB_TUT_Helm_FinalCombatPaused(1)
THEN
ResumeCombat(_ID);

IF
CombatPaused(_ID)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
AND
NOT DB_TUT_Helm_FinalCombatPaused(1)
THEN
DB_TUT_Helm_FinalCombatPaused(1);

IF
CombatResumed(_ID)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
AND
DB_TUT_Helm_FinalCombatPaused(1)
THEN
NOT DB_TUT_Helm_FinalCombatPaused(1);

IF
LeftCombat(_PartyMember,_ID)
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
AND
CombatGetInvolvedPartyMembersCount(_ID,0)
THEN
PauseCombat(_ID);

IF
DB_Is_InCombat(_Player,_ID)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
AND
QRY_OnlyOnce("TUT_Helm_StartHelmTimer")
THEN
SetFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54);
TurnBasedTimerLaunch(_Player, "TUT_Helm_Timer", "TUT_Helm_TransponderTimer", 90000);

PROC
PROC_TUT_Helm_RoundEvent(16)
AND
NOT DB_TUT_Helm_TransponderUser(_)
THEN
PROC_TUT_Helm_GameOver();

//END_REGION

//REGION Devils
PROC
PROC_CounterDecreased("TUT_Helm_DevilCount")
AND
DB_GlobalCounter("TUT_Helm_DevilCount", _Count)
AND
_Count == 0
THEN
NOT DB_GlobalCounter("TUT_Helm_DevilCount", _Count);

PROC
PROC_GLO_DefeatCounter_Notify("TUT_Helm_Devils", _, _, _)
AND
QRY_GLO_DefeatCounter_Count("TUT_Helm_Devils", "Active")
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_AliveCount)
AND
_AliveCount <= 2
AND
DB_OnlyOnce("TUT_Helm_PlayerJoinedCombat")
THEN
DB_GlobalCounter("TUT_Helm_DevilCount", 2);
PROC_CounterDecreased("TUT_Helm_DevilCount");

//END_REGION

//REGION Combat Events and Reactions

//REGION Rubble

IF
TurnStarted(_Char)
AND
DB_TUT_Helm_RubbleDelayed(1)
AND
NOT DB_Players((CHARACTER)_Char)
AND
DB_Is_InCombat(_Char, _ID)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
THEN
NOT DB_TUT_Helm_RubbleDelayed(1);
PROC_TUT_Helm_RubbleFall();

IF
TurnStarted(_Player)
AND
DB_Players((CHARACTER)_Player)
AND
DB_Is_InCombat(_Player, _ID)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
THEN
DB_TUT_Helm_PlayerTurn(1);



IF
TurnEnded(_Player)
AND
DB_Players((CHARACTER)_Player)
AND
DB_Is_InCombat(_Player, _ID)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
THEN
NOT DB_TUT_Helm_PlayerTurn(1);

PROC
PROC_TUT_Helm_RubbleFall()
AND
DB_TUT_Helm_PlayerTurn(1)
THEN
DB_TUT_Helm_RubbleDelayed(1);

PROC
PROC_TUT_Helm_RubbleFall()
AND
NOT DB_TUT_Helm_PlayerTurn(1)
THEN
PROC_LoopEffect((EFFECTRESOURCE)VFX_Script_Tutorial_CameraShake_01_0661ac5d-e5e7-79ad-0a1e-538a31a4ce0a, S_TUT_Helm_RubbleHelper_bd53b9a1-2231-4239-abd7-eb53ca56802f, "TUT_Helm_RubbleCollapse", "TUT_Avernus_C", "");
ObjectTimerCancel(S_TUT_Helm_RubbleHelper_bd53b9a1-2231-4239-abd7-eb53ca56802f, "TUT_Helm_RubbleCollapse");
ObjectTimerLaunch(S_TUT_Helm_RubbleHelper_bd53b9a1-2231-4239-abd7-eb53ca56802f, "TUT_Helm_RubbleCollapse", 5000);

IF
ObjectTimerFinished(_Helper, "TUT_Helm_RubbleCollapse")
THEN
PROC_StopLoopEffect(_Helper, "TUT_Helm_RubbleCollapse");

//END_REGION


//REGION  Bulbs
IF
Fell((ITEM)_Item, _)
AND
GetTemplate(_Item,Quest_CMB_StalkBulb_Gravity_10c7fb61-9c54-4910-a152-78ae743e51fb)
THEN
Die(_Item);
//END_REGION

IF
CombatRoundStarted(_ID, _Round)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
AND
DB_TUT_Helm_RoundCount(_Count)
AND
IntegerSum(_Count, 1, _NewCount)
THEN
NOT DB_TUT_Helm_RoundCount(_Count);
DB_TUT_Helm_RoundCount(_NewCount);
PROC_TUT_Helm_RoundEvent((INTEGER)_NewCount);

PROC
PROC_TUT_Helm_RoundEvent(_Integer)
AND
DB_TUT_Helm_RoundsRubble(_Integer)
THEN
PROC_TUT_Helm_RubbleFall();

//REGION First Round Events

PROC
PROC_TUT_Helm_RoundEvent(1)
THEN
DB_GLO_DefeatCounter_Target("TUT_Helm_DevilCount", 2);

//END_REGION

//REGION Second Round Events

PROC
PROC_TUT_Helm_RoundEvent(2)
AND
DB_Players(_Player)
THEN
DB_GlobalCounter("TUT_Helm_DevilCount", 2);
PROC_CounterDecreased("TUT_Helm_DevilCount");



//END_REGION


//REGION Fourth Round Events

PROC
PROC_TUT_Helm_RoundEvent(4)
THEN
DB_GlobalCounter("TUT_Helm_DevilCount", 2);
PROC_CounterDecreased("TUT_Helm_DevilCount");


//END_REGION

//REGION Fifth Round Events

PROC
PROC_TUT_Helm_RoundEvent(5)
THEN
DB_GlobalCounter("TUT_Helm_DevilCount", 2);
PROC_CounterDecreased("TUT_Helm_DevilCount");

//END_REGION

//REGION Cambion backup
//Add Cambions to the Fight
PROC
PROC_TUT_Helm_RoundEvent(6)
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,"MEDIUM",1)
AND
DB_TUT_Helm_Devils_BackUpCambions(_Cambion)
AND
QRY_OnlyOnce("TUT_Helm_SpawnCambionBackUp_OnlyOnce")
THEN
PROC_TUT_Helm_SpawnCambionBackUp();

//Cambions arrive sooner in Hardcore Mode
PROC
PROC_TUT_Helm_RoundEvent(5)
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,"HARD",1)
AND
DB_TUT_Helm_Devils_BackUpCambions(_Cambion)
AND
QRY_OnlyOnce("TUT_Helm_SpawnCambionBackUp_OnlyOnce")
THEN
PROC_TUT_Helm_SpawnCambionBackUp();

//Cambions arrive later in Story Mode
PROC
PROC_TUT_Helm_RoundEvent(8)
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,"EASY",1)
AND
DB_TUT_Helm_Devils_BackUpCambions(_Cambion)
AND
QRY_OnlyOnce("TUT_Helm_SpawnCambionBackUp_OnlyOnce")
THEN
PROC_TUT_Helm_SpawnCambionBackUp();

//If they didn's spawn for some reason or no difficulty defined
PROC
PROC_TUT_Helm_RoundEvent(9)
AND
DB_TUT_Helm_Devils_BackUpCambions(_Cambion)
AND
QRY_OnlyOnce("TUT_Helm_SpawnCambionBackUp_OnlyOnce")
THEN
PROC_TUT_Helm_SpawnCambionBackUp();

IF
DB_TUT_Helm_Devils_BackUpCambions(_Cambion)
THEN
TriggerRegisterForCharacter((TRIGGER)S_TUT_Helm_ConsolePointArea_870b647f-5853-4f1a-9c39-a4915808201a,_Cambion);
TriggerRegisterForCharacter((TRIGGER)S_TUT_Helm_CambionBackUpCombatJoin_2c4780faS_TUT_Helm_CambionBackUpCombatJoin_2c4780fa-2697-4ad8-99c0-3571ba505277,_Cambion);

IF
EnteredTrigger(_Cambion,(TRIGGER)S_TUT_Helm_ConsolePointArea_870b647f-5853-4f1a-9c39-a4915808201a)
THEN
TriggerUnregisterForCharacter((TRIGGER)S_TUT_Helm_ConsolePointArea_870b647f-5853-4f1a-9c39-a4915808201a,_Cambion);
SetFlag((FLAG)TUT_Helm_Event_ReachedTransponder_f48e0c6e-495f-44c3-b0bf-b30819cd0e6e,_Cambion);

IF
Died(_Boss)
AND
DB_TUT_Helm_CambionAndMindFlayer(_Boss)
THEN
NOT DB_TUT_Helm_CambionAndMindFlayer(_Boss);
PROC_TUT_Helm_CheckCambionAndMindFlayerAreDead();

PROC
PROC_TUT_Helm_CheckCambionAndMindFlayerAreDead()
AND
NOT DB_TUT_Helm_CambionAndMindFlayer(_)
AND
QRY_OnlyOnce("TUT_Helm_SpawnCambionBackUp_OnlyOnce")
THEN
PROC_TUT_Helm_SpawnCambionBackUp();

PROC
PROC_TUT_Helm_SpawnCambionBackUp()
AND
NOT DB_TUT_Helm_GameOver(1)
AND
DB_TUT_Helm_Devils_BackUpCambions(_Cambion)
THEN
PROC_Appear(_Cambion);
DB_SpotPlayers((CHARACTER)_Cambion, "TUT_Helm_CambionSpot", NULL_00000000-0000-0000-0000-000000000000, (FLAG)TUT_Helm_State_CambionStopSpotting_7f58caad-625b-4eea-96fa-906021cb688f);
DB_SpotPlayers_IgnoreCombat((CHARACTER)_Cambion, "TUT_Helm_CambionSpot");
DB_SpotPlayers_CustomRadius((CHARACTER)_Cambion, "TUT_Helm_CambionSpot", 8.0);
DB_SpotPlayers_TargetIgnoreCantTalk((CHARACTER)_Cambion, "TUT_Helm_CambionSpot");
DB_SpotPlayers_IncludeWildshapedPlayers((CHARACTER)_Cambion, "TUT_Helm_CambionSpot");

IF
WentOnStage(_Cambion,1)
AND
DB_TUT_Helm_Devils_BackUpCambions((CHARACTER)_Cambion)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
THEN
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",_Cambion);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_Cambion, "TUT_Helm_CambionSpot", (CHARACTER)_Player)
AND
DB_TUT_Helm_Devils_BackUpCambions(_Cambion)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("TUT_Helm_CambionSpottedPlayer")
THEN
SetFlag((FLAG)TUT_Helm_State_CambionStopSpotting_7f58caad-625b-4eea-96fa-906021cb688f, NULL_00000000-0000-0000-0000-000000000000);
PROC_TryStartAD((DIALOGRESOURCE)TUT_Helm_AD_BackUpCambion_d25cd41c-b0e4-551b-7d46-2ccead0b8393, _Cambion);


//END_REGION

//REGION Combat ADs
//Define When ADs are queued for
PROC
PROC_TUT_Helm_Init()
THEN
DB_TUT_Helm_CombatPlayerADs(TUT_Helm_VB_FirstWarning_d532434e-80d5-6f2f-df02-129dae65d36b,1);
DB_TUT_Helm_CombatPlayerADs(TUT_Helm_VB_LastWarning_2a416f95-ffaf-f5c9-ddfc-7bebd9bb4244,4);
DB_TUT_Helm_CombatNpcADs((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000,99); //REPLACE WITH PROPER AD IF WE HAVE ONE

//Execute Queued NPC AD
IF
TurnStarted(_NPC)
AND
NOT DB_Avatars((CHARACTER)_NPC) //For Laezel
AND
DB_GlobalFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54)
AND
DB_TUT_Helm_CombatNPCADQueued((CHARACTER)_NPC,_Dialog)
AND
NOT DB_TUT_Helm_CombatNpc_AssaultReactionAD(_NPC,_)
AND
QRY_SpeakerIsAvailable(_NPC,1)
THEN
PROC_TryStartAD(_Dialog,_NPC);
NOT DB_TUT_Helm_CombatNPCADQueued(_NPC,_Dialog);

//Execute NPC Assault Reaction AD
IF
TurnStarted((CHARACTER)_NPC)
AND
DB_GlobalFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54)
AND
DB_TUT_Helm_CombatNpc_AssaultReactionAD(_NPC,_Dialog)
AND
QRY_SpeakerIsAvailable(_NPC,1)
THEN
SetEntityEventReal(_NPC,"GLO_CombatWait",2.0);
PROC_TryStartAD(_Dialog,_NPC);
NOT DB_TUT_Helm_CombatNpc_AssaultReactionAD(_NPC,_Dialog);

//Execute Queued Player AD

IF
TurnStarted((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54)
AND
DB_TUT_Helm_CombatPlayerADQueued(_Dialog)
AND
QRY_SpeakerIsAvailable(_Player,1)
THEN
StartVoiceBark(_Dialog,(CHARACTER)_Player);
NOT DB_TUT_Helm_CombatPlayerADQueued(_Dialog);

/*
IF
TurnStarted((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54)
AND
DB_TUT_Helm_Betrayal(1)
AND
QRY_SpeakerIsAvailable(_Player,1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_Helm_PAD_MindflayerBetrayal_72b7ce2e-c29c-9468-cd91-8abb37c0ac11,(CHARACTER)_Player);
*/
//DB_TUT_Helm_CombatPlayerADQueued(_Dialog)


//Define Queued Player AD
PROC
PROC_TUT_Helm_RoundEvent((INTEGER)_NewRound)
AND
DB_TUT_Helm_CombatPlayerADs(_Dialog,_DefinedRound)
AND
_NewRound >= _DefinedRound
AND
NOT DB_TUT_Helm_CombatPlayerADQueued(_)
THEN
DB_TUT_Helm_CombatPlayerADQueued((VOICEBARKRESOURCE)_Dialog);
NOT DB_TUT_Helm_CombatPlayerADs(_Dialog,_DefinedRound);

//Define Queued NPC AD
PROC
PROC_TUT_Helm_RoundEvent((INTEGER)_NewRound)
AND
DB_TUT_Helm_CombatNpcADs(_NPC,_Dialog,_DefinedRound)
AND
_Dialog != NULL_00000000-0000-0000-0000-000000000000
AND
_NewRound >= _DefinedRound
AND
NOT DB_TUT_Helm_CombatNPCADQueued(_NPC,_)
THEN
DB_TUT_Helm_CombatNPCADQueued((CHARACTER)_NPC,_Dialog);
NOT DB_TUT_Helm_CombatNpcADs(_NPC,_Dialog,_DefinedRound);

//REGION Assault AD Events

IF
AttackedBy(S_TUT_Helm_Devil_005_ed103005-fd71-457d-ae6c-39654bbd8f2e,_AttackerOwner,_Attacker,_,_,_,_)
AND
DB_GlobalFlag((FLAG)TUT_Helm_JoinedMindflayerFight_ec25d7dc-f9d6-47ff-92c9-8921d6e32f54)
AND
QRY_GetCharacterOwnerIfItemSummon(_AttackerOwner,_Attacker)
AND
DB_QRYRTN_GetCharacterOwnerIfItemSummon(_ResolvedAttacker)
AND
DB_Players(_ResolvedAttacker)
AND
QRY_OnlyOnce("TUT_Helm_CombatNpc_AssaultReactionAD")
THEN
DB_TUT_Helm_CombatNpc_AssaultReactionAD(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,TUT_Helm_AD_LaezelIgnoreCambion_381314d8-ad7b-8a33-d48a-6931f3f8ee2b);
DB_TUT_Helm_CombatNpc_AssaultReactionAD(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846,TUT_Helm_AD_MindFlayerIgnoreCambion_8031bf13-8468-dd39-0782-402aca59d6a8);


//END_REGION

//END_REGION

//END_REGION

//REGION Second Wave of Imps

IF
DB_TUT_Helm_Devils_BackUp((CHARACTER)_Devil)
THEN
SetOnStage(_Devil,0);
AddPreferredAiTargetTag((CHARACTER)_Devil,(TAG)AVATAR_306b9b05-1057-4770-aa17-01af21acd650);
AddPreferredAiTargetTag((CHARACTER)_Devil,(TAG)REALLY_LAEZEL_b5682d1d-c395-489c-9675-1f9b0c328ea5);
AddPreferredAiTargetTag((CHARACTER)_Devil,(TAG)INTELLECT_DEVOURER_69901347-23cb-4f60-abf3-527f23cdf0db);

IF
DialogEnded((DIALOGRESOURCE)TUT_Helm_DragonAppears_6ffc2909-a928-4b8b-6901-02d823e68880, _)
AND
DB_TUT_Helm_Devils_BackUp((CHARACTER)_Devil)
AND
GetPosition(_Devil, _X, _Y, _Z)
THEN
AppearAtPosition(_Devil, _X, _Y, _Z, 1, (ANIMATION)CUST_ImpDrop_01_0bf529ab-710a-46cc-9c4b-f3b54c47f25f, "");
PROC_GLO_NarrativeCombat_JoinCombat("TUT_Helm_FinalCombat",_Devil);

//END_REGION

//REGION End Conditions

//REGION Transponder 

QRY
QRY_TUT_Helm_CheckWildshape((CHARACTER)_Char)
AND
DB_Is_WildShaped(_Char)
THEN
PROC_RemoveAllPolymorphs(_Char);

QRY
QRY_TUT_Helm_CheckWildshape((CHARACTER)_Char)
AND
NOT DB_Is_WildShaped(_Char)
THEN
DB_NOOP(1);

QRY
QRY_TUT_Helm_CheckIfActive((CHARACTER)_Char)
AND
NOT DB_Players(_Char)
AND
DB_Players(_Player)
AND
QRY_SameUser(_Char, _Player)
THEN
DB_TUT_Helm_MakePlayerActive(_Player);

QRY
QRY_TUT_Helm_CheckIfActive((CHARACTER)_Char)
AND
DB_Players(_Char)
THEN
DB_NOOP(1);

QRY
QRY_TUT_Helm_PlayersInDialog((CHARACTER)_Char)
AND
DB_PartyMembers(_Player)
AND
_Player != _Char
AND
IsSpeakerReserved(_Player, 1)
AND
SpeakerGetDialog(_Player, 1, _Dialog, _ID)
THEN
DB_TUT_Helm_InterruptedDialogs(_ID, _Char);
DialogRequestStop(_Player);

IF
DialogEnded(_, _ID)
AND
DB_TUT_Helm_InterruptedDialogs(_ID, _Char)
THEN
NOT DB_TUT_Helm_InterruptedDialogs(_ID, _Char);
PROC_TUT_Helm_RetryTransponder((CHARACTER)_Char);

PROC
PROC_TUT_Helm_RetryTransponder((CHARACTER)_Char)
AND
NOT DB_TUT_Helm_InterruptedDialogs(_, _)
THEN
PROC_TUT_Helm_TryTransponder((CHARACTER)_Char);

IF
UseStarted(_Char, S_TUT_Helm_ControlPanel_bcbba417-6403-40a6-aef6-6785d585df2a)
AND
DB_PlayerSummons(_Char)
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_Helm_AD_CreatureCantUseTransponder_1e44dd42-e7ca-2792-7b05-86cb23b40668, _Char);

IF
UseStarted(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, S_TUT_Helm_ControlPanel_bcbba417-6403-40a6-aef6-6785d585df2a)
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_Helm_AD_CreatureCantUseTransponder_1e44dd42-e7ca-2792-7b05-86cb23b40668, S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

IF
UseStarted(_Char, S_TUT_Helm_ControlPanel_bcbba417-6403-40a6-aef6-6785d585df2a)
AND
_Char != S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558
AND
NOT DB_PlayerSummons(_Char)
THEN
PROC_TUT_Helm_TryTransponder((CHARACTER)_Char);

PROC
PROC_TUT_Helm_TryTransponder((CHARACTER)_Char)
AND
QRY_TUT_Helm_CheckWildshape((CHARACTER)_Char)
AND
QRY_TUT_Helm_CheckIfActive((CHARACTER)_Char)
AND
NOT QRY_TUT_Helm_PlayersInDialog((CHARACTER)_Char)
AND
QRY_OnlyOnce("TUT_StartHelm_Dialog")
THEN
DB_TUT_Helm_TransponderUser(_Char);
PROC_TUT_Helm_Transponder((CHARACTER)_Char);

PROC
PROC_TUT_Helm_Transponder((CHARACTER)_Char)
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, _Char, 0, 0, 0, 0)
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, (INTEGER)_ID)
THEN
DialogSetTeleportPartyToLevelOnEnded(_ID, "WLD_Main_A");

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, (INTEGER)_ID)
AND
DB_Players(_Player)
AND
HasAppliedStatusOfType(_Player, "DOWNED", 1)
THEN
SetHitpointsPercentage(_Player,100.0);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, (INTEGER)_ID)
AND
DB_TutorialCompanion(_Char)
AND
NOT DB_TUT_Helm_TransponderUser(_Char)
THEN
PROC_DialogAddListeningActor(_ID, _Char);


PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, (INTEGER)_ID)
AND
DB_Players(_Player)
AND
NOT DB_TUT_Helm_TransponderUser(_Player)
THEN
PROC_DialogAddListeningActor(_ID, _Player);



IF
DialogEnded((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, _)
AND
DB_TUT_Helm_MakePlayerActive(_Player)
THEN
NOT DB_TUT_Helm_MakePlayerActive(_Player);
MakePlayerActive(_Player);

IF
DialogStarted((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, _)
AND
DB_Players((CHARACTER)_Player)
THEN
TurnBasedTimerCancel(_Player,"TUT_Helm_Timer");

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)TUT_Helm_TransponderActivated_40d32a6d-8d41-4ceb-a4e9-bbd34d0664e4)
THEN
PROC_TUT_Helm_InitiateEndTutorial();

//END_REGION

//END_REGION

//REGION Dragon cinematic
IF
DB_TUT_Guide(_Guide)
THEN
TriggerRegisterForCharacter(S_TUT_Helm_DragonTrigger_3ca543c8-75b7-4f1f-9415-941c83904fda, _Guide);
TriggerRegisterForCharacter((TRIGGER)S_TUT_Helm_MindMeldTrigger_3e0656be-0613-4e7d-9c1b-894628e812f6, _Guide);

IF
DB_TutorialCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
TriggerRegisterForCharacter(S_TUT_Helm_DragonTrigger_3ca543c8-75b7-4f1f-9415-941c83904fda, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
TriggerRegisterForCharacter((TRIGGER)S_TUT_Helm_MindMeldTrigger_3e0656be-0613-4e7d-9c1b-894628e812f6, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
DB_InRegion(_Player, S_TUT_Helm_DragonTrigger_3ca543c8-75b7-4f1f-9415-941c83904fda)
AND
DB_Players(_Player)
AND
NOT DB_Defeated(_Player)
AND
NOT DB_TutorialCompanion(_Player)
THEN
DB_TUT_Helm_DragonAppearDialogueStart(1);
PROC_TUT_Helm_StartDragonCinematic(_Player);

IF
DB_InRegion(_Guide, S_TUT_Helm_DragonTrigger_3ca543c8-75b7-4f1f-9415-941c83904fda)
AND
DB_TUT_Guide(_Guide)
AND
NOT DB_Defeated(_Guide)
THEN
PROC_TUT_Helm_GetClosestPlayerToGuideAndTriggerDragon((CHARACTER)_Guide);

IF
DB_InRegion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, S_TUT_Helm_DragonTrigger_3ca543c8-75b7-4f1f-9415-941c83904fda)
AND
DB_TutorialCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_Defeated((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_TUT_Helm_GetClosestPlayerToGuideAndTriggerDragon((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

PROC
PROC_TUT_Helm_GetClosestPlayerToGuideAndTriggerDragon((CHARACTER)_Char)
AND
DB_TUT_Helm_ClosestToGuide(_Player, _Dist)
THEN
NOT DB_TUT_Helm_ClosestToGuide(_Player, _Dist);
DB_TUT_Helm_ClosestToGuide(NULL_00000000-0000-0000-0000-000000000000, 9999.0);

PROC
PROC_TUT_Helm_GetClosestPlayerToGuideAndTriggerDragon((CHARACTER)_Char)
AND
DB_Players(_Player)
AND
NOT DB_TutorialCompanion(_Player)
AND
DB_TutorialCompanion(_Char)
AND
NOT DB_Defeated(_Player)
AND
DB_InRegion(_Player, (TRIGGER)S_TUT_Helm_MindMeldTrigger_3e0656be-0613-4e7d-9c1b-894628e812f6)
AND
GetDistanceTo(_Player, _Char, _Dist)
AND
DB_TUT_Helm_ClosestToGuide(_OtherPlayer, _SmallerDist)
AND
_Dist < _SmallerDist
THEN
NOT DB_TUT_Helm_ClosestToGuide(_OtherPlayer, _SmallerDist);
DB_TUT_Helm_ClosestToGuide(_Player, _Dist);

PROC
PROC_TUT_Helm_GetClosestPlayerToGuideAndTriggerDragon((CHARACTER)_Char)
AND
DB_TUT_Helm_ClosestToGuide(_Player, _)
AND
_Player != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_TUT_Helm_DragonAppearDialogueStart(1);
PROC_TUT_Helm_StartDragonCinematic((CHARACTER)_Player);

//Can't find any available player, use the guide
PROC
PROC_TUT_Helm_GetClosestPlayerToGuideAndTriggerDragon((CHARACTER)_Guide)
AND
DB_TUT_Helm_ClosestToGuide(_Player, _)
AND
_Player == NULL_00000000-0000-0000-0000-000000000000
AND
DB_TUT_Guide(_Guide)
AND
DB_InRegion(_Guide, (TRIGGER)S_TUT_Helm_MindMeldTrigger_3e0656be-0613-4e7d-9c1b-894628e812f6)
THEN
DB_TUT_Helm_DragonAppearDialogueStart(1);
PROC_TUT_Helm_StartDragonCinematic((CHARACTER)_Guide);

//Can't find any available player, use the guide
PROC
PROC_TUT_Helm_GetClosestPlayerToGuideAndTriggerDragon((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_TUT_Helm_ClosestToGuide(_Player, _)
AND
_Player == NULL_00000000-0000-0000-0000-000000000000
AND
NOT DB_Defeated((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_InRegion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_TUT_Helm_MindMeldTrigger_3e0656be-0613-4e7d-9c1b-894628e812f6)
THEN
DB_TUT_Helm_DragonAppearDialogueStart(1);
PROC_TUT_Helm_StartDragonCinematic((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

PROC
PROC_TUT_Helm_StartDragonCinematic((CHARACTER)_Player)
AND
NOT DB_OnlyOnce("TUT_Helm_DragonAppeared")
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)TUT_Helm_DragonAppears_6ffc2909-a928-4b8b-6901-02d823e68880, S_TUT_Helm_DragonCinematicHelper_7a74eb50-dcc9-4830-a83d-61d3568dc850, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Player, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 0, 0)
AND
QRY_OnlyOnce("TUT_Helm_DragonAppeared")
THEN
PROC_TriggerUnregisterForPlayers(S_TUT_Helm_DragonTrigger_3ca543c8-75b7-4f1f-9415-941c83904fda);
TriggerUnregisterForCharacter(S_TUT_Helm_DragonTrigger_3ca543c8-75b7-4f1f-9415-941c83904fda,S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
DB_OnlyOnce("TUT_Helm_DragonAppeared")
AND
DB_TUT_Guide(_Guide)
THEN
TriggerUnregisterForCharacter(S_TUT_Helm_DragonTrigger_3ca543c8-75b7-4f1f-9415-941c83904fda,_Guide);

QRY
QRY_SpeakerIsInDialogRange((CHARACTER)S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846, _Player)
AND
DB_TUT_Helm_DragonAppearDialogueStart(1)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)TUT_Helm_DragonAppears_6ffc2909-a928-4b8b-6901-02d823e68880, _)
THEN
NOT DB_TUT_Helm_DragonAppearDialogueStart(1);

IF 
DialogRequestFailed(TUT_Helm_DragonAppears_6ffc2909-a928-4b8b-6901-02d823e68880, _)
AND
QRY_OnlyOnce_Reset("TUT_Helm_DragonAppeared")
THEN
DB_NOOP(1);
//END_REGION

//REGION GameOver trigger
IF
DB_TUT_Guide(_Guide)
THEN
TriggerRegisterForCharacter(S_TUT_Helm_PointOfNoReturn_6c4f1de5-89c5-4944-bda3-f1304c7fbc6a, _Guide);
TriggerRegisterForCharacter(S_TUT_Helm_GameOverTrigger_c77c73c4-94e2-4cbc-9206-743777e3ed24, _Guide);
TriggerRegisterForCharacter(S_TUT_IncinerateTrigger_2a7c57ad-970d-457a-a5aa-269e24c0fb5e, _Guide);

IF
DB_TUT_Helm_BacktrackingFireTriggers((TRIGGER)_Trigger)
THEN
PROC_TriggerRegisterForPlayers(_Trigger);

IF
EnteredTrigger(_Char, S_TUT_Helm_PointOfNoReturn_6c4f1de5-89c5-4944-bda3-f1304c7fbc6a)
THEN
DB_TUT_Helm_CrossedPointOfNoReturn(_Char);

IF
EnteredTrigger(_Char, S_TUT_Helm_GuideBacktrackWarning_41479227-6954-4a4d-a075-c00255c69399)
AND
DB_TUT_Helm_CrossedPointOfNoReturn(_Char)
AND
NOT DB_TUT_Guide(_Char) // Lae'zel telling herself to not go back would sound weird
AND
DB_TUT_Guide(_Guide) // Lae'zel telling herself to not go back would sound weird
AND
GetDistanceTo(_Char, _Guide, _Dist)
AND
_Dist <= 15.0
AND
DB_TUT_GuideDialogues("Backtrack", _Guide, _Dialog)
AND
QRY_OnlyOnce("TUT_Helm_BacktrackWarning")
THEN
PROC_TryStartAD(_Dialog, _Guide);


IF
EnteredTrigger(_Char, S_TUT_Helm_GuideBacktrackWarning_41479227-6954-4a4d-a075-c00255c69399)
AND
DB_TUT_Helm_CrossedPointOfNoReturn(_Char)
AND
QRY_OnlyOnce("TUT_Helm_StartFires")
THEN
PROC_CameraShakeAroundObject(_Char, 2000, 30.0);
PROC_TUT_Helm_StartWarningFires();

IF
EnteredTrigger(_Char, S_TUT_Helm_GuideBacktrackWarning_41479227-6954-4a4d-a075-c00255c69399)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_TUT_Helm_CrossedPointOfNoReturn(_Char)
AND
_Char != S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679
AND
GetDistanceTo(_Char, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, _Dist)
AND
_Dist <= 15.0
AND
QRY_OnlyOnce("TUT_Helm_BacktrackWarning")
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_Helm_AD_ShadowheartGoToHelmReminder_17c2dc71-e5e5-26db-3132-9ef7decbb7b0, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
EnteredTrigger(_Char, S_TUT_Helm_ScreenShake_7b08ca7a-3188-4b72-8120-1a39630a48b5)
AND
DB_TUT_Helm_CrossedPointOfNoReturn(_Char)
AND
NOT DB_TUT_Helm_ScreenShake(_Char)
THEN
DB_TUT_Helm_ScreenShake(_Char);
PROC_CameraShakeAroundObject(_Char, 6000, 30.0);

IF
EnteredTrigger(_Char, S_TUT_Helm_GameOverTrigger_c77c73c4-94e2-4cbc-9206-743777e3ed24)
AND
DB_TUT_Helm_CrossedPointOfNoReturn(_Char)
THEN
PROC_TUT_Helm_GameOver();

PROC
PROC_TUT_Helm_GameOver()
THEN
DB_TUT_Helm_GameOver(1);

// Party deaths
PROC
PROC_TUT_Helm_GameOver()
AND
DB_PartyMembers(_PartyMember)
AND
NOT DB_Dead(_PartyMember)
AND
NOT DB_InRegion(_PartyMember, S_TUT_IncinerateTrigger_2a7c57ad-970d-457a-a5aa-269e24c0fb5e)
THEN
Die(_PartyMember, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

PROC
PROC_TUT_Helm_GameOver()
AND
DB_PartyMembers(_PartyMember)
AND
NOT DB_Dead(_PartyMember)
AND
DB_InRegion(_PartyMember, S_TUT_IncinerateTrigger_2a7c57ad-970d-457a-a5aa-269e24c0fb5e)
THEN
Die(_PartyMember, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

// Tutorial companions deaths
PROC
PROC_TUT_Helm_GameOver()
AND
DB_TutorialCompanion(_Companion)
AND
NOT DB_Dead(_Companion)
AND
NOT DB_InRegion(_Companion, S_TUT_IncinerateTrigger_2a7c57ad-970d-457a-a5aa-269e24c0fb5e)
THEN
Die(_Companion, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

PROC
PROC_TUT_Helm_GameOver()
AND
DB_TutorialCompanion(_Companion)
AND
NOT DB_Dead(_Companion)
AND
DB_InRegion(_Companion, S_TUT_IncinerateTrigger_2a7c57ad-970d-457a-a5aa-269e24c0fb5e)
THEN
Die(_Companion, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

// Rest of NPCs
PROC
PROC_TUT_Helm_GameOver()
AND
DB_TUT_Helm_GameOver_NPCSToDie(_NPC)
AND
IsOnStage(_NPC, 1)
AND
NOT DB_Dead(_NPC)
AND
DB_TUT_Helm_GameOver_NPCSToIncinerate(_NPC)
AND
Random(1500, _Time)
THEN
RealtimeObjectTimerLaunch(_NPC, "TUT_Helm_DieFromFire", _Time);

PROC
PROC_TUT_Helm_GameOver()
AND
DB_TUT_Helm_GameOver_NPCSToDie(_NPC)
AND
IsOnStage(_NPC, 1)
AND
NOT DB_Dead(_NPC)
AND
NOT DB_TUT_Helm_GameOver_NPCSToIncinerate(_NPC)
AND
Random(1500, _Time)
THEN
RealtimeObjectTimerLaunch(_NPC, "TUT_Helm_DieFromBludgeoning", _Time);

IF
ObjectTimerFinished(_Char, "TUT_Helm_DieFromFire")
THEN
Die(_Char, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

IF
ObjectTimerFinished(_Char, "TUT_Helm_DieFromBludgeoning")
THEN
Die(_Char, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

// BIG BOOM
PROC
PROC_TUT_Helm_GameOver()
AND
DB_TUT_Helm_GameOverFire(_Trigger)
THEN
CreateSurface(_Trigger, "SurfaceFire", 50.0, -1.0);
CreateExplosion(_Trigger, "Projectile_Fireball", 10);

PROC
PROC_TUT_Helm_GameOver()
AND
DB_TUT_Helm_GameOverExplosion(_Trigger)
THEN
CreateExplosion(_Trigger, "Projectile_Fireball", 10);
//END_REGION

//REGION Reminder when getting close to the nerves
IF
DB_TUT_Guide(_Guide)
THEN
TriggerRegisterForCharacter(S_TUT_Helm_LastReminder_e0132d4a-3abb-4298-a688-c44e260d6a01, _Guide);

IF
EnteredTrigger(_Char, S_TUT_Helm_LastReminder_e0132d4a-3abb-4298-a688-c44e260d6a01)
AND
NOT DB_TUT_Helm_DevilsDefeated(1)
THEN
PROC_TUT_Helm_PlayLastReminder(_Char);

// First, give priority to guide (Laezel)
PROC
PROC_TUT_Helm_PlayLastReminder((CHARACTER)_Char)
AND
NOT DB_TUT_Guide(_Char)
AND
DB_TUT_Guide(_Guide)
AND
NOT DB_Defeated(_Guide)
AND
QRY_SpeakerIsInDialogRange(_Char, _Guide)
AND
DB_TUT_GuideDialogues("LastReminder", _Guide, _AD)
AND
QRY_OnlyOnce("TUT_Helm_LastReminder")
THEN
PROC_TryStartAD(_AD, _Guide);

//Give priority to Shadowheart Next
PROC
PROC_TUT_Helm_PlayLastReminder((CHARACTER)_Char)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_TUT_Guide(_Char)
AND
_Char != S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679
AND
NOT DB_Defeated((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_SpeakerIsInDialogRange(_Char, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_OnlyOnce("TUT_Helm_LastReminder")
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_Helm_AD_ShadowheartRemindsNerves_6996e9b1-057d-973a-8268-7bdf58fd26dd, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

// Then, the players
PROC
PROC_TUT_Helm_PlayLastReminder((CHARACTER)_Char)
AND
DB_Players(_Char)
AND
QRY_OnlyOnce("TUT_Helm_LastReminder")
THEN
PROC_TryStartAD(TUT_Helm_PAD_NervesReminder_db278dc4-a593-fe74-7f74-b342713617d3, _Char);



//END_REGION

//REGION Zhalk dies and Mind flayer is still alive

IF
DB_TUT_Helm_Devils(_Devil)
THEN
DB_TUT_Helm_ActiveMindflayerEnemies(_Devil);

IF
WentOnStage(_Devil, 1)
AND
DB_TUT_Helm_Devils_BackUp((CHARACTER)_Devil)
THEN
DB_TUT_Helm_ActiveMindflayerEnemies(_Devil);

PROC
PROC_StateSet_Defeated(_Devil)
AND
DB_TUT_Helm_ActiveMindflayerEnemies(_Devil)
THEN
NOT DB_TUT_Helm_ActiveMindflayerEnemies(_Devil);
PROC_TUT_Helm_CheckBetrayal();

PROC
PROC_TUT_Helm_CheckBetrayal()
AND
NOT DB_TUT_Helm_DevilsDefeated(1)
AND
NOT DB_TUT_Helm_ActiveMindflayerEnemies(_)
AND
NOT DB_Defeated(S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846)
THEN
PROC_SetRelationToPlayers((FACTION)ACT0a_TUT_HelmMindflayer_8edc7770-b83c-412e-8a5a-5427a63e5b8a, 0);
PROC_TryStartAD(TUT_Helm_AD_MindFlayerKillsPlayers_a0ceb097-7ad2-db0e-b660-82a57b87f25e, S_TUT_Helm_MindFlayer_22a400ec-5f01-4659-82e1-aed0b203c846);
DB_TUT_Helm_DevilsDefeated(1);

IF
AutomatedDialogEnded(TUT_Helm_AD_MindFlayerKillsPlayers_a0ceb097-7ad2-db0e-b660-82a57b87f25e,_)
THEN
DB_TUT_Helm_CombatPlayerADQueued((VOICEBARKRESOURCE)TUT_Helm_VB_BetrayalReaction_575fd015-690e-63e2-c3b7-7c4b225352de);

//END_REGION

//REGION Tutorial Ending

//REGION Debug

PROC
PROC_LevelUnloading("TUT_Avernus_C")
AND
IsOnStage(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 0)
THEN
SetOnStage(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1);

PROC
PROC_LevelUnloading("TUT_Avernus_C")
AND
NOT DB_OnlyOnce("TUT_Helm_InitiatedTutorialEnd")
THEN
DB_TUT_Helm_BlockGameOver(1);
PROC_TUT_Helm_EndTutorial();
//END_REGION

//REGION Ethereal Plane Transition

/*
IF
DialogStarted((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, _)
AND
DB_TUT_Helm_Devils(_Devil)
THEN
SetOnStage(_Devil, 0);
*/

//PS5 players that finish that start this cinematic will be able to start directly in WLD_Main once all the game is downloaded
IF
DialogStarted((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, _)
THEN
SetFlag((FLAG)TUT_Helm_State_TutorialEnded_55073953-23b9-448c-bee8-4c44d3d67b6b);

IF
FlagSet((FLAG)TUT_Helm_State_TutorialEnded_55073953-23b9-448c-bee8-4c44d3d67b6b,_,_)
THEN
AutoSave();

/*

IF
DialogStarted((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, _)
AND
DB_TUT_Helm_Devils_BackUp(_Devil)
THEN
SetOnStage(_Devil, 0);

IF
DialogStarted((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, _)
AND
DB_TUT_Helm_Devils_BackUpCambions(_Devil)
THEN
SetOnStage(_Devil, 0);
*/

IF
DialogStarted((DIALOGRESOURCE)TUT_Helm_Transponder_d1cac06a-9fa7-237d-1f25-5e9de38ecd2c, _)
AND
DB_TUT_Misc_Tentacles(_Tentacle)
THEN
SetForceUpdate(_Tentacle, 0);
SetOnStage(_Tentacle, 0);

IF
FlagSet((FLAG)TUT_Helm_Event_EnterEtherealPlane_b106d52e-8507-469b-8980-9762f9ba2817, _, _)
AND
DB_TUT_Helm_ScrollingObjects(_Template)
THEN
UnloadLevelTemplate((LEVELTEMPLATE)_Template);

//END_REGION

PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_TUT_Helm_TransponderUser(_Char)
THEN
NOT DB_TUT_Helm_TransponderUser(_Char);

PROC
PROC_TUT_Helm_InitiateEndTutorial()
AND
QRY_OnlyOnce("TUT_Helm_InitiatedTutorialEnd")
THEN
DB_TUT_Helm_BlockGameOver(1);
PROC_TUT_Helm_EndTutorial();


PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_)
THEN
PROC_GLO_NarrativeCombat_EndCombat("TUT_Helm_FinalCombat");

PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_Players(_Player)
AND
NOT QRY_TUT_Helm_EndTutorial_BlockRestore(_Player)
THEN
ClearFlag((FLAG)TG_TUT_InNautiloid_416a5f73-8fcb-45d7-976d-dca41009c2ba, _Player);
PROC_CharacterFullRestore(_Player);

//Losiir (Laezel  alternative) should not be restored
QRY
QRY_TUT_Helm_EndTutorial_BlockRestore((CHARACTER)S_TUT_GithGuide_201a0ee6-6411-4564-aaea-1ca057bfea04)
THEN
DB_NOOP(1);

//Companion Laezel should only be restored if she's not dead
QRY
QRY_TUT_Helm_EndTutorial_BlockRestore((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_Dead((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Avatars((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_NOOP(1);

PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_TUT_Lab_DevourerIsFollowing(1)
THEN
NOT DB_TUT_Lab_DevourerIsFollowing(1);
PROC_TUT_Misc_TutorialCompanion_RemoveCompanion((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"permanently","endtutorial");

//Edge-case -> SH not recruited and hostile -> will be reset for act 1 if not dead
PROC
PROC_TUT_Helm_EndTutorial()
AND
GetFaction((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FACTION)Origin_ShadowHeart_Hostile_68d5b0df-a555-4486-9bf3-391e8f5227d0)
THEN
SetFaction((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FACTION)Origin_ShadowHeart_901cd370-86ff-b538-e1e8-574c84135ca0);
SetFlag((FLAG)ORI_Shadowheart_State_WasHostileInTutorial_1fe1e3ef-3ad0-4e7c-b94e-4cfe5d4cb07c);


//Edge-case -> Laezel not recruited and hostile -> will be reset for act 1 if not dead
PROC
PROC_TUT_Helm_EndTutorial()
AND
GetFaction((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(FACTION)Origin_Laezel_Hostile_5d2675e2-6d65-4292-bd4b-269fa83d9e07)
THEN
SetFlag((FLAG)ORI_Laezel_State_WasHostileInTutorial_7cd5c2d5-9a77-4bf5-9dfd-bd967ceb008e);
SetFaction((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,(FACTION)Origin_Laezel_bee8449b-d682-93c8-e7da-9e4bad369476);


PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_TUT_Guide(_Guide)
THEN
PROC_TUT_Misc_TutorialCompanion_RemoveCompanion((CHARACTER)_Guide,"permanently","endtutorial");


PROC
PROC_TUT_Helm_EndTutorial()
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_TUT_Misc_TutorialCompanion_RemoveCompanion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"permanently","endtutorial");

PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_TUT_Guide((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_Dead((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
SetFlag((FLAG)TUT_Guide_LaezelWasGuide_a10b31fe-0e33-41db-876e-40e2676b04af, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_TUT_Guide((CHARACTER)S_TUT_GithGuide_201a0ee6-6411-4564-aaea-1ca057bfea04)
THEN
MakeNPC((CHARACTER)S_TUT_GithGuide_201a0ee6-6411-4564-aaea-1ca057bfea04);

PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_TUT_Helm_TempUsStatus(_Status)
AND
HasActiveStatus(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,_Status,1)
THEN
RemoveStatus(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _Status);

PROC
PROC_TUT_Helm_EndTutorial()
THEN
PROC_RemovePartyFollower(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

PROC
PROC_TUT_Helm_EndTutorial()
AND
NOT DB_OnlyOnce("TUT_TransformChamber_FreedShadowheart")
THEN
PROC_TUT_TransformChamber_RemoveChairHack();

PROC
PROC_TUT_Helm_EndTutorial()
AND
NOT DB_Players(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
IsOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0)
THEN
SetOnStage(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);

PROC
PROC_TUT_Helm_EndTutorial()
AND
NOT DB_Players(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
DB_OriginRecruitmentDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,ShadowHeart_Recruitment_f553d51e-18ed-659b-e418-56fdca0d0a0a);
PROC_TUT_Misc_TutorialCompanion_RemoveCompanion(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"permanently","endtutorial");

PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_Players(_Player)
AND
GetReservedUserID(_Player,_User)
THEN
CompleteTutorialForUser(_User);

PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_TUT_Start_InitialPartySizeAfterTUT(_Max)
THEN
SetMaxPartySizeOverride(_Max);
NOT DB_TUT_Start_InitialPartySizeAfterTUT(_Max);

//REGION Party Wipe

QRY 
QRY_GameOver_BlockGameOver() 
AND
DB_TUT_Helm_BlockGameOver(1)
THEN
DB_NOOP(1);

//Check if players are still alive, if not, rezz one so they do not wipe when having no tutorial companions to raise them.
PROC
PROC_TUT_Helm_EndTutorial()
AND
NOT QRY_GameOver_AliveCharactersLeft()
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("TUT_Helm_RevivedPlayer")
THEN
Resurrect(_Player);

//END_REGION

PROC //In case QA skips ahead without completing the tutorial properly
PROC_LevelLoadedOnce("WLD_Main_A")
AND
NOT DB_Players(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
IsTagged((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6, 1)
THEN
PROC_TUT_TransformChamber_RemoveChairHack();

PROC
PROC_LevelLoadedOnce("WLD_Main_A")
AND
DB_Players(_Player)
AND
DB_Dead(_Player)
THEN
SetFlag(GLO_TUT_State_WasDeadAtTheEndOfTUT_9118ad6e-b6ea-440e-b788-40bf485fec06, _Player);

PROC
PROC_LevelLoadedOnce("WLD_Main_A")
AND
DB_TUT_Guide((CHARACTER)_Guide)
AND
DB_Dead((CHARACTER)_Guide)
THEN
SetFlag(GLO_TUT_State_WasDeadAtTheEndOfTUT_9118ad6e-b6ea-440e-b788-40bf485fec06, _Guide); //important for Lae'zel companion
TeleportTo(_Guide, S_TUT_GuideDeath_11989862-14e9-44e1-877f-f99c05d574f8, "", 0, 0, 0);

PROC
PROC_LevelLoadedOnce(_Level)
AND
_Level != "TUT_Avernus_C"
AND
DB_TUT_Helm_BlockGameOver(1)
THEN
NOT DB_TUT_Helm_BlockGameOver(1);

PROC
PROC_LevelLoadedOnce(_Level)
AND
_Level != "TUT_Avernus_C"
THEN
PROC_TUT_Helm_EndTutorialCleanUp();

PROC
PROC_TUT_Helm_EndTutorialCleanUp()
THEN
GoalCompleted;

//END_REGION


//REGION Debug
IF
TextEvent("PauseNarrativeCombat")
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_)
THEN
PROC_GLO_NarrativeCombat_LeaveCombat("TUT_Helm_FinalCombat",_PartyMember);

IF
TextEvent("PauseNarrativeCombat")
AND
DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_ID)
THEN
PauseCombat(_ID);

IF
TextEvent("TUT_Helm_StartFires")
AND
DB_TUT_Helm_BacktrackingFireTriggers(_Trigger)
AND
Random(1500,_Random)
THEN
ObjectTimerLaunch(_Trigger, "TUT_Helm_MakeFireWarning",_Random);

IF
ObjectTimerFinished(_Trigger,"TUT_Helm_MakeFireWarning")
AND
NOT QRY_AnyCharacterInTrigger((TRIGGER)_Trigger)
THEN
CreateExplosion(_Trigger,"Projectile_Fireball",-1);
CreateSurface(_Trigger, "SurfaceFire", 3.5, -1.0);

IF
TextEvent("TUT_Helm_TestExplosion")
AND 
GetHostCharacter(_Char)
THEN
CreateExplosion(_Char,"Projectile_Fireball",-1);

IF
TextEvent("TUT_Helm_StartFires")
AND 
GetHostCharacter(_Char)
THEN
PROC_CameraShakeAroundObject(_Char, 2000, 30.0);



//END_REGION
EXITSECTION
PROC_CheckPartyFull();
ENDEXITSECTION
ParentTargetEdge "Tutorial"
