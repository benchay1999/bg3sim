Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Knowledge Check Items

DB_KnowledgeCheckItem_AD("TUT_Lab_AcidMaw", (ITEM)S_TUT_Lab_AcidMaw_069af69f-354a-40d7-b53b-fb07d9d72843, "Investigation", (DIFFICULTYCLASS)DC_Legacy_5_6e246ccd-6149-4ec4-a325-034309a18138, (DIALOGRESOURCE)TUT_Lab_PAD_AcidMawComment_d1187421-cccc-c82c-6c1f-443ecfabc62a, (FLAG)TUT_Lab_Knows_AcidMaw_3420b8e3-c24d-42a6-83fd-7df1d335d9d0);

SetOnStage((ITEM)S_TUT_Lab_AcidMaw_069af69f-354a-40d7-b53b-fb07d9d72843, 0);

//END_REGION

//REGION Intellect Devourer Operation


DB_GlobalFlagReactionAfterDialog((FLAG)TUT_Lab_Event_UsStartsFleeing_e1529859-09bf-4c68-879a-6ba5e4876e82, (DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e);
DB_GlobalFlagReactionAfterDialog((FLAG)TUT_Lab_State_TryKillBrain_1b90cd28-0d25-4b4c-af09-2a5b1833039a, (DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e);
DB_GlobalFlagReactionAfterDialog((FLAG)TUT_Lab_State_FreedBrain_2a0d14f5-661b-46d5-8910-98cc4f85c3e3, (DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e);
SetCanInteract(S_TUT_Lab_OperationChair_f7f83f8c-fead-4953-9924-ef4956dd9543, 0);
PROC_CharacterDisableAllCrimes(S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575,1); 
TriggerRegisterForCharacter(S_TUT_Lab_VictimBounds_acdb0458-a0ec-4c13-a98d-92a5c5d09519, S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575);
TriggerRegisterForCharacter(S_TUT_Lab_EscapeUsNearTrigger_d61af560-bf6b-43d1-92bb-c0a0167d469d, S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575);

Use(S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575, S_TUT_Lab_OperationChair_f7f83f8c-fead-4953-9924-ef4956dd9543, "TUT_Lab_SitOnChair");

DB_Dialogs((CHARACTER)S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575, (ITEM)S_TUT_Lab_SpeakerHelper_d31feb5c-9b0a-40a7-98f3-ad5281413cb8, (DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e);
DB_Dialogs((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (DIALOGRESOURCE)TUT_Lab_DevourerFollower_728f07b6-dc6b-75fb-d7bf-649d3beb534d);
DB_DialogBlockAttackButton(TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e);

DB_TUT_Lab_IntellectDevourerDialogues((DIALOGRESOURCE)TUT_Lab_DevourerFollower_728f07b6-dc6b-75fb-d7bf-649d3beb534d);
DB_TUT_Lab_IntellectDevourerDialogues((DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e);

PROC_SetOnStage(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, 0);
//END_REGION

//REGION Brain Reader

SetOnStage((ITEM)S_TUT_Lab_BrainReader_2abaa5fd-014e-4ee1-8033-1e7fdc517eb6, 0); //Temporary set it off stage until we know where we want to move it.

DB_TUT_Lab_BrainJar((ITEM)S_TUT_Lab_AdventurerBrainJar_2c5bca7e-8649-4217-9ebb-52b20a506e99);
DB_TUT_Lab_BrainJar((ITEM)S_TUT_Lab_ClericBrainJar_f938e0a4-fb50-4d69-8b40-18e9bba30a22);


PROC_TUT_Lab_SetUp();

//END_REGION

PROC_TriggerRegisterForPlayers(S_TUT_Start_HoleBounds_e594a65c-17fb-44e9-893d-82a4e58557f8);
KBSECTION
//REGION Debug Commands
IF
TextEvent("TUT_LAB_MoveUs")
THEN
UseSpell(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"Projectile_Jump", S_TUT_UsEscapePosition_Jump_d78fb374-7c20-435f-af42-50bab1b62cbc);


IF
TextEvent("TUT_Laboratory_LobotomizeUs")
THEN
ApplyStatus((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"TUT_LOBOTOMIZED_US",-1.0);

IF
TextEvent("TUT_Laboratory_FreeUs")
THEN
PROC_TUT_Laboratory_DebugRecruitUs();

IF
DB_GlobalFlag((FLAG)TUT_Lab_Debug_RecruitUs_b897439b-d03f-4c7f-8596-389f13eb2e62)
THEN
PROC_TUT_Laboratory_DebugRecruitUs();

PROC
PROC_TUT_Laboratory_DebugRecruitUs()
AND
GetHostCharacter(_Player)
THEN
SetFlag((FLAG)TUT_Lab_DevourerIsFollower_fdac4665-45bf-40ec-9f87-12674cbad1d6);
SetFlag(GLO_TUT_Knows_TalkedToIntellectDevourer_51dc73fa-ca3e-175c-8798-f66b0bd64e25, _Player);
PROC_TUT_Misc_TutorialCompanion_RecruitBrain((CHARACTER)_Player);
ApplyStatus(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, "TUT_NEWBORN_INTDEV", 30.0, 1, NULL_00000000-0000-0000-0000-000000000000);
Transform((CHARACTER)S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575, (CHARACTER)QUEST_TUT_LAB_TrappedDevourerVictim_Brainless_89136d53-c05d-4528-81a9-4a8f72de27c6, DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);
SetFlag((FLAG)TUT_Lab_State_FreedBrain_2a0d14f5-661b-46d5-8910-98cc4f85c3e3);
TeleportTo(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,_Player);
SetFlag((FLAG)TUT_Misc_State_DevourerBecomesFollower_b1eef2ac-1efe-42c2-a7c3-ff2213e9aaed,_Player);

PROC
PROC_TUT_Laboratory_DebugAngerUs()
AND
GetHostCharacter(_Player)
THEN
SetFlag((FLAG)TUT_Lab_State_FreedBrain_2a0d14f5-661b-46d5-8910-98cc4f85c3e3);
SetFlag(GLO_TUT_Knows_TalkedToIntellectDevourer_51dc73fa-ca3e-175c-8798-f66b0bd64e25, _Player);
ApplyStatus(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, "TUT_NEWBORN_INTDEV", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
SetFlag((FLAG)TUT_Lab_Event_UsStartsFleeing_e1529859-09bf-4c68-879a-6ba5e4876e82);

IF
TextEvent("TUT_Laboratory_AngerUs")
THEN
PROC_TUT_Laboratory_DebugAngerUs();

IF
DB_GlobalFlag((FLAG)TUT_Lab_Debug_AntagonizeUs_1e700f5c-953b-41fb-b1e9-ce9cc0c15a9f)
THEN
PROC_TUT_Laboratory_DebugAngerUs();

PROC
PROC_TUT_Laboratory_DebugAngerUs()
AND
QRY_OnlyOnce("TUT_Lab_UsStartsEscape")
THEN
TimerLaunch("TUT_TransformChamber_DebugStartEscape",1000);

IF
TimerFinished("TUT_TransformChamber_DebugStartEscape")
THEN
DB_TUT_Lab_UsJumping(1);
PROC_TUT_Laboratory_StartUsEscape();

//END_REGION

//REGION Intellect Devourer Operation

IF
UseStarted(_Player, (ITEM)S_TUT_Lab_ClosedBrinepool_53499357-f2c4-4ffd-afc0-5b72000c4587)
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_Lab_PAD_ClosedBrinepool_a4f58504-eeba-3261-8f6f-87184483b54b,_Player);

//REGION Kill Myrnath if he leaves trigger

IF
LeftTrigger(S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575, S_TUT_Lab_VictimBounds_acdb0458-a0ec-4c13-a98d-92a5c5d09519)
AND
HasActiveStatus(S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575, "TUT_UNDEROPERATION", 1)
AND
NOT DB_Dead(S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575)
THEN
PROC_TUT_Laboratory_KillVictim();


//END_REGION

//REGION Temporary Patch 4 dialogue work around

QRY
QRY_HasMutedSpeakersWithLines((DIALOGRESOURCE)_Dialog, (GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (GUIDSTRING)_Speaker2, (GUIDSTRING)_Speaker3, (GUIDSTRING)_Speaker4, (GUIDSTRING)_Speaker5, (GUIDSTRING)_Speaker6)
AND
NOT DB_TUT_Lab_IntellectDevourerDialogues(_Dialog)
THEN
DB_StartOverrideDialog_PlayerSpeaker((GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

QRY
QRY_HasMutedSpeakersWithLines((DIALOGRESOURCE)_Dialog, (GUIDSTRING)_Speaker1, (GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (GUIDSTRING)_Speaker3, (GUIDSTRING)_Speaker4, (GUIDSTRING)_Speaker5, (GUIDSTRING)_Speaker6)
AND
NOT DB_TUT_Lab_IntellectDevourerDialogues(_Dialog)
THEN
DB_StartOverrideDialog_PlayerSpeaker((GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

QRY
QRY_HasMutedSpeakersWithLines((DIALOGRESOURCE)_Dialog, (GUIDSTRING)_Speaker1, (GUIDSTRING)_Speaker2, (GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (GUIDSTRING)_Speaker4, (GUIDSTRING)_Speaker5, (GUIDSTRING)_Speaker6)
AND
NOT DB_TUT_Lab_IntellectDevourerDialogues(_Dialog)
THEN
DB_StartOverrideDialog_PlayerSpeaker((GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

QRY
QRY_HasMutedSpeakersWithLines((DIALOGRESOURCE)_Dialog, (GUIDSTRING)_Speaker1, (GUIDSTRING)_Speaker2, (GUIDSTRING)_Speaker3, (GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (GUIDSTRING)_Speaker5, (GUIDSTRING)_Speaker6)
AND
NOT DB_TUT_Lab_IntellectDevourerDialogues(_Dialog)
THEN
DB_StartOverrideDialog_PlayerSpeaker((GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

QRY
QRY_HasMutedSpeakersWithLines((DIALOGRESOURCE)_Dialog, (GUIDSTRING)_Speaker1, (GUIDSTRING)_Speaker2, (GUIDSTRING)_Speaker3, (GUIDSTRING)_Speaker4, (GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (GUIDSTRING)_Speaker6)
AND
NOT DB_TUT_Lab_IntellectDevourerDialogues(_Dialog)
THEN
DB_StartOverrideDialog_PlayerSpeaker((GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

QRY
QRY_HasMutedSpeakersWithLines((DIALOGRESOURCE)_Dialog, (GUIDSTRING)_Speaker1, (GUIDSTRING)_Speaker2, (GUIDSTRING)_Speaker3, (GUIDSTRING)_Speaker4, (GUIDSTRING)_Speaker5, (GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
AND
NOT DB_TUT_Lab_IntellectDevourerDialogues(_Dialog)
THEN
DB_StartOverrideDialog_PlayerSpeaker((GUIDSTRING)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);
//END_REGION


//REGION


IF
EntityEvent(S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575, "TUT_Lab_SitOnChair")
THEN
ApplyStatus(S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575, "TUT_UNDEROPERATION", -1.0, 1);

IF
Died((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
THEN
PROC_RemovePartyFollower((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

IF
DialogEnded((DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e, _ID)
AND
DB_GlobalFlag((FLAG)TUT_Lab_DevourerIsFollower_fdac4665-45bf-40ec-9f87-12674cbad1d6)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
GetFaction(_Player, _PlayerFaction)
AND
GetRelation((FACTION)ACT0_TUT_LabDevourer_55adef8a-dea9-4f20-9af4-1045ec79e749, _PlayerFaction, _Relation)
AND
_Relation > 50
AND
QRY_OnlyOnce("TUT_Lab_DevourerAddedToParty")
THEN
SetFlag(GLO_TUT_Knows_TalkedToIntellectDevourer_51dc73fa-ca3e-175c-8798-f66b0bd64e25, _Player);
PROC_TUT_Misc_TutorialCompanion_RecruitBrain((CHARACTER)_Player);

//The intellect devourer is offstage at the start so will fail the regular inclusion flow (Offstage counts as DB_CantTalk)
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e, _ID)
THEN
PROC_DialogAddSpeakingActor(_ID,(CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

//The intellect devourer is muted but can communicate with us telepathically when included in a dialog.
QRY
QRY_Inclusion_SpeakerIsAvailableForInclusion(_InclusionDialog, _, (CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (CHARACTER)_MainPlayer)
AND
DB_PartyMembers((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
AND
QRY_SpeakerIsAvailable((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, 1,1)
AND
QRY_SpeakerIsInDialogRange((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,_MainPlayer)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e, _ID)
AND
DB_GlobalFlag((FLAG)TUT_Lab_State_FreedBrain_2a0d14f5-661b-46d5-8910-98cc4f85c3e3)
AND
NOT DB_GlobalFlag((FLAG)TUT_Lab_Event_UsStartsFleeing_e1529859-09bf-4c68-879a-6ba5e4876e82)
AND
NOT DB_GlobalFlag((FLAG)TUT_Lab_State_LobotomizedBrain_d303b55f-b9b1-4acc-b052-26622a337867)
THEN
ApplyStatus(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, "TUT_NEWBORN_INTDEV", 30.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
DialogEnded((DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e, _ID)
AND
DB_GlobalFlag((FLAG)TUT_Lab_State_FreedBrain_2a0d14f5-661b-46d5-8910-98cc4f85c3e3)
AND
DB_GlobalFlag((FLAG)TUT_Lab_Event_UsStartsFleeing_e1529859-09bf-4c68-879a-6ba5e4876e82)
AND
NOT DB_GlobalFlag((FLAG)TUT_Lab_State_LobotomizedBrain_d303b55f-b9b1-4acc-b052-26622a337867)
THEN
ApplyStatus(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, "TUT_NEWBORN_INTDEV", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);


IF
DialogEnded((DIALOGRESOURCE)TUT_Lab_DevourerFollower_728f07b6-dc6b-75fb-d7bf-649d3beb534d, _ID)
AND
DB_GlobalFlag((FLAG)TUT_Lab_DevourerIsFollower_fdac4665-45bf-40ec-9f87-12674cbad1d6)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
NOT DB_TUT_Lab_DevourerIsFollowing(1)
THEN
PROC_TUT_Misc_TutorialCompanion_RecruitBrain((CHARACTER)_Player);

PROC
PROC_TUT_Misc_TutorialCompanion_RecruitBrain((CHARACTER)_Player)
AND
GetFaction((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,_Faction)
THEN
DB_TUT_Lab_DevourerIsFollowing(1);
SetFaction(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360);
DB_TUT_Misc_TutorialCompanion_OldFaction((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _Faction);
AddPartyFollower((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,_Player);

PROC
PROC_TUT_Misc_TutorialCompanion_RecruitBrain((CHARACTER)_Player)
THEN
PROC_SceneOver("TUT_Laboratory_UsDimissed");

PROC
PROC_TUT_Lab_TempRemoveBrain()
AND
CharacterGetOwner((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,_Player)
THEN
NOT DB_TUT_Lab_DevourerIsFollowing(1);
ClearFlag((FLAG)TUT_Lab_DevourerIsFollower_fdac4665-45bf-40ec-9f87-12674cbad1d6);
PROC_TUT_Misc_TutorialCompanion_RemoveCompanion(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"dismissed","");
PROC_CharacterDisableAllCrimes(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);
DB_TUT_Lab_OwnerUs(_Player);
SetFlag((FLAG)TUT_LowerDeck_State_UsWaiting_ca04ed16-c1ef-44f5-ae5c-f19e48d88034);


IF
DialogEnded((DIALOGRESOURCE)TUT_Lab_DevourerFollower_728f07b6-dc6b-75fb-d7bf-649d3beb534d, _ID)
AND
NOT DB_GlobalFlag((FLAG)TUT_Lab_DevourerIsFollower_fdac4665-45bf-40ec-9f87-12674cbad1d6)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
DB_TUT_Lab_DevourerIsFollowing(1)
THEN
NOT DB_TUT_Lab_DevourerIsFollowing(1);
PROC_TUT_Misc_TutorialCompanion_RemoveCompanion(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"dismissed","");

IF
DialogEnded((DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e, _ID)
AND
DB_GlobalFlag((FLAG)TUT_Lab_State_FreedBrain_2a0d14f5-661b-46d5-8910-98cc4f85c3e3)
AND
QRY_OnlyOnce("TUT_Lab_TrappedDevourerVictim_Transformed")
THEN
Transform((CHARACTER)S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575, (CHARACTER)QUEST_TUT_LAB_TrappedDevourerVictim_Brainless_89136d53-c05d-4528-81a9-4a8f72de27c6, DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);

IF
FlagSet((FLAG)TUT_Lab_State_FreedBrain_2a0d14f5-661b-46d5-8910-98cc4f85c3e3, _, _)
THEN
SetOnStage(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, 1);

IF
FlagSet((FLAG)TUT_Lab_State_LobotomizedBrain_d303b55f-b9b1-4acc-b052-26622a337867, _, _)
THEN
ApplyStatus((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"TUT_LOBOTOMIZED_US",-1.0);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)TUT_Lab_State_TryKillBrain_1b90cd28-0d25-4b4c-af09-2a5b1833039a)
THEN
PROC_TUT_Laboratory_KillVictim();

PROC
PROC_TUT_Laboratory_KillVictim()
THEN
Die(S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)TUT_Lab_Event_UsStartsFleeing_e1529859-09bf-4c68-879a-6ba5e4876e82)
AND
QRY_OnlyOnce("TUT_Lab_UsStartsEscape")
THEN
DB_TUT_Lab_UsJumping(1);
PROC_TUT_Laboratory_StartUsEscape();

PROC
PROC_TUT_Laboratory_StartUsEscape()
THEN
SetCanFight(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,0);
SetCanJoinCombat(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,0);
PROC_RemoveAllDialogEntriesForSpeaker(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);
SetHasDialog(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,0);
PROC_SetRelationToPlayers((FACTION)ACT0_TUT_LabDevourer_55adef8a-dea9-4f20-9af4-1045ec79e749,0);
TriggerRegisterForCharacter((TRIGGER)S_TUT_UsEscapePosition_Jump_d78fb374-7c20-435f-af42-50bab1b62cbc, (CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

PROC
PROC_TUT_Laboratory_StartUsEscape()
AND
DB_TUT_Lab_UsJumping(1)
THEN
UseSpell(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"Projectile_Jump", S_TUT_UsEscapePosition_Jump_d78fb374-7c20-435f-af42-50bab1b62cbc);

PROC
PROC_TUT_Laboratory_StartUsEscape()
AND
NOT DB_TUT_Lab_UsJumping(1)
THEN
PROC_CharacterMoveTo((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, S_TUT_UsEscapePosition_Leave_ff47a48c-4ec0-4653-91ee-05d0e2f5e8e8,"Run", "TUT_SortingChamber_UsReadyToLeave");

PROC
PROC_SceneInterrupted(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _Char, "TUT_Laboratory_UsDimissed", _Reason)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason) 
AND
DB_PartyMembers(_Char)
AND
NOT DB_OnlyOnce("TUT_LowerDeck_GuideAppears")
THEN
PROC_SceneOver("TUT_Laboratory_UsDimissed");
PROC_TUT_Laboratory_StartUsEscape();

PROC
PROC_SceneInterrupted(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _Char, "TUT_Laboratory_UsDimissed", _Reason)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason) 
AND
DB_PartyMembers(_Char)
AND
DB_OnlyOnce("TUT_LowerDeck_GuideAppears")
AND
QRY_OnlyOnce("TUT_Lab_UsStartsEscape")
THEN
PROC_SceneOver("TUT_Laboratory_UsDimissed");
SetCanJoinCombat(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,1);
PROC_SetCanFight(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,1);
PROC_TUT_Misc_UsHostile();

IF
UsingSpellInTrigger(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"Projectile_Jump",_,_,(TRIGGER)S_TUT_DevourerJumpStartTrigger_155d865c-f7b4-4300-994d-e3fcc8baf851, _ID)
AND
IsInTrigger(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (TRIGGER)S_TUT_DevourerJumpStartTrigger_155d865c-f7b4-4300-994d-e3fcc8baf851,1)
AND
DB_TUT_Lab_UsJumping(1)
THEN
DB_TUT_Lab_UsJumpID(_ID);


IF
CastSpellFailed(_Us,_,_,_,_ID)
AND
DB_TUT_Lab_UsJumpID(_ID)
THEN
NOT DB_TUT_Lab_UsJumpID(_ID);
PROC_SetOnStage(S_TUT_Lab_UsEscapeBlocker_001_6b858436-f0b1-41ce-88f0-e3428d9896bc,0);
PROC_SetOnStage(S_TUT_Lab_UsEscapeBlocker_000_fad701b2-701c-47f7-b832-53e44e335d89,0);
PROC_CharacterMoveTo((CHARACTER)_Us, S_TUT_UsEscapePosition_Leave_ff47a48c-4ec0-4653-91ee-05d0e2f5e8e8,"Run", "TUT_SortingChamber_UsReadyToLeave");

IF
CastedSpell(_Us,_,_,_,_ID)
AND
DB_TUT_Lab_UsJumpID(_ID)
THEN
NOT DB_TUT_Lab_UsJumping(1);
NOT DB_TUT_Lab_UsJumpID(_ID);

IF
EnteredTrigger(_Us, (TRIGGER)S_TUT_UsEscapePosition_Jump_d78fb374-7c20-435f-af42-50bab1b62cbc)
THEN
TriggerUnregisterForCharacter((TRIGGER)S_TUT_UsEscapePosition_Jump_d78fb374-7c20-435f-af42-50bab1b62cbc, (CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);
PROC_SetOnStage(S_TUT_Lab_UsEscapeBlocker_001_6b858436-f0b1-41ce-88f0-e3428d9896bc,0);
PROC_SetOnStage(S_TUT_Lab_UsEscapeBlocker_000_fad701b2-701c-47f7-b832-53e44e335d89,0);
PROC_CharacterMoveTo((CHARACTER)_Us, S_TUT_UsEscapePosition_Leave_ff47a48c-4ec0-4653-91ee-05d0e2f5e8e8,"Run", "TUT_SortingChamber_UsReadyToLeave");

IF
EntityEvent(_Us, "TUT_SortingChamber_UsReadyToLeave")
THEN
PROC_SetOnStage(_Us,0);
PROC_SetOnStage(S_TUT_Lab_UsEscapeBlocker_001_6b858436-f0b1-41ce-88f0-e3428d9896bc,1);
PROC_SetOnStage(S_TUT_Lab_UsEscapeBlocker_000_fad701b2-701c-47f7-b832-53e44e335d89,1);
SetCanFight(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,1);
SetCanJoinCombat(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,1);
SetFaction(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (FACTION)ACT0a_TUT_UpperDeck_Mindflayer_d218306d-31e0-4329-9c3c-125b2cbf0dec);
TimerLaunch("TUT_SortingChamber_UsMovingThroughNautiloid",7000);

IF
TimerFinished("TUT_SortingChamber_UsMovingThroughNautiloid")
THEN
SetHitpointsPercentage(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,100.0);
PROC_SetOnStage(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,1);
DB_TUT_Lab_DevourerHostilityWhenSeenUs(1);
TeleportToPosition(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,-32.0, 26.0, -354.0, "TUT_SortingChamber_UsTraveled",0,0,0,0,0); 

IF
EntityEvent(_Us,"TUT_SortingChamber_UsTraveled")
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)_Us,"TUT_TransformChamber_ReadyToGoToPosition");

PROC
PROC_ReadyToMoveOn(_Us,"TUT_TransformChamber_ReadyToGoToPosition")
AND
NOT DB_Defeated(S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1)
THEN
PROC_CharacterMoveTo(_Us, S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1,"Run", "");

PROC
PROC_ReadyToMoveOn(_Us,"TUT_TransformChamber_ReadyToGoToPosition")
AND
DB_Defeated(S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1)
THEN
PROC_SetRelationToPlayers((FACTION)ACT0a_TUT_UpperDeck_Mindflayer_d218306d-31e0-4329-9c3c-125b2cbf0dec,0);
PROC_CharacterMoveTo(_Us, S_TUT_MindFlayerRoom_UsTeleport_33122d49-a31d-49e6-9436-719e192f6736,"Run", "");

//If temp hostile with int dev, make permanent hostility
IF
RelationChanged((FACTION)ACT0a_TUT_UpperDeck_Mindflayer_d218306d-31e0-4329-9c3c-125b2cbf0dec, _Faction, 0, _)
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
GetFaction(_PartyMember,_Faction)
AND
QRY_OnlyOnce("TUT_Laboratory_UpperIntDevHostile")
THEN
PROC_SetRelationToPlayers((FACTION)ACT0a_TUT_UpperDeck_Mindflayer_d218306d-31e0-4329-9c3c-125b2cbf0dec,0);

IF
RelationChanged((FACTION)ACT0a_TUT_UpperDeck_Mindflayer_d218306d-31e0-4329-9c3c-125b2cbf0dec, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, 1)
AND
DB_PartyMembers((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
AND
NOT DB_GLO_NarrativeCombat_ID("TUT_Helm_FinalCombat",_)
AND
NOT DB_GlobalFlag((FLAG)TUT_Lab_State_LobotomizedBrain_d303b55f-b9b1-4acc-b052-26622a337867)
AND
QRY_OnlyOnce("TUT_Misc_TrappedDevourerHostile")
THEN
PROC_TUT_Misc_UsHostile();

PROC
PROC_TUT_Misc_UsHostile()
AND
DB_PartyMembers((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
THEN
PROC_RemovePartyFollower((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

PROC
PROC_TUT_Misc_UsHostile()
THEN
SetFaction(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,(FACTION)ACT0a_TUT_UpperDeck_Mindflayer_d218306d-31e0-4329-9c3c-125b2cbf0dec);


//REGION Intellect Devourer Call Out

IF
EnteredTrigger(_Player, S_TUT_Misc_RubbleRoom_001_5873b16d-43e6-48c8-970b-bde226c6b515)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("TUT_Lab_EnteredLab")
THEN
PROC_TUT_Lab_Callout();

PROC
PROC_TUT_Lab_Callout()
AND
QRY_StartDialog((DIALOGRESOURCE)TUT_Lab_AD_DevourerVictim_8aff4ad4-72c5-37e5-3bcd-7176489d717c, (CHARACTER)S_TUT_Lab_DevourerVictim_37f50067-bc94-4b77-9e3c-95d73222b575)
THEN
TimerLaunch("TUT_Lab_DevourerCallOutTimer", 15000);

IF
TimerFinished("TUT_Lab_DevourerCallOutTimer")
AND
NOT DB_OnlyOnce("TUT_Lab_DevourerCallOut")
THEN
PROC_TUT_Lab_Callout();

IF
DialogEnded((DIALOGRESOURCE)TUT_Lab_TrappedDevourer_7236cc61-1c14-46ee-917d-5ec036e4058e, _)
AND
QRY_OnlyOnce("TUT_Lab_DevourerCallOut")
THEN
TimerCancel("TUT_Lab_DevourerCallOutTimer");

PROC
PROC_LevelUnloading("TUT_Avernus_C")
THEN
TimerCancel("TUT_Lab_DevourerCallOutTimer");
//END_REGION


//REGION Find Jar

IF
AddedTo(_Jar, _Player, _)
AND
DB_TUT_Lab_BrainJar((ITEM)_Jar)
AND
NOT DB_TUT_Lab_BrainJarFound((ITEM)_Jar)
THEN
DB_TUT_Lab_BrainJarFound((ITEM)_Jar);
PROC_TUT_Lab_BrainjarAD(_Jar, (CHARACTER)_Player);

PROC
PROC_TUT_Lab_BrainjarAD((ITEM)_Jar, (CHARACTER)_Player)
AND
DB_Players(_Player)
AND
DB_TUT_Lab_BrainJar((ITEM)_Jar)
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_Lab_PAD_BrainJarLoot_6f436f22-f141-15d6-1b8c-05f7613a85e8, _Player);


//END_REGION

IF
FlagSet((FLAG)TUT_Lab_State_MindflayerCheckFailed_89bf3698-47a1-4b80-acb4-9f078c136a78, _Player, _)
THEN
ApplyStatus(_Player, "TUT_LAB_MADNESS", 6.0, 1);

//END_REGION


//REGION Block intellect devourer from pickpocketing other players
QRY
QRY_BlockPickpocket((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (CHARACTER)_Player)
AND
DB_Players(_Player)
THEN
DB_NOOP(1);
//END_REGION

//REGION Block Int Dev from landing crits while NPC

PROC
PROC_TUT_Lab_SetUp()
THEN
ApplyStatus(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"DISABLE_CRITICALHITS",-1.0,1);

IF
FlagSet((FLAG)TUT_Lab_DevourerIsFollower_fdac4665-45bf-40ec-9f87-12674cbad1d6,_,_)
THEN
RemoveStatus(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"DISABLE_CRITICALHITS");

IF
FlagCleared((FLAG)TUT_Lab_DevourerIsFollower_fdac4665-45bf-40ec-9f87-12674cbad1d6,_,_)
THEN
ApplyStatus(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,"DISABLE_CRITICALHITS",-1.0,1);

//END_REGION

//REGION Hooks
IF
TextEvent("TUT_RecruitIntDev")
AND
QRY_OnlyOnce_Reset("debug_TUT_RecruitIntDev")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("debug_TUT_RecruitIntDev")
THEN
PROC_TUT_Misc_TutorialCompanion_RecruitBrain((CHARACTER)_Player);
SetOnStage(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, 1);
TeleportTo(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _Player);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Tutorial"
