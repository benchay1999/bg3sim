Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs((ITEM)S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)TUT_TransformChamber_PodGirl_02fa0520-60ff-573c-0d96-4782711cbdde);
DB_Dialogs((ITEM)S_TUT_TransformChamber_PodLock_adf5f444-02e5-4502-b0f0-2d02c614b33f,(DIALOGRESOURCE)TUT_TransformChamber_PodLock_3012c32a-c894-5113-6302-5e151b3d2f56);
DB_GlobalFlagReactionAfterDialog((FLAG)TUT_TransformChamber_PodGirl_Event_BarbarianStrengthSuccess_551a3ad7-67d1-48dd-81f5-f5f9cd10d63d, (DIALOGRESOURCE)TUT_TransformChamber_PodGirl_02fa0520-60ff-573c-0d96-4782711cbdde);
DB_AD_Dialog(S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1,(DIALOGRESOURCE)TUT_TransformChamber_AD_PatrollingIntDev_b1b25ece-1ee6-4c70-6f49-7b480a45c437);

PROC_TriggerRegisterForPlayers(S_TUT_TransformChamber_EnterChamber_096ae849-5888-4f9a-99bb-71ccc461713e);
PROC_TriggerRegisterForPlayers(S_TUT_TransformChamber_LaezelComment_1de4439d-5a67-4877-8217-275e9b71c622);
PROC_TriggerRegisterForPlayers(S_TUT_TransformChamber_SpotPodStorage_a4ac6721-fa25-4973-81c3-1e497a5a8af7);

DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)TUT_TransformChamber_AD_HostileUs_f4f938ea-f6e8-23d2-0dc7-61d959ad1ae1);
ApplyStatus(S_TUT_Misc_PodMindflayer_14cbbbbb-b10e-444a-ba2d-5960db071fe7,"TUT_CHARACTERINPOD",-1.0);
PROC_SetInvulnerable(S_TUT_Misc_PodMindflayer_14cbbbbb-b10e-444a-ba2d-5960db071fe7,1);
ApplyStatus(S_TUT_Misc_PodHuman_92b60869-b880-4f29-8cd3-bb2a8c771af1,"TUT_CHARACTERINPOD",-1.0);
PROC_SetInvulnerable(S_TUT_Misc_PodHuman_92b60869-b880-4f29-8cd3-bb2a8c771af1,1);

SetForceUpdate(S_TUT_TransformChamber_DrainVictim_000_5bc43df4-6274-4b73-baed-c7f5268b2fc7,1);
SetForceUpdate(S_TUT_TransformChamber_DrainVictim_001_dd1d4bcf-da0e-441a-b700-7273bad6579e,1);

DB_Inclusion_Object((CHARACTER)S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1, (FLAG)TUT_TransformChamber_Devourer_StartInclusion_c296132d-3c85-4fa3-8aae-68866aeb62a2, (FLAG)TUT_TransformChamber_Devourer_EndInclusion_16ebac86-885a-492c-8d7e-bddd6bd59323);
DB_DialogBlockAttackButton((DIALOGRESOURCE)TUT_TransformChamber_PodGirl_02fa0520-60ff-573c-0d96-4782711cbdde);

SetOnStage((ITEM)S_TUT_TransformChamber_HackChair_8f0d979f-e26e-45de-8417-f88acdd9b89e, 0);

PROC_TUT_TransformChamber_SpotPlayer();

//REGION Brain Drain

DB_Dialogs((CHARACTER)S_TUT_TransformChamber_DrainVictim_000_5bc43df4-6274-4b73-baed-c7f5268b2fc7, (DIALOGRESOURCE)TUT_TransformChamber_DrainVictim000_2b262d54-363c-7d12-5d45-1dcd1ff8d022);
DB_Dialogs((CHARACTER)S_TUT_TransformChamber_DrainVictim_001_dd1d4bcf-da0e-441a-b700-7273bad6579e, (DIALOGRESOURCE)TUT_TransformChamber_DrainVictim001_c4f14d38-42c4-1d9e-b726-ba4a1b6d89cf);

DB_TUT_TransformChamber_Stations((CHARACTER)S_TUT_TransformChamber_DrainVictim_000_5bc43df4-6274-4b73-baed-c7f5268b2fc7, (ITEM)S_TUT_TransformChamber_DrainBed_000_7037f574-5814-4299-8597-2dc0901688b0, (TRIGGER)S_TUT_TransformChamber_VictimMove_000_455f118b-d316-4eff-9732-0c8a4741fdd0);
DB_TUT_TransformChamber_Stations((CHARACTER)S_TUT_TransformChamber_DrainVictim_001_dd1d4bcf-da0e-441a-b700-7273bad6579e, (ITEM)S_TUT_TransformChamber_DrainBed_001_f109fa8d-7b4e-4e78-913b-b2bf96629827, (TRIGGER)S_TUT_TransformChamber_VictimMove_001_b1a214db-c76a-4ce5-9fca-988e8cb40d3d);

DB_TUT_TransformChamber_StationSeats((ITEM)S_TUT_TransformChamber_DrainBed_000_7037f574-5814-4299-8597-2dc0901688b0);
DB_TUT_TransformChamber_StationSeats((ITEM)S_TUT_TransformChamber_DrainBed_001_f109fa8d-7b4e-4e78-913b-b2bf96629827);
DB_TUT_TransformChamber_StationSeats((ITEM)S_TUT_TransformChamber_DrainBed_002_8113609e-b236-4824-b118-806dedf4d738);
DB_TUT_TransformChamber_StationSeats((ITEM)S_TUT_TransformChamber_DrainBed_003_b05000c5-67f4-4006-a5db-2563266faa60);

PROC_TUT_TransformChamber_BrainMachineInit();

DB_KnowledgeCheckItem_AD("TUT_TransformChamber_Sign_001", (ITEM)S_TUT_TransformChamber_Sign_001_d7bca7e3-9827-4596-9d41-914ec2c20886, "Arcana", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)TUT_TransformChamber_PAD_Sign_001_94689cc5-b695-e078-d378-4181812167be, (FLAG)TUT_TransformChamber_State_DecipheredSigil_001_a774b6f7-b10f-4d7a-9648-42afd6dbf291);
DB_KnowledgeCheckItem_AD("TUT_TransformChamber_Sign_002", (ITEM)S_TUT_TransformChamber_Sign_002_4190d1f4-1853-4ded-8fff-2f06c4f3fcc9, "Arcana", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)TUT_TransformChamber_PAD_Sign_002_e73fc6f2-8db9-9666-69ba-06dd4ec59df6, (FLAG)TUT_TransformChamber_State_DecipheredSigil_002_2704e245-a5c0-47e8-bf81-451405cc495e);
DB_KnowledgeCheckItem_AD("TUT_TransformChamber_Sign_003", (ITEM)S_TUT_TransformChamber_Sign_003_09e455c0-7fa2-48bb-979c-2bca317c25ab, "Arcana", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)TUT_TransformChamber_PAD_Sign_003_6ae47a51-9d39-f753-9dc2-38ae1a1c785d, (FLAG)TUT_TransformChamber_State_DecipheredSigil_003_f9b5eaa1-6747-4aab-8a16-8244c6028047);
DB_KnowledgeCheckItem_AD("TUT_TransformChamber_Sign_005", (ITEM)S_TUT_TransformChamber_Sign_005_f7d46f64-d7e5-4ed3-9a51-335cf0a45168, "Arcana", (DIFFICULTYCLASS)DC_Legacy_15_bddbb9b8-a242-4c3e-a2eb-3fd274c0c539, (DIALOGRESOURCE)TUT_TransformChamber_PAD_Sign_005_948585cb-57f5-5497-8a1b-e8bdb36cc1ae, (FLAG)TUT_TransformChamber_State_DecipheredSigil_005_261aa71c-a3a9-4112-8f8d-5834fdd4bc98);

DB_TUT_TransformChamber_Sigils((ITEM)S_TUT_TransformChamber_Sign_001_d7bca7e3-9827-4596-9d41-914ec2c20886, (FLAG)TUT_TransformChamber_State_DecipheredSigil_001_a774b6f7-b10f-4d7a-9648-42afd6dbf291, "TUT_TransformChamber_Sign001", "TUT_TransformChamber_SignDeciphered_001");
DB_TUT_TransformChamber_Sigils((ITEM)S_TUT_TransformChamber_Sign_002_4190d1f4-1853-4ded-8fff-2f06c4f3fcc9, (FLAG)TUT_TransformChamber_State_DecipheredSigil_002_2704e245-a5c0-47e8-bf81-451405cc495e, "TUT_TransformChamber_Sign002", "TUT_TransformChamber_SignDeciphered_002");
DB_TUT_TransformChamber_Sigils((ITEM)S_TUT_TransformChamber_Sign_003_09e455c0-7fa2-48bb-979c-2bca317c25ab, (FLAG)TUT_TransformChamber_State_DecipheredSigil_003_f9b5eaa1-6747-4aab-8a16-8244c6028047, "TUT_TransformChamber_Sign003", "TUT_TransformChamber_SignDeciphered_003");
DB_TUT_TransformChamber_Sigils((ITEM)S_TUT_TransformChamber_Sign_005_f7d46f64-d7e5-4ed3-9a51-335cf0a45168, (FLAG)TUT_TransformChamber_State_DecipheredSigil_005_261aa71c-a3a9-4112-8f8d-5834fdd4bc98, "TUT_TransformChamber_Sign005", "TUT_TransformChamber_SignDeciphered_005");

DB_TUT_TransformChamber_Levers((ITEM)S_TUT_TransformChamber_Lever_001_7dff92d1-6954-434a-a336-dd3933782314, (FLAG)TUT_TransformChamber_State_MindDrainingMachineDestroyed_d6df60d9-46ef-4925-a06b-a6f71840a988, "TUT_TransformChamber_Aggressive");
DB_TUT_TransformChamber_Levers((ITEM)S_TUT_TransformChamber_Lever_002_7bc4fc42-3a61-427a-92e6-62e4dc8bceec, (FLAG)TUT_TransformChamber_State_MindDrainingMachineDestroyed_d6df60d9-46ef-4925-a06b-a6f71840a988, "TUT_TransformChamber_Destroy");
DB_TUT_TransformChamber_Levers((ITEM)S_TUT_TransformChamber_Lever_003_72b5d40e-6c60-48fe-99ad-5170d0f19fdd, (FLAG)TUT_TransformChamber_State_MindDrainingMachineDestroyed_d6df60d9-46ef-4925-a06b-a6f71840a988, "TUT_TransformChamber_Free");
DB_TUT_TransformChamber_Levers((ITEM)S_TUT_TransformChamber_Lever_005_85ff4c93-d1e1-4ac1-b244-2d62e2c60f7c, (FLAG)TUT_TransformChamber_State_TransformMachineDestroyed_9e4f268b-105c-43de-bd1e-b63be8d4ae27, "TUT_TransformChamber_Transform");

DB_TUT_TransformChamber_DestroyLevers((ITEM)S_TUT_TransformChamber_Lever_002_7bc4fc42-3a61-427a-92e6-62e4dc8bceec, "TUT_TransformChamber_MindDrainingDestroyed", (TRIGGER)S_TUT_TransformChamber_MindDrainingMachine_d0bbe123-0d78-44bc-9b04-2176502c5df5, (FLAG)TUT_TransformChamber_State_MindDrainingMachineDestroyed_d6df60d9-46ef-4925-a06b-a6f71840a988);

DB_TUT_TransformChamber_NegativeLevers((ITEM)S_TUT_TransformChamber_Lever_001_7dff92d1-6954-434a-a336-dd3933782314, (FLAG)TUT_TransformChamber_State_DecipheredSigil_001_a774b6f7-b10f-4d7a-9648-42afd6dbf291);
DB_TUT_TransformChamber_NegativeLevers((ITEM)S_TUT_TransformChamber_Lever_002_7bc4fc42-3a61-427a-92e6-62e4dc8bceec, (FLAG)TUT_TransformChamber_State_DecipheredSigil_002_2704e245-a5c0-47e8-bf81-451405cc495e);

//END_REGION
//HACK to exclude the gameplay pod from the cinematic
TeleportTo(S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0, S_TUT_ShadowheartPodPoint_8b6f57a0-dd34-41ba-8c59-7b36dfcfe97d, "");
KBSECTION
//REGION Origin/Shadowheart Encounter

//REGION Gith Check

IF
FlagSet((FLAG)TUT_TransformChamber_Event_CheckForGith_eec50557-fd64-40cb-9942-652af0550a22, _, _)
AND
DB_Players(_Player)
AND
IsTagged(_Player, (TAG)GITHYANKI_677ffa76-2562-4217-873e-2253d4720ba4, 1)
AND
QRY_SpeakerIsInDialogRange(_Player, S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0)
THEN
SetFlag((FLAG)TUT_TransformChamber_State_GithInParty_fe089c5e-3e18-4ce9-b3d0-6dbb0eadec82, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((FLAG)TUT_TransformChamber_Event_CheckForGith_eec50557-fd64-40cb-9942-652af0550a22, _, _)
AND
DB_TUT_Guide(_Player)
AND
QRY_SpeakerIsInDialogRange(_Player, S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0)
THEN
SetFlag((FLAG)TUT_TransformChamber_State_GithInParty_fe089c5e-3e18-4ce9-b3d0-6dbb0eadec82, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION



PROC
PROC_GLO_Origins_SetupRecruitment("TUT_Avernus_C") 
AND
DB_Players((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_RemoveDialog(S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0);
PROC_RemoveDialog((ITEM)S_TUT_TransformChamber_PodLock_adf5f444-02e5-4502-b0f0-2d02c614b33f);
DB_ItemDialog_NarratorAD((ITEM)S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0, (DIALOGRESOURCE)TUT_TransformChamber_AD_EmptySHPod_39062bc5-63e9-6f80-e80d-c1202e1ad8ae);
SetOnStage(S_TUT_TransformChamber_PodKey_19df3203-a4fb-4513-be14-fe036acffc0e, 0);
SetCanInteract((ITEM)S_TUT_TransformChamber_PodLock_adf5f444-02e5-4502-b0f0-2d02c614b33f,0);

PROC
PROC_GLO_Origins_SetupRecruitment("TUT_Avernus_C") 
AND
NOT DB_Players((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_SelfHealing_Disable((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
SetTag((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);
SetHasDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0);
PROC_CharacterDisableAllCrimes((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
SetOnStage((ITEM)S_TUT_TransformChamber_HackChair_8f0d979f-e26e-45de-8417-f88acdd9b89e, 1);
SetVisible((ITEM)S_TUT_TransformChamber_HackChair_8f0d979f-e26e-45de-8417-f88acdd9b89e, 0);
SetCanInteract((ITEM)S_TUT_TransformChamber_HackChair_8f0d979f-e26e-45de-8417-f88acdd9b89e, 0);
SetHasDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0);
ApplyStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"TUT_CHARACTERINPOD",-1.0);
PROC_SetInvulnerable(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,1);
TeleportTo((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_TUT_Misc_ShadowheartTeleport_c73b50af-5c89-4a3d-86cd-2cce8d1d0bdd, "TUT_TransformChamber_ShadowheartTeleport", 0, 0, 0);
PROC_LoopEffect(VFX_Script_Nautiloid_Pod_Warding_Rune_01_741cb6d0-e56f-47ad-a956-a38b1bcf3d20, S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0,"TUT_TransformChamber_PodEffect", "TUT_Avernus_C", "");

IF
FlagSet((FLAG)TUT_TransformChamber_State_HasPodKey_8321a9b7-746a-4bd5-8388-9cd838d061ad,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("TUT_TransformChamber_PodKeyReaction")
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_TransformChamber_PAD_PodKeyFound_b1239ef7-e525-1a94-6e3c-c46b86c2efa1,_Player);

IF
EntityEvent((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "TUT_TransformChamber_ShadowheartTeleport")
THEN
SetDetached((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);
TeleportTo((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, S_TUT_ShadowheartPodPoint_8b6f57a0-dd34-41ba-8c59-7b36dfcfe97d, "TUT_TransformChamber_ShadowheartTeleportToPod", 0, 0, 0);


IF
EntityEvent((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "TUT_TransformChamber_ShadowheartTeleportToPod")
THEN
Use((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (ITEM)S_TUT_TransformChamber_HackChair_8f0d979f-e26e-45de-8417-f88acdd9b89e, 1, 1, "TUT_TransformChamber_ShadowheartInPod");


IF
ReposeAdded(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, S_TUT_TransformChamber_HackChair_8f0d979f-e26e-45de-8417-f88acdd9b89e)
THEN
ApplyStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "TUT_SHADOWHEARTINPOD", -1.0);

IF
EnteredTrigger(_Player, S_TUT_TransformChamber_EnterChamber_096ae849-5888-4f9a-99bb-71ccc461713e)
AND
DB_Players(_Player)
AND
NOT DB_Players((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_TUT_TransformChamber_Callout();

PROC
PROC_TUT_TransformChamber_Callout()
AND
NOT DB_GlobalFlag((FLAG)TUT_TransformChamber_State_ShadowheartFreed_c5b714f1-b88c-4268-9736-47bcdc538b4f)
AND
QRY_StartDialog((DIALOGRESOURCE)TUT_TransformChamber_AD_PodGirlCall_1a2192bd-a6b5-e2e6-b70d-f18f837226d1, S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0)
AND
TimerExists("TUT_TransformChamber_CallOutTimer", 0)
THEN
TimerLaunch("TUT_TransformChamber_CallOutTimer", 6000);

IF
CombatStarted(_ID)
AND
QRY_TUT_TransformChamber_CheckPlayersNearSHPod(_ID)
THEN
DB_TUT_TransformChamber_CombatStoppingCallOut(_ID);

IF
SwitchedCombat(_,_OldID,_NewID)
AND
DB_TUT_TransformChamber_CombatStoppingCallOut(_OldID)
THEN
NOT DB_TUT_TransformChamber_CombatStoppingCallOut(_OldID);
DB_TUT_TransformChamber_CombatStoppingCallOut(_NewID);

IF
CombatEnded(_ID)
AND
DB_TUT_TransformChamber_CombatStoppingCallOut(_ID)
AND
DB_TransformChamber_CalloutWaiting(1)
THEN
PROC_TUT_TransformChamber_Callout();

IF
CombatEnded(_ID)
AND
DB_TUT_TransformChamber_CombatStoppingCallOut(_ID)
THEN
NOT DB_TUT_TransformChamber_CombatStoppingCallOut(_ID);

QRY
QRY_TUT_TransformChamber_CheckPlayersNearSHPod((GUIDSTRING)_CombatGUID)
AND
DB_PartyMembers(_Char)
AND
DB_Is_InCombat(_Char,_CombatGUID)
AND
GetDistanceTo(_Char, S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0, _Dist)
AND
_Dist < 25
THEN
DB_NOOP(1);

IF
TimerFinished("TUT_TransformChamber_CallOutTimer")
AND
DB_TUT_TransformChamber_CombatStoppingCallOut(_)
THEN
DB_TransformChamber_CalloutWaiting(1);

IF
TimerFinished("TUT_TransformChamber_CallOutTimer")
AND
NOT DB_TUT_TransformChamber_CombatStoppingCallOut(_)
THEN
PROC_TUT_TransformChamber_Callout();

IF
DialogEnded((DIALOGRESOURCE)TUT_TransformChamber_PodGirl_02fa0520-60ff-573c-0d96-4782711cbdde, _)
AND
QRY_OnlyOnce("TUT_TransformChamber_CallOut")
THEN
TimerCancel("TUT_TransformChamber_CallOutTimer");

IF
FlagSet((FLAG)TUT_TransformChamber_State_RuneShock_a12a3809-52f5-9da4-1dea-f01c2c4c8b6f, _Player, _Inst)
THEN
ClearFlag((FLAG)TUT_TransformChamber_State_RuneShock_a12a3809-52f5-9da4-1dea-f01c2c4c8b6f, _Player, _Inst);
ApplyStatus(_Player, "SHOCKED", 30.0, 1, S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0);

//REGION Free Shadowheart

//REGION Voicebarks
 
IF
FlagSet(TUT_TransformChamber_State_DisableWard_5276092d-7b2b-49c8-b3fa-7220c801c1ce, _, _)
THEN
ClearFlag(TUT_TransformChamber_State_DisableWard_5276092d-7b2b-49c8-b3fa-7220c801c1ce, NULL_00000000-0000-0000-0000-000000000000);
PROC_StopLoopEffect(S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0, "TUT_TransformChamber_PodEffect");

IF
FlagSet(TUT_TransformChamber_State_EnableWard_6693efff-4b30-4239-929c-a03e33c29421, _, _)
THEN
ClearFlag(TUT_TransformChamber_State_EnableWard_6693efff-4b30-4239-929c-a03e33c29421, NULL_00000000-0000-0000-0000-000000000000);
PROC_LoopEffect(VFX_Script_Nautiloid_Pod_Warding_Rune_01_741cb6d0-e56f-47ad-a956-a38b1bcf3d20, S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0,"TUT_TransformChamber_PodEffect", "TUT_Avernus_C", "");

IF
DialogEnded((DIALOGRESOURCE)TUT_TransformChamber_PodLock_3012c32a-c894-5113-6302-5e151b3d2f56, _ID)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
NOT DB_GlobalFlag((FLAG)TUT_TransformChamber_State_ActivatedConsole_5c73cf41-04e7-4018-bc84-d4e9cbff2243)
AND
NOT QRY_ItemInMagicPockets((CHARACTER)_Player, (ITEM)S_TUT_TransformChamber_PodKey_19df3203-a4fb-4513-be14-fe036acffc0e)
AND
QRY_OnlyOnce("TUT_TransformChamber_InteractedWithoutKey")
THEN
RealtimeObjectTimerLaunch(_Player, "TUT_TransformChamber_PodKeyDelay", 1000);

IF
ObjectTimerFinished(_Player, "TUT_TransformChamber_PodKeyDelay")
THEN
StartVoiceBark((VOICEBARKRESOURCE)TUT_TransformChamber_VB_PodLockUnactivated_e83fae7e-a3b0-f2ef-27e2-20c99e946095, (CHARACTER)_Player);



//END_REGION

IF
RelationChanged((FACTION)Origin_ShadowHeart_901cd370-86ff-b538-e1e8-574c84135ca0,_Faction,0,0)
AND
FactionGetParentFaction(_Faction,1,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360)
THEN
SetFaction((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FACTION)Origin_ShadowHeart_Hostile_68d5b0df-a555-4486-9bf3-391e8f5227d0);


IF
FlagSet((FLAG)TUT_TransformChamber_State_EndPodDialogue_46cfbaa6-ffae-4aec-afeb-78843d3f2d5d, _, _)
THEN
PROC_ForceStopDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
SetCanInteract(S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0, 0);

IF
DialogEnded((DIALOGRESOURCE)TUT_TransformChamber_PodLock_3012c32a-c894-5113-6302-5e151b3d2f56, _ID)
AND
DB_DialogPlayers(_ID,_Player,_)
AND
GetFlag((FLAG)TUT_TransformChamber_State_FreedShadowheart_c3980ab3-9370-4c2d-9c76-38aff5fe575a, _Player, 1)
AND
QRY_OnlyOnce("TUT_TransformChamber_FreedShadowheart")
THEN
DB_OnlyOnce("TUT_TransformChamber_CallOut");
PROC_TUT_TransformChamber_FreeShadowheart();

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)TUT_TransformChamber_PodGirl_Event_BarbarianStrengthSuccess_551a3ad7-67d1-48dd-81f5-f5f9cd10d63d)
AND
QRY_OnlyOnce("TUT_TransformChamber_FreedShadowheart")
THEN
DB_OnlyOnce("TUT_TransformChamber_CallOut");
PROC_TUT_TransformChamber_FreeShadowheart();

IF
FlagSet((FLAG)TUT_TransformChamber_State_FreedShadowheart_c3980ab3-9370-4c2d-9c76-38aff5fe575a, _, _)
THEN
PROC_TUT_TransformChamber_MoveShadowheart();

PROC
PROC_TUT_TransformChamber_MoveShadowheart()
THEN
StopAnimation((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);
TimerLaunch("TUT_TransformChamber_ShadowheartKneel",200);
RemoveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "TUT_SHADOWHEARTINPOD");
PROC_SetInvulnerable(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,0);
RemoveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"TUT_CHARACTERINPOD");
TeleportTo(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, S_TUT_TransformChamber_ShadowheartAppear_1366d2d8-ea8d-48fb-a0fe-65638cf68c25, "TUT_TransformChamber_ShadowheartArrive", 0, 0, 0);
PROC_TUT_TransformChamber_RemoveChairHack();

IF
TimerFinished("TUT_TransformChamber_ShadowheartKneel")
THEN
PROC_PlayLoopingAnimation((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(ANIMATION)NULL_00000000-0000-0000-0000-000000000000,(ANIMATION)CUST_KneelingBesideCorpse_01_Loop_312687d1-eb1b-4c66-a8fe-433b980c1f4f,(ANIMATION)NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((FLAG)TUT_TransformChamber_Event_UsedPodKey_ef8b4e63-8586-4c72-addc-a9333dd8b2b7, _, _)
THEN
PROC_GlobalClearFlagAndCache((FLAG)TUT_TransformChamber_Event_UsedPodKey_ef8b4e63-8586-4c72-addc-a9333dd8b2b7);
RequestDelete(S_TUT_TransformChamber_PodKey_19df3203-a4fb-4513-be14-fe036acffc0e);

IF
UseStarted(_Player,(ITEM)S_TUT_TransformChamber_PodLock_adf5f444-02e5-4502-b0f0-2d02c614b33f)
AND
DB_TUT_TransformChamber_DoneWithSHPod(1)
THEN
PROC_PlayCantUseItemAD(_Player);

IF
UseStarted(_Player,(ITEM)S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0)
AND
DB_TUT_TransformChamber_DoneWithSHPod(1)
THEN
PROC_PlayCantUseItemAD(_Player);

PROC
PROC_TUT_TransformChamber_FreeShadowheart()
THEN
DB_Surrender_BlockPermaDefeatedOnFlee((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
SetOnStage((ITEM)S_TUT_TransformChamber_HackChair_8f0d979f-e26e-45de-8417-f88acdd9b89e, 0);
DB_TUT_TransformChamber_DoneWithSHPod(1);
SetCanInteract((ITEM)S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0,1);
SetFlag((FLAG)TUT_TransformChamber_State_ShadowheartFreed_c5b714f1-b88c-4268-9736-47bcdc538b4f, NULL_00000000-0000-0000-0000-000000000000);
TimerCancel("TUT_TransformChamber_CallOutTimer");
PROC_RemoveAllDialogEntriesForSpeaker(S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0);

PROC
PROC_TUT_TransformChamber_RemoveChairHack()
THEN
ClearTag((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);
PROC_SelfHealing_Enable((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
SetHasDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);
PROC_CharacterEnableAllCrimes((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
SetDetached(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0);

IF
EntityEvent(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "TUT_TransformChamber_ShadowheartArrive")
THEN
PlayEffect(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (EFFECTRESOURCE)VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416);
PROC_TUT_TransformChamber_ShadowheartFreed();

PROC
PROC_TUT_TransformChamber_ShadowheartFreed()
THEN
DB_TUT_TransformChamber_ShadowheartOnGround(1);
SetDoNotFaceFlag((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);
PROC_RemoveDialog((ITEM)S_TUT_TransformChamber_PodLock_adf5f444-02e5-4502-b0f0-2d02c614b33f);
PROC_RemoveDialogEntryForSpeaker(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(DIALOGRESOURCE)TUT_TransformChamber_PodLock_3012c32a-c894-5113-6302-5e151b3d2f56);
DB_Dialogs((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFreed_5ac55171-4df5-a168-9dad-856667d44988);
TimerLaunch("TUT_TransformChamber_ShadowHeartADDelay", 1500);

IF
DialogEnded((DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFreed_5ac55171-4df5-a168-9dad-856667d44988, _)
AND
DB_TUT_TransformChamber_ShadowheartOnGround(1)
THEN
NOT DB_TUT_TransformChamber_ShadowheartOnGround(1);
SetDoNotFaceFlag((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0);
StopAnimation((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);

IF
TimerFinished("TUT_TransformChamber_ShadowHeartADDelay")
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_TransformChamber_AD_ShadowheartFree_00967606-3238-05d9-0299-5a5207c30686, (CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);

IF
DialogEnded((DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFreed_5ac55171-4df5-a168-9dad-856667d44988, _ID)
AND
NOT DB_GlobalFlag((FLAG)TUT_TransformChamber_State_NotAvatar_286522b0-6dd1-4490-b9b3-c3c4133884b8)
AND
NOT QRY_TUT_TransformChamber_RecruitedShadowheart()
THEN
SetHasDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0);
PROC_DisappearOutOfSightTo((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, S_LOW_TransformChamber_SHDisappearTo_ae26b13e-96f2-4205-b4a1-32cde73002cc, "Run", 0, "");

QRY
QRY_TUT_TransformChamber_RecruitedShadowheart()
AND
DB_Players(_Player)
AND
GetFlag((FLAG)TUT_TransformChamber_State_RecruitedShadowheart_2c531120-0297-4e8d-9783-762f5ea67c66, _Player, 1)
THEN
DB_NOOP(1);

IF
Resurrected(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_Avatars((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT QRY_TUT_TransformChamber_RecruitedShadowheart()
AND
DB_CurrentLevel("TUT_Avernus_C")
THEN
SetHasDialog((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 0);
PROC_DisappearOutOfSight((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "Run", 0, "TUT_Shadowheart_TryKillOffScreen");

IF
EntityEvent((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "TUT_Shadowheart_TryKillOffScreen")
AND
NOT DB_GLO_InfernalBox_Owner((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
Die((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, DEATHTYPE.Psychic, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 1.0);

//REGION Shadowheart Tutorial Recruitment

IF
DialogEnded((DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFreed_5ac55171-4df5-a168-9dad-856667d44988, _ID)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
GetFlag((FLAG)TUT_TransformChamber_State_RecruitedShadowheart_2c531120-0297-4e8d-9783-762f5ea67c66, _Player, 1)
THEN
PROC_RemoveDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_Dialogs((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFollower_5c77b381-e606-12b7-1379-89db17e4a6d5);
NOT DB_OriginInPartyDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(DIALOGRESOURCE)ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5);
DB_OriginInPartyDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFollower_5c77b381-e606-12b7-1379-89db17e4a6d5);
DB_TUT_Misc_TutorialCompanion_OldFaction(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (FACTION)Origin_ShadowHeart_901cd370-86ff-b538-e1e8-574c84135ca0);
//END_REGION

//REGION Shadowheart - Thrall crime handling

QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_Criminal, (STRING)_Crime, (GUIDSTRING)_Evidence, (CHARACTER)_Victim, _)
AND
DB_TUT_TransformChamber_Stations(_Victim, _, _)
THEN
DB_NOOP(1);

//END_REGION

//REGION Post Tutorial States

QRY
QRY_TUT_TransformChamber_ShadowheartState((FLAG)_Flag)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)_Flag, _Player, 1)
THEN
DB_NOOP(1);

QRY
QRY_TUT_TransformChamber_ShadowheartState((FLAG)_Flag)
AND
NOT DB_Players((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
GetFlag((FLAG)_Flag, (CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, 1)
THEN
DB_NOOP(1);

PROC
PROC_TUT_Helm_EndTutorial()
AND
NOT DB_Avatars(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
QRY_TUT_TransformChamber_ShadowheartState((FLAG)TUT_TransformChamber_State_FreedShadowheart_c3980ab3-9370-4c2d-9c76-38aff5fe575a)
THEN
PROC_TUT_TransformChamber_ShadowheartWasFreed();

PROC
PROC_TUT_Helm_EndTutorial()
AND
DB_OriginInPartyDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFollower_5c77b381-e606-12b7-1379-89db17e4a6d5)
AND
NOT DB_OriginInPartyDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5)
THEN
PROC_RemoveDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
DB_OriginInPartyDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,ShadowHeart_InParty_95ca3833-09d0-5772-b16a-c7a5e9208fe5);

PROC
PROC_TUT_TransformChamber_ShadowheartWasFreed()
AND
NOT DB_Defeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_TUT_TransformChamber_ShadowheartParty();

PROC
PROC_TUT_TransformChamber_ShadowheartWasFreed()
AND
DB_Defeated(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_RemoveDialogEntryForSpeaker((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFreed_5ac55171-4df5-a168-9dad-856667d44988);
SetFlag(GLO_TUT_State_WasDeadAtTheEndOfTUT_9118ad6e-b6ea-440e-b788-40bf485fec06, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679);
PROC_State_Progress(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment","BEACH");

PROC
PROC_TUT_TransformChamber_ShadowheartParty()
AND
NOT QRY_TUT_TransformChamber_ShadowheartState((FLAG)TUT_TransformChamber_State_RecruitedShadowheart_2c531120-0297-4e8d-9783-762f5ea67c66)
THEN
PROC_RemoveDialogEntryForSpeaker((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (DIALOGRESOURCE)TUT_TransformChamber_ShadowheartFreed_5ac55171-4df5-a168-9dad-856667d44988);
SetFlag(GLO_Shadowheart_State_BeachRecruitment_14468bb2-c6bf-4aa0-a00e-011ced4823fb, NULL_00000000-0000-0000-0000-000000000000);
PROC_State_Progress(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment","BEACH");

PROC
PROC_TUT_TransformChamber_ShadowheartParty()
AND
QRY_TUT_TransformChamber_ShadowheartState((FLAG)TUT_TransformChamber_State_RecruitedShadowheart_2c531120-0297-4e8d-9783-762f5ea67c66)
THEN
SetFlag(GLO_Shadowheart_State_BeachRecruitment_14468bb2-c6bf-4aa0-a00e-011ced4823fb, NULL_00000000-0000-0000-0000-000000000000);
PROC_State_Progress(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"Recruitment","BEACH");
SetFlag((FLAG)GLO_Shadowheart_State_RecruitedInTutorial_c7f8437b-6064-4a1d-9774-71da051887e5, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//END_REGION

//END_REGION

//REGION Intellect Devourer Spot

IF
AttackedBy((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,_,_,_,_DMG,_,_)
AND
_DMG > 0
AND
DB_TUT_Lab_DevourerHostilityWhenSeenUs(1)
THEN
SetCanFight((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,1);
PROC_SetRelationToPlayers((FACTION)ACT0a_TUT_UpperDeck_Mindflayer_d218306d-31e0-4329-9c3c-125b2cbf0dec,0);
NOT DB_TUT_Lab_DevourerHostilityWhenSeenUs(1);

PROC
PROC_TUT_TransformChamber_SpotPlayer()
THEN
DB_SpotPlayers((CHARACTER)S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1, "TUT_Lab_DevourerSpot", NULL_00000000-0000-0000-0000-000000000000, (FLAG)TUT_Lab_State_StopSpotting_09055509-c996-4722-a3a7-ac3528b9659f);

IF
Saw((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (CHARACTER)S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1,_)
AND
DB_TUT_Lab_DevourerHostilityWhenSeenUs(1)
AND
NOT DB_Defeated(S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1)
AND
QRY_OnlyOnce("TUT_TransformChamber_UsStartPatrol")
THEN
PROC_SetRelationToPlayers((FACTION)ACT0a_TUT_UpperDeck_Mindflayer_d218306d-31e0-4329-9c3c-125b2cbf0dec,0);
PROC_Follow((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, (CHARACTER)S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1);
NOT DB_TUT_Lab_DevourerHostilityWhenSeenUs(1);

IF
TurnStarted(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558)
AND
DB_Is_InCombat(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558,_ID)
AND
QRY_IsEnemyToAnyPlayerInCombat((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _ID)
AND
QRY_OnlyOnce("TUT_TransformChamber_UsAD")
THEN
PROC_TryStartAD((DIALOGRESOURCE)TUT_TransformChamber_AD_HostileUs_f4f938ea-f6e8-23d2-0dc7-61d959ad1ae1,S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

IF
DB_Sees((CHARACTER)S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1, _Player)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
DB_DialogSpeakers(_ID, S_TUT_TransformChamber_Pod_007_1eebfdb5-8814-da8d-2d3e-64b2924f95b0, _)
THEN
SetFlag((FLAG)TUT_TransformChamber_State_DevourerSpotted_7fc9f12e-de79-4b29-89bd-9d3423b8ead6, _Player);

IF
LostSightOf(S_TUT_Lab_IntellectDevourer_40bd6b82-2728-410a-bb8a-a805f98556a1, _Player)
AND
GetFlag((FLAG)TUT_TransformChamber_State_DevourerSpotted_7fc9f12e-de79-4b29-89bd-9d3423b8ead6, _Player, 1)
THEN
ClearFlag((FLAG)TUT_TransformChamber_State_DevourerSpotted_7fc9f12e-de79-4b29-89bd-9d3423b8ead6, _Player);



//END_REGION

//REGION Machines

//REGION Brain Draining
PROC
PROC_TUT_TransformChamber_BrainMachineInit()
AND
DB_TUT_TransformChamber_Stations(_Victim, _Bed, _)
THEN
PROC_CharacterDisableAllCrimes(_Victim,1); 
Use(_Victim, _Bed, "");

IF
DB_TUT_TransformChamber_StationSeats(_Seat)
THEN
SetCanInteract((ITEM)_Seat, 0);

IF
ReposeAdded(_Victim, _Bed)
AND
DB_TUT_TransformChamber_Stations((CHARACTER)_Victim, (ITEM)_Bed, _)
THEN
ApplyStatus(_Victim, "TUT_SAPPED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION Levers

IF
FlagSet(_Flag, _, _)
AND
DB_TUT_TransformChamber_Sigils(_Sigil, _Flag, _Name, _OnlyOnce)
AND
QRY_OnlyOnce(_OnlyOnce)
THEN
SetStoryDisplayName(_Sigil, _Name);

IF
UseStarted(_Player, _Sigil)
AND
_Player != S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558
AND
DB_TUT_TransformChamber_Sigils(_Sigil, _Flag, _, _)
AND
GetFlag(_Flag, _Player, 1)
AND
DB_KnowledgeCheckItem_AD(_, _Sigil, _, _, _AD, _)
AND
QRY_StartDialog_Fixed(_AD, _Player)
THEN
DB_NOOP(1);

IF
UseStarted(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _Sigil)
AND
DB_TUT_TransformChamber_Sigils(_Sigil, _, _, _)
THEN
PROC_TryStartAD((DIALOGRESOURCE)GLO_AD_CannotUseNow_Muted_79fe3a97-7e74-6f79-9afb-6a5d947a4b0b, S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

IF
UseStarted(_Player, _Lever)
AND
_Player != S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558
AND
DB_TUT_TransformChamber_Levers(_Lever, _MachineFlag, _OnlyOnce)
AND
NOT DB_GlobalFlag(_MachineFlag)
AND
QRY_OnlyOnce(_OnlyOnce)
THEN
PROC_TUT_TransformChamber_MachineActivate((ITEM)_Lever, (CHARACTER)_Player);

IF
UseStarted(S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558, _Lever)
AND
DB_TUT_TransformChamber_Levers(_Lever, _, _)
THEN
PROC_TryStartAD((DIALOGRESOURCE)GLO_AD_CannotUseNow_Muted_79fe3a97-7e74-6f79-9afb-6a5d947a4b0b, S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);

//REGION Turn captive hostile
PROC 
PROC_TUT_TransformChamber_MachineActivate((ITEM)S_TUT_TransformChamber_Lever_001_7dff92d1-6954-434a-a336-dd3933782314, (CHARACTER)_Player)
AND
NOT DB_TUT_TransformChamber_StartCombat((CHARACTER)_Player)
AND
DB_TUT_TransformChamber_Stations(_Victim, _Station, _)
AND
IsReposedOnEntity(_Victim, _Station, 1)
AND
NOT DB_PermaDefeated(_Victim)
AND
HasActiveStatus(_Victim, "TUT_SAPPED", 1)
THEN
DB_TUT_TransformChamber_StartCombat((CHARACTER)_Player);
PlayEffect(_Victim, (EFFECTRESOURCE)VFX_Script_Mindflayer_TransformChamber_HeadFX_01_ca4c5fe9-6868-96d3-a360-9943f07958b0, "Dummy_HeadFX", 1.0);
PROC_StopLoopEffect(_Victim, "TUT_TransformChamber_BrainDrain");
RemoveStatus(_Victim, "TUT_SAPPED");

IF
ReposeRemoved(_Victim, _Station)
AND
DB_TUT_TransformChamber_Stations((CHARACTER)_Victim, (ITEM)_Station, _)
THEN
PROC_TUT_TransformChamber_MachineSetHostile();

IF
StatusRemoved(_Victim, "TUT_SAPPED", _, _)
AND
DB_TUT_TransformChamber_StartCombat((CHARACTER)_Player)
AND
DB_TUT_TransformChamber_Stations((CHARACTER)_Victim, _, _Trigger)
THEN
TeleportTo(_Victim, _Trigger, "TUT_TransformChamber_VictimMoved", 0, 0, 0);

IF
EntityEvent(_Victim, "TUT_TransformChamber_VictimMoved")
AND
DB_TUT_TransformChamber_Stations((CHARACTER)_Victim, _, _)
AND
DB_TUT_TransformChamber_StartCombat((CHARACTER)_Player)
THEN
NOT DB_TUT_TransformChamber_StartCombat((CHARACTER)_Player);
PROC_TUT_TransformChamber_MachineSetHostile();
RealtimeObjectTimerLaunch(_Player, "TUT_TransformChamber_HostileDelay", 1000);
PROC_TUT_TransformChamber_NegativeOutcome((CHARACTER)_Player, (ITEM)S_TUT_TransformChamber_Lever_001_7dff92d1-6954-434a-a336-dd3933782314);

IF
ObjectTimerFinished(_Player, "TUT_TransformChamber_HostileDelay")
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_OnlyOnce("TUT_TransformChamber_MachineHostile")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)TUT_TransformChamber_PAD_SlavesHostile_ff3b6996-fd5c-aa35-443b-2f7dfc024bcd, _Player)
AND
QRY_OnlyOnce("TUT_TransformChamber_MachineHostile")
THEN
DB_NOOP(1);

PROC
PROC_TUT_TransformChamber_MachineSetHostile()
AND
DB_Players(_Player)
AND
GetFaction(_Player, _PlayerFaction)
AND
GetRelation(_PlayerFaction, (FACTION)ACT0_TUT_CapturedCivilians_0b1cec64-69a4-4765-8dd0-f378d2c74acc, _Relation)
AND
_Relation != 0
THEN
PROC_SetRelationMutual((FACTION)ACT0_TUT_CapturedCivilians_0b1cec64-69a4-4765-8dd0-f378d2c74acc, _PlayerFaction, 0);
PROC_SetRelationMutual((FACTION)ACT0_TUT_CapturedCivilians_0b1cec64-69a4-4765-8dd0-f378d2c74acc, (FACTION)ACT0a_TUT_Devils_53c6dd13-fdee-41ff-88d9-9b5778a417e7, 0);
PROC_SetRelationMutual((FACTION)ACT0_TUT_CapturedCivilians_0b1cec64-69a4-4765-8dd0-f378d2c74acc, (FACTION)ACT0a_TUT_HelmDevil_0314cde4-8572-4d70-a117-dba88e20e70d, 0);


//END_REGION

//REGION Destroy Machine

PROC
PROC_TUT_TransformChamber_MachineActivate((ITEM)_Lever, (CHARACTER)_Player)
AND
DB_TUT_TransformChamber_DestroyLevers(_Lever, _ID, _Machine, _MachineFlag)
THEN
PROC_TUT_TransformChamber_KillSlaves((ITEM)_Lever);
PROC_TUT_TransformChamber_NegativeOutcome((CHARACTER)_Player, (ITEM)_Lever);

PROC
PROC_TUT_TransformChamber_KillSlaves((ITEM)S_TUT_TransformChamber_Lever_002_7bc4fc42-3a61-427a-92e6-62e4dc8bceec)
AND
DB_TUT_TransformChamber_Stations(_Victim, _Station, _)
AND
IsReposedOnEntity(_Victim, _Station, 1)
AND
NOT DB_PermaDefeated(_Victim)
AND
HasActiveStatus(_Victim, "TUT_SAPPED", 1)
THEN
PROC_StopLoopEffect(_Victim, "TUT_TransformChamber_BrainDrain");
Die(_Victim, DEATHTYPE.Psychic, NULL_00000000-0000-0000-0000-000000000000, 1, 0);


//END_REGION

//REGION Free - Mind Drained Slaves

PROC
PROC_TUT_TransformChamber_MachineActivate((ITEM)S_TUT_TransformChamber_Lever_003_72b5d40e-6c60-48fe-99ad-5170d0f19fdd, (CHARACTER)_Player)
AND
DB_TUT_TransformChamber_Stations(_Victim, _Station, _)
AND
IsReposedOnEntity(_Victim, _Station, 1)
AND
NOT DB_PermaDefeated(_Victim)
AND
HasActiveStatus(_Victim, "TUT_SAPPED", 1)
THEN
PROC_StopLoopEffect(_Victim, "TUT_TransformChamber_BrainDrain");
PROC_TUT_TransformChamber_Freed((CHARACTER)_Player, (CHARACTER)_Victim);

PROC
PROC_TUT_TransformChamber_Freed((CHARACTER)_Player, (CHARACTER)_Victim)
AND
NOT DB_OnlyOnce("TUT_TransformChamber_FreedCommented")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)TUT_TransformChamber_SlavesFreed_22ad36d0-7d38-136e-709c-8b4aea1e07c4, _Victim, _Player)
AND
QRY_OnlyOnce("TUT_TransformChamber_FreedCommented")
THEN
DB_NOOP(1);

PROC
PROC_TUT_TransformChamber_MachineActivate((ITEM)S_TUT_TransformChamber_Lever_003_72b5d40e-6c60-48fe-99ad-5170d0f19fdd, (CHARACTER)_Player)
AND
DB_TUT_TransformChamber_Stations(_Victim, _, _)
AND
NOT QRY_TUT_TransformChamber_CheckVictims()
AND
NOT DB_OnlyOnce("TUT_TransformChamber_FreedDead")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)TUT_TransformChamber_PAD_FreedSlavesDead_1d60b68c-0582-5556-0a83-df32186c44c5, _Player)
AND
QRY_OnlyOnce("TUT_TransformChamber_FreedDead")
THEN
DB_NOOP(1);

QRY
QRY_TUT_TransformChamber_CheckVictims()
AND
DB_TUT_TransformChamber_Stations(_Victim, _, _)
AND
NOT DB_PermaDefeated(_Victim)
THEN
DB_NOOP(1);


//END_REGION

//REGION Transformation

PROC
PROC_TUT_TransformChamber_MachineActivate((ITEM)S_TUT_TransformChamber_Lever_005_85ff4c93-d1e1-4ac1-b244-2d62e2c60f7c, (CHARACTER)_Player)
AND
DB_TUT_Misc_Pods(_Pod)
AND
QRY_SpeakerIsAvailable(_Pod)
THEN
PROC_TUT_Misc_MindflayerPodView((CHARACTER)_Player, (ITEM)_Pod);

IF
UseStarted(_Player, _Lever)
AND
_Player != S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558
AND
DB_TUT_Misc_CurrentTransformationID(_ID)
THEN
PROC_DialogAddListeningActor(_ID,_Player);


//END_REGION

//REGION Gith Guide Response

PROC
PROC_TUT_TransformChamber_NegativeOutcome((CHARACTER)_Player, (ITEM)_Lever)
AND
DB_TUT_TransformChamber_NegativeLevers(_Lever, _Flag)
AND
DB_TUT_Guide(_Guide)
AND
_Player != _Guide
AND
GetDistanceTo(_Guide, _Player, _Distance)
AND
_Distance < 12.0
AND
DB_TUT_GuideDialogues("TransformLever", _Guide, _Dialog)
AND
NOT DB_OnlyOnce("TUT_TransformChamber_GuideCommented")
AND
QRY_StartDialog_Fixed(_Dialog, _Guide)
AND
QRY_OnlyOnce("TUT_TransformChamber_GuideCommented")
THEN
DB_NOOP(1);


//END_REGION

//END_REGION
//END_REGION

//REGION Shar Chest

IF
UseFinished(_Player, S_TUT_TransformChamber_SharChest_95dde668-cee0-47c0-92ed-1072db84f687, 0)
AND
DB_Players(_Player)
AND
IsLocked(S_TUT_TransformChamber_SharChest_95dde668-cee0-47c0-92ed-1072db84f687, 1)
AND
QRY_OnlyOnce("TUT_TransformChamber_FailedOpeningChest")
THEN
SetFlag((FLAG)TUT_TransformChamber_State_FoundChest_6c984fc7-638a-481a-b148-5f09bb3cb11d, NULL_00000000-0000-0000-0000-000000000000);
StartVoiceBark((VOICEBARKRESOURCE)TUT_TransformChamber_VB_ChestLocked_12a8bd7f-6e43-a059-4e1c-e7bfaa35b15a, _Player);

IF
AddedTo(S_TUT_TransformChamber_SharKey_85b291f6-730b-4bb8-98e4-cff22652b94f, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
IsLocked(S_TUT_TransformChamber_SharChest_95dde668-cee0-47c0-92ed-1072db84f687, 1)
AND
QRY_OnlyOnce("TUT_TransformChamber_AcquiredChest")
THEN
StartVoiceBark((VOICEBARKRESOURCE)TUT_TransformChamber_VB_KeyFound_f4916c26-897c-160b-5a67-64f350b7ab9c, _Player);


//END_REGION

//REGION Debug
IF
FlagSet((FLAG)_Flag, (CHARACTER)_Character, _) // flagType: Object
AND
DB_Debug_CharacterAddFlags((FLAG)_Flag,(CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,(FLAG)_)
AND
NOT DB_TutorialCompanion(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
PROC_TUT_TransformChamber_RemoveChairHack();

IF
TextEvent("TUT_TransformChamber_TeleportTo_ExperimentationRoom")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player, S_TUT_TeleportTo_ExperimentationRoom_fec90275-6d8a-4e18-9045-e3e27ecc4c05, "", 1,1,1,1,1);


IF
DB_GlobalFlag((FLAG)TUT_TransformChamber_Debug_TeleportToChamber_667eb607-0794-47bf-a389-66157782aa60)
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player, S_TUT_TeleportTo_ExperimentationRoom_fec90275-6d8a-4e18-9045-e3e27ecc4c05, "", 1,1,1,1,1);

IF
TextEvent("TUT_TransformChamber_GetSHPodKey")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_TUT_TransformChamber_PodKey_19df3203-a4fb-4513-be14-fe036acffc0e,_Player, 1,1);

IF
DB_GlobalFlag((FLAG)TUT_TransformChamber_Debug_GetPodKey_9bb8f9eb-5261-4f4f-a5cf-f6ac19ee9634)
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_TUT_TransformChamber_PodKey_19df3203-a4fb-4513-be14-fe036acffc0e,_Player, 1,1);


//END_REGION



PROC
PROC_TUT_Helm_EndTutorial()
THEN
GoalCompleted;
EXITSECTION
PROC_SetInvulnerable(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,0);
SetHasDialog(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1);
RemoveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"TUT_CHARACTERINPOD");
RemoveStatus(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "TUT_SHADOWHEARTINPOD");
PROC_StopFollow((CHARACTER)S_TUT_Lab_TrappedDevourer_6ca92237-eb1e-4ed8-a1ee-18b3bef21558);
SetForceUpdate(S_TUT_TransformChamber_DrainVictim_000_5bc43df4-6274-4b73-baed-c7f5268b2fc7,0);
SetForceUpdate(S_TUT_TransformChamber_DrainVictim_001_dd1d4bcf-da0e-441a-b700-7273bad6579e,0);

ENDEXITSECTION
ParentTargetEdge "Tutorial"
