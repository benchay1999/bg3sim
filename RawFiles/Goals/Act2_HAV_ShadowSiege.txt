Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_TriggerEvents_TriggerSet("HAV_Siege_FF_Zone",(TRIGGER)S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45);
DB_TriggerEvents_TriggerSet("HAV_Siege_FF_Zone",(TRIGGER)S_HAV_Haven_SUB_Cellar_eee18cb6-443a-4b8f-ad19-58dff3d731d8);
DB_TriggerEvents_AllPlayersLeftAllTriggersInSet("HAV_Siege_FF_Zone","HAV_Siege_FF_AllPlayersLeft");

DB_AddCharactersInTriggerToDialog(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99,S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45,1,1,1);
DB_AddCharactersInTriggerToDialog(HAV_Siege_Outro_9c82a52e-ee30-d74a-8f20-59ad593acb6b,S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45,1,1,1);
DB_AddCharactersInTriggerToDialog(HAV_Siege_Outro_9c82a52e-ee30-d74a-8f20-59ad593acb6b,S_HAV_Haven_SUB_Cellar_eee18cb6-443a-4b8f-ad19-58dff3d731d8,1,1,1);
DB_DropMutingStatussesDialog(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99);

PROC_TriggerRegisterForPlayers(S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45);

TriggerRegisterForCharacter(S_HAV_Siege_IsobelCheckTrigger_530e7f2c-5fd6-4899-ab0c-e04d984b8826,S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);

NOT DB_HAV_Siege_NPCs((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);
// Key NPCs
DB_HAV_Siege_NPCs(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_HAV_Siege_NPCs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_HAV_Siege_NPCs(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
DB_HAV_Siege_NPCs(S_HAV_GnomeCat_33e545f6-9a0a-48ae-88b4-896a0c21c8ca);
// Outcasts
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_FountainPatrol_Caster_ff70f59a-7d50-4e69-a768-60a97c6fb57d);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_DockGuard_Melee_f1f837ad-8e6a-442d-bba4-46f665c47675);
DB_HAV_Siege_NPCs(S_HAV_EnteringHaven_Guard_f48078e6-ec51-49a2-a244-9d0a72af5257);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_BarricadeGuards_Melee_Dwarf_b1d8b327-1f27-4921-aa2b-dd18a9d67fc8);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_BarricadeRunners_Ranger_572690b6-68f5-4e7b-807b-b9376b658b65);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_BarricadeYeller_Ranger_b612ef5f-3381-4486-8959-84dd399fb1ae);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_DockGuard_Ranger_a0f9d7cb-d87c-4af8-87fa-d273a8ecba93);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_HarperQuartermaster_f769815c-d437-4a45-9ae4-aebd53ec8f7c);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_DockGuard_Left_Melee_bd46130e-1c2c-4888-9e9c-6dd58965ab4f);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_DockGuard_Left_Ranger_3a856945-e4a5-4214-89af-84a2b50789d8);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_EntranceGuards_Caster_HighElf_825714dd-7df9-4cd1-aecb-edf577baa487);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_EntranceGuards_Halfling_Melee_c8bc8f03-c91c-42d4-829c-d16bb1df4a67);
DB_HAV_Siege_NPCs(S_HAV_HavenOutcasts_RoofWatcher_Caster_d44b6aee-7737-4961-bb2b-e7920b003107);
// FFs
DB_HAV_Siege_NPCs(S_GLO_Desire_8b9fa503-7205-4ddd-bdfa-bfaa781d9ea9);
DB_HAV_Siege_NPCs(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
DB_HAV_Siege_NPCs(S_HAV_FlamingFist_001_47058367-9c0c-4756-a467-07b87b28e0d6);
DB_HAV_Siege_NPCs(S_HAV_FlamingFist_002_39ace2b4-699d-468c-a664-8a06492d997a);
DB_HAV_Siege_NPCs(S_HAV_FlamingFist_003_128c0f54-fea0-49df-89ca-c2ca8d996a31);
DB_HAV_Siege_NPCs(S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373);
DB_HAV_Siege_NPCs(S_HAV_FlamingFist_005_0e691c0a-562b-43bb-8554-cde1194decd5);
DB_HAV_Siege_NPCs(S_HAV_FlamingFist_006_9629c27e-8e50-4258-8bda-6639af768ba6);
DB_HAV_Siege_NPCs(S_HAV_Manip_0b8fdd17-7ce6-4038-9d9d-49f5ddbc20be);
DB_HAV_Siege_NPCs(S_HAV_AncientFist_MartCullagh_378938e2-2193-49a3-a06e-8e26cc128055);
// Harpers
DB_HAV_Siege_NPCs(S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f);
DB_HAV_Siege_NPCs(S_HAV_HarperGuard_002_34a9bfd8-1ca2-4a1c-b72e-2bf1cfc046a4);
DB_HAV_Siege_NPCs(S_SCL_Drider_Harper_Caster_000_ef609a8e-08bf-4648-bbb4-380a7f4bc887);
DB_HAV_Siege_NPCs(S_SCL_Drider_Harper_Melee_000_b9f6bb1e-f4cd-4bb3-a7f0-80aad9bae8c8);
DB_HAV_Siege_NPCs(S_SCL_Drider_Harper_Ranger_000_ce089a64-1a91-4ab0-ac71-a2712680780d);
DB_HAV_Siege_NPCs(S_SCL_Drider_Harper_Ranger_001_71c140fa-0ebd-4f36-8728-6e28a445a6ff);
DB_HAV_Siege_NPCs(S_SCL_HarperScout_000_c6dfb2aa-809f-4b3e-8b32-968c10184ec3);
DB_HAV_Siege_NPCs(S_SCL_HarperScout_001_25e154f6-d762-4bea-862e-98c48d7ebe3e);
DB_HAV_Siege_NPCs(S_SCL_HarperScout_003_9bebec18-ca66-42e9-abce-8d6a5f9d2a1b);
// Tiefling from DB_HAV_TieflingSurvivors
DB_HAV_Siege_NPCs(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);
DB_HAV_Siege_NPCs(S_DEN_CharmedKid_3b92c689-6024-4446-a6c9-584e9e8d77ca);
DB_HAV_Siege_NPCs(S_DEN_PickpocketTrader_e1fda08b-45d4-41db-84b5-20e9931ba5af);
DB_HAV_Siege_NPCs(S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925);
DB_HAV_Siege_NPCs(S_DEN_Trainee_001_1f839ad2-2bcb-47d2-8de9-db7a1fb5d67f );
DB_HAV_Siege_NPCs(S_DEN_Trainee_002_bd7f31a6-98e8-46cd-97be-4347fa45d387);
DB_HAV_Siege_NPCs(S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79);

DB_HAV_Siege_NPCs(S_GLO_YoungLover_02_dcf597c0-36c5-4c81-957a-6fe9fca50a68);
DB_HAV_Siege_NPCs(S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892);


DB_HAV_Siege_CinematicCandidatesPos(1,S_HAV_Siege_Cine_KeyNPCPos_ac7123b7-cf6b-4754-a7a3-9d360f896cff);
DB_HAV_Siege_CinematicPlayerPos(S_HAV_Siege_Cine_PlayersPos_be08583b-092a-469d-b6fe-d908f99de8bb);

DB_HAV_Siege_PreparedJaheiraForCinematic((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);
DB_HAV_Siege_PreparedDyingHarperForCinematic((CHARACTER)S_HAV_DummyBackup_DyingInCinematic_26a7386d-4a3e-4e0c-9e26-d904579fec42); // removed later if candidate is present
DB_HAV_Siege_PreparedKidnapperForCinematic((CHARACTER)NULL_00000000-0000-0000-0000-000000000000); // removed later if candidate is present

DB_HAV_Siege_Haven_SUBs((TRIGGER)S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab);
DB_HAV_Siege_Haven_SUBs((TRIGGER)S_HAV_Haven_SUB_Cellar_eee18cb6-443a-4b8f-ad19-58dff3d731d8);

PROC_HAV_Siege_FillDBsFromOtherGoals();

DB_CustomDialogRange(S_HAV_DummyBackup_DyingInCinematic_26a7386d-4a3e-4e0c-9e26-d904579fec42,900000);

DB_HAV_Siege_IsobelMurderDisapprovers((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_HAV_Siege_IsobelMurderDisapprovers((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_HAV_Siege_IsobelMurderDisapprovers((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

DB_HAV_TakingIsobel_Kidnapper((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("HAV_Destruction", HAV_GeneralHaven_State_HavenDestroyed_efc8a650-b68f-4041-b75a-2d44a8be60b4);

DB_DontCreateMurder(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
KBSECTION
//REGION Debug
IF
FlagSet(Debug_HAV_Siege_OnlyIntroDialog_c2945f26-113f-48e9-ad81-cfbdcfccd266,_Player,_)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_ForceStopDialog(_Player);
DB_Debug_HAV_Siege_Jaheira(NULL_00000000-0000-0000-0000-000000000000);
DB_Debug_HAV_Siege_Kidnapper1(NULL_00000000-0000-0000-0000-000000000000);
DB_Debug_HAV_Siege_Kidnapper2(NULL_00000000-0000-0000-0000-000000000000);
RealtimeObjectTimerLaunch(_Player,"Debug_HAV_Siege_IntroDialogDirectly",500);

IF
ObjectTimerFinished(_Player,"Debug_HAV_Siege_IntroDialogDirectly")
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_Debug_HAV_Siege_IntroDialogDirectly(_Player);

PROC
PROC_Debug_HAV_Siege_IntroDialogDirectly((CHARACTER)_Player)
AND
NOT DB_GlobalFlag(GLO_Jaheira_State_PermaDefeated_932fb5a1-00ba-4621-b7ae-877d40d7ddcd)
THEN
NOT DB_Debug_HAV_Siege_Jaheira(NULL_00000000-0000-0000-0000-000000000000);
DB_Debug_HAV_Siege_Jaheira(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_Debug_HAV_Siege_IntroDialogDirectly((CHARACTER)_Player)
AND
NOT DB_GlobalFlag(HAV_TakingIsobel_State_SpyIsDefeated_863bc783-83ad-4102-b0ee-b5b70b136047)
THEN
NOT DB_Debug_HAV_Siege_Kidnapper1(NULL_00000000-0000-0000-0000-000000000000);
DB_Debug_HAV_Siege_Kidnapper1(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);

PROC
PROC_Debug_HAV_Siege_IntroDialogDirectly((CHARACTER)_Player)
AND
DB_Debug_HAV_Siege_Kidnapper1(NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_Debug_HAV_Siege_Kidnapper2(NULL_00000000-0000-0000-0000-000000000000);
DB_Debug_HAV_Siege_Kidnapper2(S_HAV_TaxiGhoul_3ebef8c7-2733-42aa-9757-84fdeadbe652);


PROC
PROC_Debug_HAV_Siege_IntroDialogDirectly((CHARACTER)_Player)
AND
DB_Debug_HAV_Siege_Jaheira(_Jaheira)
AND
DB_Debug_HAV_Siege_Kidnapper1(_Spy)
AND
DB_Debug_HAV_Siege_Kidnapper2(_Ghoul)
AND
QRY_StartDialogCustom_Fixed(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99, _Jaheira, S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _Spy, _Ghoul, _Player, 0, 0, 0, 1)
THEN
DB_NOOP(1);


IF
FlagSet(Debug_HAV_Siege_KidnapIsobel_SpySide_1bc6bce7-39d8-42be-beef-56980ef125e2,_,_)
AND
GetHostCharacter(_Player)
THEN
PROC_ForceStopDialog(_Player);
DB_Debug_HAV_Siege_Start_SpySide(1);
DB_HAV_Siege_PlayerInAbduction(_Player);
DB_HAV_TakingIsobel_Kidnapper((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
PROC_Debug_StartRecurrent("Debug_HAV_Siege_Start",10,100);

IF
FlagSet(Debug_HAV_Siege_KidnapIsobel_GhoulSide_53a6a341-71c9-4df1-b8b6-5eb5ce50c334,_,_)
AND
GetHostCharacter(_Player)
THEN
PROC_ForceStopDialog(_Player);
DB_Debug_HAV_Siege_Start_GhoulSide(1);
DB_HAV_Siege_PlayerInAbduction(_Player);
Die(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,DEATHTYPE.DoT,1);
PROC_Debug_StartRecurrent("Debug_HAV_Siege_Start",10,100);

IF
FlagSet(Debug_HAV_Siege_KidnapIsobel_SpySide_JahDead_b81e1a49-281e-4be5-9e82-75a5cda66529,_,_)
AND
GetHostCharacter(_Player)
THEN
PROC_ForceStopDialog(_Player);
DB_Debug_HAV_Siege_Start_SpySide(1);
DB_HAV_Siege_PlayerInAbduction(_Player);
DB_HAV_TakingIsobel_Kidnapper((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
Die(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,DEATHTYPE.DoT,1);
PROC_Debug_StartRecurrent("Debug_HAV_Siege_Start",10,100);

IF
FlagSet(Debug_HAV_Siege_KidnapIsobel_GhoulSide_JahDead_36a4e474-e983-436a-88f5-4383bce6c65b,_,_)
AND
GetHostCharacter(_Player)
THEN
PROC_ForceStopDialog(_Player);
DB_Debug_HAV_Siege_Start_GhoulSide(1);
DB_HAV_Siege_PlayerInAbduction(_Player);
Die(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,DEATHTYPE.DoT,1);
Die(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,DEATHTYPE.DoT,1);
PROC_Debug_StartRecurrent("Debug_HAV_Siege_Start",10,100);

IF
FlagSet(Debug_HAV_Siege_KidnapIsobel_IsobelSide_bf985e5e-bd25-4bb7-ac52-668954bb2ed9,_,_)
AND
GetHostCharacter(_Player)
THEN
PROC_ForceStopDialog(_Player);
DB_Debug_HAV_Siege_Start_SpySide(0);
DB_HAV_Siege_PlayerInAbduction(_Player);
DB_HAV_TakingIsobel_Kidnapper((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
PROC_Debug_StartRecurrent("Debug_HAV_Siege_Start",10,100);

IF
TextEvent("hav_siege_outro")
AND
GetHostCharacter(_Player)
THEN
PROC_GlobalSetFlagAndCache(Debug_HAV_Siege_PlayersAutoWin_87bd337d-0c0a-45ad-b623-d741f69785ab);
PROC_ForceStopDialog(_Player);
DB_Debug_HAV_Siege_Start_SpySide(0);
DB_HAV_Siege_PlayerInAbduction(_Player);
DB_HAV_TakingIsobel_Kidnapper((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
PROC_Debug_StartRecurrent("Debug_HAV_Siege_Start",11,100);


IF
FlagSet(Debug_HAV_Siege_Start_bb8418df-ccfb-4a99-8bd9-6640eb7080e0,_,_)
AND
GetHostCharacter(_Player)
THEN
PROC_ForceStopDialog(_Player);
DB_Debug_HAV_Siege_Start_SpySide(0);
DB_HAV_Siege_PlayerInAbduction(_Player);
DB_HAV_TakingIsobel_Kidnapper((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
PROC_Debug_StartRecurrent("Debug_HAV_Siege_Start",11,100);

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",1)
AND
DB_SCL_HarperScouts_Scouts(_Scout)
THEN
TeleportTo(_Scout,S_SCL_HarperBridge_b68e6789-b6d3-4b39-866c-78dcfb37e7f0);

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",1)
THEN
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_State_JaheiraMet_5a642593-c3e8-af53-f0e8-a950cecb6af7);
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_State_WasVouchedFor_49b15dc5-9283-0937-4d7e-e66f3d8d5a11);
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_State_FlamingSpyVouch_f3850740-f19b-44c0-a018-00fa00e87b31);
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_Knows_FlamingFistIsSpy_5e5cd42d-0187-8d9d-3823-a105077c7278);
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_State_GainedAccess_07c776da-353a-9050-e9be-c42d51a99412);
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_TadpoleCheckpoint_StatedCure_39f76d25-cbd9-dbdd-af2d-1077deaa6bfc);

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",2)
AND
GetHostCharacter(_Player)
THEN
SetFlag(HAV_EnteringHaven_TadpoleCheckpoint_ShowedArtefact_ba75294a-aea1-7c37-ba4c-a9543b5bd02a,_Player);

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",3)
THEN
TeleportTo(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,S_HAV_Jaheira_InnHome2_68f5d526-225a-4436-abc4-7047911be5d8);
TeleportTo(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,S_HAV_SpyInPoint_546e38ea-db44-4b12-bbb7-d486dca08124);

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",4)
AND
GetHostCharacter(_Player)
THEN
PROC_GlobalSetFlagAndCache(HAV_Jaheira_Event_DrankWithJaheira_0c883fae-84dc-128f-45fb-528fdb33631d);
SetFlag(HAV_TakingIsobel_UserShortCut_SkipWine_f0bdfa03-ca0e-41b0-8d61-7142c2239473,_Player);
PROC_GlobalSetFlagAndCache(HAV_Jaheira_State_MissionGiven_7516666c-4c71-86d7-9d2b-9f3a4269970b);
PROC_GlobalSetFlagAndCache(GLO_HAV_TakingIsobel_HeardOfIsobel_118e48d3-982f-05ee-ddc1-a84ca7d5386b);
PROC_GlobalSetFlagAndCache(HAV_Jaheira_SentToIsobel_66fe5023-3708-9bba-5dce-70b4ded2665b);
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_Knows_SpyExplainedHisMission_db491c69-6de0-5958-1f0d-98a6073e94d7);

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",5)
AND
GetHostCharacter(_Player)
THEN
PROC_SpotPlayers_StopSpotting(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy_Greeting");
TeleportTo(_Player,S_HAV_TakingIsobel_PlayerRoomPoint_69c575a0-b9d2-4d78-b3d6-6ce89b9ed48a);
TeleportTo(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,S_HAV_TakingIsobel_IsobelRoomPoint_fec9a316-3db9-4918-a3c2-6d00b8f29ce9);
SetFlag(GLO_HAV_TakingIsobel_BriefInRoom_HasMet_69c150cc-9ffc-a1b4-5ea0-d14aa577e7cc,_Player,0);
PROC_GlobalSetFlagAndCache(HAV_IsobelGaveOintment_277341f5-4dfe-a314-4f7a-d0caad194eec);
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_Event_GiveOintment_efb6aed5-fd07-433b-b0c5-b980bf77bb2c);
PROC_GlobalSetFlagAndCache(GLO_HAV_IsobelGaveMission_4f0dd500-6de8-08ce-7db9-083c891e67e7);
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_Event_FastTransform_00abbf3d-060d-4b7c-a6ee-23cbfd5928fe);

//PROC
//PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",6)
//AND
//GetHostCharacter(_Player)
//THEN
//PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"HAV_Isobel","HAV_Isobel_State_Capture");
//PROC_HAV_TakingIsobel_CaptureStarting();
//PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"HAV_TakingIsobel_Capture","SpyCombat_Confrontation");

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",6)
AND
DB_Debug_HAV_Siege_Start_SpySide(0)
THEN
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"HAV_TakingIsobel_Capture","SpyCombat_SideWithIsobel");

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",8)
AND
DB_Debug_HAV_Siege_Start_SpySide(1)
THEN
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_State_SidedWithSpy_5eb745b2-5043-2f36-4d3a-ee3f09ed7a82);
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"HAV_TakingIsobel_Capture","SpyCombat_SideWithSpy");

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",8)
AND
DB_Debug_HAV_Siege_Start_GhoulSide(1)
THEN
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_State_SidedWithSpy_5eb745b2-5043-2f36-4d3a-ee3f09ed7a82);
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"HAV_TakingIsobel_Capture","SpyCombat_SideWithSpy");

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",9)
THEN
//PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_Event_SpyCombatStarted_b0930689-e539-424e-bc92-e4a37fbee7d5);
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_Event_SpawnGhouls_e8d0fd32-5eff-4101-bb7c-6d2e1acd4ba4);
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_Event_AbductionAttempted_24605994-7bed-3f92-36f0-1472d32ab2ea);
//PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"HAV_Isobel","HAV_Isobel_State_FollowUp_Capture");

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",10)
THEN
SetOnStage(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,0);
SetOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,0);
//ApplyStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"KNOCKED_OUT",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_Debug_DoRecurrent("Debug_HAV_Siege_Start",11)
THEN
DB_Debug_HAV_Siege_StopIntroDialog(1);

IF
DialogStarted(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99,_Instance)
AND
DB_Debug_HAV_Siege_StopIntroDialog(1)
AND
DB_DialogPlayers(_Instance,_Player,_)
THEN
PROC_ForceStopDialog(_Player);

IF
DB_Debug_HAV_Siege_StopIntroDialog(1)
AND
DB_DialogName(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99,_Instance)
AND
DB_DialogPlayers(_Instance,_Player,_)
THEN
PROC_ForceStopDialog(_Player);

/*
IF
FlagSet(HAV_Siege_Event_SiegeStart_9e906939-7f64-4356-9974-670c422ba9f9,_,_)
AND
DB_Debug_HAV_Siege_StopIntroDialog(1)
AND
DB_Players(_Player)
THEN
TeleportTo(_Player,TeleportTrigger_066_96d494ca-9320-4db6-a33d-21a9532d7345);
*/

IF
DB_GLO_DefeatCounter(_NPC,"HAV_Siege")
AND
DB_GlobalFlag(Debug_HAV_Siege_PlayersAutoWin_87bd337d-0c0a-45ad-b623-d741f69785ab)
THEN
Die((CHARACTER)_NPC,DEATHTYPE.DoT,1);

IF
FlagSet(Debug_HAV_Siege_KillSiege_6829cb77-12cb-4256-bff1-32ea56805395,_,_)
AND
DB_GLO_DefeatCounter(_Enemy,"HAV_Siege")
THEN
Die(_Enemy,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);

IF
FlagSet(Debug_HAV_Siege_FastForward_b2e64e12-67d4-43ba-8da7-8e3f5af8a5d3,_,_)
THEN
PROC_HAV_Siege_FastForward();

IF
FlagSet(Debug_HAV_Siege_KnockOutIsobel_2fbe9b87-9d04-436b-99bd-873cda2fd8c8,NULL_00000000-0000-0000-0000-000000000000,_)
THEN
ApplyStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "KNOCKED_OUT", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("siege_end")
AND
DB_GLO_DefeatCounter(_Enemy,"HAV_Siege")
THEN
Die(_Enemy,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);

IF
DB_Is_InCombat(_Entity,_CombatID)
AND
NOT DB_HAV_Siege_EnemyWaves(_,_Entity)
AND
DB_HAV_Siege_EnemyWaves(_,_Shadow)
AND
DB_Is_InCombat(_Shadow,_CombatID)
AND
NOT DB_PartyMembers((CHARACTER)_Entity)
AND
DB_GlobalFlag(Debug_HAV_Siege_ShadowsAutoWin_2778abae-5b7f-4a9e-b35b-ea82f5317c99)
THEN
RealtimeObjectTimerLaunch(_Entity,"Timer_Debug_HAV_Siege_ShadowsWin",3000);

IF
ObjectTimerFinished(_Entity,"Timer_Debug_HAV_Siege_ShadowsWin")
THEN
Die(_Entity,DEATHTYPE.Necrotic,1);
//END_REGION Debug


//REGION Init

PROC
PROC_HAV_Siege_FillDBsFromOtherGoals()
AND
DB_HAV_SavingPrisoners_InHaven(_Tiefling)
THEN
DB_HAV_Siege_NPCs((CHARACTER)_Tiefling);

PROC
PROC_HAV_Siege_FillDBsFromOtherGoals()
AND
DB_SCL_Drider_HarpersGroup(_Harper,_,_)
THEN
DB_HAV_Siege_NPCs(_Harper);

IF
DB_HAV_SavingPrisoners_InHaven(_Tiefling)
AND
_Tiefling != S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b
AND
NOT DB_HAV_Siege_NPCs((CHARACTER)_Tiefling)
AND
NOT DB_GlobalFlag(Debug_HAV_Siege_Start_bb8418df-ccfb-4a99-8bd9-6640eb7080e0)
AND
NOT DB_PermaDefeated(_Tiefling)
THEN
DB_HAV_Siege_NPCs((CHARACTER)_Tiefling);

//Rolan can leave and come back
IF
DB_HAV_Siege_NPCs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
DB_HAV_SavingPrisoners_InHaven((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
NOT DB_GlobalFlag(GLO_Prodigy_State_InHaven_fe9b4527-9d66-45db-8e04-490fd51b7be5)
THEN
NOT DB_HAV_Siege_NPCs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

IF
DB_HAV_SavingPrisoners_InHaven((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
DB_GlobalFlag(GLO_Prodigy_State_InHaven_fe9b4527-9d66-45db-8e04-490fd51b7be5)
AND
NOT DB_HAV_Siege_NPCs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
DB_HAV_Siege_NPCs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

IF
DB_SCL_Drider_HarpersGroup(_Harper,_,_)
AND
NOT DB_HAV_Siege_NPCs(_Harper)
AND
NOT DB_GlobalFlag(Debug_HAV_Siege_Start_bb8418df-ccfb-4a99-8bd9-6640eb7080e0)
AND
NOT DB_PermaDefeated(_Harper)
THEN
DB_HAV_Siege_NPCs(_Harper);

//END_REGION Init


//REGION Flags setup

IF
DB_OffStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
PROC_GlobalSetFlagAndCache(HAV_Siege_State_IsobelINotInHaven_7ef56463-3776-4081-9376-14a0a06ebf53);

IF
LeftTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,S_HAV_Siege_IsobelCheckTrigger_530e7f2c-5fd6-4899-ab0c-e04d984b8826)
THEN
PROC_GlobalSetFlagAndCache(HAV_Siege_State_IsobelINotInHaven_7ef56463-3776-4081-9376-14a0a06ebf53);

IF
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706)
AND
NOT DB_GlobalFlag(HAV_Siege_State_NoMoreSiege_2129857a-bfa2-49c4-a853-c7e08a2fa632)
THEN
SetFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958);

IF
DB_GlobalFlag(HAV_Siege_State_IsobelINotInHaven_7ef56463-3776-4081-9376-14a0a06ebf53)
AND
NOT DB_GlobalFlag(HAV_Siege_State_NoMoreSiege_2129857a-bfa2-49c4-a853-c7e08a2fa632)
THEN
SetFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958);

IF
DB_GlobalFlag(HAV_Siege_Event_IsobelLeftWillingly_07bcb31b-2dc0-494a-847f-8910c3b45e8d)
AND
NOT DB_GlobalFlag(HAV_Siege_State_NoMoreSiege_2129857a-bfa2-49c4-a853-c7e08a2fa632)
THEN
SetFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958);

//Isobel being KO'd flagging
IF
DB_Defeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
DB_KnockedOut(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
NOT DB_GlobalFlag(HAV_Siege_State_NoMoreSiege_2129857a-bfa2-49c4-a853-c7e08a2fa632)
THEN
PROC_GlobalSetFlagAndCache(HAV_Siege_State_IsobelINotInHaven_7ef56463-3776-4081-9376-14a0a06ebf53);
PROC_GlobalSetFlagAndCache(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958);

IF 
FlagSet(HAV_Siege_State_IsobelINotInHaven_7ef56463-3776-4081-9376-14a0a06ebf53, _, _)
AND
DB_HAV_TakingIsobel_MainRoomCombat(_CombatID)
THEN
PROC_SetRelationMutual((FACTION)Act2_HAV_FlamingSpy_Hostile_caa2c8a9-67d2-479b-91ad-f460e66cfd9b, (FACTION)Act2_HAV_Haven_e52bfc8c-7826-470d-a9f5-f6fae80dde82, 50);
PROC_SetRelationToPlayers((FACTION)Act2_HAV_FlamingSpy_Hostile_caa2c8a9-67d2-479b-91ad-f460e66cfd9b, 50);
EndCombat(_CombatID);

//Disabling checkpoint/trespass spotting once Isobel is down, as there are now bigger problems
IF
FlagSet(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958, _, _)
AND
DB_HAV_Siege_NPCs(_Char)
THEN
PROC_CharacterDisableCrime(_Char, "Trespassing");

//Good for debugging. Leave in place
IF
DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
AND
NOT DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706)
AND
NOT DB_GlobalFlag(HAV_Siege_State_IsobelINotInHaven_7ef56463-3776-4081-9376-14a0a06ebf53)
AND
NOT DB_GlobalFlag(HAV_Siege_Event_IsobelLeftWillingly_07bcb31b-2dc0-494a-847f-8910c3b45e8d)
THEN
ClearFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958);

//END_REGION Flags setup


//REGION Track players involved in Isobel disappearance

IF
DialogActorJoined(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985,_,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_HAV_Siege_PlayerInAbduction(_)
THEN
DB_HAV_Siege_PlayerInAbduction(_Player);

//END_REGION Track players involved in Isobel disappearance


//REGION Starting the Siege Cinematic
//Clear downed from prefered speaker if applicable
IF
FlagSet(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958,_,_)
AND
NOT DB_GlobalFlag(SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169)
AND
DB_HAV_Siege_PlayerInAbduction(_Player)
AND
DB_Downed(_Player)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
UseSpell(NULL_00000000-0000-0000-0000-000000000000, "Target_Help", _Player);
DB_HAV_Siege_SpeakerRestore(_Player);

IF
StatusRemoved(_Player, "DOWNED", _, _)
AND
DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
AND
NOT DB_GlobalFlag(SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169)
AND
DB_HAV_Siege_PlayerInAbduction((CHARACTER)_Player)
AND
DB_HAV_Siege_SpeakerRestore((CHARACTER)_Player)
THEN
NOT DB_HAV_Siege_SpeakerRestore(_Player);
PROC_HAV_Siege_StartSiegeCinematic(_Player);

IF
FlagSet(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958,_,_)
AND
NOT DB_HAV_Siege_PlayerInAbduction(_)
AND
NOT DB_GlobalFlag(SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
PROC_HAV_Siege_StartSiegeCinematic(NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958,_,_)
AND
DB_HAV_Siege_PlayerInAbduction(_Player)
AND
NOT DB_GlobalFlag(SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169)
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_Downed(_Player)
THEN
PROC_HAV_Siege_StartSiegeCinematic(_Player);

PROC
PROC_HAV_Siege_StartSiegeCinematic(_)
AND
NOT DB_GlobalFlag(HAV_EnteringHaven_GainedAccess_StopSpotting_a51abf96-f5df-4dca-9acd-414eee740884)
THEN
PROC_RemoveDBTrespassTrigger((TRIGGER)S_HAV_EnteringHaven_ForbiddenArea_307bf271-9af2-4572-967a-e87edf41bf54,(TRIGGER)S_HAV_TrespassReturnPos_28cd1e46-be2c-44c2-810f-a6d4c6c3b25c);
PROC_TriggerUnregisterForPlayers(S_HAV_EnteringHaven_SpotTrigger_38b4a5b6-47a3-4e3c-826a-1b63c60863f7);

PROC
PROC_HAV_Siege_StartSiegeCinematic((CHARACTER)_PlayerCandidate)
AND
QRY_HAV_Siege_PreparePlayerForCinematic(_PlayerCandidate)
AND
DB_HAV_Siege_PreparedPlayerForCinematic(_Player)
AND
QRY_HAV_Siege_PrepareActorsForIntroCinematic()
AND
DB_HAV_Siege_PreparedJaheiraForCinematic(_JaheiraIfAvailable)
AND
DB_HAV_Siege_PreparedDyingHarperForCinematic(_DyingHarper)
AND
DB_HAV_Siege_PreparedKidnapperForCinematic(_Kidnapper)
AND
QRY_StartDialogCustom_Fixed(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99, _JaheiraIfAvailable, _DyingHarper, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, S_HAV_TaxiGhoul_3ebef8c7-2733-42aa-9757-84fdeadbe652, _Player, 0, 0, 0, 0)
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99,_DialogID)
THEN
PROC_DialogAddSpeakingActor(_DialogID,S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);


PROC
PROC_StartDialog_AddExtraSpeakers(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99,_DialogID)
AND
DB_HAV_Siege_PreparedKidnapperForCinematic(_Kidnapper)
THEN
PROC_DialogAddSpeakingActor(_DialogID,_Kidnapper);

PROC
PROC_StartDialog_AddExtraSpeakers(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99, _DialogID)
AND
DB_PartyMembers(_Character)
AND
NOT DB_HAV_Siege_PreparedPlayerForCinematic(_Character)
THEN
PROC_DialogAddListeningActor(_DialogID, _Character);

IF
DB_DialogPlayers(_ID, _Avatar, 1)
AND
DB_DialogName((DIALOGRESOURCE)HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99, _ID)
AND
DB_DialogRequestCache_SpeakerList_Players(_, _DialogID, _Avatar, 1)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
GetFlag(ORI_DarkUrge_State_KilledIsobel_9148a397-dd31-44b5-84dd-ecdaade56042, _Avatar, 1)
AND
DB_HAV_Siege_IsobelMurderDisapprovers(_Companion)
AND
DB_DialogPlayers(_ID, _Companion, _)
AND
NOT DB_Avatars(_Companion)
AND
QRY_SameUser(_Companion, _Avatar)
THEN
SetFlag((FLAG)HAV_Siege_State_CanBlameForIsobelMurder_812e2b76-ea3d-4ee4-aa8e-90deb31b85bd, _Companion, 0);

IF
DialogEnded(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99,_)
AND
NOT DB_GlobalFlag((FLAG)HAV_Siege_Intro_DoSetup_b6ae7abe-c08f-7555-42fa-83610fa07802)
AND
NOT DB_BUGFIX_Marker("GUS-294724-2")
THEN
PROC_HAV_Siege_Intro_Started();

IF
FlagSet((FLAG)HAV_Siege_Intro_DoSetup_b6ae7abe-c08f-7555-42fa-83610fa07802, _, _)
AND
NOT DB_BUGFIX_Marker("GUS-294724-2")
THEN
PROC_HAV_Siege_Intro_Started();

PROC
PROC_HAV_Siege_Intro_Started()
THEN
DB_GLO_DefeatCounter(S_HAV_Siege_W1_Vine_01_a21562c0-d05f-45aa-9fdd-68cbf4be0f90, "HAV_Siege");
DB_GLO_DefeatCounter(S_HAV_Siege_W1_Vine_02_02cd562f-68d6-4ed1-8adb-09628143fa8b, "HAV_Siege");
DB_GLO_DefeatCounter(S_HAV_Siege_W1_Vine_03_b18f12e8-e3ca-4c80-93fe-9332907c9e45, "HAV_Siege");
PROC_HAV_Siege_TeleportCinematicActors();

PROC
PROC_HAV_Siege_Intro_Started()
AND
NOT DB_Defeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
NOT DB_CombatReact_AD_OnTurn(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, (DIALOGRESOURCE)HAV_Haven_AD_FlamingSpy_IsobelCombat_000_ef1f8b3e-b0f9-166c-49ad-a6ac1693e0ee, 1);
NOT DB_CombatReact_AD_OnTurn(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, (DIALOGRESOURCE)HAV_Haven_AD_FlamingSpy_IsobelCombat_001_82af9a75-2416-7942-3bc3-52b4995da643, 2);
NOT DB_CombatReact_AD_OnTurn(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, (DIALOGRESOURCE)HAV_Haven_AD_FlamingSpy_IsobelCombat_002_7cf2dbea-d5e4-4733-f3e8-264a914afe62, 3);

PROC
PROC_HAV_Siege_StartSiegeCinematic((CHARACTER)_PlayerCandidate)
AND
NOT DB_HAV_Siege_PreparedPlayerForCinematic(_)
AND
NOT QRY_HAV_Siege_FastForward()
THEN
DB_NOOP(1);

PROC
PROC_StateSet_Defeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
DB_HAV_TakingIsobel_Kidnapper(S_HAV_TaxiGhoul_3ebef8c7-2733-42aa-9757-84fdeadbe652);
NOT DB_HAV_TakingIsobel_Kidnapper((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);

QRY
QRY_HAV_Siege_PreparePlayerForCinematic((CHARACTER)_PriorityPlayer)
THEN
SysClear("DB_HAV_Siege_PreparedPlayerForCinematic",1);
DB_DialogStarted_IgnoreStopConditions(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99);


//Priority player isn't downed, they maintain priority
QRY
QRY_HAV_Siege_PreparePlayerForCinematic((CHARACTER)_PriorityPlayer)
AND
DB_InRegion(_PriorityPlayer,S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45)
AND
NOT DB_Downed(_PriorityPlayer)
AND
NOT DB_Defeated(_PriorityPlayer)
THEN
DB_HAV_Siege_PreparedPlayerForCinematic(_PriorityPlayer);


//Priority player is defeated, we check for other players in cinematic trigger that aren't downed and make them the priority player
QRY
QRY_HAV_Siege_PreparePlayerForCinematic((CHARACTER)_PriorityPlayer)
AND
NOT DB_HAV_Siege_PreparedPlayerForCinematic(_PriorityPlayer)
AND
DB_Players(_Player)
AND
_Player != _PriorityPlayer
AND
NOT DB_Downed(_Player)
AND
NOT DB_Defeated(_Player)
AND
DB_InRegion(_Player, S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45)
AND
QRY_OnlyOnce("HAV_Siege_FallbackSpeakerNearSelected")
THEN
DB_HAV_Siege_PreparedPlayerForCinematic(_Player);

//No fallback speakers in Haven, we get a non-downed speaker outside of Haven and set a flag that forces the cinematic only version of the dialog
QRY
QRY_HAV_Siege_PreparePlayerForCinematic((CHARACTER)_PriorityPlayer)
AND
NOT DB_HAV_Siege_PreparedPlayerForCinematic(_)
AND
DB_Players(_Player)
AND
NOT DB_InRegion(_Player, S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45)
AND
NOT DB_Downed(_Player)
AND
NOT DB_Defeated(_Player)
AND
QRY_OnlyOnce("HAV_Siege_FallbackSpeakerFarSelected")
THEN
PROC_GlobalSetFlagAndCache(HAV_Siege_State_BlockPlayerFromTeleport_30e1268e-9dea-413f-ac52-61438f7c9c80);
DB_HAV_Siege_PreparedPlayerForCinematic(_Player);


QRY
QRY_HAV_Siege_PrepareActorsForIntroCinematic()
THEN
PROC_ForceStopDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
PROC_ForceStopDialog(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5);

QRY
QRY_HAV_Siege_PrepareActorsForIntroCinematic()
AND
QRY_SpeakerIsAvailable(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,1,1)
AND
NOT DB_GlobalFlag(MOO_Assault_State_JaheiraPresent_7d113d3f-aae7-40fe-9672-55094729f3dd)
THEN
NOT DB_HAV_Siege_PreparedJaheiraForCinematic(NULL_00000000-0000-0000-0000-000000000000);
DB_HAV_Siege_PreparedJaheiraForCinematic(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
//TeleportTo(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,S_HAV_Siege_Cine_KeyNPCPos_ac7123b7-cf6b-4754-a7a3-9d360f896cff,"",0,0,0,1,1);

QRY
QRY_HAV_Siege_PrepareActorsForIntroCinematic()
AND
QRY_SpeakerIsAvailable(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5,1,1)
THEN
NOT DB_HAV_Siege_PreparedDyingHarperForCinematic(S_HAV_DummyBackup_DyingInCinematic_26a7386d-4a3e-4e0c-9e26-d904579fec42);
DB_HAV_Siege_PreparedDyingHarperForCinematic(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5);
//TeleportTo(S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5,S_HAV_Siege_Cine_DyingHarperPos_e1e4f2c0-b70d-46b6-b698-37414b1f01f3,"",0,0,0,1,1);

QRY
QRY_HAV_Siege_PrepareActorsForIntroCinematic()
AND
DB_HAV_TakingIsobel_Kidnapper(_Kidnapper)
THEN
PROC_ForceStopDialog(_Kidnapper);

QRY
QRY_HAV_Siege_PrepareActorsForIntroCinematic()
AND
DB_HAV_TakingIsobel_Kidnapper(_Kidnapper)
AND
QRY_SpeakerIsAvailable(_Kidnapper,1,1)
THEN
NOT DB_HAV_Siege_PreparedKidnapperForCinematic(NULL_00000000-0000-0000-0000-000000000000);
DB_HAV_Siege_PreparedKidnapperForCinematic(_Kidnapper);

QRY
QRY_HAV_Siege_PrepareActorsForIntroCinematic()
AND
DB_HAV_TakingIsobel_Kidnapper(_Kidnapper)
AND
NOT DB_HAV_Siege_PreparedKidnapperForCinematic(_Kidnapper)
THEN
SetOnStage(S_HAV_TaxiGhoul_3ebef8c7-2733-42aa-9757-84fdeadbe652,1);
DB_HAV_Siege_PreparedKidnapperForCinematic(S_HAV_TaxiGhoul_3ebef8c7-2733-42aa-9757-84fdeadbe652);

QRY
QRY_HAV_Siege_PrepareActorsForIntroCinematic()
AND
NOT DB_HAV_TakingIsobel_Kidnapper(_)
THEN
SetOnStage(S_HAV_TaxiGhoul_3ebef8c7-2733-42aa-9757-84fdeadbe652,1);
DB_HAV_Siege_PreparedKidnapperForCinematic(S_HAV_TaxiGhoul_3ebef8c7-2733-42aa-9757-84fdeadbe652);

IF
DB_HAV_Siege_PreparedPlayerForCinematic(_Player)
THEN
PROC_ForceStopDialog(_Player);

PROC
PROC_HAV_Siege_TeleportCinematicActors()
AND
DB_HAV_Siege_CinematicCandidatesPos(_Index,_Pos)
THEN
RemoveSurfaceLayer(_Pos,"Ground",2.0);
RemoveSurfaceLayer(_Pos,"Cloud",2.0);

PROC
PROC_HAV_Siege_TeleportCinematicActors()
AND
DB_HAV_Siege_CinematicPlayerPos(_Pos)
THEN
RemoveSurfaceLayer(_Pos,"Ground",2.0);
RemoveSurfaceLayer(_Pos,"Cloud",2.0);

PROC
PROC_HAV_Siege_TeleportCinematicActors()
AND
DB_HAV_Siege_CinematicPlayerPos(_Pos)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player,S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45)
AND
CharacterIgnoreActiveCrimes(_Player, _)
THEN
DB_NOOP(1);

PROC
PROC_HAV_Siege_TeleportCinematicActors()
AND
DB_HAV_Siege_CinematicPlayerPos(_Pos)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player,S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45)
AND
NOT DB_GlobalFlag(HAV_Siege_State_BlockPlayerFromTeleport_30e1268e-9dea-413f-ac52-61438f7c9c80)
THEN
TeleportTo(_Player,_Pos,"",0,0,0,1,1);

PROC
PROC_HAV_Siege_Intro_Started()
THEN
PROC_HAV_Siege_PrepareForSiege();

IF
DialogEnded(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99,_ID)
THEN
PROC_HAV_Siege_AfterIntro();

IF
DialogRequestFailed(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99,_)
THEN
PROC_HAV_Siege_Intro_Started();
PROC_HAV_Siege_AfterIntro();

PROC
PROC_HAV_Siege_AfterIntro()
THEN
PROC_State_Progress(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege");
PROC_State_Progress(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Area", "HAV_Area_State_BarrierIsOff");
SetOnStage(S_HAV_TaxiGhoul_3ebef8c7-2733-42aa-9757-84fdeadbe652, 0);


PROC
PROC_State_Changed(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege")
THEN
SetFlag(HAV_Siege_Event_SiegeStart_9e906939-7f64-4356-9974-670c422ba9f9);

//END_REGION Starting the Siege Cinematic


//REGION HAV defeat counter

IF
DB_HAV_Siege_NPCs(_NPC)
THEN
DB_GLO_DefeatCounter(_NPC,"HAV_Destruction");

//END_REGION HAV defeat counter


//REGION Siege VBs and ADs

IF
ScreenFadeCleared(_,"HAV_Siege_CINE_FadeToBlack")
THEN
DB_HAV_Siege_EnterCombatVB_Logic(1);

IF
DB_HAV_Siege_EnterCombatVB_Logic(1)
AND
DB_HAV_Siege_PlayerInAbduction(_Player)
AND
DB_Is_InCombat(_Player, _ID)
AND
DB_HAV_Siege_EnemyWaves(_,_Shadow)
AND
DB_Is_InCombat(_Shadow, _ID)
THEN
PROC_HAV_Siege_EnterCombatVB(_Player);

IF
DB_HAV_Siege_EnterCombatVB_Logic(1)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _ID)
AND
DB_HAV_Siege_EnemyWaves(_,_Shadow)
AND
DB_Is_InCombat(_Shadow, _ID)
THEN
PROC_HAV_Siege_EnterCombatVB(_Player);

PROC
PROC_HAV_Siege_EnterCombatVB((CHARACTER)_Player)
AND
QRY_OnlyOnce("HAV_Siege_EnterCombatVB")
THEN
NOT DB_HAV_Siege_EnterCombatVB_Logic(1); // turn off the rules above
StartVoiceBark(HAV_VB_ShadowSiege_PlayerEntersCombat_9d551bbc-2a39-aecf-cc1f-25cb27f2fe8f,_Player);

IF
WentOnStage(S_HAV_Siege_W3_Boss_37223ef4-2293-4a2a-a1e2-88367d241fcf,1)
THEN
PROC_HAV_Siege_TentacleAppearedPAD();

PROC
PROC_HAV_Siege_TentacleAppearedPAD()
AND
QRY_GetClosestAvailableCharacterTo(S_HAV_Siege_W3_Boss_37223ef4-2293-4a2a-a1e2-88367d241fcf,0,0,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1,1)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Avatar,_,_,1)
AND
QRY_SpeakerIsAvailable(_Avatar)
AND
QRY_IsInRange(S_HAV_Siege_W3_Boss_37223ef4-2293-4a2a-a1e2-88367d241fcf, _Avatar, 30.0)
AND
QRY_OnlyOnce("HAV_Siege_TentacleAppearedPAD")
THEN
PROC_TryStartAD(HAV_Siege_PAD_TentacleAppeared_bb09c4ca-93ca-1c13-882a-b66a57196ec3,_Avatar);

PROC
PROC_HAV_Siege_TentacleAppearedPAD()
AND
NOT DB_OnlyOnce("HAV_Siege_TentacleAppearedPAD")
AND
QRY_GetClosestAvailableCharacterTo(S_HAV_Siege_W3_Boss_37223ef4-2293-4a2a-a1e2-88367d241fcf,1,0,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,1,1)
AND
DB_ClosestAvailableCharacterTo(_Player,_,_)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QRY_IsInRange(S_HAV_Siege_W3_Boss_37223ef4-2293-4a2a-a1e2-88367d241fcf, _Player, 30.0)
AND
QRY_OnlyOnce("HAV_Siege_TentacleAppearedPAD")
THEN
PROC_TryStartAD(HAV_Siege_PAD_TentacleAppeared_bb09c4ca-93ca-1c13-882a-b66a57196ec3,_Player);

//END_REGION Siege VBs and ADs


//REGION Ending the Siege

IF
FlagSet(HAV_Siege_Event_SiegeEnd_1939fc49-17fd-49f8-9030-8c3d627a05df,_,_)
THEN
PROC_State_Progress(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Unprotected");
DB_CustomDialogRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,157);
PROC_HAV_Siege_PlayOutro();

PROC
PROC_HAV_Siege_PlayOutro()
AND
NOT DB_GlobalFlag(MOO_Assault_State_JaheiraPresent_7d113d3f-aae7-40fe-9672-55094729f3dd)
AND
QRY_HAV_Siege_PreparePlayerForEndCinematic()
AND
DB_HAV_Siege_PreparedPlayerForEndCinematic(_Player)
AND
QRY_HAV_Siege_PrepareActorsForOutroCinematic()
AND
NOT QRY_StartDialogCustom_Fixed(HAV_Siege_Outro_9c82a52e-ee30-d74a-8f20-59ad593acb6b,
	S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,
	_Player,
	0, 0, 0, 1)
THEN
NOT DB_CustomDialogRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,157);
PROC_HAV_Siege_OutroDialogFailed();

PROC
PROC_HAV_Siege_PlayOutro()
AND
DB_GlobalFlag(MOO_Assault_State_JaheiraPresent_7d113d3f-aae7-40fe-9672-55094729f3dd)
THEN
NOT DB_CustomDialogRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,157);
PROC_HAV_Siege_OutroDialogFailed();

IF
DialogStarted(HAV_Siege_Outro_9c82a52e-ee30-d74a-8f20-59ad593acb6b,_)
AND
DB_HAV_Torches(_Torch)
THEN
ApplyStatus(_Torch,"BURNING",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_HAV_Siege_OutroDialogFailed()
AND
DB_HAV_Torches(_Torch)
THEN
ApplyStatus(_Torch,"BURNING",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_HAV_Siege_PreparePlayerForEndCinematic()
THEN
SysClear("DB_HAV_Siege_PreparedPlayerForEndCinematic",1);

QRY
QRY_HAV_Siege_PreparePlayerForEndCinematic()
AND
DB_Avatars(_Player)
AND
NOT DB_HAV_Siege_PreparedPlayerForEndCinematic(_)
AND
QRY_InRegions(_Player,S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45,S_HAV_Haven_SUB_Cellar_eee18cb6-443a-4b8f-ad19-58dff3d731d8)
THEN
DB_HAV_Siege_PreparedPlayerForEndCinematic(_Player);

QRY
QRY_HAV_Siege_PreparePlayerForEndCinematic()
AND
DB_Players(_Player)
AND
NOT DB_HAV_Siege_PreparedPlayerForEndCinematic(_)
AND
QRY_InRegions(_Player,S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45,S_HAV_Haven_SUB_Cellar_eee18cb6-443a-4b8f-ad19-58dff3d731d8)
THEN
DB_HAV_Siege_PreparedPlayerForEndCinematic(_Player);

QRY
QRY_HAV_Siege_PrepareActorsForOutroCinematic()
AND
DB_InteractiveDialogSpeaker(_, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_ForceStopDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

QRY
QRY_HAV_Siege_PrepareActorsForOutroCinematic()
THEN
DB_NOOP(1);

IF
DialogEnded(HAV_Siege_Outro_9c82a52e-ee30-d74a-8f20-59ad593acb6b,_)
THEN
NOT DB_CustomDialogRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,157);

//END_REGION Ending the Siege


//REGION Jaheira relation

PROC
PROC_HAV_SetJaheiraAndHavenHostile()
THEN
PROC_SetRelation(GLO_Jaheira_e7dfda4a-9696-4aa1-9abc-9a350a797ed6,Hero_a1542c81-6895-929e-4522-10ce218bb360,0);
PROC_SetRelation(Act2_HAV_Haven_e52bfc8c-7826-470d-a9f5-f6fae80dde82,Hero_a1542c81-6895-929e-4522-10ce218bb360,0);

IF
DialogEnded(HAV_Siege_Outro_9c82a52e-ee30-d74a-8f20-59ad593acb6b,_)
AND
NOT DB_GlobalFlag(HAV_Siege_Intro_JaheiraAggroToPlayer_c7207af6-3ac7-1bd5-22e5-50a381b2c77f)
THEN
PROC_DisappearOutOfSight((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Walk", 0, "HAV_Siege_JaheiraLeftHaven");

IF
DialogEnded(HAV_Siege_Outro_9c82a52e-ee30-d74a-8f20-59ad593acb6b,_)
AND
NOT DB_GlobalFlag(HAV_Siege_Intro_JaheiraAggroToPlayer_c7207af6-3ac7-1bd5-22e5-50a381b2c77f)
AND
DB_HAV_Siege_LowHP(_Harper,_,_)
AND
NOT DB_Defeated(_Harper)
AND
NOT QRY_HAV_Siege_BlockCharacterFromDisappearing(_Harper)
THEN
PROC_NotifyWhenReadyToMoveOn(_Harper,"HAV_Siege_HarperLeavesAfter");

QRY
QRY_HAV_Siege_BlockCharacterFromDisappearing((CHARACTER)_Harper)
AND
0 == 1
THEN
DB_NOOP(1);

PROC
PROC_ReadyToMoveOn(_Harper,"HAV_Siege_HarperLeavesAfter")
THEN
PROC_DisappearOutOfSight(_Harper, "Walk", 0, "");

PROC
PROC_HAV_Siege_OutroDialogFailed()
AND
DB_GlobalFlag(HAV_Siege_Intro_JaheiraAggroToPlayer_c7207af6-3ac7-1bd5-22e5-50a381b2c77f)
THEN
PROC_HAV_SetJaheiraAndHavenHostile();
//END_REGION Jaheira relation


//REGION Siege Fast Forward

// hack: this QRY always succeeds, intended
QRY
QRY_HAV_Siege_FastForward()
THEN
PROC_HAV_Siege_FastForward();

PROC
PROC_HAV_Siege_FastForward()
THEN
PROC_GlobalSetFlagAndCache(HAV_Siege_State_FastForward_2bc1996c-51d9-4e97-b230-daad5eedfdca);

PROC
PROC_HAV_Siege_FastForward()
AND
NOT DB_GlobalFlag(HAV_Siege_Event_SiegeStart_9e906939-7f64-4356-9974-670c422ba9f9)
THEN
PROC_HAV_Siege_PrepareForSiege();

PROC
PROC_HAV_Siege_FastForward()
AND
DB_HAV_Siege_EnemyWaves(_Wave,_Enemy)
THEN
PROC_HAV_Siege_SpawnWave(_Wave);

PROC
PROC_HAV_Siege_FastForward()
AND
QRY_HAV_Siege_FastForward_IsInHaven(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
Die(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,DEATHTYPE.Necrotic,1);

IF
EntityEvent(_Player,"HAV_Siege_FF_AllPlayersLeft")
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
AND
NOT DB_GlobalFlag(HAV_Siege_Event_SiegeEnd_1939fc49-17fd-49f8-9030-8c3d627a05df)
AND
NOT QRY_CheckOtherPlayersInTrigger(_Player,S_HAV_Siege_CinematicIncludeZone_9d4fc4ac-870d-48df-b5b4-05e168238a45)
AND
QRY_OnlyOnce("HAV_Siege_FastForward")
THEN
PROC_HAV_Siege_FastForward();

QRY
QRY_HAV_Siege_FastForward_IsInHaven((CHARACTER)_NPC)
AND
DB_HAV_Siege_Haven_SUBs(_Trigger)
AND
IsInTrigger(_NPC,_Trigger,1)
THEN
DB_NOOP(1);

//END_REGION Siege Fast Forward

//REGION Haven Defeat Music

IF
FlagSet(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958,_,_)
THEN
PROC_MusicPlayGeneral("NightsongDead");

//END_REGION

//REGION Catch all to make sure if Assault has started, we get a flag to know that Haven fell during Assault

IF
FlagSet(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958, _, _)
AND
DB_GlobalFlag(MOO_Assault_State_InProgress_0f3a8f5d-7402-4220-bebb-d4b21d3db08d)
THEN
PROC_GlobalSetFlagAndCache(MOO_Assault_State_HavenFellDuring_420b2cd0-7cb7-4107-946e-d73d27d67037);

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
