Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_GLO_CharacterCorpseDialog(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (DIALOGRESOURCE)HAV_Isobel_Dead_20dadd7f-e5cb-1e5d-f3d7-fe021892ea01);
DB_DeadOnceFlag(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706);
DB_PreventKnockedOutPermaDefeated((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);

//REGION States
DB_State_Current(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom");

DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom", 1000); //On balcony or in room, hasn't given protection yet.
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Capture", 2000); //During capture scene, after the protection spell.
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_FollowUp_Protection", 3000); //She's safe, the spy has been defeated. Cue thanks.
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_PostFollowUpProtection", 4000);
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_FollowUp_Capture", 6000); //Was captured and sent to Moonrise.
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_DefeatedInHaven", 7000); //tbd
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_AtMoonrise", 8000); //At moonrise, followup done.
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_KethericShowdown", 9000); //tbd
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Trials", 10000); //tbd

DB_State_Current(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "SpyCombat_Init");
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "SpyCombat_Init", 0);
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "SpyCombat_SpyReady", 1000);
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "SpyCombat_Confrontation", 4000); //TODO: remove the state "SpyCombat_BargingIn"
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "SpyCombat_SideWithIsobel", 5000);
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "SpyCombat_SideWithSpy", 6000);
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "CombatEnd_Protected", 7000);
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "Tasked_PersuadingIsobel", 8000);
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "Tasked_IsobelPersuaded", 9000);
DB_State_Flags(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "Tasked_IsobelPersuaded", HAV_TakingIsobel_State_IsobelIsPreparingToGoToMT_610216db-cc3a-4d7e-867d-a3f66943aaaa);
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "Tasked_PlayerCombat", 10000);
DB_State_Priority(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "Capture_Finished", 12000);

DB_State_Flags(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom", HAV_TakingIsobel_State_Brief_InRoom_09b77182-7096-46d4-a099-73e50a2b46e6); //this flag is currently unused
DB_State_Flags(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_NightsongReunion", HAV_Isobel_State_InNightsongReunion_30321075-74e9-4f08-8c31-3f5f85feabee);
DB_State_Flags(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_FollowUp_Capture", MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce);
DB_State_Flags(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_AtMoonrise", MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce);
DB_State_Flags(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_KethericShowdown", MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce);

SetHasDialog(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 1);

//END_REGION

//REGION Brief in Room (ointment)

TriggerRegisterForCharacter(S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
TriggerRegisterForCharacter(S_HAV_IsobelPrayerBox_db9e0476-91a4-46bb-82d7-c67a1dbe9b93, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);

//END_REGION

//REGION CallToArm
DB_GLO_Cinematic_PositionFlags("HAV_CallToArm",S_HAV_LakeShoreBox_76a66863-e8ae-45b5-83b8-428561b186de, HAV_TakingIsobel_Event_CallToArmAtLake_3ea0548b-cb0b-4e7e-a2f3-80d45ee90d45);

//END_REGION

DB_HAV_TakingIsobel_IsobelGuards((CHARACTER)S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f, (TRIGGER)S_HAV_IsobelGuardPoint_a0ff52f4-53b9-48dd-ad67-4326a65bd939);
DB_HAV_TakingIsobel_IsobelGuards(S_HAV_HarperGuard_002_34a9bfd8-1ca2-4a1c-b72e-2bf1cfc046a4, S_HAV_IsobelGuardPoint2_4bd40020-5d87-4e0f-b551-ddbfb1f369f7);

DB_HAV_TakingIsobel_FlyingGhouls((CHARACTER)S_HAV_FlyingGhoul_000_62dd0ebd-8325-4b76-ba41-99fbee98149a);
DB_HAV_TakingIsobel_FlyingGhouls((CHARACTER)S_HAV_FlyingGhoul_001_48026cfd-acc4-42dd-a9e3-583cac5f7a34);
DB_HAV_TakingIsobel_FlyingGhouls((CHARACTER)S_HAV_FlyingGhoul_002_c43490d5-4d8c-4986-8b1e-6bcf4325cb0d);
DB_HAV_TakingIsobel_FlyingGhouls((CHARACTER)S_HAV_FlyingGhoul_003_317ba5c6-eda5-4e7a-a288-443c25fd2525);
DB_HAV_TakingIsobel_FlyingGhouls((CHARACTER)S_HAV_FlyingGhoul_004_e63f73e4-2ea1-45cc-b54e-56355b700a9d);
DB_HAV_TakingIsobel_FlyingGhouls((CHARACTER)S_HAV_FlyingGhoul_005_db61112a-dbc9-4f0e-9e6f-332a09f3b35a);


DB_DialogBlockAttackButton((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985);
DB_DialogBlockTradeButton((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985);
DB_DialogBlockAttackButton((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5);
DB_DialogBlockTradeButton((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5);

SetOnStage(S_HAV_TaxiGhoul_3ebef8c7-2733-42aa-9757-84fdeadbe652, 0);

SetFlag(HAV_TakingIsobel_State_SpyIsAvailable_96dd328c-15f7-45ab-bc41-a13aa38ac2a3);


//REGION Marcus Transform Setup

DB_Inclusion_Object((CHARACTER)S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f, (FLAG)HAV_HarperGuard_001_Inclusion_Start_97e01964-a56e-5f96-db72-91bc65a67b5f, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, (CHARACTER)S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f);

//END_REGION

DB_SpotPlayers((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_MarcusCorpse", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_MarcusCorpse", S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f);
PROC_SpotPlayers_StopSpotting((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_MarcusCorpse");

PROC_TriggerRegisterForPlayers(S_HAV_SpyPlayerInBox_edb52dcc-651b-46c5-afd0-e6f3de7beba2);

//Mol's abduction scene is more elaborate, therefore more sensitive to location.
DB_HAV_TakingIsobel_Abductees((CHARACTER)S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925, (TRIGGER)S_HAV_TakingIsobel_InnAttackBox_NPCs_6efdcf8d-83c8-4c78-98e2-3c09a1b6dcf7);
DB_HAV_TakingIsobel_Abductees((CHARACTER)S_HAV_FlamingFist_005_0e691c0a-562b-43bb-8554-cde1194decd5, S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab);
DB_HAV_TakingIsobel_Abductees((CHARACTER)S_HAV_FlamingFist_003_128c0f54-fea0-49df-89ca-c2ca8d996a31, S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab);
DB_HAV_TakingIsobel_Abductees((CHARACTER)S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373, S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab);
DB_HAV_TakingIsobel_Abductees((CHARACTER)S_HAV_FlamingFist_006_9629c27e-8e50-4258-8bda-6639af768ba6, S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab);
DB_HAV_TakingIsobel_Abductees((CHARACTER)S_HAV_FlamingFist_002_39ace2b4-699d-468c-a664-8a06492d997a, S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab);


DB_Inclusion_CombatInclusionDialog(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985);
KBSECTION
//REGION Debug
IF
TextEvent("sendjaheiratoisobel")
THEN 
PROC_HAV_TakingIsobel_FollowUpCleanup();

IF
TextEvent("spycapture")
AND
GetHostCharacter(_Character)
THEN
PROC_Debug_HAV_KidnapIsobel(_Character, 0);

IF
TextEvent("nightsongtohav")
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_CaptureReady");
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_LakeToRoomTransition");
SetFlag(HAV_EnteringHaven_State_GainedAccess_07c776da-353a-9050-e9be-c42d51a99412);
PROC_HAV_EnteringHaven_Admitted();
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_HAV_NightsongFollowup_NightsongPos_Room_fec9a316-3db9-4918-a3c2-6d00b8f29ce9);
TeleportTo(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelPrayerPoint_ad61fb61-370f-4b1b-a40e-85ba0f1f1a8f);
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtInn");
PROC_State_Progress(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_NightsongFollowup_Reunite", "HAV_State_NightsongFollowup_Reunite_Done");
SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);

PROC
PROC_Debug_HAV_KidnapIsobel((GUIDSTRING)_Character,(INTEGER)_)
THEN
PROC_HAV_EnteringHaven_Admitted();
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_State_WasVouchedFor_49b15dc5-9283-0937-4d7e-e66f3d8d5a11);
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_State_FlamingSpyVouch_f3850740-f19b-44c0-a018-00fa00e87b31);
TeleportTo(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_SpyInPoint_546e38ea-db44-4b12-bbb7-d486dca08124);
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour");
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_State_GainedAccess_07c776da-353a-9050-e9be-c42d51a99412);
TeleportTo(_Character, S_HAV_TakingIsobel_PlayerRoomPoint_69c575a0-b9d2-4d78-b3d6-6ce89b9ed48a);

PROC
PROC_Debug_HAV_KidnapIsobel((GUIDSTRING)_Character,0)
THEN
SetFaction(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, (FACTION)Act2_HAV_FlamingSpy_Hostile_caa2c8a9-67d2-479b-91ad-f460e66cfd9b);

PROC
PROC_Debug_HAV_KidnapIsobel((GUIDSTRING)_Character,1)
THEN
SetFaction(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,Act2_HAV_FlamingSpy_Ally_e3da5c3f-056c-4391-83c9-7a78b0703856);
//END_REGION

//REGION End of ritual

PROC
PROC_StateSet_PermaDefeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
HasActiveStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_ISOBEL_MOONRITUAL", 1)
THEN
SetFlag(HAV_TakingIsobel_Event_IsobelToRoom_d1f2df3a-ba92-5599-0b19-b0d9da9c0f5c, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_HAV_TakingIsobel_CheckForMarcusInRoom();

IF
DialogStarted(HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _)
AND
HasActiveStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_ISOBEL_MOONRITUAL", 1)
THEN
PROC_HAV_Isobel_FinishRitual();

//TODO: Add other polish here.

IF
FlagSet(HAV_TakingIsobel_Event_IsobelToRoom_d1f2df3a-ba92-5599-0b19-b0d9da9c0f5c, NULL_00000000-0000-0000-0000-000000000000, _Dialog)
AND
_Dialog != 0
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
IsMovementBlocked((CHARACTER)_Player, 0)
THEN
CharacterMoveTo((CHARACTER)_Player, S_HAV_TakingIsobel_PlayerRoomPoint_69c575a0-b9d2-4d78-b3d6-6ce89b9ed48a, "Stroll", "");

IF
FlagSet(HAV_TakingIsobel_Event_IsobelToRoom_d1f2df3a-ba92-5599-0b19-b0d9da9c0f5c, NULL_00000000-0000-0000-0000-000000000000, _Dialog)
AND
_Dialog != 0
AND
IsMovementBlocked(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 0)
THEN
CharacterMoveTo((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_TakingIsobel_IsobelRoomPoint_fec9a316-3db9-4918-a3c2-6d00b8f29ce9, "Stroll", "");

IF
DialogEnded(HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PurgeOsirisQueue((CHARACTER)_Player, 1);
PurgeOsirisQueue(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 1);



//END_REGION

//REGION Init
IF
FlagSet(MOO_FirstFloor_DukeDouble_Quest_Accepted_10d8d681-e2a3-c472-e7d9-08718f2eaea2, NULL_00000000-0000-0000-0000-000000000000, _)
AND
NOT DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_ReadyForCheckpoint")
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_LeavingCheckpoint");

IF
EntityEvent(_, "HAV_FlamingSpy_GotToRoof")
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_CaptureReady");

PROC
PROC_State_Changed(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_CaptureReady")
THEN
PROC_HAV_TakingIsobel_SetSpyOnStage(0);
TeleportTo(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_SpyTransfoVBBox_d3e2f7f5-3ae0-4269-aa4e-cac02e15f207);
PROC_ForceStopDialog(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
//PROC_Poof(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "SpyCombat_SpyReady");

IF
DB_HAV_TakingIsobel_FlyingGhouls(_Ghoul)
THEN
SetOnStage(_Ghoul, 0);

//END_REGION


// Roof clues

IF
VoiceBarkEnded(HAV_TakingIsobel_VB_SpyTransformationClue_c0c6519e-477a-c5d4-de8b-30077def7b72, _)
AND
NOT DB_CantTalk(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelRoom_SUB_4310edec-0ce2-4ac0-adbd-c02d60b92c3d, 1)
THEN
PROC_TryStartAD(HAV_TakingIsobel_AD_ReactingToRoofNoise_353e1ef0-2546-4ca1-7bef-e3101483d54a, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);


//REGION Harper guard at Isobels door

//Player warned Jaheira and Isobel about Marcus -> two harpers go standing guard in Isobel's room
PROC
PROC_HAV_TakingIsobel_TrySendingGuardToIsobel()
AND
DB_HAV_TakingIsobel_IsobelGuards(_Guard, _Point)
THEN
PROC_CharacterMoveTo(_Guard, _Point, "Run", "");
SetFlag(HAV_TakingIsobel_Event_HarperGuardIsobel_7316cac0-c33c-4bb7-94b4-62c7eb10de86);

QRY
QRY_Inclusion_SpeakerIsAvailableForInclusion((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, _, (CHARACTER)S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f, _)
AND
QRY_SpeakerIsAvailable(S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f, 1)
AND
IsInTrigger(S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f, S_HAV_IsobelRoom_SUB_4310edec-0ce2-4ac0-adbd-c02d60b92c3d, 1)
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelRoom_SUB_4310edec-0ce2-4ac0-adbd-c02d60b92c3d, 1)
THEN
DB_NOOP(1);

QRY
QRY_Inclusion_SpeakerIsAvailableForInclusion((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, _, (CHARACTER)S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f, _)
AND
QRY_SpeakerIsAvailable(S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f, 1)
AND
IsInTrigger(S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f, S_HAV_IsobelRoom_SUB_4310edec-0ce2-4ac0-adbd-c02d60b92c3d, 1)
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelPrayerBox_db9e0476-91a4-46bb-82d7-c67a1dbe9b93, 1)
THEN
DB_NOOP(1);

//END_REGION

//REGION Brief In Room

//Marcus is defeated before he moves to his Spy_DefaultBehaviour state
IF
DB_Defeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
DB_State_Current(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_RemoveNPCADs((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_Dialogs((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, NULL_00000000-0000-0000-0000-000000000000, (DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5);



//Clicking on Marcus -
//- Resume after 
QRY
QRY_SelectCustomDialog_AfterGenerics(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour")
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3)
AND
DB_GlobalFlag(HAV_TakingIsobel_State_IsobelInRoom_cff275db-2618-fac2-581e-051aca727131)
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
IsInTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_IsobelRoom_SUB_4310edec-0ce2-4ac0-adbd-c02d60b92c3d, 1)
AND
QRY_SpeakerIsAvailable((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
NOT QRY_CharacterIsHidden(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
NOT QRY_State_IsBeforeState(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance")
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3)
AND
IsInTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_IsobelRoom_SUB_4310edec-0ce2-4ac0-adbd-c02d60b92c3d, 1)
AND
NOT DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_FlamingSpy_18b84cde-f3e1-5119-4ce3-3ba3dd0354c5, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
NOT QRY_State_IsBeforeState(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance")
AND
NOT DB_CantTalk(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
AND
NOT DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_FlamingSpy_18b84cde-f3e1-5119-4ce3-3ba3dd0354c5, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_AD_SpyWaiting_48c75193-2a89-1066-bbff-7de456bb5c56, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);

//Marcus ignores Halsin if he is the character trying to talk to her
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance")
THEN
DB_SelectedDialog(HAV_Marcus_DismissesHalsin_dcfcdb8f-aabc-bd64-8874-bbebc7b75b3c, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);

//Click on Isobel
//Can only occur on her balcony or in her room - disable the dialogue outside of those areas.

//Marcus is defeated. Skip Marcus, unless Marcus is the topic of the discussion.
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _Player)
AND
DB_State_Current(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom")
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
DB_Defeated((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_SpyDefeatedInRoomOnArrival_3409e8d7-7352-491c-9d93-e15b4f2bfce6)
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f, 1)
AND
IsInTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f, 1)
THEN
SetFlag((FLAG)HAV_TakingIsobel_Event_SpyIsDefeatedInRoom_719e4639-839b-4975-9301-75c4f3189c48, NULL_00000000-0000-0000-0000-000000000000, 0);//Just to be sure we don't start the wrong branch.
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, NULL_00000000-0000-0000-0000-000000000000, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _Player)
AND
DB_State_Current(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom")
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
DB_Defeated((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, NULL_00000000-0000-0000-0000-000000000000, _Player);

//Marcus hasn't arrived yet.
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _Player)
AND
NOT DB_Defeated((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
QRY_State_IsBeforeState(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour")
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_AD_BeforeFlamingSpy_30f5dd95-edc2-04e7-52be-9a2bcc22e7a7, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);

//Marcus is off-screen, waiting for his chance.
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _Player)
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureReady")
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
QRY_SpeakerIsAvailable(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player);

//Marcus is off-screen, waiting for his chance.
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _Player)
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3)
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureReady")
AND
NOT DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, NULL_00000000-0000-0000-0000-000000000000, _Player);

QRY
QRY_SpeakerIsAvailable(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _, _, _)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureReady")
AND
NOT DB_Defeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
DB_NOOP(1);

//Normal flow - Marcus is available.
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _Player)
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3)
AND
DB_State_Current(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom")
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour")
AND
NOT DB_CantTalk((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
QRY_SpeakerIsAvailable((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT QRY_CharacterIsHidden((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player);

//Marcus is unavailable, invisible, etc. but alive somewhere.
//Skip him for now; postpone his assault.
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _Player)
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3)
AND
DB_State_Current(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom")
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour")
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
NOT DB_Defeated((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, NULL_00000000-0000-0000-0000-000000000000, _Player);


//Isobel ignores Halsin if he is the character trying to talk to her
QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_State_Current(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom")
THEN
DB_SelectedDialog(HAV_Isobel_DismissesHalsin_64a46176-d87f-8f97-3e4c-f6ca77942b85, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);


QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _Player)
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3)
THEN
DB_SelectedDialog((DIALOGRESOURCE)HAV_Isobel_4a5bc7ea-4009-0de3-4ab7-da5bd379979e, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, NULL_00000000-0000-0000-0000-000000000000, _Player);

PROC
PROC_BlockUseOfItem(_Player, S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance")
AND
DB_Players(_Player)
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
DB_InRegion(_Player, S_HAV_IsobelRoom_SUB_4310edec-0ce2-4ac0-adbd-c02d60b92c3d)
AND
IsClosed(S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113, 1)
AND
QRY_StartDialog((DIALOGRESOURCE)HAV_TakingIsobel_FlamingSpy_18b84cde-f3e1-5119-4ce3-3ba3dd0354c5, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
DB_CustomUseItemResponse(_Player, S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113, 1);

PROC
PROC_BlockUseOfItem(_Player, S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour")
AND
DB_State_Current(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom")
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_IsobelToRoom_d1f2df3a-ba92-5599-0b19-b0d9da9c0f5c)
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelPrayerBox_db9e0476-91a4-46bb-82d7-c67a1dbe9b93, 1)
AND
DB_Players(_Player)
AND
_Player != S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323
AND
DB_InRegion(_Player, S_HAV_IsobelRoom_SUB_4310edec-0ce2-4ac0-adbd-c02d60b92c3d)
AND
IsClosed(S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113, 1)
AND
QRY_SpeakerIsAvailable(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
QRY_StartDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
DB_CustomUseItemResponse(_Player, S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113, 1);

IF
EnteredTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f)
THEN
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_State_IsobelInRoom_cff275db-2618-fac2-581e-051aca727131);

IF
LeftTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f)
THEN
PROC_GlobalClearFlagAndCache(HAV_TakingIsobel_State_IsobelInRoom_cff275db-2618-fac2-581e-051aca727131);

IF
EnteredTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f)
THEN
SetHasDialog(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 1);

IF
LeftTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f)
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelPrayerBox_db9e0476-91a4-46bb-82d7-c67a1dbe9b93, 0)
THEN
SetHasDialog(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 0);

IF
EnteredTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelPrayerBox_db9e0476-91a4-46bb-82d7-c67a1dbe9b93)
THEN
SetHasDialog(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 1);

IF
LeftTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,S_HAV_IsobelPrayerBox_db9e0476-91a4-46bb-82d7-c67a1dbe9b93)
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f, 0)
THEN
SetHasDialog(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 0);

PROC
PROC_DialogFlagSetup(HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _, _, _)
AND
NOT QRY_HAV_TakingIsobel_IsInPrayer()
THEN
ClearFlag(HAV_TakingIsobel_State_IsobelInPrayer_15a12857-854c-931a-94fe-ae3edf47edcd, NULL_00000000-0000-0000-0000-000000000000, 0);

QRY
QRY_HAV_TakingIsobel_IsInPrayer()
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_Event_IsobelToRoom_d1f2df3a-ba92-5599-0b19-b0d9da9c0f5c)
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelPrayerBox_db9e0476-91a4-46bb-82d7-c67a1dbe9b93, 1)
THEN
SetFlag(HAV_TakingIsobel_State_IsobelInPrayer_15a12857-854c-931a-94fe-ae3edf47edcd, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_HAV_TakingIsobel_CheckForMarcusInRoom()
AND
IsInTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_IsobelRoomFollowUpBox_Room_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f, 1)
AND
DB_PermaDefeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT DB_GlobalFlag(HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686) //wasn't killed at the entrance then dragged there
THEN
SetFlag(HAV_TakingIsobel_Event_SpyDefeatedInRoomOnArrival_3409e8d7-7352-491c-9d93-e15b4f2bfce6, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211); //helps Anubis to decide which state to enter initially. Anubis takes care of the rest.
TriggerRegisterForCharacter(S_HAV_DefeatedSpyReactionBox_91ff47ef-4c54-486f-b440-530373587845, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
TeleportTo(S_HAV_DefeatedSpyReactionBox_91ff47ef-4c54-486f-b440-530373587845, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);

IF
EnteredTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_DefeatedSpyReactionBox_91ff47ef-4c54-486f-b440-530373587845)
AND
IsInTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_IsobelRoomFollowUpBox_Room_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f, 1)
AND
IsInTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_DefeatedSpyReactionBox_91ff47ef-4c54-486f-b440-530373587845, 1)
THEN
TriggerUnregisterForCharacter(S_HAV_DefeatedSpyReactionBox_91ff47ef-4c54-486f-b440-530373587845, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_TryStartAD(HAV_Isobel_AD_AtSpyCorpse_18f57fc3-844a-f19b-b13c-3276b195416e, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_MarcusCorpse");

PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_MarcusCorpse", _Player)
AND
QRY_StartDialog((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
SetFlag((FLAG)HAV_TakingIsobel_Event_SpyIsDefeatedInRoom_719e4639-839b-4975-9301-75c4f3189c48, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_DialogFlagSetup(HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _Player)
THEN
PROC_SpotPlayers_StopSpotting((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_MarcusCorpse");

IF
FlagSet(HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3, NULL_00000000-0000-0000-0000-000000000000, _Inst)
AND
DB_DialogName(HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _Inst)
AND
DB_DialogPlayers(_Inst, _Player, 1)
THEN
DB_HAV_SpyCapture_PrioPlayer((CHARACTER)_Player);

//END_REGION

//REGION Spy Capture - Setup

IF
DB_HAV_TakingIsobel_Abductees(_Character, _)
THEN
DB_Inclusion_NPCDialog((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, _Character);
DB_Inclusion_Object(_Character, (FLAG)HAV_TakingIsobel_Event_IncludeAbductees_c733d143-c4f5-da26-7019-3acbf48c4f55, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_StartDialog_AddExtraSpeakers(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985,_Inst)
AND
DB_DialogRequestCache_SpeakerList_Speakers(_InclusionDialog,_Inst,_Speaker,1)
AND
QRY_OnlyOnce_Reset("HAV_TakingIsobel_IncludeAbductee1")
AND
DB_HAV_TakingIsobel_Abductees(_Abductee, _)
AND
NOT DB_OnlyOnce("HAV_TakingIsobel_IncludeAbductee1")
AND
_Abductee != S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925
AND
NOT DB_ObjectInclusion(_, _Abductee)
AND
QRY_Inclusion_SpeakerIsAvailableForInclusion(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, _Inst, _Abductee, (CHARACTER)_Speaker)
THEN
DB_OnlyOnce("HAV_TakingIsobel_IncludeAbductee1");
PROC_DialogAddSpeakingActorAt(_Inst,_Abductee, 9);
DB_ObjectInclusion(_Inst, (GUIDSTRING)_Abductee);
DB_ObjectIsDialogSoftLocked(_Inst, (GUIDSTRING)_Abductee);

PROC
PROC_StartDialog_AddExtraSpeakers(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985,_Inst)
AND
DB_DialogRequestCache_SpeakerList_Speakers(_InclusionDialog,_Inst,_Speaker,1)
AND
QRY_OnlyOnce_Reset("HAV_TakingIsobel_IncludeAbductee2")
AND
DB_HAV_TakingIsobel_Abductees(_Abductee, _)
AND
NOT DB_OnlyOnce("HAV_TakingIsobel_IncludeAbductee2")
AND
_Abductee != S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925
AND
_Abductee != S_HAV_FlamingFist_005_0e691c0a-562b-43bb-8554-cde1194decd5
AND
NOT DB_ObjectInclusion(_, _Abductee)
AND
QRY_Inclusion_SpeakerIsAvailableForInclusion(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, _Inst, _Abductee, (CHARACTER)_Speaker)
THEN
DB_OnlyOnce("HAV_TakingIsobel_IncludeAbductee2");
PROC_DialogAddSpeakingActorAt(_Inst,_Abductee, 10);
DB_ObjectInclusion(_Inst, (GUIDSTRING)_Abductee);
DB_ObjectIsDialogSoftLocked(_Inst, (GUIDSTRING)_Abductee);

PROC
PROC_StartDialog_AddExtraSpeakers(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985,_Inst)
THEN
DB_HAV_TakingIsobel_GhoulsDialogue(_Inst);
PROC_DialogAddSpeakingActorAt(_Inst, S_HAV_FlyingGhoul_000_62dd0ebd-8325-4b76-ba41-99fbee98149a, 6);
PROC_DialogAddSpeakingActorAt(_Inst, S_HAV_FlyingGhoul_001_48026cfd-acc4-42dd-a9e3-583cac5f7a34, 7);
PROC_DialogAddSpeakingActorAt(_Inst, S_HAV_FlyingGhoul_002_c43490d5-4d8c-4986-8b1e-6bcf4325cb0d, 8);

QRY
QRY_SpeakerIsAvailable(_Ghoul, _, _)
AND
DB_HAV_TakingIsobel_FlyingGhouls((CHARACTER)_Ghoul)
AND
DB_HAV_TakingIsobel_GhoulsDialogue(_Inst)
THEN
DB_NOOP(1);

IF
DialogStarted(_, _Inst)
AND
DB_HAV_TakingIsobel_GhoulsDialogue(_Inst)
THEN
NOT DB_HAV_TakingIsobel_GhoulsDialogue(_Inst);

IF
DialogRequestFailed(_, _Inst)
AND
DB_HAV_TakingIsobel_GhoulsDialogue(_Inst)
THEN
NOT DB_HAV_TakingIsobel_GhoulsDialogue(_Inst);


//--- Default: after BriefInRoom
IF
DialogEnded(HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _ID)
AND
GetFlag(HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
PROC_HAV_TakingIsobel_TryStartCapture(_ID);

IF
DialogEnded((DIALOGRESOURCE)HAV_Isobel_4a5bc7ea-4009-0de3-4ab7-da5bd379979e, _)
THEN
PROC_HAV_TakingIsobel_TryStartCapture(0);

PROC
PROC_HAV_FlamingSpy_CaptureFailedToStart()
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureReady") //If Marcus was waiting above and somehow his kidnapping was skipped, skip away.
THEN
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_FollowUp_Protection");
GoalCompleted;

PROC
PROC_HAV_FlamingSpy_CaptureFailedToStart()
AND
DB_Defeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_FollowUp_Protection");
GoalCompleted;

//--- Starting the SpyCature automatically after HAV_TakingIsobel_BriefInRoom
PROC
PROC_HAV_TakingIsobel_TryStartCapture((INTEGER)_ID)
AND
NOT QRY_HAV_TakingIsobel_FlamingSpyOutOfPosition(_ID)
AND
NOT QRY_HAV_TakingIsobel_StartWithPrio()
AND
NOT QRY_HAV_TakingIsobel_StartWithAny(_ID)
THEN
PROC_HAV_FlamingSpy_CaptureFailedToStart();

// Continuing with the same player that got the brief
QRY
QRY_HAV_TakingIsobel_StartWithPrio()
AND
DB_HAV_SpyCapture_PrioPlayer(_Player)
AND
QRY_HAV_TakingIsobel_StartSpyCapture(_Player)
THEN
DB_NOOP(1);

// Starting with another player in the room
QRY
QRY_HAV_TakingIsobel_StartWithAny((INTEGER)_ID)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_HAV_SpyPlayerInBox_edb52dcc-651b-46c5-afd0-e6f3de7beba2)
AND
NOT DB_CantTalk(_Player)
AND
NOT DB_CantMove(_Player)
AND
QRY_State_IsBeforeState(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "SpyCombat_Confrontation")
AND
QRY_HAV_TakingIsobel_StartSpyCapture((CHARACTER)_Player)
THEN
DB_NOOP(1);

QRY
QRY_HAV_TakingIsobel_FlamingSpyOutOfPosition((INTEGER)_ID)
AND
IsInTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_SpyPlayerInBox_edb52dcc-651b-46c5-afd0-e6f3de7beba2, 0)
AND
IsOnStage(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, 1)//Doesn't matter where he is if he's off-stage, hovering above
THEN
PROC_HAV_FlamingSpy_CaptureFailedToStart();

QRY
QRY_HAV_TakingIsobel_StartSpyCapture((CHARACTER)_Player)
AND
QRY_StartDialogCustom_Fixed(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 0, 0, 0, 0)	
THEN
PROC_State_IfCurrentProgress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom", "HAV_Isobel_State_Capture");
DB_SceneManager(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_IsobelMarcusScene");
DB_SceneManager(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_IsobelMarcusScene");
GoalCompleted;

IF
DialogEnded(HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _)
AND
GetFlag(HAV_TakingIsobel_Event_ContinueFromBriefInRoom_a8a061d3-2661-1910-788b-b0ba4d37d4a3, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_Defeated((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
PROC_State_IfCurrentProgress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom", "HAV_Isobel_State_FollowUp_Protection");

//If either of the guards are included, they become hostile to the players.
IF
DB_GlobalFlag((FLAG)HAV_TakingIsobel_State_SidedWithSpy_5eb745b2-5043-2f36-4d3a-ee3f09ed7a82)
AND
DB_DialogName((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, _ID)
AND
DB_DialogSpeakers(_ID, _Guard, _)
AND
DB_HAV_TakingIsobel_IsobelGuards((CHARACTER)_Guard, _)
THEN
PROC_SetRelationToPlayers((FACTION)Act2_HAV_Haven_e52bfc8c-7826-470d-a9f5-f6fae80dde82, 0);
SetFlag((FLAG)HAV_General_State_IsHostileToPlayers_3cd1e3a7-6a9a-6558-a9f2-8db69824869b, NULL_00000000-0000-0000-0000-000000000000, 0);
NOT DB_HAV_TakingIsobel_JaheiraCallsToArm(1);

//---  When this dialog is starting, the spy is still off stage
QRY
QRY_SpeakerIsAvailableForDialogSlot(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, 2, _AllowStartIfCombat, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
NOT DB_Defeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
DB_NOOP(1);

PROC
PROC_DialogFlagSetup(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (GUIDSTRING)_, _Player)
THEN
PROC_State_IfCurrentProgress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_Brief_InRoom", "HAV_Isobel_State_Capture");

QRY
QRY_SpeakerIsInDialogRange((CHARACTER)_Character, _Player)
AND
DB_HAV_TakingIsobel_Abductees(_Character, _Trigger)
AND
DB_DialogRequestCache_SpeakerList_Players((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985,_, _Player,_)
AND
IsInTrigger(_Character, _Trigger, 1)
THEN
DB_NOOP(1);

QRY
QRY_SpeakerIsInDialogRange((CHARACTER)_Character, _NPC)
AND
DB_HAV_TakingIsobel_Abductees(_Character, _Trigger)
AND
DB_DialogRequestCache_SpeakerList_NPCs((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985,_, _NPC,_)
AND
IsInTrigger(_Character, _Trigger, 1)
THEN
DB_NOOP(1);

//END_REGION

//REGION Minor polish - if the dialogue won't start because one of the participants is Silenced or otherwise unavailable, don't suggest it will in the dialogue

IF
DB_DialogSpeakers(_ID, _Character, _)
AND
DB_DialogName((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _ID)
AND
DB_CurrentMutingStatuses(_Character, _, _)
THEN
DB_HAV_TakingIsobel_MutedBriefSpeaker(_Character);
SetFlag((FLAG)HAV_TakingIsobel_State_AbductionMuted_2d7d3878-c25b-01a9-8345-396525be8884, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_HAV_TakingIsobel_MutedBriefSpeaker(_Character)
AND
NOT DB_CurrentMutingStatuses(_Character, _, _)
THEN
NOT DB_HAV_TakingIsobel_MutedBriefSpeaker(_Character);
PROC_HAV_TakingIsobel_MutedBriefSpeakerRemoved();

IF
DB_HAV_TakingIsobel_MutedBriefSpeaker(_Character)
AND
DB_DialogName((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _ID)
AND
NOT DB_DialogSpeakers(_ID, _Character, _)
THEN
NOT DB_HAV_TakingIsobel_MutedBriefSpeaker(_Character);
PROC_HAV_TakingIsobel_MutedBriefSpeakerRemoved();

IF
DB_HAV_TakingIsobel_MutedBriefSpeaker(_Character)
AND
NOT DB_DialogName((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _)
THEN
NOT DB_HAV_TakingIsobel_MutedBriefSpeaker(_Character);
PROC_HAV_TakingIsobel_MutedBriefSpeakerRemoved();

PROC
PROC_HAV_TakingIsobel_MutedBriefSpeakerRemoved()
AND
NOT DB_HAV_TakingIsobel_MutedBriefSpeaker(_)
THEN
ClearFlag((FLAG)HAV_TakingIsobel_State_AbductionMuted_2d7d3878-c25b-01a9-8345-396525be8884, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION Isobels Death


PROC
PROC_StateSet_Defeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211) //TODO: check when she becomes defeated
THEN
GoalCompleted;


//END_REGION

PROC
PROC_SCE_SetupDebrief()
THEN
RemoveStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_ISOBEL_MOONRITUAL", NULL_00000000-0000-0000-0000-000000000000);
GoalCompleted;
 
IF
FlagSet(HAV_TakingIsobel_Event_FastTransform_00abbf3d-060d-4b7c-a6ee-23cbfd5928fe, _, _ID)
AND
NOT DB_DialogName((DIALOGRESOURCE)HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5, _ID) //If the flag is set outside of the dialogue, most likely in combat, continue to the next step.
THEN
SetFlag(HAV_TakingIsobel_Event_IsobelToRoom_d1f2df3a-ba92-5599-0b19-b0d9da9c0f5c, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
TextEvent("SCE_SetupNightsong_MoveToCamp")
THEN
GoalCompleted;

IF
DB_GlobalFlag(MOO_Assault_State_InProgress_0f3a8f5d-7402-4220-bebb-d4b21d3db08d) //Check on DB_GlobalFlag here to be entirely sure it's set down the line
THEN
RemoveStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_ISOBEL_MOONRITUAL", NULL_00000000-0000-0000-0000-000000000000);
GoalCompleted;

IF
DialogStarted(HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, _ID)
THEN
GoalCompleted;
PROC_HAV_TakingIsobel_SpyCaptureStarted(_ID);
EXITSECTION
TriggerUnregisterForCharacter(S_HAV_DefeatedSpyReactionBox_91ff47ef-4c54-486f-b440-530373587845, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_RemoveNPCADs((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);

PROC_SpotPlayers_StopSpotting((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_MarcusCorpse");
NOT DB_SpotPlayers((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_MarcusCorpse", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SpotPlayers_SpotTrigger((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_MarcusCorpse", S_HAV_IsobelRoomFollowUpBox_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f);
ENDEXITSECTION
ParentTargetEdge "Act2"
