Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_AD_Dialog(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, HAV_TakingIsobel_AD_SpyAtEntrance_486995ca-2cee-35a8-0dc0-72922463fd33);
DB_GLO_CharacterCorpseDialog(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, (DIALOGRESOURCE)HAV_TakingIsobel_FlamingSpy_Dead_5736f474-6ded-5c0d-fe07-39eff92dc122);

SetOnStage(S_HAV_SpyGrave_PLACEHOLDER_97709367-aaf3-495e-864d-2ca56937308d, 0);

//--- States
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_ReadyForCheckpoint");
SetFlag(HAV_TakingIsobel_State_FlamingSpyAtCheckpoint_2380bfb0-52e9-4e39-acb6-5be67cd2318a);

DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_ReadyForCheckpoint", 0);
	DB_State_Flags(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_ReadyForCheckpoint", HAV_TakingIsobel_State_FlamingSpyAtCheckpoint_2380bfb0-52e9-4e39-acb6-5be67cd2318a);
DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_WatchingAtCheckpoint", 250);
	DB_State_Flags(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_WatchingAtCheckpoint", HAV_TakingIsobel_State_FlamingSpyAtCheckpoint_2380bfb0-52e9-4e39-acb6-5be67cd2318a);
DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_LeavingCheckpoint", 500);
DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance", 600);
DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour", 1000); //Waiting in Isobel's chambers.
DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureReady", 2000); //Waiting on the roof.
	DB_State_Flags(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureReady", HAV_TakingIsobel_State_SpyIsInCaptureScene_e168701f-1a6d-492b-933c-bcd12c04054d);
DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureStarted", 3000); //In combat, trying to capture Isobel.
	DB_State_Flags(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureStarted", HAV_TakingIsobel_State_SpyIsInCaptureScene_e168701f-1a6d-492b-933c-bcd12c04054d);
DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_AtMoonrise", 4000);
DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_Defeated", 9000);

DB_DeadOnceFlag(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, HAV_TakingIsobel_State_SpyIsDead_5377ad88-9ba1-461c-919f-a4ccfc75c8a7);

DB_HAV_FlamingSpyTransform_Harpers((CHARACTER)S_HAV_HavenOutcasts_BarricadeGuards_Melee_Dwarf_b1d8b327-1f27-4921-aa2b-dd18a9d67fc8);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_EntranceGuards_Halfling_Melee_c8bc8f03-c91c-42d4-829c-d16bb1df4a67);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_HarperQuartermaster_f769815c-d437-4a45-9ae4-aebd53ec8f7c);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_DockGuard_Left_Ranger_3a856945-e4a5-4214-89af-84a2b50789d8);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_DockGuard_Ranger_a0f9d7cb-d87c-4af8-87fa-d273a8ecba93);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_EntranceGuards_Caster_HighElf_825714dd-7df9-4cd1-aecb-edf577baa487);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_DockGuard_Left_Melee_bd46130e-1c2c-4888-9e9c-6dd58965ab4f);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_BarricadeRunners_Ranger_572690b6-68f5-4e7b-807b-b9376b658b65);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_BarricadeYeller_Ranger_b612ef5f-3381-4486-8959-84dd399fb1ae);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HavenOutcasts_DockGuard_Melee_f1f837ad-8e6a-442d-bba4-46f665c47675);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_HarperGuard_002_34a9bfd8-1ca2-4a1c-b72e-2bf1cfc046a4);
DB_HAV_FlamingSpyTransform_Harpers(S_SCL_HarperScout_000_c6dfb2aa-809f-4b3e-8b32-968c10184ec3);
DB_HAV_FlamingSpyTransform_Harpers(S_SCL_HarperScout_001_25e154f6-d762-4bea-862e-98c48d7ebe3e);
DB_HAV_FlamingSpyTransform_Harpers(S_SCL_HarperScout_003_9bebec18-ca66-42e9-abce-8d6a5f9d2a1b);
DB_HAV_FlamingSpyTransform_Harpers(S_SCL_HarperScout_002_a0fecf82-7dde-4dd7-af67-eb0ef5aa67e0);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_FlamingFist_001_47058367-9c0c-4756-a467-07b87b28e0d6);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_FlamingFist_002_39ace2b4-699d-468c-a664-8a06492d997a);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_FlamingFist_003_128c0f54-fea0-49df-89ca-c2ca8d996a31);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_FlamingFist_005_0e691c0a-562b-43bb-8554-cde1194decd5);
DB_HAV_FlamingSpyTransform_Harpers(S_HAV_FlamingFist_006_9629c27e-8e50-4258-8bda-6639af768ba6);

DB_QRYRTN_HAV_FlamingSpy_TransformDialogWatcher(NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Isobel", NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", NULL_00000000-0000-0000-0000-000000000000);

Equip(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_FlamingSpy_Armour_cbfe8de8-14b1-4cd9-8c7e-e59d91b74418);

TriggerRegisterForCharacter(S_HAV_IsobelRoomFollowUpBox_Balcony_ea450666-303d-4cde-b1f6-162fdc423064, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
TriggerRegisterForPlayers(S_HAV_EnteringHaven_CombatAddChecker_b053df36-f455-48c7-98fa-03d19839af21);

DB_DefeatedStateFlag(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, HAV_TakingIsobel_State_SpyIsDefeated_863bc783-83ad-4102-b0ee-b5b70b136047);
DB_PermaDefeatedFlag(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, (FLAG)HAV_TakingIsobel_State_SpyIsPermaDefeated_28387342-a79a-4684-aca9-d71237925347);

DB_GlobalFlagReactionAfterDialog(HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686, HAV_EnteringHaven_TadpoleCheckpoint_e51408cc-4f7a-5a5f-52e8-caf1359c1d6c);
KBSECTION
//REGION Spy - leaving checkpoint


IF
DB_GlobalFlag((FLAG)HAV_EnteringHaven_State_GainedAccess_07c776da-353a-9050-e9be-c42d51a99412)
AND
NOT DB_GlobalFlag((FLAG)HAV_EnteringHaven_State_FlamingSpyVouch_f3850740-f19b-44c0-a018-00fa00e87b31)
AND
NOT DB_DialogNPCs(_, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _)
AND
NOT DB_Is_InCombat(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _)
AND
QRY_State_IsBeforeState(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_AtMoonrise")
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_CaptureReady");
PROC_HAV_TakingIsobel_SpyTransform();

// If the spy vouched for the player, he leaves the area immediately after the dialog HAV_EnteringHaven_TadpoleCheckpoint
// If he didn't, he stays nearby for a moment, giving the opportunity to the player to maybe notice him. Justification: Spy is watching the player, he was listening to the dialog.
PROC
PROC_HAV_EnteringHaven_Admitted()
AND
NOT QRY_HAV_FlamingSpy_StickAround()
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_LeavingCheckpoint");

QRY
QRY_HAV_FlamingSpy_StickAround()
AND
NOT DB_GlobalFlag(HAV_EnteringHaven_FlamingSpyVouch_f3850740-f19b-44c0-a018-00fa00e87b31)
AND
IsInTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_SpyMoveStartSphere_48316407-1389-41b7-aecb-b8db5935489c, 1)
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_WatchingAtCheckpoint");

PROC
PROC_State_Changed(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_ReadyForCheckpoint", (STRING)_)
THEN
SetFlag(HAV_TakingIsobel_State_FlamingSpyIsWatching_5479f9ca-f04c-4f32-af8c-e0c2a01bda9d);
PROC_TriggerRegisterForPlayers(S_HAV_SpyMoveStartSphere_48316407-1389-41b7-aecb-b8db5935489c);

IF
EnteredTrigger(_, S_HAV_SpyMoveStartSphere_48316407-1389-41b7-aecb-b8db5935489c)
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_LeavingCheckpoint");

IF
FlagCleared(HAV_TakingIsobel_State_FlamingSpyIsWatching_5479f9ca-f04c-4f32-af8c-e0c2a01bda9d, NULL_00000000-0000-0000-0000-000000000000, _) //Anubis clears it if anything interrupts the spy's action
AND
DB_GlobalFlag(HAV_TakingIsobel_State_FlamingSpyIsWatching_5479f9ca-f04c-4f32-af8c-e0c2a01bda9d)
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_LeavingCheckpoint");

PROC
PROC_State_Changed(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", (STRING)_, (STRING)_) //progressed beyond AtCheckpoint / StickingAtCheckpoint
AND
NOT QRY_State_IsBeforeState(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_LeavingCheckpoint")
THEN
PROC_RemoveNPCADs(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
PROC_TriggerUnregisterForPlayers(S_HAV_SpyMoveStartSphere_48316407-1389-41b7-aecb-b8db5935489c);
ClearFlag(HAV_TakingIsobel_State_FlamingSpyIsWatching_5479f9ca-f04c-4f32-af8c-e0c2a01bda9d);

PROC
PROC_State_Changed(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance")
THEN
DB_SpotPlayers(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy_Greeting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy_Greeting", S_HAV_TakingIsobel_SpyGreetingBox_dbcb8a05-18e7-4b53-b063-0402c8ca281c);
DB_SpotPlayers_Continuous(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy_Greeting");

IF
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_LeavingCheckpoint")
AND
NOT DB_CantAct(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
PROC_CharacterMoveTo(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_SpyInPoint_546e38ea-db44-4b12-bbb7-d486dca08124, "Walk", "HAV_FlamingSpy_ArrivedAtRoom");

IF
EntityEvent(_FlamingSpy,"HAV_FlamingSpy_ArrivedAtRoom")
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance");
PROC_RemoveAllDialogEntriesForSpeaker(_FlamingSpy);
SetHasDialog(_FlamingSpy, 1);
DB_DontCreateMurder((CHARACTER)_FlamingSpy);

IF
FlagSet(HAV_TakingIsobel_Knows_SpyExplainedHisMission_db491c69-6de0-5958-1f0d-98a6073e94d7, _, _)
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour");

PROC
PROC_State_Changed(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour")
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
SetHasDialog(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, 1);


PROC
PROC_HAV_TakingIsobel_SetSpyOnStage((INTEGER)_Bool1)
THEN
SetOnStage(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Bool1);


//END_REGION

//REGION Marcus transforms if attacked.
IF
TurnStarted(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
DB_Is_InCombat(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Combat)
AND
NOT DB_CantMove(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT DB_Is_EngineBlock_Act(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT DB_CantTalk_IgnoreCombat(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance")
AND
NOT QRY_HAV_FlamingSpy_TransformDialog(_Combat)
THEN
DB_NOOP(1);
//PROC_HAV_TakingIsobel_SpyTransform();

IF
TurnStarted(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
DB_Is_InCombat(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Combat)
AND
NOT DB_CantMove(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT DB_Is_EngineBlock_Act(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT DB_CantTalk_IgnoreCombat(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour")
AND
NOT QRY_HAV_FlamingSpy_TransformDialog(_Combat)
THEN
DB_NOOP(1);
//PROC_HAV_TakingIsobel_SpyTransform();

PROC
PROC_HAV_TakingIsobel_SpyTransform()
AND
QRY_OnlyOnce("HAV_TakingIsobel_MarcusTransforms")
THEN
ClearFlag((FLAG)HAV_Jaheira_State_DiscussMarcus_d43d141a-bda9-c1f2-6dce-e22ca308026c);
ApplyStatus(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FLAMINGSPYDISGUISE", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
AddSpell((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"Target_HAV_TakingIsobel_SearingSmite_Marcus",0,0);
AddSpell((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"Projectile_HAV_TakingIsobel_Fly_Marcus",0,0);
//AddSpell((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"Shout_HAV_FlamingSpy_VampiricShout",0,0); //now given to Marcus via polymorph template; this will include difficulty condition

PROC
PROC_HAV_TakingIsobel_SpyTransform()
AND
DB_GlobalFlag((FLAG)HAV_General_State_IsHostileToPlayers_3cd1e3a7-6a9a-6558-a9f2-8db69824869b)
THEN
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_State_SidedWithSpy_5eb745b2-5043-2f36-4d3a-ee3f09ed7a82);

PROC
PROC_HAV_TakingIsobel_SpyTransform()
AND
NOT DB_GlobalFlag(HAV_TakingIsobel_State_SidedWithSpy_5eb745b2-5043-2f36-4d3a-ee3f09ed7a82)
THEN
SetFaction(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, (FACTION)Act2_HAV_FlamingSpy_Hostile_caa2c8a9-67d2-479b-91ad-f460e66cfd9b);

PROC
PROC_HAV_TakingIsobel_SpyTransform()
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance")
THEN
SetFlag(HAV_TakingIsobel_State_SpyConfrontationStarted_44c18469-4650-4941-bf5f-9fe1f01df6e0);
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_CaptureStarted");

PROC
PROC_HAV_TakingIsobel_SpyTransform()
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour")
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_CaptureStarted");

PROC
PROC_HAV_TakingIsobel_SpyTransform()
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureStarted")
THEN
SetFlag(HAV_TakingIsobel_State_SpyConfrontationStarted_44c18469-4650-4941-bf5f-9fe1f01df6e0);

QRY
QRY_CorpseLooting_BlockMakeOwned(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
DB_GlobalFlag(HAV_TakingIsobel_State_SpyConfrontationStarted_44c18469-4650-4941-bf5f-9fe1f01df6e0)
THEN
DebugText(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "Marcus is lootable");
DB_NOOP(1);

IF
BaseFactionChanged(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _, Act2_HAV_FlamingSpy_Hostile_caa2c8a9-67d2-479b-91ad-f460e66cfd9b)
AND
DB_Is_InCombat((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _ID)
AND
DB_Is_InCombat(_Character, _ID)
AND
NOT DB_PartyMembers((CHARACTER)_Character)
AND
IsAlly(_Character, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, 0)
THEN
LeaveCombat(_Character);

PROC
PROC_HAV_TakingIsobel_SpyTransform()
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureStarted")
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Isobel", (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
Use(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113, 1, 0, "");

QRY
QRY_HAV_FlamingSpy_TransformDialog((GUIDSTRING)_Combat)
AND
QRY_HAV_FlamingSpy_TransformDialogWatchers((GUIDSTRING)_Combat)
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogWatcher(_Speaker1)
AND
_Speaker1 != NULL_00000000-0000-0000-0000-000000000000 //You do need at least one party member.
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Isobel", _Isobel)
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", _Harper1)
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)HAV_TakingIsobel_SpyCapture_1b698557-76c0-1166-6415-91fadb358985, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Speaker1, _Isobel, _Harper1, 0, 0, 0, 0)
THEN
PROC_GlobalSetFlagAndCache(HAV_TakingIsobel_Event_FastTransform_00abbf3d-060d-4b7c-a6ee-23cbfd5928fe);
PROC_HAV_TakingIsobel_SpyTransform();

QRY
QRY_HAV_FlamingSpy_TransformDialogWatchers((GUIDSTRING)_Combat)
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogWatcher(_Speaker)
AND
_Speaker != NULL_00000000-0000-0000-0000-000000000000
THEN
NOT DB_QRYRTN_HAV_FlamingSpy_TransformDialogWatcher(_Speaker);
DB_QRYRTN_HAV_FlamingSpy_TransformDialogWatcher(NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_HAV_FlamingSpy_TransformDialogWatchers((GUIDSTRING)_Combat)
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs(_ID, _Speaker)
AND
_Speaker != NULL_00000000-0000-0000-0000-000000000000
THEN
NOT DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs(_ID, _Speaker);
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs(_ID, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_HAV_FlamingSpy_TransformDialogWatchers(_Combat)
AND
DB_Is_InCombat(_Player, _Combat)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_CantTalk_IgnoreCombat(_Player)
THEN
PROC_HAV_FlamingSpy_NextTransformDialogWatcher(_Player);

QRY
QRY_HAV_FlamingSpy_TransformDialogWatchers(_Combat)
AND
DB_Is_InCombat(_Character, _Combat)
AND
NOT DB_Players((CHARACTER)_Character)
AND
DB_PartyMembers(_Character)
AND
NOT DB_CantTalk_IgnoreCombat(_Character)
THEN
PROC_HAV_FlamingSpy_NextTransformDialogWatcher(_Character);

PROC
PROC_HAV_FlamingSpy_NextTransformDialogWatcher((GUIDSTRING)_Player)
AND
QRY_OnlyOnce_Reset("HAV_FlamingSpy_NextTransformDialogWatcher")
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogWatcher(NULL_00000000-0000-0000-0000-000000000000)
AND
QRY_OnlyOnce("HAV_FlamingSpy_NextTransformDialogWatcher")
THEN
NOT DB_QRYRTN_HAV_FlamingSpy_TransformDialogWatcher(NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAV_FlamingSpy_TransformDialogWatcher(_Player);

QRY
QRY_HAV_FlamingSpy_TransformDialogWatchers(_Combat)
AND
NOT DB_CantTalk((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
AND
IsInTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_IsobelRoomFollowUpBox_Room_1ddc9945-3187-4eee-a2f3-8e2c06e5c06f, 1)
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_HAV_IsobelPrayerBox_db9e0476-91a4-46bb-82d7-c67a1dbe9b93, 1)
AND
NOT DB_Destroyed(S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113)
AND
IsClosed(S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113, 1)
THEN
NOT DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Isobel", NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Isobel", (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);

QRY
QRY_HAV_FlamingSpy_TransformDialogWatchers(_Combat)
AND
DB_HAV_TakingIsobel_IsobelGuards(_Guard, _)
AND
DB_Is_InCombat(_Guard, _Combat)
AND
NOT DB_CantTalk_IgnoreCombat(_Guard)
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", _Guard);


QRY
QRY_HAV_FlamingSpy_TransformDialogWatchers(_Combat)
AND
DB_HAV_FlamingSpyTransform_Harpers(_Guard)
AND
DB_Is_InCombat(_Guard, _Combat)
AND
NOT DB_CantTalk_IgnoreCombat(_Guard)
AND
QRY_HAV_FlamingSpy_IsCloserTransformHarper(_Guard)
THEN
NOT DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", NULL_00000000-0000-0000-0000-000000000000);
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", _Guard);

QRY
QRY_HAV_FlamingSpy_IsCloserTransformHarper((CHARACTER)_Guard)
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", NULL_00000000-0000-0000-0000-000000000000)
THEN
DB_NOOP(1);

QRY
QRY_HAV_FlamingSpy_IsCloserTransformHarper((CHARACTER)_Guard)
AND
DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", _OldGuard)
AND
NOT DB_HAV_TakingIsobel_IsobelGuards((CHARACTER)_OldGuard, _)
AND
GetDistanceTo(_Guard, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Dist)
AND
GetDistanceTo(_OldGuard, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _OldDist)
AND
_Dist < _OldDist
THEN
NOT DB_QRYRTN_HAV_FlamingSpy_TransformDialogNPCs("Harper", _OldGuard);

//END_REGION


//REGION Start dialogue on sight

PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy_Greeting", _Player)
AND
QRY_StartDialog((DIALOGRESOURCE)HAV_TakingIsobel_FlamingSpy_18b84cde-f3e1-5119-4ce3-3ba3dd0354c5, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
DB_NOOP(1);

PROC
PROC_DialogFlagSetup((DIALOGRESOURCE)HAV_TakingIsobel_FlamingSpy_18b84cde-f3e1-5119-4ce3-3ba3dd0354c5, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
PROC_SpotPlayers_StopSpotting((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy_Greeting");

PROC
PROC_BlockUseOfItem(_Player, S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113)
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_Knows_SpyExplainedHisMission_db491c69-6de0-5958-1f0d-98a6073e94d7)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_DefaultBehaviour")
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_HAV_IsobelRoom_SUB_4310edec-0ce2-4ac0-adbd-c02d60b92c3d)
AND
CanSee(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player, 1)
AND
QRY_StartDialog((DIALOGRESOURCE)HAV_TakingIsobel_FlamingSpy_18b84cde-f3e1-5119-4ce3-3ba3dd0354c5, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _Player)
THEN
DB_CustomUseItemResponse(_Player, S_HAV_IsobelBalconyDoor_33b6ec88-e2ed-4074-af35-76aaaf66f113, 0);


//END_REGION

//REGION Marcus leaves the room during Isobel's dialogue.

IF
FlagSet((FLAG)HAV_TakingIsobel_Event_MarcusToBalcony_8a9169b8-3a23-b89e-4565-5fcbfc00a3c4, _, _)
AND
IsMovementBlocked((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, 0)
THEN
CharacterMoveTo((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_SCL_TakingIsobel_MarcusBalconyPoint_2c2bf15b-8db4-47bb-b2d8-06250715cea6, "Stroll", "");

IF
FlagCleared((FLAG)HAV_TakingIsobel_Event_MarcusToBalcony_8a9169b8-3a23-b89e-4565-5fcbfc00a3c4, _, _)
AND
IsMovementBlocked((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, 0)
THEN
CharacterMoveTo((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,S_HAV_SpyInPoint2_62a04762-0f65-46e5-8080-dc4e5d34e237, "Sprint", "");

IF
EnteredTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_IsobelRoomFollowUpBox_Balcony_ea450666-303d-4cde-b1f6-162fdc423064)
THEN
SetFlag((FLAG)HAV_TakingIsobel_State_FlamingSpyOnBalcony_e9daa24c-18ea-b641-9d9b-6c1caede5cb4, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
LeftTrigger(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_HAV_IsobelRoomFollowUpBox_Balcony_ea450666-303d-4cde-b1f6-162fdc423064)
THEN
ClearFlag((FLAG)HAV_TakingIsobel_State_FlamingSpyOnBalcony_e9daa24c-18ea-b641-9d9b-6c1caede5cb4, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION Marcus Checkpoint Scene extra logic
/*
IF
DB_GlobalFlag((FLAG)GOB_Checkpoint_State_GainedAccess_46279ae3-9662-01b0-25a5-a46e1b80d057)
AND
NOT DB_GlobalFlag((FLAG)HAV_EnteringHaven_State_FlamingSpyVouch_f3850740-f19b-44c0-a018-00fa00e87b31)
AND
DB_DialogNPCs(_Id, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _)
AND
DialogRemoveActorFromDialog(_Id,S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,1)
THEN
DB_NOOP(1);

IF
DialogActorLeft(HAV_EnteringHaven_TadpoleCheckpoint_e51408cc-4f7a-5a5f-52e8-caf1359c1d6c,_,S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,_)
AND
DB_GlobalFlag(HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686)
THEN
PROC_HAV_TakingIsobel_SpyTransform();
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_CaptureReady");*/

IF
FlagSet((FLAG)HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686, _, _)
THEN
PROC_HAV_TakingIsobel_SpyTransform();

IF
DialogEnded(HAV_EnteringHaven_TadpoleCheckpoint_e51408cc-4f7a-5a5f-52e8-caf1359c1d6c, _ID)
AND
DB_GlobalFlag(HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686)
AND
DB_DialogPlayers(_ID, _Player, _)
THEN
EnterCombat(_Player, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);

//We need a catch all for nearby players too
PROC
PROC_GlobalFlagReactionAfterDialog(HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686)
AND
DB_GlobalFlag(HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_HAV_EnteringHaven_CombatAddChecker_b053df36-f455-48c7-98fa-03d19839af21)
THEN
EnterCombat(_Player, S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);

IF
DB_Is_InCombat(_Character, _ID)
AND
DB_GlobalFlag(HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686)
AND
NOT DB_GlobalFlag(HAV_EnteringHaven_Event_FlamingSpyFlyAway_ca13e310-a7dc-4faa-b409-5e23a9ca54ac)
AND
DB_Is_InCombat(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _ID)
AND
_Character != S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6
AND
NOT DB_HAV_EnteringHaven_Claws((CHARACTER)_Character)
THEN
PROC_MakeSurprised(_Character, 1, 1);

IF
CastedSpell(_FlamingSpy, "Shout_HAV_FlamingSpy_SummonHands", _, _, _)
AND
GetPosition(_FlamingSpy,_X,_Y,_Z)
THEN
PlayEffectAtPosition(EFFECTRESOURCEGUID_VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416,_X,_Y,_Z);
ObjectTimerLaunch(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpyFlyAway", 100, 0);

IF
ObjectTimerFinished(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpyFlyAway")
THEN
SetOnStage(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, 0);
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_Event_FlamingSpyFlyAway_ca13e310-a7dc-4faa-b409-5e23a9ca54ac);
ClearTag(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, (TAG)ACT2_HAV_SUMMONREADY_816cea1e-49c5-431f-85ff-521cc8571df8);

IF
FlagSet(HAV_EnteringHaven_Event_FlamingSpyFlyAway_ca13e310-a7dc-4faa-b409-5e23a9ca54ac, _, _)
THEN
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,"HAV_FlamingSpy", "Spy_CaptureReady");

//END_REGION

//REGION Marcus Entering Haven Combat Logic
IF
DB_HAV_EnteringHaven_Claws(_Claw)
THEN
SetOnStage(_Claw, 0);

QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)_Claw)
AND
DB_HAV_EnteringHaven_Claws(_Claw)
THEN
DB_NOOP(1);

IF
CastedSpell(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "Shout_HAV_FlamingSpy_SummonHands", _, _, _)
AND
DB_HAV_EnteringHaven_Claws(_Claw)
THEN
DB_HAV_EnteringHaven_ClawsActive(1);
PROC_Appear(_Claw);
DB_GLO_DefeatCounter(_Claw, "HAV_EnteringHaven_ClawsDefeated");

PROC
PROC_LongRest()
AND
DB_HAV_EnteringHaven_ClawsActive(1)
THEN
DB_ExecuteInLevel("HAV_EnteringHaven_KillClaws","SCL_Main_A");

PROC
PROC_ExecuteInLevel("HAV_EnteringHaven_KillClaws","SCL_Main_A")
AND
DB_HAV_EnteringHaven_Claws(_Claw)
THEN
Die(_Claw, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 0.0);

PROC
PROC_ExecuteInLevel("HAV_EnteringHaven_KillClaws","SCL_Main_A")
AND
DB_HAV_EnteringHaven_ClawsActive(1)
THEN
SetFlag(HAV_EnteringHaven_State_ClawsKilledLongAgo_b26a5215-ac49-4755-bd58-1aac44595a64, NULL_00000000-0000-0000-0000-000000000000, 0);


PROC 
PROC_GLO_DefeatCounter_AllPermaDefeated("HAV_EnteringHaven_ClawsDefeated")
THEN
NOT DB_HAV_EnteringHaven_ClawsActive(1);
PROC_GlobalSetFlagAndCache(HAV_EnteringHaven_Event_ClawsKilled_d3669128-2cb3-49be-8245-59cedfdc38ef);
TimerLaunch("HAV_EnteringHaven_ClawDefeatedLongAgo", 60000);

IF
TimerFinished("HAV_EnteringHaven_ClawDefeatedLongAgo")
THEN
SetFlag(HAV_EnteringHaven_State_ClawsKilledLongAgo_b26a5215-ac49-4755-bd58-1aac44595a64, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_Is_InCombat(_Character, _Combat)
AND
DB_PartyMembers((CHARACTER)_Character)
AND
DB_Is_InCombat(_Claw, _Combat)
AND
DB_HAV_Enteringhaven_Claws((CHARACTER)_Claw)
THEN
DB_CharacterCrimeDisabled(_Character, "HAV_EnteringHaven_ForbiddenArea");

//When the character leaves the combat, they can be reacted to again.
//Even if all the claws are dead, reacting to them as trespassing isn't really helpful.
IF
LeftCombat(_Player, _CombatGuid)
AND
DB_CharacterCrimeDisabled((CHARACTER)_Player, "HAV_EnteringHaven_ForbiddenArea")
THEN
NOT DB_CharacterCrimeDisabled(_Player, "HAV_EnteringHaven_ForbiddenArea");


//END_REGION

PROC
PROC_StateSet_Defeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
CanSee((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, 1)
AND
DB_State_Current(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureStarted")
AND
QRY_OnlyOnce("HAV_Isobel_AD_MarcusDefeated")
THEN
PROC_TryStartAD(HAV_Isobel_AD_MarcusDefeated_4f8cd9cb-d052-68cd-0063-e26c03dc34cb, (CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);

// Flaming Fist defeated
PROC
PROC_StateSet_PermaDefeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
SetFlag(HAV_TakingIsobel_State_SpyIsDefeated_863bc783-83ad-4102-b0ee-b5b70b136047);
PROC_State_Progress(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_Defeated");
GoalCompleted;
EXITSECTION
NOT DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_ReadyForCheckpoint", 0);
NOT DB_State_Flags(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_ReadyForCheckpoint", HAV_TakingIsobel_State_FlamingSpyAtCheckpoint_2380bfb0-52e9-4e39-acb6-5be67cd2318a);
NOT DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_WatchingAtCheckpoint", 250);
NOT DB_State_Flags(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_WatchingAtCheckpoint", HAV_TakingIsobel_State_FlamingSpyAtCheckpoint_2380bfb0-52e9-4e39-acb6-5be67cd2318a);
NOT DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_LeavingCheckpoint", 500);
NOT DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_IsobelRoomEntrance", 600);
NOT DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_DefaultBehaviour", 1000); //Waiting in Isobel's chambers.
NOT DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureReady", 2000); //Waiting on the roof.
NOT DB_State_Flags(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureReady", HAV_TakingIsobel_State_SpyIsInCaptureScene_e168701f-1a6d-492b-933c-bcd12c04054d);
NOT DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureStarted", 3000); //In combat, trying to capture Isobel.
NOT DB_State_Flags(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_CaptureStarted", HAV_TakingIsobel_State_SpyIsInCaptureScene_e168701f-1a6d-492b-933c-bcd12c04054d);
NOT DB_State_Priority(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FlamingSpy", "Spy_AtMoonrise", 4000);

NOT DB_HAV_TakingIsobel_IsobelGuards((CHARACTER)S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f, (TRIGGER)S_HAV_IsobelGuardPoint2_4bd40020-5d87-4e0f-b551-ddbfb1f369f7);
NOT DB_HAV_TakingIsobel_IsobelGuards(S_HAV_HarperGuard_002_34a9bfd8-1ca2-4a1c-b72e-2bf1cfc046a4, S_HAV_IsobelGuardPoint_a0ff52f4-53b9-48dd-ad67-4326a65bd939);


DB_HAV_FlamingSpy_TryToKill(1);

TriggerUnregisterForCharacter(S_HAV_IsobelRoomFollowUpBox_Balcony_ea450666-303d-4cde-b1f6-162fdc423064, (CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6);
ENDEXITSECTION
ParentTargetEdge "Act2"
