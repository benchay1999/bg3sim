Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_OneShotPartyTrigger(S_ORI_Gale_LastNightAliveTrigger_943e6455-3aaa-4804-9fcf-24059ffa603f);

SetOnStage(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, 0);
PROC_LoopEffect(VFX_Script_Gameplay_Gale_DeathVoice_01_7e9d37d9-a03e-fe8c-d997-d3fe9b26302c, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, "ORI_Gale_DoubleOverlay", "SCL_Main_A", "");
DB_Dialogs(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, (DIALOGRESOURCE)CAMP_GaleDouble2_5aa5ccd5-6624-3660-d814-e5f8d569708b);
SetOnStage(S_ORI_Gale_LastNightAlive_GaleDouble_244735bd-a5e6-4e70-b6e6-becbf70a54b8, 0);
SetOnStage(S_ORI_Gale_LastNightAlive_GaleDouble2_1b5e6e47-03bc-41b6-91e9-dbe6ba86ffe8, 0);
SetOnStage(S_ORI_Gale_LastNightAlive_GaleDouble3_f6fb700a-5086-404c-ba15-7cf16642fc22, 0);
SetOnStage(S_ORI_Gale_LastNightAlive_AvatarDouble_1cedd0c1-6bfe-4f32-a1e7-78b0acf209a9, 0);
SetOnStage(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, 0); 

DB_OriginCampFlags((CHARACTER)S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000, (FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_ORI_OriginCampData((CHARACTER)S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349,"SCLMAIN", (TRIGGER)S_CAMP_Gale_cd090f6d-20b7-8d2e-1bc5-7cc7fbf04c0d);
DB_ORI_OriginCampData((CHARACTER)S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349,"SHARTEMPLE", (TRIGGER)S_CMP_Gale_A_4413321d-33af-8e54-0ae2-523abab343cf);
DB_ORI_OriginCampData((CHARACTER)S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349,"MOONRISE", (TRIGGER)S_CMP_Gale_A_78fdad04-c5bb-8ef2-3904-ded057036f00);
DB_ORI_OriginCampData((CHARACTER)S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349,"HAVEN", (TRIGGER)S_CAMP_GALE_44bf9701-c872-8b5c-3c44-be9d626d46a2);
SetTag(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, (TAG)BLOCK_PICKPOCKET_fe2e65d3-a8de-45bf-a372-c339adec669e);

PROC_ORI_Gale_Act2Setup();

DB_ORI_GaleDouble2Trigger("SCLMAIN", (TRIGGER)S_ORI_GaleDouble2_Box_bbdd28aa-8fbf-802a-1eda-146fa2b25f29);
DB_ORI_GaleDouble2Trigger("SHARTEMPLE", S_ORI_GaleDouble2_Box_32e75b5a-92a7-8150-0df7-fad2617556eb);
DB_ORI_GaleDouble2Trigger("MOONRISE", S_ORI_GaleDouble2_Box_00409ba1-873a-4eef-87fa-9ca501370067);
DB_ORI_GaleDouble2Trigger("HAVEN", S_ORI_GaleDouble2_Box_3283b04e-277a-8e58-3f59-5635192f59ce);

DB_TopicalGreeting((FLAG)TG_ORI_Gale_ConsumedTWNBoss_e65c5df2-9ff6-4e46-b0c0-f421e9fce6c9);
DB_TopicalGreeting((FLAG)TG_ORI_GaleBlessedByMystra_f3f75c10-e497-4819-8fd5-a2a3b3800525);
DB_TopicalGreeting((FLAG)TG_ORI_Gale_CraftedDarkLantern_e59b3e35-10f1-4d16-9d03-d495a6049c3e);

DB_ORI_Gale_LanternIngredients("Pixie", DEC_Necromancer_Dead_Pixie_A_001_49cc3b4a-171a-42e1-a9e3-edaca53c8e5c);
DB_ORI_Gale_LanternIngredients("Pixie", DEC_Necromancer_Dead_Pixie_Bowl_A_001_25389689-3ea3-4e33-b05c-f49a15241522);
DB_ORI_Gale_LanternIngredients("Lantern", UNI_UND_Moonlantern_Broken_0b42df9e-2ded-41bd-84a6-503573936d95);
DB_ORI_Gale_LanternIngredients("Lantern", UNI_UND_Moonlantern_Broken_12a0f78a-8029-4c67-9965-f863fd20fda5);

DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df);
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);
KBSECTION
//REGION Gale romance scene in Last Night

PROC
PROC_CampNight_StartSelected()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
THEN
NOT DB_OnlyOnce("ORI_Gale_RejoinDuringLastNightAlive");
PROC_ORI_Gale_SetupForLastNightAlive();
SetOnStage(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, 1);
PROC_ORI_SetupCamp(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, 1);
Transform(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
CopyCharacterEquipment(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_ORI_Gale_InLastNightAlive(1);

PROC
PROC_ORI_Gale_SetupForLastNightAlive()
AND
NOT DB_Partymembers((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_Poof(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, VFX_Script_Gale_Double_Poof_01_5aec34ad-c864-c27d-1c4e-bb941014b75d);

PROC
PROC_ORI_Gale_SetupForLastNightAlive()
AND
DB_ORI_Gale_LastNightAliveAvatar(_Avatar)
THEN
NOT DB_ORI_Gale_LastNightAliveAvatar(_Avatar);

PROC
PROC_ORI_Gale_SetupForLastNightAlive()
AND
DB_Partymembers((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars(_Avatar)
AND
QRY_SameUser((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
THEN
DB_ORI_Gale_LastNightAliveAvatar(_Avatar);

PROC
PROC_ORI_Gale_SetupForLastNightAlive()
AND
DB_Partymembers((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_GLO_PartyMembers_Remove((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1);

IF
CharacterLeftParty((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_InLastNightAlive(1)
THEN
PROC_Poof(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, VFX_Script_Gale_Double_Poof_01_5aec34ad-c864-c27d-1c4e-bb941014b75d);

IF
RemovedFrom(_Anything, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349)
AND
IsItem(_Anything, 1)
THEN
RequestDelete((ITEM)_Anything);

IF
DB_ORI_Gale_InLastNightAlive(1)
AND
NOT DB_Camp_QueuedNight((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
THEN
NOT DB_ORI_Gale_InLastNightAlive(1);
PROC_ORI_Gale_Rejoin();
PROC_Poof(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, VFX_Script_Gale_Double_Poof_01_5aec34ad-c864-c27d-1c4e-bb941014b75d);

IF
AttackedBy(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, _, _, _, _, _, _)
THEN
PROC_Poof(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, VFX_Script_Gale_Double_Poof_01_5aec34ad-c864-c27d-1c4e-bb941014b75d);


QRY
QRY_Camp_StartRomanceNight_CustomDialogStart(CAMP_GalesLastNightAlive_SD_ROM_e6067557-2187-7493-c9b6-363ef6dd8334, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
AND
QRY_StartDialog_Fixed(CAMP_GalesLastNightAlive_SD_ROM_e6067557-2187-7493-c9b6-363ef6dd8334, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_ORI_Gale_LastNightAlive_GaleDouble_244735bd-a5e6-4e70-b6e6-becbf70a54b8, S_ORI_Gale_LastNightAlive_GaleDouble2_1b5e6e47-03bc-41b6-91e9-dbe6ba86ffe8, S_ORI_Gale_LastNightAlive_GaleDouble3_f6fb700a-5086-404c-ba15-7cf16642fc22, S_ORI_Gale_LastNightAlive_AvatarDouble_1cedd0c1-6bfe-4f32-a1e7-78b0acf209a9, _Avatar)
THEN
PROC_ORI_Gale_Rejoin();
Transform(S_ORI_Gale_LastNightAlive_GaleDouble_244735bd-a5e6-4e70-b6e6-becbf70a54b8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
Transform(S_ORI_Gale_LastNightAlive_GaleDouble2_1b5e6e47-03bc-41b6-91e9-dbe6ba86ffe8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
Transform(S_ORI_Gale_LastNightAlive_AvatarDouble_1cedd0c1-6bfe-4f32-a1e7-78b0acf209a9, _Avatar, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
MakePlayerActive(_Avatar);

PROC
PROC_ORI_Gale_Rejoin()
AND
NOT DB_GlobalFlag((FLAG)GEN_MaxPlayerCountReached_823b5064-8aa4-c0b7-1b8c-657b46987ccd)
AND
DB_ORI_Gale_LastNightAliveAvatar(_Avatar)
AND
DB_PartyMembers(_Avatar)
AND
QRY_OnlyOnce("ORI_Gale_RejoinDuringLastNightAlive")
THEN
PROC_GLO_PartyMembers_Add((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar);
PROC_ORI_Gale_Rejoin_TryTeleport(_Avatar);

PROC
PROC_ORI_Gale_Rejoin_TryTeleport((CHARACTER)_Avatar)
AND
NOT DB_InCamp(_Avatar)
THEN
TeleportTo(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar, "", 0, 0, 0, 0, 0);
AttachToPartyGroup((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar);

PROC
PROC_ORI_Gale_Rejoin_TryTeleport((CHARACTER)_Avatar)
AND
DB_InCamp(_Avatar)
AND
QRY_Camp_GetCamperPos(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_QRYRTN_Camp_GetCamperPos(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,_CamperPos)
THEN
TeleportTo(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _CamperPos, "", 0, 0, 0, 0, 0);

PROC
PROC_ORI_Gale_Rejoin()
THEN
SetOnStage(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1);

QRY
QRY_SpeakerIsAvailable((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,_,_,_)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
AND
DB_OffStage((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

IF
DB_InCamp((CHARACTER)S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
THEN
PROC_CampRelationshipDialog((CHARACTER)S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, (DIALOGRESOURCE)CAMP_GaleDouble2_5aa5ccd5-6624-3660-d814-e5f8d569708b, 0);
PROC_Try_CampRelationshipDialog((CHARACTER)S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349,1);
DB_CampNight_Completed((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd);

QRY
QRY_CampNight_AtLeastOneCompanionAvailableForCRD(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_InCamp((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_CantTalk((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SpeakerIsAvailable((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

QRY
QRY_SelectCustomDialog(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, _Companion)
AND
NOT DB_Avatars((CHARACTER)_Companion)
THEN
DB_SelectedDialog(GLO_AD_GaleDouble2_30311056-3d50-f319-01c2-29dcacf057e4, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349);

IF
DialogEnded((DIALOGRESOURCE)CAMP_GaleDouble2_5aa5ccd5-6624-3660-d814-e5f8d569708b, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
GetFlag((FLAG)ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9,_Player,1)
THEN
DB_Camp_QueuedRomanceNight((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)CAMP_GalesLastNightAlive_SD_ROM_e6067557-2187-7493-c9b6-363ef6dd8334, (CHARACTER)_Player);
PROC_Camp_TryLeaveNightMode((CHARACTER)_Player);

IF
FlagSet(ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9, _Player, _)
THEN
DB_ORI_Gale_QueuedForLastNightAliveScene(_Player);

IF
FlagCleared(ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9, _Player, _)
THEN
NOT DB_Camp_QueuedRomanceNight((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)CAMP_GalesLastNightAlive_SD_ROM_e6067557-2187-7493-c9b6-363ef6dd8334, (CHARACTER)_Player);
NOT DB_ORI_Gale_QueuedForLastNightAliveScene(_Player);

IF
FlagSet(ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9, _Player, _)
AND
DB_ORI_Gale_QueuedForLastNightAliveScene(_OtherPlayer)
AND
_OtherPlayer != _Player
THEN
ClearFlag(ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9, _OtherPlayer, 0);

IF
DB_ActiveCamp(_Camp)
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
AND
DB_ORI_GaleDouble2Trigger(_Camp, _Trigger)
AND
DB_ORI_Gale_CurrentGaleDouble2Trigger(_OldTrigger)
AND
_OldTrigger != _Trigger
THEN
TriggerUnregisterForCharacter(_OldTrigger, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349);
NOT DB_ORI_Gale_CurrentGaleDouble2Trigger(_OldTrigger);

IF
DB_ActiveCamp(_Camp)
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
AND
DB_ORI_GaleDouble2Trigger(_Camp, _Trigger)
AND
NOT DB_ORI_Gale_CurrentGaleDouble2Trigger(_Trigger)
THEN
TriggerRegisterForCharacter(_Trigger, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349);
DB_ORI_Gale_CurrentGaleDouble2Trigger(_Trigger);

IF
DB_ORI_Gale_CurrentGaleDouble2Trigger(_Trigger)
AND
NOT DB_InRegion(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, _Trigger)
THEN
TeleportTo(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, _Trigger);
//TODO: Dress up with VFX

IF
DB_ORI_Gale_CurrentGaleDouble2Trigger(_OldTrigger)
AND
NOT DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
THEN
TriggerUnregisterForCharacter(_OldTrigger, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349);
NOT DB_ORI_Gale_CurrentGaleDouble2Trigger(_OldTrigger);

PROC
PROC_OneShotTriggerEntered(_, (TRIGGER)S_ORI_Gale_LastNightAliveTrigger_943e6455-3aaa-4804-9fcf-24059ffa603f)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(ORI_Gale_State_ReadyForLastNightAlive_088c7213-0615-41a0-a4ac-1ab4d1341666, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
EnteredTrigger(_Player, S_SHA_Temple_SUB_348b76ee-33d8-471b-a95d-7ded0d6cdfd5)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(ORI_Gale_State_ReadyForLastNightAlive_088c7213-0615-41a0-a4ac-1ab4d1341666, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_ORI_Dating(_Character, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(ORI_Gale_State_LastNightAlive_RomanceCandidateExists_7c5bc0f6-3488-4cf8-b1f0-f76055bda2fc, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(ORI_Gale_State_LastNightAlive_RomanceCandidateExists_7c5bc0f6-3488-4cf8-b1f0-f76055bda2fc)
AND
NOT DB_ORI_Dating(_, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
ClearFlag(ORI_Gale_State_LastNightAlive_RomanceCandidateExists_7c5bc0f6-3488-4cf8-b1f0-f76055bda2fc, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_CAMPDEBUG_QueueNight((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _)
AND
GetHostCharacter(_Character)
AND
NOT DB_ORI_Dating(_, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars(_Character)
THEN
DB_OnlyOnce("ORI_Gale_LastNightAlive_DebugSetup");
SetFlag((FLAG)ORI_State_DatingGale_75d0e041-c16c-d089-6d89-64354fa4c9d9, _Character, 0);

PROC
PROC_CAMPDEBUG_QueueNight((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _)
AND
NOT DB_ORI_Dating(_, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars(_Avatar)
THEN
DB_OnlyOnce("ORI_Gale_LastNightAlive_DebugSetup");
SetFlag((FLAG)ORI_State_DatingGale_75d0e041-c16c-d089-6d89-64354fa4c9d9, _Avatar, 0);

PROC
PROC_CAMPDEBUG_QueueNight((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _)
THEN
NOT DB_OnlyOnce("ORI_Gale_LastNightAlive_DebugSetup");

PROC
PROC_Camp_SetModeToDay()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
AND
QRY_OnlyOnce("ORI_Gale_IPRD_LastNightAlive")
THEN
PROC_ORI_Gale_TryQueueLastNightAliveIPRD();

PROC
PROC_ORI_Gale_TryQueueLastNightAliveIPRD()
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_WillingToDie_3f22f471-60e6-11df-1c95-19f756f81994)
AND
QRY_ORI_Gale_EligibleAvatarInLastNightAlive()
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
CharacterReservedUserIDChanged((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1, _, 0, _)
AND
NOT QRY_ORI_Gale_EligibleAvatarInLastNightAlive()
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574,  (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);

IF
CharacterReservedUserIDChanged((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _)
AND
DB_RelationshipDialog_Queue((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1, _, 0, _)
AND
NOT QRY_ORI_Gale_EligibleAvatarInLastNightAlive()
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574,  (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);

PROC
PROC_COL_TeleportPartiesToColony(_)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574,  (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);

QRY
QRY_ORI_Gale_EligibleAvatarInLastNightAlive()
AND
DB_ORI_Partnered(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
GetFlag((FLAG)CAMP_GalesLastNightAlive_SD_ROM_Event_CollateralDamage_aeb64e31-0211-def4-505a-86999d46fe4a, _Avatar, 0)
AND
NOT QRY_PreventMPDialogue(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_EligibleAvatarInLastNightAlive()
AND
NOT DB_ORI_Partnered(_, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
GetFlag(ORI_Gale_State_WasInLastNightAlive_8259b8c8-c5aa-35b3-f7c5-820492069c03, _Avatar, 1)
AND
GetFlag((FLAG)CAMP_GalesLastNightAlive_SD_ROM_Event_CollateralDamage_aeb64e31-0211-def4-505a-86999d46fe4a, _Avatar, 0)
AND
NOT QRY_PreventMPDialogue(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

QRY
QRY_SelectCustomDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1, _, 0, -100)
AND
NOT QRY_PreventMPDialogue((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
AND
GetFlag(ORI_Gale_State_WasInLastNightAlive_8259b8c8-c5aa-35b3-f7c5-820492069c03, _Avatar, 0)
THEN
DB_SelectedDialog(GLO_AD_NonBondedCompanionDialog_62ba7c46-8d22-c591-f04c-2e99441cd02a, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);


//END_REGION

//REGION Gale Last Night for Avatars

//Prevent the query from triggering for non-Gale.
QRY
QRY_SelectCustomDialog((GUIDSTRING)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, (GUIDSTRING)_Player)
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_Avatar_46377049-b609-44ba-ae82-e931d2ff9953)
AND
_Player != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
THEN
DB_SelectedDialog((DIALOGRESOURCE)CAMP_Gale_Tressym_00706ce9-cbf7-95ee-912d-b42909b483a7, S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _Player);

//END_REGION

//REGION if Gale enters the colony without getting Mystra's briefing, he has no origin moment.

PROC
PROC_COL_TeleportPartiesToColony(_)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c)
THEN
NOT DB_COL_ChosenThreeOverrides((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

//END_REGION

//REGION Avatar state worsens through act 2 as well.

PROC
PROC_ORI_Gale_Act2Setup()
AND
NOT DB_GlobalFlag(ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93)
THEN
//Counts as crossing two regions for distance - should trigger one increase in need.
PROC_ORI_Gale_IncreaseRegionsVisited();
PROC_ORI_Gale_IncreaseRegionsVisited();

PROC
PROC_ORI_Gale_Act2Setup()
AND
NOT DB_GlobalFlag(ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
//Counts as crossing two regions for distance - should trigger one increase in need.
PROC_ORI_Gale_IncreaseRegionsVisited();
PROC_ORI_Gale_IncreaseRegionsVisited();


PROC
PROC_ORI_Gale_Act2Setup()
AND
NOT DB_GlobalFlag(ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9)
THEN
DB_OneShotPartyTrigger(S_ORI_Gale_SCLBombTrigger_392d9539-883c-41a7-8ac0-b0c0748f47a1);

PROC
PROC_OneShotTriggerEntered(_, S_ORI_Gale_SCLBombTrigger_392d9539-883c-41a7-8ac0-b0c0748f47a1)
THEN
PROC_ORI_Gale_IncreaseRegionsVisited();
PROC_ORI_Gale_IncreaseRegionsVisited();

IF
FlagSet(ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9, _, _)
THEN
PROC_RemoveOneShotTrigger(S_ORI_Gale_SCLBombTrigger_392d9539-883c-41a7-8ac0-b0c0748f47a1);


//END_REGION

//REGION If Gale missed Elminster entirely, he's going to leave
PROC
PROC_SCE_DebriefStarts()
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_SawElderBrain_05706143-82c3-616d-6850-9281f08c9b9f, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

PROC
PROC_SCE_DebriefStarts()
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_ElminsterVisit_2b8afc02-f8ae-d386-a910-989767a06250);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem1_c1899c40-e4c4-72d6-4360-444cea41e72f);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem2_170a6564-a01e-f145-6958-bf84312d0e03);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem3_b2db2afd-74a2-b432-df34-6073d7c78b62);

QRY
QRY_TWN_Finale_CompanionHasUnfinishedBusiness()
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c)
AND
NOT DB_OnlyOnce("ORI_Gale_EndOfActReminder")
THEN
DB_NOOP(1);

IF
ReadyCheckPassed("TWN_Finale_CompanionReadyCheck")
THEN
DB_OnlyOnce("ORI_Gale_EndOfActReminder");

//END_REGION

//REGION If Gale's Dating Avatar gets into combat with a shadow, he grows concerned.

IF
DB_ORI_Dating(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Is_InCombat(_Avatar, _Combat)
AND
DB_Is_InCombat(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Combat)
AND
NOT DB_GlobalFlag(ORI_Gale_State_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70)
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_Is_InCombat(_Undead, _Combat)
AND
NOT DB_PartyMembers((CHARACTER)_Undead)
AND
QRY_SameUser((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
AND
IsTagged(_Undead, (TAG)UNDEAD_33c625aa-6982-4c27-904f-e47029a9b140, 1)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, (FLAG)ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1);

IF
CharacterReservedUserIDChanged((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _)
AND
DB_ORI_Dating(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, (FLAG)ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70);

IF
DB_ORI_Partnered(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, (FLAG)ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70);

IF
FlagCleared((FLAG)ORI_State_PartneredWithGale_e008e20d-d642-42ed-9008-297b6273aa21, _Avatar, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, (FLAG)ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70);

IF
FlagCleared((FLAG)ORI_State_DatingGale_75d0e041-c16c-d089-6d89-64354fa4c9d9, _Avatar, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, (FLAG)ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70);

//END_REGION

//REGION Gale reminds the players

IF
DB_GlobalFlag(HAV_EnteringHaven_State_GainedAccess_07c776da-353a-9050-e9be-c42d51a99412)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d)
THEN
TriggerRegisterForCharacter(S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
FlagSet((FLAG)ORI_Gale_Knows_DidHavReminder_0a902530-51c5-fdcf-aa51-4c2417096c98, _, _)
THEN
TriggerUnregisterForCharacter(S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
FlagSet((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d, _, _)
THEN
TriggerUnregisterForCharacter(S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
EnteredTrigger((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag((FLAG)ORI_Gale_State_DoingHAVReminder_b3d946e0-ddaa-48ea-948e-ef14faf4df1a, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_State_HAVReminder_7f04f5c1-2585-ff41-a61a-674ab5e31627, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
FlagSet((FLAG)ORI_Gale_State_DoingHAVReminder_b3d946e0-ddaa-48ea-948e-ef14faf4df1a, NULL_00000000-0000-0000-0000-000000000000, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_State_HAVReminder_7f04f5c1-2585-ff41-a61a-674ab5e31627);

IF
LeftTrigger((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,  S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1)
THEN
ClearFlag((FLAG)ORI_Gale_State_DoingHAVReminder_b3d946e0-ddaa-48ea-948e-ef14faf4df1a, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_State_HAVReminder_7f04f5c1-2585-ff41-a61a-674ab5e31627);

//END_REGION

//REGION Avatar Last Night Alive

PROC
PROC_CAMPDEBUG_QueueNight(_Night, _)
AND
DB_CampNight_SoloDream(_Night, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)CAMP_Gale_SD_LastNightAlive_fdabf765-0c88-414c-60c2-2221fde2b464)
THEN
PROC_CampNight_GaleTressym_ToCamp(1);

PROC
PROC_CampNight_StartSleepMoments_PreHook()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Gale_LastNightAlive_Avatar_FollowedMystra_f45005bf-c598-4331-8cb8-fe246093f1db)
AND
NOT DB_GlobalFlag(ORI_Gale_Knows_ElminsterLetterRead_0f4d6900-49b2-4c5d-b72e-6b119011b8ab)
THEN
NOT DB_Camp_QueuedSoloDream((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, CAMP_Gale_SD_LastNightAlive_fdabf765-0c88-414c-60c2-2221fde2b464);

IF
DialogStarted(CAMP_Gale_SD_LastNightAlive_fdabf765-0c88-414c-60c2-2221fde2b464, _ID)
THEN
SetFlag((FLAG)ORI_Gale_State_HadLastNightAliveSD_29164397-366b-4b1a-a3c3-c3e91baed4e7, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogStarted((DIALOGRESOURCE)CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _)
THEN
PROC_ToInventoryAndOnStage(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
ApplyStatus(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, "GEN_INVENTORYBOUND", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
DialogEnded((DIALOGRESOURCE)CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _)
THEN
RemoveStatus(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, "GEN_INVENTORYBOUND", NULL_00000000-0000-0000-0000-000000000000);

IF
DialogEnded((DIALOGRESOURCE)CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Event_ReadElminsterLetter_678c9c84-1003-5c3a-fbe3-600fc12a3288)
THEN
Use((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, 1, 0, "");

IF
GameBookInterfaceClosed(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, _)
THEN
SetFlag(ORI_Gale_Knows_ElminsterLetterRead_0f4d6900-49b2-4c5d-b72e-6b119011b8ab, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_HandlingRelationshipDialog((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, (DIALOGRESOURCE)CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _, _, _, _)
AND
NOT GetRegion( S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, "SCL_Main_A")
THEN
TeleportTo(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, S_ORI_Gale_ElminsterPoint_SCL_975ef355-b68e-4061-bda8-b774e8ff552f, "", 0, 0, 0, 1, 1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _ID)
THEN
PROC_DialogAddSpeakingActor(_ID, S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b);

QRY
QRY_SelectCustomDialog(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _Avatar)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, (DIALOGRESOURCE)CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _, _, _, _)
AND
_Avatar != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
QRY_SpeakerIsAvailable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236)
THEN
DB_SelectedDialog((DIALOGRESOURCE)CAMP_Gale_Tressym_00706ce9-cbf7-95ee-912d-b42909b483a7, S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _Avatar);

QRY
QRY_SelectCustomDialog(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, (DIALOGRESOURCE)CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _, _, _, _)
AND
QRY_SpeakerIsAvailable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236)
THEN
DB_SelectedDialog((DIALOGRESOURCE)CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

//END_REGION

//REGION Gale can draw power from one of the fallen Bosses

PROC
PROC_BlockLootCorpse(_Player, _Boss)
AND
DB_TWN_Bosses(_Boss, _, _, _, _, _)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Player)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)TWN_Gale_LootBoss_bf0f715a-405c-41c1-a736-80fd7c8ecd9e, _Boss, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_GlobalSetFlagAndCache(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9);
DB_CustomLootCorpseResponse(_Player, _Boss, 0);

IF
DialogEnded(TWN_Gale_LootBoss_bf0f715a-405c-41c1-a736-80fd7c8ecd9e, _ID)
AND
DB_DialogSpeakers(_ID, _Corpse, 1)
AND
GetDistanceTo(_Corpse, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Dist)
AND
_Dist <= 5.0
AND
NOT DB_Defeated(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
OpenCharacterLootUI((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)_Corpse, _)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962, _, _)
THEN
AddPassive(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_ShadowSpellSlots");
SetFlag(TG_ORI_Gale_ConsumedTWNBoss_e65c5df2-9ff6-4e46-b0c0-f421e9fce6c9, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);
RemoveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_MYSTRABLESSING_1", NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((FLAG)ORI_Gale_State_RefusedTWNBossPower_e047de12-2c0b-7bdb-3553-47b03f69ca6a, _, _)
AND
NOT DB_GlobalFlag(ORI_Gale_State_CraftedDarkLantern_3ddebb12-8c9f-47b4-8b6a-bb8eeac51a9b)
THEN
ApplyStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_MYSTRABLESSING_2", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(TG_ORI_GaleBlessedByMystra_f3f75c10-e497-4819-8fd5-a2a3b3800525, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

//END_REGION

//REGION Journal updates
//Companion

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _ID)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
AND
NOT DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle")
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
QuestUpdate((CHARACTER)_Player, "ORI_COM_Gale", "FoundCircle");

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _ID)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8)
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle")
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
QuestUpdate((CHARACTER)_Player, "ORI_COM_Gale", "AccidentallyDestroyed");

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _ID)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8)
AND
DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle")
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
QuestUpdate((CHARACTER)_Player, "ORI_COM_Gale", "Destroyed");

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, _Player, _)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle")
THEN
QuestUpdate((CHARACTER)_Player, "ORI_COM_Gale", "Crafted");

IF
LevelLoaded("INT_MAIN_A")
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "Crafted")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "Destroyed")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "AccidentallyDestroyed")
AND
DB_Players(_Player)
THEN
QuestUpdate((CHARACTER)_Player, "ORI_COM_Gale", "MagicCircle_Act3");

//Avatar
IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _ID)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
AND
NOT DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 0)
THEN
QuestUpdate((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle");

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _ID)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8)
AND
DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 1)
THEN
QuestUpdate((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "Destroyed");

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, _, _)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 1)
THEN
QuestUpdate((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "Crafted");

IF
LevelLoaded("INT_MAIN_A")
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 1)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "Crafted", 0)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "Destroyed", 0)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 1)
THEN
QuestUpdate((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "MagicCircle_Act3");


QRY
QRY_MOO_BalthazarLab_Circle_Using((INTEGER)_ID)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
GetFlag((FLAG)SCL_BalthazarLab_Circle_Event_Use_277fddb0-4519-c267-52c3-3831ad1955c9, _Player, 1)
THEN
DB_NOOP(1);

//END_REGION

//REGION Balthazar's experiment.

IF
InteractionFallback((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_TryStartAD((DIALOGRESOURCE)GEB_AD_CantTalkNow_ae991ba1-8a2e-9cc7-b4c2-379af7f058c5, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77);

QRY
QRY_ORI_Gale_BalthazarLab_Circle_GaleDialog((CHARACTER)_Character)
AND
NOT DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Character)
AND
QRY_SameUser(_Character, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_BalthazarLab_Circle_GaleDialog((CHARACTER)_Character)
AND
DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
AND
QRY_StartDialog((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _Character)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_BalthazarLab_Circle_GaleDialog((CHARACTER)_Character)
AND
NOT DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
AND
_Character != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
DB_Avatars(_Character)
AND
NOT DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Character)
AND
QRY_SameUser(_Character, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _Character, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

PROC
PROC_DialogFlagSetup((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_OnlyOnce("ORI_Gale_BalthazarLab_Circle_GaleDialog");

IF
InteractionFallback(_Character, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77)
AND
_Character != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604 
AND
NOT QRY_ORI_Gale_BalthazarLab_Circle_GaleDialog((CHARACTER)_Character)
THEN
PROC_TryStartAD((DIALOGRESOURCE)MOO_BalthazarLab_Circle_PAD_1f95c6fa-8fb7-5d53-a2c0-5eac2013f733, _Character);

IF
DialogEnded((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _ID)
AND
DB_DialogPlayers(_ID, _Player, _)
AND
GetFlag((FLAG)SCL_BalthazarLab_Circle_Event_Use_277fddb0-4519-c267-52c3-3831ad1955c9, _Player, 1)
THEN
MakePlayerActive((CHARACTER)_Player);
SetTag(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, (TAG)ITEMINTERACTION_UNLOCKED_6ca541e1-b5d9-4cfa-b745-61a5483052d7);
ClearFlag((FLAG)SCL_BalthazarLab_Circle_Event_Use_277fddb0-4519-c267-52c3-3831ad1955c9, _Player, 0);
Use((CHARACTER)_Player, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, 1, 0, "");


IF
DialogEnded((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
QuestUpdateIsUnlocked((CHARACTER)_Player, "ORI_COM_Gale", "Crafted_Companion", 1)
AND
GetPosition(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _X, _Y, _Z)
THEN
SetVisible(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, 0);
PlayEffectAtPosition(VFX_Script_SCL_MagicCircle_CombineSuccess_01_3fd32122-a4e0-a6eb-291b-60e42e7ad710, _X, _Y, _Z, 1.0);

IF
DialogEnded((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _ID)
AND
DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8)
THEN
ClearFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8);
CreateExplosion(S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, "Projectile_MOO_BalthazarCircle_Explode", 10, NULL_00000000-0000-0000-0000-000000000000);

//If Gale is an Avatar, trigger TGs on everyone else.
IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, _, _)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(TG_ORI_Gale_CraftedDarkLantern_e59b3e35-10f1-4d16-9d03-d495a6049c3e, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

//If Gale is not an Avatar, trigger IPRD for him.
IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_CraftedShadowLantern_645a4eb9-5417-951b-f282-9bdcdd9f89f1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, _Player, _DarkLantern)
AND
GetPosition(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _X, _Y, _Z)
THEN
SetFlag(ORI_Gale_State_CraftedDarkLantern_3ddebb12-8c9f-47b4-8b6a-bb8eeac51a9b, NULL_00000000-0000-0000-0000-000000000000, 0);
SetVisible(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, 0);
PlayEffectAtPosition(VFX_Script_SCL_MagicCircle_CombineSuccess_01_3fd32122-a4e0-a6eb-291b-60e42e7ad710, _X, _Y, _Z, 1.0);
SetFlag((FLAG)ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Player, 0);
ToInventory(_DarkLantern, _Player, -1, 1, 1);

IF
UseStarted(_, S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77)
AND
GetFlag(ORI_Gale_State_CraftedDarkLantern_3ddebb12-8c9f-47b4-8b6a-bb8eeac51a9b, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
ClearTag(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, (TAG)ITEMINTERACTION_UNLOCKED_6ca541e1-b5d9-4cfa-b745-61a5483052d7);

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, _, _)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_StartDialog((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)ORI_Gale_Event_DestroyBalthazarCircle_773ed9d2-5879-0e2b-f18f-2e6768b958f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962)
THEN
ApplyStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_MYSTRABLESSING_1", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((FLAG)ORI_Gale_Event_DestroyBalthazarCircle_773ed9d2-5879-0e2b-f18f-2e6768b958f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(TG_ORI_GaleBlessedByMystra_f3f75c10-e497-4819-8fd5-a2a3b3800525, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
FlagSet((FLAG)ORI_Gale_Event_DestroyBalthazarCircle_773ed9d2-5879-0e2b-f18f-2e6768b958f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_BlessedByMystra_66c00d4b-a810-b142-7e3e-7387c1918dd7, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
DialogEnded((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _)
AND
DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
AND
GetPosition(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _X, _Y, _Z)
THEN
SetVisible(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, 0);
PlayEffectAtPosition(VFX_Script_SCL_MagicCircle_DestroyAction_01_4647a831-0117-c958-f9c7-2f2e2829471a, _X, _Y, _Z, 1.0);

IF
LeftTrigger(_Character, S_MOO_UpperFloorInterior_SUB_93c522d3-04c4-4f71-a1dc-043478c51301)
AND
DB_Players(_Character)
AND
GetFlag((FLAG)ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Character, 1)
THEN
ClearFlag((FLAG)ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Character, 0);

IF
DialogEnded((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _ID)
AND
DB_DialogPlayers(_ID, _Character, _)
AND
GetFlag((FLAG)ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Character, 1)
THEN
ClearFlag((FLAG)ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Character, 0);

//Check if ingredients are available
IF
Moved(_Ingredient)
AND
DB_ORI_Gale_LanternIngredients(_Type, _Ingredient)
THEN
NOT DB_ORI_Gale_LanternIngredients(_Type, _Ingredient);
PROC_ORI_Gale_BalthazarLab_CheckIngredients();

PROC
PROC_ORI_Gale_BalthazarLab_CheckIngredients()
AND
NOT DB_ORI_Gale_LanternIngredients("Pixie", _)
THEN
SetFlag(ORI_Gale_BalthazarLab_State_IngredientsGone_8e632516-2a31-4ace-8327-392e152f3924, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_ORI_Gale_BalthazarLab_CheckIngredients()
AND
NOT DB_ORI_Gale_LanternIngredients("Lantern", _)
THEN
SetFlag(ORI_Gale_BalthazarLab_State_IngredientsGone_8e632516-2a31-4ace-8327-392e152f3924, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(ORI_Gale_BalthazarLab_Event_TakeIngredients_e60fe6a9-2216-4c63-85cf-b1479451c285, _Character, _)
AND
QRY_OnlyOnce_Reset("ORI_Gale_BalthazarLab_Event_TakeIngredients")
AND
DB_ORI_Gale_LanternIngredients("Pixie", _Pixie)
AND
DB_ORI_Gale_LanternIngredients("Lantern", _Lantern)
AND
QRY_OnlyOnce("ORI_Gale_BalthazarLab_Event_TakeIngredients")
THEN
ToInventory(_Pixie, _Character, -1, 1, 1);
ToInventory(_Lantern, _Character, -1, 1, 1);

IF
FlagSet(ORI_Gale_BalthazarLab_Event_TakeIngredients_e60fe6a9-2216-4c63-85cf-b1479451c285, _Character, _)
THEN
ClearFlag(ORI_Gale_BalthazarLab_Event_TakeIngredients_e60fe6a9-2216-4c63-85cf-b1479451c285, _Character, 0);


//END_REGION

//REGION Track if Gale has obeyed Mystra

IF
FlagSet(ORI_Gale_State_ReadyForLastNightAlive_088c7213-0615-41a0-a4ac-1ab4d1341666, NULL_00000000-0000-0000-0000-000000000000, _)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_ORI_Gale_FollowedMystra()
THEN
SetFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
TadpolePowerAssigned((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46)
AND
NOT QRY_ORI_Gale_FollowedMystra()
THEN
ClearFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

QRY
QRY_ORI_Gale_FollowedMystra()
AND
NOT DB_GlobalFlag(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9)
AND
NOT DB_OnlyOnce("ORI_Gale_BalthazarLab_Circle_GaleDialog")
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
GetTadpolePowersCount((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_FollowedMystra()
AND
DB_GlobalFlag(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962)
AND
NOT DB_OnlyOnce("ORI_Gale_BalthazarLab_Circle_GaleDialog")
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_FollowedMystra()
AND
NOT DB_GlobalFlag(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9)
AND
DB_OnlyOnce("ORI_Gale_BalthazarLab_Circle_GaleDialog")
AND
DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _, _)
AND
QRY_ORI_Gale_FollowedMystra()
THEN
SetFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogEnded((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _)
AND
QRY_ORI_Gale_FollowedMystra()
THEN
SetFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogEnded((DIALOGRESOURCE)TWN_Gale_LootBoss_bf0f715a-405c-41c1-a736-80fd7c8ecd9e, _)
AND
QRY_ORI_Gale_FollowedMystra()
THEN
SetFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962, _, _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46)
THEN
ClearFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogEnded((DIALOGRESOURCE)MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _)
AND
NOT DB_GlobalFlag((FLAG)SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46)
THEN
ClearFlag((FLAG)ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);


//END_REGION

//REGION Hack for Tara's WRD
IF
DialogStarted((DIALOGRESOURCE)CAMP_Gale_Tressym_00706ce9-cbf7-95ee-912d-b42909b483a7, _ID)
AND
DB_DialogPlayers(_ID, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1)
THEN
NOT DB_ORI_Gale_TaraCRD(1);
PROC_ExclamationMark_Hide((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);

IF
DB_Camp_QueuedNight((FLAG)NIGHT_Gale_LastNightAlive_Avatar_46377049-b609-44ba-ae82-e931d2ff9953)
THEN
NOT DB_ORI_Gale_TaraCRD(1);
PROC_ExclamationMark_Hide((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);

IF
DB_Camp_QueuedNight((FLAG)NIGHT_Gale_LastNightAlive_Avatar_FollowedMystra_f45005bf-c598-4331-8cb8-fe246093f1db)
THEN
NOT DB_ORI_Gale_TaraCRD(1);
PROC_ExclamationMark_Hide((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);

IF
FlagSet(MOO_Audience_Event_PassTeleporter_3115b554-2e0e-cbdc-6166-5fa7586cae45, _, _)
THEN
NOT DB_ORI_Gale_TaraCRD(1);
PROC_ExclamationMark_Hide((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);

IF
FlagSet(SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e, _, _)
THEN
NOT DB_ORI_Gale_TaraCRD(1);
PROC_ExclamationMark_Hide((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);


//END_REGION

//REGION

IF
FlagSet((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, _, _)
THEN
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Act2End_05706143-82c3-616d-6850-9281f08c9b9f, (FLAG)ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
