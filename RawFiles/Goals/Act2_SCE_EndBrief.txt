Version 1
SubGoalCombiner SGC_AND
INITSECTION
SetOnStage(S_SCE_Portal_ce5f1b20-6e3b-4fe9-9137-8c4ea3d025af, 0);

DB_SCE_Debrief_Participant((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, (TRIGGER)S_SCE_IsobelPoint_d51cd5c0-9a39-4f86-9da5-116af810b914, (DIALOGRESOURCE)SCE_IsobelSoloReunion_29607941-2c6d-8244-742c-db0c577b1933);
DB_SCE_Debrief_Participant((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (TRIGGER)S_SCE_JaheiraPoint_88a296f5-6f7b-4e26-a3df-a9291c0f1399, (DIALOGRESOURCE)SCE_Jaheira_Debrief_7eb6a35a-656a-78db-57c8-4d5178ef880b);
DB_SCE_Debrief_Participant((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (TRIGGER)S_SCE_NightsongPoint_c4db60d7-57f7-41fc-99f1-5957ab059e7f, (DIALOGRESOURCE)SCE_NightsongSoloReunion_1dc738df-3423-82a6-2f11-3615feee5a1c);

DB_SCE_Participant_KeepFaction((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
DB_SCE_Participant_KeepFaction((CHARACTER)S_HAV_SpiritOfTheLand_1403cdfd-0660-4592-90c6-bfe4607ccd3a);


NOT DB_SCE_Debrief_Participant_Config((CHARACTER)NULL_00000000-0000-0000-0000-000000000000,"_Config");

// Sets and clears global flags if a character is currently at the epilogue
//DB_SCE_Debrief_ParticipantFlags((CHARACTER)_Char, (FLAG)_GlobalFlag);
DB_SCE_Debrief_ParticipantFlags((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (FLAG)SCE_Debrief_State_JaheiraCurrentlyPresent_766b30ac-7b90-4159-a30f-50fe939ba7d8);
DB_SCE_Debrief_ParticipantFlags((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (FLAG)SCE_Debrief_State_MintharaCurrentlyPresent_bcd7dde7-aad5-4dff-b289-3672c8e2591b);

//REGION Dialog flags
DB_HasItemEvent((ITEM)S_SCE_KhalidsGift_43e4f96a-ce86-4da0-8b02-eb82fd9cc462, (FLAG)SCE_Debrief_State_HasKhalidsGift_0fee377a-319a-44f3-93d8-5aff54388806);
DB_GiveItemToEvent((ITEM)S_SCE_KhalidsGift_43e4f96a-ce86-4da0-8b02-eb82fd9cc462, (FLAG)SCE_Debrief_Event_GiveKhalidsAmulet_358d3065-3391-4680-b41f-830f192e0ad0);
//END_REGION

//REGION Characters to hide
// Hide characters in DB_MOO_Denizens() and DB_SCE_Debrief_HiddenCharacters()
// Caravan members
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_DriderCaravan_GoblinMelee_000_c176d94a-eaa6-4869-a344-88e44b31e17d);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_DriderCaravan_GoblinMelee_001_0648b227-b64b-471f-a6ac-d71af926dfb4);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_DriderCaravan_HalfOrcMelee_8e95a1ed-12f0-4b2e-9d22-d9b4522a1445);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_DriderCaravan_GoblinRanger_d9efe828-934f-4b38-b741-402001449f0d);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_DriderCaravan_HalfOrcCaster_f9522205-623f-4a82-904a-128b26182707);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab);

// Docks
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_DockObserver_5d1de164-5969-4593-87b7-1fcb5b54f00f);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_DockJumper_fd7e05e2-3d4a-4de9-baf5-2be25b21441f);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_DockPatroller_000_646fba8c-6972-4162-aa7a-f0df28bb1f51);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_DockPatroller_001_352693eb-0ef0-4949-86c5-ba78081d9fb4);

// Scrying eyes
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_UpperEye_C_881081c0-8e1a-4033-9cb3-37532cd7f4ef);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_UpperEye_B_6bbcbc71-91b2-499e-b42d-381eb729bad1);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_PrisonEye_C_89e223c3-52e8-4bbf-9a75-47cbb0b6b65e);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_PrisonEye_B_9bea6db5-8e9a-4277-9813-823b45248022);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_GroundEye_A_bb378616-79a0-4b0c-b967-e650e3707b24);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_GroundEye_B_e50cabc8-afb0-4e5b-a73c-166828488510);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_PrisonEye_A_fe9333ab-2bbe-4624-978e-56ca9b4c58da);

// Entrance checkpoint
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_EntranceGuard_001_b302d246-59ff-48ee-8247-0e3bcfd4b38e);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_EntranceGuard_002_2ab30cea-d3f1-4aa4-8c83-b8b700ef0048);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_EntranceGhoul_001_c9b6a714-491a-40aa-b5b6-3fe608a4efb5);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_EntranceGhoul_002_2e7447e5-35dd-4cdd-8426-43a6afe0edc7);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_EntranceGhoul_003_019af169-5366-4a1f-8392-35df658b2e8e);

// Roof
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_RoofCultist_ebfd7bc7-0fd5-4dee-8fd5-308ded4d0a65);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_RoofNecromite_001_97c8dc13-5a94-48c2-b2d1-2bb3c1d4dd40);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_RoofNecromite_002_0d759ded-13de-4e24-ad3b-cae83879b4c9);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_RoofNecromite_003_02edce28-9ce1-4905-a776-fd8b50ae0dcc);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_RoofNecromite_004_ee6ea72e-8a85-445f-8b48-461b4d9d5418);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_RoofNecromite_005_242237d0-a129-48a6-a868-3b9211138de5);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_RoofNecromite_006_48279220-f514-48a7-8084-c8b8eb3629ff);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_RoofNecromite_007_a1fbcddf-cf6e-4222-a022-0fd12d099ce2);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_RoofNecromite_008_afd14856-feff-42be-9b6c-402889f45c13);

// Feral ghouls
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_FlyingGhoul_000_6a6a2784-47b0-4838-bc6a-31288ac99158);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_FlyingGhoul_001_ac6133f2-98fd-465b-9b12-e5bf72b4c3c9);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_FlyingGhoul_002_90b8c61f-c7e8-445c-a1b1-9d9874457529);

//Guards
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_MindTorturer_001_480b89b1-ae6c-46e7-ad79-1b3babe3655e);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_MindTorturer_002_5c744998-b3cb-4edb-8a32-4df06593e849);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_WarehouseGuard_000_d161fc7f-801c-463c-bdbd-f638c8499361);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_WarehouseGuard_001_30de3349-7bcb-4a6e-be2e-3ae7a4c89e6a);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_WarehouseGuard_002_8360ec17-f888-4745-8b22-351feadb86d1);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_PrisonWarden_66b3e4c0-2f82-4c0a-9333-73a5194f88c7);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_PrisonGuard_002_0cf357ec-268c-4779-92ad-8d6c7de437d1);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_PrisonGuard_004_107c72ca-2a4f-477d-a315-deeea3eea49e);

//Haven Denizens
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_HAV_HavenOutcasts_RoofWatcher_Caster_d44b6aee-7737-4961-bb2b-e7920b003107);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_HAV_HavenOutcasts_EntranceGuards_Caster_HighElf_825714dd-7df9-4cd1-aecb-edf577baa487);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_HAV_LastLightOx000_7150c268-1a23-4967-82e8-bf69c624a22b);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_HAV_LastLightOx001_b80708e2-bb6e-46a2-b68e-086c53d95cef);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_HAV_GnomeCat_33e545f6-9a0a-48ae-88b4-896a0c21c8ca);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_HAV_Manip_0b8fdd17-7ce6-4038-9d9d-49f5ddbc20be);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_HAV_FlamingFist_006_9629c27e-8e50-4258-8bda-6639af768ba6);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_Drider_Harper_Melee_000_b9f6bb1e-f4cd-4bb3-a7f0-80aad9bae8c8);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_Drider_Harper_Ranger_000_ce089a64-1a91-4ab0-ac71-a2712680780d);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_Drider_Harper_Ranger_001_71c140fa-0ebd-4f36-8728-6e28a445a6ff);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_Drider_Harper_Caster_000_ef609a8e-08bf-4648-bbb4-380a7f4bc887);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_HarperScout_000_c6dfb2aa-809f-4b3e-8b32-968c10184ec3);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_HarperScout_001_25e154f6-d762-4bea-862e-98c48d7ebe3e);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_SCL_HarperScout_003_9bebec18-ca66-42e9-abce-8d6a5f9d2a1b);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_HAV_FlamingFist_001_47058367-9c0c-4756-a467-07b87b28e0d6); //GLO
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_GLO_DevilishOx_49eb5b4b-c6ed-4d37-8f68-97b1128b7d56); //GLO
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79); //GLO
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_GLO_YoungLover_02_dcf597c0-36c5-4c81-957a-6fe9fca50a68); //GLO
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b); //GLO

DB_SCE_Debrief_BackOnStage((CHARACTER)S_GLO_DevilishOx_49eb5b4b-c6ed-4d37-8f68-97b1128b7d56); 
DB_SCE_Debrief_BackOnStage((CHARACTER)S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79); 
DB_SCE_Debrief_BackOnStage((CHARACTER)S_GLO_YoungLover_02_dcf597c0-36c5-4c81-957a-6fe9fca50a68); 
DB_SCE_Debrief_BackOnStage((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b); 
DB_SCE_Debrief_BackOnStage((CHARACTER)S_HAV_FlamingFist_001_47058367-9c0c-4756-a467-07b87b28e0d6);

//Assault
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_AssaultHarper_002_350067f3-a2ff-462d-acaa-fb5222711c65);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_AssaultHarper_003_2863d986-9aca-447c-a493-19cc5f06394b);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_AssaultHarper_004_d552c90e-7d29-4904-a349-6d44b9b38040);

DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_AssaultFlamingFist_001_623d562f-937c-4863-97df-d836f6bf2c6a);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_AssaultFlamingFist_002_a442887f-71ed-415e-92b2-58ffa6e029a5);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_AssaultFlamingFist_003_68bd5a16-ca4b-4108-9ba5-9d16bda5f108);
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_AssaultFlamingFist_004_eba54058-6cac-467e-9912-a3942eb49a8d);



// Others
DB_SCE_Debrief_HiddenCharacters((CHARACTER)S_MOO_KethericHound_9c7a8f97-bae8-4509-ad10-a67c17202a31);

//END_REGION

//REGION Inclusions
DB_Inclusion_Object(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (FLAG)SCE_Minthara_Inclusion_Start_82541346-7f03-4e80-a590-79ebf95d2332, (FLAG)SCE_Minthara_Inclusion_End_057432e2-c0cb-4d2d-b16c-157a1e258bf5);
//END_REGION

//REGION Jergal
DB_SCE_Debrief_Participant((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, S_SCE_JergalPoint_96a26bf5-bc06-4236-8d97-67fa2da1f40b, (DIALOGRESOURCE)SCE_Jergal_Debrief_40bfba6f-d321-0d1e-1d14-5092544d96ea);
DB_GLO_Jergal_ResurrectionDialogues((DIALOGRESOURCE)SCE_Jergal_Debrief_40bfba6f-d321-0d1e-1d14-5092544d96ea, 200);
//END_REGION

//REGION Item ownership

DB_SCE_ItemOwnership_Triggers((TRIGGER)S_MOO_BugbearOwnership_a77e8d94-0367-4e81-aedb-eb9cbac7e799);
DB_SCE_ItemOwnership_Triggers((TRIGGER)S_MOO_InfernalOwnership_377724ee-fde7-48ba-9184-1b43eccc904d);
DB_SCE_ItemOwnership_Triggers((TRIGGER)S_MOO_KitchenOwnership_11acb37a-4cfd-47f1-b5f2-846bbd575399);
DB_SCE_ItemOwnership_Triggers((TRIGGER)S_MOO_ZhentOwnership_dc1351dc-57e1-4c6b-a4c5-10910dff1b47);
DB_SCE_ItemOwnership_Triggers((TRIGGER)S_MOO_ZRell_Ownership_2bed540d-8220-4cf3-af18-380a71a11c4c);
DB_SCE_ItemOwnership_Triggers((TRIGGER)S_MOO_AudienceAccess_Ownership_1219f21f-61d3-42fc-b4c9-1a17cd3fa0ba);

//END_REGION
KBSECTION
PROC
PROC_State_Changed(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", _, "HAV_Isobel_State_AtMoonrise")
THEN
NOT DB_SCE_Debrief_Participant((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_SCE_IsobelPoint_d51cd5c0-9a39-4f86-9da5-116af810b914, (DIALOGRESOURCE)SCE_Isobel_Debrief_811d4693-e7a2-ab59-4afd-1701756b755f);

IF
DB_GlobalFlag((FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e)
AND
DB_Players(_Player)
AND
NOT DB_InRegion(_Player,(TRIGGER)S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b)
THEN
SetFlag(SCE_State_PlayerVisitedEpilogue_1c1c8a40-0862-4794-a46b-5064c54512df,_Player);

//REGION Debrief set-up

//If Jaheira is in your party, she shouldn't need any of this, so take her out of the debrief setup. Her dialog is handled within her InParty as a nested dialog.
IF
DB_GlobalFlag((FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e)
AND 
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_GlobalSetFlagAndCache(Debug_SCE_Debrief_BlockJaheira_e9063240-a89f-4965-86cf-90c9377c438d);

PROC
PROC_SCE_StartSetupDebrief()
THEN
ClearFlag(MOO_Assault_State_InProgress_0f3a8f5d-7402-4220-bebb-d4b21d3db08d); //In case of debug skipping the entering of colony
PROC_Foop(S_SCE_Portal_ce5f1b20-6e3b-4fe9-9137-8c4ea3d025af);
PROC_LoopEffect(VFX_Script_Waypoint_Portal_Looping_01_ac49625c-c1fb-a34c-911c-d43e65164364,S_SCE_Portal_Effect_Helper_8c0add1c-689e-4a42-a6d8-30940fec306d,"GLO_UsingWaypoint","SCL_Main_A","");
PROC_GlobalSetFlagAndCache(HAV_Siege_State_NoMoreSiege_2129857a-bfa2-49c4-a853-c7e08a2fa632);
PROC_GlobalSetFlagAndCache(SCE_Debrief_State_Setup_0ebc6b35-0f07-4a73-b6b8-9782ecbcaccf);
PROC_TWN_MarchingArmy_ArmyLeft();
PROC_SCE_SetupDebrief();
PROC_SCE_SetUpFinale();
PROC_HAV_ProtectionFX_Off();

PROC
PROC_SCE_SetupDebrief()
AND
DB_MOO_Denizens(_NPC)
AND
NOT DB_SCE_Debrief_Participant((CHARACTER)_NPC, _, _)
AND
NOT DB_Defeated(_NPC)
THEN
SetOnStage(_NPC, 0);

PROC
PROC_SCE_SetupDebrief()
AND
DB_SCE_Debrief_HiddenCharacters(_NPC)
AND
NOT DB_SCE_Debrief_Participant((CHARACTER)_NPC, _, _)
AND
NOT DB_Defeated(_NPC)
THEN
SetOnStage(_NPC, 0);

PROC
PROC_SCE_SetupDebrief()
AND
DB_SCE_Debrief_Participant(_Character, _, _)
AND
NOT DB_Players(_Character)
AND
NOT QRY_SCE_Debrief_BlockCharacter((CHARACTER)_Character)
THEN
PROC_SCE_SendCharacterToDebrief(_Character);

// Will always send the character to their debrief state unless they are in DB_Defeated()
PROC
PROC_SCE_SendCharacterToDebrief((CHARACTER)_Character)
THEN
PROC_SCE_SendCharacterToDebrief((CHARACTER)_Character, 1);

//Applying Debrief faction override technical status
PROC
PROC_SCE_SendCharacterToDebrief((CHARACTER)_Character)
AND
NOT DB_SCE_Participant_KeepFaction(_Character)
AND
NOT DB_PartOfTheTeam(_Character)
THEN
ApplyStatus(_Character, "SCE_EPILOGUE_FACTIONOVERRIDE", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SCE_SetupDebrief()
AND
DB_SCE_RavenguardFollowUp_FlamingFists(_Character)
THEN
ApplyStatus(_Character, "SCE_EPILOGUE_FACTIONOVERRIDE", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);


 //instead of checking DB_CantMove, check everything EXCEPT DB_Offstage
PROC
PROC_SCE_SendCharacterToDebrief((CHARACTER)_Character, (INTEGER)_TeleportToEpilogue)
AND
DB_SCE_Debrief_Participant(_Character, _Trigger, _Dialog)
AND
NOT QRY_CantMove_IgnoreOffstage(_Character)
THEN
PROC_RemoveDialog(_Character);
PROC_SCE_MoveOrTeleportToDebrief(_Character, _Trigger, _TeleportToEpilogue);

PROC
PROC_SCE_MoveOrTeleportToDebrief((CHARACTER)_Char, (TRIGGER)_Trigger, 1)
THEN
TeleportTo(_Char, _Trigger, "SCE_MovedToEpilogue", 0, 0, 1, 1, 1);

PROC
PROC_SCE_MoveOrTeleportToDebrief((CHARACTER)_Char, (TRIGGER)_Trigger, 0)
THEN
PROC_CharacterMoveTo(_Char, _Trigger, "Walk", "SCE_MovedToEpilogue");

//Clearing debrief faction override technical status
IF
LevelUnloading("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e)
AND
DB_SCE_Debrief_Participant(_Char, _, _)
AND
HasAppliedStatus(_Char, "SCE_EPILOGUE_FACTIONOVERRIDE", 1)
THEN
RemoveStatus(_Char, "SCE_EPILOGUE_FACTIONOVERRIDE", NULL_00000000-0000-0000-0000-000000000000);

IF
EntityEvent((CHARACTER)_Character, "SCE_MovedToEpilogue")
AND
DB_SCE_Debrief_Participant(_Character, _Trigger, _Dialog)
THEN
PROC_SetOnStage(_Character,1);
SetFlag(SCE_State_AtEpilogue_3541abb5-6aaf-48c7-bf30-5a13b3abc718, _Character, 0);
DB_Dialogs(_Character, _Dialog);
DB_SCE_Debrief_BeenInEpilogue(_Character);
DB_SCE_Debrief_CharactersInEpilogue(_Character);
TriggerRegisterForCharacter((TRIGGER)S_SCE_EpilogueArea_f53ddb87-4834-43df-81d0-757e0bdfc502, _Character);
PROC_SCE_CharacterInEpilogueHook(_Character);

// If Jaheira survived to here, she AD's when she's done moving
PROC
PROC_SCE_DebriefStarts()
AND
QRY_OnlyOnce("SCE_EpilogueIntroAD")
AND
DB_SCE_Debrief_CharactersInEpilogue((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_TryStartAD(SCE_Jaheira_AD_EpilogueIntro_ad4993f4-db6b-8d62-fc80-ca32265ca650, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_SCE_DebriefStarts()
AND
QRY_OnlyOnce("SCE_EpilogueIntroAD")
AND
NOT DB_SCE_Debrief_CharactersInEpilogue((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_TryStartAD(SCE_Jergal_AD_EpilogueIntro_b59862ef-3a0c-e11d-df3c-0b89f970c354, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);


IF
DB_SCE_Debrief_ParticipantFlags(_Char, _Flag)
AND
NOT DB_SCE_Debrief_CharactersInEpilogue(_Char)
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

IF
DB_SCE_Debrief_ParticipantFlags(_Char, _Flag)
AND
DB_SCE_Debrief_CharactersInEpilogue(_Char)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

IF
DialogEnded((DIALOGRESOURCE)TWN_Finale_LeavingAct_06d434ac-008b-1994-5dc5-f8fcd681553d, _DialogID)
AND
NOT DB_DialogRequestFailed(TWN_Finale_LeavingAct_06d434ac-008b-1994-5dc5-f8fcd681553d, _DialogID)
AND
DB_SCE_Debrief_CharactersInEpilogue(_Char)
THEN
ClearFlag(SCE_State_AtEpilogue_3541abb5-6aaf-48c7-bf30-5a13b3abc718, _Char);

IF
LeftTrigger(_Char, (TRIGGER)S_SCE_EpilogueArea_f53ddb87-4834-43df-81d0-757e0bdfc502)
THEN
ClearFlag(SCE_State_AtEpilogue_3541abb5-6aaf-48c7-bf30-5a13b3abc718, _Char);

IF
FlagCleared(SCE_State_AtEpilogue_3541abb5-6aaf-48c7-bf30-5a13b3abc718, (CHARACTER)_Char, _)
THEN
NOT DB_SCE_Debrief_CharactersInEpilogue(_Char);
TriggerUnregisterForCharacter((TRIGGER)S_SCE_EpilogueArea_f53ddb87-4834-43df-81d0-757e0bdfc502, _Char);

PROC
PROC_SCE_CharacterInEpilogueHook((CHARACTER)_Character)
AND
DB_SCE_Debrief_Participant_Config(_Character,_Config)
THEN
PROC_SetAnubisConfig(_Character,_Config);

QRY
QRY_SCE_Debrief_BlockCharacter((CHARACTER)_Char)
AND
DB_SCE_Debrief_BeenInEpilogue(_Char)
THEN
DB_NOOP(1);

//Undead shadowcurse do not enter DB_Permadefeated. We check if they are cursed specifically since being in/not in a safe zone does not indicate what status they are in
QRY
QRY_SCE_Debrief_BlockCharacter((CHARACTER)_Char)
AND
QRY_SCL_ShadowCurse_Undead(_Char)
THEN
DB_NOOP(1);

QRY
QRY_SCE_Debrief_BlockCharacter((CHARACTER)_Char)
AND
DB_PermaDefeated(_Char)
THEN
DB_NOOP(1);

IF
DB_SCE_Debrief_CharactersInEpilogue(_)
THEN
TimerCancel("SCE_UpdateBehaviours");
TimerLaunch("SCE_UpdateBehaviours",3000);

IF
TimerFinished("SCE_UpdateBehaviours")
THEN
PROC_SCE_UpdateBehaviours();

//END_REGION

//REGION Dismissing epilogue companions
IF
EntityEvent((CHARACTER)_Player, "SCE_Debrief_Start")
AND
DB_Players(_Player)
AND
DB_SCE_Debrief_Participant(_Player, _, _)
AND
NOT QRY_SCE_Debrief_BlockCharacter(_Player)
THEN
DB_GLO_PartyMembers_BlockReturnToRecruitmentPosition(_Player);
DB_SCE_Debrief_RemovedPartyMembers(_Player);
PROC_GLO_PartyMembers_MakeNPC(_Player);
PROC_SCE_SendCharacterToDebrief(_Player, 0);
NOT DB_GLO_PartyMembers_BlockReturnToRecruitmentPosition(_Player);

IF
EntityEvent((CHARACTER)_Player, "SCE_Debrief_Start")
AND
NOT DB_SCE_Debrief_Participant(_Player, _, _)
AND
QRY_OnlyOnce("SCE_Debrief_Starts")
THEN
PROC_SCE_DebriefStarts();

PROC
PROC_SCE_CharacterInEpilogueHook((CHARACTER)_Char)
THEN
DB_NOOP(1);
//END_REGION

//REGION Debrief dialogues
PROC
PROC_SCE_DebriefStarts()
AND
QRY_OnlyOnce("SCE_DebriefSelected")
THEN
PROC_GlobalSetFlagAndCache((FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e);
//END_REGION

//REGION Jergal
PROC
PROC_DialogFlagSetup(SCE_Jergal_Debrief_40bfba6f-d321-0d1e-1d14-5092544d96ea, _, _)
THEN
PROC_GLO_Jergal_SetDeadPlayers();
PROC_GLO_Jergal_SetDialogVariables(SCE_Jergal_Debrief_40bfba6f-d321-0d1e-1d14-5092544d96ea);

QRY
QRY_GLO_Jergal_BlockSettingDialog()
AND
GetFlag(SCE_State_AtEpilogue_3541abb5-6aaf-48c7-bf30-5a13b3abc718, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, 1)
THEN
DB_NOOP(1);

// Move Jergal back to camp if players long rest
PROC
PROC_Camp_TeleportAllToCamp()
AND
DB_SCE_Debrief_CharactersInEpilogue((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805)
THEN
ClearFlag(SCE_State_AtEpilogue_3541abb5-6aaf-48c7-bf30-5a13b3abc718, S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
PROC_GLO_Jergal_MoveToCamp();

//Talked to Jergal in epilogue (for behaviour)
IF
FlagSet((FLAG)SCE_Jergal_HasMet_10c004a4-8408-66be-3e56-8e5ddb297af3,_,_)
AND
QRY_OnlyOnce("SCE_TalekdToJergal")
THEN
SetEntityEvent(S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805, "SCE_TalkedToJergal", 1);

//END_REGION

//REGION Debug
IF
TextEvent("SCE_RecruitJaheiraAndHalsin")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Debug_SCE_TestEndColony")
THEN
SetOnStage(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,1);
PROC_GLO_PartyMembers_Add(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player);
SetFlag((FLAG)SetPreset_Default_7eabc516-c15c-46ff-a99d-60d4a9f7037e, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0); // flagType: Object
SetOnStage(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,1);
TeleportTo(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player);
PROC_GLO_PartyMembers_Add(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player);
SetFlag((FLAG)SetPreset_Default_7eabc516-c15c-46ff-a99d-60d4a9f7037e, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 0); // flagType: Object
RealtimeObjectTimerLaunch(_Player, "Debug_SCE_TeleportHalsin", 100);

IF
ObjectTimerFinished(_Player, "Debug_SCE_TeleportHalsin")
THEN
TeleportTo(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, _Player);

IF
TextEvent("SCE_Minthara")
THEN
SysCompleteGoal("Act2_MOO_MintharaFate");
TeleportTo(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,S_SCE_MintharaPoint_b4a3e1a8-c2b2-4b30-bc47-46ca7a89229d);
PROC_Foop(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
PROC_SCE_SendCharacterToDebrief((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);

IF
TextEvent("SCE_SetupDebrief")
THEN
PROC_SCE_Debug_SetupDebrief();

IF
FlagSet((FLAG)Debug_SCE_Debrief_UnlockMinthara_66beb456-51fe-dcaf-f5a2-24ba4a88c7e7, _, _)
THEN
SetEntityEvent(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_MintharaFate_ToCamp", 1);

QRY
QRY_SCE_Debrief_BlockCharacter((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_GlobalFlag(Debug_SCE_Debrief_BlockMinthara_e3cef87a-4951-4ce9-aa1c-77a32a3dda1c)
THEN
DB_NOOP(1);

QRY
QRY_SCE_Debrief_BlockCharacter((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_GlobalFlag(Debug_SCE_Debrief_BlockJaheira_e9063240-a89f-4965-86cf-90c9377c438d)
THEN
DB_NOOP(1);

IF
DB_CurrentLevel("SCL_Main_A")
AND
DB_GlobalFlag(Debug_SCE_Setup_e917c37c-14d8-df8e-3f35-f876502d4b5a)
THEN
PROC_SCE_Debug_SetupDebrief();

PROC
PROC_SCE_Debug_SetupDebrief()
AND
QRY_OnlyOnce("Debug_SCE_SetupDebrief")
THEN
PROC_GlobalClearFlagAndCache(MOO_Assault_State_InProgress_0f3a8f5d-7402-4220-bebb-d4b21d3db08d);
PROC_SCE_DebugClearMOO();
PROC_SCE_DEBUG_SituationSpecificFlagSet();
PROC_SCE_StartSetupDebrief();
DB_OnlyOnce("SCE_Debrief_Starts");
PROC_SCE_DebriefStarts();

QRY
QRY_MOO_Assault_Skipped()
AND
DB_OnlyOnce("Debug_SCE_SetupDebrief")
THEN
DB_NOOP(1);

PROC
PROC_SCE_DebugClearMOO()
THEN
PROC_MOO_Execution_ForceResolve();

IF
DB_CurrentLevel("SCL_Main_A")
AND
DB_GlobalFlag(Debug_SCE_Epilogue_State_NightsongDead_d99668b9-b291-4877-945c-4b5b021c129d)
AND
DB_Players(_Player)
THEN
SetFlag((FLAG)SHA_NightsongPrison_Event_PermanentlyKillNightsong_097792de-6bd1-e7c9-77d3-fe6419e3170a, _Player);

IF
FlagSet(Debug_SCE_Debrief_UnlockMinthara_66beb456-51fe-dcaf-f5a2-24ba4a88c7e7, _, _)
THEN
SetFlag(MOO_MintharaFate_State_ToCamp_4e0701b1-c16d-4017-8be6-5781c3c682f4, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION Voicebarks

PROC
PROC_SCE_StartSetupDebrief()
THEN
DB_OneShot_VoiceBarkTrigger(S_SCE_PartyVB_ToBaldursGate_Trigger_9013deb2-3947-4999-9204-d42cffcbf11a,SCE_PartyVB_VB_ToBaldursGate_857f1025-3f65-d180-7423-423a8e79080e);
DB_OneShot_VoiceBarkTrigger(S_SCE_PartyVB_UnfinishedBusiness_Trigger_632ad7dc-a132-48c8-9357-6f27adb11e5e,SCE_PartyVB_VB_UnfinishedBusiness_09641221-7dd6-f9a0-e6b9-a1cfd41d7bb4);
DB_OneShot_VoiceBarkTrigger(S_SCE_PartyVB_CurseStateComment_Trigger_fa7ca051-347b-4719-91ba-c60330e355f5,SCE_PartyVB_VB_CurseStateComment_c7e6c948-f03f-135f-bd96-aeb98fa4e20a);


PROC
PROC_SCE_StartSetupDebrief()
AND
NOT DB_GlobalFlag(GLO_LiftingTheCurse_State_BreathHasBeenRestored_2113b54e-a140-4aa0-97ac-219fa7b7d038)
THEN
DB_OneShot_VoiceBarkTrigger(S_SCE_PartyVB_ShadowCurseNotLifted_Trigger_501ae20e-9ef9-435e-8d13-860fa434d056,SCE_PartyVB_VB_ShadowCurseNotLifted_beb110f3-29a1-3276-e4b4-9687a6dbfecf);

IF
FlagSet(GLO_LiftingTheCurse_State_BreathHasBeenRestored_2113b54e-a140-4aa0-97ac-219fa7b7d038,_,_)
THEN
PROC_RemoveOneShotVoiceBarkTrigger(S_SCE_PartyVB_ShadowCurseNotLifted_Trigger_501ae20e-9ef9-435e-8d13-860fa434d056,SCE_PartyVB_VB_ShadowCurseNotLifted_beb110f3-29a1-3276-e4b4-9687a6dbfecf);

//END_REGION

//REGION Item ownership

IF
FlagSet(MOO_Assault_State_InProgress_0f3a8f5d-7402-4220-bebb-d4b21d3db08d,_,_)
AND
QRY_OnlyOnce("SCE_HandleMOOItems")
THEN
PROC_SCE_HandleMOOItems();

PROC
PROC_SCE_SetupDebrief()
AND
QRY_OnlyOnce("SCE_HandleMOOItems")
THEN
PROC_SCE_HandleMOOItems();

//Clear ownership within item ownership triggers
PROC
PROC_SCE_HandleMOOItems()
AND
DB_SCE_ItemOwnership_Triggers((TRIGGER)_OwnershipTrigger)
THEN
TriggerClearItemsOwner(_OwnershipTrigger);

//END_REGION

//REGION Music 

IF
FlagSet(SCE_State_PlayerVisitedEpilogue_1c1c8a40-0862-4794-a46b-5064c54512df,_,_)
AND
QRY_OnlyOnce("SCE_MusicStart")
THEN
PROC_MusicPlayGeneral("Act2_end_Moonrise_meeting");

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
