Version 1
SubGoalCombiner SGC_AND
INITSECTION
PROC_TriggerRegisterForPlayers(S_TWN_GraveyardRaphaelSpawn_c81ceadf-5b47-4b29-ac22-e18cd7cf10d7);

SetTag(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (TAG)ACT2_SHADOW_CURSE_IMMUNE_b47643e0-583c-4808-b108-f6d3b605b0a9);

DB_GLO_CompoundFlag((FLAG)MOO_Ketheric_Knows_HasSeen_0d776dde-e2b5-447a-b41d-3dd3c025cf96, (FLAG)GLO_Ketheric_Knows_Existence_aaf551db-484c-b549-4cc6-435086ae2d86);
DB_GLO_CompoundFlag((FLAG)GLO_SCL_Ketheric_State_PlayerKnowsKethericHistory_fe5d6b69-fd1a-aeac-17d5-2887fbf61fae, (FLAG)GLO_Ketheric_Knows_Existence_aaf551db-484c-b549-4cc6-435086ae2d86);
DB_GLO_CompoundFlag((FLAG)GLO_Ketheric_Knows_AboutImmortality_6d37f35d-fcaf-4b80-97f6-e44473ef5fbb, (FLAG)GLO_Ketheric_Knows_Existence_aaf551db-484c-b549-4cc6-435086ae2d86);
DB_GLO_CompoundFlag((FLAG)GLO_Ketheric_Knows_ImmortalitySource_0e9375d2-68e3-0509-36c5-55694768dad5, (FLAG)GLO_Ketheric_Knows_Existence_aaf551db-484c-b549-4cc6-435086ae2d86);
DB_GLO_CompoundFlag((FLAG)GLO_Ketheric_Knows_KethericNotTadpoled_9ffd4bfb-d61e-964f-c011-269cd32098aa, (FLAG)GLO_Ketheric_Knows_Existence_aaf551db-484c-b549-4cc6-435086ae2d86);
KBSECTION
IF
EnteredTrigger(_Player, S_TWN_GraveyardRaphaelSpawn_c81ceadf-5b47-4b29-ac22-e18cd7cf10d7)
AND
NOT DB_State_Current((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftHaven")
AND
QRY_State_IsBeforeState((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_AFamiliarFace")
AND
NOT DB_SHA_AFamiliarFace_WaitingRaphaelPoof(1)
AND
QRY_OnlyOnce("SHA_RaphaelAtGraveyard")
THEN
DB_SHA_AFamiliarFace_WaitingRaphaelPoof(1);
PROC_HAV_MolsDeal_MonitorAbort();

IF
EnteredTrigger(_, S_TWN_GraveyardRaphaelSpawn_c81ceadf-5b47-4b29-ac22-e18cd7cf10d7)
AND
DB_State_Current((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftHaven")
AND
NOT DB_SHA_AFamiliarFace_WaitingRaphaelPoof(1)
AND
QRY_OnlyOnce("SHA_RaphaelAtGraveyard")
THEN
PROC_SHA_AFamiliarFace_InitScene();

PROC
PROC_HAV_MolsDeal_OnMonitorPoofed()
AND
DB_SHA_AFamiliarFace_WaitingRaphaelPoof(1)
THEN
NOT DB_SHA_AFamiliarFace_WaitingRaphaelPoof(1);
PROC_SHA_AFamiliarFace_InitScene();

PROC
PROC_SHA_AFamiliarFace_InitScene()
AND
IsDead(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 1)
THEN
Resurrect(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

PROC
PROC_SHA_AFamiliarFace_InitScene()
THEN
PROC_State_Progress((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_AFamiliarFace");
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);
PROC_TriggerUnregisterForPlayers(S_TWN_GraveyardRaphaelSpawn_c81ceadf-5b47-4b29-ac22-e18cd7cf10d7);
TeleportTo(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, S_SHA_RaphaelPoint_f3af0429-1d3f-4d31-bf75-bfd6e2561cf4, "SHA_MoveRaphaelToTemple", 1, 1, 1);

IF
EntityEvent(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_MoveRaphaelToTemple")
AND
DB_State_Current(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_AFamiliarFace")
THEN
DB_Dialogs((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (DIALOGRESOURCE)SHA_Raphael_b2456297-525e-fff7-e72b-7da3da48995a);
DB_DropMutingStatussesDialog(SHA_Raphael_b2456297-525e-fff7-e72b-7da3da48995a);
SetFlag((FLAG)SHA_OrthonsLair_State_RaphaelAtTemple_3b3a1869-54e0-45c9-bdc7-b548febbe291, NULL_00000000-0000-0000-0000-000000000000);
PROC_GLO_Monitor_Foop();
DB_SpotPlayers((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_RaphaelAtGraveyard", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_RaphaelAtGraveyard", (TRIGGER)S_SHA_RaphaelGraveyardDialogTrigger_4a167728-e20e-4b85-aa4a-9571c1737409);
DB_SpotPlayers_IncludeWildshapedPlayers(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_RaphaelAtGraveyard");
DB_SceneManager(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_RaphaelAtGraveyard");
DB_SceneTriggerManager("SHA_RaphaelAtGraveyard", S_TWN_RaphaelAtGraveyardScene_ddcf2f64-19bf-4cd6-816f-eddd36f8b8af);

PROC
PROC_SpotPlayers_Spotted(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_RaphaelAtGraveyard", _Player)
AND
QRY_SHA_Raphael_ReplaceSpeakerWithAstarionAvatar(_Player)
AND
DB_QRYRTN_SHA_Raphael_DialogSpeaker(_Speaker)
AND
QRY_StartDialog(SHA_Raphael_b2456297-525e-fff7-e72b-7da3da48995a, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _Speaker)
THEN
DB_NOOP(1);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (CHARACTER)_Player)
AND
DB_State_Current(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_AFamiliarFace")
AND
QRY_SHA_Raphael_ReplaceSpeakerWithAstarionAvatar(_Player)
AND
DB_QRYRTN_SHA_Raphael_DialogSpeaker(_Speaker)
THEN
DB_SelectedDialog((DIALOGRESOURCE)SHA_Raphael_b2456297-525e-fff7-e72b-7da3da48995a, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _Speaker);

QRY
QRY_SHA_Raphael_ReplaceSpeakerWithAstarionAvatar((CHARACTER)_Player)
AND
_Player != S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255
AND
DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_CantTalk(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_HiddenCharacters(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _)
AND
GetDistanceTo(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Distance)
AND
_Distance <= 25.0
THEN
DB_QRYRTN_SHA_Raphael_DialogSpeaker((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

// didn't find Astarion - use the default player
QRY
QRY_SHA_Raphael_ReplaceSpeakerWithAstarionAvatar((CHARACTER)_Player)
AND
NOT DB_QRYRTN_SHA_Raphael_DialogSpeaker(_)
THEN
DB_QRYRTN_SHA_Raphael_DialogSpeaker((CHARACTER)_Player);

IF
DialogStarted(SHA_Raphael_b2456297-525e-fff7-e72b-7da3da48995a, _)
THEN
PROC_SpotPlayers_StopSpotting(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_RaphaelAtGraveyard");

IF
DialogEnded(SHA_Raphael_b2456297-525e-fff7-e72b-7da3da48995a, _)
THEN
PROC_SceneOver("SHA_RaphaelAtGraveyard");
PROC_State_Progress((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftGraveyard");

PROC
PROC_SceneInterrupted(_, _, "SHA_RaphaelAtGraveyard", _Interruption)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Interruption)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)SHA_FamiliarFace_AD_MonitorLeaves_75abe47d-8e36-e8a1-9924-3ee6de2b5342, (CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8)
THEN
PROC_GlobalSetFlagAndCache((FLAG)GLO_Monitor_State_AttackedMonitor_355730d6-4035-4918-888e-dbbefea1b6c3);
PROC_SceneOver("SHA_RaphaelAtGraveyard");
PROC_State_Progress((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftGraveyard");

IF
AutomatedDialogEnded((DIALOGRESOURCE)SHA_FamiliarFace_AD_MonitorLeaves_75abe47d-8e36-e8a1-9924-3ee6de2b5342, _)
THEN
PROC_GlobalSetFlagAndCache((FLAG)GLO_Monitor_State_AttackedMonitor_355730d6-4035-4918-888e-dbbefea1b6c3);
PROC_SceneOver("SHA_RaphaelAtGraveyard");
PROC_State_Progress((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftGraveyard");

PROC
PROC_State_Changed(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_AFamiliarFace", _)
THEN
PROC_SceneOver("SHA_RaphaelAtGraveyard");

PROC
PROC_State_Changed(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", _, "GLO_Monitor_LeftGraveyard")
THEN
PROC_GLO_Monitor_Poof();

//REGION Custom permadefeated
// We need to catch the Orthon when he is permadefeated, but since he can't be permadefeated because we need him in act 3 we need to do our custom permadefeated checks for the Orthon.
IF
DB_Dead((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_CanBeResurrected(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_PermaDefeated((GUIDSTRING)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
THEN
PROC_State_Progress((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftAct2");

IF
DB_KnockedOut((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_PermaDefeated((GUIDSTRING)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_PreventKnockedOutPermaDefeated((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
// If they can be resurrected, they can also be helped up again
NOT DB_CanBeResurrected((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
THEN
PROC_State_Progress((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftAct2");

IF
DB_KnockedOut((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_PermaDefeated((GUIDSTRING)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_PreventKnockedOutPermaDefeated((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
// If they can be resurrected, they can also be helped up again
NOT DB_CanBeResurrected((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
HasAppliedStatus(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,"KNOCKED_OUT_TEMPORARILY",0)
THEN
PROC_State_Progress((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftAct2");
//END_REGION 

PROC
PROC_SceneOver("SHA_RaphaelAtGraveyard")
AND
DB_GlobalFlag(SHA_AFamiliarFace_State_RaphaelAtGraveyard_3b3a1869-54e0-45c9-bdc7-b548febbe291)
THEN
PROC_SpotPlayers_StopSpotting(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_RaphaelAtGraveyard");
ClearFlag(SHA_AFamiliarFace_State_RaphaelAtGraveyard_3b3a1869-54e0-45c9-bdc7-b548febbe291, NULL_00000000-0000-0000-0000-000000000000);
PROC_ForceStopDialog(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);
SetFlag((FLAG)ORI_Astarion_State_RaphaelLeftMasoleumEntrance_ee881edf-2d4d-40a2-a6f1-c790a01c9ed5);

PROC
PROC_GLO_Monitor_DebugStateReset()
AND
QRY_OnlyOnce_Reset("SHA_RaphaelAtGraveyard")
THEN
PROC_TriggerRegisterForPlayers(S_TWN_GraveyardRaphaelSpawn_c81ceadf-5b47-4b29-ac22-e18cd7cf10d7);

PROC
PROC_State_Changed(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", _, "GLO_Monitor_SharessCaress")
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
