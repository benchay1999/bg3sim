Version 1
SubGoalCombiner SGC_AND
INITSECTION
//DB_TWN_TollCollectorBoss_Data(_Face,_ArmorPart,_Status,_Bone,_DebugText)
DB_TWN_TollCollectorBoss_Data(1, (CHARACTER)S_TWN_Tollhouse_Face_Greed_46e0f41a-6603-43ee-8e99-5dd91e7e9bb9,(ITEM)ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Arm_L_496c95a5-8262-4cce-ae83-d25e820cca03, "TWN_TOLLHOUSE_BUFF_01", "Shoulder_L", (ANIMATION)REAC_Hit_F_Combat_01_ArmL_5aa350d4-c9bd-45d2-a499-ee1acb6a27e4, "Left Arm removed!");
DB_TWN_TollCollectorBoss_Data(2, S_TWN_Tollhouse_Face_Guilt_2321affc-6302-4800-87dc-bcd220642920,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Arm_R_4bd6813f-6267-4ed8-8c4a-d7cec7a61fcb, "TWN_TOLLHOUSE_BUFF_02", "Shoulder_R", REAC_Hit_F_Combat_01_ArmR_8f313389-30c6-44b2-816f-44df1688ee99, "Right Arm removed!");
DB_TWN_TollCollectorBoss_Data(3, S_TWN_Tollhouse_Face_Obedience_0e35df6f-31f8-4ebb-a44f-e472c2e6a9c9,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Leg_L_82c1d274-2914-4d21-a3e4-0f33d68834c9, "TWN_TOLLHOUSE_BUFF_03", "Knee_L", REAC_Hit_F_Combat_01_LegL_7ba1d90d-c92f-42bc-a8ba-8ee5dd2e103a, "Left Leg removed!");
DB_TWN_TollCollectorBoss_Data(4, S_TWN_Tollhouse_Face_Regret_f5206c52-e481-4c2c-b24b-f186904d768d,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Leg_R_905104ed-38cb-48a9-b806-573ff6797678, "TWN_TOLLHOUSE_BUFF_04", "Knee_R", REAC_Hit_F_Combat_01_LegR_7745e0bf-5961-438a-a5dc-b16538cc2645, "Right Leg removed!");
DB_TWN_TollCollectorBoss_Data(5, S_TWN_Tollhouse_Face_Heartlessness_f335ce62-1d8b-4f70-969d-ef75f0dd78b1,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Torso_3a84fbd5-766f-429c-af5c-b135c39be5ce, "TWN_TOLLHOUSE_BUFF_05", "Chest_M", REAC_Hit_F_Combat_01_Torso_47741175-1716-4e70-8006-78b693a07478, "Chest removed!");
DB_TWN_TollCollectorBoss_Data(6, S_TWN_Tollhouse_Face_Cowardice_efea0b12-68eb-4329-8fd9-14078e983607,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Head_be826b2a-6fd2-4183-a049-bcb9f3b1a99c, "TWN_TOLLHOUSE_BUFF_06", "Head_M", REAC_Hit_F_Combat_01_Head_b568aa07-de7e-4737-90b4-0f252613bdef, "Head removed!");

//armor parts must be equipped through Osiris
Equip(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Head_be826b2a-6fd2-4183-a049-bcb9f3b1a99c);
Equip(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Arm_L_496c95a5-8262-4cce-ae83-d25e820cca03);
Equip(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Arm_R_4bd6813f-6267-4ed8-8c4a-d7cec7a61fcb);
Equip(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Torso_3a84fbd5-766f-429c-af5c-b135c39be5ce);
Equip(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Leg_L_82c1d274-2914-4d21-a3e4-0f33d68834c9);
Equip(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,ITEMGUID_S_QUEST_TWN_TollCollector_ArmorPart_Leg_R_905104ed-38cb-48a9-b806-573ff6797678);

ApplyStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_06",-1.0);	//have to do this in this order
ApplyStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_05",-1.0);
ApplyStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_04",-1.0);
ApplyStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_03",-1.0);
ApplyStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_02",-1.0);
ApplyStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_01",-1.0);

PROC_DeclareCounter("DB_TWN_TollCollectorBoss_NextBuffToRemove"); // 0 by default
PROC_IncreaseCounter("DB_TWN_TollCollectorBoss_NextBuffToRemove"); // now it is 1, the first buff

// Combat NPC Reactivity
DB_CombatReact_AD_StatusRemoved(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, (DIALOGRESOURCE)TWN_Tollhouse_AD_TollhouseMaster_Buff_001_Combat_145f5689-495d-a178-cf11-113d6836a63b, "TWN_TOLLHOUSE_BUFF_01");
DB_CombatReact_AD_StatusRemoved(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, (DIALOGRESOURCE)TWN_Tollhouse_AD_TollhouseMaster_Buff_002_Combat_879d557b-b65e-a541-a32e-1157c91786ad, "TWN_TOLLHOUSE_BUFF_02");
DB_CombatReact_AD_StatusRemoved(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, (DIALOGRESOURCE)TWN_Tollhouse_AD_TollhouseMaster_Buff_003_Combat_0812bccd-d90f-5bd0-319f-20116928f3ee, "TWN_TOLLHOUSE_BUFF_03");
DB_CombatReact_AD_StatusRemoved(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, (DIALOGRESOURCE)TWN_Tollhouse_AD_TollhouseMaster_Buff_004_Combat_b9fb2041-eae7-ccdc-e62f-90a773bdea99, "TWN_TOLLHOUSE_BUFF_04");
DB_CombatReact_AD_StatusRemoved(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, (DIALOGRESOURCE)TWN_Tollhouse_AD_TollhouseMaster_Buff_005_Combat_532ad210-2233-c76b-f61a-477f69f45ea1, "TWN_TOLLHOUSE_BUFF_05");
DB_CombatReact_AD_StatusRemoved(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, (DIALOGRESOURCE)TWN_Tollhouse_AD_TollhouseMaster_Buff_006_Combat_06c6c25d-7309-161a-76e2-8b53b64aa68a, "TWN_TOLLHOUSE_BUFF_06");
DB_CombatReact_AD_AppliedStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, (DIALOGRESOURCE)TWN_Tollhouse_AD_TollhouseMaster_Vulnerable_Combat_10c50570-b886-4a77-fe19-5a6b0a3dc588, "TWN_TOLLHOUSE_VULNERABLE");
KBSECTION
//REGION attacking TC manually OR by destroying a face
IF
StatusRemoved(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,_Status,_,_)
AND
DB_TWN_TollCollectorBoss_Data(_BuffNumber,_Face,_ArmorPart,_Status,_Bone, _Animation, _DebugText)
THEN
PROC_TWN_TryPlayHitAnimationOnTollCollector(_Animation);
Unequip(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,_ArmorPart);
Die(_ArmorPart);
PlayEffect(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,VFX_Actions_Cast_WeaponAttack_Impact_DuergarRaftHammerExplosion_01_63c1abba-7738-b3d6-fe36-0533e1e8e147,_Bone,1.0); //replace with dedicated VFX
DebugText(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, _DebugText);
PROC_IncreaseCounter("DB_TWN_TollCollectorBoss_NextBuffToRemove");

PROC
PROC_TWN_TryPlayHitAnimationOnTollCollector((ANIMATION)_Animation)
AND
HasActiveStatusWithGroup((CHARACTER)S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "SG_Prone", 0)
AND
HasActiveStatusWithGroup((CHARACTER)S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "SG_Incapacitated", 0)
AND
HasActiveStatusWithGroup((CHARACTER)S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "SG_Unconscious", 0)
AND
HasActiveStatusWithGroup((CHARACTER)S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "SG_Stunned", 0)
AND
HasActiveStatusWithGroup((CHARACTER)S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "SG_Paralyzed", 0)
AND
HasActiveStatusWithGroup((CHARACTER)S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "SG_Petrified", 0)
THEN
PlayAnimation(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,_Animation,""); //CHANGE THIS WHEN NEW MODEL
//END_REGION

//REGION attacking TC by killing faces removes the status which triggers the scripting above
IF
Dying(_Face)
AND
DB_TWN_TollCollectorBoss_Data(_, _Face, _, _, _, _, _)
AND
QRY_TWN_TollCollectorBoss_HasBuffToRemove()
AND
GetPosition(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, _X, _Y, _Z)
AND
RealSum(_X,2.0,_XOffset)
AND
CreateAt(QUEST_TWN_TollCollector_Reward_88f58d6f-2907-49b2-9c5f-8dc10a9013c1,_XOffset, _Y, _Z, 0, 0, "", _)
THEN
PlayEffectAtPosition(VFX_Environment_Fireworks_Explosion_03_023ebfb0-8067-8cd5-0237-82d9e8bb3922,_XOffset,_Y,_Z,1.0);

IF
Dying(_Face)
AND
DB_TWN_TollCollectorBoss_Data(_, _Face, _, _, _, _, _)
AND
QRY_TWN_TollCollectorBoss_HasBuffToRemove()
THEN
PROC_TWN_TollCollectorBoss_RemoveNextBuff();

PROC
PROC_TWN_TollCollectorBoss_RemoveNextBuff()
AND
DB_GlobalCounter("DB_TWN_TollCollectorBoss_NextBuffToRemove", _NextBuff)
AND
DB_TWN_TollCollectorBoss_Data(_NextBuff,_Face,_ArmorPart,_Status,_Bone, _Animation, _DebugText)
THEN
RemoveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, _Status, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_TWN_TollCollectorBoss_HasBuffToRemove()
AND
DB_GlobalCounter("DB_TWN_TollCollectorBoss_NextBuffToRemove", _NextBuff)
AND
DB_TWN_TollCollectorBoss_Data(_NextBuff, _, _, _, _, _Animation, _DebugText)
THEN
DB_NOOP(1);
//END_REGION

//REGION all armor parts lost but one
IF
StatusRemoved(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,_Status,_,_)
AND
DB_TWN_TollCollectorBoss_Data(_, _, _, _Status, _, _, _)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_VULNERABLE",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_01",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_02",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_03",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_04",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_05",0)
THEN
DebugText(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "VULNERABLE!");
ApplyStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "TWN_TOLLHOUSE_VULNERABLE", -1.0);
//END_REGION

//REGION all armor parts lost!
IF
StatusRemoved(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,_Status,_,_)
AND
DB_TWN_TollCollectorBoss_Data(_, _, _, _Status, _, _, _)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_01",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_02",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_03",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_04",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_05",0)
AND
HasActiveStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TWN_TOLLHOUSE_BUFF_06",0)
THEN
DebugText(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "ALL ARMOR LOST!");
RemovePassive(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,"TollCollector_Armor");
ApplyStatus(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06, "TWN_TOLLHOUSE_TECHNICAL_NOHELMET",-1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION gold lances
IF
StatusApplied((ITEM)_Item,"GOLD_SCAN_AURA_TOLLCOLLECTOR_FLAGGED",S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,_)
AND
GetTemplate(_Item,LOOT_Gold_A_1c3c9c74-34a1-4685-989e-410dc080be6f)
AND
IsTagged(_Item,(TAG)LOOT_GOLD_6c6b7cac-113c-42ee-bc46-05567b067a9f,1)
THEN
AiAddInterestingItem(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,_Item);

IF
StatusRemoved((ITEM)_Item,"GOLD_SCAN_AURA_TOLLCOLLECTOR_FLAGGED",_,_)
THEN
AiRemoveInterestingItem(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06,_Item);

/* commented out because destroying the player's whole stash of gold seems needlessly punishing - Ed 10/5/23
IF
StatusApplied((ITEM)_Item,"TWN_TOLLHOUSE_GOLD_KILL",_,_) //system status for when the TC uses gold to summon gold lances
AND
GetTemplate(_Item,LOOT_Gold_A_1c3c9c74-34a1-4685-989e-410dc080be6f)
AND
IsTagged(_Item,(TAG)LOOT_GOLD_6c6b7cac-113c-42ee-bc46-05567b067a9f,1)
THEN
Die(_Item);
*/

IF 
CastedSpell((CHARACTER)_Character,"Rush_GoldenLance",_,_,_)
AND
_Character != NULL_00000000-0000-0000-0000-000000000000
AND
IsCharacter((CHARACTER)_Character, 1)
THEN
Die((CHARACTER)_Character,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,0,1);
//END_REGION

IF 
DB_PermaDefeated(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06)
AND
DB_TWN_TollCollectorBoss_Data(_BuffNumber,_Face,_ArmorPart,_Status,_Bone, _Animation, _DebugText)
THEN
NOT DB_TWN_TollCollectorBoss_Data(_BuffNumber,_Face,_ArmorPart,_Status,_Bone,_Animation,_DebugText);

IF 
DB_PermaDefeated(S_TWN_Tollhouse_TollhouseMaster_3b460226-8ca2-4bbc-9bd7-8bb947aa2c06)
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act2"
