Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION In-Camp Abduction related
DB_CampNight((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92, 3990);
DB_CampNight_Camp((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92, "ELFSONG");
DB_CampNight_Camp((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92, "FARM");

DB_CampNight_Requirement((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92, (FLAG)LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75);
DB_CampNight_ExclusiveMoment((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92);
DB_CampNight_CFM((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92, (DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000); // defined later because it depends on which character was chosen.
DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec);

NOT DB_GEN_OrinsAbduction_CFM_Orin((DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GEN_OrinsAbduction_ChosenCharFlag((FLAG)NULL_00000000-0000-0000-0000-000000000000);

DB_GEN_OrinsAbduction_AbducteeList("Laezel",	(CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,						CAMP_OrinAbduction_CFM_Laezel_23ce00ef-2178-950c-42bf-30f4e6cba0d9);
DB_GEN_OrinsAbduction_AbducteeList("Halsin",	(CHARACTER)S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323,							CAMP_OrinAbduction_CFM_Halsin_35d0f127-5932-65a5-241c-d97b2d6a7ebc);
DB_GEN_OrinsAbduction_AbducteeList("Gale",		(CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,							CAMP_OrinAbduction_CFM_Gale_9b6d59ec-165e-5bf1-7219-0ef7b02e3c63);
DB_GEN_OrinsAbduction_AbducteeList("Minthara",	(CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,					CAMP_OrinAbduction_CFM_Minthara_c5574476-5235-147f-d7e7-b021abfd0891);
DB_GEN_OrinsAbduction_AbducteeList("Yenna",		(CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f,							CAMP_OrinAbduction_CFM_Yenna_eee61c9f-3d9c-86bf-06bf-d0eec00df54d); // No valid companions, Atrocity will occur, everyone in slaughterlist will be killed.

DB_GEN_OrinsAbduction_OrinAbductionPosList("SLUMS", 	(TRIGGER)S_LOW_BhaalTemple_OrinAbduction_TriggerPos_8443fa4f-37b7-43ea-b99d-331d85ede8c5);
DB_GEN_OrinsAbduction_OrinAbductionPosList("ELFSONG", 	(TRIGGER)S_LOW_BhaalTemple_OrinAbduction_Elfsong_TriggerPos_332e7105-d4e3-40ed-a45f-32f223d40d34);
DB_GEN_OrinsAbduction_OrinAbductionPosList("FARM",		(TRIGGER)S_WYR_OrinsImpersonation_OrinAbduction_PosTrigger_5547f7f9-860f-4d5f-a523-e75553c2a5b4);

DB_GEN_OrinsAbduction_AbductionCamp("SLUMS",			(FLAG)GLO_OrinsAbduction_State_AbductionOccured_Slums_b63ceee7-ac3f-4d8e-a696-88a1996d5d69);
DB_GEN_OrinsAbduction_AbductionCamp("ELFSONG",			(FLAG)GLO_OrinsAbduction_State_AbductionOccured_Elfsong_f815b894-0a28-40a9-aba7-b59418311eaa);
DB_GEN_OrinsAbduction_AbductionCamp("FARM",				(FLAG)GLO_OrinsAbduction_State_AbductionOccured_Farm_2a32cb87-e14b-49d3-ad6b-88016d8bc137);

DB_GEN_OrinsAbduction_MintharaAbduction("Wyll",			(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,			(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Wyll_15dc3800-05ec-45e6-897e-ee66aca70b1f);
DB_GEN_OrinsAbduction_MintharaAbduction("Karlach",		(CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c,		(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Karlach_f278e183-10af-45cf-958c-f24200138f5c);
DB_GEN_OrinsAbduction_MintharaAbduction("Jaheira",		(CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,		(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Jaheira_9e4847ab-966f-4d07-8398-1ec886ee53d0);
DB_GEN_OrinsAbduction_MintharaAbduction("Isobel",		(CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,			(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Isobel_80ae2d20-30de-46ae-a5f6-cc22f7dd55c3);
DB_GEN_OrinsAbduction_MintharaAbduction("Gale",			(CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604,			(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Gale_a7e0ca7b-473c-453c-a4a8-234fdcbf07d0);
DB_GEN_OrinsAbduction_MintharaAbduction("Astarion",		(CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255,		(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Astarion_88ca535b-adc4-436d-89f1-8beb1e8295ef);
DB_GEN_OrinsAbduction_MintharaAbduction("Shadowheart",	(CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,	(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Shadowheart_8a6f7e4d-3641-475a-b6ad-d4d7a746633f);
DB_GEN_OrinsAbduction_MintharaAbduction("Laezel",		(CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12,		(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Laezel_d01891a9-d41b-4822-9a6a-272c3aedbaa1);
DB_GEN_OrinsAbduction_MintharaAbduction("Nightsong",	(CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,		(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Nightsong_44d09961-71ed-47d7-938b-d2c6c6608146);
DB_GEN_OrinsAbduction_MintharaAbduction("Minsc",		(CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,			(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Minsc_d7821983-3c6e-4c1a-90ac-bb0109d62162);
DB_GEN_OrinsAbduction_MintharaAbduction("Ravengard",	(CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,		(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Ravengard_7207cf7d-85cf-43ed-85af-f4177d8dfea5);
DB_GEN_OrinsAbduction_MintharaAbduction("Yenna",		(CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f,			(FLAG)LOW_BhaalTemple_MintharaAbduction_IsAvailable_Yenna_0f3da579-792b-4df1-b9e7-8653726a0090);

DB_GEN_OrinsAbduction_DummyAsylumPos("BGO_Main_A", (TRIGGER)S_GLO_OrinsImpersonation_OrinDummy_HomePos_2eb2b9f8-45ab-47f9-9472-a80e13a7b87c);
DB_GEN_OrinsAbduction_DummyAsylumPos("CTY_Main_A", (TRIGGER)S_GLO_BhaalTemple_OrinDummy_HomePos_2e6a713a-19f4-45cf-aaa1-422d4e7d51d5);

//END_REGION

//REGION Used by both In-Camp and In-World Abductions
NOT DB_GEN_OrinsAbduction_ChosenCharRelationship((FLAG)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

DB_GEN_OrinsAbduction_PartneredList("Laezel",		(FLAG)ORI_State_PartneredWithLaezel_d169a786-6e56-4f0d-a2eb-33c48d8d1160);
DB_GEN_OrinsAbduction_PartneredList("Halsin",		(FLAG)ORI_State_PartneredWithHalsin_7b53fe60-bb16-48a9-ae5c-9bce1dfac1a9);
DB_GEN_OrinsAbduction_PartneredList("Halsin",		(FLAG)ORI_State_PartneredWithHalsinSecondary_6af0be74-d032-4a20-876a-11bab5f86db2);
DB_GEN_OrinsAbduction_PartneredList("Gale",			(FLAG)ORI_State_PartneredWithGale_e008e20d-d642-42ed-9008-297b6273aa21);
DB_GEN_OrinsAbduction_PartneredList("Minthara",		(FLAG)ORI_State_PartneredWithMinthara_39ac48fa-b440-47e6-a436-6dc9b10058d8);

DB_GEN_OrinsAbduction_AbducteeFlagList("Laezel",	(FLAG)LOW_BhaalTemple_State_WasAbductedLaezel_2f0ad86d-e4c7-47f9-bb8b-bb7b8f3ebc40);
DB_GEN_OrinsAbduction_AbducteeFlagList("Halsin",	(FLAG)LOW_BhaalTemple_State_WasAbductedHalsin_0265b4a7-cf01-4543-ac34-2a76da85d674);
DB_GEN_OrinsAbduction_AbducteeFlagList("Gale",		(FLAG)LOW_BhaalTemple_State_WasAbductedGale_74d236e1-eff9-4b73-a6e7-4e6402d5c84c);
DB_GEN_OrinsAbduction_AbducteeFlagList("Minthara",	(FLAG)LOW_BhaalTemple_State_WasAbductedMinthara_d1e51161-8462-4333-8676-74b4d0384054);
DB_GEN_OrinsAbduction_AbducteeFlagList("Yenna",		(FLAG)LOW_BhaalTemple_State_WasAbductedYenna_ff8e1e49-dcb0-4671-a747-dce5c704207b);

DB_GEN_OrinsAbduction_AbducteeGender("Laezel",		(FLAG)LOW_BhaalTemple_State_AbducteeIsFemale_844c25f6-51f5-a806-8e41-9a97942a6e0a);
DB_GEN_OrinsAbduction_AbducteeGender("Halsin",		(FLAG)LOW_BhaalTemple_State_AbducteeIsMale_2adc8613-1948-93da-82eb-e31f440275e2);
DB_GEN_OrinsAbduction_AbducteeGender("Gale",		(FLAG)LOW_BhaalTemple_State_AbducteeIsMale_2adc8613-1948-93da-82eb-e31f440275e2);
DB_GEN_OrinsAbduction_AbducteeGender("Minthara",	(FLAG)LOW_BhaalTemple_State_AbducteeIsFemale_844c25f6-51f5-a806-8e41-9a97942a6e0a);
DB_GEN_OrinsAbduction_AbducteeGender("Yenna",		(FLAG)LOW_BhaalTemple_State_AbducteeIsFemale_844c25f6-51f5-a806-8e41-9a97942a6e0a);
//END_REGION

//REGION Orin's ShapeShiftRule 
//DB_GEN_OrinsAbduction_OrinTransformRule_Common(		(SHAPESHIFTRULE)DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);
DB_GEN_OrinsAbduction_OrinTransformRule_Common(		(SHAPESHIFTRULE)WYR_OrinsImpersonation_79876d09-46c3-4025-96ce-db6969f249f0);

//DB_GEN_OrinsAbduction_OrinTransformRule_DarkUrge(	(SHAPESHIFTRULE)DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);
//DB_GEN_OrinsAbduction_OrinTransformRule_DarkUrge(	(SHAPESHIFTRULE)DISGUISE_WITH_CUSTOM_LOOKS_8194cfb6-4199-46d2-9027-613c302352aa);
DB_GEN_OrinsAbduction_OrinTransformRule_DarkUrge(	(SHAPESHIFTRULE)LOW_Orin_DarkUrge_e952d634-682a-4c12-b8da-e8a8fad39048);

DB_GEN_OrinsAbduction_OrinTransformRule_Gortash(	(SHAPESHIFTRULE)DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);

//DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763
//DISGUISE_WITH_CUSTOM_LOOKS_8194cfb6-4199-46d2-9027-613c302352aa
//END_REGION

//REGION Speak with Dead 
DB_GLO_CharacterCorpseDialog((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (DIALOGRESOURCE)LOW_BhaalTemple_PostLaezelAbduction_Yenna_Dead_3cf0d490-7e9d-6cb5-2943-a6a6b5f4b837);
//END_REGION

//REGION TODO: Move to Orin-s personal goal
DB_GLO_Orin_KnowsLocationFlags((FLAG)LOW_BhaalTemple_Knows_TempleIsBhaalTemple_b1525a1c-829e-4c05-bc39-c161e30ac235);
DB_GLO_Orin_KnowsLocationFlags((FLAG)LOW_MurderTribunal_Knows_BhaalTempleLocation_0a45cd29-8ae1-43bb-9ef6-b95af1dc6e55);
DB_GLO_Orin_KnowsLocationFlags((FLAG)LOW_BhaalTemple_State_SeenBhaalAltar_9a6db3ce-ddb0-4288-b419-a521b6a63004);
//END_REGION

PROC_GEN_OrinsAbduction_Orin_Init();
PROC_GEN_OrinsAbduction_InCampAbductions_Disable(); // becomes true only when Gortash spoke to players, or he was killed before they spoke to him.
PROC_GEN_OrinsAbduction_InWorldAbductions_Init();
PROC_GEN_OrinsAbduction_InWorldImpersonations_Init();
KBSECTION
/*
//REGION Debug Partial Script Restore
PROC
PROC_Debug_ActRestored((STRING)_Act, (STRING)_Level)
THEN
PROC_Debug_WYR_OrinsImpersonation_Impersonations_KillOff();

// if someone was impersonated, kill them off and send them to Bhaal Temple.
PROC
PROC_Debug_WYR_OrinsImpersonation_Impersonations_KillOff()
AND
DB_WYR_OrinsImpersonation_WorldImpersonationList(_ImpName, _, _, _ImpChar)
AND
DB_WYR_OrinsImpersonation_WorldImpersonationDeathFlag(_ImpName, _DeathFlag)
AND
DB_GlobalFlag((FLAG)_DeathFlag)
AND
DB_WYR_OrinsImpersonation_PostOrinDeathPos(_ImpName, _ImpPostOrinTrig)
THEN
SetVisible((CHARACTER)_ImpChar, 1);
Die(_ImpChar,DEATHTYPE.DoT,1);
TeleportTo((CHARACTER)_ImpChar, _ImpPostOrinTrig, "", 0, 0, 0, 0, 0);
//END_REGION
*/

//REGION Orin's Titles
PROC
PROC_GEN_OrinsAbduction_Orin_SaveTitle()
AND
ObjectGetTitle(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _TranslatedStringKey)
AND
ResolveTranslatedString(_TranslatedStringKey, _TranslatedString)
THEN
DB_GEN_OrinsAbduction_Orin_SavedTitle(_TranslatedStringKey, _TranslatedString);

PROC
PROC_GEN_OrinsAbduction_Orin_RestoreTitle()
AND
DB_GEN_OrinsAbduction_Orin_SavedTitle(_TranslatedStringKey, _TranslatedString)
THEN
ObjectSetTitleHidden(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0);

PROC
PROC_GEN_OrinsAbduction_Orin_ClearTitle()
THEN
ObjectSetTitleHidden(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 1);

// Every time Orin needs to teleport somewhere to impersonate someone, we clear her title (after a delay)
IF
EntityEvent(_, "GEN_OrinsAbduction_OrinTeleported")
THEN
PROC_GEN_OrinsAbduction_Orin_ClearTitle();

// Clear her title on loaded savegame because code restores it.
IF
SavegameLoaded()
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2) // if Orin is in the temple, then don't need to clear her title anymore.
AND
NOT DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
PROC_GEN_OrinsAbduction_Orin_ClearTitle();
//END_REGION


//REGION TODO: Move to Orin-s personal goal
IF
FlagSet(_Flag,_,_)
AND
DB_GLO_Orin_KnowsLocationFlags(_Flag)
AND
NOT DB_GlobalFlag((FLAG)GLO_Orin_Knows_OrinLocation_72767edb-8b64-4337-5159-7535315cee0f)
THEN
PROC_GlobalSetFlagAndCache((FLAG)GLO_Orin_Knows_OrinLocation_72767edb-8b64-4337-5159-7535315cee0f);
//END_REGION





//REGION Init Orin
PROC
PROC_GEN_OrinsAbduction_Orin_Init()
THEN
DB_PermaDefeatedFlag(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, GLO_Orin_State_PermaDefeated_c716e4d9-e6ed-445c-a710-ee4d91c67298);
SetOnStage((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 1);
CopyCharacterEquipment((CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); //copy over Orin's Equipment (assuming combat had set up a unique EQ), so we can copy it back to her later.)
SetImmortal(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 1);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)WYR_OrinsImpersonation_LINE_OrinAttacked_54169b5d-e726-4f5f-6211-f583081f26ff);
DB_DialogBlockAttackButton((DIALOGRESOURCE)WYR_OrinsImpersonation_LINE_OrinAttacked_54169b5d-e726-4f5f-6211-f583081f26ff);
DB_DialogBlockTradeButton((DIALOGRESOURCE)WYR_OrinsImpersonation_LINE_OrinAttacked_54169b5d-e726-4f5f-6211-f583081f26ff);
DB_GLO_DefeatCounter(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "LOW_BhaalTemple_CombatWin_Counter");
SetFaction((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (FACTION)ACT3_LOW_BhaalTemple_Cultists_d0c6137f-2da9-480a-80ae-8325ea8ebd0e); // set a faction with other Bhaal cultists for non-DU players.
PROC_GEN_OrinsAbduction_Orin_SaveTitle();

QRY
QRY_GEN_OrinsAbduction_HasDarkUrgeChar() // check if part of the team
AND
DB_GlobalFlag((FLAG)GLO_Origin_PartOfTheTeam_DarkUrge_fbf4c4a8-99bb-4e62-a78c-cc9c115bd938)
THEN
DB_NOOP(1);
//END_REGION

//REGION Orin's Bhaal Temple Teleportation Ring - Give Orin her ring.
// Ring already exists in the world, placed in Scripters' asylum
PROC
PROC_GEN_OrinsAbduction_GiveOrinRing()
AND
IsInInventoryOf((ITEM)S_GLO_Orin_TeleportRing_b9ed80b2-cedd-4008-a0d9-7ccf016a7bbf, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0) // check if she DOESN'T have the ring already.
THEN
Equip((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (ITEM)S_GLO_Orin_TeleportRing_b9ed80b2-cedd-4008-a0d9-7ccf016a7bbf); // equip it so it can't be pickpocketed. Only if she dies players will see it.
//END_REGION

//REGION Orin's Bhaal Dagger WITHOUT Netherstone in pommel
// Give the Dagger to Target's inventory.
PROC
PROC_GEN_OrinsAbduction_GiveDagger_WithoutNetherstone((CHARACTER)_TargetChar)
AND
IsInInventoryOf((ITEM)S_GLO_Orin_Bhaalist_Dagger_51c312d5-ce5e-4f8c-a5ad-edc2beced3e6, (CHARACTER)_TargetChar, 0) // check if she DOESN'T have the dagger already.
THEN
ToInventory((ITEM)S_GLO_Orin_Bhaalist_Dagger_51c312d5-ce5e-4f8c-a5ad-edc2beced3e6, (CHARACTER)_TargetChar, 1, 0, 1);
//END_REGION

//REGION Orin's Bhaal Dagger WITH Netherstone in pommel
PROC
PROC_GEN_OrinsAbduction_GiveDagger_WithNetherstone((CHARACTER)_TargetChar)
AND
IsInInventoryOf((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, (CHARACTER)_TargetChar, 0) // check if she DOESN'T have the dagger already.
AND
NOT DB_GEN_OrinsAbduction_GaveDagger(1)
THEN
ToInventory((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, (CHARACTER)_TargetChar, 1, 0, 0);
DB_GEN_OrinsAbduction_GaveDagger(1);
//END_REGION

//REGION Orin's Netherstone
PROC
PROC_GEN_OrinsAbduction_GiveStone((CHARACTER)_TargetChar)
AND
IsInInventoryOf((ITEM)S_LOW_CrownController_Orin_360b0dfd-8e0b-48d2-a079-fcf68c104d6b, (CHARACTER)_TargetChar, 0) // check if she DOESN'T have the stone already.
THEN
ToInventory((ITEM)S_LOW_CrownController_Orin_360b0dfd-8e0b-48d2-a079-fcf68c104d6b, (CHARACTER)_TargetChar, 1, 1, 1);
//END_REGION

//REGION If players attacked Orin during her In-World Impersonations (WYR or LOW), she starts override crime dialog and teleports away.
// If Orin was attacked during In-World Impersonation in WYR
PROC
PROC_SceneInterrupted(_, _AttackOwner, "GEN_OrinsAbduction_Scene", "Attacked")
AND
QRY_GEN_OrinsAbduction_PlayerTeam(_AttackOwner)
AND
DB_ActiveLevel("BGO_Main_A")
THEN
NOT DB_SceneAllowAllDisturbances("GEN_OrinsAbduction_Scene");
DB_GEN_OrinsAbduction_OrinAttacker(_AttackOwner);
PROC_WYR_OrinsImpersonation_StopCrimeReaction();
PROC_GEN_OrinsAbduction_OrinTransformsBack();
PROC_GEN_OrinsAbduction_OrinAttacked_Setup();
PROC_WYR_OrinsImpersonation_Remove_DyingEffect(); // if Orin was impersonating the DyingAttacker, remove the status as well.
PROC_WYR_OrinsImpersonation_FlamingFist_RemoveFaction(); // if Orin was impersonating the FlamingFist, remove the status as well.

// Orin could be hit by several crime handling at once (EG A fireball on her, while hitting the owned door, while player is in tresspass zone all at once)
// So we cancelled any crime reaction should might be wanting to react to when the hit reaction triggered first.
PROC
PROC_WYR_OrinsImpersonation_StopCrimeReaction()
AND
GetHandlingCrimeID((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CrimeID)
THEN
PROC_CRIME_StopForAllCriminals(_CrimeID);

// If Orin was attacked during her In-World Abduction, set the flag so crime dialog will know its from Undercity.
PROC
PROC_SceneInterrupted(_, _AttackOwner, "GEN_OrinsAbduction_Scene", _Reason)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2) // if Orin is in the temple and therefore where the real battle takes place, then don't react
AND
QRY_GEN_OrinsAbduction_PlayerTeam(_AttackOwner)
AND
DB_ActiveLevel("CTY_Main_A")
AND
DB_GEN_OrinsAbduction_AbductionPlace("InWorld")
THEN
PROC_GEN_OrinsAbduction_ClearDB_OrinAttacker();
DB_GEN_OrinsAbduction_OrinAttacker(_AttackOwner);
PROC_GEN_OrinsAbduction_OrinTransformsBack();
PROC_GEN_OrinsAbduction_OrinAttacked_Setup();
PROC_GlobalSetFlagAndCache((FLAG)WYR_OrinsImpersonation_State_OrinAttacked_Undercity_0f699205-494c-41b4-a1cc-8af69b168672);

IF
DialogEnded((DIALOGRESOURCE)WYR_OrinsImpersonation_LINE_OrinAttacked_54169b5d-e726-4f5f-6211-f583081f26ff, _)
AND
DB_ActiveLevel("BGO_Main_A")
AND
DB_GEN_OrinsAbduction_OrinInAttackedDialog(1)
AND
NOT DB_GEN_OrinsAbduction_WaitForOrinAttackedDialog(1) // check for this or else the 2nd attack will trigger again when she's already setup at the next impersonation.
THEN
NOT DB_GEN_OrinsAbduction_OrinInAttackedDialog(1);
PROC_WYR_OrinsImpersonation_EndImpersonationByAttack();


IF
DialogEnded((DIALOGRESOURCE)WYR_OrinsImpersonation_LINE_OrinAttacked_54169b5d-e726-4f5f-6211-f583081f26ff, _)
AND
DB_ActiveLevel("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InWorld")
AND
DB_GEN_OrinsAbduction_OrinInAttackedDialog(1)
THEN
NOT DB_GEN_OrinsAbduction_OrinInAttackedDialog(1);
PROC_LOW_BhaalTemple_InWorldAbduction_Completed();


// during her Wyrm's Crossing impersonations, she should ignore the attacks on her.
QRY
QRY_CRIME_KeepingAnEyeOut_Block((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _ID)
AND
DB_CurrentLevel("BGO_Main_A")
THEN
DB_NOOP(1);


// during her Undercity In-World Abduction, she should also ignore the attacks on her.
QRY
QRY_CRIME_KeepingAnEyeOut_Block((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _ID)
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InWorld")
THEN
DB_NOOP(1);
//END_REGION

//REGION If players attacked Orin during Camp Nested dialog. This is a fallback support. In final implementation of nested dialog, it shouldn't be needed.
// If Orin was attacked during the InCamp abduction. Shouldn't be possible since its a CFM, but its a fallback.
PROC
PROC_SceneInterrupted(_, _AttackOwner, "GEN_OrinsAbduction_CampScene", _Reason)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2) // if Orin is in the temple and therefore where the real battle takes place, then don't react
AND
QRY_GEN_OrinsAbduction_PlayerTeam(_AttackOwner)
AND
DB_ActiveLevel("CTY_Main_A")
AND
DB_GEN_OrinsAbduction_AbductionPlace("InCamp")
THEN
//PROC_GEN_OrinsAbduction_OrinTransformsBack();
//TODO: PROC_ForceStopDialog(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // end the dialog with Orin.
PROC_GEN_OrinsAbduction_InCampAbduction_Completed();
PROC_SceneOver("GEN_OrinsAbduction_CampScene");
//NOT DB_GEN_OrinsAbduction_AbductionPlace("InCamp");

// during her Undercity In-Camp Abduction, she should also ignore the attacks on her.
// this is a fallback in case somehow someone attacks her during the CFM.
QRY
QRY_CRIME_KeepingAnEyeOut_Block((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _ID)
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InCamp")
THEN
DB_NOOP(1);
//END_REGION

//REGION Start Orin Attacked Dialog in WYR
// When already in Attacked dialog
PROC
PROC_GEN_OrinsAbduction_OrinAttacked_Setup()
AND
DB_ActiveLevel("BGO_Main_A")
AND
DB_GEN_OrinsAbduction_OrinInAttackedDialog(1)
THEN
// since she's currently in another dialog with another player, just force dialog stop and the DialogEnded would handle things as normal.
PROC_ForceStopDialog(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);

// Not in Attacked dialog
PROC
PROC_GEN_OrinsAbduction_OrinAttacked_Setup()
AND
DB_ActiveLevel("BGO_Main_A")
AND
NOT DB_GEN_OrinsAbduction_OrinInAttackedDialog(1)
THEN
PROC_ForceStopDialog(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
DB_GEN_OrinsAbduction_WaitForOrinAttackedDialog(1);

// wait for her to become available since she was just attacked.
IF
DB_GEN_OrinsAbduction_WaitForOrinAttackedDialog(1)
AND
NOT DB_CantTalk(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_GEN_OrinsAbduction_OrinAttacker(_AttackOwner)
THEN
NOT DB_GEN_OrinsAbduction_WaitForOrinAttackedDialog(1);
PROC_GEN_OrinsAbduction_OrinAttacked_StartDialog(_AttackOwner);

// start dialog with her since she's available.
PROC
PROC_GEN_OrinsAbduction_OrinAttacked_StartDialog((CHARACTER)_Player)
AND
DB_ActiveLevel("BGO_Main_A")
AND
//QRY_StartDialog(
QRY_StartDialogCustom_Fixed(
	(DIALOGRESOURCE)WYR_OrinsImpersonation_LINE_OrinAttacked_54169b5d-e726-4f5f-6211-f583081f26ff,
	(CHARACTER) S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,
				_Player,
				1, 1, 0, 0)
THEN
DB_GEN_OrinsAbduction_OrinInAttackedDialog(1);

// if dialog couldn't start with her, just teleport her away.
PROC
PROC_GEN_OrinsAbduction_OrinAttacked_StartDialog((CHARACTER)_Player)
AND
DB_ActiveLevel("BGO_Main_A")
AND
NOT DB_GEN_OrinsAbduction_OrinInAttackedDialog(1)
AND
NOT DB_GEN_OrinsAbduction_WaitForOrinAttackedDialog(1)
THEN
PROC_WYR_OrinsImpersonation_EndImpersonationByAttack();
//END_REGION

//REGION Start Orin Attacked Dialog in LOW
// When already in Attacked dialog
PROC
PROC_GEN_OrinsAbduction_OrinAttacked_Setup()
AND
DB_ActiveLevel("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InWorld")
AND
DB_GEN_OrinsAbduction_OrinInAttackedDialog(1)
THEN
// since she's currently in another dialog with another player, just force dialog stop and the DialogEnded would handle things as normal.
PROC_ForceStopDialog(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);


// Not in Attacked dialog
PROC
PROC_GEN_OrinsAbduction_OrinAttacked_Setup()
AND
DB_ActiveLevel("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InWorld")
AND
NOT DB_GEN_OrinsAbduction_OrinInAttackedDialog(1)
THEN
PROC_ForceStopDialog(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
DB_GEN_OrinsAbduction_WaitForOrinAttackedDialog(1);

// start dialog with her since she's available.
PROC
PROC_GEN_OrinsAbduction_OrinAttacked_StartDialog((CHARACTER)_Player)
AND
DB_ActiveLevel("CTY_Main_A")
AND
QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)WYR_OrinsImpersonation_LINE_OrinAttacked_54169b5d-e726-4f5f-6211-f583081f26ff,
	(CHARACTER) S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,
				_Player)
THEN
DB_GEN_OrinsAbduction_OrinInAttackedDialog(1);

/*
// Start Attacked dialog with Orin during In-World Abduction
PROC
PROC_GEN_OrinsAbduction_OrinAttacked_StartDialog((CHARACTER)_Player)
AND
DB_ActiveLevel("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InWorld")
AND
NOT QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)WYR_OrinsImpersonation_LINE_OrinAttacked_54169b5d-e726-4f5f-6211-f583081f26ff,
	(CHARACTER) S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,
				_Player)
THEN
DB_GEN_OrinsAbduction_OrinInAttackedDialog(1);
PROC_LOW_BhaalTemple_InWorldAbduction_Completed();
*/
//END_REGION

//REGION QRYs for valid player characters that attacked Orin
QRY // checks to see if the person who attacked is part of the player's team.
QRY_GEN_OrinsAbduction_PlayerTeam((CHARACTER)_AttackOwner)
AND
DB_PartyMembers(_AttackOwner)
THEN
DB_NOOP(1);
//END_REGION

//REGION Dummies Setup, we need these dummies for Orin's impersonation. For their VO in some cases, and visuals in others.
// We move the dummies around as players change levels.
IF
LevelLoaded("BGO_Main_A") // If Wyrm's Crossing was loaded
THEN
PROC_GEN_OrinsAbduction_SetupDummies();

IF
LevelLoaded("CTY_Main_A") // If Undercity was loaded.
THEN
PROC_GEN_OrinsAbduction_SetupDummies();
PROC_GEN_OrinsAbduction_InCampAbductions_Init();

PROC
PROC_GEN_OrinsAbduction_SetupDummies()
AND
NOT DB_GlobalFlag((FLAG)GLO_Orin_State_PermaDefeated_c716e4d9-e6ed-445c-a710-ee4d91c67298) // make sure Orin is still alive, else its pointless.
AND
DB_CurrentLevel(_CurrentLevel)
AND
DB_GEN_OrinsAbduction_DummyAsylumPos(_CurrentLevel, _TriggerPos)
THEN
TeleportTo((CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, _TriggerPos, "", 0, 0, 0, 0, 0);		// used as Orin's voice.
TeleportTo((CHARACTER)S_GLO_BhaalTemple_OrinGortashDummy_9fcd1601-fb36-4435-b6da-a80cee4edb10, _TriggerPos, "", 0, 0, 0, 0, 0);	// used as Gortash's voice in nested dialogs that can occur both in WYR and LOW
//END_REGION

//REGION React to Gortash telling players about Orin. Enable In-Camp Abductions (In WYR and LOW). Enable In-World Abductions (In LOW)
IF
DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_Knows_CampCompromised_62f279b8-9f36-4f4a-92d3-edc16cb4d760)
THEN
PROC_GEN_OrinsAbduction_InCampAbductions_Init();
PROC_GEN_OrinsAbduction_InWorldAbductions_Init();
// In Orin's Impersonation Goal, the InWorld Impersonations will also be disabled if it was still ongoing.
//END_REGION

//REGION React to Gortash being killed before talking to him. Enable In-Camp Abductions (In WYR and LOW). Enable In-World Abductions (In LOW)
IF
DB_GlobalFlag((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769)
THEN
PROC_GEN_OrinsAbduction_InCampAbductions_Init();
PROC_GEN_OrinsAbduction_InWorldAbductions_Init();
// In Orin's Impersonation Goal, the InWorld Impersonations will also be disabled if it was still ongoing.
//END_REGION

//REGION IN WORLD IMPERSONATION Init/Disable (For Orin's Impersonations in Wyrm's Crossing)
PROC 
PROC_GEN_OrinsAbduction_InWorldImpersonations_Init()
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_OrinsImpersonation_State_InWorldImpersonationsEnabled_4f3afc61-a52f-44ec-8308-3f81a17854d9);

PROC
PROC_GEN_OrinsAbduction_InWorldImpersonations_Disable()
THEN
PROC_GlobalClearFlagAndCache((FLAG)WYR_OrinsImpersonation_State_InWorldImpersonationsEnabled_4f3afc61-a52f-44ec-8308-3f81a17854d9);
//END_REGION

//REGION IN WORLD ABDUCTEE Init/Disable (For Bhaal Temple)
PROC
PROC_GEN_OrinsAbduction_InWorldAbductions_Init()
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d) // Abduction shouldn't have occured yet.
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_InWorldAbductionEnabled_efddef72-84c2-4a44-b5a4-5d82ce887010); // By default, In World Abductions is set to true so it can happen.
PROC_LOW_BhaalTemple_InWorldAbductionTriggers_Init();

PROC
PROC_GEN_OrinsAbduction_InWorldAbductions_Disable()
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_InWorldAbductionEnabled_efddef72-84c2-4a44-b5a4-5d82ce887010); // 
//END_REGION

//REGION IN CAMP ABDUCTEE Init/Disable (For both Wyrm's Crossing and Undercity)
PROC
PROC_GEN_OrinsAbduction_InCampAbductions_Init()
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d) // Abduction shouldn't have occured yet.
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75); // By default, Orin will pay a visit to the camp.

PROC
PROC_GEN_OrinsAbduction_InCampAbductions_Disable()
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75); // Disable camp abductions

//Prevent nights with potential kidnap victims at the same time as Camp Abduction
QRY
QRY_CampNight_HasEveningReservedSpeakerProblem((FLAG)_PotentialNight)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92)
AND
DB_CampNight_CRD(_PotentialNight,_Speaker,_,_)
AND
DB_GEN_OrinsAbduction_AbducteeList(_,_Speaker,_)
THEN
DB_NOOP(1);

//Same for sleep moments
QRY
QRY_CampNight_HasSleepReservedSpeakerProblem((FLAG)_PotentialNight)
AND
NOT DB_CampNight_OnlyAllowSleepOrMorningMoments(1)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92)
AND
DB_CampNight_SleepIndividualDialogs(_PotentialNight,_Speaker)
AND
DB_GEN_OrinsAbduction_AbducteeList(_,_Speaker,_)
THEN
DB_NOOP(1);
//END_REGION

//REGION IN CAMP ABDUCTEE Step 0) When players have gathered in the camp, and clicked on the campfire/bedroll - find the 'best' target for Orin to abduct and impersonate.
PROC
PROC_CampNight_StartSelected() // triggered by Camp system.
AND
DB_Camp_QueuedNight((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92)
AND
DB_GlobalFlag(LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75)
THEN
PROC_GEN_OrinsAbduction_ClearDB_ChosenName();
PROC_GEN_OrinsAbduction_FindBestAbductee();

PROC_GEN_OrinsAbduction_ClearDBs();
PROC_GEN_OrinsAbduction_SetupBestAbductee();
PROC_GEN_OrinsAbduction_SetupCampReq();
PROC_GEN_OrinsAbduction_OrinAbductionSetup();
PROC_GEN_OrinsAbduction_AbductCompanion();
//END_REGION

//REGION IN CAMP ABDUCTEE Step 1) Find romance partner, or friend, or Yenna at worst case scenario.

// Try to find romance partner first.
PROC
PROC_GEN_OrinsAbduction_FindBestAbductee()							// Looking for first possible romance friend.
AND
DB_GEN_OrinsAbduction_AbducteeList(_TargetName, _TargetChar, _)	// Iterate through the candidate lists
AND
NOT DB_GEN_OrinsAbduction_ChosenName(_)							// we haven't chosen anyone yet. After we choose one this line will prevent further iteration
AND
QRY_GEN_OrinsAbduction_CheckBasicReq((CHARACTER)_TargetChar)
AND
QRY_GEN_OrinsAbduction_CheckValidFriend()
THEN
DB_NOOP(1);

// Check to see if the target is partnered with any avatar - except for Minthara
QRY
QRY_GEN_OrinsAbduction_CheckRomance((STRING)_TargetName)
AND
_TargetName != "Minthara" // If its Minthara, ignore the romance check since she's definitely a romance partner when she's part of the party.
AND
DB_GEN_OrinsAbduction_PartneredList(_TargetName, _TargetFlag)
AND
DB_Avatars(_Player)
AND
GetFlag((FLAG)_TargetFlag, _Player, 1) // checking the character flags.
THEN
DB_NOOP(1);

// Check through possible abduction candidates and see if they are valid.
QRY
QRY_GEN_OrinsAbduction_CheckValidFriend()
AND
DB_GEN_OrinsAbduction_AbducteeList(_TargetName, _TargetChar, _)	// Iterate through the candidate lists
AND
NOT DB_GEN_OrinsAbduction_ChosenName(_)							// Romance must not have already been chosen.
AND
QRY_GEN_OrinsAbduction_CheckFriendConditions(_TargetName, (CHARACTER)_TargetChar)
THEN
DB_GEN_OrinsAbduction_ChosenName(_TargetName); 					// save the chosen

// If normal companion (as opposed to the Yenna), check if they are available.
QRY
QRY_GEN_OrinsAbduction_CheckFriendConditions((STRING)_TargetName, (CHARACTER)_TargetChar) 
AND
_TargetName != "Yenna"
//AND //Disabled because we now don't want Laezel to be gated behind Yenna's absence.
//_TargetName != "Laezel"  
AND
QRY_GEN_OrinsAbduction_CheckBasicReq(_TargetChar)
AND
NOT QRY_GEN_OrinsAbduction_CheckRomance(_TargetName)
THEN
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
DB_GEN_OrinsAbduction_ChosenCharRelationship((FLAG)LOW_BhaalTemple_State_AbducteeIsFriend_dd552cb0-4429-4bc9-849c-85fb611124bd);

/* Disabled because we now don't want Laezel to be gated behind Yenna's absence.
// If Laezel, Yenna must also be available, check if they are available.
QRY
QRY_GEN_OrinsAbduction_CheckFriendConditions("Laezel", (CHARACTER)_TargetChar) 
AND
QRY_GEN_OrinsAbduction_CheckBasicReq(_TargetChar)
AND
NOT QRY_GEN_OrinsAbduction_CheckRomance("Laezel")
AND
DB_GlobalFlag((FLAG)CAMP_Yenna_HasMet_cca85c99-e3c7-4054-98e1-3ced676f8082) // make sure players has at least met Yenna in camp first.
THEN
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
DB_GEN_OrinsAbduction_ChosenCharRelationship((FLAG)LOW_BhaalTemple_State_AbducteeIsFriend_dd552cb0-4429-4bc9-849c-85fb611124bd);
*/

// If we are down in the list and reached Yenna, then no companions are available and we will do the Atrocity scene - which has now been changed to Yenna's abduction.
QRY
QRY_GEN_OrinsAbduction_CheckFriendConditions("Yenna", _)
THEN
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
DB_GEN_OrinsAbduction_ChosenCharRelationship((FLAG)LOW_BhaalTemple_State_AbducteeIsYenna_fa8d1e59-26d5-4ad6-9706-1cb15a5cdb0a);

// Basic check for validity of choice.
QRY
QRY_GEN_OrinsAbduction_CheckBasicReq((CHARACTER)_TargetChar)
AND
NOT DB_Players(_TargetChar) 					// must not be in the current party
AND
DB_InCamp((CHARACTER)_TargetChar)				// Must be in camp
AND
NOT DB_Avatars((CHARACTER)_TargetChar)			// Must NOT be an avatar.
AND
NOT DB_DismissedAvatar((CHARACTER)_TargetChar)	
AND
NOT DB_CantTalk((CHARACTER)_TargetChar)			// Must be able to talk.
AND
NOT DB_PermaDefeated((CHARACTER)_TargetChar)	// Must NOT be permaDefeated.
THEN
DB_NOOP(1);

// When checking abduction victim - If its Yenna, she's the fallback, so we force her to be in camp if she isn't already as she should be.
QRY
QRY_GEN_OrinsAbduction_CheckBasicReq(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
AND 
NOT DB_GEN_OrinsAbduction_CheckingMintharaVictim(1)
THEN
DB_InCamp(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);

// When checking Minthara killed victim - Yenna doesn't have to be in camp for this.
QRY
QRY_GEN_OrinsAbduction_CheckBasicReq(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
AND 
DB_GEN_OrinsAbduction_CheckingMintharaVictim(1)
THEN
DB_NOOP(1);

//END_REGION

//REGION IN CAMP ABDUCTEE Step 3) Setup the various DBs since we've found at least 1 valid ABDUCTEE
PROC
PROC_GEN_OrinsAbduction_SetupBestAbductee()
AND
DB_GEN_OrinsAbduction_ChosenName(_TargetName)
AND
QRY_GEN_OrinsAbduction_SetAbducteeDBs(_TargetName) // set the DBs for targeted candidate
THEN
DB_NOOP(1);

// for abductee is Yenna. This is to force Yenna into camp regardless of where she is.
PROC
PROC_GEN_OrinsAbduction_SetupBestAbductee()
AND
DB_GEN_OrinsAbduction_ChosenName("Yenna")
THEN
PROC_ORI_SetupCamp((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, 1);
NOT DB_YennaDismissedFromCamp(1); // to make sure Yenna doesn't reappear in camp.

//REGION QRYs to populate the DBs and Flags
QRY
QRY_GEN_OrinsAbduction_SetAbducteeDBs((STRING)_TargetName)
AND
DB_GEN_OrinsAbduction_AbducteeList(_TargetName, _TargetChar, _TargetDialog)
AND
DB_GEN_OrinsAbduction_AbducteeFlagList(_TargetName, _TargetFlag)
AND
DB_GEN_OrinsAbduction_AbducteeGender(_TargetName, _TargetGenderFlag)
THEN
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_TargetChar);
DB_GEN_OrinsAbduction_CFM_Orin((DIALOGRESOURCE)_TargetDialog);
DB_GEN_OrinsAbduction_ChosenCharFlag((FLAG)_TargetFlag);
PROC_GlobalSetFlagAndCache(_TargetFlag); // to set the flag of who was actually abductee for use in dialogs.
PROC_GlobalSetFlagAndCache(_TargetGenderFlag); // to set the gender flag for writers to use in dialogs - specifically the Nested dialog that wouldn't have access to the original victim.

//END_REGION

//END_REGION

//REGION IN CAMP ABDUCTEE Step 4) Setup the requirement for Camp Systems
PROC
PROC_GEN_OrinsAbduction_SetupCampReq()
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
THEN
DB_InCamp((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // since we found a possible candidate, add Orin into the camp DB.
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // just in case
NOT DB_CampNight_CFM((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92, (DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
DB_CampNight_CFM((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92, (DIALOGRESOURCE)_ImpersonatingOrinDialog);
PROC_GEN_OrinsAbduction_Setup_CampTriggerPos(); // setup trigger DB for current camp.

PROC
PROC_GEN_OrinsAbduction_SetupCampReq()
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)_TargetChar)
AND
DB_Origins(_TargetChar)
AND
QRY_GetBestAvatarForCompanion(_TargetChar)
AND
DB_QRYRTN_GetBestAvatarForCompanion(_TargetChar,_Avatar)
THEN
DB_CampfireMoment_FixedPlayer(_ImpersonatingOrinDialog, _Avatar);

//REGION when abductee is Laezel
PROC
PROC_GEN_OrinsAbduction_SetupCampReq()
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenName("Laezel")
THEN
PROC_GEN_OrinsAbduction_Temple_KnockedOut_Remove(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f); // remove status or else camp system will think she's unavailable.
DB_InCamp((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f); // Add Yenna to camp DB or else the CFM will fail.

PROC
PROC_StartDialog_AddExtraSpeakers(_ImpersonatingOrinDialog, _DialogID)
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenName("Laezel")
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, 4);
//END_REGION

//REGION when abductee is Halsin
PROC
PROC_GEN_OrinsAbduction_SetupCampReq()
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenName("Halsin")
THEN
PROC_GEN_OrinsAbduction_ChooseHalsinVictim();

PROC
PROC_StartDialog_AddExtraSpeakers(_ImpersonatingOrinDialog, _DialogID)
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim("Yenna", _HalsinVictimChar)
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, _HalsinVictimChar, 5);

PROC
PROC_StartDialog_AddExtraSpeakers(_ImpersonatingOrinDialog, _DialogID)
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim("Scratch", _HalsinVictimChar)
THEN
PROC_DialogAddSpeakingActorAt(_DialogID, _HalsinVictimChar, 4);
//END_REGION

//REGION when abductee is Minthara
PROC
PROC_GEN_OrinsAbduction_SetupCampReq()
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenName("Minthara")
THEN
DB_GEN_OrinsAbduction_CheckingMintharaVictim(1); // just used as a boolean to set so the CheckBasicReq (that is reused for checking abduction target) knows not to force Yenna into camp.
PROC_GEN_OrinsAbduction_SetAvailableMintharaVictim();
NOT DB_GEN_OrinsAbduction_CheckingMintharaVictim(1);
//END_REGION

//REGION for all abductees
PROC
PROC_GEN_OrinsAbduction_SetupCampReq()
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenName(_ImpersonatedName)
THEN
NOT DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec);
DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)_ImpersonatingOrinDialog, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec);
//END_REGION


//REGION Camp locations differ
// For SLUMS camp - the following 3 overloads could be refactored, but leave it as is in case each camp might have different setups in the future.
PROC
PROC_GEN_OrinsAbduction_Setup_CampTriggerPos()
AND
DB_ActiveCamp("SLUMS")
AND
DB_GEN_OrinsAbduction_OrinAbductionPosList("SLUMS", _TriggerPos)
THEN
PROC_GEN_OrinsAbduction_ClearDB_CurCampTrigPos();
DB_GEN_OrinsAbduction_CurCampTrigPos(_TriggerPos);

// For ELFSONG camp
PROC
PROC_GEN_OrinsAbduction_Setup_CampTriggerPos()
AND
DB_ActiveCamp("ELFSONG")
AND
DB_GEN_OrinsAbduction_OrinAbductionPosList("ELFSONG", _TriggerPos)
THEN
PROC_GEN_OrinsAbduction_ClearDB_CurCampTrigPos();
DB_GEN_OrinsAbduction_CurCampTrigPos(_TriggerPos);

// For FARM camp
PROC
PROC_GEN_OrinsAbduction_Setup_CampTriggerPos()
AND
DB_ActiveCamp("FARM")
AND
DB_GEN_OrinsAbduction_OrinAbductionPosList("FARM", _TriggerPos)
THEN
PROC_GEN_OrinsAbduction_ClearDB_CurCampTrigPos();
DB_GEN_OrinsAbduction_CurCampTrigPos(_TriggerPos);
//END_REGION

//END_REGION

//REGION IN CAMP ABDUCTEE Step 5) Setup Orin for the impersonation of the abductee
PROC
PROC_GEN_OrinsAbduction_OrinAbductionSetup()
AND
DB_GlobalFlag(LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75)
AND
DB_GEN_OrinsAbduction_ChosenName(_ImpersonatedName)
AND
DB_GEN_OrinsAbduction_ChosenChar(_ImpersonatedChar)
AND
DB_GEN_OrinsAbduction_CurCampTrigPos(_TriggerPos)
AND
DB_GEN_OrinsAbduction_OrinTransformRule_Common(_TransformRule)
THEN
PROC_LOW_BhaalTemple_OrinSpotting_Stopped(); // if the in camp abduction is happening in Undercity already, need to disable Orin's spotting cause she's having it on from the Temple.
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_Event_TransformToOrin_9280b884-9f8e-41f4-bd49-dbfcb2827fe5); // flag will be used to check her transformation state in dialogs
DB_PreventPermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // prevent her permadeath in Impersonation encounters
DB_GEN_OrinsAbduction_IsTransformed(1);
Transform((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)_ImpersonatedChar, (SHAPESHIFTRULE)_TransformRule);
CopyCharacterEquipment(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)_ImpersonatedChar);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2);
TeleportTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _TriggerPos, "GEN_OrinsAbduction_OrinTeleported", 0, 0, 0, 0, 0);
DB_SceneManager((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101 ,"GEN_OrinsAbduction_CampScene");

//REGION Orin-Laezel uses Yenna as hostage setup
// If Orin impersonates Laezel, we need Yenna to be there too since Orin-Laezel uses her as a hostage.
PROC
PROC_GEN_OrinsAbduction_OrinAbductionSetup()
AND
DB_GlobalFlag(LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75)
AND
DB_GEN_OrinsAbduction_ChosenName("Laezel")
AND
DB_GEN_OrinsAbduction_CurCampTrigPos(_TriggerPos)
THEN
TeleportTo((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, _TriggerPos, "", 0, 0, 0, 0, 0);
PROC_GEN_OrinsAbduction_PostCampHostage_Yenna_DialogSetup(); // if its Laezel, might as well give Yenna her post-Orin-encounter dialog in case she survives.
//END_REGION

//REGION Orin-Halsin uses Scratch/Yenna as hostage setup
// If Orin impersonates Halsin, we need Scratch/Yenna to be there too since Orin-Halsin uses her as a hostage.
PROC
PROC_GEN_OrinsAbduction_OrinAbductionSetup()
AND
DB_GlobalFlag(LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75)
AND
DB_GEN_OrinsAbduction_ChosenName("Halsin")
AND
DB_GEN_OrinsAbduction_CurCampTrigPos(_TriggerPos)
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim(_HalsinVictimName, _HalsinVictimChar)
THEN
PROC_GEN_OrinsAbduction_KnockedOut_Apply(_HalsinVictimChar);
TeleportTo((CHARACTER)_HalsinVictimChar, _TriggerPos, "GEN_OrinsAbduction_OrinTeleported", 0, 0, 0, 0, 0);
//END_REGION

//REGION Scratch is the hostage setup
// If Orin-Halsin victim is Scratch
PROC
PROC_GEN_OrinsAbduction_OrinAbductionSetup()
AND
DB_GlobalFlag(LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75)
AND
DB_GEN_OrinsAbduction_ChosenName("Halsin")
AND
DB_GEN_OrinsAbduction_CurCampTrigPos(_TriggerPos)
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim("Scratch", _HalsinVictimChar)
THEN
PROC_GlobalSetFlagAndCache((FLAG)GLO_CourierDog_State_UnavailableForSummon_0fef1fa5-9216-4833-94c1-5fe1da7da7c7);
//END_REGION

//REGION Yenna is the hostage setup
// If Orin-Halsin victim is Scratch
PROC
PROC_GEN_OrinsAbduction_OrinAbductionSetup()
AND
DB_GlobalFlag(LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75)
AND
DB_GEN_OrinsAbduction_ChosenName("Yenna")
AND
DB_GEN_OrinsAbduction_CurCampTrigPos(_TriggerPos)
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim("Yenna", _HalsinVictimChar)
THEN
PROC_GEN_OrinsAbduction_PostCampHostage_Yenna_DialogSetup(); 
//END_REGION

//REGION Orin-Minthara needs to be bloodied
// If Orin impersonates Minthara, she pretends to have killed someone and is all blooded.
PROC
PROC_GEN_OrinsAbduction_OrinAbductionSetup()
AND
DB_GlobalFlag(LOW_BhaalTemple_State_InCampAbductionEnabled_531257fe-eb47-4058-9992-b1c55e42ad75)
AND
DB_GEN_OrinsAbduction_ChosenName("Minthara")
THEN
PROC_GEN_OrinsAbduction_BloodiedChar_Apply((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//END_REGION

//END_REGION

//REGION IN CAMP ABDUCTEE Step 6) Abduct targeted companion
PROC
PROC_GEN_OrinsAbduction_AbductCompanion()
AND
DB_GEN_OrinsAbduction_ChosenChar(_ImpersonatedChar)
AND
DB_GEN_OrinsAbduction_ChosenName(_ImpersonatedName)
AND
DB_GEN_OrinsAbduction_ChosenCharRelationship(_ImpersonatedCharRelationship)
AND
DB_ActiveCamp(_Camp)
AND
DB_GEN_OrinsAbduction_AbductionCamp(_Camp, _CampFlag)
THEN
/* Moved this to after the nested dialog so players won't get the prompt that companion left too earlier
PROC_Origins_CompanionLeaveTemporarily((CHARACTER)_ImpersonatedChar, "LOW_BhaalTemple_Abducted");
NOT DB_InCamp((CHARACTER)_ImpersonatedChar);
*/
PROC_GEN_OrinsAbduction_SetupVictimInTemple((CHARACTER)_ImpersonatedChar, (FLAG)_ImpersonatedCharRelationship);
PROC_GlobalSetFlagAndCache((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d);
DB_GEN_OrinsAbduction_AbductionPlace("InCamp");
PROC_GlobalSetFlagAndCache((FLAG)_CampFlag);

// if anyone other than Laezel, remove Yenna from the temple.
PROC
PROC_GEN_OrinsAbduction_AbductCompanion()
AND
DB_GEN_OrinsAbduction_ChosenName(_ImpersonatedName)
AND
_ImpersonatedName != "Laezel"
AND
_ImpersonatedName != "Halsin"
THEN
PROC_LOW_BhaalTemple_RemoveDefaultVictim(); // if its in LOW, remove Yenna from the temple.

//REGION Orin-Laezel
// if its Laezel, we need to cleanup Yenna as the default abductee, but not teleport her out since RemoveDefaultVictim automatically does.
PROC
PROC_GEN_OrinsAbduction_AbductCompanion()
AND
DB_GEN_OrinsAbduction_ChosenName("Laezel")
THEN
// This is to cleanup Yenna as the abductee as she is the default abductee
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_AbducteeIsYenna_fa8d1e59-26d5-4ad6-9706-1cb15a5cdb0a);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_WasAbductedYenna_ff8e1e49-dcb0-4671-a747-dce5c704207b); // to set the flag of who was actually abductee for use in dialogs.
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();

// might as well give Yenna her post-Orin-encounter dialog in case she survives.
PROC_GEN_OrinsAbduction_PostCampHostage_Yenna_DialogSetup();
//DB_GLO_DieFlag((FLAG)LOW_BhaalTemple_State_OrinLaezelKillsYenna_84065b20-4337-4010-87d7-0a62f855298c, (CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, DEATHTYPE.DoT, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // flag to check if Orin killed the victim
DB_DialogDeath((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
PROC_GEN_OrinsAbduction_YennaImmortality_Remove(); // Remove her from DB_Children in case she will be killed here by Orin.
//END_REGION

//REGION Orin-Halsin
// if its Halsin, we need to cleanup Yenna as the default abductee, but not teleport her out since RemoveDefaultVictim automatically does.
PROC
PROC_GEN_OrinsAbduction_AbductCompanion()
AND
DB_GEN_OrinsAbduction_ChosenName("Halsin")
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim("Yenna", _)
THEN
// This is to cleanup Yenna as the abductee as she is the default abductee
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_AbducteeIsYenna_fa8d1e59-26d5-4ad6-9706-1cb15a5cdb0a);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_WasAbductedYenna_ff8e1e49-dcb0-4671-a747-dce5c704207b); // to set the flag of who was actually abductee for use in dialogs.
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
PROC_GEN_OrinsAbduction_PostCampHostage_Yenna_DialogSetup();

// if its Halsin, we need to cleanup Yenna as the default abductee, but not teleport her out since RemoveDefaultVictim automatically does.
PROC
PROC_GEN_OrinsAbduction_AbductCompanion()
AND
DB_GEN_OrinsAbduction_ChosenName("Halsin")
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim("Scratch", _)
THEN
// This is to cleanup Yenna as the abductee as she is the default abductee
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_AbducteeIsYenna_fa8d1e59-26d5-4ad6-9706-1cb15a5cdb0a);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_WasAbductedYenna_ff8e1e49-dcb0-4671-a747-dce5c704207b); // to set the flag of who was actually abductee for use in dialogs.
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship();
PROC_GEN_OrinsAbduction_PostCampHostage_Scratch_DialogSetup();
//END_REGION

//END_REGION

//REGION IN CAMP ABDUCTEE Step 7) End of dialog as Orin gave her ultimatum and teleports away. 
IF
DialogEnded((DIALOGRESOURCE)_ImpersonatingOrinDialog, _DialogID)
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
//AND
//DB_DialogPlayers(_DialogID, _Player1, 1)
THEN
NOT DB_InCamp((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_Event_TransformToGortash_aca677a0-c532-44df-ac77-3156f0c06925); 
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_Event_TransformToOrin_9280b884-9f8e-41f4-bd49-dbfcb2827fe5);
PROC_GEN_OrinsAbduction_SetupOrinGortash();
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_BhaalTemple_InWorldAbduction_Nested_a1504daf-2fb7-7cc7-9165-b749c2bcd115);
PROC_GEN_OrinsAbduction_NestedDialog_Start(_DialogID);

IF // if Yenna was not killed by Laezel, put her back in DB_Children so she can't be killed by players.
DialogEnded((DIALOGRESOURCE)_ImpersonatingOrinDialog, _DialogID)
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenName("Laezel")
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
THEN
PROC_GEN_OrinsAbduction_YennaImmortality_Reset();

IF // Orin-Halsin victim was Scratch
DialogEnded((DIALOGRESOURCE)_ImpersonatingOrinDialog, _DialogID)
AND
DB_GEN_OrinsAbduction_CFM_Orin(_ImpersonatingOrinDialog)
AND
DB_GEN_OrinsAbduction_ChosenName("Halsin")
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim("Scratch", _HalsinVictimChar)
THEN
PROC_GlobalClearFlagAndCache((FLAG)GLO_CourierDog_State_UnavailableForSummon_0fef1fa5-9216-4833-94c1-5fe1da7da7c7);

// save all the players from parent dialog
PROC
PROC_GEN_OrinsAbduction_NestedDialog_Start((INTEGER)_DialogID)
AND
DB_DialogPlayers(_DialogID, _Player, _Pos)
AND
_Pos != 1
THEN
DB_GEN_OrinsAbduction_NestedParentListeners(_Player);

PROC
PROC_GEN_OrinsAbduction_NestedDialog_Start((INTEGER)_DialogID)
AND
DB_DialogPlayers(_DialogID, _Player, 1)
AND
NOT QRY_StartDialog_Fixed(
	(DIALOGRESOURCE)LOW_BhaalTemple_InWorldAbduction_Nested_a1504daf-2fb7-7cc7-9165-b749c2bcd115,
	(CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,
			   S_GLO_BhaalTemple_OrinGortashDummy_9fcd1601-fb36-4435-b6da-a80cee4edb10,			   
			   _Player)
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_BhaalTemple_InWorldAbduction_Nested_a1504daf-2fb7-7cc7-9165-b749c2bcd115, (INTEGER)_NestedDialogID)
AND
DB_GEN_OrinsAbduction_NestedParentListeners(_Player)
THEN
PROC_DialogAddListeningActor(_NestedDialogID, _Player);
NOT DB_GEN_OrinsAbduction_NestedParentListeners(_Player);

// make sure the nested dialog doesn't pull in any other speakers.
QRY
QRY_Inclusion_BlockCompanionInclusion(_Companion,(DIALOGRESOURCE)LOW_BhaalTemple_InWorldAbduction_Nested_a1504daf-2fb7-7cc7-9165-b749c2bcd115)
THEN
DB_NOOP(1);
//END_REGION

//REGION IN CAMP ABDUCTEE Step 8) End of Nested Dialog for InCamp - nested dialog is the same as In-World for now
// If end of nested dialog
IF
DialogEnded((DIALOGRESOURCE)LOW_BhaalTemple_InWorldAbduction_Nested_a1504daf-2fb7-7cc7-9165-b749c2bcd115, _)
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InCamp")
THEN
PROC_GEN_OrinsAbduction_InCampAbduction_Completed();

PROC
PROC_GEN_OrinsAbduction_InCampAbduction_Completed()
THEN
PROC_GEN_OrinsAbduction_CompanionLeaves();
PROC_GEN_OrinsAbduction_WakeUpCampAbductee(); // wakes the the camp abductee (for Orin-Halsin abducting Scratch or Yenna)
//NOT DB_GEN_OrinsAbduction_AbductionPlace("InCamp");
PROC_GEN_OrinsAbduction_DisableAllImpersonations();
PROC_GEN_OrinsAbduction_OrinTeleportOut();
PROC_GEN_OrinsMessages_Setup();

// Wake up Halsin's Victim
PROC
PROC_GEN_OrinsAbduction_WakeUpCampAbductee()
AND
DB_GEN_OrinsAbduction_AbductionPlace("InCamp")
AND
DB_GEN_OrinsAbduction_ChosenName("Halsin")
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim(_HalsinVictimName, _HalsinVictimChar)
THEN
//DB_NOOP(1);
PROC_GEN_OrinsAbduction_KnockedOut_Remove(_HalsinVictimChar);
//END_REGION

//REGION IN-CAMP ABDUCTEE - Register the companion as leaving the party. A prompt appears now, so needs to happen after the scene.
// Triggers only near the end of the abduction, since a popup will appear telling the players that a companion left the party.
PROC
PROC_GEN_OrinsAbduction_CompanionLeaves()
AND
DB_GEN_OrinsAbduction_ChosenChar((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f) // if the companion abducted is Yenna, we block the popup "companion has left the party", as she's not really a companion
THEN
DB_Origins_BlockTransferReasons("LOW_BhaalTemple_Abducted");

PROC
PROC_GEN_OrinsAbduction_CompanionLeaves()
AND
DB_GEN_OrinsAbduction_ChosenChar(_ImpersonatedChar)
THEN
PROC_Origins_CompanionLeaveTemporarily((CHARACTER)_ImpersonatedChar, "LOW_BhaalTemple_Abducted");
NOT DB_InCamp((CHARACTER)_ImpersonatedChar);
PROC_RemoveAllDialogEntriesForSpeaker(_ImpersonatedChar);
SetHasDialog(_ImpersonatedChar,0);
//END_REGION

//REGION Sets flag to see if any of the following victims is available for Orin-Minthara abduction. Wyll, Karlach, Jaheira, Isobel, Gale, Astarion, Shadowheart, Laezel, Nightsong, Minsc, Ravengard and Yenna
// as long as the potential target is available, just set the flag.
// in the dialog, we'll prioritize the nodes so the first top node that's available will be chosen
// this allows for writers/narrative to decide the priority themselves.
PROC
PROC_GEN_OrinsAbduction_SetAvailableMintharaVictim()
AND
DB_GEN_OrinsAbduction_MintharaAbduction(_CharName, _Char, _CharFlag)
AND
QRY_GEN_OrinsAbduction_CheckBasicReq(_Char)
THEN
PROC_GlobalSetFlagAndCache((FLAG)_CharFlag);
//END_REGION


//REGION Select Victim for Orin-Halsin. Scratch or Yenna
// clear DB first
PROC
PROC_GEN_OrinsAbduction_ChooseHalsinVictim()
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim(_HalsinVictimName, _HalsinVictimChar)
THEN
NOT DB_GEN_OrinsAbduction_ChosenHalsinVictim(_HalsinVictimName, _HalsinVictimChar);

// if Scratch is available
PROC
PROC_GEN_OrinsAbduction_ChooseHalsinVictim()
AND
QRY_GEN_OrinsAbduction_Scratch_IsAvailable()
THEN
DB_GEN_OrinsAbduction_ChosenHalsinVictim("Scratch", (CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_HalsinAbduction_IsScratch_7ce47264-9ccc-4874-a2a1-a9faaa11491c);

QRY
QRY_GEN_OrinsAbduction_Scratch_IsAvailable()
AND
NOT DB_PermaDefeated((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901)
AND
DB_GlobalFlag((FLAG)CAMP_Courier_Dog_Moved2Camp_7dcb7732-1c76-463a-bec9-251f30860e6c)
THEN
DB_NOOP(1);

// Yenna is always available when Scratch isn't available.
PROC
PROC_GEN_OrinsAbduction_ChooseHalsinVictim()
AND
NOT QRY_GEN_OrinsAbduction_Scratch_IsAvailable()
THEN
DB_GEN_OrinsAbduction_ChosenHalsinVictim("Yenna", (CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_HalsinAbduction_IsYenna_42bbec85-a6a7-4ef7-a006-82ebbd6c58a3);
//NOT DB_CampNight_CRD((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92,(CHARACTER)NULL_00000000-0000-0000-0000-000000000000,(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000);
//DB_CampNight_CRD((FLAG)NIGHT_BhaalTemple_Abduction_3b3655ad-e3a2-45da-9030-ffe34d28ea92,(CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f,(DIALOGRESOURCE)LOW_BhaalTemple_PostLaezelAbduction_Yenna_ffa51503-6973-dd90-ba68-6790def99e6d);
//END_REGION


//REGION Set/Remove Yenna's IMMORTALITY from DB_Children.
PROC
PROC_GEN_OrinsAbduction_YennaImmortality_Remove()
THEN
//NOT DB_Children((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
//SetImmortal(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f,0);
PROC_Children_RemoveNPC((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);

PROC
PROC_GEN_OrinsAbduction_YennaImmortality_Reset()
AND
NOT DB_PermaDefeated(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
THEN
DB_Children((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
//SetImmortal(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f,1);
//END_REGION


//REGION Setup chosen victim as sacrifice in temple.
PROC
PROC_GEN_OrinsAbduction_SetupVictimInTemple((CHARACTER)_TargetChar, (FLAG)_TargetFlag)
THEN
PROC_SetOnStage((CHARACTER)_TargetChar, 1);
SetVisible((CHARACTER)_TargetChar, 1);
TeleportTo((CHARACTER)_TargetChar, S_GLO_BhaalTemple_AbductionSacrifice_TriggerPos_891c74a5-0ba0-4e09-83d5-f4f4fba200c2, "", 0, 0, 0, 0, 0);
PROC_GEN_OrinsAbduction_Temple_KnockedOut_Apply((CHARACTER)_TargetChar); // TODO: maybe use the altar as bed in the future?
PROC_GlobalSetFlagAndCache((FLAG)_TargetFlag); // flag that determines target is a friend, romance, or Yenna
DB_GEN_OrinsAbduction_ChosenCharRelationship((FLAG)_TargetFlag);
//DB_GLO_DieFlag((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9, (CHARACTER)_TargetChar, DEATHTYPE.None, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
DB_DialogDeath((CHARACTER)_TargetChar);
//END_REGION


//REGION Turns off all impersonations
PROC
PROC_GEN_OrinsAbduction_DisableAllImpersonations()
THEN
PROC_GEN_OrinsAbduction_InWorldAbductions_Disable();
PROC_GEN_OrinsAbduction_InCampAbductions_Disable();
PROC_GEN_OrinsAbduction_InWorldImpersonations_Disable(); // disable Wyrm's Crossing In-World Impersonations.

PROC_WYR_OrinsImpersonation_DisableAllImpersonations(); // if PROC_GEN_OrinsAbduction_DisableAllImpersonations is triggered in Wyrm's Crossing, it will also trigger this cleanup.
PROC_LOW_BhaalTemple_InWorldAbductions_Disable(); // if PROC_GEN_OrinsAbduction_DisableAllImpersonations is trigger in Undercity, it will also trigger this cleanup.
//END_REGION



//REGION Apply and Remove KNOCKED_OUT effect
PROC
PROC_GEN_OrinsAbduction_Temple_KnockedOut_Apply((CHARACTER)_TargetChar)
//AND
//NOT DB_KnockedOut(_TargetChar)
THEN
//DB_DoNotRemoveKnockedOutCharacterOnLongRest(_TargetChar);
//DB_PreventKnockedOutPermaDefeated(_TargetChar);
//DB_SurrenderOnKnockedOutDialog((CHARACTER)_TargetChar, (DIALOGRESOURCE)LOW_BhaalTemple_ExamineAbductee_7e7974f1-fbaa-a19b-b9bf-73980a0b3503);
DB_Dialogs((CHARACTER)_TargetChar, (DIALOGRESOURCE)LOW_BhaalTemple_ExamineAbductee_7e7974f1-fbaa-a19b-b9bf-73980a0b3503);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_ExamineAbductee_7e7974f1-fbaa-a19b-b9bf-73980a0b3503);
DB_GEN_OrinsAbduction_Abductee_ExamineAbducteeDialog("Enabled");
ApplyStatus(_TargetChar, "WYR_ORINSIMPERSONATION_KNOCKEDOUT", -1.0, 0, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
PROC_SetHasDialogIfChar(_TargetChar, 1);
SetTag(_TargetChar, (TAG)DOWNED_DISABLED_7095912e-fcb9-41dd-aec3-3cf7803e4b22);

PROC
PROC_GEN_OrinsAbduction_Temple_KnockedOut_Remove((CHARACTER)_TargetChar)
//AND
//DB_KnockedOut(_TargetChar)
THEN
RemoveStatus(_TargetChar, "WYR_ORINSIMPERSONATION_KNOCKEDOUT", S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//NOT DB_DoNotRemoveKnockedOutCharacterOnLongRest(_TargetChar);
//NOT DB_PreventKnockedOutPermaDefeated(_TargetChar); // status apparently auto-removes this.
//NOT DB_SurrenderOnKnockedOutDialog((CHARACTER)_TargetChar, (DIALOGRESOURCE)LOW_BhaalTemple_ExamineAbductee_7e7974f1-fbaa-a19b-b9bf-73980a0b3503);
NOT DB_Dialogs((CHARACTER)_TargetChar, (DIALOGRESOURCE)LOW_BhaalTemple_ExamineAbductee_7e7974f1-fbaa-a19b-b9bf-73980a0b3503);
NOT DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_ExamineAbductee_7e7974f1-fbaa-a19b-b9bf-73980a0b3503);
DB_GEN_OrinsAbduction_Abductee_ExamineAbducteeDialog("Disabled");
ClearTag(_TargetChar, (TAG)DOWNED_DISABLED_7095912e-fcb9-41dd-aec3-3cf7803e4b22);

PROC
PROC_GEN_OrinsAbduction_KnockedOut_Apply((CHARACTER)_TargetChar)
//AND
//NOT DB_KnockedOut(_TargetChar)
THEN
//DB_PreventKnockedOutPermaDefeated(_TargetChar);
ApplyStatus(_TargetChar, "WYR_ORINSIMPERSONATION_KNOCKEDOUT", -1.0, 0, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//PROC_SetHasDialogIfChar(_TargetChar, 0);

PROC
PROC_GEN_OrinsAbduction_KnockedOut_Remove((CHARACTER)_TargetChar)
//AND
//DB_KnockedOut(_TargetChar)
THEN
//NOT DB_PreventKnockedOutPermaDefeated(_TargetChar);
RemoveStatus(_TargetChar, "WYR_ORINSIMPERSONATION_KNOCKEDOUT", S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//PROC_SetHasDialogIfChar(_TargetChar, 1);
//END_REGION


//REGION Orin kills Yenna in dialog as Orin-Laezel
//PROC
//PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BhaalTemple_State_OrinLaezelKillsYenna_84065b20-4337-4010-87d7-0a62f855298c, (DIALOGRESOURCE)CAMP_OrinAbduction_CFM_Laezel_23ce00ef-2178-950c-42bf-30f4e6cba0d9)
IF
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinLaezelKillsYenna_84065b20-4337-4010-87d7-0a62f855298c)
THEN
NOT DB_InCamp((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
NOT DB_DoNotRemoveKnockedOutCharacterOnLongRest(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
NOT DB_PreventKnockedOutPermaDefeated(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);
PROC_DieImmediate((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, DEATHTYPE.DoT, 1);
PROC_GEN_OrinsAbduction_Yenna_Killcat();

PROC
PROC_GEN_OrinsAbduction_Yenna_Killcat()
THEN
PROC_DieImmediate((CHARACTER)S_GLO_YennasCat_6583b752-ac47-4ae9-ab9d-d75cebaf9b71, DEATHTYPE.Disintegrate, 0);
PROC_SetOnStage(S_GLO_YennasCat_6583b752-ac47-4ae9-ab9d-d75cebaf9b71, 0);
NOT DB_InCamp(S_GLO_YennasCat_6583b752-ac47-4ae9-ab9d-d75cebaf9b71);
//END_REGION

//REGION Yenna dies, reactivity to her body with PAD.
IF
CharacterLootedCharacter(_Player, (CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("GEN_OrinsAbduction_YennaDeadBody")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BhaalTemple_PostLaezelAbduction_PAD_DeadYenna_73203c00-6a82-3542-70d0-9e8d27b565e8, _Player);
//END_REGION

//REGION Setup Yenna's post-Orin-Laezel/Halsin dialog.
PROC
PROC_GEN_OrinsAbduction_PostCampHostage_Yenna_DialogSetup()
THEN
DB_Dialogs(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (DIALOGRESOURCE)LOW_BhaalTemple_PostLaezelAbduction_Yenna_ffa51503-6973-dd90-ba68-6790def99e6d);
DB_GEN_OrinsAbduction_PostCampHostage_TalkedToYenna("No");

// in case Yenna was offstaged for some reason.
PROC
PROC_GEN_OrinsAbduction_PostCampHostage_Yenna_DialogSetup()
AND
DB_OffStage(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
THEN
PROC_SetOnStage(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, 1);

PROC
PROC_LongRest()
AND
DB_GEN_OrinsAbduction_AbductionPlace("InCamp")
AND
DB_GEN_OrinsAbduction_PostCampHostage_TalkedToYenna("No")
THEN
NOT DB_GEN_OrinsAbduction_AbductionPlace("InCamp");
DB_GEN_OrinsAbduction_PostCampHostage_TalkedToYenna("Yes");
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f);

// Related to Yenna goal.
SetFlag(CAMP_Yenna_State_PostAbductionCampChat_d30c5b6a-eada-4c8c-927d-a50de178ec29);
//PROC_ORI_SetupCamp((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, 1);
//DB_Dialogs((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (DIALOGRESOURCE)CAMP_MeetingYenna_SoupVendor_b1b97be3-de2f-c93f-6738-e4d9f9f136cb);


QRY
QRY_SelectCustomDialog_AfterGenerics(S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, _Player)
AND
DB_GEN_OrinsAbduction_AbductionPlace("InCamp")
AND
DB_GEN_OrinsAbduction_PostCampHostage_TalkedToYenna("No")
THEN
DB_SelectedDialog(
	(DIALOGRESOURCE)LOW_BhaalTemple_PostLaezelAbduction_Yenna_ffa51503-6973-dd90-ba68-6790def99e6d,
	(CHARACTER)	S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f,
				_Player);
//END_REGION

//REGION Setup Scratch's post-Orin-Halsin dialog
PROC
PROC_GEN_OrinsAbduction_PostCampHostage_Scratch_DialogSetup()
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_HalsinAbduction_TalkedToScratch_3e1b4fcd-23b8-445a-b89d-549324621645);
//END_REGION


//REGION Orin Teleports Away
PROC 
PROC_GEN_OrinsAbduction_OrinTeleportOut()
THEN
PROC_GEN_OrinsAbduction_PlayEffect_Teleport();
PROC_GlobalClearFlagAndCache((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2);
//TeleportToPosition((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 859.454, -49.573, -22.273);
SetHitpointsPercentage(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 100.0); // heal her back up in case she took damage from the last encounter.
RemoveHarmfulStatuses(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
NOT DB_PreventPermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // remove her from the PerventPermaDefeated so she can die normally again.
TeleportTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, S_GLO_BhaalTemple_OrinTemple_TriggerPos_810e97df-6e10-4ff3-94d4-2a466a3ec7c7, "", 0, 0, 0, 0, 0);
PROC_SceneOver("GEN_OrinsAbduction_Scene");
PROC_SceneOver("GEN_OrinsAbduction_CampScene");
PROC_GEN_OrinsAbduction_ClearDB_OrinAttacker();
PROC_WYR_OrinsImpersonation_OrinJournalist_Spotting_Stop((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//PROC_WYR_OrinsImpersonation_OrinSmith_Spotting_Stop((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); // DISABLED: ADs still interrupt world behaviors, so disabling for now.

//END_REGION

//REGION Remove all items that Orin might have gathered from her impersonations.
// only remove the items if we've saved the items she has before.
PROC
PROC_GEN_OrinsAbduction_Orin_RemoveAllItems()
AND
DB_LOW_BhaalTemple_SavedOrinsInventory(1)
THEN
MoveAllItemsTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, 1, 1, 1, 1); // clear her impersonation items that she might have accumulated.

// she's not in the temple yet, so removing all her items is ok since she hasn't gotten her real set of items yet.
PROC
PROC_GEN_OrinsAbduction_Orin_RemoveAllItems()
AND
NOT DB_LOW_BhaalTemple_SavedOrinsInventory(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2)
THEN
MoveAllItemsTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, 1, 1, 1, 1); // clear her impersonation items that she might have accumulated.
//END_REGION

//REGION Move all items from Orin to Gore Pile
PROC
PROC_GEN_OrinsAbduction_Orin_MoveAllItemsToGore()
THEN
MoveAllItemsTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (ITEM)S_LOW_BhaalTemple_OrinCorpse_502e7d05-9f67-4092-a6ad-c349750720c9, 1, 1, 1);
//END_REGION



//REGION When in dialog, Orin transforms into Gortash. Gameplay must reflect her transformation as well.
IF
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_TransformToGortash_aca677a0-c532-44df-ac77-3156f0c06925)
AND
DB_GEN_OrinsAbduction_OrinTransformRule_Gortash(_TransformRule)
THEN
DB_GEN_OrinsAbduction_IsTransformed(1);
PROC_GEN_OrinsAbduction_PlayEffect_Transform();
Transform((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, (SHAPESHIFTRULE)_TransformRule);
//END_REGION


//REGION When in dialog, Orin transforms into her original form. Flag would be set then. Gameplay must reflect her transformation as well.
IF
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_TransformToOrin_9280b884-9f8e-41f4-bd49-dbfcb2827fe5)
THEN
PROC_GEN_OrinsAbduction_OrinTransformsBack();
//END_REGION

//REGION Orin transforms back to her real form, and remove all items on her.
PROC
PROC_GEN_OrinsAbduction_OrinTransformsBack()
AND
DB_GEN_OrinsAbduction_IsTransformed(1)
THEN
RemoveTransforms((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
PROC_GEN_OrinsAbduction_PlayEffect_Transform(); // plays gameplay effect of her transformation.
NOT DB_GEN_OrinsAbduction_IsTransformed(1);

PROC
PROC_GEN_OrinsAbduction_OrinTransformsBack()
THEN
PROC_GEN_OrinsAbduction_BloodiedChar_Remove((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
PROC_GEN_OrinsAbduction_Orin_RemoveAllItems();
PROC_LOW_BhaalTemple_Orin_Inventory_Restore();
PROC_GEN_OrinsAbduction_Transformation_PlaySound((GUIDSTRING)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);

// When Orin transforms back, try to clean up some values on her
PROC
PROC_GEN_OrinsAbduction_OrinTransformsBack()
AND
DB_GEN_OrinsAbduction_OrinAttacker(_AttackOwner)
THEN
PROC_SetAttitude((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _AttackOwner, 0);
//NOT DB_GEN_OrinsAbduction_OrinAttacker(_AttackOwner);
//END_REGION

//REGION Transform Orin's body upon death.
// when Orin dies, change her body
IF
DB_PermaDefeated((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
TimerLaunch("LOW_BhaalTemple_OrinCorpseTransform", 4000);

IF
TimerFinished("LOW_BhaalTemple_OrinCorpseTransform")
THEN
PROC_GEN_OrinsAbduction_OrinCorpseTransform();

PROC
PROC_GEN_OrinsAbduction_OrinCorpseTransform()
THEN
TeleportTo((ITEM)S_LOW_BhaalTemple_OrinCorpse_502e7d05-9f67-4092-a6ad-c349750720c9, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "GEN_OrinsAbduction_OrinBodySwap", 0, 0, 0, 0, 0);		
PROC_GEN_OrinsAbduction_Orin_MoveAllItemsToGore();

IF
EntityEvent(_, "GEN_OrinsAbduction_OrinBodySwap")
THEN
CreateSurface(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "SurfaceBlood", 1.0, -1.0); // create blood where Orin used to be.
SetOnStage((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0);
//END_REGION


//REGION Power Word Kill Handling
// when Bhaal has given the power to the Dark Urge, give the spell to the player
IF
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalAccepted_904c45e0-bb06-40ed-b5d7-4f1c851b9d86) ////PROC_GlobalFlagReactionAfterDialog
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
AddSpell((CHARACTER)_DarkUrge, "Target_LOW_DarkUrge_PowerWordKill", 1, 0); // give power word kill one time use.
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_GivenPowerWordKill_5247a7dd-d3c8-45fa-98b3-be47194e50f0);
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3); // give slayer form if not already given.

// when players have used the spell, remove it from the players.
IF
FlagCleared((FLAG)ORI_DarkUrge_State_GivenPowerWordKill_5247a7dd-d3c8-45fa-98b3-be47194e50f0, _, _)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
RemoveSpell((CHARACTER)_DarkUrge, "Target_LOW_DarkUrge_PowerWordKill");

IF
CastedSpell(_DarkUrge, "Target_LOW_DarkUrge_PowerWordKill", _, _, _)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
PROC_GlobalClearFlagAndCache((FLAG)ORI_DarkUrge_State_GivenPowerWordKill_5247a7dd-d3c8-45fa-98b3-be47194e50f0);
//END_REGION

//REGION Setup Orin dummy character to look like Gortash for a couple of nodes in the nested dialog file.
PROC
PROC_GEN_OrinsAbduction_SetupOrinGortash()
AND
DB_GEN_OrinsAbduction_OrinTransformRule_Gortash(_TransformRule)
THEN
Transform((CHARACTER)S_GLO_BhaalTemple_OrinGortashDummy_9fcd1601-fb36-4435-b6da-a80cee4edb10, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, (SHAPESHIFTRULE)_TransformRule);
//END_REGION

//REGION If WYR_OrinsImpersonation_State_MetOrinOnce was set, check if it makes sense to set WYR_OrinsImpersonation_State_MetOrinOnce_EnableTG
IF
DB_GlobalFlag((FLAG)WYR_OrinsImpersonation_State_MetOrinOnce_5f82392a-6e8f-4c9b-a927-b9d77ee263ec)
AND
NOT DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d)
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_OrinsImpersonation_State_MetOrinOnce_EnableTG_4f3080c7-7324-4326-9daf-a8f8ffa96551);

//END_REGION


//REGION EFFECTS Teleport, Transform and GetOrinCorpse
PROC
PROC_GEN_OrinsAbduction_PlayEffect_Transform()
AND
GetPosition((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,_X,_Y,_Z)
THEN
PlayEffect(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, EFFECTRESOURCEGUID_VFX_Script_Doppelganger_Poof_01_e78795e5-b5ff-c96c-d6c0-4da52fd527ba, "Dummy_Root");
//PlayEffectAtPosition(VFX_Script_Doppelganger_Poof_01_e78795e5-b5ff-c96c-d6c0-4da52fd527ba,_X,_Y,_Z); 
//PlayEffectAtPosition(EFFECTRESOURCEGUID_VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416,_X,_Y,_Z);
//PlayEffectAtPosition(EFFECTRESOURCEGUID_VFX_Script_Raphael_Poof_TeleportIn_01_f7880749-91d9-68dd-9675-ec33dbbc7936,_X,_Y,_Z);


PROC
PROC_GEN_OrinsAbduction_PlayEffect_Teleport()
AND
GetPosition((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,_X,_Y,_Z)
THEN
PlayEffectAtPosition(EFFECTRESOURCEGUID_VFX_Script_Orin_Teleportation_96add906-01fb-1af0-239e-72c229b48915,_X,_Y,_Z); 
//PlayEffect(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, EFFECTRESOURCEGUID_VFX_Script_Orin_Teleportation_96add906-01fb-1af0-239e-72c229b48915);
//PlayEffect(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, EFFECTRESOURCEGUID_VFX_Script_Orin_Teleportation_96add906-01fb-1af0-239e-72c229b48915, "Dummy_Root");
//PlayEffectAtPosition(VFX_Script_Doppelganger_Poof_01_e78795e5-b5ff-c96c-d6c0-4da52fd527ba,_X,_Y,_Z); 
//PlayEffectAtPosition(EFFECTRESOURCEGUID_VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416,_X,_Y,_Z); 
//PlayEffectAtPosition(EFFECTRESOURCEGUID_VFX_Script_Raphael_Poof_TeleportIn_01_f7880749-91d9-68dd-9675-ec33dbbc7936,_X,_Y,_Z); 

PROC
PROC_GEN_OrinsAbduction_PlayEffect_TeleportOnCharPoof((CHARACTER)_TargetChar)
AND
GetPosition((CHARACTER)_TargetChar, _X,_Y,_Z)
THEN
PlayEffectAtPosition(EFFECTRESOURCEGUID_VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416,_X,_Y,_Z); 
//END_REGION

//REGION EFFECTS Bloody the Altar after someone dies on it.
PROC
PROC_GEN_OrinsAbduction_Altar_PlayEffect_Bloodied()
THEN
PROC_LoopEffect((EFFECTRESOURCE)VFX_Script_LOW_BhaalTemple_TempleAltar_Blood_01_5a488740-246e-9d64-e4f4-0f553101b31b, S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, "LOW_BhaalTemple_Altar_Bloodied", "CTY_Main_A", "");
//PlayEffect((ITEM)S_LOW_BhaalTemple_TempleAltar_64b08f01-5e3f-4ca2-9603-4e8c85c80e8e, EFFECTRESOURCEGUID_VFX_Script_LOW_BhaalTemple_TempleAltar_Blood_01_5a488740-246e-9d64-e4f4-0f553101b31b);
//END_REGION

//REGION EFFECTS Bloody the character
PROC
PROC_GEN_OrinsAbduction_BloodiedChar_Apply((CHARACTER)_Target)
THEN
//ApplyStatus((CHARACTER)_Target, "BLOOD_COVERED_FULL", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000); //BLOOD_COVERED_FULL //BLOOD_COVERED_SLIGHT
ApplyStatus((CHARACTER)_Target, "BLOOD_COVERED_FULL", -1.0, 1, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); //BLOOD_COVERED_FULL //BLOOD_COVERED_SLIGHT


PROC
PROC_GEN_OrinsAbduction_BloodiedChar_Remove((CHARACTER)_Target)
AND
HasActiveStatus((CHARACTER)_Target, "BLOOD_COVERED_SLIGHT", 1)
THEN
RemoveStatus((CHARACTER)_Target, "BLOOD_COVERED_SLIGHT", S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//PROC to remove blood.

//END_REGION

//REGION EFFECT SOUND Play music when Orin reveals herself during an impersonation
PROC
PROC_GEN_OrinsAbduction_Transformation_PlaySound((GUIDSTRING)_Target)
THEN
MusicPlayGeneral("Explo_Orin_impersonation");
//END_REGION


//REGION Clear DBs
PROC
PROC_GEN_OrinsAbduction_ClearDBs()
THEN
PROC_GEN_OrinsAbduction_ClearDB_ChosenChar();
PROC_GEN_OrinsAbduction_ClearDB_CFM_Orin();
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharFlag();

PROC
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharRelationship()
AND
DB_GEN_OrinsAbduction_ChosenCharRelationship(_PrevVal)
THEN
NOT DB_GEN_OrinsAbduction_ChosenCharRelationship(_PrevVal);

PROC
PROC_GEN_OrinsAbduction_ClearDB_ChosenChar()
AND
DB_GEN_OrinsAbduction_ChosenChar(_PrevVal)
THEN
NOT DB_GEN_OrinsAbduction_ChosenChar(_PrevVal);

PROC
PROC_GEN_OrinsAbduction_ClearDB_CFM_Orin()
AND
DB_GEN_OrinsAbduction_CFM_Orin(_PrevVal)
THEN
NOT DB_GEN_OrinsAbduction_CFM_Orin(_PrevVal);

PROC
PROC_GEN_OrinsAbduction_ClearDB_ChosenName()
AND
DB_GEN_OrinsAbduction_ChosenName(_PrevVal)
THEN
NOT DB_GEN_OrinsAbduction_ChosenName(_PrevVal);

PROC
PROC_GEN_OrinsAbduction_ClearDB_CurCampTrigPos()
AND
DB_GEN_OrinsAbduction_CurCampTrigPos(_PrevVal)
THEN
NOT DB_GEN_OrinsAbduction_CurCampTrigPos(_PrevVal);

PROC
PROC_GEN_OrinsAbduction_ClearDB_ChosenCharFlag()
AND
DB_GEN_OrinsAbduction_ChosenCharFlag(_PrevVal)
THEN
NOT DB_GEN_OrinsAbduction_ChosenCharFlag(_PrevVal);

PROC
PROC_GEN_OrinsAbduction_ClearDB_OrinAttacker()
AND
DB_GEN_OrinsAbduction_OrinAttacker(_PrevVal)
THEN
NOT DB_GEN_OrinsAbduction_OrinAttacker(_PrevVal);


// Singleton for tracking if players had spoken to Yenna yet for post Laezel Abduction.
IF
DB_GEN_OrinsAbduction_PostCampHostage_TalkedToYenna(_NewState)
AND
DB_GEN_OrinsAbduction_PostCampHostage_TalkedToYenna(_OldState)
AND
_NewState != _OldState
THEN
NOT DB_GEN_OrinsAbduction_PostCampHostage_TalkedToYenna(_OldState);


// Singleton for tracking to track if Abductee is still on the altar or not to play the ExamineAbductee dialog.
IF
DB_GEN_OrinsAbduction_Abductee_ExamineAbducteeDialog(_NewState)
AND
DB_GEN_OrinsAbduction_Abductee_ExamineAbducteeDialog(_OldState)
AND
_NewState != _OldState
THEN
NOT DB_GEN_OrinsAbduction_Abductee_ExamineAbducteeDialog(_OldState);


// Singleton 
IF
DB_GEN_OrinsAbduction_OrinInAttackedDialog(_NewState)
AND
DB_GEN_OrinsAbduction_OrinInAttackedDialog(_OldState)
AND
_NewState != _OldState
THEN
NOT DB_GEN_OrinsAbduction_OrinInAttackedDialog(_OldState);


//END_REGION


//REGION DEBUG checking DBs
IF
TextEvent("BTCheckPartyFollowersDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTCheckPartyFollowersDB");
PROC_GEN_OrinsAbduction_Check_PartyFollowersDB();

PROC
PROC_GEN_OrinsAbduction_Check_PartyFollowersDB()
AND
DB_PartyFollowers(_Char)
AND
GUIDToString(_Char, _ReturnString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _ReturnString);

IF
TextEvent("BTCheckCampDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "Check Camp DB");
PROC_GEN_OrinsAbduction_CheckCampDB();

PROC
PROC_GEN_OrinsAbduction_CheckCampDB()
AND
DB_InCamp(_Char)
AND
GUIDToString(_Char, _ReturnString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _ReturnString);

IF
TextEvent("BTCheckPlayerDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "Check Player DB");
PROC_GEN_OrinsAbduction_CheckPlayerDB();

PROC
PROC_GEN_OrinsAbduction_CheckPlayerDB()
AND
DB_Players(_Char)
AND
GUIDToString(_Char, _ReturnString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _ReturnString);

IF
TextEvent("BTCheckCampLocDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTCheckCampLocDB");
PROC_Debug_CheckCampLoc();

PROC
PROC_Debug_CheckCampLoc()
AND
DB_ActiveCamp("SLUMS")
AND
DB_GEN_OrinsAbduction_OrinAbductionPosList("SLUMS", _TriggerPos)
AND
GetHostCharacter(_Player)
AND
GUIDToString(_TriggerPos, _ReturnString)
AND
Concatenate(" Slums_TriggerPos: ", _ReturnString, _FinalString)
THEN
DebugText(_Player, _FinalString);

PROC
PROC_Debug_CheckCampLoc()
AND
DB_ActiveCamp("ELFSONG")
AND
DB_GEN_OrinsAbduction_OrinAbductionPosList("ELFSONG", _TriggerPos)
AND
GetHostCharacter(_Player)
AND
GUIDToString(_TriggerPos, _ReturnString)
AND
Concatenate("Elfsong_TriggerPos: ", _ReturnString, _FinalString)
THEN
DebugText(_Player, _FinalString);

PROC
PROC_Debug_CheckCampLoc()
AND
DB_ActiveCamp("FARM")
AND
DB_GEN_OrinsAbduction_OrinAbductionPosList("FARM", _TriggerPos)
AND
GetHostCharacter(_Player)
AND
GUIDToString(_TriggerPos, _ReturnString)
AND
Concatenate("FARM_TriggerPos: ", _ReturnString, _FinalString)
THEN
DebugText(_Player, _FinalString);

IF
TextEvent("BTCheckActiveCampDB")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "Check Active Camp DB");
PROC_GEN_OrinsAbduction_CheckActiveCampDB();

PROC
PROC_GEN_OrinsAbduction_CheckActiveCampDB()
AND
DB_ActiveCamp(_CampName)
AND
Concatenate(": ", _CampName, _ReturnString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _ReturnString);

IF
TextEvent("BTCheckChosenCharDB")
AND
DB_GEN_OrinsAbduction_ChosenChar(_Char)
AND
GUIDToString(_Char, _ReturnString)
AND
Concatenate("ChosenChar: ", _ReturnString, _FinalString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _FinalString);


IF
TextEvent("BTCheckChosenNameDB")
THEN
PROC_Debug_GEN_OrinsAbduction_DisplayChosenName();

PROC
PROC_Debug_GEN_OrinsAbduction_DisplayChosenName()
AND
DB_GEN_OrinsAbduction_ChosenName(_Char)
AND
Concatenate("ChosenName: ", _Char, _FinalString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _FinalString);

IF
TextEvent("BTCheckChosenRelationshipDB")
AND
DB_GEN_OrinsAbduction_ChosenCharRelationship(_Char)
AND
GUIDToString(_Char, _ReturnString)
AND
Concatenate("CheckChosenRelationshipDB: ", _ReturnString, _FinalString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _FinalString);

IF
TextEvent("BTCheckYennaDBChildren")
AND
DB_Children((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTCheckYennaDBChildren: TRUE");

IF
TextEvent("BTCheckPermaDefeated")
AND
DB_PermaDefeated((CHARACTER)S_GLO_OrinsImpersonation_Smith_2ac966aa-3372-419a-902a-8330925830ef)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTCheckPermaDefeated: TRUE");

IF
TextEvent("BTCheckChosenHalsinVictimDB")
AND
DB_GEN_OrinsAbduction_ChosenHalsinVictim(_CharName, _)
AND
Concatenate("BTCheckChosenHalsinVictimDB: ", _CharName, _FinalString)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, _FinalString);

//END_REGION


//REGION DEBUG Commands

IF
TextEvent("BTWakeHalsinVictim")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTWakeHalsinVictim");
PROC_GEN_OrinsAbduction_WakeUpCampAbductee();

IF
TextEvent("BTDieSmith")
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_OrinsImpersonation_Smith_2ac966aa-3372-419a-902a-8330925830ef)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTDieSmith");
Die(S_GLO_OrinsImpersonation_Smith_2ac966aa-3372-419a-902a-8330925830ef,DEATHTYPE.DoT,1);

IF
TextEvent("OAEnableAbduction")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAEnableAbduction");
PROC_GEN_OrinsAbduction_Debug_EnableAbduction();

PROC
PROC_GEN_OrinsAbduction_Debug_EnableAbduction()
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_KillDirectorGortash_Knows_CampCompromised_62f279b8-9f36-4f4a-92d3-edc16cb4d760);  // Gortash told players about Orin, therefore enable InCamp Abductions, and disable InWorld Impersonations.
PROC_GEN_OrinsAbduction_InCampAbductions_Init();
PROC_GEN_OrinsAbduction_InWorldAbductions_Init();
PROC_GEN_OrinsAbduction_InWorldImpersonations_Disable();



IF
TextEvent("OAGiveKethericNetherstone") // for testing purposes
AND
GetHostCharacter((CHARACTER)_Player)
THEN
DebugText(_Player, "OAGiveKethericNetherstone");
ToInventory(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, _Player);

IF
TextEvent("OAGiveGortashNetherstone")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAGiveGortashNetherstone");
PROC_GEN_OrinsAbduction_Debug_GiveGortashNetherstone();

PROC
PROC_GEN_OrinsAbduction_Debug_GiveGortashNetherstone()
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_WYR_CrownController_Gortash_383be300-d328-4152-86df-4927482d1fd7, _Player);

IF
TextEvent("OASetKilledGortash")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OASetKilledGortash");
PROC_GEN_OrinsAbduction_Debug_SetKilledGortash();

PROC
PROC_GEN_OrinsAbduction_Debug_SetKilledGortash()
THEN
Die((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, DEATHTYPE.DoT, 1); // will set the perma-defeated, so DB can be reacted to.
PROC_GlobalSetFlagAndCache(GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769); // have to set this if we haven't loaded WYR yet, so Gortash won't be able to die if he's not loaded.

IF
TextEvent("OASetTalkedToGortash")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OASetTalkedToGortash");
PROC_GlobalSetFlagAndCache((FLAG)GLO_Gortash_HasMet_74cffb8f-fc93-4c67-a12e-aa2cc8890291);
PROC_GlobalSetFlagAndCache((FLAG)WYR_KillDirectorGortash_Knows_CampCompromised_62f279b8-9f36-4f4a-92d3-edc16cb4d760);  // Gortash told players about Orin, therefore enable InCamp Abductions, and disable InWorld Impersonations.


IF
TextEvent("OALearnAboutBhaalTemple")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OALearnAboutBhaalTemple");
PROC_GlobalSetFlagAndCache((FLAG)LOW_MurderTribunal_Knows_BhaalTempleLocation_0a45cd29-8ae1-43bb-9ef6-b95af1dc6e55);

IF
TextEvent("BTForceCampNight") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTForceCampNight");
PROC_CampNight_StartSelected();

IF
TextEvent("BTSetupDummies") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "BTSetupDummies");
PROC_GEN_OrinsAbduction_SetupDummies();

IF
TextEvent("OATryPlayADAfterTransform_WithSpeakerGroup") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OATryPlayADAfterTransform_WithSpeakerGroup");
TeleportTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _Player, "", 0, 0, 0, 0, 0);		
DB_GEN_OrinsAbduction_IsTransformed(1);
Transform((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, S_WYR_Circus_LoveDryad_a8bce35d-17ee-46e3-8d56-1d0d29c4a01e, (SHAPESHIFTRULE)WYR_OrinsImpersonation_79876d09-46c3-4025-96ce-db6969f249f0);
PROC_TryStartAD((DIALOGRESOURCE)WYR_Circus_AD_LoveDryad_0a121d28-d4e8-07bb-6a70-404c247e5d48, 
				(CHARACTER)	S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);


IF
TextEvent("OATryPlayADAfterTransform_WithoutSpeakerGroup") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OATryPlayADAfterTransform_WithoutSpeakerGroup");
TeleportTo((CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, _Player, "", 0, 0, 0, 0, 0);		
DB_GEN_OrinsAbduction_IsTransformed(1);
Transform((CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, S_WYR_Circus_LoveDryad_a8bce35d-17ee-46e3-8d56-1d0d29c4a01e, (SHAPESHIFTRULE)WYR_OrinsImpersonation_79876d09-46c3-4025-96ce-db6969f249f0);
PROC_TryStartAD((DIALOGRESOURCE)WYR_Circus_AD_LoveDryad_0a121d28-d4e8-07bb-6a70-404c247e5d48, 
				(CHARACTER)	S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec);

//DB_Dialogs((CHARACTER)S_GOB_Festivities_Trader_3c9f9d17-835c-46bf-929d-240e3b4adb55, GOB_Festivities_Trader_baaf58f0-558d-7a40-9eaf-639b8bc6fddb);
//CopyCharacterEquipment((CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, (CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101); //copy over Orin's Equipment (assuming combat had set up a unique EQ), so we can copy it back to her later.)

IF
TextEvent("OAKnockoutStatusOnDummyApply") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAKnockoutStatusOnDummyApply");
TeleportTo((CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, _Player, "", 0, 0, 0, 0, 0);		
PROC_GEN_OrinsAbduction_Temple_KnockedOut_Apply((CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec);

IF
TextEvent("OAKnockoutStatusOnDummyRemove") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAKnockoutStatusOnDummyRemove");
PROC_GEN_OrinsAbduction_Temple_KnockedOut_Remove((CHARACTER)S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec);

IF
TextEvent("OADUAcceptedBhaal") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OADUAcceptedBhaal");
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_BhaalAccepted_904c45e0-bb06-40ed-b5d7-4f1c851b9d86);

IF
TextEvent("OAAltarBloodied") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAAltarBloodied");
PROC_GEN_OrinsAbduction_Altar_PlayEffect_Bloodied();


IF
TextEvent("OALearnOrinMother") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OALearnOrinMother");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Knows_OrinsMother_329be152-2e04-4b9c-85c6-055efad23da8);

IF
TextEvent("OALearnSarevokOrderedOrinDead") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OALearnSarevokOrderedOrinDead");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_Knows_SarevokOrderedOrinDead_e13e6f51-977b-f828-ac47-f7cd6f7e03e2);

IF
TextEvent("OAOrinMotherEnable") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinMotherEnable");
PROC_LOW_BhaalTemple_OrinsMother_Enable();

IF
TextEvent("OAOrinMotherUseBed") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinMotherUseBed");
PROC_LOW_BhaalTemple_OrinsMother_UseBed();

IF
TextEvent("OAOrinMotherTeleportBed") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinMotherTeleportBed");
PROC_LOW_BhaalTemple_OrinsMother_TeleportBed();

IF
TextEvent("OAOrinMotherKill") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinMotherKill");
PROC_LOW_BhaalTemple_OrinsMother_Kill();

IF
TextEvent("OAOrinMotherResurrect") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinMotherResurrect");
PROC_LOW_BhaalTemple_OrinsMother_Resurrect();

IF
TextEvent("OAOrinMotherPlayDeadAnim") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinMotherPlayDeadAnim");
PROC_LOW_BhaalTemple_OrinsMother_PlayDeadAnim();

IF
TextEvent("OAOrinMotherApplyStatus") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinMotherApplyStatus");
PROC_LOW_BhaalTemple_OrinsMother_ApplyStatus();




IF
TextEvent("OAPlayerTransformSlayer") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAPlayerTransformSlayer");
PROC_LOW_BhaalTemple_PlayerTransformIntoSlayer();

IF
TextEvent("OAForcePlayerTransformSlayer") // for testing purposes
AND
GetHostCharacter(_Player)
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
THEN
DebugText(_Player, "OAForcePlayerTransformSlayer");
UseSpell(_DarkUrge, "Shout_DarkUrge_Slayer", _DarkUrge);

IF
TextEvent("OAForcePlayerTransformSlayer2") // for testing purposes
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAForcePlayerTransformSlayer2");
SetFlag((FLAG)ORI_DarkUrge_State_SlayerForm_88b450d5-3815-4f5d-0c6f-0de221513d64, _DarkUrge, 0);



IF
TextEvent("OAOrinGem_Start") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinGem_Start");
QuestUpdate("GLO_OrinContolGem", "LearnedAboutOrin");


IF
TextEvent("OAOrinGem_LearnedAboutTemple1") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinGem_LearnedAboutTemple1");
PROC_GlobalSetFlagAndCache((FLAG)LOW_SerialKiller_Knows_TargetList_262314d1-43bf-4ea5-ae23-4a77bfab2671);

IF
TextEvent("OAOrinGem_LearnedAboutTemple2") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAOrinGem_LearnedAboutTemple2");
PROC_GlobalSetFlagAndCache((FLAG)LOW_Elfsong_State_AllowHelpDevella_6692d31b-c2a1-4c1f-6471-1a2c701867dd);

IF
TextEvent("OAForceAttackedDialog") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAForceAttackedDialog");
PROC_GEN_OrinsAbduction_OrinAttacked_StartDialog(_Player);

IF
TextEvent("OACheckVersion") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OrinStoryVersion: 18-05-2023");

IF
TextEvent("OATeleportYennaToMe") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OATeleportYennaToMe");
TeleportTo((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, _Player, "", 0, 0, 0, 0, 0);		// used as Orin's voice.

IF
TextEvent("OAUnsheathed") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAUnsheathed");
SetWeaponUnsheathed((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, 1, 1);

IF
TextEvent("OAPlayAnim1") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAPlayAnim1");
PlayAnimation((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (ANIMATION)CUST_Idle_Still_Combat_01_590ea7e8-ae43-4307-916b-b1133ef47dfa, "");

IF
TextEvent("OAPlayAnim2") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAPlayAnim2");
PlayAnimation((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (ANIMATION)CUST_Training_Sword_01_51d4761b-2b2e-41a3-b52b-40b6700d6e39, "");

IF
TextEvent("OAPlayAnim3") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAPlayAnim3");
SetWeaponUnsheathed((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, 1, 1);
PlayAnimation((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (ANIMATION)CUST_Training_Sword_01_51d4761b-2b2e-41a3-b52b-40b6700d6e39, "");
TimerLaunch("PlayCombatAnim", 2800);

IF
TimerFinished("PlayCombatAnim")
THEN
PlayAnimation((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (ANIMATION)CUST_Idle_Still_Combat_01_590ea7e8-ae43-4307-916b-b1133ef47dfa, "");

IF
TextEvent("OAPlayAll") // for testing purposes
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OAPlayAll");
PlayAnimation((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (ANIMATION)CUST_Idle_Still_Combat_01_590ea7e8-ae43-4307-916b-b1133ef47dfa, "Anim1");

IF
EntityEvent((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, "Anim1")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "EntityEvent1");
PlayAnimation((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (ANIMATION)CUST_Training_Sword_01_51d4761b-2b2e-41a3-b52b-40b6700d6e39, "Anim2");

IF
EntityEvent((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, "Anim2")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "EntityEvent2");
PlayAnimation((CHARACTER)S_GLO_Yenna_d496d903-d3d6-4314-a324-18542de77b0f, (ANIMATION)CUST_Idle_Still_Combat_01_590ea7e8-ae43-4307-916b-b1133ef47dfa, "");

IF
TextEvent("BTOrinCorpseTransform")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTOrinCorpseTransform");
PROC_GEN_OrinsAbduction_OrinCorpseTransform();

IF
TextEvent("BTOrinCorpseTransformBack")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "BTOrinCorpseTransformBack");
RemoveTransforms(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
SetHitpointsPercentage(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 0.0);

IF
TextEvent("OAOrinsTitleGet")
AND
GetHostCharacter(_Char)
AND
ObjectGetTitle(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _TranslatedStringKey)
AND
ResolveTranslatedString(_TranslatedStringKey, _TranslatedString)
AND
Concatenate("OAOrinsTitleGet :", _TranslatedString, _ReturnString)
THEN
DebugText(_Char, _ReturnString);
// need proc to save/load her title when she does her impersonations

IF
TextEvent("OAOrinsTitleSave")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "OAOrinsTitleSave");
PROC_GEN_OrinsAbduction_Orin_SaveTitle();

IF
TextEvent("OAOrinsTitleClear")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "OAOrinsTitleClear");
PROC_GEN_OrinsAbduction_Orin_ClearTitle();

IF
TextEvent("OAOrinsTitleRestore")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "OAOrinsTitleRestore");
PROC_GEN_OrinsAbduction_Orin_RestoreTitle();

IF
TextEvent("OITransformSFXPlay")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OITransformSFXPlay");
PROC_GEN_OrinsAbduction_Transformation_PlaySound((GUIDSTRING)_Player);

IF
TextEvent("OARestoreOrin")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OARestoreOrin");
PROC_GLO_Bugfix_305346_RestoreOrin();

IF
TextEvent("OATryRestoreDagger")
AND
GetHostCharacter(_Player)
THEN
DebugText(_Player, "OATryRestoreDagger");
PROC_GLO_Bugfix_317998_TryRestoreDagger();
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3_GEN"
