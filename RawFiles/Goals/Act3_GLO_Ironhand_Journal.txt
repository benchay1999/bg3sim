Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION LOW_Foundry - Avenge the Ironhands
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_WulbrenToldSteelWatch_48b3c3f0-e78a-4277-8ef9-b9cc0a4d8960, "LOW_Foundry", "TalkedWithWulbren");
DB_QuestDef_State((FLAG)WYR_Wulbren_State_InterruptedByBarcus_f2211dd4-5494-66b1-5e7b-01664f7287b0, "LOW_Foundry", "TalkedToBarcus");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_FoundryVisited_5c929efe-ffe2-4eeb-8853-da29735b53ab,"LOW_Foundry","EnteredFoundry");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_ControlCentreWatchersDefeated_c4eb7726-fdb8-4e53-84a3-9ec1e955d154,"LOW_Foundry","DefeatedTitan");
DB_QuestDef_State((FLAG)WYR_Ironhand_BombDestroyed_8ed705b5-6f86-4cff-8c14-cc1c7b87ad9c,"LOW_Foundry","WastedBomb");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_KnownsHowToDisableNeurocitor_0df02f4a-0d44-f355-4638-9aee2ea61fde, "LOW_Foundry", "DiscoveredSecretCode");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_Knows_FoundryDestroyedByBrain_2274d648-53f4-4107-9256-a5c6332dc283, "LOW_Foundry", "DiscoveredDestroyedFoundry");
DB_QuestDef_State((FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b, "LOW_Foundry", "DestroyedFoundry");
DB_QuestDef_State((FLAG)WYR_Ironhand_State_WulbrenPermaDefeated_b837a5cd-31f9-4cfc-b341-dee71e93a067,"LOW_Foundry","WulbrenDied");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_Outcome_WulbrenSatisfied_5761bbee-eafa-4a61-a5fb-e83d9a77a9f9,"LOW_Foundry","Outcome_AllGondiansDead");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83,"LOW_Foundry","Outcome_SidedWithWulbren");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_Event_WulbrenCombat_b4d7b17e-3c19-3140-b91a-3eb0574e9f7d,"LOW_Foundry","Outcome_SidedWithGondians_WulbrenDead");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c,"LOW_Foundry","Outcome_SidedWithGondians_WulbrenLeft");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_GondianIronhandPeace_34d84919-7ad8-a715-d8a9-abc24e8a4800,"LOW_Foundry","Outcome_BrokeredPeace");
DB_QuestDef_State((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99, "LOW_Foundry", "EnteredEND");
//END_REGION

//REGION LOW_SaveGondians - Save the Gondians
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_AgreedToHelpGondians_5acaf88a-ea7d-3e0d-ef62-c33e8b4203d1, "LOW_SaveGondians", "AgreedToHelpZanner");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_IRNLocationDiscovered_02ea0627-74cc-486c-9d30-f96483374711, "LOW_SaveGondians", "FoundClue");
DB_QuestDef_State((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c, "LOW_SaveGondians", "EnteredIronThrone");
DB_QuestDef_State((FLAG)IRN_IronThrone_State_TalkedToObelia_fa1ce0db-c0aa-4c2f-9570-cfd721283e8a, "LOW_SaveGondians", "TalkedToObelia_InIRN");
DB_QuestDef_State((FLAG)IRN_IronThrone_State_AllLivingGondiansSaved_5eb35e89-7bad-468c-9fc7-e2ecee1d7386 , "LOW_SaveGondians", "AllLivingGondiansSaved");
DB_QuestDef_State((FLAG)IRN_IronThrone_State_AgreedToHelpFoundryGondians_35c2874d-84b0-4345-8a4a-f99b4391932a, "LOW_SaveGondians", "AgreedToHelpFreedHostages");
//DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_ToldToStillDestroyFoundry_f9739a52-a395-48f7-b3d7-c3b34412a60f, "LOW_SaveGondians", "TalkedToSurvivors"); //on hold
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_JoinedFoundryConfrontation_691eaaff-674d-4ecb-a776-5bc52f9170f1, "LOW_SaveGondians", "JoinedFoundryConfrontation");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_ReportedToToobin_f23820a0-e614-475a-9fd4-4ff8920b6ffc, "LOW_SaveGondians", "ReportedToZanner_AfterIRN");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_LiedToFundango_bb487579-d501-f13a-f32b-2643f93f80b9, "LOW_SaveGondians", "LiedToZanner_AfterIRN");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_FundangoBySwitchBoard_d4ba6a0d-8233-4fdc-999b-8c75d598a375, "LOW_SaveGondians", "DefeatedControlCentreWatchers_ZannerPresent");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_TitanDefeatedWithoutToobinPresent_b0c70e67-f759-4e42-8568-93bc695e7437, "LOW_SaveGondians", "DefeatedControlCentreWatchers_ZannerAway");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_TitanDefeatedWithToobinDead_2fac6404-0e6b-48a5-b7cb-2500840aa4f6, "LOW_SaveGondians", "DefeatedControlCentreWatchers_ZannerDead");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83, "LOW_SaveGondians", "FinalConfrontation_SidedWithWulbren");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_Outcome_NoWulbren_9117a2ef-dbb6-48e7-a5f1-4cab02f3db72, "LOW_SaveGondians", "FinalConfrontation_NoWulbren");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_Event_WulbrenCombat_b4d7b17e-3c19-3140-b91a-3eb0574e9f7d, "LOW_SaveGondians", "FinalConfrontation_SidedWithGondians_Combat");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c,"LOW_SaveGondians", "FinalConfrontation_SidedWithGondians_Peaceful");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_GondianIronhandPeace_34d84919-7ad8-a715-d8a9-abc24e8a4800, "LOW_SaveGondians", "FinalConfrontation_AchievedPeace");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_AllGondiansDead_5d620b89-5101-402b-8424-8135c2f800d5, "LOW_SaveGondians", "AllGondiansDead");
DB_QuestDef_State((FLAG)LOW_Steelwatchfoundry_State_ToldZannerHostagesDied_677fdfee-6ccd-49b5-9984-172ff5b61e6c, "LOW_SaveGondians", "ToldZannerHostagesDead");
DB_QuestDef_State((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99, "LOW_SaveGondians", "EnteredEND");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_Knows_FoundryDestroyedByBrain_2274d648-53f4-4107-9256-a5c6332dc283, "LOW_SaveGondians", "GortashDead");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_KillSwitchKilledGondians_8930425e-fa90-41b2-a222-67eacf8753f5, "LOW_SaveGondians","AllGondiansDead_BySwitch");
//END_REGION
KBSECTION
//REGION LOW_Foundry - Avenge the Ironhands
// GnomesIntervented
PROC
PROC_GlobalFlagReactionAfterDialog(WYR_Ironhand_Event_GnomesIntervent_06ad5471-b210-4ea0-a390-09bc7afdd332,WYR_South_Primary_f03a1685-b148-b70e-b773-b62404525308,_DialogID)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_Foundry", "TalkedWithWulbren")
THEN
QuestUpdate("LOW_Foundry", "GnomesIntervented");

//Only update with Barcus's request once we have the original request from Wulbren
IF
DB_GlobalFlag(WYR_Ironhand_Event_InvestigateQuest_Offered_bf4bd7b5-8a79-43a6-bc7b-4ae62cfe4302)
AND
DB_GlobalFlag(WYR_KillDirectorGortash_State_WulbrenToldSteelWatch_48b3c3f0-e78a-4277-8ef9-b9cc0a4d8960)
THEN
QuestUpdate("LOW_Foundry", "TalkedToBarcus");

// we can't switch markers atm through the journal, so needs a little bit of a manual work (since we don't know which gnome needs a marker)
IF
QuestUpdateUnlocked(_Player, "LOW_Foundry", "GnomesIntervented")
AND
DB_WYR_Ironhand_SceneGnomes(1, (CHARACTER)S_WYR_Ironhand_Artificer_001_627b5b4d-51df-416a-800a-ddf357c96995)
AND
DB_Players(_Player)
THEN
DB_WYR_Ironhand_Journal_FollowGnomesMarker((CHARACTER)_Player, "WYR_Ironhand_Artificer");

IF
QuestUpdateUnlocked(_Player, "LOW_Foundry", "GnomesIntervented")
AND
DB_WYR_Ironhand_SceneGnomes(1, (CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5)
AND
DB_Players(_Player)
THEN
DB_WYR_Ironhand_Journal_FollowGnomesMarker((CHARACTER)_Player, "WYR_Ironhand_Nimble");

IF
DB_WYR_Ironhand_Journal_FollowGnomesMarker((CHARACTER)_Player, _MarkerID)
THEN
PROC_ShowMarker((CHARACTER)_Player, _MarkerID);

PROC
PROC_WYR_Ironhand_Journal_ClearFollowMarker()
AND
DB_WYR_Ironhand_Journal_FollowGnomesMarker(_Player, _MarkerID)
THEN
NOT DB_WYR_Ironhand_Journal_FollowGnomesMarker(_Player, _MarkerID);
PROC_HideMarker(_Player, _MarkerID);

IF
QuestUpdateUnlocked(_, "LOW_Foundry", _QuestUpdate)
AND
_QuestUpdate != "GnomesIntervented"
THEN
PROC_WYR_Ironhand_Journal_ClearFollowMarker();

// FollowedGnomeGone
IF
DB_WYR_Ironhand_Checkpoint_Candidate(1, _Gnome)
AND
DB_WYR_Ironhand_SceneGnomes(1, _Gnome)
AND
DB_PermaDefeated(_Gnome)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_Foundry", "GnomesIntervented")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_Foundry", "EnteredHideout")
THEN
QuestUpdate("LOW_Foundry", "FollowedGnomeGone");

// EnteredHideout
IF
DB_InRegion(_Player, (TRIGGER)S_WYR_Ironhand_SUB_55832d9c-360c-483f-977a-bb6c4beb4eb0)
AND
DB_Players(_Player)
AND
NOT DB_WYR_Ironhand_UpdatedEntering(1)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_Foundry", "GnomesIntervented")
THEN
DB_WYR_Ironhand_UpdatedEntering(1); // to avoid log spamming
QuestUpdate("LOW_Foundry", "EnteredHideout");

IF
FlagSet((FLAG)WYR_Ironhand_State_PlayerSawGnomes_d2378ff6-22b2-4f31-aa4e-947408de5cdc, _,_)
AND
DB_QuestIsAccepted("LOW_Foundry")
AND
NOT DB_WYR_Ironhand_UpdatedEntering(1)
THEN
DB_WYR_Ironhand_UpdatedEntering(1);
QuestUpdate("LOW_Foundry", "EnteredHideout");

// PickedupBomb
IF
AddedTo(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
QuestUpdate("LOW_Foundry", "PickedupBomb");

//Gortash's death caused the foundry's collapse, and the player found Wulbren by the Foundry
IF
DialogEnded(LOW_SteelWatchFoundry_WulbrenThanks_23985c4f-1b42-5820-f757-e56ea3957746, _)
AND
DB_WYR_IronHand_WulbrenWaitingAtFoundry(1)
THEN
NOT DB_WYR_IronHand_WulbrenWaitingAtFoundry(1);
QuestUpdate("LOW_Foundry", "GortashDead");
SetFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98);
//END_REGION

//REGION LOW_SaveGondians - Save the Gondians
//All surviving Gondians in the Iron throne have been saved
//In Act3i_IRN_IronThrone goal file

//Entering warehouse (only IF you already know about the prison)
IF
DB_InRegion(_Player, S_LOW_WarehouseInterior_88801975-6707-43ee-8644-3aa6d99c24e2)
AND
DB_Players(_Player)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_IRNLocationDiscovered_02ea0627-74cc-486c-9d30-f96483374711)
AND
QRY_OnlyOnce("LOW_SaveGondians_EnteredWarehouse")
THEN
QuestUpdate("LOW_SaveGondians", "EnteredWarehouse");
//Going to share this trigger with Belly of the Beast quest
//PROC_TriggerUnregisterForPlayers(S_LOW_WarehouseInterior_88801975-6707-43ee-8644-3aa6d99c24e2);

//Entering warehouse basement (only IF you already know about the prison)
IF
DB_InRegion(_Player, S_LOW_SubmersibleFoundArea_33e66469-ee7c-44e0-ab28-0413cda48d31)
AND
DB_Players(_Player)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_IRNLocationDiscovered_02ea0627-74cc-486c-9d30-f96483374711)
AND
QRY_OnlyOnce("LOW_SaveGondians_EnteredWarehouseBasement")
THEN
QuestUpdate("LOW_SaveGondians", "EnteredWarehouseBasement");
PROC_TriggerUnregisterForPlayers(S_LOW_SubmersibleFoundArea_33e66469-ee7c-44e0-ab28-0413cda48d31);

//Videocall with Gortash
IF
DialogEnded((DIALOGRESOURCE)IRN_IronThrone_Arrival_76172178-657d-57f0-2337-d33f5f60f6d5, _)
THEN
QuestUpdate("LOW_SaveGondians", "GortashCall");

//Leaving with all Gondians in the Iron throne have been saved
PROC
PROC_LOW_SteelWatchFoundry_SetUpAfterIRN()
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_AnyIronThronePrisonersDead_5d6c4329-ee56-4084-8220-d627b716ac87)
THEN
QuestUpdate("LOW_SaveGondians", "LeftIronThrone_AllSaved");

//Leaving with some surviving gondians
PROC
PROC_LOW_SteelWatchFoundry_SetUpAfterIRN()
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_AnyIronThronePrisonersDead_5d6c4329-ee56-4084-8220-d627b716ac87)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllIronThronePrisonersDead_4fefe27f-7cd6-44b1-9322-a57b22246271)
THEN
QuestUpdate("LOW_SaveGondians", "LeftIronThrone_SomeSaved");

//Leaving with no surviving Gondians, previously having met Zanner
PROC
PROC_LOW_SteelWatchFoundry_SetUpAfterIRN()
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllIronThronePrisonersDead_4fefe27f-7cd6-44b1-9322-a57b22246271)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_Hasmet_FundangoToobin_94af332f-8038-48bf-8998-70028a73a887)
THEN
QuestUpdate("LOW_SaveGondians", "AllHostagesDead_KnowZanner");

//Leaving with no surviving Gondians, never having met Zanner
PROC
PROC_LOW_SteelWatchFoundry_SetUpAfterIRN()
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_AllIronThronePrisonersDead_4fefe27f-7cd6-44b1-9322-a57b22246271)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Hasmet_FundangoToobin_94af332f-8038-48bf-8998-70028a73a887)
THEN
QuestUpdate("LOW_SaveGondians", "AllHostagesDead_DontKnowZanner");

//Zanner Toobin dies after the player has visited IRN
IF
DB_PermaDefeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
THEN
QuestUpdate("LOW_SaveGondians", "ZannerDead_AfterIRN");

//Killed all Baneites in the workroom after returning from IRN
//use defeatcounters "LOW_SteelWatchFoundry_WorkroomPostIRNBaneites" and "LOW_SteelWatchFoundry_WorkroomOriginalBaneites" - if both are fully defeated progress the journal
IF
DB_GlobalFlag(LOW_SteelWatchFoundry_State_OriginalWorkroomBaneitesDefeated_e33e6570-c885-4a61-8b26-16e1d2784137)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_PostIRNWorkroomBaneitesDefeated_1c0a4b23-9bc2-4d25-9c89-c066ee42f6c7)
THEN
QuestUpdate("LOW_SaveGondians", "SecuredWorkroom");

//Entered Control Centre trigger
IF
DialogEnded((DIALOGRESOURCE)LOW_SteelWatchFoundry_FundangoTitanWarning_ddbc8732-7c9d-a8f6-9295-70d873f727d8, _)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_SaveGondians_ArrivedInControlCentre")
THEN
QuestUpdate("LOW_SaveGondians", "ArrivedInControlCentre");

//Zanner Toobin dies before entering IRN
IF
DB_PermaDefeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
THEN
QuestUpdate("LOW_SaveGondians", "ZannerDead_BeforeIRN");

//Wasted runepowder bomb
IF
DestroyedBy(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, _, _, _)
THEN
SetFlag(WYR_Ironhand_BombDestroyed_8ed705b5-6f86-4cff-8c14-cc1c7b87ad9c);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3_GEN"
