Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Gortash Confrontation
DB_OriginMayLeaveDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)WYR_KillDirectorGortash_Ceremony_5149a422-854a-9e05-433a-0520d87eb112);
DB_DefeatedStateFlag(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, (FLAG)GLO_Gortash_State_Defeated_7ba6ad38-bb7b-41cc-a71f-15b12c988858);
DB_DeadOnceFlag((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (FLAG)GLO_Orin_State_Dead_9165c397-4578-404d-a046-c8e8b09509e9); // Explicitly said in WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM

DB_GLO_DieFlag((FLAG)ORI_Karlach_Event_KillGortash_fd6c6e85-9a50-e9ac-832d-73897615d3d0, (CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, DEATHTYPE.Necrotic, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

DB_InRegionFlag((TRIGGER)S_WYR_KarlachCell_PlayerTrigger_1f5f5e06-e779-46bf-b72a-375bc21ac00e, (FLAG)ORI_GortashConfrontation_State_PlayerInsideKarlachsCell_9909ce57-0540-e906-33b5-e4970743d71b);


DB_Origins_BlockTransferReasons("ORI_Karlach_SentToPrison");

PROC_DefineSingleOriginMoment((DIALOGRESOURCE)WYR_KillDirectorGortash_AfterCeremony_bd68e69e-3339-1c5f-b173-2591a0319985, (TAG)KARLACH_9aab4bcd-e1f7-4008-8f7b-f1203789ae9b, (DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a, (DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_COM_b4faf26b-68d6-b3ce-da96-0edca8d70608, (DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a);
DB_GlobalFlagReactionAfterDialog((FLAG)WYR_KillDirectorGortash_Event_MoveGortashToHisOffice_b73e0d24-c6ba-43a1-b848-18f1a5333c1c, (DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a);
DB_GlobalFlagReactionAfterDialog((FLAG)WYR_KillDirectorGortash_Event_MoveGortashToHisOffice_b73e0d24-c6ba-43a1-b848-18f1a5333c1c, (DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_COM_b4faf26b-68d6-b3ce-da96-0edca8d70608);

DB_GlobalFlagReactionAfterDialog((FLAG)WYR_GortashConfrontation_Event_SendKarlachToCamp_7a52ef44-835d-4af9-0388-cdd1036a09ed, (DIALOGRESOURCE)WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2);

DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_AfterDefeatingGortash_585a4ee6-b04f-2559-2bc5-ae99a1f57ff2);
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_AfterDefeatingGortash_585a4ee6-b04f-2559-2bc5-ae99a1f57ff2);

DB_ORI_GortashConfrontation_PrisonGuard((CHARACTER)S_WYR_WyrmRockPrison_EntranceGuard_3f27f04f-4041-462e-9db3-a3ba163eb0c6);
DB_ORI_GortashConfrontation_PrisonGuard((CHARACTER)S_WYR_WyrmRockPrison_Guard_001_bbdac4e8-23cb-4134-b718-2d852ce22ea1);
DB_ORI_GortashConfrontation_PrisonGuard((CHARACTER)S_WYR_WyrmRockPrison_Guard_002_3a853d86-2086-4923-b09d-3192244effe6);
DB_ORI_GortashConfrontation_PrisonGuard((CHARACTER)S_WYR_WyrmRockPrison_Guard_003_cbf95410-351a-491e-92aa-1663df98c6f5);
DB_ORI_GortashConfrontation_PrisonGuard((CHARACTER)S_WYR_WyrmRockPrison_Guard_004_e019ed47-a0fd-45d5-9baa-1a817f52b984);

TriggerRegisterForCharacter((TRIGGER)S_WYR_GortashConfrontation_NPCInclusions_acc5ab21-423a-4619-a232-06f4948ca6a6, (CHARACTER)S_WYR_KillDirectorGortash_SteelWatcher_5967b1c5-8e3c-4064-83e3-5219aa204c3d);
//END_REGION Gortash Confrontation

//REGION Back at Home Night
PROC_ORI_Karlach_BackAtHomeNight();
//END_REGION Back at Home Night

//REGION Misc Moments
DB_GlobalFlagReactionAfterDialog((FLAG)WYR_Circus_Event_FailedToGainAccess_b9b0ff6b-d7e8-8c53-4b21-55413b6c6da5, (DIALOGRESOURCE)WYR_Circus_Checkpoint_5117a414-8890-f4db-a844-8bf632d62086);
//END_REGION Misc Moments
KBSECTION
//REGION Gortash Confrontation

//REGION Prison
IF
FlagSet((FLAG)ORI_GortashConfrontation_Event_KarlachSentToPrison_f6764bce-1df3-4f81-91d0-bf986329798e, _, _DialogID)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)S_WYR_KarlachCell_PlayerTrigger_1f5f5e06-e779-46bf-b72a-375bc21ac00e);
SetFlag((FLAG)ORI_GortashConfrontation_State_KarlachsCellLocked_fa7ed9a2-359d-40a8-b5a9-6624a9f5af89, NULL_00000000-0000-0000-0000-000000000000);
DB_RegionPrison_CustomCell((TRIGGER)S_WYR_WyrmRockPrison_PlayerCell_6792230e-f319-4870-8778-5f7bfae74489, (TRIGGER)S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_WYR_KarlachsCellPos_d1d61fae-69e8-4000-8ba1-6f6b7ea42514, (ITEM)S_WYR_WyrmRockPrison_KarlachsCellDoor_ca3f8d0e-b59c-4281-9174-f10f40f612bf, "WYR_WyrmRockPrison_PrisonDoor");
PROC_CrimePerformArrest((CHARACTER)S_WYR_AudienceHall_SteelWatcher_003_6622cf7f-a119-4c42-9a1e-b7cc4543dd19, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "BGO_Main_A_WyrmRock");
PROC_Origins_CompanionLeaveTemporarily((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_Karlach_SentToPrison");
PROC_GLO_Origins_SetRecruitmentDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_Recruitment_WyrmsPrison_275b1a71-2ea2-a07d-29f4-7ccfe32a5571);
DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison");
DB_SceneNoHostileContinuousDisturbance("ORI_KarlachInPrison");
PROC_CharacterDisableCrime((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "WYR_WyrmRockPrison_InnerAreaTrespassing");
PROC_SetRelationToPlayers((FACTION)Origin_Karlach_2e560efd-f847-4c83-a3a1-8241ce74a7bf, 100); // Makes sense for her to be friendly at this point of the game.
ClearTag(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6); // Let her make it possible to be resurrected.

IF
FlagSet((FLAG)ORI_GortashConfrontation_Event_RemoveKarlach_03b5ca45-3712-b74f-9d36-30988e15a5cd, _, _DialogID)
AND
DialogRemoveActorFromDialog(_DialogID, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _)
THEN
DB_NOOP(1);

IF
Opened(S_WYR_WyrmRockPrison_KarlachsCellDoor_ca3f8d0e-b59c-4281-9174-f10f40f612bf)
AND
QRY_OnlyOnce("WYR_KarlachHostileAgainsGuards")
THEN
PROC_SetRelationMutual((FACTION)Origin_Karlach_2e560efd-f847-4c83-a3a1-8241ce74a7bf, (FACTION)ACT3_WYR_WyrmRock_Prison_5ebe11a9-688f-44b7-ad4b-e86f8e0e790c, 0);

IF
Opened(S_WYR_WyrmRockPrison_KarlachsCellDoor_ca3f8d0e-b59c-4281-9174-f10f40f612bf)
AND
DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison")
AND
NOT DB_GlobalFlag(ORI_GortashConfrontation_State_KarlachsCellLocked_fa7ed9a2-359d-40a8-b5a9-6624a9f5af89)
AND
QRY_OnlyOnce("ORI_Karlach_InitiatedRecruitmentInPrison")
AND
QRY_GetBestAvatarForCompanion((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_QRYRTN_GetBestAvatarForCompanion((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Avatar)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Avatar, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
QRY_StartDialog_Fixed(Karlach_Recruitment_WyrmsPrison_275b1a71-2ea2-a07d-29f4-7ccfe32a5571, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Avatar)
THEN
DB_NOOP(1);

IF
Unlocked(S_WYR_WyrmRockPrison_KarlachsCellDoor_ca3f8d0e-b59c-4281-9174-f10f40f612bf, _, _)
AND
DB_GlobalFlag(ORI_GortashConfrontation_State_KarlachsCellLocked_fa7ed9a2-359d-40a8-b5a9-6624a9f5af89)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_WYR_KarlachCell_PlayerTrigger_1f5f5e06-e779-46bf-b72a-375bc21ac00e);
PROC_GlobalClearFlagAndCache((FLAG)ORI_GortashConfrontation_State_KarlachsCellLocked_fa7ed9a2-359d-40a8-b5a9-6624a9f5af89);
PROC_GlobalSetFlagAndCache((FLAG)ORI_GortashConfrontation_State_KarlachFreed_47c387ea-6d33-4452-b6fe-1411fe93d3e0);

IF
LeftTrigger((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768)
AND
DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison")
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_GortashConfrontation_State_KarlachFreed_47c387ea-6d33-4452-b6fe-1411fe93d3e0);

IF
EnteredTrigger((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768)
AND
DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison")
AND
IsLocked(S_WYR_WyrmRockPrison_KarlachsCellDoor_ca3f8d0e-b59c-4281-9174-f10f40f612bf, 1)
AND
IsClosed(S_WYR_WyrmRockPrison_KarlachsCellDoor_ca3f8d0e-b59c-4281-9174-f10f40f612bf, 1)
THEN
PROC_GlobalClearFlagAndCache((FLAG)ORI_GortashConfrontation_State_KarlachFreed_47c387ea-6d33-4452-b6fe-1411fe93d3e0);

IF
DB_Players((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison")
THEN
PROC_SceneOver("ORI_KarlachInPrison");

PROC
PROC_ORI_SendToCampAfterDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _)
AND
DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison")
THEN
PROC_SceneOver("ORI_KarlachInPrison");

PROC
PROC_GLO_PartyMembers_AddHook((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _)
AND
DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison")
THEN
PROC_SceneOver("ORI_KarlachInPrison");

PROC
PROC_CRIME_Prison_Escaped((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Arrester, S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768, _ArrestedNotShapeshifted, _PrisonCrimeName, _PrisonCrimeNameAD, _FugitiveStatus)
THEN
PROC_CRIME_Prison_RemoveCustomPrison((TRIGGER)S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

IF
StatusApplied((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "GB_FUGITIVE_WYR", _, _)
AND
DB_RegionPrison_CustomCell((TRIGGER)S_WYR_WyrmRockPrison_PlayerCell_6792230e-f319-4870-8778-5f7bfae74489, (TRIGGER)S_WYR_KarlachCell_eaa45487-cd70-46d4-90eb-4d1570616768, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (TRIGGER)S_WYR_KarlachsCellPos_d1d61fae-69e8-4000-8ba1-6f6b7ea42514, (ITEM)S_WYR_WyrmRockPrison_KarlachsCellDoor_ca3f8d0e-b59c-4281-9174-f10f40f612bf, "WYR_WyrmRockPrison_PrisonDoor")
THEN
SetFlag((FLAG)ORI_GortashConfrontation_State_KarlachEscaping_6094f71c-912c-4a5c-8a7a-bd2c067ed93d, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_CrimeGetCustomArrestDialogCustom((CHARACTER)_Arrester, (INTEGER)_CrimeID, GEB_Arrest_EscapedPrison_2dc6b458-e9e1-cef9-1e59-a6569c9f6434, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTER)_Criminal2, (CHARACTER)_Criminal3, (CHARACTER)_Criminal4)
AND
DB_Players(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_ORI_GortashConfrontation_PrisonGuard(_Arrester)
AND
DB_GlobalFlag((FLAG)ORI_GortashConfrontation_State_KarlachEscaping_6094f71c-912c-4a5c-8a7a-bd2c067ed93d)
THEN
DB_CrimeArrest_CustomDialog(_Arrester, _CrimeID, WYR_GortashConfrontation_CustomKarlachArrest_f65b1b0e-1850-70d6-a935-18962e748c3e);

IF
StatusRemoved((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "GB_FUGITIVE_WYR", _, _)
AND
DB_GlobalFlag((FLAG)ORI_GortashConfrontation_State_KarlachEscaping_f8fe78db-f576-4fff-a104-8379cbf704b8)
THEN
ClearFlag((FLAG)ORI_GortashConfrontation_State_KarlachEscaping_6094f71c-912c-4a5c-8a7a-bd2c067ed93d, NULL_00000000-0000-0000-0000-000000000000);

// Revert faction relationship
PROC
PROC_SceneOver("ORI_KarlachInPrison")
AND
QRY_OnlyOnce("ORI_KarlachInPrison_EndScene")
THEN
PROC_SetRelationMutual((FACTION)Origin_Karlach_2e560efd-f847-4c83-a3a1-8241ce74a7bf, (FACTION)ACT3_WYR_WyrmRock_Prison_5ebe11a9-688f-44b7-ad4b-e86f8e0e790c, 50);

IF
FlagSet((FLAG)ORI_GortashConfrontation_State_KarlachWillLeave_cb4ac6a2-b553-5f2d-2bfe-680d5aa0ff94, _, _)
THEN
PROC_TriggerRegisterForParty((TRIGGER)S_WYR_GortashConfrontation_Area_88419ab5-274d-4ef9-80cb-cd5b762e0099);

IF
LeftTrigger(_Player, S_WYR_Prison_SUB_cd67276d-52e4-44b9-a237-0e2cd45106d8)
AND
DB_GlobalFlag((FLAG)ORI_GortashConfrontation_State_KarlachWillLeave_cb4ac6a2-b553-5f2d-2bfe-680d5aa0ff94)
AND
NOT DB_GlobalFlag((FLAG)ORI_GortashConfrontation_State_KarlachLeft_1fed69d1-c245-4c5f-9ed0-5cfed57d8ae9)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger(S_WYR_Prison_SUB_cd67276d-52e4-44b9-a237-0e2cd45106d8)
THEN
PROC_SceneOver("ORI_KarlachInPrison");
PROC_DisappearOutOfSight((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "Run", 0, "ORI_GortashConfrontation_KarlachLeaves");

IF
EntityEvent(_, "ORI_GortashConfrontation_KarlachLeaves")
THEN
SetFlag((FLAG)ORI_GortashConfrontation_State_KarlachLeft_1fed69d1-c245-4c5f-9ed0-5cfed57d8ae9, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Prison

IF
DialogEnded((DIALOGRESOURCE)WYR_KillDirectorGortash_Ceremony_5149a422-854a-9e05-433a-0520d87eb112, _)
AND
NOT DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_AcceptedAlliance_92e647a6-4625-4a2b-a143-35cba456fe50)
AND
DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_RefusedAlliance_c6f5c2cc-7724-4af3-b73a-10d8f7518e42)
AND
NOT DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison")
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_RejectedGortashAlliance_e990a351-329f-4723-bdcc-62ca2217ed22, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
DialogEnded((DIALOGRESOURCE)WYR_KillDirectorGortash_Ceremony_5149a422-854a-9e05-433a-0520d87eb112, _)
AND
DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_AcceptedAlliance_92e647a6-4625-4a2b-a143-35cba456fe50)
AND
NOT DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_RefusedAlliance_c6f5c2cc-7724-4af3-b73a-10d8f7518e42)
AND
NOT DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison")
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_AcceptedGortashAlliance_361e5553-4dc9-4f0f-2e2f-0b3ef8f50385, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

// Edge case: if players neither accept nor reject Gortash' alliance trigger her rejected branch
IF
DialogEnded((DIALOGRESOURCE)WYR_KillDirectorGortash_Ceremony_5149a422-854a-9e05-433a-0520d87eb112, _)
AND
DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_OfferedAlliance_03713386-ba9a-46b8-9911-554b89072d88)
AND
NOT DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_AcceptedAlliance_92e647a6-4625-4a2b-a143-35cba456fe50)
AND
NOT DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_RefusedAlliance_c6f5c2cc-7724-4af3-b73a-10d8f7518e42)
AND
NOT DB_SceneManager((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison")
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_RejectedGortashAlliance_e990a351-329f-4723-bdcc-62ca2217ed22, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
FlagSet((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_AcceptedGortashAlliance_361e5553-4dc9-4f0f-2e2f-0b3ef8f50385);
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_RejectedGortashAlliance_e990a351-329f-4723-bdcc-62ca2217ed22);


// Redefine OM but with in office branch (in ceremony and in office rooms share dialog nodes for lore)
// Because of the shape of the room and that the dialog triggers as soon as players are spotted Karlach can easily be out of range. Increase it and add a trigger.
IF
FlagSet(WYR_KillDirectorGortash_State_InOffice_12233623-2dc3-4dbe-b493-b491fdf6321d, _, _)
AND
QRY_OnlyOnce("ORI_GortashConfrontation_InOffice")
THEN
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)WYR_KillDirectorGortash_GortashInOffice_b032707c-5cf3-be12-b590-d35f59019fd7, (TAG)KARLACH_9aab4bcd-e1f7-4008-8f7b-f1203789ae9b, (DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a, (DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_COM_b4faf26b-68d6-b3ce-da96-0edca8d70608, (DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a);
DB_OriginDialogTrigger((DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a, (TRIGGER)S_WYR_GortashConfrontation_OM_InOffice_Trigger_dbd22ecd-5241-4838-9da4-0b044c74cb61);
DB_OriginDialogTrigger((DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_COM_b4faf26b-68d6-b3ce-da96-0edca8d70608, (TRIGGER)S_WYR_GortashConfrontation_OM_InOffice_Trigger_dbd22ecd-5241-4838-9da4-0b044c74cb61);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a, 30.0);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_COM_b4faf26b-68d6-b3ce-da96-0edca8d70608, 30.0);

//REGION Karlach Fights Gortash alone
IF
DB_GlobalFlag((FLAG)ORI_GortashConfrontation_State_KarlachLeft_1fed69d1-c245-4c5f-9ed0-5cfed57d8ae9)
AND
NOT DB_InRegion(_, (TRIGGER)S_WYR_GortashConfrontation_Area_88419ab5-274d-4ef9-80cb-cd5b762e0099)
THEN
PROC_ORI_GortashConfrontation_DecideKarlachsFate();

PROC
PROC_ORI_GortashConfrontation_DecideKarlachsFate()
AND
DB_Defeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
THEN
SetFlag((FLAG)ORI_Karlach_Event_KillGortash_fd6c6e85-9a50-e9ac-832d-73897615d3d0, NULL_00000000-0000-0000-0000-000000000000);

// Karlach dies
PROC
PROC_ORI_GortashConfrontation_DecideKarlachsFate()
AND
NOT DB_Defeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
THEN
SetFlag((FLAG)ORI_Karlach_State_KilledByGortash_d74f8867-9752-45bc-ab54-3177101e8507, NULL_00000000-0000-0000-0000-000000000000); // Steelwatch variant might appear at the end game instead because of steelwatchers being disabled after steelwatch foundry.
SetOnStage(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

PROC
PROC_ORI_GortashConfrontation_DecideKarlachsFate()
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_Karlach_LeftPrisonAlone");
PROC_TriggerUnregisterForParty((TRIGGER)S_WYR_GortashConfrontation_Area_88419ab5-274d-4ef9-80cb-cd5b762e0099);

//END_REGION Karlach Fights Gortash alone

//REGION Gortash and Karlach OM after ceremony
QRY
QRY_OriginMoment_PreventRelaunchDialog(WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _Player)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_PreventRelaunchDialog(WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_COM_b4faf26b-68d6-b3ce-da96-0edca8d70608, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _Player)
THEN
DB_NOOP(1);

IF
DB_WYR_KillDirectorGortash_Banites(_Banite, _)
THEN
TriggerRegisterForCharacter((TRIGGER)S_WYR_GortashConfrontation_NPCInclusions_acc5ab21-423a-4619-a232-06f4948ca6a6, (CHARACTER)_Banite);

PROC
PROC_StartDialog_AddExtraSpeakers(WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a, _DialogID)
AND
DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_InOffice_12233623-2dc3-4dbe-b493-b491fdf6321d)
AND
NOT DB_GlobalFlag((FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b)
AND
DB_InRegion(S_WYR_KillDirectorGortash_SteelWatcher_5967b1c5-8e3c-4064-83e3-5219aa204c3d, (TRIGGER)S_WYR_GortashConfrontation_NPCInclusions_acc5ab21-423a-4619-a232-06f4948ca6a6)
AND
QRY_SpeakerIsAvailable(S_WYR_KillDirectorGortash_SteelWatcher_5967b1c5-8e3c-4064-83e3-5219aa204c3d)
THEN
PROC_DialogAddSpeakingActor(_DialogID, S_WYR_KillDirectorGortash_SteelWatcher_5967b1c5-8e3c-4064-83e3-5219aa204c3d);

PROC
PROC_StartDialog_AddExtraSpeakers(WYR_GortashConfrontation_OM_KarlachAndGortashEncounter_AOM_OOM_be1c938d-d0b4-2345-683a-1a892da2873a, _DialogID)
AND
DB_WYR_KillDirectorGortash_Banites(_Banite, _)
AND
DB_GlobalFlag((FLAG)WYR_KillDirectorGortash_State_InOffice_12233623-2dc3-4dbe-b493-b491fdf6321d)
AND
DB_InRegion(_Banite, (TRIGGER)S_WYR_GortashConfrontation_NPCInclusions_acc5ab21-423a-4619-a232-06f4948ca6a6)
AND
QRY_SpeakerIsAvailable(_Banite)
THEN
PROC_DialogAddSpeakingActor(_DialogID, _Banite);
//END_REGION Gortash and Karlach OM after ceremony

//END_REGION Gortash Confrontation

//REGION Misc Moments
// Failing to gain entrance to the circus
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)WYR_Circus_Event_FailedToGainAccess_b9b0ff6b-d7e8-8c53-4b21-55413b6c6da5)
AND
DB_Players((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_WYR_Circus_EntranceGuard_63ef213e-7a72-4126-9d5f-2f7d60ee9178)
THEN
PROC_TryStartAD((DIALOGRESOURCE)WYR_Circus_PAD_KarlachCantEnterCircus_b3d99849-3c6d-ff65-aec5-a0ab0152ccac, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
//END_REGION Misc Moments

//REGION Back at Home Night
// Companion Karlach
PROC
PROC_ORI_Karlach_BackAtHomeNight()
THEN
DB_CampNight((FLAG)NIGHT_Karlach_BackAtHome_afb71d32-882d-452b-98bd-98ba7944b330, 5400);
DB_CampNight_Camp((FLAG)NIGHT_Karlach_BackAtHome_afb71d32-882d-452b-98bd-98ba7944b330, "FARM");
DB_CampNight_CancelledBy((FLAG)NIGHT_Karlach_BackAtHome_afb71d32-882d-452b-98bd-98ba7944b330, (FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac);
DB_CampNight_CRD((FLAG)NIGHT_Karlach_BackAtHome_afb71d32-882d-452b-98bd-98ba7944b330, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)CAMP_BackAtHome_CRD_Karlach_72acb27b-c532-f64f-c9b7-a441e649d4d9, (FLAG)NULL_00000000-0000-0000-0000-000000000000);

// Avatar Karlach
PROC
PROC_ORI_Karlach_BackAtHomeNight()
THEN
DB_CampNight((FLAG)NIGHT_Karlach_BackAtHome_Avatar_944b08a1-34e6-4ad0-a43d-ffe96add76dc, 6400);
DB_CampNight_Camp((FLAG)NIGHT_Karlach_BackAtHome_Avatar_944b08a1-34e6-4ad0-a43d-ffe96add76dc, "FARM");
DB_CampNight_CancelledBy((FLAG)NIGHT_Karlach_BackAtHome_Avatar_944b08a1-34e6-4ad0-a43d-ffe96add76dc, (FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac);
DB_CampNight_SoloDream((FLAG)NIGHT_Karlach_BackAtHome_Avatar_944b08a1-34e6-4ad0-a43d-ffe96add76dc, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)CAMP_BackAtHome_SD_Karlach_bc97b414-6811-7f2e-e16f-93fd74531a48);
//END_REGION Back at Home Night

//REGION Gortash in Colony
//Gortash in colony IPRD edge-case: Gortash is permadefeated or after the ceremony at WYR and players haven't triggered the facing death dialog.
IF
FlagSet((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_GortashInColony_80314a56-b334-48fe-9055-54bcd2efc5b6);

IF
FlagSet((FLAG)WYR_KillDirectorGortash_State_AfterCeremony_a05a6945-21ad-400d-80bc-7b4934571c57, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_GortashInColony_80314a56-b334-48fe-9055-54bcd2efc5b6);
//END_REGION Gortash in Colony
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3"
