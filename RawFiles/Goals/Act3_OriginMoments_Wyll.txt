Version 1
SubGoalCombiner SGC_AND
INITSECTION
ApplyStatus(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"GLO_MIZORA_INVULNERABLE",-1.0,0);

SetOnStage(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, 0);
SetOnStage((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,0);
SetOnStage((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,0);

DB_DefeatedStateFlag(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61);
DB_PermaDefeatedFlag(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
DB_CanBeResurrected(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

PROC_DefineSingleOriginMoment((DIALOGRESOURCE)WYR_MeetingMizora_f075875a-5279-8fbb-0a9b-b40b4a437d66,(TAG)REALLY_WYLL_5f40def5-d3ec-4698-a367-01a339888956,
							(DIALOGRESOURCE)WYR_MeetingMizora_OM_Wyll_COM_AOM_OOM_56b90cd5-e0f5-34fb-ff76-6b569cef34e5,
							(DIALOGRESOURCE)WYR_MeetingMizora_OM_Wyll_COM_AOM_OOM_56b90cd5-e0f5-34fb-ff76-6b569cef34e5,
							(DIALOGRESOURCE)WYR_MeetingMizora_OM_Wyll_COM_AOM_OOM_56b90cd5-e0f5-34fb-ff76-6b569cef34e5);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)WYR_MeetingMizora_OM_Wyll_COM_AOM_OOM_56b90cd5-e0f5-34fb-ff76-6b569cef34e5,100.0);
DB_OriginMoment_DontAutoClearOriginMoment((DIALOGRESOURCE)WYR_MeetingMizora_OM_Wyll_COM_AOM_OOM_56b90cd5-e0f5-34fb-ff76-6b569cef34e5);

//REGION HelmetOfBalduran
DB_CampNight((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,6270);
DB_CampNight_Camp((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,"FARM");
DB_CampNight_Camp((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,"SLUMS");
DB_CampNight_Camp((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,"ELFSONG");
DB_CampNight_Requirement((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,(FLAG)WYLLAVATAR_b0d1be97-c501-4a9d-8718-e473210a4694,(FLAG)WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c,(FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
DB_CampNight_CancelledBy((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,(FLAG)CAMP_Ravengard_Event_TurnedInQuest_d7e46c3c-e6a1-b962-d7c8-04fa3eaa2242);
DB_CampNight_SoloDream((FLAG)Night_Wyll_HelmetOfBalduran_d5b13963-4f14-4a43-a423-7934a63d4745,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)CAMP_WyllHelmetOfBalduran_CFM_c68ff4c7-4f0a-08d3-8572-74ade60ddc2b);

//END_REGION


//REGION Mizora Pact
DB_CampNight((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,5240 /* 6240 for avatar */, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,"FARM");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,"SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,"ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,(FLAG)WYLL_042ed775-0b10-4d41-a4f5-b31e6f144206,(FLAG)WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e, (FLAG)GLO_Origin_PartOfTheTeam_Wyll_24e24ca7-3446-440b-b645-19404845e108);
DB_CampNight_CFM((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,(DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2);
DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2,
								(GUIDSTRING)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,
								(GUIDSTRING)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,
								(GUIDSTRING)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,
								(GUIDSTRING)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampfireMoment_OptionalSpeakers((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2,S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_CampNight_CRD((FLAG)NIGHT_Wyll_MizorasPact_c9b8d342-34b8-4d2e-a254-fe8bcae71df3,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,(FLAG)Wyll_InParty2_Event_AfterPact_a64af098-7121-0913-30e8-5aba415c737c);

DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"FARM",(TRIGGER)S_CAMP_Ravengard_e50982fd-0b00-4287-b183-20eddeb3069b);
DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"SLUMS",(TRIGGER)S_CAMP_SLUMS_Ravengard_81249232-3284-4e78-9de8-4c4407914c8e);
DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"ELFSONG",(TRIGGER)S_CAMP_ELFSONG_Ravengard_6cace9b7-a095-44cf-98df-c5a6c7a3e090);

DB_ORI_OriginCampData((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"FARM",(TRIGGER)S_CAMP_FARM_Mizora_e1dd2822-3c52-4995-bdcc-86485b27c24a);
DB_ORI_OriginCampData((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"SLUMS",(TRIGGER)S_CAMP_SLUMS_Mizora_c62e3caa-769c-4182-b749-d047e8488396);
DB_ORI_OriginCampData((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"ELFSONG",(TRIGGER)S_CAMP_ELFSONG_Mizora_4fdcf21b-0d9d-4336-a6c3-2f6dd1c57d02);

DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,"FARM",(TRIGGER)S_FARM_MizorasPact_Devil01_Point_71b54b5c-eb8b-477b-9129-28cb4864aa8c);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,"SLUMS",(TRIGGER)S_CAMP_MizorasPact_Devil01_Point_ba130696-019b-4717-a66e-9c4c50141a85);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,"ELFSONG",(TRIGGER)S_ELFSONG_MizorasPact_Devil01_Point_6b07a6a1-6048-4229-8b69-b85c1d531130);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,"FARM",(TRIGGER)S_FARM_MizorasPact_Devil02_Point_ac0544cf-3920-4467-a35c-9173f97df6a0);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,"SLUMS",(TRIGGER)S_CAMP_MizorasPact_Devil02_Point_67b32487-681b-4b21-9311-0cb39537e10b);
DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,"ELFSONG",(TRIGGER)S_ELFSONG_MizorasPact_Devil02_Point_d108a198-f1cc-4474-951e-7d98364c1f29);

//END_REGION

//REGION Romance Mizora
DB_CampNight((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,4080);
DB_CampNight_Camp((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,"FARM");
DB_CampNight_Camp((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,"SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,"ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,(FLAG)WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e,(FLAG)CAMP_Mizora_State_ReadyForRomance_50326103-dae1-818a-3705-046d864c3386, (FLAG)GLO_Origin_PartOfTheTeam_Wyll_24e24ca7-3446-440b-b645-19404845e108);
DB_CampNight_RomanceNight((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,(CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,(DIALOGRESOURCE)CAMP_Mizora_SD_ROM_27220d79-2ae3-0262-209b-3e91e1b42f88,(FLAG)CAMP_Mizora_Event_ReadyForRomance_753a635d-e457-ab5f-a180-3a346ca00875);
DB_CampNight_MorningCFM((FLAG)NIGHT_Mizora_Romance_fbc49818-3d0a-43be-915b-b6d0f507d162,(DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12);
DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12,S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);
//END_REGION


//REGION Romance Wyll
DB_CampNight((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,4090);
DB_CampNight_Camp((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,"FARM");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,"SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,"ELFSONG");
DB_CampNight_Requirement_Partner((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
//Ravengard returned from IRN
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381,(FLAG)CAMP_Wyll_Act3Romance_Event_CanStart_d27dc3e6-e856-4e87-8140-a25f4d5ba57d);
//Ravengard died during ceremony
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381,(FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac,(FLAG)GLO_Ravengard_State_PermaDefeated_b1b2458c-dd27-4db7-974e-a294ca6e2e9e);
//Ravengard resurrected
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381,(FLAG)VISITEDREGION_CTY_Main_A_ce5346f4-c176-43ea-8da0-2067450e26ac,(FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1);
DB_CampNight_CRD((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)CAMP_Wyll_CRD_Act3Romance_599fe884-f39f-a3b5-7a86-ca239e016a05,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION Mizora Resurrects Ravengard After IRN Destruction
DB_CampNight((FLAG)NIGHT_Wyll_MizoraResurrectsRavengardAfterIRNDestruction_b8407ecd-e429-4218-bf44-dcae2d047c9c,5245);
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizoraResurrectsRavengardAfterIRNDestruction_b8407ecd-e429-4218-bf44-dcae2d047c9c,"FARM");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizoraResurrectsRavengardAfterIRNDestruction_b8407ecd-e429-4218-bf44-dcae2d047c9c,"SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Wyll_MizoraResurrectsRavengardAfterIRNDestruction_b8407ecd-e429-4218-bf44-dcae2d047c9c,"ELFSONG");
DB_CampNight_Requirement((FLAG)NIGHT_Wyll_MizoraResurrectsRavengardAfterIRNDestruction_b8407ecd-e429-4218-bf44-dcae2d047c9c,(FLAG)CAMP_Mizora_State_WantsToResurrectRavengardAfterIRNDestruction_ac394670-1bb9-4e9e-92dc-8fa9382d4a64, (FLAG)GLO_Origin_PartOfTheTeam_Wyll_24e24ca7-3446-440b-b645-19404845e108);
DB_CampNight_CRD((FLAG)NIGHT_Wyll_MizoraResurrectsRavengardAfterIRNDestruction_b8407ecd-e429-4218-bf44-dcae2d047c9c,(CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,(DIALOGRESOURCE)CAMP_Mizora_TalkToResurrectRavengard_a3881b60-bec8-0f55-99fe-7b22f6e93592,(FLAG)NULL_00000000-0000-0000-0000-000000000000);

DB_GlobalFlagReactionAfterDialog((FLAG)CAMP_Mizora_State_ResurrectedRavengardAfterIRNDestruction_64816ccb-c284-4f53-b730-565997635054, CAMP_Mizora_TalkToResurrectRavengard_a3881b60-bec8-0f55-99fe-7b22f6e93592);

//END_REGION
KBSECTION
//REGION Misc
//Appear and Disappear hook added here as well since this goal is the first one alphabetically to be added to Story.Div and it checks for Character in this instance, causing the hooks in the Global Goal file to prevent story builds
PROC
PROC_GLO_MizoraAppear_AppearedHook((GUIDSTRING)_Entity, (STRING)_String)
THEN
DB_NOOP(1);

PROC
PROC_GLO_MizoraDisappear_DisappearedHook((GUIDSTRING)_Character, (STRING)_String)
THEN
DB_NOOP(1);
//END_REGION

//REGION Meeting Mizora
PROC
PROC_LevelLoadedOnce("BGO_Main_A")
THEN
TeleportTo(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,(TRIGGER)S_WYR_CambionMeetingPoint_71eed736-c77a-4657-8b94-22299a490b2f);

IF
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_WYR_MeetingMizoraSetupDone(_) 
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
PROC_WYR_Mizora_MeetingSetup();

PROC
PROC_WYR_Mizora_MeetingSetup()
THEN
SetOnStage(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,1);
PROC_TriggerRegisterForPlayers((TRIGGER)S_WYR_CambionDialogTrigger_FallbackRegister_580571b6-9e87-486f-93dd-7d7dc0f36c95);
DB_SpotPlayers((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"ORI_Wyll_MeetingMizoraSpotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"ORI_Wyll_MeetingMizoraSpotting",S_WYR_CambionDialogTrigger_e3e4bad7-aa79-45db-8754-32570052e0cd);
DB_Dialogs(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,(DIALOGRESOURCE)WYR_MeetingMizora_f075875a-5279-8fbb-0a9b-b40b4a437d66);
DB_WYR_MeetingMizoraSetupDone(1);

IF
FlagSet(WYR_WyrmRock_State_AlertState_3d238a15-bb39-411a-8023-23385c98f2b8, _, _)
AND
NOT DB_GlobalFlag(WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e)
AND
QRY_WYR_Mizora_MeetingFallback_CheckValid()
THEN
PROC_WYR_Mizora_MeetingFallback();

IF
EnteredTrigger(_Player,S_WYR_CambionDialogTrigger_FallbackRegister_580571b6-9e87-486f-93dd-7d7dc0f36c95)
AND
QRY_WYR_Mizora_MeetingFallback_CheckValid()
THEN
PROC_WYR_Mizora_MeetingFallback();

QRY
QRY_WYR_Mizora_MeetingFallback_CheckValid()
AND
NOT DB_GlobalFlag(WYR_MeetingMizora_Event_SentWyllUpstairs_cb147c97-f1e7-cfba-ef10-cd2e6adc9f69)
THEN
DB_NOOP(1);

QRY
QRY_WYR_Mizora_MeetingFallback_CheckValid()
AND
NOT DB_GlobalFlag(GLO_Gortash_HasMet_74cffb8f-fc93-4c67-a12e-aa2cc8890291)
THEN
DB_NOOP(1);

QRY
QRY_WYR_Mizora_MeetingFallback_CheckValid()
AND
NOT DB_GlobalFlag(WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e)
THEN
DB_NOOP(1);

PROC
PROC_WYR_Mizora_MeetingFallback()
AND
DB_WYR_MeetingMizoraSetupDone(1)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_WYR_CambionDialogTrigger_FallbackRegister_580571b6-9e87-486f-93dd-7d7dc0f36c95);
PROC_SpotPlayers_StopSpotting("ORI_Wyll_MeetingMizoraSpotting");
PROC_GLO_Monitor_EntityPoof(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a); //TODO: change to mizora's teleport
TeleportTo(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,(TRIGGER)S_WYR_CambionMeetingPoint_Fallback_48f5db57-f3cc-4fdd-9b48-e687b9c48869,"WYR_MeetingMizora_TeleportedFallback");

IF
EntityEvent(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"WYR_MeetingMizora_TeleportedFallback")
THEN
PROC_GLO_Monitor_EntityFoop(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a); //TODO: change to mizora's teleport
DB_SpotPlayers((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"ORI_Wyll_MeetingMizoraFallbackSpotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"ORI_Wyll_MeetingMizoraFallbackSpotting",(TRIGGER)S_WYR_CambionDialogTrigger_FallbackSpot_a2b1255b-5b99-46f4-90fe-858f78341eca);

QRY
QRY_OriginMoment_PreventRelaunchDialog(WYR_MeetingMizora_OM_Wyll_COM_AOM_OOM_56b90cd5-e0f5-34fb-ff76-6b569cef34e5,_,_)
THEN
DB_NOOP(1);

PROC
PROC_SpotPlayers_Spotted(_,"ORI_Wyll_MeetingMizoraSpotting",_Player)
AND
DB_Players(_Player)
AND
QRY_StartDialog((DIALOGRESOURCE)WYR_MeetingMizora_f075875a-5279-8fbb-0a9b-b40b4a437d66,(CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,_Player)
THEN
DB_NOOP(1);

PROC
PROC_SpotPlayers_Spotted(_,"ORI_Wyll_MeetingMizoraFallbackSpotting",_Player)
AND
DB_Players(_Player)
AND
QRY_StartDialog((DIALOGRESOURCE)WYR_MeetingMizora_f075875a-5279-8fbb-0a9b-b40b4a437d66,(CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,_Player)
THEN
DB_NOOP(1);

//END_REGION


//REGION Sending Mizora to Camp
IF
DialogEnded(WYR_MeetingMizora_OM_Wyll_COM_AOM_OOM_56b90cd5-e0f5-34fb-ff76-6b569cef34e5,_)
THEN
PROC_WYR_MeetingMizora_SentToCamp();

IF
DialogEnded((DIALOGRESOURCE)WYR_MeetingMizora_f075875a-5279-8fbb-0a9b-b40b4a437d66,_)
THEN
PROC_WYR_MeetingMizora_SentToCamp();

PROC
PROC_WYR_MeetingMizora_SentToCamp()
AND
DB_GlobalFlag(WYR_MeetingMizora_Event_MizoraLeftWYR_03f1d319-d5f4-8aa1-0f0d-d58e5b32bf2e)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_WYR_CambionDialogTrigger_FallbackRegister_580571b6-9e87-486f-93dd-7d7dc0f36c95);
PROC_GLO_Monitor_EntityPoof(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a); //TODO: change to mizora's teleport
PROC_ClearOriginMoment(WYR_MeetingMizora_OM_Wyll_COM_AOM_OOM_56b90cd5-e0f5-34fb-ff76-6b569cef34e5);
PurgeOsirisQueue((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);
SetEntityEvent(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,"ClearPeaceReturn");
PROC_RemoveDialog(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);
DB_Dialogs(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,(DIALOGRESOURCE)CAMP_Mizora_d1ad5fc6-6d64-e1b6-3f9d-e702a5c2d164);

PROC
PROC_CampfireMoment_PreDialog((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2)
AND
DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
NOT DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2,
								(GUIDSTRING)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,
								(GUIDSTRING)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,
								(GUIDSTRING)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,
								(GUIDSTRING)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_CampfireMoment_FixedSpeakers((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2,
								(GUIDSTRING)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,
								(GUIDSTRING)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,
								(GUIDSTRING)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa);
DB_CampfireMoment_FixedPlayer((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2, (GUIDSTRING)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

PROC
PROC_CampfireMoment_PreDialog((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2)
THEN
PROC_ORI_SetupCamp((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);
PROC_ORI_SetupCamp((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249);
PROC_ORI_SetupCamp((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa);

PROC
PROC_CampfireMoment_PreDialog((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2)
AND
DB_GlobalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61)
THEN
PROC_ORI_SetupCamp(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2,(INTEGER)_Inst)
AND
DB_GlobalFlag((FLAG)GLO_Ravengard_State_Defeated_7bb624ef-09cb-4e55-b035-832c05427a61)
THEN
PROC_DialogAddSpeakingActor(_Inst,S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

IF
FlagSet(WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1,_,_)
THEN
PROC_CAMP_Ravengard_ResurrectedByMizora();

PROC
PROC_CAMP_Ravengard_ResurrectedByMizora()
THEN
PROC_CAMP_Ravengard_RestoreRavengard();
Resurrect((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
SetFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
SetHasDialog(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
DB_Dialogs((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (DIALOGRESOURCE)CAMP_Ravengard_c9e72a15-7691-102d-4f00-f20b7ab8ff95); //Not having an entry in DB_Dialogs causes SetHasDialog to be set to 0 after a PROC_CharacterMoveTo
ToInventory((ITEM)S_GLO_AnsurGhost_LegendOfAnsurBook_b0ecc3d5-85ad-48fa-bc47-988107507e6c, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1, 0, 1);
DB_Camp_Ravengard_BeingResurrectedByMizora(1);

//If he was killed by Mizora before the pact scene while in the Iron Throne and was then resurrected, clean up after his IRN setup
PROC
PROC_CAMP_Ravengard_ResurrectedByMizora()
AND
DB_GlobalFlag((FLAG)IRN_Ravengard_State_KilledOffscreenByMizoraBeforePactScene_f4a0eace-8c06-4d5e-a446-7b5e64d3b80f)
THEN
ClearTag(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (TAG)ACT3_LOW_IRONTHRONE_RAVENGARDTARGET_6953dce2-8f2f-4ff4-bb29-78cbb3dc5638);
SetCanJoinCombat(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
RemoveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_PRISONER_RAVENGARD", NULL_00000000-0000-0000-0000-000000000000);
PROC_CAMP_Ravengard_RestoreEquipmentAfterIRN();

//Removing DB_PreventPermaDefeated too early causes him to be added to DB_PermaDefeated immediately as it is a trigger condition, making the resurrect fail to bring him back properly
IF
Resurrected((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
DB_Camp_Ravengard_BeingResurrectedByMizora(1)
THEN
NOT DB_Camp_Ravengard_BeingResurrectedByMizora(1);
NOT DB_PreventPermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

PROC
PROC_CAMP_Ravengard_RestoreRavengard()
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_WYR_WyrmRock_Ravengard_a7892e9b-2f74-4c2c-83d1-feba3daa55ce, 50);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_IronThrone_Ravengard_d884141d-e554-4ab8-a209-cad8c8fbdad7, 50);
DB_NoLowAttitudeDialog((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

PROC
PROC_CAMP_Ravengard_RestoreRavengard()
THEN
PROC_RestoreAttitudeToPartyIfLower((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 0);

PROC
PROC_CampfireMoment_PostDialog((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2)
AND
DB_GlobalFlag(WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1)
THEN
PROC_CampRelationshipDialog((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,(DIALOGRESOURCE)CAMP_Ravengard_c9e72a15-7691-102d-4f00-f20b7ab8ff95,(FLAG)FCRD_Ravengard_FirstTimeInCamp_45b556aa-f39d-45b9-889e-0bdaffaa30dc,0);
PROC_Try_CampRelationshipDialog((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,1);

PROC
PROC_CampfireMoment_PostDialog((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2)
THEN
PROC_GLO_Monitor_EntityPoof((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249);
PROC_GLO_Monitor_EntityPoof((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa);
NOT DB_CanBeResurrected(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
NOT DB_InCamp(S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249);
NOT DB_InCamp(S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa);
NOT DB_PartOfTheTeam(S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249);
NOT DB_PartOfTheTeam(S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa);
NOT DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,"FARM",(TRIGGER)S_FARM_MizorasPact_Devil01_Point_71b54b5c-eb8b-477b-9129-28cb4864aa8c);
NOT DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,"SLUMS",(TRIGGER)S_CAMP_MizorasPact_Devil01_Point_ba130696-019b-4717-a66e-9c4c50141a85);
NOT DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil01_cce497bd-4d56-42b2-b2f8-236dffd48249,"ELFSONG",(TRIGGER)S_ELFSONG_MizorasPact_Devil01_Point_6b07a6a1-6048-4229-8b69-b85c1d531130);
NOT DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,"FARM",(TRIGGER)S_FARM_MizorasPact_Devil02_Point_ac0544cf-3920-4467-a35c-9173f97df6a0);
NOT DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,"SLUMS",(TRIGGER)S_CAMP_MizorasPact_Devil02_Point_67b32487-681b-4b21-9311-0cb39537e10b);
NOT DB_ORI_OriginCampData((CHARACTER)S_CAMP_MizorasPact_Devil02_24440f3b-5977-4c4a-b97e-2415a2b533fa,"ELFSONG",(TRIGGER)S_ELFSONG_MizorasPact_Devil02_Point_d108a198-f1cc-4474-951e-7d98364c1f29);

PROC
PROC_CampfireMoment_PostDialog((DIALOGRESOURCE)CAMP_MizorasPact_CFM_332084e3-3f24-6ad2-50af-62ee0d0d54c2)
AND
NOT DB_GlobalFlag(WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1)
AND
DB_Defeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
SetOnStage(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,0);
NOT DB_InCamp(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
NOT DB_PartOfTheTeam(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
NOT DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"FARM",(TRIGGER)S_CAMP_Ravengard_e50982fd-0b00-4287-b183-20eddeb3069b);
NOT DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"SLUMS",(TRIGGER)S_CAMP_SLUMS_Ravengard_81249232-3284-4e78-9de8-4c4407914c8e);
NOT DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,"ELFSONG",(TRIGGER)S_CAMP_ELFSONG_Ravengard_6cace9b7-a095-44cf-98df-c5a6c7a3e090);

IF
FlagSet((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6, _, _)
THEN
NOT DB_PreventPermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
//END_REGION


//REGION Ravengard
IF
FlagSet((FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1, _, _)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
THEN
ClearFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496);

PROC
PROC_IRN_KillRavengard()
THEN
Die(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, DEATHTYPE.Psychic, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
SetFlag((FLAG)IRN_Ravengard_State_KilledOffscreenByMizoraBeforePactScene_f4a0eace-8c06-4d5e-a446-7b5e64d3b80f);

//Wyll turns hostile if Ravengard is killed by a player other than Companion Wyll
IF
EnteredCombat((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Combat)
AND
NOT DB_GlobalFlag((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99)
AND
QRY_ORI_Wyll_RavengardSaved()
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
DB_Is_InCombat(_PartyMember,_Combat)
AND
QRY_IsEnemy(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,_PartyMember)
AND
QRY_ORI_Wyll_RavengardKilled_AD(_PartyMember)
AND
NOT DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "CompanionHostile");
PROC_SetRelationToPlayers((FACTION)Origin_Wyll_ca92900a-f1b8-443f-885b-c64c1047a423, 0);

QRY
QRY_ORI_Wyll_RavengardSaved()
AND
DB_GlobalFlag((FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Wyll_RavengardSaved()
AND
DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Wyll_RavengardKilled_AD(_PartyMember)
AND
_PartyMember != S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d
THEN
PROC_TryStartAD((DIALOGRESOURCE)IRN_IronThrone_AD_WyllReactsToPlayerKillingRavengard_b00ab024-731a-ce45-c459-f22a51177372, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

QRY
QRY_ORI_Wyll_RavengardKilled_AD(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
PROC_TryStartAD((DIALOGRESOURCE)IRN_IronThrone_AD_WyllReactsToRavengardDying_dc8dc7d4-bb6a-ed91-c298-71e2468c7c2b, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_CrimeID, _, _, _, S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a)
THEN
CrimeIgnoreCrime(_CrimeID, (CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

//Found out about Ravengard dying in the Iron Throne explosion
// -- Reading letter left by Redhammer in the Dock Warehouse basement
IF
FlagSet((FLAG)LOW_DockWareHouse_State_ReadResignationLetter_WithRavengard_a65a0874-9c21-47af-879d-9cf27474b634, _, _)
THEN
SetFlag((FLAG)GLO_Ravengard_Knows_KilledDuringIRNDestruction_479fc5e6-daa9-4e82-b1c4-3dd282e130de);

IF
FlagSet((FLAG)GLO_Ravengard_Knows_KilledDuringIRNDestruction_479fc5e6-daa9-4e82-b1c4-3dd282e130de, _, _)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,
Wyll_InParty2_Event_ReactedRavengardDeath_374e2383-f0e9-4353-3e35-9dd10c03eb9a,S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,0);

//If players enter the Iron Throne before the pact scene but leave without seeing Ravengard dead
IF
FlagSet((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9, _, _)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
DB_GlobalFlag((FLAG)IRN_Ravengard_State_KilledOffscreenByMizoraBeforePactScene_f4a0eace-8c06-4d5e-a446-7b5e64d3b80f)
AND
NOT DB_GlobalFlag((FLAG)GLO_Ravengard_State_SeenDeadRavengardDuringIRN_43cea123-9650-46f3-99d4-64c6d284ef1f)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,
Wyll_InParty2_Event_ReactedRavengardDeath_374e2383-f0e9-4353-3e35-9dd10c03eb9a,S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,0);

IF
FlagSet((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a, _, _)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6, (FLAG)Wyll_InParty2_Event_ReactedRavengardDeath_374e2383-f0e9-4353-3e35-9dd10c03eb9a);
//END_REGION


//REGION Romance Wyll
IF
DB_Dead(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
SetFlag((FLAG)WYR_Ravengard_State_KilledBeforeIRN_bb43c67a-cc36-4498-9e76-1faaf010cc2a);

IF
FlagSet((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a,_,_)
THEN
DB_LongRestCountDown(1,CAMP_Wyll_Act3Romance_Event_CanStart_d27dc3e6-e856-4e87-8140-a25f4d5ba57d);

PROC
PROC_CampNight_StartSelected()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_Wyll_Act3Romance_0dec1691-512f-4b13-9249-5cce64227231)
THEN
DB_Camp_RequiredTalks(CAMP_Wyll_CRD_Act3Romance_ROM_599fe884-f39f-a3b5-7a86-ca239e016a05);

IF
FlagSet((FLAG)CAMP_Wyll_Act3Romance_Event_Began_cb51446f-3a3e-62e7-00ee-0484f90f64b7, _, _)
THEN
PROC_Camp_RequiredTalks_Complete(CAMP_Wyll_CRD_Act3Romance_ROM_599fe884-f39f-a3b5-7a86-ca239e016a05);
//END_REGION


//REGION Romance Mizora
IF
FlagSet((FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381,_Player,_)
THEN
DB_LongRestCountDown(2,(FLAG)CAMP_Mizora_State_SuggestRomance_7e3e4852-5fac-4b51-9fc9-036d315b720d);

IF
FlagSet(CAMP_Mizora_Event_ReadyForRomance_753a635d-e457-ab5f-a180-3a346ca00875,_Player,_)
THEN
DB_CampfireMoment_FixedPlayer((DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12, (CHARACTER)_Player);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12,_Inst)
AND
DB_CampfireMoment_FixedPlayer((DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12, _MainPlayer)
AND
DB_ORI_Partnered(_MainPlayer,_Partner)
THEN
PROC_DialogAddSpeakingActor(_Inst,_Partner);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12,_Inst)
AND
DB_CampfireMoment_FixedPlayer((DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12, _MainPlayer)
AND
NOT DB_ORI_Partnered(_MainPlayer,_)
AND
NOT DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_InCamp((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
PROC_DialogAddSpeakingActor(_Inst,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12,_Inst)
AND
DB_PlayerInCamp(_OtherPlayer)
AND
NOT DB_CantTalk(_OtherPlayer)
AND
QRY_OnlyOnce("CAMP_MizoraMorningAfter_CFM_Partymember1")
THEN
PROC_DialogAddSpeakingActorAt(_Inst,_OtherPlayer,11);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12,_Inst)
AND
DB_PlayerInCamp(_OtherPlayer)
AND
NOT DB_CantTalk(_OtherPlayer)
AND
QRY_OnlyOnce("CAMP_MizoraMorningAfter_CFM_Partymember2")
THEN
PROC_DialogAddSpeakingActorAt(_Inst,_OtherPlayer,12);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_69ddc432-0293-98b1-e512-baff8b160f12,_Inst)
AND
DB_PlayerInCamp(_OtherPlayer)
AND
NOT DB_CantTalk(_OtherPlayer)
AND
QRY_OnlyOnce("CAMP_MizoraMorningAfter_CFM_Partymember3")
THEN
PROC_DialogAddSpeakingActorAt(_Inst,_OtherPlayer,13);

QRY
QRY_Inclusion_BlockCompanionInclusion((GUIDSTRING)_Companion,(DIALOGRESOURCE)CAMP_MizoraMorningAfter_CFM_ROM_69ddc432-0293-98b1-e512-baff8b160f12)
THEN
DB_NOOP(1);
//END_REGION


//REGION Ansur
IF
FlagSet((FLAG)ORI_Wyll_Knows_SentToFindAnsur_9bc505eb-3531-2f9e-1e55-477ed0e475bc, _, _)
THEN
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)WYR_EntranceStatue_21a578ec-2d9e-41c6-4a08-2a264113e37c, (TAG)REALLY_WYLL_5f40def5-d3ec-4698-a367-01a339888956, (DIALOGRESOURCE)WYR_EntranceStatue_OM_Wyll_AOM_869fd4cc-b83e-f6d0-b53f-484206e1b450, (DIALOGRESOURCE)WYR_EntranceStatue_OM_Wyll_COM_OOM_1cf467b5-5263-4cdf-e63e-87017176d132, (DIALOGRESOURCE)WYR_EntranceStatue_OM_Wyll_COM_OOM_1cf467b5-5263-4cdf-e63e-87017176d132);


IF
DialogStarted((DIALOGRESOURCE)WYR_EntranceStatue_21a578ec-2d9e-41c6-4a08-2a264113e37c, _ID)
AND
GetFlag((FLAG)AOM_794d7d9a-4e15-849c-7c0d-6e6cdb67cdcb, S_WYR_EntranceStatue_750036f3-7abc-41b8-8cd0-9b977500d5b3, 1)
THEN
SetFlag((FLAG)OM_BlockChaining_9b8c01fc-8cc8-40d5-a8df-59a725a578c9, S_WYR_EntranceStatue_750036f3-7abc-41b8-8cd0-9b977500d5b3, 1);

IF
DialogEnded((DIALOGRESOURCE)WYR_EntranceStatue_OM_Wyll_COM_OOM_1cf467b5-5263-4cdf-e63e-87017176d132, _)
AND
DB_GlobalFlag((FLAG)WYR_Balduran_Event_OpenDoor_99e8c929-4b71-3e03-2b43-6e7421896f7a)
AND
QRY_OnlyOnce("WYR_BalduranOpenDoor")
THEN
PROC_ItemUnlockAndOpen(S_WYR_Wyrmway_Entrance_29448775-b702-4ea2-94c0-d40b27844c38);
AutoSave();

//END_REGION


//REGION Ravengard killed offscreen by the Iron Throne being destroyed
IF
FlagSet((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9, _, _)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllEternalPact_8da8b1fb-5aa9-8cf5-8b45-6f8ca31a1227)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
THEN
SetFlag((FLAG)CAMP_Mizora_State_WantsToResurrectRavengardAfterIRNDestruction_ac394670-1bb9-4e9e-92dc-8fa9382d4a64);

//QRY should be enabled once the lines are destubbed, recorded and cinematically ready
QRY
QRY_CAMP_Ravengard_NewLinesAvailable_GUS_301029()
AND
1 == 0 //Change to 1 == 1 once lines are ready
THEN
DB_NOOP(1);

//Bypassing the new narrator dialog until it is fully ready - instead of triggering the dialog, trigger the logic following it's completion directly (she speaks an AD, so it flows nicely even without)
QRY
QRY_SelectCustomDialog(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _Player)
AND
DB_GlobalFlag((FLAG)CAMP_Mizora_State_WantsToResurrectRavengardAfterIRNDestruction_ac394670-1bb9-4e9e-92dc-8fa9382d4a64)
AND
NOT QRY_CAMP_Ravengard_NewLinesAvailable_GUS_301029()
THEN
ClearFlag((FLAG)CAMP_Mizora_State_WantsToResurrectRavengardAfterIRNDestruction_ac394670-1bb9-4e9e-92dc-8fa9382d4a64);
SetFlag((FLAG)CAMP_Mizora_State_ResurrectedRavengardAfterIRNDestruction_64816ccb-c284-4f53-b730-565997635054);
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_LeadingPlayer((CHARACTER)_Player);
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_InitialDialogFinished();
PROC_CancelRelationshipDialog((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, CAMP_Mizora_TalkToResurrectRavengard_a3881b60-bec8-0f55-99fe-7b22f6e93592,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
PROC_ExclamationMark_Hide(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a); //To cover for daytime since the exclamation mark persists

IF
DialogStarted(CAMP_Mizora_TalkToResurrectRavengard_a3881b60-bec8-0f55-99fe-7b22f6e93592, _Id)
AND
DB_DialogPlayers(_Id, _Player, 1)
THEN
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_LeadingPlayer((CHARACTER)_Player);

IF
NestedDialogPlayed(CAMP_Mizora_TalkToResurrectRavengard_a3881b60-bec8-0f55-99fe-7b22f6e93592, _Id)
AND
DB_DialogPlayers(_Id, _Player, 1)
THEN
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_LeadingPlayer((CHARACTER)_Player);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)CAMP_Mizora_State_ResurrectedRavengardAfterIRNDestruction_64816ccb-c284-4f53-b730-565997635054)
THEN
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_InitialDialogFinished();

PROC
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_InitialDialogFinished()
THEN
SetHasDialog((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, 0); //Players should not be able to talk to Mizora while she's resurrecting Ravengard

PROC
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_InitialDialogFinished()
AND
NOT QRY_StartDialog_Fixed(IRN_IronThrone_AD_MizoraHelpsRavengardTeleportedToSub_InSubmersible_9fba529c-3f37-01dc-3805-49341f7a062e, S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a)
THEN
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_StartResurrection();

IF
AutomatedDialogEnded((DIALOGRESOURCE)IRN_IronThrone_AD_MizoraHelpsRavengardTeleportedToSub_InSubmersible_9fba529c-3f37-01dc-3805-49341f7a062e, _)
AND
DB_GlobalFlag((FLAG)CAMP_Mizora_State_ResurrectedRavengardAfterIRNDestruction_64816ccb-c284-4f53-b730-565997635054)
THEN
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_StartResurrection();

PROC
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_StartResurrection()
THEN
PROC_ORI_SetupCamp((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectionOngoing(1);
SetFlag((FLAG)WYR_Ravengard_State_Resurrected_86c9572d-84e7-b407-0ce6-84fd263418a1); //Resurrects and moves Ravengard to his default Camp Pos
PROC_SetOnStage(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1);
TimerLaunch("CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectionBackupTimer", 15000); //In case the Resurrected event never arrives for some reason

IF
TimerFinished("CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectionBackupTimer")
THEN
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectRavengard();

IF
Resurrected((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
TimerCancel("CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectionBackupTimer");
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectRavengard();

PROC
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectRavengard()
THEN
TimerLaunch("CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_MizoraHasDialogRestore_BackupTimer", 10000); //If soemthing goes wrong, enable Mizora's dialogs again

IF
TimerFinished("CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_MizoraHasDialogRestore_BackupTimer")
THEN
SetHasDialog((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, 1);

PROC
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectRavengard()
AND
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectionOngoing(1)
AND
NOT QRY_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_TryGetPosNearMizora()
AND
DB_ActiveCamp(_ActiveCamp)
AND
DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _ActiveCamp, _RavengardPos)
THEN
NOT DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectionOngoing(1);
DB_Camp_BlockCamperPosAdjustment(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
PROC_GLO_MizoraAppear((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _RavengardPos, "CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_AppearedAtCamp");

QRY
QRY_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_TryGetPosNearMizora()
AND
GetPosition((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _MizoraX, _MizoraY, _MizoraZ) //Good position for this moment
AND
FindValidPosition(_MizoraX, _MizoraY, _MizoraZ, 5.0, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1, _RavengardX, _RavengardY, _RavengardZ)
THEN
NOT DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectionOngoing(1);
DB_Camp_BlockCamperPosAdjustment(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
PROC_GLO_MizoraAppear((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _RavengardX, _RavengardY, _RavengardZ, "CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_AppearedAtCamp");

//FindValidPosition fallback
QRY
QRY_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_TryGetPosNearMizora()
AND
NOT DB_Camp_BlockCamperPosAdjustment(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
GetPosition((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _MizoraX, _MizoraY, _MizoraZ) //Good position for this moment
THEN
NOT DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ResurrectionOngoing(1);
DB_Camp_BlockCamperPosAdjustment(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
PROC_GLO_MizoraAppear((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _MizoraX, _MizoraY, _MizoraZ, "CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_AppearedAtCamp");


IF
EntityEvent(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_AppearedAtCamp")
THEN
TimerLaunch("CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_CheckPlayerAvailability", 1000);

IF
TimerFinished("CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_CheckPlayerAvailability")
AND
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_LeadingPlayer(_Player) //If it is still set after the timer, the dialog failed to start, send Ravengard back to camp pos
THEN
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ReturnToPos();

IF
EntityEvent(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_AppearedAtCamp")
AND
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_LeadingPlayer(_Player)
AND
DB_InCamp(_Player)
AND
NOT QRY_SelectAndStartDialog((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Player)
THEN
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ReturnToPos();

IF
DialogStarted((DIALOGRESOURCE)CAMP_Ravengard_c9e72a15-7691-102d-4f00-f20b7ab8ff95, _)
AND
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_LeadingPlayer(_Player)
THEN
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ReturnToPos();

IF
DialogRequestFailed((DIALOGRESOURCE)CAMP_Ravengard_c9e72a15-7691-102d-4f00-f20b7ab8ff95, _)
AND
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_LeadingPlayer(_Player)
THEN
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ReturnToPos();

PROC
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ReturnToPos()
AND
DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_LeadingPlayer(_Player)
THEN
NOT DB_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_LeadingPlayer(_Player);

PROC
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ReturnToPos()
AND
DB_Camp_BlockCamperPosAdjustment(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
NOT DB_Camp_BlockCamperPosAdjustment(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

PROC
PROC_CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ReturnToPos()
THEN
TimerCancel("CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_MizoraHasDialogRestore_BackupTimer");
SetHasDialog((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, 1);
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ReturnToPos");

PROC
PROC_ReadyToMoveOn((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "CAMP_Ravengard_MizoraResurrectsRavengardAfterIRNDestruction_ReturnToPos")
THEN
PROC_CAMP_ReturnToCampPos((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

//END_REGION


//REGION Ravengard and Mizora leave if Wyll is no longer part of team
//If Wyll leaves the team permanently after Ravengard and Mizora are already part of the camp team, they leave as well
PROC
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _)
AND
DB_Players(_Player)
AND
QuestIsAccepted(_Player, "ORI_COM_Wyll", 1)
THEN
QuestUpdate(_Player, "ORI_COM_Wyll", "BrokenAbandoned"); //ToDo: Add better journal update

PROC
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _)
AND
DB_Players(_Player)
AND
QuestIsAccepted(_Player, "PLA_GrandDukeRescue", 1)
THEN
QuestUpdate(_Player, "PLA_GrandDukeRescue", "LeftAct_Duke"); //ToDo: Add better journal update

PROC
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _)
AND
DB_InCamp((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
PROC_ORI_Wyll_WyllLeftTeam_DropLetter((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
DB_ORI_Wyll_WyllLeftTeam_RavengardLeaving(1);

PROC
PROC_ORI_Wyll_WyllLeftTeam_DropLetter((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
DB_Dead((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllDead_365521bd-e2bd-4eea-b19a-9d599e0e855d);

PROC
PROC_ORI_Wyll_WyllLeftTeam_DropLetter((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
NOT DB_Dead((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (ITEM)S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllAlive_966a0749-ac05-4398-9080-998fd50665ed);

PROC
PROC_ORI_Wyll_WyllLeftTeam_DropLetter((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a)
AND
DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
THEN
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, S_ORI_Wyll_WyllLeavesTeam_MizoraNotePactBroken_a8151237-1ba8-43de-a712-76de13565e73);

PROC
PROC_ORI_Wyll_WyllLeftTeam_DropLetter((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
THEN
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, S_ORI_Wyll_WyllLeavesTeam_MizoraNotePactKept_bb5b1633-353a-47f3-b42a-40aacf8db2d5);

//Sent when he has dropped the shield and the letter
IF
EntityEvent(S_ORI_Wyll_WyllLeavesTeam_RavengardLetter_966a0749-ac05-4398-9080-998fd50665ed, "ORI_Wyll_WyllLeavesTeam_RavengardLetterMovedToShield")
AND
DB_ORI_Wyll_WyllLeftTeam_RavengardLeaving(1)
THEN
NOT DB_ORI_Wyll_WyllLeftTeam_RavengardLeaving(1);
PROC_DisappearOutOfSight((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "ORI_Wyll_WyllLeftTeam_TeleportToAsylum", 0, "Walk");
ClearFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a);
NOT DB_PartOfTheTeam(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
DB_ORI_Wyll_WyllLeftTeam_CharacterShouldLeaveCamp((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

IF
EntityEvent(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "ORI_Wyll_WyllLeftTeam_TeleportToAsylum")
AND
DB_ORI_Wyll_WyllLeftTeam_CharacterShouldLeaveCamp((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
NOT DB_ORI_Wyll_WyllLeftTeam_CharacterShouldLeaveCamp((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
PROC_ORI_Wyll_WyllLeavesTeam_TeleportToAsylum((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);

PROC
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _)
AND
DB_InCamp((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a)
THEN
PROC_ORI_Wyll_WyllLeftTeam_DropLetter((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);
PROC_GLO_MizoraDisappear((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, "ORI_Wyll_WyllLeftTeam_MizoraDisappeared");
NOT DB_PartOfTheTeam((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);
DB_ORI_Wyll_WyllLeftTeam_CharacterShouldLeaveCamp((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);

IF
AnimationEvent(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, "AnimationSetOffStage", 0)
AND
DB_ORI_Wyll_WyllLeftTeam_CharacterShouldLeaveCamp(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a)
THEN
NOT DB_ORI_Wyll_WyllLeftTeam_CharacterShouldLeaveCamp(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);
PROC_ORI_Wyll_WyllLeavesTeam_TeleportToAsylum((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a);

PROC
PROC_ORI_Wyll_WyllLeavesTeam_TeleportToAsylum((CHARACTER)_Character)
AND
DB_ActiveLevel("CTY_Main_A")
THEN
TeleportTo(_Character, (TRIGGER)S_ORI_Wyll_WyllLeavesTeam_AsylumPos_CTY_12776689-6743-44e7-9a6b-ab6a23bb2cdd, "", 0, 0, 0, 1, 0);

PROC
PROC_ORI_Wyll_WyllLeavesTeam_TeleportToAsylum((CHARACTER)_Character)
AND
DB_ActiveLevel("BGO_Main_A")
THEN
TeleportTo(_Character, (TRIGGER)S_ORI_Wyll_WyllLeavesTeam_AsylumPos_BGO_26f78bf4-1f62-4205-b2a9-bfd2af4769d6, "", 0, 0, 0, 1, 0);

PROC
PROC_ORI_Wyll_WyllLeftTeam_DropLetter((CHARACTER)_Character)
AND
DB_ActiveCamp(_Camp)
AND
DB_ORI_Wyll_WyllLeftTeam_Letters(_Character, _Letter)
THEN
DB_ORI_Wyll_WyllLeavesTeam_LetterCurrentlyInCamp((ITEM)_Letter, (STRING)_Camp);

//Foop mizora's letter when she's gone, leaving a fire surface around it until it's picked up so it can stand out
PROC
PROC_GLO_MizoraDisappear_DisappearedHook((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, "ORI_Wyll_WyllLeftTeam_MizoraDisappeared")
AND
DB_ActiveCamp(_Camp)
AND
DB_ORI_OriginCampData((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _Camp, _Pos)
AND
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _Letter)
THEN
PROC_GLO_MizoraAppear(_Letter, _Pos, "ORI_Wyll_WyllLeavesCamp_MizoraLetterDropped");
CreateSurface(_Letter, "SurfaceFire", 2.0, -1.0, NULL_00000000-0000-0000-0000-000000000000);
DB_ORI_Wyll_WyllLeavesTeam_MizoraFireSurfaceActive(_Letter, _Camp); //Track where the fire surface is spawned to clean it up later when the same level is loaded

//Ravengard drops the letter on top of a flaming fist generic shield, again to make the letter stand out and connect it to Ravengard
PROC
PROC_ORI_Wyll_WyllLeftTeam_DropLetter((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
DB_ActiveCamp(_Camp)
AND
DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Camp, _Pos)
THEN
TeleportTo(S_ORI_Wyll_WyllLeavesTeam_RavengardShield_582b7f3b-1fb3-4962-8e5f-1162dcdafd5d, _Pos, "ORI_Wyll_WyllLeavesTeam_ShieldDropped", 0, 0, 0, 0, 1);
PROC_Foop((ITEM)S_ORI_Wyll_WyllLeavesTeam_RavengardShield_582b7f3b-1fb3-4962-8e5f-1162dcdafd5d);

//Move the letter to the shield's position and level
IF
EntityEvent(_Shield, "ORI_Wyll_WyllLeavesTeam_ShieldDropped")
THEN
PROC_ORI_Wyll_WyllLeavesTeam_TeleportLetterOnShield();

PROC
PROC_ORI_Wyll_WyllLeavesTeam_TeleportLetterOnShield()
AND
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Letter)
THEN
TeleportTo(_Letter, S_ORI_Wyll_WyllLeavesTeam_RavengardShield_582b7f3b-1fb3-4962-8e5f-1162dcdafd5d, "ORI_Wyll_WyllLeavesTeam_RavengardLetterMovedToShield", 0, 0, 0, 0, 0);

//Move the letter on top of the shield, slightly offset
IF
EntityEvent(S_ORI_Wyll_WyllLeavesTeam_RavengardLetter_966a0749-ac05-4398-9080-998fd50665ed, "ORI_Wyll_WyllLeavesTeam_RavengardLetterMovedToShield")
AND
GetPosition(S_ORI_Wyll_WyllLeavesTeam_RavengardShield_582b7f3b-1fb3-4962-8e5f-1162dcdafd5d, _X, _Y, _Z)
AND
RealSum(_Y, 0.1, _OffsetY)
AND
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Letter)
THEN
TeleportToPosition(_Letter, _X, _OffsetY, _Z, "", 0, 0, 0, 0, 0);

//If players switch camps without picking up or reading each letter, move the letter to the appropriate camps (assuming players have not seen them here)
IF
DB_ActiveCamp(_NewCamp)
AND
DB_ORI_OriginCampData(_Character, _NewCamp, _Pos)
AND
DB_ORI_Wyll_WyllLeftTeam_Letters(_Character, _Letter)
AND
NOT DB_ORI_Wyll_WyllLeavesTeam_PickedUpLetter(_Letter)
AND
DB_ORI_Wyll_WyllLeavesTeam_LetterCurrentlyInCamp((ITEM)_Letter, _Camp)
AND
_NewCamp != _Camp
THEN
NOT DB_ORI_Wyll_WyllLeavesTeam_LetterCurrentlyInCamp(_Letter, _Camp);
DB_ORI_Wyll_WyllLeavesTeam_LetterCurrentlyInCamp(_Letter, _NewCamp);
PROC_ORI_Wyll_WyllLeavesTeam_MoveLettersToNewCamp(_Character, _NewCamp);

//Mizora's letter creates a new fire surface in the new camp underneath it, clearing the surface in the previous camp
PROC
PROC_ORI_Wyll_WyllLeavesTeam_MoveLettersToNewCamp((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, (STRING)_NewCamp)
AND
DB_ORI_OriginCampData((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _NewCamp, _Pos)
AND
DB_ORI_Wyll_WyllLeftTeam_Letters(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _Letter)
THEN
TeleportTo(_Letter, _Pos, "", 0, 0, 0, 0, 1);
CreateSurface(_Letter, "SurfaceFire", 2.0, -1.0, NULL_00000000-0000-0000-0000-000000000000);
DB_ORI_Wyll_WyllLeavesTeam_MizoraFireSurfaceActive(_Letter, _NewCamp); //Track where the fire surface is spawned to clean it up later when the same level is loaded

//Ravengard's letter moves along with the shield
PROC
PROC_ORI_Wyll_WyllLeavesTeam_MoveLettersToNewCamp((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (STRING)_NewCamp)
AND
DB_ORI_OriginCampData((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _NewCamp, _Pos)
THEN
TeleportTo(S_ORI_Wyll_WyllLeavesTeam_RavengardShield_582b7f3b-1fb3-4962-8e5f-1162dcdafd5d, _Pos, "ORI_Wyll_WyllLeavesTeam_ShieldTeleported", 0, 0, 0, 0, 1);

IF
EntityEvent(_, "ORI_Wyll_WyllLeavesTeam_ShieldTeleported")
THEN
PROC_ORI_Wyll_WyllLeavesTeam_TeleportLetterOnShield();

//If the shield has been touched by anyone, make the letter drop to the floor. If the letter is picked up by players, it should automatically enable gravity too
IF
Moved(S_ORI_Wyll_WyllLeavesTeam_RavengardShield_582b7f3b-1fb3-4962-8e5f-1162dcdafd5d)
AND
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Letter)
AND
NOT DB_ORI_Wyll_WyllLeavesTeam_PickedUpLetter(_Letter)
THEN
DB_ORI_Wyll_WyllLeavesTeam_PickedUpLetter(_Letter);
SetGravity((ITEM)_Letter, GRAVITYTYPE.Enabled, NULL_00000000-0000-0000-0000-000000000000);

//Moving the letter in any way counts as picking it up
IF
Moved(_Letter)
AND
DB_ORI_Wyll_WyllLeftTeam_Letters(_, _Letter)
AND
NOT DB_ORI_Wyll_WyllLeavesTeam_PickedUpLetter(_Letter)
THEN
DB_ORI_Wyll_WyllLeavesTeam_PickedUpLetter(_Letter);

//Reading the letter without picking it up also counts as letter being received
IF
UseFinished(_, _Letter, 1)
AND
DB_ORI_Wyll_WyllLeftTeam_Letters(_, _Letter)
AND
NOT DB_ORI_Wyll_WyllLeavesTeam_PickedUpLetter(_Letter)
THEN
DB_ORI_Wyll_WyllLeavesTeam_PickedUpLetter(_Letter);

//Once Mizora's letter has been moved/pickedup/read - clear the surface
IF
DB_ORI_Wyll_WyllLeavesTeam_PickedUpLetter(_Letter)
AND
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _Letter)
AND
DB_ORI_Wyll_WyllLeavesTeam_MizoraFireSurfaceActive((ITEM)_Letter, _Camp)
AND
DB_ActiveCamp(_Camp)
AND
DB_ORI_OriginCampData((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _Camp, _Pos)
THEN
NOT DB_ORI_Wyll_WyllLeavesTeam_MizoraFireSurfaceActive(_Letter, _Camp);
CreateSurface(_Pos, "SurfaceNone", 2.0, -1.0, NULL_00000000-0000-0000-0000-000000000000);

//If Wyll dies after Ravengard has dropped his WyllAlive letter but players haven't read it yet - swap the WyllAlive letter to the WyllDead letter
IF
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllAlive_966a0749-ac05-4398-9080-998fd50665ed)
AND
NOT DB_ORI_Wyll_WyllLeavesTeam_PickedUpLetter(S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllAlive_966a0749-ac05-4398-9080-998fd50665ed)
AND
DB_Dead((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
DB_ORI_Wyll_WyllLeavesTeam_LetterCurrentlyInCamp(S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllAlive_966a0749-ac05-4398-9080-998fd50665ed, _CurrentCamp)
THEN
PROC_SetOnStage(S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllAlive_966a0749-ac05-4398-9080-998fd50665ed, 0);
NOT DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllAlive_966a0749-ac05-4398-9080-998fd50665ed);
DB_ORI_Wyll_WyllLeftTeam_Letters((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllDead_365521bd-e2bd-4eea-b19a-9d599e0e855d);
NOT DB_ORI_Wyll_WyllLeavesTeam_LetterCurrentlyInCamp(S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllAlive_966a0749-ac05-4398-9080-998fd50665ed, _CurrentCamp);
DB_ORI_Wyll_WyllLeavesTeam_LetterCurrentlyInCamp(S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllDead_365521bd-e2bd-4eea-b19a-9d599e0e855d, _CurrentCamp);
TeleportTo(S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllDead_365521bd-e2bd-4eea-b19a-9d599e0e855d, S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllAlive_966a0749-ac05-4398-9080-998fd50665ed, "", 0, 0, 0, 0, 0);
PROC_SetOnStage(S_ORI_Wyll_WyllLeavesTeam_RavengardLetterWyllDead_365521bd-e2bd-4eea-b19a-9d599e0e855d, 1);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3_GEN"
