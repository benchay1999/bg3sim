Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Flaming Fists
DB_Dialogs(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc);
DB_Dialogs(S_WYR_RefugeeCamp_FlamingFist_001_2e90c37b-78ca-4df5-9fdc-3a680e3fafc1, WYR_RefugeeCamp_FlamingFist_001_f21754e7-489b-4b50-899e-c98d3649e1df);
DB_Dialogs(S_WYR_RefugeeCamp_FlamingFist_002_e93bd361-c99d-454d-b6be-f998bf67056f, WYR_RefugeeCamp_FlamingFist_002_b2475a60-8205-fe71-d293-ba7729218819);
DB_Dialogs(S_WYR_RefugeeCamp_FlamingFist_003_5e55ec6a-496a-46c0-9a08-2755f4acb665, WYR_RefugeeCamp_FlamingFist_003_9f43c725-007b-ec69-6391-ab970203c234);
DB_Dialogs(S_WYR_RefugeeCamp_FlamingFist_004_285923f1-dce0-4f7f-8ebe-0de8ba990467, WYR_RefugeeCamp_FlamingFist_004_eb8c17b7-66e7-b89d-859d-29f6c80bd42b);
DB_Dialogs(S_WYR_RefugeeCamp_FlamingFist_005_ea3260b0-3e43-4742-ad3e-b570807bc802, WYR_RefugeeCamp_FlamingFist_005_71432b0d-45cc-3215-0306-680abba26ab1);
DB_Dialogs(S_WYR_RefugeeCamp_FlamingFist_006_f0b8e3b7-3761-418a-a331-aae048c08ead, WYR_RefugeeCamp_FlamingFist_006_405945db-f5da-892f-4426-a2345d1ef18e);

DB_DialogMoneyTransfer(1, WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc, 500, 2); // Player (speaker 2) paying to the NPC (default speaker 1)

// Manip's states
DB_State_Priority(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "Guarding", 0);
DB_State_Priority(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "GainedAccess", 100);
DB_State_Priority(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "Alerted", 200);
DB_State_Priority(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "NearToysSpotting", 300);
DB_State_Priority(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "NearToysInvestigated", 400);
DB_State_Priority(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "InvestigatedPlayerLeft", 500);
DB_State_Priority(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "QuestResolved", 600);
DB_State_Priority(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "Defeated", 1000);

DB_State_Current(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "Guarding");

DB_DefeatedStateFlag(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,(FLAG)WYR_RefugeeCamp_FlamingFistManip_State_Defeated_78c7480e-4c5f-1eb7-3042-6adf1c2e382c);
//END_REGION

//REGION Crimes
DB_WYR_RefugeeCamp_FlamingFists_CrimeLeads((CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,(DIALOGRESOURCE)WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc);
DB_WYR_RefugeeCamp_FlamingFists_CrimeLeads(S_WYR_RefugeeCamp_FlamingFist_001_2e90c37b-78ca-4df5-9fdc-3a680e3fafc1, WYR_RefugeeCamp_FlamingFist_001_f21754e7-489b-4b50-899e-c98d3649e1df);
DB_WYR_RefugeeCamp_FlamingFists_CrimeLeads(S_WYR_RefugeeCamp_FlamingFist_002_e93bd361-c99d-454d-b6be-f998bf67056f, WYR_RefugeeCamp_FlamingFist_002_b2475a60-8205-fe71-d293-ba7729218819);
DB_WYR_RefugeeCamp_FlamingFists_CrimeLeads(S_WYR_RefugeeCamp_FlamingFist_003_5e55ec6a-496a-46c0-9a08-2755f4acb665, WYR_RefugeeCamp_FlamingFist_003_9f43c725-007b-ec69-6391-ab970203c234);
DB_WYR_RefugeeCamp_FlamingFists_CrimeLeads(S_WYR_RefugeeCamp_FlamingFist_005_ea3260b0-3e43-4742-ad3e-b570807bc802, WYR_RefugeeCamp_FlamingFist_005_71432b0d-45cc-3215-0306-680abba26ab1);
DB_WYR_RefugeeCamp_FlamingFists_CrimeLeads(S_WYR_RefugeeCamp_FlamingFist_006_f0b8e3b7-3761-418a-a331-aae048c08ead, WYR_RefugeeCamp_FlamingFist_006_405945db-f5da-892f-4426-a2345d1ef18e);

DB_WYR_RefugeeCamp_FlamingFists_CheckSilence((CHARACTER)S_WYR_RefugeeCamp_FlamingFist_005_ea3260b0-3e43-4742-ad3e-b570807bc802);
DB_WYR_RefugeeCamp_FlamingFists_CheckSilence(S_WYR_RefugeeCamp_FlamingFist_003_5e55ec6a-496a-46c0-9a08-2755f4acb665);
DB_WYR_RefugeeCamp_FlamingFists_CheckSilence(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);

DB_SpotPlayers(
	S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,
	"WYR_RefugeeCamp_ManipEntranceSpotting",
	NULL_00000000-0000-0000-0000-000000000000,
	NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(
	S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,
	"WYR_RefugeeCamp_ManipEntranceSpotting",
	S_WYR_RefugeeCamp_ManipEntranceSpotArea_0cfdc47c-bec3-4c11-ab5d-3c5fb5fcd9e7);

DB_TrespassTrigger(
	S_WYR_RefugeeCamp_BigBarnTrespassArea_4f20ae14-6a39-4e2b-a17d-0dd8ebf3d493,
	S_WYR_RefugeeCamp_BigBarnTrespassOutPos_d634c12f-2c7e-4497-a987-4b2b3581b6bb, 
	"WYR_RefugeeCamp_BigBarnTrespass",
	S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);

DB_ItemOwnerShipTriggers("BGO_Main_A",(TRIGGER)S_WYR_RefugeeCamp_BigBarn_SUB_488c46b0-045d-49e7-b76e-f86b0a94a630,(CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);
DB_ItemOwnerShipTriggersFallback((TRIGGER)S_WYR_RefugeeCamp_BigBarn_SUB_488c46b0-045d-49e7-b76e-f86b0a94a630,(CHARACTER)S_WYR_RefugeeCamp_FlamingFist_001_2e90c37b-78ca-4df5-9fdc-3a680e3fafc1);
DB_ItemOwnerShipTriggersFallback((TRIGGER)S_WYR_RefugeeCamp_BigBarn_SUB_488c46b0-045d-49e7-b76e-f86b0a94a630,(CHARACTER)S_WYR_RefugeeCamp_FlamingFist_002_e93bd361-c99d-454d-b6be-f998bf67056f);
DB_ItemOwnerShipTriggersFallback((TRIGGER)S_WYR_RefugeeCamp_BigBarn_SUB_488c46b0-045d-49e7-b76e-f86b0a94a630,(CHARACTER)S_WYR_RefugeeCamp_FlamingFist_003_5e55ec6a-496a-46c0-9a08-2755f4acb665);

PROC_TriggerRegisterForPlayers(S_WYR_RefugeeCamp_TrappedToysArea_5b631e39-bf37-45f2-bdfb-ed17200aa6ad);
//END_REGION

//REGION Misc
DB_Dialogs(S_WYR_RefugeeCamp_BarnPig_f35e27df-72a6-44ba-96d0-3f69b13ad580, WYR_RefugeeCamp_BarnPig_cb7a3a4c-01db-692e-e03b-bb91822d977c);

// Dark Urge
DB_HasItemTemplateScriptFlag(1, WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc, UNI_WYR_ExplosiveToy_e077ef28-5de9-439d-bbaf-59536585c938, 2, 1);
DB_FlagReactionAfterDialog((FLAG)WYR_RefugeeCamp_Event_DUTossToy_253b7ca4-f116-1860-3809-900f8d5b8009, (DIALOGRESOURCE)WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc);
//END_REGION
KBSECTION
//REGION Explosive toys interaction
// Entering trigger near the toys
IF
DB_InRegion(_Player, S_WYR_RefugeeCamp_TrappedToysArea_5b631e39-bf37-45f2-bdfb-ed17200aa6ad)
AND
DB_Players(_Player)
AND
NOT DB_CantTalk(_Player)
AND
IsDestroyed(S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3,0)
AND
IsTrapArmed(S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3,1)
AND
QRY_OncePerUserAndNearbyPlayers(_Player, "WYR_RefugeeCamp_NoticedToysVBPlay")
THEN
DB_NOOP(1);

IF
EntityEvent(S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3, "RevealFromStory")
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_FoundTrappedToys_c132806f-00ab-955d-9338-348663af1712);

IF
EntityEvent(S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3, "StoryReveal")
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_FoundTrappedToys_c132806f-00ab-955d-9338-348663af1712);

PROC
PROC_WYR_RefugeeCamp_ToysAleartGuards()
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_FoundTrappedToys_c132806f-00ab-955d-9338-348663af1712);

// Noise from the toys crate alerts the guards
IF
AutomatedDialogStarted(WYR_ExplosiveBearToy_AD_0808fc2e-bdd5-d37e-0b0b-47b3a16164dd,_InstanceID)
AND
DB_DialogNPCs(_InstanceID, S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3, _)
THEN
PROC_WYR_RefugeeCamp_ToysAleartGuards();

IF
DestroyingBy(S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3,_,_,_)
AND
NOT DB_WYR_RefugeeCamp_ToysCrateEmptied(1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_ToysExploded_2994074b-ac48-4702-a750-b56e69e940e0);
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_FoundTrappedToys_c132806f-00ab-955d-9338-348663af1712);
PROC_WYR_RefugeeCamp_ToysAleartGuards();

PROC
PROC_WYR_RefugeeCamp_ToysAleartGuards()
AND
NOT DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_ManipInvestigatedToys_f8dc3fc7-744f-575b-b0a4-b90beafb3a70)
AND
NOT DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_GuardsAlerted_2ef42687-4116-4ddb-96b1-dedb0c7c1704)
AND
HasActiveStatus(S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3, "SILENCED", 0)
AND
QRY_WYR_BigBarn_AnyGuardIsNotSilenced()
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_GuardsAlerted_2ef42687-4116-4ddb-96b1-dedb0c7c1704);

QRY
QRY_WYR_BigBarn_AnyGuardIsNotSilenced()
AND
DB_WYR_RefugeeCamp_FlamingFists_CheckSilence(_Character)
AND
NOT DB_Defeated(_Character)
AND
HasActiveStatus(_Character, "SILENCED", 0)
THEN
DB_NOOP(1);

// Crate transformation
IF 
TemplateRemovedFrom(UNI_WYR_ExplosiveToy_e077ef28-5de9-439d-bbaf-59536585c938, _, S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3)
AND
NOT DB_WYR_RefugeeCamp_ToysCrateEmptied(1)
AND
TemplateIsInInventory((ITEMROOT)UNI_WYR_ExplosiveToy_e077ef28-5de9-439d-bbaf-59536585c938, S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3,0)
THEN
DB_WYR_RefugeeCamp_ToysCrateEmptied(1);
SetEntityEvent(S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3, "WYR_RefugeeCamp_TrappedToysEmpty"); // to disable the trap script
Transform(S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3, CONT_GEN_Crate_Teddy_Explosive_A_Empty_29dcb091-043a-45b6-8bad-481c19488f9b, DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);

IF
DB_WYR_RefugeeCamp_ToysCrateEmptied(1)
THEN
PROC_GlobalSetFlagAndCache(WYR_RefugeeCamp_State_ToysCrateEmpty_3b0ede7f-35be-4c73-8cce-bfaaacf90320);
//END_REGION

//REGION Manip: Donations handling
// donating
IF
MovedFromTo(_Item, _Player, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, 1)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_WYR_BigBarn_OnItemDonated(_Player, (ITEM)_Item);
SetFlag((FLAG)WYR_RefugeeCamp_State_DonatedBarter_aa0c4f70-0fe4-2b3a-79c4-bea177826462, _Player, 0);

IF
MovedFromTo(_Item, _Player, S_WYR_RefugeeCamp_BigBarnDonationsChest_82bbab11-ef63-474c-a2a4-3968466dcd39, 0)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_WYR_BigBarn_OnItemDonated(_Player, (ITEM)_Item);

PROC
PROC_WYR_BigBarn_OnItemDonated((CHARACTER)_Player, (ITEM)_Item)
THEN
DB_NOOP(1);
//END_REGION

//REGION Manip: States
IF
FlagSet((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417,_,_)
THEN
PROC_State_Progress(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "GainedAccess");

PROC
PROC_State_Changed(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", _, _NewState)
AND
NOT DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_ManipInvestigatedToys_f8dc3fc7-744f-575b-b0a4-b90beafb3a70)
AND
DB_State_Priority(_,"WYR_FlamingFistManip", _NewState, _Priority)
AND
_Priority > 0
AND
NOT DB_CharacterInRegionFlag(
		S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,
		S_WYR_RefugeeCamp_ToysManipInvestigateArea_14528b29-f53c-4a7f-8dcc-b148f5eee5b7,
		WYR_RefugeeCamp_FlamingFistManip_State_NearToys_feb33d83-f430-ef2f-187d-36e8ad914052)
THEN
DB_CharacterInRegionFlag(
	(CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, 
	(TRIGGER)S_WYR_RefugeeCamp_ToysManipInvestigateArea_14528b29-f53c-4a7f-8dcc-b148f5eee5b7,
	(FLAG)WYR_RefugeeCamp_FlamingFistManip_State_NearToys_feb33d83-f430-ef2f-187d-36e8ad914052);

// Alert state after player touches the toys
IF
FlagSet((FLAG)WYR_RefugeeCamp_State_GuardsAlerted_2ef42687-4116-4ddb-96b1-dedb0c7c1704,_,_)
THEN
PROC_State_Progress(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "Alerted");

// Player found toys and manip near them - ready to investigate them (or whats left of them)
PROC
PROC_State_Changed(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", _OldState, _NewState)
AND
DB_CharacterInRegionFlag(
	S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, 
	S_WYR_RefugeeCamp_ToysManipInvestigateArea_14528b29-f53c-4a7f-8dcc-b148f5eee5b7, 
	WYR_RefugeeCamp_FlamingFistManip_State_NearToys_feb33d83-f430-ef2f-187d-36e8ad914052)
AND
DB_State_Priority(_,"WYR_FlamingFistManip", "GainedAccess", _GainedAccessPriority)
AND
DB_State_Priority(_,"WYR_FlamingFistManip",_OldState,_PriorityOld)
AND
_PriorityOld >= _GainedAccessPriority
AND
DB_State_Priority(_,"WYR_FlamingFistManip", "InvestigatedPlayerLeft", _NotNearToysPriority)
AND
DB_State_Priority(_,"WYR_FlamingFistManip", _NewState, _PriorityNew)
AND
_PriorityNew >= _NotNearToysPriority
THEN
NOT DB_CharacterInRegionFlag(
	(CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, 
	(TRIGGER)S_WYR_RefugeeCamp_ToysManipInvestigateArea_14528b29-f53c-4a7f-8dcc-b148f5eee5b7,
	(FLAG)WYR_RefugeeCamp_FlamingFistManip_State_NearToys_feb33d83-f430-ef2f-187d-36e8ad914052);

IF
FlagSet(WYR_RefugeeCamp_FlamingFistManip_State_NearToys_feb33d83-f430-ef2f-187d-36e8ad914052, _,_)
AND
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_FoundTrappedToys_c132806f-00ab-955d-9338-348663af1712)
THEN
PROC_State_Progress(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "NearToysSpotting");

IF
FlagSet((FLAG)WYR_RefugeeCamp_State_FoundTrappedToys_c132806f-00ab-955d-9338-348663af1712,_,_)
AND
GetFlag((FLAG)WYR_RefugeeCamp_FlamingFistManip_State_NearToys_feb33d83-f430-ef2f-187d-36e8ad914052, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, 1)
THEN
PROC_State_Progress(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "NearToysSpotting");

// adding auto-spotting for the case where player investigated the barn with the manip together
PROC
PROC_State_Changed(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", _, "NearToysSpotting")
AND
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417)
AND
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_ManipAgreedInvestigate_ae6869c2-8b25-6b6e-ed00-87ce770cf5fd)
THEN
DB_SpotPlayers(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_RefugeeCamp_ManipAlliedAtToysSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((FLAG)WYR_RefugeeCamp_State_ManipInvestigatedToys_f8dc3fc7-744f-575b-b0a4-b90beafb3a70,_,_)
THEN
PROC_SpotPlayers_StopSpotting("WYR_RefugeeCamp_ManipAlliedAtToysSpotting");

PROC
PROC_SpotPlayers_Spotted(_, "WYR_RefugeeCamp_ManipAlliedAtToysSpotting", _Player)
AND
QRY_StartDialog(WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, _Player)
THEN
DB_NOOP(1);

// After toys investigation
IF
FlagSet(WYR_RefugeeCamp_State_ManipInvestigatedToys_f8dc3fc7-744f-575b-b0a4-b90beafb3a70,_,_)
THEN
PROC_State_Progress(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "NearToysInvestigated");

IF
LeftTrigger(_Player, (TRIGGER)S_WYR_RefugeeCamp_BigBarn_SUB_488c46b0-045d-49e7-b76e-f86b0a94a630)
AND
DB_Players(_Player)
AND
NOT DB_InRegion(_, S_WYR_RefugeeCamp_TrappedToysArea_5b631e39-bf37-45f2-bdfb-ed17200aa6ad)
AND
DB_State_Current(_, "WYR_FlamingFistManip", "NearToysInvestigated")
THEN
PROC_State_Progress(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "InvestigatedPlayerLeft");

PROC
PROC_State_Changed(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", _, "InvestigatedPlayerLeft")
THEN
PROC_TriggerUnregisterForPlayers(S_WYR_RefugeeCamp_TrappedToysArea_5b631e39-bf37-45f2-bdfb-ed17200aa6ad);
PROC_GlobalSetFlagAndCache(WYR_RefugeeCamp_FlamingFistManip_State_OutsideAfterInvestigation_a4e1ef7a-9c22-42e6-bf29-e3d4a1431599);

// Resolved
IF
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_BigBarnSolved_9dc06a8d-c8d6-3086-615a-6b77d2cf3fdb)
AND
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_ManipInvestigatedToys_f8dc3fc7-744f-575b-b0a4-b90beafb3a70)
THEN
PROC_State_Progress(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "QuestResolved");

IF
FlagSet((FLAG)WYR_RefugeeCamp_FlamingFistManip_State_Defeated_78c7480e-4c5f-1eb7-3042-6adf1c2e382c,_,_)
THEN
PROC_State_Progress(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_FlamingFistManip", "Defeated");
//END_REGION

//REGION Manip: Interrogation after other Fist catches the player and teleports
IF
FlagSet((FLAG)WYR_RefugeeCamp_Event_ManipForceInterrogate_635db5a0-b2f4-7598-1ed9-380eb7688a1c, _, _Instance)
AND
DB_DialogPlayers(_Instance, _Player, _)
AND
NOT DB_WYR_RefugeeCamp_AwaitingInterrogation(_Player)
THEN
DB_WYR_RefugeeCamp_AwaitingInterrogation(_Player);

IF
FlagSet((FLAG)WYR_RefugeeCamp_Event_ManipForceInterrogate_635db5a0-b2f4-7598-1ed9-380eb7688a1c, _, _Instance)
THEN
PROC_RefugeeCamp_StartManipInterrogationSpotting();

PROC
PROC_RefugeeCamp_StartManipInterrogationSpotting()
THEN
PROC_SpotPlayers_StopSpotting(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,"WYR_RefugeeCamp_ManipEntranceSpotting");

PROC
PROC_RefugeeCamp_StartManipInterrogationSpotting()
AND
NOT DB_SpotPlayers(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_RefugeeCamp_ManipInterrogationSpotting",_,_)
AND
NOT QRY_SpotPlayers_IsSpotting(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_RefugeeCamp_ManipInterrogationSpotting")
THEN
DB_SpotPlayers(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_RefugeeCamp_ManipInterrogationSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_HasObjectFlag(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_RefugeeCamp_ManipInterrogationSpotting", WYR_RefugeeCamp_State_ManipInterrogationTarget_f46031eb-d5fc-45df-98d4-91496c081ad2, 1);

PROC
PROC_RefugeeCamp_StartManipInterrogationSpotting()
AND
DB_SpotPlayers(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_RefugeeCamp_ManipInterrogationSpotting", _,_)
AND
NOT QRY_SpotPlayers_IsSpotting(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_RefugeeCamp_ManipInterrogationSpotting")
THEN
PROC_SpotPlayers_RestartSpotting(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_RefugeeCamp_ManipInterrogationSpotting");

PROC
PROC_SpotPlayers_Spotted(_, "WYR_RefugeeCamp_ManipInterrogationSpotting", _Player)
AND
NOT QRY_StartDialog_Fixed(WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, _Player)
AND
CrimeGetNewID(_Id) // fallback to a crime if dialog didn't start
THEN
PROC_RefugeeCamp_StopManipInterrogation();
PROC_CharacterRegisterCrime(_Player, "WYR_RefugeeCamp_BigBarnTrespass", S_WYR_RefugeeCamp_BigBarnTrespassArea_4f20ae14-6a39-4e2b-a17d-0dd8ebf3d493, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, _Id);

IF
DialogEnded(WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc,_InstanceID)
THEN
PROC_RefugeeCamp_StopManipInterrogation();

IF
FlagSet((FLAG)WYR_RefugeeCamp_State_GuardsAlerted_2ef42687-4116-4ddb-96b1-dedb0c7c1704,_,_)
THEN
PROC_RefugeeCamp_StopManipInterrogation();

PROC
PROC_RefugeeCamp_StopManipInterrogation()
AND
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_Event_ManipForceInterrogate_635db5a0-b2f4-7598-1ed9-380eb7688a1c)
THEN
PROC_SpotPlayers_StopSpotting((CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,"WYR_RefugeeCamp_ManipInterrogation");
PROC_GlobalClearFlagAndCache((FLAG)WYR_RefugeeCamp_Event_ManipForceInterrogate_635db5a0-b2f4-7598-1ed9-380eb7688a1c);

PROC
PROC_RefugeeCamp_StopManipInterrogation()
AND
DB_WYR_RefugeeCamp_AwaitingInterrogation(_Player)
THEN
NOT DB_WYR_RefugeeCamp_AwaitingInterrogation(_Player);
ClearFlag((FLAG)WYR_RefugeeCamp_State_ManipInterrogationTarget_f46031eb-d5fc-45df-98d4-91496c081ad2, _Player);
ClearFlag((FLAG)WYR_RefugeeCamp_Event_BigBarnTrespassReact_787c870a-3e4c-2bde-ab0d-d54b14784012, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);

IF
DB_WYR_RefugeeCamp_AwaitingInterrogation(_Player)
THEN
SetFlag(WYR_RefugeeCamp_State_ManipInterrogationTarget_f46031eb-d5fc-45df-98d4-91496c081ad2, _Player);

// door opening
PROC
PROC_RefugeeCamp_StartManipInterrogationSpotting()
AND
IsInTrigger(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, (TRIGGER)S_WYR_RefugeeCamp_BigBarn_SUB_488c46b0-045d-49e7-b76e-f86b0a94a630, 0)
AND
NOT QRY_IsOpeneding(DOOR_Double_Medium_Village_Gate_A_000_f09cc7ba-e7ee-4f25-bf30-12bfc6bf9cbd)
AND
IsDestroyed(DOOR_Double_Medium_Village_Gate_A_000_f09cc7ba-e7ee-4f25-bf30-12bfc6bf9cbd, 0)
THEN
Open(DOOR_Double_Medium_Village_Gate_A_000_f09cc7ba-e7ee-4f25-bf30-12bfc6bf9cbd);
//END_REGION

//REGION Manip: Catching player on entrance
// Spotting on entrance
PROC
PROC_SpotPlayers_Spotted(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, "WYR_RefugeeCamp_ManipEntranceSpotting", _Player)
AND
NOT DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417)
AND
QRY_WYR_RefugeeCamp_SpottedPlayer_Prepare(_Player)
AND
NOT QRY_StartDialog_Fixed(WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, _Player)
THEN
ClearFlag(WYR_RefugeeCamp_Event_SpottedEnteringBarn_ec21acc6-0574-47b5-8871-c0dfaf3d9016,_Player,0);

QRY
QRY_WYR_RefugeeCamp_SpottedPlayer_Prepare((CHARACTER)_Player)
THEN
SetFlag(WYR_RefugeeCamp_Event_SpottedEnteringBarn_ec21acc6-0574-47b5-8871-c0dfaf3d9016,_Player,0);

IF
FlagSet((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417,_,_)
THEN
PROC_SpotPlayers_StopSpotting(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,"WYR_RefugeeCamp_ManipEntranceSpotting");

IF
FlagSet(WYR_RefugeeCamp_Event_ManipInterrogationEnded_e252f7c0-d3da-4350-826d-7b040601bb39,_,_)
THEN
PROC_SpotPlayers_StopSpotting(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,"WYR_RefugeeCamp_ManipEntranceSpotting");

IF
FlagSet((FLAG)WYR_RefugeeCamp_State_GuardsAlerted_2ef42687-4116-4ddb-96b1-dedb0c7c1704,_,_)
THEN
PROC_SpotPlayers_StopSpotting(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,"WYR_RefugeeCamp_ManipEntranceSpotting");
//END_REGION

//REGION Trespass crime inside
// Trespass crime custom dialog
QRY
QRY_CrimeGetCustomArrestDialogCustom(_Guard,_CrimeID,_,_Player,_,_,_)
AND
DB_WYR_RefugeeCamp_FlamingFists_CrimeLeads(_Guard, _CustomDialog)
AND
DB_Players(_Player)
AND
CrimeGetType(_CrimeID, "WYR_RefugeeCamp_BigBarnTrespass")
THEN
SetFlag((FLAG)WYR_RefugeeCamp_Event_BigBarnTrespassReact_787c870a-3e4c-2bde-ab0d-d54b14784012, _Guard, 0);
DB_CrimeArrest_CustomDialog(_Guard, _CrimeID, _CustomDialog);

PROC
PROC_DialogFlagSetup(_Dialog, _Guard, _Player)
AND
DB_WYR_RefugeeCamp_FlamingFists_CrimeLeads((CHARACTER)_Guard, _Dialog)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417)
AND
NOT DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_ManipAgreedInvestigate_ae6869c2-8b25-6b6e-ed00-87ce770cf5fd)
AND
NOT DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_ManipInvestigatedToys_f8dc3fc7-744f-575b-b0a4-b90beafb3a70)
AND
QRY_WYR_RefugeeCamp_CheckTrespassCrimeOngoing(_Player, _Guard)
THEN
SetFlag((FLAG)WYR_RefugeeCamp_Event_BigBarnTrespassReact_787c870a-3e4c-2bde-ab0d-d54b14784012, _Guard, 0);

QRY
QRY_WYR_RefugeeCamp_CheckTrespassCrimeOngoing((CHARACTER)_Player, (CHARACTER)_Guard)
AND
NOT DB_WYR_RefugeeCamp_IgnoreTrespassCrimeWhileTalking(_Player, _Guard)
AND
DB_PlayerTrespassing(_Player, _CrimeID, S_WYR_RefugeeCamp_BigBarnTrespassArea_4f20ae14-6a39-4e2b-a17d-0dd8ebf3d493)
AND
GetFlag(WYR_RefugeeCamp_Event_BigBarnTrespassReact_787c870a-3e4c-2bde-ab0d-d54b14784012, _Guard, 0)
AND
CrimeIgnoreCriminal(_CrimeID, (CHARACTER)_Player, 1)
THEN
DB_WYR_RefugeeCamp_IgnoreTrespassCrimeWhileTalking((CHARACTER)_Player, _Guard);

QRY
QRY_WYR_RefugeeCamp_CheckTrespassCrimeOngoing((CHARACTER)_Player, (CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75)
AND
DB_WYR_RefugeeCamp_AwaitingInterrogation(_Player)
THEN
DB_NOOP(1);

IF
OnCrimeConfrontationDone(_CrimeID,_Arrester,_,_,_,_,_)
AND
CrimeGetType(_CrimeID, "WYR_RefugeeCamp_BigBarnTrespass")
AND
DB_WYR_RefugeeCamp_FlamingFists_CrimeLeads(_Arrester,_)
AND
GetFlag((FLAG)WYR_RefugeeCamp_Event_BigBarnTrespassReact_787c870a-3e4c-2bde-ab0d-d54b14784012, _Arrester, 1)
THEN
ClearFlag((FLAG)WYR_RefugeeCamp_Event_BigBarnTrespassReact_787c870a-3e4c-2bde-ab0d-d54b14784012, _Arrester, 0);

IF
FlagCleared(WYR_RefugeeCamp_Event_BigBarnTrespassReact_787c870a-3e4c-2bde-ab0d-d54b14784012, _Arrester,_)
AND
DB_WYR_RefugeeCamp_IgnoreTrespassCrimeWhileTalking(_Player, (CHARACTER)_Arrester)
AND
DB_PlayerTrespassing(_Player, _CrimeID, S_WYR_RefugeeCamp_BigBarnTrespassArea_4f20ae14-6a39-4e2b-a17d-0dd8ebf3d493)
AND
CrimeStopIgnoringCriminal(_CrimeID, (CHARACTER)_Player, 1)
THEN
DB_NOOP(1);

IF
FlagCleared(WYR_RefugeeCamp_Event_BigBarnTrespassReact_787c870a-3e4c-2bde-ab0d-d54b14784012, _Arrester,_)
AND
DB_WYR_RefugeeCamp_IgnoreTrespassCrimeWhileTalking(_Player, (CHARACTER)_Arrester)
THEN
NOT DB_WYR_RefugeeCamp_IgnoreTrespassCrimeWhileTalking(_Player, _Arrester);

// Guards alerted: clearing player's access after they touched something they've shouldn't
IF
FlagSet((FLAG)WYR_RefugeeCamp_State_GuardsAlerted_2ef42687-4116-4ddb-96b1-dedb0c7c1704,_,_)
AND
NOT DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_ManipAgreedInvestigate_ae6869c2-8b25-6b6e-ed00-87ce770cf5fd)
THEN
PROC_GlobalClearFlagAndCache((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417);

IF
FlagSet((FLAG)WYR_RefugeeCamp_State_GuardsAlerted_2ef42687-4116-4ddb-96b1-dedb0c7c1704,_,_)
AND
NOT DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_ManipAgreedInvestigate_ae6869c2-8b25-6b6e-ed00-87ce770cf5fd)
THEN
PROC_WYR_RefugeeCamp_SwitchToInsideTrespass();

PROC
PROC_WYR_RefugeeCamp_SwitchToInsideTrespass()
AND
DB_TrespassTrigger(_TrespassTrigger, _OutPos, "WYR_RefugeeCamp_BigBarnTrespass", _Owner)
THEN
PROC_RemoveDBTrespassTrigger(_TrespassTrigger, _OutPos, _Owner);

PROC
PROC_WYR_RefugeeCamp_SwitchToInsideTrespass()
AND
NOT DB_PermaDefeated(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75)
THEN
DB_TrespassTrigger(
	S_WYR_RefugeeCamp_BigBarnTrespassArea_4f20ae14-6a39-4e2b-a17d-0dd8ebf3d493,
	S_WYR_RefugeeCamp_BigBarnTrespassOutPos_Inside_aaeee370-87b7-4fe5-82b2-40263fbfdbef, 
	"WYR_RefugeeCamp_BigBarnTrespass",
	S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);

PROC
PROC_WYR_RefugeeCamp_SwitchToInsideTrespass()
AND
DB_PermaDefeated(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75)
THEN
DB_TrespassTrigger(
	S_WYR_RefugeeCamp_BigBarnTrespassArea_4f20ae14-6a39-4e2b-a17d-0dd8ebf3d493,
	S_WYR_RefugeeCamp_BigBarnTrespassOutPos_Inside_aaeee370-87b7-4fe5-82b2-40263fbfdbef, 
	"WYR_RefugeeCamp_BigBarnTrespass");

// stopping keeping an eye out after gaining access
IF
FlagSet((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417,_,_)
AND
DB_TrespassTrigger(_TrespassTrigger, _OutPos, "WYR_RefugeeCamp_BigBarnTrespass", _Owner)
THEN
PROC_RemoveDBTrespassTrigger(_TrespassTrigger, _OutPos, _Owner);

IF
FlagSet((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417,_,_)
THEN
PROC_CRIME_KeepingAnEyeOut_Stop(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);

QRY
QRY_CRIME_KeepingAnEyeOut_Block((CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, _ID)
AND
DB_GlobalFlag(WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417)
AND
CrimeGetType(_ID, "WYR_RefugeeCamp_BigBarnTrespass")
THEN
DB_NOOP(1);
//END_REGION

//REGION Manip: Toys interrogation
IF
FlagSet(WYR_RefugeeCamp_Event_ManipInterrogationStarted_2b499b63-362f-40e3-903a-d57a66aff571, _Player, _)
AND
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_GuardsAlerted_2ef42687-4116-4ddb-96b1-dedb0c7c1704)
AND
IsInTrigger(_Player, S_WYR_RefugeeCamp_ToysManipInvestigateArea_14528b29-f53c-4a7f-8dcc-b148f5eee5b7, 1)
THEN
PROC_CharacterMoveTo((CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, S_WYR_RefugeeCamp_FlamingFistManip_ToysPos_0c7c5c94-fb33-403a-a07d-3828f2b109ed, "Run", "");

// if investigated, it should disable the crime once again
IF
FlagSet((FLAG)WYR_RefugeeCamp_State_ManipInvestigatedToys_f8dc3fc7-744f-575b-b0a4-b90beafb3a70,_,_)
AND
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417)
AND
NOT DB_PermaDefeated(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75)
AND
DB_TrespassTrigger(_TrespassTrigger, _OutPos, "WYR_RefugeeCamp_BigBarnTrespass", _Owner)
THEN
PROC_RemoveDBTrespassTrigger(_TrespassTrigger, _OutPos, _Owner);

IF
FlagSet((FLAG)WYR_RefugeeCamp_State_ManipInvestigatedToys_f8dc3fc7-744f-575b-b0a4-b90beafb3a70,_,_)
AND
DB_GlobalFlag((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417)
THEN
PROC_CRIME_KeepingAnEyeOut_Stop(S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);

// Crime interrogation was interrupted 
IF
DialogEnded(WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc,_InstanceID)
AND
DB_DialogPlayers(_InstanceID,_Player,_)
AND
GetFlag((FLAG)WYR_RefugeeCamp_Event_ManipInterrogationStarted_2b499b63-362f-40e3-903a-d57a66aff571,_Player,1)
AND
GetFlag((FLAG)WYR_RefugeeCamp_Event_ManipInterrogationEnded_e252f7c0-d3da-4350-826d-7b040601bb39,_Player,0)
THEN
PROC_SetRelationTemporaryHostile((CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75,(CHARACTER)_Player);

IF
DialogEnded(WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc,_InstanceID)
AND
DB_DialogPlayers(_InstanceID,_Player,_)
AND
GetFlag(WYR_RefugeeCamp_Event_ManipInterrogationEnded_e252f7c0-d3da-4350-826d-7b040601bb39,_Player,1)
THEN
ClearFlag((FLAG)WYR_RefugeeCamp_Event_ManipInterrogationEnded_e252f7c0-d3da-4350-826d-7b040601bb39,_Player,_InstanceID);

IF
DialogEnded(WYR_RefugeeCamp_FlamingFistManip_b49f7f31-263c-a50f-3745-5948f7345dfc,_InstanceID)
AND
DB_DialogPlayers(_InstanceID,_Player,_)
AND
GetFlag(WYR_RefugeeCamp_Event_ManipInterrogationStarted_2b499b63-362f-40e3-903a-d57a66aff571,_Player,1)
THEN
ClearFlag((FLAG)WYR_RefugeeCamp_Event_ManipInterrogationStarted_2b499b63-362f-40e3-903a-d57a66aff571,_Player,_InstanceID);

// Ownership
IF
FlagSet((FLAG)WYR_RefugeeCamp_State_ManipAgreedInvestigate_ae6869c2-8b25-6b6e-ed00-87ce770cf5fd,_,_)
THEN
TriggerClearItemsOwner(S_WYR_RefugeeCamp_BigBarn_SUB_488c46b0-045d-49e7-b76e-f86b0a94a630);
SetOwner(S_WYR_RefugeeCamp_BigBarnDonationsChest_82bbab11-ef63-474c-a2a4-3968466dcd39, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);

// Blocking toy-related crimes - it's not the guards' trap, even thoug they "own" the crate with the toys (and we have trespassing crime for that anyway)
QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_Criminal, (STRING)_Crime, (ITEM)S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3,_,_)
AND
DB_CRIME_ForbiddenItemType(_,_,_Crime)
THEN
DB_NOOP(1);

QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_Criminal, _CrimeType, (ITEM)S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3,_,_)
AND
QRY_CRIME_IsCrimeFamilyMember(_CrimeType, "Vandalise")
THEN
DB_NOOP(1);
//END_REGION

//REGION Turning perma-hostile
IF
KilledBy((CHARACTER)S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, _Player, _,_)
AND
DB_PartyMembers((CHARACTER)_Player)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_WYR_RefugeeCamp_FlamingFists_811059d2-54d0-41f4-9e2c-c047670943d9, 0);
//END_REGION

//REGION Dark Urge
IF
FlagSet(WYR_RefugeeCamp_Event_ManipInterrogationStarted_2b499b63-362f-40e3-903a-d57a66aff571, _Player, _)
THEN
DB_CharacterInRegionFlag((CHARACTER)_Player, (TRIGGER)S_WYR_RefugeeCamp_PlayerNearToysArea_73f09903-5ee1-43f6-aaa5-8d19667ad096, (FLAG)WYR_RefugeeCamp_State_PlayerNearToys_b5871704-2563-43ec-8d5b-9c6bf3162a66);

IF
FlagCleared(WYR_RefugeeCamp_Event_ManipInterrogationStarted_2b499b63-362f-40e3-903a-d57a66aff571, _Player, _)
THEN
NOT DB_CharacterInRegionFlag((CHARACTER)_Player, (TRIGGER)S_WYR_RefugeeCamp_PlayerNearToysArea_73f09903-5ee1-43f6-aaa5-8d19667ad096, (FLAG)WYR_RefugeeCamp_State_PlayerNearToys_b5871704-2563-43ec-8d5b-9c6bf3162a66);

PROC
PROC_FlagReactionAfterDialog(_Player, (FLAG)WYR_RefugeeCamp_Event_DUTossToy_253b7ca4-f116-1860-3809-900f8d5b8009)
THEN
PROC_WYR_RefugeeCamp_DUThrows((CHARACTER)_Player);

PROC
PROC_WYR_RefugeeCamp_DUThrows((CHARACTER)_Player)
AND
NOT DB_WYR_RefugeeCamp_ToysCrateEmptied(1)
AND
TemplateIsInInventory(UNI_WYR_ExplosiveToy_e077ef28-5de9-439d-bbaf-59536585c938, _Player, 0)
AND
GetItemByTemplateInInventory(UNI_WYR_ExplosiveToy_e077ef28-5de9-439d-bbaf-59536585c938, S_WYR_RefugeeCamp_ToysCrate_94a76661-93eb-4f7f-9e33-bcd987cb72e3, _Toy)
THEN
ToInventory((ITEM)_Toy, _Player, 1, 0, 1);
DB_WYR_RefugeeCamp_DUWantsToThrow((CHARACTER)_Player, (ITEM)_Toy);

PROC
PROC_WYR_RefugeeCamp_DUThrows((CHARACTER)_Player)
AND
GetFlag(WYR_RefugeeCamp_Event_DUTossToy_253b7ca4-f116-1860-3809-900f8d5b8009, _Player, 1)
AND
GetItemByTemplateInInventory(UNI_WYR_ExplosiveToy_e077ef28-5de9-439d-bbaf-59536585c938, _Player, _Toy)
AND
GetDistanceTo(_Player, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, _Dist)
AND
_Dist < 20.0
THEN
ClearFlag(WYR_RefugeeCamp_Event_DUTossToy_253b7ca4-f116-1860-3809-900f8d5b8009, _Player, 0);
UseSpell(_Player, "Throw_Throw", S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75, _Toy);

PROC
PROC_WYR_RefugeeCamp_DUThrows((CHARACTER)_Player)
AND
NOT DB_WYR_RefugeeCamp_DUWantsToThrow(_,_)
THEN
RealtimeObjectTimerLaunch(_Player, "WYR_RefugeeCamp_HostileAfterDUThrow_Timer", 1900);

IF
ObjectTimerFinished((CHARACTER)_Player, "WYR_RefugeeCamp_HostileAfterDUThrow_Timer")
THEN
PROC_SetRelationTemporaryHostile(_Player, S_WYR_RefugeeCamp_FlamingFistManip_c5ed5400-53e6-4201-813c-d4b107be7a75);

IF
AddedTo(_Toy, _Player, _)
AND
DB_WYR_RefugeeCamp_DUWantsToThrow((CHARACTER)_Player, (ITEM)_Toy)
THEN
NOT DB_WYR_RefugeeCamp_DUWantsToThrow((CHARACTER)_Player, (ITEM)_Toy);
PROC_WYR_RefugeeCamp_DUThrows(_Player);
//END_REGION

//REGION Debug
IF
TextEvent("WYR_BigBarn_FoundToys_Alone")
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_FoundTrappedToys_c132806f-00ab-955d-9338-348663af1712);

IF
TextEvent("WYR_BigBarn_FoundToys_AfterBasement")
THEN
PROC_WYR_MerchantsHouse_DebugKnowsBasement();
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417);
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_FoundTrappedToys_c132806f-00ab-955d-9338-348663af1712);

IF
TextEvent("WYR_BigBarn_FoundToys_ManipInvestigates")
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_FoundTrappedToys_c132806f-00ab-955d-9338-348663af1712);
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_BigBarnGainedAccess_fa205e14-8af0-4f11-056f-5dd467a12417);
PROC_GlobalSetFlagAndCache((FLAG)WYR_RefugeeCamp_State_ManipAgreedInvestigate_ae6869c2-8b25-6b6e-ed00-87ce770cf5fd);
//END_REGION Debug

//REGION GUSX-9791 Patch
// The issue is systemic, but I can make it a bit nicer for the players in this case
QRY
QRY_CRIME_BlockRegisterCrime(_Char, "WYR_RefugeeCamp_BigBarnTrespass", _,_,_,_)
AND
DB_PlayerSummons(_Char)
AND
DB_GlobalFlag(WYR_RefugeeCamp_State_GuardsAlerted_2ef42687-4116-4ddb-96b1-dedb0c7c1704)
THEN
DB_NOOP(1);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3"
