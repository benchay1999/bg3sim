Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Dialogs((CHARACTER)S_WYR_OpenHand_PriestNovice_e4c0f221-c692-4a02-9125-1ab35ed7eb61, (DIALOGRESOURCE)WYR_OpenHand_PriestNovice_f8f1a46a-cdde-9f0b-6a2c-d33451c678ba);
DB_Dialogs((CHARACTER)S_WYR_OpenHand_ArguingPriest_001_5f71634a-6ed0-4f68-933e-a4ef9b79d620, (DIALOGRESOURCE)WYR_OpenHand_ArguingPriest_001_b8084d24-718b-e56d-a2f3-cbece8dbda01);
DB_Dialogs((CHARACTER)S_WYR_OpenHand_ArguingPriest_002_888f7b75-bae2-487b-a631-aad7be93a29b, (DIALOGRESOURCE)WYR_OpenHand_ArguingPriest_002_7cdc7066-4cdb-9bd9-e260-acb380ddcfed);
DB_Dialogs((CHARACTER)S_WYR_OpenHand_Yannis_cb5ad2e6-40e9-4377-9669-1c4e4b1106e0, (DIALOGRESOURCE)WYR_OpenHand_Yannis_3d592559-36c0-2eaf-4abc-114171ba7a66);
DB_Dialogs((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58, (DIALOGRESOURCE)WYR_OpenHand_HollyphantDetective_249490a4-775f-77d2-24cd-65a92af08e19);
DB_Dialogs((CHARACTER)S_WYR_OpenHand_Donnick_9aa8c488-10a6-4b7e-b076-0421785876dc, (DIALOGRESOURCE)WYR_OpenHand_Donnick_602b1610-52d5-6ff6-15ad-240aca1f38ff);
DB_Dialogs((CHARACTER)S_WYR_OpenHand_Rose_b5cb45e5-4bd0-4744-b8d0-e363455a63e8, (DIALOGRESOURCE)WYR_OpenHand_Rose_5e2fae61-cc7c-a6db-ecad-f1f16aab044d);

DB_ItemDialog_NarratorAD((ITEM)S_WYR_OpenHand_TemplePlaque_34816857-219d-490d-88a4-63c98aac8d89, (DIALOGRESOURCE)WYR_OpenHand_AD_TemplePlaque_d6dfe8c5-7a58-d5ca-0ab0-0f627e49fdee);

Use((CHARACTER)S_WYR_OpenHand_Lorgan_75fd6462-4d79-4d36-8fdc-fbdd124f5722, (ITEM)S_WYR_OpenHand_LorgansBed_70bad76a-a519-4208-8d18-96286ceca19f, 1, 0, "WYR_OpenHand_LorganUsedBed");
DB_GLO_CharacterCorpseDialog((CHARACTER)S_WYR_OpenHand_Lorgan_75fd6462-4d79-4d36-8fdc-fbdd124f5722, (DIALOGRESOURCE)WYR_OpenHand_FatherLorgan_Dead_750d93e9-4f7c-4d53-5553-00327e732131);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_WYR_OpenHand_Shifter_001_fa27a169-32ba-4cf2-a400-e0874056c572, (DIALOGRESOURCE)WYR_OpenHand_Shifter_001_Dead_bed97f13-be81-2421-e92a-ef8c84dd7d7b);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_WYR_OpenHand_DeadTieflingRefugee_1fcbfb7e-931a-4297-8c28-8b8c6d703207, (DIALOGRESOURCE)WYR_OpenHand_Refugee_Dead_9801f591-f695-3a7f-0431-d870749b30a6);

DB_WYR_OpenHand_Buttons((ITEM)S_WYR_OpenHand_CellarButton_001_1fd64a84-c26c-4253-9655-945926ee2790, (ITEM)S_WYR_OpenHand_CellarHeraldicStone_001_167e66fd-dcf6-4216-9101-91612310be83, (TRIGGER)S_WYR_OpenHand_CellarHeraldicStone_001_MovedPos_d563425c-e64e-4f40-aeef-c3e24f9df820);
DB_WYR_OpenHand_Buttons((ITEM)S_WYR_OpenHand_CellarButton_002_dd737483-a3bf-42c4-9634-7ad18c69712f, (ITEM)S_WYR_OpenHand_CellarHeraldicStone_002_06a63e75-dfa3-4be1-a78e-a12675694734, (TRIGGER)S_WYR_OpenHand_CellarHeraldicStone_002_MovedPos_5bdc3069-c9d4-4dd4-8325-a9251f5b760d);

DB_SpotPlayers((CHARACTER)S_WYR_OpenHand_Shifter_001_fa27a169-32ba-4cf2-a400-e0874056c572, "WYR_OpenHand_Shifters", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers((CHARACTER)S_WYR_OpenHand_Shifter_002_076ff51e-5710-409e-b1d3-a4b0dcec1e4f, "WYR_OpenHand_Shifters", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers((CHARACTER)S_WYR_OpenHand_Shifter_003_83bbacf9-5395-4420-b5de-5a112d598840, "WYR_OpenHand_Shifters", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

DB_HasItemEvent(S_WYR_OpenHand_Dagger_Bleed_b255824c-d3f6-4fd4-93f0-901a699a4b44, WYR_OpenHand_State_HasDagger_a1a8df94-4145-4ad1-a7a3-c01cdb3c4094);
DB_GiveItemToEvent(S_WYR_OpenHand_Dagger_Bleed_b255824c-d3f6-4fd4-93f0-901a699a4b44, WYR_OpenHand_Event_GiveDagger_bf2956e8-d7d1-45f6-999e-a7cb6bedc559);

//Lorgan's Diary
DB_BookFlags(S_WYR_OpenHand_LorgansDiary_eb5a34ae-57a6-4071-952e-723f8e8e60e6,WYR_OpenHand_Knows_LorgansHiddenActivity_6c7c201d-372a-427d-ad81-e1b650108255);

DB_GLO_DefeatCounter((CHARACTER)S_WYR_OpenHand_Shifter_001_fa27a169-32ba-4cf2-a400-e0874056c572, "WYR_OpenHand_Shifters");
DB_GLO_DefeatCounter((CHARACTER)S_WYR_OpenHand_Shifter_002_076ff51e-5710-409e-b1d3-a4b0dcec1e4f, "WYR_OpenHand_Shifters");
DB_GLO_DefeatCounter((CHARACTER)S_WYR_OpenHand_Shifter_003_83bbacf9-5395-4420-b5de-5a112d598840, "WYR_OpenHand_Shifters");
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("WYR_OpenHand_Shifters", (FLAG)WYR_OpenHand_State_AllShiftersDefeated_ee310dff-06aa-4636-a33e-2650c3b2cb18);

DB_HasItemEvent((ITEM)S_WYR_OpenHand_ShiftersFlowerKey_8ab130ef-4fad-4bfe-b667-f4a73c1c36c0, (FLAG)WYR_OpenHand_State_HasBloodiedFlowerKey_0733d1e9-dc81-46dd-9626-6d1a8eaa7d7d);

DB_OneShotPlayerTrigger(S_WYR_OpenHand_MainHall_60ee9baa-8d57-4ce7-a45b-d74c6093deb2);

DB_GLO_CompoundFlag(WYR_OpenHand_Knows_KillersDescription_df386ffb-0403-5c5a-158b-25e1b1ae4387, (FLAG)WYR_SerialKiller_State_FoundClue_afaa501d-7c42-4fa1-8811-bee0c75cb7c1);
DB_GLO_CompoundFlag(WYR_OpenHand_Knows_KillersName_ce8dca23-7b94-4b18-81ef-ff40ca3d9bed, (FLAG)WYR_SerialKiller_State_FoundClue_afaa501d-7c42-4fa1-8811-bee0c75cb7c1);
DB_GLO_CompoundFlag(WYR_OpenHand_Knows_KillerIsBhaalist_985a3fc7-e3ea-4227-9d36-45e3be45347d, (FLAG)WYR_SerialKiller_State_FoundClue_afaa501d-7c42-4fa1-8811-bee0c75cb7c1);
DB_GLO_CompoundFlag(WYR_OpenHand_State_AllShiftersDefeated_ee310dff-06aa-4636-a33e-2650c3b2cb18, (FLAG)WYR_SerialKiller_State_FoundClue_afaa501d-7c42-4fa1-8811-bee0c75cb7c1);
DB_GLO_CompoundFlag(WYR_Flophouse_State_FoundMother_db3f08a3-0365-498f-a12d-6d39feb6e1aa, (FLAG)WYR_SerialKiller_State_FoundClue_afaa501d-7c42-4fa1-8811-bee0c75cb7c1);
DB_GLO_CompoundFlag(WYR_Flophouse_Knows_NextTarget_9a9654a9-6fd8-4ff0-bbb9-0bfe4bce8484, (FLAG)WYR_SerialKiller_State_FoundClue_afaa501d-7c42-4fa1-8811-bee0c75cb7c1);
DB_GLO_CompoundFlag((FLAG)WYR_SerialKiller_State_ValeriaSendToDevella_65f1a97d-1656-da36-6417-be1e44a87663, (FLAG)WYR_OpenHand_State_TempleOpenForRefugees_2d32e661-ee87-4d20-b4de-2e6510c76683);

DB_OneShot_VoiceBarkTrigger((TRIGGER)S_WYR_OpenHand_MassacreArea_6a2aba54-6b6c-4b2e-b3fc-29ad73bff2cb, WYR_OpenHand_VB_Massacre_61d7a623-0b96-0072-a4d6-41e86aa3c76d);

DB_FlagReactionAfterDialog((FLAG)WYR_OpenHand_Event_GivePass_dad981b8-d856-485e-9b7f-bf4c74aa77ab, (DIALOGRESOURCE)WYR_SharessCaress_HollyphantDetective_710444e8-5786-08e5-a1b3-2d2c2a1b88b5);
DB_HasItemEvent(S_WYR_OpenHand_LowerCityPass_350eba29-7233-42df-be7b-0a0bd375c745, (FLAG)WYR_OpenHand_State_HasLowerCityPass_413c9079-d47d-43b7-9328-9124d5994527);
DB_GiveItemToEvent(S_WYR_OpenHand_LowerCityPass_350eba29-7233-42df-be7b-0a0bd375c745, (FLAG)WYR_OpenHand_Event_GiveLowerCityPass_dad981b8-d856-485e-9b7f-bf4c74aa77ab);

//REGION Ownership
DB_ItemOwnerShipTriggers("BGO_Main_A", (TRIGGER)S_WYR_OpenHand_OwnershipTrigger_MainHall_bce0ef1e-951b-45b4-8241-19d2982fe4ac, (CHARACTER)S_WYR_OpenHand_Yannis_cb5ad2e6-40e9-4377-9669-1c4e4b1106e0);
DB_ItemOwnerShipTriggers("BGO_Main_A", (TRIGGER)S_WYR_OpenHand_OwnershipTrigger_Barracks_ae88add6-f253-4007-b91b-d43fac5eff7c, (CHARACTER)S_WYR_OpenHand_Rose_b5cb45e5-4bd0-4744-b8d0-e363455a63e8);
DB_ItemOwnerShipTriggers("BGO_Main_A", (TRIGGER)S_WYR_OpenHand_OwnershipTrigger_Kitchen_3831ff52-0d83-4500-a296-27b981d46b69, (CHARACTER)S_WYR_OpenHand_Donnick_9aa8c488-10a6-4b7e-b076-0421785876dc);
DB_ItemOwnerShipTriggers("BGO_Main_A", (TRIGGER)S_WYR_OpenHand_OwnershipTrigger_Bedroom_4e450b31-4234-450a-8ba5-40a4b4593fd5, (CHARACTER)S_WYR_OpenHand_Donnick_9aa8c488-10a6-4b7e-b076-0421785876dc);
DB_ItemOwnerShipTriggers("BGO_Main_A", (TRIGGER)S_WYR_OpenHand_OwnershipTrigger_Fireplace_f17e8137-d471-4afc-bb74-8e66ad27e746, (CHARACTER)S_WYR_OpenHand_Donnick_9aa8c488-10a6-4b7e-b076-0421785876dc);

// hatch, doors
DB_ItemOwnerShipClearItem("BGO_Main_A", (ITEM)S_WYR_OpenHand_BasementHatch_881db4ec-731d-4dd1-b140-1610d6fd5b74);
DB_ItemOwnerShipClearItem("BGO_Main_A", (ITEM)S_WYR_OpenHand_DoorOutside_001_6ec81b02-2aeb-432d-b245-74989bab6bd4);
DB_ItemOwnerShipClearItem("BGO_Main_A", (ITEM)S_WYR_OpenHand_DoorOutside_002_84b23e69-3947-4dca-9363-81d0c3d736e2);
DB_ItemOwnerShipClearItem("BGO_Main_A", (ITEM)S_WYR_OpenHand_DoorOutside_003_7b93e339-288c-4629-a6a7-59d51d57abcd);
DB_ItemOwnerShipClearItem("BGO_Main_A", (ITEM)S_WYR_OpenHand_DoorOutside_004_352c9767-cd8e-4ee0-9d78-3812984b139e);
DB_ItemOwnerShipClearItem("BGO_Main_A", (ITEM)S_WYR_OpenHand_DoorOutside_005_130fb178-cc70-429e-8b66-d5a80c609da9);
DB_ItemOwnerShipClearItem("BGO_Main_A", (ITEM)S_WYR_OpenHand_DoorToBarracks_77fabadd-50f4-4f1d-9f4d-26ec8054622c);
DB_ItemOwnerShipClearItem("BGO_Main_A", (ITEM)S_WYR_OpenHand_DoorToKitchen_01939ba5-830d-4d14-893f-6e6297c09cfe);
DB_ItemOwnerShipClearItem("BGO_Main_A", (ITEM)S_WYR_OpenHand_DoorToPriestsCells_2fb0e983-3028-4132-97c6-b245f85302bc);
//END_REGION

//REGION Journal DBs
DB_QuestDef_State((FLAG)WYR_OpenHand_Knows_LorganHandCut_c8455535-778b-4cd7-b0e4-7446815b3c28, "WYR_OpenHandMurder", "LorganNoHand");
DB_QuestDef_State((FLAG)WYR_OpenHand_Knows_DaggerIsCursed_f8474716-265b-42ed-85ab-55c0fb017d96, "WYR_OpenHandMurder", "LorganPoisoned");
DB_QuestDef_State((FLAG)WYR_OpenHand_Knows_KillersDescription_df386ffb-0403-5c5a-158b-25e1b1ae4387, "WYR_OpenHandMurder", "BrilgorDidntDoIt");
DB_QuestDef_State((FLAG)WYR_OpenHand_Knows_LorgansHiddenActivity_6c7c201d-372a-427d-ad81-e1b650108255, "WYR_OpenHandMurder", "LorganHidesRefugees");
DB_QuestDef_State((FLAG)WYR_OpenHand_Knows_RefugeeCorpseOutside_d48dcebf-8426-460e-e99d-69ec640b34b9, "WYR_OpenHandMurder", "FindBrilgorBody");
DB_QuestDef_State((FLAG)WYR_OpenHand_State_BrilgorToldPlayersWhereDie_25d88635-f068-f385-e66a-23406e2ad75b, "WYR_OpenHandMurder", "BrilgorKilledTunnels");
DB_QuestDef_State((FLAG)WYR_OpenHand_State_LorganTellPlayersWhereDied_82806445-ffc7-2e85-5142-9560496de736, "WYR_OpenHandMurder", "LorganKilledTunnels");
DB_QuestDef_State((FLAG)WYR_OpenHand_State_DonnikToldPlayersCellar_1376529a-0c5c-688c-986a-0bb6b32121c0, "WYR_OpenHandMurder", "FindChappelUnderground");
DB_QuestDef_State((FLAG)WYR_OpenHand_State_PlayersOpenSecretDoor_cf74c6de-4c14-4fd3-a944-0d27c68996f8, "WYR_OpenHandMurder", "EnterCaves");

//Dagger journal databases
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "DaggerFound", 1);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "DolorIsKiller", 1);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "DolorKillerNotBrilgor", 1);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "EnterCaves", 1);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Key", "FindKeyOrigin", 2);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Key", "DaggerFoundAfterKey", 2);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseKey", 3);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseFlophouse", 3);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseDoppelganger", 3);
DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseAlradyEnterLair", 3);

DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps("WYR_OpenHandMurder_InvestigateCrimeScene", "TalkedValeria_OnlyDagger");
DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps("WYR_OpenHandMurder_Key", "TalkedValeriaDagger_KeyFound");
DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps("WYR_OpenHandMurder_Flophouse", "TalkerValeriaDagger_Flophouse");

DB_WYR_OpenHand_DaggerObjectiveDatabase_CurrentObjective("Base", "Base", 0);
//END_REGION Journal DBs

//REGION PADs about Murder Tableux
DB_GEN_SerialKiller_TableuxPADs((CHARACTER)S_WYR_OpenHand_FakeIllasera_fb1b68cf-52f1-46ce-8328-d7db26c7fbf3, (FLAG)WYR_SerialKiller_Event_SawIllaseraTableu_1d5a614b-d713-46d5-8a34-e1af8587d6af, "WYR_FakeIllasera", (TRIGGER)S_WYR_OpenHand_FakeIllasera_Area_1500e2e7-98c0-457a-af17-246899f11987);
//END_REGION
DB_BookFlags((ITEM)S_WYR_OpenHand_LorgansDiary_eb5a34ae-57a6-4071-952e-723f8e8e60e6, (FLAG)WYR_OpenHand_Knows_HowToOpenSecretTunnels_74184bb0-edd1-73a0-3d63-fe07b78c9e4b);

// we need to move the corpse into a coffin
Die(S_WYR_OpenHand_DeadTieflingRefugee_1fcbfb7e-931a-4297-8c28-8b8c6d703207, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 1.0);

//REGION Cave entrance
DB_WYR_OpenHandCave_EntranceBoulders((ITEM)S_WYR_OpenHandCave_EntranceBoulder_004_f3d9edb8-a10a-43c2-a274-af7c9ba94ead);
DB_WYR_OpenHandCave_EntranceBoulders((ITEM)S_WYR_OpenHandCave_EntranceBoulder_01_88f670bc-92c4-4754-854a-0d6fdf0e7b96);
DB_WYR_OpenHandCave_EntranceBoulders((ITEM)S_WYR_OpenHandCave_EntranceBoulder_02_00da9a74-38d0-4811-9e81-ebcb6170d4ba);
//END_REGION 
KBSECTION
//REGION Init
IF
EntityEvent(S_WYR_OpenHand_Lorgan_75fd6462-4d79-4d36-8fdc-fbdd124f5722, "WYR_OpenHand_LorganUsedBed")
THEN
Die(S_WYR_OpenHand_Lorgan_75fd6462-4d79-4d36-8fdc-fbdd124f5722, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 1.0);

IF
Died((CHARACTER)S_WYR_OpenHand_DeadTieflingRefugee_1fcbfb7e-931a-4297-8c28-8b8c6d703207)
THEN
ToInventory(S_WYR_OpenHand_DeadTieflingRefugee_1fcbfb7e-931a-4297-8c28-8b8c6d703207, S_WYR_OpenHand_Coffin_e59d538e-baf3-4c32-9678-94847e08e08e, 1, 0, 0);
//END_REGION Init

//REGION Main Hall
PROC
PROC_OneShotTriggerEntered(_Player, (TRIGGER)S_WYR_OpenHand_MainHall_60ee9baa-8d57-4ce7-a45b-d74c6093deb2)
THEN
SetFlag((FLAG)WYR_Flophouse_State_VisitedOpenHandTemple_31db52cb-16d9-49cc-92f0-67dacb0295c1, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_WYR_OpenHand_ArguingPriest_001_5f71634a-6ed0-4f68-933e-a4ef9b79d620, _Player)
AND
NOT DB_GlobalFlag((FLAG)WYR_OpenHand_State_SolvedCase_20129d02-67f4-4231-acce-2ef1e984ea8d)
AND
NOT DB_WYR_OpenHand_ArguingPriestGroupDialogHappened(1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_WYR_OpenHand_ArguingPriest_002_888f7b75-bae2-487b-a631-aad7be93a29b, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)WYR_OpenHand_ArguingPriests_a1d142ac-de2d-6fc6-5f57-811d5f059e6e,
	S_WYR_OpenHand_ArguingPriest_001_5f71634a-6ed0-4f68-933e-a4ef9b79d620,
	S_WYR_OpenHand_ArguingPriest_002_888f7b75-bae2-487b-a631-aad7be93a29b,
	_Player);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_WYR_OpenHand_ArguingPriest_002_888f7b75-bae2-487b-a631-aad7be93a29b, _Player)
AND
NOT DB_GlobalFlag((FLAG)WYR_OpenHand_State_SolvedCase_20129d02-67f4-4231-acce-2ef1e984ea8d)
AND
NOT DB_WYR_OpenHand_ArguingPriestGroupDialogHappened(1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_WYR_OpenHand_ArguingPriest_001_5f71634a-6ed0-4f68-933e-a4ef9b79d620, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)WYR_OpenHand_ArguingPriests_a1d142ac-de2d-6fc6-5f57-811d5f059e6e,
	S_WYR_OpenHand_ArguingPriest_001_5f71634a-6ed0-4f68-933e-a4ef9b79d620,
	S_WYR_OpenHand_ArguingPriest_002_888f7b75-bae2-487b-a631-aad7be93a29b,
	_Player);

IF
DialogStarted((DIALOGRESOURCE)WYR_OpenHand_ArguingPriests_a1d142ac-de2d-6fc6-5f57-811d5f059e6e, _)
THEN
DB_WYR_OpenHand_ArguingPriestGroupDialogHappened(1);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_WYR_OpenHand_Yannis_cb5ad2e6-40e9-4377-9669-1c4e4b1106e0, _Player)
AND
NOT DB_WYR_OpenHand_InvestigationGroupDialogHappened(1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)WYR_OpenHand_YannisAndHollyphantDetective_0dda0d28-6df0-0402-e4a6-47c60295748a,
	S_WYR_OpenHand_Yannis_cb5ad2e6-40e9-4377-9669-1c4e4b1106e0,
	S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,
	_Player);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58, _Player)
AND
NOT DB_WYR_OpenHand_InvestigationGroupDialogHappened(1)
AND
NOT DB_GlobalFlag((FLAG)WYR_OpenHand_Event_SendHollyphantToTavern_34a5879a-debf-41a7-a6cb-8e74b0b9e8ff)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_WYR_OpenHand_Yannis_cb5ad2e6-40e9-4377-9669-1c4e4b1106e0, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)WYR_OpenHand_YannisAndHollyphantDetective_0dda0d28-6df0-0402-e4a6-47c60295748a,
	S_WYR_OpenHand_Yannis_cb5ad2e6-40e9-4377-9669-1c4e4b1106e0,
	S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,
	_Player);

IF
DialogStarted((DIALOGRESOURCE)WYR_OpenHand_YannisAndHollyphantDetective_0dda0d28-6df0-0402-e4a6-47c60295748a, _)
THEN
DB_WYR_OpenHand_InvestigationGroupDialogHappened(1);

// In group dialog between Valeria and Yannis, Valeria leaves in the middle of the dialog
IF
FlagSet((FLAG)WYR_OpenHand_Event_SendHollyphantToTavern_34a5879a-debf-41a7-a6cb-8e74b0b9e8ff, NULL_00000000-0000-0000-0000-000000000000, _ID)
AND
DB_DialogName((DIALOGRESOURCE)WYR_OpenHand_YannisAndHollyphantDetective_0dda0d28-6df0-0402-e4a6-47c60295748a, _ID)
AND
DialogRemoveActorFromDialog(_ID, S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58, _)
THEN
PROC_WYR_OpenHand_SendDetectiveToTavern();

// fallback in case DialogRemoveActorFromDialog failed for some reason
IF
DialogEnded(WYR_OpenHand_YannisAndHollyphantDetective_0dda0d28-6df0-0402-e4a6-47c60295748a, _ID)
AND
DB_GlobalFlag((FLAG)WYR_OpenHand_Event_SendHollyphantToTavern_34a5879a-debf-41a7-a6cb-8e74b0b9e8ff)
THEN
PROC_WYR_OpenHand_SendDetectiveToTavern();

// If her individual dialog was triggered, then Valeria leaves after it ends
IF
DialogEnded((DIALOGRESOURCE)WYR_OpenHand_HollyphantDetective_249490a4-775f-77d2-24cd-65a92af08e19, _)
AND
DB_GlobalFlag((FLAG)WYR_OpenHand_Event_SendHollyphantToTavern_34a5879a-debf-41a7-a6cb-8e74b0b9e8ff)
THEN
PROC_WYR_OpenHand_SendDetectiveToTavern();

PROC
PROC_WYR_OpenHand_SendDetectiveToTavern()
AND
QRY_OnlyOnce("WYR_OpenHand_SendDetectiveToTavern")
THEN
PROC_RemoveDialog(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
PROC_CharacterMoveTo((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58, S_WYR_OpenHand_HollyphantDestinationAtTavern_8132970e-fe1b-4cc3-8d97-49fb253c9b44, "Run", "WYR_OpenHand_HollyphantArrivedAtTavern");

IF
FlagSet((FLAG)WYR_OpenHand_State_YannisAskedToInvestigate_394409f9-a450-4f9e-b396-7e861da8287f, _, _)
THEN
PROC_ClearCorpseOwner((CHARACTER)S_WYR_OpenHand_Lorgan_75fd6462-4d79-4d36-8fdc-fbdd124f5722);
//END_REGION Main Hall

//REGION Lorgans Chest
IF
UseFinished(_Player, S_WYR_OpenHand_LorgansChest_fa41b720-f976-41ab-81bb-5d2b70b9136e, 1)
AND
NOT DB_OnlyOncePerPlayer(_Player, "WYR_OpenHand_CheckLorgansChest")
AND
NOT DB_GlobalFlag(WYR_OpenHand_State_LorgansDiaryDiscovered_24e7c296-dc27-49b1-8afb-c6ac87702728)
THEN
DB_OnlyOncePerPlayer(_Player, "WYR_OpenHand_CheckLorgansChest");
RequestPassiveRoll(_Player, S_WYR_OpenHand_LorgansChest_fa41b720-f976-41ab-81bb-5d2b70b9136e, "SkillCheck", "Investigation", (DIFFICULTYCLASS)Act3_Easy_5028066b-6ea0-4a6a-9e3e-53bee62559a7, 0, "WYR_OpenHand_LorgansChestInvestigation");

IF
RollResult("WYR_OpenHand_LorgansChestInvestigation", _Player, S_WYR_OpenHand_LorgansChest_fa41b720-f976-41ab-81bb-5d2b70b9136e, 1, _, _)
THEN
PROC_TryStartAD(WYR_OpenHand_AD_LorgansChestDoubleBottom_3a241fbc-b4f9-b72f-63c5-006c6b073bdd, _Player);
ToInventory(S_WYR_OpenHand_LorgansDiary_eb5a34ae-57a6-4071-952e-723f8e8e60e6, S_WYR_OpenHand_LorgansChest_fa41b720-f976-41ab-81bb-5d2b70b9136e, 1, 0, 1);
SetFlag(WYR_OpenHand_State_LorgansDiaryDiscovered_24e7c296-dc27-49b1-8afb-c6ac87702728);
PROC_PlayPerceptionRevealEffect((ITEM)S_WYR_OpenHand_LorgansChest_fa41b720-f976-41ab-81bb-5d2b70b9136e, "WYR_OpenHand_LorgansChestBottomDoubleDiscovered");

IF
DestroyingBy((ITEM)S_WYR_OpenHand_LorgansChest_fa41b720-f976-41ab-81bb-5d2b70b9136e, _, _, _)
AND
NOT DB_GlobalFlag(WYR_OpenHand_State_LorgansDiaryDiscovered_24e7c296-dc27-49b1-8afb-c6ac87702728)
THEN
TeleportTo(S_WYR_OpenHand_LorgansDiary_eb5a34ae-57a6-4071-952e-723f8e8e60e6, S_WYR_OpenHand_LorgansDiaryPosition_913f9057-362b-45ed-bd28-9b6167f74224, "WYR_OpenHand_LorgansDiary_Teleported", 0, 0, 0, 0, 1);
SetFlag(WYR_OpenHand_State_LorgansDiaryDiscovered_24e7c296-dc27-49b1-8afb-c6ac87702728);

IF
EntityEvent(S_WYR_OpenHand_LorgansDiary_eb5a34ae-57a6-4071-952e-723f8e8e60e6, "WYR_OpenHand_LorgansDiary_Teleported")
THEN
PROC_PlayPerceptionRevealEffect(S_WYR_OpenHand_LorgansDiary_eb5a34ae-57a6-4071-952e-723f8e8e60e6, "WYR_OpenHand_LorgansDiary");
//END_REGION Lorgans Chest

//REGION Secret Tunnels Door
IF
DB_WYR_OpenHand_Buttons(_Button, _, _)
THEN
SetOnStage(_Button, 0);

IF
FlagSet((FLAG)WYR_OpenHand_Knows_HowToOpenSecretTunnels_74184bb0-edd1-73a0-3d63-fe07b78c9e4b, _, _)
AND
DB_WYR_OpenHand_Buttons(_Button, _HeraldicStone, _MovedPos)
THEN
SetEntityEvent(_HeraldicStone, "StoryReveal");

IF
UseFinished(_Player, _HeraldicStone, 1)
AND
DB_WYR_OpenHand_Buttons(_Button, _HeraldicStone, _MovedPos)
AND
NOT DB_WYR_OpenHand_HeraldicStoneMoved(_HeraldicStone)
THEN
DB_WYR_OpenHand_HeraldicStoneMoved(_HeraldicStone);
ItemMoveTo(_HeraldicStone, _MovedPos, 2.0, 0.0, 0, "", 0);
SetCanInteract(_HeraldicStone, 0);
SetOnStage(_Button, 1);

IF
DualEntityEvent(_Player, _Button, "WYR_OpenHand_CellarButton_On")
THEN
DB_WYR_OpenHand_ActivatedCellarButtons(_Button);
PROC_LoopEffect(VFX_Script_Light_Button_01_b5d1591e-fa36-a156-0f64-5980f2f728a8, _Button, "WYR_OpenHand_CellarButton", "BGO_Main_A", "");

IF
DB_WYR_OpenHand_ActivatedCellarButtons((ITEM)WYR_OpenHand_CellarButton_001_1fd64a84-c26c-4253-9655-945926ee2790)
AND
DB_WYR_OpenHand_ActivatedCellarButtons((ITEM)WYR_OpenHand_CellarButton_002_dd737483-a3bf-42c4-9634-7ad18c69712f)
THEN
Open((ITEM)S_WYR_OpenHand_CellarSlidingWall_ede4a888-0e7e-4bfc-97e2-3da1e38f08d4);
SetFlag(WYR_OpenHand_State_PlayersOpenSecretDoor_cf74c6de-4c14-4fd3-a944-0d27c68996f8);

IF
DualEntityEvent(_Player, _Button, "WYR_OpenHand_CellarButton_Off")
THEN
NOT DB_WYR_OpenHand_ActivatedCellarButtons(_Button);
PROC_StopLoopEffect(_Button, "WYR_OpenHand_CellarButton");

IF
DualEntityEvent(_Player, _Button, "WYR_OpenHand_CellarButton_Off")
AND
IsOpened((ITEM)S_WYR_OpenHand_CellarSlidingWall_ede4a888-0e7e-4bfc-97e2-3da1e38f08d4, 1)
THEN
Close((ITEM)S_WYR_OpenHand_CellarSlidingWall_ede4a888-0e7e-4bfc-97e2-3da1e38f08d4);

IF
DualEntityEvent(_Player, _, "WYR_OpenHand_LeverUsed")
THEN
PROC_WYR_OpenHand_OpenCloseSecretDoor();

PROC
PROC_WYR_OpenHand_OpenCloseSecretDoor()
AND
IsOpened((ITEM)S_WYR_OpenHand_CellarSlidingWall_ede4a888-0e7e-4bfc-97e2-3da1e38f08d4, 0)
THEN
Open((ITEM)S_WYR_OpenHand_CellarSlidingWall_ede4a888-0e7e-4bfc-97e2-3da1e38f08d4);

PROC
PROC_WYR_OpenHand_OpenCloseSecretDoor()
AND
IsOpened((ITEM)S_WYR_OpenHand_CellarSlidingWall_ede4a888-0e7e-4bfc-97e2-3da1e38f08d4, 1)
THEN
Close((ITEM)S_WYR_OpenHand_CellarSlidingWall_ede4a888-0e7e-4bfc-97e2-3da1e38f08d4);
//END_REGION Secret Tunnels Door

//REGION Tunnels
PROC
PROC_SpotPlayers_Spotted(_, "WYR_OpenHand_Shifters", _Player)
AND
QRY_OnlyOnce("WYR_OpenHand_ShiftersSpottedPlayer")
THEN
PROC_SetRelationToPlayers((FACTION)Act3_WYR_OpenHand_Shifters_66f98981-f44d-48e0-8b16-2bfff792a8ba, 0);
PROC_ForceStopDialog(S_WYR_OpenHand_Shifter_001_fa27a169-32ba-4cf2-a400-e0874056c572);
PROC_TryStartAD((DIALOGRESOURCE)WYR_OpenHand_AD_ShiftersAttack_8be237b7-f1c0-2c12-dd47-ee4e592667a0, S_WYR_OpenHand_Shifter_001_fa27a169-32ba-4cf2-a400-e0874056c572);

IF
AddedTo(S_WYR_OpenHand_ShiftersFlowerKey_8ab130ef-4fad-4bfe-b667-f4a73c1c36c0, (CHARACTER)_Player, _)
AND
DB_Players(_Player)
AND
GetFlag(WYR_OpenHand_State_PickedUpBloodiedKey_c3e0ca6c-32e9-47f6-8a54-b362ad43079a, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
SetFlag(WYR_OpenHand_State_PickedUpBloodiedKey_c3e0ca6c-32e9-47f6-8a54-b362ad43079a);

IF
AddedTo(S_WYR_OpenHand_ShiftersFlowerKey_8ab130ef-4fad-4bfe-b667-f4a73c1c36c0, (CHARACTER)_Player, _)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)WYR_Flophouse_State_PickedUpNormalFlowerKey_5d5584c1-07e2-447b-9e8a-6b492265b06c)
AND
QRY_OnlyOnce("WYR_Openhand_PAD_BloodiedFlowerKey")
THEN
PROC_WYR_SerialKiller_PlayKeyPAD(WYR_Openhand_PAD_BloodiedFlowerKey_8c10fc7f-58d9-439f-a232-ca1b8148b818,_Player);

IF
AddedTo(S_WYR_OpenHand_DaggerOfParalyzing_b255824c-d3f6-4fd4-93f0-901a699a4b44, _Player, _)
AND
DB_GlobalFlag(WYR_OpenHand_Knows_Murder_69cba284-da0f-47cd-800d-d9939d0a4c98)
AND
QRY_OnlyOnce("WYR_OpenHand_PAD_PickedUpDaggerOfParalyzing")
THEN
PROC_TryStartAD((DIALOGRESOURCE)WYR_OpenHand_PAD_PickedUpDagger_a0218e18-d38d-54f7-97d0-fe4c04fe538b, _Player);
//END_REGION Tunnels

//REGION Tunnel boulders
//Collision detection and damage handled through CMB_RollingBoulder in anubis
IF
UseFinished(_Player, S_TELEPORT_CavemouthA_6e799f00-243c-41ec-9713-178c9b1f1ec9, 1)
AND
NOT DB_WYR_OpenHand_TunnelsBoulder_EnteredInside(1)
THEN
DB_WYR_OpenHand_TunnelsBoulder_EnteredInside(1);

IF
UseStarted(_Player, S_TELEPORT_SmuggelTunnel_6b473899-49a5-4720-a4cd-da3eb588ae5f)
AND
NOT DB_WYR_OpenHand_TunnelsBoulder_EnteredInside(1)
THEN
PROC_WYR_OpenHandCave_EntranceBoulders_Clear();

PROC
PROC_WYR_OpenHandCave_EntranceBoulders_Clear()
AND
DB_WYR_OpenHandCave_EntranceBoulders(_Boulder)
AND
IsInTrigger(_Boulder, S_WYR_OpenHandCave_EntranceArea_e7e89bb8-f8e6-4906-80a9-8942b3069318, 1)
AND
IsDestroyed(_Boulder, 0)
THEN
Die(_Boulder, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 300000.0); // they are heavy
//END_REGION Tunnerl boulder

//REGION Journal
//New starting point and flow
IF
FlagSet(WYR_OpenHand_State_HasDagger_a1a8df94-4145-4ad1-a7a3-c01cdb3c4094, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
NOT QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate("WYR_OpenHandMurder", "FoundDagger_NoYannis");

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("WYR_OpenHand_Shifters")
AND
NOT QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate("WYR_OpenHandMurder", "KilledDoppelgangers_NoYannis");

IF
FlagSet(WYR_OpenHand_State_HasBloodiedFlowerKey_0733d1e9-dc81-46dd-9626-6d1a8eaa7d7d, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
NOT QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate((CHARACTER)_Player, "WYR_OpenHandMurder", "FoundKey_NoYannis");

IF
QuestUpdateUnlocked(_Character, "WYR_OpenHandMurder", _StateID)
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "FoundKey_NoYannis")
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "KilledDoppelgangers_NoYannis")
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "FoundDagger_NoYannis")
THEN
QuestUpdate(_Character, "WYR_OpenHandMurder", "FoundAllClues_NoYannis");

IF
DB_GlobalFlag(WYR_OpenHand_State_GoToFlophouse_8a7a226b-7fad-d253-e2c9-ed21890dbe02)
AND
NOT QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate("WYR_OpenHandMurder", "SwDDoppelganger_NoYannis");

IF
DB_GlobalFlag(WYR_OpenHand_State_GoToFlophouse_8a7a226b-7fad-d253-e2c9-ed21890dbe02)
AND
QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate("WYR_OpenHandMurder", "FollowTheKeyBecauseDoppelganger");

IF
DB_GlobalFlag(WYR_OpenHand_State_GoToFlophouse_8a7a226b-7fad-d253-e2c9-ed21890dbe02)
AND
DB_GlobalFlag(WYR_OpenHand_State_YannisAskedToInvestigate_394409f9-a450-4f9e-b396-7e861da8287f)
AND
NOT QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate("WYR_OpenHandMurder", "FollowTheKeyBecauseDoppelganger_DelayedStart");

//Old starting point and flow

IF
FlagSet(WYR_OpenHand_State_YannisAskedToInvestigate_394409f9-a450-4f9e-b396-7e861da8287f, _, _)
AND
NOT DB_QuestIsOpened("WYR_OpenHandMurder")
THEN
QuestUpdate("WYR_OpenHandMurder", "YannisStartPoint");

IF
DB_GlobalFlag(WYR_OpenHand_Knows_KillersName_ce8dca23-7b94-4b18-81ef-ff40ca3d9bed)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "BrilgorDidntDoIt")
AND
QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate("WYR_OpenHandMurder", "DolorIsKiller");

IF
DB_GlobalFlag(WYR_OpenHand_Knows_KillersName_ce8dca23-7b94-4b18-81ef-ff40ca3d9bed)
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "BrilgorDidntDoIt")
AND
QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate("WYR_OpenHandMurder", "DolorKillerNotBrilgor");

IF
FlagSet(WYR_OpenHand_State_HasDagger_a1a8df94-4145-4ad1-a7a3-c01cdb3c4094, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "DaggerFound")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "FindKeyOrigin")
AND
QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate("WYR_OpenHandMurder", "DaggerFound");

IF
FlagSet(WYR_OpenHand_State_HasDagger_a1a8df94-4145-4ad1-a7a3-c01cdb3c4094, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "DaggerFound")
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "FindKeyOrigin")
AND
QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate("WYR_OpenHandMurder", "DaggerFoundAfterKey");

IF
FlagSet(WYR_OpenHand_State_HasBloodiedFlowerKey_0733d1e9-dc81-46dd-9626-6d1a8eaa7d7d, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "FindKeyOrigin")
AND
QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate(_Player, "WYR_OpenHandMurder", "FindKeyOrigin");

IF
DB_GlobalFlag(WYR_OpenHand_State_YannisAskedToInvestigate_394409f9-a450-4f9e-b396-7e861da8287f)
AND
DB_Players(_Player)
AND
GetFlag(WYR_OpenHand_State_HasBloodiedFlowerKey_0733d1e9-dc81-46dd-9626-6d1a8eaa7d7d, _Player, 1)
AND
NOT QRY_WYR_OpenHand_StartedOldFlow()
THEN
QuestUpdate(_Player, "WYR_OpenHandMurder", "FindKeyOrigin_AlternativeFlow");

QRY
QRY_WYR_OpenHand_TalkedYannis()
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "YannisStartPoint")
THEN
DB_NOOP(1);

QRY
QRY_WYR_OpenHand_TalkedYannis()
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "TalkYannisNotStart")
THEN
DB_NOOP(1);

IF
DB_GlobalFlag(WYR_SerialKiller_State_ToldValeriaAboutDagger_39b8c37f-9e84-4750-82a6-6c966c644765)
AND
QRY_OnlyOnce_Reset("WYR_LOW_OpenHandMurder_ValeriaDagger")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("WYR_LOW_OpenHandMurder_ValeriaDagger")
AND
QRY_WYR_OpenHand_PickDaggerObjective(_Player)
THEN
PROC_WYR_OpenHand_FinishEvaluation();

PROC
PROC_WYR_OpenHand_FinishEvaluation()
AND
DB_Players(_Player)
AND
DB_WYR_OpenHand_DaggerObjectiveDatabase_CurrentObjective(_Objective, _Step, _)
AND
QuestUpdateExists("WYR_OpenHandMurder", _Step, 1)
AND
QRY_OnlyOnce("WYR_OpenHandMurder_ValeriaDagger_FinishEvaluation")
AND
DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps(_Objective, _StepToTrigger)
THEN
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps(_Objective, _StepToTrigger);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "DaggerFound", 1);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "DolorIsKiller", 1);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "DolorKillerNotBrilgor", 1);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_InvestigateCrimeScene", "EnterCaves", 1);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Key", "FindKeyOrigin", 2);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Key", "DaggerFoundAfterKey", 2);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseKey", 3);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseFlophouse", 3);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseDoppelganger", 3);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase("WYR_OpenHandMurder_Flophouse", "FollowTheKeyBecauseAlradyEnterLair", 3);
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps("WYR_OpenHandMurder_InvestigateCrimeScene", "TalkedValeria_OnlyDagger");
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps("WYR_OpenHandMurder_Key", "TalkedValeriaDagger_KeyFound");
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase_Steps("WYR_OpenHandMurder_Flophouse", "TalkerValeriaDagger_Flophouse");
QuestUpdate(_Player, "WYR_OpenHandMurder", _StepToTrigger);

//REGION QRY_WYR_OpenHand_PickDaggerObjective
QRY
QRY_WYR_OpenHand_PickDaggerObjective((CHARACTER)_Player)
AND
DB_WYR_OpenHand_DaggerObjectiveDatabase(_Objective, _Step, _Priority)
AND
QuestUpdateIsUnlocked(_Player, "WYR_OpenHandMurder", _Step, 1)
AND
DB_WYR_OpenHand_DaggerObjectiveDatabase_CurrentObjective(_OtherObjective, _OtherStep, _OtherPriority)
AND
_Priority > _OtherPriority
THEN
NOT DB_WYR_OpenHand_DaggerObjectiveDatabase_CurrentObjective(_OtherObjective, _OtherStep, _OtherPriority);
DB_WYR_OpenHand_DaggerObjectiveDatabase_CurrentObjective(_Objective, _Step, _Priority);
//END_REGION

//REGION QRY_WYR_OpenHand_StartedOldFlow

QRY
QRY_WYR_OpenHand_StartedOldFlow()
AND
QRY_WYR_OpenHand_TalkedYannis()
THEN
DB_NOOP(1);

QRY
QRY_WYR_OpenHand_StartedOldFlow()
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "BrilgorKilledTunnels")
THEN
DB_NOOP(1);

QRY
QRY_WYR_OpenHand_StartedOldFlow()
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_OpenHandMurder", "LorganKilledTunnels")
THEN
DB_NOOP(1);

//END_REGION QRY_WYR_OpenHand_StartedOldFlow

//END_REGION Journal

//REGION Debug
IF
TextEvent("sk_dagger")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_WYR_OpenHand_DaggerOfParalyzing_b255824c-d3f6-4fd4-93f0-901a699a4b44, _Player, 1, 1, 1);

IF
TextEvent("sk_pass")
AND
GetHostCharacter(_Player)
THEN
TemplateAddTo((ITEMROOT)UNI_WYR_LowerCityPass_0a172d65-748c-4ff1-bf66-200fceb5ca79, _Player, 1, 1);

IF
TextEvent("sk_key")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_WYR_OpenHand_ShiftersFlowerKey_8ab130ef-4fad-4bfe-b667-f4a73c1c36c0, _Player, 1, 1, 1);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3"
