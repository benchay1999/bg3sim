Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Chess

DB_WYR_Chess_Tile(1, 1, (ITEM)S_WYR_Chess_1a_c8fcb1e8-5a31-47fe-b131-ccf5bec14756);
DB_WYR_Chess_Tile(1, 2, S_WYR_Chess_1b_12432d4c-e3ad-4c26-8380-21214f00a0f4);
DB_WYR_Chess_Tile(1, 3, S_WYR_Chess_1c_bc993dec-0651-4f5c-8cbc-2d13c7853008);
DB_WYR_Chess_Tile(1, 4, S_WYR_Chess_1d_f4429a2c-06df-486b-ba48-f25571776fe6);
DB_WYR_Chess_Tile(1, 5, S_WYR_Chess_1e_85ca4769-e6ee-430a-b30c-03f600d1171c);
DB_WYR_Chess_Tile(1, 6, S_WYR_Chess_1f_1cf4778a-8cfa-40cd-8d0d-d81781f7d375);
DB_WYR_Chess_Tile(1, 7, S_WYR_Chess_1g_b8af2294-571f-425e-849d-2e412c0ce53b);
DB_WYR_Chess_Tile(1, 8, S_WYR_Chess_1h_639c625c-7e83-484d-986e-3fd1332ca005);

DB_WYR_Chess_Tile(2, 1, S_WYR_Chess_2a_479352fe-e76d-4913-a961-2c96ee923759);
DB_WYR_Chess_Tile(2, 2, S_WYR_Chess_2b_9cf3dc80-258b-4c66-8b73-5f2cb9841173);
DB_WYR_Chess_Tile(2, 3, S_WYR_Chess_2c_cc49ec91-2a35-4cba-b535-99c2f9b29cd9);
DB_WYR_Chess_Tile(2, 4, S_WYR_Chess_2d_17aaa354-1b9b-426a-af29-7450ee083604);
DB_WYR_Chess_Tile(2, 5, S_WYR_Chess_2e_9b9c6faf-4b4a-449e-9f8a-c240f29bfa33);
DB_WYR_Chess_Tile(2, 6, S_WYR_Chess_2f_7717ec17-f37b-4974-950b-6fa8220f4065);
DB_WYR_Chess_Tile(2, 7, S_WYR_Chess_2g_8c927502-3c02-4301-bb64-5916babcf375);
DB_WYR_Chess_Tile(2, 8, S_WYR_Chess_2h_f270ce27-5785-4ac7-be3d-c724f87dc652);

DB_WYR_Chess_Tile(3, 1, S_WYR_Chess_3a_fef1bca6-5ae5-4abc-88cc-e7e29ca868d4);
DB_WYR_Chess_Tile(3, 2, S_WYR_Chess_3b_e63b59bd-4b78-427c-8967-9734c7a750f1);
DB_WYR_Chess_Tile(3, 3, S_WYR_Chess_3c_c0e65cd2-6106-477a-961e-39a6981be0ec);
DB_WYR_Chess_Tile(3, 4, S_WYR_Chess_3d_c69e95b7-1ea4-4398-bc13-d2b354ca194e);
DB_WYR_Chess_Tile(3, 5, S_WYR_Chess_3e_177b6b1c-5e95-4430-9bf6-de5a9c3f1090);
DB_WYR_Chess_Tile(3, 6, S_WYR_Chess_3f_71b5507c-22aa-4021-bfee-f412e8c5d94f);
DB_WYR_Chess_Tile(3, 7, S_WYR_Chess_3g_e28e50a3-d53a-49c1-ae16-5c2d8e385f5b);
DB_WYR_Chess_Tile(3, 8, S_WYR_Chess_3h_d461c692-08b3-45de-8584-60b37ab4f6ee);

DB_WYR_Chess_Tile(4, 1, S_WYR_Chess_4a_211518f5-3965-488a-ba01-341ca5856227);
DB_WYR_Chess_Tile(4, 2, S_WYR_Chess_4b_c97338d2-ec80-4e85-81d2-553312247a71);
DB_WYR_Chess_Tile(4, 3, S_WYR_Chess_4c_cf9cb89d-2853-4d07-becb-d6d0ca367611);
DB_WYR_Chess_Tile(4, 4, S_WYR_Chess_4d_b1a1ec80-7a40-4aab-8d85-e43151883a79);
DB_WYR_Chess_Tile(4, 5, S_WYR_Chess_4e_8b40f06d-4aa7-43dd-a56e-d57cc6dbe402);
DB_WYR_Chess_Tile(4, 6, S_WYR_Chess_4f_83a162b8-004a-4aef-a11f-b7e08b2824d6);
DB_WYR_Chess_Tile(4, 7, S_WYR_Chess_4g_dd3b96d7-6335-435c-8513-8aa805653f8f);
DB_WYR_Chess_Tile(4, 8, S_WYR_Chess_4h_02e2c224-d81d-4bb8-8636-ee5e71aecc41);

DB_WYR_Chess_Tile(5, 1, S_WYR_Chess_5a_b2b500fa-6135-4280-9c54-dba47393c584);
DB_WYR_Chess_Tile(5, 2, S_WYR_Chess_5b_93f80c82-e1b8-4b7c-adb7-ee26dd5fd58a);
DB_WYR_Chess_Tile(5, 3, S_WYR_Chess_5c_6fbcfa32-ac92-4b53-ae31-066523f50d88);
DB_WYR_Chess_Tile(5, 4, S_WYR_Chess_5d_9d8a1562-0e9c-4717-a5af-27a3662e920d);
DB_WYR_Chess_Tile(5, 5, S_WYR_Chess_5e_a46df296-b88e-40d8-96d9-003bffd1b374);
DB_WYR_Chess_Tile(5, 6, S_WYR_Chess_5f_a905f8ee-8752-4848-bfce-513b72017870);
DB_WYR_Chess_Tile(5, 7, S_WYR_Chess_5g_762bf30b-b06d-4d9f-971e-9b763be40274);
DB_WYR_Chess_Tile(5, 8, S_WYR_Chess_5h_e5999c28-f0bb-43c2-9210-02c86bb57421);

DB_WYR_Chess_Tile(6, 1, S_WYR_Chess_6a_d06364d5-4693-4c7e-9275-4a767efa8074);
DB_WYR_Chess_Tile(6, 2, S_WYR_Chess_6b_aa82ff3d-0e07-4945-8386-526c04c707bb);
DB_WYR_Chess_Tile(6, 3, S_WYR_Chess_6c_42ed8400-a605-4e3c-b231-667afb517791);
DB_WYR_Chess_Tile(6, 4, S_WYR_Chess_6d_1a4a551e-11e4-447e-9713-181b5ef9716f);
DB_WYR_Chess_Tile(6, 5, S_WYR_Chess_6e_8fe8b4fe-f870-4b26-89da-efa745d3a495);
DB_WYR_Chess_Tile(6, 6, S_WYR_Chess_6f_84dd40fc-a9dc-4209-825c-d9f478ce003a);
DB_WYR_Chess_Tile(6, 7, S_WYR_Chess_6g_025b78e2-4707-4c4a-ac29-d7522938a4e9);
DB_WYR_Chess_Tile(6, 8, S_WYR_Chess_6h_bcd3d5b1-4df5-49ce-96a4-599ad98cb39f);

DB_WYR_Chess_Tile(7, 1, S_WYR_Chess_7a_338ce658-cbca-444a-99cc-f723c23de3da);
DB_WYR_Chess_Tile(7, 2, S_WYR_Chess_7b_730133f4-9f2c-4dbf-9a51-53f308d46dfd);
DB_WYR_Chess_Tile(7, 3, S_WYR_Chess_7c_5de75942-3066-43e7-89bb-1439ef13e639);
DB_WYR_Chess_Tile(7, 4, S_WYR_Chess_7d_3eb095eb-e7a6-449c-8179-e0eeeeab44c5);
DB_WYR_Chess_Tile(7, 5, S_WYR_Chess_7e_323fb635-ae7d-4161-aa6c-cb4abf225b60);
DB_WYR_Chess_Tile(7, 6, S_WYR_Chess_7f_1f19ebf3-2e96-469d-b4c4-e7f205d11d1b);
DB_WYR_Chess_Tile(7, 7, S_WYR_Chess_7g_fa70fb99-ddaf-4b3b-bc62-430b338e962c);
DB_WYR_Chess_Tile(7, 8, S_WYR_Chess_7h_31379a5c-dca1-4939-b112-7b64c91de56b);

DB_WYR_Chess_Tile(8, 1, S_WYR_Chess_8a_7c7b9928-4693-4532-852a-e48b56e893d6);
DB_WYR_Chess_Tile(8, 2, S_WYR_Chess_8b_bf6516fb-9979-4cae-9aea-77f232141027);
DB_WYR_Chess_Tile(8, 3, S_WYR_Chess_8c_ddbaad6f-803c-45ee-aa68-4717bde7dbc0);
DB_WYR_Chess_Tile(8, 4, S_WYR_Chess_8d_4b5eb922-096b-4739-9421-0522455f1431);
DB_WYR_Chess_Tile(8, 5, S_WYR_Chess_8e_40237ff4-deb2-417d-a427-d7b91d7ac7b3);
DB_WYR_Chess_Tile(8, 6, S_WYR_Chess_8f_52600863-67a1-45c2-9ea7-92de057fd89f);
DB_WYR_Chess_Tile(8, 7, S_WYR_Chess_8g_bab3ce08-7cc7-4e67-9b20-acdb1d6ba9ad);
DB_WYR_Chess_Tile(8, 8, S_WYR_Chess_8h_19156154-800b-4a78-91e0-c792d023710f);

DB_WYR_Chess_LifeGems((ITEM)S_WYR_Chess_Life1_699da5b0-6566-477d-b0de-619f831f87d5);
DB_WYR_Chess_LifeGems(S_WYR_Chess_Life2_18405221-d147-4475-a553-66f646df51b7);
DB_WYR_Chess_LifeGems(S_WYR_Chess_Life3_b5d4f92c-b285-474f-8c52-e1b0fa1b57e0);

DB_WYR_Chess_Directions(-1);
DB_WYR_Chess_Directions(1);


DB_WYR_Chess_StartPos(1, (ITEM)S_WYR_Chess_Bishop1_cad61364-44fe-4647-a034-1370d359e139, (ITEM)S_WYR_Chess_5b_93f80c82-e1b8-4b7c-adb7-ee26dd5fd58a);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, S_WYR_Chess_8f_52600863-67a1-45c2-9ea7-92de057fd89f);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Pawn1_9c9bf30a-b7e3-40d2-8ac9-2c7d47fd31ce, S_WYR_Chess_7f_1f19ebf3-2e96-469d-b4c4-e7f205d11d1b);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Pawn2_6b74d0f5-7e91-4ba3-bd25-1f9e69c6ecbf, S_WYR_Chess_6e_8fe8b4fe-f870-4b26-89da-efa745d3a495);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Queen1_6a97fad0-2cf0-4c38-a02a-daaf38c1e5e3, S_WYR_Chess_6c_42ed8400-a605-4e3c-b231-667afb517791);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Queen2_5804b68f-8ebc-42e5-9507-c817a3af6d74, S_WYR_Chess_6f_84dd40fc-a9dc-4209-825c-d9f478ce003a);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Pawn3_098f0870-5822-4e2d-ad58-5af344771da2, S_WYR_Chess_4b_c97338d2-ec80-4e85-81d2-553312247a71);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Pawn4_b8875b9b-bf75-4e3b-8183-4af54cb15d59, S_WYR_Chess_5a_b2b500fa-6135-4280-9c54-dba47393c584);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Rook1_ee91ac85-5b7a-4ffc-b64b-d7d3c19d9e4e, S_WYR_Chess_3d_c69e95b7-1ea4-4398-bc13-d2b354ca194e);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Pawn7_0a4c1566-7a15-49ce-b748-235460cfb6ef, S_WYR_Chess_2f_7717ec17-f37b-4974-950b-6fa8220f4065);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Pawn6_35906485-36c5-448e-bd93-de38e01f9bca, S_WYR_Chess_3g_e28e50a3-d53a-49c1-ae16-5c2d8e385f5b);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_Pawn5_37b94dba-fd17-4449-a16d-5ff33c8aea50, S_WYR_Chess_4h_02e2c224-d81d-4bb8-8636-ee5e71aecc41);
DB_WYR_Chess_StartPos(1, S_WYR_Chess_King2_92bff751-8119-4578-aa04-df3de5f122c7, S_WYR_Chess_1f_1cf4778a-8cfa-40cd-8d0d-d81781f7d375);

DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Queen2_5804b68f-8ebc-42e5-9507-c817a3af6d74, (ITEM)S_WYR_Chess_6a_d06364d5-4693-4c7e-9275-4a767efa8074);
DB_WYR_Chess_StartPos(2, S_WYR_Chess_Pawn1_9c9bf30a-b7e3-40d2-8ac9-2c7d47fd31ce, (ITEM)S_WYR_Chess_7c_5de75942-3066-43e7-89bb-1439ef13e639);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Pawn5_37b94dba-fd17-4449-a16d-5ff33c8aea50, (ITEM)S_WYR_Chess_2c_cc49ec91-2a35-4cba-b535-99c2f9b29cd9);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Queen1_6a97fad0-2cf0-4c38-a02a-daaf38c1e5e3, (ITEM)S_WYR_Chess_4d_b1a1ec80-7a40-4aab-8d85-e43151883a79);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Rook2_691987a5-d18e-421d-b4b3-a9ba44740398, (ITEM)S_WYR_Chess_8e_40237ff4-deb2-417d-a427-d7b91d7ac7b3);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Bishop2_d3779d86-5a9a-4750-818b-086cc699bbcc, (ITEM)S_WYR_Chess_5e_a46df296-b88e-40d8-96d9-003bffd1b374);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_King2_92bff751-8119-4578-aa04-df3de5f122c7, (ITEM)S_WYR_Chess_2e_9b9c6faf-4b4a-449e-9f8a-c240f29bfa33);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Pawn2_6b74d0f5-7e91-4ba3-bd25-1f9e69c6ecbf, (ITEM)S_WYR_Chess_5f_a905f8ee-8752-4848-bfce-513b72017870);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Pawn6_35906485-36c5-448e-bd93-de38e01f9bca, (ITEM)S_WYR_Chess_4f_83a162b8-004a-4aef-a11f-b7e08b2824d6);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Pawn9_b7d89f06-097e-4c4f-acf6-c23de424b04d, (ITEM)S_WYR_Chess_7g_fa70fb99-ddaf-4b3b-bc62-430b338e962c);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Pawn7_0a4c1566-7a15-49ce-b748-235460cfb6ef, (ITEM)S_WYR_Chess_2g_8c927502-3c02-4301-bb64-5916babcf375);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, (ITEM)S_WYR_Chess_8h_19156154-800b-4a78-91e0-c792d023710f);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Pawn4_b8875b9b-bf75-4e3b-8183-4af54cb15d59, (ITEM)S_WYR_Chess_6h_bcd3d5b1-4df5-49ce-96a4-599ad98cb39f);
DB_WYR_Chess_StartPos(2, (ITEM)S_WYR_Chess_Pawn8_7685e434-9fd1-42af-920a-9ec29a3d29c5, (ITEM)S_WYR_Chess_2h_f270ce27-5785-4ac7-be3d-c724f87dc652);

DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Pawn1_9c9bf30a-b7e3-40d2-8ac9-2c7d47fd31ce, (ITEM)S_WYR_Chess_5b_93f80c82-e1b8-4b7c-adb7-ee26dd5fd58a);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Rook2_691987a5-d18e-421d-b4b3-a9ba44740398, (ITEM)S_WYR_Chess_5c_6fbcfa32-ac92-4b53-ae31-066523f50d88);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Queen2_5804b68f-8ebc-42e5-9507-c817a3af6d74, (ITEM)S_WYR_Chess_7d_3eb095eb-e7a6-449c-8179-e0eeeeab44c5);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Queen1_6a97fad0-2cf0-4c38-a02a-daaf38c1e5e3, (ITEM)S_WYR_Chess_5d_9d8a1562-0e9c-4717-a5af-27a3662e920d);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Rook1_ee91ac85-5b7a-4ffc-b64b-d7d3c19d9e4e, (ITEM)S_WYR_Chess_8f_52600863-67a1-45c2-9ea7-92de057fd89f);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Bishop1_cad61364-44fe-4647-a034-1370d359e139, (ITEM)S_WYR_Chess_7f_1f19ebf3-2e96-469d-b4c4-e7f205d11d1b);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Pawn2_6b74d0f5-7e91-4ba3-bd25-1f9e69c6ecbf, (ITEM)S_WYR_Chess_5f_a905f8ee-8752-4848-bfce-513b72017870);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Pawn5_37b94dba-fd17-4449-a16d-5ff33c8aea50, (ITEM)S_WYR_Chess_2f_7717ec17-f37b-4974-950b-6fa8220f4065);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, (ITEM)S_WYR_Chess_6g_025b78e2-4707-4c4a-ac29-d7522938a4e9);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Pawn3_098f0870-5822-4e2d-ad58-5af344771da2, (ITEM)S_WYR_Chess_5g_762bf30b-b06d-4d9f-971e-9b763be40274);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Pawn6_35906485-36c5-448e-bd93-de38e01f9bca, (ITEM)S_WYR_Chess_4g_dd3b96d7-6335-435c-8513-8aa805653f8f);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_King2_92bff751-8119-4578-aa04-df3de5f122c7, (ITEM)S_WYR_Chess_1g_b8af2294-571f-425e-849d-2e412c0ce53b);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Pawn4_b8875b9b-bf75-4e3b-8183-4af54cb15d59, (ITEM)S_WYR_Chess_6h_bcd3d5b1-4df5-49ce-96a4-599ad98cb39f);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Knight1_b4534bb0-33ad-40e7-a4e5-6b64238979fe, (ITEM)S_WYR_Chess_5h_e5999c28-f0bb-43c2-9210-02c86bb57421);
DB_WYR_Chess_StartPos(3, (ITEM)S_WYR_Chess_Pawn7_0a4c1566-7a15-49ce-b748-235460cfb6ef, (ITEM)S_WYR_Chess_3h_d461c692-08b3-45de-8584-60b37ab4f6ee);

DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Pawn1_9c9bf30a-b7e3-40d2-8ac9-2c7d47fd31ce, (ITEM)S_WYR_Chess_7a_338ce658-cbca-444a-99cc-f723c23de3da);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Pawn5_37b94dba-fd17-4449-a16d-5ff33c8aea50, (ITEM)S_WYR_Chess_3a_fef1bca6-5ae5-4abc-88cc-e7e29ca868d4);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Pawn2_6b74d0f5-7e91-4ba3-bd25-1f9e69c6ecbf, (ITEM)S_WYR_Chess_6b_aa82ff3d-0e07-4945-8386-526c04c707bb);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Pawn3_098f0870-5822-4e2d-ad58-5af344771da2, (ITEM)S_WYR_Chess_5c_6fbcfa32-ac92-4b53-ae31-066523f50d88);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Pawn6_35906485-36c5-448e-bd93-de38e01f9bca, (ITEM)S_WYR_Chess_2c_cc49ec91-2a35-4cba-b535-99c2f9b29cd9);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Rook2_691987a5-d18e-421d-b4b3-a9ba44740398, (ITEM)S_WYR_Chess_8d_4b5eb922-096b-4739-9421-0522455f1431);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Queen2_5804b68f-8ebc-42e5-9507-c817a3af6d74, (ITEM)S_WYR_Chess_5e_a46df296-b88e-40d8-96d9-003bffd1b374);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Pawn7_0a4c1566-7a15-49ce-b748-235460cfb6ef, (ITEM)S_WYR_Chess_4e_8b40f06d-4aa7-43dd-a56e-d57cc6dbe402);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Rook3_18876404-9dfc-4d38-9208-5f0191d28b8d, (ITEM)S_WYR_Chess_8f_52600863-67a1-45c2-9ea7-92de057fd89f);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Pawn4_b8875b9b-bf75-4e3b-8183-4af54cb15d59, (ITEM)S_WYR_Chess_7f_1f19ebf3-2e96-469d-b4c4-e7f205d11d1b);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_King2_92bff751-8119-4578-aa04-df3de5f122c7, (ITEM)S_WYR_Chess_1f_1cf4778a-8cfa-40cd-8d0d-d81781f7d375);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Pawn9_b7d89f06-097e-4c4f-acf6-c23de424b04d, (ITEM)S_WYR_Chess_5g_762bf30b-b06d-4d9f-971e-9b763be40274);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Bishop1_cad61364-44fe-4647-a034-1370d359e139, (ITEM)S_WYR_Chess_4g_dd3b96d7-6335-435c-8513-8aa805653f8f);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, (ITEM)S_WYR_Chess_6h_bcd3d5b1-4df5-49ce-96a4-599ad98cb39f);
DB_WYR_Chess_StartPos(4, (ITEM)S_WYR_Chess_Knight1_b4534bb0-33ad-40e7-a4e5-6b64238979fe, (ITEM)S_WYR_Chess_5h_e5999c28-f0bb-43c2-9210-02c86bb57421);

DB_WYR_Chess_SetupFlag(1, (FLAG)WYR_Chess_State_Option1_72600c71-696f-2d73-614d-ceae09296d1a);
DB_WYR_Chess_SetupFlag(2, (FLAG)WYR_Chess_State_Option2_b3129fb9-2691-600b-7e3d-9958d8a6cf8b);
DB_WYR_Chess_SetupFlag(3, (FLAG)WYR_Chess_State_Option3_7f8ff590-6de2-605c-2944-4513499df56a);

DB_WYR_Chess_Size("Bishop", "Medium");
DB_WYR_Chess_Size("Rook", "Medium");
DB_WYR_Chess_Size("King", "Big");
DB_WYR_Chess_Size("Pawn", "Small");
DB_WYR_Chess_Size("Queen", "Big");
DB_WYR_Chess_Size("Knight", "Big");

DB_WYR_Chess_TeleportVFX("Medium", 0, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Medium_Teleport_Black_Start_01_74ccbdd5-ee75-230c-3c11-bdfa8ad04a9b, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Medium_Teleport_Black_End_01_838ca68c-a216-62ea-cb38-06d461b8ed64);
DB_WYR_Chess_TeleportVFX("Medium", 1, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Medium_Teleport_Black_Start_01_74ccbdd5-ee75-230c-3c11-bdfa8ad04a9b, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Medium_Teleport_White_End_01_39e9b7e5-d0b2-d751-6aae-4e5e9351d556);
DB_WYR_Chess_TeleportVFX("Big", 0, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Big_Teleport_Black_Start_01_e30debac-e1be-2d1e-5e31-4d9e31246928, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Big_Teleport_Black_End_01_8c14f0f5-d49d-2e1a-329f-48fcbda7eefa);
DB_WYR_Chess_TeleportVFX("Big", 1, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Big_Teleport_White_Start_01_7c53fe00-68f1-cbc5-cbfc-2e9dafec86c6, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Big_Teleport_White_End_01_e05683cd-c3d1-f387-9a8f-cc659ad8c19c);
DB_WYR_Chess_TeleportVFX("Small",  0, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Small_Teleport_Black_Start_01_5c60f3f7-394a-2922-ccdc-f01cdd2118b5, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Small_Teleport_Black_End_01_915210da-899b-9ea1-6a35-2b38644aaa7b);
DB_WYR_Chess_TeleportVFX("Small",  1, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Small_Teleport_White_Start_01_efc87d57-b4c3-c0f1-0b3a-692adf534fd6,  (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Small_Teleport_White_End_01_b6d11896-9aa2-c768-6ef9-b3f3b86c0f32);

DB_WYR_Chess_CaptureVFX("Medium", 0, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Medium_Captured_Black_01_fc44819d-6094-8d49-9adc-17a8a63c1b6a);
DB_WYR_Chess_CaptureVFX("Medium", 1, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Medium_Captured_White_01_6b8ba2e7-a1c7-760d-8d22-c5a21040df7a);
DB_WYR_Chess_CaptureVFX("Big", 0, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Big_Captured_Black_01_dd1ef4c3-dec7-2384-ee93-78d1dece0991);
DB_WYR_Chess_CaptureVFX("Big", 1, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Big_Captured_White_01_b342d0cc-d549-3388-b540-635b72a213b4);
DB_WYR_Chess_CaptureVFX("Small", 0, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Small_Captured_Black_01_26ea37dc-bb35-6187-a781-04f538a977c5);
DB_WYR_Chess_CaptureVFX("Small", 1, (EFFECTRESOURCE)VFX_Script_PUZ_Wyrmway_Chess_Piece_Small_Captured_White_01_a609fa49-9c3a-70f6-804d-d8c27232e703);


DB_WYR_Chess_Piece((ITEM)S_WYR_Chess_Bishop1_cad61364-44fe-4647-a034-1370d359e139, (TAG)ACT3_WYR_CHESS_VALIDPOS1_2826afb6-6acc-431b-bf08-614cb1fd8906, 0, "Bishop", "Target_WYR_Chess_MovePiece1");
DB_WYR_Chess_Piece(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, (TAG)ACT3_WYR_CHESS_VALIDPOS2_cb1aa16e-f82b-4c31-bb1d-3e4354f8178c, 0, "King", "Target_WYR_Chess_MovePiece2");
DB_WYR_Chess_Piece(S_WYR_Chess_King2_92bff751-8119-4578-aa04-df3de5f122c7, (TAG)ACT3_WYR_CHESS_VALIDPOS3_4dba2eaa-fc50-43f9-8fca-a1083c525667, 1, "King", "Target_WYR_Chess_MovePiece3");
DB_WYR_Chess_Piece(S_WYR_Chess_Pawn1_9c9bf30a-b7e3-40d2-8ac9-2c7d47fd31ce, (TAG)ACT3_WYR_CHESS_VALIDPOS4_2a1ab916-179f-47e6-b9ae-0cb4cb4393f3, 0, "Pawn", "Target_WYR_Chess_MovePiece4");
DB_WYR_Chess_Piece(S_WYR_Chess_Pawn2_6b74d0f5-7e91-4ba3-bd25-1f9e69c6ecbf, (TAG)ACT3_WYR_CHESS_VALIDPOS5_f39e97bf-131d-47df-b0ea-b77781814a59, 0, "Pawn", "Target_WYR_Chess_MovePiece5");
DB_WYR_Chess_Piece(S_WYR_Chess_Pawn3_098f0870-5822-4e2d-ad58-5af344771da2, (TAG)ACT3_WYR_CHESS_VALIDPOS6_711bfaaa-b7f1-4e88-b25c-21c262e39791, 0, "Pawn", "Target_WYR_Chess_MovePiece6");
DB_WYR_Chess_Piece(S_WYR_Chess_Pawn4_b8875b9b-bf75-4e3b-8183-4af54cb15d59, (TAG)ACT3_WYR_CHESS_VALIDPOS7_e42ee9ed-00c7-4b5f-ba2d-5c74d4d8d835, 0, "Pawn", "Target_WYR_Chess_MovePiece7");
DB_WYR_Chess_Piece(S_WYR_Chess_Pawn5_37b94dba-fd17-4449-a16d-5ff33c8aea50, (TAG)ACT3_WYR_CHESS_VALIDPOS8_27a40a92-7e08-475f-9966-ca35b7d95eb9, 1, "Pawn", "Target_WYR_Chess_MovePiece8");
DB_WYR_Chess_Piece(S_WYR_Chess_Pawn6_35906485-36c5-448e-bd93-de38e01f9bca, (TAG)ACT3_WYR_CHESS_VALIDPOS9_c56a58c6-f041-4190-abc1-dbda5f5cd2e2, 1, "Pawn", "Target_WYR_Chess_MovePiece9");
DB_WYR_Chess_Piece(S_WYR_Chess_Pawn7_0a4c1566-7a15-49ce-b748-235460cfb6ef, (TAG)ACT3_WYR_CHESS_VALIDPOS10_3095740b-af8b-4c81-9372-32c331dbdd65, 1, "Pawn", "Target_WYR_Chess_MovePiece10");
DB_WYR_Chess_Piece(S_WYR_Chess_Queen1_6a97fad0-2cf0-4c38-a02a-daaf38c1e5e3, (TAG)ACT3_WYR_CHESS_VALIDPOS11_8e0860d4-f88d-4312-ba34-0619db70663f, 0, "Queen", "Target_WYR_Chess_MovePiece11");
DB_WYR_Chess_Piece(S_WYR_Chess_Queen2_5804b68f-8ebc-42e5-9507-c817a3af6d74, (TAG)ACT3_WYR_CHESS_VALIDPOS12_35886142-5e0c-4ac0-ad99-04a29546d9c9, 1, "Queen", "Target_WYR_Chess_MovePiece12");
DB_WYR_Chess_Piece(S_WYR_Chess_Rook1_ee91ac85-5b7a-4ffc-b64b-d7d3c19d9e4e, (TAG)ACT3_WYR_CHESS_VALIDPOS13_c3a239d5-8b3b-41bf-b5e5-06c4c8df3ebd, 1, "Rook", "Target_WYR_Chess_MovePiece13");
DB_WYR_Chess_Piece(S_WYR_Chess_Rook2_691987a5-d18e-421d-b4b3-a9ba44740398, (TAG)ACT3_WYR_CHESS_VALIDPOS14_308bb08a-8ef1-4285-a8c6-9cec22aa878b, 0, "Rook", "Target_WYR_Chess_MovePiece14");
DB_WYR_Chess_Piece(S_WYR_Chess_Bishop2_d3779d86-5a9a-4750-818b-086cc699bbcc, (TAG)ACT3_WYR_CHESS_VALIDPOS15_5a919708-f6a8-4aa0-a7ca-17858989ef37, 1, "Bishop", "Target_WYR_Chess_MovePiece15");
DB_WYR_Chess_Piece(S_WYR_Chess_Pawn8_7685e434-9fd1-42af-920a-9ec29a3d29c5, (TAG)ACT3_WYR_CHESS_VALIDPOS16_ef67c85c-7861-4e35-bd03-4e95d14f49e0, 1, "Pawn", "Target_WYR_Chess_MovePiece16");
DB_WYR_Chess_Piece(S_WYR_Chess_Knight1_b4534bb0-33ad-40e7-a4e5-6b64238979fe, ACT3_WYR_CHESS_VALIDPOS17_1bc7f496-38b3-4986-a9a7-b52f5c91979a, 1, "Knight", "Target_WYR_Chess_MovePiece17");
DB_WYR_Chess_Piece(S_WYR_Chess_Pawn9_b7d89f06-097e-4c4f-acf6-c23de424b04d, ACT3_WYR_CHESS_VALIDPOS18_9696d26c-f268-4b2f-b68f-a628fe598277, 0, "Pawn", "Target_WYR_Chess_MovePiece18");
DB_WYR_Chess_Piece(S_WYR_Chess_Rook3_18876404-9dfc-4d38-9208-5f0191d28b8d, ACT3_WYR_CHESS_VALIDPOS19_b10d148e-4b6b-4129-8276-f3f0eacfbccb, 0, "Rook", "Target_WYR_Chess_MovePiece19"); 

PROC_WYR_Chess_Setup();
//Unimplemented rules for now:
//Castling, promotions, and fairy pieces, blocking moves that place the player under check.

DB_WYR_Chess_KingHP(100, -1);

SetCanInteract(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, 1);


//END_REGION

//REGION Paintings - Justice

PROC_CharacterDisableAllCrimes((CHARACTER)S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d);

AddFogVolume(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d, S_WYR_ShadowFogVolume_5f2e0cea-8f31-42e5-b854-6bd16e1f2758);

TriggerRegisterForItems(S_WYR_PaintingPuzzle_Painting7Box_ab7fe099-886f-48b1-b9ba-38602b81b5e8);

DB_AD_Dialog(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d, (DIALOGRESOURCE)WYR_PaintingShadow1_AD_5ebf74af-b193-233b-aee8-7c3ce97049ab);

DB_Dialogs(S_WYR_PaintingPuzzle_Painting1_19922ba5-ff79-4a45-b7d0-861ff6c3abdb, WYR_PaintingPuzzle_Painting1_7f259770-41ed-1d3c-bca7-de0eecbba8df);
DB_Dialogs(S_WYR_PaintingPuzzle_Painting2_d0d74c34-9e95-4090-aa1f-db2d44b7a6c1, WYR_PaintingPuzzle_Painting2_d1cc45bb-52a0-baee-ae0d-28e262f6677b);
DB_Dialogs(S_WYR_PaintingPuzzle_Painting3_93ee2b8b-e9d8-441c-abc8-1eb5172b45d5, WYR_PaintingPuzzle_Painting3_f7c88515-2ace-364b-095a-33c9b29f02cc);
DB_Dialogs(S_WYR_PaintingPuzzle_Painting4_cfbd3cd2-3723-4672-a870-1dcb9f1071cb, WYR_PaintingPuzzle_Painting4_51a5722c-de5c-b710-4a45-b1781656459c);
DB_Dialogs(S_WYR_PaintingPuzzle_Painting5_3ca2a04d-c62b-4062-9770-5f1f45449dce, WYR_PaintingPuzzle_Painting5_9b2a85ad-a816-c6bd-c6eb-1a88004851e4);
DB_Dialogs(S_WYR_PaintingPuzzle_Painting6_a41d0e1e-aa7c-435a-868c-9520c4f58b60, WYR_PaintingPuzzle_Painting6_05b6b10f-e256-9bd4-68f1-bbacf39e2d41);

TriggerRegisterForCharacter(S_WYR_PaintingPuzzle_ShadowBox_51bb969b-c247-4dc9-8e0d-856190e79020, S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d);
PROC_TriggerRegisterForPlayers(S_WYR_PaintingPuzzle_ShadowDamage_ADTrigger_12fa0f4c-a673-4144-b463-9dbf8d74f357);

Transform(S_WYR_PaintingPuzzle_SolutionPainting1_Solved_05a742e1-efad-4f97-af99-47852aaf8bc8, S_WYR_PaintingPuzzle_SolutionPainting1_31746c94-4f33-4bc2-8348-5952c6bf0947, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
Transform(S_WYR_PaintingPuzzle_SolutionPainting2_Solved_800c97ea-3c4b-4fc4-bc91-f042c6047e93, S_WYR_PaintingPuzzle_SolutionPainting2_b878885e-8efa-42c7-a9bd-8238e08d5fad, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);

DB_WYR_PaintingPuzzle_SolutionPaintings((ITEM)S_WYR_PaintingPuzzle_SolutionPainting1_31746c94-4f33-4bc2-8348-5952c6bf0947, (ITEM)S_WYR_PaintingPuzzle_SolutionPainting1_Solved_05a742e1-efad-4f97-af99-47852aaf8bc8, (TRIGGER)S_WYR_PaintingPuzzle_SolutionPainting1Box_8126be9d-9c0e-473e-b04f-83756eb34334, (DIALOGRESOURCE)WYR_PaintingPuzzle_SolutionPainting1_AD_8620082c-d28d-e57b-8244-3a288a460123, (DIALOGRESOURCE)WYR_PaintingPuzzle_SolutionPainting1_762868ae-8a3a-4b4f-8f5c-a4fc1b51af1a, "WYR_Wyrmway_SolutionPainting1Name");
DB_WYR_PaintingPuzzle_SolutionPaintings((ITEM)S_WYR_PaintingPuzzle_SolutionPainting2_b878885e-8efa-42c7-a9bd-8238e08d5fad, (ITEM)S_WYR_PaintingPuzzle_SolutionPainting2_Solved_800c97ea-3c4b-4fc4-bc91-f042c6047e93, (TRIGGER)S_WYR_PaintingPuzzle_SolutionPainting2Box_90659c16-e494-4ea6-83e6-7ed8d6823261, (DIALOGRESOURCE)WYR_PaintingPuzzle_SolutionPainting2_AD_25b67b70-826b-18c8-233d-7a3c7ef4062c, (DIALOGRESOURCE)WYR_PaintingPuzzle_SolutionPainting2_f4b73081-4a3b-b6dc-17ee-14d1d215c153, "WYR_Wyrmway_SolutionPainting2Name");
DB_WYR_PaintingPuzzle_SolutionPaintings((ITEM)S_WYR_PaintingPuzzle_SolutionPainting3_38e88703-d24d-462e-8032-98a2d77465d4, (ITEM)S_WYR_PaintingPuzzle_SolutionPainting3_Solved_9a7d7b30-c119-43d4-9408-2049283a1be1, (TRIGGER)S_WYR_PaintingPuzzle_SolutionPainting3Box_d03be200-56bf-43fa-90d3-07c83eb9844e, (DIALOGRESOURCE)WYR_PaintingPuzzle_SolutionPainting3_AD_6c95de36-eac9-6c10-0a74-5cd795bcf5d3, (DIALOGRESOURCE)WYR_PaintingPuzzle_SolutionPainting3_688f4681-108f-70d9-e50e-99191946403b, "WYR_Wyrmway_SolutionPainting3Name");

//END_REGION

//REGION Indicators

PROC_DeclareCounter("WYR_Wyrmway_Successes");
PROC_DeclareCounter("WYR_Wyrmway_Failures");
PROC_DeclareCounter("WYR_Wyrmway_Entered");

DB_WYR_WyrmwayTrials_EnterThresholds(1, (FLAG)WYR_WyrmwayTrials_State_SolvedOnePuzzle_9aebc6cb-84a4-4790-915f-5f98383d69c3, (FLAG)WYR_WyrmwayTrials_State_OneCanEnter_5874c39e-cfad-4a39-81b8-d1b63bc752cb);
DB_WYR_WyrmwayTrials_EnterThresholds(2, (FLAG)WYR_WyrmwayTrials_State_SolvedTwoPuzzles_5974e22d-b353-4d44-b31f-0e0f17623d3a, (FLAG)WYR_WyrmwayTrials_State_TwoCanEnter_2edffd5f-a69e-4b42-9cb3-34c1c83df708);
DB_WYR_WyrmwayTrials_EnterThresholds(3, (FLAG)WYR_WyrmwayTrials_State_SolvedThreePuzzles_ac62a418-f25e-4df3-90ac-915e9907e861, (FLAG)WYR_WyrmwayTrials_State_ThreeCanEnter_3b865de6-f79d-4903-9dbe-396f2360d60f);
DB_WYR_WyrmwayTrials_EnterThresholds(4, (FLAG)WYR_WyrmwayTrials_State_AllSucceeded_af019736-1d77-4609-a33b-dcd8360e5191, (FLAG)WYR_WyrmwayTrials_State_FourCanEnter_20d1b51c-760b-4630-97a9-b8da34a33c14);


/*
List of indicator statues - 
Statue (in the puzzle room), followed by the tracker in the main room (for the 'main' statue only, i.e. destroying this statue fails the puzzle),
followed by the trigger, if the statue speaks on entering a trigger, followed by the dialogue which is played when entering that trigger or clicking
on that statue, followed by an identifier to group these by puzzle.
*/

DB_WYR_Wyrmway_IndicatorStatues((ITEM)S_WYR_Chess_Statue3_9485f592-77fc-4039-92f8-6e4dcc6640f7, (ITEM)S_WYM_Wyrmway_ChessIndicator_538106f6-079a-4965-bb1b-1d8c3ee86279, (ITEM)S_WYR_Wyrmsway_ChessSuccessIndicator_f5b6c61a-051e-4208-aade-f91270e04d65, (DIALOGRESOURCE)WYR_Chess_Rules_86b5f4f9-ae02-21c4-3f89-f64e7b8ac1e8, (DIALOGRESOURCE)WYR_Chess_AD_Success_b8139c88-ba8f-febd-3216-ba83228a49c5, "WYM_Wyrmway_Chess");
DB_WYR_Wyrmway_IndicatorStatues((ITEM)S_WYR_InsightTest_Instructor_666740c1-a97d-4cbc-b049-bf6902099a3f, (ITEM)S_WYM_Wyrmway_InsightIndicator_18695bfb-f9db-40b4-9783-ce275b37d5ca, (ITEM)S_WYR_Wyrmsway_InsightSuccessIndicator_e0299564-23d6-43fd-beff-81c2964d65ac, (DIALOGRESOURCE)WYR_InsightPuzzle_Rules_9a5ed579-7bb7-fa69-a67b-976ff9cbf290, (DIALOGRESOURCE)WYR_InsightPuzzle_AD_Success_c9b56351-c619-ae54-708e-7e82aeecc3ea, "WYM_Wyrmway_InsightPuzzle");
DB_WYR_Wyrmway_IndicatorStatues((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12, (ITEM)S_WYM_Wyrmway_CourageIndicator_d020f6ee-1acf-4027-966e-f9049746452f, (ITEM)S_WYR_Wyrmsway_CourageSuccessIndicator_c9d88152-33ce-4935-ad4a-5a5c9f8c6943, (DIALOGRESOURCE)WYR_CouragePuzzle_Rules_9e329103-ccac-ac45-46e0-f523d1166828, (DIALOGRESOURCE)WYR_CouragePuzzle_AD_Success_f8c4351f-3c86-6ed0-cfb2-5453378c765a, "WYM_Wyrmway_CouragePuzzle");
DB_WYR_Wyrmway_IndicatorStatues((ITEM)S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982, (ITEM)S_WYM_Wyrmway_PaintingIndicator_895796b9-5937-49f4-920e-7b7e4ed9d6b0, (ITEM)S_WYR_Wyrmsway_PaintingSuccessIndicator_dca29a65-3255-40ec-9a28-0fe88306dbc1, (DIALOGRESOURCE)WYR_PaintingPuzzle_Rules_2d25fb30-9e9e-aa1d-7f75-292c1d382be7, (DIALOGRESOURCE)WYR_PaintingPuzzle_AD_Success_e601d4f7-6203-d125-de3f-b4287cf08b00, "WYR_Wyrmway_PaintingPuzzle");

DB_WYR_Wyrmway_StatuePredeathDialog((ITEM)S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982, (DIALOGRESOURCE)WYR_PaintingPuzzle_AD_Fail_8ea2770a-1347-f6a3-8b6b-c33bd308f387);
DB_WYR_Wyrmway_StatuePredeathDialog((ITEM)S_WYR_InsightTest_Instructor_666740c1-a97d-4cbc-b049-bf6902099a3f, (DIALOGRESOURCE)WYR_InsightPuzzle_AD_Fail_37f4347c-b7b4-41e1-c268-d78faed175cc);
DB_WYR_Wyrmway_StatuePredeathDialog((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12, (DIALOGRESOURCE)WYR_CouragePuzzle_AD_Fail_34164521-d218-1bdc-37d3-82f7ea46f6ad);
//Defined below, when the statue is destroyed: DB_WYR_Wyrmway_StatuePredeathDialog((ITEM)S_WYR_Chess_Statue3_9485f592-77fc-4039-92f8-6e4dcc6640f7, (DIALOGRESOURCE)WYR_Chess_AD_Fail_aa987e74-3544-ec64-2058-da339fcf8d25); 

PROC_TriggerRegisterForParty(S_WYR_CentralPlatform_12b01eaf-8039-40f7-b147-42b20126ed0e);

DB_WYR_Wyrmway_SuccessFlag((ITEM)S_WYR_Chess_Statue3_9485f592-77fc-4039-92f8-6e4dcc6640f7, (FLAG)WYR_Chess_State_Succeeded_fe3b0e63-6f5f-4683-4fa9-3bca0f878470);
DB_WYR_Wyrmway_SuccessFlag((ITEM)S_WYR_InsightTest_Instructor_666740c1-a97d-4cbc-b049-bf6902099a3f, (FLAG)WYR_InsightPuzzle_State_Succeeded_379b403f-502a-e979-a3cc-f3bff8f83bed);

//END_REGION

//REGION Insight

DB_WYR_InsightPuzzle_Suspect((CHARACTER)S_WYR_InsightPuzzle_Suspect2_78df67f2-93c0-48b4-8c15-7edbaea1abf7, 0);
DB_WYR_InsightPuzzle_Suspect((CHARACTER)S_WYR_InsightPuzzle_Suspect3_ce9cd75e-c8c8-46d2-80e5-f1cde42ee42c, 0);
DB_WYR_InsightPuzzle_Suspect((CHARACTER)S_WYR_InsightPuzzle_Suspect1_2d8b3b34-8856-4adc-8cde-349e1f281674, 1);
PROC_CharacterDisableAllCrimes((CHARACTER)S_WYR_InsightPuzzle_Suspect1_2d8b3b34-8856-4adc-8cde-349e1f281674);
PROC_CharacterDisableAllCrimes((CHARACTER)S_WYR_InsightPuzzle_Suspect2_78df67f2-93c0-48b4-8c15-7edbaea1abf7);
PROC_CharacterDisableAllCrimes((CHARACTER)S_WYR_InsightPuzzle_Suspect3_ce9cd75e-c8c8-46d2-80e5-f1cde42ee42c);


DB_WYR_InsightPuzzle_Birds((CHARACTER)S_WYR_InsightPuzzle_Bird1_bc57916f-d2c6-42ee-83d7-465baf5a2746, (ITEM)S_WYR_InsightPuzzle_Hint2_64082582-01ac-4f30-b873-aa4554fb7881);
DB_WYR_InsightPuzzle_Birds((CHARACTER)S_WYR_InsightPuzzle_Bird2_72e60f3a-dbab-4d49-afb0-f4932667d4c2, S_WYR_InsightPuzzle_Hint3_d697147b-159f-4329-b6e9-e31311c9dde0);
DB_WYR_InsightPuzzle_Birds((CHARACTER)S_WYR_InsightPuzzle_Bird3_8af02eb1-d632-49de-99e0-846a05fa757c, S_WYR_InsightPuzzle_Hint6_ed43632d-49c6-4a50-bd00-bbd6dffcfc66);

PROC_WYR_InsightPuzzle_Setup();

//END_REGION

//REGION Courage

DB_WYR_CourageTrial_Enemies(0, (CHARACTER)S_WYR_CourageTest_Myrmidon1_f76893c2-c5ad-4124-8e45-472241a3671e);
DB_WYR_CourageTrial_Enemies(0, (CHARACTER)S_WYR_CourageTest_Myrmidon5_b403ca05-2642-40f8-ab4f-7fb2efa7f7fc);
DB_WYR_CourageTrial_Enemies(2, (CHARACTER)S_WYR_CourageTest_Myrmidon2_bb1b1c58-cc61-47e0-9bc9-d1463553d6fa);
DB_WYR_CourageTrial_Enemies(2, (CHARACTER)S_WYR_CourageTest_Myrmidon6_ce4ff3ce-29ef-47a4-8214-8449a59bffd9);
DB_WYR_CourageTrial_Enemies(3, (CHARACTER)S_WYR_CourageTest_Myrmidon3_8a6b3d1d-49da-431b-90e7-a87e7bdb8394);
DB_WYR_CourageTrial_Enemies(3, (CHARACTER)S_WYR_CourageTest_Myrmidon7_3fbdb287-a564-48d4-ab22-2b1028d9fc60);
DB_WYR_CourageTrial_Enemies(4, (CHARACTER)S_WYR_CourageTest_Myrmidon4_e081f0a7-5ec2-4a29-b045-a09d13c20171);
DB_WYR_CourageTrial_Enemies(4, (CHARACTER)S_WYR_CourageTest_Myrmidon8_ce2bb9f5-a90b-4a9c-ac98-ad1ee33b3f4c);

DB_WYR_CourageTrial_Torches(4, S_WYR_CourageTest_TrialMarker1_c2ed5d9b-ef3d-49fe-baf3-3eb2c40b3a17, "WYR_CourageTest_Light1");
DB_WYR_CourageTrial_Torches(1, S_WYR_CourageTest_TrialMarker2_dd10e10f-4f9c-424d-8bd5-8e2c08cdea25, "WYR_CourageTest_Light2");
DB_WYR_CourageTrial_Torches(2, S_WYR_CourageTest_TrialMarker3_371ab073-818e-43b1-baa1-319f4d01efed, "WYR_CourageTest_Light3");
DB_WYR_CourageTrial_Torches(3, S_WYR_CourageTest_TrialMarker4_9bf53f78-9162-4e22-9ac5-45ba0d039610, "WYR_CourageTest_Light4");


ApplyStatus(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, "GROUNDED", -1.0, 1, S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);

//END_REGION

//REGION Environmental PADs

DB_KnowledgeCheckItem_AD("WYR_Wyrmway_Mural", S_WYR_Wyrmway_MuralHelper1_10d03fb5-7dd2-46b8-bee4-1243e108f923, "History", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, (DIALOGRESOURCE)WYR_Wyrmway_Mural_PAD_d6a99594-a501-3f7c-1624-3003f81ec763, (FLAG)WYR_Wyrmway_MuralHelper1_Knows_MadeCheck_dd41db78-064e-b8b4-5a9a-8dd9271b7fb0);
DB_KnowledgeCheckItem_AD("WYR_Wyrmway_Mural", S_WYR_Wyrmway_MuralHelper2_12e8cbb3-a1bb-4237-9ede-e5548a847a6f, "History", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, (DIALOGRESOURCE)WYR_Wyrmway_Mural2_PAD_30389bd4-a945-636a-5a99-129403a02bbf, (FLAG)WYR_Wyrmway_MuralHelper1_Knows_MadeCheck_dd41db78-064e-b8b4-5a9a-8dd9271b7fb0);
DB_KnowledgeCheckItem_AD("WYR_Wyrmway_Mural", S_WYR_Wyrmway_MuralHelper3_c47f0c5e-d251-4c0f-81f7-3cab1689a783, "History", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, (DIALOGRESOURCE)WYR_Wyrmway_Mural3_PAD_0581c139-cffc-2fe1-1e7d-f4d75a0ae794, (FLAG)WYR_Wyrmway_MuralHelper1_Knows_MadeCheck_dd41db78-064e-b8b4-5a9a-8dd9271b7fb0);



DB_OneShot_VoiceBarkTrigger(S_WYR_Wyrmway_VB_Arrival_54b5a191-e83d-4cf5-9901-64705e74147a, (VOICEBARKRESOURCE)WYR_Wyrmway_VB_Arrival_6747f079-91e9-c516-ac9d-b8312d0b3a9b, "PerUserAndNearbyPlayers", S_WYR_Wyrmway_Arrival_Past_8aa4fe87-d29b-472b-a7f8-c00b5bc63867);
DB_OneShot_VoiceBarkTrigger(S_WYR_PaintingPuzzle_VB_Entrance_a2622d35-9206-42dd-a92c-f8ce3064676e, WYR_PaintingPuzzle_VB_Entrance_254145fc-0f7f-a2c8-9454-756b812aeb4f, "PerUserAndNearbyPlayers",  S_WYR_PaintingPuzzle_VB_Entrance_Cancel_3c8abffd-ab33-47cd-88db-c8bf971396c9);
DB_OneShot_VoiceBarkTrigger(S_WYR_Chess_VB_Entrance_fd7da93e-329b-4770-af80-a40c41fe4818, WYR_Chess_VB_Entrance_dfedcfdd-99c8-314c-76fc-049afd152678, "PerUserAndNearbyPlayers",  S_WYR_Chess_VB_Entrance_Past_bb496ad0-e144-43cb-ab85-4ef5742f95f7);

DB_WYR_WyrmwayPuzzleVBs((TRIGGER)S_WYR_PaintingPuzzle_VB_Entrance_a2622d35-9206-42dd-a92c-f8ce3064676e, "WYR_Wyrmway_PaintingPuzzle");
DB_WYR_WyrmwayPuzzleVBs(S_WYR_Chess_VB_Entrance_fd7da93e-329b-4770-af80-a40c41fe4818, "WYM_Wyrmway_Chess");

//END_REGION

//REGION Balduran's Ghost

SetOnStage(S_WYR_Balduran_97b22123-6825-4b24-8c47-437b0774e7a1, 0);

DB_WYR_Wyrmway_Setup(1);

//END_REGION

SetCanInteract((ITEM)S_WYR_Wyrmway_AccessDoor_52b29031-e2aa-48b0-9a8f-62b6b64591f4, 0);


//REGION Balduran's Helmet

DB_HasItemEvent((ITEM)S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0, (FLAG)WYR_BalduranHelmet_State_HasItem_8b3fbbae-a2f3-4da4-a0ef-9f8dd5a5aa38);

//END_REGION

//REGION Balduran guiding players through the area

DB_Dialogs((ITEM)S_WYR_EntranceStatue_750036f3-7abc-41b8-8cd0-9b977500d5b3, (DIALOGRESOURCE)WYR_EntranceStatue_21a578ec-2d9e-41c6-4a08-2a264113e37c);
SetOnStage(S_WYR_FinalRoomEntrance_Statue_2867a964-6f66-46a0-b430-ec28a1b1d04d, 0);
DB_Dialogs(S_WYR_FinalRoomEntrance_Statue_Indestructible_3bcbf351-946b-4c72-b313-ce4b491b5902,  WYR_FinalRoomEntrance_Statue_fb1b38bf-70e0-e884-5d5d-c014b0163557);

//END_REGION

//REGION Skeletal dragon

SetVisible(S_WYR_SkeletalDragonBlocker_67511a5c-75f8-496c-81c6-17d4820c2b38, 0);

SetVisible(S_WYR_SkeletalDragonBlocker_000_bdf56ccd-6990-4988-a9ee-792f9fc69a24, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_001_68f502f3-0833-4d48-ac34-38f800a54c63, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_002_342df486-09b7-4259-bc4e-ddc96a010571, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_003_2826c2c1-f846-4320-a76a-8b88558773dc, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_004_6bcdd409-9503-4b1b-a69f-b284b2e4b644, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_005_50bbde3b-48a2-4dcd-be67-f19f612372b3, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_006_e49292d1-3320-47ad-a0a1-c6aea3b839c1, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_007_7215d6ab-0c4f-4c6c-84fe-8a087152078d, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_008_a11d3452-8ac9-4441-8077-54e8d30c046e, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_009_e7162ac4-22f9-4c15-8afb-2a4817982c4d, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_010_b22845fa-8463-4b71-bb25-4e9bc68376e9, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_011_ada3a431-2465-40c6-a380-9afac2bcd128, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_012_c6a9a13e-3fb6-4b88-a6c9-5b7180d463ed, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_014_0ea74d6a-1644-40e2-9fb5-6e88b8445536, 0);
SetVisible(S_WYR_SkeletalDragonBlocker_015_cf2f3042-76d5-4868-b8f5-20413f1b52e5, 0);

SetOnStage((CHARACTER)S_WYR_AnsurGhost_4be5ac7c-2ce0-4e9a-9526-d16d3e4db2d2, 0);

DB_State_Priority(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "Dead", 1000);
DB_State_Priority(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "Risen", 2000);
DB_State_Priority(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "DeadAgain", 3000);

DB_State_Current(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "Dead");

DB_CanBeResurrected(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a);
Die(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 0.0);
SetVisible(S_WYR_CourageTest_WaterSpawner_01_393e4d51-fff6-4a23-8b89-ad8afd61aa76,0);
SetVisible(S_WYR_SkeletalDragon_WaterSpawner_1_0a58b1a1-348b-4f6d-a643-773f04c02b84,0);
SetVisible(S_WYR_SkeletalDragon_WaterSpawner_2_ce98e028-ba03-44eb-a0c7-cbde7517ac02,0);
SetVisible(S_WYR_SkeletalDragon_WaterSpawner_3_5f602d28-1142-41e2-bea2-b1f6e1797403,0);
SetVisible(S_WYR_SkeletalDragon_WaterSpawner_4_cd2b03ee-6da8-4074-9824-3e1246d08175,0);
SetOnStage(S_WYR_SkeletonDragon_Minion_01_9bb09a03-955a-4ecb-b1ea-4a5d83ec2b7e,0);
SetOnStage(S_WYR_SkeletonDragon_Minion_02_df015249-8648-46a7-9fe7-8ea64342eb59,0);
DB_Combat_Dragon_ProxyOwner((CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_WYR_SkeletalDragon_HitProxy_BackLeg_Left_9cc444d3-ad64-42f0-8149-f776954e7b4e, "WYR_SkeletalDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_WYR_SkeletalDragon_HitProxy_BackLeg_Right_d43c67c3-bdcd-4414-a3b4-19d770ff4838, "WYR_SkeletalDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_WYR_SkeletalDragon_HitProxy_FrontLeg_Left_aae1b4ed-ff9a-476a-b1ac-e7733f7342ef, "WYR_SkeletalDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_WYR_SkeletalDragon_HitProxy_FrontLeg_Right_93411434-d191-43c6-abfb-121f14bd3198, "WYR_SkeletalDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_WYR_SkeletalDragon_HitProxy_Head_2d266951-c8de-4938-a1a8-832ddfe9ad73, "WYR_SkeletalDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_WYR_SkeletalDragon_HitProxy_Tail_a051b246-1ae8-4019-93a6-14ff249fd283, "WYR_SkeletalDragon");
DB_WYR_SkeletalDragon_MaxLightningStrikes(2);



//END_REGION

//REGION Fail a single trial - shortcut in

DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_000_487f9e3d-8d34-45b3-bb47-a3f956e6578d);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_007_e8c114de-4350-4b8b-aa09-645b5aaec7f3);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_001_370171b4-1740-48e1-9208-b6df397524fa);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_002_318690af-cad4-484d-b7ce-6f260bff1dea);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_003_6b806cf1-91ee-45d4-a10a-7a20e5308128);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_004_0a38a3bc-7e62-4f46-888d-a597e287d394);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_005_b1dbe85e-7c6c-496a-a8f5-8a890dad8db9);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_006_7c7df1a0-3f5d-41fa-98b6-27da6e7046cb);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_015_f8250eb8-e6e6-4ca9-b103-21382a5478a5);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_008_dd31c8a6-51b3-4a12-856d-60441396aa67);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_009_1d2a929c-ca32-461b-97d5-e117bce68775);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_010_5f4e5fc6-1e40-4e87-87ec-0ed8c00c91ed);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_011_84bd785a-d74e-416f-8355-8b6569e92b6a);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_012_620809ae-6afa-4b56-9434-727dd9da8e6d);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_013_c7710aab-9c59-4a3d-9c84-910a57842cef);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_014_6dc31bde-63db-472a-ae9d-58851dd0efd8);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_013_20010a19-e43b-49fc-99fc-346e7fb7d33a);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_016_a70fc840-b1c4-4afb-b86e-8e50ee8e8ba7);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_017_35bd5877-419a-489e-87c8-4cdaca758179);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_018_54fbd8ae-3141-4812-b992-9c5d6f61de0e);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_019_fe93db0d-162a-4a48-a5cd-fb4ae0988482);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_020_23b8e4d1-edbb-461f-adec-2e4025f8ece1);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_021_f61d948b-26c8-4022-8b20-3ff6540d6480);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_022_e34a01fa-3722-4fe6-95f7-3e628a1bb4a7);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_023_0235346a-a6c4-404c-aa58-2acb1e1b6edb);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_024_aee318d3-62b8-4b9c-95f4-51b67f220888);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_025_34109004-4e2a-4197-9802-9d360766da7e);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_026_f2ca60b7-feea-4a2b-80d7-5916b2aa4027);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_027_b88bedfd-30df-40cd-8513-47151ba4d5b9);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_028_6f0b51e5-0d95-417f-bfe2-3cdd46c65e4d);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_029_0617428e-a5e5-4d7a-981d-d2a6fcfa1b99);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_030_b8280b37-4132-4434-b842-2b04970ba19e);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_031_3eead152-dd22-4f37-abdd-daf56319f810);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_032_1cd7e93c-4be0-4c63-97aa-96902fc7c383);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_033_f01b73e9-d205-4e2f-b536-fe3715d0cbd1);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_034_ade5a168-0030-49f7-8406-e6d22fb31a73);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_035_a8d19521-856a-45a0-8dbd-0de80227c877);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_036_05c3e326-5390-4a3e-9dda-332e86d43a36);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_037_769660a4-2745-416b-990b-76f8e968a8bd);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_038_104a7a2d-b546-4c4e-b1f5-76cf4702daf3);
DB_WYR_Wyrmsway_FailSkeletons((CHARACTER)S_WYR_Wyrmsway_FailSkeleton_039_265972ca-3ea0-4cf1-b671-d9143671051a);

//END_REGION

DB_OneShot_VoiceBarkTrigger(S_WYR_SkeletalDragon_AD_Noticed_1f2747d2-cb1c-4fff-b788-869bda9e0d74, WYR_SkeletalDragon_VB_NotSent_a0085eb5-0caf-d855-66f4-9b4d5e03997e);

DB_TopicalGreeting((FLAG)TG_WYR_Wyrmway_32db8446-492b-46f9-81d1-57f220c78be8);

SetVisible(S_WYR_SkeletalHelmetBlocker_02_91f115a3-034c-4c8a-91fa-e65de495fc9f, 0);
SetVisible(S_WYR_SkeletalHelmetBlocker_01_9d8d47eb-26af-4e18-b367-f7311d0b858d, 0);

NOT DB_WYR_CourageTest_Tester((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

DB_DropMutingStatussesDialog(WYR_AnsurGhost_HelmetPickup_7fe755b8-967a-f495-7e06-de5d4122960e);

SetOnStage(S_WYR_SkeletalDragonBlocker_67511a5c-75f8-496c-81c6-17d4820c2b38, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_001_68f502f3-0833-4d48-ac34-38f800a54c63, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_002_342df486-09b7-4259-bc4e-ddc96a010571, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_003_2826c2c1-f846-4320-a76a-8b88558773dc, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_004_6bcdd409-9503-4b1b-a69f-b284b2e4b644, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_005_50bbde3b-48a2-4dcd-be67-f19f612372b3, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_006_e49292d1-3320-47ad-a0a1-c6aea3b839c1, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_007_7215d6ab-0c4f-4c6c-84fe-8a087152078d, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_008_a11d3452-8ac9-4441-8077-54e8d30c046e, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_009_e7162ac4-22f9-4c15-8afb-2a4817982c4d, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_010_b22845fa-8463-4b71-bb25-4e9bc68376e9, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_011_ada3a431-2465-40c6-a380-9afac2bcd128, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_012_c6a9a13e-3fb6-4b88-a6c9-5b7180d463ed, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_014_0ea74d6a-1644-40e2-9fb5-6e88b8445536, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_015_cf2f3042-76d5-4868-b8f5-20413f1b52e5, 0);
KBSECTION
//REGION Entrance murals
IF
UseStarted(_Character, _Painting)
AND
DB_KnowledgeCheckItem_AD("WYR_Wyrmway_Mural", _Painting, _, _, _, _)
AND
DB_DialogSpeakers(_ID, _Character, _)
AND
DB_DialogName(_Dialog, _AD)
AND
DB_KnowledgeCheckItem_AD("WYR_Wyrmway_Mural", _, _, _, _Dialog, _)
THEN
PROC_ForceStopDialog(_Character);

QRY
QRY_GLO_SkillCheck_CheckAdvantage(_Character, _, "WYR_Wyrmway_Mural")
AND
IsTagged(_Character, (TAG)BALDURIAN_f15e9b0d-676c-4f52-9abf-365cff89ef0f, 1)
THEN
DB_QRYRTN_GLO_Skillcheck_CheckAdvantage(2);

QRY
QRY_GLO_SkillCheck_CheckAdvantage(_Character, _, "WYR_Wyrmway_Mural")
AND
IsTagged(_Character, (TAG)BALDURIAN_f15e9b0d-676c-4f52-9abf-365cff89ef0f, 0)
AND
IsTagged(_Character, (TAG)REALLY_PLANAR_4cb02915-7ad7-4141-907e-93253c6a8644, 1)
THEN
DB_QRYRTN_GLO_Skillcheck_CheckAdvantage(-1);

PROC
PROC_GLO_KnowledgeCheckEnded((CHARACTER)_Character, "WYR_Wyrmway_Mural", _, _, _)
THEN
SetFlag((FLAG)WYR_EntranceStatue_State_Attempted_67cdf8c3-6e77-e1f2-f891-f4217b0372c0, _Character, 0);

IF
FlagSet((FLAG)WYR_EntranceStatue_State_Attempted_67cdf8c3-6e77-e1f2-f891-f4217b0372c0, _Character, _ID)
AND
_ID != 0
AND
NOT QRY_GLO_KnowledgeCheck_Done((CHARACTER)_Character, "WYR_Wyrmway_Mural")
AND
GetFlag(WYR_Wyrmway_MuralHelper1_Knows_MadeCheck_dd41db78-064e-b8b4-5a9a-8dd9271b7fb0, NULL_00000000-0000-0000-0000-000000000000, _Success)
THEN
PROC_GLO_KnowledgeCheck_ForceComplete((CHARACTER)_Character, "WYR_Wyrmway_Mural", NULL_00000000-0000-0000-0000-000000000000, _Success);




//END_REGION

//REGION Chess Puzzle

//REGION Chess Puzzle setup


//DEBUG
IF
TextEvent("WYR_Chess_Setup")
AND
DB_WYR_Chess_Solution(_OldVar, _Tile1, _Tile2)
THEN
NOT DB_WYR_Chess_Solution(_OldVar, _Tile1, _Tile2);

IF
TextEvent("WYR_Chess_Setup")
AND
DB_WYR_Chess_Variant(_OldVar)
THEN
NOT DB_WYR_Chess_Variant(_OldVar);

IF
TextEvent("WYR_Chess_Setup")
AND
GetTextEventParamInteger(1, _Var)
THEN
DB_WYR_Chess_Variant(_Var);

IF
TextEvent("WYR_Chess_Setup")
THEN
PROC_WYR_Chess_Setup();

IF
DB_WYR_Chess_Variant(_Var)
AND
DB_WYR_Chess_SetupFlag(_Var, _Flag)
AND
NOT DB_GlobalFlag(_Flag)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

IF
DB_WYR_Chess_Variant(_Var)
AND
DB_GlobalFlag(_Flag)
AND
DB_WYR_Chess_SetupFlag(_OtherVar, _Flag)
AND
_OtherVar != _Var
THEN
PROC_GlobalClearFlagAndCache(_Flag);

PROC
PROC_WYR_Chess_Setup()
AND
NOT DB_WYR_Chess_Variant(_)
AND
Random(3, _Rand)
AND
IntegerSum(_Rand, 1, _Var)
THEN
DB_WYR_Chess_Variant(_Var);

PROC
PROC_WYR_Chess_Setup()
THEN
DB_WYR_Chess_PlayerSide(1);

PROC
PROC_WYR_Chess_Setup()
AND
DB_WYR_Chess_Variant(_Var)
THEN
PROC_WYR_Chess_Setup(_Var);

PROC
PROC_WYR_Chess_Setup(1)
THEN
DB_WYR_Chess_Solution(1, (ITEM)S_WYR_Chess_6f_84dd40fc-a9dc-4209-825c-d9f478ce003a, (ITEM)S_WYR_Chess_8h_19156154-800b-4a78-91e0-c792d023710f);
DB_WYR_Chess_Solution(2, S_WYR_Chess_8f_52600863-67a1-45c2-9ea7-92de057fd89f, S_WYR_Chess_7e_323fb635-ae7d-4161-aa6c-cb4abf225b60);
DB_WYR_Chess_Solution(3, S_WYR_Chess_8h_19156154-800b-4a78-91e0-c792d023710f, S_WYR_Chess_8d_4b5eb922-096b-4739-9421-0522455f1431);

PROC
PROC_WYR_Chess_Setup(2)
THEN
DB_WYR_Chess_Solution(1, (ITEM)S_WYR_Chess_6a_d06364d5-4693-4c7e-9275-4a767efa8074, (ITEM)S_WYR_Chess_6h_bcd3d5b1-4df5-49ce-96a4-599ad98cb39f);
DB_WYR_Chess_Solution(2, (ITEM)S_WYR_Chess_8h_19156154-800b-4a78-91e0-c792d023710f, (ITEM)S_WYR_Chess_8g_bab3ce08-7cc7-4e67-9b20-acdb1d6ba9ad);
DB_WYR_Chess_Solution(3, (ITEM)S_WYR_Chess_6h_bcd3d5b1-4df5-49ce-96a4-599ad98cb39f, (ITEM)S_WYR_Chess_7g_fa70fb99-ddaf-4b3b-bc62-430b338e962c);


PROC
PROC_WYR_Chess_Setup(3)
THEN
DB_WYR_Chess_Solution(1, (ITEM)S_WYR_Chess_8f_52600863-67a1-45c2-9ea7-92de057fd89f, (ITEM)S_WYR_Chess_8g_bab3ce08-7cc7-4e67-9b20-acdb1d6ba9ad);
DB_WYR_Chess_Solution(2, (ITEM)S_WYR_Chess_7f_1f19ebf3-2e96-469d-b4c4-e7f205d11d1b, (ITEM)S_WYR_Chess_8g_bab3ce08-7cc7-4e67-9b20-acdb1d6ba9ad);
DB_WYR_Chess_Solution(3, (ITEM)S_WYR_Chess_7d_3eb095eb-e7a6-449c-8179-e0eeeeab44c5, (ITEM)S_WYR_Chess_7g_fa70fb99-ddaf-4b3b-bc62-430b338e962c);

PROC
PROC_WYR_Chess_Setup(4)
THEN
DB_WYR_Chess_Solution(1, (ITEM)S_WYR_Chess_5e_a46df296-b88e-40d8-96d9-003bffd1b374, (ITEM)S_WYR_Chess_7g_fa70fb99-ddaf-4b3b-bc62-430b338e962c);
DB_WYR_Chess_Solution(2, (ITEM)S_WYR_Chess_6h_bcd3d5b1-4df5-49ce-96a4-599ad98cb39f, (ITEM)S_WYR_Chess_5h_e5999c28-f0bb-43c2-9210-02c86bb57421);
DB_WYR_Chess_Solution(3, (ITEM)S_WYR_Chess_7g_fa70fb99-ddaf-4b3b-bc62-430b338e962c, (ITEM)S_WYR_Chess_7h_31379a5c-dca1-4939-b112-7b64c91de56b);


//Piece locations
PROC
PROC_WYR_Chess_Setup((INTEGER)_Integer)
AND
DB_WYR_Chess_StartPos(_Integer, _Piece, _Tile)
AND
NOT DB_WYR_Chess_OnTile(_Piece, _Tile)
THEN
DB_WYR_Chess_Setup_WaitingFor(_Piece);
PROC_WYR_Chess_VFXMoveTo(_Tile, _Piece, "Setup");

//Update location
PROC
PROC_WYR_Chess_DoMoveTo(_, (ITEM)_Tile, (ITEM)_Piece, "Setup")
THEN
NOT DB_WYR_Chess_Setup_WaitingFor(_Piece);

PROC
PROC_WYR_Chess_DoMoveTo(_, (ITEM)_Tile, (ITEM)_Piece, "Setup")
AND
NOT DB_WYR_Chess_Setup_WaitingFor(_)
THEN
PROC_WYR_Chess_FinishSetup();

PROC
PROC_WYR_Chess_FinishSetup()
THEN
PROC_RemoveCounter("WYR_Chess_Move");
PROC_DeclareCounter("WYR_Chess_Move");
PROC_IncreaseCounter("WYR_Chess_Move");

PROC
PROC_WYR_Chess_FinishSetup()
AND
DB_WYR_Chess_Piece(_Piece, _, _, _, _)
AND
DB_WYR_Chess_Variant(_Var)
AND
NOT DB_WYR_Chess_StartPos(_Var, _Piece, _)
THEN
SetOnStage(_Piece, 0);

PROC
PROC_WYR_Chess_FinishSetup()
AND
DB_WYR_Chess_PlayerSide(_Colour)
AND
DB_WYR_Chess_Piece(_Piece, _, _Colour, _, _)
THEN
PROC_WYR_Chess_Update(_Piece);

PROC
PROC_WYR_Chess_FinishSetup()
AND
DB_WYR_Chess_OnTile(_Piece, _)
THEN
SetCanInteract(_Piece, 1);

PROC
PROC_WYR_Chess_FinishSetup()
AND
DB_WYR_Chess_PlayerSide(_PlayerColour)
AND
DB_WYR_Chess_Piece(_Piece, _, _PlayerColour, _, _)
THEN
SetTag(_Piece, ACT3_WYR_CHESS_PLAYERSIDE_443d1f4b-26f4-4fd6-a3b4-7d1d95046231);

PROC
PROC_WYR_Chess_FinishSetup()
AND
DB_WYR_Chess_PlayerSide(_PlayerColour)
AND
DB_WYR_Chess_Piece(_Piece, _, _Colour, _, _)
AND
_Colour != _PlayerColour
THEN
ClearTag(_Piece, ACT3_WYR_CHESS_PLAYERSIDE_443d1f4b-26f4-4fd6-a3b4-7d1d95046231);


//END_REGION

//REGION Update the valid positions

PROC
PROC_WYR_Chess_Update((ITEM)_Piece)
AND
DB_WYR_Chess_Piece(_Piece, _, _Colour, _Type, _)
AND
DB_WYR_Chess_OnTile(_Piece, _Tile)
AND
DB_WYR_Chess_Tile(_X, _Y, _Tile)
THEN
PROC_WYR_Chess_Update(_X, _Y, _Piece, _Colour, _Type);

PROC
PROC_WYR_Chess_Update((ITEM)_Piece)
AND
DB_WYR_Chess_Piece(_Piece, _Tag, _, _, _)
AND
DB_WYR_Chess_TagCache(_Tile, _Tag)
AND
NOT DB_WYR_Chess_ToUpdate(_Tile)
THEN
PROC_WYR_Chess_UpdateTag((ITEM)_Tile, (TAG)_Tag, 0);

PROC
PROC_WYR_Chess_Update((ITEM)_Piece)
AND
DB_WYR_Chess_Piece(_Piece, _Tag, _, _, _)
AND
DB_WYR_Chess_ToUpdate(_Tile)
AND
NOT DB_WYR_Chess_TagCache(_Tile, _Tag)
THEN
PROC_WYR_Chess_UpdateTag((ITEM)_Tile, (TAG)_Tag, 1);

PROC
PROC_WYR_Chess_Update((ITEM)_Piece)
AND
DB_WYR_Chess_ToUpdate(_Tile)
THEN
NOT DB_WYR_Chess_ToUpdate(_Tile);

PROC
PROC_WYR_Chess_UpdateTag((ITEM)_Tile, (TAG)_Tag, 1)
AND
NOT DB_WYR_Chess_TagCache(_Tile, _Tag)
AND
DB_WYR_Chess_OnTile(_Piece, _Tile)
THEN
SetTag(_Piece, _Tag);

PROC
PROC_WYR_Chess_UpdateTag((ITEM)_Tile, (TAG)_Tag, 1)
AND
NOT DB_WYR_Chess_TagCache(_Tile, _Tag)
THEN
DB_WYR_Chess_TagCache(_Tile, _Tag);
SetTag(_Tile, _Tag);

PROC
PROC_WYR_Chess_UpdateTag((ITEM)_Tile, (TAG)_Tag, 0)
AND
DB_WYR_Chess_OnTile(_Piece, _Tile)
AND
DB_WYR_Chess_TagCache(_Tile, _Tag)
THEN
ClearTag(_Piece, _Tag);

PROC
PROC_WYR_Chess_UpdateTag((ITEM)_Tile, (TAG)_Tag, 0)
AND
DB_WYR_Chess_TagCache(_Tile, _Tag)
THEN
NOT DB_WYR_Chess_TagCache(_Tile, _Tag);
ClearTag(_Tile, _Tag);

//REGION Knight

PROC
PROC_WYR_Chess_Update((INTEGER)_X, (INTEGER)_Y, (ITEM)_Piece, (INTEGER)_Colour, "Knight")
AND
DB_WYR_Chess_Directions(_A)
AND
IntegerProduct(_A, 2, _B)
AND
DB_WYR_Chess_Directions(_C)
THEN
PROC_WYR_Chess_KnightUpdate(_X, _Y, _Piece, _Colour, _B, _C);

PROC
PROC_WYR_Chess_Update(_X, _Y, (ITEM)_Piece, _Colour, "Knight")
AND
DB_WYR_Chess_Directions(_A)
AND
DB_WYR_Chess_Directions(_B)
AND
IntegerProduct(_B, 2, _C)
THEN
PROC_WYR_Chess_KnightUpdate(_X, _Y, _Piece, _Colour, _A, _C);

PROC
PROC_WYR_Chess_KnightUpdate((INTEGER)_X, (INTEGER)_Y, (ITEM)_Piece, (INTEGER)_Colour, (INTEGER)_A, (INTEGER)_B)
AND
IntegerSum(_X, _A, _NewX)
AND
IntegerSum(_Y, _B, _NewY)
THEN
PROC_WYR_Chess_SingleStepUpdate(_NewX, _NewY, _Piece, _Colour);

PROC
PROC_WYR_Chess_SingleStepUpdate((INTEGER)_X, (INTEGER)_Y, (ITEM)_Piece, (INTEGER)_Colour)
AND
DB_WYR_Chess_Tile(_X, _Y, _Tile)
AND
NOT DB_WYR_Chess_OnTile(_, _Tile)
THEN
DB_WYR_Chess_ToUpdate((ITEM)_Tile);

PROC
PROC_WYR_Chess_SingleStepUpdate((INTEGER)_X, (INTEGER)_Y, (ITEM)_Piece, (INTEGER)_Colour)
AND
DB_WYR_Chess_Tile(_X, _Y, _Tile)
AND
DB_WYR_Chess_OnTile(_Piece, _Tile)
AND
DB_WYR_Chess_Piece(_Piece, _, _Colour, _, _)
AND
DB_Negate(_Colour, _OtherColour)
THEN
DB_WYR_Chess_ToUpdate((ITEM)_Tile);


PROC
PROC_WYR_Chess_SingleStepUpdate((INTEGER)_X, (INTEGER)_Y, (ITEM)_Piece, (INTEGER)_Colour)
AND
DB_WYR_Chess_Tile(_X, _Y, _Tile)
AND
DB_WYR_Chess_OnTile(_OtherPiece, _Tile)
THEN
DB_WYR_Chess_Blocking(_Piece, _OtherPiece);


//END_REGION

//REGION Straight-moving pieces - rooks, bishops, queens.

PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, _Colour, "Queen")
THEN
PROC_WYR_Chess_Update(_X, _Y, _Piece, _Colour, "Rook");
PROC_WYR_Chess_Update(_X, _Y, _Piece, _Colour, "Bishop");

PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, _Colour, "Rook")
AND
DB_WYR_Chess_Directions(_A)
THEN
PROC_WYR_Chess_LineUpdate(_X, _Y, _Piece, _Colour, _A, 0);

PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, _Colour, "Rook")
AND
DB_WYR_Chess_Directions(_A)
THEN
PROC_WYR_Chess_LineUpdate(_X, _Y, _Piece, _Colour, 0, _A);

PROC
PROC_WYR_Chess_Update((INTEGER)_X, (INTEGER)_Y, (ITEM)_Piece, (INTEGER)_Colour, "Bishop")
AND
DB_WYR_Chess_Directions(_A)
AND
DB_WYR_Chess_Directions(_B)
THEN
PROC_WYR_Chess_LineUpdate(_X, _Y, _Piece, _Colour, _A, _B);

PROC
PROC_WYR_Chess_LineUpdate((INTEGER)_X, (INTEGER)_Y, (ITEM)_Piece, (INTEGER)_Colour, (INTEGER)_A, (INTEGER)_B)
AND
IntegerSum(_X, _A, _X2)
AND
IntegerSum(_Y, _B, _Y2)
THEN
PROC_WYR_Chess_LineUpdateCheck(_X2, _Y2, _Piece, _Colour, _A, _B);

PROC
PROC_WYR_Chess_LineUpdateCheck((INTEGER)_X, (INTEGER)_Y, (ITEM)_Piece, (INTEGER)_Colour, (INTEGER)_A, (INTEGER)_B)
AND
DB_WYR_Chess_Tile(_X, _Y, _Tile)
AND
NOT DB_WYR_Chess_OnTile(_, _Tile)
THEN
DB_WYR_Chess_ToUpdate(_Tile);
PROC_WYR_Chess_LineUpdate(_X, _Y, _Piece, _Colour, _A, _B);

PROC
PROC_WYR_Chess_LineUpdateCheck((INTEGER)_X, (INTEGER)_Y, (ITEM)_Piece, (INTEGER)_Colour, (INTEGER)_A, (INTEGER)_B)
AND
DB_WYR_Chess_Tile(_X, _Y, _Tile)
AND
DB_WYR_Chess_OnTile(_OtherPiece, _Tile)
AND
DB_WYR_Chess_Piece(_OtherPiece, _, _OtherColour, _, _)
AND
DB_Negate(_Colour, _OtherColour)
THEN
DB_WYR_Chess_ToUpdate(_Tile);

PROC
PROC_WYR_Chess_LineUpdateCheck(_X, _Y, _Piece, _Colour, _A, _B)
AND
DB_WYR_Chess_Tile(_X, _Y, _Tile)
AND
DB_WYR_Chess_OnTile(_OtherPiece, _Tile)
THEN
DB_WYR_Chess_Blocking(_Piece, _OtherPiece);

//END_REGION


//REGION King
PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, _Colour, "King")
AND
DB_WYR_Chess_Directions(_A)
AND
DB_WYR_Chess_Directions(_B)
AND
IntegerSum(_X, _A, _NewX)
AND
IntegerSum(_Y, _B, _NewY)
THEN
PROC_WYR_Chess_SingleStepUpdate(_NewX, _NewY, _Piece, _Colour);

PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, _Colour, "King")
AND
DB_WYR_Chess_Directions(_A)
AND
IntegerSum(_Y, _A, _NewY)
THEN
PROC_WYR_Chess_SingleStepUpdate(_X, _NewY, _Piece, _Colour);

PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, _Colour, "King")
AND
DB_WYR_Chess_Directions(_A)
AND
IntegerSum(_X, _A, _NewX)
THEN
PROC_WYR_Chess_SingleStepUpdate(_NewX, _Y, _Piece, _Colour);


//END_REGION

//REGION Pawn

//Normal move
PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, 1, "Pawn")
AND
IntegerSum(_X, 1, _NewX)
AND
DB_WYR_Chess_Tile(_NewX, _Y, _Tile)
THEN
PROC_WYR_Chess_PawnUpdate(_Piece, _Tile);

PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, 0, "Pawn")
AND
IntegerSum(_X, -1, _NewX)
AND
DB_WYR_Chess_Tile(_NewX, _Y, _Tile)
THEN
PROC_WYR_Chess_PawnUpdate(_Piece, _Tile);

PROC
PROC_WYR_Chess_PawnUpdate((ITEM)_Piece, (ITEM)_Tile)
AND
NOT DB_WYR_Chess_OnTile(_, _Tile)
THEN
DB_WYR_Chess_ToUpdate((ITEM)_Tile);

PROC
PROC_WYR_Chess_PawnUpdate(_Piece, _Tile)
AND
DB_WYR_Chess_OnTile(_OtherPiece, _Tile)
THEN
DB_WYR_Chess_Blocking(_Piece, _OtherPiece);

//Taking pieces
PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, 1, "Pawn")
AND
IntegerSum(_X, 1, _NewX)
AND
DB_WYR_Chess_Directions(_A)
AND
IntegerSum(_Y, _A, _NewY)
AND
DB_WYR_Chess_Tile(_NewX, _NewY, _Tile)
AND
DB_WYR_Chess_OnTile(_OtherPiece, _Tile)
AND
DB_WYR_Chess_Piece(_OtherPiece, _, 0, _, _)
THEN
DB_WYR_Chess_ToUpdate((ITEM)_Tile);
DB_WYR_Chess_Blocking(_Piece, _OtherPiece);


PROC
PROC_WYR_Chess_Update(_X, _Y, _Piece, 0, "Pawn")
AND
IntegerSum(_X, -1, _NewX)
AND
DB_WYR_Chess_Directions(_A)
AND
IntegerSum(_Y, _A, _NewY)
AND
DB_WYR_Chess_Tile(_NewX, _NewY, _Tile)
AND
DB_WYR_Chess_OnTile(_OtherPiece, _Tile)
AND
DB_WYR_Chess_Piece(_OtherPiece, _, 1, _, _)
THEN
DB_WYR_Chess_ToUpdate((ITEM)_Tile);
DB_WYR_Chess_Blocking(_Piece, _OtherPiece);


//First moves
PROC
PROC_WYR_Chess_Update(2, _Y, _Piece, 1, "Pawn")
AND
DB_WYR_Chess_Tile(4, _Y, _Tile)
THEN
PROC_WYR_Chess_PawnUpdate(_Piece, _Tile);

PROC
PROC_WYR_Chess_Update(7, _Y, _Piece, 0, "Pawn")
AND
DB_WYR_Chess_Tile(5, _Y, _Tile)
THEN
PROC_WYR_Chess_PawnUpdate(_Piece, _Tile);

//END_REGION

//END_REGION


//REGION Moving a piece

IF
StartedPreviewingSpell((GUIDSTRING)_Caster, (STRING)_Spell, _, _)
AND
DB_WYR_Chess_Piece(_Piece, _Tag, _, _, _Spell)
AND
DB_WYR_Chess_TagCache(_Tile, _Tag)
AND
NOT DB_WYR_Chess_PreparePreview(_Tile, _Spell)
THEN
PROC_LoopEffect(VFX_Script_PUZ_Wyrmway_Chess_Piece_Selection_Overlay_01_914e03d3-ff67-53df-b500-67595918a485, _Tile, _Spell, "BGO_Main_A", "");
DB_WYR_Chess_PreparePreview(_Tile, _Spell);

IF
CastSpell(_, _Spell, _, _, _)
AND
DB_WYR_Chess_PreparePreview(_Tile, _Spell)
THEN
NOT DB_WYR_Chess_PreparePreview(_Tile, _Spell);
PROC_StopLoopEffect(_Tile, _Spell);

IF
CastSpellFailed(_, _Spell, _, _, _)
AND
DB_WYR_Chess_PreparePreview(_Tile, _Spell)
THEN
NOT DB_WYR_Chess_PreparePreview(_Tile, _Spell);
PROC_StopLoopEffect(_Tile, _Spell);

IF
UsingSpellOnTarget(_Caster, _Tile, _Spell, _, _, _)
AND
DB_WYR_Chess_Piece(_Piece, _, _, _, _Spell)
AND
DB_WYR_Chess_Tile(_, _, (ITEM)_Tile)
THEN
PROC_WYR_Chess_MoveTo((ITEM)_Tile, (ITEM)_Piece);
DB_WYR_Chess_Mover(_Caster);

IF
UsingSpellOnTarget(_Caster, _TargetPiece, _Spell, _, _, _)
AND
DB_WYR_Chess_Piece(_Piece, _, _, _, _Spell)
AND
DB_WYR_Chess_OnTile((ITEM)_TargetPiece, _Tile)
THEN
PROC_WYR_Chess_MoveTo((ITEM)_Tile, (ITEM)_Piece);
DB_WYR_Chess_Mover(_Caster);

PROC
PROC_WYR_Chess_MoveTo((ITEM)_, (ITEM)_)
AND
DB_WYR_Chess_Piece(_Piece, _, _, _, _)
THEN
SetCanInteract(_Piece, 0);

PROC
PROC_WYR_Chess_MoveTo((ITEM)_Tile, (ITEM)_Piece)
THEN
PROC_WYR_Chess_VFXMoveTo(_Tile, _Piece, "PlayerMove");

//Update location
PROC
PROC_WYR_Chess_DoMoveTo((ITEM)_OldTile, (ITEM)_Tile, (ITEM)_Piece, "PlayerMove")
THEN
DB_WYR_Chess_MoveMade(_OldTile, _Tile);
PROC_WYR_Chess_AfterMove((ITEM)_Piece);


//Build up a temp list of all the pieces that the moved piece could take
//or that blocked its movement, then clean up old data.
PROC
PROC_WYR_Chess_AfterMove((ITEM)_Piece)
AND
DB_WYR_Chess_Blocking(_OtherPiece, _Piece)
THEN
NOT DB_WYR_Chess_Blocking(_OtherPiece, _Piece);
DB_WYR_Chess_TempBlocking(_OtherPiece);

PROC
PROC_WYR_Chess_AfterMove((ITEM)_Piece)
AND
DB_WYR_Chess_Blocking(_Piece, _OtherPiece)
THEN
NOT DB_WYR_Chess_Blocking(_Piece, _OtherPiece);
DB_WYR_Chess_TempBlocking(_OtherPiece);

PROC
PROC_WYR_Chess_AfterMove((ITEM)_Piece)
AND
DB_WYR_Chess_TagCache(_Tile, _Tag)
AND
DB_WYR_Chess_Piece(_Piece, _Tag, _, _, _)
THEN
PROC_WYR_Chess_Update(_Piece);

PROC
PROC_WYR_Chess_AfterMove(_)
AND
DB_WYR_Chess_TempBlocking(_Piece)
THEN
PROC_WYR_Chess_Update(_Piece);
NOT DB_WYR_Chess_TempBlocking(_Piece);

PROC
PROC_WYR_Chess_DoMoveTo(_, (ITEM)_Tile, (ITEM)_Piece, "PlayerMove")
THEN
PROC_WYR_Chess_MoveComplete();

PROC
PROC_WYR_Chess_MoveComplete()
THEN
TimerLaunch("WYR_Chess_ReactionDelayAfterMove", 1000);

//END_REGION

//REGION Evaluate if the move was valid, move accordingly, reset.

IF
TimerFinished("WYR_Chess_ReactionDelayAfterMove")
AND
NOT QRY_WYR_Chess_RightMove()
THEN
PROC_WYR_Chess_WrongMove();


QRY
QRY_WYR_Chess_RightMove()
AND
DB_WYR_Chess_MoveMade(_OldTile, _Tile)
AND
DB_GlobalCounter("WYR_Chess_Move", _Move)
AND
DB_WYR_Chess_Solution(_Move, _OldTile, _Tile)
THEN
PROC_WYR_Chess_RightMove();

PROC
PROC_WYR_Chess_RightMove()
AND
DB_WYR_Chess_MoveMade(_OldTile, _Tile)
THEN
NOT DB_WYR_Chess_MoveMade(_OldTile, _Tile);

PROC
PROC_WYR_Chess_RightMove()
THEN
PROC_IncreaseCounter("WYR_Chess_Move");
PROC_WYR_Chess_AIMove();

PROC
PROC_WYR_Chess_AIMove()
AND
DB_GlobalCounter("WYR_Chess_Move", _Move)
AND
DB_WYR_Chess_Solution(_Move, _OldTile, _Tile)
AND
DB_WYR_Chess_OnTile(_Piece, _OldTile)
THEN
PROC_WYR_Chess_VFXMoveTo(_Tile, _Piece, "AIMove");

//Update location
PROC
PROC_WYR_Chess_DoMoveTo(_, (ITEM)_Tile, (ITEM)_Piece, "AIMove")
THEN
PROC_WYR_Chess_AfterMove((ITEM)_Piece);
TimerLaunch("WYR_Chess_ReactionDelayAfterAIMove", 1100);

PROC
PROC_WYR_Chess_RightMove()
AND
DB_GlobalCounter("WYR_Chess_Move", _Move)
AND
NOT DB_WYR_Chess_Solution(_Move, _, _)
AND
DB_WYR_Chess_Piece(_Piece, _, _, _, _)
THEN
SetCanInteract(_Piece, 0);

PROC
PROC_WYR_Chess_RightMove()
AND
DB_GlobalCounter("WYR_Chess_Move", _Move)
AND
NOT DB_WYR_Chess_Solution(_Move, _, _)
THEN
Die(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, DEATHTYPE.Radiant, S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, 0, 0, 15.0);

IF
DestroyedBy(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, _, _, _)
AND
DB_WYR_Chess_Piece(_Piece, _, _, _, _)
THEN
SetCanInteract(_Piece, 0);

IF
DestroyedBy(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, _, _, _)
THEN
TimerCancel("WYR_Chess_ReactionDelayAfterAIMove");
TimerCancel("WYR_Chess_ReactionDelayAfterMove");
PROC_WYR_Wyrmway_PuzzleSolved(S_WYR_Chess_Statue3_9485f592-77fc-4039-92f8-6e4dcc6640f7);

//Polish to-do: more polish re: communicating victory.

IF
TimerFinished("WYR_Chess_ReactionDelayAfterAIMove")
AND
DB_WYR_Chess_Piece(_Piece, _, _, _, _)
THEN
SetCanInteract(_Piece, 1);

PROC
PROC_WYR_Chess_RightMove()
THEN
PROC_IncreaseCounter("WYR_Chess_Move");
PROC_WYR_Chess_TryNextMoveSuggestion();

PROC
PROC_WYR_Chess_WrongMove()
AND
SysFactAtIndex("DB_WYR_Chess_LifeGems", 1, 1, "DB_WYR_Chess_SelectedLifeGem")
AND
DB_WYR_Chess_SelectedLifeGem((ITEM)_Gem)
THEN
NOT DB_WYR_Chess_SelectedLifeGem(_Gem);
NOT DB_WYR_Chess_LifeGems(_Gem);
Die(_Gem);
PROC_ForceStopDialog(S_WYR_Chess_Statue3_9485f592-77fc-4039-92f8-6e4dcc6640f7);

PROC
PROC_WYR_Chess_WrongMove()
AND
NOT SysCount("DB_WYR_Chess_LifeGems", 1, 0)
THEN
PROC_TryStartAD(WYR_Chess_AD_Fail_aa987e74-3544-ec64-2058-da339fcf8d25, S_WYR_Chess_Statue3_9485f592-77fc-4039-92f8-6e4dcc6640f7);

PROC
PROC_WYR_Chess_WrongMove()
AND
SysCount("DB_WYR_Chess_LifeGems", 1, 0)
THEN
DB_WYR_Wyrmway_StatuePredeathDialog((ITEM)S_WYR_Chess_Statue3_9485f592-77fc-4039-92f8-6e4dcc6640f7, (DIALOGRESOURCE)WYR_Chess_AD_Fail_aa987e74-3544-ec64-2058-da339fcf8d25); 
PROC_WYR_Wyrmway_DestroyStatue(S_WYR_Chess_Statue3_9485f592-77fc-4039-92f8-6e4dcc6640f7);

PROC
PROC_WYR_Chess_WrongMove()
AND
SysCount("DB_WYR_Chess_LifeGems", 1, 0)
AND
DB_WYR_Chess_Mover(_Character)
THEN
NOT DB_WYR_Chess_Mover(_Character);

PROC
PROC_WYR_Chess_WrongMove()
AND
SysCount("DB_WYR_Chess_LifeGems", 1, 0)
THEN
PlayEffect(S_WYR_Chess_FailureTrigger_0a281e6a-cb86-4fab-882f-59ae4840082b, VFX_Script_PUZ_Wyrmway_Chess_Failed_01_9293c9c5-af71-260e-67f1-7fa4c2e8350b,"", 1.0);

PROC
PROC_WYR_Chess_WrongMove()
AND
SysCount("DB_WYR_Chess_LifeGems", 1, 0)
AND
DB_WYR_Chess_Piece(_Piece, _, _, _, _)
AND
IsOnStage(_Piece, 1)
THEN
PROC_WYR_Chess_VFXMoveTo((ITEM)NULL_00000000-0000-0000-0000-000000000000, (ITEM)_Piece, "Cleanup");

//Retry.
PROC
PROC_WYR_Chess_WrongMove()
AND
NOT SysCount("DB_WYR_Chess_LifeGems", 1, 0)
THEN
PROC_WYR_Chess_Setup();
PROC_WYR_Chess_TryNextMoveSuggestion();

//END_REGION

//REGION Teleportation VFX

//Bring targeting up to date with new position.
PROC
PROC_WYR_Chess_VFXMoveTo((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event)
AND
DB_WYR_Chess_OnTile(_Piece, _OldTile)
AND
DB_WYR_Chess_TagCache(_OldTile, _Tag)
AND
IsTagged(_Piece, _Tag, 1)
THEN
ClearTag(_Piece, _Tag);

PROC
PROC_WYR_Chess_VFXMoveTo((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event)
AND
DB_WYR_Chess_TagCache(_Tile, _Tag)
AND
IsTagged(_Piece, _Tag, 0)
THEN
SetTag(_Piece, _Tag);

PROC
PROC_WYR_Chess_VFXMoveTo((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event)
AND
IsOnStage(_Piece, 1)
AND
DB_WYR_Chess_Piece(_Piece, _Tag, _Colour, _Type, _Spell)
AND
DB_WYR_Chess_Size(_Type, _Size)
AND
DB_WYR_Chess_TeleportVFX(_Size, _Colour, _StartEffect, _)
THEN
PlayEffect(_Piece, _StartEffect, "", 1.0);

PROC
PROC_WYR_Chess_VFXMoveTo((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event)
AND
IsOnStage(_Piece, 1)
THEN
DB_WYR_Chess_MovingTo(_Tile, _Piece, _Event);
RealtimeObjectTimerLaunch(_Piece, "WYR_Chess_MovePiece", 1100);


PROC
PROC_WYR_Chess_VFXMoveTo((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event)
AND
_Event != "Cleanup"
AND
_Event != "Setup"
THEN
RealtimeObjectTimerLaunch(_Piece, "WYR_Chess_TryCapturePiece", 800);

PROC
PROC_WYR_Chess_VFXMoveTo((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event)
AND
IsOnStage(_Piece, 0)
THEN
SetOnStage(_Piece, 1);
PROC_WYR_VFXMoveTo_ArrivalStart((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event);

IF
ObjectTimerFinished(_Piece, "WYR_Chess_MovePiece")
AND
DB_WYR_Chess_MovingTo(_Tile, (ITEM)_Piece, _Event)
AND
_Event != "Setup"
THEN
SetVisible(_Piece, 0);
RealtimeObjectTimerLaunch(_Piece, "WYR_Chess_ReappearAndMovePiece", 100);


IF
ObjectTimerFinished(_Piece, "WYR_Chess_MovePiece")
AND
DB_WYR_Chess_MovingTo(_Tile, (ITEM)_Piece, "Setup")
THEN
PROC_WYR_VFXMoveTo_ArrivalStart((ITEM)_Tile, (ITEM)_Piece, "Setup");

IF
ObjectTimerFinished(_Piece, "WYR_Chess_ReappearAndMovePiece")
AND
DB_WYR_Chess_MovingTo(_Tile, (ITEM)_Piece, _Event)
AND
_Event != "Cleanup"
THEN
RealtimeObjectTimerLaunch(_Piece, "WYR_Chess_ReappearPiece", 100);
PROC_WYR_VFXMoveTo_ArrivalStart((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event);

IF
ObjectTimerFinished(_Piece, "WYR_Chess_ReappearAndMovePiece")
AND
DB_WYR_Chess_MovingTo(_Tile, (ITEM)_Piece, "Cleanup")
THEN
SetOnStage(_Piece, 0);

IF
ObjectTimerFinished(_Piece, "WYR_Chess_ReappearPiece")
THEN
SetVisible(_Piece, 1);

PROC
PROC_WYR_VFXMoveTo_ArrivalStart((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event)
AND
DB_WYR_Chess_Piece((ITEM)_Piece, _Tag, _Colour, _Type, _Spell)
AND
DB_WYR_Chess_Size(_Type, _Size)
AND
DB_WYR_Chess_TeleportVFX(_Size, _Colour, _, _EndEffect)
THEN
PlayEffect(_Piece, _EndEffect, "", 1.0);

PROC
PROC_WYR_VFXMoveTo_ArrivalStart((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event)
AND
DB_WYR_Chess_OnTile(_Piece, _OldTile)
THEN
NOT DB_WYR_Chess_OnTile(_Piece, _OldTile);
DB_WYR_Chess_OnTile(_Piece, _Tile);
TeleportTo(_Piece, _Tile);
NOT DB_WYR_Chess_MovingTo(_Tile, _Piece, _Event);
PROC_WYR_Chess_DoMoveTo(_OldTile, (ITEM)_Tile, (ITEM)_Piece, (STRING)_Event);

PROC
PROC_WYR_VFXMoveTo_ArrivalStart((ITEM)_Tile, (ITEM)_Piece, (STRING)_Event)
AND
NOT DB_WYR_Chess_OnTile(_Piece, _)
THEN
DB_WYR_Chess_OnTile(_Piece, _Tile);
TeleportTo(_Piece, _Tile);
NOT DB_WYR_Chess_MovingTo(_Tile, _Piece, _Event);
PROC_WYR_Chess_DoMoveTo(NULL_00000000-0000-0000-0000-000000000000, (ITEM)_Tile, (ITEM)_Piece, (STRING)_Event);

IF
ObjectTimerFinished(_Piece, "WYR_Chess_MovePiece")
AND
DB_WYR_Chess_MovingTo(_Tile, (ITEM)_Piece, _Event)
AND
NOT DB_WYR_Chess_OnTile(_Piece, _)
THEN
DB_WYR_Chess_OnTile(_Piece, _Tile);
TeleportTo(_Piece, _Tile);
NOT DB_WYR_Chess_MovingTo(_Tile, _Piece, _Event);
PROC_WYR_Chess_DoMoveTo((ITEM)NULL_00000000-0000-0000-0000-000000000000, (ITEM)_Tile, (ITEM)_Piece, (STRING)_Event);

//Taking pieces
IF
ObjectTimerFinished(_Piece, "WYR_Chess_TryCapturePiece")
AND
DB_WYR_Chess_MovingTo(_Tile, (ITEM)_Piece, _Event)
AND
DB_WYR_Chess_OnTile(_OtherPiece, _Tile)
AND
DB_WYR_Chess_Piece(_OtherPiece, _Tag, _Colour, _Type, _Spell)
THEN
PROC_WYR_Chess_Captured(_OtherPiece);
NOT DB_WYR_Chess_OnTile(_OtherPiece, _Tile);

PROC
PROC_WYR_Chess_Captured((ITEM)_Piece)
AND
DB_WYR_Chess_Piece(_Piece, _, _Colour, _Type, _)
AND
DB_WYR_Chess_Size(_Type, _Size)
AND
DB_WYR_Chess_CaptureVFX(_Size, _Colour, _CaptureVFX)
THEN
PlayEffect(_Piece, _CaptureVFX, "", 1.0);
RealtimeObjectTimerLaunch(_Piece, "WYR_Chess_Capture_Hide", 300);
RealtimeObjectTimerLaunch(_Piece, "WYR_Chess_Capture", 400);

IF
ObjectTimerFinished(_Piece, "WYR_Chess_Capture_Hide")
THEN
SetVisible(_Piece, 0);
RealtimeObjectTimerLaunch(_Piece, "WYR_Chess_ReappearPiece", 200);

IF
ObjectTimerFinished(_Piece, "WYR_Chess_Capture")
THEN
SetOnStage(_Piece, 0);

//END_REGION

//REGION Damaging the King

IF
AttackedBy(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, _, _, _, _, _, _)
THEN
NOT DB_WYR_Chess_KingAttackHandled(1);


//If the item is attacked once and was damaged before, fail (unless the statue is destroyed)
IF
AttackedBy(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, _, _, _, _, _, _ID)
AND
DB_WYR_Chess_KingHP(_OldHP, _OldID)
AND
_OldID != -1
AND
_OldID != _ID
AND
GetHitpoints(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, _HP)
AND
_HP < _OldHP //Check if attack was actulally damaging
AND
_HP != 0
THEN
DB_WYR_Chess_KingAttackHandled(1);
NOT DB_WYR_Chess_KingHP(_OldHP, _OldID);
SetHitpointsPercentage(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, 100.0);
PROC_WYR_Chess_WrongMove();
DB_WYR_Chess_KingHP(100, -1);

//If the item is attacked once and wasn't damage before, set new HP.
IF
AttackedBy(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, _, _, _, _, _, _ID)
AND
NOT DB_WYR_Chess_KingAttackHandled(1)
AND
DB_WYR_Chess_KingHP(_OldHP, -1)
AND
GetHitpoints(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, _HP)
AND
_HP < _OldHP //Check if attack was actulally damaging
THEN
NOT DB_WYR_Chess_KingHP(_OldHP, -1);
DB_WYR_Chess_KingHP(_HP, _ID);
DB_WYR_Chess_KingAttackHandled(1);

//One attack doing damage several times.
IF
AttackedBy(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, _, _, _, _, _, _ID)
AND
NOT DB_WYR_Chess_KingAttackHandled(1)
AND
DB_WYR_Chess_KingHP(_OldHP, _ID)
AND
GetHitpoints(S_WYR_Chess_King1_cd2393b5-fccc-4e0f-8592-16f85f078edf, _HP)
THEN
NOT DB_WYR_Chess_KingHP(_OldHP, _ID);
DB_WYR_Chess_KingHP(_HP, _ID);


//END_REGION

//REGION Gale's advice pings

PROC
PROC_BlockUseOfItem(_Character, _Piece)
AND
DB_WYR_Chess_Piece(_Piece, _, _, _, _)
AND
GetFlag(WYR_Chess_Knows_HeardGalesSolution_d564c991-cbdb-d5c9-8986-1e47b23ff578, _Character, 1)
AND
NOT QRY_WYR_Chess_GalePing((CHARACTER)_Character)
THEN
PROC_WYR_Chess_NextMoveSuggestion();

PROC
PROC_WYR_Chess_TryNextMoveSuggestion()
AND
DB_WYR_Chess_Mover(_Character)
AND
GetFlag(WYR_Chess_Knows_HeardGalesSolution_d564c991-cbdb-d5c9-8986-1e47b23ff578, _Character, 1)
AND
NOT QRY_WYR_Chess_GalePing((CHARACTER)_Character)
THEN
PROC_WYR_Chess_NextMoveSuggestion();

QRY
QRY_WYR_Chess_GalePing((CHARACTER)_Character)
AND
QRY_SameUser(_Character, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Character)
AND
DB_GlobalCounter("WYR_Chess_Move", _Move)
AND
DB_WYR_Chess_Solution(_Move, _OldTile, _NewTile)
AND
GetPosition(_OldTile, _OldX, _OldY, _OldZ)
AND
GetPosition(_NewTile, _NewX, _NewY, _NewZ)
THEN
RequestPing(_OldX, _OldY, _OldZ, _OldTile, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
RequestPing(_NewX, _NewY, _NewZ, _NewTile, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

PROC
PROC_WYR_Chess_TryNextMoveSuggestion()
AND
DB_WYR_Chess_Mover(_Caster)
THEN
NOT DB_WYR_Chess_Mover(_Caster);

PROC
PROC_WYR_Chess_NextMoveSuggestion()
AND
DB_GlobalCounter("WYR_Chess_Move", _Move)
AND
DB_WYR_Chess_Solution(_Move, _OldTile, _NewTile)
THEN
PROC_LoopEffect(VFX_UI_MapPing_01_05e4202b-4f24-2ebc-07d0-cc3ba0c17320, _OldTile, "WYR_Chess_Hint", "BGO_Main_A", "");
RealtimeObjectTimerLaunch(_OldTile, "WYR_Chess_Hint_End", 700);
PROC_LoopEffect(VFX_UI_MapPing_01_05e4202b-4f24-2ebc-07d0-cc3ba0c17320, _NewTile, "WYR_Chess_Hint", "BGO_Main_A", "");
RealtimeObjectTimerLaunch(_NewTile, "WYR_Chess_Hint_End", 900);

IF
ObjectTimerFinished(_Tile, "WYR_Chess_Hint_End")
THEN
PROC_StopLoopEffect(_Tile, "WYR_Chess_Hint");


//END_REGION 

//END_REGION

//REGION Painting Puzzle
IF
DB_WYR_PaintingPuzzle_SolutionPaintings(_, _SolutionPainting, _, _AD, _Dialog, _)
THEN
DB_Dialogs(_SolutionPainting, _Dialog);
DB_WYR_PaintingPuzzle_SolvedPainting(_SolutionPainting, _Dialog, _AD);
SetOnStage(_SolutionPainting, 0);

IF
Moved(_Painting)
AND
DB_WYR_PaintingPuzzle_SolvedPainting(_SolutionPainting, _Dialog, _AD)
AND
DB_Dialogs(_SolutionPainting, _Dialog)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_SolutionPainting);
DB_AD_Dialog(_SolutionPainting, _AD);

IF
ItemEnteredTrigger(_Painting, S_WYR_PaintingPuzzle_Painting7Box_ab7fe099-886f-48b1-b9ba-38602b81b5e8, _)
AND
DB_WYR_PaintingPuzzle_SolutionPaintings(_Painting, _SolutionPainting, _, _, _, _)
AND
NOT DB_WYR_Wyrmway_Solved(S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982)
AND
NOT DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982)
THEN
SetOnStage(S_WYR_PaintingPuzzle_PaintingSlot_12834a10-c7f1-4ca5-9e66-13fe5f1d8c8a, 0);
SetOnStage(_Painting, 0);
SetOnStage(_SolutionPainting, 1);
PROC_WYR_PaintingPuzzle_PaintingSolveAttempt(_Painting, _Painting);

IF
Combined(S_WYR_PaintingPuzzle_PaintingSlot_12834a10-c7f1-4ca5-9e66-13fe5f1d8c8a, _Painting, _, _, _, _, _Result)
THEN
PROC_WYR_PaintingPuzzle_PaintingSolveAttempt(_Painting, _Result);

PROC
PROC_WYR_PaintingPuzzle_PaintingSolveAttempt((ITEM)_Painting, (ITEM)_Result)
AND
_Painting != S_WYR_PaintingPuzzle_SolutionPainting3_38e88703-d24d-462e-8032-98a2d77465d4
THEN
PROC_WYR_Wyrmway_DestroyStatue(S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982);

PROC
PROC_WYR_PaintingPuzzle_PaintingSolveAttempt((ITEM)_Painting, (ITEM)_Result)
AND
DB_WYR_PaintingPuzzle_SolutionPaintings(_Painting, _, _, _AD, _Dialog, _)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Result);
DB_WYR_PaintingPuzzle_SolvedPainting(_Result, _Dialog, _AD);
DB_Dialogs(_Result, _Dialog);

PROC
PROC_WYR_PaintingPuzzle_PaintingSolveAttempt((ITEM)S_WYR_PaintingPuzzle_SolutionPainting3_38e88703-d24d-462e-8032-98a2d77465d4, _)
THEN
PROC_WYR_Wyrmway_PuzzleSolved(S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982);

PROC
PROC_WYR_PaintingPuzzle_PaintingSolveAttempt((ITEM)S_WYR_PaintingPuzzle_SolutionPainting3_38e88703-d24d-462e-8032-98a2d77465d4, _)
AND
NOT DB_OffStage(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d)
THEN
PROC_Poof(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d);

PROC
PROC_WYR_PaintingPuzzle_PaintingSolveAttempt(_, _)
THEN
TriggerUnregisterForItems(S_WYR_PaintingPuzzle_Painting7Box_ab7fe099-886f-48b1-b9ba-38602b81b5e8);

IF
UseFinished(_Character, _Painting, 1)
AND
DB_WYR_PaintingPuzzle_SolutionPaintings(_Painting, _, _Trigger, _AD, _Dialog, _)
AND
DB_Players(_Character)
AND
NOT QRY_WYR_PaintingPuzzle_DoDialog(_Character, _Painting, _Trigger, _Dialog)
THEN
PROC_TryStartAD(_AD, _Painting);

QRY
QRY_WYR_PaintingPuzzle_DoDialog((CHARACTER)_Character, (ITEM)_Painting, (TRIGGER)_Trigger, (DIALOGRESOURCE)_Dialog)
AND
IsInTrigger(_Painting, _Trigger, 1)
AND
QRY_StartDialog_Fixed(_Dialog, _Painting, _Character)
THEN
DB_NOOP(1);

IF
DestroyedBy((ITEM)S_WYR_PaintingPuzzle_SolutionPainting3_38e88703-d24d-462e-8032-98a2d77465d4, _, _, _)
THEN
PROC_WYR_Wyrmway_DestroyStatue((ITEM)S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982);

IF
DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982)
THEN
PROC_WYR_Wyrmway_CleanupPaintingPuzzle();

PROC
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982)
THEN
PROC_WYR_Wyrmway_CleanupPaintingPuzzle();

//REGION Possessing Ghost

IF
UseFinished(_, S_WYR_PaintingPuzzle_DebugRemoveStatus_126872c0-e807-4fdd-a884-3703afcb35e8, _)
AND
DB_WYR_PaintingPuzzle_BlockedPainting(_Painting)
THEN
RemoveStatus(_Painting, "WYR_PAINTINGPUZZLE_HIDDEN", NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(_Painting, "WYR_PAINTINGPUZZLE_HIDDEN", _, _)
THEN
SetStoryDisplayName(_Painting, "WYR_PaintingPuzzle_SolutionPaintingShroudedName");
DB_WYR_PaintingPuzzle_BlockedPainting(_Painting);

IF
StatusRemoved(_Painting, "WYR_PAINTINGPUZZLE_HIDDEN", _, _)
AND
DB_WYR_PaintingPuzzle_SolutionPaintings((ITEM)_Painting,  _, _, _, _, _Name)
THEN
SetStoryDisplayName(_Painting, _Name);
NOT DB_WYR_PaintingPuzzle_BlockedPainting(_Painting);

PROC
PROC_BlockMoveOfItem(_Character, _Painting)
AND
DB_WYR_PaintingPuzzle_BlockedPainting(_Painting)
THEN
PROC_WYR_TriedPickupCursedPainting(_Character);
DB_CustomMoveItemResponse(_Character, _Painting, 0);

PROC
PROC_BlockPickupOfItem(_Character, _Painting)
AND
DB_WYR_PaintingPuzzle_BlockedPainting(_Painting)
THEN
PROC_WYR_TriedPickupCursedPainting(_Character);
DB_CustomPickupItemResponse(_Character, _Painting, 0);

PROC
PROC_BlockUseOfItem(_Character, _Painting)
AND
DB_WYR_PaintingPuzzle_BlockedPainting(_Painting)
THEN
PROC_WYR_TriedPickupCursedPainting(_Character);
DB_CustomUseItemResponse(_Character, _Painting, 0);

PROC
PROC_WYR_TriedPickupCursedPainting((CHARACTER)_Character)
AND
DB_Players(_Character)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)WYR_PaintingPuzzle_PAD_PaintingBlocked_3d76aa65-4ced-6f8d-3103-9e7c49b6c859, _Character)
THEN
PROC_PlayCantUseItemAD(_Character);

IF
StatusRemoved(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d, "WYR_PAINTINGPUZZLE_AURA", _, _)
AND
NOT DB_WYR_Wyrmway_StatueFailed(S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982)
AND
QRY_OnlyOnce("WYR_Wyrmway_JudgeGone")
THEN
PROC_Poof(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d);
PROC_TryStartAD((DIALOGRESOURCE)WYR_PaitingPuzzle_AD_BanishedJudge_93c45ddd-08aa-8744-5043-39d181971210, S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982);
SetFlag((FLAG)WYR_PaintingShadow1_State_Gone_e232d01e-02db-49b7-bfde-7b90dd7c36aa, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
LeftTrigger(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d, S_WYR_PaintingPuzzle_ShadowBox_51bb969b-c247-4dc9-8e0d-856190e79020)
AND
NOT DB_WYR_Wyrmway_StatueFailed(S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982)
AND
QRY_OnlyOnce("WYR_Wyrmway_JudgeGone")
THEN
PROC_Poof(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d);
PROC_TryStartAD((DIALOGRESOURCE)WYR_PaitingPuzzle_AD_BanishedJudge_93c45ddd-08aa-8744-5043-39d181971210, S_WYR_PaintingPuzzle_Statue_7b87ac65-adab-49a9-b621-5feefa1de982);
SetFlag((FLAG)WYR_PaintingShadow1_State_Gone_e232d01e-02db-49b7-bfde-7b90dd7c36aa, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION


PROC
PROC_WYR_Wyrmway_CleanupPaintingPuzzle()
AND
IsOnStage(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d, 1)
THEN
PROC_Poof(S_WYR_PaintingShadow1_bbb26d9b-df5a-49a9-b63a-3db13317ba0d);

PROC
PROC_WYR_Wyrmway_CleanupPaintingPuzzle()
AND
DB_WYR_PaintingPuzzle_SolutionPaintings(_Painting, _, _, _, _, _)
AND
Exists(_Painting, 1)
THEN
SetStoryItem(_Painting, 0);

//END_REGION

//REGION Environmental ADs
PROC
PROC_WYR_Wyrmway_DestroyStatue((ITEM)_Statue)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue, _, _, _, _, _ID)
AND
DB_WYR_WyrmwayPuzzleVBs(_Trigger, _ID)
AND
DB_OneShot_VoiceBarkTrigger(_Trigger, _Voicebark, _, _)
THEN
PROC_RemoveOneShotVoiceBarkTrigger(_Trigger, _Voicebark);

PROC
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)_Statue)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue, _, _, _, _, _ID)
AND
DB_WYR_WyrmwayPuzzleVBs(_Trigger, _ID)
AND
DB_OneShot_VoiceBarkTrigger(_Trigger, _Voicebark, _, _)
THEN
PROC_RemoveOneShotVoiceBarkTrigger(_Trigger, _Voicebark);

//END_REGION

//REGION Global - indicator statues
IF
DB_WYR_Wyrmway_IndicatorStatues(_Statue1, _, _, _Rules, _, _)
THEN
DB_Dialogs(_Statue1, _Rules);

IF
DB_WYR_Wyrmway_IndicatorStatues(_, _Statue2, _, _Rules, _, _)
AND
_Statue2 != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_Dialogs(_Statue2, _Rules);

PROC
PROC_WYR_Wyrmway_PuzzleSolved(_Statue)
AND
DB_Dialogs(_Statue, _Rules)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Statue);

IF
DB_WYR_Wyrmway_IndicatorStatues(_Statue1, _Statue2, _, _, _, _)
AND
_Statue2 != NULL_00000000-0000-0000-0000-000000000000
AND
DB_WYR_Wyrmway_StatuePredeathDialog(_Statue1, _Dialog)
THEN
DB_WYR_Wyrmway_StatuePredeathDialog(_Statue2, _Dialog); //The indicators also ominously speak.

IF
DB_WYR_Wyrmway_IndicatorStatues(_Statue1, _, _, _Dialog, _, _)
THEN
PROC_SetInvulnerable(_Statue1, 1);
DB_Dialogs(_Statue1, _Dialog);

IF
DB_WYR_Wyrmway_IndicatorStatues(_, _Statue2, _, _, _, _)
AND
_Statue2 != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_SetInvulnerable(_Statue2, 1);
SetCanInteract(_Statue2, 0);

PROC
PROC_WYR_Wyrmway_DestroyStatue(_)
THEN
PROC_TriggerUnregisterForParty(S_WYR_CentralPlatform_12b01eaf-8039-40f7-b147-42b20126ed0e);
SetFlag(WYR_WyrmwayTrials_State_Failed_ffea8f23-3d08-4c57-9675-823a826b4357, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_WYR_Wyrmway_DestroyStatue((ITEM)_Statue)
AND
NOT DB_WYR_Wyrmway_StatueFailed(_Statue)
AND
NOT DB_WYR_Wyrmway_StatuePredeathDialog(_Statue, _)
THEN
DB_WYR_Wyrmway_StatueFailed(_Statue);
SetCanInteract(_Statue, 0);
PROC_WYR_Wyrmway_DoDestroyStatues();

PROC
PROC_WYR_Wyrmway_DoDestroyStatues()
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue, _, _, _, _, _)
THEN
PROC_WYR_Wyrmway_DoDestroyStatue(_Statue);

PROC
PROC_WYR_Wyrmway_DoDestroyStatues()
AND
DB_WYR_Wyrmway_IndicatorStatues(_, _Statue, _, _, _, _)
AND
_Statue != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_WYR_Wyrmway_DoDestroyStatue(_Statue);

PROC
PROC_WYR_Wyrmway_DestroyStatue((ITEM)_Statue)
AND
NOT DB_WYR_Wyrmway_StatueFailed(_Statue)
AND
DB_WYR_Wyrmway_StatuePredeathDialog(_Statue, _Dialog)
AND
NOT QRY_StartDialog_Fixed(_Dialog, _Statue)
THEN
DB_WYR_Wyrmway_StatueFailed(_Statue);
SetCanInteract(_Statue, 0);
PROC_WYR_Wyrmway_DoDestroyStatues();

IF
AutomatedDialogStarted(_Dialog, _ID)
AND
DB_WYR_Wyrmway_StatuePredeathDialog(_Statue, _Dialog)
AND
DB_DialogNPCs(_ID,_Statue, 1)
THEN
DB_WYR_Wyrmway_StatueFailed(_Statue);
SetCanInteract(_Statue, 0);

IF
AutomatedDialogRequestFailed(_Dialog, _ID)
AND
DB_WYR_Wyrmway_StatuePredeathDialog(_Statue, _Dialog)
AND
DB_DialogRequestCache_SpeakerList_Speakers(_Dialog,_ID,_Statue,_)
THEN
DB_WYR_Wyrmway_StatueFailed(_Statue);
SetCanInteract(_Statue, 0);

IF
AutomatedDialogEnded(_Dialog, _ID)
AND
DB_WYR_Wyrmway_StatuePredeathDialog(_Statue, _Dialog)
AND
DB_DialogNPCs(_ID,_Statue, 1)
THEN
PROC_WYR_Wyrmway_DoDestroyStatues();

PROC
PROC_WYR_Wyrmway_DoDestroyStatue((ITEM)_Statue)
THEN
SetCanInteract(_Statue, 0);

IF
DB_WYR_Wyrmway_StatueFailed((ITEM)_Statue)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue, _, _, _, _, _ID)
AND
DB_WYR_Wyrmway_IndicatorStatues(_AnyStatue, _, _, _, _, _ID)
THEN
PROC_StopLoopEffect(_AnyStatue, "WYR_Wyrmway_Solved");


//If you have already solved the puzzle and then fail it somehow, you also lose the win.
PROC
PROC_WYR_Wyrmway_DoDestroyStatue((ITEM)_Statue1)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue1, _Statue2, _, _Dialog, _, _)
AND
_Statue2 != NULL_00000000-0000-0000-0000-000000000000
AND
DB_WYR_Wyrmway_Solved(_Statue2)
THEN
NOT DB_WYR_Wyrmway_Solved(_Statue2);
PROC_DecreaseCounter("WYR_Wyrmway_Successes");

PROC
PROC_WYR_Wyrmway_DoDestroyStatue((ITEM)S_WYM_Wyrmway_ChessIndicator_538106f6-079a-4965-bb1b-1d8c3ee86279)
THEN
PROC_SetInvulnerable(S_WYM_Wyrmway_ChessIndicator_538106f6-079a-4965-bb1b-1d8c3ee86279, 0);
Die(S_WYM_Wyrmway_ChessIndicator_538106f6-079a-4965-bb1b-1d8c3ee86279, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 2.0);

IF
AnimationEvent(S_WYM_Wyrmway_ChessIndicator_538106f6-079a-4965-bb1b-1d8c3ee86279, "ImpactChain", _)
AND
QRY_OnlyOnce("WYR_Wyrmway_DoorDown")
THEN
PROC_ItemUnlockAndOpen(S_WYR_Wyrmway_DoorDown_bea67866-f75a-4526-a9cc-750d0efa3153);

IF
DestroyedBy((ITEM)S_WYM_Wyrmway_ChessIndicator_538106f6-079a-4965-bb1b-1d8c3ee86279, _, _, _)
AND
QRY_OnlyOnce("WYR_Wyrmway_DoorDown")
THEN
PROC_ItemUnlockAndOpen(S_WYR_Wyrmway_DoorDown_bea67866-f75a-4526-a9cc-750d0efa3153);

//Peaceful resolution
IF
Opened(S_WYR_Wyrmway_DoorDown_bea67866-f75a-4526-a9cc-750d0efa3153)
AND
NOT DB_WYR_Wyrmway_StatueFailed(_)
AND
DB_WYR_Wyrmsway_FailSkeletons(_Skeleton)
THEN
PROC_PeacefulResolve(_Skeleton);

PROC
PROC_WYR_Wyrmway_DestroyStatue((ITEM)_Statue1)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue1, _Statue2, _, _Dialog, _, _ID)
AND
_Statue2 != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_WYR_Wyrmway_DestroyStatue((ITEM)_Statue2);
PROC_StopLoopEffect(_Statue2, "WYR_Wyrmway_Solved");

PROC
PROC_WYR_Wyrmway_DoDestroyStatue((ITEM)_Statue2)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue1, (ITEM)_Statue2, _EventListener, _Dialog, _SuccessDialog, _ID)
THEN
NOT DB_WYR_Wyrmway_IndicatorStatues(_Statue1, _Statue2, _EventListener, _Dialog, _SuccessDialog, _ID);
PROC_IncreaseCounter("WYR_Wyrmway_Failures");

PROC
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)_Statue)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue, _, _, _, _, _ID)
AND
DB_WYR_Wyrmway_IndicatorStatues(_AnyStatue, _, _, _, _, _ID)
THEN
PROC_LoopEffect(VFX_Script_PUZ_GEN_Statue_Balduran_A_01_d4414168-9493-e1aa-6408-171b0722de0d, _AnyStatue, "WYR_Wyrmway_Solved", "BGO_Main_A", "");
SetCanInteract(_AnyStatue, 0);

PROC
PROC_WYR_Wyrmway_PuzzleSolved(_)
THEN
PROC_TriggerUnregisterForParty(S_WYR_CentralPlatform_12b01eaf-8039-40f7-b147-42b20126ed0e);

PROC
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)_Statue)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue, _, _, _, _SuccessDialog, _ID)
THEN
PROC_TryStartAD(_SuccessDialog, _Statue);

PROC
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)_Statue)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue, _, _EventListener, _, _SuccessDialog, _)
THEN
SetEntityEvent(_EventListener, "WYR_Wyrmway_Passed", 1);

PROC
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)_Statue)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue, _Statue2, _, _, _SuccessDialog, _)
AND
_Statue2 != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_TryStartAD(_SuccessDialog, _Statue2);
PROC_LoopEffect(VFX_Script_PUZ_GEN_Statue_Balduran_A_01_d4414168-9493-e1aa-6408-171b0722de0d, _Statue2, "WYR_Wyrmway_Solved", "BGO_Main_A", "");
PROC_IncreaseCounter("WYR_Wyrmway_Successes");
DB_WYR_Wyrmway_Solved(_Statue2);

PROC
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)_Statue)
AND
DB_WYR_Wyrmway_SuccessFlag(_Statue, _Flag)
THEN
SetFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_InRegion(_Character, S_WYR_CentralPlatform_12b01eaf-8039-40f7-b147-42b20126ed0e)
AND
NOT DB_HiddenCharacters(_Character, _)
AND
DB_WYR_Wyrmway_IndicatorStatues(_Statue1, _Statue2, _, _, _, _)
AND
_Statue2 != NULL_00000000-0000-0000-0000-000000000000
AND
NOT QRY_WYR_Wyrmway_SawAnyPuzzle(_Character)
AND
QRY_OncePerUserAndNearbyPlayers(_Character, "WYR_CentralPlatform_PAD")
THEN
PROC_TryStartAD((DIALOGRESOURCE)WYR_Wyrmway_CentralPlatform_AD_f9ebafc1-9259-127a-ab36-83eafd5625a5, _Statue2);

QRY
QRY_WYR_Wyrmway_SawAnyPuzzle((CHARACTER)_Character)
AND
DB_WYR_Wyrmway_IndicatorStatues(_, _, _, _, _, _ID)
AND
QRY_OncePerUserAndNearbyPlayers_IsSet(_Character, _ID)
THEN
DB_NOOP(1);

//REGION Hordes of the undead.

//Start the Fail state combats
IF
TextEvent("WYR_TrialsFailstate_CombatStart")
THEN
PROC_WYR_Wyrmway_DoDestroyStatues();

IF
DB_WYR_Wyrmsway_FailSkeletons(_Skeleton)
THEN
SetOnStage(_Skeleton, 0);

PROC
PROC_WYR_Wyrmway_DoDestroyStatues()
AND
DB_WYR_Wyrmsway_FailSkeletons(_Skeleton)
THEN
SetOnStage(_Skeleton, 1);

PROC
PROC_WYR_Wyrmway_DoDestroyStatues()
THEN
SetEntityEvent(S_WYR_FailCrystals_Event_99ffbe89-1e65-420c-9a74-6e75aa7417d0, "WYR_Failcrystals_Drop", 1);

IF
TextEvent("WYR_FailCrystals_Drop")
THEN
SetEntityEvent(S_WYR_FailCrystals_Event_99ffbe89-1e65-420c-9a74-6e75aa7417d0, "WYR_Failcrystals_Drop", 1);

//END_REGION

//REGION Clicking the door while it's locked

IF
UseFinished(_Character, S_WYR_Wyrmway_DoorDown_bea67866-f75a-4526-a9cc-750d0efa3153, 0)
AND
QRY_OnlyOnce_Reset("WYR_Wyrmyway_PuzzleUnfinished_AD")
AND
DB_WYR_Wyrmway_IndicatorStatues(_, _Statue, _, _, _, _)
AND
_Statue != NULL_00000000-0000-0000-0000-000000000000
AND
NOT DB_WYR_Wyrmway_StatueFailed(_Statue)
AND
NOT DB_WYR_Wyrmway_Solved(_Statue)
AND
NOT DB_OnlyOnce("WYR_Wyrmyway_PuzzleUnfinished_AD")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)WYR_Wyrmway_AD_DoorBlocked_a4863d5f-e413-03da-6b70-a53352ec51d4, S_WYM_Wyrmway_InsightIndicator_18695bfb-f9db-40b4-9783-ce275b37d5ca)
THEN
DB_OnlyOnce("WYR_Wyrmyway_PuzzleUnfinished_AD");

//END_REGION

IF
TextEvent("WYR_Wyrmway_Fail")
THEN
PROC_WYR_Wyrmway_DoDestroyStatues();

//END_REGION

//REGION Insight Puzzle

//REGION Birds

QRY
QRY_SelectADForRequest(_Bird, _Player)
AND
IsCharacter(_Bird, 1)
AND
DB_WYR_InsightPuzzle_Birds((CHARACTER)_Bird, _)
THEN
PROC_WYR_InsightPuzzle_Bird_Catch(_Bird, (CHARACTER)_Player);

PROC
PROC_WYR_InsightPuzzle_Bird_Catch((CHARACTER)_Bird, (CHARACTER)_Player)
AND
DB_WYR_InsightPuzzle_Bird_TriedToCatch(_Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)WYR_InsightPuzzle_AD_Birds_bdd72ac1-172d-9f8a-301f-bded71f4ad55, _Player);

PROC
PROC_WYR_InsightPuzzle_Bird_Catch((CHARACTER)_Bird, (CHARACTER)_Player)
AND
NOT DB_WYR_InsightPuzzle_Bird_TriedToCatch(_Player)
THEN
DB_WYR_InsightPuzzle_Bird_TriedToCatch(_Player);
PROC_TrySkillCheck((CHARACTER)_Player,(GUIDSTRING)_Bird, "SleightOfHand",(DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, "WYR_InsightPuzzle_Birds");

PROC
PROC_RollResult("WYR_InsightPuzzle_Birds", (CHARACTER)_Player, (GUIDSTRING)_Bird, 0)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)WYR_InsightPuzzle_AD_Birds_bdd72ac1-172d-9f8a-301f-bded71f4ad55, _Player)
THEN
DB_NOOP(1);

QRY
QRY_GLO_SkillCheck_CheckAdvantage(_, _Bird, "WYR_InsightPuzzle_Birds")
AND
HasActiveStatus(_Bird, "SLOW", 1)
THEN
DB_QRYRTN_GLO_Skillcheck_CheckAdvantage(1);

QRY
QRY_GLO_SkillCheck_CheckAdvantage(_, _Bird, "WYR_InsightPuzzle_Birds")
AND
HasActiveStatus(_Bird, "RAY_OF_FROST", 1)
THEN
DB_QRYRTN_GLO_Skillcheck_CheckAdvantage(1);

PROC
PROC_RollResult("WYR_InsightPuzzle_Birds", (CHARACTER)_Player, (GUIDSTRING)_Bird, 1)
AND
DB_WYR_InsightPuzzle_Birds((CHARACTER)_Bird, _Book)
THEN
DB_WYR_InsightPuzzle_Bird_Captured(_Bird);
PROC_Poof(_Bird);
PROC_ToInventoryAndOnStage(_Book, _Player, -1, 1, 1);

IF
DB_WYR_InsightPuzzle_Birds(_Bird, _Book)
THEN
PROC_CharacterDisableAllCrimes(_Bird);
SetHasDialog(_Bird, 1);
SetOnStage(_Book, 0);

IF
DB_PermaDefeated(_Bird)
AND
DB_WYR_InsightPuzzle_Birds((CHARACTER)_Bird, _)
THEN
PROC_Poof(_Bird);

PROC
PROC_StateSet_CantMove(_Bird)
AND
DB_WYR_InsightPuzzle_Birds((CHARACTER)_Bird, _Book)
THEN
SetEntityEvent(_Bird, "WYR_InsightPuzzle_Bird_CantMove", 1); //Wait a frame.

IF
EntityEvent(_Bird, "WYR_InsightPuzzle_Bird_CantMove")
AND
NOT DB_PermaDefeated(_Bird)
AND
NOT DB_WYR_InsightPuzzle_Bird_Captured((CHARACTER)_Bird)
AND
DB_WYR_InsightPuzzle_Birds(_Bird, _Book)
AND
GetPosition(_Bird, _X, _Y, _Z)
THEN
PROC_Poof(_Bird);
TeleportTo(_Book, _Bird);
SetOnStage(_Book, 1);
ScatterAt(_Book, _X, _Y, _Z);

//END_REGION

IF
Died(_Suspect)
AND
DB_WYR_InsightPuzzle_Suspect((CHARACTER)_Suspect, _)
AND
DB_WYR_InsightPuzzle_Suspect((CHARACTER)_OtherSuspect, _)
THEN
RealtimeObjectTimerLaunch(_OtherSuspect, "WYR_InsightPuzzle_Poof", 1200); //IF the players are trying to kill everyone at once, give them the opportunity.

IF
ObjectTimerFinished(_Suspect, "WYR_InsightPuzzle_Poof")
THEN
PROC_Poof(_Suspect);

IF
Died(_Suspect)
AND
DB_WYR_InsightPuzzle_Suspect((CHARACTER)_Suspect, 0)
THEN
PROC_WYR_Wyrmway_DestroyStatue((ITEM)S_WYR_InsightTest_Instructor_666740c1-a97d-4cbc-b049-bf6902099a3f);

IF
DB_Dead(S_WYR_InsightPuzzle_Suspect1_2d8b3b34-8856-4adc-8cde-349e1f281674)
AND
DB_OffStage((CHARACTER)S_WYR_InsightPuzzle_Suspect2_78df67f2-93c0-48b4-8c15-7edbaea1abf7)
AND
DB_OffStage((CHARACTER)S_WYR_InsightPuzzle_Suspect3_ce9cd75e-c8c8-46d2-80e5-f1cde42ee42c)
AND
NOT DB_Dead((CHARACTER)S_WYR_InsightPuzzle_Suspect2_78df67f2-93c0-48b4-8c15-7edbaea1abf7)
AND
NOT DB_Dead((CHARACTER)S_WYR_InsightPuzzle_Suspect3_ce9cd75e-c8c8-46d2-80e5-f1cde42ee42c)
THEN
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)S_WYR_InsightTest_Instructor_666740c1-a97d-4cbc-b049-bf6902099a3f);
PROC_WYR_InsightPuzzle_CleanupWyllVB();

//REGION Wyll comment
PROC
PROC_WYR_InsightPuzzle_Setup()
AND
NOT DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
DB_WYR_InsightPuzzle_Books((ITEM)S_WYR_InsightPuzzle_Hint1_ddc9f895-2055-4350-8552-93c705e6cca2);
DB_WYR_InsightPuzzle_Books((ITEM)S_WYR_InsightPuzzle_Hint2_64082582-01ac-4f30-b873-aa4554fb7881);
DB_WYR_InsightPuzzle_Books((ITEM)S_WYR_InsightPuzzle_Hint3_d697147b-159f-4329-b6e9-e31311c9dde0);
DB_WYR_InsightPuzzle_Books((ITEM)S_WYR_InsightPuzzle_Hint6_ed43632d-49c6-4a50-bd00-bbd6dffcfc66);

PROC
PROC_WYR_InsightPuzzle_Setup()
AND
DB_WYR_InsightPuzzle_Birds(_Bird, _)
THEN
DB_PreventKnockedOutPermaDefeated(_Bird);
PROC_CharacterDisableAllCrimes(_Bird);

IF
DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_InsightTest_Instructor_666740c1-a97d-4cbc-b049-bf6902099a3f)
THEN
PROC_WYR_InsightPuzzle_CleanupWyllVB();

IF
FlagSet((FLAG)WYR_Wyrmsway_State_WyllQuiet_7652950f-2476-c353-ad15-2fa83180ffb5, _, _)
THEN
PROC_WYR_InsightPuzzle_CleanupWyllVB();

PROC
PROC_WYR_InsightPuzzle_CleanupWyllVB()
AND
DB_WYR_InsightPuzzle_Books(_Book)
THEN
NOT DB_WYR_InsightPuzzle_Books(_Book);

PROC
PROC_WYR_InsightPuzzle_CleanupWyllVB()
THEN
TriggerUnregisterForCharacter(S_WYR_PaintingPuzzle_VB_Wyll_95143df7-432b-4df8-8dfd-6f9f7c913c31, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

IF
GameBookInterfaceClosed(_Book, _Character)
AND
DB_WYR_InsightPuzzle_Books(_Book)
THEN
NOT DB_WYR_InsightPuzzle_Books(_Book);
PROC_WYR_InsightPuzzle_BookRead();

PROC
PROC_WYR_InsightPuzzle_BookRead()
AND
NOT DB_WYR_InsightPuzzle_Books(_)
THEN
TriggerRegisterForCharacter(S_WYR_PaintingPuzzle_VB_Wyll_95143df7-432b-4df8-8dfd-6f9f7c913c31, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

IF
DB_InRegion((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, (TRIGGER)S_WYR_PaintingPuzzle_VB_Wyll_95143df7-432b-4df8-8dfd-6f9f7c913c31)
AND
NOT DB_CantTalk(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
AND
NOT DB_Avatars((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
StartVoiceBark(WYR_InsightPuzzle_VB_Wyll_66846d22-89bb-43c6-ffd0-e265e57a698b, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
TriggerUnregisterForCharacter(S_WYR_PaintingPuzzle_VB_Wyll_95143df7-432b-4df8-8dfd-6f9f7c913c31, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

//END_REGION

//END_REGION

//REGION Courage Puzzle

IF
DB_WYR_CourageTrial_Enemies(_, _Enemy)
THEN
SetOnStage(_Enemy, 0);

PROC
PROC_BlockMoveOfItem(_Character, (ITEM)S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04)
THEN
DB_CustomMoveItemResponse(_Character, S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, 0);

PROC
PROC_BlockMoveOfItem(_Character, (ITEM)S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04)
AND
NOT DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
AND
NOT DB_WYR_Wyrmway_Solved((ITEM)S_WYM_Wyrmway_CourageIndicator_d020f6ee-1acf-4027-966e-f9049746452f)
AND
DB_Players(_Character)
THEN
PROC_PlayCantUseItemAD(_Character);

PROC
PROC_BlockPickupOfItem(_Character, (ITEM)S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04)
AND
DB_Players(_Character)
AND
QRY_OnlyOnce("WYR_CourageTest_Rules")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)WYR_CouragePuzzle_Rules_9e329103-ccac-ac45-46e0-f523d1166828, S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12, _Character)
THEN
DB_CustomPickupItemResponse(_Character, S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, 0);

PROC
PROC_BlockUseOfItem(_Character, (ITEM)S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04)
AND
DB_Players(_Character)
AND
QRY_OnlyOnce("WYR_CourageTest_Rules")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)WYR_CouragePuzzle_Rules_9e329103-ccac-ac45-46e0-f523d1166828, S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12, _Character)
THEN
DB_CustomUseItemResponse(_Character, S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, 0);

IF
DialogEnded((DIALOGRESOURCE)WYR_CouragePuzzle_Rules_9e329103-ccac-ac45-46e0-f523d1166828, _ID)
AND
DB_GlobalFlag((FLAG)WYR_CouragePuzzle_Event_TakeTorch_71c53909-cbdf-6bfb-6318-53f2cb680260)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_GlobalClearFlagAndCache((FLAG)WYR_CouragePuzzle_Event_TakeTorch_71c53909-cbdf-6bfb-6318-53f2cb680260);
Pickup((CHARACTER)_Player, (ITEM)S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, "", 1);

IF
AddedTo(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, _Holder, _)
AND
DB_Players((CHARACTER)_Holder)
AND
NOT DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
AND
NOT DB_WYR_Wyrmway_Solved((ITEM)S_WYM_Wyrmway_CourageIndicator_d020f6ee-1acf-4027-966e-f9049746452f)
THEN
Equip(_Holder, S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);

IF
Equipped(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, _Character)
AND
NOT DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
AND
NOT DB_WYR_Wyrmway_Solved((ITEM)S_WYM_Wyrmway_CourageIndicator_d020f6ee-1acf-4027-966e-f9049746452f)
AND
IsInTrigger(_Character, S_WYR_Wyrmway_TestArea_e51e90a0-d436-4bc3-b55d-6276dfa7d81b, 1)
AND
CreateNarrativeCombat(_Combat)
THEN
DB_WYR_CourageTest_Tester(_Character, _Combat);
ApplyStatus(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, "BURNING", -1.0, 1, S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);
ApplyStatus(_Character, "WYR_COURAGEBRIGHT", -1.0, 1, S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);
ApplyStatus(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, "WYR_COURAGEBOUND", -1.0, 1, S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);
PROC_WYR_CourageTrial_Setup();
SetInNarrativeCombat(_Character, _Combat, 1);
PROC_ForceStopDialog(S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12);
SetCanInteract((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12, 0);
PROC_GlobalClearFlagAndCache((FLAG)WYR_CouragePuzzle_Event_TakeTorch_71c53909-cbdf-6bfb-6318-53f2cb680260);
TriggerRegisterForCharacter(S_WYR_Wyrmway_TestArea_e51e90a0-d436-4bc3-b55d-6276dfa7d81b, _Character);

IF
DB_Is_InCombat(_Character, _Combat)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_, _Combat)
AND
IsCharacter(_Character, 1)
THEN
DB_WYR_CourageTest_Combatant((CHARACTER)_Character); //Avoid looking over the DB_Combat database unnecessarily.

IF
DB_WYR_CourageTest_Combatant(_Character)
AND
NOT DB_WYR_CourageTest_Tester((CHARACTER)_, _)
THEN
NOT DB_WYR_CourageTest_Combatant(_Character);

IF
DB_WYR_CourageTest_Combatant(_Character)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_, _Combat)
AND
NOT DB_Is_InCombat(_Character, _Combat)
THEN
NOT DB_WYR_CourageTest_Combatant(_Character);

IF
DB_Dead(_Character)
AND
DB_WYR_CourageTest_Combatant(_Character)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_, _Combat)
THEN
SetInNarrativeCombat(_Character, _Combat, 0);

IF
EnteredCombat(_Character, _)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character, _Combat)
THEN
SetInNarrativeCombat(_Character, _Combat, 1);

IF
EnteredCombat(_Anchor, _)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Anchor, _Combat)
AND
DB_InRegion(_Character, S_WYR_Wyrmway_SUB_Courage_33b6ae56-c6ec-4997-9e87-dd2280c21f00)
THEN
SetInNarrativeCombat(_Character, _Combat, 1);

PROC
PROC_WYR_CourageTrial_Setup()
AND
DB_WYR_CourageTest_Tester(_Character, _)
AND
DB_WYR_CourageTrial_Enemies(0, _Enemy)
THEN
DebugText(_Character, "Enemy AppearAt starting");
AppearAt(_Enemy, _Enemy, 1, NULL_00000000-0000-0000-0000-000000000000, "WYR_Wyrmsway_InitEnemy", 0);

IF
EntityEvent(_Enemy, "WYR_Wyrmsway_InitEnemy")
AND
DB_WYR_CourageTest_Tester(_Character, _Combat)
THEN
DebugText(_Character, "Enemy AppearAt ended");
SetInNarrativeCombat(_Enemy, _Combat, 1);

IF
EntityEvent(_Enemy, "WYR_Wyrmsway_InitEnemy")
AND
DB_WYR_CourageTest_Tester(_Character, _Combat)
AND
QRY_OnlyOnce("WYR_CourageTest_General")
THEN
TurnBasedTimerLaunch(_Character, "WYR_CourageTest_General", "WYR_CourageTrial_TimerName", 24000);


IF
EnteredCombat(_Enemy, _Combat)
AND
DB_WYR_CourageTrial_Enemies(0, (CHARACTER)_Enemy)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character, _Combat)
AND
DB_Is_InCombat(_Character, _Combat)
AND
QRY_OnlyOnce("WYR_Wyrmway_CourageTrial_Start")
THEN
PROC_WYR_CourageTrial_Step(_Character);

//REGION Combat join
IF
EnteredCombat(_NewJoin, _Combat)
AND
DB_WYR_CourageTest_Tester(_Character, _NarCombat)
AND
DB_WYR_CourageTrial_Enemies(_, _Enemy)
AND
DB_Is_InCombat(_Enemy, _Combat)
AND
_Combat != _NarCombat
THEN
SetInNarrativeCombat(_NewJoin, _NarCombat, 1);
/*Characters in Narrative Combat encountering enemies (e.g. the party) actually enter
a second, separate combat with those other characters.
This keeps such combats merged.
With very rare exceptions, the _NewChar here is a party member (there are no other combatants around),
and the combat won't be kited elsewhere as the torch-wielder can't leave the arena and they are the
combat's main target.*/

IF
DB_Sees(_Combatant, _NewJoin)
AND
NOT DB_WYR_CourageTest_Combatant(_NewJoin)
AND
DB_WYR_CourageTest_Combatant(_Combatant)
AND
DB_WYR_CourageTest_Tester(_, _NarCombat)
AND
NOT DB_Dead(_NewJoin)
AND
IsEnemy(_Combatant, _NewJoin, 1)
THEN
SetInNarrativeCombat(_NewJoin, _NarCombat, 1);

IF
DB_Sees(_NewJoin, _Combatant)
AND
NOT DB_Dead(_NewJoin)
AND
NOT DB_WYR_CourageTest_Combatant(_NewJoin)
AND
DB_WYR_CourageTest_Combatant(_Combatant)
AND
NOT DB_HiddenCharacters(_NewJoin, _)
AND
DB_WYR_CourageTest_Tester(_, _NarCombat)
AND
IsEnemy(_Combatant, _NewJoin, 1)
THEN
SetInNarrativeCombat(_NewJoin, _NarCombat, 1);

IF
DB_Sees(_NewJoin, _Combatant1)
AND
NOT DB_Dead(_NewJoin)
AND
NOT DB_WYR_CourageTest_Combatant(_NewJoin)
AND
NOT DB_HiddenCharacters(_NewJoin, _)
AND
DB_WYR_CourageTest_Combatant(_Combatant1)
AND
DB_WYR_CourageTest_Combatant(_Combatant2)
AND
IsAlly(_Combatant1, _NewJoin, 1)
AND
IsEnemy(_Combatant2, _Combatant1, 1)
AND
DB_WYR_CourageTest_Tester(_, _NarCombat)
THEN
SetInNarrativeCombat(_NewJoin, _NarCombat, 1);

IF
AttackedBy(_Combatant, _, _NewJoin, _, _, _, _)
AND
NOT DB_WYR_CourageTest_Combatant((CHARACTER)_NewJoin)
AND
DB_WYR_CourageTest_Combatant((CHARACTER)_Combatant)
AND
DB_WYR_CourageTest_Tester(_, _NarCombat)
THEN
SetInNarrativeCombat(_NewJoin, _NarCombat, 1);

IF
UsingSpellOnTarget(_NewJoin, _Combatant, _, _, _, _)
AND
NOT DB_WYR_CourageTest_Combatant((CHARACTER)_NewJoin)
AND
DB_WYR_CourageTest_Combatant((CHARACTER)_Combatant)
AND
DB_WYR_CourageTest_Tester(_, _NarCombat)
THEN
SetInNarrativeCombat(_NewJoin, _NarCombat, 1);

IF
UsingSpellOnZoneWithTarget(_NewJoin, _Combatant, _, _, _, _)
AND
NOT DB_WYR_CourageTest_Combatant((CHARACTER)_NewJoin)
AND
DB_WYR_CourageTest_Combatant((CHARACTER)_Combatant)
AND
DB_WYR_CourageTest_Tester(_, _NarCombat)
THEN
SetInNarrativeCombat(_NewJoin, _NarCombat, 1);

//END_REGION

IF
EnteredCombat(_Character, _Combat)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character, _Combat)
AND
DB_WYR_CourageTrial_Enemies(0, (CHARACTER)_Enemy)
AND
DB_Is_InCombat(_Enemy, _Combat)
AND
QRY_OnlyOnce("WYR_Wyrmway_CourageTrial_Start")
THEN
PROC_WYR_CourageTrial_Step(_Character);

IF
EnterCombatFailed(_Enemy, _Character)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character, _Combat)
AND
DB_WYR_CourageTrial_Enemies(0, (CHARACTER)_Enemy)
AND
QRY_OnlyOnce("WYR_Wyrmway_CourageTrial_Start")
THEN
PROC_WYR_CourageTrial_Step(_Character);

IF
EnterCombatFailed(_Character, _Enemy)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character, _Combat)
AND
DB_WYR_CourageTrial_Enemies(0, (CHARACTER)_Enemy)
AND
QRY_OnlyOnce("WYR_Wyrmway_CourageTrial_Start")
THEN
PROC_WYR_CourageTrial_Step(_Character);

//REGION Old code, from before switch to TurnBasedTimer. Kept for savegame compatibility.

PROC
PROC_WYR_CourageTrial_Setup()
AND
DB_WYR_CourageTest_Tester(_Character)
AND
DB_WYR_CourageTrial_Enemies(0, _Enemy)
THEN
AppearAt(_Enemy, _Enemy, 1, NULL_00000000-0000-0000-0000-000000000000, "WYR_Wyrmsway_InitEnemy", 0);

IF
EntityEvent(_Enemy, "WYR_Wyrmsway_InitEnemy")
AND
DB_WYR_CourageTest_Tester(_Character)
THEN
EnterCombat(_Enemy, _Character);

IF
EnteredCombat(_Enemy, _Combat)
AND
DB_WYR_CourageTrial_Enemies(0, (CHARACTER)_Enemy)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character)
AND
DB_Is_InCombat(_Character, _Combat)
AND
QRY_OnlyOnce("WYR_Wyrmway_CourageTrial_Start")
THEN
PROC_WYR_CourageTrial_Step(_Character);

IF
EnteredCombat(_Character, _Combat)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character)
AND
DB_WYR_CourageTrial_Enemies(0, (CHARACTER)_Enemy)
AND
DB_Is_InCombat(_Enemy, _Combat)
AND
QRY_OnlyOnce("WYR_Wyrmway_CourageTrial_Start")
THEN
PROC_WYR_CourageTrial_Step(_Character);

IF
EnterCombatFailed(_Enemy, _Character)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character)
AND
DB_WYR_CourageTrial_Enemies(0, (CHARACTER)_Enemy)
AND
QRY_OnlyOnce("WYR_Wyrmway_CourageTrial_Start")
THEN
PROC_WYR_CourageTrial_Step(_Character);

IF
EnterCombatFailed(_Character, _Enemy)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character)
AND
DB_WYR_CourageTrial_Enemies(0, (CHARACTER)_Enemy)
AND
QRY_OnlyOnce("WYR_Wyrmway_CourageTrial_Start")
THEN
PROC_WYR_CourageTrial_Step(_Character);

//END_REGION

IF
Unequipped(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, _Character)
AND
NOT DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
AND
NOT DB_WYR_Wyrmway_Solved((ITEM)S_WYM_Wyrmway_CourageIndicator_d020f6ee-1acf-4027-966e-f9049746452f)
THEN
PROC_WYR_Wyrmway_DestroyStatue((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12);

IF
Equipped(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, _Character)
AND
NOT DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
AND
NOT DB_WYR_Wyrmway_Solved((ITEM)S_WYM_Wyrmway_CourageIndicator_d020f6ee-1acf-4027-966e-f9049746452f)
AND
IsInTrigger(_Character, S_WYR_Wyrmway_TestArea_e51e90a0-d436-4bc3-b55d-6276dfa7d81b, 0)
THEN
PROC_WYR_Wyrmway_DestroyStatue((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12);

PROC
PROC_WYR_CourageTrial_TryStep((CHARACTER)_Character)
AND
NOT DB_WYR_Wyrmway_StatueFailed((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
AND
NOT DB_WYR_Wyrmway_Solved((ITEM)S_WYM_Wyrmway_CourageIndicator_d020f6ee-1acf-4027-966e-f9049746452f)
THEN
PROC_WYR_CourageTrial_Step((CHARACTER)_Character);

PROC
PROC_WYR_CourageTrial_Step((CHARACTER)_Character)
AND
DB_GlobalCounter("WYR_CourageTrial",_Count)
AND
DB_WYR_CourageTrial_Torches(_Count, _Trigger, _Name)
THEN
PROC_LoopEffectAtPositionAndRotation(VFX_Script_BGO_TrialOfJustice_Orb_01_d8e78888-c2d3-5cb9-ed43-1eb0a65ea4d0, _Trigger, _Name, "BGO_Main_A", 2.0);


PROC
PROC_WYR_CourageTrial_Step((CHARACTER)_Character)
AND
QRY_IncreaseCounter("WYR_CourageTrial")
AND
DB_GlobalCounter("WYR_CourageTrial",_Count)
AND
_Count < 5
THEN
DB_NOOP(1);
//DebugText(_Character, "Starting timer");
//ObjectTimerLaunch(_Character, "WYR_CourageTrial", 6000, 1);


PROC
PROC_CounterIncreased("WYR_CourageTrial", _Count)
AND
DB_WYR_CourageTrial_Enemies(_Count, _Enemy)
AND
NOT DB_WYR_CourageTest_Tester(_)
THEN
AppearAt(_Enemy, _Enemy, 1, NULL_00000000-0000-0000-0000-000000000000, "WYR_Wyrmsway_InitEnemy", 0);

PROC
PROC_CounterIncreased("WYR_CourageTrial", _Count)
AND
DB_WYR_CourageTrial_Enemies(_Count, _Enemy)
AND
DB_WYR_CourageTest_Tester(_)
THEN
AppearAt(_Enemy, _Enemy, 1, NULL_00000000-0000-0000-0000-000000000000, "", 0);

IF
ObjectTimerFinished(_, "WYR_CourageTest_General")
THEN
PROC_WYR_Wyrmway_PuzzleSolved((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12);

IF
ObjectTimerFinished(_, "WYR_CourageTest_General")
AND
DB_WYR_CourageTest_Tester(_Player, _)
THEN
RemoveStatus(_Player, "WYR_COURAGEBRIGHT", S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);

IF
CombatRoundStarted(_Combat, _)
AND
DB_OnlyOnce("WYR_Wyrmway_CourageTrial_Start")
AND
DB_WYR_CourageTest_Tester(_Character, _Combat)
THEN
PROC_WYR_CourageTrial_TryStep((CHARACTER)_Character);

IF
LeftTrigger(_Character, S_WYR_Wyrmway_TestArea_e51e90a0-d436-4bc3-b55d-6276dfa7d81b)
AND
DB_WYR_CourageTest_Tester(_Character, _)
THEN
SetFlag((FLAG)WYR_CourageTrial_Event_left_2783b6a4-36ab-48d2-9aed-63a2e93405ca, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_WYR_Wyrmway_DestroyStatue((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12);

PROC
PROC_StateSet_Defeated(_Character)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character, _)
THEN
PROC_WYR_Wyrmway_DestroyStatue((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12);

PROC
PROC_WYR_Wyrmway_PuzzleSolved(S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
THEN
PROC_WYR_CourageTrial_Cleanup();

IF
DB_WYR_Wyrmway_StatueFailed(S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12)
THEN
RemoveStatus(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, "BURNING", S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);
PROC_WYR_CourageTrial_Cleanup();

PROC
PROC_WYR_CourageTrial_Cleanup()
THEN
RemoveStatus(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, "WYR_COURAGEBOUND", S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);
TeleportTo(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, S_WYR_CourageTest_TorchPos_fe34da11-5fff-49a6-a51c-851c4f154d13, "", 0, 0, 0, 0, 0);
SetCanInteract(S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04, 0);

PROC
PROC_WYR_CourageTrial_Cleanup()
AND
DB_WYR_CourageTest_Tester(_Character, _Combat)
THEN
TurnBasedTimerCancel(_Character, "WYR_CourageTest_General");
DestroyNarrativeCombat(_Combat);
NOT DB_WYR_CourageTest_Tester(_Character, _Combat);
TriggerUnregisterForCharacter(S_WYR_Wyrmway_TestArea_e51e90a0-d436-4bc3-b55d-6276dfa7d81b, _Character);
RemoveStatus(_Character, "WYR_COURAGEBRIGHT", S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);

//REGION Old code

PROC
PROC_CounterIncreased("WYR_CourageTrial", _Count)
AND
_Count >= 5
AND
DB_WYR_CourageTest_Tester(_Player)
THEN
RemoveStatus(_Player, "WYR_COURAGEBRIGHT", S_WYR_CourageTest_Torch_c0022e77-6409-498b-83d9-2ca43ee4fa04);

IF
LeftTrigger(_Character, S_WYR_Wyrmway_TestArea_e51e90a0-d436-4bc3-b55d-6276dfa7d81b)
AND
DB_WYR_CourageTest_Tester(_Character)
THEN
SetFlag((FLAG)WYR_CourageTrial_Event_left_2783b6a4-36ab-48d2-9aed-63a2e93405ca, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_WYR_Wyrmway_DestroyStatue((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12);

PROC
PROC_StateSet_Defeated(_Character)
AND
DB_WYR_CourageTest_Tester((CHARACTER)_Character)
THEN
PROC_WYR_Wyrmway_DestroyStatue((ITEM)S_WYR_CourageTest_Instructor_f6b033f9-db05-44b9-bdcc-7e50e4736b12);

//END_REGION

PROC
PROC_WYR_CourageTrial_Cleanup()
AND
DB_WYR_CourageTrial_Enemies(_, _Enemy)
AND
NOT DB_PermaDefeated(_Enemy)
AND
IsOnStage(_Enemy, 1)
THEN
PROC_Poof(_Enemy, VFX_Script_PUZ_Wyrmway_TrialOfCourage_Poof_01_cafc2279-b9d5-2e9a-dac9-c7e479bb8875);

//END_REGION

//REGION Balduran's instruction

IF
DialogEnded((DIALOGRESOURCE)WYR_EntranceStatue_21a578ec-2d9e-41c6-4a08-2a264113e37c, _)
AND
DB_GlobalFlag((FLAG)WYR_Balduran_Event_OpenDoor_99e8c929-4b71-3e03-2b43-6e7421896f7a)
AND
QRY_OnlyOnce("WYR_BalduranOpenDoor")
THEN
PROC_ItemUnlockAndOpen(S_WYR_Wyrmway_Entrance_29448775-b702-4ea2-94c0-d40b27844c38);
AutoSave();

IF
UseFinished(_Character, S_WYR_Wyrmway_Entrance_29448775-b702-4ea2-94c0-d40b27844c38, 0)
AND
IsLocked((ITEM)S_WYR_Wyrmway_Entrance_29448775-b702-4ea2-94c0-d40b27844c38, 1)
AND
DB_Players(_Character)
AND
QRY_StartDialog_Fixed(WYR_EntranceStatue_21a578ec-2d9e-41c6-4a08-2a264113e37c, S_WYR_EntranceStatue_750036f3-7abc-41b8-8cd0-9b977500d5b3, _Character)
THEN
DB_NOOP(1);

IF
Unlocked(S_WYR_Wyrmway_Entrance_29448775-b702-4ea2-94c0-d40b27844c38, _, _)
THEN
SetFlag(WYR_Wyrmway_State_EntryOpened_d8cad828-82f3-4a9b-ad0d-6f1637792d4e, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DestroyedBy(S_WYR_Wyrmway_Entrance_29448775-b702-4ea2-94c0-d40b27844c38, _, _, _)
THEN
SetFlag(WYR_Wyrmway_State_EntryOpened_d8cad828-82f3-4a9b-ad0d-6f1637792d4e, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(WYR_Wyrmway_State_EntryOpened_d8cad828-82f3-4a9b-ad0d-6f1637792d4e, _, _)
AND
DB_Avatars(_Avatar)
THEN
SetFlag(TG_WYR_Wyrmway_32db8446-492b-46f9-81d1-57f220c78be8, _Avatar, 0);

IF
DB_WYR_Wyrmway_Setup(1)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
SetFlag((FLAG)WYR_Balduran_State_WyllCanGetHelm_c68c52ba-469e-facf-aedd-eb4085be3ce4);

IF
DB_GlobalFlag((FLAG)WYR_Balduran_State_WyllCanGetHelm_c68c52ba-469e-facf-aedd-eb4085be3ce4)
AND
NOT DB_PartOfTheTeam((CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d)
THEN
ClearFlag((FLAG)WYR_Balduran_State_WyllCanGetHelm_c68c52ba-469e-facf-aedd-eb4085be3ce4);

IF
DialogEnded(WYR_FinalRoomEntrance_Statue_fb1b38bf-70e0-e884-5d5d-c014b0163557, _)
THEN
PROC_ItemUnlockAndOpen(S_WYR_Wyrmway_FinalRoomDoor_0462ed30-eb7e-4086-bb16-a17026e0c36a);

IF
UseFinished(_Player, S_WYR_Wyrmway_FinalRoomDoor_0462ed30-eb7e-4086-bb16-a17026e0c36a, 0)
AND
DB_Players(_Player)
AND
IsLocked(S_WYR_Wyrmway_FinalRoomDoor_0462ed30-eb7e-4086-bb16-a17026e0c36a, 1)
AND
QRY_StartDialog_Fixed(S_WYR_FinalRoomEntrance_Statue_Indestructible_3bcbf351-946b-4c72-b313-ce4b491b5902, S_WYR_FinalRoomEntrance_Statue_2867a964-6f66-46a0-b430-ec28a1b1d04d, _Player)
THEN
DB_NOOP(1);

//END_REGION

//REGION Skeletal Dragon
PROC
PROC_BlockLootCorpse(_Player, S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
DB_Players(_Player)
AND
DB_State_Current(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "Dead")
AND
NOT DB_CantTalk_IgnoreStatuses(_Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)WYR_AnsurGhost_HelmetPickup_7fe755b8-967a-f495-7e06-de5d4122960e, S_WYR_AnsurGhost_4be5ac7c-2ce0-4e9a-9526-d16d3e4db2d2, _Player)
THEN
PROC_WYR_SkeletalDragon_RemoveHidden(_Player);
Transform(S_WYR_AnsurGhost_4be5ac7c-2ce0-4e9a-9526-d16d3e4db2d2, _Player, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
CopyCharacterEquipment(S_WYR_AnsurGhost_4be5ac7c-2ce0-4e9a-9526-d16d3e4db2d2, _Player);
DB_CustomLootCorpseResponse(_Player, S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, 0);

PROC
PROC_WYR_SkeletalDragon_RemoveHidden((CHARACTER)_Player)
AND
DB_HiddenCharacters(_Player, _Reason)
THEN
RemoveStatus(_Player, _Reason, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_BlockLootCorpse(_Player, S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
DB_Players(_Player)
AND
DB_State_Current(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "Dead")
AND
DB_DialogSpeakers(_DialogInst, S_WYR_AnsurGhost_4be5ac7c-2ce0-4e9a-9526-d16d3e4db2d2, _)
THEN
PROC_DialogAddListeningActor(_DialogInst, _Player);
DB_CustomLootCorpseResponse(_Player, S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, 0);

IF
EnteredTrigger(_Player, S_WYR_Wyrmway_SUB_DragonArena_4e0cb53d-8cf6-446c-b86a-7ef480938db9)
AND
DB_PartyMembers(_Player)
AND
NOT DB_WYR_Wyrmway_StatueFailed(_)
AND
QRY_OnlyOnce("WYR_Wyrmway_SolvedTrials")
THEN
QuestUpdate(_Player, "HIDDEN_BGO_Boosters", "WYR_Wyrmway_SolvedTrials");

IF
EnteredTrigger(_Player, S_WYR_Wyrmway_SUB_DragonArena_4e0cb53d-8cf6-446c-b86a-7ef480938db9)
AND
DB_PartyMembers(_Player)
AND
DB_WYR_Wyrmway_StatueFailed(_)
AND
QRY_OnlyOnce("WYR_Wyrmway_Entered_FailedTrials")
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_Wyrmway_State_EnteredLair_NoSolution_aa27b11f-0645-4591-b144-a225fe8067ed);

PROC
PROC_BlockMoveOfItem(_Character, S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0)
AND
NOT DB_Players(_Character)
THEN
PROC_WYR_TriedTakeHelmet(_Character);
DB_CustomMoveItemResponse(_Character, S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0, 0);


PROC
PROC_BlockMoveOfItem(_Character, S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0)
AND
NOT DB_State_Current(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "DeadAgain")
THEN
PROC_WYR_TriedTakeHelmet(_Character);
DB_CustomMoveItemResponse(_Character, S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0, 0);

PROC
PROC_BlockPickupOfItem(_Character, S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0)
AND
DB_Players(_Character)
AND
DB_State_Current(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "DeadAgain")
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)WYR_AnsurGhost_a4d1b437-aa2f-b343-bf27-a336b42b5dee, S_WYR_AnsurGhost_4be5ac7c-2ce0-4e9a-9526-d16d3e4db2d2, _Character)
THEN
PROC_WYR_TriedTakeHelmet(_Character);
DB_CustomPickupItemResponse(_Character, S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0, 0);

PROC
PROC_WYR_TriedTakeHelmet((CHARACTER)_Character)
THEN
PROC_RemoveOneShotVoiceBarkTrigger(S_WYR_SkeletalDragon_AD_Noticed_1f2747d2-cb1c-4fff-b788-869bda9e0d74, WYR_SkeletalDragon_VB_NotSent_a0085eb5-0caf-d855-66f4-9b4d5e03997e);
PROC_RemoveOneShotVoiceBarkTrigger(S_WYR_SkeletalDragon_AD_Noticed_1f2747d2-cb1c-4fff-b788-869bda9e0d74, WYR_SkeletalDragon_VB_Sent_54e82376-bf88-70cc-f6ea-86213c8a8b95);

PROC
PROC_WYR_TriedTakeHelmet((CHARACTER)_Character)
AND
NOT DB_State_Current(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "DeadAgain")
THEN
PROC_TryStartAD((DIALOGRESOURCE)WYR_HelmetOfBalduran_AD_PickupFail_08f839f1-1041-bd96-7ec7-08a334952c8d, S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0);


IF
DialogEnded(WYR_AnsurGhost_HelmetPickup_7fe755b8-967a-f495-7e06-de5d4122960e, _ID)
AND
DB_DialogPlayers(_ID, _Player, _)
THEN
PROC_TriggerRegisterForParty(S_WYR_SkeletalDragon_BattleTrigger_c3bd7b80-78e7-45f2-967d-ba6a3be30c50);
DB_WYR_DragonCombatCandidates(_Player);
PROC_State_Progress(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "Risen");
AiAddInterestingItem((CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, (ITEM)S_WYR_SkeletalDragon_FlyHelper_000_2f0bf64f-fede-4101-b895-bb91800a6e17);
AiAddInterestingItem((CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, (ITEM)S_WYR_SkeletalDragon_FlyHelper_001_bcf447bb-8d2f-43ee-b0e3-268d0d9c461e);
AiAddInterestingItem((CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, (ITEM)S_WYR_SkeletalDragon_FlyHelper_002_63b17cad-733a-4015-b777-3e634e623793);
AiAddInterestingItem((CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, (ITEM)S_WYR_SkeletalDragon_FlyHelper_003_c0f893de-e102-4278-ae73-44f88a54f273);
Resurrect(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, NULL_00000000-0000-0000-0000-000000000000, 1);
ApplyStatus(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_DRAGONANIMATED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
AppearAt((CHARACTER)S_WYR_SkeletonDragon_Minion_01_9bb09a03-955a-4ecb-b1ea-4a5d83ec2b7e, S_WYR_SkeletonDragon_Minion_AppearPos_01_690ebda5-1136-4ce5-9d65-df244499703c, 1, NULL_00000000-0000-0000-0000-000000000000, "");
AppearAt((CHARACTER)S_WYR_SkeletonDragon_Minion_02_df015249-8648-46a7-9fe7-8ea64342eb59, S_WYR_SkeletonDragon_Minion_AppearPos_02_57bc3b3a-89de-4dff-aba0-0b21160b199e, 1, NULL_00000000-0000-0000-0000-000000000000, "");

IF
Died(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
DB_State_Current(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "Dead")
THEN
SetOnStage(S_WYR_SkeletalDragonBlocker_67511a5c-75f8-496c-81c6-17d4820c2b38, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_001_68f502f3-0833-4d48-ac34-38f800a54c63, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_002_342df486-09b7-4259-bc4e-ddc96a010571, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_003_2826c2c1-f846-4320-a76a-8b88558773dc, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_004_6bcdd409-9503-4b1b-a69f-b284b2e4b644, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_005_50bbde3b-48a2-4dcd-be67-f19f612372b3, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_006_e49292d1-3320-47ad-a0a1-c6aea3b839c1, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_007_7215d6ab-0c4f-4c6c-84fe-8a087152078d, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_008_a11d3452-8ac9-4441-8077-54e8d30c046e, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_009_e7162ac4-22f9-4c15-8afb-2a4817982c4d, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_010_b22845fa-8463-4b71-bb25-4e9bc68376e9, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_011_ada3a431-2465-40c6-a380-9afac2bcd128, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_012_c6a9a13e-3fb6-4b88-a6c9-5b7180d463ed, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_014_0ea74d6a-1644-40e2-9fb5-6e88b8445536, 1);
SetOnStage(S_WYR_SkeletalDragonBlocker_015_cf2f3042-76d5-4868-b8f5-20413f1b52e5, 1);

IF
Resurrected(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
DB_WYR_DragonCombatCandidates(_Player)
THEN
EnterCombat((CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, _Player);


IF
Resurrected(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
THEN
SetOnStage(S_WYR_SkeletalDragonBlocker_67511a5c-75f8-496c-81c6-17d4820c2b38, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_001_68f502f3-0833-4d48-ac34-38f800a54c63, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_002_342df486-09b7-4259-bc4e-ddc96a010571, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_003_2826c2c1-f846-4320-a76a-8b88558773dc, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_004_6bcdd409-9503-4b1b-a69f-b284b2e4b644, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_005_50bbde3b-48a2-4dcd-be67-f19f612372b3, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_006_e49292d1-3320-47ad-a0a1-c6aea3b839c1, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_007_7215d6ab-0c4f-4c6c-84fe-8a087152078d, 0);
SetOnStage(S_WYR_SkeletalDragonBlocker_008_a11d3452-8ac9-4441-8077-54e8d30c046e, 0);

//REGION Combat

IF
Resurrected(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
THEN
PROC_Combat_Dragon_ProxySetup("WYR_SkeletalDragon");
NOT DB_CanBeResurrected(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a);
//Force cast Super Nova (temporary solution)
IF
TurnStarted(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
HasActiveStatus(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"DRAGON_SKELETAL_FLIGHTSTATE",1)
AND
GetPosition(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,_X,_Y,_Z)
THEN
SetEntityEventReal(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"GLO_CombatWait",2.5);
PROC_WYR_SkeletalDragon_NovaCam();
UseSpellAtPosition(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"Projectile_SuperNova_Dragon_Skeletal",_X,_Y,_Z);

PROC
PROC_WYR_SkeletalDragon_NovaCam()
AND
DB_Players(_Player)
THEN
SendArenaCameraEvent(_Player, S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_Wyrmway_SuperNova");

IF
TextEvent("SkeletalDragon_NovaCam")
AND
GetHostCharacter(_Char)
THEN
DebugText(_Char, "SkeletalDragon_NovaCam");
PROC_WYR_SkeletalDragon_NovaCam();

//Toggle Proxies while in Flight State
IF
StatusApplied(_Dragon,"DRAGON_SKELETAL_FLIGHTSTATE",_,_)
AND
DB_Combat_Dragon_ProxyOwner((CHARACTER)_Dragon,(STRING)_ID)
AND
DB_Combat_Dragon_HitProxies((CHARACTER)_Proxies,(STRING)_ID)
THEN
SetOnStage(_Proxies,0);

IF
StatusRemoved(_Dragon,"DRAGON_SKELETAL_FLIGHTSTATE",_,_)
AND
DB_Combat_Dragon_ProxyOwner((CHARACTER)_Dragon,(STRING)_ID)
AND
DB_Combat_Dragon_HitProxies((CHARACTER)_Proxies,(STRING)_ID)
THEN
SetOnStage(_Proxies,1);

//Set temp atmosphere if we aren't already in Phase 2 (stormy)
IF
StatusApplied(_Dragon,"DRAGON_SKELETAL_FLIGHTSTATE",_,_)
AND
NOT DB_WYR_SkeletalDragon_Phase2Start(1)
THEN
TriggerSetAtmosphere((TRIGGER)ATM_WyrmsWayArena_A_96fb8d2b-70eb-45f1-ba5d-fc9feadf2047,"d216497f-2586-441f-e020-b8870646e26f");

//Phase 2, start spawning Lightning
IF
StatusApplied(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"DRAGON_SKELETAL_FLIGHTSTATE",_,_)
AND
QRY_OnlyOnce("WYR_SkeletalDragon_AD_Flying")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)WYR_SkeletalDragon_AD_Flying_5fd29653-62fb-aa46-e5a1-c686ecc3de4e, (CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
THEN
SetEntityEventReal(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"GLO_CombatWait", -1.00, 1);

IF
AutomatedDialogEnded(WYR_SkeletalDragon_AD_Flying_5fd29653-62fb-aa46-e5a1-c686ecc3de4e, _)
THEN
SetEntityEvent(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"GLO_CancelCombatWait", 1);

IF
CastedSpell(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"Projectile_SuperNova_Dragon_Skeletal",_,_,_)
AND
NOT DB_WYR_SkeletalDragon_Phase2Start(1)
THEN
DB_WYR_SkeletalDragon_Phase2Start(1);

IF
DB_WYR_SkeletalDragon_Phase2Start(1)
THEN
TriggerSetAtmosphere((TRIGGER)ATM_WyrmsWayArena_A_96fb8d2b-70eb-45f1-ba5d-fc9feadf2047,"65f0f633-0a64-e556-7b8e-2a41f6f323ab");

IF
CombatRoundStarted(_CombatId,_)
AND
DB_Is_InCombat(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,_CombatId)
AND
DB_WYR_SkeletalDragon_Phase2Start(1)
THEN
UseSpell(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"ProjectileStrike_WYR_LightningStrike_Spawner",S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a);
IterateCharactersAround(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,60.0,"WYR_SkeletalDragon_TrySpawnLightningStrike","WYR_SkeletalDragon_LightningStrike_IteratorEnd");

IF
EntityEvent(_Char,"WYR_SkeletalDragon_TrySpawnLightningStrike")
AND
QRY_WYR_SkeletalDragon_CanSpawnMoreLightningStrikes()
AND
QRY_IsEnemy(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,_Char)
AND
DB_Is_InCombat(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,_CombatId)
AND
DB_Is_InCombat(_Char,_CombatId)
AND
IsTagged(_Char,(TAG)HIT_PROXY_1b1a83c5-4fc9-488f-b4ed-0fcf844b1f5c,0)
AND
CreateAtObject(Quest_CMB_LightningStrike_0febed02-0ae8-4076-9f7b-65bff3b4121d,_Char,1,0,"",0,_)
THEN
DB_WYR_SkeletalDragon_LightningStrikeTargets(_Char);


QRY
QRY_WYR_SkeletalDragon_CanSpawnMoreLightningStrikes()
AND
SysCount("DB_WYR_SkeletalDragon_LightningStrikeTargets", 1, _CurrentValue)
AND
DB_WYR_SkeletalDragon_MaxLightningStrikes(_Max)
AND
_CurrentValue < _Max
THEN
DB_NOOP(1);

IF
EntityEvent(_,"WYR_SkeletalDragon_LightningStrike_IteratorEnd")
AND
DB_WYR_SkeletalDragon_LightningStrikeTargets(_Char)
THEN
NOT DB_WYR_SkeletalDragon_LightningStrikeTargets(_Char);

IF
Dying((CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
THEN
TriggerSetAtmosphere((TRIGGER)ATM_WyrmsWayArena_A_96fb8d2b-70eb-45f1-ba5d-fc9feadf2047,"262e6f84-3870-2b52-3e09-8dbf8b91be39");

IF
Dying((CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
NOT DB_CantTalk_IgnoreCombatDead(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
NOT QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)WYR_SkeletalDragon_AD_Dying_13d851c5-a60f-1be6-3b6b-2d92f7f81648, S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, 0, 0, 0, 0)
AND
QRY_OnlyOnce("WYR_SkeletalDragon_VB_Died_Start")
THEN
TimerLaunch("WYR_SkeletalDragon_VB_Died", 2000);

IF
AutomatedDialogEnded((DIALOGRESOURCE)WYR_SkeletalDragon_AD_Dying_13d851c5-a60f-1be6-3b6b-2d92f7f81648, _)
AND
QRY_OnlyOnce("WYR_SkeletalDragon_VB_Died_Start")
THEN
TimerLaunch("WYR_SkeletalDragon_VB_Died", 1000);

PROC
PROC_StateSet_PermaDefeated((CHARACTER)S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
QRY_OnlyOnce("WYR_SkeletalDragon_VB_Died_Start")
THEN
TimerLaunch("WYR_SkeletalDragon_VB_Died", 1000);

IF
TimerFinished("WYR_SkeletalDragon_VB_Died")
AND
IsInTrigger(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, S_WYR_SkeletalDragon_BattleTrigger_c3bd7b80-78e7-45f2-967d-ba6a3be30c50, 1)
AND
QRY_SpeakerIsAvailable(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, 1, 0)
AND
QRY_OnlyOnce("WYR_SkeletalDragon_VB_Died")
THEN
StartVoiceBark(WYR_SkeletalDragon_VB_Died_a2d902ae-dca6-e1b6-ca4a-17c00480f190, (CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);

IF
TimerFinished("WYR_SkeletalDragon_VB_Died")
AND
QRY_OnlyOnce("WYR_SkeletalDragon_VB_Died")
AND
QRY_GetClosestAvailableCharacterTo(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1, 0, 1)
AND
DB_ClosestAvailableCharacterTo(_Character, S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, _)
AND
IsInTrigger(_Character, S_WYR_SkeletalDragon_BattleTrigger_c3bd7b80-78e7-45f2-967d-ba6a3be30c50, 1)
THEN
StartVoiceBark(WYR_SkeletalDragon_VB_Died_a2d902ae-dca6-e1b6-ca4a-17c00480f190, _Character);

IF
UsingSpell(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "Shout_FrightfulPresence_Dragon_Skeletal", _, _, _)
AND
QRY_OnlyOnce("WYR_SkeletalDragon_AD_FrightfulPresence")
THEN
PROC_TryStartAD((DIALOGRESOURCE)WYR_SkeletalDragon_AD_LightningBreath_dfd050f1-1b18-2a18-c4f2-18a26e57ee3a, S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a);

IF
TurnStarted(_Character)
AND
DB_PartyMembers((CHARACTER)_Character)
AND
DB_Is_InCombat(_Character, _Combat)
AND
DB_Is_InCombat(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, _Combat)
AND
HasActiveStatus(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "DRAGON_SKELETAL_FLIGHTSTATE", 1)
AND
QRY_OnlyOnce("WYR_SkeletalDragon_PAD_AirAttack")
THEN
PROC_WYR_SkeletalDragon_DoAirAttackAD(_Character);

PROC
PROC_WYR_SkeletalDragon_DoAirAttackAD((CHARACTER)_Character)
AND
DB_Players(_Character)
THEN
PROC_TryStartAD((DIALOGRESOURCE)WYR_SkeletalDragon_PAD_AirAttack_32561d86-e35b-e74e-3f22-231c3c514b56, _Character);

//Remove strikes when Dragon dying
IF
Dying(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
DB_Is_InCombat(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, _Combat)
AND
DB_Is_InCombat(_LightningStrike, _Combat)
AND
IsItem(_LightningStrike,1)
AND
HasActiveStatus(_LightningStrike,"WYR_LIGHTNINGSTRIKE_TARGET",1)
THEN
SetOnStage(_LightningStrike,0);

IF
Died(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
DB_Is_InCombat(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, _Combat)
AND
DB_Is_InCombat(_LightningStrike, _Combat)
AND
IsItem(_LightningStrike,1)
AND
HasActiveStatus(_LightningStrike,"WYR_LIGHTNINGSTRIKE_TARGET",1)
THEN
SetOnStage(_LightningStrike,0);

//Delay the AI to wait for the Camera after using a flight spell
IF
CastSpell(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"Target_Fly_Dragon_Skeletal",_,_,_)
THEN
SetEntityEventReal(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"GLO_CombatWait",2.0);


//REGION Look at nearest player after using flight spell and steer towards them
IF
CastedSpell((CHARACTER)_Dragon,"Target_Fly_Dragon_Skeletal",_,_,_)
THEN
PROC_WYR_SkeletalDragon_FindSteerToTargetCandidate(_Dragon);

IF
CastSpellFailed((CHARACTER)_Dragon,"Target_Fly_Dragon_Skeletal",_,_,_)
THEN
PROC_WYR_SkeletalDragon_FindSteerToTargetCandidate(_Dragon);

//Determine steerTo candidates
PROC
PROC_WYR_SkeletalDragon_FindSteerToTargetCandidate((CHARACTER)_Dragon)
AND
QRY_WYR_SkeletalDragon_FindClosestEnemy(_Dragon)
AND
DB_QRYRTN_WYR_SkeletalDragon_ClosestEnemy(_Enemy, _Distance)
THEN
NOT DB_QRYRTN_WYR_SkeletalDragon_ClosestEnemy(_Enemy, _Distance);
SteerTo(_Dragon,_Enemy,0);

QRY
QRY_WYR_SkeletalDragon_FindClosestEnemy((CHARACTER)_Dragon)
AND
DB_Is_InCombat(_Dragon, _Combat)
AND
DB_Is_InCombat(_Enemy, _Combat)
AND
QRY_IsEnemy(_Dragon, _Enemy)
AND
HasActiveStatusWithGroup(_Enemy, "SG_Invisible", 0)
AND
GetDistanceTo(_Dragon, _Enemy, _Distance)
THEN
DB_QRYRTN_WYR_SkeletalDragon_ClosestEnemy(_Enemy, _Distance);

IF
DB_QRYRTN_WYR_SkeletalDragon_ClosestEnemy(_Enemy1, _Distance1)
AND
DB_QRYRTN_WYR_SkeletalDragon_ClosestEnemy(_Enemy2, _Distance2)
AND
_Enemy1 != _Enemy2
AND
_Distance1 >= _Distance2
THEN
NOT DB_QRYRTN_WYR_SkeletalDragon_ClosestEnemy(_Enemy1, _Distance1);
//END_REGION


IF
CastSpell(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"Target_Fly_Dragon_Skeletal_EnterFlightState_Far",_,_,_)
THEN
SetEntityEventReal(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a,"GLO_CombatWait",2.0);

//END_REGION

//TODO: Fix this terrible hack.
IF
EnteredTrigger(_Character, S_WYR_SkeletalDragon_BattleTrigger_c3bd7b80-78e7-45f2-967d-ba6a3be30c50)
THEN
SetCombatGroupID(_Character, "c35f40b0-6433-456a-955f-d945852ea23e");

IF
LeftTrigger(_Character, S_WYR_SkeletalDragon_BattleTrigger_c3bd7b80-78e7-45f2-967d-ba6a3be30c50)
THEN
SetCombatGroupID(_Character, "");

PROC
PROC_StateSet_PermaDefeated(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
THEN
SetFlag(WYR_SkeletalDragon_State_Defeated_bafbffed-bb3f-43b0-a006-7bac257a633c, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_State_IfCurrentProgress(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "Risen", "DeadAgain");

PROC
PROC_StateSet_PermaDefeated(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
NOT DB_Dead(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
THEN
PROC_TriggerRegisterForPlayers(S_WYR_SkeletalDragon_PostBattleDialog_5b56f398-13a9-47f1-99c6-4decb24f7a82);

IF
DB_Dead(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a)
AND
DB_State_Current(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "DeadAgain")
THEN
TimerLaunch("WYR_SkeletalDragon_DeathDialogDelay", 11000);

IF
TimerFinished("WYR_SkeletalDragon_DeathDialogDelay")
THEN
PROC_TriggerRegisterForPlayers(S_WYR_SkeletalDragon_PostBattleDialog_5b56f398-13a9-47f1-99c6-4decb24f7a82);

PROC
PROC_State_Changed(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, _, "DeadAgain")
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_FolkHero_JaheiraFamilyKept"); //Was misnamed in the DB, sticking with the naming.

PROC
PROC_State_Changed(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, _, "DeadAgain")
AND
IsInInventory((ITEM)S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0, 0)
THEN
PlayEffect(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, VFX_Script_WYR_AnsurGhost_HelmetPickup_01_a61c7ca3-1b64-7988-12a5-917a4e3f2d69, "", 0.0);
PlayEffect(S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0, VFX_Script_WYR_AnsurGhost_HelmetPickup_02_5bd351df-f9dc-f518-ae70-3f56a6948730, "", 0.0);

PROC
PROC_State_Changed(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, _, "DeadAgain")
AND
IsInInventory((ITEM)S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0, 1)
AND
GetInventoryOwner(S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0, _Holder)
THEN
PlayEffect(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, VFX_Script_WYR_AnsurGhost_HelmetPickup_01_a61c7ca3-1b64-7988-12a5-917a4e3f2d69, "", 0.0);
PlayEffect(_Holder, VFX_Script_WYR_AnsurGhost_HelmetPickup_02_5bd351df-f9dc-f518-ae70-3f56a6948730, "", 0.0);

IF
DB_State_Current(S_WYR_SkeletalDragon_67770922-5e0a-40c5-b3f0-67e8eb50493a, "WYR_SkeletalDragon", "DeadAgain")
AND
DB_InRegion(_Character, S_WYR_SkeletalDragon_PostBattleDialog_5b56f398-13a9-47f1-99c6-4decb24f7a82)
AND
DB_Players(_Player)
AND
NOT DB_CantTalk(_Player)
AND
NOT DB_OnlyOnce("WYR_AnsurGhost")
THEN
TeleportTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,_Player);
PROC_WYR_TryStart_DaisyEmperorBalduran((CHARACTER)_Player);

PROC
PROC_DialogFlagSetup(WYR_DaisyEmperorBalduran_fe2393a8-08d6-4be5-e669-55562b193275, _, _)
THEN
DB_OnlyOnce("WYR_AnsurGhost");
PROC_TriggerUnregisterForParty(S_WYR_SkeletalDragon_BattleTrigger_c3bd7b80-78e7-45f2-967d-ba6a3be30c50);

IF
FlagSet((FLAG)ORI_Wyll_Knows_SentToFindAnsur_9bc505eb-3531-2f9e-1e55-477ed0e475bc, _, _)
AND
DB_OneShot_VoiceBarkTrigger(S_WYR_SkeletalDragon_AD_Noticed_1f2747d2-cb1c-4fff-b788-869bda9e0d74, WYR_SkeletalDragon_VB_NotSent_a0085eb5-0caf-d855-66f4-9b4d5e03997e)
THEN
PROC_RemoveOneShotVoiceBarkTrigger(S_WYR_SkeletalDragon_AD_Noticed_1f2747d2-cb1c-4fff-b788-869bda9e0d74, WYR_SkeletalDragon_VB_NotSent_a0085eb5-0caf-d855-66f4-9b4d5e03997e);
DB_OneShot_VoiceBarkTrigger(S_WYR_SkeletalDragon_AD_Noticed_1f2747d2-cb1c-4fff-b788-869bda9e0d74, WYR_SkeletalDragon_VB_Sent_54e82376-bf88-70cc-f6ea-86213c8a8b95);


//END_REGION

//REGION Placeholder - React to lightning damage

IF
AttackedBy(S_WYR_Wyrmway_EntranceTorch1_41d2664a-a8f2-4350-b208-2d05a13e56ea, _, _, "Lightning", _, _, _)
THEN
SetEntityEvent(S_WYR_Wyrmway_AccessHelper1_e477fa58-b0be-491a-bfd1-b8586dd67c54, "WYR_Wyrmway_Torch1Hit", 1);

IF
AttackedBy(S_WYR_Wyrmway_EntranceTorch2_8e463282-657a-4c84-a37c-ec40691613ea, _, _, "Lightning", _, _, _)
THEN
SetEntityEvent(S_WYR_Wyrmway_AccessHelper2_7d05e3e8-2ac9-4c31-96bb-c73592febe25, "WYR_Wyrmway_Torch2Hit", 1);

//END_REGION

//REGION Track total state in flags

IF
DB_GlobalCounter("WYR_Wyrmway_Successes", _Count)
AND
DB_WYR_WyrmwayTrials_EnterThresholds(_Count, _Flag, _)
AND
NOT DB_GlobalFlag(_Flag)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

IF
DB_GlobalCounter("WYR_Wyrmway_Successes", _Count)
AND
DB_WYR_WyrmwayTrials_EnterThresholds(_OtherCount, _Flag, _)
AND
_OtherCount != _Count
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

IF
DB_GlobalCounter("WYR_Wyrmway_Successes", _Successes)
AND
DB_GlobalCounter("WYR_Wyrmway_Successes", _Failures)
AND
IntegerSum(_Successes, _Failures, 4)
THEN
PROC_GlobalSetFlagAndCache(WYR_WyrmwayTrials_State_AllCompleted_6e32b80e-1faa-46b3-b6e4-f43ff74b26f8);

IF
DB_GlobalCounter("WYR_Wyrmway_Successes", _Successes)
AND
DB_GlobalCounter("WYR_Wyrmway_Entered", _Entered)
AND
IntegerSubtract(_Successes, _Entered, _Left)
AND
DB_WYR_WyrmwayTrials_EnterThresholds(_Left, _, _Flag)
AND
_Flag != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_GlobalSetFlagAndCache(_Flag);

IF
DB_GlobalCounter("WYR_Wyrmway_Successes", _Successes)
AND
DB_GlobalCounter("WYR_Wyrmway_Entered", _Entered)
AND
DB_WYR_WyrmwayTrials_EnterThresholds(_NotLeft, _, _Flag)
AND
DB_GlobalFlag(_Flag)
AND
IntegerSubtract(_Successes, _Entered, _Left)
AND
_NotLeft != _Left
THEN
PROC_GlobalClearFlagAndCache(_Flag);

//END_REGION

//REGION Final Exit

IF
Moved(S_WYR_HelmetOfBalduran_36a4f0eb-1ac7-4fc5-87f5-f74ec49afec0)
AND
QRY_OnlyOnce("WYR_Wyrmway_OpenExit")
AND
GetPosition(S_WYR_Wyrmway_BaldursHelmetAltar_FinalPosition_2d7f02b8-9aec-43ba-b970-fc789b4ffd28, _X, _Y, _Z)
THEN
SetOnStage(S_WYR_SkeletalHelmetBlocker_02_91f115a3-034c-4c8a-91fa-e65de495fc9f, 0);
SetOnStage(S_WYR_SkeletalHelmetBlocker_01_9d8d47eb-26af-4e18-b367-f7311d0b858d, 0);
PlatformMoveTo(S_WYR_Wyrmway_BaldursHelmetAltar_26862c57-be3b-44d1-92b5-45ece501228d, _X, _Y, _Z, 3.0, "", 1);
Open(S_DOOR_WyrmwayReturnPoint_SecretSlidingWall_A_000_a61030a0-da9f-448f-b697-ec3df1d5e4f5);
Open(S_WYR_Wyrmway_ExitDoor_a3df5271-1843-4b79-af92-b4a9a1b4738a);

//END_REGION

//REGION Track who's in the region

IF
EnteredTrigger(_Character, S_WYR_Wyrmway_SUB_ac5390a3-ced8-477e-80ee-881b2e8372ef)
AND
DB_Players(_Character)
THEN
SetFlag((FLAG)WYR_Wyrmway_State_InWyrmway_d4bc7aa7-82ff-5a3e-df31-8153b372839a, _Character, 0);

IF
LeftTrigger(_Character, S_WYR_Wyrmway_SUB_ac5390a3-ced8-477e-80ee-881b2e8372ef)
AND
DB_Players(_Character)
THEN
ClearFlag((FLAG)WYR_Wyrmway_State_InWyrmway_d4bc7aa7-82ff-5a3e-df31-8153b372839a, _Character, 0);


//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3"
