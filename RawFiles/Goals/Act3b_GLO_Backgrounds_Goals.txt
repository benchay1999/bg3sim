Version 1
SubGoalCombiner SGC_AND
INITSECTION
//All DB_GLO-BackgroundGoal entries were already added into GLO_BackgroundGoald.txt goal file. Check there before adding new stuff in DB_GLO_Backgrounds_Goal, please.
//REGION Acolyte
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)GLO_Orin_State_AgreedToKillGortash_39af75d8-2442-8667-551e-6a0dc699398b, "Act3_Acolyte_AcceptedOrinAlliance");
DB_GLO_Backgrounds_ChainAfterCharacterFlag((FLAG)LOW_WaterQueensHouse_State_OfferingGiven_30ab72c4-2730-495e-4266-043aeab7efd1, "Act3_Acolyte_WaveFuneralOfferingGiven");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060, "Act3_Acolyte_MurderTribunalCompleted");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_WaterQueensHouse_State_OfferingGiven_30ab72c4-2730-495e-4266-043aeab7efd1, "Act3_Acolyte_WaveFuneralOfferingGiven");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_HouseOfGrief_Event_DetermineHeartForm_f2f9c186-bb12-4916-a26c-7f62d1193c1b, "Act3_Acolyte_CompletedMappingOfTheHeart");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83, "Act3_Acolyte_BhaalTempleFound");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_KurwinCoffin_HasMet_KidNecromancer_Calmed_b96fbcfb-ab4c-06b9-2082-9535bb71bb40, "Act3_Acolyte_NinaDylemaResolved");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_KurwinCoffin_State_KidNecromancer_RaisedBrotherFromDead_50f20126-fafe-f712-8e3d-08d521ea183d, "Act3_Acolyte_NinaDylemaResolved");
//END_REGION

//REGION Charlatan
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Tusgront_State_AllowedAccess_fb3bb79c-82b6-4580-93b5-18e7839bad6c,"Act3_Charlatan_TrusgrontUndercellaAccess");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_FireworksHouse_Event_UsedPassword_a1db6ba2-5535-4c96-aa27-b7736625fa6c, "Act3_Charlatan_GainedAccessToAveryWorkshop");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_KurwinCoffin_State_ScaredKoboldLeader_e9c5bff9-ebf7-2212-e632-ee24b6c7c1d1, "Act3_Charlatan_RetrievedBugthimbleGold");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Elfsong_GetDiscount_Camp_1bfbea74-7eba-4b31-7999-d41508ede906, "Act3_Charlatan_ElfsongRoomRebate");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Charlatan_SidedWithGuild");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366, "Act3_Charlatan_SidedWithZhents");
//Betrayal
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd, "Act3_Charlatan_AllianceBetrayed");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_BlushingMermaid_State_PlayerBrokeDealWithHag_1e69b66d-9f46-4df5-aeb4-56382f8b1001, "Act3_Charlatan_AllianceBetrayed");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425, "Act3_Charlatan_AllianceBetrayed");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Nightsong_State_WasDeceivedToGoToRamazith_7ceb07f0-a5ce-4542-b76b-141f2985caf1, "Act3_Charlatan_AllianceBetrayed");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)END_IllithidOptions_Event_OrpheusPathLaezelBetrayed_2be665c6-da32-4e78-bae2-a83fb1b72368, "Act3_Charlatan_AllianceBetrayed");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)END_IllithidOptions_Event_VlaakithPathLaezelBetrayed_9d571d9a-fe2c-41eb-9e2c-2667364f8404, "Act3_Charlatan_AllianceBetrayed");
DB_GLO_Backgrounds_ChainAfterCharacterFlag((FLAG)TG_ORI_Astarion_BetrayedAstarionVampireLordToGur_c24060d9-1146-48ac-a2ff-c25be7767e71, "Act3_Charlatan_AllianceBetrayed");
DB_GLO_Backgrounds_ChainAfterCharacterFlag((FLAG)TG_ORI_Shadowheart_ShadowheartBetrayed_f78e829a-55cb-4dbf-859e-2f125471fbdc, "Act3_Charlatan_AllianceBetrayed");
//END_REGION

//REGION Criminal
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Elfsong_Patron008_TellJoinThievesGuild_b2836808-8526-1121-b220-a72ef773f8ff, "Act3_Criminal_AdvisedDez");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Criminal_SideWithGuild");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366, "Act3_Criminal_SideWithZhents");
//END_REGION

//REGION Entertainer
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_BlushingMermaid_Patron01_Patron09_AgreeDate_fb7e53a3-59f6-6ac2-9d51-f8bd8bd56eed, "Act3_Entertainer_NudgeSvendSiggy");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_Elfsong_Alfira_HasMet_d403b633-c483-bd93-01e8-f32a5228d381, "Act3_Entertainer_ElfsongAlfiraMeetup");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_TheLodge_State_GithKid_TalkedDown_6b6b8cee-5793-110f-163a-84509ad690bf, "Act3_Entertainer_GithyankiPtaris");
DB_GLO_Backgrounds_ChainAfterCharacterFlag((FLAG)LOW_WaterQueensHouse_State_OfferingGiven_30ab72c4-2730-495e-4266-043aeab7efd1, "Act3_Entertainer_WaveFuneralOffering");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog(LOW_Elfsong_State_LoseComedyTournament_bc0e4794-c81b-62c7-caaa-c3e5e451bf24, "Act3_Entertainer_LostComedyContest");
//END_REGION Entertainer

//REGION Folk Hero
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_KurwinCoffin_State_CoffinBeingMade_f7f8b7fc-7f7b-091f-fdf8-8b078e71d519, "Act3_FolkHero_KurwinPersuasionExceptionSuccess");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_Elfsong_Alfira_HasMet_d403b633-c483-bd93-01e8-f32a5228d381, "Act3_FolkHero_ElfongMeetingAlfira");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_Elfsong_Lakrissa_HasMet_9a573299-9cba-4845-816c-f021ec0eb0d4, "Act3_FolkHero_ElfsongMeetingLakrissa");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_Oskar_State_PaintedPortrait_b9a55b88-f4df-4a9b-8738-80509b13029a, "Act3_FolkHero_ObtainedOskarPortrait");
DB_LOW_SaveValeriaQuestSteps("MurderTribunal_FollowMurders_Completion");
DB_LOW_SaveValeriaQuestSteps("MurderTribunal_FollowMurders_Completion_SarevokNoValeria");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240, "Act3_FolkHero_SpawnsSaved");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_SteelWatchFoundry_State_Outcome_AllGondiansSaved_422247be-9c7a-4a0b-bf9e-070e62c72d1f, "Act3_FolkHero_WorkshopRescuedAllGondians");
//END_REGION Folk Hero

//REGION Guild Artisan
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_BloodMerchant_Araj_HasMet_7a72b63f-926f-2e01-100d-5faaeafa2b14, "Act3_GuildArtisan_BloodMerchantFollowup");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c, "Act3_GuildArtisan_AccessedIronThrone");
//END_REGION Guild Artisan

//REGION Noble
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_BaldursMouth_State_PrinterJammed_f1e28436-528e-4607-ac58-acbb73065b4e, "Act3_Noble_PrintingPressSabotaged");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_SerialKiller_PlayerWarnCoraAboutPoison_8c1d6f61-b422-ef19-1707-a107515a7159, "Act3_Noble_WarnedHighberry");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Noble_GuildZhentAlliegenceChosen");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366, "Act3_Noble_GuildZhentAlliegenceChosen");
DB_GLO_Backgrounds_ChainAfterCharacterFlag((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060, "Act3_Noble_MurderTribunalComplete");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_SteelWatchFoundry_Knows_GondiansForcedToWorkInFoundry_a2a32837-db90-4631-93f7-a4feef5b86b1, "Act3_Noble_GondianBlackmailDiscovered");
//END_REGION Noble

//REGION Outlander
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)CAMP_Elfsong_PaymentDone_fd063151-f443-4b87-80bf-6a9441b2b4d7, "Act3_Outlander_ElfsongRoomObtained");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_JaheirasHouse_State_JaheiraMetFamily_9486cabf-8113-47f8-a03f-4a9aba46d140, "Act3_Urchin_JaheiraKeptFamily");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c, "Act3_Outlander_IronThroneEntered");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83, "Act3_Outlander_BhaalTempleEntered");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a, "Act3_Outlander_SteelWatcherWorkshopDestroyed");
//END_REGION Outlander

//REGION Sage
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_BaldursMouth_HasMet_PrinterGremlin_f89f6d6f-17dc-4089-acb9-e859beec6e75, "Act3_Sage_PrintingPressMachinationsDiscovered");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_BloodMerchant_Araj_HasMet_7a72b63f-926f-2e01-100d-5faaeafa2b14, "Act3_Sage_BloodExperimentFollowup");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425, "Act3_Sage_NightsongGiven");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)WYR_AnsurGhost_HelmetPickup_Event_MetAnsur_c66f69e5-3281-98bf-05a9-15e4fb2143aa, "Act3_Sage_AnsurDiscovered");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_BlushingMermaid_HasMet_Saved_QuenoraGrizly_9af705fd-278d-4137-a5e9-d6eba6847ea8, "Act3_Sage_CapnGrislySaved");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_SteelWatchFoundry_State_UsedBombOnFoundry_e8a53028-4395-d6d2-17d4-9051feac4e8d, "Act3_Sage_WulbrenRunepowderBombUsed");
//END_REGION Sage

//REGION Soldier
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)CAMP_Elfsong_PaymentDone_fd063151-f443-4b87-80bf-6a9441b2b4d7, "Act3_Soldier_ElfsongRoomObtained");
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_BloodMerchant_Event_ArajGetBloodFromCharacter_00b0a0f7-98ee-86ac-3b8f-d7cce5b98ce0, "Act3_Soldier_ArajBloodFollowup");
//END_REGION Soldier

//REGION Urchin
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_KurwinCoffin_State_CoffinBeingMade_f7f8b7fc-7f7b-091f-fdf8-8b078e71d519, "Act3_Urchin_KurwinExceptionSuccess");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)CAMP_Elfsong_PaymentDone_fd063151-f443-4b87-80bf-6a9441b2b4d7, "Act3_Urchin_ElfsongRoomObtained");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_KurwinCoffin_HasMet_KidNecromancer_Calmed_b96fbcfb-ab4c-06b9-2082-9535bb71bb40, "Act3_Urchin_NinaCemetarySituationResolved");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_KurwinCoffin_State_KidNecromancer_RaisedBrotherFromDead_50f20126-fafe-f712-8e3d-08d521ea183d, "Act3_Urchin_NinaCemetarySituationResolved");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_JaheirasHouse_State_JaheiraMetFamily_9486cabf-8113-47f8-a03f-4a9aba46d140, "Act3_Urchin_JaheiraKeptFamily");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_FireworksHouse_Event_UsedPassword_a1db6ba2-5535-4c96-aa27-b7736625fa6c, "Act3_Urchin_FelogyrPassCode");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a, "Act3_Urchin_GondianWorkshopDestroyed");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_JaheirasHouse_State_JaheiraMetFamily_9486cabf-8113-47f8-a03f-4a9aba46d140, "Act3_Urchin_JaheiraKeptFamily");
//END_REGION Urchin

//REGION Haunted One
DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060, "Act3_HauntedOne_MurderTribunalCompleted");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83, "Act3_HauntedOne_BhaalTempleFound");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)ORI_DarkUrge_State_BhaalAccepted_904c45e0-bb06-40ed-b5d7-4f1c851b9d86, "Act3_HauntedOne_EmbracedBhaal");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)ORI_DarkUrge_State_BhaalResisted_74944ac3-1ea0-4eae-9653-1f1319f8646b, "Act3_HauntedOne_RejectedBhaal");
//END_REGION Haunted One

KBSECTION
//REGION Acolyte
PROC
PROC_OskarsBeloved_FreeKerri((GUIDSTRING)_Attacker)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Attacker, "Act3_Acolyte_BurnedKerriPortraitTrue");

IF
FlagSet(_Flag, _Character, _)
AND
DB_LOW_StormshoreTabernacle_Offerings(_, _Flag, _)
AND
GUIDToString(_Character, _CharacterGUID)
AND
Concatenate(_CharacterGUID, "_ReceiveOffering", _OutIDString)
AND
QRY_OnlyOnce(_OutIDString)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Character, "Act3_Acolyte_TabernacleOfferingGiven");

IF
DB_GlobalFlag(LOW_BlushingMermaid_State_VanraOutOfHag_80a69cad-828a-4d92-9bc3-9acf206f9739)
AND
DB_GlobalFlag(LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Acolyte_VanraRescued");

IF
SubQuestUpdateUnlocked(_Character, "LOW_FindBhaalTemple_FollowMurders", _ValeriaSavedQuestStep)
AND
DB_LOW_SaveValeriaQuestSteps(_ValeriaSavedQuestStep)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Character, "Act3_Acolyte_MurderTribunalRejected");

//END_REGION

//REGION Charlatan
IF
EntityEvent(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa,"LOW_VoloFate_VoloToCamp")
AND
DB_Players(_Player)
AND
IsTagged(_Player, (TAG)CHARLATAN_07925e5b-af3d-4743-a565-b9fee04c24ac, 1)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Charlatan_VoloSaved");

IF
Combined(S_LOW_BaldursMouth_BlockMaker_000_c691983c-82f2-4eb2-a0a6-cf33f8a84406, _Article1, _, _, _, _Player, _)
AND
DB_LOW_BaldursMouth_Articles(_Article1Flag, _Article1, _)
AND
DB_LOW_BaldursMouth_PositiveArticles(_Article1)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Charlatan_BaldursMouthRigged");

IF
DB_GlobalFlag(LOW_FatherCarrion_State_PlayersAcceptedTask_318caac3-8dba-4f13-b1ad-02f847715231)
AND
DB_GlobalFlag(LOW_FatherCarrion_State_IsHostile_50c741f9-19be-4fac-997a-3d31202ba14e)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Charlatan_AllianceBetrayed");

IF
DB_GlobalFlag(LOW_HouseOfHope_State_ContractIsDestroyed_1a51a77c-d549-4d50-95df-97ab9d1ef9f6)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Charlatan_AllianceBetrayed");

IF
DialogStarted((DIALOGRESOURCE)LOW_BhaalTemple_Orin_aeff0a89-2e7a-d237-6155-221138d17718,_)
AND
DB_GlobalFlag((FLAG)GLO_Orin_State_AgreedToKillGortash_39af75d8-2442-8667-551e-6a0dc699398b)
AND
NOT DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Charlatan_AllianceBetrayed");


//END_REGION

//REGION Criminal
IF
Combined(S_LOW_BaldursMouth_BlockMaker_000_c691983c-82f2-4eb2-a0a6-cf33f8a84406, _Article1, _, _, _, _Player, _)
AND
DB_LOW_BaldursMouth_Articles(_Article1Flag, _Article1, _)
AND
DB_LOW_BaldursMouth_PositiveArticles(_Article1)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_BaldursMouthRigged");

IF
FlagSet(LOW_CountingHouse_State_HasBankPass_0adc0b5e-3f89-4b3a-b04e-417499a8a818, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_ObtainedBankPass");

IF
Unlocked(_Vault,_Player,(ITEM)NULL_00000000-0000-0000-0000-000000000000)
AND
DB_LOW_CountingHouse_VipVaults(_Vault,_)
AND
QRY_OnlyOnce("Act3_Criminal_LowerVaultOpened")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_LowerVaultOpened");

IF
EnteredTrigger(_Player, S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_GainedUndercellarEntrance");

IF
DB_InRegion(_Player, (TRIGGER)S_LOW_DevilsFee_ReturnToDiabolist_74e65e00-d475-4e32-87db-a8cc92b42b06)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75)
AND
QRY_OnlyOnce("LOW_DevilsFee_BurgledHouseOfHope")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_BurgledHouseOfHope");

// Steal and offering to the gods.	Works with any offering inside the Stormshore Tabernacle
IF
CharacterStoleItem(_Player, _, _, _, _, _, (CHARACTER)S_LOW_TempleGuardian_32ec6ad3-c085-4fc5-943b-e2e3a05d9f2b, _Chest, _, _)
AND
DB_LOW_StormshoreTabernacle_SingleGods(_, _,_,(ITEM) _Chest,_)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_TabernacleOfferingStolen");

IF
CharacterStoleItem(_Player, _, _, _, _, _, (CHARACTER)S_LOW_TempleGuardian_32ec6ad3-c085-4fc5-943b-e2e3a05d9f2b, (ITEM)S_LOW_GenericGodChest_8c43197d-6bfa-4ddf-9ee5-d3f75b1444d3, _, _)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_TabernacleOfferingStolen");
//END_REGION

//REGION Entertainer
IF
Combined(S_LOW_BaldursMouth_BlockMaker_000_c691983c-82f2-4eb2-a0a6-cf33f8a84406, _Article1, _, _, _, _Player, _)
AND
DB_LOW_BaldursMouth_Articles(_Article1Flag, _Article1, _)
AND
DB_LOW_BaldursMouth_PositiveArticles(_Article1)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Entertainer_BaldursMouthRigged");

IF
DB_GlobalFlag(LOW_OskarsBeloved_State_AllFinalEnemiesPermaDefeated_5c1eeb4a-b09d-42f2-bbc2-f606fcbfc899)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Entertainer_OskarSaved");

IF
QuestUpdateUnlocked(_Player, "GLO_DoubtingArtist", _Step)
AND
DB_LOW_OskarsBeloved_BackgroundGoals_OskarSaved_QuestSteps(_Step)
AND
NOT DB_PermaDefeated(S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Entertainer_OskarSaved");

IF
QuestClosed("GLO_DoubtingArtist")
AND
DB_GlobalFlag((FLAG)LOW_OskarsBeloved_State_ArtistLeftHideout_76dca7be-5c6a-4444-afa4-3ae4b13d6315)
AND
HasActiveStatus(S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd, "LOW_OSKARSBELOVED_OSKARPOSSESSED", 0)
AND
NOT DB_PermaDefeated(S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Entertainer_OskarSaved");

IF
DB_GlobalFlag(LOW_Elfsong_State_WinComedyTournament_58ac0d2f-319e-e2c4-627f-15114b93c510)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Entertainer_WonComedyContest")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Entertainer_WonComedyContest");

IF
MovedFromTo(_, S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, _Player, 1)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Entertainer_ObtainedFigaroClothing");

IF
DialogEnded(LOW_Elfsong_HarvardWilloughby_b6115a49-cb95-fe6e-38c5-0ccf35b37c94, _)
AND
DB_GlobalFlag(LOW_Elfsong_State_ComedyTournament_Participate_8b116a03-d12b-679e-5685-5d5061e57333)
AND
NOT DB_GlobalFlag(LOW_Elfsong_State_WinComedyTournament_58ac0d2f-319e-e2c4-627f-15114b93c510)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Entertainer_ObtainedFigaroClothing");

//END_REGION Entertainer

//REGION Folk Hero
IF
DialogEnded(_Dialog, _)
AND
DB_LOW_IronThrone_ReturnDialogs(_Dialog)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_AnyIronThronePrisonersDead_5d6c4329-ee56-4084-8220-d627b716ac87)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_FolkHero_IronThroneAllGondiansSaved");

PROC
PROC_LOW_SorcerousSundries_HandleNightsongVictory()
AND
NOT QRY_SorcerousSundries_NightsongCanSmashLorro()
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_FolkHero_LorroakanDefeated");

IF
EntityEvent(_Nightsong, "LOW_SorcerousSundries_ReadyToSmashLorroakan")
AND
NOT QRY_LOW_SorcerousSundries_CheckForPlayerSmash()
AND
NOT DB_GLO_Backgrounds_Completed(_, "Act3_FolkHero_LorroakanDefeated")
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_FolkHero_LorroakanDefeated");

IF
DialogEnded((DIALOGRESOURCE)LOW_SorcerousSundries_NightsongSmash_ca824374-abdf-7094-9b35-2578466eb7b8, _)
AND
NOT DB_GLO_Backgrounds_Completed(_, "Act3_FolkHero_LorroakanDefeated")
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_FolkHero_LorroakanDefeated");

IF
SubQuestUpdateUnlocked(_Character, "LOW_FindBhaalTemple_FollowMurders", _ValeriaSavedQuestStep)
AND
DB_LOW_SaveValeriaQuestSteps(_ValeriaSavedQuestStep)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Character, "Act3_FolkHero_SavedValeria");

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a,_,_)
AND
DB_Avatars(_AnyAvatar)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_AnyAvatar, "Act3_FolkHero_FreedHope");

//END_REGION Folk Hero

//REGION Guild Artisan
IF
QuestUpdateUnlocked(_Character, "LOW_Foundry", "DestroyedFoundry")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Character, "Act3_GuildArtisan_UsedRunePowderBomb");

IF
QuestUpdateUnlocked(_Character, "LOW_StopTheGazette", "PrinterFound")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Character, "Act3_GuildArtisan_PrintingPressInnerWorkings");

IF
Unlocked(_Vault,_Player,(ITEM)NULL_00000000-0000-0000-0000-000000000000)
AND
DB_LOW_CountingHouse_VipVaults(_Vault,_)
AND
QRY_OnlyOnce("Act3_GuildArtisan_OpenedLowerVault")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_GuildArtisan_OpenedLowerVault");

IF
MovedFromTo(_, S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, _Player, 1)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_GuildArtisan_FigaroNewOutfit");

IF
DB_GlobalFlag(LOW_DevilsFee_Know_NoticeHellishItems_b0cfc46c-4730-26f1-f3a2-a6d7147a5e58)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_GuildArtisan_DevilRelicsIdentified");

PROC
PROC_OskarsBeloved_FreeKerri((GUIDSTRING)_Attacker)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Attacker, "Act3_GuildArtisan_PaintingBurned");

IF
DB_GlobalFlag(LOW_SerialKiller_State_CheckKarabasan_525f4751-f5c2-09cc-a370-14a57c499d1f)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_GuildArtisan_DolorPoisonedWine");

//END_REGION Guild Artisan

//REGION Noble
IF
Combined(S_LOW_BaldursMouth_BlockMaker_000_c691983c-82f2-4eb2-a0a6-cf33f8a84406, _Article1, _, _, _, _Player, _)
AND
DB_LOW_BaldursMouth_Articles(_Article1Flag, _Article1, _)
AND
DB_LOW_BaldursMouth_PositiveArticles(_Article1)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Noble_PrintingPressSabotaged");

IF
MovedFromTo(_, S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, _Player, 1)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Noble_FigaroNewOutfitObtained");

IF
EnteredTrigger(_Player, S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Noble_AccessedUndercellar");
//END_REGION Noble

//REGION Outlander
IF
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
THEN
TimerLaunch("Background_Act3_Outlander_TookInfernalPortal", 1000); // To avoid lack of UI pop-up: it does not appear because of autosave or teleport that happens at the same moment

IF
TimerFinished("Background_Act3_Outlander_TookInfernalPortal")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Outlander_TookInfernalPortal")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Outlander_TookInfernalPortal");

//DB_GLO_Backgrounds_ChainAfterCharacterFlag(LOW_TheLodge_HasMet_GithKid_c9d0b075-b1ae-0f0b-e22f-61d0ba3aac33, "Act3_Outlander_GithyankiEggFollowup");

IF
DialogStarted(LOW_TheLodge_GithBoy_67cf0943-fc4e-ce86-34e2-4f37a5bcdaa0, _)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Outlander_GithyankiEggFollowup")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Outlander_GithyankiEggFollowup");

IF
DB_GlobalFlag(LOW_TheLodge_State_GithKid_Combat_6949f002-d2af-a717-6756-78414a7e85c9)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Outlander_GithyankiEggFollowup")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Outlander_GithyankiEggFollowup");

IF
EnteredTrigger(_Player, S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Outlander_EnterTheUndercella");
//END_REGION Outlander

//REGION Sage
IF
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Sage_AccessedInfernalPortal")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Sage_AccessedInfernalPortal");

IF
DB_GlobalFlag(LOW_BlushingMermaid_State_QuenoraIsSaved_2d5e3ae7-12b3-4dae-94c6-ec9acfceb61e)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Sage_CapnGrislySaved")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Sage_CapnGrislySaved");

PROC
PROC_OskarsBeloved_FreeKerri((GUIDSTRING)_Attacker)
AND
DB_Players((CHARACTER)_Attacker)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Attacker, "Act3_Sage_UsedTrueCandle");

IF
DB_GlobalFlag(LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Sage_LorroakanDefeated")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Sage_LorroakanDefeated");

IF
DB_GlobalFlag(LOW_TheLodge_AskedAboutMembership_afa85f19-4951-b386-a818-097514395165)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Sage_SocietyOfBrillianceInquiry")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Sage_SocietyOfBrillianceInquiry");
//END_REGION Sage

//REGION Soldier
IF
DB_GlobalFlag(LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Soldier_KillEthelAgain")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Soldier_KillEthelAgain");

IF
DialogStarted(LOW_ParkCultistAmbush_003_b3dbcd94-1a5d-4ed7-f7bf-747e17cf7bf3, _)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Soldier_SpokeWithNetherBrain")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Soldier_SpokeWithNetherBrain");

IF
DB_GlobalFlag(LOW_SharGrotto_State_KilledCultists_2f9e0755-1f69-45f4-b7d7-7ad1814ecc3c)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Soldier_SharranEncounterSurvived")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Soldier_SharranEncounterSurvived");

IF
DB_InRegion(_Player, (TRIGGER)S_LOW_DevilsFee_ReturnToDiabolist_74e65e00-d475-4e32-87db-a8cc92b42b06)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75)
AND
QRY_OnlyOnce("LOW_DevilsFee_EscapeFromHouseOfHope")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Soldier_ExitedHouseOfHope");

IF
KilledBy(_SteelWatcher, _Player, _, _)
AND
IsTagged(_SteelWatcher, STEEL_WATCHER_bc09a589-e076-4b2d-8b86-f8cccbb64449, 1)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Soldier_KilledSteelWatcher");

IF
DB_GlobalFlag(GLO_Orin_State_PermaDefeated_c716e4d9-e6ed-445c-a710-ee4d91c67298)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Soldier_OrinExecuted");

IF
DB_PermaDefeated(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorAscended_68cf8d54-b6f2-468b-925d-5f4610e93c04)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Soldier_CazadorDefeated");
//END_REGION Soldier

//REGION Urchin
IF
DB_GlobalFlag(LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
QRY_OnlyOnce("Act3_Urchin_EthelKilled")
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Urchin_EthelKilled");

IF
DB_GlobalFlag(LOW_BlushingMermaid_State_VanraOutOfHag_80a69cad-828a-4d92-9bc3-9acf206f9739)
AND
DB_GlobalFlag(LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
QRY_OnlyOnce("Act3_Urchin_LoraChildRescued")
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Urchin_LoraChildRescued");

IF
EnteredTrigger(_Player, S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Urchin_AccessedUndercellar");

//END_REGION Urchin

//REGION Haunted One
IF
CharacterStoleItem(_Player, _, _, _, _, _, (CHARACTER)S_LOW_TempleGuardian_32ec6ad3-c085-4fc5-943b-e2e3a05d9f2b, (ITEM)S_LOW_GenericGodChest_8c43197d-6bfa-4ddf-9ee5-d3f75b1444d3, _, _)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_HauntedOne_TabernacleOfferingsStolen")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_HauntedOne_TabernacleOfferingsStolen");

IF
CharacterStoleItem(_Player, _, _, _, _, _, (CHARACTER)S_LOW_TempleGuardian_32ec6ad3-c085-4fc5-943b-e2e3a05d9f2b, _Chest, _, _)
AND
DB_LOW_StormshoreTabernacle_SingleGods((ITEM)_, _,(DIALOGRESOURCE)_,(ITEM) _Chest,(FLAG) _AngeredFlag)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_HauntedOne_TabernacleOfferingsStolen")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_HauntedOne_TabernacleOfferingsStolen");

IF
SubQuestUpdateUnlocked(_Character, "LOW_FindBhaalTemple_FollowMurders", _ValeriaSavedQuestStep)
AND
DB_LOW_SaveValeriaQuestSteps(_ValeriaSavedQuestStep)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Character, "Act3_HauntedOne_MurderTribunalRejected");

IF
DB_GlobalFlag(LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_HauntedOne_LorroakanKilled")
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_HauntedOne_LorroakanKilled");

IF
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_UsedBombOnFoundry_e8a53028-4395-d6d2-17d4-9051feac4e8d)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_HauntedOne_UsedBrilliantRetort")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_HauntedOne_UsedBrilliantRetort");
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Soldier_DeepGnomesAided");

IF
DB_GlobalFlag(LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_HauntedOne_MysticCarrionKilled")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_HauntedOne_MysticCarrionKilled");

IF
DB_GlobalFlag(LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_HauntedOne_EthelKilledAgain")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_HauntedOne_EthelKilledAgain");

IF
DB_GlobalFlag(LOW_MurderTribunal_Sarevok_State_Dead_e9d30711-af25-4ba9-813e-cc7c131b17b6)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_HauntedOne_SarevokKilled")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_HauntedOne_SarevokKilled");
//END_REGION Haunted One
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
