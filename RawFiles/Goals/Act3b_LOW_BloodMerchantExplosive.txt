Version 1
SubGoalCombiner SGC_AND
INITSECTION
PROC_LOW_InitializeBloodMerchant();

DB_HasItemEvent((ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, LOW_BloodMerchant_HasItem_ExplosivePotion_0b172550-1bb3-42ec-8943-8322b239d18d);

DB_GiveItemToEventWithClear((ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, LOW_BloodMerchant_Event_GiveItemExplosivePotion_6c8ba01f-14ae-2878-cad1-fa9b39669cc1);

DB_LOW_BloodMerchant_DamageWithBlood("Slashing");
DB_LOW_BloodMerchant_DamageWithBlood("Piercing");
DB_LOW_BloodMerchant_DamageWithBlood("Bludgeoning");

//Ownership - house is boarded up with FF signs outside - setting patrolling guards as owners
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_BloodMerchant_Ownership_0839c4aa-7122-4062-89f3-e4f26615382d, (CHARACTER)S_LOW_SWS_Patrols_002_FF_000_4bda014f-b1f7-4191-a3f6-93d981ff7e0d);
//Subregion
DB_Subregion((TRIGGER)LOW_BloodMerchant_Poly_SUB_74075284-a9d0-44d0-be56-067d2769fd6f, "LOW_BloodMerchant_SUB", 0, 1);

//Hidden Booster
DB_QuestDef_State(LOW_BloodMerchant_State_ArajAsTrader_74fec4cc-4c35-a05b-1c47-af36980adca1, "HIDDEN_CTY_Boosters", "LOW_BloodMerchantLair_DrinkPotion");

//Barricaded doors
DB_LOW_BloodMerchant_BarricadedDoors((ITEM)S_LOW_BloodMerchant_Barricade_000_f211d987-614c-4511-b88b-9a70e88741cd, (ITEM)S_DOOR_BloodMerchantA_0d8cc61c-64ae-406d-a4d3-1553b6a1e1e5);
DB_LOW_BloodMerchant_BarricadedDoors((ITEM)S_LOW_BloodMerchant_Barricade_001_0b35a759-2c9d-4540-a0df-2c10790bfb2b, (ITEM)S_Door_BloodmechantB_a2a9c95d-f1a0-4d7b-a4db-2b4811290c47);
KBSECTION
//REGION Explosions and Araj going out

PROC
PROC_LOW_InitializeBloodMerchant()
AND
NOT DB_PermaDefeated(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a)
AND
QRY_LOW_SearchClonedCharacter()
THEN
//ExplosionsDB
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_001_819f337f-ed8d-42e6-93bc-3ffde03f3ee1);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_002_167ee07d-cac4-497a-98f6-8d88e9bdef6a);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_003_c9a36cb2-911b-41f8-9f72-b2e07e562c7b);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_004_c87c31f5-ce93-4920-9dff-60e9c706063f);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_005_0223413a-c232-4edd-9022-db06a5c39151);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_006_8c7c928c-e21d-407b-b2b0-e2551912fde7);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_007_167faae5-4698-447d-a84c-84c89047d16b);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_008_e3c564f3-c553-4d07-9f0c-4ff8f0811908);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_009_ffb91e8b-045d-4161-a996-a7ab98bc383a);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_010_e1582b3b-e3c5-4cfd-86d1-db45cf7402fc);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_011_15357cf8-f408-4e75-89bd-04ad9f59da13);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_012_5d655d9e-c2b3-48aa-a3a1-e6301d175fb0);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_013_08a08630-5528-4dfe-8738-72b2797ff065);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_014_08eddaa6-9f7c-40e3-b37c-3532ebc12498);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_015_2c78a517-badf-4caf-9228-7a4a7f79948b);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_016_1806f9d4-d69e-458c-b002-b002aaa7354f);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_017_6ebf4dce-9e3f-4459-9fb2-9b07e3b6fbda);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_018_addd247b-c287-46f1-9e89-98f71129ffc6);
DB_LOW_BloodMerchant_ExplosionsPoints(S_LOW_BloodMerchant_ExplosionPoint_019_25445d63-6405-43da-9fa7-fedeeefb4347);
TeleportTo(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, (TRIGGER)S_LOW_BloodMerchant_Araj_OriginPoint_387206b3-0938-48c8-b4d7-92272ee7856a);
PROC_SetOnStage(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, 1);
SetFaction(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, (FACTION)Act3_LOW_ArajBloodMerchant_4f198d21-e639-4a07-a184-74e8e84954e4);
PROC_RemoveDialog(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);
ToInventory((ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, 1, 0, 1);
SetFlag((FLAG)LOW_BloodMerchant_Event_ArajHouseInFlames_1214c82e-a4ff-315a-2f93-ff5ac7e53cf1);
SetOnStage(S_LOW_BloodMerchant_Blackboard_000_4a542c37-0bca-447f-ac19-6843ac7f0101, 0);
SetOnStage(S_LOW_BloodMerchant_Blackboard_001_0859dcf8-4148-44cc-9360-a7352c6202c4, 0);
SetOnStage(S_LOW_BloodMerchant_Barricade_000_f211d987-614c-4511-b88b-9a70e88741cd, 0);
SetOnStage(S_LOW_BloodMerchant_Barricade_001_0b35a759-2c9d-4540-a0df-2c10790bfb2b, 0);
//RegisterTriggers and Destination points into a DB
DB_LOW_BloodMerchant_TriggeringExplosions((TRIGGER)S_LOW_BloodMerchant_Explosion_001_50804325-a182-48fc-9139-054f5f38d6d4, (TRIGGER)S_LOW_BloodMerchant_ArajEndPoint_a2fca2f0-ecb6-4ef1-8f3d-45b77cf17938);
DB_LOW_BloodMerchant_TriggeringExplosions(S_LOW_BloodMerchant_Explosion_002_4d6e6f88-7d07-4024-a36e-c8f011e75902, S_LOW_BloodMerchant_ArajEndPoint_000_8e736fd1-e248-457b-be38-bbb4138388f3);
DB_LOW_BloodMerchant_TriggeringExplosions(S_LOW_BloodMerchant_Explosion_000_61895b14-0e4f-4dd9-93cf-25296a09b04f, S_LOW_BloodMerchant_ArajEndPoint_000_8e736fd1-e248-457b-be38-bbb4138388f3);
SetOwner(S_DOOR_GEN_Hatch_Wood_A_000_b85e31bc-b93e-42df-8d87-3ad1f2644130, (CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);
DB_ItemOwnershipTriggers("CTY_Main_A",(TRIGGER)S_LOW_BloodMerchant_Lab_SUB_2bae1f5b-beca-4944-b555-8d5c0b1cabaf, (CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);
SetOnStage(S_LOW_BloodMerchant_ChosensBlood_000_610c1f00-47d7-4173-99a0-dbae0d58e3a5, 0);
SetOnStage(S_LOW_BloodMerchant_Breakthrough_000_d6e48692-b7bc-4843-b88d-3120fe6f4973, 1);
PROC_LOW_BloodMerchant_CheckBite();

PROC
PROC_LOW_BloodMerchant_CheckBite()
AND
DB_GlobalFlag(MOO_BloodMerchant_State_GotBittenByAstarion_e0a3b0ec-b124-4870-a733-4e1468b3dc11)
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_BloodMerchant_Bitten_8574825d-fe6f-4f21-9f98-48bb072a9f1a, (GUIDSTRING)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, 1, 0);

//Case Araj not being there
PROC
PROC_LOW_InitializeBloodMerchant()
AND
DB_PermaDefeated(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a)
THEN
PROC_LOW_BloodMerchant_NoArajSituation();

PROC
PROC_LOW_InitializeBloodMerchant()
AND
NOT QRY_LOW_SearchClonedCharacter()
THEN
PROC_LOW_BloodMerchant_NoArajSituation();

PROC
PROC_LOW_BloodMerchant_NoArajSituation()
AND
QRY_OnlyOnce("LOW_BloodMerchant_CannotInitialize")
THEN
SetOnStage(S_LOW_BloodMerchant_Breakthrough_000_d6e48692-b7bc-4843-b88d-3120fe6f4973, 0);
DB_ItemDialog_NarratorAD(LOW_BloodMerchant_Blackboard_000_4a542c37-0bca-447f-ac19-6843ac7f0101, (DIALOGRESOURCE)LOW_BloodMerchant_AD_EvictedHouse_a326c71c-763e-c29d-25d7-c3a970420013); //Two signs, same dialog
DB_ItemDialog_NarratorAD(LOW_BloodMerchant_Blackboard_001_0859dcf8-4148-44cc-9360-a7352c6202c4, (DIALOGRESOURCE)LOW_BloodMerchant_AD_EvictedHouse_a326c71c-763e-c29d-25d7-c3a970420013);
PROC_LOW_BloodMerchant_CleanGeneralDatabases();

IF
DB_LOW_BloodMerchant_TriggeringExplosions(_Area, _DestinationPoint)
THEN
PROC_TriggerRegisterForParty(_Area);

IF
EnteredTrigger(_PartyMember, _AreaTrigger)
AND
DB_LOW_BloodMerchant_TriggeringExplosions(_AreaTrigger, _)
AND
DB_LOW_BloodMerchant_ExplosionsPoints(_ExplosionPoint)
THEN
CreateExplosion(_ExplosionPoint,"Projectile_LOW_BloodMerchant_ExplosionsWithAsh",4);
TriggerSetCrowdBehaviour(CrowdCharacterTrigger_037_30d4146b-8fd3-44d1-b834-9e631659f5a8, CROWDBEHAVIOUR.Flee);
TriggerSetCrowdBehaviour(CrowdCharacterTrigger_036_583ece28-9c95-4e32-8da6-cec21881938e, CROWDBEHAVIOUR.Flee);
TriggerSetCrowdBehaviour(CrowdCharacterTrigger_039_6f06d829-4739-4a54-b3d9-faad46c7c0b4, CROWDBEHAVIOUR.Flee);
TriggerSetCrowdBehaviour(CrowdCharacterTrigger_038_693dadba-1413-486f-8982-b69f6e8095d0, CROWDBEHAVIOUR.Flee);
NOT DB_LOW_BloodMerchant_ExplosionsPoints(_ExplosionPoint);

IF
EnteredTrigger(_PartyMember, _AreaTrigger)
AND
DB_LOW_BloodMerchant_TriggeringExplosions(_AreaTrigger, _DestinationTrigger)
AND
QRY_OnlyOnce("LOW_BloodMerchant_TriggeringExplosion")
THEN
DB_LOW_BloodMerchant_DestinationTrigger(_DestinationTrigger);
TimerLaunch("LOW_BloodMerchant_ExplosionTimer", 1800);
TimerLaunch("LOW_BloodMerchant_FlamingTimer", 18000);
PROC_LOW_BloodMerchant_CleanTriggers();

PROC
PROC_LOW_BloodMerchant_CleanTriggers()
AND
DB_LOW_BloodMerchant_TriggeringExplosions(_AreaTrigger, _DestinationTrigger)
THEN
PROC_TriggerUnregisterForParty(_AreaTrigger);
NOT DB_LOW_BloodMerchant_TriggeringExplosions(_AreaTrigger, _DestinationTrigger);

IF
TimerFinished("LOW_BloodMerchant_ExplosionTimer")
AND
DB_LOW_BloodMerchant_DestinationTrigger(_Destination)
THEN
NOT DB_LOW_BloodMerchant_DestinationTrigger(_Destination);
PROC_CharacterMoveTo((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Destination, "Run", "LOW_BloodMerchant_GoOutHouse");

IF
TimerFinished("LOW_BloodMerchant_FlamingTimer")
THEN
ClearFlag((FLAG)LOW_BloodMerchant_Event_ArajHouseInFlames_1214c82e-a4ff-315a-2f93-ff5ac7e53cf1);

IF
EntityEvent(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, "LOW_BloodMerchant_GoOutHouse")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BloodMerchant_AD_ExplosionAraj_3889f510-fa28-d67f-2270-f064b0993847, S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);
DB_Dialogs((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, LOW_BloodMerchant_Araj_MainDialog_4ac05c22-197c-dcbd-6269-285af525387d);

IF
DialogEnded((DIALOGRESOURCE)LOW_BloodMerchant_Araj_MainDialog_4ac05c22-197c-dcbd-6269-285af525387d, _)
AND
DB_GlobalFlag((FLAG)LOW_BloodMerchant_State_ArajInsideHouse_ff35cf83-fc61-4708-44f4-39f188121e60)
THEN
PROC_CharacterMoveTo((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, S_LOW_BloodMerchant_ArajTP_f66140a4-7e05-4e70-a064-42846889e6ab, "Walk", "LOW_BloodMerchant_GoInHouse");

//END_REGION

//REGION Trying to go away

IF
FlagSet((FLAG)LOW_BloodMerchant_Event_GiveItemExplosivePotion_6c8ba01f-14ae-2878-cad1-fa9b39669cc1, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_TriggerRegisterForPlayers(S_LOW_BloodMerchant_InHouse_43d460c0-8277-43cf-8041-7f29fcb2f9dd);
PROC_TriggerRegisterForPlayers(S_LOW_BloodMerchant_StartDialogue_0f4ca0ce-5695-434b-9dbb-3e3b911c6bea);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_BloodMerchant_InHouse_43d460c0-8277-43cf-8041-7f29fcb2f9dd)
AND
DB_Players(_Player)
THEN
DB_LOW_BloodMerchant_WasInsideHouse(_Player);

IF
LeftTrigger(_Player, (TRIGGER)S_LOW_BloodMerchant_InHouse_43d460c0-8277-43cf-8041-7f29fcb2f9dd)
AND
GetFlag((FLAG)LOW_BloodMerchant_HasItem_ExplosivePotion_0b172550-1bb3-42ec-8943-8322b239d18d, _Player, 1)
AND
DB_LOW_BloodMerchant_WasInsideHouse(_Player)
THEN
PROC_TryStartAD(LOW_BloodMerchant_AD_PlayersTryExitHouse_7c420744-bf92-fb51-6ba9-04edf9f114f3, S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);

IF
EnteredTrigger(_Player, S_LOW_BloodMerchant_StartDialogue_0f4ca0ce-5695-434b-9dbb-3e3b911c6bea)
AND
NOT DB_LOW_BloodMerchant_WarnedOnce(1)
AND
GetFlag((FLAG)LOW_BloodMerchant_HasItem_ExplosivePotion_0b172550-1bb3-42ec-8943-8322b239d18d, _Player, 1)
AND
DB_LOW_BloodMerchant_WasInsideHouse(_Player)
AND
NOT QRY_LOW_BloodMerchant_CannotFollow(_Player)
THEN
PROC_CharacterMoveToAndTalk(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Player, LOW_BloodMerchant_Araj_TryToGoAway_06a507ce-edbd-d815-59ff-dafdf8a768c4 ,"LOW_BloodMerchant_TryGoAway", "Run", 30.0);
DB_LOW_BloodMerchant_WarnedOnce(1);
PROC_TriggerUnregisterForPlayers(S_LOW_BloodMerchant_StartDialogue_0f4ca0ce-5695-434b-9dbb-3e3b911c6bea);

IF
DialogRequestFailed(LOW_BloodMerchant_Araj_TryToGoAway_06a507ce-edbd-d815-59ff-dafdf8a768c4, _)
THEN
PROC_TryStartAD(LOW_BloodMerchant_AD_BackupWarning_3239a5ad-36cd-4259-38ee-b0821bc362b4, S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);

QRY
QRY_LOW_BloodMerchant_CannotFollow((CHARACTER)_Player)
AND
DB_CantTalk(_Player)
THEN
DB_NOOP(1);

QRY
QRY_LOW_BloodMerchant_CannotFollow((CHARACTER)_Player)
AND
DB_CantTalk(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a)
THEN
DB_NOOP(1);

QRY
QRY_LOW_BloodMerchant_CannotFollow((CHARACTER)_Player)
AND
DB_HiddenCharacters(_Player, _)
THEN
DB_NOOP(1);

IF
DB_PermaDefeated(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a)
AND
DB_LOW_BloodMerchant_WasInsideHouse(_Player)
THEN
NOT DB_LOW_BloodMerchant_WasInsideHouse(_Player);

//Removing the blockers to go away
IF
DB_GlobalFlag((FLAG)LOW_BloodMerchant_State_ArajAsTrader_74fec4cc-4c35-a05b-1c47-af36980adca1)
THEN
PROC_TriggerUnregisterForPlayers(S_LOW_BloodMerchant_InHouse_43d460c0-8277-43cf-8041-7f29fcb2f9dd);
PROC_TriggerUnregisterForPlayers(S_LOW_BloodMerchant_StartDialogue_0f4ca0ce-5695-434b-9dbb-3e3b911c6bea);

IF
DB_GlobalFlag((FLAG)LOW_BloodMerchant_State_ArajAsTrader_74fec4cc-4c35-a05b-1c47-af36980adca1)
AND
DB_LOW_BloodMerchant_WasInsideHouse(_Player)
THEN
NOT DB_LOW_BloodMerchant_WasInsideHouse(_Player);

IF
FlagSet((FLAG)LOW_BloodMerchant_HasItem_ExplosivePotion_0b172550-1bb3-42ec-8943-8322b239d18d, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
SetDualEntityEvent(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Player, "LOW_BloodMerchant_HasPotion", 1);

// Also for non-Players, in case you dismiss someone and then get it from their inventory
IF
FlagCleared((FLAG)LOW_BloodMerchant_HasItem_ExplosivePotion_0b172550-1bb3-42ec-8943-8322b239d18d, _Char, _)
THEN
SetDualEntityEvent(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Char, "LOW_BloodMerchant_LostPotion", 1);

//END_REGION

//REGION Destroying or droping the potion

IF
DroppedBy(S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, _Player)
AND
DB_Sees((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Player)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BloodMerchant_AD_PlayersDropPotionGround_c9dd841d-5cc7-1157-a3bd-8b30063460db, S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);

IF
DestroyedBy((ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, _, _, _)
THEN
SetFlag(LOW_BloodMerchant_State_PotionDestroyed_4f4b93c1-91d0-46b3-bec9-957a26371c29);

IF
DestroyedBy((ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, _Destroyer, _Player, _)
AND
DB_PartyMembers(_Destroyer)
AND
DB_Sees((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Player)
THEN
SetHostileAndEnterCombat((FACTION)Act3_LOW_ArajBloodMerchant_4f198d21-e639-4a07-a184-74e8e84954e4, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Player);

//END_REGION

//REGION Blood Curse

IF
StatusApplied(_Player, "LOW_BLOODMERCHANT_EXPLOSIVEPOTION", _, _)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
THEN
SetFlag(LOW_BloodMerchant_State_CharacterDrinkPotion_e803eb7d-1455-42f0-8a10-bae18790a24c, _Player);
ClearFlag((FLAG)LOW_BloodMerchant_State_WaitingForProcedure_ecfad6e5-016a-4212-a64e-cad0ed9fe049);
ClearFlag((FLAG)LOW_BloodMerchant_State_ProcedureAcceded_4b350316-2340-cfdf-5857-f201c2aad3f4);
PROC_TryStartAD(LOW_BloodMerchant_PAD_ExplosiveBlood_ed155395-9b1f-30ec-2e87-beff98284e45, _Player);
DB_LOW_BloodMerchant_ExplosiveBloodCharacter(_Player);
AddPassive(_Player, "LOW_BloodMerchant_ExplosiveBlood");

IF
StatusApplied(_Player, "LOW_BLOODMERCHANT_EXPLOSIVEPOTION", _, _)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 0)
THEN
SetFlag(LOW_BloodMerchant_State_PotionDestroyed_4f4b93c1-91d0-46b3-bec9-957a26371c29);
ApplyStatus(_Player, "POISONED", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);


//TODO: STUB, ONLY UNTIL WE HAVE A WAY TO CHANGE THE BLOOD TYPE IN OSIRIS (if this arrives at some point)
IF
AttackedBy(_Player, _, _, _Damage, _, _, _)
AND
DB_LOW_BloodMerchant_ExplosiveBloodCharacter(_Player)
AND
DB_LOW_BloodMerchant_DamageWithBlood(_Damage)
THEN
CreateSurface(_Player, "SurfaceBloodExploding", 2.0, -1.0);

IF
FlagSet((FLAG)LOW_BloodMerchant_Event_ArajGetBloodFromCharacter_00b0a0f7-98ee-86ac-3b8f-d7cce5b98ce0, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
ApplyDamage(_Player, 5, "Piercing", NULL_00000000-0000-0000-0000-000000000000);
TemplateAddTo((ITEMROOT)WPN_Grenade_BloodSurface_7821978d-c720-4651-9693-936960145636, S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, 2, 0);
ClearFlag(LOW_BloodMerchant_Event_ArajGetBloodFromCharacter_00b0a0f7-98ee-86ac-3b8f-d7cce5b98ce0, _Player);
SetFlag(LOW_BloodMerchant_State_NewGrenadesToday_8e75d13b-88f7-462c-92f9-55d41fea02e7);

PROC
PROC_LongRest()
AND
DB_GlobalFlag(LOW_BloodMerchant_State_NewGrenadesToday_8e75d13b-88f7-462c-92f9-55d41fea02e7)
THEN
ClearFlag(LOW_BloodMerchant_State_NewGrenadesToday_8e75d13b-88f7-462c-92f9-55d41fea02e7);

PROC
PROC_BlockUseOfItem(_Player, S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 0)
AND
DB_Sees((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Player)
AND
NOT DB_CantAct(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a)
AND
NOT DB_GlobalFlag(LOW_BloodMerchant_State_ArajSeesTryMessPotion_4c34d76d-69e5-4c26-8678-10139002dd9a)
THEN
DB_CustomUseItemResponse(_Player,(ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, 0);
SetFlag(LOW_BloodMerchant_State_ArajSeesTryMessPotion_4c34d76d-69e5-4c26-8678-10139002dd9a);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BloodMerchant_AD_PlayersDropPotionGround_c9dd841d-5cc7-1157-a3bd-8b30063460db, S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);

//Only if she see us and not in dialog. In dialog, the only option after that will be "I destroy the potion"
PROC
PROC_BlockUseOfItem(_Player, S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 0)
AND
DB_Sees((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Player)
AND
NOT DB_CantAct(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a)
AND
DB_GlobalFlag(LOW_BloodMerchant_State_ArajSeesTryMessPotion_4c34d76d-69e5-4c26-8678-10139002dd9a)
AND
GetFaction(_Player, _PlayerFaction)
THEN
DB_CustomUseItemResponse(_Player,(ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, 1);
SetHostileAndEnterCombat((FACTION)Act3_LOW_ArajBloodMerchant_4f198d21-e639-4a07-a184-74e8e84954e4, _PlayerFaction, S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a, _Player);

PROC
PROC_BlockUseOfItem(_Player, S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
THEN
PROC_CharacterDisableAllCrimes((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);
TimerLaunch("LOW_BloodMerchant_ArajNoCrimes", 2000);
//DB_IgnoreAssault((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);
DB_CustomUseItemResponse(_Player, (ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, 1);


IF
TimerFinished("LOW_BloodMerchant_ArajNoCrimes")
THEN
PROC_CharacterEnableAllCrimes((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);

/*IF
FlagSet(LOW_BloodMerchant_State_CharacterDrinkPotion_e803eb7d-1455-42f0-8a10-bae18790a24c, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
NOT DB_IgnoreAssault((CHARACTER)S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);*/

//END_REGION

//REGION QRY_LOW_SearchClonedCharacter

//Not happy with this code, but it works
QRY
QRY_LOW_SearchClonedCharacter()
AND
DB_MOO_InfernalVendor_CharacterSellBlood(_Character)
THEN
DB_NOOP(1);

//END_REGION

//REGION Cleaning
PROC
PROC_LOW_BloodMerchant_CleanGeneralDatabases()
THEN
NOT DB_HasItemEvent((ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, LOW_BloodMerchant_HasItem_ExplosivePotion_0b172550-1bb3-42ec-8943-8322b239d18d);
NOT DB_GiveItemToEventWithClear((ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, LOW_BloodMerchant_Event_GiveItemExplosivePotion_6c8ba01f-14ae-2878-cad1-fa9b39669cc1);
NOT DB_LOW_BloodMerchant_DamageWithBlood("Slashing");
NOT DB_LOW_BloodMerchant_DamageWithBlood("Piercing");
NOT DB_LOW_BloodMerchant_DamageWithBlood("Bludgeoning");

//END_REGION

//REGION Barricaded doors
IF
DB_LOW_BloodMerchant_BarricadedDoors(_Barricade, _Door)
AND
NOT QRY_LOW_BloodMerchant_BarricadeDestroyed(_Barricade)
THEN
Lock(_Door, "LOW_BloodMerchant_BarricadedDoors_ImpossibleToLockpick");

QRY
QRY_LOW_BloodMerchant_BarricadeDestroyed((ITEM)_Barricade)
AND
DB_LOW_BloodMerchant_BarricadedDoors(_Barricade, _Door)
AND
IsDestroyed(_Barricade, 1)
THEN
NOT DB_LOW_BloodMerchant_BarricadedDoors(_Barricade, _Door);
Unlock(_Door);

IF
DestroyedBy(_Barricade, _Destroyer, _, _)
AND
DB_LOW_BloodMerchant_BarricadedDoors(_Barricade, _Door)
THEN
Unlock(_Door, _Destroyer);

PROC
PROC_BlockUseOfItem(_Player, _Door)
AND
DB_Players(_Player)
AND
DB_LOW_BloodMerchant_BarricadedDoors(_, _Door)
AND
IsLocked(_Door, 1)
THEN
DB_CustomUseItemResponse(_Player, _Door, 0);
PROC_TryStartAD(GEN_AD_ItemBlocked_a4eb2e7b-809a-a9e4-94da-955a8ac9b8c6, _Player);

//END_REGION

//REGION DebugZone

IF
TextEvent("LOW_BloodMerchant_Initialize")
AND
DB_Players(_Player)
AND
IsControlled(_Player, 1) //For testing, we get the controlled character
THEN
SetFlag(MOO_InfernalVendor_State_SoldBlood_ae50cf43-a0ef-4ce6-bdb1-0ccf628b9a63, _Player);
SetFlag((FLAG)Debug_Act3_Event_BloodMerchantSetup_e5dcbf3a-3025-95d6-645b-c58d791311b4);

IF
DB_GlobalFlag((FLAG)Debug_Act3_Event_BloodMerchantSetup_e5dcbf3a-3025-95d6-645b-c58d791311b4)
AND
DB_Players(_Player)
AND
IsControlled(_Player, 1)
THEN
DB_MOO_InfernalVendor_CharacterSellBlood(_Player);
//Add the cleaned DBs
DB_HasItemEvent((ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, LOW_BloodMerchant_HasItem_ExplosivePotion_0b172550-1bb3-42ec-8943-8322b239d18d);
DB_GiveItemToEventWithClear((ITEM)S_LOW_BloodMerchant_ExplosivePotion_45df7099-5087-479e-ab0c-526e16ef5372, LOW_BloodMerchant_Event_GiveItemExplosivePotion_6c8ba01f-14ae-2878-cad1-fa9b39669cc1);
DB_LOW_BloodMerchant_DamageWithBlood("Slashing");
DB_LOW_BloodMerchant_DamageWithBlood("Piercing");
DB_LOW_BloodMerchant_DamageWithBlood("Bludgeoning");
PROC_LOW_InitializeBloodMerchant();

IF
TextEvent("LOW_BloodMerchant_AllCompanionsBlood")
AND
DB_PartOfTheTeam(_Companion)
THEN
DB_MOO_InfernalVendor_CharacterSellBlood(_Companion);
SetFlag(MOO_InfernalVendor_State_SoldBlood_ae50cf43-a0ef-4ce6-bdb1-0ccf628b9a63, _Companion);

IF
TextEvent("LOW_BloodMerchant_FindClone")
THEN
PROC_LOW_InitializeBloodMerchant();

IF
TextEvent("LOW_BloodMerchant_AddPotion")
AND
DB_Players(_Player)
AND
IsControlled(_Player, 1)
THEN
DebugText(_Player, "This potion is a hacky one. Can be drinked by non-tadpoled charactes! Be wary");
TemplateAddTo(UNI_CONS_Drink_ExplosiveBloodPotion_666ac219-e011-4c2b-bcc7-c2f0c6a9f7b4, _Player, 1, 1);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
