Version 1
SubGoalCombiner SGC_AND
INITSECTION
// Disguised Redcaps
DB_LOW_DisguisedRedcaps((CHARACTER)S_LOW_BlushingMermaid_DisguisedRedcap_01_efa9ccb1-4ba2-4467-82ef-b8ed63b867a4,"LOW_REDCAP_PATRON_01");
DB_LOW_DisguisedRedcaps((CHARACTER)S_LOW_BlushingMermaid_DisguisedRedcap_02_ba363354-3341-41e9-ae92-c3fe8a07a9ea,"LOW_REDCAP_PATRON_02");
DB_LOW_DisguisedRedcaps((CHARACTER)S_LOW_BlushingMermaid_DisguisedRedcap_03_76784911-9f0d-48f6-8e0d-b609345b2be2,"LOW_REDCAP_PATRON_03");
DB_LOW_DisguisedRedcaps((CHARACTER)S_LOW_BlushingMermaid_DisguisedRedcap_04_9f218fa2-418d-46ee-b38d-1708f25314ec,"LOW_REDCAP_PATRON_04");
DB_LOW_DisguisedRedcaps((CHARACTER)S_LOW_BlushingMermaid_DisguisedRedcap_05_357299a8-b8c2-4b99-92f8-761fd697c435,"LOW_REDCAP_PATRON_05");
DB_LOW_DisguisedRedcaps((CHARACTER)S_LOW_BlushingMermaid_DisguisedRedcap_06_8a9a0273-3a3b-47ee-b362-5b83903458fb,"LOW_REDCAP_PATRON_06");
DB_SceneManager(S_LOW_BlushingMermaid_DisguisedRedcap_01_efa9ccb1-4ba2-4467-82ef-b8ed63b867a4,"LOW_DisguisedHag_Scene");
DB_SceneManager(S_LOW_BlushingMermaid_DisguisedRedcap_02_ba363354-3341-41e9-ae92-c3fe8a07a9ea,"LOW_DisguisedHag_Scene");
DB_SceneManager(S_LOW_BlushingMermaid_DisguisedRedcap_03_76784911-9f0d-48f6-8e0d-b609345b2be2,"LOW_DisguisedHag_Scene");
DB_SceneManager(S_LOW_BlushingMermaid_DisguisedRedcap_04_9f218fa2-418d-46ee-b38d-1708f25314ec,"LOW_DisguisedHag_Scene");
DB_SceneManager(S_LOW_BlushingMermaid_DisguisedRedcap_05_357299a8-b8c2-4b99-92f8-761fd697c435,"LOW_DisguisedHag_Scene");
DB_SceneManager(S_LOW_BlushingMermaid_DisguisedRedcap_06_8a9a0273-3a3b-47ee-b362-5b83903458fb,"LOW_DisguisedHag_Scene");

DB_Dialogs(S_LOW_BlushingMermaid_DisguisedRedcap_01_efa9ccb1-4ba2-4467-82ef-b8ed63b867a4, (DIALOGRESOURCE)LOW_BlushingMermaid_DisguisedRedcap_01_eb2cc339-73ba-8f0b-25f1-081db231c01a);
DB_Dialogs(S_LOW_BlushingMermaid_DisguisedRedcap_02_ba363354-3341-41e9-ae92-c3fe8a07a9ea, (DIALOGRESOURCE)LOW_BlushingMermaid_DisguisedRedcap_02_7f9acb47-ad4f-1874-ed10-5d87242a7e26);
DB_Dialogs(S_LOW_BlushingMermaid_DisguisedRedcap_03_76784911-9f0d-48f6-8e0d-b609345b2be2, (DIALOGRESOURCE)LOW_BlushingMermaid_DisguisedRedcap_03_07df203a-69ef-f333-8898-8ca88a6534ed);
DB_Dialogs(S_LOW_BlushingMermaid_DisguisedRedcap_04_9f218fa2-418d-46ee-b38d-1708f25314ec, (DIALOGRESOURCE)LOW_BlushingMermaid_DisguisedRedcap_04_2cade439-faa3-fb56-b9d9-ae2fb27ae390);
DB_Dialogs(S_LOW_BlushingMermaid_DisguisedRedcap_05_357299a8-b8c2-4b99-92f8-761fd697c435, (DIALOGRESOURCE)LOW_BlushingMermaid_DisguisedRedcap_05_2bd6b6b2-0e7b-229f-0d46-1019e5517c74);
DB_Dialogs(S_LOW_BlushingMermaid_DisguisedRedcap_06_8a9a0273-3a3b-47ee-b362-5b83903458fb, (DIALOGRESOURCE)LOW_BlushingMermaid_DisguisedRedcap_06_c7e01376-59c8-d273-80d3-b6c88d0eed19);

DB_GLO_DefeatCounter(S_LOW_BlushingMermaid_DisguisedRedcap_01_efa9ccb1-4ba2-4467-82ef-b8ed63b867a4, "LOW_BlushingMermaid_RedcapsPermaDefeated");
DB_GLO_DefeatCounter(S_LOW_BlushingMermaid_DisguisedRedcap_02_ba363354-3341-41e9-ae92-c3fe8a07a9ea, "LOW_BlushingMermaid_RedcapsPermaDefeated");
DB_GLO_DefeatCounter(S_LOW_BlushingMermaid_DisguisedRedcap_03_76784911-9f0d-48f6-8e0d-b609345b2be2, "LOW_BlushingMermaid_RedcapsPermaDefeated");
DB_GLO_DefeatCounter(S_LOW_BlushingMermaid_DisguisedRedcap_04_9f218fa2-418d-46ee-b38d-1708f25314ec, "LOW_BlushingMermaid_RedcapsPermaDefeated");
DB_GLO_DefeatCounter(S_LOW_BlushingMermaid_DisguisedRedcap_05_357299a8-b8c2-4b99-92f8-761fd697c435, "LOW_BlushingMermaid_RedcapsPermaDefeated");
DB_GLO_DefeatCounter(S_LOW_BlushingMermaid_DisguisedRedcap_06_8a9a0273-3a3b-47ee-b362-5b83903458fb, "LOW_BlushingMermaid_RedcapsPermaDefeated");

DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_BlushingMermaid_RedcapsPermaDefeated",(FLAG)LOW_BlushingMermaid_State_DisguisedRedcaps_PermaDefeated_032aeb06-5eff-4459-8b1d-4ad796c15a8b);

// Ethel and Bosun
DB_Dialogs(S_LOW_BlushingMermaid_BosunGannet_d6f07cae-779b-4f10-b87c-c8117bfa1fe9, LOW_BlushingMermaid_BosunGannet_eb3db70d-cef4-fd66-688a-48b1bfd66fe0);
DB_LOW_Ethel((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_DoNotRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_DontRemoveDialogsOnKnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_PreventKnockedOutPermaDefeated((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3);
DB_SpotPlayers((CHARACTER)S_LOW_BlushingMermaid_BosunGannet_d6f07cae-779b-4f10-b87c-c8117bfa1fe9,"LOW_BosunGannetAD_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

DB_LOW_GoldRewardForKillingLora(3000);
DB_LOW_HagDialogsWithGold((DIALOGRESOURCE)LOW_BlushingMermaid_DisguisedHag_1632da0a-d0d7-4905-1c99-75c88102f102);
DB_LOW_HagDialogsWithGold((DIALOGRESOURCE)LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_Event_HagTransformsInDialog_5fa54251-1a34-4218-aa5b-f0ca9cda9c82,(DIALOGRESOURCE)LOW_BlushingMermaid_DisguisedHag_1632da0a-d0d7-4905-1c99-75c88102f102);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_State_PlayerBrokeDealWithHag_1e69b66d-9f46-4df5-aeb4-56382f8b1001,(DIALOGRESOURCE)LOW_BlushingMermaid_Hag_AfterDeal_7bcded43-4347-a00a-f2e7-63ca14eefc9f);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_State_HagCutOpen_d1772eba-c22b-4235-a492-eb39e0926237,(DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3);

DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BlushingMermaid_PreCellarCombat_Hag_3bd2c6d8-5638-4518-5c23-b057f70c0ede);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BlushingMermaid_HagVomitsOutDeadVanra_e3067621-8c76-c65e-8026-5dfaecc9d1de);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3);

// Quenora
DB_LOW_Quenora(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
DB_PermaDefeatedFlag(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(FLAG)LOW_BlushingMermaid_State_QuenoraGrizly_PermaDefeated_b6e14bf7-b6c5-4151-91b6-69669cf6f764);

// Vanra
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_Event_VanraWentToMom_895cda4f-6348-45c0-ba2e-bac1a7a1a0b2,(DIALOGRESOURCE)LOW_BlushingMermaid_VanraSaved_63754baa-d2dd-93fe-697c-dc9106b22291);
DB_DeadOnceFlag((CHARACTER)S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,(FLAG)LOW_BlushingMermaid_State_VanraIsDead_085595a2-d5d8-4379-ba50-5d92dbbbaa17);

DB_LOW_VanraSavedDialogs((DIALOGRESOURCE)LOW_BlushingMermaid_VomitsOutVanra_Hag_10f3400d-85f0-d324-5057-c0b6bdc6366c);
DB_LOW_VanraSavedDialogs((DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3);

// Patrons
DB_Dialogs(S_LOW_BlushingMermaid_Patron_01_4e7b519f-3e47-45d7-b2d1-20001a522bfe, S_LOW_BlushingMermaid_Patron_09_da46cc19-8972-478a-b063-7f7a5f61ae93, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_01_Patron_09_Debate_e08d01be-f122-db6e-dccf-5e4cb59267f3);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_12_b5c8b44e-c660-4a97-bbaf-8a0853a4c6c8, S_LOW_BlushingMermaid_Patron_13_0cd108a4-a496-4e90-8ee7-d09fe6bc0e47, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_12_Patron_13_Group_4f4d26ad-f1a2-692c-ecbd-bd93a093d9ac);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_02_01f6482f-3afc-496e-9d9a-cb078a2dd5b1, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_02_f4f8d77e-3dbc-ec3c-bb1c-0ca4ee1773e4);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_03_6bb7045e-7cdf-4188-a9d8-6b16abd25028, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_03_bcc767f7-7c30-534e-ef51-422b61eb38cc);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_04_8fec6485-b7c3-4b04-9c9c-6f94abaa4830, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_04_12d41bce-decf-657a-6dc8-162b66c31bbe);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_05_6c50ccb1-1215-4e98-8dc1-70d42478e2fc, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_05_4601e0f1-29e5-a75f-e419-4ead84a94387);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_06_33f7f264-5494-457b-b2f1-62ad6360db77, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_06_5c686f60-babf-3eab-9020-166fb0f348a2);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_07_34aad024-a7cc-4e75-b7c8-548e14c49909, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_07_2052fd73-05af-7c5c-9a37-de26898a5c8c);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_08_40dcda0b-7891-414f-8aeb-f742d842207d, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_08_f3833dae-d3d3-7500-213e-933f03f28185);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_10_2a1b36c5-ff2f-4228-ba2f-2d776d5cd66e, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_10_0c56c11a-deab-4e96-363c-067ab0fed7d8);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_11_b1f21c2d-1553-4a7b-86b5-ee31706e6c3e, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_11_15814a2e-e3c2-e7e3-62bb-83f61cd68f16);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_State_Patron_12_Left_27009b2b-39b4-4e4a-bdd8-fa518d6cfef7,(DIALOGRESOURCE)LOW_BlushingMermaid_Patron_12_Patron_13_Group_4f4d26ad-f1a2-692c-ecbd-bd93a093d9ac);

// Masked victims
DB_Dialogs(S_LOW_BlushingMermaid_MaskedVictim_01_453e3292-b7ff-4a13-873a-82da3bfc2511, (DIALOGRESOURCE)LOW_BlushingMermaid_MaskedVictim_01_9a99bb91-ca54-d441-cd99-fcada33d9bfb);
DB_Dialogs(S_LOW_BlushingMermaid_MaskedVictim_02_518fab8f-2d1d-46c8-9a45-9045156d0053, (DIALOGRESOURCE)LOW_BlushingMermaid_MaskedVictim_02_f5b6d56d-530a-7f76-f2ac-f2eb284d5e5c);
DB_Dialogs(S_LOW_BlushingMermaid_MaskedVictim_03_0406349d-d0fc-4bf5-8d18-5b8b8c9e6456, (DIALOGRESOURCE)LOW_BlushingMermaid_MaskedVictim_03_b2b282f4-8480-28db-f150-b04601d5241d);

DB_HAG_MaskedVictims((CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_01_453e3292-b7ff-4a13-873a-82da3bfc2511, S_BlushingMermaid_MaskedVictim_01_SummonPoint_8ad3574e-b460-4b6f-9fd8-88bf156a0647, 100, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_MaskedVictim_01_Resist_c9e4e0d9-753e-ed79-f2b8-b0deb6678166);
DB_HAG_MaskedVictims((CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_02_518fab8f-2d1d-46c8-9a45-9045156d0053, S_BlushingMermaid_MaskedVictim_02_SummonPoint_bb42763f-1ad9-4188-837c-332bb6e179d3, 300, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_MaskedVictim_02_Resist_81751a2f-c222-e5ff-4dd8-0dd6616f31f7);
DB_HAG_MaskedVictims((CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_03_0406349d-d0fc-4bf5-8d18-5b8b8c9e6456, S_BlushingMermaid_MaskedVictim_03_SummonPoint_92a75e09-5204-4b65-9e2a-cee57709043b, 600, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_MaskedVictim_03_Resist_a551c32c-da72-a67d-09ed-41ab75196486);

DB_LOW_MaskedVictims_HagMask((CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_01_453e3292-b7ff-4a13-873a-82da3bfc2511,(ITEM)S_LOW_BlushingMermaid_HagMask_01_4c1dfe00-dda3-4c8d-bf27-3104373591c5,(ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_NoteMaskedVictim01_6c034de3-de99-46ee-b138-e0b8f47cb923);
DB_LOW_MaskedVictims_HagMask((CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_02_518fab8f-2d1d-46c8-9a45-9045156d0053,(ITEM)S_LOW_BlushingMermaid_HagMask_02_88327f51-cc84-4086-987a-c98a3fd2a3f9,(ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_NoteMaskedVictim02_73df7add-f652-4d0e-8d75-6829e7471bde);
DB_LOW_MaskedVictims_HagMask((CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_03_0406349d-d0fc-4bf5-8d18-5b8b8c9e6456,(ITEM)S_LOW_BlushingMermaid_HagMask_03_d7ec6309-7b22-4d01-8226-d76100d00906,(ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_NoteMaskedVictim03_f0c080dd-e103-4cb6-9dc1-47c41abadc80);
DB_LOW_MaskedVictims_HagMask((CHARACTER)S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(ITEM)S_LOW_BlushingMermaid_QuenorasHagMask_6eb1036e-017e-4cc2-8f65-1cc0cda601ad,(ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_NoteMaskedCaptain_3574bf1f-3843-464e-8149-546b83189a4b);

// Hag masks
// Worn by masked victims
DB_HAG_Hagmasks((ITEM)S_LOW_BlushingMermaid_HagMask_01_4c1dfe00-dda3-4c8d-bf27-3104373591c5, (ITEM)S_LOW_BlushingMermaid_HagMask_Helper_01_862d8a74-6489-4df2-9541-708137bb2a34);
DB_HAG_Hagmasks((ITEM)S_LOW_BlushingMermaid_HagMask_02_88327f51-cc84-4086-987a-c98a3fd2a3f9, (ITEM)S_LOW_BlushingMermaid_HagMask_Helper_02_976845a2-e54d-4f8f-a66b-cb6680029c97);
DB_HAG_Hagmasks((ITEM)S_LOW_BlushingMermaid_HagMask_03_d7ec6309-7b22-4d01-8226-d76100d00906, (ITEM)S_LOW_BlushingMermaid_HagMask_Helper_03_e198c083-7c20-4737-b359-a042f7de7fc5);
DB_HAG_Hagmasks((ITEM)S_LOW_BlushingMermaid_QuenorasHagMask_6eb1036e-017e-4cc2-8f65-1cc0cda601ad, (ITEM)S_LOW_BlushingMermaid_QuenorasHagMask_Helper_4269d779-ceb8-4230-a36d-29282ae4b47f);

DB_CombatReact_AD_OnEntered(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(DIALOGRESOURCE)LOW_BlushingMermaid_AD_MaskedVictims_Attack_73159625-84fb-de53-ba67-e5af69c5c9dc);
DB_Inclusion_Object((CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_01_453e3292-b7ff-4a13-873a-82da3bfc2511, (FLAG)LOW_BlushingMermaid_MaskedVictim_01_StartInclusion_dee67ea6-5ae3-4b41-80ba-9d8c42894b9b, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_Object((CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_02_518fab8f-2d1d-46c8-9a45-9045156d0053, (FLAG)LOW_BlushingMermaid_MaskedVictim_02_StartInclusion_ae5fed06-bde9-4fce-881d-a243933e0645, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_BlushingMermaid_AD_MaskedVictims_Attack_73159625-84fb-de53-ba67-e5af69c5c9dc, (CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_01_453e3292-b7ff-4a13-873a-82da3bfc2511);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_BlushingMermaid_AD_MaskedVictims_Attack_73159625-84fb-de53-ba67-e5af69c5c9dc, (CHARACTER)S_LOW_BlushingMermaid_MaskedVictim_02_518fab8f-2d1d-46c8-9a45-9045156d0053);
DB_Inclusion_CombatInclusionDialog(LOW_BlushingMermaid_AD_MaskedVictims_Attack_73159625-84fb-de53-ba67-e5af69c5c9dc);

// Available for players to pick up
DB_HAG_Hagmasks((ITEM)S_LOW_BlushingMermaid_HagMask_04_d6256093-4f74-4236-b4b0-be3753f7e7da, (ITEM)S_LOW_BlushingMermaid_HagMask_Helper_04_4cae6d53-5b4e-42ec-ae5b-a70fe55dd64f);

// In disguised redcaps inventories
DB_HAG_Hagmasks((ITEM)S_LOW_BlushingMermaid_HagMask_05_ec401ec6-6488-4799-b7d1-08008b1131fe, (ITEM)S_LOW_BlushingMermaid_HagMask_Helper_05_9c90d121-c084-489b-8f90-aef85db5a14e);
DB_HAG_Hagmasks((ITEM)S_LOW_BlushingMermaid_HagMask_06_2b0adc7a-a45e-4713-a10f-d240dc8926ba, (ITEM)S_LOW_BlushingMermaid_HagMask_Helper_06_a58dd7a0-7c9d-440b-a3d5-b960df5b3492);
DB_HAG_Hagmasks((ITEM)S_LOW_BlushingMermaid_HagMask_07_c4784b6e-8dbf-42c8-a7d8-c1bf756cab2c, (ITEM)S_LOW_BlushingMermaid_HagMask_Helper_07_54920138-c18a-4a72-b24e-4487cbdd9cc2);

PROC_TriggerRegisterForParty((TRIGGER)S_LOW_BlushingMermaid_Pub_Trigger_dc4d50f8-5bee-4117-9722-ac02e7ab113f);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_BlushingMermaid_CellarTrigger_2c889517-8252-49f0-a55c-ead662b8cb3f);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_BlushingMermaid_VanraDialogTrigger_56469603-08e9-45cd-8412-da70896834e3);
TriggerRegisterForCharacter((TRIGGER)S_LOW_BlushingMermaid_Pub_Trigger_dc4d50f8-5bee-4117-9722-ac02e7ab113f,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
TriggerRegisterForCharacter((TRIGGER)S_LOW_BlushingMermaid_CellarTrigger_2c889517-8252-49f0-a55c-ead662b8cb3f,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_LOW_HagVomitTriggers((TRIGGER)S_LOW_BlushingMermaid_Pub_Trigger_dc4d50f8-5bee-4117-9722-ac02e7ab113f);
DB_LOW_HagVomitTriggers(S_LOW_BlushingMermaid_CellarTrigger_2c889517-8252-49f0-a55c-ead662b8cb3f);

// Hag Shrooms
DB_GLO_DefeatCounter(S_LOW_BlushingMermaid_HagRegenShroom_01_cd00e76d-ed4b-494f-a42e-877cb79cf4f2,"LOW_HagResurrectionShrooms_PermaDefeated");
DB_GLO_DefeatCounter(S_LOW_BlushingMermaid_HagRegenShroom_02_dde4a500-970e-4866-ac0b-bbd07d61dfe2,"LOW_HagResurrectionShrooms_PermaDefeated");
DB_GLO_DefeatCounter(S_LOW_BlushingMermaid_HagRegenShroom_03_9005b647-c8c6-43b5-ab76-ac9f5636b30a,"LOW_HagResurrectionShrooms_PermaDefeated");
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_HagResurrectionShrooms_PermaDefeated",(FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33);
DB_GLO_DefeatCounter_IgnoreWaitForCombatEnd("LOW_HagResurrectionShrooms_PermaDefeated");

DB_LOW_DefeatedShroomsToResurrectionHP(0,100.0);
DB_LOW_DefeatedShroomsToResurrectionHP(1,80.0);
DB_LOW_DefeatedShroomsToResurrectionHP(2,60.0);

DB_LOW_DefeatedShroomsToCombatPhase(1,(FLAG)LOW_BlushingMermaid_State_HagCombatPhase_2_b9def2bd-bb1a-49e3-96af-958e853293c5);
DB_LOW_DefeatedShroomsToCombatPhase(2,LOW_BlushingMermaid_State_HagCombatPhase_3_a5e3f2dd-5294-4776-826b-60c029cb7590);
DB_LOW_DefeatedShroomsToCombatPhase(3,LOW_BlushingMermaid_State_HagCombatPhase_4_593877d7-9b40-4485-a171-0e316c6a7ea1);

// shrooms should share combat group with  the hag
DB_LOW_ShroomSupportSpells("LOW_HAG_RESURRECTING","Target_LOW_HagShroom_Resurrect");
DB_LOW_ShroomSupportSpells("LOW_HAG_AWAKENING","Target_LOW_HagShroom_Awaken");

DB_LOW_HagDialogsPreventingReteatWhenShroomDefeated((DIALOGRESOURCE)LOW_BlushingMermaid_HagVomitsOutDeadVanra_e3067621-8c76-c65e-8026-5dfaecc9d1de);
DB_LOW_HagDialogsPreventingReteatWhenShroomDefeated((DIALOGRESOURCE)LOW_BlushingMermaid_VomitsOutVanra_Hag_10f3400d-85f0-d324-5057-c0b6bdc6366c);
DB_LOW_HagDialogsPreventingReteatWhenShroomDefeated((DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3);

// Hag Doubles
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_001_0c9b0cab-b061-4210-b8ea-53e99dfc7733);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_002_323e77e7-9f2e-44b7-b665-75aeeb8bbb80);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_003_e061d56e-c38c-4bf4-b774-57e18f0b0fd3);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_004_466e8124-43d6-4c68-8e01-563ca87b7ebd);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_005_0eaa5e37-4a37-4368-a236-e54b4326f74e);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_006_4fc852d9-8d67-426f-99f0-25bc7002fbe4);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_007_ca54dcdb-7f96-497f-a01b-0c6f7430470c);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_008_d861dd3a-a880-480c-ac0a-26dbb0282ef3);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_009_969f307b-4e65-4441-b704-327e9acfc862);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_010_38120058-8c82-4132-85f7-8132b892204e);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_011_82333eef-288f-4863-8431-4e0fa254d4c4);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_012_696772c0-544c-4a19-893d-33a88c3d2425);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_013_6030f9dc-1b71-49fd-b57f-1238f72e1128);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_014_ce06635c-c5dd-4c4a-8ad4-f914e904aa47);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_015_14bc1f7c-c611-419c-ae8b-ae878e1fe903);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_016_e68d735c-ce0c-4989-b704-599b6bc0e68e);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_017_e838e5f7-8aa7-4763-b29c-dd318a60e683);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_019_ea575095-19ae-45db-8c48-42f186e3bcec);
DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_020_587022c0-8870-457a-aa51-3f8384a7c1ce);

// Voice bark
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_LOW_BlushingMermaid_HaggyCellarVB_Trigger_10db15eb-cad9-4a6c-8e60-5dfaa95c25f4,(VOICEBARKRESOURCE)LOW_BlushingMermaid_VB_HaggyCellar_270d9d64-8ecd-3075-3d6f-5d39930df108);

DB_PartyProgress_Trigger((TRIGGER)S_LOW_BlushingMermaid_HaggyCellar_Trigger_47b776be-f7c3-4104-b1e4-7ff53c8eea0a,(FLAG)LOW_BlushingMermaid_State_EnteredHagCellar_NoHagReveal_42a4b333-0d02-4397-b232-9d35aa1ccccd);

DB_LOW_BlushingMermaidBasementEntranceIllusuion(S_LOW_BlushingMermaid_BasementEntraceIllusion_543ad91c-25c7-4036-b117-8822e89f54f2);

//REGION LOW_SaveHaggedChild quest
// Start, searching for Vanra
DB_QuestDef_State((FLAG)LOW_BasiliskGate_State_KnowsVanraIsMissing_8c800e14-8dba-4685-a95e-81a719da60eb,"LOW_SaveHaggedChild","TalkedWithLora");
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_FindMissingKidMotherAccepted_5c647e06-a54a-1211-577a-441d07b267d4,"LOW_SaveHaggedChild","MayrinaAskedToFindLora");
DB_QuestDef_State((FLAG)LOW_BlushingMermaid_State_BosunToldAboutCaptain_4ec7115d-93d3-40df-a87c-5683f647a49e,"LOW_SaveHaggedChild","TalkedWithBosun");
DB_QuestDef_State((FLAG)LOW_BlushingMermaid_State_TookTimeKillLoraOffer_5e674785-2178-4b53-94b6-a09e4dfe32ca,"LOW_SaveHaggedChild","TalkedHag_NoLoraKillDecision");
DB_QuestDef_State((FLAG)LOW_BlushingMermaid_State_PlayersReadHagInformantsNote_23cc4563-f336-4f9e-a83c-35fe8b8f8308,"LOW_SaveHaggedChild","ReadHagsInformantNote");
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_EnteredHagCellar_NoHagReveal_42a4b333-0d02-4397-b232-9d35aa1ccccd,"LOW_SaveHaggedChild","EnteredHagBasement",0,(FLAG)LOW_BlushingMermaid_State_MayrinaToldHagStoleKid_147e85e3-6a90-4a98-b721-ca726bd98c61);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_EnteredHagCellar_NoHagReveal_42a4b333-0d02-4397-b232-9d35aa1ccccd,"LOW_SaveHaggedChild","EnteredHagBasement_CuredMayrina",1,(FLAG)LOW_BlushingMermaid_State_MayrinaToldHagStoleKid_147e85e3-6a90-4a98-b721-ca726bd98c61);

// Hag asking to kill Lora, Hag reveal
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_AgreedToBringHeadToHag_c0a98ec4-171f-46c1-9a67-80140da3703e,"LOW_SaveHaggedChild","AcceptedKillLora_FirstOffer",0,(FLAG)LOW_BlushingMermaid_State_TookTimeKillLoraOffer_5e674785-2178-4b53-94b6-a09e4dfe32ca);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_AgreedToBringHeadToHag_c0a98ec4-171f-46c1-9a67-80140da3703e,"LOW_SaveHaggedChild","AcceptedKillLora_AfterFirstOffer",1,(FLAG)LOW_BlushingMermaid_State_TookTimeKillLoraOffer_5e674785-2178-4b53-94b6-a09e4dfe32ca);
DB_QuestDef_State((FLAG)LOW_BlushingMermaid_State_MissingKidsMother_Dead_357a9292-30cb-4625-aefd-7f27d89c9511 ,"LOW_SaveHaggedChild","KilledLora");
DB_QuestDef_State((FLAG)LOW_BasiliskGate_State_KnockedOutLoraDisappeared_eade1142-3a15-4bb0-a940-0317c7d24aa6,"LOW_SaveHaggedChild","KnockedOutLora_DisappearedOnLongRest");
DB_QuestDef_State((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5,"LOW_SaveHaggedChild","DealWithHag");
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369,"LOW_SaveHaggedChild","HagCellarRetreat",0,(FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5);

// Hag Boss fight, rescuing Vanra.
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61,"LOW_SaveHaggedChild","HagBossFightStarted_BrokeDeal",1,(FLAG)LOW_BlushingMermaid_State_MadeDealWithHag_5d727ce8-a931-4a70-9c84-413565825b0c);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61,"LOW_SaveHaggedChild","HagBossFightStarted",0,(FLAG)LOW_BlushingMermaid_State_HagQuestGrenade_BookRead_6c36ea74-ea4e-4974-b9cd-dd49ca00265f);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61,"LOW_SaveHaggedChild","HagBossFightStarted_KnowsGrenadeRecipe",1,(FLAG)LOW_BlushingMermaid_State_HagQuestGrenade_BookRead_6c36ea74-ea4e-4974-b9cd-dd49ca00265f);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_VanraOutOfHag_80a69cad-828a-4d92-9bc3-9acf206f9739,"LOW_SaveHaggedChild","VanraSavedWithQuestGrenade",0,(FLAG)LOW_BlushingMermaid_State_HagCutOpen_d1772eba-c22b-4235-a492-eb39e0926237);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_VanraOutOfHag_80a69cad-828a-4d92-9bc3-9acf206f9739,"LOW_SaveHaggedChild","VanraCarvedOut",1,(FLAG)LOW_BlushingMermaid_State_HagCutOpen_d1772eba-c22b-4235-a492-eb39e0926237);

// COMPLETION steps for when Vanra went home based on Lora states
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_Event_VanraWentToMom_895cda4f-6348-45c0-ba2e-bac1a7a1a0b2,"LOW_SaveHaggedChild","VanraReturnedHome_NoLora",1,(FLAG)LOW_BlushingMermaid_State_MissingKidsMother_PermaDefeated_b77d4de2-9c85-447c-94d3-776bac904880);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_Event_VanraWentToMom_895cda4f-6348-45c0-ba2e-bac1a7a1a0b2,"LOW_SaveHaggedChild","VanraReturnedHome_LoraPermaHostile",1,(FLAG)LOW_BlushingMermaid_State_MissingKidsMother_PermaHostile_8b29049d-1cc3-4d94-a147-b4cb1068237f);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_Event_VanraWentToMom_895cda4f-6348-45c0-ba2e-bac1a7a1a0b2,"LOW_SaveHaggedChild","VanraReturnedHome_LoraNeverAsked",0,(FLAG)LOW_BasiliskGate_State_KnowsVanraIsMissing_8c800e14-8dba-4685-a95e-81a719da60eb);

// Vanra went home, visting her and Lora afterwards COMPLETION step
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_Event_VanraWentToMom_895cda4f-6348-45c0-ba2e-bac1a7a1a0b2,"LOW_SaveHaggedChild","VanraReturnedHome_LoraHome",0,(FLAG)LOW_BlushingMermaid_State_MissingKidsMother_PermaHostile_8b29049d-1cc3-4d94-a147-b4cb1068237f);
DB_QuestDef_State((FLAG)LOW_BlushingMermaid_State_RewardFromLoraReceived_28060f87-7cba-4cbe-9dcd-24654fd6bdbb,"LOW_SaveHaggedChild","LoraGaveReward");

DB_QuestDef_PermaDefeatedState("LOW_SaveHaggedChild","VanraPermaDefeated",(CHARACTER)S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c);
//END_REGION

// Combat NPC Reactivity
DB_CombatReact_AD_OnNextTurn(S_LOW_BlushingMermaid_DisguisedRedcap_01_efa9ccb1-4ba2-4467-82ef-b8ed63b867a4, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_Combat_Redcaps_000_8474fd31-eab1-1d04-0ec0-753830c07fbb);
DB_CombatReact_AD_OnNextTurn(S_LOW_BlushingMermaid_DisguisedRedcap_04_9f218fa2-418d-46ee-b38d-1708f25314ec, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_Combat_Redcaps_001_3f946954-8f7a-5075-ab9e-5f632ebf19d4);
DB_CombatReact_AD_OnNextTurn(S_LOW_BlushingMermaid_DisguisedRedcap_05_357299a8-b8c2-4b99-92f8-761fd697c435, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_Combat_Redcaps_002_ebaa219f-5f2a-fb64-8a9e-d59bae188227);
DB_CombatReact_AD_OnNextTurn(S_LOW_BlushingMermaid_DisguisedRedcap_06_8a9a0273-3a3b-47ee-b362-5b83903458fb, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_Combat_Redcaps_003_e17e2c39-e12e-d20a-be02-3d5e9a12a2fa);
DB_CombatReact_AD_OnCast(S_LOW_BlushingMermaid_DisguisedRedcap_02_ba363354-3341-41e9-ae92-c3fe8a07a9ea, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_Combat_Redcaps_Multiattack_cc504a67-82e7-bdd0-e753-09d8a9768b5e, "Target_LOW_BlushingMermaid_Redcap_MultiAttack");
DB_CombatReact_AD_AppliedStatus(S_LOW_BlushingMermaid_DisguisedRedcap_03_76784911-9f0d-48f6-8e0d-b609345b2be2, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_Combat_Redcaps_Bloodlust_ec35f545-9ae2-5a64-b215-76ba5b9d1393, "LOW_REDCAP_BLOODLUST");
KBSECTION
//REGION Hag/Quenora setup in case players dealt with the hag in Act 1
IF
DB_LOW_Ethel(_Ethel)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
NOT DB_GLO_CharacterCorpseDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, HAG_Hag_Dead_ce5651fe-84a8-598c-a98c-abd136055663);
RemoveHarmfulStatuses(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetCanTrade(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,0);
SetCombatGroupID(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HagBossFight");
PROC_SpotPlayers_StopSpotting(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_Hag");
PROC_RemoveAllDialogEntriesForSpeaker(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_NoLowAttitudeDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_LOW_LevelTeleportHagResurrecting(1);
DB_SceneManager(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_DisguisedHag_Scene");
DB_Dialogs(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, LOW_BlushingMermaid_DisguisedHag_1632da0a-d0d7-4905-1c99-75c88102f102);
DB_PreventPermaDefeated(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
TeleportTo(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, S_LOW_BlushingMermaid_QuenoraTeleportSpot_2244ed9b-e942-49f2-85aa-465f6defaef2, "");
PROC_SetOnStage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 1);
Resurrect(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HAG_DISGUISE",-1.0,0);
SetHitpointsPercentage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,100.0);
SetImmortal(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1);
SetFlag((FLAG)LOW_BlushingMermaid_State_HagInBaldursGate_68d1731c-7a20-4692-a093-5aa39b69d211);
PROC_LOW_SetOnStage_Redcaps(1);
PROC_Poof(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c);
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e,50);
PROC_SetRelationToPlayers((FACTION)GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0,0);
PROC_LOW_SetShroomDifficulty();
PROC_SetCustomTradeTreasure(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_Hag");

IF
DB_LOW_Quenora(_Quenora)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
DB_HAG_MaskedVictims((CHARACTER)S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232, S_BlushingMermaid_QuenoraGrizly_SummonPoint_22b859c4-fecd-4a09-a581-43a378d6be86, 700, (DIALOGRESOURCE)LOW_BlushingMermaid_AD_QuenoraGrizly_Resist_6313b4b6-7332-c76c-e42f-ceb6248d509d);
DB_Dialogs(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232, LOW_BlushingMermaid_QuenoraGrizly_Masked_2720cc15-7f8b-af63-7ed8-adea66cfd931);
TeleportTo(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,S_LOW_BlushingMermaid_QuenoraCellarTeleportSpot_aa0d6690-3ce1-4636-8be0-ea0180d134e1);
SetFaction(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232, (FACTION)GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0);
SetTag(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(TAG)AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
RemoveStatus(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,"ANIM_OVERRIDE_BM_HANGOVER_01");
PROC_LOW_BlushingMermaid_OwnershipTriggerSertup(S_LOW_BlushingMermaid_BosunGannet_d6f07cae-779b-4f10-b87c-c8117bfa1fe9);
//END_REGION

//REGION Quenora setup in case the hag wasn't dealt in Act 1 and thus didn't make it to BG
// Hag wasn't killed in Act I, Blushing Mermaid as usual
IF
DB_LOW_Quenora(_Quenora)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
DB_Dialogs(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(DIALOGRESOURCE)LOW_BlushingMermaid_QuenoraGrizly_4f9eea9b-d3e9-6eaf-5d26-8fef98f93105);
Resurrect(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
TeleportTo(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,S_LOW_BlushingMermaid_QuenoraTeleportSpot_2244ed9b-e942-49f2-85aa-465f6defaef2);
Unequip((CHARACTER)S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(ITEM)S_LOW_BlushingMermaid_QuenorasHagMask_6eb1036e-017e-4cc2-8f65-1cc0cda601ad);
SetFaction(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(FACTION)ACT3_LOW_BlushingMermaid_Civilians_c0d4b9de-5884-41c1-aab8-1fbce6991129);
ToInventory((ITEM)S_LOW_BlushingMermaid_CellarDoor_Key_b67244b6-d831-41da-8b95-c085238e876b,S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
ClearTag(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(TAG)ACT3_LOW_HAG_9b91e9ae-0205-476d-a381-17dca1b2cdc7);
ApplyStatus(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,"ANIM_OVERRIDE_BM_HANGOVER_01",-1.0);
PROC_LOW_SetOnStage_Redcaps(0);
PROC_LOW_BlushingMermaid_OwnershipTriggerSertup(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
//END_REGION

//REGION Hag Masks
IF
DB_HAG_Hagmasks(_Mask,_)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
NOT GetDirectInventoryOwner(_Mask,_)
THEN
PROC_SetOnStage(_Mask,0);

IF
DB_HAG_Hagmasks(_Mask,_)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_SetOnStage(_Mask,1);
//END_REGION

//REGION Masked Victims
IF
DB_HAG_MaskedVictims(_MaskedVictim, _, _, _)
AND
NOT DB_LOW_Quenora(_MaskedVictim)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_SetOnStage(_MaskedVictim,0);

IF
DB_HAG_MaskedVictims(_MaskedVictim, _, _, _)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
DB_LOW_MaskedVictims_HagMask(_MaskedVictim,_Mask,_BookRoot)
THEN
PROC_SetOnStage(_MaskedVictim,1);
TemplateAddTo(_BookRoot,_MaskedVictim,1);
ApplyStatus(_MaskedVictim,"HAG_MASK_NPC",-1.0);
Equip(_MaskedVictim,_Mask);
SetCombatGroupID(_MaskedVictim,"LOW_MaskedVictims");

// If players make deal with the hag, masked victims don't aggro
IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5,_,_)
THEN
SetFlag((FLAG)LOW_BlushingMermaid_State_MadeDealWithHag_5d727ce8-a931-4a70-9c84-413565825b0c);
PROC_SetRelationToPlayers((FACTION)GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0,50);

// Hag summons victims for boss fight, the flag is set in LOW_Hag.ann
IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagSummonedMaskedVictims_9f668b40-cd80-48ea-bca7-ac4c046163f4, _, _)
AND
DB_HAG_MaskedVictims(_Victim, _, _Timer, _)
THEN
PROC_ForceStopDialog(_Victim);
ObjectTimerLaunch(_Victim, "LOW_HagSummonedMaskedVictims_Timer",_Timer);

//Delay timer before teleport down
IF
ObjectTimerFinished(_Victim, "LOW_HagSummonedMaskedVictims_Timer")
AND
DB_HAG_MaskedVictims((CHARACTER)_Victim, _Trigger, _, _)
THEN
PlayEffect(_Victim,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f,"",1.0);
PlayEffect(_Trigger,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f,"",1.0);
TeleportTo(_Victim, _Trigger);
SetCombatGroupID(_Victim,"LOW_HagBossFight");
SetFaction(_Victim, GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e);

// When hag is truly dealt with, masked victims return into masked faction which is now neutral to players
PROC
PROC_LOW_MaskedVictimsNeutral()
AND
DB_HAG_MaskedVictims(_Victim, _Trigger, _, _)
THEN
SetFaction(_Victim, GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0);

PROC
PROC_LOW_MaskedVictimsNeutral()
THEN
PROC_SetRelationToPlayers((FACTION)GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0, 50);
PROC_SetRelationMutual((FACTION)GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0,(FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 50);
//END_REGION

//REGION Redcaps
PROC
PROC_LOW_SetOnStage_Redcaps((INTEGER)_Bool)
AND
DB_LOW_DisguisedRedcaps(_Redcap,_Disguise)
THEN
PROC_SetOnStage(_Redcap, _Bool);

IF
DB_LOW_DisguisedRedcaps(_Redcap,_Disguise)
THEN
ApplyStatus(_Redcap, _Disguise,-1.0,0);

IF
RelationChanged((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,0,1)
AND
DB_LOW_DisguisedRedcaps(_Redcap,_Disguise)
THEN
RemoveStatus(_Redcap,_Disguise);
PROC_RemoveAllDialogEntriesForSpeaker(_Redcap);

IF
RelationChanged((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,0,1)
THEN
SetFlag((FLAG)LOW_BlushingMermaid_State_DisguisedRedcapsDroppedDisguise_da4c2802-faa5-4e60-a591-f52c2622e6f9);
PROC_SetRelationMutual((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,(FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428,0);
PROC_SetRelationMutual((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,(FACTION)GLO_FlamingFists_Reinforcements_a2a56601-616b-4d85-b571-cf34fc5801a8,0);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_DisguisedRedcapsDroppedDisguise_da4c2802-faa5-4e60-a591-f52c2622e6f9,_,_)
AND
DB_LOW_DisguisedRedcapsPlayersToAttack(_Player)
AND
DB_LOW_DisguisedRedcaps(_Redcap,_)
THEN
PROC_EnterCombat(_Player,_Redcap);

PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_DisguisedRedcapsDroppedDisguise_da4c2802-faa5-4e60-a591-f52c2622e6f9)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_DisguisedRedcaps_PermaDefeated_032aeb06-5eff-4459-8b1d-4ad796c15a8b)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HadLongRestAfterPermaDefeatingRedcaps_7ebdacc6-5aa5-486b-88ab-0d09829bd1e5)
THEN
SetFlag((FLAG)LOW_BlushingMermaid_State_HadLongRestAfterPermaDefeatingRedcaps_7ebdacc6-5aa5-486b-88ab-0d09829bd1e5);

PROC
PROC_SceneInterrupted((CHARACTER)_DisguisedRedcap,_Character,"LOW_DisguisedHag_Scene","Attacked")
AND
DB_LOW_DisguisedRedcaps(_DisguisedRedcap,_)
AND
DB_PartyMembers(_Character)
AND
QRY_OnlyOnce("LOW_DisguisedRedcapAttacked_HagDropsDisguise")
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,0);
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE");
SetFlag((FLAG)LOW_BlushingMermaid_State_DisguisedRedcapAttacked_097435c5-0a18-4062-8932-61ef459aa5ff);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_DisguisedRedcapsDroppedDisguise_da4c2802-faa5-4e60-a591-f52c2622e6f9,_,_)
THEN
// These patrons don't have reactions to redcap attacks in their dialogs
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_LOW_BlushingMermaid_Patron_02_01f6482f-3afc-496e-9d9a-cb078a2dd5b1,"LOW_BlushingMermaidPatronRunAway_Notify");
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_LOW_BlushingMermaid_Patron_08_40dcda0b-7891-414f-8aeb-f742d842207d,"LOW_BlushingMermaidPatronRunAway_Notify");

PROC
PROC_ReadyToMoveOn(_Patron,"LOW_BlushingMermaidPatronRunAway_Notify")
THEN
PROC_DisappearOutOfSight(_Patron,"Run",1,"");
//END_REGION

//REGION Ownership Trigger Setup
PROC
PROC_LOW_BlushingMermaid_OwnershipTriggerSertup((GUIDSTRING)_Owner)
AND
_Owner == S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232
THEN
PROC_LOW_BlushingMermaid_OwnershipTriggerCleanup();
DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_BlushingMermaid_OwnershipTrigger_308b4eb6-9778-4065-aa04-478a0d26821d,(CHARACTER)S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
DB_ItemOwnerShipTriggersFallback((TRIGGER)S_LOW_BlushingMermaid_OwnershipTrigger_308b4eb6-9778-4065-aa04-478a0d26821d,S_LOW_BlushingMermaid_BosunGannet_d6f07cae-779b-4f10-b87c-c8117bfa1fe9);

PROC
PROC_LOW_BlushingMermaid_OwnershipTriggerSertup((GUIDSTRING)_Owner)
AND
_Owner == S_LOW_BlushingMermaid_BosunGannet_d6f07cae-779b-4f10-b87c-c8117bfa1fe9
THEN
PROC_LOW_BlushingMermaid_OwnershipTriggerCleanup();
DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_BlushingMermaid_OwnershipTrigger_308b4eb6-9778-4065-aa04-478a0d26821d,(CHARACTER)S_LOW_BlushingMermaid_BosunGannet_d6f07cae-779b-4f10-b87c-c8117bfa1fe9);

PROC
PROC_LOW_BlushingMermaid_OwnershipTriggerCleanup()
AND
DB_ItemOwnerShipTriggersFallback((TRIGGER)S_LOW_BlushingMermaid_OwnershipTrigger_308b4eb6-9778-4065-aa04-478a0d26821d,_FallbackOwner)
THEN
NOT DB_ItemOwnerShipTriggersFallback((TRIGGER)S_LOW_BlushingMermaid_OwnershipTrigger_308b4eb6-9778-4065-aa04-478a0d26821d,_FallbackOwner);

PROC
PROC_LOW_BlushingMermaid_OwnershipTriggerCleanup()
THEN
TriggerClearItemsOwner((TRIGGER)S_LOW_BlushingMermaid_OwnershipTrigger_308b4eb6-9778-4065-aa04-478a0d26821d);

IF
DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_BlushingMermaid_OwnershipTrigger_308b4eb6-9778-4065-aa04-478a0d26821d,_)
THEN
ClearOwnership((ITEM)S_LOW_BlushingMermaid_CellarDoor_Upstairs_25633b00-cb37-43a6-97cc-707c1f9f4b83);
ClearOwnership((ITEM)S_LOW_BlushingMermaid_CellarDoor_Upstairs_2_3d43d839-e612-468a-8c9b-c186febce1cf);
ClearOwnership((ITEM)S_LOW_BuriedMound_07_7726f589-3ae9-41ac-9d85-c03e23f47df6);
//END_REGION

//REGION BM Spotting events
IF
DB_LOW_Ethel(_DisguisedHag)
THEN
DB_SpotPlayers(_DisguisedHag,"LOW_EthelDrinkSuggestion_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous(_DisguisedHag,"LOW_EthelDrinkSuggestion_Spotting");

PROC
PROC_SpotPlayers_Spotted(_,"LOW_EthelDrinkSuggestion_Spotting",_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRevealed_aa751f69-f448-1436-c243-eb9f06a060ca)
AND
DB_GlobalFlag((FLAG)LOW_BasiliskGate_State_KnowsVanraIsMissing_8c800e14-8dba-4685-a95e-81a719da60eb)
THEN
PROC_TryStartAD(LOW_BlushingMermaid_AD_Greeting_AuntieEthel_eb80a1f4-680b-350b-1a70-20b15c4b0628,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_SpotPlayers_StopSpotting(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_EthelDrinkSuggestion_Spotting");

PROC
PROC_SpotPlayers_Spotted(_,"LOW_BosunGannetAD_Spotting",_Player)
AND
QRY_OnlyOnce("LOW_BosunGannetAD_Spotting")
THEN
PROC_TryStartAD(LOW_BlushingMermaid_AD_Greeting_BosunGannet_b817e48e-6d09-c0a9-314c-2d43ed2f62b2,S_LOW_BlushingMermaid_BosunGannet_d6f07cae-779b-4f10-b87c-c8117bfa1fe9);
//END_REGION

//REGION Hag disguise
IF
StatusApplied(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE",_,_)
THEN
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"ANIM_OVERRIDE_BM_HANGOVER_01",-1.0);
// For some reason just setting the title in this event doesn't work, thus I use the timer
RealtimeObjectTimerLaunch(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_SetHagDisguisedTitle_Timer",1);

IF
ObjectTimerFinished(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_SetHagDisguisedTitle_Timer")
THEN
ObjectSetTitle(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_BlushingMermaid_EmptyHagTitle");

IF
StatusRemoved(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE",_,_)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"ANIM_OVERRIDE_BM_HANGOVER_01");
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_PREGNANT",-1.0);
Transform(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,Hag_Green_Pregnant_5c1b2180-1225-43a6-91ff-f176f2cdd741,(SHAPESHIFTRULE)DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);
PROC_SpotPlayers_StopSpotting(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_EthelDrinkSuggestion_Spotting");
PROC_SceneOver("LOW_DisguisedHag_Scene");
PROC_RemoveAllDialogEntriesForSpeaker(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_HagRevealed_aa751f69-f448-1436-c243-eb9f06a060ca);
ObjectSetTitle(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_HagTitle");
NOT DB_PartyProgress_Trigger((TRIGGER)S_LOW_BlushingMermaid_HaggyCellar_Trigger_47b776be-f7c3-4104-b1e4-7ff53c8eea0a,(FLAG)LOW_BlushingMermaid_State_EnteredHagCellar_NoHagReveal_42a4b333-0d02-4397-b232-9d35aa1ccccd);

IF
StatusRemoved(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE",_,_)
AND
GetHitpoints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HP)
AND
_HP > 0
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35)
AND
NOT QRY_LOW_HagTransformed_StartDialogCustom()
THEN
PROC_LOW_HagRetreatsToOrlop();

// Edge case for when hag is one-shotted while disguised
IF
StatusRemoved(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE",_,_)
AND
GetHitpoints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HP)
AND
_HP <= 0
THEN
DB_LOW_HagKilledWhileDisguised(1);

// Prevents crimes force stoping Dead Vanra vomit dialog
QRY
QRY_CRIME_BlockRegisterCrime(_,_,_,_,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
AND
DB_LOW_HagKilledWhileDisguised(1)
THEN
DB_Noop(1);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_Event_HagTransformsInDialog_5fa54251-1a34-4218-aa5b-f0ca9cda9c82)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE");

PROC
PROC_SceneInterrupted((CHARACTER)_Hag,_Character,"LOW_DisguisedHag_Scene","Attacked")
AND
DB_PartyMembers(_Character)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE");

QRY
QRY_LOW_HagTransformed_StartDialogCustom()
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailable(_Player,1,0)
AND
DB_InRegion(_Player,S_LOW_BlushingMermaid_Pub_Trigger_dc4d50f8-5bee-4117-9722-ac02e7ab113f)
AND
QRY_StartDialogCustom((DIALOGRESOURCE)LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,(CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player,0,0,0,1)
THEN
DB_AddCharactersInTriggerToDialog(LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,S_LOW_BlushingMermaid_Pub_Trigger_dc4d50f8-5bee-4117-9722-ac02e7ab113f,1,1,1);

// Custom check to ensure that stealthing players are not forced into the dialogue
QRY
QRY_ShouldNotAddCharacterInTriggerToDialog(_Char,LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,S_LOW_BlushingMermaid_Pub_Trigger_dc4d50f8-5bee-4117-9722-ac02e7ab113f)
AND
DB_HiddenCharacters(_Char,_)
AND
DB_DialogName(LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,_DialogInst)
THEN
DB_HiddenPlayer_TransformedHagDialog(_Char,_DialogInst);

IF
DialogEnded((DIALOGRESOURCE)LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,_)
AND
DB_HiddenPlayer_TransformedHagDialog(_Char,_DialogInst)
THEN
NOT DB_HiddenPlayer_TransformedHagDialog(_Char,_DialogInst);

// Making sure that the char will be added in LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307 in case they drop stealth
IF
DB_HiddenPlayer_TransformedHagDialog(_Player,_DialogInst)
AND
NOT DB_HiddenCharacters(_Player,_)
AND
DB_InRegion(_Player,S_LOW_BlushingMermaid_Pub_Trigger_dc4d50f8-5bee-4117-9722-ac02e7ab113f)
THEN
PROC_DialogAddListeningActor(_DialogInst,_Player);

// Hack to have disguised hag speaking in hag voice
PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_BlushingMermaid_DisguisedHag_1632da0a-d0d7-4905-1c99-75c88102f102, _ID)
THEN
PROC_DialogAddSpeakingActorAt(_ID,S_LOW_BlushingMermaid_QuenoraGrizly_HagVoiceDummy_5790158e-f3bc-47f4-9fc9-38767daeeceb,3);

IF
TemplateUseFinished(_Player,_HagsInformantNote,_,1)
AND
DB_Players(_Player)
AND
DB_LOW_HagInformantsNote_Templates(_HagsInformantNote)
AND
NOT DB_LOW_BlushingMermaid_HagInformantsNoteRead(1)
THEN
DB_LOW_BlushingMermaid_HagInformantsNoteRead(1);
SetFlag((FLAG)LOW_BlushingMermaid_State_PlayersReadHagInformantsNote_23cc4563-f336-4f9e-a83c-35fe8b8f8308);
//END_REGION

//REGION Hag gives gold to players for killing Lora
// As it is the hag, just adding gold out of thin air to players works. Also there is no dialog to acount for the hag's gold stolen
IF
FlagSet((FLAG)LOW_BlushingMermaid_Event_HagGivesGold_41db7122-db70-4520-a4c8-a708671bcab9,_Player,_)
AND
DB_DialogMoneyTransfer(1,(DIALOGRESOURCE)LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,_GoldAmount)
THEN
AddGold(_Player,_GoldAmount);

IF
DB_LOW_GoldRewardForKillingLora((INTEGER)_GoldAmount)
AND
DB_LOW_HagDialogsWithGold(_Dialog)
THEN
DB_DialogMoneyTransfer(1, _Dialog, _GoldAmount);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_DoubledLoraKillBounty_211f67fe-e957-44b9-969e-f25fb312a97b,_,_)
AND
DB_LOW_HagDialogsWithGold(_Dialog)
AND
DB_DialogMoneyTransfer(1, _Dialog, _GoldAmount)
THEN
NOT DB_DialogMoneyTransfer(1, _Dialog, _GoldAmount);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_DoubledLoraKillBounty_211f67fe-e957-44b9-969e-f25fb312a97b,_,_)
AND
DB_LOW_GoldRewardForKillingLora(_GoldAmount)
AND
IntegerProduct(_GoldAmount,2,_DoubledGold)
AND
DB_LOW_HagDialogsWithGold(_Dialog)
THEN
DB_DialogMoneyTransfer(1, _Dialog, _DoubledGold);
//END_REGION

//REGION Hag retreats to Orlop
IF
DialogEnded((DIALOGRESOURCE)LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35)
THEN
PROC_LOW_HagRetreatsToOrlop();

IF
DialogEnded((DIALOGRESOURCE)LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,_DialogInst)
AND
QRY_LOW_DisguisedRedcapsAggro()
AND
DB_DialogPlayers(_DialogInst,_Player,_)
THEN
DB_LOW_DisguisedRedcapsPlayersToAttack(_Player);

IF
DialogEnded((DIALOGRESOURCE)LOW_BlushingMermaid_VomitsOutVanra_Hag_10f3400d-85f0-d324-5057-c0b6bdc6366c,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35)
THEN
PROC_LOW_HagRetreatsToOrlop();

IF
FlagSet((FLAG)LOW_BlushingMermaid_Event_HagVomitsVanraWithoutDialog_43fe7708-b061-44de-84fd-40574c7379aa,_,_)
AND
GetPosition(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_X,_Y,_Z)
THEN
DB_LOW_VanraSpawnPosition(_X,_Y,_Z);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8);
PROC_LOW_HagRetreatsToOrlop();

PROC
PROC_LOW_HagRetreatsToOrlop()
AND
GetHitpoints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HP)
AND
_HP > 0
AND
QRY_OnlyOnce("LOW_BlushingMermaid_HagRetreatsToOrlop")
THEN
PROC_Poof(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f);
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE");
TeleportTo(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,S_LOW_BlushingMermaid_HagCellarTeleportSpot_78b85f90-81ba-4509-a7d5-b30b836f212c,"LOW_HagTeleportedToCellar",1,1,1,1,1);

// Edge case for when hag was killed before escaping in the cellar
PROC
PROC_LOW_HagRetreatsToOrlop()
AND
GetHitpoints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HP)
AND
_HP <= 0
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33)
AND
DB_GLO_DefeatCounter(_HagShroom,"LOW_HagResurrectionShrooms_PermaDefeated")
AND
NOT DB_Defeated(_HagShroom)
AND
NOT DB_HagShroomResurrectedHagKilledBeforeRetreat(_)
AND
QRY_OnlyOnce("LOW_BlushingMermaid_HagRetreatsToOrlop")
THEN
DB_HagShroomResurrectedHagKilledBeforeRetreat(_HagShroom);

IF
StatusApplied(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_RESURRECTING",_,_)
AND
DB_HagShroomResurrectedHagKilledBeforeRetreat(_HagShroom)
THEN
UseSpell(_HagShroom,"Target_LOW_HagShroom_Resurrect",S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

PROC
PROC_LOW_DisguisedRecaps_HostileAfterHagRetreat()
AND
QRY_LOW_DisguisedRedcapsAggro()
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,0);

PROC
PROC_LOW_DisguisedRecaps_HostileAfterHagRetreat()
AND
NOT QRY_LOW_DisguisedRedcapsAggro()
AND
DB_LOW_DisguisedRedcaps(_Redcap,_)
THEN
DB_SceneManager(_Redcap,"LOW_DisguisedRedcapsPostHagReveal_Scene");

PROC
PROC_SceneInterrupted((CHARACTER)_DisguisedRedcap,_Character,"LOW_DisguisedRedcapsPostHagReveal_Scene","Attacked")
AND
DB_PartyMembers(_Character)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,0);

QRY
QRY_LOW_DisguisedRedcapsAggro()
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_PromisedNotToBotherHag_475ec6fe-6c79-394a-eb93-7b83ec3926e9)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5)
THEN
DB_NOOP(1);

// TODO: Implement hag followers neutrality to players in case they make a deal with her
//END_REGION

//REGION Hag Cellar retreat PAD
IF
DB_Is_InCombat(_Player,_CombatID)
AND
DB_LOW_DisguisedRedcapsPlayersToAttack(_Player)
AND
DB_Is_InCombat(_Redcap,_CombatID)
AND
DB_LOW_DisguisedRedcaps((CHARACTER)_Redcap,_)
AND
QRY_OnlyOnce("LOW_StoreHagRetreatCombatID_OnlyOnce")
THEN
DB_LOW_HagRetreatCombatID(_CombatID);

IF
SwitchedCombat(_,_OldID,_NewID)
AND
DB_LOW_HagRetreatCombatID(_OldID)
THEN
NOT DB_LOW_HagRetreatCombatID(_OldID);
DB_LOW_HagRetreatCombatID(_NewID);

IF
CombatEnded(_CombatID)
AND
DB_LOW_HagRetreatCombatID(_CombatID)
THEN
NOT DB_LOW_HagRetreatCombatID(_CombatID);
PROC_LOW_HagCellarRetreatPAD();

PROC
PROC_LOW_HagCellarRetreatPAD()
AND
DB_LOW_DisguisedRedcapsPlayersToAttack(_Player)
AND
NOT DB_LOW_HagCellarRetreatPAD_Started(1)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_BlushingMermaid_PAD_PostHagCellarRetreat_f647274d-4de4-9d78-0e19-df524997d4da,_Player)
THEN
DB_LOW_HagCellarRetreatPAD_Started(1);

PROC
PROC_LOW_HagCellarRetreatPAD()
AND
DB_LOW_DisguisedRedcapsPlayersToAttack(_Player)
THEN
NOT DB_LOW_DisguisedRedcapsPlayersToAttack(_Player);

PROC
PROC_LOW_HagCellarRetreatPAD()
AND
DB_LOW_HagCellarRetreatPAD_Started(1)
THEN
NOT DB_LOW_HagCellarRetreatPAD_Started(1);
//END_REGION

//REGION Hag cellar setup
IF
EntityEvent(_Hag,"LOW_HagTeleportedToCellar")
THEN
PROC_Foop(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369);
SetIsBoss(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1);
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_MAGICRESISTANCE",-1.0);
PROC_RemoveAllDialogEntriesForSpeaker(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_LOW_DisguisedRecaps_HostileAfterHagRetreat();

IF
EntityEvent(_Hag,"LOW_HagTeleportedToCellar")
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5)
THEN
SetFlag((FLAG)LOW_BlushingMermaid_State_HagMasksControlWearers_17fe9c38-dcb6-45f4-912d-bb0d11553d91);
ApplyStatus(_Hag,"INVISIBLE",-1.0);
RemoveHarmfulStatuses(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetHitpointsPercentage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,100.0);
DB_SceneManager(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_PreHagCellarCombat_Scene");
DB_SpotPlayers(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HagCellarDialog_Spotting",(FLAG)LOW_BlushingMermaid_Event_Hag_StartSpotting_893b414f-6e8d-4831-b6ff-253472cf7ef5,NULL_00000000-0000-0000-0000-000000000000);
// The hag will attack players only if spots them inside the trigger
PROC_LOW_SetupHagCellarCombatSpotting();
DB_SpotPlayers_SpotTrigger(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarCombat_Spotting", S_LOW_BlushingMermaid_HagCellarCombatTrigger_28528ff2-3b0d-4142-8a03-be90610e17a6);

IF
EntityEvent(_Hag,"LOW_HagTeleportedToCellar")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35)
THEN
SetFlag((FLAG)LOW_BlushingMermaid_State_HagMasksControlWearers_17fe9c38-dcb6-45f4-912d-bb0d11553d91);
// The hag will attack players on sight
PROC_LOW_SetupHagCellarCombatSpotting();

PROC
PROC_LOW_SetupHagCellarCombatSpotting()
THEN
DB_SpotPlayers_Continuous(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarCombat_Spotting");
DB_SpotPlayers_IncludeWildshapedPlayers(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarCombat_Spotting");
DB_SpotPlayers_IncludeFollowers(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarCombat_Spotting");
DB_SpotPlayers_IncludeSummons(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarCombat_Spotting");
DB_SpotPlayers_IgnoreCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarCombat_Spotting");
DB_SpotPlayers_SpotterIgnoreCantTalk(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarCombat_Spotting");
DB_SpotPlayers(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarCombat_Spotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
EntityEvent(_Hag,"LOW_HagTeleportedToCellar")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5)
THEN
DB_Dialogs(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(DIALOGRESOURCE)LOW_BlushingMermaid_Hag_AfterDeal_7bcded43-4347-a00a-f2e7-63ca14eefc9f);
DB_SceneManager(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_PreHagCellarCombat_Scene");

// Edge case handling for when players trigger hag cellar retreat by destroying one of her mushrooms
IF
EntityEvent(_Hag,"LOW_HagTeleportedToCellar")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagShroomDefeated_4ae0b765-b770-45fa-8a3d-5486411ee245)
AND
DB_Players((CHARACTER)_Player)
AND
DB_InRegion(_Player,(TRIGGER)S_LOW_BlushingMermaid_CellarTrigger_2c889517-8252-49f0-a55c-ead662b8cb3f)
AND
QRY_StartDialogCustom((DIALOGRESOURCE)LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player,0,0,0,1)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "INVISIBLE");
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,(TRIGGER)S_LOW_BlushingMermaid_CellarTrigger_2c889517-8252-49f0-a55c-ead662b8cb3f,1,1,1,1);

IF
DialogEnded((DIALOGRESOURCE)LOW_BlushingMermaid_TransformedHag_e68f85b7-6266-426e-3aca-c8460b75b307,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagShroomDefeated_4ae0b765-b770-45fa-8a3d-5486411ee245)
THEN
PROC_LOW_HagCellarBossFightStarted();

PROC
PROC_SpotPlayers_Spotted(_Hag,"LOW_HagCellarDialog_Spotting",_Player)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_BlushingMermaid_PreCellarCombat_Hag_3bd2c6d8-5638-4518-5c23-b057f70c0ede,_Hag,_Player)
THEN
SetFlag(LOW_BlushingMermaid_Event_Hag_StartSpotting_893b414f-6e8d-4831-b6ff-253472cf7ef5);

IF
DialogStarted((DIALOGRESOURCE)LOW_BlushingMermaid_PreCellarCombat_Hag_3bd2c6d8-5638-4518-5c23-b057f70c0ede,_)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"INVISIBLE");

IF
DialogEnded((DIALOGRESOURCE)LOW_BlushingMermaid_PreCellarCombat_Hag_3bd2c6d8-5638-4518-5c23-b057f70c0ede,_Id)
THEN
PROC_LOW_HagCellarBossFightStarted();

PROC
PROC_SpotPlayers_Spotted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarCombat_Spotting", _Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagShroomDefeated_4ae0b765-b770-45fa-8a3d-5486411ee245)
THEN
PROC_ForceStopDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_LOW_HagCellarBossFightStarted();

PROC
PROC_SpotPlayers_Spotted(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HagCellarDialog_Spotting", _Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagShroomDefeated_4ae0b765-b770-45fa-8a3d-5486411ee245)
AND
DB_InRegion(_Player, S_LOW_BlushingMermaid_HagCellarCombatTrigger_28528ff2-3b0d-4142-8a03-be90610e17a6)
THEN
PROC_LOW_HagCellarBossFightStarted();

PROC
PROC_SceneInterrupted((CHARACTER)_Hag,_Character,"LOW_PreHagCellarCombat_Scene","Attacked")
AND
DB_PartyMembers(_Character)
THEN
PROC_LOW_HagCellarBossFightStarted();

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_State_PlayerBrokeDealWithHag_1e69b66d-9f46-4df5-aeb4-56382f8b1001)
THEN
PROC_LOW_HagCellarBossFightStarted();

PROC
PROC_LOW_HagCellarBossFightStarted()
AND
QRY_OnlyOnce("LOW_HagCellarBossFightStarted_OnlyOnce")
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "INVISIBLE");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61);
PROC_GlobalClearFlagAndCache((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5);
PROC_SetRelationToPlayers((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, 0);
PROC_SpotPlayers_StopSpotting("LOW_HagCellarDialog_Spotting");
PROC_SpotPlayers_StopSpotting("LOW_HagCellarCombat_Spotting");
PROC_SceneOver("LOW_PreHagCellarCombat_Scene");

IF
AttackedBy(_HagShroom,_,_PartyMember,_,_,_,_)
AND
DB_GLO_DefeatCounter(_HagShroom,"LOW_HagResurrectionShrooms_PermaDefeated")
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61)
THEN
PROC_LOW_HagCellarBossFightStarted();

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61,_,_)
AND
DB_GLO_DefeatCounter(_HagShroom,"LOW_HagResurrectionShrooms_PermaDefeated")
AND
NOT DB_Defeated(_HagShroom)
THEN
SetCombatGroupID(_HagShroom,"LOW_HagBossFight");
//END_REGION

//REGION Hag Boss Fight started PAD
IF
DB_Is_InCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_CombatID)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player,_CombatID)
AND
QRY_OnlyOnce("LOW_TrackHagBossFightCombat_OnlyOnce")
THEN
DB_LOW_HagBossFightCombat(_CombatID);

IF
SwitchedCombat(_,_OldID,_NewID)
AND
DB_LOW_HagBossFightCombat(_OldID)
THEN
NOT DB_LOW_HagBossFightCombat(_OldID);
DB_LOW_HagBossFightCombat(_NewID);

IF
CombatEnded(_CombatID)
AND
DB_LOW_HagBossFightCombat(_CombatID)
THEN
NOT DB_LOW_HagBossFightCombat(_CombatID);

IF
TurnStarted(_Player)
AND
DB_Players((CHARACTER)_Player)
AND
DB_LOW_HagBossFightCombat(_CombatID)
AND
NOT DB_LOW_StartedHagCombatPAD(1)
AND
DB_Is_InCombat(_Player,_CombatID)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_BlushingMermaid_PAD_HagCombatStart_1641b1de-e377-f3ba-beb5-f0a7bfa05d5b,_Player)
THEN
DB_LOW_StartedHagCombatPAD(1);
//END_REGION

//REGION Final hag combat
// On Hag perma-hostility to players, her minions do the same
IF
RelationChanged(GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, 1)
THEN
PROC_SetRelationToPlayers((FACTION)GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0,0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,0);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33,_,_)
THEN
NOT DB_PreventPermaDefeated(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
Dying((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BlushingMermaid_AD_Hag_TrulyDying_ed8b5f42-d6b5-fd49-9e16-de6cc1773fa3,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
TemplateAddTo((ITEMROOT)MAG_OfFeywildSparks_Ring_a4813d7b-2ff0-488b-8152-a27cb75e8d8e,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1);

IF
Dying((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33)
THEN
NOT DB_LOW_LevelTeleportHagResurrecting(1);
// Currently the dead hag can be looted and picked up still
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_RESURRECTING",-1.0);

IF
DB_KnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33)
THEN
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_AWAKENING",-1.0);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33,_,_)
AND
DB_LOW_ShroomSupportSpells(_HagCondition,_)
AND
HasActiveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HagCondition,1)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HagCondition,NULL_00000000-0000-0000-0000-000000000000);

// Handling setting truly dead hag flag in case it's already dead when all shrooms are defeated
IF
StatusRemoved(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_RESURRECTING",_,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33)
AND
GetHitpoints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HP)
AND
_HP <= 0
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c);
TemplateAddTo((ITEMROOT)MAG_OfFeywildSparks_Ring_a4813d7b-2ff0-488b-8152-a27cb75e8d8e,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1);

IF
TurnStarted(_HagShroom)
AND
DB_GLO_DefeatCounter(_HagShroom,"LOW_HagResurrectionShrooms_PermaDefeated")
AND
DB_LOW_ShroomSupportSpells(_HagCondition,_ShroomSupportSpell)
AND
HasActiveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HagCondition,1)
THEN
// _HagCondtion removal is set in the spell
UseSpell(_HagShroom,_ShroomSupportSpell,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
CastedSpell(_,"Target_LOW_HagShroom_Resurrect",_,_,_)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_RESURRECTING");
PROC_Poof(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f);
TeleportTo(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(ITEM)S_LOW_BlushingMermaid_HagResurrectionCircle_3f00a318-4728-443f-a987-d1dfcad588e6,"LOW_HagResurrectionTeleport");

IF
CastedSpell(_,"Target_LOW_HagShroom_Awaken",_,_,_)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_AWAKENING");
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"KNOCKED_OUT");
PROC_LOW_HagShroomsHeal();

IF
EntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HagResurrectionTeleport")
THEN
Resurrect(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
Resurrected(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_LOW_LevelTeleportHagResurrecting(1)
AND
NOT DB_LOW_HagShroomsDefeated(_)
THEN
PROC_LOW_HagResurrectedFoop();

IF
Resurrected(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_LOW_LevelTeleportHagResurrecting(1)
THEN
PROC_LOW_HagShroomsHeal();
PROC_LOW_HagResurrectedFoop();

IF
Resurrected(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_HagShroomResurrectedHagKilledBeforeRetreat(_HagShroom)
THEN
NOT DB_HagShroomResurrectedHagKilledBeforeRetreat(_HagShroom);
SetEntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HagTeleportedToCellar");

PROC
PROC_LOW_HagShroomsHeal()
AND
SysCount("DB_LOW_HagShroomsDefeated",1,_Count)
AND
DB_LOW_DefeatedShroomsToResurrectionHP(_Count,_RegenPercentage)
THEN
SetHitpointsPercentage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_RegenPercentage);

PROC
PROC_LOW_HagResurrectedFoop()
THEN
PROC_Foop(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f);
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_MAGICRESISTANCE",-1.0);
SetTag(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,(TAG)IGNORE_COMBAT_LATE_JOIN_PENALTY_6d60bed7-10cc-4b52-8fb7-baa75181cd49);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BlushingMermaid_AD_Hag_Resurrection_f096d95c-cbea-0eec-68e8-7596378a3d99,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
THEN
ClearFlag((FLAG)LOW_BlushingMermaid_State_HagMasksControlWearers_17fe9c38-dcb6-45f4-912d-bb0d11553d91);
ClearFlag((FLAG)LOW_BlushingMermaid_State_HagInBaldursGate_68d1731c-7a20-4692-a093-5aa39b69d211);
PROC_LOW_MaskedVictimsNeutral();

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Event_VanraWentToMom_895cda4f-6348-45c0-ba2e-bac1a7a1a0b2)
THEN
PROC_LOW_VanraSavedDialog();

// When the hag truly dies, disguised redcaps die as well just like hag spy among the hag survivors
IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
AND
DB_LOW_DisguisedRedcaps(_Redcap,_)
AND
NOT DB_Dead(_Redcap)
THEN
Die(_Redcap,DEATHTYPE.Necrotic,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1,0,0.0);
SetFlag((FLAG)LOW_BlushingMermaid_State_DisguisedRedcapsDroppedDisguise_da4c2802-faa5-4e60-a591-f52c2622e6f9);

// Handling hag immortality needed for vomit dialog in case she's chasmed
IF
EnteredChasm(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_,_,_,_,_)
AND
IsImmortal(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1)
THEN
SetImmortal((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,0);
//END_REGION

//REGION Edge case handling for when the hag is either knocked out or dead and combat with it ends
IF
EnteredCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_CombatID)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33)
THEN
DB_LOW_HagCombatWithShrooms(_CombatID);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33,_,_)
AND
DB_LOW_HagCombatWithShrooms(_CombatID)
THEN
NOT DB_LOW_HagCombatWithShrooms(_CombatID);

IF
SwitchedCombat(_,_OldCombatID,_NewCombatID)
AND
DB_LOW_HagCombatWithShrooms(_OldCombatID)
THEN
NOT DB_LOW_HagCombatWithShrooms(_OldCombatID);
DB_LOW_HagCombatWithShrooms(_NewCombatID);

IF
CombatEnded(_CombatID)
AND
DB_LOW_HagCombatWithShrooms(_CombatID)
AND
DB_LOW_ShroomSupportSpells(_HagCondition,_ShroomSupportSpell)
AND
HasActiveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HagCondition,1)
AND
DB_GLO_DefeatCounter(_HagShroom,"LOW_HagResurrectionShrooms_PermaDefeated")
AND
NOT DB_Defeated(_HagShroom)
AND
NOT DB_LOW_ShroomCastsSupportSpellOnCombatEnd(1)
THEN
DB_LOW_ShroomCastsSupportSpellOnCombatEnd(1);
UseSpell(_HagShroom,_ShroomSupportSpell,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
CastedSpell(_,_ShroomSupportSpell,_,_,_)
AND
DB_LOW_ShroomSupportSpells(_,_ShroomSupportSpell)
AND
DB_LOW_ShroomCastsSupportSpellOnCombatEnd(1)
THEN
NOT DB_LOW_ShroomCastsSupportSpellOnCombatEnd(1);
//END_REGION

//REGION Hag Regen Shrooms
PROC
PROC_LOW_SetShroomDifficulty()
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521,"HARD",1)
AND
DB_GLO_DefeatCounter(_Shroom,"LOW_HagResurrectionShrooms_PermaDefeated")
THEN
ApplyStatus(_Shroom, "HAG_MUSHROOM_HARDCORE", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_Hardcore_Enable("CTY_Main_A")
AND
DB_GLO_DefeatCounter(_Shroom,"LOW_HagResurrectionShrooms_PermaDefeated")
AND
HasActiveStatus(_Shroom, "HAG_MUSHROOM_HARDCORE", 0)
THEN
ApplyStatus(_Shroom, "HAG_MUSHROOM_HARDCORE", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_Hardcore_Disable("CTY_Main_A")
AND
DB_GLO_DefeatCounter(_Shroom,"LOW_HagResurrectionShrooms_PermaDefeated")
AND
HasActiveStatus(_Shroom, "HAG_MUSHROOM_HARDCORE", 1)
THEN
RemoveStatus(_Shroom, "HAG_MUSHROOM_HARDCORE",  NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GLO_DefeatCounter(_Shroom,"LOW_HagResurrectionShrooms_PermaDefeated")
AND
DB_Defeated(_Shroom)
THEN
DB_LOW_HagShroomsDefeated(_Shroom);

// With each shroom defeated the hag combat stage will progress
IF
DB_LOW_HagShroomsDefeated(_Shroom)
AND
SysCount("DB_LOW_HagShroomsDefeated",1,_Count)
AND
DB_LOW_DefeatedShroomsToCombatPhase(_Count,_CombatPhaseFlag)
THEN
DB_LOW_CurrentHagFightState(_CombatPhaseFlag);
SetFlag(_CombatPhaseFlag);
PROC_LOW_HagBossFightStateProgressed();

IF
DB_LOW_CurrentHagFightState(_NewPhase)
AND
DB_LOW_CurrentHagFightState(_OldPhase)
AND
_NewPhase != _OldPhase
THEN
NOT DB_LOW_CurrentHagFightState(_OldPhase);

IF
DB_LOW_HagShroomsDefeated(_Shroom)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BlushingMermaid_AD_Hag_MushroomKilled_db5097fd-3b3a-87e1-e8de-9df1f55246f2,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
DB_LOW_HagShroomsDefeated(_Shroom)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagShroomDefeated_4ae0b765-b770-45fa-8a3d-5486411ee245)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_HagShroomDefeated_4ae0b765-b770-45fa-8a3d-5486411ee245);
//END_REGION

//REGION Edge case handling for when players defeat one of the shrooms before the hag retreats to basement
IF
DB_LOW_HagShroomsDefeated(_Shroom)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369)
AND
QRY_OnlyOnce("LOW_HagRetreatsDueToShroomDefeated_OnlyOnce")
THEN
PROC_LOW_ShroomDestroyedBeforeHagRetreat();

PROC
PROC_LOW_ShroomDestroyedBeforeHagRetreat()
AND
NOT DB_DialogNPCs(_,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
THEN
PROC_LOW_HagRetreatsToOrlop();

PROC
PROC_LOW_ShroomDestroyedBeforeHagRetreat()
AND
DB_DialogNPCs(_DialogInst,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
AND
DB_DialogName(_Dialog,_DialogInst)
AND
NOT DB_LOW_HagDialogsPreventingReteatWhenShroomDefeated(_Dialog)
THEN
DB_LOW_HagDialogInterruptedByShroomDefeated(_DialogInst);
PROC_ForceStopDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

IF
DialogActorLeft(_,_DialogInst,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
AND
DB_LOW_HagDialogInterruptedByShroomDefeated(_DialogInst)
THEN
NOT DB_LOW_HagDialogInterruptedByShroomDefeated(_DialogInst);
PROC_LOW_HagRetreatsToOrlop();
//END_REGION

//REGION Throwing Quest grenade makes the hag vomit the child if it's still in her belly
IF
OnThrown(_ThrownObject,(ROOT)LOW_RegenerationPrevention_Grenade_df5f8cbf-42c5-4c0d-a0ec-ce5046474d8e,_,_ThrowId,_,_,_)
THEN
DB_LOW_HagQuestGrenade_ThrowId(_ThrowID);

IF
MissedBy(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_,_Thrower,_ThrowId)
AND
DB_LOW_HagQuestGrenade_ThrowId(_ThrowID)
THEN
PROC_LOW_QuestGrenadeThrownAtHag(_ThrowID,_Thrower);

IF
AttackedBy(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_,_Thrower,_,_,_,_ThrowId)
AND
DB_LOW_HagQuestGrenade_ThrowId(_ThrowID)
THEN
PROC_LOW_QuestGrenadeThrownAtHag(_ThrowID,_Thrower);

PROC
PROC_LOW_QuestGrenadeThrownAtHag((INTEGER)_ThrowID,(GUIDSTRING)_Thrower)
THEN
NOT DB_LOW_HagQuestGrenade_ThrowId(_ThrowID);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35);
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"STINKING_CLOUD",18.0,1,_Thrower);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_CantCarveOutVanra_860c8e13-f2e6-4939-ace9-56cac5ae3626,_,_)
AND
DB_LOW_HagQuestGrenade_ThrowId(_ThrowID)
THEN
NOT DB_LOW_HagQuestGrenade_ThrowId(_ThrowID);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRevealed_aa751f69-f448-1436-c243-eb9f06a060ca)
THEN
DB_LOW_GreandeThrownAtDisguisedHag(1);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35,_,_)
AND
NOT DB_DialogNPCs(_,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
THEN
PROC_LOW_HagVomitsKid_GrenadeThrown();

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35,_,_)
AND
DB_DialogNPCs(_DialogInst,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
THEN
PROC_ForceStopDialog(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_DialogInstInterruptedByVomiting(_DialogInst);

IF
DialogActorLeft(_,_DialogInst,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
AND
DB_DialogInstInterruptedByVomiting(_DialogInst)
THEN
NOT DB_DialogInstInterruptedByVomiting(_DialogInst);
PROC_LOW_HagVomitsKid_GrenadeThrown();
//END_REGION

//REGION Hag vomits out Vanra
PROC
PROC_LOW_HagVomitsKid_GrenadeThrown()
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_VanraIsDead_085595a2-d5d8-4379-ba50-5d92dbbbaa17)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8)
AND
NOT DB_LOW_GreandeThrownAtDisguisedHag(1)
AND
NOT QRY_LOW_StartDialogCustom_HagVomitsVanra_AddCharactersInTrigger((DIALOGRESOURCE)LOW_BlushingMermaid_VomitsOutVanra_Hag_10f3400d-85f0-d324-5057-c0b6bdc6366c)
THEN
SetFlag((FLAG)LOW_BlushingMermaid_Event_HagVomitsVanraWithoutDialog_43fe7708-b061-44de-84fd-40574c7379aa);

IF
StatusRemoved(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE",_,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35)
AND
NOT QRY_LOW_StartDialogCustom_HagVomitsVanra_AddCharactersInTrigger((DIALOGRESOURCE)LOW_BlushingMermaid_VomitsOutVanra_Hag_10f3400d-85f0-d324-5057-c0b6bdc6366c)
THEN
SetFlag((FLAG)LOW_BlushingMermaid_Event_HagVomitsVanraWithoutDialog_43fe7708-b061-44de-84fd-40574c7379aa);

QRY
QRY_LOW_StartDialogCustom_HagVomitsVanra_AddCharactersInTrigger((DIALOGRESOURCE)_Dialog)
AND
DB_InRegion(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HagTrigger)
AND
DB_LOW_HagVomitTriggers(_HagTrigger)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player,_HagTrigger)
AND
QRY_StartDialogCustom(_Dialog,(CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player,0,0,0,0)
THEN
DB_AddCharactersInTriggerToDialog(_Dialog,_HagTrigger,1,1,1,1);
//END_REGION

//REGION Hag is killed while Vanra is inside
IF
HitpointsChanged((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
AND
GetHitpoints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HP)
AND
_HP <= 0
AND
QRY_OnlyOnce("LOW_HagVomitsOutDeadVanra")
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8)
AND
NOT QRY_LOW_StartDialogCustom_HagVomitsVanra_AddCharactersInTrigger((DIALOGRESOURCE)LOW_BlushingMermaid_HagVomitsOutDeadVanra_e3067621-8c76-c65e-8026-5dfaecc9d1de)
THEN
PROC_LOW_HagKilled_SpawnDeadVanra();

IF
DialogEnded((DIALOGRESOURCE)LOW_BlushingMermaid_HagVomitsOutDeadVanra_e3067621-8c76-c65e-8026-5dfaecc9d1de,_)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_HagVomitedOutDeadVanra_0e5faddc-1d86-400e-876a-6d7407a5ec27);
PROC_LOW_HagKilled_SpawnDeadVanra();

PROC
PROC_LOW_HagKilled_SpawnDeadVanra()
AND
GetPosition(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_X,_Y,_Z)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_PREGNANT");
RemoveTransforms(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetImmortal(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,0);
Die(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,DEATHTYPE.Physical,1);
Die(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,DEATHTYPE.Physical,1);
DB_LOW_HagVomitedDeadVanra(_X,_Y,_Z);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_CantCarveOutVanra_860c8e13-f2e6-4939-ace9-56cac5ae3626);

IF
Died(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c)
AND
DB_LOW_HagVomitedDeadVanra(_X,_Y,_Z)
THEN
TeleportToPosition(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,_X,_Y,_Z,"LOW_VanraDeadTeleport",0);

IF
EntityEvent(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,"LOW_VanraDeadTeleport")
THEN
PROC_Foop(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,(EFFECTRESOURCE)VFX_Script_LOW_HAG_BlushingMermaid_Vomit_01_44647e59-07b5-9678-6989-a08aa59c4ba2);
CreatePuddle(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c, "SurfaceBlood", 10, 15, 10,20, 1.0);

PROC
PROC_LOW_HagKilled_SpawnDeadVanra()
AND
DB_LOW_HagKilledWhileDisguised(1)
THEN
NOT DB_LOW_HagKilledWhileDisguised(1);
PROC_LOW_HagRetreatsToOrlop();
//END_REGION

//REGION Hag Knockedout
IF
DB_KnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_DontRemoveDialogsOnKnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRevealed_aa751f69-f448-1436-c243-eb9f06a060ca)
THEN
QuestUpdate("LOW_AvengeHagSurvivors","HagKnockedOut");
DB_Dialogs(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, (DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3);

PROC
PROC_KnockedOut_Ended((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRevealed_aa751f69-f448-1436-c243-eb9f06a060ca)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

// For streamlining cutting out Vanra we try to start the dialog immediately for players who knocked the hag out
IF
StatusApplied(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"KNOCKED_OUT",_Player,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_CantCarveOutVanra_860c8e13-f2e6-4939-ace9-56cac5ae3626)
AND
DB_Players((CHARACTER)_Player)
AND
DB_InRegion((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HagTrigger)
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_Player,0,0,0,0)
THEN
// Players can start the dialog with the knocked out hag out of combat as a failsafe
DB_LOW_SavingVanraDialogStartedOnKnockOut(1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3,_HagTrigger,1,1,1,1);

IF
StatusApplied(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"KNOCKED_OUT",_,_)
AND
NOT DB_LOW_SavingVanraDialogStartedOnKnockOut(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_CantCarveOutVanra_860c8e13-f2e6-4939-ace9-56cac5ae3626)
AND
DB_Players(_Player)
AND
DB_Sees(_Player,(CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_LOW_KnockedOutHag_CarveOutVanraPAD(1)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_BlushingMermaid_PAD_CutOutKid_bbaea0da-cb52-ddd8-d2cd-d7e0f36f1575,_Player)
THEN
DB_LOW_KnockedOutHag_CarveOutVanraPAD(1);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_State_HagCutOpen_d1772eba-c22b-4235-a492-eb39e0926237)
THEN
Die((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,DEATHTYPE.Physical,1);
//END_REGION

//REGION Vanra is saved
// In case players somehow manage to interrupt a dialog in which Vanra is saved
IF
DialogEnded((DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagCutOpen_d1772eba-c22b-4235-a492-eb39e0926237)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8);

IF
DialogEnded((DIALOGRESOURCE)LOW_BlushingMermaid_VomitsOutVanra_Hag_10f3400d-85f0-d324-5057-c0b6bdc6366c,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8);

// Either in LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3 or LOW_BlushingMermaid_VomitsOutVanra_Hag_10f3400d-85f0-d324-5057-c0b6bdc6366c
// or if these dialogs couldn't start
IF
FlagSet((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8,_,_)
AND
NOT DB_LOW_VanraSpawnPosition(_,_,_)
AND
GetPosition(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_X,_Y,_Z)
THEN
DB_LOW_VanraSpawnPosition(_X,_Y,_Z);

IF
DB_LOW_VanraSpawnPosition(_X,_Y,_Z)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8)
THEN
NOT DB_LOW_VanraSpawnPosition(_X,_Y,_Z);
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_PREGNANT");
RemoveTransforms(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetImmortal(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,0);
TeleportToPosition(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,_X,_Y,_Z,"LOW_VanraSavedTeleport",0);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_CantCarveOutVanra_860c8e13-f2e6-4939-ace9-56cac5ae3626);

IF
EntityEvent(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,"LOW_VanraSavedTeleport")
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_VanraOutOfHag_80a69cad-828a-4d92-9bc3-9acf206f9739);
PROC_RemoveAllDialogEntriesForSpeaker(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c);
DB_Children(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c);
DB_Dialogs(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,(DIALOGRESOURCE)LOW_BlushingMermaid_VanraSaved_63754baa-d2dd-93fe-697c-dc9106b22291);
PROC_Foop(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,(EFFECTRESOURCE)VFX_Script_LOW_HAG_BlushingMermaid_Vomit_01_44647e59-07b5-9678-6989-a08aa59c4ba2);

IF
WentOnStage(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,1)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Event_VanraWentToMom_895cda4f-6348-45c0-ba2e-bac1a7a1a0b2)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_VanraOutOfHag_80a69cad-828a-4d92-9bc3-9acf206f9739)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369)
AND
NOT QRY_LOW_VanraSavedInDialog()
THEN
PROC_LOW_VanraRunsAwayAfterVomitInCellar();

QRY
QRY_LOW_VanraSavedInDialog()
AND
DB_DialogNPCs(_DialogInst,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
AND
DB_DialogName(_Dialog,_DialogInst)
AND
DB_LOW_VanraSavedDialogs(_Dialog)
THEN
DB_QRYRTN_LOW_VanraSavedInDialog(_DialogInst);

IF
DialogEnded(_,_DialogInst)
AND
DB_QRYRTN_LOW_VanraSavedInDialog(_DialogInst)
THEN
NOT DB_QRYRTN_LOW_VanraSavedInDialog(_DialogInst);
PROC_LOW_VanraRunsAwayAfterVomitInCellar();

PROC
PROC_LOW_VanraRunsAwayAfterVomitInCellar()
AND
QRY_OnlyOnce("LOW_VanraRunsAwayAfterVomitInCellar_OnlyOnce")
THEN
PROC_TryStartAD(LOW_BlushingMermaid_AD_VanraSaved_79153be5-ce8d-00b7-791e-cb76eee21741,S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c);
PROC_CharacterMoveTo((CHARACTER)S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,S_LOW_BlushingMermaid_VanraSavedSpot_5a68ace7-69e6-4eba-8b6e-cb4497734384,"Run","");

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_Event_VanraWentToMom_895cda4f-6348-45c0-ba2e-bac1a7a1a0b2)
THEN
PROC_DisappearOutOfSight((CHARACTER)S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,"Run",0,"LOW_BlushingMermaid_VanraRunsAway");

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_CantCarveOutVanra_860c8e13-f2e6-4939-ace9-56cac5ae3626,_,_)
THEN
NOT DB_DontRemoveDialogsOnKnockedOut((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
NOT DB_PreventKnockedOutPermaDefeated((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);

PROC
PROC_LOW_VanraSavedDialog()
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8)
AND
NOT DB_Defeated(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c)
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailable(_Player,1,0)
AND
DB_InRegion(_Player,S_LOW_BlushingMermaid_VanraDialogTrigger_56469603-08e9-45cd-8412-da70896834e3)
AND
NOT QRY_StartDialogCustom((DIALOGRESOURCE)LOW_BlushingMermaid_VanraSaved_63754baa-d2dd-93fe-697c-dc9106b22291,(CHARACTER)S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,_Player,0,0,0,0)
THEN
DB_NOOP(1);

//END_REGION

//REGION Quenora
IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
AND
NOT DB_PermaDefeated(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232)
THEN
SetCombatGroupID(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232, "");
SetFaction(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(FACTION)ACT3_LOW_BlushingMermaid_Civilians_c0d4b9de-5884-41c1-aab8-1fbce6991129);
// TODO: Shouldn't take off in case of can't act. Also no low attitude intercept for other masks would make sense
DB_NoLowAttitudeDialog(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
Unequip((CHARACTER)S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(ITEM)S_LOW_BlushingMermaid_QuenorasHagMask_6eb1036e-017e-4cc2-8f65-1cc0cda601ad);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_QuenoraIsSaved_2d5e3ae7-12b3-4dae-94c6-ec9acfceb61e);
PROC_RemoveAllDialogEntriesForSpeaker(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
DB_Dialogs(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(DIALOGRESOURCE)LOW_BlushingMermaid_Saved_QuenoraGrizly_ca2b1e05-b311-41ff-74f5-64a115742816);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
AND
NOT DB_PermaDefeated(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232)
AND
DB_Players(_Player)
THEN
AddAttitudeTowardsPlayer((CHARACTER)S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,_Player,50);

PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_QuenoraIsSaved_2d5e3ae7-12b3-4dae-94c6-ec9acfceb61e)
AND
NOT DB_PermaDefeated(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232)
AND
QRY_OnlyOnce("LOW_SavedQuenoraReturnsInPub_OnlyOnce")
THEN
DB_LOW_PostHagQuenoraGrizly_GoesUpstairsOnLongRest(1);

IF
DB_LOW_PostHagQuenoraGrizly_GoesUpstairsOnLongRest(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_PostHagQuenoraGrizly_GoesUpstairsOnLongRest(1);
TeleportTo(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(TRIGGER)S_LOW_BlushingMermaid_QuenoraTeleportSpot_2244ed9b-e942-49f2-85aa-465f6defaef2);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_State_SavedQuenoraBackInPub_ac5b3faf-1d38-4521-a1db-c81c70aead36);
PROC_RemoveAllDialogEntriesForSpeaker(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232);
DB_Dialogs(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(DIALOGRESOURCE)LOW_BlushingMermaid_QuenoraGrizly_4f9eea9b-d3e9-6eaf-5d26-8fef98f93105);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_BosunGannetThanked_c3a3ab9e-d39c-26ff-10e7-be24a2bee92e,_,_)
AND
DB_Players(_Player)
THEN
AddAttitudeTowardsPlayer((CHARACTER)S_LOW_BlushingMermaid_BosunGannet_d6f07cae-779b-4f10-b87c-c8117bfa1fe9,_Player,50);
//END_REGION

//REGION Cellar Secret Room
IF
DB_LOW_BlushingMermaidBasementEntranceIllusuion(S_LOW_BlushingMermaid_BasementEntraceIllusion_543ad91c-25c7-4036-b117-8822e89f54f2)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
DB_KnowledgeCheckTrigger("LOW_BlushingMermaid_BasementEntranceIllusion_Investigation",(TRIGGER)S_LOW_BlushingMermaid_BasementEntraceIllusion_Trigger_3856c014-2ab7-4d1e-99d3-f25237bff950,"Investigation",(DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57);
PROC_SetOnStage(S_LOW_BlushingMermaid_BasementEntrace_NoHagWall_1e20d3ee-e3e6-46fb-af14-e6a8a4e66373,0);
PROC_SetOnStage(S_LOW_BlushingMermaid_BasementEntraceIllusion_543ad91c-25c7-4036-b117-8822e89f54f2,1);

IF
DB_LOW_BlushingMermaidBasementEntranceIllusuion(S_LOW_BlushingMermaid_BasementEntraceIllusion_543ad91c-25c7-4036-b117-8822e89f54f2)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
NOT DB_KnowledgeCheckTrigger("LOW_BlushingMermaid_BasementEntranceIllusion_Investigation",(TRIGGER)S_LOW_BlushingMermaid_BasementEntraceIllusion_Trigger_3856c014-2ab7-4d1e-99d3-f25237bff950,"Investigation",(DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57);
PROC_SetOnStage(S_LOW_BlushingMermaid_BasementEntrace_NoHagWall_1e20d3ee-e3e6-46fb-af14-e6a8a4e66373,1);
PROC_SetOnStage(S_LOW_BlushingMermaid_BasementEntraceIllusion_543ad91c-25c7-4036-b117-8822e89f54f2,0);

PROC
PROC_GLO_KnowledgeCheckSuccess(_Player,"LOW_BlushingMermaid_BasementEntranceIllusion_Investigation",_)
AND
DB_Players(_Player)
THEN
PROC_TryStartAD((DIALOGRESOURCE)GLO_PerceptionSuccess_48825dbe-a320-7c4c-fe3e-372b717d5bc9, _Player);
ApplyStatus(S_LOW_BlushingMermaid_BasementEntraceIllusion_543ad91c-25c7-4036-b117-8822e89f54f2,"HAG_MASK_ILLUSION",-1.0);

// Alternative way out of the basement once players have made it inside through the illusory wall
IF
UseStarted(_,(ITEM)S_LOW_BlushingMermaid_BasementExitSecretDoor_Lever_1f1c1092-47a1-42f6-a04e-ef4b1b2bc60f)
THEN
SetCanInteract((ITEM)S_LOW_BlushingMermaid_BasementExitSecretDoor_Lever_1f1c1092-47a1-42f6-a04e-ef4b1b2bc60f,0);
Open((ITEM)S_LOW_BlushingMermaid_BasementExitSecretDoor_d4532c40-dc9d-4fe7-a956-f54655453133);
//END_REGION

//REGION Patrons
// If either patron 1 or 9 is not available for their debate dialog, each will have a unique interactive one
QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_BlushingMermaid_Patron_01_4e7b519f-3e47-45d7-b2d1-20001a522bfe, _Player)
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_BlushingMermaid_Patron_09_da46cc19-8972-478a-b063-7f7a5f61ae93, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_BlushingMermaid_Patron_01_2f2a704c-f887-4285-b4d1-21950ab01e89, S_LOW_BlushingMermaid_Patron_01_4e7b519f-3e47-45d7-b2d1-20001a522bfe, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_BlushingMermaid_Patron_09_da46cc19-8972-478a-b063-7f7a5f61ae93, _Player)
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_BlushingMermaid_Patron_01_4e7b519f-3e47-45d7-b2d1-20001a522bfe, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_BlushingMermaid_Patron_09_e135b723-9b0a-3c62-85c3-1cba9824f86d, S_LOW_BlushingMermaid_Patron_09_da46cc19-8972-478a-b063-7f7a5f61ae93, _Player);

// Same with patrons 12 and 13
QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_BlushingMermaid_Patron_12_b5c8b44e-c660-4a97-bbaf-8a0853a4c6c8, _Player)
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_BlushingMermaid_Patron_13_0cd108a4-a496-4e90-8ee7-d09fe6bc0e47, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_BlushingMermaid_Patron_12_3cd5b4a4-a841-10b4-4fc9-45a6a6e8e2f2, S_LOW_BlushingMermaid_Patron_12_b5c8b44e-c660-4a97-bbaf-8a0853a4c6c8, _Player);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_LOW_BlushingMermaid_Patron_13_0cd108a4-a496-4e90-8ee7-d09fe6bc0e47, _Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_Patron_12_Left_27009b2b-39b4-4e4a-bdd8-fa518d6cfef7)
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_BlushingMermaid_Patron_12_b5c8b44e-c660-4a97-bbaf-8a0853a4c6c8, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_BlushingMermaid_Patron_13_42e6c49e-d583-42b1-1dcc-501617c15fef, S_LOW_BlushingMermaid_Patron_13_0cd108a4-a496-4e90-8ee7-d09fe6bc0e47, _Player);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_BlushingMermaid_State_Patron_12_Left_27009b2b-39b4-4e4a-bdd8-fa518d6cfef7)
THEN
PROC_DisappearOutOfSight((CHARACTER)S_LOW_BlushingMermaid_Patron_12_b5c8b44e-c660-4a97-bbaf-8a0853a4c6c8,"Run",0,"");
PROC_RemoveAllDialogEntriesForSpeaker(S_LOW_BlushingMermaid_Patron_13_0cd108a4-a496-4e90-8ee7-d09fe6bc0e47);
DB_Dialogs(S_LOW_BlushingMermaid_Patron_13_0cd108a4-a496-4e90-8ee7-d09fe6bc0e47, (DIALOGRESOURCE)LOW_BlushingMermaid_Patron_13_42e6c49e-d583-42b1-1dcc-501617c15fef);
//END_REGION

//REGION Completing LOW_SaveHaggedChild quest due to players leaving for END
IF
FlagSet((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99,_,_)
AND
DB_QuestIsOpened("LOW_SaveHaggedChild")
AND
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BlushingMermaid_State_AgreedToBringHeadToHag_c0a98ec4-171f-46c1-9a67-80140da3703e,"LOW_SaveHaggedChild",_QuestUpdateToKillLora,_,_)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_SaveHaggedChild",_QuestUpdateToKillLora)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRevealed_aa751f69-f448-1436-c243-eb9f06a060ca)
THEN
QuestUpdate("LOW_SaveHaggedChild","EnteredEND_UnfinishedKillLora");

IF
FlagSet((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99,_,_)
AND
DB_QuestIsOpened("LOW_SaveHaggedChild")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5)
THEN
QuestUpdate("LOW_SaveHaggedChild","EnteredEND_MadeHagDeal");

IF
FlagSet((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99,_,_)
AND
DB_QuestIsOpened("LOW_SaveHaggedChild")
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5)
THEN
QuestUpdate("LOW_SaveHaggedChild","EnteredEND_NoHagDeal");

IF
FlagSet((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99,_,_)
THEN
GoalCompleted;
//END_REGION

//REGION Cleared in the end of the script so other Resurrected events don't happen on INIT in case the hag was killed in Act 1
IF
Resurrected((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
DB_LOW_LevelTeleportHagResurrecting(1)
THEN
NOT DB_LOW_LevelTeleportHagResurrecting(1);
ApplyStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, "LOW_HAG_DISGUISE",-1.0,0);

// Edge case for when players one-shot the disguised hag in act 1
IF
StatusApplied(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HAG_DISGUISE",_,_)
AND
HasActiveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_DISGUISE",1)
THEN
RemoveStatus(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"HAG_DISGUISE");
//END_REGION

//REGION Debug
IF
FlagSet(HAG_Hag_Event_HagEyed_2ac94597-a234-92c1-f777-aeeda4715594, _Player, _)
THEN
ApplyStatus(_Player, "HAG_HAGEYED", -1.0, 1, S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
SetTag(_Player, CANTLOSEEYE_b5de40c5-edec-43a7-a918-1d85c13232de);
SetTag(_Player, (TAG)HAGEYED_c1f7de2b-7cc5-41bc-a723-011172bbc4ba);

IF
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Debug_HagCombat_4a25fd3c-2284-48aa-8805-52cb3883ea5d)
THEN
ClearFlag((FLAG)LOW_BlushingMermaid_Debug_HagCombat_4a25fd3c-2284-48aa-8805-52cb3883ea5d);
SetFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720);
RealtimeObjectTimerLaunch(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HagCombatDebugTimer",100);

IF
ObjectTimerFinished(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HagCombatDebugTimer")
AND
GetHostCharacter(_Host)
THEN
PROC_LOW_HagRetreatsToOrlop();
SetFlag((FLAG)Debug_Teleport_LOW_BlushingMermaid_Basement_175bb4c2-23ad-4643-a46c-e92ce7af6198,_Host);

IF
TextEvent("LOW_TestTitle")
AND
GetTextEventParamString(1,_String)
THEN
ObjectSetTitle(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_String);

IF
DB_LOW_Ethel(_Ethel)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_SetOnStage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, 0);

// Happens during debug testing as HagDefeated flag is set then in Act 3 while normally it is set in Act 1
IF
StatusApplied(_Character,"HAG_MASK_HAGDEAD",_Causee,_StoryActionAD)
AND
DB_HAG_MaskedVictims((CHARACTER)_Character,_,_,_)
THEN
RemoveStatus(_Character,"HAG_MASK_HAGDEAD");

// Prevents masked victims going neutral to players on using HagDefated flag to trigger the situation
IF
RelationChanged((FACTION)GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,50,1)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
THEN
PROC_SetRelationToPlayers((FACTION)GLO_HagMaskedVictims_208ebac7-6954-4087-802f-6145cce161c0,0);

// Testing hag is trully dead state with Vanra dead or alive
IF
FlagSet((FLAG)LOW_BlushingMermaid_Debug_HagTrullyDead_VanraAlive_55f0df47-4274-4b30-abfc-c7d9a05e0a6b,_,_)
THEN
PROC_LOW_DebugTrullyKillHagSetup();

IF
FlagSet((FLAG)LOW_BlushingMermaid_Debug_HagTrullyDead_VanraDead_c7349d11-37c9-4f06-b4a7-926e30bb7763,_,_)
THEN
PROC_LOW_DebugTrullyKillHagSetup();

PROC
PROC_LOW_DebugTrullyKillHagSetup()
THEN
DB_LOW_DebugTrullyKillHag(1);
SetFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720);
RealtimeObjectTimerLaunch(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HagTrullyDeadDebugTimer",500);

IF
ObjectTimerFinished(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HagTrullyDeadDebugTimer")
THEN
PROC_LOW_HagRetreatsToOrlop();

IF
EntityEvent(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,"LOW_HagTeleportedToCellar")
AND
DB_LOW_DebugTrullyKillHag(1)
THEN
PROC_LOW_DebugKillHagShrooms();

PROC
PROC_LOW_DebugKillHagShrooms()
AND
DB_GLO_DefeatCounter(_HagShroom,"LOW_HagResurrectionShrooms_PermaDefeated")
THEN
Die((ITEM)_HagShroom);
SetFlag((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33,_,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Debug_HagTrullyDead_VanraAlive_55f0df47-4274-4b30-abfc-c7d9a05e0a6b)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8);

IF
EntityEvent(_,"LOW_VanraSavedTeleport")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Debug_HagTrullyDead_VanraAlive_55f0df47-4274-4b30-abfc-c7d9a05e0a6b)
THEN
Die(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,DEATHTYPE.Physical,1);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33,_,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Debug_HagTrullyDead_VanraDead_c7349d11-37c9-4f06-b4a7-926e30bb7763)
THEN
PROC_LOW_HagKilled_SpawnDeadVanra();

// Fix for Act3 debug setup for the hag + failsafe
IF
EnteredLevel(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_,"CTY_Main_A")
AND
CanJoinCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,0)
THEN
SetCanJoinCombat(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1);
PROC_CharacterEnableAllCrimes(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
