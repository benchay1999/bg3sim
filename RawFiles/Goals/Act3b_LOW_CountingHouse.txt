Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION One-liners
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Civilian_01_348bb33b-0d35-402a-80ea-4c580a56606e, (DIALOGRESOURCE)LOW_CountingHouse_Civilian_01_cc4fe35a-3f61-7b62-483b-80950f6e4583);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Civilian_02_cd8b2413-8448-43a7-bfeb-dfecb6e0751e, (DIALOGRESOURCE)LOW_CountingHouse_Civilian_02_b67d7a17-b0e0-ad45-6d20-0b7764209409);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Civilian_03_a3e04f8b-7727-42e7-96cb-b999503dd31e, (DIALOGRESOURCE)LOW_CountingHouse_Civilian_03_2439049c-96b4-8b29-0c90-f9de118dc24f);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Civilian_04_7d487dda-ca17-4251-8958-a96c4ee5e2f7, (DIALOGRESOURCE)LOW_CountingHouse_Civilian_04_d1702ae5-5b57-6daa-615f-afc4d64d0068);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Civilian_05_1a31eecd-72c4-48ce-bdda-a8dd291352f7, (DIALOGRESOURCE)LOW_CountingHouse_Civilian_05_39688e6a-e540-488b-fd81-2f622162b036);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Civilian_06_120f4e97-f519-4d1d-8537-70414eef6450, (DIALOGRESOURCE)LOW_CountingHouse_Civilian_06_e58e929f-24d4-0b13-a85e-21a8575f35b5);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Clerk_01_e7c72e09-b685-4a16-94a1-850c40ad6339, (DIALOGRESOURCE)LOW_CountingHouse_Clerk_001_6824c56a-ca48-3002-c573-7a4849482a02);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Clerk_02_4fd8e88d-75ca-4fc4-a73c-d8c7ba85b873, (DIALOGRESOURCE)LOW_CountingHouse_Clerk_002_7014379b-723c-e4af-d2f6-d27b8ca2da0b);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Clerk_03_af575949-4460-46d8-ba7b-71c9d35738b7, (DIALOGRESOURCE)LOW_CountingHouse_Clerk_000_4e7d0e7c-a910-3044-2585-4b220c2696bc);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_01_316f2520-fe74-4287-869b-88eea90c983d, (DIALOGRESOURCE)LOW_CountingHouse_Guard_01_48a1dd1a-438f-4009-2d09-02a1c6241a21);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_02_4316b95f-6624-4601-bceb-bdddb8e0ba62, (DIALOGRESOURCE)LOW_CountingHouse_Guard_02_b8dc5b78-1e9b-717d-2b40-48fd6cff320e);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_03_474ad061-b260-4866-bcea-64ec99e29968, (DIALOGRESOURCE)LOW_CountingHouse_Guard_03_e7f414d2-0a56-df09-3a52-bc6e025e38de);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_04_8e3c3b8b-a809-4423-8cf6-cea702b070ec, (DIALOGRESOURCE)LOW_CountingHouse_Guard_04_fd85118e-913b-9262-ec53-cd3255090439);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_05_400c9176-b9b5-448c-a283-156b15125eec, (DIALOGRESOURCE)LOW_CountingHouse_Guard_05_b20dfaf1-766b-ef2f-eb73-8e3ef0495ccc);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_06_ae3168fe-dd18-421b-aa51-4d86d1245871, (DIALOGRESOURCE)LOW_CountingHouse_Guard_06_04efe0ee-d630-4f83-46e1-47fc45921aa2);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_07_52504043-35b8-47ec-8ea4-4ac40593654e, (DIALOGRESOURCE)LOW_CountingHouse_Guard_07_157dc58d-c438-e782-495e-947177406b0e);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_08_e4ff4283-9c1c-4fd7-8e7c-b7fa27b789a8, (DIALOGRESOURCE)LOW_CountingHouse_Guard_08_b92131f2-e171-1b51-c4c0-7848b790b7d3);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_09_0aadf193-523e-40ef-80b6-fcfd5e56143f, (DIALOGRESOURCE)LOW_CountingHouse_Guard_09_8b7408d6-784b-112e-19b3-8d8883391189);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_10_600ae933-d6d3-443f-b400-8ed440874ff6, (DIALOGRESOURCE)LOW_CountingHouse_Guard_10_251d02a9-ad36-79f6-2bf5-789bc115665a);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_11_b2e920a0-0ca6-463c-beed-6fee81a6bb0b, (DIALOGRESOURCE)LOW_CountingHouse_Guard_11_1a4a918c-87f9-7309-947f-98c72002d649);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_12_4ed00592-af13-4eb4-8bfc-e337135b8b87, (DIALOGRESOURCE)LOW_CountingHouse_Guard_12_d180f165-a789-ba29-0aec-35ea92a7ddc2);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_Guard_13_9bbb4f10-bbb8-4fd5-a38a-55581bc2c3c9, (DIALOGRESOURCE)LOW_CountingHouse_Guard_13_ad09ac0e-44d5-3a93-b0e2-6e300b0f86a7);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_HeadClerkOfficeGuard_f5d6f408-f7d0-4d36-aef9-44e578727fd9, (DIALOGRESOURCE)LOW_CountingHouse_HeadClerkOfficeGuard_72048c84-2979-a801-2b98-657cfe10f417);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_HeadBankerOfficeGuard_6cf1730a-50af-49e2-b7f4-1ff52d448071, (DIALOGRESOURCE)LOW_CountingHouse_HeadBankerOfficeGuard_e58c861a-ec4f-2430-b2ad-2d767d0d095b);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_LobbyStairsGuard_33446759-12f2-41ed-aba7-4a4f4408c5fe, (DIALOGRESOURCE)LOW_CountingHouse_LobbyStairsGuard_e6f7f0db-ef8e-1f4c-cd0f-7d1ad6709a90);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_VaultButtonGuard_41a0b028-9e14-4781-8a06-cb3cb8a9ee4f, (DIALOGRESOURCE)LOW_CountingHouse_VaultButtonGuard_4ef5fba7-dc22-860a-45b0-b5865b9a4157);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_PrivateGuard_01_2eb23f41-9a39-4b28-b2e5-3409f6669b70, (DIALOGRESOURCE)LOW_CountingHouse_PrivateGuard_01_effef291-b41b-22de-5106-99b7ba93ee04);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_PrivateGuard_02_ff490513-7296-4512-8040-239f9e824f2b, (DIALOGRESOURCE)LOW_CountingHouse_PrivateGuard_02_b7a83b8f-f50e-e1a8-0773-8133b75fe524);
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_PrivateGuard_03_459e4fa3-c9f3-478a-ba56-e09431674e32, (DIALOGRESOURCE)LOW_CountingHouse_PrivateGuard_03_f4c4fae1-8087-5450-39aa-9e6e7892ed0e);
//END_REGION

//REGION Behavior ADs
DB_DoNotFaceDialog(S_LOW_CountingHouse_Guard_03_474ad061-b260-4866-bcea-64ec99e29968,(DIALOGRESOURCE)LOW_CountingHouse_AD_MainEntranceGuards_Convo_305f2647-0d5b-c433-cba5-6df4a25fac36);
DB_DoNotFaceDialog(S_LOW_CountingHouse_Guard_02_4316b95f-6624-4601-bceb-bdddb8e0ba62,(DIALOGRESOURCE)LOW_CountingHouse_AD_MainEntranceGuards_Convo_305f2647-0d5b-c433-cba5-6df4a25fac36);

DB_DoNotFaceDialog(S_LOW_CountingHouse_VaultWarningGuard_b07c79ad-9c9c-4131-a7c2-70e898e5e984,(DIALOGRESOURCE)LOW_CountingHouse_AD_PreVaultCheckpointGuards_Convo_53a6e894-fcbf-9af5-320f-6efd4625c23d);
DB_DoNotFaceDialog(S_LOW_CountingHouse_VaultMainGuard_936953b6-059b-4ed6-b03a-5d1b340f8889,(DIALOGRESOURCE)LOW_CountingHouse_AD_PreVaultCheckpointGuards_Convo_53a6e894-fcbf-9af5-320f-6efd4625c23d);

DB_DoNotFaceDialog(S_LOW_CountingHouse_HeadBankerOfficeGuard_6cf1730a-50af-49e2-b7f4-1ff52d448071,(DIALOGRESOURCE)LOW_CountingHouse_AD_UpperOfficeGuards_Convo_fc7539c6-8721-4985-d83c-af49f6683f5b);
DB_DoNotFaceDialog(S_LOW_CountingHouse_HeadClerkOfficeGuard_f5d6f408-f7d0-4d36-aef9-44e578727fd9,(DIALOGRESOURCE)LOW_CountingHouse_AD_UpperOfficeGuards_Convo_fc7539c6-8721-4985-d83c-af49f6683f5b);

DB_DoNotFaceDialog(S_LOW_CountingHouse_LobbyWarningGuard_cbfc2698-d7bc-403c-a861-8c9dbdec010b,(DIALOGRESOURCE)LOW_CountingHouse_AD_LobbyCheckpointGuards_Convo_c9e59506-d311-e78d-ff77-0376b2f39158);
DB_DoNotFaceDialog(S_LOW_CountingHouse_LobbyMainGuard_812a2565-3c84-4c47-9255-5d66d840ede4,(DIALOGRESOURCE)LOW_CountingHouse_AD_LobbyCheckpointGuards_Convo_c9e59506-d311-e78d-ff77-0376b2f39158);

DB_DoNotFaceDialog(S_LOW_CountingHouse_Guard_05_400c9176-b9b5-448c-a283-156b15125eec,(DIALOGRESOURCE)LOW_CountingHouse_AD_DocksDoorGuards_Convo_daf45d51-97fa-44f2-a53d-2808b998d206);
DB_DoNotFaceDialog(S_LOW_CountingHouse_Guard_04_8e3c3b8b-a809-4423-8cf6-cea702b070ec,(DIALOGRESOURCE)LOW_CountingHouse_AD_DocksDoorGuards_Convo_daf45d51-97fa-44f2-a53d-2808b998d206);

DB_DoNotFaceDialog(S_LOW_CountingHouse_Clerk_01_e7c72e09-b685-4a16-94a1-850c40ad6339,(DIALOGRESOURCE)LOW_CountingHouse_AD_Clerks_ChitChat_8a6f4e3a-2584-4472-881a-2305a896faf1);
DB_DoNotFaceDialog(S_LOW_CountingHouse_Clerk_02_4fd8e88d-75ca-4fc4-a73c-d8c7ba85b873,(DIALOGRESOURCE)LOW_CountingHouse_AD_Clerks_ChitChat_8a6f4e3a-2584-4472-881a-2305a896faf1);
//END_REGION

//REGION World behavior ledgers
DB_LOW_CountingHouse_ClerksLedger((CHARACTER)S_LOW_CountingHouse_Clerk_02_4fd8e88d-75ca-4fc4-a73c-d8c7ba85b873,(ITEM)BOOK_LOW_CountingHouse_AccountingBook03_000_db0cb53d-f968-48a7-ae48-eda917d34a8b);
DB_LOW_CountingHouse_ClerksLedger(S_LOW_CountingHouse_Clerk_01_e7c72e09-b685-4a16-94a1-850c40ad6339,BOOK_LOW_CountingHouse_AccountingBook02_000_6e800238-08c0-4f2e-a93d-42fed0abf740);
DB_LOW_CountingHouse_ClerksLedger(S_LOW_CountingHouse_HeadClerk_14f97819-1e07-4758-9ca8-d7802c610c43,S_LOW_CountingHouse_CounterLedger_d0f008f4-a4b2-4e6b-8a7c-a7e7c223a89b);
DB_LOW_CountingHouse_ClerksLedger(S_LOW_CountingHouse_Clerk_03_af575949-4460-46d8-ba7b-71c9d35738b7,BOOK_LOW_CountingHouse_AccountingBook01_000_956da206-9581-49ff-a7bd-ba70d8ab6101);
//END_REGION

//REGION Clerks, Guards and systemics
// Head Clerk
DB_Dialogs(S_LOW_CountingHouse_HeadClerk_14f97819-1e07-4758-9ca8-d7802c610c43, (DIALOGRESOURCE)LOW_CountingHouse_HeadClerk_8ac7c552-07e5-c7b7-d061-efdf3cebcc71);
DB_HasItemEvent((ITEM)S_LOW_CountingHouse_BankPass_000_bd6ddb53-2585-4914-b30a-9626c57317b6,(FLAG)LOW_CountingHouse_State_HasBankPass_0adc0b5e-3f89-4b3a-b04e-417499a8a818);
DB_HasItemEvent((ITEM)S_LOW_CountingHouse_PlayerSafeKey_ff80570a-4ef8-48f6-8d18-8a6971aeddea,(FLAG)LOW_CountingHouse_State_HasPlayerSafeKey_d3a2984c-afd6-4a41-9d75-e165bb38afff);
DB_GiveItemToEvent((ITEM)S_LOW_CountingHouse_BankPass_000_bd6ddb53-2585-4914-b30a-9626c57317b6, (FLAG)LOW_CountingHouse_Event_GiveBankPass_a42bbf4c-621e-25ef-48f7-1696d5c3baee);
DB_GiveItemToEvent((ITEM)S_LOW_CountingHouse_PlayerSafeKey_ff80570a-4ef8-48f6-8d18-8a6971aeddea, (FLAG)LOW_CountingHouse_Event_GiveSafeKey_50bbe524-a8bf-0941-7a2f-2f2fdf80b357);
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_CountingHouse_HeadClerk_8ac7c552-07e5-c7b7-d061-efdf3cebcc71, 10000);

// Lobby Guards
DB_Dialogs(S_LOW_CountingHouse_LobbyMainGuard_812a2565-3c84-4c47-9255-5d66d840ede4, (DIALOGRESOURCE)LOW_CountingHouse_LobbyMainGuard_a33eb524-fb4f-a9fb-32cf-add13b80bf05);
DB_Dialogs(S_LOW_CountingHouse_LobbyWarningGuard_cbfc2698-d7bc-403c-a861-8c9dbdec010b, (DIALOGRESOURCE)LOW_CountingHouse_LobbyWarningGuard_b7998a64-d240-bab5-36a4-9e415ec65db4);
DB_HasItemTemplateScriptFlag(1, (DIALOGRESOURCE)LOW_CountingHouse_LobbyMainGuard_a33eb524-fb4f-a9fb-32cf-add13b80bf05, LOW_CountingHouse_BankPass_de7ce4d1-e190-4a32-be52-57f114b5823c, 2, 1);
// Persuassion, Deception bribe options
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_CountingHouse_LobbyMainGuard_a33eb524-fb4f-a9fb-32cf-add13b80bf05, 5000);
// Intimidation bribe option
DB_DialogMoneyTransfer(2, (DIALOGRESOURCE)LOW_CountingHouse_LobbyMainGuard_a33eb524-fb4f-a9fb-32cf-add13b80bf05, 1000);
// Persuassion bribe with knowledge that the head clerk is worried
DB_DialogMoneyTransfer(3, (DIALOGRESOURCE)LOW_CountingHouse_LobbyMainGuard_a33eb524-fb4f-a9fb-32cf-add13b80bf05, 3000);
DB_CheckPoint((CHARACTER)S_LOW_CountingHouse_LobbyMainGuard_812a2565-3c84-4c47-9255-5d66d840ede4,(CHARACTER)S_LOW_CountingHouse_LobbyWarningGuard_cbfc2698-d7bc-403c-a861-8c9dbdec010b,
				(TRIGGER)S_LOW_CountingHouse_LobbyCheckpointPrimary_Trigger_570d734f-3154-4083-b49d-e9084d098bdb,(TRIGGER)S_LOW_CountingHouse_LobbyCheckpointWarning_Trigger_61fa3f8c-8297-4b22-9da5-2f0d4978fffd,
				(TRIGGER)S_LOW_CountingHouse_LobbyCheckpointTrespass_Trigger_ffcbaebb-e5ab-4da5-bad0-ec6bc9a0d254,"LOW_CountingHouse_LobbyCheckpoint",
				(FLAG)LOW_CountingHouse_State_PassedLobbyCheckpoint_085b0568-d4e7-72f4-9281-712589a0733c,"LOW_CountingHouse_Trespassing",
				(TRIGGER)S_LOW_CountingHouse_LobbyTrespassOutTrigger_1bca742f-67a0-445d-b88a-0bec24fcd24f);

// Vault Checkpoint
DB_Dialogs(S_LOW_CountingHouse_VaultWarningGuard_b07c79ad-9c9c-4131-a7c2-70e898e5e984, (DIALOGRESOURCE)LOW_CountingHouse_VaultWarningGuard_efcd5154-549a-7e15-0827-12c3cc67c77d);
DB_Dialogs(S_LOW_CountingHouse_VaultMainGuard_936953b6-059b-4ed6-b03a-5d1b340f8889, (DIALOGRESOURCE)LOW_CountingHouse_VaultGuard_d3e8107f-e747-635b-5922-d99ad2b3d4aa);
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_CountingHouse_VaultGuard_d3e8107f-e747-635b-5922-d99ad2b3d4aa, 5000);
DB_HasItemTemplateScriptFlag(1, (DIALOGRESOURCE)LOW_CountingHouse_VaultGuard_d3e8107f-e747-635b-5922-d99ad2b3d4aa, LOW_CountingHouse_BankPass_de7ce4d1-e190-4a32-be52-57f114b5823c, 2, 1);
DB_CheckPoint((CHARACTER)S_LOW_CountingHouse_VaultMainGuard_936953b6-059b-4ed6-b03a-5d1b340f8889,(CHARACTER)S_LOW_CountingHouse_VaultWarningGuard_b07c79ad-9c9c-4131-a7c2-70e898e5e984,
				(TRIGGER)S_LOW_CountingHouse_VaultCheckpointSpotTrigger_6d1fd722-434d-4904-a775-5e42aa3f29b0,(TRIGGER)S_LOW_CountingHouse_VaultCheckpointWarningTrigger_e6bb8958-024c-4438-84b0-362f5f2f2e3b,
				(TRIGGER)S_LOW_CountingHouse_VaultCheckpointTrespassTrigger_67fa23ed-df99-4bbe-a701-37a5a98d0bf0,"LOW_CountingHouse_VaultCheckpoint",
				(FLAG)LOW_CountingHouse_State_PassedVaultCheckpoint_b67acf0a-5a0e-f363-293e-d913b5bce599,"LOW_CountingHouse_Trespassing",
				(TRIGGER)S_LOW_CountingHouse_VaultCheckpointOutTrigger_6218b761-223c-445b-ade1-4b00fd8beb75);
DB_LOW_VaultCheckpointGuards(S_LOW_CountingHouse_VaultButtonGuard_41a0b028-9e14-4781-8a06-cb3cb8a9ee4f);
DB_LOW_VaultCheckpointGuards(S_LOW_CountingHouse_VaultWarningGuard_b07c79ad-9c9c-4131-a7c2-70e898e5e984);
DB_LOW_VaultCheckpointGuards(S_LOW_CountingHouse_VaultMainGuard_936953b6-059b-4ed6-b03a-5d1b340f8889);

DB_TrespassTrigger((TRIGGER)S_LOW_CountingHouse_ClerkTrespassTrigger_64da4624-ed97-46ba-b31e-42c684440798, (TRIGGER)S_LOW_CountingHouse_LobbyTrespassOutTrigger_1bca742f-67a0-445d-b88a-0bec24fcd24f,"LOW_CountingHouse_Trespassing");
DB_TrespassTrigger((TRIGGER)S_LOW_CountingHouse_UpperOffice_TrespassTrigger_cf4871cc-bbe4-487e-9b13-845ed0741c39, (TRIGGER)S_LOW_CountingHouse_LobbyTrespassOutTrigger_1bca742f-67a0-445d-b88a-0bec24fcd24f,"LOW_CountingHouse_Trespassing");
DB_TrespassTrigger((TRIGGER)S_LOW_CountingHouse_DocksTrespass_Trigger_5a769f1e-769a-444f-87a0-e26f9aa6f46b, (TRIGGER)S_LOW_CountingHouse_LobbyTrespassOutTrigger_1bca742f-67a0-445d-b88a-0bec24fcd24f,"LOW_CountingHouse_Trespassing");
// Restricted area triggers another trespass crime so a dialog which allows players to show the bank pass is triggered
DB_TrespassTrigger((TRIGGER)S_LOW_CountingHouse_RestrictedAreaTrespass_Trigger_8d239901-9f60-46ca-8774-2aab55b715c3, (TRIGGER)S_LOW_CountingHouse_LobbyTrespassOutTrigger_1bca742f-67a0-445d-b88a-0bec24fcd24f,"LOW_CountingHouse_BankPass_Trespassing");
DB_HasItemTemplateScriptFlag(1, (DIALOGRESOURCE)LOW_NGB_CountingHouse_BankPass_Trespassing_acb66b4b-fc8d-7f85-b355-e510b6ae90e8, LOW_CountingHouse_BankPass_de7ce4d1-e190-4a32-be52-57f114b5823c, 2, 1);
// In Counting House any chars provoke crime reactions, even those that normally are considered Inconspicuous
// TODO: Add some reactivity from the guards to acknowledge that we bend Inconspicuous rules in this instance
DB_Shapeshifting_Inconspicuous_CustomTriggerExpr((TRIGGER)S_LOW_CountingHouse_RestrictedAreaTrespass_Trigger_8d239901-9f60-46ca-8774-2aab55b715c3, "");
DB_Shapeshifting_Inconspicuous_CustomTriggerExpr((TRIGGER)S_LOW_CountingHouse_ClerkTrespassTrigger_64da4624-ed97-46ba-b31e-42c684440798, "");
DB_Shapeshifting_Inconspicuous_CustomTriggerExpr((TRIGGER)S_LOW_CountingHouse_UpperOffice_TrespassTrigger_cf4871cc-bbe4-487e-9b13-845ed0741c39, "");
DB_Shapeshifting_Inconspicuous_CustomTriggerExpr((TRIGGER)S_LOW_CountingHouse_DocksTrespass_Trigger_5a769f1e-769a-444f-87a0-e26f9aa6f46b, "");

DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_CountingHouse_OwnershipTrigger_513babe6-4277-438f-b9cf-ac3f8eedc476,(CHARACTER)S_LOW_CountingHouse_HeadClerk_14f97819-1e07-4758-9ca8-d7802c610c43);
DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_DOOR_CountingHouse_D_000_1a427059-a1a8-4fa9-a4ff-4d90839a4ee1);
DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_DOOR_CountingHouse_E_000_637c5243-4f01-433a-ac93-6c217e1eb634);
DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_DOOR_CountingHouse_A_000_0b998ed0-5722-4058-a702-c2b0837c5d05);
DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_DOORTELEPORT_Vault_000_38d32292-889b-4f3d-9841-ca318376ee06);
DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_LOW_CountingHouse_Sign_01_2ecc2681-22be-40c7-8f4d-1c0dde1c7901);
DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_LOW_CountingHouse_Sign_02_710932b4-45f3-4e2b-b05c-c60b81f28bf6);

DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_DOOR_CountingHouse_HeadClerkDoor_5f8d363d-3ced-4b29-a6f9-f433c085f7fa);
DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_DOOR_CountingHouse_HeadBankerDoor_bd073f8e-5cb7-48c0-8a4a-f6f3a6a06df6);

DB_ItemDialog_NarratorAD((ITEM)S_LOW_CountingHouse_Sign_01_2ecc2681-22be-40c7-8f4d-1c0dde1c7901,(DIALOGRESOURCE)LOW_CountingHouse_AD_Sign_852d0aed-23db-207b-8399-bcff2420b9f4);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_CountingHouse_Sign_02_710932b4-45f3-4e2b-b05c-c60b81f28bf6,(DIALOGRESOURCE)LOW_CountingHouse_AD_Sign_852d0aed-23db-207b-8399-bcff2420b9f4);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_CountingHouse_PinCodeSign_783b51d3-9d6d-46e7-887d-af48abfa713f,(DIALOGRESOURCE)LOW_CountingHouse_AD_PinCodeSign_53b99e7e-76a8-08bc-bb47-2b5a82c1663f);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CountingHouse_State_FailedProbingHeadClerkThoughts_37efa7dd-df3f-4df2-bfbf-cc1c788f4207, (DIALOGRESOURCE)LOW_CountingHouse_HeadClerk_8ac7c552-07e5-c7b7-d061-efdf3cebcc71);
//END_REGION

//REGION Clerks/Customers
DB_LOW_CountingHouse_Customers(S_LOW_CountingHouse_Civilian_01_348bb33b-0d35-402a-80ea-4c580a56606e,(TRIGGER)S_LOW_CountingHouse_Civilian_01_IdleTrigger_a2e7aca5-f233-4719-a9de-5d151b5aaa58);
DB_LOW_CountingHouse_Customers(S_LOW_CountingHouse_Civilian_02_cd8b2413-8448-43a7-bfeb-dfecb6e0751e,(TRIGGER)S_LOW_CountingHouse_Civilian_02_IdleTrigger_b13e6ed4-c3b9-41a4-acf1-aebcf184e246);
DB_LOW_CountingHouse_Customers(S_LOW_CountingHouse_Civilian_03_a3e04f8b-7727-42e7-96cb-b999503dd31e,(TRIGGER)S_LOW_CountingHouse_Civilian_03_IdleTrigger_a0273b35-e95a-4989-bfac-e93629694396);
DB_LOW_CountingHouse_Customers(S_LOW_CountingHouse_Civilian_04_7d487dda-ca17-4251-8958-a96c4ee5e2f7,(TRIGGER)S_LOW_CountingHouse_Civilian_04_IdleTrigger_eaa35896-7f90-42bf-a4f2-e2ebbd3422f9);
DB_LOW_CountingHouse_Customers(S_LOW_CountingHouse_Civilian_05_1a31eecd-72c4-48ce-bdda-a8dd291352f7,(TRIGGER)S_LOW_CountingHouse_Civilian_05_IdleTrigger_9f58e4a2-4152-462f-9fbb-ecd47c61eb6b);
DB_LOW_CountingHouse_Customers(S_LOW_CountingHouse_Civilian_06_120f4e97-f519-4d1d-8537-70414eef6450,(TRIGGER)S_LOW_CountingHouse_Civilian_06_IdleTrigger_3f97a15e-0b76-40cd-bb0e-17087f589fe6);

DB_LOW_CountingHouse_Clerks(S_LOW_CountingHouse_Clerk_01_e7c72e09-b685-4a16-94a1-850c40ad6339);
DB_LOW_CountingHouse_Clerks(S_LOW_CountingHouse_Clerk_02_4fd8e88d-75ca-4fc4-a73c-d8c7ba85b873);
DB_LOW_CountingHouse_Clerks(S_LOW_CountingHouse_Clerk_03_af575949-4460-46d8-ba7b-71c9d35738b7);
DB_LOW_CountingHouse_Clerks(S_LOW_CountingHouse_HeadClerk_14f97819-1e07-4758-9ca8-d7802c610c43);

NOT DB_LOW_CountingHouse_Civilians((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000);

// If alarm goes off, civilians panic
DB_GLO_CompoundFlag((FLAG)LOW_CountingHouse_State_AlarmTriggered_36e1843f-b531-4155-8ca7-f2d13908f419,(FLAG)LOW_CountingHouse_State_CiviliansPanicked_67cadb20-00fc-4015-9771-600132b67ecb);

DB_LOW_CountingHouse_CrowdTriggers((TRIGGER)CCT_ELFout_CTZN_TalkREAC_004_57980f66-c0ae-4131-b202-53f09969fb77);
DB_LOW_CountingHouse_CrowdTriggers(CCT_ELFout_CTZN_Talk_004_f6d45c19-b2cd-4fb2-8956-d2f46e5c1e11);
DB_LOW_CountingHouse_CrowdTriggers(CCT_BsG_CTZN_TalkREAC_038_5baa7f4f-57e2-4e44-be01-9707534a18b2);
DB_LOW_CountingHouse_CrowdTriggers(CCT_BsG_CTZN_Talk_038_3f80a912-322c-46ab-8dcc-448584fb73f0);
DB_LOW_CountingHouse_CrowdTriggers(CCT_BsG_CTZN_Talk_024_02594c05-7ae1-41a7-8a95-f406197a22ae);
DB_LOW_CountingHouse_CrowdTriggers(CCT_BsG_CTZN_TalkREAC_024_286a0965-1da4-46cf-a709-752e1a974db7);
DB_LOW_CountingHouse_CrowdTriggers(CCT_ELFout_CTZN_Talk_006_54bd834d-267a-42d4-8a9b-a6928bdcd72b);
DB_LOW_CountingHouse_CrowdTriggers(CCT_ELFout_CTZN_TalkREAC_006_00346972-a60a-41da-aea0-ccd8251e9107);
DB_LOW_CountingHouse_CrowdTriggers(CCT_BsG_CTZN_Talk_037_635c15f9-34cc-4789-9367-f522718d9c66);
DB_LOW_CountingHouse_CrowdTriggers(CCT_BsG_CTZN_TalkREAC_037_923f96c4-fdc0-4dc0-8378-77909aa231e3);
DB_LOW_CountingHouse_CrowdTriggers(CCT_ELFout_CTZN_Talk_003_78faad81-3daa-46b7-87b1-c2f372d5564d);
DB_LOW_CountingHouse_CrowdTriggers(CCT_ELFout_CTZN_TalkREAC_003_f84c0bb9-f0b9-4e42-939a-80862e933426);
//END_REGION

//REGION Alarm
// Upper
DB_LOW_CountingHouse_AlarmTriggers(LOW_CountingHouse_AlarmTrigger_01_b3e441b6-20d5-4636-a020-f5f6eecb67c3,(FLAG)LOW_CountingHouse_State_AlarmTriggered_UpperArea_169ce3f4-8e11-4ac2-a3ac-30aafe5f41db,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_UPPERALARM_TRIGGER_558f4c12-c503-4c20-bed9-26adc3efcf35);
DB_LOW_CountingHouse_AlarmTriggers(LOW_CountingHouse_AlarmTrigger_02_043185d3-8847-483b-8489-4e4836609709,(FLAG)LOW_CountingHouse_State_AlarmTriggered_UpperArea_169ce3f4-8e11-4ac2-a3ac-30aafe5f41db,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_UPPERALARM_TRIGGER_558f4c12-c503-4c20-bed9-26adc3efcf35);
DB_LOW_CountingHouse_AlarmTriggers(LOW_CountingHouse_AlarmTrigger_03_394efb40-9525-4cbd-ba1e-b331c66a65f9,(FLAG)LOW_CountingHouse_State_AlarmTriggered_UpperArea_169ce3f4-8e11-4ac2-a3ac-30aafe5f41db,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_UPPERALARM_TRIGGER_558f4c12-c503-4c20-bed9-26adc3efcf35);
DB_LOW_CountingHouse_AlarmTriggers(LOW_CountingHouse_AlarmTrigger_04_0f4f5c73-a7b6-448f-aa8a-22a4201c942e,(FLAG)LOW_CountingHouse_State_AlarmTriggered_UpperArea_169ce3f4-8e11-4ac2-a3ac-30aafe5f41db,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_UPPERALARM_TRIGGER_558f4c12-c503-4c20-bed9-26adc3efcf35);

//Lower
DB_LOW_CountingHouse_AlarmTriggers(LOW_CountingHouse_AlarmTrigger_05_a50c346d-0130-4045-a813-3bb897f968a3,(FLAG)LOW_CountingHouse_State_AlarmTriggered_LowerArea_5635184f-98e9-438b-8b80-249d38ba07c3,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_LOWERALARM_TRIGGER_b76df365-15e5-4954-ae92-a7eadf76e13d);

//Docks
DB_LOW_CountingHouse_AlarmTriggers(LOW_CountingHouse_AlarmTrigger_06_59f7dc45-3380-452e-868e-ffa99da92f49,(FLAG)LOW_CountingHouse_State_AlarmTriggered_DocksArea_1d666df4-54b5-4d44-b28a-f67f4c769888,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_DOCKSALARM_TRIGGER_c24e747b-2d7c-44b5-bf3c-1425b4650313);
DB_LOW_CountingHouse_AlarmTriggers(LOW_CountingHouse_AlarmTrigger_07_65b761b3-0fdd-4aa1-b73d-c7ed6eb5e8b2,(FLAG)LOW_CountingHouse_State_AlarmTriggered_DocksArea_1d666df4-54b5-4d44-b28a-f67f4c769888,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_DOCKSALARM_TRIGGER_c24e747b-2d7c-44b5-bf3c-1425b4650313);
DB_LOW_CountingHouse_AlarmTriggers(LOW_CountingHouse_AlarmTrigger_08_7af1db03-977c-4eb4-9548-c65e33a62c96,(FLAG)LOW_CountingHouse_State_AlarmTriggered_DocksArea_1d666df4-54b5-4d44-b28a-f67f4c769888,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_DOCKSALARM_TRIGGER_c24e747b-2d7c-44b5-bf3c-1425b4650313);
DB_LOW_CountingHouse_AlarmTriggers(LOW_CountingHouse_AlarmTrigger_09_fbb96ef4-1d00-473b-bc2a-656a6cf5c89d,(FLAG)LOW_CountingHouse_State_AlarmTriggered_DocksArea_1d666df4-54b5-4d44-b28a-f67f4c769888,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_DOCKSALARM_TRIGGER_c24e747b-2d7c-44b5-bf3c-1425b4650313);

DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_01_316f2520-fe74-4287-869b-88eea90c983d);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_02_4316b95f-6624-4601-bceb-bdddb8e0ba62);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_03_474ad061-b260-4866-bcea-64ec99e29968);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_04_8e3c3b8b-a809-4423-8cf6-cea702b070ec);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_05_400c9176-b9b5-448c-a283-156b15125eec);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_06_ae3168fe-dd18-421b-aa51-4d86d1245871);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_07_52504043-35b8-47ec-8ea4-4ac40593654e);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_08_e4ff4283-9c1c-4fd7-8e7c-b7fa27b789a8);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_09_0aadf193-523e-40ef-80b6-fcfd5e56143f);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_10_600ae933-d6d3-443f-b400-8ed440874ff6);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_11_b2e920a0-0ca6-463c-beed-6fee81a6bb0b);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_12_4ed00592-af13-4eb4-8bfc-e337135b8b87);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_Guard_13_9bbb4f10-bbb8-4fd5-a38a-55581bc2c3c9);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_LobbyMainGuard_812a2565-3c84-4c47-9255-5d66d840ede4);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_LobbyStairsGuard_33446759-12f2-41ed-aba7-4a4f4408c5fe);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_LobbyWarningGuard_cbfc2698-d7bc-403c-a861-8c9dbdec010b);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_VaultButtonGuard_41a0b028-9e14-4781-8a06-cb3cb8a9ee4f);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_VaultMainGuard_936953b6-059b-4ed6-b03a-5d1b340f8889);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_VaultWarningGuard_b07c79ad-9c9c-4131-a7c2-70e898e5e984);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_HeadBankerOfficeGuard_6cf1730a-50af-49e2-b7f4-1ff52d448071);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_HeadClerkOfficeGuard_f5d6f408-f7d0-4d36-aef9-44e578727fd9);
// The docks CH steelwatchers are added in the DB so follow the same combat join pipeline as the cashguards
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_DockWatchers_000_63ec5f56-a13a-4666-b571-59a97a53273f);
DB_LOW_CountingHouse_Guards(S_LOW_CountingHouse_DockWatchers_001_be738280-ad00-43d7-b8f8-71163f4c9c24);

DB_LOW_CountingHouse_DocksGuards(S_LOW_CountingHouse_Guard_07_52504043-35b8-47ec-8ea4-4ac40593654e);
DB_LOW_CountingHouse_DocksGuards(S_LOW_CountingHouse_Guard_05_400c9176-b9b5-448c-a283-156b15125eec);
DB_LOW_CountingHouse_DocksGuards(S_LOW_CountingHouse_Guard_12_4ed00592-af13-4eb4-8bfc-e337135b8b87);
DB_LOW_CountingHouse_DocksGuards(S_LOW_CountingHouse_Guard_13_9bbb4f10-bbb8-4fd5-a38a-55581bc2c3c9);
DB_LOW_CountingHouse_DocksGuards(S_LOW_CountingHouse_Guard_06_ae3168fe-dd18-421b-aa51-4d86d1245871);
DB_LOW_CountingHouse_DocksGuards(S_LOW_CountingHouse_Guard_08_e4ff4283-9c1c-4fd7-8e7c-b7fa27b789a8);
DB_LOW_CountingHouse_DocksGuards(S_LOW_CountingHouse_Guard_04_8e3c3b8b-a809-4423-8cf6-cea702b070ec);
DB_LOW_CountingHouse_DocksGuards(S_LOW_CountingHouse_Guard_11_b2e920a0-0ca6-463c-beed-6fee81a6bb0b);

DB_LOW_CountingHouse_GuardCombatADs(S_LOW_CountingHouse_Guard_04_8e3c3b8b-a809-4423-8cf6-cea702b070ec,(DIALOGRESOURCE)LOW_CountingHouse_AD_Guard_04_CombatStart_b9d76617-2f4a-fadc-4abb-8ce13811bcfa,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_CountingHouse_GuardCombatADs(S_LOW_CountingHouse_Guard_06_ae3168fe-dd18-421b-aa51-4d86d1245871,LOW_CountingHouse_AD_Guard_06_CombatStart_f60260fd-6e11-4bf1-a2cf-070e1967a691,NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_CountingHouse_GuardCombatADs(S_LOW_CountingHouse_LobbyMainGuard_812a2565-3c84-4c47-9255-5d66d840ede4,LOW_CountingHouse_AD_LobbyMainGuard_CombatStart_c6470559-ab4f-7744-5c8f-b9a5c525e997,NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_CountingHouse_GuardCombatADs(S_LOW_CountingHouse_VaultMainGuard_936953b6-059b-4ed6-b03a-5d1b340f8889,LOW_CountingHouse_AD_VaultMainGuard_CombatStart_8eaad542-f79c-e874-0573-5e809fc54867,NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_CountingHouse_GuardCombatADs(S_LOW_CountingHouse_HeadBankerOfficeGuard_6cf1730a-50af-49e2-b7f4-1ff52d448071,LOW_CountingHouse_AD_HeadBankerOfficeGuard_Alarm_98a636ca-a163-499a-bf7d-d1afa02b0033,LOW_CountingHouse_State_AlarmTriggered_UpperArea_169ce3f4-8e11-4ac2-a3ac-30aafe5f41db);
DB_LOW_CountingHouse_GuardCombatADs(S_LOW_CountingHouse_Guard_05_400c9176-b9b5-448c-a283-156b15125eec,LOW_CountingHouse_AD_Guard_05_Alarm_985495a7-ed76-e02d-c5be-d600ca678e69,LOW_CountingHouse_State_AlarmTriggered_DocksArea_1d666df4-54b5-4d44-b28a-f67f4c769888);
DB_LOW_CountingHouse_GuardCombatADs(S_LOW_CountingHouse_Guard_07_52504043-35b8-47ec-8ea4-4ac40593654e,LOW_CountingHouse_AD_Guard_07_Alarm_3bb8b173-de37-3efc-b9c8-74be71eb47b0,LOW_CountingHouse_State_AlarmTriggered_DocksArea_1d666df4-54b5-4d44-b28a-f67f4c769888);
DB_LOW_CountingHouse_GuardCombatADs(S_LOW_CountingHouse_LobbyWarningGuard_cbfc2698-d7bc-403c-a861-8c9dbdec010b,LOW_CountingHouse_AD_LobbyWarningGuard_Alarm_ecd9dab9-d8b3-27d4-e79c-c94e6b0507f8,LOW_CountingHouse_State_AlarmTriggered_UpperArea_169ce3f4-8e11-4ac2-a3ac-30aafe5f41db);
DB_LOW_CountingHouse_GuardCombatADs(S_LOW_CountingHouse_VaultWarningGuard_b07c79ad-9c9c-4131-a7c2-70e898e5e984,LOW_CountingHouse_AD_VaultWarningGuard_Alarm_b5e22db6-c60e-1b03-bf68-ecc6fa7ca44b,LOW_CountingHouse_State_AlarmTriggered_LowerArea_5635184f-98e9-438b-8b80-249d38ba07c3);

NOT DB_LOW_CountingHouse_HostileGuards((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000);

// When alarm goes off in any area, the global counting house alarm state flag is set, primarily affects NPC behaviors
DB_LOW_CountingHouse_AlarmFlagsByArea((FLAG)LOW_CountingHouse_State_AlarmTriggered_UpperArea_169ce3f4-8e11-4ac2-a3ac-30aafe5f41db);
DB_LOW_CountingHouse_AlarmFlagsByArea((FLAG)LOW_CountingHouse_State_AlarmTriggered_LowerArea_5635184f-98e9-438b-8b80-249d38ba07c3);
DB_LOW_CountingHouse_AlarmFlagsByArea((FLAG)LOW_CountingHouse_State_AlarmTriggered_DocksArea_1d666df4-54b5-4d44-b28a-f67f4c769888);

PROC_TriggerRegisterForParty((TRIGGER)S_LOW_CountingHouse_DocksGuardsActivation_Trigger_d78edace-4ccc-4872-a9ea-208a6e5a3353);
//END_REGION

//REGION Pre-vault trap
DB_LOW_CountingHouse_PressurePlates(S_LOW_CountingHouse_VaultPressurePlate_01_ad94350c-aa9f-4d4c-ab92-cf77c64bb4c3);
DB_LOW_CountingHouse_PressurePlates(S_LOW_CountingHouse_VaultPressurePlate_02_2cab6a92-7c09-4207-88c1-c217bcc90fff);
DB_LOW_CountingHouse_PressurePlates(S_LOW_CountingHouse_VaultPressurePlate_03_2fa315ed-3e94-4b1f-9ec5-a7355eb5d5a4);
DB_LOW_CountingHouse_PressurePlates(S_LOW_CountingHouse_VaultPressurePlate_04_5f81e628-8a27-40e7-b8f7-53c51cd05733);

DB_LOW_CountingHouse_VaultCheckpointGates((ITEM)S_LOW_CountingHouse_VaultCheckpointGate_01_78a36f2a-72c3-46f2-b8ac-fc1c5e931ad9);
DB_LOW_CountingHouse_VaultCheckpointGates((ITEM)S_LOW_CountingHouse_VaultCheckpointGate_02_d7ea217e-dfa4-4f1e-ba13-007b4edee69c);
//END_REGION

//REGION Greatdoor pincode
Lock(S_LOW_CountingHouse_GreatDoor_97933ead-8014-4241-8d83-477e658d9b44, "NOKEY");
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_CountingHouse_GreatDoor_QuestUpdate_Trigger_3388109d-41a3-4530-a847-0f6c1e5c7121);
//END_REGION

//REGION Heist
DB_DropMutingStatussesDialog(LOW_CountingHouse_Heist_63210311-4b3b-85e3-7278-2032e2a65bd7);
DB_AddCharactersInTriggerToDialog(LOW_CountingHouse_Heist_63210311-4b3b-85e3-7278-2032e2a65bd7,S_LOW_CountingHouse_HeistDialogTrigger_feec2762-07b3-42c8-ae7f-57df907e74c0,1,1,1,1);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_CountingHouse_State_RobbersEscaped_16197488-9cc2-48e2-94ae-36225025d4d8, (DIALOGRESOURCE)LOW_CountingHouse_Heist_63210311-4b3b-85e3-7278-2032e2a65bd7);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_CountingHouse_HeistDialogTrigger_feec2762-07b3-42c8-ae7f-57df907e74c0);

// Preventing disturbances from interrupting the heist dialog
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_PrivateGuard_01_2eb23f41-9a39-4b28-b2e5-3409f6669b70,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_PrivateGuard_02_ff490513-7296-4512-8040-239f9e824f2b,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_PrivateGuard_03_459e4fa3-c9f3-478a-ba56-e09431674e32,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_Cultist_01_6217b97e-3715-4e88-ae20-7ba1aa9da1aa,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_Cultist_02_464de2ba-ac0b-4fa8-bfa5-d8349ccbebf8,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_Cultist_03_73841985-c531-4a81-bab5-cc0b8abf3646,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_Cultist_04_725e41cf-6e8c-4b64-be4d-6932c07b3d7b,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_Cultist_05_5149176e-da37-4711-82a7-840d58584d95,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_Cultist_06_a8a1085b-5c59-4acc-84b4-0c7769b1acda,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_Cultist_07_5033cfd8-064b-4f32-95f4-480a25ef5e7d,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_Cultist_08_1011469c-7cf8-4aa2-9b1e-86f68ee9bdba,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047,"LOW_CountingHouse_HeistScene");
DB_SceneManager((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,"LOW_CountingHouse_HeistScene");
DB_SceneNoHostileContinuousDisturbance("LOW_CountingHouse_HeistScene");

// Rakath's guards turn into tadpoled guards in case smuggler's cave shipment makes it into the city
DB_LOW_CountingHouseTadpoledGuards(S_LOW_CountingHouse_PrivateGuard_01_2eb23f41-9a39-4b28-b2e5-3409f6669b70,(DIALOGRESOURCE)LOW_CountingHouse_AD_PrivateGuard_01_TadpoledBetrayal_a3aa8a4f-bc55-0433-b6f2-b78ae1992ef6);
DB_LOW_CountingHouseTadpoledGuards(S_LOW_CountingHouse_PrivateGuard_03_459e4fa3-c9f3-478a-ba56-e09431674e32,(DIALOGRESOURCE)LOW_CountingHouse_AD_PrivateGuard_03_TadpoledBetrayal_75c6f8b2-de52-c506-7eef-14f09cef4c66);

DB_GLO_FireBowls(S_LOW_CountingHouse_VaultChandelier_01_068d9fad-a909-47ab-b2f7-2ce0acc2097b,S_LOW_CountingHouse_VaultChandelierHinge_01_e252f579-fb4c-4a25-ae06-81687e841198);
DB_GLO_FireBowls(S_LOW_CountingHouse_VaultChandelier_02_9e592e80-915b-48c4-95c1-6367ad8ce932,S_LOW_CountingHouse_VaultChandelierHinge_02_27a49a7d-956d-48b4-b9d3-f7fb0d038470);
DB_GLO_FireBowls(S_LOW_CountingHouse_VaultChandelier_03_237ae66e-71a2-4b7d-8715-deb24ebdd4f2,S_LOW_CountingHouse_VaultChandelierHinge_03_3d7305ed-30e3-4298-91bc-fdd1a1a815d7);
DB_GLO_FireBowls(S_LOW_CountingHouse_VaultChandelier_04_974a1ee7-0771-45a7-8864-4ac0a33e8ffd,S_LOW_CountingHouse_VaultChandelierHinge_04_e6eb9ee4-ec31-49dd-ae8d-6de3053db3b9);
DB_GLO_FireBowls(S_LOW_CountingHouse_VaultChandelier_05_0fc1b292-dfb3-4755-a365-0aacbc318db7,S_LOW_CountingHouse_VaultChandelierHinge_05_c6306fbd-3cf4-4c0e-8ca6-a75511ce8861);
DB_GLO_FireBowls(S_LOW_CountingHouse_VaultChandelier_06_99ca6ef2-15f4-4a69-ad1d-207c0fad7b5e,S_LOW_CountingHouse_VaultChandelierHinge_06_862979ad-1d59-4cab-97fa-143974ff922b);

DB_GLO_FireBowls(LTS_DUN_Chandelier_C_Gold_001_eb1ddd1e-2d3d-465b-883e-67c4c1f81635,LTS_DUN_Chandelier_Hinge_A_Gold_000_42106fb4-7c19-494b-90e2-0773a0598c48);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_003_60114cfa-8adf-473a-9fef-6554f939ab81,LTS_DUN_Chandelier_Hinge_A_003_fb62f17a-eeef-48c9-8538-0d6680562caf);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_006_c8e561f0-6ea6-4e40-abca-bb8a2bdea79c,LTS_DUN_Chandelier_Hinge_A_007_872b81f4-8619-4f92-8b08-48d3857695ff);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_014_6aaea354-37d9-4906-9422-94ea67193061,LTS_DUN_Chandelier_Hinge_A_015_aecac2f6-e7ab-4b8e-9424-c285a5467c0f);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_015_e19c89e1-df15-48f5-b455-1cacd1a34ee7,LTS_DUN_Chandelier_Hinge_A_016_69361c38-813e-4402-ab03-1736285a4ff2);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_016_7df33aa9-e785-4b70-afbe-e9124fafc62e,LTS_DUN_Chandelier_Hinge_A_017_6516fa48-f38e-4b0a-ade1-f0b2926ccf96);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_021_be5b9ae4-80a2-45fe-a5ff-1fca2812738a,LTS_DUN_Chandelier_Hinge_A_008_14f0c041-a50e-4f2c-8e5e-54c9bfa822c2);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_019_2a01d65d-af4a-48a9-90ea-b6c8b9a03486,LTS_DUN_Chandelier_Hinge_A_020_bca1039f-5a07-40de-b3b2-eb600efa6d4b);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_020_862260c1-410f-4cb7-bc1e-61e1d079a31e,LTS_DUN_Chandelier_Hinge_A_021_08bc0803-0abe-4ced-a3a1-8f4725eb7ff1);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_017_e8aff108-2f6f-43af-b453-3724da3a75ad,LTS_DUN_Chandelier_Hinge_A_018_86ae1cdb-6f98-4505-a909-15ca750fa82e);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_018_66e43793-c66d-4404-9282-ac70abc2737a,LTS_DUN_Chandelier_Hinge_A_019_5902b8f3-8de5-4a2d-97ac-24f46ed736f2);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_997bda72-8539-498a-ab3c-8410450d3523,LTS_DUN_Chandelier_Hinge_A_f1d480db-f57e-4c06-977f-69a75da64c0a);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_e3ad3f6c-d54c-4050-9c04-89a1e9c5d313,LTS_DUN_Chandelier_Hinge_A_79c1e9fe-90aa-4f34-88db-295b02294375);
DB_GLO_FireBowls(LTS_DUN_Chandelier_A_e6dfe494-1355-470a-afb0-b6f96322e246,LTS_DUN_Chandelier_Hinge_A_ca8308fa-5725-4e73-9640-4e41f3448a71);
DB_GLO_FireBowls(LTS_DUN_Chandelier_A_2b4b453d-70ec-4681-85a3-fd35fd0b2ebb,LTS_DUN_Chandelier_Hinge_A_09328878-6e9f-48b6-b3ee-4210734eac08);

DB_Inclusion_Object((CHARACTER)S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57, (FLAG)LOW_CountingHouse_HeadBanker_StartInclusion_411daf88-be9b-4324-a190-631554c772df, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_CountingHouse_AD_PrivateGuard_01_TadpoledBetrayal_a3aa8a4f-bc55-0433-b6f2-b78ae1992ef6, (CHARACTER)S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_CountingHouse_AD_PrivateGuard_03_TadpoledBetrayal_75c6f8b2-de52-c506-7eef-14f09cef4c66, (CHARACTER)S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57);
DB_Inclusion_CombatInclusionDialog(LOW_CountingHouse_AD_PrivateGuard_01_TadpoledBetrayal_a3aa8a4f-bc55-0433-b6f2-b78ae1992ef6);
DB_Inclusion_CombatInclusionDialog(LOW_CountingHouse_AD_PrivateGuard_03_TadpoledBetrayal_75c6f8b2-de52-c506-7eef-14f09cef4c66);

Open((ITEM)S_LOW_CountingHouse_MainVaultDoor_3e4c5392-cde5-4c76-9ff1-906a89c7b82e);
//END_REGION

//REGION Post-heist
DB_Dialogs((CHARACTER)S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57, (DIALOGRESOURCE)LOW_CountingHouse_HeadBanker_3b0c163a-75ac-8ca3-e5da-0b0ea40245df);
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_CountingHouse_HeadBanker_3b0c163a-75ac-8ca3-e5da-0b0ea40245df, 10000);
DB_DialogMoneyTransfer(2, (DIALOGRESOURCE)LOW_CountingHouse_HeadBanker_3b0c163a-75ac-8ca3-e5da-0b0ea40245df, 5000);
DB_HasItemEvent((ITEM)S_LOW_CountingHouse_Vault9_Key_54d5b4f3-2bf3-47b5-8bb5-19e976a821e6,(FLAG)LOW_CountingHouse_State_HasItem_Vault9_Key_e9dd1023-229d-4f7c-b782-bc110a71cac7);
DB_GiveItemToEvent((ITEM)S_LOW_CountingHouse_Vault9_Key_54d5b4f3-2bf3-47b5-8bb5-19e976a821e6,(FLAG)LOW_CountingHouse_Give_Vault9_Key_c753a313-bc7a-47da-b36f-8c25201460ef);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57,(DIALOGRESOURCE)LOW_CountingHouse_SwD_HeadBanker_e8c3ab5d-a860-0beb-0e3b-97ff51d055d6);

// SwD on a Minsc follower that provides a hint to the Abandoned Cistern
DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_CountingHouse_Cultist_01_6217b97e-3715-4e88-ae20-7ba1aa9da1aa,(DIALOGRESOURCE)LOW_CountingHouse_SwD_Cultist_01_fb6dbd63-8473-9852-40d1-7ac201438396);

// TODO: Should be disabled when players find the hiedout in the Abandoned Cistern
DB_KnowledgeCheckTrigger_AD("LOW_CountingHouse_SewersFootprints", (TRIGGER)S_LOW_CountingHouse_SewersFootprintsPAD_Trigger_e7e9ff7b-f348-4687-989b-dac70df268ae, "Perception", (DIFFICULTYCLASS)Act3_Easy_5028066b-6ea0-4a6a-9e3e-53bee62559a7, (DIALOGRESOURCE)LOW_CountingHouse_PAD_SewersFootprints_d81df646-c0ab-89e2-83d1-10fc28844138, (FLAG)LOW_CountingHouse_State_SewersFootprintsNoticed_4ad12790-7fbf-49db-a394-0b6526c3249e);

DB_HasItemEvent((ITEM)S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d, (FLAG)LOW_CountingHouse_State_HasStolenGoldBag_161d3097-c4bf-48f0-8f77-d3e72645a5ca);
// Not used, need to be cut when get confirmation why these were added
DB_GiveItemToEvent((ITEM)S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d, (FLAG)LOW_CountingHouse_Event_GiveStolenGoldBag_81143539-2772-4d94-8026-56852035f84f);
//END_REGION

//REGION VIP Vaults
DB_LOW_CountingHouse_VipVaults((ITEM)S_LOW_CountingHouse_Vault1_a7062175-0a33-4ad4-a171-fc68270fd282,"LOW_CountingHouse_VipVault_1");
DB_LOW_CountingHouse_VipVaults(S_LOW_CountingHouse_Vault2_eacbddbe-676a-4b5e-8e95-338de36dc10a,"LOW_CountingHouse_VipVault_2");
DB_LOW_CountingHouse_VipVaults(S_LOW_CountingHouse_Vault3_b0df3609-7395-48cc-a419-63e8172629d8,"LOW_CountingHouse_VipVault_3");
DB_LOW_CountingHouse_VipVaults(S_LOW_CountingHouse_Vault4_30123146-fdf6-44bf-9821-4303a55cef2d,"LOW_CountingHouse_VipVault_4");
DB_LOW_CountingHouse_VipVaults(S_LOW_CountingHouse_Vault5_859ec79c-8f81-44e1-b044-bc834cf33acc,"LOW_CountingHouse_VipVault_5");
DB_LOW_CountingHouse_VipVaults(S_LOW_CountingHouse_Vault6_781145ae-8a72-4396-9651-18695ad12d38,"LOW_CountingHouse_VipVault_6");
DB_LOW_CountingHouse_VipVaults(S_LOW_CountingHouse_Vault7_2b274efa-0dab-47cf-bd79-c70110e54e96,"LOW_CountingHouse_VipVault_7");
DB_LOW_CountingHouse_VipVaults(S_LOW_CountingHouse_Vault8_b9e1344b-1bb3-455f-83f0-338c5fa153d8,"LOW_CountingHouse_VipVault_8");
DB_LOW_CountingHouse_VipVaults(S_LOW_CountingHouse_Vault9_6ba6a3cd-56ef-410a-a2b3-508fbde47e55,"");
//END_REGION

//REGION LOW_RecoverRakathsGold Quest
DB_QuestDef_State((FLAG)LOW_CountingHouse_State_HeadBankerAskedForGoldBack_437bb802-772b-43a2-b790-4f99f6d5ff86,"LOW_RecoverRakathsGold","TalkedToRakath");

DB_QuestDef_BookReadState("LOW_RecoverRakathsGold","FoundSewersClue_ReadCultistsNote",(ITEM)S_LOW_CountingHouse_SewersHint_Note_f36b85d7-0140-4c51-b7e6-3fa10e798ed1);
DB_QuestDef_State((FLAG)LOW_CountingHouse_State_SewersFootprintsNoticed_4ad12790-7fbf-49db-a394-0b6526c3249e,"LOW_RecoverRakathsGold","FoundSewersClue_FootprintsPAD");
DB_QuestDef_State((FLAG)LOW_CountingHouse_Knows_StoneLordLairLocationSWDCultist_6cf33895-c356-af3c-7deb-5f2eafc0ebb5, "LOW_RecoverRakathsGold", "FoundSewersClue_SpokeWithDeadCultist");

DB_LOW_KnowsStolenGoldInSewers_QuestUpdates("FoundSewersClue_ReadCultistsNote");
DB_LOW_KnowsStolenGoldInSewers_QuestUpdates("FoundSewersClue_FootprintsPAD");
DB_LOW_KnowsStolenGoldInSewers_QuestUpdates("FoundSewersClue_SpokeWithDeadCultist");

DB_LOW_ZhentLeaderReceivedStolenGold_QuestStep(S_GOB_Quartermaster_646936f3-8d8d-484e-9361-cd1ed484c615,"SawGoldHandover_Roah");
DB_LOW_ZhentLeaderReceivedStolenGold_QuestStep(S_LOW_Guildhall_Zhent_Leader_b7e51fc3-0788-44f2-add7-1714f2b9b6d9,"SawGoldHandover_Friol");

DB_LOW_ZhentLeaderEscapedGoldHandover_QuestStep(S_GOB_Quartermaster_646936f3-8d8d-484e-9361-cd1ed484c615,"ZhentLeaderEscaped_Roah");
DB_LOW_ZhentLeaderEscapedGoldHandover_QuestStep(S_LOW_Guildhall_Zhent_Leader_b7e51fc3-0788-44f2-add7-1714f2b9b6d9,"ZhentLeaderEscaped_Friol");

DB_LOW_ZhentLeaderPermaDefeatedWithGold_QuestStep(S_GOB_Quartermaster_646936f3-8d8d-484e-9361-cd1ed484c615,"ZhentLeaderPermaDefeated_Roah",(FLAG)LOW_Guildhall_State_ZhentLeaderRoah_PermaDefeated_44aa8b1e-14d0-4dc1-825c-a8f46155e0aa);
DB_LOW_ZhentLeaderPermaDefeatedWithGold_QuestStep(S_LOW_Guildhall_Zhent_Leader_b7e51fc3-0788-44f2-add7-1714f2b9b6d9,"ZhentLeaderPermaDefeated_Friol",(FLAG)LOW_Guildhall_State_ZhentLeaderFriol_PermaDefeated_3362ce9b-32c1-4751-84a4-ada8274d1e05);

DB_QuestDef_PermaDefeatedState("LOW_RecoverRakathsGold","RakathPermaDefeated",(CHARACTER)S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57);
//END_REGION
KBSECTION
//REGION Head Clerk
IF
FlagSet((FLAG)LOW_CountingHouse_Event_GiveSafeKey_50bbe524-a8bf-0941-7a2f-2f2fdf80b357,_,_)
THEN
SetFlag((FLAG)LOW_CountingHouse_State_HeadClerkGaveSafeKey_908b4ca3-c78d-4afc-b92f-1c936174f9ff);

IF
FlagSet((FLAG)LOW_CountingHouse_Event_GiveBankPass_a42bbf4c-621e-25ef-48f7-1696d5c3baee,_,_)
THEN
ClearOwnership((ITEM)S_LOW_CountingHouse_LobbyDoor_d7f5f3a6-5a83-4b2f-a217-c4172a6ad67c);
SetFlag((FLAG)LOW_CountingHouse_State_HeadClerkGavePass_bc3d6237-d027-479c-b965-d1b469552e61);
//END_REGION

//REGION Guards
// Lobby
IF
FlagSet((FLAG)LOW_CountingHouse_State_PassedLobbyCheckpoint_085b0568-d4e7-72f4-9281-712589a0733c,_,_)
THEN
ClearOwnership((ITEM)S_LOW_CountingHouse_LobbyDoor_d7f5f3a6-5a83-4b2f-a217-c4172a6ad67c);
PROC_RemoveDBTrespassTrigger((TRIGGER)S_LOW_CountingHouse_RestrictedAreaTrespass_Trigger_8d239901-9f60-46ca-8774-2aab55b715c3);

PROC
PROC_CheckPointDialogue(_Player, S_LOW_CountingHouse_LobbyMainGuard_812a2565-3c84-4c47-9255-5d66d840ede4)
AND
QRY_StartCheckpointWarningDialog("LOW_CountingHouse_LobbyCheckpoint", (DIALOGRESOURCE)LOW_CountingHouse_LobbyMainGuard_a33eb524-fb4f-a9fb-32cf-add13b80bf05, S_LOW_CountingHouse_LobbyMainGuard_812a2565-3c84-4c47-9255-5d66d840ede4, _Player)
THEN
DB_NOOP(1);

PROC
PROC_CheckPointDialogue(_Player, S_LOW_CountingHouse_LobbyWarningGuard_cbfc2698-d7bc-403c-a861-8c9dbdec010b)
AND
QRY_StartCheckpointWarningDialog("LOW_CountingHouse_LobbyCheckpoint", (DIALOGRESOURCE)LOW_CountingHouse_LobbyWarningGuard_b7998a64-d240-bab5-36a4-9e415ec65db4, S_LOW_CountingHouse_LobbyWarningGuard_cbfc2698-d7bc-403c-a861-8c9dbdec010b, _Player)
THEN
DB_NOOP(1);

// Vault checkpoint dialogs. In case the first permission wasn't granted, the normal CH trespassing dialog will be triggered when players are spotted
PROC
PROC_CheckPointDialogue(_Player, S_LOW_CountingHouse_VaultMainGuard_936953b6-059b-4ed6-b03a-5d1b340f8889)
AND
DB_GlobalFlag((FLAG)LOW_CountingHouse_State_PassedLobbyCheckpoint_085b0568-d4e7-72f4-9281-712589a0733c)
AND
QRY_StartCheckpointWarningDialog("LOW_CountingHouse_VaultCheckpoint", (DIALOGRESOURCE)LOW_CountingHouse_VaultGuard_d3e8107f-e747-635b-5922-d99ad2b3d4aa, S_LOW_CountingHouse_VaultMainGuard_936953b6-059b-4ed6-b03a-5d1b340f8889, _Player)
THEN
DB_NOOP(1);

PROC
PROC_CheckPointDialogue(_Player, S_LOW_CountingHouse_VaultWarningGuard_b07c79ad-9c9c-4131-a7c2-70e898e5e984)
AND
DB_GlobalFlag((FLAG)LOW_CountingHouse_State_PassedLobbyCheckpoint_085b0568-d4e7-72f4-9281-712589a0733c)
AND
QRY_StartCheckpointWarningDialog("LOW_CountingHouse_VaultCheckpoint", (DIALOGRESOURCE)LOW_CountingHouse_VaultWarningGuard_efcd5154-549a-7e15-0827-12c3cc67c77d, S_LOW_CountingHouse_VaultWarningGuard_b07c79ad-9c9c-4131-a7c2-70e898e5e984, _Player)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)LOW_CountingHouse_State_ShowedPassToGuard_bccc2492-e00e-4d1d-9f65-c96e5dc04819,_Guard,_)
AND
DB_LOW_VaultCheckpointGuards(_Guard)
THEN
SetFlag((FLAG)LOW_CountingHouse_State_PassedVaultCheckpoint_b67acf0a-5a0e-f363-293e-d913b5bce599);
SetFlag((FLAG)LOW_CountingHouse_State_PassedLobbyCheckpoint_085b0568-d4e7-72f4-9281-712589a0733c);

IF
FlagSet((FLAG)LOW_CountingHouse_State_ShowedPassToGuard_bccc2492-e00e-4d1d-9f65-c96e5dc04819,_Guard,_)
AND
NOT DB_LOW_VaultCheckpointGuards(_Guard)
THEN
SetFlag((FLAG)LOW_CountingHouse_State_PassedLobbyCheckpoint_085b0568-d4e7-72f4-9281-712589a0733c);

// Custom crime Warning AD for cashguards
IF
DB_Dialogs(_Char,_Dialog)
AND
IsTagged(_Char,(TAG)ACT3_LOW_COUNTINGHOUSE_CASHGUARD_b5a316ac-921c-4884-9a2c-8fd05c64c64b,1)
THEN
DB_CrimeType_CustomWarning((CHARACTER)_Char,"UseForbiddenItem",(DIALOGRESOURCE)LOW_NGB_CountingHouse_UseForbiddenItem_d709bf80-b240-53e5-5c57-81b707c1f771);

IF
DialogEnded(LOW_CountingHouse_LobbyMainGuard_a33eb524-fb4f-a9fb-32cf-add13b80bf05,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_CountingHouse_State_PassedLobbyCheckpoint_085b0568-d4e7-72f4-9281-712589a0733c)
THEN
PROC_GlobalSetFlagAndCache(LOW_CountingHouse_Knows_VaultPassNeeded_c7d3b140-c5d8-4429-98f3-05c87c969426);

IF
FlagSet((FLAG)LOW_CountingHouse_State_PassedLobbyCheckpoint_085b0568-d4e7-72f4-9281-712589a0733c,_,_)
THEN
PROC_PeacefulResolve((CHARACTER)S_LOW_CountingHouse_LobbyMainGuard_812a2565-3c84-4c47-9255-5d66d840ede4);
PROC_PeacefulResolve((CHARACTER)S_LOW_CountingHouse_LobbyWarningGuard_cbfc2698-d7bc-403c-a861-8c9dbdec010b);

IF
FlagSet((FLAG)LOW_CountingHouse_State_PassedVaultCheckpoint_b67acf0a-5a0e-f363-293e-d913b5bce599,_,_)
THEN
PROC_PeacefulResolve((CHARACTER)S_LOW_CountingHouse_VaultMainGuard_936953b6-059b-4ed6-b03a-5d1b340f8889);
PROC_PeacefulResolve((CHARACTER)S_LOW_CountingHouse_VaultWarningGuard_b07c79ad-9c9c-4131-a7c2-70e898e5e984);
PROC_PeacefulResolve((CHARACTER)S_LOW_CountingHouse_VaultButtonGuard_41a0b028-9e14-4781-8a06-cb3cb8a9ee4f);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_CountingHouse_State_FailedProbingHeadClerkThoughts_37efa7dd-df3f-4df2-bfbf-cc1c788f4207)
AND
DB_LOW_CountingHouse_Guards(_Guard)
AND
NOT DB_LOW_CountingHouse_HostileGuards(_Guard)
AND
GetDistanceTo(S_LOW_CountingHouse_HeadClerk_14f97819-1e07-4758-9ca8-d7802c610c43,_Guard,_Dist)
AND
_Dist <= 20.0
THEN
SetFaction(_Guard,(FACTION)ACT3_LOW_CountingHouse_HostileGuards_c58d9d05-9dff-4a1a-9c14-21c703671c41);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_CountingHouse_State_FailedProbingHeadClerkThoughts_37efa7dd-df3f-4df2-bfbf-cc1c788f4207)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CountingHouse_State_CiviliansPanicked_67cadb20-00fc-4015-9771-600132b67ecb);
//END_REGION

//REGION Vault Checkpoint
// TODO: Refactor this once Constellations are available - this is a whitebox prototype
IF
FlagSet((FLAG)LOW_CountingHouse_State_PassedVaultCheckpoint_b67acf0a-5a0e-f363-293e-d913b5bce599,_,_)
THEN
Use((CHARACTER)S_LOW_CountingHouse_VaultButtonGuard_41a0b028-9e14-4781-8a06-cb3cb8a9ee4f, (ITEM)S_LOW_CountingHouse_VaultTrapDisarm_e38baa9a-44b3-4333-9943-0304b78825aa, 1, 1, "LOW_CountingHouse_GuardDeactivatedTrap");
ClearOwnership((ITEM)S_LOW_CountingHouse_VaultCheckpointGate_02_d7ea217e-dfa4-4f1e-ba13-007b4edee69c);
ClearOwnership((ITEM)S_LOW_CountingHouse_VaultCheckpointGate_01_78a36f2a-72c3-46f2-b8ac-fc1c5e931ad9);

IF
DB_LOW_CountingHouse_VaultCheckpointGates(_Gate)
THEN
ClearOwnership(_Gate);
Unlock(_Gate);

// For debug of a visual bug on the doors, should be removed when fixed
IF
TextEvent("LOW_OpenCHGates")
AND
DB_LOW_CountingHouse_VaultCheckpointGates(_Gate)
THEN
Open(_Gate);

IF
DualEntityEvent(_, _, "LOW_CountingHouse_VaultCheckpointPressurePlateSteppedOn")
AND
NOT DB_GlobalFlag((FLAG)LOW_CountingHouse_State_VaultCheckpointTrapDisarmed_6f1f7cad-4ab8-48d2-8638-c5d1316f629f)
THEN
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000,S_LOW_CountingHouse_VaultGasPit_3ed00ed3-4595-4322-b525-a7139d89604b,"LOW_CountingHouse_VaultCheckpointTrapOn");
SetFlag((FLAG)LOW_CountingHouse_State_VaultCheckpointTrapTriggered_7a29cd4d-061a-4f7a-b362-a1db8cb26728);

IF
DualEntityEvent(_, S_LOW_CountingHouse_VaultTrapDisarm_e38baa9a-44b3-4333-9943-0304b78825aa,"LOW_CountingHouse_VaultCheckpointDisarm")
THEN
SetFlag((FLAG)LOW_CountingHouse_State_VaultCheckpointTrapDisarmed_6f1f7cad-4ab8-48d2-8638-c5d1316f629f);

IF
FlagSet((FLAG)LOW_CountingHouse_State_VaultCheckpointTrapTriggered_7a29cd4d-061a-4f7a-b362-a1db8cb26728,_,_)
AND
DB_LOW_CountingHouse_VaultCheckpointGates(_Gate)
THEN
Close(_Gate);
Lock(_Gate, "NOKEY");

IF
FlagSet((FLAG)LOW_CountingHouse_State_VaultCheckpointTrapTriggered_7a29cd4d-061a-4f7a-b362-a1db8cb26728,_,_)
AND
DB_LOW_CountingHouse_PressurePlates(_PressurePlate)
THEN
SetEntityEvent(_PressurePlate, "StoryReveal");

IF
FlagSet((FLAG)LOW_CountingHouse_State_VaultCheckpointTrapDisarmed_6f1f7cad-4ab8-48d2-8638-c5d1316f629f,_,_)
AND
DB_LOW_CountingHouse_VaultCheckpointGates(_Gate)
THEN
Unlock(_Gate);

IF
Unlocked((ITEM)_Gate, _, _)
AND
DB_LOW_CountingHouse_VaultCheckpointGates(_Gate)
THEN
Open(_Gate);

// Override (skip to combat) of Warning dialog for when CH guards spot players in prevault restricted area
QRY
QRY_CrimeGetCustomWarning(_Warner,"LOW_CountingHouse_Trespassing",_WarningDialog,_CrimeID)
AND
NOT DB_GlobalFlag((FLAG)LOW_CountingHouse_State_PassedVaultCheckpoint_b67acf0a-5a0e-f363-293e-d913b5bce599)
AND
DB_Players(_Player)
AND
CrimeGetCriminal(_CrimeID, 1, _Player)
AND
DB_InRegion(_Player,(TRIGGER)S_LOW_CountingHouse_VaultCheckpointTrespassTrigger_67fa23ed-df99-4bbe-a701-37a5a98d0bf0)
THEN
DB_CrimeWarning_Block(_Warner, "LOW_CountingHouse_Trespassing", _WarningDialog, 1);
PROC_MakeNPCHostile(_Warner,_Player);
//END_REGION

//REGION Cashguards open the vault trap in case it was triggered but any of the party members crossed it - works only in combat
IF
FlagSet((FLAG)LOW_CountingHouse_State_VaultCheckpointTrapTriggered_7a29cd4d-061a-4f7a-b362-a1db8cb26728,_,_)
THEN
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_CountingHouse_VaultTrapEscape_Trigger_2d5fd984-b4b3-4de1-bd32-9f9699996e83);

IF
FlagSet((FLAG)LOW_CountingHouse_State_VaultCheckpointTrapDisarmed_6f1f7cad-4ab8-48d2-8638-c5d1316f629f,_,_)
THEN
RemoveStatus(S_LOW_CountingHouse_VaultGasPit_3ed00ed3-4595-4322-b525-a7139d89604b,"LOW_COUNTINGHOUSE_AVOIDAREA_RADIUS4");
RemoveStatus(S_LOW_CountingHouse_InvisHelper_AIAvoidArea_b0039f0b-d236-4149-84bf-9d7bee9e3b43,"LOW_COUNTINGHOUSE_AVOIDAREA_RADIUS6");
PROC_TriggerUnregisterForParty((TRIGGER)S_LOW_CountingHouse_VaultTrapEscape_Trigger_2d5fd984-b4b3-4de1-bd32-9f9699996e83);

IF
FlagSet((FLAG)LOW_CountingHouse_State_VaultCheckpointTrapDisarmed_6f1f7cad-4ab8-48d2-8638-c5d1316f629f,_,_)
AND
IsTagged(S_LOW_CountingHouse_VaultTrapDisarm_e38baa9a-44b3-4333-9943-0304b78825aa,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_DISARMVAULTTRAP_b2d39cc2-21cb-4e3f-85a4-891490272916,1)
THEN
ClearTag(S_LOW_CountingHouse_VaultTrapDisarm_e38baa9a-44b3-4333-9943-0304b78825aa,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_DISARMVAULTTRAP_b2d39cc2-21cb-4e3f-85a4-891490272916);

IF
EnteredTrigger(_PartyMember,(TRIGGER)S_LOW_CountingHouse_VaultTrapEscape_Trigger_2d5fd984-b4b3-4de1-bd32-9f9699996e83)
AND
QRY_OnlyOnce("LOW_CountingHouse_SetDisarmVaultTrapAIHelper_OnlyOnce")
THEN
SetTag(S_LOW_CountingHouse_VaultTrapDisarm_e38baa9a-44b3-4333-9943-0304b78825aa,(TAG)ACT3_LOW_COUNTINGHOUSE_AI_DISARMVAULTTRAP_b2d39cc2-21cb-4e3f-85a4-891490272916);
//END_REGION

//REGION Counting House guards join combat in case they see other guards fighting OR a party member in combat with CH guard
IF
DB_Sees(_Guard1,_Guard2)
AND
DB_LOW_CountingHouse_Guards(_Guard1)
AND
DB_LOW_CountingHouse_Guards(_Guard2)
AND
DB_Is_InCombat(_Guard2,_CombatId)
THEN
PROC_LOW_CountingHouse_GuardSawGuardInCombat(_Guard1,_CombatId);

PROC
PROC_LOW_CountingHouse_GuardSawGuardInCombat((CHARACTER)_Guard,(GUIDSTRING)_CombatId)
AND
DB_LOW_CountingHouse_HostileGuards(_Guard)
AND
NOT DB_Is_InCombat(_Guard,_CombatId)
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember,_CombatId)
THEN
PROC_EnterCombat(_Guard,_PartyMember);

PROC
PROC_LOW_CountingHouse_GuardSawGuardInCombat((CHARACTER)_Guard,(GUIDSTRING)_CombatId)
AND
NOT DB_LOW_CountingHouse_HostileGuards(_Guard)
THEN
DB_LOW_CountingHouseGuard_EnterCombatOnFactionChanged(_Guard,_CombatId);
SetFaction(_Guard,(FACTION)ACT3_LOW_CountingHouse_HostileGuards_c58d9d05-9dff-4a1a-9c14-21c703671c41);

IF
DB_Sees(_Guard,_PartyMember)
AND
DB_LOW_CountingHouse_Guards(_Guard)
AND
NOT DB_LOW_CountingHouse_HostileGuards(_Guard)
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember,_CombatId)
THEN
PROC_LOW_CountingHouse_GuardSawPartyMemberInCombat(_Guard,_CombatId);

PROC
PROC_LOW_CountingHouse_GuardSawPartyMemberInCombat((GUIDSTRING)_Guard,(GUIDSTRING)_CombatId)
AND
QRY_LOW_CountingHouse_HostileGuardsInCombat(_CombatId)
THEN
NOT DB_QRYRTN_LOW_CountingHouse_HostileGuardsInCombat(_CombatID);
SetFaction(_Guard,(FACTION)ACT3_LOW_CountingHouse_HostileGuards_c58d9d05-9dff-4a1a-9c14-21c703671c41);

QRY
QRY_LOW_CountingHouse_HostileGuardsInCombat((GUIDSTRING)_CombatId)
AND
DB_LOW_CountingHouse_HostileGuards(_HostileGuard)
AND
DB_Is_InCombat(_HostileGuard,_CombatID)
AND
NOT DB_QRYRTN_LOW_CountingHouse_HostileGuardsInCombat(_CombatID)
THEN
DB_QRYRTN_LOW_CountingHouse_HostileGuardsInCombat(_CombatID);
//END_REGION

//REGION Cashguards/Player perma-hostility is handeled via swapping cashguards' faction so we can handle it on per guard basis
// By default counting house guards have ACT3_LOW_CountingHouse_Civilians faction
IF
FlagSet((FLAG)LOW_CountingHouse_State_AlarmTriggered_36e1843f-b531-4155-8ca7-f2d13908f419,_,_)
AND
DB_LOW_CountingHouse_Guards(_Guard)
AND
NOT DB_LOW_CountingHouse_HostileGuards(_Guard)
THEN
SetFaction(_Guard,(FACTION)ACT3_LOW_CountingHouse_HostileGuards_c58d9d05-9dff-4a1a-9c14-21c703671c41);

IF
DB_Is_InCombat(_Guard,_CombatID)
AND
NOT DB_LOW_CountingHouse_HostileGuards(_Guard)
AND
DB_LOW_CountingHouse_Guards(_Guard)
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember,_CombatID)
THEN
SetFaction(_Guard,(FACTION)ACT3_LOW_CountingHouse_HostileGuards_c58d9d05-9dff-4a1a-9c14-21c703671c41);

// If a civilian sees a hostile guard, their panicked behavior from anubis kicks in
IF
DB_Sees(_Civilian,_Guard)
AND
NOT DB_LOW_CountingHouse_CiviliansPanicked(1)
AND
DB_LOW_CountingHouse_Civilians(_Civilian)
AND
DB_LOW_CountingHouse_HostileGuards(_Guard)
AND
NOT DB_GlobalFlag((FLAG)LOW_CountingHouse_State_CiviliansPanicked_67cadb20-00fc-4015-9771-600132b67ecb)
THEN
DB_LOW_CountingHouse_CiviliansPanicked(1);
PROC_GlobalSetFlagAndCache((FLAG)LOW_CountingHouse_State_CiviliansPanicked_67cadb20-00fc-4015-9771-600132b67ecb);

// If a non-hostile guard sees a panicking civilian, it turnes hostile to players
IF
DB_Sees(_Guard,_Civilian)
AND
NOT DB_LOW_CountingHouse_HostileGuards(_Guard)
AND
DB_LOW_CountingHouse_Guards(_Guard)
AND
DB_LOW_CountingHouse_Civilians(_Civilian)
AND
DB_GlobalFlag((FLAG)LOW_CountingHouse_State_CiviliansPanicked_67cadb20-00fc-4015-9771-600132b67ecb)
THEN
SetFaction(_Guard,(FACTION)ACT3_LOW_CountingHouse_HostileGuards_c58d9d05-9dff-4a1a-9c14-21c703671c41);

// If players take long rest after the cahsguards have been alerted, all of them turn hostile
PROC
PROC_LongRest()
AND
NOT DB_OnlyOnce("LOW_CountingHouse_AllGuardsTurnHostileOnLongRest_OnlyOnce")
AND
DB_LOW_CountingHouse_HostileGuards(_HostileGuard)
AND
NOT DB_PermaDefeated(_HostileGuard)
AND
QRY_OnlyOnce("LOW_CountingHouse_AllGuardsTurnHostileOnLongRest_OnlyOnce")
THEN
DB_LOW_CountingHouse_AllGuardsHostileOnLongRest(1);

IF
DB_LOW_CountingHouse_AllGuardsHostileOnLongRest(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_CountingHouse_AllGuardsHostileOnLongRest(1);
PROC_LOW_CountingHouse_AllGuardsHostileOnLongRest();

PROC
PROC_LOW_CountingHouse_AllGuardsHostileOnLongRest()
AND
DB_LOW_CountingHouse_Guards(_Guard)
AND
NOT DB_LOW_CountingHouse_HostileGuards(_Guard)
THEN
SetFaction(_Guard,(FACTION)ACT3_LOW_CountingHouse_HostileGuards_c58d9d05-9dff-4a1a-9c14-21c703671c41);

IF
BaseFactionChanged(_Guard,_,(FACTION)ACT3_LOW_CountingHouse_HostileGuards_c58d9d05-9dff-4a1a-9c14-21c703671c41)
AND
DB_LOW_CountingHouse_Guards(_Guard)
THEN
DB_LOW_CountingHouse_HostileGuards(_Guard);

IF
BaseFactionChanged(_Guard,_,(FACTION)ACT3_LOW_CountingHouse_HostileGuards_c58d9d05-9dff-4a1a-9c14-21c703671c41)
AND
DB_LOW_CountingHouseGuard_EnterCombatOnFactionChanged(_Guard,_CombatID)
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember,_CombatID)
THEN
PROC_EnterCombat(_Guard,_PartyMember);

IF
SwitchedCombat(_,_OldCombatID,_NewCombatID)
AND
DB_LOW_CountingHouseGuard_EnterCombatOnFactionChanged(_Guard,_OldCombatID)
THEN
NOT DB_LOW_CountingHouseGuard_EnterCombatOnFactionChanged(_Guard,_OldCombatID);
DB_LOW_CountingHouseGuard_EnterCombatOnFactionChanged(_Guard,_NewCombatID);

IF
CombatEnded(_CombatID)
AND
DB_LOW_CountingHouseGuard_EnterCombatOnFactionChanged(_Guard,_CombatID)
THEN
NOT DB_LOW_CountingHouseGuard_EnterCombatOnFactionChanged(_Guard,_CombatID);
//END_REGION

//REGION Counting House steelwatchers stop aggroing players along with other cashguards once become brain-controlled
IF
BaseFactionChanged(_SteelWatcher,_,(FACTION)GLO_SteelWatcher_BrainControlled_f0bb90ec-b609-4864-9716-0ad5d7222689)
AND
DB_GLO_SteelWatchers((CHARACTER)_SteelWatcher)
THEN
NOT DB_LOW_CountingHouse_Guards(_SteelWatcher);
//END_REGION

//REGION Alarm
IF
FlagSet(_AlarmFlag,_,_)
AND
DB_LOW_CountingHouse_AlarmFlagsByArea(_AlarmFlag)
THEN
SetFlag((FLAG)LOW_CountingHouse_State_AlarmTriggered_36e1843f-b531-4155-8ca7-f2d13908f419);

IF
DB_LOW_CountingHouse_AlarmTriggers(_AlarmTrigger,_,_Tag)
THEN
SetTag(_AlarmTrigger,_Tag);
ApplyStatus(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_ACTIVE",-1.0);

IF
DB_LOW_CountingHouse_AlarmTriggers(_AlarmTrigger,_,_Tag)
AND
HasActiveStatus(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED",1)
THEN
RemoveStatus(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED");

IF
ArmedTrapUsed(_Character,_AlarmTrigger)
AND
DB_LOW_CountingHouse_AlarmTriggers((ITEM)_AlarmTrigger,_AlarmFlag,_Tag)
THEN
PlayAnimation(_AlarmTrigger, OBJ_Open_Unused_01_1c8ad609-f780-418e-9fdf-c52f6d749c9f, "");
SetDisableUse((ITEM)_AlarmTrigger,1);
RemoveStatus(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_ACTIVE");
ApplyStatus(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED",18.0,0,_Character);

IF
StatusApplied(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED",_,_)
AND
DB_LOW_CountingHouse_AlarmTriggers(_AlarmTrigger,_AlarmFlag,_Tag)
THEN
DB_LOW_CountingHouse_AlarmIsTriggered(_AlarmTrigger,_AlarmFlag);

IF
StatusApplied(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED",_AlarmRinger,_)
AND
DB_LOW_CountingHouse_AlarmTriggers(_AlarmTrigger,_AlarmFlag,_Tag)
AND
HasActiveStatus(_AlarmTrigger,"SILENCED",0)
THEN
PROC_LOW_CountingHouseAlarmTriggered(_AlarmTrigger,_AlarmFlag,_AlarmRinger,_Tag);

IF
StatusRemoved(_AlarmTrigger,"SILENCED",_,_)
AND
DB_LOW_CountingHouse_AlarmIsTriggered(_AlarmTrigger,_AlarmFlag)
AND
DB_LOW_CountingHouse_AlarmTriggers(_AlarmTrigger,_AlarmFlag,_Tag)
THEN
PROC_LOW_CountingHouseAlarmTriggered(_AlarmTrigger,_AlarmFlag,NULL_00000000-0000-0000-0000-000000000000,_Tag);

IF
AttemptedDisarm(_AlarmTrigger,_,_,1)
AND
DB_LOW_CountingHouse_AlarmTriggers((ITEM)_AlarmTrigger,_AlarmFlag,_Tag)
THEN
RemoveStatus(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED");
RemoveStatus(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_ACTIVE");
SetDisableUse((ITEM)_AlarmTrigger,1);

IF
StatusRemoved(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED",_,_)
THEN
SetDisableUse((ITEM)_AlarmTrigger,0);

IF
StatusRemoved(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED",_,_)
AND
NOT DB_Defeated(_AlarmTrigger)
AND
IsTrapArmed((ITEM)_AlarmTrigger,1)
THEN
ApplyStatus(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_ACTIVE",-1.0);

IF
StatusRemoved(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED",_,_)
AND
DB_LOW_CountingHouse_AlarmIsTriggered(_AlarmTrigger,_AlarmFlag)
THEN
NOT DB_LOW_CountingHouse_AlarmIsTriggered(_AlarmTrigger,_AlarmFlag);

IF
StatusRemoved(_AlarmTrigger,"LOW_COUNTINGHOUSE_ALARMMACHINE_TRIGGERED",_,_)
AND
DB_LOW_CountingHouse_AlarmTriggers(_AlarmTrigger,_AlarmFlag,_)
AND
DB_GlobalFlag(_AlarmFlag)
AND
NOT DB_LOW_CountingHouse_AlarmCombat(_,_AlarmFlag)
AND
NOT DB_LOW_CountingHouse_AlarmIsTriggered(_,_AlarmFlag)
THEN
PROC_LOW_CountingHouse_ResetAlarmTrigger(_AlarmFlag);

PROC
PROC_LOW_CountingHouseAlarmTriggered((GUIDSTRING)_AlarmTrigger,(FLAG)_AlarmFlag,(GUIDSTRING)_AlarmRinger,(TAG)_Tag)
THEN
SetFlag(_AlarmFlag);
SetDualEntityEvent(_AlarmTrigger,_AlarmTrigger,"LOW_CountingHouse_AlarmTriggerUsed");
PROC_LOW_CountingHouseAlarmTriggered(_AlarmFlag,_AlarmRinger,_Tag);

PROC
PROC_LOW_CountingHouseAlarmTriggered((FLAG)_AlarmFlag,(GUIDSTRING)_AlarmRinger,(TAG)_Tag)
AND
DB_LOW_CountingHouse_AlarmTriggers(_AlarmTrigger,_,_Tag)
THEN
ClearTag(_AlarmTrigger,_Tag);

PROC
PROC_LOW_CountingHouseAlarmTriggered((FLAG)_AlarmFlag,(GUIDSTRING)_AlarmRinger,(TAG)_Tag)
AND
_AlarmRinger != NULL_00000000-0000-0000-0000-000000000000
AND
DB_Is_InCombat(_AlarmRinger,_CombatId)
AND
NOT DB_LOW_CountingHouse_AlarmCombat(_CombatId,_AlarmFlag)
THEN
DB_LOW_CountingHouse_AlarmCombat(_CombatId,_AlarmFlag);

IF
SwitchedCombat(_,_OldCombatID,_NewCombatID)
AND
DB_LOW_CountingHouse_AlarmCombat(_OldCombatID,_AlarmFlag)
THEN
NOT DB_LOW_CountingHouse_AlarmCombat(_OldCombatID,_AlarmFlag);
DB_LOW_CountingHouse_AlarmCombat(_NewCombatID,_AlarmFlag);

IF
CombatEnded(_CombatId)
AND
DB_LOW_CountingHouse_AlarmCombat(_CombatId,_AlarmFlag)
AND
NOT DB_LOW_CountingHouse_AlarmIsTriggered(_,_AlarmFlag)
THEN
PROC_LOW_CountingHouse_ResetAlarmTrigger(_AlarmFlag);

IF
CombatEnded(_CombatId)
AND
DB_LOW_CountingHouse_AlarmCombat(_CombatId,_AlarmFlag)
THEN
NOT DB_LOW_CountingHouse_AlarmCombat(_CombatId,_AlarmFlag);

PROC
PROC_LOW_CountingHouse_ResetAlarmTrigger((FLAG)_AlarmFlag)
AND
DB_LOW_CountingHouse_AlarmTriggers(_AlarmTrigger,_AlarmFlag,_Tag)
THEN
ClearFlag(_AlarmFlag);
SetTag(_AlarmTrigger,_Tag);

IF
TextEvent("LOW_CHTestAlarmSound")
AND
GetTextEventParamUUID(1,_AlarmUUID)
THEN
PlaySound(_AlarmUUID,"SE_CTY_MephistosVault_AlarmSound_Start");

IF
TextEvent("Test_CHAlarmTrigger")
AND
GetTextEventParamUUID(1,_AlarmTrigger)
AND
GetHostCharacter(_Host)
THEN
SetDualEntityEvent((GUIDSTRING)_Host,_AlarmTrigger,"LOW_CountingHouse_AlarmTriggerUsed");
//END_REGION

//REGION Docks CH Guards
// Due to the size of the docks we need to manually acitvate docks guards so their alarm anubis works
IF
EnteredTrigger(_PartyMember,(TRIGGER)S_LOW_CountingHouse_DocksGuardsActivation_Trigger_d78edace-4ccc-4872-a9ea-208a6e5a3353)
AND
NOT DB_LOW_CountingHouse_DocksGuardsForceActivated(1)
THEN
DB_LOW_CountingHouse_DocksGuardsForceActivated(1);
PROC_LOW_CountingHouse_ForceUpdateDocksGuards(1);

IF
LeftTrigger(_PartyMember,(TRIGGER)S_LOW_CountingHouse_DocksGuardsActivation_Trigger_d78edace-4ccc-4872-a9ea-208a6e5a3353)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger((TRIGGER)S_LOW_CountingHouse_DocksGuardsActivation_Trigger_d78edace-4ccc-4872-a9ea-208a6e5a3353)
AND
DB_LOW_CountingHouse_DocksGuardsForceActivated(1)
THEN
NOT DB_LOW_CountingHouse_DocksGuardsForceActivated(1);
PROC_LOW_CountingHouse_ForceUpdateDocksGuards(0);

PROC
PROC_StateSet_PermaDefeated(_DocksGuard)
AND
DB_LOW_CountingHouse_DocksGuards(_DocksGuard)
THEN
SetForceUpdate(_DocksGuard,0);
NOT DB_LOW_CountingHouse_DocksGuards(_DocksGuard);

PROC
PROC_LOW_CountingHouse_ForceUpdateDocksGuards((INTEGER)_Bool)
AND
DB_LOW_CountingHouse_DocksGuards(_DocksGuard)
AND
NOT DB_PermaDefeated(_DocksGuard)
THEN
SetForceUpdate(_DocksGuard,_Bool);
//END_REGION

//REGION Guards Combat ADs
IF
TurnStarted(_Guard)
AND
DB_LOW_CountingHouse_GuardCombatADs(_Guard,_AD,NULL_00000000-0000-0000-0000-000000000000)
AND
NOT DB_LOW_CountingHouse_GuardADedInCombat(_Guard,_)
THEN
PROC_TryStartAD(_AD,_Guard);

IF
TurnStarted(_Guard)
AND
DB_LOW_CountingHouse_GuardCombatADs(_Guard,_AD,_AlarmFlag)
AND
_AlarmFlag != NULL_00000000-0000-0000-0000-000000000000
AND
NOT DB_GlobalFlag(_AlarmFlag)
AND
NOT DB_LOW_CountingHouse_GuardADedInCombat(_Guard,_)
THEN
PROC_TryStartAD(_AD,_Guard);

IF
AutomatedDialogStarted(_AD,_)
AND
DB_LOW_CountingHouse_GuardCombatADs(_Guard,_AD,_)
AND
DB_Is_InCombat(_Guard,_CombatId)
THEN
DB_LOW_CountingHouse_GuardADedInCombat(_Guard,_CombatId);

IF
SwitchedCombat(_,_OldCombatID,_NewCombatID)
AND
DB_LOW_CountingHouse_GuardADedInCombat(_Guard,_OldCombatID)
THEN
NOT DB_LOW_CountingHouse_GuardADedInCombat(_Guard,_OldCombatID);
DB_LOW_CountingHouse_GuardADedInCombat(_Guard,_NewCombatID);

IF
CombatEnded(_CombatId)
AND
DB_LOW_CountingHouse_GuardADedInCombat(_Guard,_CombatId)
THEN
NOT DB_LOW_CountingHouse_GuardADedInCombat(_Guard,_CombatId);
//END_REGION

//REGION Clerks/Guards panic state when alarm goes off or combat starts nearby
IF
DB_LOW_CountingHouse_Clerks(_Character)
THEN
DB_LOW_CountingHouse_Civilians(_Character);

IF
DB_LOW_CountingHouse_Customers(_Character,_)
THEN
DB_LOW_CountingHouse_Civilians(_Character);

IF
FlagSet((FLAG)LOW_CountingHouse_State_CiviliansPanicked_67cadb20-00fc-4015-9771-600132b67ecb,_,_)
AND
DB_LOW_CountingHouse_Civilians(_Character)
THEN
PROC_CharacterDisableAllCrimes((CHARACTER)_Character);

IF
FlagSet((FLAG)LOW_CountingHouse_State_CiviliansPanicked_67cadb20-00fc-4015-9771-600132b67ecb,_,_)
AND
DB_LOW_CountingHouse_CrowdTriggers(_CrowdTrigger)
THEN
TriggerSetCrowdBehaviour(_CrowdTrigger, CROWDBEHAVIOUR.Flee);
TriggerSetCrowdSpawningEnable((TRIGGER)_CrowdTrigger,0);

IF
DB_LOW_CountingHouse_Customers(_Customer,_)
THEN
TriggerRegisterForCharacter((TRIGGER)S_LOW_CountingHouse_CivilianEscape_BoxTrigger_c643f3a0-b7e6-488c-b78a-3dedf0ec6816,(CHARACTER)_Customer);

IF
EnteredTrigger(_Customer,(TRIGGER)S_LOW_CountingHouse_CivilianEscape_BoxTrigger_c643f3a0-b7e6-488c-b78a-3dedf0ec6816)
AND
NOT DB_PermaDefeated(_Customer)
AND
NOT DB_CantMove(_Customer)
THEN
PROC_DisappearOutOfSight(_Customer,"Run",1,"");

// On long rest panicking clerks disappear
PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)LOW_CountingHouse_State_CiviliansPanicked_67cadb20-00fc-4015-9771-600132b67ecb)
AND
QRY_OnlyOnce("LOW_CountingHouse_PanickedClerksDisappearOnLongRest_OnlyOnce")
THEN
DB_LOW_CountingHouse_PanickedClerksSetOffstage(1);

IF
DB_LOW_CountingHouse_PanickedClerksSetOffstage(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_CountingHouse_PanickedClerksSetOffstage(1);
PROC_LOW_CountingHouse_PanickedClerksSetOffstage();

PROC
PROC_LOW_CountingHouse_PanickedClerksSetOffstage()
AND
DB_LOW_CountingHouse_Clerks(_Clerk)
AND
NOT DB_PermaDefeated(_Clerk)
THEN
PROC_SetOnStage(_Clerk,0);
//END_REGION

//REGION Tracking players moving ledgers used in clerks' world behaviors to prevent them playing accouting world behavior
IF
Moved(_Ledger)
AND
DB_LOW_CountingHouse_ClerksLedger(_Clerk,_Ledger)
THEN
NOT DB_LOW_CountingHouse_ClerksLedger(_Clerk,_Ledger);
SetFlag((FLAG)LOW_CountingHouse_State_ClerksLedgerMoved_25435935-cd35-4866-8ecc-c56c0c088728,_Clerk);
//END_REGION

//REGION Greatdoor
IF
FlagSet((FLAG)LOW_CountingHouse_State_CorrectPinCodeEntered_c829bf70-2212-4079-8017-4f0a79b1399a,_,_)
THEN
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000,S_LOW_CountingHouse_PinCodeManager_825dc9dc-7a78-4a50-a347-c38d77f9befb,"LOW_CountingHouse_PinCodePlates_TurnedOff");

IF
EntityEvent(S_LOW_CountingHouse_PinCodeManager_825dc9dc-7a78-4a50-a347-c38d77f9befb,"LOW_CountingHouse_DisablePressurePlates")
THEN
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000,S_LOW_CountingHouse_PinCodeManager_825dc9dc-7a78-4a50-a347-c38d77f9befb,"LOW_CountingHouse_PinCodePlates_TurnedOff");

IF
EntityEvent(S_LOW_CountingHouse_PinCodeManager_825dc9dc-7a78-4a50-a347-c38d77f9befb,"LOW_CountingHouse_EnablePressurePlates")
THEN
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000,S_LOW_CountingHouse_PinCodeManager_825dc9dc-7a78-4a50-a347-c38d77f9befb,"LOW_CountingHouse_PinCodePlates_TurnedOn");

// Set in PinCodeManager anubis
IF
FlagSet((FLAG)LOW_CountingHouse_State_CorrectPinCodeEntered_c829bf70-2212-4079-8017-4f0a79b1399a,_,_)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_LOW_CountingHouse_GreatDoor_97933ead-8014-4241-8d83-477e658d9b44);

IF
Unlocked((ITEM)S_LOW_CountingHouse_GreatDoor_97933ead-8014-4241-8d83-477e658d9b44,_Player,_)
AND
DB_Players(_Player)
THEN
SetFlag((FLAG)LOW_CountingHouse_State_GreatDoorLockpicked_72e6bda9-a5ac-40b3-b56f-f7e0ce338925);
Open((ITEM)S_LOW_CountingHouse_GreatDoor_97933ead-8014-4241-8d83-477e658d9b44);
SetDualEntityEvent(NULL_00000000-0000-0000-0000-000000000000,S_LOW_CountingHouse_PinCodeManager_825dc9dc-7a78-4a50-a347-c38d77f9befb,"LOW_CountingHouse_PinCodePlates_TurnedOff");

IF
Opened((ITEM)S_LOW_CountingHouse_GreatDoor_97933ead-8014-4241-8d83-477e658d9b44)
THEN
SetCanInteract((ITEM)S_LOW_CountingHouse_GreatDoor_97933ead-8014-4241-8d83-477e658d9b44,0);

IF
EnteredTrigger(_Player,(TRIGGER)S_LOW_CountingHouse_GreatDoor_QuestUpdate_Trigger_3388109d-41a3-4530-a847-0f6c1e5c7121)
AND
DB_GlobalFlag((FLAG)LOW_CountingHouse_Knows_ClerkWorriedAboutCultists_624b0c23-c65b-82c7-ba6e-eb06d720dfac)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CountingHouse_State_PlayersReachedGreatDoor_KnowMinscBehind_2a0f4576-19cb-418a-a22c-c7a74a205eb4);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CountingHouse_GreatDoor_QuestUpdate_Trigger_3388109d-41a3-4530-a847-0f6c1e5c7121);

IF
TextEvent("LOW_GreatDoor_SetCanInteract")
THEN
SetCanInteract((ITEM)S_LOW_CountingHouse_GreatDoor_97933ead-8014-4241-8d83-477e658d9b44,1);
//END_REGION

//REGION Heist
IF
DB_InRegion(_Character, (TRIGGER)S_LOW_CountingHouse_HeistDialogTrigger_feec2762-07b3-42c8-ae7f-57df907e74c0)
AND
DB_Players(_Character)
AND
QRY_OnlyOnce("LOW_CountingHouse_StartHeistDialog")
AND
NOT QRY_StartDialogCustom((DIALOGRESOURCE)LOW_CountingHouse_Heist_63210311-4b3b-85e3-7278-2032e2a65bd7,S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047,S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57,S_LOW_CountingHouse_PrivateGuard_03_459e4fa3-c9f3-478a-ba56-e09431674e32,S_LOW_CountingHouse_PrivateGuard_02_ff490513-7296-4512-8040-239f9e824f2b,_Character,0,0,0,0)
THEN
PROC_LOW_CountingHouse_AfterHeistScene();

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_CountingHouse_Heist_63210311-4b3b-85e3-7278-2032e2a65bd7, _ID)
THEN
PROC_DialogAddSpeakingActorAt(_ID,S_LOW_CountingHouse_Cultist_01_6217b97e-3715-4e88-ae20-7ba1aa9da1aa,7);
PROC_DialogAddSpeakingActorAt(_ID,S_LOW_CountingHouse_Cultist_02_464de2ba-ac0b-4fa8-bfa5-d8349ccbebf8,8);

// The flag is set in the first dialog node, this way we ensure that the PROC will always go through in case the dialog starts
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_CountingHouse_State_RobbersEscaped_16197488-9cc2-48e2-94ae-36225025d4d8)
THEN
PROC_LOW_CountingHouse_AfterHeistScene();

PROC
PROC_LOW_CountingHouse_AfterHeistScene()
THEN
PROC_SceneOver("LOW_CountingHouse_HeistScene");
PROC_SetRelationMutual((FACTION)ACT3_LOW_CountingHouse_Robbers_b949b011-9fd1-4ed8-b7bf-223c88838327, (FACTION)ACT3_LOW_CountingHouse_Rakaths_d8c61e85-7473-4b87-9df0-e3c5785d894f, 0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_CountingHouse_Robbers_b949b011-9fd1-4ed8-b7bf-223c88838327,0);
PROC_State_Progress(S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae, "LOW_Guildhall_State", "LOW_Guildhall_State_PostHeist");
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CountingHouse_GreatDoor_QuestUpdate_Trigger_3388109d-41a3-4530-a847-0f6c1e5c7121);

IF
RelationChanged((FACTION)ACT3_LOW_CountingHouse_Robbers_b949b011-9fd1-4ed8-b7bf-223c88838327,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,0,1)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_CountingHouse_HeistDialogTrigger_feec2762-07b3-42c8-ae7f-57df907e74c0)
AND
QRY_OnlyOnce("LOW_PlayersEnterCountingHouseHeistCombat")
THEN
PROC_EnterCombat(_Player,S_LOW_CountingHouse_Cultist_01_6217b97e-3715-4e88-ae20-7ba1aa9da1aa);
PROC_TriggerUnregisterForParty((TRIGGER)S_LOW_CountingHouse_HeistDialogTrigger_feec2762-07b3-42c8-ae7f-57df907e74c0);

IF
EnteredCombat(S_LOW_CountingHouse_Cultist_01_6217b97e-3715-4e88-ae20-7ba1aa9da1aa,_CombatID)
THEN
DB_LOW_CountingHouse_HeistCombat(_CombatID);

// Setting the amount of stolen gold
IF
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_CountingHouse_HeadBanker_3b0c163a-75ac-8ca3-e5da-0b0ea40245df, _Amount)
AND
QRY_OnlyOnce("LOW_CountingHouse_InitialStolenGoldAmountSetup_OnlyOnce")
THEN
AddGold(S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d,_Amount);

// Store the amount of stolen gold before the trader carrying it dies and the gold is destroyed
IF
Dying(_Character)
AND
IsTagged(_Character, (TAG)TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b, 1)
AND
IsInInventoryOf(S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d, _Character, 1)
AND
GetGold(S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d, _Amount)
THEN
DB_LOW_StolenGoldBeforeTraderDeath(_Amount);

// Restore the destroyed stolen gold after the trader that carried it has died
IF
Died(_Character)
AND
IsTagged(_Character, (TAG)TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b, 1)
AND
IsInInventoryOf(S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d, _Character, 1)
AND
GetGold(S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d, 0)
AND
DB_LOW_StolenGoldBeforeTraderDeath(_Amount)
THEN
AddGold(S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d,_Amount);
NOT DB_LOW_StolenGoldBeforeTraderDeath(_Amount);


// Rakath's guards turn into tadpoled guards in case smuggler's cave shipment makes it into the city
IF
DB_InRegion(_Character, (TRIGGER)S_LOW_CountingHouse_HeistDialogTrigger_feec2762-07b3-42c8-ae7f-57df907e74c0)
AND
DB_Players(_Character)
AND
QRY_OnlyOnce("LOW_CountingHouse_SetupTadpoledGuards")
AND
DB_GlobalFlag((FLAG)WYR_SmugglersCave_State_SmugglersWon_f82671e3-a381-49eb-bc02-d5fa27468428)
AND
DB_LOW_CountingHouseTadpoledGuards(_Guard,_)
THEN
SetTag(_Guard,(TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed);
AddSpell((CHARACTER)_Guard,"Target_TAD_BlackHole",0,0);
// Faction is changed so cultist won't attack tadpoled guards
SetFaction(_Guard,(FACTION)ACT3_LOW_CountingHouse_TadpoledGuards_543b82ff-118b-433d-a004-6e2badc8a742);

IF
DB_OnlyOnce("LOW_CountingHouse_SetupTadpoledGuards")
AND
DB_GlobalFlag((FLAG)WYR_SmugglersCave_State_SmugglersWon_f82671e3-a381-49eb-bc02-d5fa27468428)
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_CountingHouse_SmugglersCaveNote_ShipmentArrived_fc7481fb-75cc-46a9-aa3f-ad83ea05a442,S_LOW_CountingHouse_Cultist_02_464de2ba-ac0b-4fa8-bfa5-d8349ccbebf8,1);

IF
DB_OnlyOnce("LOW_CountingHouse_SetupTadpoledGuards")
AND
NOT DB_GlobalFlag((FLAG)WYR_SmugglersCave_State_SmugglersWon_f82671e3-a381-49eb-bc02-d5fa27468428)
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_CountingHouse_SmugglersCaveNote_ShipmentNeverArrived_2d326803-4d14-418c-95d8-42ae5bfd8fa8,S_LOW_CountingHouse_Cultist_02_464de2ba-ac0b-4fa8-bfa5-d8349ccbebf8,1);

IF
TurnStarted(_Guard)
AND
DB_LOW_CountingHouseTadpoledGuards(_Guard,_RevealAD)
THEN
PROC_LOW_CountingHouse_TadpoledGuardsAggro(_Guard,_RevealAD);

PROC
PROC_LOW_CountingHouse_TadpoledGuardsAggro((GUIDSTRING)_Guard,(DIALOGRESOURCE)_RevealAD)
AND
IsTagged(_Guard,(TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed,1)
AND
QRY_OnlyOnce("LOW_CountingHouse_GuardsRevealBeingTadpoled")
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_CountingHouse_TadpoledGuards_543b82ff-118b-433d-a004-6e2badc8a742, (FACTION)ACT3_LOW_CountingHouse_Rakaths_d8c61e85-7473-4b87-9df0-e3c5785d894f, 0);
PROC_SetRelationMutual((FACTION)ACT3_LOW_CountingHouse_TadpoledGuards_543b82ff-118b-433d-a004-6e2badc8a742, (FACTION)ACT3_LOW_CountingHouse_Robbers_b949b011-9fd1-4ed8-b7bf-223c88838327, 100);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_CountingHouse_TadpoledGuards_543b82ff-118b-433d-a004-6e2badc8a742,0);
PROC_TryStartAD(_RevealAD,_Guard);
SetEntityEvent(_Guard,"GLO_AiExecuteRecalc");
SetFlag((FLAG)LOW_CountingHouse_State_GuardsRevealedBeingTadpoled_1c3d173e-31bc-46bc-bb67-7f830628335a);

// Edge case handling for when players kill all cultists before tadpoled guards turn
IF
CombatEnded(_CombatID)
AND
DB_LOW_CountingHouse_HeistCombat(_CombatID)
AND
DB_GlobalFlag((FLAG)LOW_CountingHouse_State_GuardsRevealedBeingTadpoled_1c3d173e-31bc-46bc-bb67-7f830628335a)
AND
DB_LOW_CountingHouseTadpoledGuards(_Guard,_RevealAD)
THEN
PROC_LOW_CountingHouse_TadpoledGuardsAggro(_Guard,_RevealAD);

IF
LeftCombat(_Player,_CombatID)
AND
DB_Players((CHARACTER)_Player)
AND
DB_LOW_CountingHouse_HeistCombat(_CombatID)
AND
CombatGetInvolvedPlayersCount(_CombatID,0)
AND
DB_LOW_CountingHouseTadpoledGuards(_Guard,_RevealAD)
THEN
PROC_LOW_CountingHouse_TadpoledGuardsAggro(_Guard,_RevealAD);
//END_REGION

//REGION Rakath reacts to seeing players lockpicking VIP vaults, the events are sent to anubis
IF
StoppedLockpicking(_Player,_Vault)
AND
DB_LOW_CountingHouse_VipVaults(_Vault,_)
AND
IsLocked(_Vault,1)
THEN
SetDualEntityEvent(S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57,_Player,"LOW_CountingHouse_PlayerFailedLockpickingVipVault");

IF
Unlocked(_Vault,_Player,(ITEM)NULL_00000000-0000-0000-0000-000000000000)
AND
DB_LOW_CountingHouse_VipVaults(_Vault,_HiddenBoosterUpdate)
THEN
QuestUpdate("HIDDEN_CTY_Boosters",_HiddenBoosterUpdate);
SetDualEntityEvent(S_LOW_CountingHouse_HeadBanker_f56697d0-7318-488c-852c-7c43ecdfde57,_Player,"LOW_CountingHouse_PlayerLockpickedVipVault");
//END_REGION

//REGION LOW_RecoverRakathsGold Quest
IF
EnteredTrigger(_PartyMember,(TRIGGER)S_LOW_Sewers_SUB_c053f299-2919-4928-b489-d238b356cf9b)
AND
DB_QuestIsOpened("LOW_RecoverRakathsGold")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_RecoverRakathsGold","EnteredSewers")
AND
DB_LOW_KnowsStolenGoldInSewers_QuestUpdates(_QuestUpdate)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_RecoverRakathsGold",_QuestUpdate)
THEN
QuestUpdate("LOW_RecoverRakathsGold","EnteredSewers");

IF
FlagSet((FLAG)LOW_CountingHouse_State_HasStolenGoldBag_161d3097-c4bf-48f0-8f77-d3e72645a5ca,_ZhentLeader,_)
AND
DB_DialogNPCs(_DialogInst,_ZhentLeader,_)
AND
DB_DialogName((DIALOGRESOURCE)LOW_MinscHideout_RoahBribe_041941c1-00ba-ad43-6da9-6f7a597053b3,_DialogInst)
AND
DB_LOW_ZhentLeaderReceivedStolenGold_QuestStep(_ZhentLeader,_QuestStep)
THEN
QuestUpdate("LOW_RecoverRakathsGold",_QuestStep);

IF
FlagSet((FLAG)LOW_MinscHideout_State_ZhentLeaderEscaped_0a08b808-b6e2-4923-936c-c12f2774ce61,_,_)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_RecoverRakathsGold","RetrievedStolenGold")
AND
DB_LOW_Guildhall_ZhentLeader(_ZhentLeader)
AND
GetFlag((FLAG)LOW_CountingHouse_State_HasStolenGoldBag_161d3097-c4bf-48f0-8f77-d3e72645a5ca,_ZhentLeader,1)
AND
DB_LOW_ZhentLeaderEscapedGoldHandover_QuestStep(_ZhentLeader,_QuestStep)
THEN
QuestUpdate("LOW_RecoverRakathsGold",_QuestStep);

IF
FlagSet((FLAG)LOW_Guildhall_State_ZhentLeaderRoah_PermaDefeated_44aa8b1e-14d0-4dc1-825c-a8f46155e0aa,_,_)
THEN
PROC_LOW_ZhentLeaderPermaDefeated_CheckStolenGold(LOW_Guildhall_State_ZhentLeaderRoah_PermaDefeated_44aa8b1e-14d0-4dc1-825c-a8f46155e0aa);

IF
FlagSet((FLAG)LOW_Guildhall_State_ZhentLeaderFriol_PermaDefeated_3362ce9b-32c1-4751-84a4-ada8274d1e05,_,_)
THEN
PROC_LOW_ZhentLeaderPermaDefeated_CheckStolenGold(LOW_Guildhall_State_ZhentLeaderFriol_PermaDefeated_3362ce9b-32c1-4751-84a4-ada8274d1e05);

PROC
PROC_LOW_ZhentLeaderPermaDefeated_CheckStolenGold((FLAG)_ZhentLeaderPermaDefeatedFlag)
AND
DB_LOW_ZhentLeaderPermaDefeatedWithGold_QuestStep(_ZhentLeader,_PermaDefeatedQuestStep,_ZhentLeaderPermaDefeatedFlag)
AND
DB_LOW_ZhentLeaderReceivedStolenGold_QuestStep(_ZhentLeader,_SawGoldQuestStep)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_RecoverRakathsGold",_SawGoldQuestStep)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_RecoverRakathsGold","RetrievedStolenGold")
AND
GetFlag((FLAG)LOW_CountingHouse_State_HasStolenGoldBag_161d3097-c4bf-48f0-8f77-d3e72645a5ca,_ZhentLeader,1)
THEN
QuestUpdate("LOW_RecoverRakathsGold",_PermaDefeatedQuestStep);

IF
EnteredChasm((ITEM)S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d, _, _, _, _, _)
AND
GetGold(S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d,_GoldAmount)
AND
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_CountingHouse_HeadBanker_3b0c163a-75ac-8ca3-e5da-0b0ea40245df, _DefaultGoldAmount)
AND
IntegerSubtract(_DefaultGoldAmount,1000,_GoldAmountThreshold)
AND
_GoldAmount >= _GoldAmountThreshold
THEN
QuestUpdate("LOW_RecoverRakathsGold","StolenGoldGone");

IF
AddedTo(S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_LOW_CountingHouse_PlayersPickedUpStolenGold(1)
THEN
DB_LOW_CountingHouse_PlayersPickedUpStolenGold(1);
PROC_LOW_CountingHouse_RetrievedStolenGold_QuestUpdate();

PROC
PROC_StateSet_Defeated(S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d)
THEN
PROC_LOW_CountingHouse_RetrievedStolenGold_QuestUpdate();

IF
RemovedFrom(_Item,S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d)
AND
IsTagged(_Item,(TAG)LOOT_GOLD_6c6b7cac-113c-42ee-bc46-05567b067a9f,1)
THEN
PROC_LOW_CountingHouse_RetrievedStolenGold_QuestUpdate();

PROC
PROC_LOW_CountingHouse_RetrievedStolenGold_QuestUpdate()
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_RecoverRakathsGold","RetrievedStolenGold")
THEN
QuestUpdate("LOW_RecoverRakathsGold","RetrievedStolenGold");

IF
FlagSet((FLAG)LOW_CountingHouse_State_SuccessfullyBargainedWithRakath_b3d83f9e-51e9-4546-82bb-8ffaacb8f322,_,_)
THEN
QuestUpdate("LOW_RecoverRakathsGold","BargainedWithRakath");

IF
FlagSet((FLAG)LOW_CountingHouse_State_ReturnedGoldToRakath_51f7eda8-3170-43d9-9ecf-eabea3a31f2d,_,_)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_RecoverRakathsGold","RetrievedStolenGold")
THEN
QuestUpdate("LOW_RecoverRakathsGold","ReturnedGold_DidntRetrieveStolen");

IF
FlagSet((FLAG)LOW_CountingHouse_State_ReturnedGoldToRakath_51f7eda8-3170-43d9-9ecf-eabea3a31f2d,_,_)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_RecoverRakathsGold","RetrievedStolenGold")
THEN
QuestUpdate("LOW_RecoverRakathsGold","ReturnedGold_RetrievedStolen");
//END_REGION

//REGION Setting the flag that players learned about Misnc's hideout
IF
GameBookInterfaceClosed((ITEM)S_LOW_CountingHouse_SewersHint_Note_f36b85d7-0140-4c51-b7e6-3fa10e798ed1,_PartyMember)
AND
DB_PartyMembers(_PartyMember)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CountingHouse_Knows_MinscHideoutInSewers_65c2faa5-bce2-4839-9c82-2ba1ab6a13ad);

IF
FlagSet((FLAG)LOW_CountingHouse_State_SewersFootprintsNoticed_4ad12790-7fbf-49db-a394-0b6526c3249e,_,_)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CountingHouse_Knows_MinscHideoutInSewers_65c2faa5-bce2-4839-9c82-2ba1ab6a13ad);

IF
FlagSet((FLAG)LOW_CountingHouse_Knows_StoneLordLairLocationSWDCultist_6cf33895-c356-af3c-7deb-5f2eafc0ebb5,_,_)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_CountingHouse_Knows_MinscHideoutInSewers_65c2faa5-bce2-4839-9c82-2ba1ab6a13ad);
//END_REGION

//REGION Debug
IF
TextEvent("LOW_CountingHouse_RestoreCiviliansPositions_Debug")
AND
DB_LOW_CountingHouse_Customers(_Customer,_Trigger)
THEN
PROC_SetOnStage(_Customer,1);
TeleportTo(_Customer,_Trigger);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
