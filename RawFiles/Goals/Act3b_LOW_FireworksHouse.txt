Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteGuard01_cb956cc3-0e77-4a2b-8500-7a37486348b4);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteGuard02_2dc8b619-4962-4da9-9ab9-011c2f08133e);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteGuard03_af2dde9a-b304-4656-b871-6804ff8247a9);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteGuard04_c6e81e27-210c-4a62-8a1b-f1f9bd075d24);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteGuard05_5e5fb7e4-1a2a-4072-b658-ec0707dda401);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteGuard06_dc8648df-b19d-4739-9104-0a39bb054470);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteGuard07_f1af5341-9a65-4000-bce5-184dff7af2e6);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteClerk02_3d69c599-5218-4b3d-9845-3c19b8a14278);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteWorker01_f6575645-22d7-48e7-bbcc-24dab827e02d);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_BaniteWizard_8844fff4-b1a7-499b-9c63-0ceb581672cc);
DB_LOW_FireworksHouse_BaniteGuards((CHARACTER)S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7);



DB_LOW_FireworksHouse_ExplosiveBarrels(S_LOW_FireworksHouse_Barrel_Smokepowder_A_000_feae7bc4-3148-4fce-9289-6cbea96591c8);
DB_LOW_FireworksHouse_ExplosiveBarrels(S_LOW_FireworksHouse_Barrel_Smokepowder_A_001_ce6f8115-e0f1-45da-892e-d0691810d601);
DB_LOW_FireworksHouse_ExplosiveBarrels(S_LOW_FireworksHouse_Barrel_Smokepowder_A_002_276db9f8-3c52-4ab4-8625-5d1b8450e0d9);
DB_LOW_FireworksHouse_ExplosiveBarrels(S_LOW_FIreworksHouse_Barrel_Smokepowder_A_003_792a65af-9723-4859-a4ba-76eac05e0ee1);
DB_LOW_FireworksHouse_ExplosiveBarrels(S_LOW_FireworksHouse_Barrel_Smokepowder_A_004_7625fdf3-1c33-46b3-bd53-ebfe5a6400e4);
DB_LOW_FireworksHouse_ExplosiveBarrels(S_LOW_FireworksHouse_Barrel_Smokepowder_A_005_1655d527-5097-47cd-be92-85608e413556);
DB_LOW_FireworksHouse_ExplosiveBarrels(S_LOW_FireworksHouse_Barrel_Smokepowder_A_006_635cb1ef-dbab-447c-b3dc-8cdda5d5b84e);
DB_LOW_FireworksHouse_ExplosiveBarrels(S_LOW_FIreworksHouse_Barrel_Smokepowder_A_007_a67e33d2-55d6-4ef2-8cc3-ba32fa41744e);
DB_LOW_FireworksHouse_ExplosiveBarrels(S_LOW_FireworksHouse_Barrel_Smokepowder_A_008_5adee42e-3132-4306-8458-a55ea38b66d5);


DB_LOW_FireworksHouse_Reinforcements(S_LOW_FireworksHouse_BaniteGuard03_af2dde9a-b304-4656-b871-6804ff8247a9);
DB_LOW_FireworksHouse_Reinforcements(S_LOW_FireworksHouse_BaniteClerk02_3d69c599-5218-4b3d-9845-3c19b8a14278);

DB_LOW_FireworksHouse_CombatGroups("ac783b81-53d4-41ee-8e8e-837689428e48");
DB_LOW_FireworksHouse_CombatGroups("d5ec18d4-ce68-4969-84ae-c1809cdfae98");

DB_Dialogs(S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7, S_LOW_FireworksHouse_ChildCustomer_7564dced-44e3-41f0-8e1f-0c19c0f36585, (DIALOGRESOURCE)LOW_FireworksHouse_AverySonshal_47ca80aa-85b7-8439-6a17-4aedce7c765f); 
DB_Dialogs(S_LOW_FireworksHouse_BaniteWorker01_f6575645-22d7-48e7-bbcc-24dab827e02d, (DIALOGRESOURCE)LOW_FireworksHouse_Clerk01_dcabeca8-15a3-a511-077e-0366b3f07301);
DB_Dialogs(S_LOW_FireworksHouse_BaniteClerk02_3d69c599-5218-4b3d-9845-3c19b8a14278, (DIALOGRESOURCE)LOW_FireworksHouse_Clerk02_a3c4ee4d-50e0-722d-b13e-7d75eab49d7f);
DB_Dialogs(S_LOW_FireworksHouse_BaniteGuard01_cb956cc3-0e77-4a2b-8500-7a37486348b4, (DIALOGRESOURCE)LOW_FireworksHouse_Guard01_7fd7cb45-ad38-aa44-84e6-a4d3cd777438);
DB_Dialogs(S_LOW_FireworksHouse_BaniteGuard02_2dc8b619-4962-4da9-9ab9-011c2f08133e, (DIALOGRESOURCE)LOW_FireworksHouse_Guard02_af541d61-404b-bb7e-4022-1b4bc3491fa7);
DB_Dialogs(S_LOW_FireworksHouse_BaniteGuard03_af2dde9a-b304-4656-b871-6804ff8247a9, (DIALOGRESOURCE)LOW_FireworksHouse_Guard03_63e31101-6975-e6b8-ece8-4a04edd770a3);
DB_Dialogs(S_LOW_FireworksHouse_BaniteGuard04_c6e81e27-210c-4a62-8a1b-f1f9bd075d24, (DIALOGRESOURCE)LOW_FireworksHouse_Guard04_7237063a-d789-7cc0-5066-985f33993cd3);
DB_Dialogs(S_LOW_FireworksHouse_BaniteGuard05_5e5fb7e4-1a2a-4072-b658-ec0707dda401, (DIALOGRESOURCE)LOW_FireworksHouse_Guard05_d4b3f78c-41c0-4b1e-19e8-b46759c03609);
DB_Dialogs(S_LOW_FireworksHouse_BaniteGuard06_dc8648df-b19d-4739-9104-0a39bb054470, (DIALOGRESOURCE)LOW_FireworksHouse_BaniteGuard06_fa1bf49b-5321-2e30-53d6-9d9629e5279a);
DB_Dialogs(S_LOW_FireworksHouse_BaniteGuard07_f1af5341-9a65-4000-bce5-184dff7af2e6, (DIALOGRESOURCE)LOW_FireworksHouse_BaniteGuard07_c83cc2c8-fb9b-f381-d578-d2f702a1453e);

DB_Dialogs(S_LOW_FireworksHouse_BaniteWizard_8844fff4-b1a7-499b-9c63-0ceb581672cc, (DIALOGRESOURCE)LOW_FireworksHouse_BaniteWizard_076f4353-ca04-5712-f598-b909b7fd7c70);
DB_Dialogs(S_LOW_FireworksHouse_ChildCustomer_7564dced-44e3-41f0-8e1f-0c19c0f36585, (DIALOGRESOURCE)LOW_FireworksHouse_ChildCustomer_8e56b476-bd8a-e540-6eac-11d5c2352501);
DB_Dialogs(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462, (DIALOGRESOURCE)LOW_FireworksHouse_AdultCustomer_c30463f0-9ad0-b507-9a7e-f5af6926a039);



DB_GiveItemToEvent(S_LOW_FireworksHouse_FreeSampleDetonation_090693ce-7ed1-41b8-aec2-34634c67a732, (FLAG)LOW_FireworksHouse_Event_GiveFreeSample_284c52a5-503f-4827-a4a6-db820c2119e4);
DB_GiveItemToEvent(S_LOW_FireworksHouse_FreeSampleSmokepowder_03979e25-df90-47e6-8a7c-df37bd6a6d9d, (FLAG)LOW_FireworksHouse_Event_GiveFreeSample_284c52a5-503f-4827-a4a6-db820c2119e4);
DB_GiveItemToEvent(S_LOW_FireworksHouse_FreeSampleBomb_a04bc730-aa36-4acb-abcc-aa51cdfa7331, (FLAG)LOW_FireworksHouse_Event_GiveFreeSample_284c52a5-503f-4827-a4a6-db820c2119e4);

DB_CheckPoint((CHARACTER)S_LOW_FireworksHouse_BaniteGuard01_cb956cc3-0e77-4a2b-8500-7a37486348b4, 
	(CHARACTER)S_LOW_FireworksHouse_BaniteGuard02_2dc8b619-4962-4da9-9ab9-011c2f08133e,
	(TRIGGER)S_LOW_FireworksHouse_GuardSpotTrigger_4fb9df61-b444-4834-ae99-b6e3604758dc,
	(TRIGGER)S_LOW_FireworksHouse_GuardSpotTrigger_4fb9df61-b444-4834-ae99-b6e3604758dc,
	(TRIGGER)S_LOW_FireworksHouse_TrespassTrigger_b13465e4-459a-4c8c-9704-1d880c31f7ec, 
	"LOW_FireworksHouse_CheckPoint", 
	(FLAG)LOW_FireworksHouse_Event_UsedPassword_a1db6ba2-5535-4c96-aa27-b7736625fa6c, 
	"Trespassing", 
	(TRIGGER)S_LOW_FireworksHouse_TrespassReturnTrigger_ccc31c2f-47e3-4ee7-80b8-57a47fae6742);
	
DB_CheckPoint((CHARACTER)S_LOW_FireworksHouse_BaniteGuard03_af2dde9a-b304-4656-b871-6804ff8247a9, 
	(CHARACTER)S_LOW_FireworksHouse_BaniteClerk02_3d69c599-5218-4b3d-9845-3c19b8a14278, 
	(TRIGGER)S_LOW_FireworksHouse_MiddleFloorSpot_055e1bfe-0c73-417a-a8b5-450f1f0dd8c8,
	(TRIGGER)S_LOW_FireworksHouse_MidTresspassWarningTrigger_4970eb1e-2303-4508-b08e-9cde491bf615,
	(TRIGGER)S_LOW_FireworksHouse_MiddleFloorCheckpoint_70773f55-d7fd-497f-81a3-fab458943974, 
	"LOW_FireworksHouse_MiddleCheckPoint", 
	NULL_00000000-0000-0000-0000-000000000000, 
	"Trespassing", 
	(TRIGGER)S_LOW_FireworksHouse_MidReturnTrigger_d99417ba-a8ea-4b06-94f2-15ab4481d4ca);
	

DB_Children(S_LOW_FireworksHouse_ChildCustomer_7564dced-44e3-41f0-8e1f-0c19c0f36585);

DB_SpotPlayers(S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7, "LOW_FireworksHouse_AveryStartsSalesPitch", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

//Voice Barks
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_LOW_FireworksHouse_VB_ArrivalFireworksHouse_5eab1250-516d-4f7e-a4a6-c066b3619b3e,(VOICEBARKRESOURCE)LOW_FireworksHouse_VB_ArrivingStore_8c2169ad-296b-35ec-0d17-7ad1d89670ce, "PerUserAndNearbyPlayers");

// Ownership
DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_FireworksHouse_Ownership_ec39bb0f-9bdd-4402-bdfb-b7a0f47d44f6, (CHARACTER)S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7);

DB_BookFlags(S_LOW_FireworksHouse_IronThroneExplosives_91807efb-a734-4e10-9020-3eef1f938dc5, LOW_FireworksHouse_Knows_GortashBehind_2aece2e5-2a24-4e5b-a67f-670fb4173c76);
KBSECTION
//REGION General Set Up
IF
DB_LOW_FireworksHouse_BaniteGuards(_Guard)
THEN
DB_TrespassTrigger((TRIGGER)S_LOW_FireworksHouse_MiddleFloorTrespass_d7ee227e-7f5a-41c5-86b0-31df8a572af3, (TRIGGER)S_LOW_FireworksHouse_TrespassReturnTrigger_ccc31c2f-47e3-4ee7-80b8-57a47fae6742);
DB_TrespassTrigger((TRIGGER)S_LOW_FireworksHouse_SecureAreaTrigger_7073ae40-7fce-4999-aaa9-ca71166cf4cd, NULL_00000000-0000-0000-0000-000000000000, "LOW_FireworksHouse_TopFloorTrespass");

IF
DB_InRegion(_Player, S_LOW_FireworksHouse_SUB_61e0aab9-16a2-44c7-b063-e789899baa2c)
AND
DB_PartyMembers(_Player)
AND
NOT DB_GlobalFlag(LOW_FireworksHouse_State_EverEnteredBefore_6cbdebba-535e-4b49-b501-2d17e2ad2461)
THEN
PROC_GlobalSetFlagAndCache(LOW_FireworksHouse_State_EverEnteredBefore_6cbdebba-535e-4b49-b501-2d17e2ad2461);
//END_REGION

//REGION Trigger Avery's sales pitch first time a player enters the shop
PROC
PROC_SpotPlayers_Spotted(S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7, "LOW_FireworksHouse_AveryStartsSalesPitch", _Player)
THEN
PROC_TryStartAD(LOW_FireworksHouse_AD_AverySalesPitch_199eef8b-c8ba-0af6-b896-424771df4312, S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7);
//END_REGION


//REGION Unlocks Vault door and allows access to second floor on password use
IF
DB_GlobalFlag(LOW_FireworksHouse_Event_UsedPassword_a1db6ba2-5535-4c96-aa27-b7736625fa6c)
AND
DB_LOW_FireworksHouse_BaniteGuards(_Guard)
THEN
ClearOwnership(S_LOW_FireworksHouse_BlastDoor_b52024ad-0ff4-4e4c-9e95-87432a6d1c88);
Unlock(S_LOW_FireworksHouse_BlastDoor_b52024ad-0ff4-4e4c-9e95-87432a6d1c88);
PROC_RemoveDBTrespassTrigger((TRIGGER)S_LOW_FireworksHouse_MiddleFloorTrespass_d7ee227e-7f5a-41c5-86b0-31df8a572af3);
//END_REGION


//REGION Guard Behaviours
PROC
PROC_CheckPointDialogue(_Player, S_LOW_FireworksHouse_BaniteGuard03_af2dde9a-b304-4656-b871-6804ff8247a9)
AND
QRY_StartCheckpointWarningDialog("LOW_FireworksHouse_MiddleCheckPoint", LOW_FireworksHouse_MiddleCheckpointWarning_6d07d723-dbb1-c620-2f63-e79f1ceeb4f8, S_LOW_FireworksHouse_BaniteGuard03_af2dde9a-b304-4656-b871-6804ff8247a9, _Player)
THEN
DB_NOOP(1);

IF
KilledBy(_Guard, _AttackOwner, _,_)
AND
DB_LOW_FireworksHouse_BaniteGuards(_Guard)
AND
DB_PartyMembers(_Player)
AND
QRY_IsEnemy(_Guard, _Player)
AND
QRY_OnlyOnce("FireworksHouse_GuardsStartCombat")
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_FireworksHouse_Banites_f1aedb53-13e0-4a04-a037-1be782d39392, 0);

IF
RelationChanged((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)ACT3_LOW_FireworksHouse_Banites_f1aedb53-13e0-4a04-a037-1be782d39392, 0, 1)
THEN
DB_LOW_FireworksHouse_BanitesHostile(1);

//Adds middle floor Banites to ground floor or top floor combat
IF
CombatStarted(_CombatID)
AND
DB_LOW_FireworksHouse_BaniteGuards(_Banite)
AND
DB_Is_InCombat(_Banite, _CombatID)
AND
GetCombatGroupID(_Banite, _GroupID)
AND
DB_LOW_FireworksHouse_CombatGroups(_GroupID)
AND
GetClosestPlayer(_Banite, _Player, _)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
DB_LOW_FireworksHouse_Reinforcements(_Reinforcement)
THEN
PROC_EnterCombat(_Reinforcement, _Player);

// defeat counter
IF
DB_LOW_FireworksHouse_BaniteGuards(_Banite)
THEN
DB_GLO_DefeatCounter(_Banite, "LOW_FireworksHouse_Banites");

IF
DB_LOW_FireworksHouse_Reinforcements(_Banite)
THEN
DB_GLO_DefeatCounter(_Banite, "LOW_FireworksHouse_Banites");

PROC
PROC_GLO_DefeatCounter_AllDefeated("LOW_FireworksHouse_Banites")
THEN
DB_LOW_FireworksHouse_BanitesPermaDefeated(1); // keeping the name for patch compatibility

PROC
PROC_LongRest()
AND
DB_LOW_FireworksHouse_BanitesPermaDefeated(1)
THEN
DB_LOW_FireworksHouse_ClearBanitesOnRest(1);

IF
DB_LOW_FireworksHouse_ClearBanitesOnRest(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_GLO_DefeatCounter(_Banite, "LOW_FireworksHouse_Banites")
AND
NOT DB_PermaDefeatedOrOffstage(_Banite)
AND
NOT DB_KnockedOut((CHARACTER)_Banite)
AND
NOT DB_Surrendered((CHARACTER)_Banite)
THEN
ScatterStoryItems(_Banite);
PurgeOsirisQueue(_Banite);
PROC_SetOnStage(_Banite,0);
PROC_Surrender_Fled((CHARACTER)_Banite);

QRY
QRY_CorpseLooting_BlockMakeOwned((CHARACTER)_Banite)
AND
DB_LOW_FireworksHouse_BanitesHostile(1)
AND
DB_LOW_FireworksHouse_BaniteGuards(_Banite)
THEN
DB_NOOP(1);

//END_REGION


//REGION Exploding Barrel reactivity
IF
AttackedBy(_Barrel, _, _, "Fire", _, _, _)
AND
DB_LOW_FireworksHouse_ExplosiveBarrels(_Barrel)
AND
QRY_OnlyOnce("FireworksHouse_ExplosionUpstairs")
THEN
PROC_TryStartAD(LOW_FireworksHouse_AD_ExplosionUpstairs_671516e4-f61b-40dc-50dc-5a5ed42b1d1e, 
	S_LOW_FireworksHouse_ChildCustomer_7564dced-44e3-41f0-8e1f-0c19c0f36585, 
	S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462, 
	S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7);

//END_REGION

//REGION Reactivity to Avery's death
PROC
PROC_LongRest()
AND
DB_PermaDefeated(S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7)
THEN
DB_LOW_FireworksHouse_ClearCiviliansOnRest(1);

IF
DB_LOW_FireworksHouse_ClearCiviliansOnRest(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
SetOnStage(S_LOW_FireworksHouse_ChildCustomer_7564dced-44e3-41f0-8e1f-0c19c0f36585, 0);
SetOnStage(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462, 0);

IF
DB_LOW_FireworksHouse_BanitesHostile(1)
AND
NOT DB_OffStage(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462)
AND
NOT DB_PermaDefeated(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462)
THEN
PROC_NotifyWhenReadyToMoveOn(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462, "LOW_FireworksHouse_AdultCustomerDisappear_Notify");

PROC
PROC_ReadyToMoveOn(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462, "LOW_FireworksHouse_AdultCustomerDisappear_Notify")
THEN
PROC_DisappearOutOfSight(S_LOW_FireworksHouse_AdultCustomer_de41b3b2-f958-4c32-9c72-b69d60520462, "Run", 0, "");

PROC
PROC_LongRest()
AND
DB_PermaDefeated(S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7)
AND
NOT DB_PermaDefeated(S_LOW_FireworksHouse_BaniteWizard_8844fff4-b1a7-499b-9c63-0ceb581672cc)
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_ExecuteInLevel("LOW_FireworksHouse_LockBlastDoor","CTY_Main_A");

PROC
PROC_ExecuteInLevel("LOW_FireworksHouse_LockBlastDoor","CTY_Main_A")
THEN
SetOwner(S_LOW_FireworksHouse_BlastDoor_b52024ad-0ff4-4e4c-9e95-87432a6d1c88, S_LOW_FireworksHouse_BaniteWizard_8844fff4-b1a7-499b-9c63-0ceb581672cc);
Lock(S_LOW_FireworksHouse_BlastDoor_b52024ad-0ff4-4e4c-9e95-87432a6d1c88, "0bcfe112-6709-494b-a4fc-14991b0b9695");


//END_REGION

//REGION Linking Locked Basement Doors
IF
Unlocked(S_Teleport_Door_FireworksBasement_63500f96-0ba5-4c96-bffd-3579a567f6a4, _, _)
THEN
Unlock(S_DOOR_Fireworks_Teleport_1c51e06d-f73f-4b90-8b38-e3e54759ae18);

IF
Unlocked(S_DOOR_Fireworks_Teleport_1c51e06d-f73f-4b90-8b38-e3e54759ae18, _, _)
THEN
Unlock(S_Teleport_Door_FireworksBasement_63500f96-0ba5-4c96-bffd-3579a567f6a4);

//END_REGION


//REGION Debug

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
