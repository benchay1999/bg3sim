Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Gur FollowUp
// Char, Dialog, Pos
DB_LOW_GurFollowUp_NPCs((CHARACTER)S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, (DIALOGRESOURCE)LOW_GurFollowUp_GurLeader_980793ba-f76a-8a34-7b37-fdc5945ab054, (TRIGGER)S_LOW_GurFollowUp_GurLeaderAppearPos_a761b9dd-057f-4d89-8ad4-7451e11ff285, (TRIGGER)S_LOW_GurFollowUp_GurLeaderPos_708f336e-dafb-446a-b6b1-588adc8a08d7);
DB_LOW_GurFollowUp_NPCs((CHARACTER)S_WYR_GurCamp_Hunter_001_a4ef7429-bca0-4e2f-9aab-a4eff9ac95e9, (DIALOGRESOURCE)LOW_GurFollowUp_Hunter_001_0b8f9811-2411-46dc-792c-2a811e8e08f5, (TRIGGER)S_LOW_GurFollowUp_GurAppearPos_001_8c6df7b3-908e-488b-a781-fe71e60f1657, (TRIGGER)S_LOW_GurFollowUp_GurPos_001_2c3d9aa4-4334-40ce-9faa-be231ec520f4);
DB_LOW_GurFollowUp_NPCs((CHARACTER)S_WYR_GurCamp_Hunter_002_630d63de-ae45-4649-8cbd-563b6d3055ae, (DIALOGRESOURCE)LOW_GurFollowUp_Hunter_002_00fa9c02-8e5f-b541-eb8d-184a96439af1, (TRIGGER)S_LOW_GurFollowUp_GurAppearPos_002_13246879-d476-401e-abfd-455788923ece, (TRIGGER)S_LOW_GurFollowUp_GurPos_002_8c189271-7e3d-4a35-85c2-ec332c44bbf5);
DB_LOW_GurFollowUp_NPCs((CHARACTER)S_WYR_GurCamp_Hunter_003_8948bd61-52a0-41a0-99b8-bb6d4c301255, (DIALOGRESOURCE)LOW_GurFollowUp_Hunter_003_b054b1cd-35e5-9fae-23e2-29133443dd6a, (TRIGGER)S_LOW_GurFollowUp_GurAppearPos_003_8b287019-9357-437f-a8ae-107cbcfc1f98, (TRIGGER)S_LOW_GurFollowUp_GurPos_003_b95a8271-df92-445b-b9f1-f870c51b10e4);
DB_LOW_GurFollowUp_NPCs((CHARACTER)S_WYR_GurCamp_Hunter_004_eb08e3f6-9059-498a-8125-1d9af24ee67f, (DIALOGRESOURCE)LOW_GurFollowUp_Hunter_004_0920fcd1-8b08-9d8c-b72a-f57b47956422, (TRIGGER)S_LOW_GurFollowUp_GurAppearPos_004_af618274-2ac5-4b79-91df-0b39211529e1, (TRIGGER)S_LOW_GurFollowUp_GurPos_004_92b09150-080b-4d7e-88c2-279f91c206e6);
DB_LOW_GurFollowUp_NPCs((CHARACTER)S_WYR_GurCamp_Hunter_005_afbb70d4-5cc4-444f-90b6-0d243b6418c3, (DIALOGRESOURCE)LOW_GurFollowUp_Hunter_005_4e513379-8815-3fba-0a59-1a24e0c849cf, (TRIGGER)S_LOW_GurFollowUp_GurAppearPos_005_99c6d8b7-523f-4f94-af3a-3dd6edd55363, (TRIGGER)S_LOW_GurFollowUp_GurPos_005_3c8f2299-a6aa-4e92-8714-cb57ccd98b78);
DB_LOW_GurFollowUp_NPCs((CHARACTER)S_WYR_GurCamp_Hunter_006_4c42f14a-c99a-4ba0-891c-136bf7ed38bb, (DIALOGRESOURCE)LOW_GurFollowUp_Hunter_006_97706fb3-effc-6abb-eec0-e9e2b392e718, (TRIGGER)S_LOW_GurFollowUp_GurAppearPos_006_c55bd2cc-e71f-4a28-a2af-f411e7df9298, (TRIGGER)S_LOW_GurFollowUp_GurPos_006_be075db7-1ea7-4db7-acca-ce3b10d7c601);

DB_OriginMayLeaveDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)LOW_GurFollowUp_OM_Astarion_COM_d9b5665a-d7b3-ddc0-61a4-6069dcc9f205);

DB_LOW_GurFollowUp_Dialogs(LOW_GurFollowUp_NoAstarion_196dd57e-d1b5-5526-81cb-080b2123c85b);
DB_LOW_GurFollowUp_Dialogs(LOW_GurFollowUp_OM_Astarion_AOM_OOM_5bbdbb15-be05-2f47-52ee-00683dd44700);
DB_LOW_GurFollowUp_Dialogs(LOW_GurFollowUp_OM_Astarion_COM_d9b5665a-d7b3-ddc0-61a4-6069dcc9f205);

DB_LOW_GurFollowUp_AstarionDeadDialogs((CHARACTER)S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, (DIALOGRESOURCE)LOW_GurFollowUp_AD_GurLeaderAfterKillingAstarion_0eb12662-df08-1a00-960f-38780f3d42ab);
DB_LOW_GurFollowUp_AstarionDeadDialogs((CHARACTER)S_WYR_GurCamp_Hunter_001_a4ef7429-bca0-4e2f-9aab-a4eff9ac95e9, (DIALOGRESOURCE)LOW_GurFollowUp_AD_GurTribeMemberAfterKillingAstarion_6fd18eaa-adae-b42b-0fa4-cae5ad4aa717);
DB_LOW_GurFollowUp_AstarionDeadDialogs((CHARACTER)S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, (DIALOGRESOURCE)LOW_GurFollowUp_AD_GurTribeMemberAfterKillingAstarion_6fd18eaa-adae-b42b-0fa4-cae5ad4aa717);
DB_LOW_GurFollowUp_AstarionDeadDialogs((CHARACTER)S_WYR_GurCamp_Hunter_003_8948bd61-52a0-41a0-99b8-bb6d4c301255, (DIALOGRESOURCE)LOW_GurFollowUp_AD_GurTribeMemberAfterKillingAstarion_6fd18eaa-adae-b42b-0fa4-cae5ad4aa717);
DB_LOW_GurFollowUp_AstarionDeadDialogs((CHARACTER)S_WYR_GurCamp_Hunter_004_eb08e3f6-9059-498a-8125-1d9af24ee67f, (DIALOGRESOURCE)LOW_GurFollowUp_AD_GurTribeMemberAfterKillingAstarion_6fd18eaa-adae-b42b-0fa4-cae5ad4aa717);
DB_LOW_GurFollowUp_AstarionDeadDialogs((CHARACTER)S_WYR_GurCamp_Hunter_006_4c42f14a-c99a-4ba0-891c-136bf7ed38bb, (DIALOGRESOURCE)LOW_GurFollowUp_AD_GurTribeMemberAfterKillingAstarion_6fd18eaa-adae-b42b-0fa4-cae5ad4aa717);

// NPC, PositionInSewers, AppearFrom, Dialog
DB_LOW_GurFollowUp_GurFamilyInSewers((CHARACTER)S_GLO_GurHunter_0e47fcb9-c0c4-4b0c-902b-2d13d209e760, 
	(TRIGGER)S_LOW_GurFollowUp_Undercity_GurHunter_Pos_38831887-08d4-4352-8df3-c17147c36ab2, 	
	(TRIGGER)S_LOW_GurFollowUp_Sewers_GurHunterAppearPosition_2f6cd20e-4c18-49ca-9716-c6ee84ab5b20,
	(DIALOGRESOURCE)LOW_GurFollowUp_GurHunter_86d918f2-a58d-eb0c-8388-8e1f7cd9eeac);
DB_LOW_GurFollowUp_GurFamilyInSewers((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_001_1fe747aa-f154-4507-b678-d51b3fffd20c, 
	(TRIGGER)S_LOW_GurFollowUp_Undercity_Child_001_Pos_22f96fc4-dee8-40e8-90fe-02f29a456ab1, 	
	(TRIGGER)S_LOW_GurFollowUp_Sewers_KidsAppearPosition_f1d71ad7-f402-4797-a9b8-76f70baa5066,
	(DIALOGRESOURCE)LOW_GurFollowUp_Spawn_002_fef94050-4072-29db-3ab8-07e4abc59eed);
DB_LOW_GurFollowUp_GurFamilyInSewers((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_002_5086decf-b8f4-420d-84e0-487338a90f20, 
	(TRIGGER)S_LOW_GurFollowUp_Undercity_Child_002_Pos_0c44a152-10d6-4626-9b47-9d5e2e7222c0, 	
	(TRIGGER)S_LOW_GurFollowUp_Sewers_KidsAppearPosition_f1d71ad7-f402-4797-a9b8-76f70baa5066,
	(DIALOGRESOURCE)LOW_GurFollowUp_Spawn_001_2e58197c-5b69-0e3c-efee-02a1f3197cf7);
//END_REGION
KBSECTION
//REGION Gur FollowUp
IF
DB_PermaDefeated(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
THEN
PROC_LOW_CazadorsPalace_PrepareGur();

PROC
PROC_LOW_CazadorsPalace_PrepareGur()
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_GurFollowUp_State_InDungeon_1f27517e-bbdf-4b45-8ab4-2c612650311e);

PROC
PROC_LOW_CazadorsPalace_PrepareGur()
AND
DB_WYR_GurCamp_IntroNPCs(_NPC)
THEN
PROC_SpotPlayers_StopSpotting(_NPC, "WYR_GurCamp_Intro");

PROC
PROC_LOW_CazadorsPalace_PrepareGur()
AND
DB_LOW_GurFollowUp_NPCs(_Gur, _Dialog, _AppearPos, _)
AND
DB_Defeated(_Gur)
THEN
PROC_SetOnStage(_Gur, 0);

PROC
PROC_LOW_CazadorsPalace_PrepareGur()
AND
DB_LOW_GurFollowUp_NPCs(_Gur, _Dialog, _AppearPos, _)
AND
NOT DB_Defeated(_Gur)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Gur);
DB_Dialogs(_Gur, _Dialog);
TeleportTo(_Gur, _AppearPos, "LOW_GurFollowUp_GurTeleported");
DB_GLO_DefeatCounter(_Gur, "LOW_GurFollowUp_GurFight");

// in case one of the players is near the elevator where they are supposed to appear
// we make it look like they uses the elevator and are now taking their positions
IF
EntityEvent((CHARACTER)_Gur, "LOW_GurFollowUp_GurTeleported")
AND
Random(1500, _Random)
THEN
RealtimeObjectTimerLaunch(_Gur, "LOW_GurFollowUp_AppearDelay", _Random);

IF
ObjectTimerFinished((CHARACTER)_Gur, "LOW_GurFollowUp_AppearDelay")
AND
DB_LOW_GurFollowUp_NPCs(_Gur, _, _, _Pos)
THEN
PROC_CharacterMoveTo(_Gur, _Pos, "Walk", "LOW_GurFollowUp_GurMovedToDefaultPos");

IF
EntityEvent((CHARACTER)_Gur, "LOW_GurFollowUp_GurMovedToDefaultPos")
AND
DB_LOW_GurFollowUp_NPCs(_Gur, _, _, _Pos)
THEN
LookFromTrigger(_Gur, _Pos, 0);

PROC
PROC_LOW_CazadorsPalace_PrepareGur()
AND
NOT DB_GlobalFlag((FLAG)WYR_GurCamp_State_PermanentlyHostile_32116fb3-5f46-4dda-8972-69a3d76cd6aa)
THEN
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)LOW_GurFollowUp_NoAstarion_196dd57e-d1b5-5526-81cb-080b2123c85b,
	(TAG)ASTARION_23a46e79-e73c-4043-940f-cb0aace9ab2e, 
	LOW_GurFollowUp_OM_Astarion_AOM_OOM_5bbdbb15-be05-2f47-52ee-00683dd44700,
	LOW_GurFollowUp_OM_Astarion_COM_d9b5665a-d7b3-ddc0-61a4-6069dcc9f205,
	LOW_GurFollowUp_OM_Astarion_AOM_OOM_5bbdbb15-be05-2f47-52ee-00683dd44700);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)LOW_GurFollowUp_OM_Astarion_COM_d9b5665a-d7b3-ddc0-61a4-6069dcc9f205, 30.0);
DB_OriginMoment_MaxDistance((DIALOGRESOURCE)LOW_GurFollowUp_OM_Astarion_AOM_OOM_5bbdbb15-be05-2f47-52ee-00683dd44700, 30.0);
DB_DropMutingStatussesDialog(LOW_GurFollowUp_NoAstarion_196dd57e-d1b5-5526-81cb-080b2123c85b);

QRY
QRY_OriginMoment_PreventRelaunchDialog(LOW_GurFollowUp_OM_Astarion_AOM_OOM_5bbdbb15-be05-2f47-52ee-00683dd44700, _, _)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_PreventRelaunchDialog(LOW_GurFollowUp_OM_Astarion_COM_d9b5665a-d7b3-ddc0-61a4-6069dcc9f205, _, _)
THEN
DB_NOOP(1);

IF
EntityEvent(S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, "LOW_GurFollowUp_GurTeleported")
AND
NOT DB_GlobalFlag((FLAG)WYR_GurCamp_State_PermanentlyHostile_32116fb3-5f46-4dda-8972-69a3d76cd6aa)
THEN
DB_SpotPlayers_SpotTrigger(S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, "LOW_GurFollowUp_GurLeader", (TRIGGER)S_LOW_GurFollowUp_SpotTrigger_58bfa063-99d1-4c3b-a68f-634c65655d0f);
DB_SpotPlayers(S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, "LOW_GurFollowUp_GurLeader", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

// Gur People kill all hostilies when they infiltrate the mansion
// but only if there is no player in the mansion
IF
EntityEvent(S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, "LOW_GurFollowUp_GurTeleported")
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_LOW_CazadorsPalace_GroundLevelArea_ee9690f0-fa9a-4d39-b467-d12c28bf6e19)
THEN
PROC_LOW_GurFollowUp_KillHostileNPCs();
PROC_LOW_GurFollowUp_UnlockDoors();

PROC
PROC_LOW_GurFollowUp_KillHostileNPCs()
THEN
PROC_LOW_GurFollowUp_CheckKillHostileNPC((CHARACTER)S_LOW_CazadorsPalace_Kennel_Skeleton_f2a457d8-f2e5-430b-9a53-85746171482f);

PROC
PROC_LOW_GurFollowUp_KillHostileNPCs()
AND
DB_LOW_CazadorsPalace_Ballroom_NPCs(_NPC)
THEN
PROC_LOW_GurFollowUp_CheckKillHostileNPC(_NPC);

PROC
PROC_LOW_GurFollowUp_KillHostileNPCs()
AND
DB_LOW_CazadorsPalace_Servants(_NPC, _)
THEN
PROC_LOW_GurFollowUp_CheckKillHostileNPC(_NPC);

PROC
PROC_LOW_GurFollowUp_KillHostileNPCs()
AND
DB_LOW_CazadorsPalace_GuardTower_Rats(_NPC, _)
THEN
PROC_LOW_GurFollowUp_CheckKillHostileNPC(_NPC);

PROC
PROC_LOW_GurFollowUp_CheckKillHostileNPC((CHARACTER)_NPC)
AND
NOT DB_PermaDefeated(_NPC)
THEN
Die(_NPC, DEATHTYPE.Physical, 1);

// the second door will be unlocked automatically
PROC
PROC_LOW_GurFollowUp_UnlockDoors()
AND
IsLocked((ITEM)S_LOW_CazadorsPalace_InteriorDoor_7955d456-bd48-4491-a0d2-49b98d660a7e, 1)
THEN
Unlock(S_LOW_CazadorsPalace_InteriorDoor_7955d456-bd48-4491-a0d2-49b98d660a7e);

PROC
PROC_LOW_GurFollowUp_UnlockDoors()
AND
IsLocked((ITEM)S_LOW_CazadorsPalace_Kennel_Door_b52934e3-1be1-4073-afae-38caeed0d584, 1)
THEN
Unlock(S_LOW_CazadorsPalace_Kennel_Door_b52934e3-1be1-4073-afae-38caeed0d584);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, "LOW_GurFollowUp_GurLeader", _Player)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_GurFollowUp_NoAstarion_196dd57e-d1b5-5526-81cb-080b2123c85b, S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, _Player)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)GLO_Companion_Combat_d8f0c309-193b-eaed-5aaa-812cd137caf2, _, _ID)
AND
DB_DialogName(LOW_GurFollowUp_OM_Astarion_COM_d9b5665a-d7b3-ddc0-61a4-6069dcc9f205, _ID)
THEN
PROC_GlobalSetFlagAndCache(LOW_GurFollowUp_State_BetrayedAstarion_d1683786-f95c-4113-8465-7468f6ef75cf);

IF
DialogEnded(_Dialog, _)
AND
DB_LOW_GurFollowUp_Dialogs(_Dialog)
AND
DB_GlobalFlag(ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
DB_GlobalFlag(LOW_GurFollowUp_State_BetrayedAstarion_d1683786-f95c-4113-8465-7468f6ef75cf)
THEN
PROC_SetRelationMutual((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)ACT3_WYR_GurCamp_87fe8d0d-31c9-4b10-8fc6-f0c232c24b13, 100);
DB_GLO_DefeatCounter(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_GurFollowUp_AstarionFight");
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_GurFollowUp_AstarionFight", LOW_GurFollowUp_State_KilledAstarion_94ca72ad-9b37-4ce5-baa9-959fcfad14d0);

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_GurFollowUp_AstarionFight")
THEN
PROC_LOW_GurFollowUp_QueueGurTribeRemovalFromDungeon();

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_GurFollowUp_AstarionFight")
AND
DB_LOW_GurFollowUp_AstarionDeadDialogs(_NPC, _Dialog)
AND
NOT DB_CantTalk(_NPC)
AND
QRY_OnlyOnce("LOW_GurFollowUp_AD_AfterKillingAstarion")
THEN
PROC_TryStartAD(_Dialog, _NPC);

IF
DialogEnded(_Dialog, _)
AND
DB_LOW_GurFollowUp_Dialogs(_Dialog)
AND
DB_GlobalFlag(ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
NOT DB_GlobalFlag(LOW_GurFollowUp_State_BetrayedAstarion_d1683786-f95c-4113-8465-7468f6ef75cf)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_WYR_GurCamp_87fe8d0d-31c9-4b10-8fc6-f0c232c24b13, 0);
DB_PermaDefeatedFlag(S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, LOW_GurFollowUp_State_GurPermaDefeated_7e06a146-ffc8-4491-bed2-9de18acf4883);

// reaction from Astarion
PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_GurFollowUp_GurFight")
AND
NOT DB_Avatars(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_CantTalk(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
GetDistanceTo(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890, _Dist)
AND
_Dist < 20.0
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_GurFollowUp_PAD_AstarionAfterKillingGur_c3b643a6-55df-7597-bdc9-6800ba23da3c, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);

IF
DialogEnded(_Dialog, _)
AND
DB_LOW_GurFollowUp_Dialogs(_Dialog)
AND
NOT DB_GlobalFlag(ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5)
AND
NOT DB_LOW_GurFollowUp_GurTribeRemovalQueued(1)
THEN
PROC_LOW_GurFollowUp_QueueGurTribeRemovalFromDungeon();

PROC
PROC_LOW_GurFollowUp_QueueGurTribeRemovalFromDungeon()
THEN
DB_LOW_GurFollowUp_GurTribeRemovalQueued(1); // we'll remove them after the player leaves the area
PROC_DangerZone_Safe("LOW_CazadorsPalace_GroundLevelArea");
PROC_DangerZone_Safe("LOW_CazadorsPalace_DungeonArea");
//END_REGION

//REGION Remove all Gur people from the Dungeon
IF
LeftTrigger(_Player, (TRIGGER)S_LOW_CazadorsPalace_DungeonArea_1d0aed1e-824c-4604-ab04-8e0a33827df0)
AND
DB_Players(_Player)
AND
DB_LOW_GurFollowUp_GurTribeRemovalQueued(1)
AND
NOT QRY_TriggerEvents_AnyPlayerInTrigger(S_LOW_CazadorsPalace_DungeonArea_1d0aed1e-824c-4604-ab04-8e0a33827df0)
THEN
PROC_LOW_GurFollowUp_RemoveGurTribeFromDungeon();
PROC_LOW_GurFollowUp_GurTribeLeftDungeon();

PROC
PROC_LOW_GurFollowUp_RemoveGurTribeFromDungeon()
AND
DB_LOW_GurFollowUp_NPCs(_NPC, _, _, _)
AND
NOT DB_OffStage(_NPC)
AND
NOT DB_Defeated(_NPC)
THEN
PROC_SetOnStage(_NPC, 0);
//END_REGION

//REGION If Gur Hunter is alive and his kids were release they appear in the Sewers
PROC
PROC_LOW_GurFollowUp_GurTribeLeftDungeon()
AND
DB_LOW_GurFollowUp_NPCs(S_GLO_GurHunter_0e47fcb9-c0c4-4b0c-902b-2d13d209e760, _, _, _)
AND
NOT DB_Defeated(S_GLO_GurHunter_0e47fcb9-c0c4-4b0c-902b-2d13d209e760)
AND
DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240)
THEN
PROC_LOW_GurFollowUp_SendGurFamilyToSewers();

PROC
PROC_LOW_GurFollowUp_SendGurFamilyToSewers()
AND
DB_LOW_GurFollowUp_GurFamilyInSewers(_NPC, _, _AppearPosition, _)
AND
HasActiveStatus(_NPC, "LOW_CAZADORSPALACE_PRISONER_INVULNERABILITY", 1)
THEN
RemoveStatus(_NPC, "LOW_CAZADORSPALACE_PRISONER_INVULNERABILITY");

PROC
PROC_LOW_GurFollowUp_SendGurFamilyToSewers()
AND
DB_LOW_GurFollowUp_GurFamilyInSewers(_NPC, _, _AppearPosition, _)
THEN
TeleportTo(_NPC, _AppearPosition, "LOW_GurFollowUp_AppearedInSewers");

IF
EntityEvent(S_GLO_GurHunter_0e47fcb9-c0c4-4b0c-902b-2d13d209e760, "LOW_GurFollowUp_AppearedInSewers")
THEN
SetFlag((FLAG)LOW_GurFollowUp_State_GurHunterInSewers_d221bb1e-db32-40c5-8eb0-07714a272a1e);

IF
EntityEvent((CHARACTER)_NPC, "LOW_GurFollowUp_AppearedInSewers")
AND
DB_LOW_GurFollowUp_GurFamilyInSewers(_NPC, _StandingPos, _, _Dialog)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_NPC);
DB_Dialogs(_NPC, _Dialog);
PROC_SetOnStage(_NPC, 1);
PROC_CharacterMoveTo(_NPC, _StandingPos, "Walk", "LOW_GurFollowUp_ArrivedAtPositionInSewers");
ClearTag(_NPC, (TAG)IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);

IF
EntityEvent((CHARACTER)_NPC, "LOW_GurFollowUp_ArrivedAtPositionInSewers")
AND
DB_LOW_GurFollowUp_GurFamilyInSewers(_NPC, _StandingPos, _, _)
THEN
LookFromTrigger(_NPC, _StandingPos, 0);

QRY
QRY_SelectCustomDialog_AfterGenerics((CHARACTER)_NPC, _Player)
AND
DB_LOW_GurFollowUp_GurFamilyInSewers(_NPC, _, _, _)
AND
NOT DB_OnlyOnce("LOW_GurFollowUp_GurFamilyDialogHappened")
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GLO_GurHunter_0e47fcb9-c0c4-4b0c-902b-2d13d209e760, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_CazadorsPalace_Cells_Child_001_1fe747aa-f154-4507-b678-d51b3fffd20c, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_CazadorsPalace_Cells_Child_002_5086decf-b8f4-420d-84e0-487338a90f20, _Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_GurFollowUp_GurHunterInUndercity_36ab172d-8170-4b87-2183-654fab77bdcd, 
	S_GLO_GurHunter_0e47fcb9-c0c4-4b0c-902b-2d13d209e760, 
	_Player, 
	S_LOW_CazadorsPalace_Cells_Child_002_5086decf-b8f4-420d-84e0-487338a90f20,
	S_LOW_CazadorsPalace_Cells_Child_001_1fe747aa-f154-4507-b678-d51b3fffd20c);

IF
DialogStarted((DIALOGRESOURCE)LOW_GurFollowUp_GurHunterInUndercity_36ab172d-8170-4b87-2183-654fab77bdcd, _)
THEN
DB_OnlyOnce("LOW_GurFollowUp_GurFamilyDialogHappened");
//END_REGION Gur FollowUp

//REGION Debug
IF
TextEvent("gf_appear")
THEN
PROC_DebugBook_AddGurHunterToGurTribe();
PROC_LOW_CazadorsPalace_PrepareGur();

IF
TextEvent("gf_tosewers")
THEN
PROC_LOW_GurFollowUp_QueueGurTribeRemovalFromDungeon();
PROC_LOW_GurFollowUp_GurTribeLeftDungeon();

IF
TextEvent("gf_kill")
THEN
PROC_LOW_GurFollowUp_KillHostileNPCs();
//END_REGION Debug
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
