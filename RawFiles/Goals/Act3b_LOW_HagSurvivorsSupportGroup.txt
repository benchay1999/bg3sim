Version 1
SubGoalCombiner SGC_AND
INITSECTION
PROC_SetOnStage((ITEM)S_Graveyard_MayrinaHusbandTombstone_8f7478bb-9913-4f4f-bd92-8592d35f7caf, 0);
PROC_SetOnStage(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,0);
PROC_SetOnStage(S_LOW_HagSurvivors_MayrinasNote_95c84ab5-1eed-4c0f-950a-89b8862d229c,0);

// BG Hag Survivors
DB_Dialogs((CHARACTER)S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0, (DIALOGRESOURCE)LOW_HagSurvivors_Kleidunn_b808f141-5299-a1da-2544-060f9a7a7e4a);
DB_Dialogs((CHARACTER)S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6, (DIALOGRESOURCE)LOW_HagSurvivors_Adrielle_b86566c4-3420-8842-a29e-19c0b72300dd);
DB_Dialogs((CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f, (DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_46f2decb-c31e-06ec-4c8c-3487f9a56a03);

DB_CorpseCleanup_Ignore((CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f);

DB_LOW_HagSurvivors((CHARACTER)S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0);
DB_LOW_HagSurvivors(S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6);
DB_LOW_HagSurvivors(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f);
ApplyStatus(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HAGSPY_DISGUISE",-1.0);
DB_PermaDefeatedFlag((CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,(FLAG)LOW_HagSurvivors_State_HagSpy_PermaDefeated_e62f1c84-d463-4c2e-ba55-aa6e558ec43c);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_Event_HagSpy_DropDisguise_c60c37b3-852c-431c-8f82-0285551cdfd6,(DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_Aggroed_41621532-a3a0-8d9a-de88-729d5cdc18a2);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_Event_HagSpy_DropDisguise_c60c37b3-852c-431c-8f82-0285551cdfd6,(DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_46f2decb-c31e-06ec-4c8c-3487f9a56a03);
PROC_SetRelationMutual((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,(FACTION)ACT3_LOW_HagSurvivors_HagSpy_a18d972a-d3be-43fe-b13f-1f280b3f48aa,100);

// Tracking PermaDefeateding all hag survivors (excluding hag spy), survivors from Act I are added in case of arriving in the city
DB_GLO_DefeatCounter(S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6,"LOW_HagSurvivors_PermaDefeated");
DB_GLO_DefeatCounter(S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0,"LOW_HagSurvivors_PermaDefeated");
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("LOW_HagSurvivors_PermaDefeated",(FLAG)LOW_HagSurvivors_State_AllSurvivorsPermaDefeated_a400a1bf-add8-48c3-8b45-096e2b9fb233);
DB_GLO_DefeatCounter_IgnoreWaitForCombatEnd("LOW_HagSurvivors_PermaDefeated");

DB_LOW_HagSurvivors_Factions((FACTION)ACT3_LOW_HagSurvivors_HagSpy_a18d972a-d3be-43fe-b13f-1f280b3f48aa);
DB_LOW_HagSurvivors_Factions((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54);

// Act I Hag Survivors
DB_LOW_ActI_HagSurvivors((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(TRIGGER)S_LOW_HagSurvivors_SurrogateMotherSpot_6fc81c53-b113-4d70-b864-aa5e3aaec46d,(DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_SheepForm_0f9bbd49-0a64-e33f-3149-015a0a9f31e8);
DB_LOW_ActI_HagSurvivors(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8, S_LOW_HagSurvivors_HydrangeaSpot_8309f144-86d3-485a-be57-3dc4d623c78d, LOW_HagSurvivors_MaskedVictim1_9174eeda-dcfd-cdbc-c650-1bee3a363d30);
DB_Inclusion_Object((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8, (FLAG)LOW_HagSurvivors_Hag_MaskedVictim1_StartInclusion_ac29f6c1-9e02-441e-89e3-1f619af3f456, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_Object((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, (FLAG)LOW_HagSurvivors_Hagspawn_SurrogateMother_StartInclusion_7407cc4b-4cce-4f5d-8f55-73eeac89add1, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_FirstMeeting_Adrielle_Kleidunn_Jatlo_7b610a39-dc3f-67f4-9301-94ba052ee9e9, (CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_DisguisedJatloInstaDied_99b8ec9b-eb83-92b5-0a84-f1b4e1dcbed8, (CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_DisguisedJatloInstaDied_99b8ec9b-eb83-92b5-0a84-f1b4e1dcbed8, (CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_SurvivorsFightAlongsideHagSpy_d8d6dcb0-836d-4c68-b28f-6357db9956fe,(DIALOGRESOURCE)LOW_HagSurvivors_FirstMeeting_Adrielle_Kleidunn_Jatlo_7b610a39-dc3f-67f4-9301-94ba052ee9e9);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_MayrinaDestroyedHusbandWand_fde722e6-b512-4fe4-8a2e-de00027a4856,(DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_Cured_f776ecd3-8e2a-2c91-645c-5a91e0f5d646);

// Commented out in case it is decided taht the ownership trigger is needed for the survivors
/*
DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_HagSurvivors_HagSpy_OwnershipTrigger_43b2d0e9-2149-4fca-900d-106158f1fd7c,(CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f);
ClearOwnership((ITEM)DOOR_Dungeon_Shar_Temple_Door_Single_B_004_37e3be81-3030-cf8b-8653-8d016e13f7a2);
ClearOwnership((ITEM)DOOR_Dungeon_Shar_Temple_Door_Single_B_007_74b3e9e2-a385-c8ce-940a-38ed68182817);
ClearOwnership((ITEM)DOOR_Dungeon_Shar_Temple_Door_Single_B_006_c5b6b90a-5188-cc3a-8dc1-4149c6828b19);
*/

// Preventing edge case of Mayrina disappearance on long rest in case of being knocked out during survivors' perma-hostility period.
DB_DoNotRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

DB_SpotPlayers((CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_SurvivorsFirstMeeting_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers((CHARACTER)S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6,"LOW_SurvivorsFirstMeeting_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers((CHARACTER)S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0,"LOW_SurvivorsFirstMeeting_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

DB_LOW_SurvivorsFirstMeeting_SceneInterrupts("Attacked");
DB_LOW_SurvivorsFirstMeeting_SceneInterrupts("EneteredCombat");

DB_LOW_JatloInstaDied_MandatorySpeakers(S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6);
DB_LOW_JatloInstaDied_MandatorySpeakers(S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0);

// Important dialogs that should start on spotting players
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_HagSurvivors_FirstMeeting_Adrielle_Kleidunn_Jatlo_7b610a39-dc3f-67f4-9301-94ba052ee9e9);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_HagSurvivors_DisguisedJatloInstaDied_99b8ec9b-eb83-92b5-0a84-f1b4e1dcbed8);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_Aggroed_41621532-a3a0-8d9a-de88-729d5cdc18a2);

DB_LOW_VoodooDollTeleportSpots((GUIDSTRING)S_LOW_HagSurvivors_VoodooDollTeleportSpot_01_a67bd5d1-cc51-4ff1-ae9f-83b00b472097);
DB_LOW_VoodooDollTeleportSpots((GUIDSTRING)S_LOW_HagSurvivors_VoodooDollTeleportSpot_02_9cd2b3ed-c109-4f69-9587-d1f112efefd4);
DB_LOW_VoodooDollTeleportSpots((GUIDSTRING)S_LOW_HagSurvivors_VoodooDollTeleportSpot_03_9cce486d-3616-438d-83a0-2500be9c6f55);
DB_LOW_VoodooDollTeleportSpots((GUIDSTRING)S_LOW_HagSurvivors_VoodooDollTeleportSpot_04_c535f6c0-fe53-4eb6-9edd-30aa296f7424);
DB_LOW_VoodooDollTeleportSpots((GUIDSTRING)S_LOW_HagSurvivors_VoodooDollTeleportSpot_05_9e1d1a11-5a68-4ddd-9384-8eb307b1a696);
DB_LOW_VoodooDollTeleportSpots((GUIDSTRING)S_LOW_HagSurvivors_VoodooDollTeleportSpot_06_111244b4-288a-4ed2-94d4-7df3d01bffc4);
DB_LOW_CurentVoodooDollTeleportSpot((GUIDSTRING)S_LOW_HagSurvivors_VoodooDollTeleportSpot_01_a67bd5d1-cc51-4ff1-ae9f-83b00b472097);
PROC_LOW_SetVoodooDollPotentialDestinations();
PROC_LOW_VoodooDollToDefaultSpot();

DB_Inclusion_Object((CHARACTER)S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6, (FLAG)LOW_HagSurvivors_Adrielle_StartInclusion_0054a6ab-cf77-4ba1-8081-3cd917fe1a18, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_Object((CHARACTER)S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0, (FLAG)LOW_HagSurvivors_Kleidunn_StartInclusion_69d2ac07-3df8-4586-8285-ccdcb3783362, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_AD_DropsDisguise_HagSpy_61774322-1c4c-6bae-1da4-1c0533a969fb, (CHARACTER)S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_AD_DropsDisguise_HagSpy_61774322-1c4c-6bae-1da4-1c0533a969fb, (CHARACTER)S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_AD_DropsDisguise_HagSpy_61774322-1c4c-6bae-1da4-1c0533a969fb, (CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_Aggroed_41621532-a3a0-8d9a-de88-729d5cdc18a2, (CHARACTER)S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_Aggroed_41621532-a3a0-8d9a-de88-729d5cdc18a2, (CHARACTER)S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_Aggroed_41621532-a3a0-8d9a-de88-729d5cdc18a2, (CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_DisguisedJatloInstaDied_99b8ec9b-eb83-92b5-0a84-f1b4e1dcbed8, (CHARACTER)S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_DisguisedJatloInstaDied_99b8ec9b-eb83-92b5-0a84-f1b4e1dcbed8, (CHARACTER)S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_AD_SurvivorsSeeHagSpyInstaDie_c74861c8-d01a-7faf-92a5-b0326b9b0d15, (CHARACTER)S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_AD_SurvivorsSeeHagSpyInstaDie_c74861c8-d01a-7faf-92a5-b0326b9b0d15, (CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8);
DB_Inclusion_CombatInclusionDialog(LOW_HagSurvivors_AD_DropsDisguise_HagSpy_61774322-1c4c-6bae-1da4-1c0533a969fb);

DB_PermaDefeatedFlag(S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6,(FLAG)LOW_HagSurvivors_State_Adrielle_PermaDefeated_2904c062-d139-4fc5-9031-3826c19f0645);
DB_PermaDefeatedFlag(S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0,(FLAG)LOW_HagSurvivors_State_Kleidunn_PermaDefeated_e0548f7a-eb4a-4a03-8470-6b9a82a5e56c);
DB_PermaDefeatedFlag(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,(FLAG)LOW_HagSurvivors_State_Hag_MaskedVictim1_PermaDefeated_9d57d5e3-9cf8-49e5-b70f-662450a1aeb0);
DB_PermaDefeatedFlag(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(FLAG)LOW_HagSurvivors_State_SurrogateMother_PermaDefeated_4391ae06-20bf-4e37-bbca-63519c550d0c);

// Combat stub for when hag wasn't defeated in Act 1 and thus hag surviors are not in the city
DB_LOW_HagSurvivors_Bandits((CHARACTER)S_LOW_HagSurvivors_Bandit_Fighter_01_4e3bb260-3d2e-48b0-86cf-c2693592915b);
DB_LOW_HagSurvivors_Bandits(S_LOW_HagSurvivors_Bandit_Bard_01_ede83d7d-ba00-4064-aa8c-0bab713b3518);
DB_LOW_HagSurvivors_Bandits(S_LOW_HagSurvivors_Bandit_Wizard_01_e17a32d6-78e5-4c33-b718-c548c058aac4);
DB_LOW_HagSurvivors_Bandits(S_LOW_HagSurvivors_Bandit_Warlock_01_1802e84d-f136-43c6-9c41-2c934ae56fa3);
DB_LOW_HagSurvivors_Bandits(S_LOW_HagSurvivors_Bandit_Barbarian_01_9b19aa71-7d43-4f63-9aee-dd9a5e09fede);
DB_LOW_HagSurvivors_Bandits(S_LOW_HagSurvivors_Bandit_Paladin_01_2eda24ed-9fca-4020-b514-4e041a1247f8);

DB_CombatReact_AD_OnEntered(S_LOW_HagSurvivors_Bandit_Fighter_01_4e3bb260-3d2e-48b0-86cf-c2693592915b,(DIALOGRESOURCE)LOW_HagSurvivors_AD_Bandits_CombatStart_69c639db-e37e-0d46-c78a-c8177b6270e4);
DB_Inclusion_Object((CHARACTER)S_LOW_HagSurvivors_Bandit_Bard_01_ede83d7d-ba00-4064-aa8c-0bab713b3518, (FLAG)LOW_HagSurvivors_Bandit_Bard_01_StartInclusion_cca5528b-d770-45b5-8b20-6627d108dc29, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_Object((CHARACTER)S_LOW_HagSurvivors_Bandit_Wizard_01_e17a32d6-78e5-4c33-b718-c548c058aac4, (FLAG)LOW_HagSurvivors_Bandit_Wizard_01_StartInclusion_c541f43e-a557-4ab8-b1ae-75691164f87b, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_AD_Bandits_CombatStart_69c639db-e37e-0d46-c78a-c8177b6270e4, (CHARACTER)S_LOW_HagSurvivors_Bandit_Bard_01_ede83d7d-ba00-4064-aa8c-0bab713b3518);
DB_Inclusion_NPCDialog((DIALOGRESOURCE)LOW_HagSurvivors_AD_Bandits_CombatStart_69c639db-e37e-0d46-c78a-c8177b6270e4, (CHARACTER)S_LOW_HagSurvivors_Bandit_Wizard_01_e17a32d6-78e5-4c33-b718-c548c058aac4);
DB_Inclusion_CombatInclusionDialog(LOW_HagSurvivors_AD_Bandits_CombatStart_69c639db-e37e-0d46-c78a-c8177b6270e4);

// The book that hints players about the quest grenade to save Vanra along with the required base extract are found in the hag survivors owned chest
DB_LOW_HagSurvivorsQuestBookChest(S_LOW_HagSurvivors_HagLoreBookChest_fd0fe386-dbcd-41dc-a6fb-40def976190e);

//REGION LOW_AvengeHagSurvivors quest
DB_QuestDef_ChainedState("LOW_SaveHaggedChild","HagCellarRetreat","LOW_AvengeHagSurvivors","HagCellarRetreat");
DB_QuestDef_ChainedState("LOW_SaveHaggedChild","DealWithHag","LOW_AvengeHagSurvivors","DealWithHag");
DB_QuestDef_ChainedState("LOW_SaveHaggedChild","HagBossFightStarted_BrokeDeal","LOW_AvengeHagSurvivors","HagBossFightStarted_BrokeDeal");
DB_QuestDef_ChainedState("LOW_SaveHaggedChild","HagBossFightStarted","LOW_AvengeHagSurvivors","HagBossFightStarted");

DB_QuestDef_State((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,"LOW_AvengeHagSurvivors","HagPermaDefeated");
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_PlayersKilledMayrina_75ea3027-8e3c-489b-a497-31889a83975a,"LOW_AvengeHagSurvivors","MayrinaKilledByPlayer");
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_KillHagQuestCompleted_300469ac-2022-4b4b-85f1-b611ba4abfee,"LOW_AvengeHagSurvivors","ToldSurvivorsHagTrulyDead");

// COMPLETION steps
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_AllSurvivorsPermaDefeated_a400a1bf-add8-48c3-8b45-096e2b9fb233,"LOW_AvengeHagSurvivors","AllSurvivorsPermaDefeated");
DB_QuestDef_ChainedState("LOW_SaveHaggedChild","EnteredEND_MadeHagDeal","LOW_AvengeHagSurvivors","EnteredEND_MadeHagDeal");
//END_REGION

//REGION LOW_BreakHagHex
DB_QuestDef_State((FLAG)LOW_HagSurvivors_Knows_MayrinaHexed_37f1da5e-0550-2f73-f8a8-229a8d896999,"LOW_BreakHagHex","KnowsMayrinaIsCursed");
DB_QuestDef_State((FLAG)LOW_HagSurvivors_Knows_SurvivorsHauntedByDoll_ef0e7ffe-3bf9-483d-8caf-5aa845bfef59,"LOW_BreakHagHex","KnowsAboutVoodooDoll_NoMayrina");
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_SurvivorsFightAlongsideHagSpy_d8d6dcb0-836d-4c68-b28f-6357db9956fe,"LOW_BreakHagHex","SurvivorsFightAlongsideJatlo");

DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HagSurvivors_SurrogateMother_MentionedDoll_c9485e65-b01e-d8b1-9392-02aaffe8693c,"LOW_BreakHagHex","KnowsDollCausedCurse_Sheep",0,(FLAG)LOW_HagSurvivors_State_ReadMayrinasNote_3c9a4e69-a315-4a37-a677-fc9a59070714);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HagSurvivors_State_ReadMayrinasNote_3c9a4e69-a315-4a37-a677-fc9a59070714,"LOW_BreakHagHex","KnowsDollCausedCurse_Note",0,LOW_HagSurvivors_SurrogateMother_MentionedDoll_c9485e65-b01e-d8b1-9392-02aaffe8693c);

// Quest updates checked to track whether players know about Old Garlow's place
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("ReadOldGarlowPointerNote");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("ReadHagsInformantNote");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("ReadHagsInformantNote_HagRevealed");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("KnowsMayrinaIsCursed");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("KnowsDollCausedCurse_Note");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("KnowsDollCausedCurse_Sheep");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("KnowsAboutVoodooDoll_NoMayrina");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("CuredMayrina");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("CuredMayrina_BeforeMeetingSurvivors");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("DestroyedVoodooDoll");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("ReadHagSpyNote");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("SurvivorsFightAlongsideJatlo");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("JatloDroppedDisguise_BrokeHex");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("JatloDroppedDisguise_NoHexBroken");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("JatloDroppedDisguise_SurvivorsPermaDefeated");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("HagSpyPermaDefeated_NoMayrina");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("HagSpyPermaDefeated_BeforeDollDestroyed");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("HagSpyPermaDefeated_AfterMayrinaCured");
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates("HagSpyPermaDefeated_BeforeMayrinaCured");
//END_REGION

//REGION Summon Combat Crabs
DB_LOW_HagSurvivors_Crabs((CHARACTER)S_LOW_HagSurvivors_Crab_01_cc2810df-3213-4e65-8efa-1de4517bb792);
DB_LOW_HagSurvivors_Crabs((CHARACTER)S_LOW_HagSurvivors_Crab_02_6509cc72-4648-44ec-a0c2-598a2b85b3e0);
DB_LOW_HagSurvivors_Crabs((CHARACTER)S_LOW_HagSurvivors_Crab_03_709956be-ab4c-422d-ba68-6ca45d652df8);
DB_LOW_HagSurvivors_Crabs((CHARACTER)S_LOW_HagSurvivors_Crab_04_cded4e77-ffde-4e7e-9e14-10761b46205b);
DB_LOW_HagSurvivors_Crabs((CHARACTER)S_LOW_HagSurvivors_Crab_05_61c4494e-dea4-499c-a387-c1ee47cb9fc3);
DB_LOW_HagSurvivors_Crabs((CHARACTER)S_LOW_HagSurvivors_Crab_06_99b9a9d3-8d33-409f-a640-a3f7418497a7);
//END_REGION

//REGION Survivors hag mask reactions
DB_LOW_HagMaskEquipped_HagSurvivorReaction((CHARACTER)S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0,(DIALOGRESOURCE)LOW_HagSurvivors_AD_Kleidunn_SawHagMaskEquipped_11230c7b-514e-b0bc-c7ef-29ad18049af1);
DB_LOW_HagMaskEquipped_HagSurvivorReaction(S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6,LOW_HagSurvivors_AD_Adrielle_SawHagMaskEquipped_9bf45b11-d7f4-41e0-a914-621151ea8752);
DB_LOW_HagMaskEquipped_HagSurvivorReaction(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,LOW_HagSurvivors_AD_MaskedVictim1_SawHagMaskEquipped_1f675505-02de-190c-e4c1-ef22c101ec53);
DB_LOW_HagMaskEquipped_HagSurvivorReaction(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,LOW_HagSurvivors_AD_Mayrina_SawHagMaskEquipped_8e44cd73-b335-2f26-9d9d-a6ae05e13899);
//END_REGION

//REGION Post-release reactivity for telling the survivors about the deal with the hag
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_ToldAboutHagDeal_fb133357-495c-495f-919e-a62c72d3b061,"LOW_AvengeHagSurvivors","ToldAboutHagDeal");

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_ToldAboutHagDeal_fb133357-495c-495f-919e-a62c72d3b061,(DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_Cured_f776ecd3-8e2a-2c91-645c-5a91e0f5d646);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_ToldAboutHagDeal_fb133357-495c-495f-919e-a62c72d3b061,(DIALOGRESOURCE)LOW_HagSurvivors_Adrielle_b86566c4-3420-8842-a29e-19c0b72300dd);
//END_REGION

//REGION Readables
DB_LOW_HagSurvivorsPresent_Readables((ITEM)BOOK_LOW_AuntieEthelsRevenge_KleidunnJournal_000_3a92c2b1-691b-404a-87bf-2b559da29597);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_SurvivorsEviction_001_585f1bc8-3564-4f56-b157-472c79c969c9);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_RelocationNote_000_c4820ac1-2e68-40c3-bba5-10f23d2e467d);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_000_bba24bb4-4f74-47c4-a913-74f5bac6573b);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_001_e6430e6b-efcc-43d6-a9f9-e7c0fcf28ed1);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_002_11de612c-b017-4460-8b27-6992ed7d75fc);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_003_75d4ad4d-56c7-463a-80bb-5b6bba72f068);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_004_dc71fe33-7a4c-45d9-a794-ebb25800123d);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_005_186cb0d0-4b05-4e11-b1d3-d3bf7e07954a);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_007_88f83e23-be35-48eb-9f80-31c34d9a3a26);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_008_06ae2c8f-3ec3-46d4-b60e-b688658c1a17);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_009_8b7be4f6-e060-4a29-9dcf-69284cab8e42);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_010_356771fb-0f58-4175-b1cb-79a233d6f599);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_011_27d0dab1-bd7c-43b8-85f4-cd6f5d09c120);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_012_f3009ee9-d731-4304-9272-4a5b33224096);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_013_a19c1d24-836c-4c66-9084-9096d7366311);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_014_4b4698ce-e370-4a64-bd89-429bfa504711);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_015_992e91f0-fa67-4611-a3c0-8240ef63c55d);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_016_c2502437-95a4-4673-ad96-1e7f5367e20c);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_017_be1c8942-0b91-43fa-8c2f-84eb053d4b27);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_MayrinaContactLetter_000_d7f96c98-1b5b-407a-948d-0253d951caf4);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalMayrinaLeader_000_65a2aacb-639d-44e6-95a9-46f53a678a5e);
DB_LOW_HagSurvivorsPresent_Readables(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalNoMayrina_000_eb73d969-cb4d-4510-8010-4d05fa9f696c);

// Found in Blushing Mermaid
DB_LOW_HagInformantsNote_Templates((ITEMROOT)BOOK_LOW_BlushingMermaid_HagsInformantNote_785e14ea-78ad-4583-9268-a5e64354b481);
DB_LOW_HagInformantsNote_Templates((ITEMROOT)BOOK_LOW_BlushingMermaid_HagsInformantNote_NoMayrina_974a42f2-00a9-4753-ac67-e5053d06b69b);

// In hag spy's inventory
DB_LOW_HagSpysNote_Templates((ITEMROOT)BOOK_LOW_HagSurvivors_HagSpysNote_97bfb610-9aa5-4183-bf60-972ad955b45a);
DB_LOW_HagSpysNote_Templates((ITEMROOT)BOOK_LOW_HagSurvivors_HagSpysNote_NoMayrina_658b0b6e-f60d-434c-8690-c2ea2b313f45);

PROC_LOW_SetupHagRelatedReadables();
//END_REGION
KBSECTION
//REGION Hag Survivors Setup
// Depending on whether hag was defeated in Act 1 the hag survivors building is occupied
// either by bandits or hag survivors
IF
DB_LOW_HagSurvivors(_Character)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_SetOnStage(_Character,0);

IF
DB_LOW_HagSurvivors(_Character)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
// Disabling VandaliseNoOwner on the survivors fits their theme as they are essentially squatters 
PROC_CharacterDisableCrime(_Character, "VandaliseNoOwner");
PROC_SetOnStage(_Character,1);

IF
DB_LOW_HagSurvivors_Bandits(_Character)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_SetOnStage(_Character,1);
DB_GLO_DefeatCounter(_Character,"LOW_HagSurvivors_SquatterBandits");

IF
DB_LOW_HagSurvivors_Bandits(_Character)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_SetOnStage(_Character,0);

// Setting up hag victims from Act I
IF
DB_LOW_ActI_HagSurvivors(_Character,_Spot,_Dialog)
AND
NOT DB_PermaDefeated(_Character)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
NOT QRY_LOW_MayrinaWasGivenToHag(_Character)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Character);
TeleportTo(_Character, _Spot);
PROC_SetOnStage(_Character, 1);
SetFaction(_Character, (FACTION)ACT3_LOW_HagSurvivors_Victims_8fe0bd59-dabe-4cd8-92b7-b90855867c54);
SetCombatGroupID(_Character,"c0882bbe-fb8c-f874-e1e2-dd5c9421f6a0");
DB_Dialogs(_Character, _Dialog);
DB_LOW_HagSurvivors(_Character);
DB_GLO_DefeatCounter(_Character,"LOW_HagSurvivors_PermaDefeated");
DB_NoLowAttitudeDialog(_Character);
PROC_LOW_SurrogateMotherSetup(_Character);
PROC_LOW_MaskedVictimSetup(_Character);

QRY
QRY_LOW_MayrinaWasGivenToHag((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagTookMother_38dc6752-5ab3-e108-64ed-fe63971d69fd)
THEN
DB_NOOP(1);

PROC
PROC_LOW_SurrogateMotherSetup((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
// If Mayrina is permadefeated, LOW_BreakHagHex completes
DB_QuestDef_PermaDefeatedState("LOW_BreakHagHex","MayrinaPermaDefeated",(CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
PROC_SetOnStage(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,1);
PROC_SetOnStage(S_LOW_HagSurvivors_MayrinasNote_95c84ab5-1eed-4c0f-950a-89b8862d229c,1);
SetFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3,NULL_00000000-0000-0000-0000-000000000000,0);
PROC_CharacterFullRestore(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
BlockNewCrimeReactions(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, 1);
SetTag(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);
PROC_LOW_UndeadHusbandSetup();
PROC_SceneOver("HAG_Hagspawn_ResurrectionScene");

// Apply "LOW_HAGVICTIM_SHEEPCURSE" status only when there is none active so StatusRemoved isn't thrown in case it is already applied
PROC
PROC_LOW_SurrogateMotherSetup((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
HasActiveStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HAGVICTIM_SHEEPCURSE",0)
THEN
ApplyStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HAGVICTIM_SHEEPCURSE",-1.0);

// Edge case for figthing Mayrina and Connor in Act 1
PROC
PROC_LOW_UndeadHusbandSetup()
AND
DB_GlobalFlag((FLAG)HAG_Hagspawn_Event_KillHusband_e7b38a2a-a730-420f-bf18-2b44b40fe640)
AND
NOT DB_Defeated(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5)
THEN
PROC_GlobalSetFlagAndCache((FLAG)HAG_Hagspawn_Event_WifeHusbandLeave_c85ecfa6-472a-4200-fa39-1bb40b1338be);

PROC
PROC_LOW_UndeadHusbandSetup()
AND
DB_GlobalFlag((FLAG)HAG_Hagspawn_Event_WifeHusbandLeave_c85ecfa6-472a-4200-fa39-1bb40b1338be)
THEN
PROC_CharacterFullRestore(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
PROC_RemoveAllDialogEntriesForSpeaker(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
TeleportTo(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5, (TRIGGER)S_LOW_HagSurvivors_UndeadHusband_d7d4a89f-04d9-4159-a59a-dcd216b8384f);
PROC_SetOnStage(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5, 1);
SetFaction(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5, (FACTION)ACT3_LOW_HagSurvivors_Victims_8fe0bd59-dabe-4cd8-92b7-b90855867c54);
PROC_GlobalSetFlagAndCache((FLAG)LOW_HagSurvivors_State_UndeadHusbandArrivedWithMayrina_c55490ca-a1ca-456c-bdad-2ae148db02c4);
DB_LOW_HagSurvivors(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
DB_Dialogs(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,(DIALOGRESOURCE)LOW_HagSurvivors_UndeadHusband_015571b8-a869-77fa-374d-c173fb9df480);
DB_NoLowAttitudeDialog(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
NOT DB_PreventPermaDefeated(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
DB_DefeatedStateFlag(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,(FLAG)LOW_HagSurvivors_State_Connor_Defeated_98eb28de-726e-451c-990a-7314e7a1e20b);
DB_CanBeResurrected(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);

PROC
PROC_LOW_UndeadHusbandSetup()
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_UndeadHusbandArrivedWithMayrina_c55490ca-a1ca-456c-bdad-2ae148db02c4)
THEN
PROC_SetOnStage((ITEM)S_Graveyard_MayrinaHusbandTombstone_8f7478bb-9913-4f4f-bd92-8592d35f7caf, 1);

PROC
PROC_LOW_MaskedVictimSetup((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8)
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_MaskVengeanceLetter_cf61d6e0-a559-4c0a-a740-a2eb15f1ade9,CONT_GEN_Mailbox_C_019_2ebacd72-0215-44d1-b683-028b5ae87a2d,1);
SetStoryDisplayName(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,"LOW_HagSurvivors_MaskOfRegret_DisplayName");
PROC_CharacterFullRestore(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8);
DB_SpotPlayers((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,"LOW_SurvivorsFirstMeeting_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
NOT DB_HAG_MaskedVictims((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8, S_HAG_MaskedVictim01_Moveto_13bb41c4-9425-4e71-a6f6-2bedd98bd0dc, 100, (DIALOGRESOURCE)HAG_Hag_MaskedVictim1_AD_Resist_e238cfcb-0b01-bce9-237e-79e526ac8932);

PROC
PROC_LOW_MaskedVictimSetup((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8)
AND
DB_HAG_MaskedVictims((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,_Trigger,_Delay,_AD)
THEN
NOT DB_HAG_MaskedVictims((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,_Trigger,_Delay,_AD);

IF
FlagSet((FLAG)LOW_HagSurvivors_State_Adrielle_PermaDefeated_2904c062-d139-4fc5-9031-3826c19f0645,_,_)
THEN
SetFlag((FLAG)LOW_HagSurvivors_State_SurvivorsHadCasualty_b79f04e8-6406-139a-c7e7-d149c4471b50);

IF
FlagSet((FLAG)LOW_HagSurvivors_State_Kleidunn_PermaDefeated_e0548f7a-eb4a-4a03-8470-6b9a82a5e56c,_,_)
THEN
SetFlag((FLAG)LOW_HagSurvivors_State_SurvivorsHadCasualty_b79f04e8-6406-139a-c7e7-d149c4471b50);

IF
FlagSet((FLAG)LOW_HagSurvivors_State_Hag_MaskedVictim1_PermaDefeated_9d57d5e3-9cf8-49e5-b70f-662450a1aeb0,_,_)
THEN
SetFlag((FLAG)LOW_HagSurvivors_State_SurvivorsHadCasualty_b79f04e8-6406-139a-c7e7-d149c4471b50);

IF
FlagSet((FLAG)LOW_HagSurvivors_State_SurrogateMother_PermaDefeated_4391ae06-20bf-4e37-bbca-63519c550d0c,_,_)
THEN
SetFlag((FLAG)LOW_HagSurvivors_State_SurvivorsHadCasualty_b79f04e8-6406-139a-c7e7-d149c4471b50);

// In case players kill Mayrina, surviovrs go hostile on them with no way to undo it
IF
KilledBy(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_Killer,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
QRY_LOW_IsPartyMemberOrVoodooDoll(_Killer)
AND
NOT DB_LOW_HagSurvivors_PlayersKilledMayrina(1)
THEN
DB_LOW_HagSurvivors_PlayersKilledMayrina(1);
PROC_GlobalSetFlagAndCache((FLAG)LOW_HagSurvivors_State_PlayersKilledMayrina_75ea3027-8e3c-489b-a497-31889a83975a);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,0);

QRY
QRY_LOW_IsPartyMemberOrVoodooDoll((GUIDSTRING)_Killer)
AND
DB_PartyMembers((CHARACTER)_Killer)
THEN
DB_NOOP(1);

QRY
QRY_LOW_IsPartyMemberOrVoodooDoll((GUIDSTRING)_Killer)
AND
_Killer == S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a
THEN
DB_NOOP(1);
//END_REGION

//REGION First meeting with survivors
IF
DB_SpotPlayers(_HagSurvivor,"LOW_SurvivorsFirstMeeting_Spotting",_,_)
THEN
DB_SpotPlayers_Continuous(_HagSurvivor,"LOW_SurvivorsFirstMeeting_Spotting");
DB_SpotPlayers_SpotTrigger(_HagSurvivor,"LOW_SurvivorsFirstMeeting_Spotting",(TRIGGER)S_LOW_HagSurvivors_FristMeetingTrigger_af5affb6-c628-48c0-8a3e-35f41f672f7e);
DB_SpotPlayers_IncludeWildshapedPlayers(_HagSurvivor,"LOW_SurvivorsFirstMeeting_Spotting");
PROC_SceneDialogOnly("LOW_SurvivorsFirstMeeting_Scene",_HagSurvivor,(TRIGGER)S_LOW_HagSurvivors_FristMeetingTrigger_af5affb6-c628-48c0-8a3e-35f41f672f7e);

PROC
PROC_SceneInterrupted(_HagSurvivor,_,"LOW_SurvivorsFirstMeeting_Scene",_InterruptType)
AND
DB_LOW_SurvivorsFirstMeeting_SceneInterrupts(_InterruptType)
THEN
PROC_SpotPlayers_StopSpotting("LOW_SurvivorsFirstMeeting_Spotting");
PROC_LOW_HagSurvivors_HagSpy_PermaHostility();

// Only mandatory speakers are checked
PROC
PROC_SpotPlayers_Spotted(_Survivor,"LOW_SurvivorsFirstMeeting_Spotting",_Player)
AND
QRY_SurvivorAvailableForIntroDialog(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,_Player)
AND
QRY_SurvivorAvailableForIntroDialog(S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6,_Player)
AND
QRY_SurvivorAvailableForIntroDialog(S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0,_Player)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_HagSurvivors_FirstMeeting_Adrielle_Kleidunn_Jatlo_7b610a39-dc3f-67f4-9301-94ba052ee9e9,S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6,S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,S_LOW_HagSurvivors_VoodooDoll_Helper_b5f3e046-fe13-458e-9bb7-c428b1eeec6f,_Player)
THEN
DB_NOOP(1);

QRY
QRY_SurvivorAvailableForIntroDialog((GUIDSTRING)_Survivor,(GUIDSTRING)_Player)
AND
QRY_SpeakerIsAvailable(_Survivor)
AND
GetDistanceTo(_Survivor,_Player,_Dist)
AND
_Dist <= 100
THEN
DB_NOOP(1);

IF
DialogStarted(LOW_HagSurvivors_FirstMeeting_Adrielle_Kleidunn_Jatlo_7b610a39-dc3f-67f4-9301-94ba052ee9e9,_)
THEN
SetFlag((FLAG)LOW_HagSurvivors_State_MetSurvivors_e60750e6-26bc-4b80-a782-32dcc7d1e397);
PROC_SpotPlayers_StopSpotting("LOW_SurvivorsFirstMeeting_Spotting");

// In case Mayrina is in the city, the doll is there from the get go
IF
DialogEnded(LOW_HagSurvivors_FirstMeeting_Adrielle_Kleidunn_Jatlo_7b610a39-dc3f-67f4-9301-94ba052ee9e9,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
THEN
PROC_Foop(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a);

// Edge case handling of players interrupting the dialog
IF
DialogEnded((DIALOGRESOURCE)LOW_HagSurvivors_FirstMeeting_Adrielle_Kleidunn_Jatlo_7b610a39-dc3f-67f4-9301-94ba052ee9e9,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurvivorsFightAlongsideHagSpy_d8d6dcb0-836d-4c68-b28f-6357db9956fe)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurvivorsTrustPlayers_648c69b6-a5e3-438b-ac0a-441bbb80f38d)
THEN
PROC_LOW_HagSurvivors_HagSpy_PermaHostility();

IF
DialogEnded((DIALOGRESOURCE)LOW_HagSurvivors_FirstMeeting_Adrielle_Kleidunn_Jatlo_7b610a39-dc3f-67f4-9301-94ba052ee9e9,_)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurvivorsTrustPlayers_648c69b6-a5e3-438b-ac0a-441bbb80f38d)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
THEN
SetFlag((FLAG)LOW_HagSurvivors_Knows_MayrinaHexed_37f1da5e-0550-2f73-f8a8-229a8d896999);

IF
DialogEnded((DIALOGRESOURCE)LOW_HagSurvivors_FirstMeeting_Adrielle_Kleidunn_Jatlo_7b610a39-dc3f-67f4-9301-94ba052ee9e9,_)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurvivorsTrustPlayers_648c69b6-a5e3-438b-ac0a-441bbb80f38d)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
THEN
SetFlag((FLAG)LOW_HagSurvivors_Knows_SurvivorsHauntedByDoll_ef0e7ffe-3bf9-483d-8caf-5aa845bfef59);

IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpyAggroed_74eca7c7-e83b-4f07-ac32-beac7cd5eff7,_,_)
THEN
PROC_SpotPlayers_StopSpotting("LOW_SurvivorsFirstMeeting_Spotting");

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
THEN
PROC_SceneOver("LOW_SurvivorsFirstMeeting_Scene");

PROC
PROC_SpotPlayers_StopSpotting("LOW_SurvivorsFirstMeeting_Spotting")
AND
QRY_OnlyOnce("LOW_SurvivorsFirstMeeting_StopSpotting_OnlyOnce")
THEN
PROC_SceneOver("LOW_SurvivorsFirstMeeting_Scene");
SetFlag((FLAG)LOW_HagSurvivors_State_MetSurvivors_e60750e6-26bc-4b80-a782-32dcc7d1e397);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_SurvivorsFightAlongsideHagSpy_d8d6dcb0-836d-4c68-b28f-6357db9956fe)
THEN
PROC_LOW_HagSurvivors_HagSpy_PermaHostility();

PROC
PROC_LOW_HagSurvivors_HagSpy_PermaHostility()
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_HagSurvivors_HagSpy_a18d972a-d3be-43fe-b13f-1f280b3f48aa,0);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,0);

PROC
PROC_LOW_HagSurvivors_HagSpy_PermaHostility()
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurvivorsFightAlongsideHagSpy_d8d6dcb0-836d-4c68-b28f-6357db9956fe)
THEN
SetFlag((FLAG)LOW_HagSurvivors_State_SurvivorsFightAlongsideHagSpy_d8d6dcb0-836d-4c68-b28f-6357db9956fe);
//END_REGION

//REGION Voodoo doll
// With Remove Curse
IF
StatusRemoved(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,"LOW_HAG_VOODOODOLL",_,_)
THEN
Die((ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a);

IF
DestroyedBy((ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_,_,_)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_HagSurvivors_State_DollDestroyed_e99c5e75-57c4-4a7a-be5c-0ce8e3724e60);

IF
DestroyedBy((ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_,_,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
THEN
RemoveStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HAGVICTIM_SHEEPCURSE");

IF
DestroyedBy((ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
THEN
PROC_LOW_HagSpyAggro();

IF
FlagSet((FLAG)LOW_HagSurvivors_State_DollDestroyed_e99c5e75-57c4-4a7a-be5c-0ce8e3724e60,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
THEN
QuestUpdate("LOW_BreakHagHex","DestroyedVoodooDoll");
//END_REGION

//REGION Voodoo Doll teleportation
PROC
PROC_BlockMoveOfItem(_Character,(ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a)
THEN
DB_CustomMoveItemResponse(_Character, (ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a, 0);
PROC_LOW_TeleportVoodooDoll();
PROC_TryStartAD((DIALOGRESOURCE)LOW_HagSurvivors_PAD_VoodooDoll_e3737d34-d135-6099-2492-92d9eae1d70b,_Character);

PROC
PROC_BlockPickupOfItem(_Character,(ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a)
THEN
DB_CustomPickupItemResponse(_Character, (ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a, 0);
PROC_LOW_TeleportVoodooDoll();
PROC_TryStartAD((DIALOGRESOURCE)LOW_HagSurvivors_PAD_VoodooDoll_e3737d34-d135-6099-2492-92d9eae1d70b,_Character);

IF
AttackedBy(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_Character,_,_,_,_,_)
AND
GetHitpoints(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_HP)
AND
_HP > 0
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HagSurvivors_PAD_VoodooDoll_e3737d34-d135-6099-2492-92d9eae1d70b,_Character);

IF
HitpointsChanged(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_)
AND
GetHitpoints(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_HP)
AND
_HP > 0
THEN
PROC_LOW_TeleportVoodooDoll();

PROC
PROC_LOW_TeleportVoodooDoll()
AND
QRY_LOW_GetRandomVoodooDollDestination()
AND
DB_LOW_RandomVoodooDollDestination(_Destination)
THEN
//TODO: During polishing/behaviors make sure that AD behaves correctly, provided that we insta-teleport the doll in the same action block
PROC_TryStartAD((DIALOGRESOURCE)LOW_HagSurvivors_AD_VoodooDoll_07d163fe-f3b7-a7bc-13ad-3968bcdb982c,S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a);
//TODO: Use haggy VFX for doll poofing/fooping
PROC_Poof(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f);
TeleportTo(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_Destination,"LOW_VoodooDollTeleport");
NOT DB_LOW_RandomVoodooDollDestination(_Destination);
SysClear("DB_LOW_VoodooDollPotentialDestinations",1);
PROC_LOW_SetVoodooDollPotentialDestinations();

IF
EntityEvent(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,"LOW_VoodooDollTeleport")
THEN
PROC_Foop(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,(EFFECTRESOURCE)VFX_Script_Hag_Poof_01_a5ac4b11-0c02-a7a6-5c41-a95cf56c847f);

QRY
QRY_LOW_GetRandomVoodooDollDestination()
AND
QRY_GetRandom("DB_LOW_VoodooDollPotentialDestinations",1,"DB_LOW_RandomVoodooDollDestination")
AND
DB_LOW_RandomVoodooDollDestination(_RandomSpot)
AND
DB_LOW_VoodooDollPotentialDestinations(_RandomSpot)
AND
DB_LOW_CurentVoodooDollTeleportSpot(_CurrentSpot)
AND
GUIDToString(_RandomSpot,_SpotNameString)
THEN
NOT DB_LOW_CurentVoodooDollTeleportSpot(_CurrentSpot);
DB_LOW_CurentVoodooDollTeleportSpot(_RandomSpot);
DebugBreak(_SpotNameString);

PROC
PROC_LOW_SetVoodooDollPotentialDestinations()
AND
DB_LOW_VoodooDollTeleportSpots(_Spot)
AND
NOT DB_LOW_CurentVoodooDollTeleportSpot(_Spot)
THEN
DB_LOW_VoodooDollPotentialDestinations((GUIDSTRING)_Spot);

PROC
PROC_LOW_VoodooDollToDefaultSpot()
AND
DB_LOW_CurentVoodooDollTeleportSpot(_Spot)
THEN
TeleportTo(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_Spot);
//END_REGION

//REGION Hag spy
PROC
PROC_LOW_HagSpyAggro()
AND
QRY_OnlyOnce("LOW_HagSpyAggro_OnlyOnce")
THEN
PROC_LOW_HagSpyAggro_Internal();

PROC
PROC_LOW_HagSpyAggro_Internal()
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_PlayersKilledMayrina_75ea3027-8e3c-489b-a497-31889a83975a)
THEN
PROC_SpotPlayers_StopSpotting("LOW_SurvivorsFirstMeeting_Spotting");
DB_SpotPlayers((CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HagSpyCurseLifted_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeWildshapedPlayers((CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HagSpyCurseLifted_Spotting");
DB_Dialogs(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,(DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_Aggroed_41621532-a3a0-8d9a-de88-729d5cdc18a2);
DB_SceneManager(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HagSpyChallengesPlayersOnAggro_Scene");

PROC
PROC_SceneInterrupted(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,_PartyMember,"LOW_HagSpyChallengesPlayersOnAggro_Scene","Attacked")
THEN
PROC_LOW_HagSpyDropsDisguise();
PROC_SceneOver("LOW_HagSpyChallengesPlayersOnAggro_Scene");

// In case players are fighting with Jatlo while Mayrina is cured OR the doll is destroyed, he just drops disguise and survivors become allied to players
PROC
PROC_LOW_HagSpyAggro_Internal()
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
DB_Is_InCombat(_PartyMember,_CombatId)
AND
DB_Is_InCombat(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,_CombatId)
AND
QRY_LOW_ShouldSurvivorsDropTempHostility()
THEN
DB_LOW_DropTemporaryHostility_HagSurvivors(1);
PROC_LOW_HagSpyDropsDisguise();

QRY
QRY_LOW_ShouldSurvivorsDropTempHostility()
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurrogateMotherCured_f76de6bd-5212-4fd5-beeb-5b05a41f55b7)
THEN
DB_NOOP(1);

QRY
QRY_LOW_ShouldSurvivorsDropTempHostility()
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
THEN
DB_NOOP(1);

PROC
PROC_LOW_HagSpyAggro_Internal()
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_PlayersKilledMayrina_75ea3027-8e3c-489b-a497-31889a83975a)
THEN
DB_LOW_DropTemporaryHostility_HagSurvivors(1);
PROC_LOW_HagSpyDropsDisguise();

PROC
PROC_LOW_HagSpyAggro_Internal()
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_PlayersKilledMayrina_75ea3027-8e3c-489b-a497-31889a83975a)
THEN
PROC_LOW_HagSpyDropsDisguise();

// If on spotting players once the curse is lifted Jatlo can't start a dialog for whatever reason, it drops disguise and attacks
PROC
PROC_SpotPlayers_Spotted(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HagSpyCurseLifted_Spotting",_Player)
AND
NOT QRY_StartDialogCustom((DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_Aggroed_41621532-a3a0-8d9a-de88-729d5cdc18a2,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,_Player,0,0,1,1)
THEN
PROC_LOW_HagSpyDropsDisguise();

IF
DialogStarted((DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_Aggroed_41621532-a3a0-8d9a-de88-729d5cdc18a2,_)
THEN
PROC_ClearStoryMove((CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f);

// As a failsafe, the flag is set in the first dialog node to account for players interrupting the dialog
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_Event_HagSpy_DropDisguise_c60c37b3-852c-431c-8f82-0285551cdfd6)
THEN
PROC_LOW_HagSpyDropsDisguise();

IF
HitpointsChanged(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,_HpPercentage)
AND
HasActiveStatus(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HAGSPY_DISGUISE",1)
AND
_HpPercentage < 90.0
THEN
PROC_LOW_HagSpyDropsDisguise();

PROC
PROC_LOW_HagSpyDropsDisguise()
AND
QRY_OnlyOnce("LOW_HagSpyDropsDisguise_OnlyOnce")
THEN
PROC_ForceStopDialog(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f);
PROC_SceneOver("LOW_HagSpyChallengesPlayersOnAggro_Scene");
PROC_SetRelationMutual((FACTION)ACT3_LOW_HagSurvivors_HagSpy_a18d972a-d3be-43fe-b13f-1f280b3f48aa,(FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428,0);
PROC_SetRelationMutual((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,(FACTION)ACT3_LOW_HagSurvivors_HagSpy_a18d972a-d3be-43fe-b13f-1f280b3f48aa,0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_HagSurvivors_HagSpy_a18d972a-d3be-43fe-b13f-1f280b3f48aa,0);
PROC_LOW_HagSurvivors_SurvivorsRelationsOnDroppedDisguise();
RemoveStatus(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HAGSPY_DISGUISE");

PROC
PROC_LOW_HagSpyDropsDisguise()
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_HagSurvivors_State_HagSpyAggroed_74eca7c7-e83b-4f07-ac32-beac7cd5eff7);

PROC
PROC_LOW_HagSurvivors_SurvivorsRelationsOnDroppedDisguise()
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_PlayersKilledMayrina_75ea3027-8e3c-489b-a497-31889a83975a)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,100);

IF
StatusRemoved(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HAGSPY_DISGUISE",_,_)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HagSurvivors_AD_DropsDisguise_HagSpy_61774322-1c4c-6bae-1da4-1c0533a969fb,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f);

IF
TemplateUseFinished(_Player,_HagsInformantNote,_,1)
AND
DB_Players(_Player)
AND
DB_LOW_HagSpysNote_Templates(_HagsInformantNote)
AND
NOT DB_LOW_HagSpysNoteRead(1)
THEN
DB_LOW_HagSpysNoteRead(1);
SetFlag((FLAG)LOW_HagSurvivors_State_PlayersReadHagSpysNote_958013bc-d97a-43b9-903a-69587055eea7);

IF
FlagSet((FLAG)LOW_HagSurvivors_State_PlayersReadHagSpysNote_958013bc-d97a-43b9-903a-69587055eea7,_,_)
AND
NOT DB_PermaDefeated(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_HagSpyAggroed_74eca7c7-e83b-4f07-ac32-beac7cd5eff7)
THEN
QuestUpdate("LOW_BreakHagHex","ReadHagSpyNote");

// Summon crabs from bespoke Redcap spell
IF
DB_LOW_HagSurvivors_Crabs(_Crab)
THEN
PROC_SetOnStage(_Crab,0);

IF
CastedSpell(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"TARGET_LOW_HagSurvivors_Summon",_,_,_)
AND
DB_LOW_HagSurvivors_Crabs(_Crab)
THEN
PROC_Foop(_Crab);

//Edge case dropping of hag spy disguise in case of all the survivors permadefeated
IF
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_AllSurvivorsPermaDefeated_a400a1bf-add8-48c3-8b45-096e2b9fb233)
AND
HasActiveStatus(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HAGSPY_DISGUISE",1)
THEN
PROC_LOW_HagSpyDropsDisguise();

PROC
PROC_StateSet_PermaDefeated(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurrogateMotherCured_f76de6bd-5212-4fd5-beeb-5b05a41f55b7)
AND
DB_Is_InCombat(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HagSurvivors_AD_Combat_SurrogateMother_JatloDied_4bb45075-83f7-1297-9cec-289191e49224,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
//END_REGION

//REGION Handling temporary hostility of hag survivors while Jatlo is still in disguise - Can be significantly simplified in case we get ClearTemporaryHostility call
IF
RelationChanged(_Faction,_PlayerFaction,0,0)
AND
DB_LOW_HagSurvivors_Factions(_Faction)
AND
NOT DB_LOW_DropTemporaryHostility_HagSurvivors(1)
AND
HasActiveStatus(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HAGSPY_DISGUISE",1)
THEN
DB_LOW_DropTemporaryHostility_HagSurvivors(1);

IF
RelationChanged((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,100,1)
AND
DB_LOW_DropTemporaryHostility_HagSurvivors(1)
AND
DB_Is_InCombat(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,_CombatId)
AND
NOT DB_LOW_HagSpyDroppedDisguise_CombatId(_CombatId)
THEN
DB_LOW_HagSpyDroppedDisguise_CombatId(_CombatId);

IF
RelationChanged((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,100,1)
AND
DB_LOW_DropTemporaryHostility_HagSurvivors(1)
AND
DB_LOW_HagSurvivors(_Character)
THEN
DB_NoLowAttitudeDialog(_Character);
LeaveCombat(_Character);

IF
LeftCombat(_Character,_CombatId)
AND
DB_LOW_DropTemporaryHostility_HagSurvivors(1)
AND
DB_LOW_HagSpyDroppedDisguise_CombatId(_CombatId)
AND
DB_LOW_HagSurvivors((CHARACTER)_Character)
AND
DB_LOW_PartyMembersInHagSpyCombat(_PartyMember)
THEN
EnterCombat(_Character,_PartyMember);

// Making sure that players rejoin combat when temporary hostility of the survivors is dropped via them leaving the combat
IF
DB_LOW_HagSpyDroppedDisguise_CombatId(_CombatId)
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember,_CombatId)
THEN
DB_LOW_PartyMembersInHagSpyCombat(_PartyMember);
//END_REGION

//REGION Surrogate mother curse
IF
FlagSet((FLAG)LOW_HagSurvivors_Knows_MayrinaHexed_37f1da5e-0550-2f73-f8a8-229a8d896999,_,_)
THEN
SetStoryDisplayName(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HagSurvivors_MayrinaSheepForm_DisplayName");

IF
StatusRemoved(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HAGVICTIM_SHEEPCURSE",_,_)
AND
GetHitpoints(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_HP)
AND
_HP > 0
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_HagSurvivors_State_SurrogateMotherCured_f76de6bd-5212-4fd5-beeb-5b05a41f55b7);
PROC_RemoveAllDialogEntriesForSpeaker(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
DB_Dialogs(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_Cured_f776ecd3-8e2a-2c91-645c-5a91e0f5d646);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HagSurvivors_AD_Cured_SurrogateMother_5bf34b46-2548-a31a-0d2f-13c223eb0698,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
BlockNewCrimeReactions(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd, 0);
PROC_LOW_HagSpyReactsToMayrinaLosingCurseStatus();

IF
StatusRemoved(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HAGVICTIM_SHEEPCURSE",_,_)
AND
GetHitpoints(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_HP)
AND
_HP <= 0
THEN
PROC_LOW_HagSpyReactsToMayrinaLosingCurseStatus();

PROC
PROC_LOW_HagSpyReactsToMayrinaLosingCurseStatus()
THEN
PROC_ForceStopDialog(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f);
PROC_CharacterMoveTo((CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"Run","");
PROC_LOW_HagSpyAggro();

IF
GameBookInterfaceClosed((ITEM)S_LOW_HagSurvivors_MayrinasNote_95c84ab5-1eed-4c0f-950a-89b8862d229c,_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurrogateMotherCured_f76de6bd-5212-4fd5-beeb-5b05a41f55b7)
THEN
SetFlag((FLAG)LOW_HagSurvivors_State_ReadMayrinasNote_3c9a4e69-a315-4a37-a677-fc9a59070714);

IF
FlagSet((FLAG)LOW_HagSurvivors_State_SurrogateMotherCured_f76de6bd-5212-4fd5-beeb-5b05a41f55b7,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_MetSurvivors_e60750e6-26bc-4b80-a782-32dcc7d1e397)
THEN
QuestUpdate("LOW_BreakHagHex","CuredMayrina");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_SurrogateMotherCured_f76de6bd-5212-4fd5-beeb-5b05a41f55b7,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_MetSurvivors_e60750e6-26bc-4b80-a782-32dcc7d1e397)
THEN
QuestUpdate("LOW_BreakHagHex","CuredMayrina_BeforeMeetingSurvivors");

// Edge case when players lifted the curse with Remove Curse and thus skipped destroying the doll
IF
StatusRemoved(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HAGVICTIM_SHEEPCURSE",_,_)
AND
NOT DB_Defeated(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a)
THEN
Die((ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a);

IF
DB_Sees(_Player,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SawMayrinaAsSheep_09ea45ca-113f-4b96-ad36-d349f3cc4b28)
AND
HasActiveStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HAGVICTIM_SHEEPCURSE",1)
THEN
SetFlag((FLAG)LOW_HagSurvivors_State_SawMayrinaAsSheep_09ea45ca-113f-4b96-ad36-d349f3cc4b28);

// Damage/Status transfer from voodoo doll to Mayrina. Use DB_Dead as it should work as long as Mayrina's alive
IF
AttackedBy(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_AttackerOwner,_,_DamageType,_DamageAmount,_,_)
AND
DB_GlobalFLag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
NOT DB_Dead(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
_DamageAmount >= 1
THEN
// Being low on hp Mayrina receives just 1 damage of the corresponding type, leaving room for players to figure out the connection to the doll
ApplyDamage(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,1,_DamageType,S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HagSurvivors_AD_SheepMayrina_VoodooDamaged_be0e71d5-1300-21a3-b8f4-6734ad125d3e,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

IF
StatusApplied(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,_Status,_Causee,_StortyActionID)
AND
DB_GlobalFLag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
//TODO: Come up with a DB of other blacklisted statuses that shouldn't be applied
_Status != "LOW_HAG_VOODOODOLL"
AND
NOT DB_Dead(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
ApplyStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_Status,6.0,1,S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a);
//END_REGION

//REGION Clearing AI_IGNORED for Mayrina
PROC
PROC_StateSet_PermaDefeated(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f)
AND
NOT DB_Is_InCombat(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_)
THEN
ClearTag(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);

PROC
PROC_StateSet_PermaDefeated(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f)
AND
DB_Is_InCombat(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_CombatId)
THEN
DB_LOW_HagSpyPermaDefeatedCombat(_CombatId);

PROC
PROC_StateSet_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
DB_LOW_HagSpyPermaDefeatedCombat(_CombatId)
THEN
NOT DB_LOW_HagSpyPermaDefeatedCombat(_CombatId);

IF
SwitchedCombat(_,_OldId,_NewId)
AND
DB_LOW_HagSpyPermaDefeatedCombat(_OldId)
THEN
NOT DB_LOW_HagSpyPermaDefeatedCombat(_OldId);
DB_LOW_HagSpyPermaDefeatedCombat(_NewId);

IF
CombatEnded(_CombatId)
AND
DB_LOW_HagSpyPermaDefeatedCombat(_CombatId)
THEN
ClearTag(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);
NOT DB_LOW_HagSpyPermaDefeatedCombat(_CombatId);
//END_REGION

//REGION Mayrina/Connor reacttivity
IF
DB_Sees((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_Character)
AND
HasActiveStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HAGVICTIM_SHEEPCURSE",0)
AND
GetTemplate(_Character,_CharacterTemplate)
AND
_CharacterTemplate == QUEST_HAG_HusbandZombie_f1876ebc-8a68-410a-885f-21f991a5df09
THEN
//TODO: At polishing stage randomize dialog nodes that get chosen in the AD
PROC_TryStartAD(LOW_HagSurvivors_AD_SurrogateMother_SeesHusbandAsSummon_38c109c4-edcc-dd42-33f1-4c4bd8dffcfd,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_Cured_f776ecd3-8e2a-2c91-645c-5a91e0f5d646,_ID)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_UndeadHusbandArrivedWithMayrina_c55490ca-a1ca-456c-bdad-2ae148db02c4)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
PROC_DialogAddSpeakingActor(_ID, S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);

IF
FlagSet((FLAG)LOW_HagSurvivors_State_MayrinaDestroyedHusbandWand_fde722e6-b512-4fe4-8a2e-de00027a4856,_,_)
THEN
Die(S_HAG_Wand_SummonHusband_70bc9907-91c1-4e69-ad50-53e402eca22f);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_MayrinaDestroyedHusbandWand_fde722e6-b512-4fe4-8a2e-de00027a4856)
THEN
PROC_Poof(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
TeleportTo(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,S_LOW_BlushingMermaid_MissingKid_Spot_a0c4ce02-fd08-482f-af14-0c4fb0283553);
Die(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,DEATHTYPE.None,1);
//END_REGION

//REGION HagSpy dies when Hag is trully dead
IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
AND
NOT DB_Dead(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f)
THEN
PROC_ForceStopDialog(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f);
Die(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,DEATHTYPE.Necrotic,S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,1,0,0.0);

IF
Died(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_HagSurvivors_AD_HagKilled_HagSpy_ef9ff76b-5283-1a3f-11ee-338fd97fb9e3,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f)
THEN
DB_NOOP(1);

// If Jatlo dies as a result of hag being truly killed, a dialog about that is set on survivors to start once they spot a player
IF
Died(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
THEN
PROC_LOW_HagSpyDropsDisguise();
PROC_LOW_SetupJatloInstaDiedSpotting();
PROC_TryStartAD((DIALOGRESOURCE)LOW_HagSurvivors_AD_SurvivorsSeeHagSpyInstaDie_c74861c8-d01a-7faf-92a5-b0326b9b0d15,S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6);

PROC
PROC_LOW_SetupJatloInstaDiedSpotting()
AND
DB_LOW_HagSurvivors(_HagSurvivor)
THEN
DB_SpotPlayers(_HagSurvivor,"LOW_SurvivorsJatloInstaDied_Spotting",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous(_HagSurvivor,"LOW_SurvivorsJatloInstaDied_Spotting");
DB_SpotPlayers_IncludeWildshapedPlayers(_HagSurvivor,"LOW_SurvivorsJatloInstaDied_Spotting");

IF
DB_SpotPlayers(_HagSurvivor,"LOW_SurvivorsJatloInstaDied_Spotting",_,_)
AND
DB_PermaDefeated(_HagSurvivor)
AND
DB_LOW_JatloInstaDied_MandatorySpeakers(_HagSurvivor)
THEN
PROC_SpotPlayers_StopSpotting("LOW_SurvivorsJatloInstaDied_Spotting");

// If spotting for Jatlo insta-died dialog was set, Mayrina goes to Jatlo's corpse
IF
DB_SpotPlayers((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_SurvivorsJatloInstaDied_Spotting",_,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
NOT DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
NOT DB_CantMove(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
PROC_CharacterMoveTo(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"Run","LOW_MayrinaMovedToHagSpysCorpse");

// Only mandatory speakers are checked
PROC
PROC_SpotPlayers_Spotted(_Survivors,"LOW_SurvivorsJatloInstaDied_Spotting",_Player)
AND
QRY_SurvivorAvailableForIntroDialog(S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6,_Player)
AND
QRY_SurvivorAvailableForIntroDialog(S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0,_Player)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_HagSurvivors_DisguisedJatloInstaDied_99b8ec9b-eb83-92b5-0a84-f1b4e1dcbed8,S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6,S_LOW_HagSurvivors_Kleidunn_54acca8b-2dab-4132-883e-6948bd11b8f0,_Player)
THEN
DB_NOOP(1);

IF
DialogStarted((DIALOGRESOURCE)LOW_HagSurvivors_DisguisedJatloInstaDied_99b8ec9b-eb83-92b5-0a84-f1b4e1dcbed8,_)
THEN
PROC_SpotPlayers_StopSpotting("LOW_SurvivorsJatloInstaDied_Spotting");

// Also can be set in individual survivor dialogs
IF
FlagSet((FLAG)LOW_HagSurvivors_State_KillHagQuestCompleted_300469ac-2022-4b4b-85f1-b611ba4abfee,_,_)
THEN
PROC_SpotPlayers_StopSpotting("LOW_SurvivorsJatloInstaDied_Spotting");
//END_REGION

//REGION Hag survivors quest book stash
IF
DB_LOW_HagSurvivorsQuestBookChest(_Chest)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_SetOnStage(S_LOW_HagSurvivors_HagLoreBookChest_fd0fe386-dbcd-41dc-a6fb-40def976190e,1);
SetOwner((ITEM)S_LOW_HagSurvivors_HagLoreBookChest_fd0fe386-dbcd-41dc-a6fb-40def976190e,(CHARACTER)S_LOW_HagSurvivors_Adrielle_aa38af5c-9c75-4b2e-89e3-0cc1b995dbd6);

IF
DB_LOW_HagSurvivorsQuestBookChest(_Chest)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_SetOnStage(S_LOW_HagSurvivors_HagLoreBookChest_fd0fe386-dbcd-41dc-a6fb-40def976190e,0);

// After helping the survivors and talking to them, the chest ownership is cleared
IF
FlagSet((FLAG)LOW_HagSurvivors_Knows_HagLoreBook_0e63b348-e6f3-626e-75b4-ef9a6c9b18d6,_,_)
THEN
ClearOwnership((ITEM)S_LOW_HagSurvivors_HagLoreBookChest_fd0fe386-dbcd-41dc-a6fb-40def976190e);

IF
FlagSet((FLAG)LOW_HagSurvivors_Knows_HagLoreBook_0e63b348-e6f3-626e-75b4-ef9a6c9b18d6,_,_)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_ShowHagSurvivorsStashMarker_OnlyOnce")
THEN
PROC_ShowMarker(_Player,"LOW_HagSurvivorsStashSafe");

IF
UseStarted(_Character,(ITEM)S_LOW_HagSurvivors_HagLoreBookChest_fd0fe386-dbcd-41dc-a6fb-40def976190e)
AND
DB_ActivePlayerMarker(_Player,"LOW_HagSurvivorsStashSafe")
THEN
PROC_HideMarker(_Player,"LOW_HagSurvivorsStashSafe");

IF
GameBookInterfaceClosed((ITEM)S_LOW_HagQuestGrenade_Book_4a9b62b6-33f1-4ebf-8c83-eac79b1d7fd8,_Player)
AND
QRY_OnlyOnce("LOW_HagQuestGrenade_BookReadFlagSet_OnlyOnce")
THEN
SetFlag((FLAG)LOW_BlushingMermaid_State_HagQuestGrenade_BookRead_6c36ea74-ea4e-4974-b9cd-dd49ca00265f);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagQuestGrenade_BookRead_6c36ea74-ea4e-4974-b9cd-dd49ca00265f,_,_)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_SaveHaggedChild","HagBossFightStarted")
THEN
QuestUpdate("LOW_SaveHaggedChild","FoundQuestGreandeRecipe");
//END_REGION

//REGION Survivors react to seeing players wearing hag masks
IF
Saw(_HagSurvivor,_Player,0)
AND
DB_LOW_HagMaskEquipped_HagSurvivorReaction(_HagSurvivor,_HagMaskReactionAD)
AND
DB_Players(_Player)
AND
GetEquippedItem(_Player,"Helmet",_Mask)
AND
DB_HAG_Hagmasks(_Mask,_Helper)
AND
GetRelation((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,_Relation)
AND
_Relation != 0
AND
NOT DB_LOW_HagSurvivorsWornMaskADPlayed(1)
THEN
PROC_TryStartAD(_HagMaskReactionAD,_HagSurvivor);
LookAtEntity(_HagSurvivor,_Player,3.0);

IF
AutomatedDialogStarted(_Dialog,_)
AND
DB_LOW_HagMaskEquipped_HagSurvivorReaction(_,_Dialog)
THEN
DB_LOW_HagSurvivorsWornMaskADPlayed(1);

IF
AutomatedDialogEnded(_Dialog,_)
AND
DB_LOW_HagMaskEquipped_HagSurvivorReaction(_,_Dialog)
THEN
NOT DB_LOW_HagSurvivorsWornMaskADPlayed(1);
//END_REGION

//REGION Completing LOW_BreakHagHex on talking to survivors
IF
FlagSet((FLAG)LOW_HagSurvivors_State_KillHagAccepted_cbf43b08-e2a4-f9e1-9d8f-94f1936b2ba0,_,_DialogInst)
AND
DB_DialogNPCs(_DialogInst,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_ToldMayrinaCantHelpKillHag_7402e627-305e-4d83-938f-79c05c419220)
THEN
QuestUpdate("LOW_BreakHagHex","TalkedToSavedMayrina_NotToldAboutStash");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_KillHagAccepted_cbf43b08-e2a4-f9e1-9d8f-94f1936b2ba0,_,_DialogInst)
AND
NOT DB_DialogNPCs(_DialogInst,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_)
THEN
QuestUpdate("LOW_BreakHagHex","SurvivorsToldAboutStash");
//END_REGION

//REGION LOW_AvengeHagSurvivors quest is started when LOW_BreakHagHex is completed
IF
FlagSet((FLAG)LOW_HagSurvivors_State_KillHagAccepted_cbf43b08-e2a4-f9e1-9d8f-94f1936b2ba0,_,_DialogInst)
AND
DB_DialogNPCs(_DialogInst,S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,_)
THEN
QuestUpdate("LOW_AvengeHagSurvivors","QuestStarted_AskedByMayrina");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_KillHagAccepted_cbf43b08-e2a4-f9e1-9d8f-94f1936b2ba0,_,_DialogInst)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_AvengeHagSurvivors","QuestStarted_AskedByMayrina")
THEN
QuestUpdate("LOW_AvengeHagSurvivors","QuestStarted_AskedBySurvivor");
//END_REGION

//REGION LOW_AvengeHagSurvivors journal updates based on reading the book on how to prevent hag resurrection
IF
TemplateUseFinished(_Player,(ITEMROOT)LOW_HagResurrectionPrevention_Book_661da3b2-a943-4c2c-9913-269b9503763d,_,1)
AND
QRY_OnlyOnce("LOW_HagResurrectionPrevention_BookRead_OnlyOnce")
THEN
SetFlag((FLAG)LOW_BlushingMermaid_State_HagResurrectionPrevention_BookRead_a9b2bf68-a71f-41b2-a317-a8778306aa6a);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagResurrectionPrevention_BookRead_a9b2bf68-a71f-41b2-a317-a8778306aa6a,_,_)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_AvengeHagSurvivors","HagBossFightStarted")
THEN
QuestUpdate("LOW_AvengeHagSurvivors","ReadShroomsBook");

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagResurrectionPrevention_BookRead_a9b2bf68-a71f-41b2-a317-a8778306aa6a,_,_)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_AvengeHagSurvivors","HagBossFightStarted")
THEN
NOT DB_QuestDef_ChainedState("LOW_SaveHaggedChild","HagBossFightStarted","LOW_AvengeHagSurvivors","HagBossFightStarted");
DB_QuestDef_State((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61,"LOW_AvengeHagSurvivors","HagBossFightStarted_ReadShroomsBook");
//END_REGION

//REGION Edge case start/completion for LOW_AvengeHagSurvivors quest in case players truly killed the hag but never got LOW_BreakHagHex quest first
IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
THEN
DB_LOW_HagSurvivorsDialogs_PostHagTrulyDead((DIALOGRESOURCE)LOW_HagSurvivors_DisguisedJatloInstaDied_99b8ec9b-eb83-92b5-0a84-f1b4e1dcbed8);
DB_LOW_HagSurvivorsDialogs_PostHagTrulyDead((DIALOGRESOURCE)LOW_HagSurvivors_Kleidunn_b808f141-5299-a1da-2544-060f9a7a7e4a);
DB_LOW_HagSurvivorsDialogs_PostHagTrulyDead((DIALOGRESOURCE)LOW_HagSurvivors_Adrielle_b86566c4-3420-8842-a29e-19c0b72300dd);
DB_LOW_HagSurvivorsDialogs_PostHagTrulyDead((DIALOGRESOURCE)LOW_HagSurvivors_MaskedVictim1_9174eeda-dcfd-cdbc-c650-1bee3a363d30);
DB_LOW_HagSurvivorsDialogs_PostHagTrulyDead((DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_Cured_f776ecd3-8e2a-2c91-645c-5a91e0f5d646);

IF
DialogStarted(_Dialog,_DialogInst)
AND
DB_LOW_HagSurvivorsDialogs_PostHagTrulyDead(_Dialog)
AND
QRY_LOW_MayrinaIsPermaDefeated_Or_NotPresent()
THEN
PROC_LOW_AvengeHagSurvivors_QuestUpdate_NeverGotBreakHexQuest("TrulyKilledHag_NeverGotBreakHexQuest");

IF
DialogStarted(_Dialog,_DialogInst)
AND
DB_LOW_HagSurvivorsDialogs_PostHagTrulyDead(_Dialog)
AND
NOT QRY_LOW_MayrinaIsPermaDefeated_Or_NotPresent()
THEN
PROC_LOW_AvengeHagSurvivors_QuestUpdate_NeverGotBreakHexQuest("TrulyKilledHag_NeverGotBreakHexQuest_MayrinaPresent");

PROC
PROC_LOW_AvengeHagSurvivors_QuestUpdate_NeverGotBreakHexQuest((STRING)_QuestUpdate)
AND
NOT DB_QuestIsOpened("LOW_AvengeHagSurvivors")
AND
NOT DB_QuestIsAccepted("LOW_BreakHagHex")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_AvengeHagSurvivors",_QuestUpdate)
THEN
QuestUpdate("LOW_AvengeHagSurvivors",_QuestUpdate);
PROC_LOW_AvengeHagSurvivors_CompletionSetup_NeverGotBreakHexQuest();

QRY
QRY_LOW_MayrinaIsPermaDefeated_Or_NotPresent()
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
THEN
DB_NOOP(1);

QRY
QRY_LOW_MayrinaIsPermaDefeated_Or_NotPresent()
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurrogateMother_PermaDefeated_4391ae06-20bf-4e37-bbca-63519c550d0c)
THEN
DB_NOOP(1);

PROC
PROC_LOW_AvengeHagSurvivors_CompletionSetup_NeverGotBreakHexQuest()
THEN
NOT DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_KillHagQuestCompleted_300469ac-2022-4b4b-85f1-b611ba4abfee,"LOW_AvengeHagSurvivors","ToldSurvivorsHagTrulyDead");
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_KillHagQuestCompleted_300469ac-2022-4b4b-85f1-b611ba4abfee,"LOW_AvengeHagSurvivors","TrulyKilledHag_NeverGotBreakHexQuest_TalkedToSurvivors");
//END_REGION

//REGION Completing LOW_AvengeHagSurvivors quest due to players leaving for END
IF
FlagSet((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99,_,_)
AND
DB_QuestIsOpened("LOW_AvengeHagSurvivors")
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_AvengeHagSurvivors","HagPermaDefeated")
THEN
QuestUpdate("LOW_AvengeHagSurvivors","EnteredEND_NoReportHagTrulyDead");

IF
FlagSet((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99,_,_)
AND
DB_QuestIsOpened("LOW_AvengeHagSurvivors")
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsAllyInEND_3bb65bd3-a72f-4a43-a497-10b1501cd6a5)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_AvengeHagSurvivors","HagPermaDefeated")
THEN
QuestUpdate("LOW_AvengeHagSurvivors","EnteredEND_NoHagTrulyDead");
//END_REGION

//REGION Starting LOW_BreakHagHex on reading the note from hag spy in Blushing Mermaid
IF
FlagSet((FLAG)LOW_BlushingMermaid_State_PlayersReadHagInformantsNote_23cc4563-f336-4f9e-a83c-35fe8b8f8308,_,_)
AND
NOT DB_QuestIsAccepted("LOW_BreakHagHex")
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRevealed_aa751f69-f448-1436-c243-eb9f06a060ca)
THEN
QuestUpdate("LOW_BreakHagHex","ReadHagsInformantNote");

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_PlayersReadHagInformantsNote_23cc4563-f336-4f9e-a83c-35fe8b8f8308,_,_)
AND
NOT DB_QuestIsAccepted("LOW_BreakHagHex")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRevealed_aa751f69-f448-1436-c243-eb9f06a060ca)
THEN
QuestUpdate("LOW_BreakHagHex","ReadHagsInformantNote_HagRevealed");
//END_REGION

//REGION Starting LOW_BreakHagHex through hag survivors' posters or in their former hideout
IF
TemplateUseFinished(_Player,(ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_HagSurvivorsPoster_80162ccc-b7d6-437f-b727-53478594694f,_,1)
AND
DB_Players(_Player)
AND
NOT DB_LOW_PlayersReadHagSurvivorsPoster(1)
AND
NOT DB_QuestIsAccepted("LOW_BreakHagHex")
THEN
DB_LOW_PlayersReadHagSurvivorsPoster(1);
QuestUpdate("LOW_BreakHagHex","ReadHagSurvivorsPoster");

IF
TemplateUseFinished(_Player,(ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_SurvivorsEviction_13dd4822-68e1-4ccf-a0dd-4f83e986518c,_,1)
THEN
QuestUpdate("LOW_BreakHagHex","ReadSurvivorsEvictionNotice");

IF
TemplateUseFinished(_Player,(ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_RelocationNote_15dd6e1a-df7a-4cf8-b189-6cfb580fd42b,_,1)
THEN
QuestUpdate("LOW_BreakHagHex","ReadOldGarlowPointerNote");
//END_REGION

//REGION LOW_BreakHagHex quest updates when hag spy drops disguise and attacks players
IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpyAggroed_74eca7c7-e83b-4f07-ac32-beac7cd5eff7,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_AllSurvivorsPermaDefeated_a400a1bf-add8-48c3-8b45-096e2b9fb233)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_DollDestroyed_e99c5e75-57c4-4a7a-be5c-0ce8e3724e60)
THEN
QuestUpdate("LOW_BreakHagHex","JatloDroppedDisguise_NoHexBroken");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpyAggroed_74eca7c7-e83b-4f07-ac32-beac7cd5eff7,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_AllSurvivorsPermaDefeated_a400a1bf-add8-48c3-8b45-096e2b9fb233)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_DollDestroyed_e99c5e75-57c4-4a7a-be5c-0ce8e3724e60)
THEN
QuestUpdate("LOW_BreakHagHex","JatloDroppedDisguise_BrokeHex");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpyAggroed_74eca7c7-e83b-4f07-ac32-beac7cd5eff7,_,_)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_AllSurvivorsPermaDefeated_a400a1bf-add8-48c3-8b45-096e2b9fb233)
THEN
QuestUpdate("LOW_BreakHagHex","JatloDroppedDisguise_SurvivorsPermaDefeated");
//END_REGION

//REGION LOW_BreakHagHex quest updates when hag spy is permadefeated; PermaDefeating hag spy destroys the voodoo doll
IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpy_PermaDefeated_e62f1c84-d463-4c2e-ba55-aa6e558ec43c,_,_)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_AllSurvivorsPermaDefeated_a400a1bf-add8-48c3-8b45-096e2b9fb233)
THEN
//Completes the quest
QuestUpdate("LOW_BreakHagHex","HagSpyPermaDefeated_SurvivorsPermaDefeated");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpy_PermaDefeated_e62f1c84-d463-4c2e-ba55-aa6e558ec43c,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_DollDestroyed_e99c5e75-57c4-4a7a-be5c-0ce8e3724e60)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
THEN
QuestUpdate("LOW_BreakHagHex","HagSpyPermaDefeated_NoMayrina");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpy_PermaDefeated_e62f1c84-d463-4c2e-ba55-aa6e558ec43c,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_DollDestroyed_e99c5e75-57c4-4a7a-be5c-0ce8e3724e60)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
THEN
QuestUpdate("LOW_BreakHagHex","HagSpyPermaDefeated_BeforeDollDestroyed");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpy_PermaDefeated_e62f1c84-d463-4c2e-ba55-aa6e558ec43c,_,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurrogateMotherCured_f76de6bd-5212-4fd5-beeb-5b05a41f55b7)
THEN
QuestUpdate("LOW_BreakHagHex","HagSpyPermaDefeated_BeforeMayrinaCured");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpy_PermaDefeated_e62f1c84-d463-4c2e-ba55-aa6e558ec43c,_,_)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SurrogateMotherCured_f76de6bd-5212-4fd5-beeb-5b05a41f55b7)
THEN
QuestUpdate("LOW_BreakHagHex","HagSpyPermaDefeated_AfterMayrinaCured");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpy_PermaDefeated_e62f1c84-d463-4c2e-ba55-aa6e558ec43c,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_AllSurvivorsPermaDefeated_a400a1bf-add8-48c3-8b45-096e2b9fb233)
AND
DB_Players(_Player)
THEN
DB_QuestDef_ChainedState("LOW_AvengeHagSurvivors","AllSurvivorsPermaDefeated","LOW_BreakHagHex","AllSurvivorsPermaDefeated");

IF
FlagSet((FLAG)LOW_HagSurvivors_State_HagSpy_PermaDefeated_e62f1c84-d463-4c2e-ba55-aa6e558ec43c,_,_)
AND
NOT DB_Destroyed((ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a)
THEN
Die((ITEM)S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a);
//END_REGION

//REGION Edge Case update/completion for when hag is truly dead when LOW_BreakHagHex was started, but never finished: in that case LOW_AvengeHagSurvivors can never be started
IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
AND
DB_QuestIsOpened("LOW_BreakHagHex")
AND
NOT QRY_LOW_PlayersKnowOldGarlows()
AND
NOT DB_LOW_PlayersTrulyKilledHagWithoutKnowingSurvivorsHideout(1)
THEN
DB_LOW_PlayersTrulyKilledHagWithoutKnowingSurvivorsHideout(1);
QuestUpdate("LOW_BreakHagHex","HagPermaDefeated_CheckSurvivors_BarrenCoop");

QRY
QRY_LOW_PlayersKnowOldGarlows()
AND
DB_LOW_HagSurvivorsHideoutKnowledge_QuestUpdates(_QuestUpadte)
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_BreakHagHex",_QuestUpadte)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
AND
DB_QuestIsOpened("LOW_BreakHagHex")
AND
NOT DB_LOW_PlayersTrulyKilledHagWithoutKnowingSurvivorsHideout(1)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_BreakHagHex","JatloDroppedDisguise_SurvivorsPermaDefeated")
THEN
QuestUpdate("LOW_BreakHagHex","HagPermaDefeated_CheckSurvivors");

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
AND
DB_QuestIsOpened("LOW_BreakHagHex")
THEN
NOT DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_KillHagQuestCompleted_300469ac-2022-4b4b-85f1-b611ba4abfee,"LOW_AvengeHagSurvivors","ToldSurvivorsHagTrulyDead");
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_KillHagQuestCompleted_300469ac-2022-4b4b-85f1-b611ba4abfee,"LOW_BreakHagHex","HagPermaDefeated_MetSurvivors");

IF
FlagSet((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c,_,_)
AND
NOT DB_QuestIsOpened("LOW_BreakHagHex")
THEN
QuestClose("LOW_BreakHagHex");
//END_REGION

//REGION Completing LOW_BreakHagHex when players travel to END in case it is active
IF
FlagSet((FLAG)END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99,_,_)
AND
DB_QuestIsOpened("LOW_BreakHagHex")
THEN
QuestUpdate("LOW_BreakHagHex","EnteredEND_QuestActive");
//END_REGION

//REGION Readables
PROC
PROC_LOW_SetupHagRelatedReadables()
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
DB_LOW_HagSurvivorsPresent_Readables(_Item)
THEN
PROC_SetOnStage(_Item,0);

PROC
PROC_LOW_SetupHagRelatedReadables()
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
DB_LOW_HagSurvivorsPresent_Readables(_Item)
THEN
PROC_SetOnStage(_Item,1);

PROC
PROC_LOW_SetupHagRelatedReadables()
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_JatloLetter_eee34c26-063b-4011-9b8a-2efaba12da04,CONT_GEN_Mailbox_C_019_2ebacd72-0215-44d1-b683-028b5ae87a2d,1);
TemplateAddTo((ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_ResearchDraft_dd09726a-14d7-48b4-a215-0a33083f34fe,CONT_GEN_Chest_Common_B_Small_A_005_12eaa52e-6d32-49ac-a853-759b01c3c0d4,1);
TemplateRemoveFrom((ITEMROOT)BOOK_LOW_HagSurvivors_AdrielleNoHagNotes_438862c5-5984-4e62-8ac1-3e0b0bdf8ea0,CONT_GEN_Chest_Common_B_Small_A_005_12eaa52e-6d32-49ac-a853-759b01c3c0d4,1);

PROC
PROC_LOW_SetupHagRelatedReadables()
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
NOT DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagTookMother_38dc6752-5ab3-e108-64ed-fe63971d69fd)
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_HagSurvivors_HagSpysNote_97bfb610-9aa5-4183-bf60-972ad955b45a,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,1);
TemplateAddTo((ITEMROOT)BOOK_LOW_BlushingMermaid_HagsInformantNote_785e14ea-78ad-4583-9268-a5e64354b481,S_LOW_BlushingMermaid_CaptainsTable_22fa5c73-4d3b-48da-9f61-a8dbf8ac6c27,1);
TemplateRemoveFrom((ITEMROOT)BOOK_LOW_HagSurvivors_HagSpysNote_NoMayrina_658b0b6e-f60d-434c-8690-c2ea2b313f45,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,1);
TemplateRemoveFrom((ITEMROOT)BOOK_LOW_BlushingMermaid_HagsInformantNote_NoMayrina_974a42f2-00a9-4753-ac67-e5053d06b69b,S_LOW_BlushingMermaid_CaptainsTable_22fa5c73-4d3b-48da-9f61-a8dbf8ac6c27,1);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalMayrinaLeader_000_65a2aacb-639d-44e6-95a9-46f53a678a5e,1);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_MayrinaContactLetter_000_d7f96c98-1b5b-407a-948d-0253d951caf4,1);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalNoMayrina_000_eb73d969-cb4d-4510-8010-4d05fa9f696c,0);

PROC
PROC_LOW_SetupHagRelatedReadables()
AND
QRY_LOW_MayrinaPermaDefeatedOrGivenToHag()
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_HagSurvivors_HagSpysNote_NoMayrina_658b0b6e-f60d-434c-8690-c2ea2b313f45,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,1);
TemplateAddTo((ITEMROOT)BOOK_LOW_BlushingMermaid_HagsInformantNote_NoMayrina_974a42f2-00a9-4753-ac67-e5053d06b69b,S_LOW_BlushingMermaid_CaptainsTable_22fa5c73-4d3b-48da-9f61-a8dbf8ac6c27,1);
TemplateRemoveFrom((ITEMROOT)BOOK_LOW_HagSurvivors_HagSpysNote_97bfb610-9aa5-4183-bf60-972ad955b45a,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,1);
TemplateRemoveFrom((ITEMROOT)BOOK_LOW_BlushingMermaid_HagsInformantNote_785e14ea-78ad-4583-9268-a5e64354b481,S_LOW_BlushingMermaid_CaptainsTable_22fa5c73-4d3b-48da-9f61-a8dbf8ac6c27,1);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalMayrinaLeader_000_65a2aacb-639d-44e6-95a9-46f53a678a5e,0);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_MayrinaContactLetter_000_d7f96c98-1b5b-407a-948d-0253d951caf4,0);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalNoMayrina_000_eb73d969-cb4d-4510-8010-4d05fa9f696c,1);

QRY
QRY_LOW_MayrinaPermaDefeatedOrGivenToHag()
AND
DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd)
THEN
DB_NOOP(1);

QRY
QRY_LOW_MayrinaPermaDefeatedOrGivenToHag()
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagTookMother_38dc6752-5ab3-e108-64ed-fe63971d69fd)
THEN
DB_NOOP(1);

PROC
PROC_LOW_SetupHagRelatedReadables()
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
TemplateAddTo((ITEMROOT)BOOK_LOW_HagSurvivors_AdrielleNoHagNotes_438862c5-5984-4e62-8ac1-3e0b0bdf8ea0,CONT_GEN_Chest_Common_B_Small_A_005_12eaa52e-6d32-49ac-a853-759b01c3c0d4,1);
TemplateRemoveFrom((ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_JatloLetter_eee34c26-063b-4011-9b8a-2efaba12da04,CONT_GEN_Mailbox_C_019_2ebacd72-0215-44d1-b683-028b5ae87a2d,1);
TemplateRemoveFrom((ITEMROOT)BOOK_LOW_AuntieEthelsRevenge_ResearchDraft_dd09726a-14d7-48b4-a215-0a33083f34fe,CONT_GEN_Chest_Common_B_Small_A_005_12eaa52e-6d32-49ac-a853-759b01c3c0d4,1);
//END_REGION

//REGION Post-release reactivity for telling the survivors about the deal with the hag
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_ToldAboutHagDeal_fb133357-495c-495f-919e-a62c72d3b061)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,0);
//END_REGION

//REGION Debug
IF
FlagCleared((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720,NULL_00000000-0000-0000-0000-000000000000,0)
AND
DB_LOW_ActI_HagSurvivors(_Character,_Spot,_Dialog)
THEN
PROC_SetOnStage(_Character,0);

IF
FlagSet((FLAG)HAG_Hagspawn_Event_WifeHusbandLeave_c85ecfa6-472a-4200-fa39-1bb40b1338be,_,_)
THEN
DB_CanBeResurrected(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
SetFlag((FLAG)HAG_HagSpawn_Event_ResurrectedHusbandWithWand_939cfa41-11e0-4825-a1eb-b2ac5d26f0b8,NULL_00000000-0000-0000-0000-000000000000,0);
PROC_LOW_UndeadHusbandSetup();
RealtimeObjectTimerLaunch(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,"LOW_SetupUndeadHusband_Timer",1000);

IF
ObjectTimerFinished(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,"LOW_SetupUndeadHusband_Timer")
THEN
DB_LOW_UndeadHusbandSetupResurrected(1);
Resurrect(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);

// Resurrect is called as in Act 1 the undead husbands starts dead
IF
Resurrected((CHARACTER)S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5)
AND
DB_LOW_UndeadHusbandSetupResurrected(1)
THEN
NOT DB_LOW_UndeadHusbandSetupResurrected(1);
NOT DB_PermaDefeated(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
DB_Dialogs(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,(DIALOGRESOURCE)LOW_HagSurvivors_UndeadHusband_015571b8-a869-77fa-374d-c173fb9df480);

IF
FlagCleared((FLAG)HAG_Hagspawn_Event_WifeHusbandLeave_c85ecfa6-472a-4200-fa39-1bb40b1338be,_,_)
THEN
PROC_SetOnStage(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,0);

IF
FlagSet((FLAG)LOW_HagSurvivors_Debug_MayrinaDiedInActI_331b726e-28cc-447f-8bec-6f3d9c8fc796,_,_)
THEN
ClearFlag((FLAG)LOW_HagSurvivors_Debug_MayrinaDiedInActI_331b726e-28cc-447f-8bec-6f3d9c8fc796);
ClearFlag((FLAG)HAG_Hagspawn_Event_WifeHusbandLeave_c85ecfa6-472a-4200-fa39-1bb40b1338be);
ClearFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3);
ApplyStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"SILENCED",-1.0);
PROC_SetOnStage(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,0);
DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);

IF
FlagSet((FLAG)LOW_HagSurvivors_Debug_MayrinaSurvivedInActI_f6b10617-4258-41da-9545-a1ce89af71b8,_,_)
THEN
ClearFlag((FLAG)LOW_HagSurvivors_Debug_MayrinaSurvivedInActI_f6b10617-4258-41da-9545-a1ce89af71b8);
RemoveStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"SILENCED");
NOT DB_PermaDefeated(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd);
NOT DB_LOW_ActI_HagSurvivors((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(TRIGGER)S_LOW_HagSurvivors_SurrogateMotherSpot_6fc81c53-b113-4d70-b864-aa5e3aaec46d,(DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_SheepForm_0f9bbd49-0a64-e33f-3149-015a0a9f31e8);
DB_LOW_ActI_HagSurvivors((CHARACTER)S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,(TRIGGER)S_LOW_HagSurvivors_SurrogateMotherSpot_6fc81c53-b113-4d70-b864-aa5e3aaec46d,(DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_SheepForm_0f9bbd49-0a64-e33f-3149-015a0a9f31e8);

IF
FlagSet((FLAG)LOW_HagSurvivors_Debug_MaskOfRegetDiedInActI_d99e98ad-5d6d-4735-aa4b-c7743c260271,_,_)
THEN
ClearFlag((FLAG)LOW_HagSurvivors_Debug_MaskOfRegetDiedInActI_d99e98ad-5d6d-4735-aa4b-c7743c260271);
ApplyStatus(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,"SILENCED",-1.0);
PROC_SetOnStage(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,0);
DB_PermaDefeated(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8);

IF
FlagSet((FLAG)LOW_HagSurvivors_Debug_MaskOfRegretSurvivedInActI_3e331ba3-0ccf-4b78-b809-daa24be9f80e,_,_)
THEN
RemoveStatus(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,"SILENCED");
ClearFlag((FLAG)LOW_HagSurvivors_Debug_MaskOfRegretSurvivedInActI_3e331ba3-0ccf-4b78-b809-daa24be9f80e);
NOT DB_PermaDefeated(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8);
NOT DB_LOW_ActI_HagSurvivors(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8, S_LOW_HagSurvivors_HydrangeaSpot_8309f144-86d3-485a-be57-3dc4d623c78d, LOW_HagSurvivors_MaskedVictim1_9174eeda-dcfd-cdbc-c650-1bee3a363d30);
DB_LOW_ActI_HagSurvivors(S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8, S_LOW_HagSurvivors_HydrangeaSpot_8309f144-86d3-485a-be57-3dc4d623c78d, LOW_HagSurvivors_MaskedVictim1_9174eeda-dcfd-cdbc-c650-1bee3a363d30);

IF
FlagSet((FLAG)LOW_HagSurvivors_Debug_QuestGrenade_decc423e-1dfb-4185-84ba-ec75602a2fd0,_,_)
AND
GetHostCharacter(_Host)
THEN
ClearFlag((FLAG)LOW_HagSurvivors_Debug_QuestGrenade_decc423e-1dfb-4185-84ba-ec75602a2fd0);
TemplateAddTo((ITEMROOT)LOW_RegenerationPrevention_Grenade_df5f8cbf-42c5-4c0d-a0ec-ce5046474d8e,_Host,1,1);

IF
DB_SpotPlayers((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8, "HAG_HagLair_MaskedVictim01", _, _)
THEN
PROC_SpotPlayers_StopSpotting((CHARACTER)S_HAG_Hag_MaskedVictim1_d2832662-4a12-4565-bfe2-094b93ae8af8,"HAG_HagLair_MaskedVictim01");

// Ensures that the respective readables are created/set on stage for debugging
IF
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
PROC_LOW_SetupHagRelatedReadables();
//END_REGION

//REGION Hidden booster for dealing with the squatter bandits
PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_HagSurvivors_SquatterBandits")
THEN
QuestUpdate("HIDDEN_CTY_Boosters","LOW_HagSurvivors_DefeatSquatterBandits");
//END_REGION

//REGION Disguised Redcap Combat Support

// OE command to set up combat
IF
TextEvent("LOW_HagSurvivor_Setup")
THEN
SetFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720);

//REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
