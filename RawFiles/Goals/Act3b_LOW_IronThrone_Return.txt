Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_DropMutingStatussesDialog((DIALOGRESOURCE)IRN_IronThrone_Return_09c71cbf-c72c-d810-3bba-c1b9fc81770e);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)IRN_IronThrone_ReturnRavengard_OM_Wyll_AOM_OOM_098efda3-4db1-0643-a8dd-2138ffc2f9ff);
DB_DropMutingStatussesDialog((DIALOGRESOURCE)IRN_IronThrone_ReturnRavengard_OM_Wyll_COM_7a6ef705-6264-d7d9-b461-b4366e7df226);

DB_State_Priority(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "Arrival", 0);
DB_State_Priority(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "CountdownOngoing", 1000);
DB_State_Priority(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "CountdownFinished", 2000);
DB_State_Priority(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "BackAtDocks", 3000);
DB_State_Priority(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "WaveservantsAttack", 3500);
DB_State_Priority(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "BackInBasement", 3800);
DB_State_Priority(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "Finished", 4000);
DB_State_Priority(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "DestroyedInSteelwatch", 10000);

//DB_IRN_PrisonerGroup(_GroupID, _Prisoner) - Originally in Act3i_IRN_IronThrone goal - also added here for easier debugging
DB_IRN_PrisonerGroup(1, (CHARACTER)S_GLO_IronThrone_Group1_Prisoner1_18991627-0e38-44d0-a8ac-31e1105d5392);
DB_IRN_PrisonerGroup(1, (CHARACTER)S_GLO_IronThrone_Group1_Prisoner2_ced0a558-b5ed-4493-a499-1890ec48fbfb);
DB_IRN_PrisonerGroup(1, (CHARACTER)S_GLO_IronThrone_Group1_Prisoner3_c8b6ebf5-e505-4dbd-bd85-dbf82684cbfb);
DB_IRN_PrisonerGroup(2, (CHARACTER)S_GLO_IronThrone_Group2_Prisoner1_aede3e82-f02b-4d6c-a92f-e9418b1b0e37);
DB_IRN_PrisonerGroup(2, (CHARACTER)S_GLO_IronThrone_Group2_Prisoner2_ec0de12d-4a2f-4683-bb11-91473ec3577c);
DB_IRN_PrisonerGroup(2, (CHARACTER)S_GLO_IronThrone_Group2_Prisoner3_d4f52268-f641-406e-b725-0ebf31193693);
DB_IRN_PrisonerGroup(3, (CHARACTER)S_GLO_IronThrone_Group3_Prisoner1_bbf324dd-8840-4d7d-a097-1937016ae4b8);
DB_IRN_PrisonerGroup(3, (CHARACTER)S_GLO_IronThrone_Group3_Prisoner2_926d2515-b22a-4b51-8737-42a6c1ebd4f4);
DB_IRN_PrisonerGroup(4, (CHARACTER)S_GLO_IronThrone_Group4_Prisoner1_a1831c84-e443-4ba9-95b2-49758d576bf5);
DB_IRN_PrisonerGroup(5, (CHARACTER)S_GLO_IronThrone_Group5_Prisoner1_08ed18ea-c679-4845-93ab-a88fe73a2e55);
DB_IRN_PrisonerGroup(6, (CHARACTER)S_GLO_IronThrone_Group6_Prisoner1_5377cb38-731d-4582-9396-98529856cdbf);
DB_IRN_PrisonerGroup(7, (CHARACTER)S_GLO_IronThrone_Group7_Prisoner1_06d864d4-924a-4595-8155-d96df5b5f97e);
DB_IRN_PrisonerGroup(8, (CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);

DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group1_Prisoner1_18991627-0e38-44d0-a8ac-31e1105d5392, (DIALOGRESOURCE)IRN_IronThrone_ZumboPumbo_379d519d-ca24-8973-611a-e60706516590);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group1_Prisoner2_ced0a558-b5ed-4493-a499-1890ec48fbfb, (DIALOGRESOURCE)IRN_IronThrone_CeresOlsin_02abfcb5-594a-33c1-5c32-66d845c0cba0);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group1_Prisoner3_c8b6ebf5-e505-4dbd-bd85-dbf82684cbfb, (DIALOGRESOURCE)IRN_IronThrone_OgroNiggles_548d63d8-0d5d-1b78-c9b9-bcaf44ff2c68);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group2_Prisoner1_aede3e82-f02b-4d6c-a92f-e9418b1b0e37, (DIALOGRESOURCE)IRN_IronThrone_PhoenixLubbins_3644bd97-1c31-eee4-1b4e-16224d3684f2);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group2_Prisoner2_ec0de12d-4a2f-4683-bb11-91473ec3577c, (DIALOGRESOURCE)IRN_IronThrone_HastarBiggs_f5e1494d-e0cf-5458-074d-8943e0cdd7b5);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group2_Prisoner3_d4f52268-f641-406e-b725-0ebf31193693, (DIALOGRESOURCE)IRN_IronThrone_FeatherweightFalson_0cf6b7f8-d136-0723-4a3c-3c84c49f128b);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group3_Prisoner1_bbf324dd-8840-4d7d-a097-1937016ae4b8, (DIALOGRESOURCE)IRN_IronThrone_DeedleOfran_a5e0ceba-ebf0-bb87-e61a-17e79cdb7ed6);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group3_Prisoner2_926d2515-b22a-4b51-8737-42a6c1ebd4f4, (DIALOGRESOURCE)IRN_IronThrone_MarlonoRhandle_cfc13831-0235-6198-4f31-4c64a43bc062);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group4_Prisoner1_a1831c84-e443-4ba9-95b2-49758d576bf5, (DIALOGRESOURCE)IRN_IronThrone_Santoria_ceb6f4e3-111f-b8ee-89e0-68ce74fc089a);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group5_Prisoner1_08ed18ea-c679-4845-93ab-a88fe73a2e55, (DIALOGRESOURCE)IRN_IronThrone_ThindoVintervur_02e36793-107d-d76c-bd66-09ce11c5252f);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group6_Prisoner1_5377cb38-731d-4582-9396-98529856cdbf, (DIALOGRESOURCE)IRN_IronThrone_FlansyThornwhist_01bb805b-942c-d7bc-982a-13c800a86c01);
DB_LOW_IronThrone_HostageReturnDialogs((CHARACTER)S_GLO_IronThrone_Group7_Prisoner1_06d864d4-924a-4595-8155-d96df5b5f97e, (DIALOGRESOURCE)IRN_IronThrone_CaraleeGrollo_f94048ed-9e82-0ed2-a898-1e6d05bfa17a);

//Script needed in order to run parts of the Iron Throne situation in CTY_Main_A
//DB_LOW_IronThrone_PrisonerReturnPositions(_SubmersiblePos, _SubmersibleBench, _BasementPos)
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group1_Prisoner1_18991627-0e38-44d0-a8ac-31e1105d5392, (TRIGGER)S_LOW_HostageReturn_Hostage1_1f913b51-1bd9-4255-8b7a-9bf320039ffa, (ITEM)S_LOW_SubmersibleInteriorBench01_a4ed43ac-f7c0-473a-8c4f-112a3a9c364d);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group1_Prisoner2_ced0a558-b5ed-4493-a499-1890ec48fbfb, (TRIGGER)S_LOW_HostageReturn_Hostage2_63997902-2032-43b1-82c2-47dd01aeef0e, (ITEM)S_LOW_SubmersibleInteriorBench02_7ea9b278-f935-49a7-b2de-58127d3ce3af);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group1_Prisoner3_c8b6ebf5-e505-4dbd-bd85-dbf82684cbfb, (TRIGGER)S_LOW_HostageReturn_Hostage3_c661b0d0-f874-4824-a2e8-47142920260e, (ITEM)S_LOW_SubmersibleInteriorBench03_fde1f081-16af-4aad-b91b-a1bef2574d5f);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group2_Prisoner1_aede3e82-f02b-4d6c-a92f-e9418b1b0e37, (TRIGGER)S_LOW_HostageReturn_Hostage4_ffd574b0-89b9-44f5-a46b-7803e6ac1e06, (ITEM)S_LOW_SubmersibleInteriorBench04_ed509a43-1bfc-4654-88a0-a44cd46adfc1);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group2_Prisoner2_ec0de12d-4a2f-4683-bb11-91473ec3577c, (TRIGGER)S_LOW_HostageReturn_Hostage10_a75d9591-8047-4cb1-af3e-8c600f1353a2, (ITEM)S_LOW_SubmersibleInteriorBench10_c99eb9ea-e8d7-432e-945c-cd6fb00a6deb);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group2_Prisoner3_d4f52268-f641-406e-b725-0ebf31193693, (TRIGGER)S_LOW_HostageReturn_Hostage6_d7b3d97e-39a0-4a41-99fa-c06dcff60f16, (ITEM)S_LOW_SubmersibleInteriorBench06_a65d7207-e63a-46ba-b960-9b73caf8ef05);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group3_Prisoner1_bbf324dd-8840-4d7d-a097-1937016ae4b8, (TRIGGER)S_LOW_HostageReturn_Hostage7_4c760b84-339d-4adb-8f1c-4e044f712fe7, (ITEM)S_LOW_SubmersibleInteriorBench07_23eb1a33-deb7-4940-bdfd-cafdfc80527f);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group3_Prisoner2_926d2515-b22a-4b51-8737-42a6c1ebd4f4, (TRIGGER)S_LOW_HostageReturn_Hostage8_0c22bb86-413c-4142-8545-0c2b0a2e1636, (ITEM)S_LOW_SubmersibleInteriorBench08_7553025a-3b5b-4a72-ac48-1e3f1fc8695b);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group4_Prisoner1_a1831c84-e443-4ba9-95b2-49758d576bf5, (TRIGGER)S_LOW_HostageReturn_Hostage13_35527d0a-7054-490f-9b92-6da4bc9820f2, (ITEM)S_LOW_SubmersibleInteriorBench13_9f92a4b2-c152-4bb8-845d-0137c3c5f5b9);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group5_Prisoner1_08ed18ea-c679-4845-93ab-a88fe73a2e55, (TRIGGER)S_LOW_HostageReturn_Hostage14_36052ee0-1938-4be6-a72b-fd1cb0095da0, (ITEM)S_LOW_SubmersibleInteriorBench14_e8963965-497b-4c83-8b0f-e82b4a52e7ab);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group6_Prisoner1_5377cb38-731d-4582-9396-98529856cdbf, (TRIGGER)S_LOW_HostageReturn_Hostage9_33e3ef1a-51d5-49e3-86b7-d6efa136c130, (ITEM)S_LOW_SubmersibleInteriorBench09_a5ef0212-495a-4108-a6f5-226d5891f26b);
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)S_GLO_IronThrone_Group7_Prisoner1_06d864d4-924a-4595-8155-d96df5b5f97e, (TRIGGER)S_LOW_HostageReturn_Hostage5_ed8b49cb-795a-4ea2-86c0-ec2ed893ff3a, (ITEM)S_LOW_SubmersibleInteriorBench05_3fdf0c1b-a5d3-410c-810e-cdbab8dc2101);

//Order for each prisoner to leave after the dialog, depending on their position in the room
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group1_Prisoner1_18991627-0e38-44d0-a8ac-31e1105d5392);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group1_Prisoner2_ced0a558-b5ed-4493-a499-1890ec48fbfb);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group1_Prisoner3_c8b6ebf5-e505-4dbd-bd85-dbf82684cbfb);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group2_Prisoner1_aede3e82-f02b-4d6c-a92f-e9418b1b0e37);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group2_Prisoner2_ec0de12d-4a2f-4683-bb11-91473ec3577c);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group2_Prisoner3_d4f52268-f641-406e-b725-0ebf31193693);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group3_Prisoner1_bbf324dd-8840-4d7d-a097-1937016ae4b8);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group3_Prisoner2_926d2515-b22a-4b51-8737-42a6c1ebd4f4);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group4_Prisoner1_a1831c84-e443-4ba9-95b2-49758d576bf5);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group5_Prisoner1_08ed18ea-c679-4845-93ab-a88fe73a2e55);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group6_Prisoner1_5377cb38-731d-4582-9396-98529856cdbf);
DB_LOW_IronThrone_PrisonerLeaveOrder((CHARACTER)S_GLO_IronThrone_Group7_Prisoner1_06d864d4-924a-4595-8155-d96df5b5f97e);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_WarehouseBasementArea_cc61966e-79f4-411b-a6cc-da6b153bb84f);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_SubmersibleInteriorArea_79fedabd-52a5-4d81-9169-ec7d5d43e8c4);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)IRN_IronThrone_Return_09c71cbf-c72c-d810-3bba-c1b9fc81770e, (TRIGGER)S_LOW_WarehouseBasementArea_cc61966e-79f4-411b-a6cc-da6b153bb84f, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)IRN_IronThrone_ReturnRavengard_OM_Wyll_AOM_OOM_098efda3-4db1-0643-a8dd-2138ffc2f9ff, (TRIGGER)S_LOW_WarehouseBasementArea_cc61966e-79f4-411b-a6cc-da6b153bb84f, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)IRN_IronThrone_ReturnRavengard_OM_Wyll_COM_7a6ef705-6264-d7d9-b461-b4366e7df226, (TRIGGER)S_LOW_WarehouseBasementArea_cc61966e-79f4-411b-a6cc-da6b153bb84f, 1);

DB_LOW_IronThrone_ReturnDialogs((DIALOGRESOURCE)IRN_IronThrone_Return_09c71cbf-c72c-d810-3bba-c1b9fc81770e);
DB_LOW_IronThrone_ReturnDialogs((DIALOGRESOURCE)IRN_IronThrone_ReturnRavengard_OM_Wyll_AOM_OOM_098efda3-4db1-0643-a8dd-2138ffc2f9ff);
DB_LOW_IronThrone_ReturnDialogs((DIALOGRESOURCE)IRN_IronThrone_ReturnRavengard_OM_Wyll_COM_7a6ef705-6264-d7d9-b461-b4366e7df226);

PROC_SetOnStage((ITEM)S_LOW_BeastmasterUnfinishedNote_375c253e-567e-459e-b80b-13745ca0bf66, 0);

DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_BellyOfTheBeast_WaveservantsConfrontation_f00cc5c0-68ef-9825-425e-5169af57ca3d, (TRIGGER)S_LOW_WarehouseBasementArea_cc61966e-79f4-411b-a6cc-da6b153bb84f, 1);

DB_LOW_IronThrone_DeadCharacterBeachPos((TRIGGER)S_LOW_IronThroneDeadCharacterPos01_3a04cce8-e5c7-4d08-97dc-018a22b99d7b);
DB_LOW_IronThrone_DeadCharacterBeachPos((TRIGGER)S_LOW_IronThroneDeadCharacterPos02_73e937ca-506b-4eca-9038-8af9299d6800);
DB_LOW_IronThrone_DeadCharacterBeachPos((TRIGGER)S_LOW_IronThroneDeadCharacterPos03_82697ac3-8959-42b4-a99a-c306157b0bbb);
DB_LOW_IronThrone_DeadCharacterBeachPos((TRIGGER)S_LOW_IronThroneDeadCharacterPos04_5af549a3-98b3-414b-b939-8bce9026eb5b);
DB_LOW_IronThrone_DeadCharacterBeachPos((TRIGGER)S_LOW_IronThroneDeadCharacterPos05_06b90677-52ac-4c5a-a615-49b224be47a3);

DB_LOW_IronThrone_DeadCharactersPriorityHostages((CHARACTER)S_GLO_IronThrone_Group2_Prisoner1_aede3e82-f02b-4d6c-a92f-e9418b1b0e37);
DB_LOW_IronThrone_DeadCharactersPriorityHostages((CHARACTER)S_GLO_IronThrone_Group3_Prisoner2_926d2515-b22a-4b51-8737-42a6c1ebd4f4);
DB_LOW_IronThrone_DeadCharactersPriorityHostages((CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);
KBSECTION
//REGION Debug
//Debug state progress
PROC
PROC_DEBUG_IRN_ChangeState((FLAG)Debug_IRN_IronThrone_StateChange_CountdownOngoing_03ea8ea9-c7da-4dd4-b2f2-8d2c504b9bc4)
AND
QRY_OnlyOnce_Reset("DEBUG_IronThrone_Teleported_CountdownOngoing")
THEN
PROC_TeleportPartiesTo((TRIGGER)S_IRN_Debug_StartCountdownPos_66dd9741-ba35-4e0f-bc97-b0e2f0f301c0, "DEBUG_IronThrone_Teleported_CountdownOngoing");

IF
EntityEvent(_Player, "DEBUG_IronThrone_Teleported_CountdownOngoing")
AND
QRY_OnlyOnce("DEBUG_IronThrone_Teleported_CountdownOngoing")
THEN
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "CountdownOngoing");
ClearFlag((FLAG)Debug_IRN_IronThrone_StateChange_CountdownOngoing_03ea8ea9-c7da-4dd4-b2f2-8d2c504b9bc4);

PROC
PROC_DEBUG_IRN_ChangeState((FLAG)Debug_IRN_IronThrone_StateChange_CountdownFinished_d448c691-e09e-4e8e-9403-10a5c7200d63)
AND
QRY_OnlyOnce_Reset("DEBUG_IronThrone_Teleported_CountdownFinished")
THEN
PROC_TeleportPartiesTo((TRIGGER)S_IRN_Debug_StartCountdownPos_66dd9741-ba35-4e0f-bc97-b0e2f0f301c0, "DEBUG_IronThrone_Teleported_CountdownFinished");

IF
EntityEvent(_Player, "DEBUG_IronThrone_Teleported_CountdownFinished")
AND
QRY_OnlyOnce("DEBUG_IronThrone_Teleported_CountdownFinished")
THEN
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "CountdownFinished");
ClearFlag((FLAG)Debug_IRN_IronThrone_StateChange_CountdownFinished_d448c691-e09e-4e8e-9403-10a5c7200d63);

//State: BackAtDocks - All hostages were saved
PROC
PROC_DEBUG_IRN_ChangeState((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_MajoritySaved_1a52a283-3e07-4d8f-acb6-5b963d8c99fe)
AND
QRY_OnlyOnce_Reset("DEBUG_IronThrone_Teleported_BackAtDocks_MajoritySaved")
THEN
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group1_Prisoner1_18991627-0e38-44d0-a8ac-31e1105d5392);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group1_Prisoner2_ced0a558-b5ed-4493-a499-1890ec48fbfb);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group1_Prisoner3_c8b6ebf5-e505-4dbd-bd85-dbf82684cbfb);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group2_Prisoner1_aede3e82-f02b-4d6c-a92f-e9418b1b0e37);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group2_Prisoner2_ec0de12d-4a2f-4683-bb11-91473ec3577c);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group2_Prisoner3_d4f52268-f641-406e-b725-0ebf31193693);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group3_Prisoner1_bbf324dd-8840-4d7d-a097-1937016ae4b8);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group3_Prisoner2_926d2515-b22a-4b51-8737-42a6c1ebd4f4);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group7_Prisoner1_06d864d4-924a-4595-8155-d96df5b5f97e);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group4_Prisoner1_a1831c84-e443-4ba9-95b2-49758d576bf5);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group5_Prisoner1_08ed18ea-c679-4845-93ab-a88fe73a2e55);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group6_Prisoner1_5377cb38-731d-4582-9396-98529856cdbf);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);
SetFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
PROC_TeleportPartiesTo((TRIGGER)S_LOW_IronThrone_SubmersibleInteriorReturnPos_6fc62c85-7c7f-4651-ba4c-1105ce2c86d3, "DEBUG_IronThrone_Teleported_BackAtDocks_MajoritySaved");

IF
EntityEvent(_Player, "DEBUG_IronThrone_Teleported_BackAtDocks_MajoritySaved")
AND
QRY_OnlyOnce("DEBUG_IronThrone_Teleported_BackAtDocks_MajoritySaved")
THEN
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "BackAtDocks");
ClearFlag((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_1a52a283-3e07-4d8f-acb6-5b963d8c99fe);

//State: BackAtDocks - Majority Dead
PROC
PROC_DEBUG_IRN_ChangeState((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_MajorityDead_38c21a66-a63a-4df8-9db2-623768674798)
AND
QRY_OnlyOnce_Reset("DEBUG_IronThrone_Teleported_BackAtDocks_MajorityDead")
THEN
Die(S_GLO_IronThrone_Group1_Prisoner1_18991627-0e38-44d0-a8ac-31e1105d5392, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
Die(S_GLO_IronThrone_Group1_Prisoner2_ced0a558-b5ed-4493-a499-1890ec48fbfb, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
Die(S_GLO_IronThrone_Group1_Prisoner3_c8b6ebf5-e505-4dbd-bd85-dbf82684cbfb, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
Die(S_GLO_IronThrone_Group2_Prisoner1_aede3e82-f02b-4d6c-a92f-e9418b1b0e37, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
Die(S_GLO_IronThrone_Group2_Prisoner2_ec0de12d-4a2f-4683-bb11-91473ec3577c, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
Die(S_GLO_IronThrone_Group2_Prisoner3_d4f52268-f641-406e-b725-0ebf31193693, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
Die(S_GLO_IronThrone_Group3_Prisoner1_bbf324dd-8840-4d7d-a097-1937016ae4b8, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
Die(S_GLO_IronThrone_Group3_Prisoner2_926d2515-b22a-4b51-8737-42a6c1ebd4f4, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
Die(S_GLO_IronThrone_Group7_Prisoner1_06d864d4-924a-4595-8155-d96df5b5f97e, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group4_Prisoner1_a1831c84-e443-4ba9-95b2-49758d576bf5);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group5_Prisoner1_08ed18ea-c679-4845-93ab-a88fe73a2e55);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group6_Prisoner1_5377cb38-731d-4582-9396-98529856cdbf);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);
SetFlag((FLAG)LOW_SteelWatchFoundry_State_MajorityIronThronePrisonersDead_6c40a75d-32ae-4402-a54c-062805f7ee7d);
SetFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
PROC_TeleportPartiesTo((TRIGGER)S_LOW_IronThrone_SubmersibleInteriorReturnPos_6fc62c85-7c7f-4651-ba4c-1105ce2c86d3, "DEBUG_IronThrone_Teleported_BackAtDocks_MajorityDead");

IF
EntityEvent(_Player, "DEBUG_IronThrone_Teleported_BackAtDocks_MajorityDead")
AND
QRY_OnlyOnce("DEBUG_IronThrone_Teleported_BackAtDocks_MajorityDead")
THEN
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "BackAtDocks");
ClearFlag((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_1a52a283-3e07-4d8f-acb6-5b963d8c99fe);

//State: BackAtDocks - All but one hostages died
PROC
PROC_DEBUG_IRN_ChangeState((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_AllButOne_8dd3929c-0c53-41c2-b795-879a1bef3240)
AND
QRY_OnlyOnce_Reset("DEBUG_IronThrone_Teleported_BackAtDocks_AllButOne")
THEN
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);
SetFlag((FLAG)LOW_SteelWatchFoundry_State_AllButOneIronThronePrisonersDead_d41e3f87-aeed-4b23-8649-261d1e6a063b);
SetFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
PROC_TeleportPartiesTo((TRIGGER)S_LOW_IronThrone_SubmersibleInteriorReturnPos_6fc62c85-7c7f-4651-ba4c-1105ce2c86d3, "DEBUG_IronThrone_Teleported_BackAtDocks_AllButOne");

IF
EntityEvent(_Player, "DEBUG_IronThrone_Teleported_BackAtDocks_AllButOne")
AND
QRY_OnlyOnce("DEBUG_IronThrone_Teleported_BackAtDocks_AllButOne")
THEN
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "BackAtDocks");
ClearFlag((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_1a52a283-3e07-4d8f-acb6-5b963d8c99fe);

//State: BackAtDocks - All hostages died
PROC
PROC_DEBUG_IRN_ChangeState((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_AllDead_1edf6e8d-64da-443d-b762-750c28bc5e9d)
AND
QRY_OnlyOnce_Reset("DEBUG_IronThrone_Teleported_BackAtDocks_AllDead")
THEN
SetFlag((FLAG)LOW_SteelWatchFoundry_State_AllIronThronePrisonersDead_4fefe27f-7cd6-44b1-9322-a57b22246271);
Die(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
Die(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
SetFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
PROC_TeleportPartiesTo((TRIGGER)S_LOW_IronThrone_SubmersibleInteriorReturnPos_6fc62c85-7c7f-4651-ba4c-1105ce2c86d3, "DEBUG_IronThrone_Teleported_BackAtDocks_AllDead");

IF
EntityEvent(_Player, "DEBUG_IronThrone_Teleported_BackAtDocks_AllDead")
AND
QRY_OnlyOnce("DEBUG_IronThrone_Teleported_BackAtDocks_AllDead")
THEN
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "BackAtDocks");
ClearFlag((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_1a52a283-3e07-4d8f-acb6-5b963d8c99fe);

//State: BackAtDocks - Spokesperson died, other hostages alive
PROC
PROC_DEBUG_IRN_ChangeState((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_SpokespersonDead_107bdd2a-d5ff-4aee-8638-268876cff74e)
AND
QRY_OnlyOnce_Reset("DEBUG_IronThrone_Teleported_BackAtDocks_SpokespersonDead")
THEN
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group1_Prisoner1_18991627-0e38-44d0-a8ac-31e1105d5392);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group1_Prisoner2_ced0a558-b5ed-4493-a499-1890ec48fbfb);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group1_Prisoner3_c8b6ebf5-e505-4dbd-bd85-dbf82684cbfb);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group2_Prisoner1_aede3e82-f02b-4d6c-a92f-e9418b1b0e37);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group2_Prisoner2_ec0de12d-4a2f-4683-bb11-91473ec3577c);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group2_Prisoner3_d4f52268-f641-406e-b725-0ebf31193693);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group3_Prisoner1_bbf324dd-8840-4d7d-a097-1937016ae4b8);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group3_Prisoner2_926d2515-b22a-4b51-8737-42a6c1ebd4f4);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group7_Prisoner1_06d864d4-924a-4595-8155-d96df5b5f97e);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group4_Prisoner1_a1831c84-e443-4ba9-95b2-49758d576bf5);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group5_Prisoner1_08ed18ea-c679-4845-93ab-a88fe73a2e55);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_IronThrone_Group6_Prisoner1_5377cb38-731d-4582-9396-98529856cdbf);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);
Die(S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158, DEATHTYPE.DoT, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0.0);
SetFlag((FLAG)LOW_SteelWatchFoundry_State_AnyIronThronePrisonersDead_5d6c4329-ee56-4084-8220-d627b716ac87);
SetFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c);
PROC_TeleportPartiesTo((TRIGGER)S_LOW_IronThrone_SubmersibleInteriorReturnPos_6fc62c85-7c7f-4651-ba4c-1105ce2c86d3, "DEBUG_IronThrone_Teleported_BackAtDocks_SpokespersonDead");

IF
EntityEvent(_Player, "DEBUG_IronThrone_Teleported_BackAtDocks_SpokespersonDead")
AND
QRY_OnlyOnce("DEBUG_IronThrone_Teleported_BackAtDocks_SpokespersonDead")
THEN
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "BackAtDocks");
ClearFlag((FLAG)Debug_IRN_IronThrone_StateChange_BackAtDocks_1a52a283-3e07-4d8f-acb6-5b963d8c99fe);

//END_REGION

//REGION Left Without Entering Iron Throne
IF
EntityEvent(_Player, "IRN_IronThrone_LeftWithoutEntering")
THEN
PROC_SetOnStage(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, 1);

IF
FlagSet((FLAG)IRN_IronThrone_State_LeftWithoutEntering_9530d1e4-8740-423b-a989-d7912a5de9bc,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_State_SubmersibleReadyToDepart_a2ae474a-de65-4fde-b019-b1fdb6306acb)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BellyOfTheBeast_Beastmaster_df47ddde-7444-42e9-a50f-3371a7b21cb8, 0);

//END_REGION

//REGION State start: BackAtDocks
IF
DB_InRegion(_Player, (TRIGGER)S_LOW_SubmersibleInteriorArea_79fedabd-52a5-4d81-9169-ec7d5d43e8c4)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("IRN_IronThrone_ReturnedToSubmersibleInterior")
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_SubmersibleInteriorArea_79fedabd-52a5-4d81-9169-ec7d5d43e8c4);
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "BackAtDocks");

IF
TextEvent("irn_deadbodies")
THEN
PROC_LOW_IronThrone_TeleportDeadBodiesToShore();

//Teleport players who were left behind in the Iron Throne to the beach
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
THEN
PROC_LOW_IronThrone_TeleportDeadBodiesToShore();

PROC
PROC_LOW_IronThrone_TeleportDeadBodiesToShore()
AND
DB_IRN_PlayerDead(_Player)
AND
QRY_OnlyOnce_Reset("LOW_IronThrone_TeleportedDeadPlayerToBeach")
AND
DB_LOW_IronThrone_DeadCharacterBeachPos(_BeachPos)
AND
QRY_OnlyOnce("LOW_IronThrone_TeleportedDeadPlayerToBeach")
THEN
NOT DB_LOW_IronThrone_DeadCharacterBeachPos(_BeachPos);
NOT DB_IRN_PlayerDead(_Player);
TeleportTo(_Player, _BeachPos, "", 0, 0, 0, 1, 1);

//Teleport any priority dead hostages if of them perished
PROC
PROC_LOW_IronThrone_TeleportDeadBodiesToShore()
AND
DB_LOW_IronThrone_DeadCharactersPriorityHostages(_Prisoner)
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, _Prisoner, 0)
AND
QRY_OnlyOnce_Reset("LOW_IronThrone_TeleportedDeadHostageToBeach")
AND
DB_LOW_IronThrone_DeadCharacterBeachPos(_BeachPos)
AND
QRY_OnlyOnce("LOW_IronThrone_TeleportedDeadHostageToBeach")
THEN
PROC_DieImmediate(_Prisoner, DEATHTYPE.Physical, 1);
DB_CorpseCleanup_Ignore(_Prisoner);
NOT DB_LOW_IronThrone_DeadCharacterBeachPos(_BeachPos);
TeleportTo(_Prisoner, _BeachPos, "", 0, 0, 0, 1, 1);

//Teleport any remaining dead hostages if there are any spots left
PROC
PROC_LOW_IronThrone_TeleportDeadBodiesToShore()
AND
DB_IRN_PrisonerGroup(_GroupId, _Prisoner)
AND
_GroupId <= 8 //Everyone except Ravengard and Omeluum
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, _Prisoner, 0)
AND
QRY_OnlyOnce_Reset("LOW_IronThrone_TeleportedDeadHostageToBeach")
AND
DB_LOW_IronThrone_DeadCharacterBeachPos(_BeachPos)
AND
QRY_OnlyOnce("LOW_IronThrone_TeleportedDeadHostageToBeach")
THEN
PROC_DieImmediate(_Prisoner, DEATHTYPE.Physical, 0);
DB_CorpseCleanup_Ignore(_Prisoner);
NOT DB_LOW_IronThrone_DeadCharacterBeachPos(_BeachPos);
TeleportTo(_Prisoner, _BeachPos, "", 0, 0, 0, 1, 1);

//Return surviving Gondian prisoners to the Dock Warehouse
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
THEN
DB_TriggerEvents_AllPartyMembersLeft((TRIGGER)S_LOW_BellyOfTheBeast_WarehouseBasement_SUB_6c9b1262-8097-45a1-b989-8f56dd4d38e4, "LOW_IronThrone_AllPlayersLeftBasement");
DB_BlockedWaypointZone(S_LOW_SubmersibleInteriorArea_79fedabd-52a5-4d81-9169-ec7d5d43e8c4);

PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
DB_LOW_DockWarehouse_Beasts(_Beast)
AND
NOT DB_Defeated(_Beast)
THEN
PROC_SetOnStage(_Beast, 0);

//Players went to Iron Throne with the beastmaster
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_State_PlayersWentToIronThroneWithBeastmaster_61dd108a-9a51-4edc-b070-3da42574d0d9)
AND
NOT DB_PermaDefeated(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1)
THEN
TeleportTo(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, S_LOW_HostageReturn_Beastmaster_501d9a0b-2c5c-43ca-ab17-ebfd7335ec85);
PROC_SetOnStage(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, 1);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1);
SetHasDialog(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, 0);
RemoveHarmfulStatuses(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1);
PROC_RestoreAttitudeToPartyIfLower((CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158, 20);

//Players went to Iron Throne without the beastmaster and the waveservants are dead
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
NOT DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_State_PlayersWentToIronThroneWithBeastmaster_61dd108a-9a51-4edc-b070-3da42574d0d9)
AND
NOT QRY_LOW_BellyOfTheBeast_WaveservantAmbushHappening()
AND
NOT DB_PermaDefeated(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1)
THEN
PROC_SetOnStage(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, 0);
PROC_SetOnStage((ITEM)S_LOW_BeastmasterUnfinishedNote_375c253e-567e-459e-b80b-13745ca0bf66, 1);

//Players went to Iron Throne without the beastmaster and the waveservants are alive
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
NOT DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_State_PlayersWentToIronThroneWithBeastmaster_61dd108a-9a51-4edc-b070-3da42574d0d9)
AND
QRY_LOW_BellyOfTheBeast_WaveservantAmbushHappening()
AND
NOT DB_PermaDefeated(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1)
THEN
TeleportTo(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, S_LOW_WarehouseBasementBeastmasterNearSubPos_4d077950-4e58-47d8-9eff-e6df2d978bd8, "", 0, 0, 0, 0, 1);
PROC_SetOnStage(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, 1);
Die(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, DEATHTYPE.Cold, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 0.0);
SetFlag((FLAG)LOW_BellyOfTheBeast_State_WaveservantsKilledBeastmasterWhilePlayerIsInIronThrone_30add9ad-0e3d-41d3-a784-24e7efbb2acc);

QRY
QRY_LOW_BellyOfTheBeast_WaveservantAmbushHappening()
AND
NOT DB_Defeated(S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8)
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_Knows_WaveservantsWantBeastmasterDead_2bed3d0c-d9b1-471b-ac24-ec1a6d24819e)
THEN
DB_NOOP(1);

PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1)
THEN
TeleportTo(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, S_LOW_HostageReturn_Omeluum_ca492f8e-774a-4e41-99c9-b817ecbd06cc);
RemoveHarmfulStatuses((CHARACTER)S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);
RemoveStatus(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, "HASTE_LETHARGY", NULL_00000000-0000-0000-0000-000000000000);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);
DB_Dialogs((CHARACTER)S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, (DIALOGRESOURCE)IRN_IronThrone_Omeluum_26f2208c-177d-b640-fb5a-0594b84f305a);

PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
THEN
TeleportTo(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, S_LOW_HostageReturn_Ravengard_934888a1-7ec8-429e-b282-1d86f6381789);
RemoveHarmfulStatuses((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
RemoveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "HASTE_LETHARGY", NULL_00000000-0000-0000-0000-000000000000);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
DB_Dialogs(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, (DIALOGRESOURCE)IRN_IronThrone_Ravengard_5f8aa534-4bfc-cfd1-0c6d-f2c0a40fe96a);

//Spokesperson is alive
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, (CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158, 1)
THEN
TeleportTo(S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158, S_LOW_HostageReturn_Spokesperson_8c2ff3f7-09a3-498e-b504-37aaf26396cf);
PROC_SetOnStage((CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158, 1);
RemoveHarmfulStatuses((CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);
RemoveStatus(S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158, "HASTE_LETHARGY", NULL_00000000-0000-0000-0000-000000000000);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);
DB_Dialogs((CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158, (DIALOGRESOURCE)IRN_IronThrone_ReturnHostages_ef782bd3-1403-ce1c-f6c9-e431971f0f4c);
PROC_TriggerRegisterForPlayers((TRIGGER)S_IRN_IronThrone_ObeliaADArea_ca3ee282-4a4a-4861-9401-d6c69ca93781);
DB_LOW_IronThrone_HostagesInSubmersible((CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);

//Spokesperson is dead
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, (CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158, 0)
THEN
DB_LOW_IronThrone_SpokespersonDead(1);

QRY
QRY_SelectCustomDialog(_Hostage, _Player)
AND
DB_IRN_PrisonerGroup(_GroupId, (CHARACTER)_Hostage)
AND
_GroupId <= 8
AND
DB_LOW_IronThrone_SpokespersonDead(1)
AND
QRY_OnlyOnce("LOW_IronThrone_AlternativeDialogStarted")
THEN
DB_SelectedDialog((DIALOGRESOURCE)IRN_IronThrone_ReturnHostagesAlt_1a432fee-b7e4-64ee-8b83-b5a658672196, _Hostage, _Player);

//Teleport surviving Gondian prisoners to their positions in the Dock Warehouse
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
DB_LOW_IronThrone_PrisonerReturnPositions(_Prisoner, _Trigger, _)
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, _Prisoner, 1)
AND
DB_LOW_IronThrone_HostageReturnDialogs(_Prisoner, _Dialog)
THEN
TeleportTo(_Prisoner, _Trigger, "LOW_IronThrone_PrisonerReturnedToSubmersible", 0, 1, 1, 0, 1);
PROC_SetOnStage(_Prisoner, 1);
RemoveHarmfulStatuses((CHARACTER)_Prisoner);
RemoveStatus(_Prisoner, "HASTE_LETHARGY", NULL_00000000-0000-0000-0000-000000000000);
DB_Dialogs(_Prisoner, _Dialog);
DB_LOW_IronThrone_HostagesInSubmersible(_Prisoner);

IF
EntityEvent(_Prisoner, "LOW_IronThrone_PrisonerReturnedToSubmersible")
AND
DB_LOW_IronThrone_PrisonerReturnPositions((CHARACTER)_Prisoner, _, _Seat)
THEN
Use(_Prisoner, _Seat, 1, 1, "");

PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
DB_Players(_Player)
AND
NOT DB_Defeated(_Player)
THEN
RemoveHarmfulStatuses((CHARACTER)_Player);
RemoveStatus(_Player, "HASTE_LETHARGY", NULL_00000000-0000-0000-0000-000000000000);

//Start Return dialog - Wyll OM present
//Base Version - Without Ravengard
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
DB_Players(_Player) //TODO: Explore best way to prioritize avatars/companions as host speaker
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Player)
AND
NOT DB_OnlyOnce("IRN_ReturnFromIronThrone")
AND
QRY_StartDialog((DIALOGRESOURCE)IRN_IronThrone_Return_09c71cbf-c72c-d810-3bba-c1b9fc81770e, NULL_00000000-0000-0000-0000-000000000000,_Player)
THEN
DB_OnlyOnce("IRN_ReturnFromIronThrone");

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)IRN_IronThrone_Return_09c71cbf-c72c-d810-3bba-c1b9fc81770e, _Id)
AND
DB_Players(_Player)
AND
NOT DB_Defeated(_Player)
THEN
PROC_DialogAddListeningActor(_Id, _Player);

//Base Version - With Ravengard
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
DB_Players(_Player) //TODO: Explore best way to prioritize avatars/companions as host speaker
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Player)
AND
NOT DB_OnlyOnce("IRN_ReturnFromIronThrone")
AND
QRY_StartDialog((DIALOGRESOURCE)IRN_IronThrone_Return_09c71cbf-c72c-d810-3bba-c1b9fc81770e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03,_Player)
THEN
DB_OnlyOnce("IRN_ReturnFromIronThrone");

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)IRN_IronThrone_Return_09c71cbf-c72c-d810-3bba-c1b9fc81770e, (INTEGER)_DialogInstanceID)
THEN
SetLevelStartingDialog(_DialogInstanceID, 1);

IF
DialogEnded(_Dialog, _)
AND
DB_LOW_IronThrone_ReturnDialogs(_Dialog)
AND
DB_IRN_PrisonerGroup(_GroupId, _Prisoner)
AND
_GroupId <= 8
AND
NOT DB_OnlyOnce("LOW_IronThrone_HostagesCheerADCalled")
AND
QRY_StartDialog((DIALOGRESOURCE)IRN_IronThrone_AD_HostageCheerAfterIronThrone_10e29849-2f08-f137-d387-33e57ee3f772, _Prisoner)
THEN
DB_OnlyOnce("LOW_IronThrone_HostagesCheerADCalled");

IF
DialogEnded(_Dialog, _)
AND
DB_LOW_IronThrone_ReturnDialogs(_Dialog)
THEN
TimerLaunch("IRN_IronThrone_ReturnFromIronThrone_LowerLadderDelay", 3000);

PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackAtDocks")
AND
QRY_OnlyOnce("IRN_ReturnFromIronThrone")
THEN
TimerLaunch("IRN_IronThrone_ReturnFromIronThrone_LowerLadderDelay", 3000);

IF
TimerFinished("IRN_IronThrone_ReturnFromIronThrone_LowerLadderDelay")
THEN
PROC_LOW_IronThrone_LadderLowered();
AutoSave();

PROC
PROC_LOW_IronThrone_LadderLowered()
THEN
ItemMoveTo(S_LOW_SubmersibleInteriorLadder_8b3d25e5-4fb6-4207-8f67-82b7f6de1db9, (TRIGGER)S_LOW_SubmersibleLadderLowerPos_551435e8-2760-47fb-b2d4-9c0845ff73de, 1.0, 0.0, 0, "LOW_IronThrone_SubmersibleLadderLowered", 0);
PROC_TryStartAD((DIALOGRESOURCE)LOW_BellyOfTheBeast_AD_BeastmasterExitsSubmersible_211e1bd1-b89e-72f7-007a-af6472d9c4a6, S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1);

IF
EntityEvent(_Ladder, "LOW_IronThrone_SubmersibleLadderLowered")
THEN
SetCanInteract((ITEM)_Ladder, 1);

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_BellyOfTheBeast_AD_BeastmasterExitsSubmersible_211e1bd1-b89e-72f7-007a-af6472d9c4a6, _)
THEN
SetHasDialog(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, 1);
DB_Dialogs((CHARACTER)S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, (DIALOGRESOURCE)LOW_BellyOfTheBeast_BeastmasterAfterIronThrone_ec46a7ed-f330-9695-cdf8-b392bfec62f3);
PROC_CharacterMoveTo((CHARACTER)S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, (TRIGGER)S_LOW_SubmersibleLadderPos_4c27ebd9-5a52-4bb6-8edd-8f2bf4c38bc7, "Walk", "LOW_IronThrone_BeastmasterLeftSubmersible");

IF
EntityEvent(_Beastmaster, "LOW_IronThrone_BeastmasterLeftSubmersible")
THEN
TeleportTo(_Beastmaster, (TRIGGER)S_LOW_WarehouseBasementBeastmasterNearSubPos_4d077950-4e58-47d8-9eff-e6df2d978bd8, "", 0, 0, 0, 0, 1);
SetFlag((FLAG)LOW_BellyOfTheBeast_Event_BeastmasterExitedSubmersible_ce7ebb28-57cf-42d2-a4ed-bf0138b29c15);
DB_LOW_BellyOfTheBeast_BeastmasterReturnedToBasement(1);

QRY
QRY_LOW_IronThrone_AnyPlayerSpokenToObelia()
AND
DB_Players(_Player)
AND
GetFlag(IRN_IronThrone_HasMet_ReturnHostages_080ad093-86bf-47be-8c72-efdc4de711df, _Player, 1)
THEN
DB_NOOP(1);

IF
DB_InRegion(_Player, (TRIGGER)S_IRN_IronThrone_ObeliaADArea_ca3ee282-4a4a-4861-9401-d6c69ca93781)
AND
DB_Players(_Player)
AND
NOT QRY_LOW_IronThrone_AnyPlayerSpokenToObelia()
AND
QRY_OnlyOnce("IRN_IronThrone_ObeliaAD_Played")
THEN
PROC_TryStartAD((DIALOGRESOURCE)IRN_IronThrone_AD_EscapingHostageAtDockBasement_f4151404-7492-6396-70a6-5ae80782e110, (CHARACTER)S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);

IF
UseStarted(_Player, (ITEM)S_LOW_SubmersibleInteriorLadder_8b3d25e5-4fb6-4207-8f67-82b7f6de1db9)
AND
DB_Players(_Player)
THEN
TeleportTo(_Player, S_LOW_DockWarehouse_ReturnFromIronThronePos_d1a59a82-8b4b-4f0a-a382-14a997888333, "LOW_IronTrone_ReturnedToBasement", 1, 1, 1, 0, 1);

IF
EntityEvent(_, "LOW_IronTrone_ReturnedToBasement")
AND
NOT DB_LOW_BellyOfTheBeast_BeastmasterReturnedToBasement(1)
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_State_PlayersWentToIronThroneWithBeastmaster_61dd108a-9a51-4edc-b070-3da42574d0d9)
AND
NOT DB_PermaDefeated(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1)
THEN
DB_LOW_BellyOfTheBeast_BeastmasterReturnedToBasement(1);
TeleportTo((CHARACTER)S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, (TRIGGER)S_LOW_WarehouseBasementBeastmasterNearSubPos_4d077950-4e58-47d8-9eff-e6df2d978bd8, "", 0, 0, 0, 0, 1);

IF
DB_InRegion(_Player, (TRIGGER)S_LOW_WarehouseBasementArea_cc61966e-79f4-411b-a6cc-da6b153bb84f)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
QRY_LOW_BellyOfTheBeast_ShouldWaveservantsAmbush()
AND
QRY_OnlyOnce("LOW_BellyOfTheBeast_PlayerInRegion")
THEN
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "WaveservantsAttack"); //State change is tracked in Act3b_LOW_BellyOfTheBeast goal

IF
DB_InRegion(_Player, (TRIGGER)S_LOW_WarehouseBasementArea_cc61966e-79f4-411b-a6cc-da6b153bb84f)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
NOT QRY_LOW_BellyOfTheBeast_ShouldWaveservantsAmbush()
AND
QRY_OnlyOnce("LOW_BellyOfTheBeast_PlayerInRegion")
THEN
PROC_State_Progress((ITEM)S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "BackInBasement");

QRY
QRY_LOW_BellyOfTheBeast_ShouldWaveservantsAmbush()
AND
NOT DB_GlobalFlag((FLAG)LOW_BellyOfTheBest_State_ReportedBeastmasterDead_43dd5530-e74f-48fa-aeb1-43cbb8bbb7d6)
AND
DB_GlobalFlag((FLAG)LOW_Allandra_State_EulogyFinished_e05a20ae-7793-5919-e119-e9e29cddce64)
AND
NOT DB_Defeated(S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8)
THEN
DB_NOOP(1);

//END_REGION State end: BackAtDocks

//REGION State start: BackInBasement
//Hostages appear one by one
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackInBasement")
THEN
PROC_LOW_IronThrone_HostagesLeave();
NOT DB_BlockedWaypointZone(S_LOW_SubmersibleInteriorArea_79fedabd-52a5-4d81-9169-ec7d5d43e8c4);

//If no hostages, Ravengard and Omeluum exit directly
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackInBasement")
AND
NOT DB_LOW_IronThrone_HostagesInSubmersible(_)
THEN
PROC_LOW_IronThrone_AllHostagesLeftSubmersible();

PROC
PROC_LOW_IronThrone_HostagesLeave()
AND
Random(1000, _Time)
AND
IntegerSum(1500, _Time, _RandomLeaveTime)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_IronThrone_HostagesStartToDisembark")
THEN
ObjectTimerLaunch(_Player, "LOW_IronThrone_HostageStartsLeave", _RandomLeaveTime, 1);

IF
ObjectTimerFinished(_Player, "LOW_IronThrone_HostageStartsLeave")
AND
QRY_OnlyOnce_Reset("LOW_IronThrone_HostageLeftSubmersible")
AND
DB_LOW_IronThrone_PrisonerLeaveOrder(_Prisoner)
AND
NOT DB_Defeated(_Prisoner)
AND
DB_LOW_IronThrone_HostagesInSubmersible(_Prisoner)
AND
QRY_OnlyOnce("LOW_IronThrone_HostageLeftSubmersible")
AND
Random(1000, _Time)
AND
IntegerSum(1500, _Time, _RandomLeaveTime)
THEN
NOT DB_LOW_IronThrone_PrisonerLeaveOrder(_Prisoner);
PROC_LOW_IronThrone_HostageStartsLeave((CHARACTER)_Prisoner);
ObjectTimerLaunch(_Player, "LOW_IronThrone_HostageStartsLeave", _RandomLeaveTime, 1);

PROC
PROC_LOW_IronThrone_HostageStartsLeave((CHARACTER)_Prisoner)
THEN
PROC_CharacterMoveTo(_Prisoner, (TRIGGER)S_LOW_SubmersibleLadderPos_4c27ebd9-5a52-4bb6-8edd-8f2bf4c38bc7, "Walk", "LOW_IronThrone_HostageReachedSubmersibleExitPos");

IF
EntityEvent(_Prisoner, "LOW_IronThrone_HostageReachedSubmersibleExitPos")
THEN
NOT DB_LOW_IronThrone_HostagesInSubmersible((CHARACTER)_Prisoner);
PROC_LOW_IronThrone_CheckRemainingHostages();
TeleportTo(_Prisoner, S_LOW_DockWarehouse_ReturnFromIronThronePos_d1a59a82-8b4b-4f0a-a382-14a997888333, "LOW_IronThrone_HostageBackInBasement_Teleported", 0, 0, 0, 0, 1);

IF
EntityEvent(_Prisoner, "LOW_IronThrone_HostageBackInBasement_Teleported")
THEN
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerReachedBasement_7afcb442-1ae5-440c-89fe-7205c27f18c6, _Prisoner);

IF
EntityEvent(S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158, "LOW_IronThrone_HostageBackInBasement_Teleported")
AND
DB_LOW_IronThrone_HostagesInSubmersible(_)
AND
QRY_OnlyOnce("LOW_IronThrone_ObeliaCallsOthersOut")
THEN
PROC_TryStartAD((DIALOGRESOURCE)IRN_IronThrone_AD_EscapingHostageCallsOthersOut_c70d9442-e7d1-05a2-3657-c59eb403aa3b, S_GLO_IronThrone_EscapingHostage_614ceeec-24a5-4491-98b3-a83ab235f158);

//After the level transition has happened, clean up tags that should no longer cause issues
PROC
PROC_State_Changed(_, "IRN_IronThrone", "BackInBasement")
THEN
PROC_LOW_IronThrone_CleanUpAfterIRN();

PROC
PROC_LOW_IronThrone_CleanUpAfterIRN()
AND
DB_IRN_PrisonerGroup(_, _Prisoner)
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, _Prisoner, 1)
THEN
ClearTag(_Prisoner, (TAG)IGNORE_COMBAT_LATE_JOIN_PENALTY_6d60bed7-10cc-4b52-8fb7-baa75181cd49);
ClearTag(_Prisoner, (TAG)NO_LEVELTEMPLATE_TRANSFER_577229d7-a806-40c9-81fc-3e843d1955c0); 
PROC_SelfHealing_Enable(_Prisoner);

PROC
PROC_LOW_IronThrone_CleanUpAfterIRN()
AND
QRY_IRN_MizoraShouldAppear()
THEN
ClearTag(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, (TAG)NO_LEVELTEMPLATE_TRANSFER_577229d7-a806-40c9-81fc-3e843d1955c0); 

PROC
PROC_LOW_IronThrone_CleanUpAfterIRN()
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_State_PlayersWentToIronThroneWithBeastmaster_61dd108a-9a51-4edc-b070-3da42574d0d9)
THEN
ClearTag(S_GLO_Beastmaster_d999308c-8a20-4c31-b9e2-f89ff3ee1cd1, (TAG)NO_LEVELTEMPLATE_TRANSFER_577229d7-a806-40c9-81fc-3e843d1955c0); 

//The first hostage that sees a defeated Waveservant in the basement will comment about it
IF
DB_Sees(_Prisoner, _Waveservant)
AND
DB_IRN_PrisonerGroup(_GroupId, _Prisoner)
AND
_GroupId <= 8 //Only hostages, not Omeluum or Ravengard or Obelia
AND
DB_LOW_BellyOfTheBeast_WaveservantAttackers(_Waveservant, _)
AND
DB_Defeated(_Waveservant)
AND
QRY_OnlyOnce("LOW_IronThrone_PrisonerCommentOnDeadWaveservant")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_BellyOfTheBeast_AD_HostageReactsToWaveservantsBattle_028e9511-22d1-20d4-0c2b-800cb0cd0a82, _Prisoner);

PROC
PROC_LOW_IronThrone_CheckRemainingHostages()
AND
NOT DB_LOW_IronThrone_HostagesInSubmersible(_)
THEN
PROC_LOW_IronThrone_AllHostagesLeftSubmersible();

//END_REGION State end: BackInBasement

//REGION State start: Finshed
IF
EntityEvent(_, "LOW_IronThrone_AllPlayersLeftBasement")
AND
QRY_OnlyOnce("LOW_IronThrone_HostagesRescued")
THEN
SetFlag(IRN_IronThrone_State_BasementFinished_febdf850-3d7a-45f7-b822-d713232d166d);
PROC_State_Progress(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "Finished");

PROC
PROC_State_Changed(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "Finished")
AND
DB_IRN_PrisonerGroup(_GroupId, _Prisoner)
AND
_GroupId < 9 //Only for Obelia and the gondians
AND
NOT DB_Defeated(_Prisoner)
THEN
PROC_SetOnStage(_Prisoner, 0);
SetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerLeftBasement_32a71388-a09f-4624-9764-7cb05a8cf96a, _Prisoner);
//END_REGION State end: Finished

//REGION Ravengard
PROC
PROC_LOW_IronThrone_AllHostagesLeftSubmersible()
AND
GetHostCharacter(_Player)
THEN
ObjectTimerLaunch(_Player, "LOW_IronThrone_SpecialHostageLeave", 2000, 1);

//If present, Ravengard leaves after all the hostages have exited
IF
ObjectTimerFinished(_Player, "LOW_IronThrone_SpecialHostageLeave")
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
AND
NOT DB_Defeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
THEN
TeleportTo(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, S_LOW_DockWarehouse_ReturnFromIronThronePos_d1a59a82-8b4b-4f0a-a382-14a997888333, "", 0, 0, 0, 0, 1);
PROC_CharacterMoveTo((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, TeleportTrigger_ToWarehouse_001_785189c1-e595-402c-aac7-22a07ed157f4, "Walk", "IRN_RavengardLeft");

IF
EntityEvent(_Ravengard, "IRN_RavengardLeft")
THEN
RemoveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_PRISONER_RAVENGARD", NULL_00000000-0000-0000-0000-000000000000);
PROC_CAMP_Ravengard_RestoreEquipmentAfterIRN();
PROC_LOW_IronThrone_MoveRavengardToCamp();

PROC
PROC_State_Changed(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "Finished")
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
AND
NOT DB_PermaDefeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
THEN
RemoveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_PRISONER_RAVENGARD", NULL_00000000-0000-0000-0000-000000000000);
PROC_CAMP_Ravengard_RestoreEquipmentAfterIRN();
PROC_LOW_IronThrone_MoveRavengardToCamp();

PROC
PROC_CAMP_Ravengard_RestoreEquipmentAfterIRN()
AND
QRY_OnlyOnce("CAMP_Ravengard_RestoreEquipmentAfterIRN")
THEN
CharacterGiveEquipmentSet((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "EQP_GLO_Longsword_Shield_Plate_Ravengard");
//END_REGION

//REGION Omeluum leaving submersible when players leave for the basement
IF
FlagSet((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e,S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53,_)
THEN
QuestUpdate("LOW_SaveOmeluum","OmeluumEscapedIRN");

IF
DialogEnded((DIALOGRESOURCE)IRN_IronThrone_Omeluum_26f2208c-177d-b640-fb5a-0594b84f305a, _)
AND
QRY_OnlyOnce("IRN_IronThrone_OmeluumLeftForLodge")
THEN
UseSpell(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, "Shout_UND_SocietyOfBrilliance_Teleportation", S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);

IF
EntityEvent(_, "LOW_IronTrone_ReturnedToBasement")
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, 1)
AND
NOT DB_Defeated(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53)
AND
QRY_OnlyOnce("IRN_IronThrone_OmeluumLeftForLodge")
THEN
UseSpell(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53, "Shout_UND_SocietyOfBrilliance_Teleportation", S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53);

IF
CastedSpell(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53,"Shout_UND_SocietyOfBrilliance_Teleportation",_,_,_)
AND
DB_GlobalFlag((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9)
AND
NOT DB_GlobalFlag((FLAG)LOW_TheLodge_State_OmeluumLeftForLodge_edd32708-619c-4528-9a3a-e695f67f6186)
THEN
DB_LOW_OmeluumIsTeleportingAwayFromSubmarine(1);

IF
CastedSpell(_Member,"Shout_UND_SocietyOfBrilliance_Teleportation",_,_,_)
AND
DB_GlobalFlag((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9)
AND
NOT DB_LOW_OmeluumIsTeleportingAwayFromSubmarine(1)
AND
DB_LOW_Act1_SocietyMembers(_Member)
THEN
SetFlag((FLAG)LOW_TheLodge_State_BlurgOrOmeluumTeleportedAway_77f1763f-2aa5-44be-a108-f2ad59a12873);

IF
WentOnStage(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53,0)
AND
DB_LOW_OmeluumIsTeleportingAwayFromSubmarine(1)
THEN
NOT DB_LOW_OmeluumIsTeleportingAwayFromSubmarine(1);
SetFlag((FLAG)LOW_TheLodge_State_OmeluumLeftForLodge_edd32708-619c-4528-9a3a-e695f67f6186);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
