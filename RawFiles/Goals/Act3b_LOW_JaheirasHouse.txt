Version 1
SubGoalCombiner SGC_AND
INITSECTION
//Dialogs for all necessary characters
DB_Dialogs(S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, LOW_JaheirasHouse_EldestDaughter_090eb987-e31a-8163-d340-36267a7d787e);
DB_Dialogs(S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, LOW_JaheirasHouse_EldestSon_8334ac7a-2337-b425-7c1a-850bc8a33b4e);
DB_Dialogs(S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56);
DB_Dialogs(S_LOW_JaheirasHouse_JaheiraMiddleDaughter_3c83f569-7b33-43aa-bdb0-4dd9dfb5709b, LOW_JaheirasHouse_MiddleDaughter_36a5a0e6-6933-a076-23a3-a0932b5af50e);
DB_Dialogs(S_LOW_JaheirasHouse_JaheiraYoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c, LOW_JaheirasHouse_YoungestSon_202ddf3d-87d7-1337-40b6-31eacad44879);
DB_Dialogs(S_LOW_JaheirasHouse_PostmasterBadger_4655b52d-4a43-4ddb-bb9b-7e18e47cb5d9, LOW_JaheirasHouse_PostmasterBadger_daaf32b8-98e4-04df-95a4-b1cec7a9d789);
DB_Dialogs(S_LOW_JaheirasHouse_Rat001_ee87e59a-1901-425b-b316-94d58ca62755, LOW_JaheirasHouse_MessengerRat001_63b3b3b3-7519-fc56-93c6-cda046fa0f60);
DB_Dialogs(S_LOW_JaheirasHouse_Rat002_3ba2cc06-60c1-4db0-b9c8-d1af77298e68, LOW_JaheirasHouse_MessengerRat002_66270a48-58f5-91fa-56e1-d3be45804e54);
DB_Dialogs(S_LOW_JaheirasHouse_Rat003_486228f2-74ad-45aa-b64f-8ab41866124a, LOW_JaheirasHouse_MessengerRat003_f7e639dc-8313-f253-4a74-b9326a46b593);
DB_Dialogs(S_LOW_JaheirasHouse_Rat004_c9e8fe58-0c94-4c86-9854-23c90f56b92d, LOW_JaheirasHouse_MessengerRat004_62529fa9-4aaa-e0f9-07c7-d2c42b024607);

//Jaheira family origin moments
PROC_DefineSingleOriginMoment((DIALOGRESOURCE) LOW_JaheirasHouse_EldestDaughter_090eb987-e31a-8163-d340-36267a7d787e, (TAG)REALLY_JAHEIRA_8457eb5f-036c-4143-b6cf-447a9f555c7a, (DIALOGRESOURCE) LOW_JaheiraAndFamily_OM_Jaheira_OOM_41c550bb-9ed0-99e4-9e04-345f155fc91b, (DIALOGRESOURCE)LOW_JaheiraAndFamily_OM_Jaheira_COM_e994dbe5-5db8-4c05-eb2e-2690ca2d134e, (DIALOGRESOURCE) LOW_JaheiraAndFamily_OM_Jaheira_OOM_41c550bb-9ed0-99e4-9e04-345f155fc91b);
PROC_DefineSingleOriginMoment((DIALOGRESOURCE) LOW_JaheirasHouse_EldestSon_8334ac7a-2337-b425-7c1a-850bc8a33b4e, (TAG)REALLY_JAHEIRA_8457eb5f-036c-4143-b6cf-447a9f555c7a, (DIALOGRESOURCE) LOW_JaheiraAndSon01_OM_Jaheira_OOM_c081f33f-ef09-fb55-93db-9d757942fef6, (DIALOGRESOURCE) LOW_JaheiraAndSon01_OM_Jaheira_COM_c887de15-c086-84d8-c25d-7229b29ec809, (DIALOGRESOURCE) LOW_JaheiraAndSon01_OM_Jaheira_OOM_c081f33f-ef09-fb55-93db-9d757942fef6);
PROC_DefineSingleOriginMoment((DIALOGRESOURCE) LOW_JaheirasHouse_MiddleDaughter_36a5a0e6-6933-a076-23a3-a0932b5af50e, (TAG)REALLY_JAHEIRA_8457eb5f-036c-4143-b6cf-447a9f555c7a, (DIALOGRESOURCE) LOW_JaheiraAndDaughter02_OM_Jaheira_OOM_c65c0eae-3ee3-e41b-7ac1-3ad5310fe517, (DIALOGRESOURCE) LOW_JaheiraAndDaughter02_OM_Jaheira_COM_1efb9f66-d39b-ea37-b41b-fa71c386398c,  (DIALOGRESOURCE) LOW_JaheiraAndDaughter02_OM_Jaheira_OOM_c65c0eae-3ee3-e41b-7ac1-3ad5310fe517);
PROC_DefineSingleOriginMoment((DIALOGRESOURCE) LOW_JaheirasHouse_YoungestSon_202ddf3d-87d7-1337-40b6-31eacad44879, (TAG)REALLY_JAHEIRA_8457eb5f-036c-4143-b6cf-447a9f555c7a, (DIALOGRESOURCE) LOW_JaheiraAndSon02_OM_Jaheira_OOM_fa080372-ae4e-ebcc-2d85-db65ea3608b5, (DIALOGRESOURCE) LOW_JaheiraAndSon02_OM_Jaheira_COM_36ad2b44-8361-fa5a-28e6-95a1eae44417, (DIALOGRESOURCE) LOW_JaheiraAndSon02_OM_Jaheira_OOM_fa080372-ae4e-ebcc-2d85-db65ea3608b5);

//Set up Fig's spotting (Jaheira)
DB_SpotPlayers_HasTag(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForJaheira", (TAG)JAHEIRA_2c948b46-0d8a-426b-ad8b-5f41233df4c1, 1);
DB_SpotPlayers_SpotTrigger(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForJaheira", S_LOW_JaheirasHouse_FigTrigger_c24252d6-d7fc-4411-8715-325482d928b3);
DB_SpotPlayers(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForJaheira", NULL_00000000-0000-0000-0000-000000000000, LOW_JaheirasHouse_State_FigSpottingJaheiraStop_172957ab-963f-40cc-acda-097ba4c22f34);

//Set up Fig's spotting (Non-Jaheira)
DB_SpotPlayers_SpotTrigger(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForSomeone", S_LOW_JaheirasHouse_FigTrigger_c24252d6-d7fc-4411-8715-325482d928b3);
DB_SpotPlayers(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForSomeone", NULL_00000000-0000-0000-0000-000000000000, LOW_JaheirasHouse_State_FigSpottingAnyoneStop_61528adc-ea0b-4840-b34f-6773dec6699c);
DB_SpotPlayers_Continuous(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForSomeone");

DB_State_Current(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_Start");

//State to set Jaheira's AD's - Setup for Jaheira's AD pass - to come if we're happy with the whitebox as it stands
DB_State_Priority(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_Start", 0);
DB_State_Priority(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_FoundStudy", 50);
DB_State_Priority(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_FoundSecretBasement", 100);
DB_State_Priority(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_EnteredSecretBasement", 150);
DB_State_Priority(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_SpottedGrove", 200);
DB_State_Priority(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_FoundKhalidsGift", 250);

DB_State_Flags(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_FoundStudy", (FLAG)LOW_JaheirasHouse_State_SawStudy_deeaf401-6a5f-4c3d-8541-d07251b476e4);
DB_State_Flags(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_FoundSecretBasement", (FLAG)LOW_JaheirasHouse_State_FoundBasement_9088478d-690a-4ccc-b9d5-3b157f9770c9);
DB_State_Flags(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_EnteredSecretBasement", (FLAG)LOW_JaheirasHouse_State_SawBasement_b925fec0-8400-444f-804b-fd4e2fccbbec);
DB_State_Flags(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_SpottedGrove", (FLAG)LOW_JaheirasHouse_Event_SawGrove_bbacdd66-8d74-4b92-a468-ee100616eef0);
DB_State_Flags(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraADs_FoundKhalidsGift", (FLAG)LOW_JaheirasHouse_State_KhalidGiftComment_e1d1a3f9-e696-453e-a2c5-b37f1995b05a);

//Items being accessible for dialogs
DB_HasItemEvent(S_LOW_JaheiraSecretScroll_94609102-443a-4a11-a6e4-e6feffa02b53, (FLAG) LOW_JaheirasHouse_State_HasJaheiraScroll_bf14af6d-1735-4260-9f43-2c7d52f62104);

DB_JaheirasHouse_MovePuzzleItem(1, 0, S_LOW_JaheirasHouse_CentralDesk_e63f517c-3705-42d6-a69e-0be1c34fa35b, "LOW_JaheirasHouse_CombinedItem");
DB_JaheirasHouse_MovePuzzleItem(0, 1, S_LOW_JaheirasHouse_CentralDesk_e63f517c-3705-42d6-a69e-0be1c34fa35b, "LOW_JaheirasHouse_CombinedItem");
DB_JaheirasHouse_MovePuzzleItem(1, 0, S_LOW_JaheirasHouse_CentralDesk_e63f517c-3705-42d6-a69e-0be1c34fa35b, "LOW_JaheirasHouse_JaheiraBasementExit");

DB_JaheirasHouse_CombinedItemEntityEvent((ITEM)S_LOW_JaheirasHouse_HarperPinSlot_d96fa8b4-3bf3-44c4-8ad7-79adb43fe9d5, "LOW_JaheirasHouse_CombinedItem");

DB_JaheirasHouse_JaheiraFamilyLeaves((CHARACTER)S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115);
DB_JaheirasHouse_JaheiraFamilyLeaves((CHARACTER)S_LOW_JaheirasHouse_MiddleDaughter_3c83f569-7b33-43aa-bdb0-4dd9dfb5709b);
DB_JaheirasHouse_JaheiraFamilyLeaves((CHARACTER)S_LOW_JaheirasHouse_YoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c);
DB_JaheirasHouse_JaheiraFamilyLeaves((CHARACTER)S_LOW_JaheirasHouse_PostmasterBadger_4655b52d-4a43-4ddb-bb9b-7e18e47cb5d9);
DB_JaheirasHouse_JaheiraFamilyLeaves((CHARACTER)S_LOW_JaheirasHouse_Rat001_ee87e59a-1901-425b-b316-94d58ca62755);
DB_JaheirasHouse_JaheiraFamilyLeaves((CHARACTER)S_LOW_JaheirasHouse_Rat002_3ba2cc06-60c1-4db0-b9c8-d1af77298e68);
DB_JaheirasHouse_JaheiraFamilyLeaves((CHARACTER)S_LOW_JaheirasHouse_Rat003_486228f2-74ad-45aa-b64f-8ab41866124a);
DB_JaheirasHouse_JaheiraFamilyLeaves((CHARACTER)S_LOW_JaheirasHouse_Rat004_c9e8fe58-0c94-4c86-9854-23c90f56b92d);
DB_JaheirasHouse_JaheiraFamilyFighters((CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c);
DB_JaheirasHouse_JaheiraFamilyFighters((CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f);

DB_JaheirasHouse_FamilyDisperse((CHARACTER)S_LOW_JaheirasHouse_JaheirasDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, (TRIGGER) S_LOW_JaheiraEldestDaughterDisperseTrigger_e7f012be-87f6-465e-bb1c-77af312d8212);
DB_JaheirasHouse_FamilyDisperse((CHARACTER)S_LOW_JaheirasHouse_JaheirasSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, (TRIGGER) S_LOW_JaheiraEldestSonDisperseTrigger_3b6dff28-e081-4447-9ea9-3e874af50afa);
DB_JaheirasHouse_FamilyDisperse((CHARACTER)S_LOW_JaheirasHouse_MiddleDaughter_3c83f569-7b33-43aa-bdb0-4dd9dfb5709b, (TRIGGER) S_LOW_JaheiraMiddleDaughterDisperseTrigger_87304e75-8462-47da-8341-1f6c0ef3ed08);
DB_JaheirasHouse_FamilyDisperse((CHARACTER)S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, (TRIGGER) S_LOW_JaheiraYoungestDisperseTrigger_1add9ee3-4ab2-4141-8cf8-70d8cf0e8efd);
DB_JaheirasHouse_FamilyDisperse((CHARACTER)S_LOW_JaheirasHouse_YoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c, (TRIGGER) S_LOW_JaheiraYoungestSonDisperseTrigger_77142563-520d-41ed-bfb1-b3dbf188e61f);

DB_JaheirasHouse_FamilyAdditionalSpeakers(S_LOW_JaheirasHouse_MiddleDaughter_3c83f569-7b33-43aa-bdb0-4dd9dfb5709b);
DB_JaheirasHouse_FamilyAdditionalSpeakers(S_LOW_JaheirasHouse_JaheirasSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f);
DB_JaheirasHouse_FamilyAdditionalSpeakers(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115);
DB_JaheirasHouse_FamilyAdditionalSpeakers(S_LOW_JaheirasHouse_YoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c);

//To stop/start interactions when you open and close the hidden walls

SetCanInteract((ITEM)S_LOW_JaheirasHouse_BasementTransition_793931e4-eb7b-4814-9884-543b73a26f39, 0);

//Make sure the kid can give you the Harper Pin

DB_HasItemEvent(S_LOW_JaheirasHouse_JaheiraHarperPin_0897e01c-6f5f-484e-b10b-9dd772f11d1a, (FLAG)LOW_JaheirasHouse_Event_HasHarperPin_e3e068b3-1afa-469e-831e-e07fea14a23d);
DB_GiveItemToEvent(S_LOW_JaheirasHouse_JaheiraHarperPin_0897e01c-6f5f-484e-b10b-9dd772f11d1a, (FLAG)LOW_JaheirasHouse_Event_GivenHarperPin_c20b7bb4-9e8b-4172-8625-3a806fc03216);

//Setup the Locket for being given mid dialog


// Elemental Pillars - (Item, DamageToUseOnIt, StatusItEndsUpWith, WhetherItHasTheStatus, PlatformTiedTo, PlatformHeightToEndAt)
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_FireOrb_6282c24b-f644-488a-90c4-83bf70d5c9cb, "Fire", "BURNING");
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, "Thunder", "SHOCKED");
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, "Lightning", "SHOCKED");
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_IceOrb_c5ce37ee-6539-4f64-9c12-d97cfdeb27f1, "Cold", "FROZEN");
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_PoisonOrb_10ba625b-7a15-453a-8aa9-4e30c6bae65d, "Poison", "POISONED");

DB_JaheirasHouse_ElementalPillarsShocked("Thunder");
DB_JaheirasHouse_ElementalPillarsShocked("Lightning");

DB_JaheirasHouse_ElementalPillarSpells(S_LOW_JaheirasHouse_FireOrb_6282c24b-f644-488a-90c4-83bf70d5c9cb, "Target_GlyphOfWarding_Fire");
DB_JaheirasHouse_ElementalPillarSpells(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, "Target_GlyphOfWarding_Lightning");
DB_JaheirasHouse_ElementalPillarSpells(S_LOW_JaheirasHouse_IceOrb_c5ce37ee-6539-4f64-9c12-d97cfdeb27f1, "Target_GlyphOfWarding_Cold");
DB_JaheirasHouse_ElementalPillarSpells(S_LOW_JaheirasHouse_PoisonOrb_10ba625b-7a15-453a-8aa9-4e30c6bae65d, "Target_GlyphOfWarding_Acid");


DB_JaheirasHouse_ElementalPillarHelpers(S_LOW_JaheirasHouse_FireOrb_6282c24b-f644-488a-90c4-83bf70d5c9cb, S_LOW_JaheirasHouse_HelperFireOrb_a4bb00fd-862e-4b72-ac4c-cfd623ed9cb0);
DB_JaheirasHouse_ElementalPillarHelpers(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, S_LOW_JaheirasHouse_HelperThunderOrb_ecd5b425-2d8b-4175-959e-5047a6b107d7);
DB_JaheirasHouse_ElementalPillarHelpers(S_LOW_JaheirasHouse_IceOrb_c5ce37ee-6539-4f64-9c12-d97cfdeb27f1, S_LOW_JaheirasHouse_HelperColdOrb_544d32a5-7b03-4265-bb8f-8f6c4fa2b618);
DB_JaheirasHouse_ElementalPillarHelpers(S_LOW_JaheirasHouse_PoisonOrb_10ba625b-7a15-453a-8aa9-4e30c6bae65d, S_LOW_JaheirasHouse_HelperAcidOrb_d9088fcf-5276-465c-a030-218ef418719a);

DB_JaheirasHouse_NeedsNewTrap(S_LOW_JaheirasHouse_FireOrb_6282c24b-f644-488a-90c4-83bf70d5c9cb, "Target_GlyphOfWarding_Fire");
DB_JaheirasHouse_NeedsNewTrap(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, "Target_GlyphOfWarding_Lightning");
DB_JaheirasHouse_NeedsNewTrap(S_LOW_JaheirasHouse_IceOrb_c5ce37ee-6539-4f64-9c12-d97cfdeb27f1, "Target_GlyphOfWarding_Cold");
DB_JaheirasHouse_NeedsNewTrap(S_LOW_JaheirasHouse_PoisonOrb_10ba625b-7a15-453a-8aa9-4e30c6bae65d, "Target_GlyphOfWarding_Acid");

DB_JaheirasHouse_AllowedNewTrap(S_LOW_JaheirasHouse_FireOrb_6282c24b-f644-488a-90c4-83bf70d5c9cb);
DB_JaheirasHouse_AllowedNewTrap(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1);
DB_JaheirasHouse_AllowedNewTrap(S_LOW_JaheirasHouse_IceOrb_c5ce37ee-6539-4f64-9c12-d97cfdeb27f1);
DB_JaheirasHouse_AllowedNewTrap(S_LOW_JaheirasHouse_PoisonOrb_10ba625b-7a15-453a-8aa9-4e30c6bae65d);

DB_SpotPlayers_HasTag(S_LOW_JaheirasHouse_JaheirasDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, "LOW_JaheirasHouse_FamilySpottedJaheira", (TAG)JAHEIRA_2c948b46-0d8a-426b-ad8b-5f41233df4c1, 1);
DB_SpotPlayers(S_LOW_JaheirasHouse_JaheirasDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, "LOW_JaheirasHouse_FamilySpottedJaheira", NULL_00000000-0000-0000-0000-000000000000, LOW_JaheirasHouse_State_RionSpottingStop_c1baf690-56c4-4997-84e9-02c24e5a15b0);

DB_Children(S_LOW_JaheirasHouse_MiddleDaughter_3c83f569-7b33-43aa-bdb0-4dd9dfb5709b);
DB_Children(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115);
DB_Children(S_LOW_JaheirasHouse_YoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c);

DB_JaheirasHouse_JaheiraAndMinsc((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_JaheirasHouse_JaheiraAndMinsc((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

DB_JaheirasHouse_DeadFamilyAD((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (DIALOGRESOURCE)LOW_JaheirasHouse_PAD_JaheiraGoesHostile_c5c7e01a-8c44-69bb-02e2-198708123b3b);
DB_JaheirasHouse_DeadFamilyAD((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)LOW_JaheirasHouse_PAD_MinscGoesHostile_306c1fe5-cd54-4414-d1e4-1bb575ebdeb5);

DB_JaheirasHouse_ExclusiveReacts("Murder");
DB_JaheirasHouse_ExclusiveReacts("Assault");

DB_JaheirasHouse_MinscOptionalDialogs(LOW_JaheirasHouse_JaheiraSawFamilyAttacked_d5f74a00-3bf7-c45e-421a-d30f2823bfc9);
DB_JaheirasHouse_MinscOptionalDialogs(LOW_JaheirasHouse_PAD_JaheiraAttackedFamily_8cf5f170-5686-a5aa-328e-0ae80066a87b);

DB_OriginLeavingDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(DIALOGRESOURCE)Jaheira_Leaving_9c96c524-5692-ee30-3ee8-9b1ad4262fb1);
DB_OriginLeavingDialog(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(DIALOGRESOURCE)Minsc_Leaving_17833995-3375-c8cd-621a-678af492c546);

DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndFamily_OM_Jaheira_OOM_41c550bb-9ed0-99e4-9e04-345f155fc91b, (CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c);
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndFamily_OM_Jaheira_COM_e994dbe5-5db8-4c05-eb2e-2690ca2d134e, (CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c); 
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndDaughter01_OM_Jaheira_OOM_c9211982-672e-02e6-2d40-eaad7818f442, (CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c);
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndDaughter01_OM_Jaheira_COM_185068a2-eee0-131a-ab45-e2f61c4a43cf, (CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c);
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndSon01_OM_Jaheira_OOM_c081f33f-ef09-fb55-93db-9d757942fef6, (CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f);
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndSon01_OM_Jaheira_COM_c887de15-c086-84d8-c25d-7229b29ec809, (CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f);
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndDaughter02_OM_Jaheira_OOM_c65c0eae-3ee3-e41b-7ac1-3ad5310fe517,  (CHARACTER)S_LOW_JaheirasHouse_JaheiraMiddleDaughter_3c83f569-7b33-43aa-bdb0-4dd9dfb5709b);
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndDaughter02_OM_Jaheira_COM_1efb9f66-d39b-ea37-b41b-fa71c386398c, (CHARACTER)S_LOW_JaheirasHouse_JaheiraMiddleDaughter_3c83f569-7b33-43aa-bdb0-4dd9dfb5709b);
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndSon02_OM_Jaheira_OOM_fa080372-ae4e-ebcc-2d85-db65ea3608b5, (CHARACTER)S_LOW_JaheirasHouse_JaheiraYoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c);
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndSon02_OM_Jaheira_COM_36ad2b44-8361-fa5a-28e6-95a1eae44417, (CHARACTER)S_LOW_JaheirasHouse_JaheiraYoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c);
 
DB_LOW_JaheirasHouse_ADList("LOW_JaheirasHouse_JaheiraDoneWithOM", "LOW_JaheirasHouse_JaheiraADs_FoundStudy");
DB_LOW_JaheirasHouse_ADList("LOW_JaheirasHouse_JaheiraMovedDesk", "LOW_JaheirasHouse_JaheiraADs_FoundSecretBasement");
DB_LOW_JaheirasHouse_ADList("LOW_JaheirasHouse_JaheiraInBasement", "LOW_JaheirasHouse_JaheiraADs_EnteredSecretBasement");
DB_LOW_JaheirasHouse_ADList("LOW_JaheirasHouse_JaheiraInGrove", "LOW_JaheirasHouse_JaheiraADs_SpottedGrove");
DB_LOW_JaheirasHouse_ADList("LOW_JaheirasHouse_FoundKhalidGift", "LOW_JaheirasHouse_JaheiraADs_FoundKhalidsGift");

TriggerRegisterForCharacter(S_LOW_JaheiraBasementADTrigger_88c262f3-feca-4121-8679-fecdd0cfbc68, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
TriggerRegisterForCharacter(S_LOW_JaheiraOrbTrigger_03b7e147-fc89-4289-aff8-b9b1f0e658a9, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
TriggerRegisterForCharacter(S_LOW_JaheiraGroveTrigger_5946cc1b-2c0d-449d-be95-54786d2786ad, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

DB_KnowledgeCheckItem_AD("LOW_JaheirasHouse_OrbArcanaCheck", (ITEM)S_LOW_JaheirasHouse_FireOrb_6282c24b-f644-488a-90c4-83bf70d5c9cb, "Arcana", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_ElementalOrbArcana_2b161b1b-aede-15a7-1e1c-e5c93c17bace, (FLAG)LOW_JaheirasHouse_State_DecipheredOrbs_b743bfdd-1e54-483a-99db-18c0dc4faf0e);
DB_KnowledgeCheckItem_AD("LOW_JaheirasHouse_OrbArcanaCheck", (ITEM)S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, "Arcana", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_ElementalOrbArcana_2b161b1b-aede-15a7-1e1c-e5c93c17bace, (FLAG)LOW_JaheirasHouse_State_DecipheredOrbs_b743bfdd-1e54-483a-99db-18c0dc4faf0e);
DB_KnowledgeCheckItem_AD("LOW_JaheirasHouse_OrbArcanaCheck", (ITEM)S_LOW_JaheirasHouse_IceOrb_c5ce37ee-6539-4f64-9c12-d97cfdeb27f1, "Arcana", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_ElementalOrbArcana_2b161b1b-aede-15a7-1e1c-e5c93c17bace, (FLAG)LOW_JaheirasHouse_State_DecipheredOrbs_b743bfdd-1e54-483a-99db-18c0dc4faf0e);
DB_KnowledgeCheckItem_AD("LOW_JaheirasHouse_OrbArcanaCheck", (ITEM)S_LOW_JaheirasHouse_PoisonOrb_10ba625b-7a15-453a-8aa9-4e30c6bae65d, "Arcana", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_ElementalOrbArcana_2b161b1b-aede-15a7-1e1c-e5c93c17bace, (FLAG)LOW_JaheirasHouse_State_DecipheredOrbs_b743bfdd-1e54-483a-99db-18c0dc4faf0e);

PROC_JaheirasHouse_CheckForJaheiraDeath();

DB_GlobalFlagReactionAfterDialog(LOW_JaheirasHouse_State_YoungestTriedToStopEntry_9556ac12-1bfd-4b4d-8008-cc89736c5f3f, LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56);

DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_FireOrb_6282c24b-f644-488a-90c4-83bf70d5c9cb, "Fire", "BURNING");
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, "Thunder", "SHOCKED");
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, "Lightning", "SHOCKED");
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_IceOrb_c5ce37ee-6539-4f64-9c12-d97cfdeb27f1, "Cold", "FROZEN");
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_PoisonOrb_10ba625b-7a15-453a-8aa9-4e30c6bae65d, "Poison", "POISONED");

DB_JaheirasHouse_JaheiraItemDialogs(S_LOW_JaheirasHouse_SecretRoomBookcase_dbb64952-49e7-4ab8-a4c6-d4d3489ff565, LOW_JaheiraSecretRoom_OM_Jaheira_COM_da0578d7-bc24-6132-865d-9719fafd3409, LOW_JaheirasHouse_State_StoppedPlayerAtBookcase_53ec576a-34fe-48ce-88c7-4ad95b754328, "VB");

DB_OriginMayLeaveDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(DIALOGRESOURCE)LOW_JaheirasHouse_JaheiraSawFamilyAttacked_d5f74a00-3bf7-c45e-421a-d30f2823bfc9);
DB_OriginMayLeaveDialog(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,(DIALOGRESOURCE)LOW_JaheirasHouse_MinscSawFamilyAttacked_5ef17559-f24a-7ca8-e8a0-17026a4280fb);

// Combat NPC Reactivity
DB_CombatReact_AD_OnNextTurn(S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_EldestSonCombatAD001_dc876492-db38-c737-f1cc-dac12c078a5c);
DB_CombatReact_AD_OnNextTurn(S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_EldestSonCombatAD002_c8cff00a-5728-c06a-45f0-d6857bd47b84);
DB_CombatReact_AD_OnNextTurn(S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_EldestSonCombatAD003_b4130e70-7bb8-f053-dbca-78578ff83be1);
DB_CombatReact_AD_OnNextTurn(S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_EldestDaughterCombatAD001_89e95a60-7339-2e37-1807-c570dca99831);
DB_CombatReact_AD_OnNextTurn(S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_EldestDaughterCombatAD002_6856d0f9-ae91-de0c-1c0d-ff7e0b88ba7f);
DB_CombatReact_AD_OnNextTurn(S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_EldestDaughterCombatAD003_e4ae311f-5bc6-9ede-41a0-96060ab3b7ab);

DB_OneShot_VoiceBarkTrigger(S_LOW_JaheiraGroveTrigger_5946cc1b-2c0d-449d-be95-54786d2786ad, LOW_JaheirasHouse_VB_JaheiraGrove_3761d103-01ea-dd27-7bcd-ffeb4210bb9c);

Equip(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, S_LOW_JaheirasHouse_FigsSword_a4bfb4e7-383c-4fcf-8644-a48fe3e07e63, 1, 0, 1);

DB_GlobalFlagReactionAfterDialog(LOW_JaheirasHouse_State_GranddaughterConfrontedJaheira_f2f6c8b6-b241-4f92-bc43-984cbeed7a68, LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56);
DB_FlagReactionAfterDialog(LOW_JaheirasHouse_State_GranddaughterSawJaheira_4041963d-4576-4041-96e0-26501bff40ba, LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56);

DB_DoNotFaceDialog(S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, LOW_JaheirasHouse_AD_JordAndRion_17c60a81-617b-e57e-f0a6-52f626a6e129);
KBSECTION
//REGION Trap Orbs

//Kill switch - a pressure plate that starts under a box

IF
DualEntityEvent(_ , S_LOW_JaheiraOrbPressurePlate_6b9084aa-8b00-4913-8f89-8799081c641c, "LOW_JaheirasHouse_PressurePlateOff")
THEN
PROC_JaheirasHouse_GlyphAndPillarDisable();

PROC
PROC_JaheirasHouse_GlyphAndPillarDisable()
THEN
DB_JaheirasHouse_PausePillars(1);

PROC
PROC_JaheirasHouse_GlyphAndPillarDisable()
AND
DB_JaheirasHouse_ElementalPillars(_Orb, _DamageType, _Status)
THEN
PROC_JaheirasHouse_RemoveGlyphs((GUIDSTRING)_Orb);

//If Jaheira is in the part at the start of Act 3, make sure we set the faction to friendly too

PROC
PROC_LevelLoadedOnce("CTY_Main_A")
AND
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_JaheirasHouse_JaheirasTraps_760e3624-f809-4e23-8509-866cbd0738c6, 100);

//Set the faction hostile/not hostile if Jaheira is with the player - This will make them immune to her basement traps
IF
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_JaheirasHouse_JaheirasTraps_760e3624-f809-4e23-8509-866cbd0738c6, 100);

IF
DB_PartOfTheTeam(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_JaheirasHouse_JaheirasTraps_760e3624-f809-4e23-8509-866cbd0738c6, 0);

PROC
PROC_Origins_CompanionLeavePermanently(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_JaheirasHouse_JaheirasTraps_760e3624-f809-4e23-8509-866cbd0738c6, 0);

IF
DualEntityEvent(_, S_LOW_JaheiraOrbPressurePlate_6b9084aa-8b00-4913-8f89-8799081c641c, "LOW_JaheirasHouse_PressurePlateOn")
THEN
NOT DB_JaheirasHouse_PausePillars(1);

IF
DB_JaheirasHouse_NeedsNewTrap(_Orb, _Spell)
AND
NOT DB_JaheirasHouse_ActiveGlyph(_Orb, _)
AND
DB_JaheirasHouse_ElementalPillarSpells(_Orb, _Spell)
AND
DB_JaheirasHouse_AllowedNewTrap(_Orb)
AND
NOT DB_JaheirasHouse_SettingUpTrap(_Orb)
AND
NOT DB_JaheirasHouse_PausePillars(1)
THEN
DB_JaheirasHouse_SettingUpTrap(_Orb);

IF
DB_JaheirasHouse_SettingUpTrap(_Orb)
AND
DB_JaheirasHouse_ElementalPillarSpells(_Orb, _Spell)
AND
DB_JaheirasHouse_ElementalPillarHelpers(_Orb, _Helper)
THEN
UseSpell(_Helper, _Spell, _Orb);

IF
StatusAttempt(_Glyph, "EXPLOSIVE_RUNES", _Helper, _)
AND
DB_JaheirasHouse_ElementalPillarHelpers(_Orb, _Helper)
AND
DB_JaheirasHouse_NeedsNewTrap(_Orb, _Spell)
THEN
DebugText(_Orb, "I'm Creating");
DB_JaheirasHouse_ActiveGlyph(_Orb, _Glyph);
NOT DB_JaheirasHouse_NeedsNewTrap(_Orb, _Spell);
NOT DB_JaheirasHouse_SettingUpTrap(_Orb);

//Set up new Glyph

IF
AttackedBy(_, _Helper, _Glyph, _, _, _, _)
AND 
DB_JaheirasHouse_ActiveGlyph(_Orb, (ITEM)_Glyph)
AND
DB_JaheirasHouse_ElementalPillarHelpers(_Orb, _Helper)
AND
DB_JaheirasHouse_ElementalPillarSpells(_Orb, _Spell)
THEN
NOT DB_JaheirasHouse_AllowedNewTrap(_Orb);
NOT DB_JaheirasHouse_ActiveGlyph(_Orb, _Glyph);
DB_JaheirasHouse_NeedsNewTrap(_Orb, _Spell);
ObjectTimerLaunch(_Orb, "LOW_JaheirasHouse_NewGlyphCooldown", 6000, 1);


IF
CastSpellFailed(_Helper, _Spell, _, _, _)
AND
DB_JaheirasHouse_ElementalPillarSpells(_Orb, _Spell)
AND
DB_JaheirasHouse_ElementalPillarHelpers(_Orb, _Helper)
THEN
NOT DB_JaheirasHouse_AllowedNewTrap(_Orb);
ObjectTimerLaunch(_Orb, "LOW_JaheirasHouse_NewGlyphCooldown", 6000, 1);


IF
ObjectTimerFinished(_Orb, "LOW_JaheirasHouse_NewGlyphCooldown")
AND
DB_JaheirasHouse_ElementalPillars(_Orb, _Element, _Status)
AND
DB_JaheirasHouse_ElementalPillarSpells(_Orb, _Spell)
THEN
DB_JaheirasHouse_AllowedNewTrap(_Orb);

// For when we remove Glyphs
PROC
PROC_JaheirasHouse_RemoveGlyphs((GUIDSTRING)_Orb)
AND
DB_JaheirasHouse_ActiveGlyph(_Orb, _Glyph)
AND
DB_JaheirasHouse_ElementalPillarSpells(_Orb, _Spell)
THEN
SetOnStage(_Glyph, 0);
NOT DB_JaheirasHouse_ActiveGlyph(_Orb, _Glyph);
DB_JaheirasHouse_NeedsNewTrap(_Orb, _Spell);
NOT DB_JaheirasHouse_AllowedNewTrap(_Orb);
ObjectTimerLaunch(_Orb, "LOW_JaheirasHouse_NewGlyphCooldown", 6000, 1);

//END_REGION
 

//REGION Crime controls - If the player (not Minsc or Jaheira) attacks her family

//OVERVIEW: 	Jaheira and Minsc can be in one of a billion places, but should always care when the player attacks Jaheira's family. The goal here is for them to immediately run 
//				offstage when attacked, and Minsc/Jaheira to call you out if they're nearby. If they aren't, then everything carries on as normal - until you get to camp, and they will
//				have found out about it, confront you, and leave. For now this is handled by the flag PlayerAttackedFamily being true and CompanionConfrontedParty (set to a character)
//				being false. CompanionAttackedFamily is, for now, used just for a variance in dialogue in both instances.

//If the player attacks any of the family and the players are in combat for some reason - then default to Jaheira/Minsc just being annoyed in camp. A bit straightforward and 
//catch all, but this should be supreme edge case/player is REALLY trying hard to mess things up territory - they'd have had to drag the combat over here and attack them 
//mid said combat


//If Jaheira is dead come the time of entry to BG - Make her family go away

PROC
PROC_JaheirasHouse_CheckForJaheiraDeath()
AND
DB_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_FamilyHasReasonToLeave_a60ebbac-f4a7-4ed8-a565-4a10dbb641e2);
PROC_LOW_JaheirasHouse_FamilyLeaves();
PROC_LOW_JaheirasHouse_FightersLeave();

PROC
PROC_CRIME_AttackedInCombat((CHARACTER)_FamilyMember,(CHARACTER)_Player,(GUIDSTRING)_CombatID,(INTEGER)_StoryActionID)
AND
DB_JaheirasHouse_FamilyDisperse(_FamilyMember, _)
AND
DB_Players(_Player)
AND
IsInCombat(_Player, 1)
THEN
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_PlayerAttackedFamily_f505ff06-486a-4d8d-9986-95f4f91f9094);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_FamilyHasReasonToLeave_a60ebbac-f4a7-4ed8-a565-4a10dbb641e2);
PROC_LOW_JaheirasHouse_FamilyLeaves();

//If the player attacks any of the family, but it wasn't Minsc or Jaheira and they're also not in range

QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_Player, (STRING)_Crime, _, (CHARACTER)_FamilyMember, _ID)
AND
DB_JaheirasHouse_ExclusiveReacts(_Crime)
AND
DB_JaheirasHouse_FamilyDisperse(_FamilyMember, _)
AND
DB_Players(_Player)
AND
NOT QRY_JaheirasHouse_JaheiraMinscInRange((CHARACTER)_Player)
THEN
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_PlayerAttackedFamily_f505ff06-486a-4d8d-9986-95f4f91f9094);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_FamilyHasReasonToLeave_a60ebbac-f4a7-4ed8-a565-4a10dbb641e2);
PROC_LOW_JaheirasHouse_FamilyLeaves();
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_JaheirasHouse_JaheirasFamily_2a1a2442-56e9-48a9-9b33-94f5857f7b09, 0);


QRY
QRY_JaheirasHouse_JaheiraMinscInRange((CHARACTER)_Player)
AND
NOT DB_JaheirasHouse_JaheiraAndMinsc(_Player)
AND
DB_JaheirasHouse_JaheiraAndMinsc(_OtherPlayer)
AND
DB_Players(_OtherPlayer)
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)_Player, (CHARACTER)_OtherPlayer)
THEN
DB_NOOP(1);


//If a non-Jaheira/Minsc player attacks the family, and either/both of them are in range
QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_Player, (STRING)_Crime, _, (CHARACTER)_FamilyMember, _ID)
AND
DB_JaheirasHouse_ExclusiveReacts(_Crime)
AND
DB_JaheirasHouse_FamilyDisperse(_FamilyMember, _)
AND
DB_Players(_Player)
AND
NOT DB_JaheirasHouse_JaheiraAndMinsc(_Player)
AND
DB_JaheirasHouse_JaheiraAndMinsc(_OtherPlayer)
AND
_OtherPlayer != _Player
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, _OtherPlayer)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_JaheiraMinscReaction")
THEN
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_PlayerAttackedFamily_f505ff06-486a-4d8d-9986-95f4f91f9094);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_FamilyHasReasonToLeave_a60ebbac-f4a7-4ed8-a565-4a10dbb641e2);
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscReact((CHARACTER)_OtherPlayer);
PROC_LOW_JaheirasHouse_FamilyLeaves();

//If Jaheira/Minsc attack the family and a player is in range for them to yell at
QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_OtherPlayer, (STRING)_Crime, _, (CHARACTER)_FamilyMember, _ID)
AND
DB_JaheirasHouse_ExclusiveReacts(_Crime)
AND
DB_JaheirasHouse_FamilyDisperse(_FamilyMember, _)
AND
DB_Players(_OtherPlayer)
AND
DB_JaheirasHouse_JaheiraAndMinsc(_OtherPlayer)
AND
DB_Players(_Player)
AND
NOT DB_JaheirasHouse_JaheiraAndMinsc((CHARACTER)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, _OtherPlayer)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_JaheiraMinscReaction")
THEN
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_PlayerAttackedFamily_f505ff06-486a-4d8d-9986-95f4f91f9094);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_CompanionAttackedFamily_f30bb5a9-ca96-40a5-8eba-30c17930c3c3);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_FamilyHasReasonToLeave_a60ebbac-f4a7-4ed8-a565-4a10dbb641e2);
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscReact((CHARACTER)_OtherPlayer);
PROC_LOW_JaheirasHouse_FamilyLeaves();
 

//And finally, if Jaheira/Minsc attack the family but nobody is around to see it (except either Jaheira/Minsc)
QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_OtherPlayer, (STRING)_Crime, _, (CHARACTER)_FamilyMember, _ID)
AND
DB_JaheirasHouse_ExclusiveReacts(_Crime)
AND
DB_JaheirasHouse_FamilyDisperse(_FamilyMember, _)
AND
DB_Players(_OtherPlayer)
AND
DB_JaheirasHouse_JaheiraAndMinsc(_OtherPlayer)
AND
NOT QRY_JaheirasHouse_PlayersInRange((CHARACTER)_OtherPlayer)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_JaheiraMinscReaction")
THEN
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_PlayerAttackedFamily_f505ff06-486a-4d8d-9986-95f4f91f9094);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_CompanionAttackedFamily_f30bb5a9-ca96-40a5-8eba-30c17930c3c3);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_FamilyHasReasonToLeave_a60ebbac-f4a7-4ed8-a565-4a10dbb641e2);
PROC_LOW_JaheirasHouse_FamilyLeaves();
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscAD((CHARACTER)_OtherPlayer);

//And finally finally, a catch all incase combat starts for any other reason whatsoever and Jaheira/Minsc don't swap sides

IF
EnteredCombat(_FamilyMember, _GUID)
AND
DB_JaheirasHouse_JaheiraFamilyFighters((CHARACTER)_FamilyMember)
AND
DB_Players(_Player)
AND
IsEnemy(_Player, _FamilyMember, 1)
THEN
DB_LOW_JaheirasHouse_KidCombat(_GUID);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_PlayerAttackedFamily_f505ff06-486a-4d8d-9986-95f4f91f9094);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_FamilyHasReasonToLeave_a60ebbac-f4a7-4ed8-a565-4a10dbb641e2);
PROC_LOW_JaheirasHouse_FamilyLeaves();

IF
DB_LOW_JaheirasHouse_KidCombat(_GUID)
AND
DB_Is_InCombat(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _GUID)
AND
DB_PartyMembers(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
DB_CombatReact_AD_OnTurn(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, LOW_JaheirasHouse_PAD_JaheiraGoesHostile_c5c7e01a-8c44-69bb-02e2-198708123b3b, 1);
PROC_Origins_CompanionLeavePermanently(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "JaheiraHostile");
PROC_ClearOriginLeavingDialogs(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_Origin_BecameHostile(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

IF
DB_LOW_JaheirasHouse_KidCombat(_GUID)
AND
DB_Is_InCombat(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _GUID)
AND
DB_PartyMembers(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
DB_CombatReact_AD_OnTurn(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, LOW_JaheirasHouse_PAD_MinscGoesHostile_306c1fe5-cd54-4414-d1e4-1bb575ebdeb5 , 1);
PROC_Origins_CompanionLeavePermanently(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "MinscHostile");
PROC_ClearOriginLeavingDialogs(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
DB_Origin_BecameHostile(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);


QRY
QRY_JaheirasHouse_PlayersInRange((CHARACTER)_OtherPlayer)
AND
DB_Players(_Player)
AND
NOT DB_JaheirasHouse_JaheiraAndMinsc((CHARACTER)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, _OtherPlayer)
THEN
DB_NOOP(1);
//END_REGION

//REGION Setup Minsc/Jaheira

//First if it's Jaheira, set up Jaheira reacting

PROC
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscReact((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_JaheiraTurnsHostile")
THEN
DB_CombatReact_AD_OnTurn(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, LOW_JaheirasHouse_PAD_JaheiraGoesHostile_c5c7e01a-8c44-69bb-02e2-198708123b3b, 1);
PROC_LOW_JaheirasHouse_SetupJaheiraAndOrMinscHostile((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

//Then check if Minsc is in range and if so make sure that it procs for Minsc as well.
PROC
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscReact((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_JaheiraTurnsHostileRangeCheck")
AND
QRY_IsInRange((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, 20.0)
THEN
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscReact((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

//If it proc'd either initially for Minsc, or as a result of Jaheira range, then Minsc also reacts.
PROC
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscReact((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_MinscTurnsHostile")
THEN
DB_CombatReact_AD_OnTurn(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, LOW_JaheirasHouse_PAD_MinscGoesHostile_306c1fe5-cd54-4414-d1e4-1bb575ebdeb5 , 1);
PROC_LOW_JaheirasHouse_SetupJaheiraAndOrMinscHostile((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

//And on the offchance it proc'd for Minsc and not Jaheira, do the same range check in reverse.
PROC
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscReact((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_JaheiraTurnsHostileRangeCheck")
AND
QRY_OnlyOnce("LOW_JaheirasHouse_MinscTurnsHostileRangeCheck")
AND
QRY_IsInRange((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, 20.0)
THEN
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscReact((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_LOW_JaheirasHouse_SetupJaheiraAndOrMinscHostile((CHARACTER)_Companion)
AND
DB_GLO_PartyMembers_OriginalAlignment(_Companion,_NpcFaction)
THEN
PROC_Origins_CompanionLeavePermanently(_Companion, "CompanionHostile");
PROC_ClearOriginLeavingDialogs(_Companion);
PROC_SetRelationToPlayers(_NpcFaction,0);
DB_Origin_BecameHostile(_Companion);

//If Jaheira turns hostile - just make sure that Jord's line about his mother not being home is removed
PROC
PROC_LOW_JaheirasHouse_SetupJaheiraAndOrMinscHostile((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_CombatReact_AD_OnNextTurn(S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_EldestSonCombatAD003_b4130e70-7bb8-f053-dbca-78578ff83be1)
THEN
NOT DB_CombatReact_AD_OnNextTurn(S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, (DIALOGRESOURCE)LOW_JaheirasHouse_AD_EldestSonCombatAD003_b4130e70-7bb8-f053-dbca-78578ff83be1);

//For if you kill the children out of their sight, then return back there to find them dead

IF
DB_PermaDefeated(_NPC)
AND
DB_JaheirasHouse_JaheiraFamilyFighters((CHARACTER)_NPC)
AND
DB_JaheirasHouse_JaheiraAndMinsc(_Companion)
AND
QRY_IsInRange(_NPC, _Companion, 25.0)
AND
DB_JaheirasHouse_DeadFamilyAD(_Companion, _AD)
AND
DB_GLO_PartyMembers_OriginalAlignment(_Companion,_NpcFaction)
THEN
PROC_TryStartAD((DIALOGRESOURCE)_AD, _Companion);
PROC_Origins_CompanionLeavePermanently(_Companion, "CompanionHostile");
PROC_ClearOriginLeavingDialogs(_Companion);
PROC_SetRelationToPlayers(_NpcFaction,0);
DB_Origin_BecameHostile(_Companion);


//If the player isn't nearby, and either Minsc or Jaheira attacks their family - Jaheira (and Minsc if nearby, he gets added on dialogue start)

PROC
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscAD((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
StartVoiceBark(LOW_JaheirasHouse_VB_CompanionAttackFamily_59e93f3e-53d5-0b87-c27f-3b73ac6bc829, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);


PROC
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscAD((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba )
AND
QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
StartVoiceBark(LOW_JaheirasHouse_VB_CompanionAttackFamily_59e93f3e-53d5-0b87-c27f-3b73ac6bc829, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_LOW_JaheirasHouse_JaheiraAndOrMinscAD((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT QRY_SpeakerIsAvailableAndInDialogRange((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
StartVoiceBark(LOW_JaheirasHouse_VB_CompanionAttackFamily_59e93f3e-53d5-0b87-c27f-3b73ac6bc829, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

//If a dialog tries to start that has a Minsc inclusion, check he's near and add him if he is
PROC
PROC_StartDialog_AddExtraSpeakers(_MinscAdditions, (INTEGER)_Inst)
AND
DB_JaheirasHouse_MinscOptionalDialogs(_MinscAdditions)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_DialogAddSpeakingActor(_Inst, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
SetFlag((FLAG)LOW_JaheirasHouse_State_CompanionConfrontedParty_63f9c1c7-1f5e-4c42-8512-0d34334b041e, (CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

//END_REGION Jaheira/Minsc reacting to attacks

//REGION Family scripting

IF
TextEvent("TestJaheiraFamilyLeave")
AND
DB_GlobalFlag(LOW_JaheirasHouse_State_FamilyHasReasonToLeave_a60ebbac-f4a7-4ed8-a565-4a10dbb641e2)
THEN
PROC_LOW_JaheirasHouse_FamilyLeaves();

PROC
PROC_LOW_JaheirasHouse_FamilyLeaves()
AND
DB_JaheirasHouse_JaheiraFamilyLeaves(_NPC)
THEN
PROC_NotifyWhenReadyToMoveOn(_NPC, "LOW_JaheirasHouse_FamilyReadyToLeave");

//Once ready, family leave
PROC
PROC_ReadyToMoveOn(_NPC, "LOW_JaheirasHouse_FamilyReadyToLeave")
THEN
PROC_LOW_JaheirasHouse_TateDropsPin();
PROC_DisappearOutOfSight((CHARACTER)_NPC, "Run", 1, "LOW_JaheirasHouse_FamilyLeaves");

PROC
PROC_LOW_JaheirasHouse_TateDropsPin()
AND
IsInInventoryOf(S_LOW_JaheirasHouse_JaheiraHarperPin_0897e01c-6f5f-484e-b10b-9dd772f11d1a, S_LOW_JaheirasHouse_YoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c, 1)
THEN
ToInventory(S_LOW_JaheirasHouse_JaheiraHarperPin_0897e01c-6f5f-484e-b10b-9dd772f11d1a, FUR_GEN_Wardrobe_B_000_2478aeb9-6a0c-4716-a95d-78c2b4766efe, 1, 0, 1);

PROC
PROC_ReadyToMoveOn_Failed(_NPC, "LOW_JaheirasHouse_FamilyReadyToLeave")
THEN
SetOnStage(_NPC, 0);

//For when the adult kids need to leave too
PROC
PROC_LOW_JaheirasHouse_FightersLeave()
AND
DB_JaheirasHouse_JaheiraFamilyFighters(_NPC)
THEN
PROC_NotifyWhenReadyToMoveOn(_NPC, "LOW_JaheirasHouse_FighterReadyToLeave");

//Once ready, adult kids leave
PROC
PROC_ReadyToMoveOn(_NPC, "LOW_JaheirasHouse_FighterReadyToLeave")
THEN
PROC_DisappearOutOfSight((CHARACTER)_NPC, "Run", 1, "LOW_JaheirasHouse_FighterLeaves");

//For Fig's intro

//If Fig spots Jaheira, react with a dialog. The dialog itself handles the setup of the flag to prompt her running away (The flag check is lower). On success we stop looking for anyone (also at the flag).
//     On failing she still wants to look for Jaheira, so reset itself
PROC
PROC_SpotPlayers_Spotted(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForJaheira", _Player)
AND
NOT QRY_StartDialog_Fixed(LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56, S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, _Player)
THEN
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_YoungestTriedToStopEntry_9556ac12-1bfd-4b4d-8008-cc89736c5f3f);
SetFlag(LOW_JaheirasHouse_State_GranddaughterSawJaheira_4041963d-4576-4041-96e0-26501bff40ba, S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115);

PROC
PROC_SpotPlayers_Spotted(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForSomeone", _Player)
AND
_Player != S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a
AND
QRY_StartDialog(LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56, S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, _Player)
THEN
DB_NOOP(1);

//Make sure to add Jaheira to the dialog if she's there
PROC
PROC_StartDialog_AddExtraSpeakers(LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56, (INTEGER)_Inst)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115)
THEN
PROC_DialogAddSpeakingActor(_Inst, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

//If Fig specifically spots Jaheira, and it's after she's tried to stop someone else (otherwise it defaults to the dialog)
PROC
PROC_SpotPlayers_Spotted(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForJaheira", S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_GlobalFlag(LOW_JaheirasHouse_State_YoungestTriedToStopEntry_9556ac12-1bfd-4b4d-8008-cc89736c5f3f)
THEN
SetFlag(LOW_JaheirasHouse_State_GranddaughterSawJaheira_4041963d-4576-4041-96e0-26501bff40ba, S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115);

//If Jaheira was not in her initial conversation and has not met her family, she specifically starts looking for her and stops looking for just anyone. 
IF
FlagSet(LOW_JaheirasHouse_State_YoungestTriedToStopEntry_9556ac12-1bfd-4b4d-8008-cc89736c5f3f, _, _Inst)
AND
NOT DB_GlobalFlag(LOW_JaheirasHouse_State_JaheiraSpokeToFamily_efad8157-79e3-46a0-ae9e-3bb6f6a191d0)
AND
GetFlag(LOW_JaheirasHouse_State_GranddaughterSawJaheira_4041963d-4576-4041-96e0-26501bff40ba, S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, 0)
THEN
PROC_SpotPlayers_StopSpotting("LOW_JaheirasHouse_YoungestDaughterLookingForSomeone");

//If Jaheira was included one way or another in the dialog, Fig can stop spotting everyone immediately
IF
FlagSet(LOW_JaheirasHouse_State_GranddaughterSawJaheira_4041963d-4576-4041-96e0-26501bff40ba, S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, _Inst)
THEN
PROC_SpotPlayers_StopSpotting("LOW_JaheirasHouse_YoungestDaughterLookingForJaheira");
PROC_SpotPlayers_StopSpotting("LOW_JaheirasHouse_YoungestDaughterLookingForSomeone");

//In this case, we've had the "YOU'RE IN TROUBLE!" line, so can carry on with no AD as Fig has directly confronted Jaheira
IF
DialogEnded(LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56, _Inst)
AND
DB_GlobalFlag(LOW_JaheirasHouse_State_GranddaughterConfrontedJaheira_f2f6c8b6-b241-4f92-bc43-984cbeed7a68)
AND
GetFlag(LOW_JaheirasHouse_State_GranddaughterSawJaheira_4041963d-4576-4041-96e0-26501bff40ba, S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, 1)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_YoungestMovedInside")
THEN
PROC_CharacterMoveTo(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, (GUIDSTRING)S_LOW_JaheiraGranddaughterOMMoveTrigger2_d9e0eb17-7b4b-4885-a4cc-55d849af9a02, "Run", "LOW_JaheirasHouse_GranddaughterInPositionForGroupChat");
SetWeaponUnsheathed(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, 0, 0);
SetFlag(LOW_JaheirasHouse_State_GranddaughterMoved_6649dd76-2000-4774-bcc6-7272baaec9da, S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115);

//And in this one, we only got a "!" gasp of surprise from Fig, so play the AD so we know what she's reacting to, just incase

IF
DialogEnded(LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56, _Inst)
AND
NOT DB_GlobalFlag(LOW_JaheirasHouse_State_GranddaughterConfrontedJaheira_f2f6c8b6-b241-4f92-bc43-984cbeed7a68)
AND
GetFlag(LOW_JaheirasHouse_State_GranddaughterSawJaheira_4041963d-4576-4041-96e0-26501bff40ba, S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, 1)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_YoungestMovedInside")
THEN
PROC_CharacterMoveTo(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, (GUIDSTRING)S_LOW_JaheiraGranddaughterOMMoveTrigger2_d9e0eb17-7b4b-4885-a4cc-55d849af9a02, "Run", "LOW_JaheirasHouse_GranddaughterInPositionForGroupChatNoAD");
SetWeaponUnsheathed(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, 0, 0);
PROC_TryStartAD(LOW_JaheirasHouse_AD_Granddaughter_2333f7dd-af95-c76e-5110-767d3e27bd0a, S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
SetFlag(LOW_JaheirasHouse_State_GranddaughterMoved_6649dd76-2000-4774-bcc6-7272baaec9da, S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115);




//Fig gets her OM's set after the family meeting has played.

IF
DB_GlobalFlag(LOW_JaheirasHouse_State_JaheiraSpokeToFamily_efad8157-79e3-46a0-ae9e-3bb6f6a191d0)
THEN
PROC_DefineSingleOriginMoment((DIALOGRESOURCE) LOW_JaheirasHouse_YoungestDaughter_777b0c3e-c35c-eacf-09d8-40e22e807a56, (TAG)REALLY_JAHEIRA_8457eb5f-036c-4143-b6cf-447a9f555c7a, (DIALOGRESOURCE) LOW_JaheiraAndDaughter03_OM_Jaheira_OOM_16dcd827-02f2-9262-8957-25c9a3ed4d9d, (DIALOGRESOURCE) LOW_JaheiraAndDaughter03_OM_Jaheira_COM_47a52ee2-2e03-6772-5d43-e0433c182c3a, (DIALOGRESOURCE) LOW_JaheiraAndDaughter03_OM_Jaheira_OOM_16dcd827-02f2-9262-8957-25c9a3ed4d9d);
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndDaughter03_OM_Jaheira_OOM_16dcd827-02f2-9262-8957-25c9a3ed4d9d, (CHARACTER)S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115); 
DB_LOW_JaheirasHouse_OriginMomentList((DIALOGRESOURCE) LOW_JaheiraAndDaughter03_OM_Jaheira_COM_47a52ee2-2e03-6772-5d43-e0433c182c3a, (CHARACTER)S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115);

IF
DB_GlobalFlag(LOW_JaheirasHouse_State_JaheiraSpokeToFamily_efad8157-79e3-46a0-ae9e-3bb6f6a191d0)
AND
DB_SpotPlayers(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForSomeone", NULL_00000000-0000-0000-0000-000000000000, LOW_JaheirasHouse_State_FigSpottingAnyoneStop_61528adc-ea0b-4840-b34f-6773dec6699c)
THEN
PROC_SpotPlayers_StopSpotting("LOW_JaheirasHouse_YoungestDaughterLookingForSomeone");

IF
DB_GlobalFlag(LOW_JaheirasHouse_State_JaheiraSpokeToFamily_efad8157-79e3-46a0-ae9e-3bb6f6a191d0)
AND
DB_SpotPlayers(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForJaheira", NULL_00000000-0000-0000-0000-000000000000, LOW_JaheirasHouse_State_FigSpottingJaheiraStop_172957ab-963f-40cc-acda-097ba4c22f34)
THEN
PROC_SpotPlayers_StopSpotting("LOW_JaheirasHouse_YoungestDaughterLookingForJaheira");


IF
EntityEvent(_Player, "LOW_JaheirasHouse_GranddaughterInPositionForGroupChat")
THEN
PROC_TryStartAD(LOW_JaheirasHouse_AD_Granddaughter_2333f7dd-af95-c76e-5110-767d3e27bd0a, S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_GranddaughterReadyToStart_f7aa5ec3-2f09-4069-ab3c-d74546c69ebe);


//END_REGION


//REGION - Open/close the hidden floor that hides the basement entry and also make it not spammable

IF
Combined(S_LOW_JaheirasHouse_HarperPinSlot_d96fa8b4-3bf3-44c4-8ad7-79adb43fe9d5, _, _, _, _, _Player, _)
AND
IsOnStage(S_LOW_JaheirasHouse_CentralDesk_e63f517c-3705-42d6-a69e-0be1c34fa35b, (INTEGER)_OnStage)
AND
DB_Players(_Player)
AND
DB_JaheirasHouse_CombinedItemEntityEvent(S_LOW_JaheirasHouse_HarperPinSlot_d96fa8b4-3bf3-44c4-8ad7-79adb43fe9d5, (STRING)_PromptedEntityEvent)
THEN
PROC_JaheirasHouse_OpenPuzzleItem((STRING)_PromptedEntityEvent, (INTEGER)_OnStage);

//If you leave the cellar, make sure it opens the door if it's closed

IF
EntityEvent(_Player, "LOW_JaheirasHouse_JaheiraBasementExit")
AND
DB_Players((CHARACTER)_Player)
AND
DB_JaheirasHouse_MovePuzzleItem(_OnStage, _, _, "LOW_JaheirasHouse_JaheiraBasementExit")
THEN
PROC_JaheirasHouse_OpenPuzzleItem("LOW_JaheirasHouse_JaheiraBasementExit", (INTEGER)_OnStage);

//Then check for the item, whether it's open and either open or close it

PROC
PROC_JaheirasHouse_OpenPuzzleItem((STRING)_PromptedEntityEvent, (INTEGER)_OnStage)
AND
DB_JaheirasHouse_MovePuzzleItem(_OnStage, _NewOnStage, _PuzzleItem, (STRING)_PromptedEntityEvent)
AND
GetPosition(_PuzzleItem, _X, _Y, _Z)
THEN
PROC_PlayLoopingAnimation(S_LOW_JaheirasHouse_CentralDesk_e63f517c-3705-42d6-a69e-0be1c34fa35b, (ANIMATION)OBJ_Use_Activate_01_42c02cc0-0503-4ca9-9ea0-45564bd0e5d4, (ANIMATION)OBJ_Idle_Activated_01_8be9179a-3dc5-4a35-bd61-33af16176cf4, (ANIMATION)OBJ_Use_Deactivate_01_bb1e8405-8773-46d1-92c8-9f42d900922b);
ObjectTimerLaunch(S_LOW_JaheirasHouse_CentralDesk_e63f517c-3705-42d6-a69e-0be1c34fa35b, "LOW_JaheirasHouse_OpenDesk", 2000);

//Then listen for when it moves off stage and let the game know if it's open or shut.

IF
ObjectTimerFinished(S_LOW_JaheirasHouse_CentralDesk_e63f517c-3705-42d6-a69e-0be1c34fa35b, "LOW_JaheirasHouse_OpenDesk")
THEN
SetCanInteract((ITEM)S_LOW_JaheirasHouse_BasementTransition_793931e4-eb7b-4814-9884-543b73a26f39, 1);

//END_REGION

//REGION - The elemental orbs and appearance of the bridge

IF
AttackedBy(_Orb, _Helper, _, _DamageType, _, _, _)
AND
DB_JaheirasHouse_ElementalPillars(_Orb, _DamageType, _Status)
AND
NOT DB_JaheirasHouse_ElementalPillarHelpers(_Orb, _Helper)
THEN
NOT DB_JaheirasHouse_ElementalPillars(_Orb, _DamageType, _Status);
PROC_PlayPerceptionRevealEffect(_Orb, "LOW_JaheirasHouse_ArcaneOrbSolved");
ApplyStatus(_Orb, _Status, -1.0, 1);
PROC_JaheirasHouse_TidyAdditionalShock((STRING)_Status);
NOT DB_JaheirasHouse_AllowedNewTrap(_Orb);
PROC_JaheirasHouse_RemoveGlyphs(_Orb);

IF
StatusApplied(_Orb, _Status, _, _)
AND
DB_JaheirasHouse_ElementalPillars(_Orb, _DamageType, _Status)
THEN
NOT DB_JaheirasHouse_ElementalPillars(_Orb, _DamageType, _Status);
PROC_PlayPerceptionRevealEffect(_Orb, "LOW_JaheirasHouse_ArcaneOrbSolved");
PROC_JaheirasHouse_TidyAdditionalShock((STRING)_Status);
PROC_JaheirasHouse_MakeStatusPermanent((STRING)_Status, (GUIDSTRING)_Orb);
NOT DB_JaheirasHouse_AllowedNewTrap(_Orb);
PROC_JaheirasHouse_RemoveGlyphs(_Orb);

PROC
PROC_JaheirasHouse_TidyAdditionalShock((STRING)_Status)
AND
DB_JaheirasHouse_ElementalPillarsShocked(_String)
AND
DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, _String, _Status)
THEN
NOT DB_JaheirasHouse_ElementalPillars(S_LOW_JaheirasHouse_ThunderOrb_7caa4451-9a68-4f3a-a22c-6726a3ea34f1, _String, _Status);

PROC
PROC_JaheirasHouse_MakeStatusPermanent((STRING)_Status, (GUIDSTRING)_Orb)
AND
GetStatusTurns(_Orb, _Status, _Turns)
AND
_Turns != -1.0
THEN
RemoveStatus(_Orb, _Status);
ApplyStatus(_Orb, _Status, -1.0, 1);

//For if the players find the scroll
IF
FlagSet(LOW_JaheirasHouse_State_HasJaheiraScroll_bf14af6d-1735-4260-9f43-2c7d52f62104, _Player, _)
AND
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_FoundJaheirasScroll")
AND
QRY_IsInRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player, 20.0)
THEN
StartVoiceBark(LOW_JaheirasHouse_VB_FoundJaheiraScroll_0dd267d9-f1f1-06dd-3839-22ab8111c396, _Player);
PROC_GlobalSetFlagAndCache(ORI_Jaheira_Event_DiscoveredScroll_f048a8fe-95a1-2f40-c711-8c3dd155401a);

IF
GameBookInterfaceClosed(S_LOW_JaheiraSecretScroll_94609102-443a-4a11-a6e4-e6feffa02b53, _Player)
AND
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_FoundJaheirasScroll")
AND
QRY_IsInRange(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player, 20.0)
THEN
StartVoiceBark(LOW_JaheirasHouse_VB_FoundJaheiraScroll_0dd267d9-f1f1-06dd-3839-22ab8111c396, _Player);
PROC_GlobalSetFlagAndCache(ORI_Jaheira_Event_DiscoveredScroll_f048a8fe-95a1-2f40-c711-8c3dd155401a);

//END_REGION

//REGION Jaheira state reactions

//If you spoke to her son and got her OOM or COM - point to the study

IF
DialogEnded(LOW_JaheiraAndSon02_OM_Jaheira_OOM_fa080372-ae4e-ebcc-2d85-db65ea3608b5, _)
THEN
PROC_LOW_JaheirasHouse_JaheiraTryAD("LOW_JaheirasHouse_JaheiraDoneWithOM");

IF
DialogEnded(LOW_JaheiraAndSon02_OM_Jaheira_COM_36ad2b44-8361-fa5a-28e6-95a1eae44417, _)
THEN
PROC_LOW_JaheirasHouse_JaheiraTryAD("LOW_JaheirasHouse_JaheiraDoneWithOM");


//If you opened the secret desk and figured out the secret basement - comment on it

IF
WentOnStage(S_LOW_JaheirasHouse_CentralDesk_e63f517c-3705-42d6-a69e-0be1c34fa35b, 0)
THEN
PROC_LOW_JaheirasHouse_JaheiraTryAD("LOW_JaheirasHouse_JaheiraMovedDesk");

//If you enter into the basement

IF
EnteredTrigger(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_LOW_JaheiraBasementADTrigger_88c262f3-feca-4121-8679-fecdd0cfbc68)
AND
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_LOW_JaheirasHouse_JaheiraTryAD("LOW_JaheirasHouse_JaheiraInBasement");
TriggerUnregisterForCharacter(S_LOW_JaheiraBasementADTrigger_88c262f3-feca-4121-8679-fecdd0cfbc68, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
PROC_PlayPerceptionRevealEffect(S_LOW_JaheiraPressurePlateBox_9db03f25-d023-4a4a-b9b4-746a0ae0c7d9, "LOW_JaheirasHpuse_JaheiraToldAboutPressurePlate");

//If you go near the grove

IF
EnteredTrigger(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_LOW_JaheiraGroveTrigger_5946cc1b-2c0d-449d-be95-54786d2786ad)
AND
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_State_Progress(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", "LOW_JaheirasHouse_JaheiraInGrove");

IF
FlagSet(LOW_JaheirasHouse_Event_FoundKhalidsGift_010d2d26-74f9-4e3d-8437-4c23694dd591, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_Event_FoundKhalidsGift_010d2d26-74f9-4e3d-8437-4c23694dd591);

PROC
PROC_LOW_JaheirasHouse_JaheiraTryAD((STRING)_MoveOnString)
AND
DB_LOW_JaheirasHouse_ADList(_MoveOnString, _StateFlagString)
THEN
PROC_JaheirasHouse_JaheiraBark((STRING)_StateFlagString);

//END_REGION

//REGION Jaheira's AD's - And Minsc AD too

PROC
PROC_JaheirasHouse_JaheiraBark((STRING)_String)
THEN
PROC_State_Progress(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "LOW_JaheirasHouse_JaheiraADs", (STRING)_String);
DB_LOW_JaheirasHouse_RetryPAD(LOW_JaheirasHouse_PAD_JaheiraReactions_c13a6dab-afdf-4e80-159b-bfb21cf40f73);

IF
DB_LOW_JaheirasHouse_RetryPAD(_Dialog)
AND
NOT DB_CantTalk(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_TryStartAD((DIALOGRESOURCE)_Dialog, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
NOT DB_LOW_JaheirasHouse_RetryPAD(_Dialog);

IF
UseFinished(_Player, S_LOW_JaheirasHouse_JaheiraChest_a5a3e6ae-ee96-4cb6-b069-fef38ff19cd1, 1)
AND
DB_Players(_Player)
AND
QRY_SpeakerIsInDialogRange(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, S_LOW_JaheirasHouse_JaheiraChest_a5a3e6ae-ee96-4cb6-b069-fef38ff19cd1)
AND
QRY_OnlyOnce("LOW_JaheirasHouse_MinscCommentsOnWeapons")
THEN
PROC_TryStartAD(LOW_JaheirasHouse_PAD_MinscSawWeapons_406b62e4-35c3-3fed-2555-6d1c6e9b3e94, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

IF
EnteredTrigger (S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_LOW_JaheiraOrbTrigger_03b7e147-fc89-4289-aff8-b9b1f0e658a9)
AND
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_TryStartAD(LOW_JaheirasHouse_PAD_JaheiraPointsToOrbs_996d4214-cd42-ba05-efe3-f9fa97fae56f, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
TriggerUnregisterForCharacter(S_LOW_JaheiraOrbTrigger_03b7e147-fc89-4289-aff8-b9b1f0e658a9, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

//END_REGION 

//REGION Jaheira's OM family gathering moment

PROC
PROC_SpotPlayers_Spotted(S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, "LOW_JaheirasHouse_FamilySpottedJaheira", S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
QRY_StartDialog_Fixed(LOW_JaheirasHouse_EldestDaughter_090eb987-e31a-8163-d340-36267a7d787e, S_LOW_JaheirasHouse_JaheirasDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_RionSpottingStop_c1baf690-56c4-4997-84e9-02c24e5a15b0);

IF
DialogEnded(LOW_JaheiraAndFamily_OM_Jaheira_OOM_41c550bb-9ed0-99e4-9e04-345f155fc91b, _)
THEN
PROC_DefineSingleOriginMoment((DIALOGRESOURCE) LOW_JaheirasHouse_EldestDaughter_090eb987-e31a-8163-d340-36267a7d787e, (TAG)REALLY_JAHEIRA_8457eb5f-036c-4143-b6cf-447a9f555c7a, (DIALOGRESOURCE)LOW_JaheiraAndDaughter01_OM_Jaheira_OOM_c9211982-672e-02e6-2d40-eaad7818f442, (DIALOGRESOURCE) LOW_JaheiraAndDaughter01_OM_Jaheira_COM_185068a2-eee0-131a-ab45-e2f61c4a43cf, (DIALOGRESOURCE)LOW_JaheiraAndDaughter01_OM_Jaheira_OOM_c9211982-672e-02e6-2d40-eaad7818f442);

IF
DialogEnded(LOW_JaheiraAndFamily_OM_Jaheira_COM_e994dbe5-5db8-4c05-eb2e-2690ca2d134e, _)
THEN
PROC_DefineSingleOriginMoment((DIALOGRESOURCE) LOW_JaheirasHouse_EldestDaughter_090eb987-e31a-8163-d340-36267a7d787e, (TAG)REALLY_JAHEIRA_8457eb5f-036c-4143-b6cf-447a9f555c7a, (DIALOGRESOURCE)LOW_JaheiraAndDaughter01_OM_Jaheira_OOM_c9211982-672e-02e6-2d40-eaad7818f442, (DIALOGRESOURCE) LOW_JaheiraAndDaughter01_OM_Jaheira_COM_185068a2-eee0-131a-ab45-e2f61c4a43cf, (DIALOGRESOURCE)LOW_JaheiraAndDaughter01_OM_Jaheira_OOM_c9211982-672e-02e6-2d40-eaad7818f442);

PROC
PROC_StartDialog_AddExtraSpeakers(LOW_JaheiraAndFamily_OM_Jaheira_COM_e994dbe5-5db8-4c05-eb2e-2690ca2d134e, (INTEGER)_Inst)
THEN
PROC_LOW_JaheirasHouse_AddFamilySpeakers((INTEGER)_Inst);

PROC
PROC_StartDialog_AddExtraSpeakers(LOW_JaheiraAndFamily_OM_Jaheira_OOM_41c550bb-9ed0-99e4-9e04-345f155fc91b, (INTEGER)_Inst)
THEN
PROC_LOW_JaheirasHouse_AddFamilySpeakers((INTEGER)_Inst);

PROC
PROC_LOW_JaheirasHouse_AddFamilySpeakers((INTEGER)_Inst)
AND
DB_JaheirasHouse_FamilyAdditionalSpeakers((GUIDSTRING)_Speaker)
AND
IsInTrigger(_Speaker, S_LOW_JaheiraFamilyDialogueInclusion_5c5269ff-c866-483b-a00e-99acf461ba95, 1)
AND
QRY_SpeakerIsAvailable((CHARACTER)_Speaker)
THEN
PROC_DialogAddSpeakingActor(_Inst, _Speaker);

//Handle Jaheira's family - Don't relaunch the dialogue and move them to their idle locations after either of the Family origin moments

IF
TextEvent("LOW_ResetJaheiraFamily")
AND
DB_JaheirasHouse_FamilyDisperse(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, _Trigger)
THEN
PROC_CharacterMoveTo(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, _Trigger, "Run", "LOW_JaheirasHouseDebug");
DB_SpotPlayers_HasTag(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForJaheira", (TAG)JAHEIRA_2c948b46-0d8a-426b-ad8b-5f41233df4c1, 1);
DB_SpotPlayers_SpotTrigger(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForJaheira", S_LOW_JaheirasHouse_FigTrigger_c24252d6-d7fc-4411-8715-325482d928b3);
DB_SpotPlayers(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForJaheira", NULL_00000000-0000-0000-0000-000000000000, LOW_JaheirasHouse_State_FigSpottingJaheiraStop_172957ab-963f-40cc-acda-097ba4c22f34);
DB_SpotPlayers_SpotTrigger(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForSomeone", S_LOW_JaheirasHouse_FigTrigger_c24252d6-d7fc-4411-8715-325482d928b3);
DB_SpotPlayers(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForSomeone", NULL_00000000-0000-0000-0000-000000000000, LOW_JaheirasHouse_State_FigSpottingAnyoneStop_61528adc-ea0b-4840-b34f-6773dec6699c);
DB_SpotPlayers_Continuous(S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, "LOW_JaheirasHouse_YoungestDaughterLookingForSomeone");

IF
DialogEnded(LOW_JaheiraAndFamily_OM_Jaheira_OOM_41c550bb-9ed0-99e4-9e04-345f155fc91b, _)
AND
DB_JaheirasHouse_FamilyDisperse(_Character, _Target)
THEN
PROC_CharacterMoveTo(_Character, _Target, "Walk", "LOW_JaheirasHouse_FamilyStartingIdles");
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_JaheiraMetFamily_9486cabf-8113-47f8-a03f-4a9aba46d140);
//END_REGION

//REGION Origin Moment controlling

QRY
QRY_OriginMoment_PreventRelaunchDialog(_Dialog, (CHARACTER)_Character, _Player)
AND
DB_LOW_JaheirasHouse_OriginMomentList(_Dialog, _Character)
THEN
DB_NOOP(1);

IF
DialogEnded(LOW_JaheiraAndFamily_OM_Jaheira_COM_e994dbe5-5db8-4c05-eb2e-2690ca2d134e, _)
AND
DB_JaheirasHouse_FamilyDisperse(_Character, _Target)
THEN
PROC_CharacterMoveTo(_Character, _Target, "Walk", "LOW_JaheirasHouse_FamilyStartingIdles");
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_JaheiraMetFamily_9486cabf-8113-47f8-a03f-4a9aba46d140);
//END_REGION

//REGION Jaheira's Secret Room reactivity

//If Jaheira's avatar approaches the bookcase - It'll look for Jaheira's avatar and start a conversation if in range

PROC
PROC_BlockUseOfItem(_Avatar, _Item)
AND
DB_JaheirasHouse_JaheiraItemDialogs(_Item, _Dialog, _Flag, _)
AND
NOT DB_GlobalFlag((FLAG)_Flag)
AND
QRY_GetBestAvatarForCompanion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_QRYRTN_GetBestAvatarForCompanion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Avatar)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Avatar, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_LOW_JaheirasHouse_LaunchJaheiraDialog(_Avatar, (DIALOGRESOURCE)_Dialog);

//If anyone else approach the bookcase - It'll look for Jaheira's avatar and if it fails, start a voice bark about it. So long as she's in range.

PROC
PROC_BlockUseOfItem(_Player, _Item)
AND
DB_Players(_Player)
AND
DB_JaheirasHouse_JaheiraItemDialogs(_Item, _Dialog, _Flag, _Type)
AND
NOT DB_GlobalFlag((FLAG)_Flag)
AND
QRY_IsInRange(_Item, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 20.0)
AND
QRY_GetBestAvatarForCompanion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_QRYRTN_GetBestAvatarForCompanion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player)
THEN
PROC_JaheirasHouse_ProcessJaheiraDialogOption(_Type);

// We only need to proc the "VB" one. The "AD" one is handled by a separate event which is actively ending the use action with the locket in your inventory, so it's fine that doesn't fire.

PROC
PROC_JaheirasHouse_ProcessJaheiraDialogOption("VB")
THEN
StartVoiceBark(LOW_JaheirasHouse_VB_EnteredSecretRoom_53a8b49b-35a9-d862-ad2a-7e4875071747, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_StoppedPlayerAtBookcase_53ec576a-34fe-48ce-88c7-4ad95b754328);

//Do the same if the bookcase dialog alone fails. Once again if the other fails, the AD catches it only when you take the item out of there

QRY
QRY_StartDialogFailed(LOW_JaheiraSecretRoom_OM_Jaheira_COM_da0578d7-bc24-6132-865d-9719fafd3409, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player,_,_,_,_)
AND
QRY_IsInRange(S_LOW_JaheirasHouse_SecretRoomBookcase_dbb64952-49e7-4ab8-a4c6-d4d3489ff565, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 20.0)
THEN
StartVoiceBark(LOW_JaheirasHouse_VB_EnteredSecretRoom_53a8b49b-35a9-d862-ad2a-7e4875071747, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
PROC_GlobalSetFlagAndCache(LOW_JaheirasHouse_State_StoppedPlayerAtBookcase_53ec576a-34fe-48ce-88c7-4ad95b754328);

//Jaheira dialog starts itself based on what was sent to it

PROC
PROC_LOW_JaheirasHouse_LaunchJaheiraDialog((GUIDSTRING)_Player, (DIALOGRESOURCE)_Dialog)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)_Dialog, (CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (CHARACTER)_Player)
AND
DB_JaheirasHouse_JaheiraItemDialogs(_Item, _Dialog, _, _)
THEN
DB_CustomUseItemResponse((CHARACTER)_Player, (ITEM)_Item, 0);

//The catch all of Khalid's display case. Operates differently because players can in theory just activate it without Jaheira nearby, but leave the locket there. This
//listens for the locket actually being out of the inventory of the display case when you're done using it.

IF
UseFinished(_Player, S_LOW_JaheirasHouse_KhalidsGiftDisplayCase_c681a4f4-46f8-45b8-a2da-746896434f53, 1)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_FoundKhalidsGift")
AND
IsInInventoryOf(S_LOW_JaheirasHouse_KhalidsGift_3282593a-e057-4d69-b8bf-da92058dea75, S_LOW_JaheirasHouse_KhalidsGiftDisplayCase_c681a4f4-46f8-45b8-a2da-746896434f53,  0)
AND
NOT DB_GlobalFlag(LOW_JaheirasHouse_Event_JaheiraSpokeOfKhalid_f72bd937-37b7-4cd0-b1ec-2c4771d2394c)
THEN
PROC_LOW_JaheirasHouse_JaheiraTryAD("LOW_JaheirasHouse_FoundKhalidGift");

//END_REGION

//REGION Basement Traps

//END_REGION



EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
