Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Entrance
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_LOW_MinscHideout_NoticeWaterTrigger_6cb2ab66-21c3-4265-ac49-3c2dd4b9ae5c, (VOICEBARKRESOURCE)LOW_MinscHideout_VB_NoticeWater_a023c249-5d98-8dcf-5028-e528942ad8e2);
//END_REGION

//REGION Sluice Guards
DB_LOW_MinscHideout_SluiceGuards((CHARACTER)S_LOW_MinscHideout_SluiceGuard_000_344ca9a0-d7ac-4a22-b859-6e99b6c45a18);
DB_LOW_MinscHideout_SluiceGuards((CHARACTER)S_LOW_MinscHideout_SluiceGuard_001_b68a4b00-ed19-4b68-8eb3-990f432c10c6);
DB_LOW_MinscHideout_SluiceGuards((CHARACTER)S_LOW_MinscHideout_SluiceGuard_002_c24f4c4a-58ad-4c82-b968-5eb7c422993c);

DB_LOW_MinscHideout_SluiceGuards_Crows((CHARACTER)LOW_BhaalCultist_Crow_000_c39c5c99-6fba-488f-996b-8205ff436fdc,(TRIGGER)S_LOW_MinscHideout_SluiceGuard_CrowSpawnPoint_000_0da5b132-72fb-4cfc-bfc2-5ccb29b21e30);
DB_LOW_MinscHideout_SluiceGuards_Crows((CHARACTER)LOW_BhaalCultist_Crow_001_533d3286-9870-4073-93d3-bfc1b9fa36ac,(TRIGGER)S_LOW_MinscHideout_SluiceGuard_CrowSpawnPoint_001_1b4d3cdd-a7d4-4af7-9c50-471a95b1fcb4);
DB_LOW_MinscHideout_SluiceGuards_Crows((CHARACTER)LOW_BhaalCultist_Crow_002_66f1fee5-0a9e-4d98-b29c-19caa6680b3a,(TRIGGER)S_LOW_MinscHideout_SluiceGuard_CrowSpawnPoint_002_a01cba61-9eda-4c35-bde9-9d5f604feb73);
DB_LOW_MinscHideout_SluiceGuards_Crows((CHARACTER)LOW_BhaalCultist_Crow_003_5ffe3104-542e-4cb3-92d7-457cb4f1cca1,(TRIGGER)S_LOW_MinscHideout_SluiceGuard_CrowSpawnPoint_003_7403dcf8-9633-4bca-a251-207e4a4cb8c8);
DB_LOW_MinscHideout_SluiceGuards_Crows((CHARACTER)LOW_BhaalCultist_Crow_004_165bd441-1663-4f16-82a0-c3f3aab1dc35,(TRIGGER)S_LOW_MinscHideout_SluiceGuard_CrowSpawnPoint_004_dd8dfb8f-9225-4cff-aef8-aeae729498ab);
DB_LOW_MinscHideout_SluiceGuards_Crows((CHARACTER)LOW_BhaalCultist_Crow_005_4deeeb08-3fa4-4466-b920-22b83770fb0d,(TRIGGER)S_LOW_MinscHideout_SluiceGuard_CrowSpawnPoint_005_97533fcc-4ce6-41ea-bbc5-0c7d7ef51ab2);
DB_LOW_MinscHideout_SluiceGuards_Crows((CHARACTER)LOW_BhaalCultist_Crow_006_6d176306-05e6-4bad-bcf4-a00c0b7ff015,(TRIGGER)S_LOW_MinscHideout_SluiceGuard_CrowSpawnPoint_006_69d3ce3c-5351-4b95-94bf-4eec7f7a3170);

PROC_TriggerRegisterForPlayers(S_LOW_MinscHideout_Box_PlayerNearSluiceGuard_002_667148a6-0b90-4c76-a30e-0ccf614c85e4);

//END_REGION

//REGION Sluice Gate Puzzle
DB_LOW_MinscHideout_Valves((ITEM)S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087);
DB_LOW_MinscHideout_Valves((ITEM)S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8);

DB_LOW_MinscHideout_ValveIndicators((ITEM)S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, (ITEM)S_LOW_MinscHideout_WaterIndicator_Gauge_2fcaabf2-29fa-440e-9214-ce2e9c518dbf);
DB_LOW_MinscHideout_ValveIndicators((ITEM)S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, (ITEM)S_LOW_MinscHideout_TemperatureIndicator_Gauge_0dc8d7e4-19f7-4af2-93a6-a24734d13abb);

// Params: Valve, Status, Duration, StageNum
DB_LOW_MinscHideout_ValveStatuses((ITEM)S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, "LOW_MINSCHIDEOUT_WATERVALVE_LOW", 18.0, 1);
DB_LOW_MinscHideout_ValveStatuses((ITEM)S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, "LOW_MINSCHIDEOUT_WATERVALVE_MID", 18.0, 2);
DB_LOW_MinscHideout_ValveStatuses((ITEM)S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, "LOW_MINSCHIDEOUT_WATERVALVE_HIGH", 18.0, 3);
DB_LOW_MinscHideout_ValveStatuses((ITEM)S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, "LOW_MINSCHIDEOUT_WATERVALVE_OVER", -1.0, 4);
DB_LOW_MinscHideout_ValveStatuses((ITEM)S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "LOW_MINSCHIDEOUT_TEMPERATUREVALVE_LOW", 18.0, 1);
DB_LOW_MinscHideout_ValveStatuses((ITEM)S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "LOW_MINSCHIDEOUT_TEMPERATUREVALVE_MID", 18.0, 2);
DB_LOW_MinscHideout_ValveStatuses((ITEM)S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "LOW_MINSCHIDEOUT_TEMPERATUREVALVE_HIGH", 18.0, 3);
DB_LOW_MinscHideout_ValveStatuses((ITEM)S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "LOW_MINSCHIDEOUT_TEMPERATUREVALVE_OVER", -1.0, 4);

// Params: Valve, Status, Duration
// When this status expires the pressure/temperature statuses increase
DB_LOW_MinscHideout_ValveTimerStatuses((ITEM)S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, "LOW_MINSCHIDEOUT_WATERVALVE_INCREASING", 12.0);
DB_LOW_MinscHideout_ValveTimerStatuses((ITEM)S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "LOW_MINSCHIDEOUT_TEMPERATUREVALVE_INCREASING", 6.0);

// Sluice gates
DB_LOW_MinscHideout_SluiceGates((ITEM)S_LOW_MinscHideout_SluiceGate_ec35b4be-09a3-4e59-bca8-d183b729542c, (ITEM)PUZ_InvisibleBlocker_2x2_1H_A_Dynamic_001_377d17cc-da68-4e34-9551-a811aeb74536);
DB_LOW_MinscHideout_SluiceGates((ITEM)S_LOW_MinscHideout_SluiceGate_Exit_5eb023b9-6a07-4635-8461-1ad56793f16e, (ITEM)PUZ_InvisibleBlocker_2x2_1H_A_Dynamic_000_9ad4cfdf-902a-4c3d-be9b-ba1569baab56);

// Sluice gate force valve
DB_KnowledgeCheckTrigger("LOW_MinscHideout_NoticeSluiceValve", (TRIGGER)S_LOW_MinscHideout_NoticeSluiceValveTrigger_46aa0f2c-a60e-4333-8073-00babd8d577a, "Perception", (DIFFICULTYCLASS)Act3_VeryEasy_b9cea18d-f40a-444d-a692-76582a69130c);
DB_KnowledgeCheckItem_AD("LOW_MinscHideout_ForceValveRoll", (ITEM)S_LOW_MinscHideout_SluiceValve_Entrance_cffe260f-c4ae-4138-ace0-263c8603dfea, "Athletics", (DIFFICULTYCLASS)Act3_VeryHard_60916b01-ba4c-418e-9f30-19a669704b4d, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_KnowledgeCheckItem_AD("LOW_MinscHideout_ForceValveRoll", (ITEM)S_LOW_MinscHideout_SluiceValve_Exit_f28c12a3-2b5a-4610-a60d-6c19f0c68266, "Athletics", (DIFFICULTYCLASS)Act3_VeryHard_60916b01-ba4c-418e-9f30-19a669704b4d, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

DB_LOW_MinscHideout_DisabledValves((ITEM)S_LOW_MinscHideout_SluiceValve_Broken_f9db1298-c539-4618-bf77-ab53d83d5e7a);
// Init
PROC_LOW_MinscHideout_InitSluiceGatePuzzle();
//END_REGION

//REGION Meeting
PROC_SetRelationMutual((FACTION)ACT3_LOW_MinscHideout_MinscsGang_2cc8f4c1-33ee-460b-9c0a-6f516cbbad1b, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);

DB_LOW_MinscHideout_TeleportParams((CHARACTER)S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047, (TRIGGER)S_LOW_MinscHideout_DopplegangerRetreatPoint_b501b673-b453-4fbe-b069-8ed616893c20);
DB_LOW_MinscHideout_TeleportParams((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (TRIGGER)S_LOW_MinscHideout_MinscRetreatPoint_df3a2aa8-e232-4100-9d53-578941868569);

DB_AddCharactersInTriggerToDialog(LOW_MinscHideout_RoahBribe_041941c1-00ba-ad43-6da9-6f7a597053b3, S_LOW_MinscHideout_MeetingSceneDialogTrigger_AddChars_fb8bb0b2-af42-4029-98d0-5fb2e195e086, 1);
DB_AddCharactersInTriggerToDialog(LOW_Minsc_SaveFromAbsolute_eeb5d970-975f-5f16-80ba-4aa54cb65702, S_LOW_MinscHideout_MeetingSceneDialogTrigger_AddChars_fb8bb0b2-af42-4029-98d0-5fb2e195e086, 1);
PROC_TriggerRegisterForParty(S_LOW_MinscHideout_MeetingSceneDialogTrigger_AddChars_fb8bb0b2-af42-4029-98d0-5fb2e195e086);

//END_REGION

//REGION Minsc relics and PADs
DB_LOW_MinscHideout_RelicVB((ITEM)S_LOW_MinscHideout_RelicAerie_4ff1a465-6de5-4e23-b4ee-8bda6749c401, (DIALOGRESOURCE)LOW_MinscHideout_PAD_RelicAerie_a49d82ff-5980-5a35-88e3-11fd33fb15ae, (VOICEBARKRESOURCE)LOW_MinscHideout_VB_RelicAerie_6c1dc1c0-1754-33c6-bdae-1ca538ea652b);
DB_LOW_MinscHideout_RelicVB((ITEM)S_LOW_MinscHideout_RelicDynaheir_bdb00280-abda-4405-9af7-f3a7573afeaa, (DIALOGRESOURCE)LOW_MinscHideout_PAD_RelicDynaheir_5921f4e8-060b-3a25-1e0a-99be4a18dde4, (VOICEBARKRESOURCE)LOW_MinscHideout_VB_RelicDynaheir_74405fb3-492d-f656-cf3e-fac4096fcea6);
DB_LOW_MinscHideout_RelicVB((ITEM)S_LOW_MinscHideout_RelicJan_8d5607f8-e1d3-40d4-892e-2ffe034046a4, (DIALOGRESOURCE)LOW_MinscHideout_PAD_RelicJan_4aec5dec-bc4d-dfe4-3fef-3ea22b0a8307, (VOICEBARKRESOURCE)LOW_MinscHideout_VB_RelicJan_74acd181-e4b8-c662-37ba-6f258cdc9b74);
DB_LOW_MinscHideout_RelicVB((ITEM)S_LOW_MinscHideout_RelicKeldorn_042a3ea0-0d44-4a10-82f5-ff4f0025a6e4, (DIALOGRESOURCE)LOW_MinscHideout_PAD_RelicKeldorn_6782682a-9afe-8da9-daa3-2bd1b166cecc, (VOICEBARKRESOURCE)LOW_MinscHideout_VB_RelicKeldorn_7731b78a-e725-0662-7571-421c2b11d71a);
DB_LOW_MinscHideout_RelicVB((ITEM)S_LOW_MinscHideout_RelicMazzy_b3598674-2d08-4ba9-b74b-64da605c9e0b, (DIALOGRESOURCE)LOW_MinscHideout_PAD_RelicMazzy_3d31f65c-abce-d355-2af3-1af831f255ef, (VOICEBARKRESOURCE)LOW_MinscHideout_VB_RelicMazzy_75dc9412-69ea-02db-077e-ed95bd6a253c);
//END_REGION

//REGION Combat reactions
DB_CombatReact_AD_OnDeathOther((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (CHARACTER)S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047, (DIALOGRESOURCE)LOW_MinscHideout_AD_MinscSeesNaheiraDie_678d96b9-d84e-74ab-5808-c190e9ba51d4);
DB_CombatReact_AD_OnDeathOther((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)LOW_MinscHideout_PAD_Jaheira_MinscDies_c9655ab3-3364-2308-6156-5540514fb8f3);
//END_REGION

//REGION Voice bark
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_LOW_MinscHideout_VB_Neighbourhood_123920b0-7013-49dc-9412-cffbc2d258be, (VOICEBARKRESOURCE)LOW_MinscHideout_VB_Neighbourhood_162ed6c4-fefe-e058-8a25-fe435674326c, "PerUserAndNearbyPlayers");
//END_REGION

//REGION Debug
PROC_LOW_MinscHideout_DelayedSetupZhentBribe();
//END_REGION
KBSECTION
//REGION Sluice Guards
IF
DB_LOW_MinscHideout_SluiceGuards(_Guard)
THEN
DB_Dialogs(_Guard, (DIALOGRESOURCE)LOW_MinscHideout_SluiceGuard_3c581210-b03a-c9ea-f267-6f401168667f);
DB_SpotPlayers(_Guard, "LOW_MinscHideout_SluiceGuardSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SpotPlayers_Spotted(_Guard, "LOW_MinscHideout_SluiceGuardSpotting", _Player)
AND
QRY_OnlyOnce("LOW_MinscHideout_StartSluiceGuardDialog")
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_MinscHideout_SluiceGuard_3c581210-b03a-c9ea-f267-6f401168667f, _Guard, _Player)
THEN
PROC_SetHostileToIndivPlayerFaction((FACTION)ACT3_LOW_MinscHideout_SluiceGuards_1c02c7b1-1b14-428b-bd68-be33ea90c1fa, _Player);

// After the fight started inside, the sluice guards go hostile as well, and will attack on sight.
PROC
PROC_LOW_MinscHideout_MinscFightStarted()
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_MinscHideout_SluiceGuards_1c02c7b1-1b14-428b-bd68-be33ea90c1fa, 0);
PROC_SpotPlayers_CleanupSpotting("LOW_MinscHideout_SluiceGuardSpotting");

// Bhaal cultist crows summoning spell
IF
DB_LOW_MinscHideout_SluiceGuards_Crows(_Crow,_)
THEN
SetOnStage(_Crow, 0);

IF
CastedSpell(_Cultist, "Target_LOW_BhaalCultist_RangersCompanion_Raven", _, _, _)
AND
DB_LOW_MinscHideout_SluiceGuards_Crows(_Crow,_SpawnPoint)
THEN
AppearAt(_Crow, _SpawnPoint, 1, DFLT_UTIL_Spawn_01_510ff37e-0618-40e4-8ce0-236e3dc9c291, "");

// Register that player is near SluiceGuard_002 and set flag
IF
DB_InRegion(_Player, S_LOW_MinscHideout_Box_PlayerNearSluiceGuard_002_667148a6-0b90-4c76-a30e-0ccf614c85e4)
AND
DB_Players(_Player)
AND
NOT DB_LOW_MinscHideout_PlayerNearSluiceGuard_002(_Player)
THEN
DB_LOW_MinscHideout_PlayerNearSluiceGuard_002(_Player);
PROC_GlobalSetFlagAndCache(LOW_MinscHideout_State_PlayerNearSluiceGuard_002_18cf4b81-0cae-4856-9d71-495359733d99);

// Register that player is no longer near SluiceGuard_002
IF
DB_LOW_MinscHideout_PlayerNearSluiceGuard_002(_Player)
AND
NOT DB_InRegion(_Player, S_LOW_MinscHideout_Box_PlayerNearSluiceGuard_002_667148a6-0b90-4c76-a30e-0ccf614c85e4)
THEN
NOT DB_LOW_MinscHideout_PlayerNearSluiceGuard_002(_Player);

// When the last player has left SluiceGuard_002, unset flag
IF
DB_GlobalFlag(LOW_MinscHideout_State_PlayerNearSluiceGuard_002_18cf4b81-0cae-4856-9d71-495359733d99)
AND
NOT DB_LOW_MinscHideout_PlayerNearSluiceGuard_002(_)
THEN
PROC_GlobalSetFlagAndCache(LOW_MinscHideout_State_PlayerNearSluiceGuard_002_18cf4b81-0cae-4856-9d71-495359733d99);
//END_REGION

//REGION Sluice Gate Puzzle
// The player has two valves to control - one for water level and one for temperature
// The temperature and water level increase at different rates and have 4 stages
// Getting both valves to Stage 2 solves the puzzle
// If a valve hits Stage 4 it is locked until the player uses a third valve to unlock it
//REGION Init Sluice Gate Puzzle
PROC
PROC_LOW_MinscHideout_InitSluiceGatePuzzle()
THEN
PROC_LOW_MinscHideout_InitValves();
PROC_LOW_MinscHideout_InitSluiceGates();

// Reset valves
PROC
PROC_LOW_MinscHideout_InitValves()
AND
DB_LOW_MinscHideout_Valves(_Valve)
AND
DB_LOW_MinscHideout_ValveStatuses(_Valve, _Status, _, _)
AND
DB_LOW_MinscHideout_ValveTimerStatuses(_Valve, _TimerStatus, _)
THEN
RemoveStatus(_Valve, _Status, _Valve);
RemoveStatus(_Valve, _TimerStatus, _Valve);
PROC_LOW_MinscHideout_SetValveIndicator((ITEM)_Valve, 0);

// Initialise tracking DBs
PROC
PROC_LOW_MinscHideout_InitValves()
AND
DB_LOW_MinscHideout_Valves(_Valve)
THEN
DB_LOW_MinscHideout_ValveLevel(_Valve, 0, 0);
DB_LOW_MinscHideout_ValveOpened(_Valve, 0);

// Singleton per valve for DB_LOW_MinscHideout_ValveOpened
IF
DB_LOW_MinscHideout_ValveOpened(_Valve, _IsOpened)
AND
DB_LOW_MinscHideout_ValveOpened(_Valve, _IsOpenedOld)
AND
_IsOpened != _IsOpenedOld
THEN
NOT DB_LOW_MinscHideout_ValveOpened(_Valve, _IsOpenedOld);

// Reset sluice gates
PROC
PROC_LOW_MinscHideout_InitSluiceGates()
THEN
PROC_LOW_MinscHideout_LockSluiceGate();
//END_REGION

//REGION Hot / Cold damage gameplay
IF
AttackedBy((ITEM)_Valve, _, _, "Fire", _, _, (INTEGER)_StoryActionID)
AND
DB_LOW_MinscHideout_Valves(_Valve)
THEN
ApplyStatus(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "LOW_MINSCHIDEOUT_TEMPERATUREVALVE_HEATUP", 6.0);

IF
AttackedBy((ITEM)_Valve, _, _, "Cold", _, _, (INTEGER)_StoryActionID)
AND
DB_LOW_MinscHideout_Valves(_Valve)
THEN
ApplyStatus(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "LOW_MINSCHIDEOUT_TEMPERATUREVALVE_COOLDOWN", 6.0);
//END_REGION

//REGION Sluice Gate Valve
PROC
PROC_GLO_KnowledgeCheckSuccess(_Player, "LOW_MinscHideout_NoticeSluiceValve", _)
THEN
StartVoiceBark((VOICEBARKRESOURCE)LOW_MinscHideout_VB_NoticeSluiceValve_e4d85178-a54f-9e7d-9249-56d7dc5c0f97, _Player);
PROC_PlayPerceptionRevealEffect(S_LOW_MinscHideout_SluiceValve_cffe260f-c4ae-4138-ace0-263c8603dfea, "LOW_MinscHideout_HighlightSluiceValve");

PROC
PROC_GLO_KnowledgeCheckSuccess(_Player, "LOW_MinscHideout_ForceValveRoll", _)
THEN
PROC_LOW_MinscHideout_UnlockSluiceGate();

PROC
PROC_GLO_KnowledgeCheckFailure(_Player, "LOW_MinscHideout_ForceValveRoll", _)
THEN
PROC_TryStartAD(GEN_AD_ItemBlocked_a4eb2e7b-809a-a9e4-94da-955a8ac9b8c6, _Player);

PROC
PROC_LOW_MinscHideout_LockSluiceGate()
AND
DB_LOW_MinscHideout_SluiceGates(_Gate, _InvisBlocker)
THEN
PROC_ItemCloseAndLock(_Gate, "NO_KEY");

PROC
PROC_LOW_MinscHideout_UnlockSluiceGate()
THEN
SetFlag((FLAG)LOW_MinscHideout_State_SluiceValveUnlocked_3501c02d-a13b-632a-0469-3625ac234715);
Open((ITEM)S_DoorPorxy_MinscPipeStart_6ec2bb61-0ef3-49d9-b448-38c94373447e);

PROC
PROC_LOW_MinscHideout_UnlockSluiceGate()
AND
DB_LOW_MinscHideout_Valves(_Valve)
AND
DB_LOW_MinscHideout_ValveTimerStatuses(_Valve, _Status, _)
THEN
RemoveStatus(_Valve, _Status, _Valve);

PROC
PROC_LOW_MinscHideout_UnlockSluiceGate()
AND
DB_LOW_MinscHideout_SluiceGates(_Gate, _InvisBlocker)
THEN
PlaySound(_Gate, "SE_CTY_SluiceValve_GateOpen");
PROC_ItemUnlockAndOpen(_Gate);

// Remove notice checks when puzzle is solved
PROC
PROC_LOW_MinscHideout_UnlockSluiceGate()
THEN
PROC_KnowledgeCheck_Clear((TRIGGER)S_LOW_MinscHideout_NoticeSluiceValveTrigger_46aa0f2c-a60e-4333-8073-00babd8d577a);
SetEntityEvent(S_LOW_MinscHideout_SluicePuzzleHint_a8bb0f44-7a68-484d-8a4b-e798d0e8e4ee, "StoryCancel", 1);

IF
Opened(_Gate)
AND
DB_LOW_MinscHideout_SluiceGates(_Gate, _InvisBlocker)
THEN
PROC_SetOnStage(_InvisBlocker, 0);

IF
Closed(_Gate)
AND
DB_LOW_MinscHideout_SluiceGates(_Gate, _InvisBlocker)
THEN
PROC_SetOnStage(_InvisBlocker, 1);

IF
DestroyedBy(_Gate, _, _, _)
AND
DB_LOW_MinscHideout_SluiceGates(_Gate, _InvisBlocker)
THEN
PROC_SetOnStage(_InvisBlocker, 0);

PROC
PROC_BlockUseOfItem(_Player, _Gate)
AND
DB_Players(_Player)
AND
DB_LOW_MinscHideout_SluiceGates(_Gate, _)
THEN
DB_CustomUseItemResponse(_Player, _Gate, 0);
PROC_TryStartAD((DIALOGRESOURCE)GEN_AD_ItemBlocked_a4eb2e7b-809a-a9e4-94da-955a8ac9b8c6, _Player);
//END_REGION

//REGION Pressure Valves
// Puzzle solution - unlocks the sluice gate valve
IF
StatusApplied(_Valve, _Status, _, _)
AND
DB_LOW_MinscHideout_ValveStatuses((ITEM)_Valve, _Status, _, 2)
AND
DB_LOW_MinscHideout_ValveStatuses(_OtherValve, _OtherStatus, _, 2)
AND
_Valve != _OtherValve
AND
HasActiveStatus(_OtherValve, _OtherStatus, 1)
AND
NOT GetStatusTurns(_OtherValve, _OtherStatus, -1)
THEN
RemoveStatus(_Valve, _Status, _Valve);
RemoveStatus(_OtherValve, _OtherStatus, _OtherValve);
ApplyStatus(_Valve, _Status, -1.0, 0, _Valve);
ApplyStatus(_OtherValve, _OtherStatus, -1.0, 0, _OtherValve);
DB_LOW_MinscHideout_ValveOpened(_Valve, 0);
DB_LOW_MinscHideout_ValveOpened(_OtherValve, 0);
PROC_LOW_MinscHideout_UnlockSluiceGate();

// Turn valve on or off
IF
UseStarted(_, _Valve)
AND
DB_LOW_MinscHideout_Valves(_Valve)
AND
NOT QRY_LOW_MinscHideout_ToggleValveOff(_Valve)
AND
DB_LOW_MinscHideout_ValveTimerStatuses(_Valve, _TimerStatus, _TimerStatusDuration)
THEN
DB_LOW_MinscHideout_ValveOpened(_Valve, 1);

QRY
QRY_LOW_MinscHideout_ToggleValveOff((ITEM)_Valve)
AND
DB_LOW_MinscHideout_ValveTimerStatuses(_Valve, _TimerStatus, _)
AND
HasActiveStatus(_Valve, _TimerStatus, 1)
THEN
DB_LOW_MinscHideout_ValveOpened(_Valve, 0);

IF
DB_LOW_MinscHideout_ValveOpened(_Valve, 1)
AND
DB_LOW_MinscHideout_ValveTimerStatuses(_Valve, _TimerStatus, _TimerStatusDuration)
THEN
ApplyStatus(_Valve, _TimerStatus, _TimerStatusDuration);

IF
DB_LOW_MinscHideout_ValveOpened(_Valve, 0)
AND
DB_LOW_MinscHideout_ValveTimerStatuses(_Valve, _TimerStatus, _TimerStatusDuration)
THEN
RemoveStatus(_Valve, _TimerStatus, _Valve);

// block interaction when valve is at overload status
PROC
PROC_BlockUseOfItem(_Player, _Valve)
AND
DB_LOW_MinscHideout_ValveStatuses(_Valve, _Status, _, 4)
AND
HasActiveStatus(_Valve, _Status, 1)
THEN
DB_CustomUseItemResponse(_Player, _Valve, 0);
PROC_TryStartAD((DIALOGRESOURCE)GEN_AD_ItemBlocked_a4eb2e7b-809a-a9e4-94da-955a8ac9b8c6, _Player);

// Release pressure - remove overload status and lower status by one
IF
UseStarted(_, (ITEM)S_LOW_MinscHideout_ReleaseValve_f5d649c0-05e6-4d01-ba38-6e3b5ea15584)
AND
DB_LOW_MinscHideout_Valves(_Valve)
AND
DB_LOW_MinscHideout_ValveStatuses(_Valve, _OverloadStatus, _, 4)
AND
HasActiveStatus(_Valve, _OverloadStatus, 1)
AND
DB_LOW_MinscHideout_ValveStatuses(_Valve, _Status, _StatusDuration, 3)
THEN
DB_LOW_MinscHideout_ValveOpened(_Valve, 0);
RemoveStatus(_Valve, _OverloadStatus, _Valve);
ApplyStatus(_Valve, _Status, _StatusDuration, 0, _Valve);
PlaySound(S_LOW_MinscHideout_ReleaseValve_f5d649c0-05e6-4d01-ba38-6e3b5ea15584, "SE_CTY_SluiceValve_ReleasePressure");

// Set valve indicator
IF
StatusApplied((ITEM)_Valve, (STRING)_Status, _, _)
AND
DB_LOW_MinscHideout_ValveStatuses(_Valve, _Status, _, _StageNum)
THEN
PROC_LOW_MinscHideout_SetValveIndicator(_Valve, _StageNum);

// Set valve indicator to 0 when low status dropped
IF
StatusRemoved((ITEM)_Valve, (STRING)_Status, _, _)
AND
DB_LOW_MinscHideout_ValveStatuses(_Valve, _Status, _, 1)
AND
DB_LOW_MinscHideout_ValveTimerStatuses(_Valve, _TimerStatus, _)
AND
HasActiveStatus(_Valve, _TimerStatus, 0)
THEN
PROC_LOW_MinscHideout_SetValveIndicator(_Valve, 0);

PROC
PROC_LOW_MinscHideout_SetValveIndicator((ITEM)_Valve, (INTEGER)_Level)
AND
DB_LOW_MinscHideout_ValveIndicators(_Valve, _Indicator)
THEN
SetAnimationEventInt(_Indicator, "LOW_MinscHideout_SetGuageLevel", _Level);

// Track current valve status
PROC
PROC_LOW_MinscHideout_SetValveIndicator((ITEM)_Valve, (INTEGER)_NewLevel)
AND
DB_LOW_MinscHideout_ValveLevel(_Valve, _OldLevel, _CurrentLevel)
THEN
NOT DB_LOW_MinscHideout_ValveLevel(_Valve, _OldLevel, _CurrentLevel);
DB_LOW_MinscHideout_ValveLevel(_Valve, _CurrentLevel, _NewLevel);

// PAD on overload
IF
StatusApplied((ITEM)_Valve, (STRING)_Status, _, _)
AND
DB_LOW_MinscHideout_ValveStatuses(_Valve, _Status, _, 4)
THEN
PROC_LOW_MinscHideout_ValveOverloaded(_Valve);

PROC
PROC_LOW_MinscHideout_ValveOverloaded((ITEM)_Valve)
AND
DB_Players(_Player)
AND
QRY_IsInRange(_Valve, _Player, 10.0)
AND
QRY_OnlyOnce("LOW_MinscHideout_PuzzleOverload_PAD")
THEN
PROC_TryStartAD(LOW_MinscHideout_PAD_SluiceValveOverloading_f4154b8e-ef50-7845-3e29-b1772ed5f167, _Player);
TimerLaunch("LOW_MinscHideout_PuzzleOverload_PAD", 20);

IF
TimerFinished("LOW_MinscHideout_PuzzleOverload_PAD")
AND
QRY_OnlyOnce_Reset("LOW_MinscHideout_PuzzleOverload_PAD")
THEN
DB_NOOP(1);

PROC
PROC_LOW_MinscHideout_ValveOverloaded((ITEM)S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087)
THEN
UseSpell(S_LOW_MinscHideout_Helper_WaterBlast_9c7751b5-f43d-4b1d-a24e-f5c131a36c99, "Zone_LOW_MinscHideout_SluiceValve_SteamBlast", S_LOW_MinscHideout_Poly_WaterSurface_07053a07-6389-47b2-8b28-40dd641123d4);

PROC
PROC_LOW_MinscHideout_ValveOverloaded((ITEM)S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8)
THEN
UseSpell(S_LOW_MinscHideout_Helper_FireBlast_1721384f-7e5e-4c92-9fe7-b124decb3dd1, "Zone_LOW_MinscHideout_SluiceValve_FireBlast", S_LOW_MinscHideout_Poly_FireSurface_db30158d-868c-4ccb-838b-df0b04b4c27c);

PROC
PROC_BlockUseOfItem(_Player, _Valve)
AND
DB_Players(_Player)
AND
DB_LOW_MinscHideout_DisabledValves(_Valve)
THEN
DB_CustomUseItemResponse(_Player, _Valve, 0);
PROC_TryStartAD((DIALOGRESOURCE)GEN_AD_ItemBlocked_a4eb2e7b-809a-a9e4-94da-955a8ac9b8c6, _Player);
//END_REGION

//REGION Sounds & Steam Effects
IF
DB_LOW_MinscHideout_ValveOpened(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, 1)
THEN
PlaySound(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "SE_CTY_SluiceValve_HeatIncrease_Loop");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Fire_Light_01_8b0565bf-49fd-d492-2d57-b5466b7bde0c, S_LOW_MinscHideout_Helper_HeatSteamLeak_002_b47bc411-ca2d-4f1b-a0e7-31f6f01e455a, "MinscHideout_SteamLeak_Valve", "CTY_Main_A", "");

IF
DB_LOW_MinscHideout_ValveOpened(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, 1)
THEN
PlaySound(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, "SE_CTY_SluiceValve_WaterThroughPipes_Loop");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Light_01_acdae0fb-4822-0ea6-fb71-2c7f9c7b36ae, S_LOW_MinscHideout_Helper_WaterSteamLeak_002_15628190-24c4-4fd3-841c-99299ea6d2ac, "MinscHideout_SteamLeak_Valve", "CTY_Main_A", "");

IF
DB_LOW_MinscHideout_ValveLevel(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, 2, 3)
THEN
PlaySound(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "SE_CTY_SluiceValve_MetalCreaking_Loop");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Fire_Medium_01_db7515c2-8fc3-d7c4-7e33-5445a0e0835b, S_LOW_MinscHideout_Helper_HeatSteamLeak_000_dccd9136-345a-4296-971b-fe9fc368ae3b, "MinscHideout_SteamLeak_Vat", "CTY_Main_A", "");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Fire_Medium_01_db7515c2-8fc3-d7c4-7e33-5445a0e0835b, S_LOW_MinscHideout_Helper_HeatSteamLeak_001_312ed4a9-8c4d-4432-9fad-7da68bcbc553, "MinscHideout_SteamLeak_Vat", "CTY_Main_A", "");

IF
DB_LOW_MinscHideout_ValveLevel(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, 2, 3)
THEN
PlaySound(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, "SE_CTY_SluiceValve_MetalBuckling_Loop");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Medium_01_0f60f2f7-e2c6-cbec-e984-dbf9ae12d9a6, S_LOW_MinscHideout_Helper_WaterSteamLeak_000_c1106307-2162-49d3-8f36-13b68552bcb9, "MinscHideout_SteamLeak_Vat", "CTY_Main_A", "");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Medium_01_0f60f2f7-e2c6-cbec-e984-dbf9ae12d9a6, S_LOW_MinscHideout_Helper_WaterSteamLeak_001_95d49db5-57e5-4117-ae91-cee36153280c, "MinscHideout_SteamLeak_Vat", "CTY_Main_A", "");

IF
DB_LOW_MinscHideout_ValveLevel(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, _, 4)
THEN
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_HeatSteamLeak_000_dccd9136-345a-4296-971b-fe9fc368ae3b, "MinscHideout_SteamLeak_Vat");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_HeatSteamLeak_001_312ed4a9-8c4d-4432-9fad-7da68bcbc553, "MinscHideout_SteamLeak_Vat");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Fire_Heavy_01_b0d5d3a9-1143-c51a-ffff-593e64b78c32, S_LOW_MinscHideout_Helper_HeatSteamLeak_000_dccd9136-345a-4296-971b-fe9fc368ae3b, "MinscHideout_SteamLeak_VatHeavy", "CTY_Main_A", "");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Fire_Heavy_01_b0d5d3a9-1143-c51a-ffff-593e64b78c32, S_LOW_MinscHideout_Helper_HeatSteamLeak_001_312ed4a9-8c4d-4432-9fad-7da68bcbc553, "MinscHideout_SteamLeak_VatHeavy", "CTY_Main_A", "");

IF
DB_LOW_MinscHideout_ValveLevel(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, _, 4)
THEN
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_WaterSteamLeak_000_c1106307-2162-49d3-8f36-13b68552bcb9, "MinscHideout_SteamLeak_Vat");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_WaterSteamLeak_001_95d49db5-57e5-4117-ae91-cee36153280c, "MinscHideout_SteamLeak_Vat");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Heavy_01_651be98b-b113-c838-7bce-785fe9179b38, S_LOW_MinscHideout_Helper_WaterSteamLeak_000_c1106307-2162-49d3-8f36-13b68552bcb9, "MinscHideout_SteamLeak_VatHeavy", "CTY_Main_A", "");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Heavy_01_651be98b-b113-c838-7bce-785fe9179b38, S_LOW_MinscHideout_Helper_WaterSteamLeak_001_95d49db5-57e5-4117-ae91-cee36153280c, "MinscHideout_SteamLeak_VatHeavy", "CTY_Main_A", "");

IF
DB_LOW_MinscHideout_ValveOpened(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, 0)
THEN
PlaySound(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "SE_CTY_SluiceValve_HeatIncrease_Loop_Stop");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_HeatSteamLeak_002_b47bc411-ca2d-4f1b-a0e7-31f6f01e455a, "MinscHideout_SteamLeak_Valve");

IF
DB_LOW_MinscHideout_ValveOpened(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, 0)
THEN
PlaySound(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, "SE_CTY_SluiceValve_WaterThroughPipes_Loop_Stop");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_WaterSteamLeak_002_15628190-24c4-4fd3-841c-99299ea6d2ac, "MinscHideout_SteamLeak_Valve");

IF
DB_LOW_MinscHideout_ValveLevel(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, 3, 2)
THEN
PlaySound(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, "SE_CTY_SluiceValve_MetalCreaking_Loop_Stop");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_HeatSteamLeak_000_dccd9136-345a-4296-971b-fe9fc368ae3b, "MinscHideout_SteamLeak_Vat");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_HeatSteamLeak_001_312ed4a9-8c4d-4432-9fad-7da68bcbc553, "MinscHideout_SteamLeak_Vat");

IF
DB_LOW_MinscHideout_ValveLevel(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, 3, 2)
THEN
PlaySound(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, "SE_CTY_SluiceValve_MetalBuckling_Loop_Stop");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_WaterSteamLeak_000_c1106307-2162-49d3-8f36-13b68552bcb9, "MinscHideout_SteamLeak_Vat");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_WaterSteamLeak_001_95d49db5-57e5-4117-ae91-cee36153280c, "MinscHideout_SteamLeak_Vat");

IF
DB_LOW_MinscHideout_ValveLevel(S_LOW_MinscHideout_TemperatureValve_2491b6ee-1538-44bf-8e1a-9edf131185a8, 4, _)
THEN
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_HeatSteamLeak_000_dccd9136-345a-4296-971b-fe9fc368ae3b, "MinscHideout_SteamLeak_VatHeavy");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_HeatSteamLeak_001_312ed4a9-8c4d-4432-9fad-7da68bcbc553, "MinscHideout_SteamLeak_VatHeavy");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Fire_Medium_01_db7515c2-8fc3-d7c4-7e33-5445a0e0835b, S_LOW_MinscHideout_Helper_HeatSteamLeak_000_dccd9136-345a-4296-971b-fe9fc368ae3b, "MinscHideout_SteamLeak_Vat", "CTY_Main_A", "");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Fire_Medium_01_db7515c2-8fc3-d7c4-7e33-5445a0e0835b, S_LOW_MinscHideout_Helper_HeatSteamLeak_001_312ed4a9-8c4d-4432-9fad-7da68bcbc553, "MinscHideout_SteamLeak_Vat", "CTY_Main_A", "");

IF
DB_LOW_MinscHideout_ValveLevel(S_LOW_MinscHideout_WaterValve_b7aacda4-3cfe-4cec-8c5b-8d78b3361087, 4, _)
THEN
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_WaterSteamLeak_000_c1106307-2162-49d3-8f36-13b68552bcb9, "MinscHideout_SteamLeak_VatHeavy");
PROC_StopLoopEffect(S_LOW_MinscHideout_Helper_WaterSteamLeak_001_95d49db5-57e5-4117-ae91-cee36153280c, "MinscHideout_SteamLeak_VatHeavy");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Medium_01_0f60f2f7-e2c6-cbec-e984-dbf9ae12d9a6, S_LOW_MinscHideout_Helper_WaterSteamLeak_000_c1106307-2162-49d3-8f36-13b68552bcb9, "MinscHideout_SteamLeak_Vat", "CTY_Main_A", "");
PROC_LoopEffect(VFX_Script_CTY_AbandonedCistern_Steam_Medium_01_0f60f2f7-e2c6-cbec-e984-dbf9ae12d9a6, S_LOW_MinscHideout_Helper_WaterSteamLeak_001_95d49db5-57e5-4117-ae91-cee36153280c, "MinscHideout_SteamLeak_Vat", "CTY_Main_A", "");

//END_REGION

//END_REGION

//REGION Meeting
// Minsc and Naheira flee to Abandoned Cistern
// Roah moves to Abandoned Cistern
// As long as Roah has not yet arrived, Minsc and Naheira will attack on sight
PROC
PROC_State_Changed(_, "LOW_Guildhall_State", "LOW_Guildhall_State_PostHeist")
THEN
PROC_LOW_MinscHideout_SetupMinscNaheira();

// Minsc and Doppelganger teleport to AC, will attack players on sight
PROC
PROC_LOW_MinscHideout_SetupMinscNaheira()
THEN
PROC_LOW_MinscHideout_TeleportMinscNaheira();
SetFaction(S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047, (FACTION)ACT3_LOW_MinscHideout_MinscsGang_2cc8f4c1-33ee-460b-9c0a-6f516cbbad1b);
SetFaction(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (FACTION)ACT3_LOW_MinscHideout_MinscsGang_2cc8f4c1-33ee-460b-9c0a-6f516cbbad1b);

PROC
PROC_LOW_MinscHideout_TeleportMinscNaheira()
AND
DB_LOW_MinscHideout_TeleportParams(_Character, _Location)
THEN
PROC_LOW_MinscHideout_TeleportCharacter(_Character);

PROC
PROC_LOW_MinscHideout_TeleportCharacter((CHARACTER)_Character)
AND
DB_LOW_MinscHideout_TeleportParams(_Character, _Location)
THEN
DB_LOW_MinscHideout_TeleportingToHideout(_Character);
PROC_Poof(_Character, VFX_Script_Minsc_Teleport_Disappear_4d3bdeed-c0d0-57a7-8074-c27a850c66d4);

IF
WentOnStage((CHARACTER)_Character, 0)
AND
DB_LOW_MinscHideout_TeleportingToHideout(_Character)
AND
DB_LOW_MinscHideout_TeleportParams(_Character, _Location)
THEN
TeleportTo(_Character, _Location, "LOW_MinscHideout_Teleported");

IF
EntityEvent((CHARACTER)_Character, "LOW_MinscHideout_Teleported")
AND
DB_LOW_MinscHideout_TeleportingToHideout(_Character)
THEN
SetCombatGroupID(_Character, "93263aca-71b3-0838-a35d-2f2c90a2f89d");
PROC_SetOnStage(_Character, 1);
PlayEffect(_Character, VFX_Script_Minsc_Teleport_Appear_522cf31a-7a74-ea02-a6ab-acfc98d2756d, "");
NOT DB_LOW_MinscHideout_TeleportingToHideout(_Character);

PROC
PROC_State_Changed(_, "LOW_Guildhall_State", "LOW_Guildhall_State_PostHeist")
AND
DB_LOW_Guildhall_ZhentRepresentative(_Leader)
AND
NOT DB_LOW_MinscHideout_ZhentLeaderMoving(1)
THEN
TeleportTo(_Leader, S_LOW_MinscHideout_SecretExit_8a513e19-26eb-4b5a-b861-654d4d08a80f, "LOW_MinscHideout_PreCoup_ZhentLeaderArriving");
PROC_SetOnStage(_Leader, 1);
DB_LOW_MinscHideout_ZhentLeaderMoving(1);

// Zhent leader arrives at Abandoned Cistern, set combat group so she joins combat in progress.
IF
EntityEvent((CHARACTER)_Leader, "LOW_MinscHideout_PreCoup_ZhentLeaderArriving")
THEN
SetFaction(_Leader, (FACTION)ACT3_LOW_MinscHideout_MinscsGang_2cc8f4c1-33ee-460b-9c0a-6f516cbbad1b);
SetCombatGroupID(_Leader, "93263aca-71b3-0838-a35d-2f2c90a2f89d");
PROC_CharacterMoveTo(_Leader, S_LOW_MinscHideout_RoahMeetingPoint_faa1fd32-afa3-46af-87c4-400b366a1c32, "Walk", "LOW_MinscHideout_PreCoup_ZhentLeaderArrived");

// Zhent leader has arrived, dialog will start instead of combat when players gets close
IF
EntityEvent((CHARACTER)_Leader, "LOW_MinscHideout_PreCoup_ZhentLeaderArrived")
THEN
NOT DB_LOW_MinscHideout_ZhentLeaderMoving(1);
PROC_State_Progress(S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae, "LOW_Guildhall_State", "LOW_Guildhall_State_PreCoup");

// If the PostHeist state was skipped, quickly setup Zhent leader
PROC
PROC_State_Changed(_, "LOW_Guildhall_State", "LOW_Guildhall_State_PreHeist", "LOW_Guildhall_State_PreCoup")
AND
DB_LOW_Guildhall_ZhentRepresentative(_Leader)
THEN
PROC_LOW_MinscHideout_SetupMinscNaheira();
PROC_SetOnStage(_Leader, 1);
SetFaction(_Leader, (FACTION)ACT3_LOW_MinscHideout_MinscsGang_2cc8f4c1-33ee-460b-9c0a-6f516cbbad1b);
SetCombatGroupID(_Leader, "93263aca-71b3-0838-a35d-2f2c90a2f89d");
TeleportTo(_Leader, S_LOW_MinscHideout_RoahMeetingPoint_faa1fd32-afa3-46af-87c4-400b366a1c32);

// Use overloaded version of PROC_State_Changed to make sure they happen in the correct order
PROC
PROC_State_Changed(_, "LOW_Guildhall_State", _, "LOW_Guildhall_State_PreCoup")
AND
DB_LOW_Guildhall_ZhentRepresentative(_Leader)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_MinscHideout_MinscsGang_2cc8f4c1-33ee-460b-9c0a-6f516cbbad1b, 50);
PROC_SceneDialogOnly("LOW_MinscHideout_ZhentBribe", (CHARACTER)_Leader, (TRIGGER)S_LOW_MinscHideout_MeetingSceneDialogTrigger_8796be50-6ccc-40f9-8c79-03e1467c80bb);
PROC_SceneDialogOnly("LOW_MinscHideout_ZhentBribe", (CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (TRIGGER)S_LOW_MinscHideout_MeetingSceneDialogTrigger_8796be50-6ccc-40f9-8c79-03e1467c80bb);
PROC_SceneDialogOnly("LOW_MinscHideout_ZhentBribe", (CHARACTER)S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047, (TRIGGER)S_LOW_MinscHideout_MeetingSceneDialogTrigger_8796be50-6ccc-40f9-8c79-03e1467c80bb);
DB_OneShotPlayerTrigger((TRIGGER)S_LOW_MinscHideout_MeetingSceneDialogTrigger_8796be50-6ccc-40f9-8c79-03e1467c80bb);

// If Zhent leader enters combat while moving, stop the movement, Zhent leader will fight with Minsc / Naheira
IF
EnteredCombat((CHARACTER)_Leader, _)
AND
DB_LOW_Guildhall_ZhentRepresentative(_Leader)
AND
DB_LOW_MinscHideout_ZhentLeaderMoving(1)
THEN
PROC_ClearStoryMove(_Leader);
NOT DB_LOW_MinscHideout_ZhentLeaderMoving(1);
PROC_LOW_MinscHideout_ZhentLeaderEscaping();

// Start Zhent Bribe scene with Roah
PROC
PROC_OneShotTriggerEntered((CHARACTER)_Player, (TRIGGER)S_LOW_MinscHideout_MeetingSceneDialogTrigger_8796be50-6ccc-40f9-8c79-03e1467c80bb)
AND
DB_LOW_Guildhall_ZhentRepresentative(S_GOB_Quartermaster_646936f3-8d8d-484e-9361-cd1ed484c615)
AND
DB_SceneTriggerManager("LOW_MinscHideout_ZhentBribe", _, _)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_MinscHideout_RoahBribe_041941c1-00ba-ad43-6da9-6f7a597053b3,
	S_GOB_Quartermaster_646936f3-8d8d-484e-9361-cd1ed484c615,
	NULL_00000000-0000-0000-0000-000000000000,
	S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,
	S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047,
	_Player)
THEN
PROC_LOW_MinscHideout_FightStarts();

// Start Zhent Bribe scene with Boss Friol
PROC
PROC_OneShotTriggerEntered((CHARACTER)_Player, (TRIGGER)S_LOW_MinscHideout_MeetingSceneDialogTrigger_8796be50-6ccc-40f9-8c79-03e1467c80bb)
AND
DB_LOW_Guildhall_ZhentRepresentative(S_LOW_Guildhall_Zhent_Leader_b7e51fc3-0788-44f2-add7-1714f2b9b6d9)
AND
DB_SceneTriggerManager("LOW_MinscHideout_ZhentBribe", _, _)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_MinscHideout_RoahBribe_041941c1-00ba-ad43-6da9-6f7a597053b3,
	NULL_00000000-0000-0000-0000-000000000000,
	S_LOW_Guildhall_Zhent_Leader_b7e51fc3-0788-44f2-add7-1714f2b9b6d9,
	S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,
	S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047,
	_Player)
THEN
PROC_LOW_MinscHideout_FightStarts();

// When Minsc spots players during Bribe scene, player won't get the chance to hide.
PROC
PROC_OneShotTriggerEntered((CHARACTER)_Player, (TRIGGER)S_LOW_MinscHideout_MeetingSceneDialogTrigger_8796be50-6ccc-40f9-8c79-03e1467c80bb)
THEN
DB_SpotPlayers(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Players", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotterIgnoreCantTalk(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Players");
DB_SpotPlayers_TargetIgnoreCantTalk(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Players");
DB_SpotPlayers_IncludeWildshapedPlayers(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Players");
DB_SpotPlayers_IncludeSummons(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Players");
DB_SpotPlayers_IncludeFollowers(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Players");

PROC
PROC_SpotPlayers_Spotted(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Players", _Player)
THEN
SetFlag((FLAG)LOW_MinscHideout_State_PlayerSpottedDuringBribe_9f2066b4-4fb9-622b-367e-7e54facf09e1);

// Naheira hands bag of gold to Zhent leader
IF
FlagSet(LOW_MinscHideout_Event_NaheiraGivesGoldTo_f5b4f7cc-e60e-4d91-6660-8b0cc3f28b89, _ZhentLeader, _)
AND
DB_LOW_Guildhall_ZhentLeader((CHARACTER)_ZhentLeader)
AND
IsInInventoryOf((ITEM)S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d, (CHARACTER)S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047, 1)
THEN
ToInventory((ITEM)S_LOW_CountingHouse_StolenGoldBag_d31cdfbd-daea-4188-b685-38b708143a8d, (CHARACTER)_ZhentLeader, 1, 0, 1);

// Minsc reacts to seeing Jaheira and Naheira (doppelganger that looks like Jaheira)
IF
EnteredCombat((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, _CombatID)
AND
NOT DB_GlobalFlag((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20)
THEN
PROC_LOW_MinscHideout_MinscFightStarted();
DB_LOW_MinscHideout_MinscFightStarted(_CombatID);
PROC_SpotPlayers_CleanupSpotting("Minsc_Spotting_Players");

IF
CombatEnded(_CombatID)
AND
DB_LOW_MinscHideout_MinscFightStarted(_CombatID)
THEN
NOT DB_LOW_MinscHideout_MinscFightStarted(_CombatID);

// Set up combat spots
PROC
PROC_LOW_MinscHideout_MinscFightStarted()
THEN
DB_SpotPlayers(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Jaheira", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Jaheira");
DB_SpotPlayers_HasTag(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Jaheira", (TAG)JAHEIRA_2c948b46-0d8a-426b-ad8b-5f41233df4c1, 1);
DB_SpotPlayers_IgnoreCombat(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Jaheira");
DB_SpotPlayers(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Naheira", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeExtra(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Naheira", S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047);
DB_SpotPlayers_Continuous(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Naheira");
DB_SpotPlayers_IgnoreCombat(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Naheira");
DB_SpotPlayers_IncludeDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Naheira");
DB_SpotPlayers_TargetIgnoreCantTalk(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Naheira");

// Minsc reacts to seeing Jaheira and Naheira together
IF
DB_SpotPlayers_Spotted((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Naheira", (CHARACTER)S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047)
AND
DB_SpotPlayers_Spotted((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "Minsc_Spotting_Jaheira", (CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_GlobalFlag((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20)
THEN
DB_CombatReact_AD_OnNextTurn((GUIDSTRING)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)LOW_MinscHideout_AD_MinscSeesTwoJaheiras_8fecde5c-0d61-898a-1efe-2ac3e0b94b6f);
PROC_SpotPlayers_CleanupSpotting("Minsc_Spotting_Jaheira");
PROC_SpotPlayers_CleanupSpotting("Minsc_Spotting_Naheira");
PROC_SpotPlayers_CleanupSpotting("Jaheira_Spotting_Minsc");

// clean up Minsc making an offhand comment about seeing two Jaheiras if Naheira dies.
IF
DB_PermaDefeated(S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047)
THEN
NOT DB_CombatReact_AD_OnNextTurn((GUIDSTRING)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)LOW_MinscHideout_AD_MinscSeesTwoJaheiras_8fecde5c-0d61-898a-1efe-2ac3e0b94b6f);
PROC_SpotPlayers_CleanupSpotting("Minsc_Spotting_Jaheira");
PROC_SpotPlayers_CleanupSpotting("Minsc_Spotting_Naheira");
PROC_SpotPlayers_CleanupSpotting("Jaheira_Spotting_Minsc");

// Jaheira looking for Minsc
IF
EnteredCombat((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20)
AND
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
DB_SpotPlayers(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Jaheira_Spotting_Minsc", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeExtra(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Jaheira_Spotting_Minsc", (CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
DB_SpotPlayers_Continuous(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Jaheira_Spotting_Minsc");
DB_SpotPlayers_HasTag(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Jaheira_Spotting_Minsc", (TAG)MINSC_26fb71ce-d2c8-44b5-90d6-cb08705cb531, 1);
DB_SpotPlayers_IgnoreCombat(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Jaheira_Spotting_Minsc");

// Jaheira reacts to seeing Minsc, asking the player to knock him out and not kill him.
IF
DB_SpotPlayers_Spotted((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "Jaheira_Spotting_Minsc", (CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_GlobalFlag((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20)
THEN
DB_CombatReact_AD_OnNextTurn((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (DIALOGRESOURCE)LOW_MinscHideout_PAD_Jaheira_PleadingSaveMinsc_f04b7667-ed80-21b0-5c47-b0f8bc7f2161);
PROC_SpotPlayers_CleanupSpotting("Jaheira_Spotting_Minsc");

// Show non-lethal tutorial after Jaheira asked to knock out Minsc
IF
TurnStarted(_Player)
AND
DB_LOW_MinscHideout_MinscFightStarted(_CombatID)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
DB_Players((CHARACTER)_Player)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_ShowUnifiedTutorialForPlayer((CHARACTER)_Player, (UNIFIEDTUTORIAL)Non_Lethal_Attacks_140eab81-0fe8-4c8b-8b28-1b4b632cda3e);
DB_LOW_MinscHideout_ShowingNonLethalTutorial((CHARACTER)_Player);

IF
TurnEnded(_Player)
AND
DB_LOW_MinscHideout_ShowingNonLethalTutorial((CHARACTER)_Player)
THEN
HideTutorial((CHARACTER)_Player, (UNIFIEDTUTORIAL)Non_Lethal_Attacks_140eab81-0fe8-4c8b-8b28-1b4b632cda3e);
NOT DB_LOW_MinscHideout_ShowingNonLethalTutorial(_Player);

IF
DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_LOW_MinscHideout_CleanupEvilMinscCombatADs();

IF
FlagSet((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20, _, _)
THEN
PROC_GLO_DifficultyModes_AddPlayerBonuses((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
PROC_LOW_MinscHideout_CleanupEvilMinscCombatADs();

// Add 100 timer to cleanup logic to ensure cleanup happens all the needed ADs played
PROC
PROC_LOW_MinscHideout_CleanupEvilMinscCombatADs()
THEN
TimerLaunch("LOW_MinscHideout_CleanupEvilMinscCombatADs", 1000);

IF
TimerFinished("LOW_MinscHideout_CleanupEvilMinscCombatADs")
THEN
PROC_SpotPlayers_CleanupSpotting("Minsc_Spotting_Jaheira");
PROC_SpotPlayers_CleanupSpotting("Minsc_Spotting_Naheira");
PROC_SpotPlayers_CleanupSpotting("Jaheira_Spotting_Minsc");
NOT DB_CombatReact_AD_OnDeathOther((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (CHARACTER)S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047, (DIALOGRESOURCE)LOW_MinscHideout_AD_MinscSeesNaheiraDie_678d96b9-d84e-74ab-5808-c190e9ba51d4);
NOT DB_CombatReact_AD_OnNextTurn((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)LOW_MinscHideout_AD_MinscSeesTwoJaheiras_8fecde5c-0d61-898a-1efe-2ac3e0b94b6f);
NOT DB_CombatReact_AD_OnDeathOther((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)LOW_MinscHideout_PAD_Jaheira_MinscDies_c9655ab3-3364-2308-6156-5540514fb8f3);
NOT DB_CombatReact_AD_OnNextTurn((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (DIALOGRESOURCE)LOW_MinscHideout_PAD_Jaheira_PleadingSaveMinsc_f04b7667-ed80-21b0-5c47-b0f8bc7f2161);

IF
DialogEnded((DIALOGRESOURCE)LOW_MinscHideout_RoahBribe_041941c1-00ba-ad43-6da9-6f7a597053b3, _)
THEN
PROC_LOW_MinscHideout_FightStarts();

PROC
PROC_LOW_MinscHideout_FightStarts()
THEN
PROC_SceneOver("LOW_MinscHideout_ZhentBribe");
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_MinscHideout_MinscsGang_2cc8f4c1-33ee-460b-9c0a-6f516cbbad1b, 0);
PROC_LOW_MinscHideout_ZhentLeaderEscaping();

IF
EnteredCombat(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, _)
AND
DB_SceneTriggerManager("LOW_MinscHideout_ZhentBribe", _, _)
THEN
PROC_SceneOver("LOW_MinscHideout_ZhentBribe");

PROC
PROC_LOW_MinscHideout_ZhentLeaderEscaping()
THEN
SetFlag((FLAG)LOW_MinscHideout_State_ZhentLeaderEscaping_4333a451-024f-4c41-aea1-7046afdf0b4a);

IF
FlagSet((FLAG)LOW_MinscHideout_State_ZhentLeaderEscaped_0a08b808-b6e2-4923-936c-c12f2774ce61, _, _)
AND
DB_LOW_Guildhall_ZhentRepresentative(_Leader)
THEN
SetFaction(_Leader, (FACTION)ACT3_LOW_Guildhall_Zhent_0a9246a5-88ee-4b47-85d4-c86aba7d62dd);

IF
DialogEnded((DIALOGRESOURCE)LOW_MinscHideout_RoahBribe_041941c1-00ba-ad43-6da9-6f7a597053b3, _ID)
AND
DB_GlobalFlag((FLAG)LOW_MinscsHideout_State_PlayerInterfered_c3df81f4-d6d2-8563-b971-730c61de99b7)
AND
DB_DialogPlayers(_ID, _Player, _)
THEN
EnterCombat(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, _Player);

PROC
PROC_SceneOver("LOW_MinscHideout_ZhentBribe")
THEN
PROC_RemoveDialog(S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047);
PROC_RemoveDialog(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
DB_SpotPlayers((CHARACTER)S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047, "LOW_MinscHideout_JaheiraCloneSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_Dialogs(S_LOW_CountingHouse_JaheiraClone_4da802f5-3237-40b8-afff-d728016e3047, (DIALOGRESOURCE)LOW_MinscHideout_JaheiraDoppelganger_c219aa04-4d87-9e92-579d-28e89ac3bb55);

PROC
PROC_SpotPlayers_Spotted(_JaheiraClone, "LOW_MinscHideout_JaheiraCloneSpotting", _Player)
AND
NOT QRY_StartDialog((DIALOGRESOURCE)LOW_MinscHideout_JaheiraDoppelganger_c219aa04-4d87-9e92-579d-28e89ac3bb55, _JaheiraClone, _Player)
THEN
PROC_LOW_MinscHideout_FightStarts();
//END_REGION

//REGION Boo comes to Minsc if he dies before being saved
IF
DB_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_GlobalFlag((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20)
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3)
THEN
PROC_LOW_MinscHideout_BooComesToMinscCorpse();

// TODO: Make it work when Minsc dies not in the Cistern
PROC
PROC_LOW_MinscHideout_BooComesToMinscCorpse()
THEN
TeleportTo(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, S_LOW_MinscHideout_BooCaveEntrance_0549affd-3bca-41da-8609-6c1272e5c809, "LOW_MinscHideout_MinscDeath_BooTeleportedToCaveEntrance");

IF
EntityEvent(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, "LOW_MinscHideout_MinscDeath_BooTeleportedToCaveEntrance")
THEN
PROC_SetOnStage(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, 1);
ObjectTimerLaunch(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, "LOW_MinscHideout_MinscDeath_WaitsToSqueakAngrily", 2000);

IF
ObjectTimerFinished(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, "LOW_MinscHideout_MinscDeath_WaitsToSqueakAngrily")
THEN
PROC_TryStartAD(LOW_MinscHideout_AD_MinscDied_BooAngry_15c5dcd7-c7e4-8987-815e-deb168d149c5, S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3);
DB_AD_Dialog(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, LOW_MinscHideout_AD_MinscDied_BooAngry_15c5dcd7-c7e4-8987-815e-deb168d149c5);

// Boo goes offstage after long rest
PROC
PROC_LongRest()
AND
DB_GlobalFlag((FLAG)LOW_MinscHideout_BooSittingAtMinscCorpse_f0a36d0c-70cb-4987-9332-36e5989d3327)
AND
QRY_OnlyOnce("LOW_MinscHideout_BooAtMinscBody_GoesOffStage")
THEN
PROC_SetOnStage(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, 0);
//END_REGION

//REGION Minsc relics
IF
DB_LOW_MinscHideout_RelicPADQueue(_NewPlayer)
AND
DB_LOW_MinscHideout_RelicPADQueue(_OldPlayer)
AND
_NewPlayer != _OldPlayer
THEN
NOT DB_LOW_MinscHideout_RelicPADQueue(_OldPlayer);

IF
AutomatedDialogEnded(_AD,_)
AND
DB_ItemDialog_NarratorAD(_Relic, _AD)
AND
DB_LOW_MinscHideout_RelicVB(_Relic, _, _VB)
AND
DB_LOW_MinscHideout_RelicPADQueue(_Player)
THEN
StartVoiceBark(_VB, _Player);
NOT DB_LOW_MinscHideout_RelicPADQueue(_Player);

IF
UseFinished((CHARACTER)_Player, (ITEM)_Relic, 1)
AND
DB_Players(_Player)
AND
DB_LOW_MinscHideout_RelicVB(_Relic, _, _VB)
THEN
DB_LOW_MinscHideout_RelicPADQueue(_Player);
//END_REGION

//REGION Debug
IF
TextEvent("MinscHideout_PostHeist")
THEN
PROC_State_Progress(S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae, "LOW_Guildhall_State", "LOW_Guildhall_State_PostHeist");

IF
TextEvent("MinscHideout_SetupRoahBribe")
THEN
PROC_State_Progress(S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae, "LOW_Guildhall_State", "LOW_Guildhall_State_PreCoup");

IF
FlagSet((FLAG)Debug_Teleport_LOW_AbandonedCisternSetupZhentBribe_274c43f5-6fa9-417a-be07-6a75edb31445, _, _)
THEN
PROC_LOW_MinscHideout_SetupZhentBribe();

PROC
PROC_LOW_MinscHideout_SetupZhentBribe()
THEN
ClearFlag((FLAG)Debug_Teleport_LOW_AbandonedCisternSetupZhentBribe_274c43f5-6fa9-417a-be07-6a75edb31445);
PROC_State_Progress(S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae, "LOW_Guildhall_State", "LOW_Guildhall_State_PreCoup");

// Check if debug flag is set after loading level
PROC
PROC_LOW_MinscHideout_DelayedSetupZhentBribe()
AND
DB_GlobalFlag((FLAG)Debug_Teleport_LOW_AbandonedCisternSetupZhentBribe_274c43f5-6fa9-417a-be07-6a75edb31445)
THEN
PROC_LOW_MinscHideout_SetupZhentBribe();


//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
