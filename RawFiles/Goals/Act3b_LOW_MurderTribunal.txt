Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Journal support
DB_BookFlags((ITEM)S_LOW_MurderTribunal_MapBhaalTemple_4bedc6ee-5ea8-4dde-afa8-356b336aa254,(FLAG)LOW_MurderTribunal_Knows_BhaalTempleLocationByMap_2fe05720-c4f4-4f03-8495-f489baaabb1b);
DB_BookFlags((ITEM)S_LOW_MurderTribunal_MapBhaalTemple_4bedc6ee-5ea8-4dde-afa8-356b336aa254,(FLAG)LOW_MurderTribunal_Knows_BhaalTempleLocation_0a45cd29-8ae1-43bb-9ef6-b95af1dc6e55);

//END_REGION

PROC_TriggerRegisterForParty(S_LOW_MurderTribunal_SUB_c1739d1e-2f74-400d-8895-7c6cb42cda45);
PROC_TriggerRegisterForParty(S_LOW_MurderTribunal_DolorDeathKnightAD_Box_4c0e91b2-688b-4e27-9d14-360af201c92a);
PROC_TriggerRegisterForParty(S_LOW_MurderTribunal_Cultists_Appear_Trigger_db91a5d9-7c60-42ce-b8f1-a3e7e9199372);
PROC_TriggerRegisterForParty(S_LOW_MurderTribunal_Cultists_Chant_Trigger_a1ab1dbd-f255-4249-800b-98599cc63a35);
SetOnStage(S_LOW_MurderTribunal_Baptism_Chain01_Spring_b947aefe-9626-4c2a-a524-24cbb32d40f4,0);
TriggerRegisterForCharacter(S_LOW_MurderTribunal_Baptism_Sarevok_Box_f13624f9-c9b8-45e2-80bd-7c627342b706,(CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6);
TriggerRegisterForCharacter(S_LOW_MurderTribunal_Dolor_InTribunal_Box_e98b19b8-bed1-46da-9a05-82b24931fc0c,(CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
DB_DangerZone(S_LOW_MurderTribunal_Dangerzone_Box_5c8afd36-49f9-4a35-881d-d997f22542b4,"LOW_MurderTribunal");
TriggerRegisterForItems(S_LOW_MurderTribunal_Painting_Button_Trigger_72780e45-eebe-4f84-bac6-08d9fc5ec8a9);

DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_Event_DeathKnight_GrantedEntry_cbeb9b91-7037-97fb-de76-913f5dbb8b95,	(FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585);
DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_Event_DeathKnight_GrantedEntry_cbeb9b91-7037-97fb-de76-913f5dbb8b95,	(FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936);
DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_Event_AttackDolor_017a5e54-59f1-47ad-ab42-46767d80c929,				(FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585);
DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8,			(FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936);
DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729,		(FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936);
DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_Event_CancelHostileAfterDialog_2c5728fe-f668-690c-09d6-532cf498043e,	(FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936);
DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_Event_CancelHostileAfterDialog_2c5728fe-f668-690c-09d6-532cf498043e,	(FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585);
DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_State_SparedSarevok_3b0afae3-2cf9-cb4b-2a04-31c0223bea7d,			(FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936);
DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_State_SparedSarevok_3b0afae3-2cf9-cb4b-2a04-31c0223bea7d,			(FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585);
DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_Event_FightJaheiraMinsc_0b839488-81cb-dea0-5e3f-5e033a6d1e49,		(FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936);

DB_HostileToPlayerGroupCancelFlag((FLAG)LOW_MurderTribunal_Event_CancelDolorHostility_155b83ba-7e81-2ced-1924-fa108f49677c,		(FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928);

DB_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_DolorMurdersTribunal_6256e7e2-056a-03c6-2905-42522d923dc5,(DIALOGRESOURCE)LOW_MurderTribunal_Dolor_85388168-0bcd-ade7-2857-1c2d4cb130ea);
DB_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8,(DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90);
DB_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_ValeriaLeavesTribunal_57a75bf2-2648-c9f8-e75e-8366c582225e,(DIALOGRESOURCE)LOW_MurderTribunal_Valeria_b16af572-5cc7-ac8c-15a8-2ca2e68b9da2);
DB_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_DeathKnight_GrantedEntry_cbeb9b91-7037-97fb-de76-913f5dbb8b95,(DIALOGRESOURCE)LOW_MurderTribunal_DeathKnight_f3447992-8cd4-35d9-8aa9-d96bc7692e13);
DB_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_FightJaheiraMinsc_0b839488-81cb-dea0-5e3f-5e033a6d1e49,(DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90);
DB_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_TombstoneShop_OpenDoor_88043f62-c9c5-3aa1-4995-02346a6b45b7,(DIALOGRESOURCE)LOW_MurderTribunal_TombstoneShop_Password_306b1e62-ae1d-2a69-2166-48b3c3c55125);
DB_FlagReactionAfterDialog(LOW_MurderTribunal_Event_GiveBhaalAmulet_51ae9508-df79-2849-21a0-9f9aae78d727,(DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1);
DB_FlagReactionAfterDialog(LOW_Sarevok_BloodBaptism_HasMet_61f94311-a251-41fb-3141-4c933b260587,(DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1);
DB_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_AttackValeriaAfterDialog_af27add8-8783-9f1d-f93a-b8e12b677d5a,(DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1);

SetOnStage(S_LOW_MurderTribunal_DukeStelmane_f4856724-d8a9-4fa4-88c4-d8bd0dfc2d91,0);
SetOnStage(S_LOW_MurderTribunal_MurderMerchant_68a568cd-1e5e-46f1-9c5f-53d3eed23bd5,0);
SetCanInteract(S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf,0);
SetCanInteract(S_LOW_MurderTribunal_CellarDoor_1aa896d7-f2ad-4430-ab90-2dd00c876145,0);

//TODO: summons/followers

DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_MurderTribunal_Cultists",LOW_MurderTribunal_State_CultistsDefeated_0ac0051c-8748-4bff-a0f5-40cedfc178a8);
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_MurderTribunal_Bhaalists",LOW_MurderTribunal_State_BhaalistsDefeated_4f6e1415-fd18-4179-ab94-3efa59a2d1e9);
DB_GLO_DefeatCounter_AllDeadGlobalFlag("LOW_MurderTribunal_Bhaalists",LOW_MurderTribunal_State_BhaalistsDead_afe8bfd0-4369-4169-8191-109d2356051b);
DB_GLO_DefeatCounter_AllDefeatedGlobalFlag("LOW_MurderTribunal_DeathKnights",LOW_MurderTribunal_State_DeathKnightsDefeated_e7cf2480-e981-45bd-80f1-740661f49ed9);

//For reactivity in Bhaal Temple
DB_DeadOnceFlag((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_Sarevok_State_Dead_e9d30711-af25-4ba9-813e-cc7c131b17b6);
DB_HasItemEvent((ITEM)S_LOW_MurderTribunal_Courtroom_Key_1adad160-50ee-4027-b786-403a793d36a0,LOW_MurderTribunal_State_HasCourtroomDoorKey_86306f9e-d97d-41a6-b2ab-dfc3a8565775);

DB_Dialogs(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90);

Equip((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,S_LOW_MurderTribunal_BhaalAmulet_Sarevok_305049b2-b725-4e84-8f47-84fac8ea51f1);

//DB_LOW_MurderTribunal_DeathKnights(_DeathKnight)
DB_LOW_MurderTribunal_DeathKnights((CHARACTER)S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6);
DB_LOW_MurderTribunal_DeathKnights((CHARACTER)S_LOW_MurderTribunal_DeathKnight_Weak001_55c50d4f-91f2-41ed-912f-82f6db2610b8);
DB_LOW_MurderTribunal_DeathKnights((CHARACTER)S_LOW_MurderTribunal_DeathKnight_Weak002_ed27cf22-f23c-47d3-ab02-8e7fc5035ed6);

//DB_LOW_MurderTribunal_Court_NPCs(_Character,_Chair,_BaptismPoint)
DB_LOW_MurderTribunal_Court_NPCs((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,(ITEM)S_LOW_MurderTribunal_Chair_Sarevok_ec5150db-23f4-4cb6-92fa-186aa84d5539,(TRIGGER)S_LOW_MurderTribunal_Baptism_Sarevok_Point_f13624f9-c9b8-45e2-80bd-7c627342b706);
DB_LOW_MurderTribunal_Court_NPCs(S_LOW_MurderTribunal_Amelyssan_eca47258-a8ad-4453-a12a-3f39f8e1ca32,S_LOW_MurderTribunal_Chair_Amelyssan_58fb8984-f7d0-4cfb-ad00-05db00e881fe,S_LOW_MurderTribunal_Baptism_Amelyssan_Point_84c5bae5-53d5-4aa0-98de-b557a4f6661f);
DB_LOW_MurderTribunal_Court_NPCs(S_LOW_MurderTribunal_Illasera_df3a6de2-ba33-4717-9861-ea9f42d35fec,S_LOW_MurderTribunal_Chair_Illasera_34e91fe1-90ca-4eaf-b051-f5c32f741a65,S_LOW_MurderTribunal_Baptism_Illasera_Point_a8ff577c-9197-48fb-a0a8-7edd7c6062d4);
DB_LOW_MurderTribunal_Court_NPCs(S_LOW_MurderTribunal_Sendai_565accd2-0fdc-423e-ad68-752988a509b4,S_LOW_MurderTribunal_Chair_Sendai_0420831a-5b74-48ed-83bd-923187017bcc,S_LOW_MurderTribunal_Baptism_Sendai_Point_617aa647-9e9b-49ae-8971-277989b452f4);

//DB_LOW_MurderTribunal_PossibleMurderVictims defined in Act3_GEN_SerialKiller

DB_LOW_MurderTribunal_FlagDialogs((DIALOGRESOURCE)LOW_MurderTribunal_DeathKnight_f3447992-8cd4-35d9-8aa9-d96bc7692e13);
DB_LOW_MurderTribunal_FlagDialogs((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trespass_ac08945d-3058-916a-f596-5623cc3e7965);
DB_LOW_MurderTribunal_FlagDialogs((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90);

DB_State_Priority(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackDeathKnight",0);
DB_State_Priority(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackCourt",0);
DB_State_Priority(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackPlayers",0);

DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackDeathKnight");

DB_TrespassTrigger(S_LOW_MurderTribunal_Court_Trespass_Box_59aa4931-3db6-437e-888a-ee980b25ab44,NULL_00000000-0000-0000-0000-000000000000,"LOW_MurderTribunal_Trespass",(CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6);

DB_LOW_MurderTribunal_Cultists((CHARACTER)S_LOW_MurderTribunal_Cultist_001_fd17b00c-02ff-4199-8a95-8c402dce073d);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_002_796a76c8-2eed-4d95-8a93-cf42600efe84);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_003_a4b11a7b-af55-43ad-9f71-60dd39e174b3);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_004_cc9849e5-3ca3-4ffe-8e2b-70b150ad9034);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_005_a3d7473e-1ab1-41df-8a23-3d1af74b1339);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_006_b0b1c161-1583-43c5-b573-938fb30b0bff);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_007_9afe32a8-7a2f-4094-aab2-3e37ed44d423);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_008_c66a7c9a-d47b-4ce5-85a1-cf3957cba36c);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_009_82cf8893-e510-43f1-ae6f-66a5958b7140);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_010_debac3c7-dd1a-43f5-9dc2-7a52af799e44);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_011_d61effd2-03d6-42ef-8535-a27b4b5c15ba);
DB_LOW_MurderTribunal_Cultists(S_LOW_MurderTribunal_Cultist_012_5fa94043-e9d5-43ff-88ce-77e4236ecd3f);

DB_LOW_MurderTribunal_Cultists_ChantADs((DIALOGRESOURCE)LOW_MurderTribunal_AD_Baptism_Cultists_63de21ad-d5d8-bcd0-594f-cc673dbe7b03);
DB_LOW_MurderTribunal_Cultists_ChantADs((DIALOGRESOURCE)LOW_MurderTribunal_AD_Baptism_Cultists_Combat_cb8f7452-6338-3e26-43b8-8f981a847dd9);

DB_LOW_MurderTribunal_Cultists_ChantTiming("RepeatedAD_InitialDelay",6000); //in miliseconds
DB_LOW_MurderTribunal_Cultists_ChantTiming("RepeatedAD_Interval",8000);
DB_LOW_MurderTribunal_Cultists_ChantTiming("ValeriaAD_Delay",4000);
DB_LOW_MurderTribunal_Cultists_ChantTiming("CombatAD_Delay",3); //in number of combat turns
DB_LOW_MurderTribunal_Cultists_ChantTiming("CombatAD_Interval",6); //in number of combat turns

DB_CustomForbiddenItemCrimes(S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,"LOW_MurderTribunal_FreeValeria","LOW_MurderTribunal_FreeValeria");
DB_LOW_MurderTribunal_ChainCrimes("KnockSpell");
DB_LOW_MurderTribunal_ChainCrimes("Vandalise");
DB_LOW_MurderTribunal_ChainCrimes("VandaliseNoOwner");
DB_LOW_MurderTribunal_ChainCrimes("ItemDestroy");

DB_LOW_MurderTribunal_CancelValeriaChainedBehaviorFlags((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8);
DB_LOW_MurderTribunal_CancelValeriaChainedBehaviorFlags(LOW_MurderTribunal_State_ThreatenedValeria_20981273-1955-a5a0-0b32-610490cac952);
DB_LOW_MurderTribunal_CancelValeriaChainedBehaviorFlags(LOW_MurderTribunal_State_FreedValeria_bc52002a-08fd-0b96-a273-f949e73353f9);

DB_CombatReact_AD_OnTurn(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_AD_Sarevok_Combat001_272e7cbf-4f35-286e-8a73-20cc4b14ff75,1);
DB_CombatReact_AD_OnTurn(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_AD_Sarevok_Combat002_b3a75fdd-b6c6-c057-5303-5a525fd83921,2);
DB_CombatReact_AD_OnTurn(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_AD_Sarevok_Combat003_e8533f68-f368-a013-46fa-542db2dae481,4);
DB_CombatReact_AD_OnTurn(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_AD_Sarevok_Combat004_84174dac-9473-b44c-4933-d7f5e3695a9d,6);
DB_CombatReact_AD_OnDeath(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_AD_Sarevok_OnDeath_927ee660-2e4a-cd89-f80c-5410dea5f980);
DB_CombatReact_AD_OnCast(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_AD_Sarevok_DeathBringerAssault_2803351e-7d1c-02f3-70bb-24bc03fb3e62,"Target_LOW_DeathbringerAssault_Sarevok");



//REGION Murder Tableaux

DB_LOW_SerialKiller_SeeTableau((FLAG)LOW_MurderTribunal_State_FoundMurderTableau_Abazigal_5970fcc9-fd49-485c-bc41-397e895f8c44,(GUIDSTRING)S_LOW_FakeDraconis_Corpse_bfc4a14b-af9c-4c64-b07c-b63fd3cc420b);
DB_LOW_SerialKiller_SeeTableau((FLAG)LOW_MurderTribunal_State_FoundMurderTableau_Abazigal_5970fcc9-fd49-485c-bc41-397e895f8c44,(GUIDSTRING)S_LOW_FakeAbazigal_Corpse_0d20d453-e593-45af-85f7-c6081d1e6781);

DB_LOW_SerialKiller_SeeTableau((FLAG)LOW_MurderTribunal_State_FoundMurderTableau_Amelyssan_1ebcee4d-9586-4d87-894c-704637ec4ad8,(GUIDSTRING)S_LOW_SerialKiller_Amelyssan_FakeSendai_050b7000-4c96-4116-9576-28fd216e10b8);
DB_LOW_SerialKiller_SeeTableau((FLAG)LOW_MurderTribunal_State_FoundMurderTableau_Amelyssan_1ebcee4d-9586-4d87-894c-704637ec4ad8,(GUIDSTRING)S_LOW_SerialKiller_Amelyssan_FakeYagaShura_da787c39-1ba7-4d28-be5f-5ca1a686d0db);
DB_LOW_SerialKiller_SeeTableau((FLAG)LOW_MurderTribunal_State_FoundMurderTableau_Amelyssan_1ebcee4d-9586-4d87-894c-704637ec4ad8,(GUIDSTRING)S_LOW_SerialKiller_Amelyssan_FakeAbazigal_02c1b1ac-1a4f-434d-9301-956b2c9d8d13);
DB_LOW_SerialKiller_SeeTableau((FLAG)LOW_MurderTribunal_State_FoundMurderTableau_Amelyssan_1ebcee4d-9586-4d87-894c-704637ec4ad8,(GUIDSTRING)S_LOW_SerialKiller_Amelyssan_FakeIllasera_a7b67b34-9eb6-4de3-b69a-68c92777e2ea);
DB_LOW_SerialKiller_SeeTableau((FLAG)LOW_MurderTribunal_State_FoundMurderTableau_Amelyssan_1ebcee4d-9586-4d87-894c-704637ec4ad8,(GUIDSTRING)S_LOW_SerialKiller_Amelyssan_FakeAmelyssan_8013105c-2bb0-43a1-9ede-fdcc9593969a);
DB_LOW_SerialKiller_SeeTableau((FLAG)LOW_MurderTribunal_State_FoundMurderTableau_Amelyssan_1ebcee4d-9586-4d87-894c-704637ec4ad8,(GUIDSTRING)S_LOW_SerialKiller_Amelyssan_FakeBalthazar_5052ca0b-7b62-490d-92c2-3c2c246d6b89);

//END_REGION

// Combat NPC Reactivity

DB_CombatReact_AD_OnNextTurn(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6, (DIALOGRESOURCE)LOW_MurderTribunal_AD_DeathKnight_Combat001_d6b3bf82-0039-e186-e2bc-3ed950b8b455);
DB_CombatReact_AD_OnNextTurn(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6, (DIALOGRESOURCE)LOW_MurderTribunal_AD_DeathKnight_Combat002_2310d951-a0c3-47d9-a900-b0e07f131459);

//REGION Immersion pass

ToInventory(S_LOW_MurderTribunal_GiantRat_41ca82a0-72d1-4e91-b645-7f9c13bdaa43,S_LOW_MurderTribunal_TombstoneShop_Front_Casket_cdb9d21c-0d97-4df9-a2b2-44b7d118090a,1,0,0);
DB_Dialogs(S_LOW_MurderTribunal_TombstoneShop_Front_Tombstone_001_68057eb3-70c6-4c68-a94e-c12b44b6344f,(DIALOGRESOURCE)LOW_AD_Sign_CandulhallowsTombstones_80c179c0-94bb-c3f7-8d14-15636fbe377f);
DB_Dialogs(S_LOW_MurderTribunal_TombstoneShop_Front_Tombstone_002_7c4c2364-93bb-4280-963b-fcb4156baa9c,(DIALOGRESOURCE)LOW_AD_Sign_CandulhallowsTombstones_80c179c0-94bb-c3f7-8d14-15636fbe377f);
DB_Dialogs(S_LOW_MurderTribunal_Sewer_FlamingFistPoster_4bf6f69a-c178-4786-a914-e89064779e0c,(DIALOGRESOURCE)LOW_MurderTribunal_AD_FlamingFistsThisWay_5bb1ac77-495d-7e27-cd1a-1dfb98e2b202);
DB_Dialogs(S_LOW_MurderTribunal_Workbench_a1ac3d95-2f2e-4208-a771-5021728b9c58,(DIALOGRESOURCE)LOW_MurderTribunal_AD_FineSelectionOfTongs_38f47b29-e9d9-f47a-5e65-50ee7d79d7b1);

DB_Dialogs(S_LOW_MurderTribunal_Sewer_Skull001_04d37e95-54f7-4dc5-96e0-f2a69e427cee,(DIALOGRESOURCE)LOW_MurderTribunal_AD_TribunalSewerHallSkull1_11e78d1c-f78a-27e3-840b-bd9efad6dc64);
DB_Dialogs(S_LOW_MurderTribunal_Sewer_Skull002_5bb22274-b2b7-48f7-92b4-7f901efbaa7b,(DIALOGRESOURCE)LOW_MurderTribunal_AD_TribunalSewerHallSkull2_422d1896-6ecf-a3ca-fb62-9b6c91cc87b8);
DB_Dialogs(S_LOW_MurderTribunal_Sewer_Skull003_595ce040-8a1d-4827-a144-b7a8067816e3,(DIALOGRESOURCE)LOW_MurderTribunal_AD_TribunalSewerHallSkull3_a5515941-320c-085a-d504-1b566442c01e);
DB_Dialogs(S_LOW_MurderTribunal_Sewer_Skull004_48a2530c-e930-4adf-adec-2e3887f2374d,(DIALOGRESOURCE)LOW_MurderTribunal_AD_TribunalSewerHallSkull4_34190135-1f23-9d08-cf7e-6ae8b6f3c578);

DB_LOW_MurderTribunal_Bench((ITEM)S_LOW_MurderTribunal_Bench_001_b7a9b07b-c8e9-47f5-a76d-b535178b667c);
DB_LOW_MurderTribunal_Bench((ITEM)S_LOW_MurderTribunal_Bench_002_fee496e9-dd0d-463e-ab62-2d02f037b11a);
DB_LOW_MurderTribunal_Bench((ITEM)S_LOW_MurderTribunal_Bench_003_dc1afe1b-911b-433c-ba83-446c3395c59c);
DB_LOW_MurderTribunal_Bench((ITEM)S_LOW_MurderTribunal_Bench_004_c590d672-4da8-4454-a61e-9d1a01b06f55);

ToInventory(S_LOW_MurderTribunal_Page_SarevokOrinMother_23faac28-99b0-4ff2-bc23-13e70921a8ad,S_LOW_MurderTribunal_PrisonOfficeDesk_668c30d1-ddb8-44a4-a14f-1eb0ccebfb9c);
DB_BookFlags(S_LOW_MurderTribunal_Page_SarevokOrinMother_23faac28-99b0-4ff2-bc23-13e70921a8ad,LOW_BhaalTemple_Knows_OrinsMother_329be152-2e04-4b9c-85c6-055efad23da8);

//END_REGION
KBSECTION
//REGION Debug

IF
FlagSet(LOW_MurderTribunal_Debug_GoToStart_2140f627-251a-13da-dcc1-f5fc07a8fa6a,_Player,_)
THEN
PROC_LOW_MurderTribunal_DEBUG_GoToStart((CHARACTER)_Player);
ClearFlag(LOW_MurderTribunal_Debug_GoToStart_2140f627-251a-13da-dcc1-f5fc07a8fa6a,_Player);

IF
FlagSet(LOW_MurderTribunal_Debug_GoToStart_2140f627-251a-13da-dcc1-f5fc07a8fa6a,_Player,_)
THEN
PROC_LOW_MurderTribunal_DEBUG_GoToStart((CHARACTER)_Player);
ClearFlag(LOW_MurderTribunal_Debug_GoToStart_2140f627-251a-13da-dcc1-f5fc07a8fa6a,_Player);

IF
TextEvent("MT_Start")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation(0);
PROC_LOW_MurderTribunal_DEBUG_GoToStart(_Player);

IF
TextEvent("MT_Start_Dolor")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation(1);
PROC_LOW_MurderTribunal_DEBUG_GoToStart(_Player);

IF
TextEvent("MT_Dolor")
AND
GetTextEventParamInteger(1,_Value)
THEN
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation(_Value);

IF
TextEvent("MT_Dolor_NDK")
THEN
Die((CHARACTER)S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6,DEATHTYPE.DoT,S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6,1,0);
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation(1);

IF
TextEvent("MT_Dolor_Assault")
THEN
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation(1);
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault");

IF
TextEvent("MT_Dolor_Assault_Cheats")
AND
GetDefaultEquipmentSet((CHARACTER)S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6,_Equipment)
THEN
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation(1);
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault");
ApplyStatus(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"DEBUG_MAX_HP",-1.0);
ApplyStatus(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"BULLS_STRENGTH",-1.0);
CharacterGiveEquipmentSet(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_Equipment);

IF
TextEvent("MT_Court")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player,S_LOW_MurderTribunal_Court_Approach_Point_e0f1bfc5-d743-4210-a813-c8165dfe9d47,"",0,1,1,1,1);

IF
FlagSet(LOW_MurderTribunal_Debug_StartBaptismAlive_58663e68-2724-2e85-8277-73a3dada660a,_Player,_)
THEN
ClearFlag(LOW_MurderTribunal_Debug_StartBaptismAlive_58663e68-2724-2e85-8277-73a3dada660a,_Player);
PROC_LOW_MurderTribunal_DEBUG_StartBaptism((CHARACTER)_Player);

IF
FlagSet(LOW_MurderTribunal_Debug_StartBaptismDead_d5fb9a16-829a-2f77-05df-2bd91d5ef907,_Player,_)
THEN
ClearFlag(LOW_MurderTribunal_Debug_StartBaptismDead_d5fb9a16-829a-2f77-05df-2bd91d5ef907,_Player);
PROC_LOW_MurderTribunal_DEBUG_StartBaptism_Dead((CHARACTER)_Player);

IF
TextEvent("MT_Baptism")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_MurderTribunal_DEBUG_StartBaptism(_Player);

IF
TextEvent("MT_Baptism_Dead")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_MurderTribunal_DEBUG_StartBaptism_Dead(_Player);

PROC
PROC_LOW_MurderTribunal_DEBUG_StartBaptism((CHARACTER)_Player)
AND
DB_DialogName((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_DialogId)
AND
DB_DialogNPCs(_DialogId,_Player,_)
AND
DB_HostileToPlayerGroupAfterDialog(_NPC,_DialogId)
THEN
NOT DB_HostileToPlayerGroupAfterDialog(_NPC,_DialogId);

PROC
PROC_LOW_MurderTribunal_DEBUG_StartBaptism((CHARACTER)_Player)
AND
DB_DialogName((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,_)
THEN
PROC_ForceStopDialog(_Player);

PROC
PROC_LOW_MurderTribunal_DEBUG_StartBaptism((CHARACTER)_Player)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf);
PROC_CharacterFullRestore((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
NOT DB_Dead((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
DB_LOW_MurderTribunal_DEBUG_ResetBaptism(1);

PROC
PROC_LOW_MurderTribunal_DEBUG_StartBaptism_Dead((CHARACTER)_Player)
THEN
Die((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,DEATHTYPE.DoT,NULL_00000000-0000-0000-0000-000000000000,1,1);
DB_Dead((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
DB_LOW_MurderTribunal_DEBUG_ResetBaptism(1);

IF
TextEvent("MT_Baptism_Chained")
AND
GetTextEventParamInteger(1,_Value)
THEN
PROC_LOW_MurderTribunal_SetValeriaChained(_Value);

IF
TextEvent("MT_Cultists")
AND
DB_LOW_MurderTribunal_Cultists(_Cultist)
THEN
NOT DB_LOW_MurderTribunal_Cultists(_Cultist);
DB_LOW_MurderTribunal_Cultists(_Cultist);

IF
DB_LOW_MurderTribunal_DEBUG_ResetBaptism(1)
THEN
SetFlag(LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8);
ClearFlag(LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608);

IF
FlagCleared(LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608,_,_)
AND
DB_LOW_MurderTribunal_DEBUG_ResetBaptism(1)
THEN
PROC_GlobalSetFlagAndCache(LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608);
NOT DB_LOW_MurderTribunal_DEBUG_ResetBaptism(1);

IF
FlagSet(LOW_MurderTribunal_DEBUG_DolorConfrontation_82150b30-3787-2832-9cdb-d64553427edd,_,_)
THEN
ClearFlag(LOW_MurderTribunal_DEBUG_DolorConfrontation_82150b30-3787-2832-9cdb-d64553427edd);
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation(1);

PROC
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation((INTEGER)_)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor",_State)
THEN
NOT DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor",_State);

PROC
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation(0)
THEN
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","OffStage");
SetOnStage(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,0);

PROC
PROC_LOW_MurderTribunal_DEBUG_DoDolorConfrontation(1)
THEN
NOT DB_PermaDefeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","OffStage");
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal");
PROC_LOW_MurderTribunal_DoDolorConfrontation(0);

PROC
PROC_LOW_MurderTribunal_DEBUG_GoToStart((CHARACTER)_Player)
THEN
TeleportTo(_Player,S_LOW_MurderTribunal_DEBUG_Point_fc2d3096-0ab5-40de-a7c3-8c8de0dadfb3,"",1,1,1,1,1);
ToInventory(S_LOW_SerialKiller_NoteFromOrin_9c029a99-2636-4c19-9ff3-c7564a91cd35,_Player,1,1,1);
ToInventory(S_LOW_SerialKiller_DolorBag_43404e7f-b5a9-491d-b0ef-f3fc7f002229,_Player,1,1,1);
SetFlag(LOW_MurderTribunal_Knows_WordOfPassage_839150e6-d168-4c89-a980-68b9e9f60556);
SetFlag(LOW_MurderTribunal_Knows_UnholyAssassin_8a939a44-bb4a-d32f-0584-388d248f565c);

IF
FlagSet(LOW_MurderTribunal_Debug_GetDolorItems_b36c75f5-5b05-eb33-6512-0f6c9b055305,_Player,_)
THEN
ToInventory(S_LOW_SerialKiller_NoteFromOrin_9c029a99-2636-4c19-9ff3-c7564a91cd35,_Player,1,1,1);
ToInventory(S_LOW_SerialKiller_DolorBag_43404e7f-b5a9-491d-b0ef-f3fc7f002229,_Player,1,1,1);
ClearFlag(LOW_MurderTribunal_Debug_GetDolorItems_b36c75f5-5b05-eb33-6512-0f6c9b055305,_Player);

IF
TextEvent("MT_GetDolorItems")
AND
GetHostCharacter(_Player)
THEN
ToInventory(S_LOW_SerialKiller_NoteFromOrin_9c029a99-2636-4c19-9ff3-c7564a91cd35,_Player,1,1,1);
ToInventory(S_LOW_SerialKiller_DolorBag_43404e7f-b5a9-491d-b0ef-f3fc7f002229,_Player,1,1,1);

IF
TextEvent("MT_Passage")
AND
GetHostCharacter(_Player)
THEN
SetFlag(LOW_MurderTribunal_Knows_WordOfPassage_839150e6-d168-4c89-a980-68b9e9f60556);
SetFlag(LOW_MurderTribunal_Knows_UnholyAssassin_8a939a44-bb4a-d32f-0584-388d248f565c);

IF
TextEvent("MT_GetHand")
AND
GetTextEventParamInteger(1,_Index)
AND
SysFactAtIndex("DB_LOW_MurderTribunal_PossibleMurderVictims",4,_Index,"DB_QRY_RTN_LOW_MurderTribunal_VictimHand")
AND
DB_QRY_RTN_LOW_MurderTribunal_VictimHand((CHARACTER)_Victim,(ITEM)_Hand,(FLAG)_Flag)
AND
GetHostCharacter(_Player)
THEN
SetFlag(LOW_MurderTribunal_Knows_UnholyAssassin_8a939a44-bb4a-d32f-0584-388d248f565c);
ToInventory(_Hand,_Player,1,1,1);
NOT DB_QRY_RTN_LOW_MurderTribunal_VictimHand(_Victim,_Hand,_Flag);

IF
TextEvent("MT_RandomHand")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_MurderTribunal_DEBUG_GetRandomHand((CHARACTER)_Player);

IF
TextEvent("MT_ResetApproach")
AND
DB_SpotPlayers(_Character,"LOW_MurderTribunal_Court",_,_)
THEN
PROC_LOW_MurderTribunal_RestartCourtSpotting();
ClearFlag((FLAG)LOW_MurderTribunal_Event_GhostAppears_2ccb1bc5-5a95-e5b4-30b1-4da17aff359e);
ClearFlag((FLAG)LOW_MurderTribunal_Event_GhostTransformSpectre_d6f52bb4-0fa9-2945-a613-d6ae82715273);
ClearFlag((FLAG)LOW_MurderTribunal_Event_GhostSpectreDisappears_28980598-7ff2-8364-852f-432f030c1ad3);

IF
FlagSet(LOW_MurderTribunal_Debug_GetRandomHand_d23bf350-f45d-e7b0-db33-6bd2c6b0bf29,_Player,_)
THEN
PROC_LOW_MurderTribunal_DEBUG_GetRandomHand((CHARACTER)_Player);
ClearFlag(LOW_MurderTribunal_Debug_GetRandomHand_d23bf350-f45d-e7b0-db33-6bd2c6b0bf29,_Player);

PROC
PROC_LOW_MurderTribunal_DEBUG_GetRandomHand((CHARACTER)_Player)
AND
QRY_GetRandom("DB_LOW_MurderTribunal_PossibleMurderVictims",4,"DB_QRY_RTN_LOW_MurderTribunal_RandomHand")
AND
DB_QRY_RTN_LOW_MurderTribunal_RandomHand((CHARACTER)_Victim,(ITEM)_Hand,(FLAG)_Flag)
THEN
SetFlag(LOW_MurderTribunal_Knows_UnholyAssassin_8a939a44-bb4a-d32f-0584-388d248f565c);
ToInventory(_Hand,_Player,1,1,1);
NOT DB_QRY_RTN_LOW_MurderTribunal_RandomHand(_Victim,_Hand,_Flag);

IF
TextEvent("MT_RevealCellar")
THEN
SetEntityEvent(S_LOW_MurderTribunal_Bookcase_Sliding_Door_3fc668e3-1797-4d9d-ac6f-0b047056a3ca,"LOW_MurderTribunal_BookcaseDoorOpen",1);

IF
TextEvent("MT_Jahinsc")
AND
GetHostCharacter(_Player)
THEN
PROC_LOW_MurderTribunal_DEBUG_JahinscSacrifice(_Player);

PROC
PROC_LOW_MurderTribunal_DEBUG_JahinscSacrifice((CHARACTER)_Player)
THEN
PROC_GlobalSetFlagAndCache(ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20);
NOT DB_PreventKnockedOutPermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
SetFlag(Debug_JaheiraIsPlayer_0b906e26-cee7-4505-b246-edf95bda67e4);
SetFlag(Debug_AddJaheira_52dc4aeb-bb06-46bb-9c6c-ff3d3ef21857,_Player);
SetFlag(Debug_MinscIsPlayer_0e87a51a-9281-191e-a506-3545e442ad1c);
SetFlag(Debug_AddMinsc_e13376a2-10f4-68f3-4b4c-710938b1c143,_Player);
ToInventory(S_LOW_SerialKiller_NoteFromOrin_9c029a99-2636-4c19-9ff3-c7564a91cd35,_Player,1,1,1);
ToInventory(S_LOW_SerialKiller_DolorBag_43404e7f-b5a9-491d-b0ef-f3fc7f002229,_Player,1,1,1);
SetFlag(LOW_MurderTribunal_Knows_WordOfPassage_839150e6-d168-4c89-a980-68b9e9f60556);
SetFlag(LOW_MurderTribunal_Knows_UnholyAssassin_8a939a44-bb4a-d32f-0584-388d248f565c);
TeleportTo(_Player,S_LOW_MurderTribunal_Court_Approach_Point_e0f1bfc5-d743-4210-a813-c8165dfe9d47,"",0,0,0,1,1);
TeleportTo(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,S_LOW_MurderTribunal_Jahinsc_Point_e8a1a931-41e3-4940-8c2c-e04146d956da,"",0,0,0,1,1);
TeleportTo(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba,S_LOW_MurderTribunal_Jahinsc_Point_e8a1a931-41e3-4940-8c2c-e04146d956da,"",0,0,0,1,1);

IF
TextEvent("MT_DetermineVictim")
AND
DB_LOW_MurderTribunal_ChosenVictim(_Victim)
THEN
NOT DB_LOW_MurderTribunal_ChosenVictim(_Victim);

IF
TextEvent("MT_DetermineVictim")
AND
GetHostCharacter(_Player)
AND
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
AND
NOT DB_LOW_MurderTribunal_ChosenVictim(_)
THEN
DebugText(_Player,"Could not determine victim");

IF
TextEvent("MT_DetermineVictim")
AND
GetHostCharacter(_Player)
AND
DB_LOW_MurderTribunal_ChosenVictim(_Victim)
AND
GUIDToString(_Victim,_VictimString)
AND
Concatenate("Determined victim: ",_VictimString,_DebugString)
THEN
DebugText(_Player,_DebugString);

//END_REGION

//REGION Tombstone Shop/Word of Passage

PROC
PROC_LevelLoadedOnce("CTY_Main_A")
AND
IsInTrigger(S_LOW_MurderTribunal_Bookcase_Painting_7eedb33f-b33e-477b-84e9-6159c3b15e86,S_LOW_MurderTribunal_Painting_Button_Trigger_72780e45-eebe-4f84-bac6-08d9fc5ec8a9,1)
THEN
SetCanInteract(S_LOW_MurderTribunal_Bookcase_Button_2e18ba69-b6b1-486e-8acf-c24e32dac5b6,0);

IF
ItemLeftTrigger(S_LOW_MurderTribunal_Bookcase_Painting_7eedb33f-b33e-477b-84e9-6159c3b15e86,S_LOW_MurderTribunal_Painting_Button_Trigger_72780e45-eebe-4f84-bac6-08d9fc5ec8a9,_)
AND
QRY_OnlyOnce("LOW_MurderTribunal_Bookcase_Button_CanInteract")
THEN
SetCanInteract(S_LOW_MurderTribunal_Bookcase_Button_2e18ba69-b6b1-486e-8acf-c24e32dac5b6,1);

//Shouldn't be destructible but better safe than sorry, this could block main story progression
IF
DB_Destroyed(S_LOW_MurderTribunal_Bookcase_Painting_7eedb33f-b33e-477b-84e9-6159c3b15e86)
AND
QRY_OnlyOnce("LOW_MurderTribunal_Bookcase_Button_CanInteract")
THEN
SetCanInteract(S_LOW_MurderTribunal_Bookcase_Button_2e18ba69-b6b1-486e-8acf-c24e32dac5b6,1);

//Failsafe
IF
AddedTo(S_LOW_MurderTribunal_Bookcase_Painting_7eedb33f-b33e-477b-84e9-6159c3b15e86,_PartyMember,_)
AND
QRY_OnlyOnce("LOW_MurderTribunal_Bookcase_Button_CanInteract")
THEN
SetCanInteract(S_LOW_MurderTribunal_Bookcase_Button_2e18ba69-b6b1-486e-8acf-c24e32dac5b6,1);

PROC
PROC_BlockUseOfItem(_Player,S_LOW_MurderTribunal_CellarDoor_1aa896d7-f2ad-4430-ab90-2dd00c876145)
AND
IsLocked(S_LOW_MurderTribunal_CellarDoor_1aa896d7-f2ad-4430-ab90-2dd00c876145,1)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_Event_TombstoneShop_OpenDoor_88043f62-c9c5-3aa1-4995-02346a6b45b7)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_MurderTribunal_TombstoneShop_Password_306b1e62-ae1d-2a69-2166-48b3c3c55125,S_LOW_MurderTribunal_CellarDoor_1aa896d7-f2ad-4430-ab90-2dd00c876145,_Player)
THEN
DB_NOOP(1);

IF
FlagSet((FLAG)LOW_MurderTribunal_Event_TombstoneShop_OpenDoor_88043f62-c9c5-3aa1-4995-02346a6b45b7,_,_)
THEN
Unlock(S_LOW_MurderTribunal_CellarDoor_1aa896d7-f2ad-4430-ab90-2dd00c876145);

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_TombstoneShop_OpenDoor_88043f62-c9c5-3aa1-4995-02346a6b45b7,_,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,_)
THEN
Use((CHARACTER)_Player,S_LOW_MurderTribunal_CellarDoor_1aa896d7-f2ad-4430-ab90-2dd00c876145,1,1,"");

IF
UseFinished(_,S_LOW_MurderTribunal_Bookcase_Button_2e18ba69-b6b1-486e-8acf-c24e32dac5b6,1)
THEN
SetEntityEvent(S_LOW_MurderTribunal_Bookcase_Sliding_Door_3fc668e3-1797-4d9d-ac6f-0b047056a3ca,"LOW_MurderTribunal_BookcaseDoorOpen",1);

IF
EntityEvent(S_LOW_MurderTribunal_Bookcase_Sliding_Door_3fc668e3-1797-4d9d-ac6f-0b047056a3ca,"LOW_MurderTribunal_BookcaseDoorOpen")
THEN
ItemMoveTo((ITEM)S_LOW_MurderTribunal_Bookcase_Sliding_Door_3fc668e3-1797-4d9d-ac6f-0b047056a3ca,S_LOW_MurderTribunal_Bookcase_Target_Point_e9cda5bc-3da8-4da3-9206-b785559eaa6b,1.0,1.0,0,"");
SetCanInteract(S_LOW_MurderTribunal_CellarDoor_1aa896d7-f2ad-4430-ab90-2dd00c876145,1);

//END_REGION

//REGION Death Knight sentry

IF
DB_LOW_MurderTribunal_DeathKnights((CHARACTER)_DeathKnight)
THEN
DB_GLO_DefeatCounter(_DeathKnight,"LOW_MurderTribunal_DeathKnights");
DB_SpotPlayers((CHARACTER)_DeathKnight,"LOW_MurderTribunal_DeathKnight",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous((CHARACTER)_DeathKnight,"LOW_MurderTribunal_DeathKnight");
DB_SpotPlayers_IncludeWildshapedPlayers(_DeathKnight,"LOW_MurderTribunal_DeathKnight");
DB_SpotPlayers_TargetIgnoreCantTalk(_DeathKnight,"LOW_MurderTribunal_DeathKnight");
ApplyStatus(_DeathKnight,"LOW_MURDERTRIBUNAL_SOULOATH",-1.0,0,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6);

//If Death Knight is trying to spot us, reroute to his dialog instead of his weaker sidekicks
QRY
QRY_SelectCustomDialog((CHARACTER)_DeathKnight, _Player)
AND
DB_LOW_MurderTribunal_DeathKnights(_DeathKnight)
AND
_DeathKnight != S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6
AND
DB_SpotPlayers(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6,"LOW_MurderTribunal_DeathKnight",_,_)
AND
DB_Dialogs(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6,_Dialog)
THEN
DB_SelectedDialog(_Dialog,S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6,_Player);

//Spotting: Death Knight solo
PROC
PROC_SpotPlayers_Spotted(_Spotter,"LOW_MurderTribunal_DeathKnight",_Player)
AND
DB_Players(_Player)
AND
NOT DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal")
AND
GetFlag(LOW_MurderTribunal_HasMet_DeathKnight_8c77a678-6a8f-be17-9161-7147d79e9b68,_Player,0)
THEN
PROC_LOW_MurderTribunal_TryDeathKnightDialog(_Player);

PROC
PROC_SpotPlayers_Spotted(_Spotter,"LOW_MurderTribunal_DeathKnight",_Player)
AND
DB_Players(_Player)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal")
AND
NOT DB_OnlyOnce("LOW_MurderTribunal_HadDolorDeathKnightDialog")
AND
NOT QRY_LOW_MurderTribunal_TryDolorDeathKnightDialog(_Player)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928,0);
PROC_LOW_MurderTribunal_TryDeathKnightDialog(_Player);

PROC
PROC_LOW_MurderTribunal_TryDeathKnightDialog((CHARACTER)_Player)
AND
QRY_StartDialog_Fixed(LOW_MurderTribunal_DeathKnight_f3447992-8cd4-35d9-8aa9-d96bc7692e13,S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6,_Player)
THEN
DB_LOW_MurderTribunal_StartedDeathKnightDialog(1);

PROC
PROC_LOW_MurderTribunal_TryDeathKnightDialog((CHARACTER)_Player)
AND
NOT DB_LOW_MurderTribunal_StartedDeathKnightDialog(1)
AND
DB_Defeated(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6)
THEN
DB_HostileToPlayerGroup((FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585,_Player);

PROC
PROC_LOW_MurderTribunal_TryDeathKnightDialog((CHARACTER)_Player)
AND
NOT DB_LOW_MurderTribunal_StartedDeathKnightDialog(1)
AND
NOT DB_HostileToPlayerGroup((FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585,_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729)
THEN
DB_LOW_MurderTribunal_InvalidDeathKnightSpottedCharacter((CHARACTER)_Player);
ObjectTimerCancel(_Player,"LOW_MurderTribunal_DeathKnight_SpottedInvalid");
ObjectTimerLaunch(_Player,"LOW_MurderTribunal_DeathKnight_SpottedInvalid",3000); //Delay with timer to allow for valid player to appear

PROC
PROC_LOW_MurderTribunal_TryDeathKnightDialog((CHARACTER)_Player)
AND
DB_LOW_MurderTribunal_StartedDeathKnightDialog(1)
THEN
NOT DB_LOW_MurderTribunal_StartedDeathKnightDialog(1);

IF
DialogStarted((DIALOGRESOURCE)LOW_MurderTribunal_DeathKnight_f3447992-8cd4-35d9-8aa9-d96bc7692e13,_)
AND
DB_LOW_MurderTribunal_InvalidDeathKnightSpottedCharacter((CHARACTER)_Player)
THEN
ObjectTimerCancel(_Player,"LOW_MurderTribunal_DeathKnight_SpottedInvalid");

IF
DialogStarted((DIALOGRESOURCE)LOW_MurderTribunal_Dolor_85388168-0bcd-ade7-2857-1c2d4cb130ea,_)
AND
DB_LOW_MurderTribunal_InvalidDeathKnightSpottedCharacter((CHARACTER)_Player)
THEN
ObjectTimerCancel(_Player,"LOW_MurderTribunal_DeathKnight_SpottedInvalid");

IF
ObjectTimerFinished(_Player,"LOW_MurderTribunal_DeathKnight_SpottedInvalid")
AND
DB_LOW_MurderTribunal_InvalidDeathKnightSpottedCharacter((CHARACTER)_Player)
THEN
NOT DB_LOW_MurderTribunal_InvalidDeathKnightSpottedCharacter(_Player);
DB_HostileToPlayerGroup((FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585,_Player);

QRY
QRY_LOW_MurderTribunal_TryDolorDeathKnightDialog((CHARACTER)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6,S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
QRY_StartDialog(LOW_MurderTribunal_Dolor_85388168-0bcd-ade7-2857-1c2d4cb130ea,S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_Player,S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6)
THEN
DB_NOOP(1);

QRY
QRY_LOW_MurderTribunal_TryDolorDeathKnightDialog((CHARACTER)_Player)
AND
NOT QRY_SpeakerIsAvailable(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6)
AND
QRY_StartDialog(LOW_MurderTribunal_Dolor_85388168-0bcd-ade7-2857-1c2d4cb130ea,S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_Player)
THEN
DB_NOOP(1);

IF
DialogStarted((DIALOGRESOURCE)LOW_MurderTribunal_Dolor_85388168-0bcd-ade7-2857-1c2d4cb130ea,_)
THEN
DB_OnlyOnce("LOW_MurderTribunal_HadDolorDeathKnightDialog");

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_DeathKnight_GrantedEntry_cbeb9b91-7037-97fb-de76-913f5dbb8b95)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_LOW_MurderTribunal_Courtroom_Door_49d7d354-35d9-462c-9b14-43215ca956c3);
PROC_SpotPlayers_StopSpotting("LOW_MurderTribunal_DeathKnight");

IF
FlagSet(LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729,_,_)
THEN
PROC_SpotPlayers_StopSpotting("LOW_MurderTribunal_DeathKnight");

//END_REGION

//REGION Dolor confrontation

//Setup done via Dolor state manager: Act3_GEN_SerialKiller

IF
EnteredTrigger(_,S_LOW_MurderTribunal_DolorDeathKnightAD_Box_4c0e91b2-688b-4e27-9d14-360af201c92a)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal")
AND
QRY_OnlyOnce("LOW_MurderTribunal_AD_Dolor_DeathKnight")
AND
NOT DB_CantTalk(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_CantTalk(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6)
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_Dolor_DeathKnight_f342a193-6021-e157-7b15-ddb6678a0c86,S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6);

IF
AutomatedDialogEnded(LOW_MurderTribunal_AD_Dolor_DeathKnight_f342a193-6021-e157-7b15-ddb6678a0c86,_)
THEN
SetFlag(LOW_MurderTribunal_State_DidDolorDeathKnightAD_bf7bb964-5335-46e8-bef5-3d1ebb065d7e);

IF
AutomatedDialogRequestFailed(LOW_MurderTribunal_AD_Dolor_DeathKnight_f342a193-6021-e157-7b15-ddb6678a0c86,_)
THEN
SetFlag(LOW_MurderTribunal_State_DidDolorDeathKnightAD_bf7bb964-5335-46e8-bef5-3d1ebb065d7e);

IF
DB_GlobalFlag(LOW_MurderTribunal_Event_AttackDolor_017a5e54-59f1-47ad-ab42-46767d80c929)
AND
DB_PermaDefeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_LOW_MurderTribunal_DeathKnights(_DeathKnight)
THEN
PROC_SpotPlayers_RestartSpotting(_DeathKnight,"LOW_MurderTribunal_DeathKnight");

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_DolorMurdersTribunal_6256e7e2-056a-03c6-2905-42522d923dc5)
THEN
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault");

PROC
PROC_State_Changed(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault")
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_Event_DolorMurdersTribunal_6256e7e2-056a-03c6-2905-42522d923dc5)
THEN
SetFlag(LOW_MurderTribunal_Event_DolorMurdersTribunal_6256e7e2-056a-03c6-2905-42522d923dc5);

PROC
PROC_State_Changed(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault")
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,(FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928,0);
PROC_SetRelationMutual((FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585,(FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928,0);

IF
FlagSet(LOW_MurderTribunal_HasMet_DolorAndDeathKnight_285630b5-9350-6144-5b05-34b0a9614f53,_,_)
AND
NOT DB_LOW_MurderTribunal_SpokeToDolorAndDeathKnight(1)
THEN
DB_LOW_MurderTribunal_SpokeToDolorAndDeathKnight(1);

PROC
PROC_State_Changed(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal")
AND
NOT DB_Defeated(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6)
THEN
PROC_ClearRelationToPlayers((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928);

IF
TurnStarted(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal")
AND
DB_Defeated(S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6)
AND
NOT DB_LOW_MurderTribunal_SpokeToDolorAndDeathKnight(1)
AND
QRY_OnlyOnce("LOW_MurderTribunal_AD_Dolor_NoDeathKnight")
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_Dolor_NoDeathKnight_33efa9dc-236f-ecd0-c052-7497b5ec6244,S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

//Block Dolor's "keeping an eye out" after a crime in the Murder Tribunal
QRY
QRY_CRIME_KeepingAnEyeOut_Block((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal")
THEN
DB_NOOP(1);

QRY
QRY_CRIME_KeepingAnEyeOut_Block((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault")
THEN
DB_NOOP(1);

//REGION Dolor attacks Tribunal

PROC
PROC_State_Changed(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault",_State)
THEN
DebugText(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_State);

//STATE: AttackDeathKnight
IF
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault")
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackDeathKnight")
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_State_DeathKnightsDefeated_e7cf2480-e981-45bd-80f1-740661f49ed9)
AND
NOT DB_Is_InCombat(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_)
THEN
Attack(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6,0);
PROC_EnterCombat(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,S_LOW_MurderTribunal_DeathKnight_c16a1ebd-4390-4309-b5d5-30df6e1333f6);
//PROC_SetRelationToPlayers((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,0);
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackCourt");

IF
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault")
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackDeathKnight")
AND
DB_GlobalFlag(LOW_MurderTribunal_State_DeathKnightsDefeated_e7cf2480-e981-45bd-80f1-740661f49ed9)
THEN
//PROC_SetRelationToPlayers((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,0);
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackCourt");

//STATE: AttackCourt
IF
TurnStarted(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault")
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackCourt")
AND
DB_Is_InCombat(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_CombatId)
AND
DB_Is_InCombat(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_CombatId)
AND
NOT DB_CantTalk_IgnoreCombat(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
UseSpell(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"Target_PowerWordKill",S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,NULL_00000000-0000-0000-0000-000000000000);
PROC_WaitAndEndTurn(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,4000);

IF
CastedSpell(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"Target_PowerWordKill",_,_,_)
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_Sarevok_SmiteDolor_59313d60-3f52-6fcc-9a13-dee5500339b1,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6);

IF
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault")
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackCourt")
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_BhaalistsDefeated_4f6e1415-fd18-4179-ab94-3efa59a2d1e9)
AND
NOT DB_Is_InCombat(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_)
THEN
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackPlayers");

//STATE: AttackPlayers
PROC
PROC_State_Changed(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackPlayers")
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928,0);
RemoveStatusesWithGroup(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"SG_Invisible",S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

IF
TurnStarted(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal_Assault")
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor_MurderTribunal_Assault","AttackPlayers")
AND
QRY_LOW_MurderTribunal_IsDolorFightingPlayers()
AND
QRY_OnlyOnce("LOW_MurderTribunal_AD_Dolor_Betrayal")
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_Dolor_Betrayal_4a48a341-2281-8833-6f3d-5a7b6ca595af,S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

QRY
QRY_LOW_MurderTribunal_IsDolorFightingPlayers()
AND
DB_Is_InCombat(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,_CombatId)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player,_CombatId)
THEN
DB_NOOP(1);

//END_REGION

//END_REGION

//REGION Court

IF
DB_LOW_MurderTribunal_Court_NPCs(_Character,_Chair,_Trigger)
THEN
SitOnEntity(_Character,_Chair);
DB_SpotPlayers(_Character,"LOW_MurderTribunal_Court",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous(_Character,"LOW_MurderTribunal_Court");
DB_SpotPlayers_IncludeWildshapedPlayers(_Character,"LOW_MurderTribunal_Court");
DB_SpotPlayers_IncludeFollowers(_Character,"LOW_MurderTribunal_Court");
DB_SpotPlayers_IncludeSummons(_Character,"LOW_MurderTribunal_Court");
DB_SpotPlayers_TargetIgnoreCantTalk(_Character,"LOW_MurderTribunal_Court");
TriggerRegisterForCharacter(_Trigger,_Character);

//REGION Spotting/start trial dialog

IF
DB_SpotPlayers_Spotted(_,"LOW_MurderTribunal_Court",_Player)
AND
NOT DB_DialogName(LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_)
AND
NOT DB_PlayerTrespassing(_Player,_,(TRIGGER)S_LOW_MurderTribunal_Court_Trespass_Box_59aa4931-3db6-437e-888a-ee980b25ab44)
THEN
PROC_LOW_MurderTribunal_TryTrialDialog(_Player);

PROC
PROC_LOW_MurderTribunal_TryTrialDialog((CHARACTER)_PartyMember)
AND
NOT DB_Players(_PartyMember)
AND
CharacterGetOwner(_PartyMember,_Player)
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player,_PartyMember)
THEN
PROC_LOW_MurderTribunal_TryTrialDialog((CHARACTER)_Player);

PROC
PROC_LOW_MurderTribunal_TryTrialDialog((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_OnlyOncePerPlayer(_Player,"LOW_MurderTribunal_Court_Spotted")
AND
QRY_LOW_MurderTribunal_FindPreferredTrialSpeaker(_Player)
AND
DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_Speaker)
AND
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
AND
QRY_StartDialog_Fixed(LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb,_Player)
THEN
DB_LOW_MurderTribunal_StartedTrialDialog(1);
DB_OnlyOncePerPlayer(_Player,"LOW_MurderTribunal_Court_Spotted");

//Invalid spotted party member triggers hostility
PROC
PROC_LOW_MurderTribunal_TryTrialDialog((CHARACTER)_PartyMember)
AND
NOT DB_LOW_MurderTribunal_StartedTrialDialog(1)
THEN
DB_LOW_MurderTribunal_InvalidTrialCharacter((CHARACTER)_PartyMember);
ObjectTimerCancel(_PartyMember,"LOW_MurderTribunal_Court_SpottedInvalid");
ObjectTimerLaunch(_PartyMember,"LOW_MurderTribunal_Court_SpottedInvalid",3000); //Delay with timer to allow for valid party member to appear

IF
DialogStarted(LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_)
AND
DB_LOW_MurderTribunal_InvalidTrialCharacter((CHARACTER)_PartyMember)
THEN
ObjectTimerCancel(_PartyMember,"LOW_MurderTribunal_Court_SpottedInvalid");

IF
ObjectTimerFinished(_PartyMember,"LOW_MurderTribunal_Court_SpottedInvalid")
AND
DB_LOW_MurderTribunal_InvalidTrialCharacter((CHARACTER)_PartyMember)
THEN
NOT DB_LOW_MurderTribunal_InvalidTrialCharacter(_PartyMember);
PROC_LOW_MurderTribunal_InvalidTrialCharacter_TriggerHostility(_PartyMember);

PROC
PROC_LOW_MurderTribunal_InvalidTrialCharacter_TriggerHostility((CHARACTER)_PartyMember)
AND
NOT DB_Players(_PartyMember)
AND
DB_PartyMembers(_PartyMember)
AND
CharacterGetOwner(_PartyMember,_Player)
AND
DB_Players(_Player)
THEN
PROC_LOW_MurderTribunal_InvalidTrialCharacter_TriggerHostility((CHARACTER)_Player);

PROC
PROC_LOW_MurderTribunal_InvalidTrialCharacter_TriggerHostility((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT QRY_StartDialog_Fixed(LOW_MurderTribunal_Sarevok_Trespass_ac08945d-3058-916a-f596-5623cc3e7965,(CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_Player)
THEN
DB_HostileToPlayerGroup((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,_Player);

IF
DialogStarted(LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_)
AND
DB_SpotPlayers(_Character,"LOW_MurderTribunal_Court",_,_)
THEN
PROC_SpotPlayers_StopSpotting(_Character,"LOW_MurderTribunal_Court");

IF
DialogStarted(LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,1)
THEN
PROC_CharacterMoveTo((CHARACTER)_Player,S_LOW_MurderTribunal_Court_Approach_Point_e0f1bfc5-d743-4210-a813-c8165dfe9d47,"Walk","LOW_MurderTribunal_Trial_Approach");

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_DialogId)
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
AND
_Character != S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Character,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
PROC_DialogAddSpeakingActor(_DialogId,_Character);

QRY
QRY_LOW_MurderTribunal_FindPreferredTrialSpeaker((CHARACTER)_)
AND
DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_Speaker)
THEN
NOT DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_Speaker);

//Prefer Dark Urge
QRY
QRY_LOW_MurderTribunal_FindPreferredTrialSpeaker((CHARACTER)_Player)
AND
DB_ORI_DarkUrge(_DarkUrge)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_DarkUrge,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_DarkUrge);

//Then prefer nearby available avatar if companion
QRY
QRY_LOW_MurderTribunal_FindPreferredTrialSpeaker((CHARACTER)_Player)
AND
NOT DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_)
AND
NOT DB_Avatars(_Player)
AND
QRY_GetBestAvatarForCompanion(_Player)
AND
DB_QRYRTN_GetBestAvatarForCompanion(_Player,_Avatar)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Avatar,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_Avatar);

//Try original player
QRY
QRY_LOW_MurderTribunal_FindPreferredTrialSpeaker((CHARACTER)_Player)
AND
NOT DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_Player);

//Then prefer nearby available companion
QRY
QRY_LOW_MurderTribunal_FindPreferredTrialSpeaker((CHARACTER)_Player)
AND
DB_Players(_Companion)
AND
_Companion != _Player
AND
NOT DB_Avatars(_Companion)
AND
NOT DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Companion,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_QRYRTN_LOW_MurderTribunal_PreferredTrialSpeaker(_Companion);

//If that fails - hostility timer will start

//END_REGION

//REGION Approach and trespass triggers

IF
FlagSet((FLAG)LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617,_,_)
THEN
PROC_RemoveDBTrespassTrigger((TRIGGER)S_LOW_MurderTribunal_Court_Trespass_Box_59aa4931-3db6-437e-888a-ee980b25ab44);

//END_REGION

//REGION Determine ghost victim

//Already determined victim, player no longer has hand
QRY
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
AND
DB_LOW_MurderTribunal_ChosenVictim(_Victim)
AND
DB_LOW_MurderTribunal_PossibleMurderVictims(_Victim,_,_Flag, _)
AND
GetFlag(_Flag,_Player,0)
THEN
NOT DB_LOW_MurderTribunal_ChosenVictim(_Victim);

//Already determined victim
QRY
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
AND
DB_LOW_MurderTribunal_ChosenVictim(_)
THEN
DB_NOOP(1);

//Victim killed by players
QRY
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
AND
NOT DB_LOW_MurderTribunal_ChosenVictim(_)
AND
DB_LOW_MurderTribunal_PlayerVictims(_Victim)
AND
DB_LOW_MurderTribunal_PossibleMurderVictims(_Victim,_Hand,_Flag, _)
AND
NOT DB_LOW_MurderTribunal_ChosenVictim(_) //Check if victim was not chosen before continuing the loop
AND
GetFlag(_Flag,_Player,1)
THEN
DB_LOW_MurderTribunal_ChosenVictim(_Victim);

//Victim killed by player flag set/clear
IF
DB_LOW_MurderTribunal_ChosenVictim(_Victim)
AND
DB_LOW_MurderTribunal_PlayerVictims(_Victim)
THEN
SetFlag(LOW_MurderTribunal_MurderVictim_State_KilledByPlayer_6b701fb8-5a28-bedc-4c37-47b1a26fb1e2);

IF
DB_GlobalFlag(LOW_MurderTribunal_MurderVictim_State_KilledByPlayer_6b701fb8-5a28-bedc-4c37-47b1a26fb1e2)
AND
DB_LOW_MurderTribunal_ChosenVictim(_Victim)
AND
NOT DB_LOW_MurderTribunal_PlayerVictims(_Victim)
THEN
ClearFlag(LOW_MurderTribunal_MurderVictim_State_KilledByPlayer_6b701fb8-5a28-bedc-4c37-47b1a26fb1e2);

IF
DB_GlobalFlag(LOW_MurderTribunal_MurderVictim_State_KilledByPlayer_6b701fb8-5a28-bedc-4c37-47b1a26fb1e2)
AND
NOT DB_LOW_MurderTribunal_ChosenVictim(_)
THEN
ClearFlag(LOW_MurderTribunal_MurderVictim_State_KilledByPlayer_6b701fb8-5a28-bedc-4c37-47b1a26fb1e2);

//Victim is Stelmane flag set/clear
IF
DB_LOW_MurderTribunal_ChosenVictim((CHARACTER)S_LOW_MurderTribunal_DukeStelmane_f4856724-d8a9-4fa4-88c4-d8bd0dfc2d91)
THEN
SetFlag(LOW_MurderTribunal_MurderVictim_State_IsStelmane_c7b3390f-ba8c-416c-8b51-8c9133a9c99e);

IF
DB_GlobalFlag(LOW_MurderTribunal_MurderVictim_State_IsStelmane_c7b3390f-ba8c-416c-8b51-8c9133a9c99e)
AND
NOT DB_LOW_MurderTribunal_ChosenVictim((CHARACTER)S_LOW_MurderTribunal_DukeStelmane_f4856724-d8a9-4fa4-88c4-d8bd0dfc2d91)
THEN
ClearFlag(LOW_MurderTribunal_MurderVictim_State_IsStelmane_c7b3390f-ba8c-416c-8b51-8c9133a9c99e);

//One of the hands
QRY
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
AND
NOT DB_LOW_MurderTribunal_ChosenVictim(_) //already chose victim? Ignore rest of this rule
AND
DB_LOW_MurderTribunal_PossibleMurderVictims(_Victim,_Hand,_Flag, _)
AND
NOT DB_LOW_MurderTribunal_ChosenVictim(_) //Check if victim was not chosen before continuing the loop
AND
GetFlag(_Flag,_Player,1)
THEN
DB_LOW_MurderTribunal_ChosenVictim(_Victim);

QRY
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
AND
NOT DB_LOW_MurderTribunal_ChosenVictim(_)
THEN
SetFlag(LOW_MurderTribunal_Event_HasNoHand_0a7989d4-19cd-41d9-8b88-3dc00aefc470,_Player);

QRY
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
AND
DB_LOW_MurderTribunal_ChosenVictim(_)
THEN
ClearFlag(LOW_MurderTribunal_Event_HasNoHand_0a7989d4-19cd-41d9-8b88-3dc00aefc470,_Player);
PROC_LOW_MurderTribunal_UpdateGhostAppearance();

//During dialog, if hand is added, check again
IF
FlagSet(_Flag,_Player,_)
AND
DB_LOW_MurderTribunal_PossibleMurderVictims(_,_,_Flag, _)
AND
GetFlag(LOW_MurderTribunal_Event_HasNoHand_0a7989d4-19cd-41d9-8b88-3dc00aefc470,_Player,1)
AND
DB_LOW_MurderTribunal_FlagDialogs(_Dialog)
AND
DB_DialogName(_Dialog,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,_)
AND
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
THEN
DB_NOOP(1);

//During dialog, if hand is removed, check again
IF
FlagCleared(_Flag,_Player,_)
AND
DB_LOW_MurderTribunal_PossibleMurderVictims(_Victim,_,_Flag, _)
AND
DB_LOW_MurderTribunal_ChosenVictim(_Victim)
AND
GetFlag(LOW_MurderTribunal_Event_HasNoHand_0a7989d4-19cd-41d9-8b88-3dc00aefc470,_Player,0)
AND
DB_LOW_MurderTribunal_FlagDialogs(_Dialog)
AND
DB_DialogName(_Dialog,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,_)
AND
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
THEN
DB_NOOP(1);

//END_REGION

//REGION Trial dialog flags

IF
DialogStarted((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_)
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_State_EncounteredSarevok_adc52ea2-18e0-488b-bc49-672fe8d035a7)
THEN
SetFlag(LOW_MurderTribunal_State_EncounteredSarevok_adc52ea2-18e0-488b-bc49-672fe8d035a7);

IF
DialogEnded((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,_)
AND
GetFlag(LOW_MurderTribunal_Event_HasNoHand_0a7989d4-19cd-41d9-8b88-3dc00aefc470,_Player,1)
THEN
ClearFlag(LOW_MurderTribunal_Event_HasNoHand_0a7989d4-19cd-41d9-8b88-3dc00aefc470);

IF
EntityEvent(_Player,"LOW_MurderTribunal_Trial_Approach")
THEN
LookAtEntity((CHARACTER)_Player,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,3.0);

IF
FlagSet(LOW_MurderTribunal_Event_GhostAppears_2ccb1bc5-5a95-e5b4-30b1-4da17aff359e,_,_)
AND
DB_LOW_MurderTribunal_ChosenVictim(_Victim)
THEN
TeleportTo(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb,S_LOW_MurderTribunal_Spectre_Point_2988f76d-2f54-4480-a4a5-5a55d1b38b1d,"LOW_MurderTribunal_SpectreAppears",0,0,0,1,1);
DB_LOW_MurderTribunal_VictimGhostHere(1);

PROC
PROC_LOW_MurderTribunal_UpdateGhostAppearance()
AND
DB_LOW_MurderTribunal_ChosenVictim(_Victim)
THEN
Transform(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb,_Victim,DISGUISE_ceccc4eb-d774-4cd5-9147-12322b81b763);
CopyCharacterEquipment(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb,_Victim);

IF
DialogEnded((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_)
AND
DB_LOW_MurderTribunal_VictimGhostHere(1)
THEN
PROC_FadeOutEntity(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb);
NOT DB_LOW_MurderTribunal_VictimGhostHere(1);

IF
EntityEvent(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb,"LOW_MurderTribunal_SpectreAppears")
THEN
PROC_FadeInEntity(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb);

IF
FlagSet(LOW_MurderTribunal_Event_GhostSpectreDisappears_28980598-7ff2-8364-852f-432f030c1ad3,_,_)
THEN
PROC_FadeOutEntity(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb);
NOT DB_GLO_DefeatCounter(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb,"LOW_MurderTribunal_CourtGhosts");
PROC_GLO_DefeatCounter_CheckFinished("LOW_MurderTribunal_CourtGhosts");

IF
FlagSet((FLAG)LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617,_,_)
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_State_TrialBlocked_2a626bc5-da24-cc32-6cc0-e0c0aa41177b)
THEN
SetFlag(LOW_MurderTribunal_State_TrialBlocked_2a626bc5-da24-cc32-6cc0-e0c0aa41177b);

PROC
PROC_FlagReactionAfterDialog(_Player,LOW_MurderTribunal_Event_GiveBhaalAmulet_51ae9508-df79-2849-21a0-9f9aae78d727)
THEN
ToInventory(S_LOW_MurderTribunal_BhaalAmulet_Sarevok_305049b2-b725-4e84-8f47-84fac8ea51f1,_Player,1,1,1);
RealtimeObjectTimerLaunch(_Player,"LOW_MurderTribunal_PAD_BecameUnholyAssassin",4000);

IF
ObjectTimerFinished(_Player,"LOW_MurderTribunal_PAD_BecameUnholyAssassin")
THEN
DB_LOW_MurderTribunal_BecameUnholyAssassinPAD((CHARACTER)_Player);

IF
DB_LOW_MurderTribunal_BecameUnholyAssassinPAD((CHARACTER)_Player)
AND
NOT DB_DialogPlayers(_,_Player,_)
AND
NOT DB_Is_InCombat(_Player,_)
THEN
PROC_TryStartAD(LOW_MurderTribunal_PAD_BecameUnholyAssassin_e7ba554f-0ddc-74da-4404-ef75e1bd67a5,_Player);
NOT DB_LOW_MurderTribunal_BecameUnholyAssassinPAD((CHARACTER)_Player);

IF
FlagSet((FLAG)LOW_MurderTribunal_Knows_BhaalTempleLocation_0a45cd29-8ae1-43bb-9ef6-b95af1dc6e55,_Player,_)
THEN
PROC_UnlockPartyMarker("LOW_BhaalTemple_Door",S_LOW_BhaalTemple_MapMarker_Door_1fbd7ac6-c15d-4c3e-93e8-f9bff39ed7c0);
PROC_UnlockPartyMarker("LOW_BhaalTemple_Undercity",S_LOW_BhaalTemple_MapMarker_Undercity_b957ef60-4e2d-4722-8fe3-09310b19fffa);
PROC_ShowMarker((CHARACTER)_Player, "LOW_BhaalTemple_Door");
PROC_ShowMarker((CHARACTER)_Player, "LOW_BhaalTemple_Undercity");

//Hide markers if Bhaal temple was unlocked
IF
Opened((ITEM)S_LOW_BhaalTemple_MainDoors_a0774eb3-06c6-40ca-90c8-3dc14fae25f2)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_Knows_BhaalTempleLocation_0a45cd29-8ae1-43bb-9ef6-b95af1dc6e55)
AND
DB_Players(_Player)
THEN
PROC_HideMarker((CHARACTER)_Player, "LOW_BhaalTemple_Door");
PROC_HideMarker((CHARACTER)_Player, "LOW_BhaalTemple_Undercity");

//END_REGION

//END_REGION

//REGION Baptism of Blood

//REGION Abattoir door

IF
Unlocked(S_LOW_MurderTribunal_Abattoir_Keyhole_6cdf37c5-5238-4259-adaf-c41bb4a78ecd,_,_)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf);

IF
Unlocked(S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf,_,_)
THEN
SetCanInteract((ITEM)S_LOW_MurderTribunal_Abattoir_Keyhole_6cdf37c5-5238-4259-adaf-c41bb4a78ecd,0);
Unlock((ITEM)S_LOW_MurderTribunal_Abattoir_Keyhole_6cdf37c5-5238-4259-adaf-c41bb4a78ecd);

IF
AddedTo(S_LOW_MurderTribunal_Abattoir_Key_cdc4c618-346d-48a7-abf5-40f15e6e15a2,_Player,_)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_MurderTribunal_RevealAbattoirDoor")
THEN
SetEntityEvent(S_LOW_MurderTribunal_Abattoir_RevealHelper_f55e9164-70f3-4d34-bb91-7f5e34306f74,"LOW_MurderTribunal_RevealAbattoirDoor",1);

//END_REGION

//REGION Start baptism, baptism dialog

IF
FlagSet((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8,_,_)
THEN
PROC_LOW_MurderTribunal_PrepareBaptism();

PROC
PROC_LOW_MurderTribunal_PrepareBaptism()
AND
DB_SpotPlayers(_Character,"LOW_MurderTribunal_Court",_,_)
THEN
PROC_SpotPlayers_StopSpotting(_Character,"LOW_MurderTribunal_Court");

PROC
PROC_LOW_MurderTribunal_PrepareBaptism()
AND
IsLocked(S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf,1)
THEN
DB_LOW_MurderTribunal_CourtCombatGroupSplit(1);
SetCombatGroupID(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"LOW_MurderTribunal_Sarevok");

PROC
PROC_LOW_MurderTribunal_PrepareBaptism()
AND
DB_LOW_MurderTribunal_CourtCombatGroupSplit(1)
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
AND
_Character != S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6
THEN
SetCombatGroupID(_Character,"LOW_MurderTribunal_Court");

IF
Unlocked(S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf,_,_)
AND
DB_LOW_MurderTribunal_CourtCombatGroupSplit(1)
THEN
SetCombatGroupID(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"LOW_MurderTribunal_Court");
NOT DB_LOW_MurderTribunal_CourtCombatGroupSplit(1);

PROC
PROC_LOW_MurderTribunal_PrepareBaptism()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
TimerLaunch("LOW_MurderTribunal_EnsureAbattoirOpens",20000);

IF
Opened(S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf)
THEN
TimerCancel("LOW_MurderTribunal_EnsureAbattoirOpens");

IF
TimerFinished("LOW_MurderTribunal_EnsureAbattoirOpens")
AND
NOT DB_Defeated((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
NOT DB_Is_InCombat(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_)
THEN
PROC_ItemUnlockAndOpen(S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf);

PROC
PROC_LOW_MurderTribunal_PrepareBaptism()
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
THEN
DB_CustomDialogRange(_Character,14);
PROC_RemoveAllDialogEntriesForSpeaker(_Character);

IF
DB_InRegion((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,(TRIGGER)S_LOW_MurderTribunal_Baptism_Sarevok_Box_f13624f9-c9b8-45e2-80bd-7c627342b706)
AND
QRY_OnlyOnce("LOW_MurderTribunal_InitialBaptismDialog")
THEN
PROC_LOW_MurderTribunal_InitialBaptismDialog();

PROC
PROC_LOW_MurderTribunal_InitialBaptismDialog()
THEN
DB_Dialogs(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,(DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1);
DB_Dialogs(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,(DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1);
DB_Dialogs(S_LOW_MurderTribunal_Amelyssan_eca47258-a8ad-4453-a12a-3f39f8e1ca32,(DIALOGRESOURCE)LOW_MurderTribunal_Amelyssan_abd2b823-3450-6381-194b-b6e0c91d0142);
DB_Dialogs(S_LOW_MurderTribunal_Illasera_df3a6de2-ba33-4717-9861-ea9f42d35fec,(DIALOGRESOURCE)LOW_MurderTribunal_Illasera_f78c88af-5279-827c-49ea-e22dfa95dc8c);
DB_Dialogs(S_LOW_MurderTribunal_Sendai_565accd2-0fdc-423e-ad68-752988a509b4,(DIALOGRESOURCE)LOW_MurderTribunal_Sendai_146917d9-6b28-6374-1c93-83670984047d);

PROC
PROC_LOW_MurderTribunal_PrepareBaptism()
THEN
PROC_RemoveDBTrespassTrigger((TRIGGER)S_LOW_MurderTribunal_Court_Trespass_Box_59aa4931-3db6-437e-888a-ee980b25ab44);

IF
DB_PermaDefeated((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
DB_Dialogs(_Character,(DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(_Character);

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
AND
_Character != S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6
THEN
PROC_FadeOutEntity(_Character,"LOW_MurderTribunal_GhostsToBaptism");

IF
EntityEvent(_Character,"LOW_MurderTribunal_GhostsToBaptism")
AND
DB_LOW_MurderTribunal_Court_NPCs((CHARACTER)_Character,_,_Trigger)
THEN
TeleportTo(_Character,_Trigger);
PROC_FadeInEntity(_Character,"");

IF
DB_InRegion((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,(TRIGGER)S_LOW_MurderTribunal_Baptism_Sarevok_Box_f13624f9-c9b8-45e2-80bd-7c627342b706)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_Valeria_Knows_IsBaptismSacrifice_dc320d5b-ed30-4744-8163-efd94e52844f)
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617)
THEN
DB_SpotPlayers_Continuous(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"LOW_MurderTribunal_BaptismInitialSpot");
DB_SpotPlayers_SpotTrigger(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"LOW_MurderTribunal_BaptismInitialSpot",S_LOW_MurderTribunal_Baptism_InitialSpot_Trigger_deeb8b10-d8af-41b7-924a-c65c4a06c049);
DB_SpotPlayers((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"LOW_MurderTribunal_BaptismInitialSpot",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GlobalFlag(LOW_MurderTribunal_Valeria_Knows_IsBaptismSacrifice_dc320d5b-ed30-4744-8163-efd94e52844f) //this flag is set after the first HasMet
AND
DB_SpotPlayers(_Character,"LOW_MurderTribunal_BaptismInitialSpot",_,_)
THEN
PROC_SpotPlayers_StopSpotting(_Character,"LOW_MurderTribunal_BaptismInitialSpot");

IF
DB_GlobalFlag(LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617)
AND
DB_SpotPlayers(_Character,"LOW_MurderTribunal_BaptismInitialSpot",_,_)
THEN
PROC_SpotPlayers_StopSpotting(_Character,"LOW_MurderTribunal_BaptismInitialSpot");

IF
DB_SpotPlayers_Spotted(_,"LOW_MurderTribunal_BaptismInitialSpot",_Player)
AND
NOT DB_CantTalk(_Player)
AND
QRY_StartDialog(LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_Player)
THEN
PROC_SpotPlayers_StopSpotting("LOW_MurderTribunal_BaptismInitialSpot");

QRY
QRY_SelectCustomDialog(_Character,_Player)
AND
DB_Dialogs(_Character,(DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1)
AND
NOT QRY_MurderTribunal_TrySelectBaptismDialog((GUIDSTRING)_Player)
THEN
DB_SelectedDialog(NULL_00000000-0000-0000-0000-000000000000,_Player);
PROC_PlayCantUseItemAD((CHARACTER)_Player);

QRY
QRY_MurderTribunal_TrySelectBaptismDialog((GUIDSTRING)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_Player)
THEN
DB_SelectedDialog(LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_Player);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1,_DialogId)
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
AND
_Character != S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Character,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
PROC_DialogAddSpeakingActor(_DialogId,_Character);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1,_DialogId)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
PROC_DialogAddSpeakingActor(_DialogId,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);

//END_REGION

//REGION Cultists

IF
DB_LOW_MurderTribunal_Cultists((CHARACTER)_Cultist)
THEN
SetOnStage(_Cultist,0);
DB_LOW_MurderTribunal_Cultists_OffStage(_Cultist);
DB_GLO_DefeatCounter(_Cultist,"LOW_MurderTribunal_Cultists");

//REGION Cultists fading in/out

IF
DB_InRegion(_,S_LOW_MurderTribunal_Cultists_Appear_Trigger_db91a5d9-7c60-42ce-b8f1-a3e7e9199372)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617)
AND
DB_LOW_MurderTribunal_Cultists_OffStage(_)
AND
NOT DB_LOW_MurderTribunal_Baptism_FadingCultists(_)
THEN
DB_LOW_MurderTribunal_Baptism_FadingCultists(1);
TimerLaunch("LOW_MurderTribunal_Baptism_FadeCultist",100);

IF
DB_GlobalFlag(LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617)
AND
NOT DB_LOW_MurderTribunal_Baptism_FadingCultists(_)
AND
NOT DB_DialogNPCs(_,(CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_)
AND
QRY_LOW_MurderTribunal_Baptism_AnyCultistOnStage()
THEN
DB_LOW_MurderTribunal_Baptism_FadingCultists(0);
TimerLaunch("LOW_MurderTribunal_Baptism_FadeCultist",100);

IF
DB_LOW_MurderTribunal_Baptism_FadingCultists(0)
AND
DB_LOW_MurderTribunal_Cultists(_Cultist)
AND
NOT DB_LOW_MurderTribunal_Cultists_OffStage(_Cultist)
AND
NOT DB_Is_InCombat(_Cultist,_)
THEN
DB_LOW_MurderTribunal_Cultists_ToFade(_Cultist);

IF
DB_LOW_MurderTribunal_Baptism_FadingCultists(1)
AND
DB_LOW_MurderTribunal_Cultists_OffStage(_Cultist)
THEN
DB_LOW_MurderTribunal_Cultists_ToFade(_Cultist);

IF
TimerFinished("LOW_MurderTribunal_Baptism_FadeCultist")
AND
DB_LOW_MurderTribunal_Baptism_FadingCultists(_FadeIn)
AND
QRY_GetRandom("DB_LOW_MurderTribunal_Cultists_ToFade",1,"DB_QRY_RTN_LOW_MurderTribunal_Baptism_SelectedCultist")
AND
DB_QRY_RTN_LOW_MurderTribunal_Baptism_SelectedCultist((CHARACTER)_Cultist)
THEN
PROC_LOW_MurderTribunal_FadeCultist(_Cultist,_FadeIn,"LOW_MurderTribunal_CultistFade");
NOT DB_QRY_RTN_LOW_MurderTribunal_Baptism_SelectedCultist(_Cultist);
NOT DB_LOW_MurderTribunal_Cultists_ToFade(_Cultist);

PROC
PROC_LOW_MurderTribunal_FadeCultist((GUIDSTRING)_Cultist,0,(STRING)_FadeEvent)
THEN
PROC_FadeOutEntity(_Cultist,_FadeEvent);
DB_LOW_MurderTribunal_Cultists_OffStage((CHARACTER)_Cultist);
NOT DB_GLO_DefeatCounter(_Cultist,"LOW_MurderTribunal_Bhaalists");
PROC_GLO_DefeatCounter_CheckFinished("LOW_MurderTribunal_Bhaalists");

PROC
PROC_LOW_MurderTribunal_FadeCultist((GUIDSTRING)_Cultist,1,(STRING)_FadeEvent)
THEN
PROC_FadeInEntity(_Cultist,_FadeEvent);
NOT DB_LOW_MurderTribunal_Cultists_OffStage((CHARACTER)_Cultist);
DB_GLO_DefeatCounter(_Cultist,"LOW_MurderTribunal_Bhaalists");
PROC_GLO_DefeatCounter_CheckFinished("LOW_MurderTribunal_Bhaalists");

IF
TimerFinished("LOW_MurderTribunal_Baptism_FadeCultist")
AND
DB_LOW_MurderTribunal_Baptism_FadingCultists(_FadeIn)
AND
NOT DB_LOW_MurderTribunal_Cultists_ToFade(_)
THEN
NOT DB_LOW_MurderTribunal_Baptism_FadingCultists(_FadeIn);

QRY
QRY_LOW_MurderTribunal_Baptism_AnyCultistOnStage()
AND
DB_LOW_MurderTribunal_Cultists(_Cultist)
AND
NOT DB_LOW_MurderTribunal_Cultists_OffStage(_Cultist)
THEN
DB_NOOP(1);

IF
TimerFinished("LOW_MurderTribunal_Baptism_FadeCultist")
AND
DB_LOW_MurderTribunal_Baptism_FadingCultists(_)
AND
Random(300,_Random)
AND
IntegerSum(_Random,100,_Time)
THEN
TimerLaunch("LOW_MurderTribunal_Baptism_FadeCultist",_Time);

//END_REGION

//REGION Cultists chant

IF
DB_Is_InCombat(_Cultist,_)
AND
DB_LOW_MurderTribunal_Cultists((CHARACTER)_Cultist)
AND
NOT DB_LOW_MurderTribunal_Cultists_InCombat(1)
AND
DB_LOW_MurderTribunal_Cultists_ChantTiming("CombatAD_Delay",_Turns)
THEN
DB_LOW_MurderTribunal_Cultists_InCombat(1);
DB_LOW_MurderTribunal_Cultists_ChantCooldown(_Turns);

IF
DB_LOW_MurderTribunal_Cultists_InCombat(1)
AND
DB_LOW_MurderTribunal_Cultists(_Cultist)
AND
NOT DB_Is_InCombat(_Cultist,_)
AND
NOT QRY_LOW_MurderTribunal_AnyCultistInCombat()
THEN
NOT DB_LOW_MurderTribunal_Cultists_InCombat(1);

QRY
QRY_LOW_MurderTribunal_AnyCultistInCombat()
AND
DB_LOW_MurderTribunal_Cultists(_Cultist)
AND
DB_Is_InCombat(_Cultist,_)
THEN
DB_NOOP(1);

QRY
QRY_LOW_MurderTribunal_IsInCultistCombat((GUIDSTRING)_Entity)
AND
DB_Is_InCombat(_Entity,_CombatId)
AND
DB_LOW_MurderTribunal_Cultists(_Cultist)
AND
DB_Is_InCombat(_Cultist,_CombatId)
THEN
DB_NOOP(1);

IF
TurnStarted(_Entity)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
//the above prevents the query below from triggering before the cultists appear
//and prevents the query triggering for every single entity that starts a turn
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_CultistsDefeated_0ac0051c-8748-4bff-a0f5-40cedfc178a8)
AND
DB_CurrentLevel("CTY_Main_A") //further limit the query from triggering
AND
QRY_LOW_MurderTribunal_IsInCultistCombat(_Entity)
THEN
PROC_LOW_MurderTribunal_EvaluateCultistChantCooldown(_Entity);

//If cooldown is at 0, play chant and reset cooldown
PROC
PROC_LOW_MurderTribunal_EvaluateCultistChantCooldown((GUIDSTRING)_Entity)
AND
DB_LOW_MurderTribunal_Cultists_ChantCooldown(0)
AND
DB_LOW_MurderTribunal_Cultists((CHARACTER)_Entity)
AND
DB_LOW_MurderTribunal_Cultists_ChantTiming("CombatAD_Interval",_Interval)
THEN
NOT DB_LOW_MurderTribunal_Cultists_ChantCooldown(0);
DB_LOW_MurderTribunal_Cultists_ChantCooldown(_Interval);
PROC_LOW_MurderTribunal_DoCultistCombatChant();

//Any combat round ticks down the cooldown
PROC
PROC_LOW_MurderTribunal_EvaluateCultistChantCooldown((GUIDSTRING)_)
AND
DB_LOW_MurderTribunal_Cultists_ChantCooldown(_Index)
AND
_Index > 0
AND
IntegerSubtract(_Index,1,_New)
THEN
NOT DB_LOW_MurderTribunal_Cultists_ChantCooldown(_Index);
DB_LOW_MurderTribunal_Cultists_ChantCooldown(_New);

PROC
PROC_LOW_MurderTribunal_DoCultistCombatChant()
AND
NOT DB_LOW_MurderTribunal_Baptism_Chant_ToggleFlag(1)
THEN
DB_LOW_MurderTribunal_Baptism_Chant_ToggleFlag(1);

PROC
PROC_LOW_MurderTribunal_DoCultistCombatChant()
AND
DB_LOW_MurderTribunal_Cultists(_Cultist)
AND
DB_Is_InCombat(_Cultist,_)
AND
NOT DB_Defeated(_Cultist)
THEN
SetEntityEvent(_Cultist,"LOW_MurderTribunal_CultistChant");

IF
DB_InRegion(_,(TRIGGER)S_LOW_MurderTribunal_Cultists_Chant_Trigger_a1ab1dbd-f255-4249-800b-98599cc63a35)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729)
AND
NOT DB_LOW_MurderTribunal_ValeriaFreed(1)
AND
NOT DB_LOW_MurderTribunal_Cultists_ValeriaAndCultistsDefeated(1)
AND
NOT DB_LOW_MurderTribunal_Cultists_InCombat(1)
AND
NOT DB_LOW_MurderTribunal_Cultists_Chanting(1)
AND
DB_LOW_MurderTribunal_Cultists_ChantTiming("RepeatedAD_InitialDelay",_Delay)
THEN
DB_LOW_MurderTribunal_Cultists_Chanting(1);
TimerLaunch("LOW_MurderTribunal_CultistChant",_Delay);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_CultistsDefeated_0ac0051c-8748-4bff-a0f5-40cedfc178a8)
AND
DB_Defeated(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
AND
NOT DB_LOW_MurderTribunal_Cultists_ValeriaAndCultistsDefeated(1)
THEN
DB_LOW_MurderTribunal_Cultists_ValeriaAndCultistsDefeated(1);

IF
DB_LOW_MurderTribunal_Cultists_ValeriaAndCultistsDefeated(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_CultistsDefeated_0ac0051c-8748-4bff-a0f5-40cedfc178a8)
THEN
NOT DB_LOW_MurderTribunal_Cultists_ValeriaAndCultistsDefeated(1);

IF
DB_LOW_MurderTribunal_Cultists_ValeriaAndCultistsDefeated(1)
AND
NOT DB_Defeated(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
NOT DB_LOW_MurderTribunal_Cultists_ValeriaAndCultistsDefeated(1);

IF
DB_LOW_MurderTribunal_Cultists_Chanting(1)
AND
NOT DB_InRegion(_,(TRIGGER)S_LOW_MurderTribunal_Cultists_Chant_Trigger_a1ab1dbd-f255-4249-800b-98599cc63a35)
THEN
NOT DB_LOW_MurderTribunal_Cultists_Chanting(1);
TimerCancel("LOW_MurderTribunal_CultistChant");

IF
DB_LOW_MurderTribunal_Cultists_Chanting(1)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729)
THEN
NOT DB_LOW_MurderTribunal_Cultists_Chanting(1);
TimerCancel("LOW_MurderTribunal_CultistChant");

IF
DB_LOW_MurderTribunal_Cultists_Chanting(1)
AND
DB_LOW_MurderTribunal_ValeriaFreed(1)
THEN
NOT DB_LOW_MurderTribunal_Cultists_Chanting(1);
TimerCancel("LOW_MurderTribunal_CultistChant");

IF
DB_LOW_MurderTribunal_Cultists_Chanting(1)
AND
DB_LOW_MurderTribunal_Cultists_ValeriaAndCultistsDefeated(1) //timer will continue for Valeria's ADs
THEN
NOT DB_LOW_MurderTribunal_Cultists_Chanting(1);
TimerCancel("LOW_MurderTribunal_CultistChant");

IF
DB_LOW_MurderTribunal_Cultists_Chanting(1)
AND
DB_LOW_MurderTribunal_Cultists_InCombat(1)
THEN
NOT DB_LOW_MurderTribunal_Cultists_Chanting(1);
TimerCancel("LOW_MurderTribunal_CultistChant");

IF
TimerFinished("LOW_MurderTribunal_CultistChant")
AND
DB_LOW_MurderTribunal_Cultists(_Cultist)
THEN
DB_LOW_MurderTribunal_Baptism_Chant_ToggleFlag(1);
SetEntityEvent(_Cultist,"LOW_MurderTribunal_CultistChant");

IF
TimerFinished("LOW_MurderTribunal_CultistChant")
AND
DB_LOW_MurderTribunal_Cultists_ChantTiming("RepeatedAD_Interval",_Interval)
THEN
TimerLaunch("LOW_MurderTribunal_CultistChant",_Interval);

//Flag is global and toggled here to prevent it from happening for every chanting cultist
IF
AutomatedDialogEnded(_AD,_)
AND
DB_LOW_MurderTribunal_Cultists_ChantADs(_AD)
AND
DB_LOW_MurderTribunal_Baptism_Chant_ToggleFlag(1)
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_State_CultistChant_ChantB_d6f22765-b6ca-47ce-91b7-83b352eea3fe)
THEN
SetFlag(LOW_MurderTribunal_State_CultistChant_ChantB_d6f22765-b6ca-47ce-91b7-83b352eea3fe);
NOT DB_LOW_MurderTribunal_Baptism_Chant_ToggleFlag(1);

IF
AutomatedDialogEnded(_AD,_)
AND
DB_LOW_MurderTribunal_Cultists_ChantADs(_AD)
AND
DB_LOW_MurderTribunal_Baptism_Chant_ToggleFlag(1)
AND
DB_GlobalFlag(LOW_MurderTribunal_State_CultistChant_ChantB_d6f22765-b6ca-47ce-91b7-83b352eea3fe)
THEN
ClearFlag(LOW_MurderTribunal_State_CultistChant_ChantB_d6f22765-b6ca-47ce-91b7-83b352eea3fe);
NOT DB_LOW_MurderTribunal_Baptism_Chant_ToggleFlag(1);

//END_REGION

//END_REGION

//REGION Valeria state

IF
DB_InRegion(_,(TRIGGER)S_LOW_MurderTribunal_SUB_c1739d1e-2f74-400d-8895-7c6cb42cda45)
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608)
THEN
PROC_GlobalSetFlagAndCache(LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608);

IF
FlagSet(LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608,_,_)
AND
NOT DB_Dead((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
PROC_LOW_MurderTribunal_PrepareValeria(0);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
DB_Dialogs(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,(DIALOGRESOURCE)LOW_MurderTribunal_Valeria_b16af572-5cc7-ac8c-15a8-2ca2e68b9da2);
DB_LOW_MurderTribunal_DoValeriaSharessCaressSetup(1);

IF
FlagSet(LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608,_,_)
AND
DB_Dead((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
PROC_LOW_MurderTribunal_PrepareValeria(1);

IF
FlagSet(LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608,_,_)
THEN
DB_Dialogs(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1);

//Valeria chained combat ("sacrifice Valeria" option in dialogue)
IF
FlagSet(LOW_MurderTribunal_Event_AttackValeriaAfterDialog_af27add8-8783-9f1d-f93a-b8e12b677d5a,_,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,1)
THEN
DB_HostileToPlayerGroup((FACTION)ACT3_LOW_MurderTribunal_Valeria_a0ee262b-e7f3-4ac5-92f0-7890476fb3c4,(CHARACTER)_Player);
SetCanJoinCombat(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,1);
SetCanFight(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,1);

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_AttackValeriaAfterDialog_af27add8-8783-9f1d-f93a-b8e12b677d5a,_,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,1)
THEN
PROC_EnterCombat(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_Player);
DB_LOW_MurderTribunal_ValeriaChainedCombat(1);

//Reset being able to fight Valeria in combat after she leaves combat
IF
LeftCombat((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
AND
DB_LOW_MurderTribunal_ValeriaChainedCombat(1)
AND
NOT DB_LOW_MurderTribunal_ValeriaFreed(1)
THEN
PROC_SetCanFight(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,0);
SetCanJoinCombat(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,0);

IF
LeftCombat((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
AND
DB_LOW_MurderTribunal_ValeriaChainedCombat(1)
THEN
NOT DB_LOW_MurderTribunal_ValeriaChainedCombat(1);

//Valeria at Tribunal
PROC
PROC_LOW_MurderTribunal_PrepareValeria((INTEGER)_)
THEN
TeleportTo(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,S_LOW_MurderTribunal_Baptism_Valeria_Point_2ddc0200-9b06-436f-8d7c-b8f11498811c,"",0,0,0,1,1);
SetOnStage((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,1);
SetFaction((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,(FACTION)ACT3_LOW_MurderTribunal_Valeria_a0ee262b-e7f3-4ac5-92f0-7890476fb3c4);

//0 = alive and chained
PROC
PROC_LOW_MurderTribunal_PrepareValeria(0)
THEN
PROC_LOW_MurderTribunal_SetValeriaChained(1);
DB_SpotPlayers((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaChainedSpot",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);
SetCanInteract((ITEM)S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,1);

//1 = dead
PROC
PROC_LOW_MurderTribunal_PrepareValeria(1)
THEN
CreateSurface(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"SurfaceBlood",2.5,-1.0,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
SetCanInteract((ITEM)S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,0);

PROC
PROC_LOW_MurderTribunal_SetValeriaChained(0)
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
THEN
SetFlag(LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617);

PROC
PROC_LOW_MurderTribunal_SetValeriaChained(0)
THEN
DB_LOW_MurderTribunal_ValeriaFreed(1);
SetFlag(LOW_MurderTribunal_State_FreedValeria_bc52002a-08fd-0b96-a273-f949e73353f9);
DetachSpring(S_LOW_MurderTribunal_Baptism_Chain01_Spring_b947aefe-9626-4c2a-a524-24cbb32d40f4,"Dummy_Attach_01");
DetachSpring(S_LOW_MurderTribunal_Baptism_Chain01_Spring_b947aefe-9626-4c2a-a524-24cbb32d40f4,"Dummy_Attach_02");
SetOnStage(S_LOW_MurderTribunal_Baptism_Chain01_Spring_b947aefe-9626-4c2a-a524-24cbb32d40f4,0);
RemoveStatus(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MURDERTRIBUNAL_CHAINED",NULL_00000000-0000-0000-0000-000000000000);
PROC_SetCanFight(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,1);
SetCanJoinCombat(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,1);
PROC_SetRelationMutual((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,(FACTION)ACT3_LOW_MurderTribunal_Valeria_a0ee262b-e7f3-4ac5-92f0-7890476fb3c4,0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,0);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
DB_Dialogs(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,(DIALOGRESOURCE)LOW_MurderTribunal_Valeria_b16af572-5cc7-ac8c-15a8-2ca2e68b9da2);
PROC_CharacterEnableAllCrimes((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
PROC_CharacterDisableCrime((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_FreeValeria");
PROC_SelfHealing_Enable((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);

PROC
PROC_LOW_MurderTribunal_SetValeriaChained(1)
THEN
NOT DB_LOW_MurderTribunal_ValeriaFreed(1);
ClearFlag(LOW_MurderTribunal_State_FreedValeria_bc52002a-08fd-0b96-a273-f949e73353f9);
AttachSpring(S_LOW_MurderTribunal_Baptism_Chain01_Spring_b947aefe-9626-4c2a-a524-24cbb32d40f4,"Dummy_Attach_01",S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"Ankle_R");
AttachSpring(S_LOW_MurderTribunal_Baptism_Chain01_Spring_b947aefe-9626-4c2a-a524-24cbb32d40f4,"Dummy_Attach_02",S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,"Dummy_Pos_01");
SetOnStage(S_LOW_MurderTribunal_Baptism_Chain01_Spring_b947aefe-9626-4c2a-a524-24cbb32d40f4,1);
ApplyStatus(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MURDERTRIBUNAL_CHAINED",-1.0,0,NULL_00000000-0000-0000-0000-000000000000);
PROC_SetCanFight(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,0);
SetCanJoinCombat(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,0);
PROC_CharacterDisableAllCrimes((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
PROC_CharacterDisableCrime((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_FreeValeria");
PROC_SelfHealing_Disable((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);

PROC
PROC_LOW_MurderTribunal_SetValeriaChained(1)
AND
IsLocked((ITEM)S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,0)
THEN
Lock(S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,"MT_CHAINS");

IF
Unlocked(S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,_,_)
AND
HasAppliedStatus(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MURDERTRIBUNAL_CHAINED",1)
THEN
PROC_LOW_MurderTribunal_SetValeriaChained(0);

IF
DestroyedBy(S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,_Character,_,_)
AND
HasAppliedStatus(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MURDERTRIBUNAL_CHAINED",1)
THEN
PROC_LOW_MurderTribunal_SetValeriaChained(0);

IF
FlagSet((FLAG)LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617,_,_)
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
AND
NOT DB_Dialogs(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,(DIALOGRESOURCE)LOW_MurderTribunal_Valeria_b16af572-5cc7-ac8c-15a8-2ca2e68b9da2)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
DB_Dialogs(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,(DIALOGRESOURCE)LOW_MurderTribunal_Valeria_b16af572-5cc7-ac8c-15a8-2ca2e68b9da2);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617)
AND
DB_LOW_MurderTribunal_ValeriaFreed(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_ThreatenedValeria_20981273-1955-a5a0-0b32-610490cac952)
AND
NOT DB_Defeated(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
DB_SpotPlayers(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaFreed",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617)
AND
DB_LOW_MurderTribunal_ValeriaFreed(1)
AND
NOT DB_Is_InCombat(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
AND
NOT DB_DialogSpeakers(_,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
AND
NOT DB_LOW_MurderTribunal_ValeriaWaitingToFlee(1)
THEN
DB_LOW_MurderTribunal_ValeriaWaitingToFlee(1);
ObjectTimerLaunch((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaWaitingToFlee",2000);

IF
DB_LOW_MurderTribunal_ValeriaWaitingToFlee(1)
AND
DB_Is_InCombat(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
THEN
NOT DB_LOW_MurderTribunal_ValeriaWaitingToFlee(1);
ObjectTimerCancel((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaWaitingToFlee");

IF
DB_LOW_MurderTribunal_ValeriaWaitingToFlee(1)
AND
DB_DialogSpeakers(_,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
THEN
NOT DB_LOW_MurderTribunal_ValeriaWaitingToFlee(1);
ObjectTimerCancel((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaWaitingToFlee");

IF
ObjectTimerFinished((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaWaitingToFlee")
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaLeaves_Notify");
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);

PROC
PROC_ReadyToMoveOn((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaLeaves_Notify")
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_Valeria_Fleeing_0431534c-0382-c9a5-84e0-5d174c42bd75,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
PROC_DisappearOutOfSightTo((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,TeleportTrigger_MurderTribunal_Entrance_09d5165c-dcc9-4891-a177-6915482d3426,"Run",0,"LOW_MurderTribunal_ValeriaLeaves");
//Make sure the door is unlocked
PROC_ItemUnlockAndOpen((ITEM)S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf);

PROC
PROC_SpotPlayers_Spotted(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaFreed",_Player)
AND
DB_Players(_Player)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_MurderTribunal_Valeria_b16af572-5cc7-ac8c-15a8-2ca2e68b9da2,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_Player)
THEN
PROC_SpotPlayers_StopSpotting(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaFreed");

//END_REGION

//REGION Valeria ADs

PROC
PROC_FlagReactionAfterDialog(_,LOW_Sarevok_BloodBaptism_HasMet_61f94311-a251-41fb-3141-4c933b260587)
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_Valeria_Knows_IsBaptismSacrifice_dc320d5b-ed30-4744-8163-efd94e52844f)
THEN
SetFlag(LOW_MurderTribunal_Valeria_Knows_IsBaptismSacrifice_dc320d5b-ed30-4744-8163-efd94e52844f);

IF
TimerFinished("LOW_MurderTribunal_CultistChant")
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_CultistChant_ChantB_d6f22765-b6ca-47ce-91b7-83b352eea3fe)
AND
NOT DB_Defeated(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
AND
DB_LOW_MurderTribunal_Cultists_ChantTiming("ValeriaAD_Delay",_Delay)
THEN
TimerLaunch("LOW_MurderTribunal_ValeriaChainedAD",_Delay);

PROC
PROC_StateSet_Defeated(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
TimerCancel("LOW_MurderTribunal_ValeriaChainedAD");

IF
TimerFinished("LOW_MurderTribunal_ValeriaChainedAD")
AND
NOT DB_DialogSpeakers(_,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
AND
QRY_SpeakerIsAvailable(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_Valeria_Chained_6c97c3ad-8588-4020-bd8d-aaa7b2ba21f6,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);

IF
TurnStarted(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608)
AND
NOT DB_CantTalk_IgnoreCombat(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_FreedValeria_bc52002a-08fd-0b96-a273-f949e73353f9)
AND
QRY_OnlyOnce("LOW_MurderTribunal_AD_Valeria_Combat")
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_Valeria_Combat_085ad3fb-90e9-b0be-3ca5-22da5836955c,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);

//Chained AD and spotting before baptism begins
//This behaviour is cancelled by starting the baptism, threatening or freeing Valeria
IF
FlagSet(_Flag,_,_)
AND
DB_LOW_MurderTribunal_CancelValeriaChainedBehaviorFlags(_Flag)
THEN
PROC_SpotPlayers_StopSpotting("LOW_MurderTribunal_ValeriaChainedSpot");
TimerCancel("LOW_MurderTribunal_ValeriaChainedAD");
TimerCancel("LOW_MurderTribunal_ValeriaChained_BeforeBaptism");

//DB clean-up
IF
FlagSet(_Flag,_,_)
AND
DB_LOW_MurderTribunal_CancelValeriaChainedBehaviorFlags(_Flag)
AND
DB_LOW_MurderTribunal_CancelValeriaChainedBehaviorFlags(_DeleteFlag)
THEN
NOT DB_LOW_MurderTribunal_CancelValeriaChainedBehaviorFlags(_DeleteFlag);

PROC
PROC_SpotPlayers_Spotted(_,"LOW_MurderTribunal_ValeriaChainedSpot",_)
THEN
TimerLaunch("LOW_MurderTribunal_ValeriaChained_BeforeBaptism",1000);

IF
TimerFinished("LOW_MurderTribunal_ValeriaChained_BeforeBaptism")
AND
NOT DB_DialogSpeakers(_,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_Valeria_Chained_BeforeBaptism_ade50ab9-981c-5703-f8df-59ca3a219c84,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);

IF
TimerFinished("LOW_MurderTribunal_ValeriaChained_BeforeBaptism")
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
THEN
TimerLaunch("LOW_MurderTribunal_ValeriaChained_BeforeBaptism",12000);

//Reaction to being attacked
IF
AttackedBy(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_,_,_,_,_,_)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608)
AND
NOT DB_LOW_MurderTribunal_ValeriaFreed(1)
THEN
PROC_LOW_MurderTribunal_ValeriaAttackedChained();

PROC
PROC_LOW_MurderTribunal_ValeriaAttackedChained()
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_ThreatenedValeria_20981273-1955-a5a0-0b32-610490cac952)
THEN
SetFlag((FLAG)LOW_MurderTribunal_State_ThreatenedValeria_20981273-1955-a5a0-0b32-610490cac952);

PROC
PROC_LOW_MurderTribunal_ValeriaAttackedChained()
AND
NOT DB_LOW_MurderTribunal_ValeriaAttackedAD_OnCooldown(1)
AND
NOT DB_DialogSpeakers(_,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_Valeria_Attacked_8703838a-65ec-ea0a-5541-e20af4a0d251,S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);

PROC
PROC_LOW_MurderTribunal_ValeriaAttackedChained()
AND
NOT DB_LOW_MurderTribunal_ValeriaAttackedAD_OnCooldown(1)
THEN
DB_LOW_MurderTribunal_ValeriaAttackedAD_OnCooldown(1);
RealtimeObjectTimerLaunch(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaAttackedAD",4500);

IF
ObjectTimerFinished(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaAttackedAD")
THEN
NOT DB_LOW_MurderTribunal_ValeriaAttackedAD_OnCooldown(1);

//END_REGION

//REGION Bloodbath, resolution dialogue

IF
FlagSet(LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8,_,_)
AND
DB_Dead(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
DB_LOW_MurderTribunal_ValeriaDeadBeforeBaptism(1);

IF
FlagSet(LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8,_,_)
AND
NOT DB_Dead(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
DB_LOW_MurderTribunal_ValeriaDeadBeforeBaptism(0);

//Kill Valeria at Tribunal
IF
DB_Dead(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
AND
DB_LOW_MurderTribunal_ValeriaDeadBeforeBaptism(0)
THEN
PROC_TriggerRegisterForPlayers(S_LOW_MurderTribunal_Baptism_AfterKill_Trigger_486f0c1a-2543-4930-8f3c-7a5f6409f80f);

//Murder Tribunal Valeria killer DB
IF
KilledBy(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_Player,_,_)
AND
DB_Players((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608)
THEN
DB_LOW_MurderTribunal_ValeriaKiller((CHARACTER)_Player);

IF
DB_LOW_MurderTribunal_ValeriaKiller(_Player)
AND
IsTagged(_Player, (TAG)PALADIN_6d85ab2d-5c23-498c-a61e-98f05a00177a, 1)
THEN
PROC_GLO_PaladinOathbreaker_BrokeOath(_Player);

IF
DB_InRegion(_Player,S_LOW_MurderTribunal_Baptism_AfterKill_Trigger_486f0c1a-2543-4930-8f3c-7a5f6409f80f)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608)
AND
GetFlag((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_Player,0)
THEN
SetFlag((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_Player);
PROC_TriggerUnregisterForPlayers(S_LOW_MurderTribunal_Baptism_AfterKill_Trigger_486f0c1a-2543-4930-8f3c-7a5f6409f80f);

//Valeria already dead/enter bloodbath
IF
DB_InRegion(_Player,S_LOW_MurderTribunal_Baptism_Bloodbath_Box_d84bf38f-0f7b-4100-9f5c-f6ad2144daa0)
AND
DB_Players(_Player)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_ValeriaAtTribunal_908ab156-aaf6-40f5-8e5b-e9dae9935608)
AND
DB_Dead((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
AND
GetFlag((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_Player,0)
THEN
SetFlag((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_Player);

IF
EnteredTrigger(_Character,S_LOW_MurderTribunal_Baptism_Bloodbath_Box_d84bf38f-0f7b-4100-9f5c-f6ad2144daa0)
AND
Exists(_Character,1)
THEN
ApplyStatus(_Character,"BLOOD_COVERED_FULL",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

IF
ItemEnteredTrigger(_Item,S_LOW_MurderTribunal_Baptism_Bloodbath_Box_d84bf38f-0f7b-4100-9f5c-f6ad2144daa0,_)
AND
Exists(_Item,1)
THEN
ApplyStatus(_Item,"BLOOD_COVERED_FULL",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_Player,_)
THEN
PROC_SpotPlayers_StopSpotting("LOW_MurderTribunal_BaptismInitialSpot");

IF
FlagSet((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_Player,_)
AND
NOT DB_LOW_MurderTribunal_BaptisedPlayer(_)
AND
NOT DB_SpotPlayers(_,"LOW_MurderTribunal_Baptism",_,_)
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
THEN
DB_SpotPlayers_HasObjectFlag(_Character,"LOW_MurderTribunal_Baptism",LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,1);
DB_SpotPlayers(_Character,"LOW_MurderTribunal_Baptism",NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_,_)
AND
NOT DB_LOW_MurderTribunal_BaptisedPlayer(_)
AND
DB_SpotPlayers(_,"LOW_MurderTribunal_Baptism",_,_)
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
THEN
NOT DB_OnlyOnce("LOW_MurderTribunal_Baptism");
PROC_SpotPlayers_RestartSpotting(_Character,"LOW_MurderTribunal_Baptism");

IF
FlagSet((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_Player,_)
AND
NOT DB_LOW_MurderTribunal_BaptisedPlayer((CHARACTER)_Player)
THEN
DB_LOW_MurderTribunal_BaptisedPlayer((CHARACTER)_Player);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_MurderTribunal_Event_ValeriaLeavesTribunal_57a75bf2-2648-c9f8-e75e-8366c582225e)
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,"LOW_MurderTribunal_ValeriaLeaves_Notify");
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);

PROC
PROC_SpotPlayers_Spotted(_,"LOW_MurderTribunal_Baptism",_Player)
AND
NOT DB_DialogName(LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_)
AND
NOT DB_PlayerTrespassing(_Player,_,(TRIGGER)S_LOW_MurderTribunal_Court_Trespass_Box_59aa4931-3db6-437e-888a-ee980b25ab44)
AND
NOT DB_OnlyOnce("LOW_MurderTribunal_Baptism")
AND
DB_Players(_Player)
AND
QRY_LOW_MurderTribunal_FindPreferredBaptismSpeaker(_Player)
AND
DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_Speaker)
AND
QRY_StartDialog_Fixed(LOW_MurderTribunal_Sarevok_BloodBaptism_c109fe2f-290c-ec28-9894-4a86ce153ab1,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_Speaker)
THEN
DB_OnlyOnce("LOW_MurderTribunal_Baptism");

IF
DB_OnlyOnce("LOW_MurderTribunal_Baptism")
AND
DB_SpotPlayers(_Character,"LOW_MurderTribunal_Baptism",_,_)
THEN
PROC_SpotPlayers_StopSpotting(_Character,"LOW_MurderTribunal_Baptism");

QRY
QRY_LOW_MurderTribunal_FindPreferredBaptismSpeaker((CHARACTER)_)
AND
DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_Speaker)
THEN
NOT DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_Speaker);

//Prefer Dark Urge
QRY
QRY_LOW_MurderTribunal_FindPreferredBaptismSpeaker((CHARACTER)_Player)
AND
DB_ORI_DarkUrge(_DarkUrge)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_DarkUrge,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_DarkUrge);

//Then prefer nearby available avatar if companion
QRY
QRY_LOW_MurderTribunal_FindPreferredBaptismSpeaker((CHARACTER)_Player)
AND
NOT DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_)
AND
NOT DB_Avatars(_Player)
AND
QRY_GetBestAvatarForCompanion(_Player)
AND
DB_QRYRTN_GetBestAvatarForCompanion(_Player,_Avatar)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Avatar,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_Avatar);

//Otherwise return Valeria killer
QRY
QRY_LOW_MurderTribunal_FindPreferredBaptismSpeaker((CHARACTER)_Player)
AND
NOT DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_)
AND
DB_LOW_MurderTribunal_ValeriaKiller(_Speaker)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Speaker,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_Speaker);

//Otherwise return original player
QRY
QRY_LOW_MurderTribunal_FindPreferredBaptismSpeaker((CHARACTER)_Player)
AND
NOT DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_)
THEN
DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_Player);

//Make sure they have the performed baptism flag
QRY
QRY_LOW_MurderTribunal_FindPreferredBaptismSpeaker((CHARACTER)_Player)
AND
DB_QRYRTN_LOW_MurderTribunal_PreferredBaptismSpeaker(_)
AND
GetFlag((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_Player,0)
THEN
SetFlag((FLAG)LOW_MurderTribunal_State_PerformedBaptism_3e61965d-3413-13fc-efab-46adb1a20060,_Player);

//END_REGION

//REGION Crime reactions

//See DB_CustomForbiddenItemCrime in INIT for chain crimes

//Bhaalists ignore crimes where Valeria is the victim
QRY
QRY_CRIME_BlockRegisterCrime(_Character,_,_,(CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_)
AND
QRY_LOW_MurderTribunal_IsBhaalist(_Character)
THEN
DB_NOOP(1);

QRY
QRY_LOW_MurderTribunal_IsBhaalist((CHARACTER)_Character)
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
THEN
DB_NOOP(1);

QRY
QRY_LOW_MurderTribunal_IsBhaalist((CHARACTER)_Character)
AND
DB_LOW_MurderTribunal_Cultists(_Character)
THEN
DB_NOOP(1);

//Use knock/attacks to unlock/break chain
QRY
QRY_CRIME_BlockRegisterCrime(_Criminal,_Crime,S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,_Victim,_CrimeId)
AND
DB_LOW_MurderTribunal_ChainCrimes(_Crime)
AND
NOT DB_Dead((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
PROC_CharacterRegisterCrime(_Criminal,"LOW_MurderTribunal_FreeValeria",S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,_Victim,_CrimeId);

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_MurderTribunal_Bhaalists")
THEN
ClearOwnership(S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f);

IF
DB_Dead((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
THEN
SetCanInteract((ITEM)S_LOW_MurderTribunal_Baptism_Chain01_ef46f601-3e37-442e-8ed4-b835873ac45f,0);

//END_REGION

//END_REGION

//REGION General Murder Tribunal dialog flags

//Determine whether player has a murder victim's hand for reactivity in the various dialogs
IF
DB_DialogName(_Dialog,_DialogId)
AND
DB_LOW_MurderTribunal_FlagDialogs(_Dialog)
AND
DB_DialogPlayers(_DialogId,_Player,_)
AND
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
THEN
DB_NOOP(1);

IF
DialogEnded(_Dialog,_DialogId)
AND
DB_LOW_MurderTribunal_FlagDialogs(_Dialog)
AND
DB_DialogPlayers(_DialogId,_Player,_)
AND
GetFlag(LOW_MurderTribunal_Event_HasNoHand_0a7989d4-19cd-41d9-8b88-3dc00aefc470,_Player,1)
THEN
ClearFlag(LOW_MurderTribunal_Event_HasNoHand_0a7989d4-19cd-41d9-8b88-3dc00aefc470,_Player);

IF
FlagSet(LOW_MurderTribunal_Event_CancelHostileAfterDialog_2c5728fe-f668-690c-09d6-532cf498043e,_,_)
THEN
ClearFlag(LOW_MurderTribunal_Event_CancelHostileAfterDialog_2c5728fe-f668-690c-09d6-532cf498043e);

//END_REGION

//REGION Murdering the Tribunal

IF
Dying((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
DB_LOW_MurderTribunal_DeathKnights(_DeathKnight)
AND
NOT DB_Dead(_DeathKnight)
THEN
Die(_DeathKnight,DEATHTYPE.Radiant,NULL_00000000-0000-0000-0000-000000000000,1,0);

IF
Dying((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
NOT DB_Dead(S_LOW_MurderTribunal_Amelyssan_eca47258-a8ad-4453-a12a-3f39f8e1ca32)
THEN
ApplyStatus(S_LOW_MurderTribunal_Amelyssan_eca47258-a8ad-4453-a12a-3f39f8e1ca32,"LOW_SAREVOK_ESSENCE_AMELYSSAN_GHOST_SAREVOKDEAD",-1.0,0,S_LOW_MurderTribunal_Amelyssan_eca47258-a8ad-4453-a12a-3f39f8e1ca32);

IF
Dying((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
NOT DB_Dead(S_LOW_MurderTribunal_Illasera_df3a6de2-ba33-4717-9861-ea9f42d35fec)
THEN
ApplyStatus(S_LOW_MurderTribunal_Illasera_df3a6de2-ba33-4717-9861-ea9f42d35fec,"LOW_SAREVOK_ESSENCE_ILLASERA_GHOST_SAREVOKDEAD",-1.0,0,S_LOW_MurderTribunal_Illasera_df3a6de2-ba33-4717-9861-ea9f42d35fec);

IF
Dying((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
NOT DB_Dead(S_LOW_MurderTribunal_Sendai_565accd2-0fdc-423e-ad68-752988a509b4)
THEN
ApplyStatus(S_LOW_MurderTribunal_Sendai_565accd2-0fdc-423e-ad68-752988a509b4,"LOW_SAREVOK_ESSENCE_SENDAI_GHOST_SAREVOKDEAD",-1.0,0,S_LOW_MurderTribunal_Sendai_565accd2-0fdc-423e-ad68-752988a509b4);

IF
Dying((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
GetEquippedItem((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"Amulet",S_LOW_MurderTribunal_BhaalAmulet_Sarevok_305049b2-b725-4e84-8f47-84fac8ea51f1)
THEN
Unequip((CHARACTER)S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,S_LOW_MurderTribunal_BhaalAmulet_Sarevok_305049b2-b725-4e84-8f47-84fac8ea51f1);

IF
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
THEN
DB_GLO_DefeatCounter(_Character,"LOW_MurderTribunal_Bhaalists");

PROC
PROC_StateSet_PermaDefeated(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
SetFlag((FLAG)LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617);

PROC
PROC_StateSet_PermaDefeated(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,0);

IF
Dying((CHARACTER)S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb)
THEN
PROC_FadeOutEntity(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb,"GLO_GhostDeath");

IF
Dying((CHARACTER)S_LOW_MurderTribunal_MurderMerchant_68a568cd-1e5e-46f1-9c5f-53d3eed23bd5)
THEN
PROC_FadeOutEntity(S_LOW_MurderTribunal_MurderMerchant_68a568cd-1e5e-46f1-9c5f-53d3eed23bd5,"GLO_GhostDeath");

IF
Dying(_Character)
AND
DB_LOW_MurderTribunal_Cultists(_Character)
THEN
PROC_FadeOutEntity(_Character,"GLO_GhostDeath");

IF
Dying(_Character)
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
AND
_Character != S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6
THEN
PROC_FadeOutEntity(_Character,"GLO_GhostDeath");

IF
Died(S_LOW_MurderTribunal_Amelyssan_eca47258-a8ad-4453-a12a-3f39f8e1ca32)
AND
NOT DB_Dead(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_LOW_MurderTribunal_SarevokCombatStatuses("LOW_SAREVOK_ESSENCE_AMELYSSAN");

IF
Died(S_LOW_MurderTribunal_Illasera_df3a6de2-ba33-4717-9861-ea9f42d35fec)
AND
NOT DB_Dead(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_LOW_MurderTribunal_SarevokCombatStatuses("LOW_SAREVOK_ESSENCE_ILLASERA");

IF
Died(S_LOW_MurderTribunal_Sendai_565accd2-0fdc-423e-ad68-752988a509b4)
AND
NOT DB_PermaDefeated(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_LOW_MurderTribunal_SarevokCombatStatuses("LOW_SAREVOK_ESSENCE_SENDAI_IMAGE1");
DB_LOW_MurderTribunal_SarevokCombatStatuses("LOW_SAREVOK_ESSENCE_SENDAI_IMAGE2");
DB_LOW_MurderTribunal_SarevokCombatStatuses("LOW_SAREVOK_ESSENCE_SENDAI_IMAGE3");

IF
Died((CHARACTER)S_LOW_MurderTribunal_MurderMerchant_68a568cd-1e5e-46f1-9c5f-53d3eed23bd5)
AND
NOT DB_Dead(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
DB_LOW_MurderTribunal_SarevokCombatStatuses("LOW_SAREVOK_ESSENCE_ABAZIGAL");

IF
DB_LOW_MurderTribunal_SarevokCombatStatuses(_Status)
AND
NOT DB_LOW_MurderTribunal_SarevokDisableCombatStatuses(1)
THEN
ApplyStatus(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_Status,-1.0,1,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6);

IF
DB_LOW_MurderTribunal_SarevokCombatStatuses(_Status)
AND
DB_LOW_MurderTribunal_SarevokDisableCombatStatuses(1)
AND
HasAppliedStatus(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_Status,1)
THEN
RemoveStatus(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_Status,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6);

IF
StatusApplied(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"LOW_SAREVOK_DEATHBRINGER_ACTIVE",_,_)
THEN
DB_LOW_MurderTribunal_SarevokDisableCombatStatuses(1);

IF
DB_Defeated(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
NOT DB_LOW_MurderTribunal_SarevokDisableCombatStatuses(1)
THEN
DB_LOW_MurderTribunal_SarevokDisableCombatStatuses(1);

IF
StatusRemoved(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"LOW_SAREVOK_DEATHBRINGER_ACTIVE",_,_)
AND
NOT DB_Defeated(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
THEN
NOT DB_LOW_MurderTribunal_SarevokDisableCombatStatuses(1);

PROC
PROC_StateCleared_Defeated(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
DB_LOW_MurderTribunal_SarevokDisableCombatStatuses(1)
AND
NOT HasAppliedStatus(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"LOW_SAREVOK_DEATHBRINGER_ACTIVE",1)
THEN
NOT DB_LOW_MurderTribunal_SarevokDisableCombatStatuses(1);

IF
AutomatedDialogStarted((DIALOGRESOURCE)LOW_MurderTribunal_AD_Sarevok_DeathBringerAssault_2803351e-7d1c-02f3-70bb-24bc03fb3e62,_)
THEN
NOT DB_CombatReact_AD_OnCast(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_AD_Sarevok_DeathBringerAssault_2803351e-7d1c-02f3-70bb-24bc03fb3e62,"Target_LOW_DeathbringerAssault_Sarevok");
TimerLaunch("LOW_MurderTribunal_Sarevok_DeathBringerAssault_ADCooldown",10000);

IF
TimerFinished("LOW_MurderTribunal_Sarevok_DeathBringerAssault_ADCooldown")
THEN
DB_CombatReact_AD_OnCast(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,LOW_MurderTribunal_AD_Sarevok_DeathBringerAssault_2803351e-7d1c-02f3-70bb-24bc03fb3e62,"Target_LOW_DeathbringerAssault_Sarevok");

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_MurderTribunal_Bhaalists")
THEN
PROC_DangerZone_Safe("LOW_MurderTribunal");

//Always go permanently hostile
IF
RelationChanged((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,_Faction,0,0)
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,_Faction,0);

IF
RelationChanged((FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585,_Faction,0,0)
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585,_Faction,0);

//END_REGION

//REGION Murder Merchant

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729)
THEN
PROC_FadeInEntity(S_LOW_MurderTribunal_MurderMerchant_68a568cd-1e5e-46f1-9c5f-53d3eed23bd5);
TeleportTo(S_LOW_MurderTribunal_MurderMerchant_68a568cd-1e5e-46f1-9c5f-53d3eed23bd5,S_LOW_MurderTribunal_Merchant_Point_dc1ac5b0-65e2-4b98-baa8-c8de198a869c);
DB_Dialogs(S_LOW_MurderTribunal_MurderMerchant_68a568cd-1e5e-46f1-9c5f-53d3eed23bd5,(DIALOGRESOURCE)LOW_MurderTribunal_Merchant_18473151-521a-2773-ab45-9e1ada9e374e);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_BecameUnholyAssassin_75ba9b20-e08b-f48e-6f70-5c93586ec729)
AND
DB_Players(_Player)
AND
NOT DB_LOW_MurderTribunal_ChosenVictim(_)
AND
QRY_LOW_MurderTribunal_DetermineVictim((CHARACTER)_Player)
THEN
DB_NOOP(1);

//END_REGION

//REGION Sacrifice Jaheira/Minsc

PROC
PROC_GlobalFlagReactionAfterDialog(LOW_MurderTribunal_Event_FightJaheiraMinsc_0b839488-81cb-dea0-5e3f-5e033a6d1e49,_,_DialogId)
AND
DB_DialogPlayers(_DialogId,_Player,1)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_LOW_MurderTribunal_InitJahinscFight(_Player);

PROC
PROC_LOW_MurderTribunal_InitJahinscFight((CHARACTER)_Player)
AND
DB_Players((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "CompanionHostile");
PROC_GLO_PartyMembers_TransferStoryItems((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player);
PROC_SetRelationToPlayers((FACTION)GLO_Jaheira_e7dfda4a-9696-4aa1-9abc-9a350a797ed6, 0);

PROC
PROC_LOW_MurderTribunal_InitJahinscFight((CHARACTER)_Player)
AND
DB_Players((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, "CompanionHostile");
PROC_GLO_PartyMembers_TransferStoryItems((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, _Player);
PROC_SetRelationToPlayers((FACTION)Origin_Minsc_7512afc3-d78a-795d-39fa-ce662dfa7649, 0);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_Event_FightJaheiraMinsc_0b839488-81cb-dea0-5e3f-5e033a6d1e49)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraMinscSacrifice_d391d86e-d30f-e4db-6650-a97a2e38a79f)
AND
DB_Dead((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_Dead((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_MurderTribunal_State_SacrificedCompanions_522d207d-0f69-35cd-62e8-f1813580f4a8);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_Event_FightJaheiraMinsc_0b839488-81cb-dea0-5e3f-5e033a6d1e49)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraSacrifice_4d34ecc5-705a-2081-2826-a62076e705d9)
AND
DB_Dead((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_MurderTribunal_State_SacrificedCompanions_522d207d-0f69-35cd-62e8-f1813580f4a8);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_Event_FightJaheiraMinsc_0b839488-81cb-dea0-5e3f-5e033a6d1e49)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedMinscSacrifice_5bda0a8c-eea3-8403-2965-82d9e8b24bfe)
AND
DB_Dead((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_MurderTribunal_State_SacrificedCompanions_522d207d-0f69-35cd-62e8-f1813580f4a8);

//Auto-kill perma-defeated Jahinsc
PROC
PROC_StateSet_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_Dead(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraMinscSacrifice_d391d86e-d30f-e4db-6650-a97a2e38a79f)
THEN
Die(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_StateSet_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_Dead(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraMinscSacrifice_d391d86e-d30f-e4db-6650-a97a2e38a79f)
THEN
Die(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

PROC
PROC_StateSet_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_Dead(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraSacrifice_4d34ecc5-705a-2081-2826-a62076e705d9)
THEN
Die(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_StateSet_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_Dead(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedMinscSacrifice_5bda0a8c-eea3-8403-2965-82d9e8b24bfe)
THEN
Die(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);

//Succeed sacrifice if they die
IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraMinscSacrifice_d391d86e-d30f-e4db-6650-a97a2e38a79f)
AND
DB_Dead((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_Dead((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_MurderTribunal_State_SacrificedCompanions_522d207d-0f69-35cd-62e8-f1813580f4a8);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraSacrifice_4d34ecc5-705a-2081-2826-a62076e705d9)
AND
DB_Dead((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_MurderTribunal_State_SacrificedCompanions_522d207d-0f69-35cd-62e8-f1813580f4a8);

IF
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedMinscSacrifice_5bda0a8c-eea3-8403-2965-82d9e8b24bfe)
AND
DB_Dead((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_MurderTribunal_State_SacrificedCompanions_522d207d-0f69-35cd-62e8-f1813580f4a8);

IF
FlagSet((FLAG)LOW_MurderTribunal_State_SacrificedCompanions_522d207d-0f69-35cd-62e8-f1813580f4a8,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
THEN
PROC_LOW_MurderTribunal_RestartCourtSpotting();

PROC
PROC_LOW_MurderTribunal_RestartCourtSpotting()
AND
DB_OnlyOncePerPlayer(_Player,"LOW_MurderTribunal_Court_Spotted")
THEN
NOT DB_OnlyOncePerPlayer(_Player,"LOW_MurderTribunal_Court_Spotted");

PROC
PROC_LOW_MurderTribunal_RestartCourtSpotting()
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
THEN
PROC_SpotPlayers_RestartSpotting(_Character,"LOW_MurderTribunal_Court");

//END_REGION

//REGION Murder Tableaux

IF
DB_Sees(_PartyMember,_Object)
AND
DB_PartyMembers(_PartyMember)
AND
DB_LOW_SerialKiller_SeeTableau((FLAG)_Flag,(GUIDSTRING)_Object)
AND
GUIDToString(_Flag,_FlagString)
THEN
PROC_GlobalSetFlagAndCache(_Flag);
DebugText(_PartyMember,_FlagString);

IF
DB_GlobalFlag(_Flag)
AND
DB_LOW_SerialKiller_SeeTableau((FLAG)_Flag,(GUIDSTRING)_Object)
THEN
NOT DB_LOW_SerialKiller_SeeTableau((FLAG)_Flag,(GUIDSTRING)_Object);

//END_REGION

//REGION Immersion pass

IF
ReposeAdded(_Player,_Bench)
AND
DB_LOW_MurderTribunal_Bench((ITEM)_Bench)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_MurderTribunal_Bench")
THEN
PROC_TryStartAD(LOW_MurderTribunal_AD_AntechamberOfMurder_04b9e591-b22c-1dda-217e-f3c7300a53d6,_Player);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
