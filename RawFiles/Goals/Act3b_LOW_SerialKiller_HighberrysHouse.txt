Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Ritual
// DB ritual performed
DB_LOW_HighberrysRitualPerformedItems((ITEM)S_LOW_HighberrysHouse_SymbolOfTheAbsolute_d605e3e1-9f1b-477c-92cb-f6e73ddf984a);
DB_LOW_HighberrysRitualPerformedCharacters((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian004_ce407b77-4218-4a8e-b5c8-399ee2aeffa4, (TRIGGER)S_LOW_HighberrysHouse_TP_WineFestivalCivilian004_3e2765c6-f85e-4cc7-ad77-e0184ed7e805);
DB_LOW_HighberrysRitualPerformedCharacters((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian001_6d7ef189-307e-4b7a-8c3c-be0c4031b18c, (TRIGGER)S_LOW_HighberrysHouse_TP_WineFestivalCivilian001_7b15cd40-328d-4e4f-8f49-3b90ce7ec840);
DB_LOW_HighberrysRitualPerformedCharacters((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian002_4396e623-f09b-4599-91f3-63900a0c3382, (TRIGGER)S_LOW_HighberrysHouse_TP_WineFestivalCivilian002_e6bf0c77-2099-4ec0-b488-43506a5cd0c0);
DB_LOW_HighberrysRitualPerformedCharacters((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian003_3a893643-8e1f-4b14-ae7a-d0a8e868d5de, (TRIGGER)S_LOW_HighberrysHouse_TP_WineFestivalCivilian003_a78a48a6-1cd7-45e8-a64b-269d12f2214f);
DB_LOW_HighberrysRitualPerformedCharacters((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian005_e6f2dd59-7fee-4ae7-a913-940ceef7fb52, (TRIGGER)S_LOW_HighberrysHouse_TP_WineFestivalCivilian005_4827f790-9b61-4ff7-bf08-066804cd2e89);
DB_LOW_HighberrysRitualPerformedCharacters((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, (TRIGGER)S_LOW_HighberrysHouse_ElfsongGuard1TP_fb0a9310-b017-4a38-8365-d89f3751b72f);
DB_LOW_HighberrysRitualPerformedCharacters((CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, (TRIGGER)S_LOW_HighberrysHouse_ElfsongGuard2TP_a3381125-4c09-4a6c-a354-0d6b8cc92a68);
//END_REGION

//REGION Wine Festival
//Cora is being killed
DB_DeadOnceFlag((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (FLAG)LOW_SerialKiller_State_Cora_IsDead_d9ad6998-183f-4769-a2e0-3dac19962774);

//DB for wine festival attendants and one liners
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian001_6d7ef189-307e-4b7a-8c3c-be0c4031b18c, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalCivilian001_953245f3-ad92-29f8-e936-da3e27e83859);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian002_4396e623-f09b-4599-91f3-63900a0c3382, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalCivilian002_760ef8a1-dd76-bf25-a4ad-678a5f89be73);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian004_ce407b77-4218-4a8e-b5c8-399ee2aeffa4, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalCivilian004_3b7c221e-5a13-9a15-99d9-ae719789f854);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian003_3a893643-8e1f-4b14-ae7a-d0a8e868d5de, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalCivilian003_d0d5df57-3325-2be3-7e1f-ff682e940af6);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian005_e6f2dd59-7fee-4ae7-a913-940ceef7fb52, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalCivilian005_b60da820-8667-0365-df09-fee7f9309059);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_Ontur_74319ba4-80de-44ab-b254-3920195fbeef, (DIALOGRESOURCE)LOW_SerialKiller_Ontur_da21ad8d-f64f-19c9-615f-df899ddfb15c);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_Flaerith_381a8770-5f64-454b-aa6f-ef8c57341c57, (DIALOGRESOURCE)LOW_SerialKiller_Flaerith_fa5fe769-f244-2099-774b-76b3f792adad);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalWorker02_42b6e6f1-07c5-4914-a434-75607aa24b6b, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalWorker02_ef2b97a5-d235-2c49-0574-96fe6ca138e9);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalWorker01_07663ad2-237c-4d11-9b55-fac1ac8e90ee, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalWorker01_2d3475a3-ae3f-b102-3007-1ac771627114);

//Wine Festival crowds
DB_LOW_SerialKiller_WineFestivalCrowds((TRIGGER)CCT_BsG_CTZN_Talk_041_5dbfe603-d556-45cc-9ce4-d4e69570261f);
DB_LOW_SerialKiller_WineFestivalCrowds((TRIGGER)CCT_BsG_CTZN_TalkREAC_041_b0b332fa-a695-4c0c-9570-5b2587547406);
DB_LOW_SerialKiller_WineFestivalCrowds((TRIGGER)CCT_BsG_CTZN_TalkREAC_013_6d96d389-1369-4001-9709-0f3df05f8cb2);
DB_LOW_SerialKiller_WineFestivalCrowds((TRIGGER)CCT_BsG_CTZN_Talk_013_d1cd637a-209e-46a4-81aa-a765a6835b16);
DB_LOW_SerialKiller_WineFestivalCrowds((TRIGGER)CCT_ELFout_CTZN_TalkREAC_002_1a08ce6d-d588-408a-ad43-44745622c200);
DB_LOW_SerialKiller_WineFestivalCrowds((TRIGGER)CCT_ELFout_CTZN_Talk_002_369a3744-c7d1-45bb-96d4-4191449bff47);
DB_LOW_SerialKiller_WineFestivalCrowds((TRIGGER)CCT_BsG_CTZN_TalkREAC_014_c4d6088f-8fb5-44c2-a333-75bfef06ce3d);
DB_LOW_SerialKiller_WineFestivalCrowds((TRIGGER)CCT_BsG_CTZN_Talk_014_d969ecb0-f2f9-4a08-84f1-90d12de7805c);

// DBs for the doppelgangers
DB_LOW_DolorAndDoppelgangers((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,
	NULL_00000000-0000-0000-0000-000000000000, (DIALOGRESOURCE)LOW_HighberrysHouse_Dolor_d96be40a-b01f-dfbc-72e1-303796a5e6c6);
DB_LOW_DolorAndDoppelgangers((CHARACTER)S_LOW_SerialKiller_Doppelganger_001_108c54a2-b364-4da0-bfc7-15bd5a8f39f2,
	(CHARACTERROOT)LOW_SerialKiller_DoppelgangerFemaleHuman_46aef1d8-e4e3-4443-8aba-d0370955db65, LOW_SerialKiller_Doppelganger_001_1ef275fb-854c-da96-3494-18228475fe2f);
DB_LOW_DolorAndDoppelgangers((CHARACTER)S_LOW_SerialKiller_Doppelganger_002_41041cc2-d15c-4ea2-be5e-124a9e59a62c,
	(CHARACTERROOT)LOW_SerialKiller_DoppelgangerHumanMale_e298d305-6359-4b61-be1f-9cb23b84c83f, LOW_SerialKiller_Doppelganger_002_557c6ecc-59a2-43bd-dbeb-af1b8c3c1cb0);
DB_LOW_DolorAndDoppelgangers((CHARACTER)S_LOW_SerialKiller_Doppelganger_000_cb2bca61-95a9-4ce4-8bea-687682f95fb5,
	(CHARACTERROOT)LOW_SerialKiller_DoppelgangerMaleHighElf_1ae83841-61ec-40a0-8b9a-4a78d7392ee4,
	LOW_SerialKiller_Doppelganger_000_d2979aa4-d03f-81ef-b304-a95474705acb);
DB_LOW_DolorAndDoppelgangers((CHARACTER)S_LOW_SerialKiller_Doppelganger_003_64279955-a165-4a43-9b8b-64325e925300,
	(CHARACTERROOT)LOW_SerialKiller_Doppelganger_DwarvenFemale_2fbd9480-e136-4d45-b0ec-ee83c225f8aa, LOW_SerialKiller_Doppelganger_003_fa9b5d31-3e33-798f-2f99-bff238294396);

//DB for the wine festival appearing
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian00e3_3a893643-8e1f-4b14-ae7a-d0a8e868d5de, S_LOW_SerialKiller_WF_Group1_001_017eee3b-5ed7-4b4c-88c1-ce328bf596fc,
	S_LOW_SerialKiller_WF_AppearingPoint_001_dfb3ebb8-81d9-43fa-96ac-1461ab69b7a5, "Civilian");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian005_e6f2dd59-7fee-4ae7-a913-940ceef7fb52, S_LOW_SerialKiller_WF_Group1_002_153725e3-ac85-43dd-8645-f03989f43d5f,
	S_LOW_SerialKiller_WF_AppearingPoint_001_dfb3ebb8-81d9-43fa-96ac-1461ab69b7a5, "Civilian");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_Doppelganger_001_108c54a2-b364-4da0-bfc7-15bd5a8f39f2, S_LOW_SerialKiller_WF_Group2_001_5ff9ad23-54c5-4d54-ba35-a7e319263b5b,
	S_LOW_SerialKiller_WF_AppearingPoint_002_d23f851d-0d72-41b6-a9ed-b1ef1bd98e23, "Murderer");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_Doppelganger_003_64279955-a165-4a43-9b8b-64325e925300, S_LOW_SerialKiller_WF_Group2_002_6b41d41e-c443-4014-9257-0811513c27ba,
	S_LOW_SerialKiller_WF_AppearingPoint_002_d23f851d-0d72-41b6-a9ed-b1ef1bd98e23, "Murderer");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_Doppelganger_000_cb2bca61-95a9-4ce4-8bea-687682f95fb5, S_LOW_SerialKiller_WF_Group2_003_e8e59b8a-7a26-41b5-a5fc-eb508f98d59e,
	S_LOW_SerialKiller_WF_AppearingPoint_002_d23f851d-0d72-41b6-a9ed-b1ef1bd98e23, "Murderer");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian004_ce407b77-4218-4a8e-b5c8-399ee2aeffa4, S_LOW_SerialKiller_WF_Group3_001_9893c43c-1114-41a8-8385-cf97c098c54c,
	S_LOW_SerialKiller_WF_AppearingPoint_003_8b7bf829-4e1a-4864-b00e-9a604c5825e6, "Civilian");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian001_6d7ef189-307e-4b7a-8c3c-be0c4031b18c, S_LOW_SerialKiller_WF_Group3_002_aaa8ab66-3482-48d1-887f-b07e44c2cb89,
	S_LOW_SerialKiller_WF_AppearingPoint_003_8b7bf829-4e1a-4864-b00e-9a604c5825e6, "Civilian");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian002_4396e623-f09b-4599-91f3-63900a0c3382, S_LOW_SerialKiller_WF_Group3_003_8674e82c-97d4-4eac-884d-0b4eab7ac185,
	S_LOW_SerialKiller_WF_AppearingPoint_003_8b7bf829-4e1a-4864-b00e-9a604c5825e6, "Civilian");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, (TRIGGER)S_LOW_SerialKiller_WF_Group4_002_d899ba08-c3da-42ec-bf35-00e35be6e7a0,
	S_LOW_SerialKiller_WF_AppearingPoint_004_adbf1761-48bb-4004-98a9-26c86c5ce336, "Murderer");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_Doppelganger_002_41041cc2-d15c-4ea2-be5e-124a9e59a62c, S_LOW_SerialKiller_WF_Group4_001_918264ba-5715-4f9c-af6f-13c2ee9c3515,
	S_LOW_SerialKiller_WF_AppearingPoint_004_adbf1761-48bb-4004-98a9-26c86c5ce336, "Murderer");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_Flaerith_381a8770-5f64-454b-aa6f-ef8c57341c57, S_LOW_SerialKiller_WF_Group5_001_86873387-2cda-4515-b502-ce67617e00be,
	S_LOW_SerialKiller_WF_AppearingPoint_001_dfb3ebb8-81d9-43fa-96ac-1461ab69b7a5, "Civilian");
DB_LOW_SerialKiller_WineFestivalPositions((CHARACTER)S_LOW_SerialKiller_Ontur_74319ba4-80de-44ab-b254-3920195fbeef, S_LOW_SerialKiller_WF_Group5_002_7cb4c3a6-83f5-4009-87d1-9fc85f99910e,
	S_LOW_SerialKiller_WF_AppearingPoint_003_8b7bf829-4e1a-4864-b00e-9a604c5825e6, "Civilian");

//DBs for Cora and Roger drinking wine, only a flag
DB_LOW_SerialKiller_FlagsDrinkingWine((FLAG)LOW_SerialKiller_Event_WineParalysis_Roger_54acda90-91d7-4937-a135-016df472f4ad);
DB_LOW_SerialKiller_FlagsDrinkingWine((FLAG)LOW_SerialKiller_Event_WineParalysis_Cora_bf9e54bf-d2ce-4837-9f79-948ee5314133);

DB_LOW_SerialKiller_TheHighberrys((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679);
DB_LOW_SerialKiller_TheHighberrys((CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);

//Register trigger for the wine festival (for the ADs before the festival and later for the wine festival itself)
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_SerialKiller_VisitWineFestival_f5419edc-b46c-4f87-9853-eaf67eaefa23);


//Dialogs for the workers mounting the wine festival
DB_Dialogs((CHARACTER)S_LOW_SerialKiller_WineFestivalWorker01_07663ad2-237c-4d11-9b55-fac1ac8e90ee, LOW_SerialKiller_WineFestivalWorker01_2d3475a3-ae3f-b102-3007-1ac771627114);
DB_Dialogs((CHARACTER)S_LOW_SerialKiller_WineFestivalWorker02_42b6e6f1-07c5-4914-a434-75607aa24b6b, LOW_SerialKiller_WineFestivalWorker02_ef2b97a5-d235-2c49-0574-96fe6ca138e9);
//Dialogs for the kids at Highberry'sHouse
DB_Dialogs((CHARACTER)S_LOW_SerialKiller_RefugeeChild_001_284d96e2-b6a8-4766-85d1-57037efdd5ad, (DIALOGRESOURCE)LOW_SerialKiller_RefugeeChild_001_dc11e092-8030-da71-1e0d-db07d60b78b4);
DB_Dialogs((CHARACTER)S_LOW_SerialKiller_RefugeeChild_002_ae92b3ce-4cdd-47bc-866c-80c46d443114, (DIALOGRESOURCE)LOW_SerialKiller_RefugeeChild_002_cddfb5c6-9404-dba2-d5ec-9947377894ed);

//Database for the Wine Festival ADs

DB_LOW_SerialKiller_WineFestivalADs((DIALOGRESOURCE)LOW_SerialKiller_AD_WineFestivalChatter_002_39041a40-2400-cef3-cc36-9f90a736caff,
	(CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian004_ce407b77-4218-4a8e-b5c8-399ee2aeffa4, (CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian001_6d7ef189-307e-4b7a-8c3c-be0c4031b18c,
	(CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian002_4396e623-f09b-4599-91f3-63900a0c3382, 1);
DB_LOW_SerialKiller_WineFestivalADs((DIALOGRESOURCE)LOW_SerialKiller_AD_WineFestivalChatter_003_abb50d86-2074-d5cd-7ce6-0aa002864c65,
	(CHARACTER)S_LOW_SerialKiller_Flaerith_381a8770-5f64-454b-aa6f-ef8c57341c57, (CHARACTER)S_LOW_SerialKiller_Ontur_74319ba4-80de-44ab-b254-3920195fbeef,
	(CHARACTER)S_LOW_SerialKiller_WineFestivalWorker01_07663ad2-237c-4d11-9b55-fac1ac8e90ee, 2);
DB_LOW_SerialKiller_WineFestivalADs((DIALOGRESOURCE)LOW_SerialKiller_AD_WineFestivalChatter_004_e0b93fdf-ba51-1c98-a797-a45c9e8ef6b6,
	(CHARACTER)S_LOW_SerialKiller_WineFestivalWorker02_42b6e6f1-07c5-4914-a434-75607aa24b6b, (CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian003_3a893643-8e1f-4b14-ae7a-d0a8e868d5de,
	(CHARACTER)S_LOW_SerialKiller_WineFestivalCivilian005_e6f2dd59-7fee-4ae7-a913-940ceef7fb52, 3);
DB_LOW_SerialKiller_WineFestivalADs((DIALOGRESOURCE)LOW_SerialKiller_AD_WineFestivalChatter_001_c5e61941-1a45-0082-02a6-c865df953956,
	(CHARACTER)S_LOW_SerialKiller_Doppelganger_000_cb2bca61-95a9-4ce4-8bea-687682f95fb5, (CHARACTER)S_LOW_SerialKiller_Doppelganger_001_108c54a2-b364-4da0-bfc7-15bd5a8f39f2,
	(CHARACTER)S_LOW_SerialKiller_Doppelganger_003_64279955-a165-4a43-9b8b-64325e925300, 4);
DB_LOW_SerialKiller_WineFestivalADs((DIALOGRESOURCE)LOW_SerialKiller_AD_WineFestivalChatter_005_57c27c2f-8410-9f84-73a1-14f5b0eda11f,
	(CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, (CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679,
	(CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, 5);
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(1);

NOT DB_LOW_SerialKiller_ReproduceEscapePAD(NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

// Setting up scene by defalut (no lair discovered)
PROC_LOW_HighberrysHouse_NotMurderer_BothAlive();
PROC_LOW_CheckMissionTriggered();

ToInventory((ITEM)S_LOW_DolorBag_43404e7f-b5a9-491d-b0ef-f3fc7f002229, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, 1, 0, 1);

DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_HighberrysHouse_WithoutMurderer_547725be-0fc8-c4c0-45bb-ab694a8732f2, 500, 3);

DB_Children(S_LOW_SerialKiller_RefugeeChild_001_284d96e2-b6a8-4766-85d1-57037efdd5ad);
DB_Children(S_LOW_SerialKiller_RefugeeChild_002_ae92b3ce-4cdd-47bc-866c-80c46d443114);

DB_SerialKiller_OrphanChilds((CHARACTER)S_LOW_SerialKiller_RefugeeChild_001_284d96e2-b6a8-4766-85d1-57037efdd5ad);
DB_SerialKiller_OrphanChilds((CHARACTER)S_LOW_SerialKiller_RefugeeChild_002_ae92b3ce-4cdd-47bc-866c-80c46d443114);

DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_HighberrysHouse_Ownership_Patched_de3b7056-2e02-4a2d-82c1-70b5b5a631e2, (CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);
KBSECTION
//REGION Before Wine Festival

// Basic scene with both Highberrys alive and without Dolor.
PROC
PROC_LOW_HighberrysHouse_NotMurderer_BothAlive()
AND
NOT DB_Defeated((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
NOT DB_Defeated((CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404)
THEN
PROC_LOW_HighberrysHouse_ShowRitualItems(0);
PROC_LOW_ShowAttendantsWineFestival(0);
PROC_LOW_ShowDolorAndDoppelgangers(0);
//PROC_SetOnStage(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, 0);
DB_Dialogs((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404,
	(DIALOGRESOURCE)LOW_HighberrysHouse_WithoutMurderer_547725be-0fc8-c4c0-45bb-ab694a8732f2);

//Play the wine workers AD
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_SerialKiller_VisitWineFestival_f5419edc-b46c-4f87-9853-eaf67eaefa23)
AND
NOT DB_GlobalFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5)
AND
QRY_OnlyOnce("LOW_WineFestivalWorkers")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SerialKiller_AD_WineFestivalWorkers_dc5891d9-75b9-8969-767f-dfb54ead8b70, S_LOW_SerialKiller_WineFestivalWorker02_42b6e6f1-07c5-4914-a434-75607aa24b6b,
	S_LOW_SerialKiller_WineFestivalWorker01_07663ad2-237c-4d11-9b55-fac1ac8e90ee);

IF
AutomatedDialogEnded(LOW_SerialKiller_AD_WineFestivalWorkers_dc5891d9-75b9-8969-767f-dfb54ead8b70, _Instance)
AND
QRY_OnlyOnce_Reset("LOW_WineFestivalWorkers")
THEN
DB_NOOP(1);


//END_REGION

//REGION Highberry's live or dead

IF
Died(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
NOT DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","OffStage")
THEN
SetFlag((FLAG)LOW_SerialKiller_Event_KillHighberrysAfterLongRest_c79f8fc7-272d-4398-8861-848d469b885b);
PROC_LOW_SerialKiller_FigarosSetupCommon();

//Detect if players severed Cora's Hand (getting the hand for the first time), prevents ritual
IF
FlagSet((FLAG)LOW_SerialKiller_State_HandHasItem_Cora_14b2403a-7a5b-44ab-ab99-903686f357cc, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_SeveringCoraHand")
THEN
SetFlag((FLAG)LOW_SerialKiller_State_Cora_SeveredHand_d8c2c89a-235d-486c-9bf7-4f5aed0b84e7);
ClearFlag(LOW_SerialKiller_Event_KillHighberrysAfterLongRest_c79f8fc7-272d-4398-8861-848d469b885b);

// Cora is dead, fallback to roger single dialog
PROC
PROC_StateSet_PermaDefeated((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
NOT DB_PermaDefeated((CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404)
AND
NOT DB_GlobalFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5)
THEN
PROC_RemoveDialog(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);
DB_Dialogs((CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, (DIALOGRESOURCE)LOW_HighberrysHouse_OnlyRoger_d6248e4b-9e9d-73bf-25b7-19d4fc7b09f5);

// Roger is Dead
PROC
PROC_StateSet_PermaDefeated((CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404)
AND
NOT DB_PermaDefeated((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
THEN
PROC_RemoveDialog(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679);
DB_Dialogs((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (DIALOGRESOURCE)LOW_HighberrysHouse_OnlyCora_0943e58e-50f2-1d1e-2507-12047735acb3);

//Make children run if they see Cora or Roger die in front of them
IF
KilledBy(_Highberry, _, _Killer, _)
AND
DB_LOW_SerialKiller_TheHighberrys(_Highberry)
AND
DB_SerialKiller_OrphanChilds(_Child)
AND
DB_Sees(_Child, (CHARACTER)_Killer)
THEN
PROC_DisappearOutOfSight(_Child, "Run", 1, "");

//END_REGION

//REGION Mission triggered

//When loading the level
PROC
PROC_LOW_CheckMissionTriggered()
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_State_MissionTriggered_003250e5-2cca-4612-9b74-a9802e8fec12)
AND
NOT DB_GlobalFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5)
THEN
PROC_LOW_InitializeWineFestival();
SetFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5);
ClearFlag((FLAG)LOW_SerialKiller_State_MissionTriggered_003250e5-2cca-4612-9b74-a9802e8fec12);

//Perform the ritual after a long rest if players visit the Wine Festival
PROC
PROC_LongRest_InLevel("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_Event_KillHighberrysAfterLongRest_c79f8fc7-272d-4398-8861-848d469b885b)
AND
NOT DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_Dead(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
PROC_LOW_SerialKiller_PerformRitualAndSClearFlags();

PROC
PROC_LongRest()
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_Event_KillHighberrysAfterLongRest_c79f8fc7-272d-4398-8861-848d469b885b)
AND
NOT DB_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_Dead(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
DB_LOW_SerialKiller_PerformRitual(1);

IF
LevelLoaded("CTY_Main_A")
AND
DB_LOW_SerialKiller_PerformRitual(1)
THEN
NOT DB_LOW_SerialKiller_PerformRitual(1);
PROC_LOW_SerialKiller_PerformRitualAndSClearFlags();

PROC
PROC_LOW_SerialKiller_PerformRitualAndSClearFlags()
THEN
ClearFlag((FLAG)LOW_SerialKiller_Event_KillHighberrysAfterLongRest_c79f8fc7-272d-4398-8861-848d469b885b);
ClearFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5);
PROC_LOW_HighberrysHouse_PerformRitual();

//CrimeScene without ritual, if Dolor kills Cora at the wine festival
PROC
PROC_LongRest_InLevel("CTY_Main_A")
AND
DB_GlobalFlag(LOW_SerialKiller_State_DolorKillsCoraWineFestival_0fce13c6-8d48-4391-a890-f1397add7af4)
AND
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index)
AND
QRY_OnlyOnce("LOW_SerialKiller_CrimeSceneWithoutRitual")
THEN
PROC_LOW_SerialKiller_CrimeScene(_Index);

PROC
PROC_LongRest()
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag(LOW_SerialKiller_State_DolorKillsCoraWineFestival_0fce13c6-8d48-4391-a890-f1397add7af4)
AND
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index)
AND
QRY_OnlyOnce("LOW_SerialKiller_CrimeSceneWithoutRitual")
THEN
DB_LOW_SerialKiller_SetupCrimeScene(_Index);

IF
LevelLoaded("CTY_Main_A")
AND
DB_LOW_SerialKiller_SetupCrimeScene(_Index)
THEN
NOT DB_LOW_SerialKiller_SetupCrimeScene(_Index);
PROC_LOW_SerialKiller_CrimeScene(_Index);

PROC
PROC_LOW_SerialKiller_CrimeScene((INTEGER)_Index)
THEN
PROC_LOW_ShowAttendantsWineFestival(1);
PROC_LOW_HideOnlyDoppelgangers();
PROC_LOW_SetRitualCharactersInPosition();
PROC_RemoveDialog(S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c);
PROC_Removedialog(S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159);
DB_Dialogs(S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, (DIALOGRESOURCE)LOW_HighberrysHouse_Guard_d3e5af13-a9a8-ad24-2841-fef76a50ef06);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, LOW_HighberrysHouse_Guard_Interior_5a2426c2-b921-1704-b3d9-ecaf59683a5e);
NOT DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index);
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(-1);

IF
DB_GlobalFlag((FLAG)LOW_SerialKiller_State_MissionTriggered_003250e5-2cca-4612-9b74-a9802e8fec12)
AND
NOT DB_GlobalFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_LOW_InitializeWineFestival();
SetFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5);
ClearFlag((FLAG)LOW_SerialKiller_State_MissionTriggered_003250e5-2cca-4612-9b74-a9802e8fec12);

//END_REGION

//REGION Wine Festival
//Show the wine festival with Dolor
PROC
PROC_LOW_InitializeWineFestival()
AND
NOT DB_PermaDefeated(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
THEN
PROC_LOW_ShowDolorAndDoppelgangers(1);
PROC_LOW_SerialKiller_CharactersToWineFestival();
PROC_LOW_SerialKiller_SettingUpScene();
PROC_CharacterMoveTo(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, S_LOW_SerialKiller_RogerToFestival_e9581a27-db04-4ceb-9060-72d1867210e2, "Walk", "LOW_SerialKiller_RogerArrives");
PROC_CharacterMoveTo(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, S_LOW_SerialKiller_CoraToWineFestival_3308f1c9-e511-4811-85e2-25de71917060, "Walk", "LOW_SerialKiller_CoraArrives");
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "WineFestival");

//Show the wine festival without Dolor: he will be at Figaro's
PROC
PROC_LOW_InitializeWineFestival()
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_State_Cora_SeveredHand_d8c2c89a-235d-486c-9bf7-4f5aed0b84e7)
THEN
PROC_LOW_ShowDolorAndDoppelgangers(1);
PROC_LOW_FigarosSetup_NotLongRest("NotKillCora");
PROC_LOW_ShowAttendantsWineFestival(1);
PROC_CharacterMoveTo(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, S_LOW_SerialKiller_RogerToFestival_e9581a27-db04-4ceb-9060-72d1867210e2, "Walk", "");
PROC_RemoveDialog(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);
DB_Dialogs(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, (DIALOGRESOURCE)LOW_SerialKiller_RogerWineFestival_ee90229f-aa92-f1ca-a29d-1274374d0096);
PROC_State_Progress(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "Figaro");

//Full scene
PROC
PROC_LOW_SerialKiller_SettingUpScene()
AND
NOT DB_PermaDefeated(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
DB_LOW_SerialKiller_WineFestivalADs(_, _Character1, _Character2, _Character3, _) //This DB contains every character at the wine festival, including the workers
THEN
DB_SceneManager(_Character1, "LOW_SerialKiller_WineFestivalScene");
DB_SceneManager(_Character2, "LOW_SerialKiller_WineFestivalScene");
DB_SceneManager(_Character3, "LOW_SerialKiller_WineFestivalScene");

PROC
PROC_LOW_SerialKiller_SettingUpScene()
THEN
DB_SceneAllowAllDisturbances("LOW_SerialKiller_WineFestivalScene");

PROC
PROC_LOW_SerialKiller_CharactersToWineFestival()
AND
DB_LOW_SerialKiller_WineFestivalPositions(_Character, _Destination, _Origin, _TypeOfCharacter)
AND
_TypeOfCharacter == "Civilian"
AND
DB_LOW_WineFestivalAttendants(_Character, _Dialog)
AND
GUIDToString(_Character, _OutGuidString)
AND
Concatenate(_TypeOfCharacter, _OutGuidstring, _OutEventCode)
THEN
PROC_AppearOutOfSightTo(_Character, _Destination, _Origin, _OutEventCode);
DB_Dialogs(_Character, _Dialog);
DB_LOW_SerialKiller_WineFestivalAppearingEvents(_Character, _OutEventCode);

PROC
PROC_LOW_SerialKiller_CharactersToWineFestival()
AND
DB_LOW_SerialKiller_WineFestivalPositions(_Character, _Destination, _Origin, _TypeOfCharacter)
AND
_TypeOfCharacter == "Murderer"
AND
NOT DB_PermaDefeated(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
GUIDToString(_Character, _OutGuidString)
AND
Concatenate(_TypeOfCharacter, _OutGuidstring, _OutEventCode)
THEN
PROC_AppearOutOfSightTo(_Character, _Destination, _Origin, _OutEventCode);
DB_LOW_SerialKiller_WineFestivalAppearingEvents(_Character, _OutEventCode);

PROC
PROC_LOW_SerialKiller_CharactersToWineFestival()
AND
DB_LOW_SerialKiller_WineFestivalPositions(_Character, _Destination, _Origin, _TypeOfCharacter)
AND
_TypeOfCharacter == "Murderer"
AND
DB_PermaDefeated(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
THEN
NOT DB_LOW_SerialKiller_WineFestivalPositions(_Character, _Destination, _Origin, _TypeOfCharacter);

//AppearOutOfSight Event
IF
EntityEvent((CHARACTER)_CharacterWineFestival, _Event)
AND
DB_LOW_SerialKiller_WineFestivalAppearingEvents(_CharacterWineFestival, _Event)
AND
DB_LOW_SerialKiller_WineFestivalPositions(_CharacterWineFestival, _Destination, _, _)
THEN
NOT DB_LOW_SerialKiller_WineFestivalAppearingEvents(_CharacterWineFestival, _Event);
PROC_CharacterMoveTo(_CharacterWineFestival, _Destination, "Walk", _Event);

//Move to the final positions event
IF
EntityEvent((CHARACTER)_CharacterWineFestival, _Event)
AND
NOT DB_LOW_SerialKiller_WineFestivalAppearingEvents(_CharacterWineFestival, _Event)
AND
DB_LOW_SerialKiller_WineFestivalPositions(_CharacterWineFestival, _Destination, _Origin, _TypeOfCharacter)
THEN
NOT DB_LOW_SerialKiller_WineFestivalPositions(_CharacterWineFestival, _Destination, _Origin, _TypeOfCharacter);
PROC_LOW_SerialKiller_TryStartChatter();

PROC
PROC_LOW_SerialKiller_TryStartChatter()
AND
QRY_IsEmptyDB("DB_LOW_SerialKiller_WineFestivalPositions", 4)
THEN
PROC_LOW_ReproduceWineFestivalChatter();

//Show festival attendants and add the dialogs
PROC
PROC_LOW_ShowAttendantsWineFestival(0)
AND
DB_LOW_WineFestivalAttendants(_Character, _)
THEN
PROC_RemoveDialog(_Character);
PROC_SetOnStage(_Character, 0);

//Show festival attendants and add the dialogs
PROC
PROC_LOW_ShowAttendantsWineFestival(1)
AND
DB_LOW_WineFestivalAttendants(_Character, _Dialog)
THEN
PROC_SetOnStage(_Character, 1);
DB_Dialogs(_Character, _Dialog);


//Show/hide Dolor and the doppelgangers
PROC
PROC_LOW_ShowDolorAndDoppelgangers(0)
AND
DB_LOW_DolorAndDoppelgangers(_Character, _, _)
THEN
PROC_RemoveDialog(_Character);
PROC_SetOnStage(_Character, 0);

PROC
PROC_LOW_ShowDolorAndDoppelgangers(1)
AND
DB_LOW_DolorAndDoppelgangers(_Character, _, _Dialogue)
AND
_Character != S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134
THEN
DB_Dialogs(_Character, _Dialogue);
PROC_SetOnStage(_Character, 1);

PROC
PROC_LOW_ShowDolorAndDoppelgangers(1)
AND
DB_LOW_DolorAndDoppelgangers(_Character, _, _Dialogue)
THEN
PROC_CharacterDisableCrime(_Character, "Murder");
PROC_CharacterDisableCrime(_Character, "Assault");

PROC
PROC_LOW_ShowDolorAndDoppelgangers(1)
AND
DB_LOW_DolorAndDoppelgangers(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _, _Dialogue)
THEN
SetOnStage(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, 1);
PROC_RemoveDialog(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679);
PROC_RemoveDialog(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);
DB_Dialogs(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, (CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404,
	(DIALOGRESOURCE)LOW_HighberrysHouse_Dolor_d96be40a-b01f-dfbc-72e1-303796a5e6c6);

PROC
PROC_LOW_HideOnlyDoppelgangers()
AND
DB_LOW_DolorAndDoppelgangers(_Character, _, _)
AND
_Character != S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134
THEN
PROC_SetOnStage(_Character, 0);

//Play the wine festival chatter for the first time
PROC
PROC_LOW_ReproduceWineFestivalChatter()
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5)
AND
QRY_OnlyOnce("LOW_WineFestivalHappening")
AND
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index)
AND
_Index != -1
AND
DB_LOW_SerialKiller_WineFestivalADs(_Dialog, _Speaker1, _Speaker2, _Speaker3, _Index)
AND
IntegerSum(_Index, 1, _OutIndex)
AND
GetHostCharacter(_Player)
THEN
PROC_TryStartAD((DIALOGRESOURCE)_Dialog, _Speaker1, _Speaker2, _Speaker3);
NOT DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index);
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_OutIndex);

//Skip 4th and 5th AD if Cora is Dead before the festival. Dolor and doppelgangers at Figaro's
IF
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(4)
AND
DB_Defeated(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
THEN
NOT DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(4);
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(1);

IF
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index)
AND
_Index > 4
THEN
NOT DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index);
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(1);

//Cleaning DB when wine festival ends.
IF
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(-1)
AND
DB_LOW_SerialKiller_WineFestivalADs(_Dialog, _Speaker1, _Speaker2, _Speaker3, _Index)
THEN
DialogRequestStop(_Speaker1);
DialogRequestStop(_Speaker2);
DialogRequestStop(_Speaker3);
NOT DB_LOW_SerialKiller_WineFestivalADs(_Dialog, _Speaker1, _Speaker2, _Speaker3, _Index);

//Play next chatter
IF
AutomatedDialogEnded(_Dialog, _ID)
AND
DB_LOW_SerialKiller_WineFestivalADs(_Dialog, _, _, _, _Index)
AND
QRY_OnlyOnce_Reset("LOW_WineFestivalHappening")
THEN
PROC_LOW_ReproduceWineFestivalChatter();

//Players visit the Wine Festival, so the Highberry's will die after a long rest if Dolor is alive
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_SerialKiller_VisitWineFestival_f5419edc-b46c-4f87-9853-eaf67eaefa23)
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5)
AND
NOT DB_GlobalFlag((FLAG)LOW_SerialKiller_State_DolorIsPermaDefeated_a1ca5851-fea5-4536-934a-b402ac8d92a6)
THEN
SetFlag((FLAG)LOW_SerialKiller_Event_HighberrysAlive_WillDieAfterLongRest_c79f8fc7-272d-4398-8861-848d469b885b, NULL_00000000-0000-0000-0000-000000000000);

//Doppelgangers and Dolor temporary hostile because pickpocketing should become always hostile when both are in Wine Festival.
IF
RelationChanged(Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, 0)
THEN
PROC_SetRelationMutual(Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);

//Transform doppelgangers into Dolor when a temporary hostility starts in the Wine Festival.
IF
DB_GLO_Combat_TemporaryHostile(_Doppelganger)
AND
DB_LOW_DolorAndDoppelgangers((CHARACTER)_Doppelganger, _, _)
AND
_Doppelganger != S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134
THEN
UseSpell(_Doppelganger, "Shout_LOW_Shapechanger_Doppelganger_Highberry_000", _Doppelganger);
DB_LOW_SerialKiller_Doppelganger_AlreadyTransformed(_Doppelganger);

//END_REGION

//REGION Dolor Running or dying from Wine Festival

// Starting combat
IF
FlagSet((FLAG)LOW_SerialKiller_Event_DolorCombatHighberrysHouse_a40b5a87-023d-0f2a-4a75-935646b139d0, (CHARACTER)_Player, _)
AND
DB_Players(_Player)
THEN
DB_LOW_SerialKiller_WaitingCombat_NoWine(_Player);
ClearFlag(LOW_SerialKiller_Event_DolorCombatHighberrysHouse_a40b5a87-023d-0f2a-4a75-935646b139d0);

IF
DialogEnded(LOW_HighberrysHouse_Dolor_d96be40a-b01f-dfbc-72e1-303796a5e6c6, _)
AND
DB_LOW_SerialKiller_WaitingCombat_NoWine(_Player)
THEN
NOT DB_LOW_SerialKiller_WaitingCombat_NoWine(_Player);
PROC_LOW_SerialKiller_DoppelgangersAsDolor();
SetStoryDisplayName(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "SerialKiller_Dolor_Name");
SetHostileAndEnterCombat((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, _Player, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, 0);

//Players kill Cora. This mostly happen if we use CTRL+K, not sure if we can trigger a KilledBy event without an AttackedBy
IF
KilledBy((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, _Player, _, _ID)
AND
DB_Players((CHARACTER)_Player)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SerialKiller_AD_DolorSeeYouKillCora_9406383e-cbbc-6ef4-4abc-4558843e47bb, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

//Players assault Cora in any way, Dolor runs away because other one is behind his prey. The wine festival will continue
PROC
PROC_SceneInterrupted(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, _PartyMember, "LOW_SerialKiller_WineFestivalScene", "Attacked")
AND
DB_PartyMembers((CHARACTER)_PartyMember)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SerialKiller_AD_DolorSeeYouKillCora_9406383e-cbbc-6ef4-4abc-4558843e47bb, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

IF
AutomatedDialogEnded(LOW_SerialKiller_AD_DolorSeeYouKillCora_9406383e-cbbc-6ef4-4abc-4558843e47bb, _InstanceID)
AND
QRY_OnlyOnce("LOW_DolorSeeYouKillCora")
THEN
PROC_LOW_SerialKiller_DolorTryToEscape("LOW_Dolor_AwayWineFestival_NotKillingCora");

//Dolor being attacked before dialog and attacker can be seen
IF
AttackedBy(_Character, _PartyCharacter, _, _, _, _, _StoryActionID)
AND
DB_PartyMembers((CHARACTER)_PartyCharacter)
AND
IsInCombat(_Character, 0)
AND
DB_LOW_DolorAndDoppelgangers((CHARACTER)_Character, _, _)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
AND
NOT DB_HiddenCharacters(_PartyCharacter, _)
THEN
PROC_LOW_SerialKiller_DoppelgangersAsDolor();
SetStoryDisplayName(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "SerialKiller_Dolor_Name");
SetHostileAndEnterCombat((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, _PartyCharacter, _Character);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, 0);

//Dolor receives second attack and run away
IF
AttackedBy(_Character, _PartyCharacter, _, _, _, _, _StoryActionID)
AND
DB_PartyMembers((CHARACTER)_PartyCharacter)
AND
IsInCombat(_Character, 0)
AND
DB_LOW_DolorAndDoppelgangers((CHARACTER)_Character, _, _)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
AND
DB_HiddenCharacters(_PartyCharacter, _)
AND
DB_SerialKiller_DolorAttackedStealth("True")
THEN
NOT DB_SerialKiller_DolorAttackedStealth("True");
SetFlag((FLAG)LOW_SerialKiller_State_DolorNotKillsCora_fde4182c-ace1-40a8-a5ef-d680f289b42a);
PROC_TryStartAD(LOW_SerialKiller_AD_DolorBeingAttackedRunAway_36292ecd-2ac0-2335-85b6-c0ee47338006, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
PROC_LOW_SerialKiller_DolorTryToEscape("LOW_Dolor_AwayWineFestival_NotKillingCora");
SetFlag((FLAG)LOW_SerialKiller_State_CoraSavedInStealth_4779eeec-ec9e-4cb3-b863-da0cb7c0385b);

//Dolor receives first attack from a hidden character
IF
AttackedBy(_Character, _PartyCharacter, _, _, _, _, _StoryActionID)
AND
DB_PartyMembers((CHARACTER)_PartyCharacter)
AND
IsInCombat(_Character, 0)
AND
DB_LOW_DolorAndDoppelgangers((CHARACTER)_Character, _, _)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
AND
DB_HiddenCharacters(_PartyCharacter, _)
AND
NOT DB_SerialKiller_DolorAttackedStealth("True")
THEN
DB_SerialKiller_DolorAttackedStealth("True");
PROC_TryStartAD(LOW_SerialKiller_AD_DolorReceiveFirstAttackFestival_bb62c31a-045c-5b07-6438-908c08be4719, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134); //Will improve this in behaviour phase

//Force to use the Misty Steps scroll if Dolor have one in their inventory at their first turn at the wine festival
IF
TurnStarted(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
AND
NOT DB_Dead(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
NOT QRY_IsCharaterUnconsciousOrEquivalent(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
THEN
PROC_LOW_SerialKiller_DolorTryToEscape("LOW_Dolor_AwayWineFestival_NotKillingCora");

//Force to use the Misty Steps scroll if Dolor have one in their inventory at their first turn at the wine festival
IF
TurnStarted(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
AND
DB_Dead(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
NOT QRY_IsCharaterUnconsciousOrEquivalent(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
THEN
PROC_LOW_SerialKiller_DolorTryToEscape("LOW_Dolor_AwayWineFestival_KillingCora");

//Oneshooting Dolor or one of the doppelgangers
IF
KilledBy(_DolorORDoppelganger, _Player, _Player, _ID)
AND
DB_PartyMembers((CHARACTER)_Player)
AND
DB_LOW_DolorAndDoppelgangers(_DolorORDoppelganger, _, _)
AND
IsInCombat(_DolorORDoppelganger, 0)
AND
DB_State_Current(_Character,"LOW_Dolor","WineFestival")
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, 0);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, 0);

//Check if players begin combat in the plaza
IF
CombatStarted(_CombatGuid)
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember, _CombatGuid)
AND
DB_Is_InCombat((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _CombatGuid)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
AND
QRY_OnlyOnce("LOW_SerialKiller_WineFestivalCombat")
THEN
PROC_CharacterMoveTo((CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, S_LOW_HighberrysHouse_Roger_RunPoint_c5d63e62-feb9-42f1-b705-ed372e49e244, "Run", "", "check");
PROC_CharacterMoveTo((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, S_LOW_HighberrysHouse_Cora_RunPoint_b0fef3b7-1f43-48b4-81a2-12c1c2675749, "Run", "", "check");
PROC_SetRelationMutual(Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_WineFestivalCivilians_e620bbb1-53ff-49f5-a324-14033c17a85e, 51);
PROC_SetRelationMutual(Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, (FACTION)ACT3_LOW_SerialKiller_WineFestivalCivilians_e620bbb1-53ff-49f5-a324-14033c17a85e, 51);
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway(_CombatGuid);

//Adding the players to a custom DB when they start combat with Dolor
IF
DB_Is_InCombat(_Player, _CombatGuid)
AND
DB_Is_InCombat((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _CombatGuid)
AND
NOT DB_LOW_SerialKiller_PlayersIncombat((CHARACTER)_Player, _CombatGuid)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
AND
DB_Players((CHARACTER)_Player)
THEN
DB_LOW_SerialKiller_PlayersIncombat(_Player, _CombatGuid);

//Wine attendants should run away.
PROC
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway()
AND
DB_LOW_WineFestivalAttendants(_Character, _Dialog)
THEN
PROC_RemoveDialog(_Character);
PROC_DisappearOutOfSight(_Character, "Run", 1, "");
NOT DB_LOW_WineFestivalAttendants(_Character, _Dialog);

PROC
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway()
AND
DB_LOW_SerialKiller_WineFestivalCrowds(_CrowdTrigger)
THEN
TriggerSetCrowdBehaviour(_CrowdTrigger, CROWDBEHAVIOUR.Flee);
TriggerSetCrowdSpawningEnable((TRIGGER)_CrowdTrigger,0);
NOT DB_LOW_SerialKiller_WineFestivalCrowds(_CrowdTrigger);

PROC
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway((GUIDSTRING)_CombatGuid)
AND
DB_LOW_WineFestivalAttendants(_Character, _Dialog)
THEN
PROC_RemoveDialog(_Character);
DB_LOW_SerialKiller_RunAwayAfterCombat(_CombatGuid, _Character);
NOT DB_LOW_WineFestivalAttendants(_Character, _Dialog);

PROC
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway((GUIDSTRING)_CombatGuid)
AND
DB_LOW_SerialKiller_WineFestivalCrowds(_CrowdTrigger)
THEN
TriggerSetCrowdBehaviour(_CrowdTrigger, CROWDBEHAVIOUR.Cower);
DB_LOW_SerialKiller_RunAwayAfterCombat_Crowds(_CrowdTrigger, _CombatGuid);
NOT DB_LOW_SerialKiller_WineFestivalCrowds(_CrowdTrigger);

//Clear the flag of the wine festival if the attendants run away in any case
PROC
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway()
THEN
ClearFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5);

PROC
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway((GUIDSTRING)_CombatGuid)
THEN
ClearFlag((FLAG)LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5);

PROC
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway()
AND
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index)
THEN
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(-1);

PROC
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway((GUIDSTRING)_CombatGuid)
AND
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index)
THEN
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(-1);

IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_RunAwayAfterCombat(_CombatGuid, _Character)
THEN
PROC_DisappearOutOfSight(_Character, "Run", 1, "");

IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_RunAwayAfterCombat_Crowds(_CrowdTrigger, _CombatGuid)
THEN
TriggerSetCrowdBehaviour(_CrowdTrigger, CROWDBEHAVIOUR.Flee);
TriggerSetCrowdSpawningEnable((TRIGGER)_CrowdTrigger,0);
NOT DB_LOW_SerialKiller_RunAwayAfterCombat_Crowds(_CrowdTrigger, _CombatGuid);

//If Dolor runs away in the combat, after the combat an AD will play
IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersInCombat(_Player, _CombatGuid)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor","Figaro") //Dolor on Figaro's Because he escaped
AND
QRY_OnlyOnce("LOW_DolorScapes")
AND
QRY_GetRandom("DB_LOW_SerialKiller_PlayersInCombat", 2, "DB_LOW_SerialKiller_ReproduceEscapePAD") //To add some variation here
AND
DB_LOW_SerialKiller_ReproduceEscapePAD(_PlayerForPAD, _CombatGuidPAD)
THEN
NOT DB_LOW_SerialKiller_ReproduceEscapePAD(_PlayerForPAD, _CombatGuidPAD);
PROC_TryStartAD(LOW_SerialKiller_PAD_DolorEscapes_0d8e6e34-90af-6387-1581-02dd06f415d5, _PlayerForPAD);


//Check if combat ends and Dolor is still alive (because players run away, for example). Dolor and Cora alive
IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersInCombat(_Player, _CombatGuid)
AND
NOT DB_Defeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_Defeated((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
THEN
SetFlag((FLAG)LOW_SerialKiller_State_DolorNotKillsCora_fde4182c-ace1-40a8-a5ef-d680f289b42a);
DebugText(_Player, "End combat");
NOT DB_LOW_SerialKiller_PlayersInCombat(_Player, _CombatGuid);
Attack((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, 1);

IF
AttackedBy(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _, _, _, _, _)
THEN
Die(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, DEATHTYPE.Physical, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, 0, 0, 0.0);
SetFlag(LOW_SerialKiller_State_RogerMourning_9cdc1c53-e0c2-4b00-9896-34997ede19b7);
PROC_LOW_SerialKiller_DolorTryToEscape("LOW_Dolor_AwayWineFestival_KillingCora");
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway();

PROC
PROC_LongRest()
AND
DB_GlobalFlag(LOW_SerialKiller_State_RogerMourning_9cdc1c53-e0c2-4b00-9896-34997ede19b7)
THEN
ClearFlag(LOW_SerialKiller_State_RogerMourning_9cdc1c53-e0c2-4b00-9896-34997ede19b7);

//Check if combat ends and Dolor is still alive (because players run away, for example). Dolor is alive, Cora is Dead
IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersInCombat(_Character, _CombatGuid)
AND
NOT DB_Defeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_Dead((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
THEN
NOT DB_LOW_SerialKiller_PlayersInCombat(_Character, _CombatGuid);
PROC_LOW_SerialKiller_DolorTryToEscape("LOW_Dolor_AwayWineFestival_KillingCora");


//Cleaning the databases
IF
CombatEnded(_CombatGuid)
AND
DB_LOW_SerialKiller_PlayersInCombat(_Player, _CombatGuid)
THEN
NOT DB_LOW_SerialKiller_PlayersInCombat(_Player, _CombatGuid);

//Apply drunk wine state for Cora and/OR roger if they drink the wine in the dialog
IF
DialogEnded((DIALOGRESOURCE)LOW_HighberrysHouse_Dolor_d96be40a-b01f-dfbc-72e1-303796a5e6c6, _)
AND
DB_LOW_SerialKiller_FlagsDrinkingWine(_Flag)
AND
DB_LOW_SerialKiller_TheHighberrys(_OneHighberry)
AND
GetFlag((FLAG)_Flag, _OneHighberry, 1)
THEN
ApplyStatus(_OneHighberry, "LOW_SERIALKILLER_PARALYZED", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);

//Dolor will attack Cora if she is paralized.
IF
StatusApplied((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, "LOW_SERIALKILLER_PARALYZED", _, _)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
Attack((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, 1);

IF
FlagSet(LOW_SerialKiller_Event_WineParalysis_Players_f93c6e25-9b54-4c4d-6a31-1198234121fc, _Player, _)
THEN
DB_SerialKiller_WaitUntilFinishDialog_Paralysis(_Player);

IF
DialogEnded(LOW_HighberrysHouse_Dolor_d96be40a-b01f-dfbc-72e1-303796a5e6c6, _)
AND
DB_SerialKiller_WaitUntilFinishDialog_Paralysis(_Player)
THEN
NOT DB_SerialKiller_WaitUntilFinishDialog_Paralysis(_Player);
ApplyStatus(_Player, "LOW_SERIALKILLER_PARALYZED", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_LOW_SerialKiller_DoppelgangersAsDolor();
SetStoryDisplayName(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "SerialKiller_Dolor_Name");
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, 0);

PROC
PROC_LOW_SerialKiller_DoppelgangersAsDolor()
AND
DB_LOW_DolorAndDoppelgangers(_Character, _, _)
AND
_Character != S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134
AND
NOT DB_LOW_SerialKiller_Doppelganger_AlreadyTransformed(_Character)
THEN
UseSpell(_Character, "Shout_LOW_Shapechanger_Doppelganger_Highberry_000", _Character);
DB_LOW_SerialKiller_Doppelganger_AlreadyTransformed(_Character);

//Equip the daggers for the doppelgangers
PROC
PROC_LOW_SerialKiller_DoppelgangersAsDolor()
AND
DB_LOW_DolorAndDoppelgangers(_Character, _, _)
AND
_Character != S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134
AND
GUIDToString(_Character, _Result)
AND
Concatenate("LOW_SerialKiller_FindDagger_", _Result, _OutEvent)
AND
Concatenate("LOW_SerialKiller_FinishSearch_", _Result, _OutFinalEvent)
THEN
IterateInventory(_Character, _OutEvent, _OutFinalEvent);
DB_LOW_SerialKiller_DoppelgangersIteration(_OutEvent, _OutFinalEvent, _Character);

IF
EntityEvent(_Item, _DoppelgangerEvent)
AND
DB_LOW_SerialKiller_DoppelgangersIteration(_DoppelgangerEvent, _, _Character)
AND
GetTemplate(_Item, WPN_HUM_Dagger_A_0_569b0f3d-abcd-4b01-aaf0-979091288163)
THEN
Equip(_Character, (ITEM)_Item, 1, 0, 0);

IF
EntityEvent(_, _OutFinalEvent)
AND
DB_LOW_SerialKiller_DoppelgangersIteration(_OutFinal, _OutFinalEvent, _Charcter)
THEN
NOT DB_LOW_SerialKiller_DoppelgangersIteration(_OutFinal, _OutFinalEvent, _Charcter);

PROC
PROC_LOW_SerialKiller_DolorUseSpellGoAway()
THEN
UseSpell((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "Shout_LOW_SerialKiller_BootsOfDimensionDoor", S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

IF
CastedSpell(_Character, "Shout_LOW_SerialKiller_BootsOfDimensionDoor", _, _, _)
AND
GetPosition(_Character, _X, _Y, _Z)
THEN
EndTurn(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
PlayEffectAtPosition(VFX_Spells_Cast_Intent_Utility_DimensionDoor_Root_01_7a4c033f-4128-31c0-fc04-951f8b7f2242, _X, _Y, _Z, 1.0);
PlayEffect(_Character, VFX_Spells_Cast_Intent_Utility_DimensionDoor_BodyFX_Textkey_01_f4de2ffb-353f-a215-3311-f729bd8de1d6);
RealtimeObjectTimerLaunch(_Character, "LOW_SerialKiller_TeleportAnimationDelay", 600); //Timer is needed because the VFX for disappearing also makes the character reappear after some time. If we play it too soon, we see the character reappear before they are set off stage.

IF
ObjectTimerFinished(_Character, "LOW_SerialKiller_TeleportAnimationDelay")
AND
DB_LOW_SerialKiller_DolorGoAway(_String)
THEN
SetOnStage((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, 0);
RealtimeObjectTimerLaunch(_Character, "LOW_SerialKiller_GoToFigaro_Delay", 6000);

IF
ObjectTimerFinished(_Character, "LOW_SerialKiller_GoToFigaro_Delay")
AND
DB_LOW_SerialKiller_DolorGoAway(_String)
THEN
PROC_LOW_FigarosSetup_NotLongRest(_String);
NOT DB_LOW_SerialKiller_DolorGoAway(_String);

//Dolor use magic to scape from the wine festival
PROC
PROC_LOW_SerialKiller_DolorTryToEscape("LOW_Dolor_AwayWineFestival_NotKillingCora")
THEN
PROC_LOW_SerialKiller_DolorUseSpellGoAway();
DB_LOW_SerialKiller_DolorGoAway("NotKillCora");

//Dolor use magic to scape from the wine festival
PROC
PROC_LOW_SerialKiller_DolorTryToEscape("LOW_Dolor_AwayWineFestival_KillingCora")
THEN
SetFlag((FLAG)LOW_SerialKiller_State_DolorKillsCoraWineFestival_0fce13c6-8d48-4391-a890-f1397add7af4);
PROC_LOW_SerialKiller_DolorUseSpellGoAway();
DB_LOW_SerialKiller_DolorGoAway("KilledCora");

//Dolor moves to Figaro and both Highberrys survive
PROC
PROC_State_Changed(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","Figaro")
AND
NOT DB_PermaDefeated(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404)
AND
NOT DB_PermaDefeated(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
THEN
PROC_RemoveDialog(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);
PROC_RemoveDialog(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679);
DB_Dialogs((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404,
	(DIALOGRESOURCE)LOW_HighberrysHouse_WithoutMurderer_547725be-0fc8-c4c0-45bb-ab694a8732f2);

//Assign the dialog to both Highberry's after killing Dolor
PROC
PROC_StateSet_Defeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_PermaDefeated(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404)
AND
NOT DB_PermaDefeated(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
THEN
PROC_RemoveDialog(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);
PROC_RemoveDialog(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679);
DB_Dialogs((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404,
	(DIALOGRESOURCE)LOW_HighberrysHouse_WithoutMurderer_547725be-0fc8-c4c0-45bb-ab694a8732f2);



//END_REGION

//REGION Checking dialogues with multiple characters
//Check started dialog with Cora and Roger (without Dolor)
QRY
QRY_SelectCustomDialog(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, _Player)
AND
QRY_SpeakerIsAvailable(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
NOT DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_HighberrysHouse_WithoutMurderer_547725be-0fc8-c4c0-45bb-ab694a8732f2, (CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679,
	(CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, _Player);

//Check started dialog with Cora and Roger (without Dolor)
QRY
QRY_SelectCustomDialog(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, _Player)
AND
QRY_SpeakerIsAvailable(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404)
AND
NOT DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_HighberrysHouse_WithoutMurderer_547725be-0fc8-c4c0-45bb-ab694a8732f2, (CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679,
	(CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, _Player);

//Check started dialog with Dolor, Cora and Roger
QRY
QRY_SelectCustomDialog(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, _Player)
AND
QRY_SpeakerIsAvailable(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404)
AND
QRY_SpeakerIsAvailable(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_HighberrysHouse_Dolor_d96be40a-b01f-dfbc-72e1-303796a5e6c6, (CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,
	(CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, _Player);

//Check started dialog with Dolor, Cora and Roger
QRY
QRY_SelectCustomDialog(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, _Player)
AND
QRY_SpeakerIsAvailable(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
QRY_SpeakerIsAvailable(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_HighberrysHouse_Dolor_d96be40a-b01f-dfbc-72e1-303796a5e6c6, (CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,
	(CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, _Player);

//Check started dialog with Dolor, Cora and Roger
QRY
QRY_SelectCustomDialog(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _Player)
AND
QRY_SpeakerIsAvailable(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
QRY_SpeakerIsAvailable(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
THEN
DB_SelectedDialog((DIALOGRESOURCE)LOW_HighberrysHouse_Dolor_d96be40a-b01f-dfbc-72e1-303796a5e6c6, (CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,
	(CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, _Player);


//END_REGION

//REGION Performing the ritual
// Show/hide all ritual items
PROC
PROC_LOW_HighberrysHouse_ShowRitualItems((INTEGER)_IsActive)
AND
DB_LOW_HighberrysRitualPerformedItems(_Item)
THEN
SetOnStage(_Item, _IsActive);

// Move the ritual characters to their finals positions.
PROC
PROC_LOW_SetRitualCharactersInPosition()
AND
DB_LOW_HighberrysRitualPerformedCharacters(_Character, _Trigger)
AND
NOT DB_PermaDefeated(_Character)
THEN
PROC_SetOnStage(_Character, 1);
TeleportTo(_Character, _Trigger);

//To handle the edge case when the FF are leaving through Disappear out of Sight (because players already enter in the Wine Festival) and, before finish, they do a really quick long rest.
IF
Deactivated(_FlamingFist)
AND
DB_LOW_Elfsong_FlamingFists((CHARACTER)_FlamingFist)
AND
DB_GlobalFlag(LOW_SerialKiller_State_HighberrysRitualPerformed_00c1e2ab-8752-47f1-b847-51aedc0fb189)
THEN
PROC_SetOnStage(_FlamingFist, 1);

PROC
PROC_LOW_HighberrysHouse_SetHighberrys()
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_SerialKiller_State_HighberrysRitualPerformed_00c1e2ab-8752-47f1-b847-51aedc0fb189);
PROC_LOW_SetRitualCharactersInPosition();
PROC_LOW_HighberrysHouse_ShowRitualItems(1);
Die(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (DIALOGRESOURCE)LOW_HighberrysHouse_Cora_SwD_f7a40e0d-caa2-a08d-8d10-7eee2e0c265a);
Die(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);
TeleportTo(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679, (TRIGGER)S_LOW_HighberrysHouse_CoraTP_056984a3-8b78-443b-9005-a9d229db20c3);
TeleportTo(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, (TRIGGER)S_LOW_HighberrysHouse_RogerTP_ab7c4284-52bf-42c6-bda8-d8558532974a);

// If the players leave the area and take a long rest, the Highberrys will be killed and some other things happens. Full ritual, with both Highberrys killed by Dolor
PROC
PROC_LOW_HighberrysHouse_PerformRitual()
AND
NOT DB_Dead(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index)
THEN
PROC_LOW_ShowAttendantsWineFestival(1);
PROC_LOW_HighberrysHouse_SetHighberrys();
PROC_LOW_FigarosSetup_NotLongRest("KilledCora");
PROC_LOW_HideOnlyDoppelgangers();
PROC_RemoveDialog(S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c);
PROC_RemoveDialog(S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, (DIALOGRESOURCE)LOW_HighberrysHouse_Guard_d3e5af13-a9a8-ad24-2841-fef76a50ef06);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, (DIALOGRESOURCE)LOW_HighberrysHouse_Guard_Interior_5a2426c2-b921-1704-b3d9-ecaf59683a5e);
NOT DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index);
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(-1);

// Ritual, but players kill Roger and Cora and get her hand
PROC
PROC_LOW_HighberrysHouse_PerformRitual()
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_State_Cora_SeveredHand_d8c2c89a-235d-486c-9bf7-4f5aed0b84e7)
AND
DB_PermaDefeated((CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404)
AND
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index)
THEN
PROC_LOW_SetRitualCharactersInPosition();
PROC_LOW_FigarosSetup_NotLongRest("NotKillCora");
PROC_LOW_HideOnlyDoppelgangers();
SetFlag((FLAG)LOW_SerialKiller_State_HighberrysRitualPerformed_00c1e2ab-8752-47f1-b847-51aedc0fb189);
PROC_RemoveDialog(S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c);
PROC_RemoveDialog(S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, (DIALOGRESOURCE)LOW_HighberrysHouse_Guard_d3e5af13-a9a8-ad24-2841-fef76a50ef06);
DB_Dialogs((CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, (DIALOGRESOURCE)LOW_HighberrysHouse_Guard_Interior_5a2426c2-b921-1704-b3d9-ecaf59683a5e);
NOT DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(_Index);
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(-1);

//If the ritual is performed, all the crowds should leave
PROC
PROC_LOW_HighberrysHouse_PerformRitual()
AND
DB_LOW_SerialKiller_WineFestivalCrowds(_CrowdTrigger)
THEN
TriggerSetCrowdBehaviour(_CrowdTrigger, CROWDBEHAVIOUR.Flee);
TriggerSetCrowdSpawningEnable((TRIGGER)_CrowdTrigger,0);
NOT DB_LOW_SerialKiller_WineFestivalCrowds(_CrowdTrigger);

//Guard yelling
IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_SerialKiller_VisitWineFestival_f5419edc-b46c-4f87-9853-eaf67eaefa23)
AND
DB_GlobalFlag((FLAG)LOW_SerialKiller_State_HighberrysRitualPerformed_00c1e2ab-8752-47f1-b847-51aedc0fb189)
AND
QRY_OnlyOnce("LOW_SerialKiller_GuardYelling")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_SerialKiller_AD_FlamingFist01_Yelling_d167404a-5545-f200-25e1-e20498b1b82a, (CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c);
PROC_TriggerUnregisterForParty(S_LOW_SerialKiller_VisitWineFestival_f5419edc-b46c-4f87-9853-eaf67eaefa23);

//END_REGION

//REGION Combat OE Commands Helpers [Abby]
IF
TextEvent("low_highberry_combat")
AND
GetHostCharacter(_Player)
THEN
DB_Debug_LOW_Highberry_CombatRequested(1);
TeleportTo(_Player, S_DEBUG_Teleport_LOW_Start_fab2d4d4-8b03-4263-94d7-f9819ed26523,"debug_LOW_highberry_teleport_reset", 1, 1, 1, 1, 1);

IF
EntityEvent(_Player, "debug_LOW_highberry_teleport_reset")
AND
QRY_OnlyOnce("debug_LOW_highberry_teleport_reset")
THEN
LoadPartyPreset("Level12_Rogue_Fighter_Cleric_Wizard",_Player);

IF
PartyPresetLoaded("Level12_Rogue_Fighter_Cleric_Wizard", _)
AND
DB_Debug_LOW_Highberry_CombatRequested(1)
THEN
NOT DB_Debug_LOW_Highberry_CombatRequested(1);
SetFlag((FLAG)LOW_SerialKiller_State_MissionTriggered_003250e5-2cca-4612-9b74-a9802e8fec12);
SetFlag((FLAG)LOW_SerialKiller_Knows_TargetList_262314d1-43bf-4ea5-ae23-4a77bfab2671);
SetFlag((FLAG)Debug_LOW_SerialKiller_NextStageQuest_06aad8a3-cdeb-4fd1-b029-6cfe8c096397);
SetFlag((FLAG)LOW_SerialKiller_Event_KillHighberrysAfterLongRest_c79f8fc7-272d-4398-8861-848d469b885b);
PROC_LongRest();
TimerLaunch("DEBUG_LOW_Highberry_TimerLaunched", 1000);

IF
TimerFinished("DEBUG_LOW_Highberry_TimerLaunched")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player, S_Debug_Teleport_LOW_HighberrysHouse_77e3cb84-658e-439b-b1ce-824fa3cb3068,"", 1, 1, 1, 1, 1);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
