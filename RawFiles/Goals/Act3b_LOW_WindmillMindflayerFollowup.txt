Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_LOW_WindmillMindflayerFollowup_Family((GUIDSTRING)S_LOW_WindmillMindflayerFollowup_Father_9eb473a4-6fd9-4cc2-87df-537c434ee32e);
DB_LOW_WindmillMindflayerFollowup_Family(S_LOW_WindmillMindflayerFollowup_Mother_323eb737-2422-4026-b403-785473c738ee);
DB_LOW_WindmillMindflayerFollowup_Family(S_LOW_WindmillMindflayerFollowup_Child_36c1ce47-4d87-4520-9094-e4dc8008cffd);

DB_Dialogs(S_LOW_WindmillMindflayerFollowup_Father_9eb473a4-6fd9-4cc2-87df-537c434ee32e,(DIALOGRESOURCE)LOW_WindmillMindflayerFollowup_Father_83973615-2a60-9cb7-bed4-e69dc1a6ca31);
DB_Dialogs(S_LOW_WindmillMindflayerFollowup_Mother_323eb737-2422-4026-b403-785473c738ee,(DIALOGRESOURCE)LOW_WindmillMindflayerFollowup_Mother_c570f03a-5f92-2ed7-547c-1fc9e7ad7fc1);
DB_Dialogs(S_LOW_WindmillMindflayerFollowup_Child_36c1ce47-4d87-4520-9094-e4dc8008cffd,(DIALOGRESOURCE)LOW_WindmillMindflayerFollowup_Child_e6df6aef-0fbc-6bee-51db-cde3644e3b4d);

DB_LOW_WindmillMindflayer_StatusesToRemove("WYR_WINDMILL_MINDFLAYER_WEAK");

DB_Children((CHARACTER)S_LOW_WindmillMindflayerFollowup_Child_36c1ce47-4d87-4520-9094-e4dc8008cffd);

DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_WindmillMindflayerFollowup_OwnershipTrigger_01_db4e5316-a8e9-4909-b011-e0f5db933f2c,(CHARACTER)S_LOW_WindmillMindflayerFollowup_Father_9eb473a4-6fd9-4cc2-87df-537c434ee32e);
DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_WindmillMindflayerFollowup_OwnershipTrigger_02_3bd6edaf-5063-4755-9d19-8f2e6a735736,(CHARACTER)S_LOW_WindmillMindflayerFollowup_Father_9eb473a4-6fd9-4cc2-87df-537c434ee32e);
DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_Door_FillerHouseC_AmbrustDownstairs_848264a8-c8f7-4dc3-b1cd-c1c6c5ccdd6b);
DB_ItemOwnerShipClearItem("CTY_Main_A",(ITEM)S_DOOR_FillerhouseC_AmbrustUpstairs_0af028e4-a254-485e-8154-0d80b247b90f);
KBSECTION
//REGION Mindflayer arrives flow
IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)WYR_Windmill_State_BodyGiven_500f48b2-6888-7f02-b3de-7c17f051dd8d)
AND
NOT DB_GlobalFlag((FLAG)LOW_WindmillMindflayerFollowup_State_FamilyScaredAway_32926fbe-cde7-47ee-b798-e58fad71062f)
AND
NOT DB_PermaDefeated(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17)
AND
NOT DB_LOW_WindmillMindflayerFollowup_Setup(1)
THEN
DB_LOW_WindmillMindflayerFollowup_Setup(1);
PROC_LOW_WindmillMindflayerFollowup_Setup();

PROC
PROC_LOW_WindmillMindflayerFollowup_Setup()
THEN
Transform(S_LOW_WindmillMindflayerFollowup_Mother_323eb737-2422-4026-b403-785473c738ee,UNI_LOW_WindmillMindflayerFollowup_Mother_Headless_397ee59a-051b-4fc7-a1c3-fe62ba9fd98c,(SHAPESHIFTRULE)DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);
Transform(S_LOW_WindmillMindflayerFollowup_Father_9eb473a4-6fd9-4cc2-87df-537c434ee32e,UNI_LOW_WindmillMindflayerFollowup_Father_Headless_9a98a88e-9a50-4f58-be8c-791caee4c37f,(SHAPESHIFTRULE)DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);
TriggerClearItemsOwner((TRIGGER)S_LOW_WindmillMindflayerFollowup_OwnershipTrigger_01_db4e5316-a8e9-4909-b011-e0f5db933f2c);
TriggerClearItemsOwner((TRIGGER)S_LOW_WindmillMindflayerFollowup_OwnershipTrigger_02_3bd6edaf-5063-4755-9d19-8f2e6a735736);
PROC_GlobalSetFlagAndCache((FLAG)LOW_WindmillMindflayerFollowup_State_MindflayerInBG_834b84d1-8917-437f-8b7f-105d91085758);
PROC_Children_RemoveNPC((CHARACTER)S_LOW_WindmillMindflayerFollowup_Child_36c1ce47-4d87-4520-9094-e4dc8008cffd);
DB_CombatReact_AD_OnEntered(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17,(DIALOGRESOURCE)WYR_Windmill_AD_Mindflayer_Combat_02_52f4d950-62cf-82df-3e36-ca19df805fbe);

PROC
PROC_LOW_WindmillMindflayerFollowup_Setup()
AND
DB_LOW_WindmillMindflayerFollowup_Family(_Character)
AND
NOT DB_PermaDefeated(_Character)
THEN
Die(_Character,DEATHTYPE.Physical,0);
DB_CorpseCleanup_Ignore((CHARACTER)_Character);

PROC
PROC_LOW_WindmillMindflayerFollowup_Setup()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17);
PROC_CharacterFullRestore(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17);
TeleportTo(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17,(TRIGGER)S_LOW_WindmillMindflayerFollowup_MF_Spot_91ea4881-9165-4efb-bdee-1c21c95544d6,"LOW_WindmillMindflayer_Teleported");
DB_Dialogs(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17,(DIALOGRESOURCE)LOW_WindmillMindflayerFollowup_Mindflayer_7aedb297-8c40-e77e-8808-a3956b924dee);

IF
EntityEvent(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17,"LOW_WindmillMindflayer_Teleported")
THEN
SetOnStage(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17,1);
RealtimeObjectTimerLaunch(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17,"LOW_WindmillMindflayer_RemoveStatuses_Timer",1000);

IF
ObjectTimerFinished(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17,"LOW_WindmillMindflayer_RemoveStatuses_Timer")
AND
DB_LOW_WindmillMindflayer_StatusesToRemove(_Status)
AND
HasActiveStatus(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17,_Status,1)
THEN
RemoveStatus(S_WYR_Windmill_MF_2084666f-59fb-470f-bb68-4523cf881d17,_Status);
//END_REGION

//REGION Handling players killing family members before mindlayer arrives. In that case, the mindflayer never arrives
PROC
PROC_StateSet_Defeated(_Character)
AND
DB_LOW_WindmillMindflayerFollowup_Family(_Character)
AND
NOT DB_GlobalFlag((FLAG)LOW_WindmillMindflayerFollowup_State_MindflayerInBG_834b84d1-8917-437f-8b7f-105d91085758)
THEN
PROC_LOW_WindmillMindflayerFollowupFamilyRunsAway();

PROC
PROC_LOW_WindmillMindflayerFollowupFamilyRunsAway()
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_WindmillMindflayerFollowup_State_FamilyScaredAway_32926fbe-cde7-47ee-b798-e58fad71062f);

PROC
PROC_LOW_WindmillMindflayerFollowupFamilyRunsAway()
AND
DB_LOW_WindmillMindflayerFollowup_Family(_Character)
AND
NOT DB_PermaDefeated(_Character)
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)_Character,"LOW_WindmillMindflayerFollowupFamily_Notify");

PROC
PROC_ReadyToMoveOn(_Character,"LOW_WindmillMindflayerFollowupFamily_Notify")
THEN
PROC_DisappearOutOfSight(_Character,"Run",0,"");
//END_REGION

// Debug
IF
DB_GlobalFlag((FLAG)LOW_WindmillMindflayerFollowup_Debug_Setup_05a96eb5-d82c-4a7b-a5a8-4994f65ff5d3)
THEN
ClearFlag((FLAG)LOW_WindmillMindflayerFollowup_Debug_Setup_05a96eb5-d82c-4a7b-a5a8-4994f65ff5d3);
DB_LOW_WindmillMindflayer_StatusesToRemove("SLEEPING");
DB_LOW_WindmillMindflayerFollowup_Setup(1);
PROC_LOW_WindmillMindflayerFollowup_Setup();
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
