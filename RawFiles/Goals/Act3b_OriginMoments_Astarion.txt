Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Black Mass Aftermath
DB_CampNight((FLAG)NIGHT_Astarion_BlackMassAftermath_347b8d34-c287-4d15-83c5-7ae6786003c7, 4190);
DB_CampNight_Camp((FLAG)NIGHT_Astarion_BlackMassAftermath_347b8d34-c287-4d15-83c5-7ae6786003c7, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Astarion_BlackMassAftermath_347b8d34-c287-4d15-83c5-7ae6786003c7, "ELFSONG");
DB_CampNight_Camp((FLAG)NIGHT_Astarion_BlackMassAftermath_347b8d34-c287-4d15-83c5-7ae6786003c7, "FARM");
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_BlackMassAftermath_347b8d34-c287-4d15-83c5-7ae6786003c7, (FLAG)ORI_Astarion_Knows_CazadorDead_5f891b0c-a2d8-4d6c-9f99-3012ab00b54e, (FLAG)ASTARIONCOMPANION_9fa6b609-3ba0-43ed-a95b-82304f7b8dac);
DB_CampNight_Requirement_Partner((FLAG)NIGHT_Astarion_BlackMassAftermath_347b8d34-c287-4d15-83c5-7ae6786003c7, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255);
DB_CampNight_RomanceNight((FLAG)NIGHT_Astarion_BlackMassAftermath_347b8d34-c287-4d15-83c5-7ae6786003c7, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)CAMP_Astarion_SD_ROM_BlackMassAftermath_cdc9ae59-c30e-3819-4060-d46263681631,(FLAG)NULL_00000000-0000-0000-0000-000000000000);
DB_OriginMayLeaveDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)CAMP_Astarion_SD_ROM_BlackMassAftermath_cdc9ae59-c30e-3819-4060-d46263681631);

// Spawn Friendship Follow Up
DB_CampNight((FLAG)NIGHT_Astarion_SpawnFriendshipFollowUp_913e611c-4bcd-472d-8e30-0bfeea9503b4, 4000);
DB_CampNight_Camp((FLAG)NIGHT_Astarion_SpawnFriendshipFollowUp_913e611c-4bcd-472d-8e30-0bfeea9503b4, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Astarion_SpawnFriendshipFollowUp_913e611c-4bcd-472d-8e30-0bfeea9503b4, "ELFSONG");
DB_CampNight_Camp((FLAG)NIGHT_Astarion_SpawnFriendshipFollowUp_913e611c-4bcd-472d-8e30-0bfeea9503b4, "FARM");
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_SpawnFriendshipFollowUp_913e611c-4bcd-472d-8e30-0bfeea9503b4, (FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546, (FLAG)ORI_Astarion_State_BlackMassAftermathFriendshipTrack_3affb6d7-e057-402e-b218-d99f8bc79089, (FLAG)ASTARIONCOMPANION_9fa6b609-3ba0-43ed-a95b-82304f7b8dac);
DB_CampNight_CRD((FLAG)NIGHT_Astarion_SpawnFriendshipFollowUp_913e611c-4bcd-472d-8e30-0bfeea9503b4, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_CRD_SpawnFriendFollowUp_de839ea2-f053-4298-ab28-e18adbe991c8);

// Lord Friendship Follow Up
DB_CampNight((FLAG)NIGHT_Astarion_LordFriendshipFollowUp_6ba14bd2-6ad5-4018-aeb2-28544137514d, 4000);
DB_CampNight_Camp((FLAG)NIGHT_Astarion_LordFriendshipFollowUp_6ba14bd2-6ad5-4018-aeb2-28544137514d, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Astarion_LordFriendshipFollowUp_6ba14bd2-6ad5-4018-aeb2-28544137514d, "ELFSONG");
DB_CampNight_Camp((FLAG)NIGHT_Astarion_LordFriendshipFollowUp_6ba14bd2-6ad5-4018-aeb2-28544137514d, "FARM");
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_LordFriendshipFollowUp_6ba14bd2-6ad5-4018-aeb2-28544137514d, (FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, (FLAG)ORI_Astarion_State_BlackMassAftermathFriendshipTrack_3affb6d7-e057-402e-b218-d99f8bc79089, (FLAG)ASTARIONCOMPANION_9fa6b609-3ba0-43ed-a95b-82304f7b8dac);
DB_CampNight_CRD((FLAG)NIGHT_Astarion_LordFriendshipFollowUp_6ba14bd2-6ad5-4018-aeb2-28544137514d, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_CRD_LordFriendFollowUp_8b80bda9-5640-421a-b086-9cdf92a4e028);

// 2 days afer breaking up with the Lord
DB_CampNight((FLAG)NIGHT_Astarion_TwoDaysAfterBreakup_1da1bdb1-8a25-46dd-beff-8d27694f4934, 4190);
DB_CampNight_Camp((FLAG)NIGHT_Astarion_TwoDaysAfterBreakup_1da1bdb1-8a25-46dd-beff-8d27694f4934, "SLUMS");
DB_CampNight_Camp((FLAG)NIGHT_Astarion_TwoDaysAfterBreakup_1da1bdb1-8a25-46dd-beff-8d27694f4934, "ELFSONG");
DB_CampNight_Camp((FLAG)NIGHT_Astarion_TwoDaysAfterBreakup_1da1bdb1-8a25-46dd-beff-8d27694f4934, "FARM");
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_TwoDaysAfterBreakup_1da1bdb1-8a25-46dd-beff-8d27694f4934, (FLAG)ORI_Astarion_State_TwoDaysPassedAfterBreakingUpWithLord_5e99a44d-ee98-49f0-b34b-31735b383f15, (FLAG)ASTARIONCOMPANION_9fa6b609-3ba0-43ed-a95b-82304f7b8dac);
DB_CampNight_CRD((FLAG)NIGHT_Astarion_TwoDaysAfterBreakup_1da1bdb1-8a25-46dd-beff-8d27694f4934, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_CRD_TwoDaysAfterBreakupWithLord_f2840737-c28c-4d14-85c8-58f389bc361b);
//END_REGION Black Mass Aftermath

//REGION Relationship Dialogs
//Lord FollowUp - Ritual Room
DB_GlobalFlagReactionAfterDialog((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);

//Spawn FollowUp - Ritual Room
DB_GlobalFlagReactionAfterDialog((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b);
//END_REGION
KBSECTION
//REGION Romance
IF
DialogEnded((DIALOGRESOURCE)CAMP_Astarion_SD_ROM_BlackMassAftermath_cdc9ae59-c30e-3819-4060-d46263681631, _)
THEN
SetFlag(ORI_Astarion_State_Act3RomanceSceneEnded_d06b1484-55db-4a6b-988b-cbb26cb70c70);

IF
FlagSet(ORI_Astarion_Event_TurnIntoSpawn_d7819489-bbe1-4d7c-96f2-d01c7c336115, _Player, _)
THEN
AddPassive(_Player, "LOW_VampireSpawn");
SetFlag((FLAG)ORI_Astarion_State_PlayerTurnedIntoSpawn_3c67fb05-3ce6-491a-a9d1-2110acd8966c);

//Breaking up with Lord Astarion
//Either we are Karlach and he tried to convert us, or we simply broke up with him (both Karlach and non-Karlach players)
IF
FlagCleared((FLAG)ORI_State_PartneredWithAstarion_30819c8d-b39d-42e7-acd1-2a8c2c309994, _Player, _ID)
AND
DB_DialogName((DIALOGRESOURCE)CAMP_Astarion_SD_ROM_BlackMassAftermath_cdc9ae59-c30e-3819-4060-d46263681631, _ID)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
THEN
DB_ORI_Astarion_BrokeUpWithLord((CHARACTER)_Player);
SetFlag((FLAG)ORI_State_HandledBreakupWithAstarion_a8917c83-bcd4-4fb9-8459-649be92e2fbe, _Player);
DB_LongRestCountDown(3, (FLAG)ORI_Astarion_State_TwoDaysPassedAfterBreakingUpWithLord_5e99a44d-ee98-49f0-b34b-31735b383f15);

IF
DialogEnded((DIALOGRESOURCE)CAMP_Astarion_SD_ROM_BlackMassAftermath_cdc9ae59-c30e-3819-4060-d46263681631, _)
AND
DB_ORI_Astarion_BrokeUpWithLord(_Player)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Astarion_SD_ROM_BlackMassAftermath_TriedBitingKarlach_3d7e1697-d7f6-5c91-6c94-19620fa06f38)
THEN
SetFlag((FLAG)ORI_Astarion_State_BrokeUpWithLord_a7bb1f31-b617-4eae-a1e0-3ec516b930c1, _Player);

IF
DialogEnded((DIALOGRESOURCE)CAMP_Astarion_SD_ROM_BlackMassAftermath_cdc9ae59-c30e-3819-4060-d46263681631, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
THEN
SetFlag((FLAG)ORI_Astarion_State_NotVampireLordPostBlackMass_f9bde842-2fb6-4a95-9e64-4e5d214b0a13);

IF
DialogEnded((DIALOGRESOURCE)CAMP_Astarion_SD_ROM_BlackMassAftermath_cdc9ae59-c30e-3819-4060-d46263681631, _)
AND
DB_ORI_Astarion_BrokeUpWithLord((CHARACTER)_Player)
THEN
NOT DB_ORI_Astarion_BrokeUpWithLord((CHARACTER)_Player);
//END_REGION

//REGION Friendship Track
IF
FlagSet((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546, _, _)
AND
NOT DB_ORI_Partnered(_, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
SetFlag((FLAG)ORI_Astarion_State_BlackMassAftermathFriendshipTrack_3affb6d7-e057-402e-b218-d99f8bc79089);

IF
FlagSet((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, _, _)
AND
NOT DB_ORI_Partnered(_, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
SetFlag((FLAG)ORI_Astarion_State_BlackMassAftermathFriendshipTrack_3affb6d7-e057-402e-b218-d99f8bc79089);
//END_REGION

//REGION Relationship Dialogs
IF
FlagSet((FLAG)GLO_Companion_Leave_363c71f4-8b46-c0c0-4bbb-0e5a85e4652d, _, _DialogID)
AND
DB_DialogName((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _DialogID)
THEN
PROC_GlobalSetFlagAndCache(LOW_CazadorsPalace_RitualRoom_State_IPRDsBlocked_ae62ff68-2cb2-4756-aaa1-a2d6662f5407);

IF
FlagSet((FLAG)GLO_Companion_Combat_d8f0c309-193b-eaed-5aaa-812cd137caf2, _, _DialogID)
AND
DB_DialogName((DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b, _DialogID)
THEN
PROC_GlobalSetFlagAndCache(LOW_CazadorsPalace_RitualRoom_State_IPRDsBlocked_ae62ff68-2cb2-4756-aaa1-a2d6662f5407);

//Lord Follow Up - Ritual Room
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
NOT DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_IPRDsBlocked_ae62ff68-2cb2-4756-aaa1-a2d6662f5407)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, ORI_Astarion_IPRD_BecameVampireLord_00530d40-c094-491b-bb26-394c5f92fe59, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0);

//Spawn Follow Up - Ritual Room
PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546)
AND
NOT DB_Avatars((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
NOT DB_GlobalFlag(LOW_CazadorsPalace_RitualRoom_State_IPRDsBlocked_ae62ff68-2cb2-4756-aaa1-a2d6662f5407)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, ORI_Astarion_IPRD_StayedVampireSpawn_81ecc5e1-7aa1-4d3c-91dd-4ba751e0f8b1, S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 0);

PROC
PROC_CampNight_StartMorningMoments()
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_PlayerTurnedIntoSpawn_3c67fb05-3ce6-491a-a9d1-2110acd8966c)
AND
QRY_OnlyOnce("ORI_Astarion_CRD_Conversion")
THEN
PROC_CampRelationshipDialog(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)Astarion_InParty_53aba16e-55bb-a0fc-a444-522e237dbe46, (FLAG)ORI_Astarion_CRD_Conversion_318f1d8b-e4a1-4d31-8e04-431aacd058c7, 0);
PROC_Try_CampRelationshipDialog(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 1);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
