Version 1
SubGoalCombiner SGC_AND
INITSECTION
Lock(S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5, "STORY_LOCK");
Lock(S_END_ArmouryBackDoor_9203b8e4-7851-4f76-87e2-aad3f05d9a23, "STORY_LOCK");

DB_END_Armoury_Civilian((CHARACTER)S_END_ArmouryCivilian_001_8e88e13a-093a-47a5-9031-12055f1dff0b);
DB_END_Armoury_Civilian(S_END_ArmouryCivilian_002_b4818ef0-a5a8-44c4-9603-35a8d11869fe);
DB_END_Armoury_Civilian(S_END_ArmouryCivilian_003_bace1e81-671d-4120-bc0c-c46d26bcbbb7);

DB_Dialogs(S_END_ArmouryCivilian_001_8e88e13a-093a-47a5-9031-12055f1dff0b, S_END_ArmouryCivilian_002_b4818ef0-a5a8-44c4-9603-35a8d11869fe, S_END_ArmouryCivilian_003_bace1e81-671d-4120-bc0c-c46d26bcbbb7, END_Armoury_Door_7a02faca-ba91-d8da-f747-7dd765dbfacc);
DB_DialogBlockAttackButton(END_Armoury_Door_7a02faca-ba91-d8da-f747-7dd765dbfacc);
DB_DialogBlockTradeButton(END_Armoury_Door_7a02faca-ba91-d8da-f747-7dd765dbfacc);
DB_IgnoreMutingStatussesDialog(END_Armoury_Door_7a02faca-ba91-d8da-f747-7dd765dbfacc);

PROC_TriggerRegisterForParty(S_END_ArmouryArea_46fc22cd-e7f3-4605-be2d-82bd3ce020fc);
PROC_TriggerRegisterForParty(S_END_ArmouryDialogArea_c0e00073-f7ff-4e10-a470-81ea034fdf39);

DB_SpotPlayers(S_END_ArmouryCivilian_001_8e88e13a-093a-47a5-9031-12055f1dff0b, "END_Armoury_Infiltrated", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
KBSECTION
//REGION Locked entrance
//Failed to lockpick the door
PROC
PROC_RollResult("GAMEPLAY_LockPicking", _Player, S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5, 0)
AND
DB_Players(_Player)
THEN
SetFlag(END_Armoury_Event_BlockedInteraction_3a388774-3b6e-52af-740c-a2e4499add83, _Player, 0);
PROC_END_Armoury_StartDoorDialog(_Player);

PROC
PROC_BlockUseOfItem(_Player, S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5)
AND
NOT DB_GlobalFlag(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b)
AND
IsLocked(S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5, 1)
THEN
PROC_END_Armoury_StartDoorDialog(_Player);
DB_CustomUseItemResponse(_Player, S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5, 0);

IF
Opened(S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5)
THEN
SetCanInteract(S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5, 0);

IF
Opened(S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5)
AND
NOT DB_GlobalFlag(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b)
THEN
SetFlag(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
Opened(S_END_ArmouryBackDoor_9203b8e4-7851-4f76-87e2-aad3f05d9a23)
AND
NOT DB_GlobalFlag(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b)
THEN
SetFlag(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DestroyedBy(S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5, _, _, _)
THEN
SetFlag(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b, _, _)
AND
IsDestroyed(S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5, 0)
AND
IsOpened(S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5, 0)
THEN
PROC_ItemUnlockAndOpen(S_END_ArmouryDoor_311c45f0-4c10-4762-919a-c89f6d5cd3f5);

//END_REGION

//REGION Civilians spotting

//If door is opened while the civilians are in dialog, stop spotting.
IF
FlagSet(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b, _, _)
AND
DB_END_Armoury_Civilian(_Character)
AND
DB_DialogNPCs(_, _Character, _)
THEN
PROC_SpotPlayers_StopSpotting("END_Armoury_Infiltrated");

PROC
PROC_SpotPlayers_Spotted(_, "END_Armoury_Infiltrated", _Player)
THEN
SetFlag(END_Armoury_Event_Spotted_1996c2f9-fe02-4757-34b6-dbb0da34b5c3, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_END_Armoury_StartDoorDialog(_Player);

//END_REGION

//REGION Civilians leave

IF
DialogEnded((DIALOGRESOURCE)END_Armoury_Door_7a02faca-ba91-d8da-f747-7dd765dbfacc, _)
AND
DB_GlobalFlag(END_Armoury_Event_CiviliansLeave_82003bc9-3180-e309-71df-1d06f2583b85)
AND
DB_END_Armoury_Civilian(_Character)
THEN
PROC_CharacterMoveTo(_Character, S_END_ArmouryDisappearPos_60817405-fea0-4bc5-9767-2094c64f7a9a, "Run", "END_Armoury_Disappear");

IF
EntityEvent(_Character, "END_Armoury_Disappear")
THEN
PROC_DisappearOutOfSightTo((CHARACTER)_Character, S_END_ArmouryDisappearDirection_24737e1f-48b2-404d-81a4-32137b60e87a, "Run", 1, "");

//END_REGION

//REGION Dialogue with civilians

IF
FlagSet(END_ArmouryDoor_Event_CheckMindflayer_05cfdb21-66ba-49a9-3316-1d855a50ee40, _, _)
AND
DB_InRegion(_Character, S_END_ArmouryDialogArea_c0e00073-f7ff-4e10-a470-81ea034fdf39)
AND
IsTagged(_Character, MINDFLAYER_8ee4d870-3f6b-466c-968f-ab0ba2be6229, 1)
THEN
SetFlag(END_ArmouryDoor_State_MindflayerClose_c206e88e-6f41-4892-ac6f-7d21d4642f53, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogEnded(END_Armoury_Door_7a02faca-ba91-d8da-f747-7dd765dbfacc, _)
AND
DB_GlobalFlag((FLAG)END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b)
THEN
PROC_TriggerUnregisterForParty(S_END_ArmouryArea_46fc22cd-e7f3-4605-be2d-82bd3ce020fc);
PROC_TriggerUnregisterForParty(S_END_ArmouryDialogArea_c0e00073-f7ff-4e10-a470-81ea034fdf39);

PROC
PROC_END_Armoury_StartDoorDialog((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT QRY_StartDialog_Fixed(END_Armoury_Door_7a02faca-ba91-d8da-f747-7dd765dbfacc, S_END_ArmouryCivilian_001_8e88e13a-093a-47a5-9031-12055f1dff0b, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Player)
AND
DB_GlobalFlag(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b)
THEN
PROC_SetRelationToPlayers(ACT3_END_ArmouryCivilians_3777498a-441d-443e-a87f-844b7b3c3868, 0); //This is likely becaues the dialog failed because the spotting failed to start it. If the spotting was activated, the civilians are nervous, so start combat.
PROC_TriggerUnregisterForParty(S_END_ArmouryArea_46fc22cd-e7f3-4605-be2d-82bd3ce020fc);
PROC_TriggerUnregisterForParty(S_END_ArmouryDialogArea_c0e00073-f7ff-4e10-a470-81ea034fdf39);

PROC
PROC_END_Armoury_StartDoorDialog((CHARACTER)_Player)
AND
NOT DB_Players(_Player)
AND
DB_GlobalFlag(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b)
THEN
PROC_SetRelationToPlayers(ACT3_END_ArmouryCivilians_3777498a-441d-443e-a87f-844b7b3c3868, 0);
PROC_TriggerUnregisterForParty(S_END_ArmouryArea_46fc22cd-e7f3-4605-be2d-82bd3ce020fc);
PROC_TriggerUnregisterForParty(S_END_ArmouryDialogArea_c0e00073-f7ff-4e10-a470-81ea034fdf39);

IF
EnteredTrigger(_PartyMember, S_END_ArmouryDialogArea_c0e00073-f7ff-4e10-a470-81ea034fdf39)
AND
NOT DB_Players(_PartyMember)
AND
NOT QRY_END_Armoury_InDialog()
AND
DB_GlobalFlag(END_Armoury_Event_DoorOpens_0126d5ae-6e00-6952-886d-b6a2709aee8b)
THEN
PROC_SetRelationToPlayers(ACT3_END_ArmouryCivilians_3777498a-441d-443e-a87f-844b7b3c3868, 0);
PROC_TriggerUnregisterForParty(S_END_ArmouryArea_46fc22cd-e7f3-4605-be2d-82bd3ce020fc);
PROC_TriggerUnregisterForParty(S_END_ArmouryDialogArea_c0e00073-f7ff-4e10-a470-81ea034fdf39);

QRY
QRY_END_Armoury_InDialog()
AND
DB_END_Armoury_Civilian(_Character)
AND
DB_DialogNPCs(_ID, _Character, _)
AND
DB_DialogName(END_Armoury_Door_7a02faca-ba91-d8da-f747-7dd765dbfacc, _ID)
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)END_Armoury_Door_7a02faca-ba91-d8da-f747-7dd765dbfacc, _ID)
AND
DB_END_Armoury_Civilian(_Character)
AND
_Character != S_END_ArmouryCivilian_001_8e88e13a-093a-47a5-9031-12055f1dff0b //Instigator
THEN
PROC_DialogAddSpeakingActor(_ID, _Character);

IF
FlagSet((FLAG)END_Armoury_Event_Reward_d35f3a6a-dc18-a677-5690-ba0ee5802327, _, _)
THEN
PROC_END_Armoury_ApplyDeathWard();

PROC
PROC_END_Armoury_ApplyDeathWard()
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, S_END_ArmouryDialogArea_c0e00073-f7ff-4e10-a470-81ea034fdf39)
AND
IsTagged(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
THEN
ApplyStatus(_Player, "DEATH_WARD", -1.0);

PROC
PROC_END_Armoury_ApplyDeathWard()
AND
DB_InRegion(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, S_END_ArmouryDialogArea_c0e00073-f7ff-4e10-a470-81ea034fdf39)
AND
IsTagged(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
THEN
ApplyStatus(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, "DEATH_WARD", -1.0);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3c"
