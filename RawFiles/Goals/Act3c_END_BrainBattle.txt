Version 1
SubGoalCombiner SGC_AND
INITSECTION
SetAmbushing(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, 1); //To hide the outline

PROC_TriggerRegisterForParty(S_END_BrainBattleArea_b0cbe773-d02f-4074-8507-eab6033c3b27);

SetDoNotFaceFlag(S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, 1);

DB_END_BrainBattle_DefaultThralls((CHARACTER)S_END_SuperThrall_001_939b84fb-5ea5-43cf-b73c-c1315f60fe3f);
DB_END_BrainBattle_DefaultThralls((CHARACTER)S_END_SuperThrall_002_8eeb8999-4c72-43a4-b7b3-7e6cdc824d36);
DB_END_BrainBattle_DefaultThralls((CHARACTER)S_END_SuperThrall_003_0f9dd1ac-6545-4919-9f2f-5fe1958c3419);
DB_END_BrainBattle_DefaultThralls((CHARACTER)S_END_SuperThrall_004_ba226fbd-7a38-4f9d-8403-8b593a698cd6);

DB_END_BrainBattle_PickedThrall((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_END_BrainBattle_PickedThrall((GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000);

DB_END_BrainBattle_Thralls((TAG)BARBARIAN_02913f9a-f696-40cf-acdf-32032afab32c, QUEST_END_Thrall_Barbarian_0d14b483-983b-49d5-bc54-4cfab8897e37, "END_SUPERTHRALL_BARBARIAN", "EQP_END_Thrall_Barbarian");
DB_END_BrainBattle_Thralls((TAG)BARD_d93434bd-6b71-4789-b128-ee24156057cc, QUEST_END_Thrall_Bard_33d55bca-6c52-479c-b633-e2d10d3afa83, "END_SUPERTHRALL_BARD", "EQP_END_Thrall_Bard");
DB_END_BrainBattle_Thralls((TAG)CLERIC_1671b4bf-4f47-4bb7-9cb9-80bb1f6009d5, QUEST_END_Thrall_Cleric_98184393-7914-45ee-a89c-1c30f6ea1340, "END_SUPERTHRALL_CLERIC", "EQP_END_Thrall_Cleric");
DB_END_BrainBattle_Thralls((TAG)DRUID_44ac4317-4d38-4d28-80e2-94024c6e42f0, QUEST_END_Thrall_Druid_6c6b4487-cdca-45c8-b9b7-a90817a8249f, "END_SUPERTHRALL_DRUID", "EQP_END_Thrall_Druid");
DB_END_BrainBattle_Thralls((TAG)FIGHTER_1ae7017c-4884-4a43-bc4a-742fa0d201c0, QUEST_END_Thrall_Fighter_53a0d484-4647-44cb-9483-af52b72f991c, "END_SUPERTHRALL_FIGHTER", "EQP_END_Thrall_Fighter");
DB_END_BrainBattle_Thralls((TAG)MONK_e1e460bb-d0ae-4452-8529-c9e176558731, QUEST_END_Thrall_Monk_7ccc7bf1-c781-4c0c-ba9b-22948c593aea, "END_SUPERTHRALL_MONK", "EQP_END_Thrall_Monk");
DB_END_BrainBattle_Thralls((TAG)PALADIN_6d85ab2d-5c23-498c-a61e-98f05a00177a, QUEST_END_Thrall_Paladin_244b45f9-2fbd-4384-b822-71070da6f5f0, "END_SUPERTHRALL_PALADIN", "EQP_END_Thrall_Paladin");
DB_END_BrainBattle_Thralls((TAG)RANGER_37a733c1-a862-4157-b92a-9cff46232c6a, QUEST_END_Thrall_Ranger_e225fab6-36b8-4b35-b863-751b9d51ff34, "END_SUPERTHRALL_RANGER", "EQP_END_Thrall_Ranger");
DB_END_BrainBattle_Thralls((TAG)ROGUE_f8a0608b-666c-4be6-a49c-03b369c10bd2, QUEST_END_Thrall_Rogue_f710ea72-6c27-4a52-9919-4a00b2659c17, "END_SUPERTHRALL_ROGUE", "EQP_END_Thrall_Rogue");
DB_END_BrainBattle_Thralls((TAG)SORCERER_18266c0b-efbc-4c80-8784-ada4a37218d7, QUEST_END_Thrall_Sorcerer_a134466e-333b-4bf5-a65b-6a717fdaf044, "END_SUPERTHRALL_SORCERER", "EQP_END_Thrall_Sorcerer");
DB_END_BrainBattle_Thralls((TAG)WARLOCK_5804f55a-93f7-4281-9512-8d548a9e2a22, QUEST_END_Thrall_Warlock_6eab792d-c187-4a0d-86e7-39b0e2e41005, "END_SUPERTHRALL_WARLOCK", "EQP_END_Thrall_Warlock");
DB_END_BrainBattle_Thralls((TAG)WIZARD_6fe3ae27-dc6c-4fc9-9245-710c790c396c, QUEST_END_Thrall_Wizard_ca44eafa-4c35-4103-889d-fd4df47f2835, "END_SUPERTHRALL_WIZARD", "EQP_END_Thrall_Wizard");
DB_END_BrainBattle_Thralls((TAG)NULL_00000000-0000-0000-0000-000000000000, QUEST_END_Thrall_Fallback_ef0ef83b-56af-4203-a984-28a74975adf5, "END_SUPERTHRALL_FALLBACK", "EQP_END_Thrall_Fallback");

DB_END_BrainBattle_PlayerAdversary((CHARACTER)NULL_00000000-0000-0000-0000-000000000000, (GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_END_BrainBattle_PlayerAdversary((CHARACTER)NULL_00000000-0000-0000-0000-000000000000, (GUIDSTRING)NULL_00000000-0000-0000-0000-000000000000);

DB_END_BrainBattle_AdversarySpawnPos((TRIGGER)S_END_ThrallPos_001_ad5c383e-efd1-43fb-b567-a8a1fd786d73);
DB_END_BrainBattle_AdversarySpawnPos(S_END_ThrallPos_002_ea33627c-48e4-474a-a444-139da100dcf5);
DB_END_BrainBattle_AdversarySpawnPos(S_END_ThrallPos_003_a470a34e-cfa1-43e8-9f26-5c17aa4ab56d);
DB_END_BrainBattle_AdversarySpawnPos(S_END_ThrallPos_004_98912a06-b79e-445f-8d77-fb9c0e00c7e0);

DB_END_BrainBattle_BackupDaisies(END_BackupDaisy_001_d8e8b72e-4b21-4442-8e34-0ecab3f499ae);
DB_END_BrainBattle_BackupDaisies(END_BackupDaisy_002_7f8ba670-6749-457e-9aea-8169ab6d7a38);
DB_END_BrainBattle_BackupDaisies(END_BackupDaisy_003_41900801-ad80-4e79-881a-b0f58f14aff4);
DB_END_BrainBattle_BackupDaisies(END_BackupDaisy_004_e7bc792c-09ab-4a42-972e-6798cb5927b5);

DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_007_7cd54f7c-21af-49f1-87cb-97e13f26bf27);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_008_28db1262-a6b9-47cd-af6b-44cb694b17ba);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_009_987dcf83-3ca5-4372-b2d9-fec950c2e5a6);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_010_29edd32f-571c-4d6b-b5f4-3fd36cd8ad77);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_011_ba70658b-84f2-4cc1-bd30-dadb3efd5402);
DB_END_BrainBattle_NautiloidCannons((CHARACTER)S_END_NautiloidCannon_012_717fd538-8263-4a85-9d0f-15b5cf58e99d);

DB_END_BrainBattle_PodSpawnAreas((TRIGGER)S_END_BrainIllithidPodArea_001_e10d68e8-78e1-4eec-9da2-aa7c213a8077);
DB_END_BrainBattle_PodSpawnAreas(S_END_BrainIllithidPodArea_004_1629e3f9-f3a9-4d65-8d75-9f3e09fcca7d);
DB_END_BrainBattle_PodSpawnAreas(S_END_BrainIllithidPodArea_003_db99f8be-025c-471d-be3d-560b93b514fa);
DB_END_BrainBattle_PodSpawnAreas(S_END_BrainIllithidPodArea_002_02ac5351-a37c-4b7d-aaec-4588ec54bc73);
DB_END_BrainBattle_PodSpawnAreas(S_END_BrainIllithidPodArea_005_c75a19cc-50d8-4709-b0a7-4302dadd24d0);
DB_END_BrainBattle_PodSpawnAreas(S_END_BrainIllithidPodArea_006_4731dedf-7f7e-4f99-86d1-aa4d67d05b36);
DB_END_BrainBattle_PodSpawnAreas(S_END_BrainIllithidPodArea_007_7c69737a-9082-4bf8-9796-c4270b67e709);
DB_END_BrainBattle_PodSpawnAreas(S_END_BrainIllithidPodArea_008_037c975c-d695-4da1-a26f-c7e12e45d28a);

DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_001_a7387630-f935-4c0b-80da-d21628d6e9c7, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_002_8042c385-b8d0-42e5-ab0f-ea9d7bf6f941, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_003_ed77f41a-054c-453d-8d3f-415ee5872f33, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_004_772c253f-2b1d-4426-abd2-d64f5357f7fd, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_005_c050677a-a5ec-4f81-87d1-39d8ab9cd13a, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_006_6f87e6c7-601d-4ea5-a538-c629150baec6, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_007_6697977c-7084-4c2d-be45-927b16aabc43, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_008_fcd9edcf-8bc0-4543-b34e-cc161a5e2e55, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_009_376274e3-7f5f-40ec-af37-cfc279a5c42d, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_010_ad59d016-69e8-46d8-9e22-ab747f9dc10a, 0);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_011_39cc27b0-1352-4577-b33b-61a5df044f28, 1);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_012_8ac94e11-be6c-4e9a-996b-94a627f54a97, 1);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_013_6176cb82-2cac-4a03-83ae-efe2c596587c, 1);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_014_a05455d4-44ce-477f-a554-83e73f6f5d31, 1);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_015_9d75bccc-543c-429c-960c-b2699666a3e0, 1);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_016_37a583f6-9724-4457-8944-1b262b716d24, 1);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_017_a3170e52-a501-4cfc-a11c-f10f217934d9, 1);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_018_eb68c6ed-ad2d-4885-acae-e29d0807dd2c, 1);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_019_955b71b1-029a-422d-bada-c0da28dadaa9, 2);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_020_a1c64fb1-5d7b-40c1-871e-2872264b2212, 2);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_021_cd20691f-2599-47ea-a297-b99aefbcc32c, 2);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_022_115d6400-f70b-4f78-8027-b9bf5f22c397, 2);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_023_f5579e3f-cf2a-40b2-af80-84ee228e6fb5, 2);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_024_8ff5b92b-cfc7-43a4-92d6-ec188b5026d4, 2);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_025_3cdedc48-12d5-4c5c-a610-01f2b4877043, 2);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_026_7ca5c0fe-633c-4c86-a4a8-b2b36f8c0e9f, 2);
DB_END_BrainBattle_NautiloidStrikeSets((TRIGGER)S_END_NautiloidStrikePos_027_a7dcc088-30ec-4883-8a45-29d0d4d76612, 2);

DB_END_BrainBattle_Enemies(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a);
DB_END_BrainBattle_Enemies((CHARACTER)S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e);
DB_END_BrainBattle_Enemies((CHARACTER)S_END_BrainBattle_MindFlayer_001_70ef4f3f-c8bf-4b07-b473-8043699a6d5c);
DB_END_BrainBattle_Enemies((CHARACTER)S_END_BrainBattle_MindFlayer_002_e5f0fcdf-8a9e-426a-96db-254f94898172);
DB_END_BrainBattle_Enemies((CHARACTER)S_END_BrainBattle_MindFlayer_003_3868c215-f34f-4dfb-9c8a-1b06f2d5644d);
DB_END_BrainBattle_Enemies((CHARACTER)S_END_BrainBattle_MindFlayer_004_c42ee756-319a-4ebd-b547-dceda6ef606d);


DB_END_BrainBattle_Enemies_MindFlayerArcanists((CHARACTER)S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e);
DB_END_BrainBattle_Enemies_MindFlayerArcanists((CHARACTER)S_END_BrainBattle_MindFlayer_001_70ef4f3f-c8bf-4b07-b473-8043699a6d5c);
DB_END_BrainBattle_Enemies_MindFlayerArcanists((CHARACTER)S_END_BrainBattle_MindFlayer_002_e5f0fcdf-8a9e-426a-96db-254f94898172);
DB_END_BrainBattle_Enemies_MindFlayerArcanists((CHARACTER)S_END_BrainBattle_MindFlayer_003_3868c215-f34f-4dfb-9c8a-1b06f2d5644d);
DB_END_BrainBattle_Enemies_MindFlayerArcanists((CHARACTER)S_END_BrainBattle_MindFlayer_004_c42ee756-319a-4ebd-b547-dceda6ef606d);

DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_001_6efe022f-8578-4710-a50d-fd1bd59904fc, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_001_3d70755e-035b-4f2a-bc60-df8ff4c5fff9);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_002_29294081-6990-453c-b667-7ed7f8ad2a27, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_002_b0df723e-1758-4621-b28f-b6af3d79007c);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_003_7e3e5fea-dd9f-432a-ab12-092e1e0f18c1, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_003_8d4db7f5-c5fd-405a-a05e-111ea2a6c8d2);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_004_1b121796-39dd-49b6-931d-a034d21b1963, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_004_d392ad42-d78d-4dcf-841d-466df13c8f4f);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_005_26139602-6b60-4844-9cad-f9188c1c9394, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_005_7189f249-d54e-4e1b-b1fe-da0a423c84b8);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_006_a84fb30e-c652-4c1b-9b43-2acf4b9d7e90, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_006_623324bf-f7ec-4325-b5b6-86a30907d533);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_007_977b8b8e-7541-4f27-949b-211f2417a45d, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_007_eae82dde-428a-41ff-84d6-4c12b1d4c2cd);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_008_7c5e5bcf-82ff-45e7-b3ae-6fee00e53457, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_008_f02eb8cf-3f1a-4e21-bd54-e4922b72184a);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_009_b7f6e355-50b5-444e-a11f-9ea0e672e6af, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_009_60e842f8-10ac-45ae-be74-6482b2c0f8db);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_010_b7df06f5-2c51-4b05-ad84-8737f7227d01, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_010_4b1948ec-5587-490e-85a9-efcd89ce17cf);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_011_6641a54c-176b-4c76-9a37-ad2dc1b4d02d, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_011_470db11e-6a0d-4ed2-8fff-4540e4d9381b);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_012_b685cbcf-c9c4-4f4c-9370-436f9b1ff4bd, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_012_a6683393-02e8-45d0-95d1-39c184c147bd);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_013_6edfc979-6257-43cc-8f46-326b95cfccc7, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_013_6102c4a6-0abf-4d3b-bca4-2e2381ddec16);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_014_6476da1f-9391-4260-9bbb-3df448cea360, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_014_3d6670fd-1731-49d3-94de-2095dc7866ec);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_015_6630a992-1e9a-4b70-b8b6-25043efe3753, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_015_fae393ab-4926-4833-a636-a40d9b5c126c);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_016_59c22551-acff-4426-8232-99cf7059758a, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_016_6571d0fb-78f8-42f7-b42b-f27833526aee);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_017_0e7e534f-5b19-481c-acc4-dd815e6de4d6, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_017_85dc8997-0133-4ba9-aeb6-097491c2572c);
DB_END_BrainBattle_BrainTentacles((CHARACTER)S_END_BrainBattle_Tentacle_018_55916542-5572-4edf-b454-52da27c1a4be, (TRIGGER)S_END_BrainBattle_TentacleSpawnTrigger_018_387242b6-c101-4df5-8e48-46f73103750c);

DB_Combat_Dragon_ProxyOwner((CHARACTER)S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, "END_RedDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_END_Dragon_Proxy_LegFrontLeft_0326bf71-261b-413b-a0ac-1ad457306e84, "END_RedDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_END_Dragon_Proxy_LegFrontRight_0ddd897c-6aa1-454b-936f-97681ff13382, "END_RedDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_END_Dragon_Proxy_LegBackLeft_748b540f-7ca8-4f69-a62d-efd8daf4115b, "END_RedDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_END_Dragon_Proxy_LegBackRight_b52f7339-4084-43c4-820f-4ee16ee06552, "END_RedDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_END_Dragon_Proxy_Tail_78a27d89-9867-481f-9e88-a1ff60af6f35, "END_RedDragon");
DB_Combat_Dragon_HitProxies((CHARACTER)S_END_Dragon_Proxy_Head_e3bedcb1-b99d-42e7-9134-06614d7392ee, "END_RedDragon");
PROC_Combat_Dragon_ProxySetup("END_RedDragon");

//SetOnStage(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, 0);
SetForceUpdate(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, 1);

AiAddInterestingItem(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, S_END_DragonJumpPoint_001_fe54e1d3-1533-4f63-9411-d862f170d2c1);
AiAddInterestingItem(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, S_END_DragonJumpPoint_002_de457ae1-3b79-4777-a095-462ae973e4bb);
AiAddInterestingItem(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, S_END_DragonJumpPoint_003_a0343314-3ebc-4a17-8a1c-454a50ccb5f4);
AiAddInterestingItem(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, S_END_DragonJumpPoint_004_04c5bb9a-f723-4505-a3b0-388510030cd3);
AiAddInterestingItem(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, S_END_DragonJumpPoint_005_d1142771-b6a5-4899-825f-766f7f188cae);
AiAddInterestingItem(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, S_END_DragonJumpPoint_006_ac57bb63-f294-4418-b3cf-982eb11877e8);

SetForceUpdate(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, 1);
SetForceUpdate(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, 1);
SetForceUpdate(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, 1);
SetForceUpdate(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, 1);

DB_END_BrainBattle_CrownTurn(0);
DB_END_BrainBattle_NautiloidTurn(0);

DB_END_BrainBattle_TeleportPositions((TRIGGER)S_END_BrainBattlePartyPos_001_96fdb9c4-13c4-42b6-9e12-0644c8f2850d, 1);
DB_END_BrainBattle_TeleportPositions((TRIGGER)S_END_BrainBattlePartyPos_002_5eb45058-b1d0-410d-aa16-f42aff1c7ffa, 2);
DB_END_BrainBattle_TeleportPositions((TRIGGER)S_END_BrainBattlePartyPos_003_9454a614-281f-42f3-a14a-ef12c1b80e3c, 3);
DB_END_BrainBattle_TeleportPositions((TRIGGER)S_END_BrainBattlePartyPos_004_54ec11ee-a6e5-4240-a524-1c94a77ac6b4, 4);
DB_END_BrainBattle_TeleportPositions((TRIGGER)S_END_BrainBattlePartyPos_005_f8af2bc0-0ef8-4ed3-8c09-cf0d9aaa5571, 5);
DB_END_BrainBattle_TeleportPositions((TRIGGER)S_END_BrainBattlePartyPos_006_af2e76fe-14de-4415-bf21-d12ac50395a7, 6);
DB_END_BrainBattle_TeleportPositions((TRIGGER)S_END_BrainBattlePartyPos_007_6328c0bd-49d3-43fe-bcc8-360f3eef86fc, 7);
DB_END_BrainBattle_TeleportPositions((TRIGGER)S_END_BrainBattlePartyPos_008_6cf3e324-81b0-404f-b1e6-d35ed0787fdd, 8);

DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_8f6b2b6a-3c4c-45e9-8069-d728ecca47f0, (ITEM)398bc36d-2ced-8a8b-4912-2c9cbda4da37);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_002_986baa02-1776-4000-b122-077a8bd0aca8, (ITEM)8e2f3234-191d-8e82-5165-42ac324dca32);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_003_c2cc1c7b-0427-45b2-802b-0bf8e81551dd, (ITEM)2da5a0c4-62ca-88f2-3f60-20d38121806f);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_004_d3fbd6ac-ca83-4c95-b192-190288f1e876, (ITEM)8bddcb2c-99a1-870b-30b0-2cca1722e3ef);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_005_1d646bd7-57a6-43a0-b660-6886f6bc02ef, (ITEM)8b039516-e8c5-8b2b-3870-56825dc9c8d9);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_006_3654bde7-f4bc-41d5-8c6b-f608543823ef, (ITEM)08d3956e-25cd-8c80-52a3-a468c4253b2f);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_007_5ce783db-f68b-4ef2-bd82-a0cdbe754813, (ITEM)b9296fb4-6be8-8f9b-1b2c-b028b13b2236);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_008_d122d9a9-0afd-4143-aec4-e9f1596f3fd8, (ITEM)cb8d4098-98ad-8054-2625-846d16835521);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_009_70b6cdc3-74ff-4c34-9f4b-b47f7371e065, (ITEM)b9296fb4-6be8-8f9b-1b2c-b028b13b2236);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_010_773048fe-8287-4603-9900-f98f7cc56d8f, (ITEM)b766d97e-bfa2-89c4-5df1-5c7280aad288);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_011_92e8d529-5821-423d-b150-7fa167dc906e, (ITEM)2d4c079b-82c4-84a5-3747-a5e9c15cfeed);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_012_70cb6db5-850b-4bde-a7dc-e6a74908036f, (ITEM)2d4c079b-82c4-84a5-3747-a5e9c15cfeed);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_013_a1996ecd-a174-40d0-810a-71b107491894, (ITEM)e9298a75-1d23-8e5b-2404-d6bbe3216776);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_014_bd6d7621-ebbf-40ff-8696-b531442d11a6, (ITEM)203647d9-4dd0-87a4-4c7e-e380e3cfd12e);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_015_be42e122-5d83-4af4-b9e8-40d0ba48a2f1, (ITEM)4a72420d-a1e8-40c9-b6d7-c5ea2b561a92);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_016_eae65893-b18e-461f-a445-3b306b500e64, (ITEM)e1860db2-d36d-4d2d-978d-f9fc8882fd48);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_017_54c6481d-2e60-42d5-b3f2-4759ce628a8f, (ITEM)a736e58a-b589-456e-83c0-8cd34eedf3bf);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_018_9e8d8851-de3e-4c46-9d56-f0231fd196df, (ITEM)283c9461-40a3-4420-944f-635e83b9aa49);
DB_END_BrainBattle_MindSpawnPoints((TRIGGER)S_END_MindPartyPos_019_c3d1e9b7-ddcc-4d11-9bd6-f1c399869c86, (ITEM)6d2fac3b-266d-46e1-8136-a0edc6e61c99);
SetOnStage(S_END_MindPortal_06463ecc-d906-4c7c-b4e0-41e69abccc36, 0);

TriggerRegisterForItems((TRIGGER)S_END_NetherbrainArena_001_SUB_a79f975d-d33a-455b-a444-9a0d08f59c57);

PROC_TriggerRegisterForPlayers(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad);

SetImmortal(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, 1);

PROC_CharacterDisableAllCrimes((CHARACTER)S_END_Netherbrain_HitboxProxy_001_49e7f225-6fa9-4f86-b03b-b8282a2bba20);
PROC_SelfHealing_Disable((CHARACTER)S_END_Netherbrain_HitboxProxy_001_49e7f225-6fa9-4f86-b03b-b8282a2bba20);
PROC_CharacterDisableAllCrimes((CHARACTER)S_END_Netherbrain_HitboxProxy_002_238679d4-f051-4b4f-bd50-5809c9e5893a);
PROC_SelfHealing_Disable((CHARACTER)S_END_Netherbrain_HitboxProxy_002_238679d4-f051-4b4f-bd50-5809c9e5893a);
PROC_CharacterDisableAllCrimes((CHARACTER)S_END_Netherbrain_HitboxProxy_003_37f2b1cc-992c-4298-aaf3-84e8b6c6fe0a);
PROC_SelfHealing_Disable((CHARACTER)S_END_Netherbrain_HitboxProxy_003_37f2b1cc-992c-4298-aaf3-84e8b6c6fe0a);


PROC_CharacterDisableAllCrimes((CHARACTER)S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1);
PROC_CharacterDisableAllCrimes((CHARACTER)S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759);

DB_END_BrainBattle_DaisySpells("Target_END_Daisy_Command_Drop", (FLAG)END_BrainBattle_Event_DaisyDrop_69d918c4-36e6-f262-4ec6-20c650be8593);
DB_END_BrainBattle_DaisySpells("Target_END_Daisy_Command_Grovel", (FLAG)END_BrainBattle_Event_DaisyGrovel_2857a9b0-46d5-69fe-656e-e4ba70322d72);
DB_END_BrainBattle_DaisySpells("Target_END_Daisy_Command_Flee", (FLAG)END_BrainBattle_Event_DaisyFlee_1f46d45e-bfd8-62e4-32ed-16ae60b0c88b);
DB_END_BrainBattle_DaisySpells("Target_END_Daisy_Command_Halt", (FLAG)END_BrainBattle_Event_DaisyHalt_f97b003f-9382-9625-7ebc-cd260dfefcad);
DB_END_BrainBattle_DaisySpells("Target_END_Daisy_Command_Hush", (FLAG)END_BrainBattle_Event_DaisyHush_aa60650c-4f5f-5db3-4f07-3a3331b905bd);

DB_END_MindBattle_Platforms((ITEM)2da5a0c4-62ca-88f2-3f60-20d38121806f);
DB_END_MindBattle_Platforms(398bc36d-2ced-8a8b-4912-2c9cbda4da37);
DB_END_MindBattle_Platforms(8bddcb2c-99a1-870b-30b0-2cca1722e3ef);
DB_END_MindBattle_Platforms(b9296fb4-6be8-8f9b-1b2c-b028b13b2236);
DB_END_MindBattle_Platforms(08d3956e-25cd-8c80-52a3-a468c4253b2f);
DB_END_MindBattle_Platforms(b766d97e-bfa2-89c4-5df1-5c7280aad288);
DB_END_MindBattle_Platforms(8e2f3234-191d-8e82-5165-42ac324dca32);
DB_END_MindBattle_Platforms(8b039516-e8c5-8b2b-3870-56825dc9c8d9);
DB_END_MindBattle_Platforms(2d4c079b-82c4-84a5-3747-a5e9c15cfeed);
DB_END_MindBattle_Platforms(203647d9-4dd0-87a4-4c7e-e380e3cfd12e);
DB_END_MindBattle_Platforms(e9298a75-1d23-8e5b-2404-d6bbe3216776);
DB_END_MindBattle_Platforms(cb8d4098-98ad-8054-2625-846d16835521);
DB_END_MindBattle_Platforms(4a72420d-a1e8-40c9-b6d7-c5ea2b561a92);
DB_END_MindBattle_Platforms(e1860db2-d36d-4d2d-978d-f9fc8882fd48);
DB_END_MindBattle_Platforms(a736e58a-b589-456e-83c0-8cd34eedf3bf);
DB_END_MindBattle_Platforms(283c9461-40a3-4420-944f-635e83b9aa49);
DB_END_MindBattle_Platforms(6d2fac3b-266d-46e1-8136-a0edc6e61c99);

DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_000_235d2cbe-9f87-4fea-b0de-7d1b49e79039);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_001_0c6b267f-1b78-411b-83cc-a04f49877bb0);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_002_9705e055-5666-46aa-afe0-7b8a37b959f3);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_003_1fe3dc3a-f4b3-49ac-96db-3c5d044e067d);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_004_40da66bd-2607-4ea8-a242-202e8cf2b623);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_005_7c843326-37b9-4e79-99a5-d80019cef9d1);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_006_3bcf0280-fcb4-4556-8a38-b3a90b2e345b);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_007_118525e0-1d8e-4e28-a927-43a6520a8934);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_008_537f81be-48bb-49ab-9ae2-bd50738db812);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_009_1649e4cd-3e8e-4b8f-ae8f-86781e4f007d);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_010_4b2e814c-3e3b-4645-a552-19c59d0bf89e);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_011_cceb2de3-4bef-4c23-aa56-de45c3beb388);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_012_dee05715-0d67-4ce9-90a0-e6d496a0c827);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_013_240f27d5-bd31-4499-95df-6ed38943f0fa);
DB_END_MindBattle_OrbHelpers((ITEM)S_END_MindArena_OrbHelper_014_00c0bb6a-aaed-4a0f-8825-42c5a227e581);

DB_END_MindBattle_Ladders((ITEM)S_END_MindLadder_001_38cb1dba-cd25-4b44-b421-84f0e9d5bb8a, (ITEM)e9298a75-1d23-8e5b-2404-d6bbe3216776);
DB_END_MindBattle_Ladders(S_END_MindLadder_001_38cb1dba-cd25-4b44-b421-84f0e9d5bb8a, 0723ac48-1021-8448-2d37-17ecf6424f3d);
DB_END_MindBattle_Ladders(S_END_MindLadder_002_f69bbfe2-f4bf-4eba-8977-96d514c0bf13, 2d4c079b-82c4-84a5-3747-a5e9c15cfeed);
DB_END_MindBattle_Ladders(S_END_MindLadder_002_f69bbfe2-f4bf-4eba-8977-96d514c0bf13, 7bbbbc39-9ef4-85db-5de4-490ba2eaf0ec);
DB_END_MindBattle_Ladders(S_END_MindLadder_003_4cfd0bd9-a5ba-4535-bffa-54ea32534737, 2d4c079b-82c4-84a5-3747-a5e9c15cfeed);
DB_END_MindBattle_Ladders(S_END_MindLadder_003_4cfd0bd9-a5ba-4535-bffa-54ea32534737, 8b039516-e8c5-8b2b-3870-56825dc9c8d9);
DB_END_MindBattle_Ladders(S_END_MindLadder_005_4809f0b5-ba1d-4204-9db9-967640840cad, e9298a75-1d23-8e5b-2404-d6bbe3216776);
DB_END_MindBattle_Ladders(S_END_MindLadder_005_4809f0b5-ba1d-4204-9db9-967640840cad, b9296fb4-6be8-8f9b-1b2c-b028b13b2236);
DB_END_MindBattle_Ladders(S_END_MindLadder_006_919c4241-b896-4c5e-9432-039f1c60f8ee, 08d3956e-25cd-8c80-52a3-a468c4253b2f);
DB_END_MindBattle_Ladders(S_END_MindLadder_006_919c4241-b896-4c5e-9432-039f1c60f8ee, 398bc36d-2ced-8a8b-4912-2c9cbda4da37);

DB_END_MindBattle_Chains("END_CHAINSOFKARSUS_CHAINS_VFX_2", 2);
DB_END_MindBattle_Chains("END_CHAINSOFKARSUS_CHAINS_VFX_4", 3);
DB_END_MindBattle_Chains("END_CHAINSOFKARSUS_CHAINS_VFX_1", 4);
DB_END_MindBattle_Chains("END_CHAINSOFKARSUS_CHAINS_VFX_3", 5);
PROC_DeclareCounter("END_BrainBattle_ChainCounter");

NOT DB_END_BrainBattle_QueuedRestoreCharacters((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

DB_DialogDeath(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759);
DB_DialogStarted_IgnoreStopConditions(END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd);

DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_ACID", "Acid");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_BLUDGEONING", "Bludgeoning");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_COLD", "Cold");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_FIRE", "Fire");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_FORCE", "Force");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_LIGHTNING", "Lightning");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_NECROTIC", "Necrotic");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_PIERCING", "Piercing");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_POISON", "Poison");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_PSYCHIC", "Psychic");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_RADIANT", "Radiant");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_SLASHING", "Slashing");
DB_END_BrainBattle_ImmunityStatuses("ABSOLUTE_AEGIS_THUNDER", "Thunder");

//REGION Evil Endings

DB_END_BrainBattle_EvilEndingFlag((FLAG)END_FinalDecision_Event_QueueEvilAvatar_982afed6-1f17-57a6-dc65-aaf5eb1685d9, (DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilAvatar_e0069683-63a6-f619-cf62-5dc4105a11ba);
DB_END_BrainBattle_EvilEndingFlag((FLAG)END_FinalDecision_Event_QueueEvilDU_aa66f591-0de6-dabb-059b-bc4fc04df2bd, (DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilDurge_dee4fb08-6170-7221-fb87-51733bbd7220);
DB_END_BrainBattle_EvilEndingFlag((FLAG)END_FinalDecision_Event_QueueEvilEmperor_f4b9c398-2f07-e21a-e7fc-e569f844211b, (DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilEmperor_b5525d0a-e217-9ed9-bc06-e98e2ce1b362);

//END_REGION
KBSECTION
//REGION Debug

IF
TextEvent("startmindtimer")
THEN
TurnBasedTimerLaunch(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, "END_MindCountdown", "END_MindCountdown_Timer", 24000);

IF
TextEvent("mindbraindies")
THEN
Die(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1);

IF
TextEvent("mindbattle")
AND
GetHostCharacter(_Character)
THEN
ApplyStatus(_Character, "MIND_FLAYER_FORM", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_GlobalSetFlagAndCache(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd);
PROC_TeleportPartiesTo(S_END_MindPortal_06463ecc-d906-4c7c-b4e0-41e69abccc36, "");
PROC_END_BrainBattle_DominationUsed(_Character);
PROC_SetRelationToPlayers(ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, 0);
DB_END_DEBUG_BrainBattle_MindBattleCombatJoin(1);

IF
TextEvent("testbraindeath")
THEN
PlayEffect(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, VFX_Combat_Death_Mind_Lifetime_01_071ec218-0a26-3f5a-a5b4-975eb11a82d8, "Dummy_BodyFX", 1.0);

IF
TextEvent("testcrownburst")
THEN
PROC_LoopEffect(VFX_Script_Brainquake_NoOffset_01_0d5c292e-0eca-5117-bdc5-75a56b1e5eb7, S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_BrainBattle_DominationReaction", "END_Main", "", 0.2);
ObjectTimerLaunch(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_BrainBattle_DominationReaction", 5000);

IF
TextEvent("END_BrainBattle_CINE_NautiloidFires")
AND
DB_PartyMembers(_PartyMember)
THEN
SendArenaCameraEvent(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, _PartyMember, "END_BrainBattle_CINE_NautiloidFires");

PROC
PROC_END_BrainBattle_EnterMind((CHARACTER)_DominationCharacter)
AND
DB_END_DEBUG_BrainBattle_MindBattleCombatJoin(1)
AND
NOT DB_END_BrainBattle_Start(1)
THEN
SetCombatGroupID(_DominationCharacter, "END_BrainBattle");
DB_END_BrainBattle_Start(1);

IF
DB_END_DEBUG_BrainBattle_MindBattleCombatJoin(1)
AND
DB_END_BrainBattle_Start(1)
AND
DB_PartyMembers(_PartyMember)
THEN
SetCombatGroupID(_PartyMember, "END_BrainBattle");
PROC_END_BrainBattle_TryEnterCombat(_PartyMember);

IF
TextEvent("brainbattle")
THEN
PROC_END_BrainBattle_DebugAddEmperor();

PROC
PROC_END_BrainBattle_DebugAddEmperor()
AND
GetHostCharacter(_Player)
THEN
DB_END_DEBUG_BrainBattle_EmperorJoiningParty(1);
SetFlag(END_IllithidOptions_State_GaveStones_18e3be1a-c1c0-437e-ad0a-a1426d8830f4);
SetFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961);
PROC_DEBUG_END_IllithidOptionsFollower_Follow(_Player, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

IF
CharacterJoinedParty(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
AND
DB_END_DEBUG_BrainBattle_EmperorJoiningParty(1)
AND
GetHostCharacter(_Player)
THEN
NOT DB_END_DEBUG_BrainBattle_EmperorJoiningParty(1);
DebugText(_Player, "Possiblity of breaking Illithid Options Situations!");
PROC_END_BrainBattle_TeleportParty(1);
DB_END_HighHallInterior_ToRoofReadyCheckPlayer(_Player);
PROC_END_BrainBattle_PreSetup();

IF
TextEvent("brainbattlenoemperor")
AND
GetHostCharacter(_Player)
THEN
ApplyStatus(_Player, "MIND_FLAYER_FORM", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_GlobalSetFlagAndCache(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd);
DB_END_HighHallInterior_ToRoofReadyCheckPlayer(_Player);
PROC_END_BrainBattle_PreSetup();

IF
TextEvent("nautiloidon")
THEN
ApplyStatus(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, "END_NAUTILOID_SPAWN_VFX", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
TextEvent("nautiloidoff")
THEN
TeleportTo(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, S_END_DebugTentacle_998e2725-5022-43fd-87f7-2f64be3718f4, "");
RemoveStatus(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, "END_NAUTILOID_SPAWN_VFX", NULL_00000000-0000-0000-0000-000000000000);
SetForceUpdate(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, 0);
//END_REGION

//REGION Setup

IF
DB_END_BrainBattle_NautiloidCannons(_Cannon)
THEN
SetOnStage(_Cannon, 0);

IF
DB_END_BrainBattle_DefaultThralls(_Character)
THEN
DB_NOOP(1);

//PROC_END_BrainBattle_PreSetup() is fired form Act3c_END_UpperHighHall

PROC
PROC_END_BrainBattle_Setup()
AND
DB_PartyMembers(_PartyMember)
THEN
LeaveCombat(_PartyMember);

PROC
PROC_END_BrainBattle_Setup()
THEN
DB_END_BrainBattle_RapidMindMeld(1);
DB_END_MorphicPool_RapidMindMeldADHelper((ITEM)S_END_RapidMindMeldHelper_007_47c212eb-1cfb-4e2b-803f-03aa65e0a178, (DIALOGRESOURCE)END_BrainBattle_AD_RapidMindMeld_001_dc1a70c8-dcd2-94ba-835e-90b27b9de561);
DB_END_MorphicPool_RapidMindMeldADHelper((ITEM)S_END_RapidMindMeldHelper_008_fc7f9f4a-8216-4ef7-b9b4-4e4e214cefe5, (DIALOGRESOURCE)END_BrainBattle_AD_RapidMindMeld_002_d6be2dde-cea3-31ad-ca47-408f470cc94c);
DB_END_MorphicPool_RapidMindMeldADHelper((ITEM)S_END_RapidMindMeldHelper_009_1a6afb45-5adc-43ce-961b-93d0a8e3475e, (DIALOGRESOURCE)END_BrainBattle_AD_RapidMindMeld_003_ba5b84be-4290-009b-cd6f-a8d0337a129e);
DB_END_MorphicPool_RapidMindMeldADHelper((ITEM)S_END_RapidMindMeldHelper_010_d0169cf1-1aa2-40a2-81e9-ab6d0ea133ca, (DIALOGRESOURCE)END_BrainBattle_AD_RapidMindMeld_004_fe055f67-495a-37a1-2f6f-783c4317197f);
DB_END_MorphicPool_RapidMindMeldADHelper((ITEM)S_END_RapidMindMeldHelper_011_c6d06422-0376-4f3a-ba67-58b36f91468d, (DIALOGRESOURCE)END_BrainBattle_AD_RapidMindMeld_005_b31c34f4-706a-ebc9-c203-e426d402870e);
DB_END_MorphicPool_RapidMindMeldADHelper((ITEM)S_END_RapidMindMeldHelper_012_82242af5-2273-4804-9d97-975eeb1d9ec4, (DIALOGRESOURCE)END_BrainBattle_AD_RapidMindMeld_006_513e4249-d926-2199-6f55-3ec78a07a9b9);
DB_END_MorphicPool_RapidMindMeldADHelper((ITEM)S_END_RapidMindMeldHelper_013_3cb8ce5c-1fac-4426-bf23-a7889d020cc8, (DIALOGRESOURCE)END_BrainBattle_AD_RapidMindMeld_007_9197e648-79ee-6908-fadd-641848586566);
DB_END_MorphicPool_RapidMindMeldADHelper((ITEM)S_END_RapidMindMeldHelper_014_7d620a11-1fd8-4a02-b0fb-524da0658f36, (DIALOGRESOURCE)END_BrainBattle_AD_RapidMindMeld_008_63b6d9ea-37f2-3886-f704-5a5f4df826b0);


//REGION Select player class to use for super thralls
PROC
PROC_END_BrainBattle_PreSetup()
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
DB_Players(_Player)
AND
DB_ClassTags(_Class)
AND
IsTagged(_Player, _Class, 1)
THEN
DB_END_BrainBattle_PlayerClasses(_Player, _Class);

//Character had no class (because of mods)
PROC
PROC_END_BrainBattle_PreSetup()
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
DB_Players(_Player)
AND
IsTagged(_Player, BARBARIAN_02913f9a-f696-40cf-acdf-32032afab32c, 0)
AND
IsTagged(_Player, BARD_d93434bd-6b71-4789-b128-ee24156057cc, 0)
AND
IsTagged(_Player, CLERIC_1671b4bf-4f47-4bb7-9cb9-80bb1f6009d5, 0)
AND
IsTagged(_Player, DRUID_44ac4317-4d38-4d28-80e2-94024c6e42f0, 0)
AND
IsTagged(_Player, FIGHTER_1ae7017c-4884-4a43-bc4a-742fa0d201c0, 0)
AND
IsTagged(_Player, MONK_e1e460bb-d0ae-4452-8529-c9e176558731, 0)
AND
IsTagged(_Player, PALADIN_6d85ab2d-5c23-498c-a61e-98f05a00177a, 0)
AND
IsTagged(_Player, RANGER_37a733c1-a862-4157-b92a-9cff46232c6a, 0)
AND
IsTagged(_Player, ROGUE_f8a0608b-666c-4be6-a49c-03b369c10bd2, 0)
AND
IsTagged(_Player, SORCERER_18266c0b-efbc-4c80-8784-ada4a37218d7, 0)
AND
IsTagged(_Player, WARLOCK_5804f55a-93f7-4281-9512-8d548a9e2a22, 0)
AND
IsTagged(_Player, WIZARD_6fe3ae27-dc6c-4fc9-9245-710c790c396c, 0)
THEN
PROC_END_BrainBattle_ClearCustomPlayerClasses(_Player);

PROC
PROC_END_BrainBattle_ClearCustomPlayerClasses((CHARACTER)_Player)
AND
DB_END_BrainBattle_PlayerClasses(_Player, _Class)
THEN
NOT DB_END_BrainBattle_PlayerClasses(_Player, _Class);

PROC
PROC_END_BrainBattle_ClearCustomPlayerClasses((CHARACTER)_Player)
THEN
DB_END_BrainBattle_PlayerClasses(_Player, NULL_00000000-0000-0000-0000-000000000000);


//For Cases of Multiclass, we pick a random class from the class tags a character has
PROC
PROC_END_BrainBattle_PreSetup()
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
DB_Players(_Player)
AND
DB_END_BrainBattle_PlayerClasses(_,_)
AND
QRY_GetRandom("DB_END_BrainBattle_PlayerClasses",2,"DB_END_BrainBattle_RandomPlayerSelectedClass")
AND
DB_END_BrainBattle_RandomPlayerSelectedClass((CHARACTER)_RandomPlayer,(TAG)_RandomClass)
AND
NOT DB_END_BrainBattle_PlayerSelectedClass((CHARACTER)_RandomPlayer, _)
THEN
NOT DB_END_BrainBattle_RandomPlayerSelectedClass((CHARACTER)_RandomPlayer,(TAG)_RandomClass);
DB_END_BrainBattle_PlayerSelectedClass((CHARACTER)_RandomPlayer,(TAG)_RandomClass);
PROC_END_BrainBattle_PlayerSelectedClass_ClearOtherClasses(_RandomPlayer);

//only allow a player yo go through this once
PROC
PROC_END_BrainBattle_PlayerSelectedClass_ClearOtherClasses((CHARACTER)_Player)
AND
DB_END_BrainBattle_PlayerClasses(_Player,_Class)
THEN
NOT DB_END_BrainBattle_PlayerClasses(_Player,_Class);

//Setup one super thrall per player when Emperor is allied.
PROC
PROC_END_BrainBattle_PreSetup()
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
DB_END_BrainBattle_PlayerSelectedClass((CHARACTER)_Player,(TAG)_Class)
AND
DB_END_BrainBattle_Thralls(_Class, _ThrallTemplate, _PolymorphStatus, _EquipmentSet)
AND
DB_END_BrainBattle_AdversarySpawnPos(_Position)
AND
NOT DB_END_BrainBattle_PlayerAdversary(_Player, _)
AND
SysFactAtIndex("DB_END_BrainBattle_DefaultThralls", 1, 1, "DB_END_BrainBattle_PickedThrall")
AND
DB_END_BrainBattle_PickedThrall(_Thrall)
AND
CreateAtObject(_ThrallTemplate,_Position,0,0,"END_BrainBattle_Setup_ThrallSpawned",1,_SpawnedThrall)
THEN
NOT DB_END_BrainBattle_PickedThrall(_Thrall);
NOT DB_END_BrainBattle_DefaultThralls((CHARACTER)_Thrall);
Transform((CHARACTER)_SpawnedThrall,_Thrall, Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
DB_END_BrainBattle_Enemies(_SpawnedThrall);
NOT DB_END_BrainBattle_AdversarySpawnPos(_Position);
DB_END_BrainBattle_PlayerAdversary(_Player, _SpawnedThrall);
AddPreferredAiTargetTag((CHARACTER)_SpawnedThrall, (TAG)_Class);
DB_END_BrainBattle_ExtraSpeakerThrall((CHARACTER)_SpawnedThrall);
DB_END_BrainBattle_QueuedThrallSpawn((CHARACTER)_SpawnedThrall);
DB_END_BrainBattle_Setup_ThrallSpawned_Status(_SpawnedThrall,_PolymorphStatus);
DB_END_BrainBattle_DelaySetup(1);

IF
EnteredLevel((CHARACTER)_Thrall, _, "END_Main")
AND
DB_END_BrainBattle_QueuedThrallSpawn(_Thrall)
THEN
NOT DB_END_BrainBattle_QueuedThrallSpawn(_Thrall);

IF
EntityEvent(_SpawnedThrall,"END_BrainBattle_Setup_ThrallSpawned")
AND
DB_END_BrainBattle_Setup_ThrallSpawned_Status((CHARACTER)_SpawnedThrall,_PolymorphStatus)
THEN
ApplyStatus(_SpawnedThrall, _PolymorphStatus, -1.0, 1, _SpawnedThrall);
NOT DB_END_BrainBattle_Setup_ThrallSpawned_Status(_SpawnedThrall,_PolymorphStatus);

//Setup one super thrall per player when Emperor is allied.
PROC
PROC_END_BrainBattle_PreSetup()
AND
NOT DB_END_BrainBattle_DelaySetup(1)
THEN
PROC_END_BrainBattle_Setup();

IF
DB_END_BrainBattle_DelaySetup(1)
AND
NOT DB_END_BrainBattle_QueuedThrallSpawn(_)
THEN
PROC_END_BrainBattle_Setup();
//END_REGION 

//Setup Emperor when enemy.
PROC
PROC_END_BrainBattle_Setup()
AND
DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
THEN
PROC_SetOnStage(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 1);
PROC_RemoveMutingStatusses(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
PROC_CharacterFullRestore(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
TeleportTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_EmperorBrainPos_80c1ecca-63bf-4ea5-a536-e72f1b72c3a4, "");
SetFaction(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, (FACTION)ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879);
UseSpell(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,"Target_TAD_ShieldOfThralls",S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
ApplyStatus(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,"END_INITIATIVE_DEBUFF",-1.0,1,S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
SetAiHint(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,(TAG)AI_HINT_UNIQUE_1902723d-dd16-4e7a-87d6-7b07f63add79);
DB_END_BrainBattle_Enemies(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

//Setup one daisy per player if Emperor is enemy.
//Player has a daisy
PROC
PROC_END_BrainBattle_Setup()
AND
DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
DB_Players(_Player)
AND
DB_GLO_DaisyDreams_Relationships(_Player, _Daisy)
AND
DB_END_BrainBattle_AdversarySpawnPos(_Position)
AND
DB_END_BrainBattle_BackupDaisies(_BackupDaisy)
AND
NOT DB_END_BrainBattle_PlayerAdversary(_Player, _)
THEN
TeleportTo(_BackupDaisy, _Position, "");
Transform(_BackupDaisy, _Daisy, (SHAPESHIFTRULE)DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);
DB_END_BrainBattle_CombatDaisy(_BackupDaisy);
NOT DB_END_BrainBattle_BackupDaisies(_BackupDaisy);
DB_END_BrainBattle_Enemies(_BackupDaisy);
NOT DB_END_BrainBattle_AdversarySpawnPos(_Position);
DB_END_BrainBattle_PlayerAdversary(_Player, _BackupDaisy);
DB_END_BrainBattle_IntroExtraSpeakers((CHARACTER)_BackupDaisy);

//Player doesn't have a daisy so use a backup one.
PROC
PROC_END_BrainBattle_Setup()
AND
DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
DB_Players(_Player)
AND
NOT DB_GLO_DaisyDreams_Relationships(_Player, _)
AND
DB_END_BrainBattle_AdversarySpawnPos(_Position)
AND
DB_END_BrainBattle_BackupDaisies(_Daisy)
AND
NOT DB_END_BrainBattle_PlayerAdversary(_Player, _)
THEN
NOT DB_END_BrainBattle_BackupDaisies(_Daisy);
DB_END_BrainBattle_CombatDaisy(_Daisy);
DB_END_BrainBattle_Enemies(_Daisy);
TeleportTo(_Daisy, _Position, "");
NOT DB_END_BrainBattle_AdversarySpawnPos(_Position);
DB_END_BrainBattle_PlayerAdversary(_Player, _Daisy);
DB_END_BrainBattle_IntroExtraSpeakers((CHARACTER)_Daisy);

//Try Avatar Gale
PROC
PROC_END_BrainBattle_Setup()
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_END_BrainBattle_IntroScene(1)
AND
QRY_StartDialogCustom(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_IntroCharacter((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_END_BrainBattle_IntroScene(1);

//Start intro scene with main avatar.
PROC
PROC_END_BrainBattle_Setup()
AND
DB_END_General_MainDialogAnchor(_Avatar)
AND
NOT DB_END_BrainBattle_IntroScene(1)
AND
QRY_StartDialogCustom(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, _Avatar, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_IntroCharacter((CHARACTER)_Avatar);
DB_END_BrainBattle_IntroScene(1);

//Fallback: Try any avatar
PROC
PROC_END_BrainBattle_Setup()
AND
DB_Avatars(_Avatar)
AND
NOT DB_END_General_MainDialogAnchor(_Avatar)
AND
NOT DB_END_BrainBattle_IntroScene(1)
AND
QRY_StartDialogCustom(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, _Avatar, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_IntroCharacter((CHARACTER)_Avatar);
DB_END_BrainBattle_IntroScene(1);

//Fallback: Try non-avatar players
PROC
PROC_END_BrainBattle_Setup()
AND
DB_Players(_Player)
AND
NOT DB_Avatars(_Player)
AND
NOT DB_END_BrainBattle_IntroScene(1)
AND
QRY_StartDialogCustom(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, _Player, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_IntroCharacter((CHARACTER)_Player);
DB_END_BrainBattle_IntroScene(1);

IF
DialogActorJoined(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, _, _Player, _)
AND
DB_Players((CHARACTER)_Player)
AND
NOT DB_END_BrainBattle_IntroCharacter((CHARACTER)_Player)
AND
NOT DB_GlobalFlag(END_BrainBattle_State_HasCompanionsForIntro_f7bf2403-bdf4-50cc-f6b4-4fab6dc191fd)
THEN
SetFlag(END_BrainBattle_State_HasCompanionsForIntro_f7bf2403-bdf4-50cc-f6b4-4fab6dc191fd, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogActorJoined(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, _, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _)
AND
NOT DB_GlobalFlag(END_BrainBattle_State_HasCompanionsForIntro_f7bf2403-bdf4-50cc-f6b4-4fab6dc191fd)
THEN
SetFlag(END_BrainBattle_State_HasCompanionsForIntro_f7bf2403-bdf4-50cc-f6b4-4fab6dc191fd, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogActorJoined(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, _, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _)
AND
DB_PartyMembers(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
AND
NOT DB_GlobalFlag(END_BrainBattle_State_HasCompanionsForIntro_f7bf2403-bdf4-50cc-f6b4-4fab6dc191fd)
THEN
SetFlag(END_BrainBattle_State_HasCompanionsForIntro_f7bf2403-bdf4-50cc-f6b4-4fab6dc191fd, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_END_BrainBattle_Setup()
AND
DB_END_HighHallInterior_ToRoofReadyCheckPlayer(_Player)
THEN
NOT DB_END_HighHallInterior_ToRoofReadyCheckPlayer(_Player);

PROC
PROC_END_BrainBattle_Setup()
THEN
SetFlag(END_General_State_CurrentlyInBrainBattle_0d7205b2-0d55-4540-8737-543253873cd6);
PROC_SetRelationToPlayers(ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, 50);

//Couldn't start intro scene
PROC
PROC_END_BrainBattle_Setup()
AND
NOT DB_END_BrainBattle_IntroScene(1)
THEN
SetFlag(END_BrainBattle_Event_PlayersMovedToBrain_87f477a2-6ca7-4ada-be46-3f2680fa0f4c);
DB_END_BrainBattle_Start(1);
PROC_SetRelationToPlayers(ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, 0);


IF
DialogEnded(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, _)
AND
NOT DB_GlobalFlag(END_BrainBattle_Event_PlayersMovedToBrain_87f477a2-6ca7-4ada-be46-3f2680fa0f4c)
THEN
SetFlag(END_BrainBattle_Event_PlayersMovedToBrain_87f477a2-6ca7-4ada-be46-3f2680fa0f4c, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(END_BrainBattle_Event_PlayersMovedToBrain_87f477a2-6ca7-4ada-be46-3f2680fa0f4c, _, _)
THEN
PROC_END_BrainBattle_TeleportParty(1);

PROC
PROC_END_BrainBattle_TeleportParty(1)
AND
DB_PartyMembers(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
DB_END_BrainBattle_Teleported(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
TeleportTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_BrainBattlePartyPos_009_3c60b4fd-1440-40da-889d-d8d0030215b1, "", 0, 0, 0, 1, 1);
LookFromTrigger(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_BrainBattlePartyPos_009_3c60b4fd-1440-40da-889d-d8d0030215b1, 1);

PROC
PROC_END_BrainBattle_TeleportParty(1)
AND
DB_PartyMembers(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
DB_END_BrainBattle_Teleported(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
TeleportTo(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, S_END_BrainBattlePartyPos_009_3c60b4fd-1440-40da-889d-d8d0030215b1, "", 0, 0, 0, 1, 1);
LookFromTrigger(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, S_END_BrainBattlePartyPos_009_3c60b4fd-1440-40da-889d-d8d0030215b1, 1);

PROC
PROC_END_BrainBattle_TeleportParty((INTEGER)_Index)
AND
SysCount("DB_END_BrainBattle_TeleportPositions", 2, _Count)
AND
_Index > _Count
THEN
PROC_END_BrainBattle_TeleportParty(1);

//Move players in prepared spots
PROC
PROC_END_BrainBattle_TeleportParty((INTEGER)_Index)
AND
DB_PartyMembers(_Character)
AND
_Character != S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b
AND
_Character != S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e
AND
NOT DB_END_BrainBattle_Teleported(_Character)
AND
IntegerSum(_Index, 1, _NextIndex)
AND
DB_END_BrainBattle_TeleportPositions(_Pos, _Index)
THEN
DB_END_BrainBattle_Teleported(_Character);
TeleportTo(_Character, _Pos, "", 0, 0, 0, 1, 1);
LookFromTrigger(_Character, _Pos, 1);
PROC_END_BrainBattle_TeleportParty(_NextIndex);

//Have Karsus' Compulsion Glow in the UI
PROC
PROC_END_BrainBattle_TryEnterCombat(_Character)
AND
HasSpell(_Character,"Target_END_Mindflayer_CrownDomination",1)
THEN
ApplyStatus(_Character,"END_KARSUSCOMPULSION_SPELLGLOW",-1.0,1);

//END_REGION

//REGION Intro Dialogue

PROC
PROC_StartDialog_AddExtraSpeakers(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, _ID)
AND
DB_END_BrainBattle_IntroExtraSpeakers(_Adversary)
AND
DB_END_BrainBattle_CombatDaisy(_Adversary)
THEN
PROC_DialogAddSpeakingActor(_ID, _Adversary, 0, 1);

PROC
PROC_StartDialog_AddExtraSpeakers(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, _ID)
AND
DB_END_BrainBattle_ExtraSpeakerThrall(_Adversary)
THEN
PROC_DialogAddSpeakingActor(_ID, _Adversary, 0, 1);

PROC
PROC_StartDialog_AddExtraSpeakers(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, _ID)
AND
DB_PartyMembers(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
PROC_DialogAddSpeakingActor(_ID, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
FlagSet((FLAG)END_BrainBattle_Event_GaleAscendsTheStalkAlone_217731da-1297-09b6-52b0-e9ee8580e70c, _, _)
THEN
PROC_END_General_AssignMainAvatar((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
DialogEnded(END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, _)
THEN
SetFlag(END_BrainBattle_Event_Started_3cd63c2e-7343-45dd-9137-4cabca2179a6, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_END_BrainBattle_Start(1);
PROC_SetRelationToPlayers(ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, 0);

IF
CastSpell((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Spell, _, _, _)
AND
DB_ORI_Gale_SuicideSpell(_Spell)
THEN
PROC_END_General_AssignMainAvatar(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
//END_REGION

//REGION Combat Tracking
IF
DB_END_BrainBattle_Enemies(_Object)
AND
IsCharacter(_Object, 1)
THEN
PROC_CharacterDisableAllCrimes((CHARACTER)_Object);

//Orpheus or Emperor
IF
DB_PartyMembers(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
TriggerRegisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

//Orpheus or Emperor
IF
DB_PartyMembers(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
TriggerRegisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
RelationChanged(ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, _)
AND
DB_END_BrainBattle_Start(1)
AND
DB_PartyMembers(_PartyMember)
THEN
SetCombatGroupID(_PartyMember, "END_BrainBattle");
PROC_END_BrainBattle_TryEnterCombat(_PartyMember);

IF
EnteredTrigger(_PartyMember, S_END_BrainBattleArea_b0cbe773-d02f-4074-8507-eab6033c3b27)
AND
DB_END_BrainBattle_Start(1)
AND
GetCombatGroupID(_PartyMember, _Group)
AND
_Group != "END_BrainBattle"
THEN
SetCombatGroupID(_PartyMember, "END_BrainBattle");
PROC_END_BrainBattle_TryEnterCombat(_PartyMember);

PROC
PROC_END_BrainBattle_TryEnterCombat((CHARACTER)_Player)
AND
DB_END_BrainBattle_Enemies(_Character)
AND
NOT DB_Is_InCombat(_Player, _)
THEN
PROC_EnterCombat(_Player, _Character);

IF
DB_END_BrainBattle_Enemies(_Object)
THEN
SetForceUpdate(_Object, 1);
SetCombatGroupID(_Object, "END_BrainBattle");

//Track active players
IF
DB_Is_InCombat(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, _ID)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _ID)
AND
NOT DB_Defeated(_Player)
THEN
DB_END_BrainBattle_ActivePlayers(_Player);

IF
DB_END_BrainBattle_ActivePlayers(_Player)
AND
DB_Defeated(_Player)
THEN
NOT DB_END_BrainBattle_ActivePlayers(_Player);

PROC
PROC_END_BrainBattle_TryJoinCombat((GUIDSTRING)_Object)
AND
DB_END_BrainBattle_ActivePlayers(_Player)
AND
NOT DB_EnterCombatRequested(_Object)
THEN
PROC_EnterCombat(_Object, _Player);

PROC
PROC_StateSet_PermaDefeated(_Object)
AND
DB_END_BrainBattle_Enemies(_Object)
THEN
SetForceUpdate(_Object, 0);
NOT DB_END_BrainBattle_Enemies(_Object);

IF
DB_END_BrainBattle_Start(1)
AND
DB_KnockedOut(_PartyMember)
AND
DB_PartyMembers(_PartyMember)
AND
NOT DB_END_BrainBattle_PermaDefeated(_PartyMember)
THEN
TriggerUnregisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, _PartyMember);
DB_END_BrainBattle_PermaDefeated(_PartyMember);

IF
DB_END_BrainBattle_Start(1)
AND
DB_Dead(_PartyMember)
AND
DB_PartyMembers(_PartyMember)
AND
NOT DB_END_BrainBattle_PermaDefeated(_PartyMember)
THEN
TriggerUnregisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, _PartyMember);
DB_END_BrainBattle_PermaDefeated(_PartyMember);

IF
DB_END_BrainBattle_PermaDefeated(_Player)
AND
NOT DB_Dead(_Player)
AND
NOT DB_KnockedOut(_Player)
AND
DB_Players(_Player)
THEN
TriggerRegisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, _Player);
NOT DB_END_BrainBattle_PermaDefeated(_Player);

IF
DB_END_BrainBattle_PermaDefeated(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
AND
NOT DB_Dead(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
AND
NOT DB_KnockedOut(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
TriggerRegisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
NOT DB_END_BrainBattle_PermaDefeated(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

IF
DB_END_BrainBattle_PermaDefeated(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
NOT DB_Dead(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
NOT DB_KnockedOut(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
TriggerRegisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
NOT DB_END_BrainBattle_PermaDefeated(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
DB_PartyMembers(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
TriggerRegisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
DB_PartyMembers(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
TriggerRegisterForCharacter(S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

//All party members left the top brain battle.
IF
DB_END_BrainBattle_Start(1)
AND
NOT DB_InRegion(_, S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad)
AND
NOT DB_END_BrainBattle_PausedCombat(_)
AND
QRY_OnlyOnce("END_BrainBattle_Cleared")
THEN
PROC_END_BrainBattle_ClearBrainBattle();

PROC
PROC_END_BrainBattle_ClearBrainBattle()
AND
DB_Is_InCombat(_Object, _) //Everything in combat on top of the brain should get removed.
AND
IsInTrigger(_Object, S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, 1)
THEN
SetForceUpdate(_Object, 0);
SetCombatGroupID(_Object, "");
LeaveCombat(_Object);
SetCanJoinCombat(_Object, 0);
SetCanFight(_Object, 0);
PROC_END_BrainBattle_CheckRemoveFollower(_Object);

PROC
PROC_END_BrainBattle_CheckRemoveFollower((GUIDSTRING)_Character)
AND
IsCharacter(_Character, 1)
THEN
PROC_RemovePartyFollower((CHARACTER)_Character);

PROC
PROC_END_BrainBattle_CheckRemoveFollower((GUIDSTRING)_Character)
AND
IsCharacter(_Character, 1)
AND
IsSummon((CHARACTER)_Character, 1)
THEN
SetOnStage(_Character, 0);


PROC
PROC_END_BrainBattle_ClearBrainBattle()
AND
DB_END_BrainBattle_NautiloidCannons(_Cannon)
THEN
SetForceUpdate(_Cannon, 0);

//For debug purposes.
PROC
PROC_END_BrainBattle_ClearBrainBattle()
AND
DB_END_BrainBattle_Enemies(_Object) //Everything in combat on top of the brain should get removed.
AND
IsInTrigger(_Object, S_END_BrainCombatEndCheckArea_c2343d09-4446-416c-a3e6-fff64ca563ad, 1)
THEN
SetForceUpdate(_Object, 0);
SetCombatGroupID(_Object, "");
LeaveCombat(_Object);
SetCanJoinCombat(_Object, 0);
SetCanFight(_Object, 0);


//END_REGION

//REGION Crown turn
IF
EnteredCombat(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, _)
AND
DB_GlobalFlag(END_General_State_PartyMemberIsMindFlayer_3c42b03b-c51c-4f06-a5a3-a5ee416d9d8b)
THEN
TurnBasedTimerLaunch(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_NautiloidCountdown", "END_NautiloidCountdown_Timer", 24000);

IF
EnteredCombat(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, _)
AND
NOT DB_GlobalFlag(END_General_State_PartyMemberIsMindFlayer_3c42b03b-c51c-4f06-a5a3-a5ee416d9d8b)
THEN
DB_END_BrainBattle_TadpoleReminderActive(1);
TurnBasedTimerLaunch(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_NautiloidCountdown", "END_NautiloidCountdownSupremeTadpole_Timer", 24000);

IF
FlagSet(END_General_State_PartyMemberIsMindFlayer_3c42b03b-c51c-4f06-a5a3-a5ee416d9d8b, _, _)
AND
DB_END_BrainBattle_TadpoleReminderActive(1)
AND
DB_END_BrainBattle_CrownTurn(_TurnCount)
AND
_TurnCount < 4
AND
IntegerProduct(_TurnCount, 6000, _TimePassed)
AND
IntegerSubtract(24000, _TimePassed, _RemainingTime)
THEN
NOT DB_END_BrainBattle_TadpoleReminderActive(1);
DB_END_BrainBattle_ContinueTimerTime(_RemainingTime);
TurnBasedTimerCancel(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_NautiloidCountdown");
RealtimeObjectTimerLaunch(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_SwitchTimer", 500);

IF
ObjectTimerFinished(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_SwitchTimer")
AND
DB_END_BrainBattle_ContinueTimerTime(_RemainingTime)
THEN
TurnBasedTimerLaunch(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_NautiloidCountdown", "END_NautiloidCountdown_Timer", _RemainingTime);
NOT DB_END_BrainBattle_ContinueTimerTime(_RemainingTime);

IF
TurnStarted(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a)
THEN
PROC_END_BrainBattle_IncrementCrownTurn();

PROC
PROC_END_BrainBattle_IncrementCrownTurn()
AND
DB_END_BrainBattle_CrownTurn(_Turn)
AND
IntegerSum(_Turn, 1, _Sum)
THEN
NOT DB_END_BrainBattle_CrownTurn(_Turn);
DB_END_BrainBattle_CrownTurn(_Sum);
//PROC_END_BrainBattle_ProcessCrownTurn(_Sum);

PROC
PROC_END_BrainBattle_IncrementCrownTurn()
AND
DB_END_BrainBattle_CrownTurn(4)
AND
DB_END_BrainBattle_TadpoleReminderActive(1)
AND
NOT DB_GlobalFlag(END_General_State_PartyMemberIsMindFlayer_3c42b03b-c51c-4f06-a5a3-a5ee416d9d8b)
THEN
TurnBasedTimerCancel(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_NautiloidCountdown");
RealtimeObjectTimerLaunch(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_SwitchToQuestMessage", 500);

IF
ObjectTimerFinished(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_SwitchToQuestMessage")
THEN
QuestMessageShow("END_BrainBattle_UseSupremeTadpoleID", "END_BrainBattle_UseSupremeTadpole");

IF
FlagSet(END_General_State_PartyMemberIsMindFlayer_3c42b03b-c51c-4f06-a5a3-a5ee416d9d8b, _, _)
AND
DB_END_BrainBattle_TadpoleReminderActive(1)
AND
DB_END_BrainBattle_CrownTurn(_TurnCount)
AND
_TurnCount >= 4
THEN
NOT DB_END_BrainBattle_TadpoleReminderActive(1);
QuestMessageHide("END_BrainBattle_UseSupremeTadpoleID");

PROC
PROC_END_BrainBattle_IncrementCrownTurn()
AND
DB_END_BrainBattle_CrownTurn(4)
THEN
SetFlag(END_BrainBattle_Event_SummoningNautiloid_4941b0cc-c3f0-1aa4-36ab-0c0768090b07);

IF
EntityEvent(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_CameraTarget")
AND
DB_END_BrainBattle_CrownTurn(4)
THEN
TeleportTo(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, S_END_NautiloidCameraPos_b18891fe-a5b0-4c11-b3d5-f6f6391a6b39, "", 0, 0, 0, 0, 0);

IF
EntityEvent(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_CastSpell")
AND
DB_END_BrainBattle_CrownTurn(4)
THEN
PROC_END_BrainBattle_CrownSpell(S_END_NautiloidCameraPos_b18891fe-a5b0-4c11-b3d5-f6f6391a6b39, "Shout_END_Netherbrain_HellFromAbove");

PROC
PROC_END_BrainBattle_CrownSpell((GUIDSTRING)_VisualTarget, "Shout_END_Netherbrain_HellFromAbove")
THEN
UseSpell(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "Shout_END_Netherbrain_HellFromAbove", S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a);

PROC
PROC_END_BrainBattle_CrownSpell((GUIDSTRING)_VisualTarget, "Shout_END_Netherbrain_DraconicDomination")
THEN
UseSpell(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "Shout_END_Netherbrain_DraconicDomination", S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a);

PROC
PROC_END_BrainBattle_CrownSpell((GUIDSTRING)_VisualTarget, "Target_END_Netherbrain_GraspFromBelow")
THEN
UseSpell(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "Target_END_Netherbrain_GraspFromBelow", _VisualTarget);

IF
EntityEvent(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_CameraTarget")
AND
DB_END_BrainBattle_CrownTurn(2)
THEN
TeleportTo(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, S_END_DragonCameraPos_792709ca-d97a-4ad0-858f-6bf0bd377687, "", 0, 0, 0, 0, 0);

IF
EntityEvent(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_CastSpell")
AND
DB_END_BrainBattle_CrownTurn(2)
THEN
PROC_END_BrainBattle_CrownSpell(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "Shout_END_Netherbrain_DraconicDomination");

IF
AutomatedDialogEnded((DIALOGRESOURCE)END_BrainBattle_AD_CrownTurn_52b8a6be-38bc-4da6-5d4c-42fe19783a4c, _)
AND
DB_END_BrainBattle_CrownTurn(4)
THEN
ApplyStatus(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_CROWN_CASTING_VFX", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
TurnEnded(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a)
THEN
RemoveStatus(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_CROWN_CASTING_VFX", NULL_00000000-0000-0000-0000-000000000000);
TeleportTo(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "", 0, 0, 0, 0, 0);
ObjectTimerCancel(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a,"END_BrainBattle_EnnervationRay_VFXTimer");
ObjectTimerCancel(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a,"END_BrainBattle_EnnervationRay_SpellCastTimer");


//Ennervation Ray
//Reset camera to the crown and play VFX
IF
EntityEvent(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_CastSpell3")
THEN
ApplyStatus(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_CROWN_CASTING_VFX", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
PlayAnimation(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20,SPL_EnervationRay_01_Cast_95201e56-49e2-420c-bb25-ccc69ab57c3b);
RealtimeObjectTimerLaunch(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a,"END_BrainBattle_EnnervationRay_VFXTimer",500);

IF
TextEvent("crownanim")
THEN
PlayAnimation(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20,SPL_EnervationRay_01_Cast_95201e56-49e2-420c-bb25-ccc69ab57c3b);
DebugText(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20,"Text Crown Animation");

//Portal VFX
IF
ObjectTimerFinished(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a,"END_BrainBattle_EnnervationRay_VFXTimer")
THEN
ApplyStatus((ITEM)S_END_EnervationRay_PortalVFXHelper_13b52a45-144b-4ab1-a89f-dd5bcfd57936, "END_CROWN_ENNERVATION_CASTING_VFX", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
TeleportTo(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a,S_END_EnervationRayCameraPos_8b3c2808-b0d7-4aa7-867c-12406a9aee95);
RealtimeObjectTimerLaunch(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a,"END_BrainBattle_EnnervationRay_SpellCastTimer",1000);

//Cast Spell
IF
ObjectTimerFinished(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a,"END_BrainBattle_EnnervationRay_SpellCastTimer")
AND
QRY_END_BrainBattle_GetClosestValidTarget()
AND
DB_END_BrainBattle_ClosestValidTarget(_Target, _)
THEN
RemoveStatus((ITEM)S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_CROWN_CASTING_VFX");
RemoveStatus((ITEM)S_END_EnervationRay_PortalVFXHelper_13b52a45-144b-4ab1-a89f-dd5bcfd57936, "END_CROWN_ENNERVATION_CASTING_VFX");
UseSpell((ITEM)S_END_EnervationRay_PortalVFXHelper_13b52a45-144b-4ab1-a89f-dd5bcfd57936, "Projectile_EnnervationRay", _Target);
TeleportTo(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a,_Target);


QRY
QRY_END_BrainBattle_GetClosestValidTarget()
AND
DB_END_BrainBattle_ClosestValidTarget(_Target, _Distance)
THEN
NOT DB_END_BrainBattle_ClosestValidTarget(_Target, _Distance);

QRY
QRY_END_BrainBattle_GetClosestValidTarget()
AND
DB_Is_InCombat(_Target, _)
AND
QRY_IsInCombatWith(_Target, (ITEM)S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a)
AND
NOT DB_Defeated(_Target)
AND
GetFaction(_Target, _TargetFaction)
AND
GetRelation(_TargetFaction, (FACTION)ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, _Relation)
AND
_Relation == 0
AND
GetDistanceTo(_Target, S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, _Distance)
THEN
DB_END_BrainBattle_ClosestValidTarget(_Target, _Distance);

IF
DB_END_BrainBattle_ClosestValidTarget(_Target, _Distance)
AND
DB_END_BrainBattle_ClosestValidTarget(_Target2, _Distance2)
AND
_Target != _Target2
AND
_Distance <= _Distance2
THEN
NOT DB_END_BrainBattle_ClosestValidTarget(_Target2, _Distance2);

IF
EntityEvent(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_ResetCameraTarget")
THEN
TeleportTo(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "", 0, 0, 0, 0, 0);
//END_REGION

//REGION Tentacle Spawning / Destroying

IF
DB_END_BrainBattle_BrainTentacles(_Tentacle , _Trigger)
THEN
PROC_SetOnStage(_Tentacle, 0);
PROC_TriggerRegisterForParty(_Trigger);

IF
EnteredTrigger(_Char, _Trigger)
AND
DB_END_BrainBattle_BrainTentacles(_Tentacle, _Trigger)
AND
IsOnStage(_Tentacle, 0)
AND
GetUUID(_Tentacle,_UUID)
AND
Concatenate("END_BrainBattle_SpawnTentacle_",_UUID,_OnlyOnceString)
AND
QRY_OnlyOnce(_OnlyOnceString)
THEN
AppearAt(_Tentacle, _Tentacle, 1, NULL_00000000-0000-0000-0000-000000000000, "", 0);
DB_END_BrainBattle_Enemies(_Tentacle);
PROC_TriggerUnregisterForParty(_Trigger);

IF
DB_PermaDefeated(_Tentacle)
AND
DB_END_BrainBattle_BrainTentacles((CHARACTER)_Tentacle, (TRIGGER)_Trigger)
THEN
NOT DB_END_BrainBattle_BrainTentacles(_Tentacle, _Trigger);


//Interaction with Dragon Landing
IF
CastedSpell((CHARACTER)_Dragon, "Target_Fly_Dragon",_,_,_)
AND
DB_END_BrainBattle_BrainTentacles(_Tentacle, _)
AND
IsOnStage(_Tentacle, 1)
AND
GetDistanceTo(_Dragon, _Tentacle, _Dist)
AND
_Dist < 6.0
THEN
Die((CHARACTER)_Tentacle, DEATHTYPE.Physical, _Dragon, 1, 0);

//END_REGION

//REGION Illithid Horde - Misc. Reinforcements

IF
DB_END_BrainBattle_PodSpawnAreas(_Trigger)
THEN
TriggerRegisterForCharacter(_Trigger, S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e);

//END_REGION

//REGION Draconic Domination

IF
TextEvent("END_SpawnDragon")
THEN
PROC_END_BrainBattle_SpawnDragon();

PROC
PROC_END_BrainBattle_SpawnDragon()
THEN
DB_END_BrainBattle_QueuedSpawn(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e);
SetOnStage(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, 1);
SetForceUpdate(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, 1);
SetEntityEvent(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, "END_BrainBattle_SpawnedDragon");


IF
WentOnStage(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, 1)
THEN
PlayAnimation(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, (ANIMATION)CUST_Landing_01_72f2b73f-ab59-4ea7-99fa-ac1c8b298e80, "");

IF
StatusRemoved(S_END_Dragon_823861a5-0132-4d15-b9f1-9bac2fa2e85e, "END_NETHERBRAIN_DRAGONDOMINATION", _, _)
THEN
PROC_SetRelationMutual(ACT3_END_Dragon_c43260b4-b04a-44df-814d-662bf64ff602, ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, 0);
PROC_SetRelationToPlayers(ACT3_END_Dragon_c43260b4-b04a-44df-814d-662bf64ff602, 100);

//END_REGION

//REGION Hell from Above - Nautiloid

PROC
PROC_END_BrainBattle_CrownSpell((GUIDSTRING)_VisualTarget, "Shout_END_Netherbrain_HellFromAbove")
THEN
PROC_END_BrainBattle_SpawnNautiloid();


//First helper is converted into a pod strike if possible.
PROC
PROC_END_HellFromAbove_DecideStrike((TRIGGER)_Helper)
AND
NOT DB_END_HellFromAbove_QueuedPod(_, _, _)
AND
GetPosition(_Helper, _X, _Y, _Z)
THEN
DB_END_HellFromAbove_SetTarget(_Helper);
DB_END_HellFromAbove_QueuedPod(_X, _Y, _Z);
PROC_END_NautiloidStrike_SetTarget(_X, _Z, 1);

PROC
PROC_END_HellFromAbove_DecideStrike((TRIGGER)_Helper)
AND
NOT DB_END_HellFromAbove_SetTarget(_Helper)
AND
GetPosition(_Helper, _X, _Y, _Z)
THEN
DB_END_HellFromAbove_SetTarget(_Helper);
PROC_END_NautiloidStrike_SetTarget(_X, _Z);

PROC
PROC_END_BrainBattle_SpawnNautiloid()
THEN
ApplyStatus(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, "END_NAUTILOID_SPAWN_VFX", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, "END_NAUTILOID_SPAWN_VFX", _, _)
THEN
TeleportTo(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, S_END_BrainNautiloidPos_d7fb3435-99f8-4e54-b428-5a03c15aee89, "");
SetForceUpdate(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, 1);
DB_END_BrainBattle_Enemies(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a);
PROC_END_BrainBattle_TryJoinCombat(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a);

PROC
PROC_END_BrainBattle_TryJoinCombat(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a)
AND
DB_END_BrainBattle_NautiloidCannons(_Cannon)
THEN
SetOnStage(_Cannon, 1);
SetForceUpdate(_Cannon, 1);

IF
EnteredCombat(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, _)
AND
DB_END_BrainBattle_NautiloidTurn(_Turn)
THEN
PROC_END_HellFromAbove_SeekTargets(_Turn);

IF
EntityEvent(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, "END_BrainBattle_Turn")
THEN
PROC_END_BrainBattle_IncrementNautiloidTurn();

PROC
PROC_END_BrainBattle_IncrementNautiloidTurn()
AND
DB_END_BrainBattle_NautiloidTurn(_Turn)
AND
IntegerSum(_Turn, 1, _Sum)
THEN
NOT DB_END_BrainBattle_NautiloidTurn(_Turn);
DB_END_BrainBattle_NautiloidTurn(_Sum);

IF
EntityEvent(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, "END_BrainBattle_CameraTarget")
THEN
TeleportTo(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, S_END_NautiloidStrikeCameraPos_4d4689c2-ab9a-47e2-810f-468c6ba3a066, "", 0, 0, 0, 0, 0);

IF
EntityEvent(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, "END_BrainBattle_CastSpell2")
AND
DB_END_BrainBattle_NautiloidTurn(_Turn)
THEN
PROC_END_HellFromAbove_SeekTargets(_Turn);

PROC
PROC_END_HellFromAbove_SeekTargets((INTEGER)_Turn)
AND
IntegerModulo(_Turn, 3, _Mod)
AND
DB_END_BrainBattle_NautiloidStrikeSets(_Position, _Mod)
THEN 
PROC_END_HellFromAbove_DecideStrike(_Position);

IF
EntityEvent(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, "END_BrainBattle_FireCannons")
AND
DB_PartyMembers(_PartyMember)
THEN
SendArenaCameraEvent(S_END_Nautiloid_002_f50dc928-bb2d-48b6-a2dd-98fce0a47d28, _PartyMember, "END_BrainBattle_CINE_NautiloidFires");

IF
EntityEvent(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, "END_BrainBattle_CastSpell")
AND
DB_END_BrainBattle_NautiloidTurn(_Turn)
AND
IntegerModulo(_Turn, 2, _Modulo)
THEN
TeleportTo(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, S_END_NautiloidStrikeCameraPos_4d4689c2-ab9a-47e2-810f-468c6ba3a066, "", 0, 0, 0, 0, 0);
PROC_END_NautiloidStrike_FireAll();
PROC_END_HellFromAbove_FirePod(_Modulo);

//0 is the modulo for even turns, spawn intellect devourers
PROC
PROC_END_HellFromAbove_FirePod(0)
THEN
PROC_END_NautiloidStrike_FireDropPods(0);

//1 is the modulo for even turns, spawn a mindflayer
PROC
PROC_END_HellFromAbove_FirePod(1)
THEN
PROC_END_NautiloidStrike_FireDropPods(1);

PROC
PROC_END_HellFromAbove_FirePod((INTEGER)_Turn)
AND
DB_END_HellFromAbove_QueuedPod(_X, _Y, _Z)
THEN
NOT DB_END_HellFromAbove_QueuedPod(_X, _Y, _Z);

PROC
PROC_END_NautiloidStrike_FireAll()
AND
DB_END_HellFromAbove_SetTarget(_Helper)
THEN
NOT DB_END_HellFromAbove_SetTarget(_Helper);

IF
TurnEnded(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a)
THEN
TeleportTo(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, S_END_FireCannonsCameraPos_49c42cb5-1550-4b6f-ba2d-7e09d59b2cba, "", 0, 0, 0, 0, 0);

IF
EnteredCombat(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, _)
THEN
TeleportTo(S_END_NautiloidHelper_f61c2ece-f92e-4707-b6e4-eae37437990a, S_END_FireCannonsCameraPos_49c42cb5-1550-4b6f-ba2d-7e09d59b2cba, "", 0, 0, 0, 0, 0);

//END_REGION

//REGION Generic spawn handling

PROC
PROC_END_NautiloidStrike_DropPodCharSet(_Char)
AND
IsInTrigger(_Char, S_END_BrainBattleArea_b0cbe773-d02f-4074-8507-eab6033c3b27, 1)
THEN
DB_END_BrainBattle_Enemies(_Char);

PROC
PROC_END_NautiloidStrike_IntDevPodCharSet(_IntDev)
AND
IsInTrigger(_IntDev, S_END_BrainBattleArea_b0cbe773-d02f-4074-8507-eab6033c3b27, 1)
THEN
RequestSetSwarmGroup(_IntDev, "END_BrainBattle_IntDevs");
SetFaction(_IntDev, (FACTION)ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879);

IF
WentOnStage(_SpawnedCharacter, 1)
AND
DB_END_BrainBattle_QueuedSpawn(_SpawnedCharacter)
THEN
NOT DB_END_BrainBattle_QueuedSpawn(_SpawnedCharacter);
PROC_END_BrainBattle_Spawned(_SpawnedCharacter);

PROC
PROC_END_BrainBattle_Spawned((GUIDSTRING)_SpawnedCharacter)
THEN
DB_END_BrainBattle_Enemies(_SpawnedCharacter);

//END_REGION

//REGION Casting Kharsus's Compulsion

IF
CastedSpell(_, "Target_END_Mindflayer_CrownDomination", _, _, _)
AND
NOT DB_GlobalFlag(END_BrainBattle_Event_CompulsionAttempt_91f9cf79-2ba8-ce1c-9380-4282464328be)
THEN
SetFlag(END_BrainBattle_Event_CompulsionAttempt_91f9cf79-2ba8-ce1c-9380-4282464328be, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(END_BrainBattle_Event_CompulsionAttempt_91f9cf79-2ba8-ce1c-9380-4282464328be, _, _)
AND
DB_END_BrainBattle_Enemies_MindFlayerArcanists(_Char)
THEN
SetStayInAiHints(_Char,0);
SetAiHint(_Char,NULL_00000000-0000-0000-0000-000000000000);

IF
TurnStarted((CHARACTER)_DominationCharacter)
AND
HasActiveStatus(_DominationCharacter, "END_KARSUSCOMPULSION_CHANNEL", 1)
THEN
DB_END_BrainBattle_DominationDone(1);


IF
GainedControl((CHARACTER)_DominationCharacter)
AND
HasActiveStatus(_DominationCharacter, "END_KARSUSCOMPULSION_CHANNEL", 1)
AND
DB_END_BrainBattle_DominationDone(1)
THEN
RemoveStatus(_DominationCharacter,"END_KARSUSCOMPULSION_CHANNEL");
ApplyStatus(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20,"END_KARSUSCOMPULSION_CHANNEL_TARGET_END",1.0,1);
PROC_END_BrainBattle_DominationUsed(_DominationCharacter);

//Hack to keep the channelling VFX in sync
IF
StatusRemoved(_DominationCharacter, "END_KARSUSCOMPULSION_CHANNEL",_,_)
THEN
RemoveStatus(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20,"END_KARSUSCOMPULSION_CHANNEL_TARGET");

PROC
PROC_END_BrainBattle_DominationUsed((CHARACTER)_DominationCharacter)
THEN
PROC_END_General_AssignMainAvatar(_DominationCharacter);
DB_END_BrainBattle_DominationCharacter(_DominationCharacter);

//End combat if ongoing.
PROC
PROC_END_BrainBattle_DominationUsed((CHARACTER)_DominationCharacter)
AND
DB_Is_InCombat(S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a, _ID)
THEN
DB_END_BrainBattle_PausedCombat(_ID);
PauseCombat(_ID);

PROC
PROC_END_BrainBattle_DominationUsed((CHARACTER)_DominationCharacter)
THEN
SetFlag(END_BrainBattle_State_PortalOpen_d55bc4d7-eabb-1c01-88e4-28e3456bd1c7, NULL_00000000-0000-0000-0000-000000000000, 0);
SetOnStage(S_END_MindPortal_06463ecc-d906-4c7c-b4e0-41e69abccc36, 1);
SetForceUpdate(S_END_MindPortal_06463ecc-d906-4c7c-b4e0-41e69abccc36, 1);

IF
WentOnStage(S_END_MindPortal_06463ecc-d906-4c7c-b4e0-41e69abccc36, 1)
THEN
TimerLaunch("END_BrainBattle_StartMindFade", 2000);

IF
TimerFinished("END_BrainBattle_StartMindFade")
AND
DB_Players(_Player)
THEN
ScreenFadeTo(_Player, 1.5, 1, "END_BrainBattle_EnterMindFade");

IF
ScreenFadeDone(_, "END_BrainBattle_EnterMindFade")
AND
QRY_OnlyOnce("END_BrainBattle_ClearFade")
THEN
PROC_END_BrainBattle_FadeFinished();

IF
DialogStarted((DIALOGRESOURCE)END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd, _)
AND
DB_Players(_Player)
THEN
ClearScreenFade(_Player, 0.8, "END_BrainBattle_EnterMindFade");

IF
DialogStarted((DIALOGRESOURCE)END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd, _)
THEN
PROC_END_BrainBattle_TeleportDominationCharacter();

PROC
PROC_END_BrainBattle_TeleportDominationCharacter()
AND
QRY_OnlyOnce("END_BrainBattle_TeleportDominationCharacter")
AND
DB_END_BrainBattle_DominationCharacter(_DominationCharacter)
THEN
DB_END_BrainBattle_EnterPortalAD(1);
DB_END_BrainBattle_PortalOpened(1);
DB_END_BrainBattle_QueueMindAD(_DominationCharacter);
TeleportTo(_DominationCharacter, S_END_MindPartyPos_8f6b2b6a-3c4c-45e9-8069-d728ecca47f0, "", 0, 0, 0, 0, 1);

IF
StatusApplied(_, "END_KARSUSCOMPULSION_CHANNEL", _, _)
THEN
DB_END_BrainBattle_OngoingDomination(1);

IF
StatusRemoved(_, "END_KARSUSCOMPULSION_CHANNEL", _, _)
THEN
NOT DB_END_BrainBattle_OngoingDomination(1);

//END_REGION

//REGION Mind Battle

PROC
PROC_END_BrainBattle_FadeFinished()
AND
QRY_OnlyOnce("END_BrainBattle_EnterMind")
AND
DB_END_BrainBattle_DominationCharacter(_DominationCharacter)
THEN
PROC_END_BrainBattle_EnterMindDialog(_DominationCharacter);

PROC
PROC_END_BrainBattle_EnterMindDialog((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
CharacterGetOwner(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Owner)
AND
QRY_StartDialogCustom(END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, NULL_00000000-0000-0000-0000-000000000000, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Owner, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_EnterMindScene(1);

PROC
PROC_END_BrainBattle_EnterMindDialog((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
AND
CharacterGetOwner(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _Owner)
AND
QRY_StartDialogCustom(END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, NULL_00000000-0000-0000-0000-000000000000, _Owner, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_EnterMindScene(1);

PROC
PROC_END_BrainBattle_EnterMindDialog((CHARACTER)_DominationCharacter)
AND
QRY_StartDialogCustom(END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _DominationCharacter, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_EnterMindScene(1);

PROC
PROC_END_BrainBattle_EnterMindDialog((CHARACTER)_DominationCharacter)
AND
NOT DB_END_BrainBattle_EnterMindScene(1)
THEN
PROC_END_BrainBattle_EnterMind(_DominationCharacter);

IF
DialogEnded(END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd, _)
AND
DB_END_BrainBattle_DominationCharacter(_DominationCharacter)
THEN
PROC_END_BrainBattle_EnterMind(_DominationCharacter);
MusicPlayGeneral("Netherbrain_combat_Part_2");

PROC
PROC_END_BrainBattle_EnterMind((CHARACTER)_DominationCharacter)
AND
DB_END_BrainBattle_PausedCombat(_ID)
THEN
NOT DB_END_BrainBattle_PausedCombat(_ID);
ResumeCombat(_ID);
RemoveStatus(_DominationCharacter,"END_KARSUSCOMPULSION_SPELLGLOW");

PROC
PROC_END_BrainBattle_EnterMind((CHARACTER)_DominationCharacter)
THEN
SetForceUpdate(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, 1);
SetForceUpdate(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, 1);
SetCombatGroupID(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, "END_BrainBattle");
SetCombatGroupID(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, "END_BrainBattle");
EnterCombat(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, _DominationCharacter);
EnterCombat(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, _DominationCharacter);
RemoveSpell(_DominationCharacter,"Shout_END_AllyAbilities_MultipleSummon",1);

IF
EnteredCombat(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, _)
THEN
TurnBasedTimerCancel(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, "END_NautiloidCountdown");
TimerLaunch("END_Mindcountdown_Delay", 1000);

IF
TimerFinished("END_Mindcountdown_Delay")
THEN
TurnBasedTimerLaunch(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, "END_MindCountdown", "END_MindCountdown_Timer", 30000);

//Teleporter
IF
UseStarted(_Character, S_END_MindPortal_06463ecc-d906-4c7c-b4e0-41e69abccc36)
THEN
PROC_END_BrainBattle_UsedMindTeleporter(_Character);

PROC
PROC_END_BrainBattle_UsedMindTeleporter((CHARACTER)_Character)
THEN
DB_END_BrainBattle_QueuedTeleportToMind(_Character);

//Try a spot unaffected by orb
PROC
PROC_END_BrainBattle_UsedMindTeleporter((CHARACTER)_Character)
AND
DB_END_BrainBattle_MindSpawnPoints(_Target, _Object)
AND
DB_END_BrainBattle_QueuedTeleportToMind(_Character)
AND
HasActiveStatus(_Object, "OBLITERATIONORB", 0)
AND
NOT QRY_END_BrainBattle_IsMindTargetInvalid(_Target, _Character, _Object)
THEN
NOT DB_END_BrainBattle_QueuedTeleportToMind(_Character);
RemoveSpell(_Character,"Shout_END_AllyAbilities_MultipleSummon",1);
PlayEffect(_Character, VFX_Script_END_MindArena_TeleportIn_01_99f45f51-1c30-84ee-003f-d44be42e71c0,"Dummy_Root");
TeleportTo(_Character, _Target, "END_MindBattle_TeleportedTo", 0, 0, 0, 0, 1);

//If no spot is found, try spots affected by orb.
PROC
PROC_END_BrainBattle_UsedMindTeleporter((CHARACTER)_Character)
AND
DB_END_BrainBattle_MindSpawnPoints(_Target, _Object)
AND
DB_END_BrainBattle_QueuedTeleportToMind(_Character)
AND
HasActiveStatus(_Object, "OBLITERATIONORB", 1)
AND
NOT QRY_END_BrainBattle_IsMindTargetInvalid(_Target, _Character, _Object)
THEN
NOT DB_END_BrainBattle_QueuedTeleportToMind(_Character);
PlayEffect(_Character, VFX_Script_END_MindArena_TeleportIn_01_99f45f51-1c30-84ee-003f-d44be42e71c0,"Dummy_Root");
TeleportTo(_Character, _Target, "END_MindBattle_TeleportedTo", 0, 0, 0, 0, 1);

IF
EntityEvent((CHARACTER)_Player, "END_MindBattle_TeleportedTo")
AND
DB_END_AllyAbilities_Summons(_, _, _Follower, _)
THEN
PROC_RemovePartyFollower(_Follower);

QRY
QRY_END_BrainBattle_IsMindTargetInvalid((TRIGGER)_Target, (GUIDSTRING)_Character, (ITEM)_Object)
AND
GetPosition(_Target, _X, _Y, _Z)
AND
NOT FindValidPosition(_X, _Y, _Z, 1.0, _Character, 0, _, _, _)
THEN
NOT DB_END_BrainBattle_MindSpawnPoints(_Target, _Object);

IF
DestroyedBy(_Object, _, _, _)
AND
DB_END_BrainBattle_MindSpawnPoints(_Trigger, _Object)
THEN
NOT DB_END_BrainBattle_MindSpawnPoints(_Trigger, _Object);

IF
DestroyedBy(_Platform, _, _, _)
AND
DB_END_MindBattle_Ladders(_Ladder, _Platform)
THEN
PROC_END_MindBattle_DestroyLadder(_Ladder);

PROC
PROC_END_MindBattle_DestroyLadder((ITEM)_Ladder)
THEN
Die(_Ladder);

PROC
PROC_END_MindBattle_DestroyLadder((ITEM)_Ladder)
AND
DB_END_MindBattle_Ladders(_Ladder, _Platform)
THEN
NOT DB_END_MindBattle_Ladders(_Ladder, _Platform);

IF
DestroyedBy(_Platform, _, _, _)
AND
DB_END_MindBattle_Platforms(_Platform)
THEN
NOT DB_END_MindBattle_Platforms(_Platform);
PROC_END_MindBattle_CheckRemainingPlatforms();

PROC
PROC_END_MindBattle_CheckRemainingPlatforms()
AND
SysCount("DB_END_MindBattle_Platforms", 1, _RemainingPlatforms)
AND
IntegerToString(_RemainingPlatforms, _PlatformString)
AND
Concatenate(_PlatformString, " remaining platforms!", _PrintString)
THEN
DebugBreak(_PrintString);

IF
DB_END_MindBattle_OrbHelpers(_Helper)
THEN
AiAddInterestingItem(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759,(ITEM)_Helper);

//END_REGION

//REGION All chains broken game over

PROC
PROC_END_BrainBattle_CheckMindGameOver(5)
AND
DB_END_General_MainDialogAnchor(_Character)
AND
NOT DB_END_BrainBattle_BlockChainGameOver(1)
THEN
SetFlag((FLAG)GLO_ThrallOfTheAbsolute_Event_EndingLost_56da89f9-916b-076f-d6c1-035a9ac39cb8, _Character, 0);
//END_REGION

//REGION Elder Brain Hit reactions

IF
AttackedBy(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, _, _, _Type, _Amount, _, _)
AND
_Amount > 0
THEN
DB_END_BrainBattle_StoredDamageTypes(_Type);

IF
StatusApplied(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, "ABSOLUTE_AEGIS", _, _)
THEN
PROC_END_BrainBattle_MakeMindBrainImmune();

PROC
PROC_END_BrainBattle_MakeMindBrainImmune()
AND
DB_END_BrainBattle_StoredDamageTypes(_Type)
AND
DB_END_BrainBattle_ImmunityStatuses(_Status, _Type)
THEN
NOT DB_END_BrainBattle_StoredDamageTypes(_Type);
ApplyStatus(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, _Status, 6.0, 1, S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759);

IF
AttackedBy(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, _, _, _, _Amount, _, _)
AND
_Amount > 0
AND
NOT DB_END_MindBrain_IsPlayingHitAnimation(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1)
THEN
DB_END_MindBrain_IsPlayingHitAnimation(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1);
PlayAnimation((CHARACTER)S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1,(ANIMATION)REAC_Magic_External_Combat_01_5f127742-79d4-4590-839f-6eb5ae45930d,"END_Netherbrain_FinishedPlayingHitAnimation");
PROC_END_Netherbrain_PlayHitAnimation();

PROC
PROC_END_Netherbrain_PlayHitAnimation()
AND
GetHitpointsPercentage(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1,_Percent)
AND
_Percent > 0.0
THEN
DB_END_MindBrain_IsPlayingHitAnimation(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759);
PlayAnimation((CHARACTER)S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759,(ANIMATION)REAC_Hit_F_Combat_01_Head_b568aa07-de7e-4737-90b4-0f252613bdef,"END_Netherbrain_FinishedPlayingHitAnimation");

//Clear Animation DB
IF
EntityEvent((CHARACTER)_Char,"END_Netherbrain_FinishedPlayingHitAnimation")
AND
DB_END_MindBrain_IsPlayingHitAnimation(_Char)
THEN
NOT DB_END_MindBrain_IsPlayingHitAnimation(_Char);

//END_REGION

//REGION Netherbrain Psionic Rebuke reaction VFX (temp hack)

IF
UsingSpellOnTarget(_Char,_Target,"Target_PsionicRebuke_Netherbrain",_,_,_)
THEN
PROC_LoopEffect(VFX_Script_Brainquake_NoOffset_01_0d5c292e-0eca-5117-bdc5-75a56b1e5eb7, _Char, "END_BrainBattle_PsionicRebuke", "END_Main", "", 0.01);
RealtimeObjectTimerLaunch(_Char, "END_BrainBattle_PsionicRebuke_Timer", 5000);

IF
ObjectTimerFinished(_Char, "END_BrainBattle_PsionicRebuke_Timer")
THEN
PROC_StopLoopEffect(_Char, "END_BrainBattle_PsionicRebuke");
//END_REGION

//REGION Changes to the Brain if the players beats the 99 DC

IF
FlagSet(END_MorphicPool_Event_99RollSuccess_dfd232ba-165f-4472-ab46-ae45778642f7, _, _)
THEN
ApplyStatus(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1,"END_NETHERBRAIN_MORPHICPOOLWOUND",-1.0,1);
PROC_SetHitpointsPercentage_BlockSelfHealing(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1,80.0);

//END_REGION

//REGION Completing the Domination

IF
HitpointsChanged(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, _Percent)
THEN
SetHitpointsPercentage(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, _Percent);

IF
Dying(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1)
AND
DB_Is_InCombat(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, _ID)
THEN
DB_END_BrainBattle_BlockChainGameOver(1);
PROC_END_MindBattle_MindDeathSetup(_ID);

PROC
PROC_END_MindBattle_MindDeathSetup((GUIDSTRING)_CombatID)
THEN
TurnBasedTimerCancel(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, "END_MindCountdown");
PlayAnimation(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, DIE_Generic_KO_01_8145f891-e1f3-4510-b166-d974ef1c3896, "");
SetFlag(END_BrainBattle_Event_DeathCry_827e3129-d67e-ff16-c27a-952e9cf96f2b, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_TryStartAD(END_BrainBattle_AD_MindBrainTurn_fbc23a61-dd88-ca19-81ed-9578236a9b27, S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1);
DB_END_BrainBattle_PausedMindCombat(_CombatID);
PauseCombat(_CombatID);
TimerLaunch("END_MindBattle_Over", 7000);
MusicPlayGeneral("Netherbrain_combat_Victory");
PROC_END_BrainBattle_DeleteKeyItems();

PROC
PROC_END_BrainBattle_DeleteKeyItems()
THEN
NOT DB_END_General_TadpoleAndStoneTracking(
    (ITEM)S_END_CrownController_Complete_5424460f-8a64-45d6-863e-55e5425e271e,
    (FLAG)END_General_State_HasCrownController_de78970a-95c8-4e54-bdf7-28f1da9ca83b,
    (FLAG)END_General_State_PartyHasCrownController_d526db7f-8ded-4755-84cd-498fd629b11d,
    (DIALOGRESOURCE)END_General_PAD_DroppedCrownController_720b87f5-6516-f7f5-81f6-538cc8515051,
    "END_CompleteCrownController");

PROC
PROC_END_BrainBattle_DeleteKeyItems()
THEN
RequestDelete(S_GLO_PuzzleBox_326324f9-0920-8f0f-3e85-3781fbf48282);
RequestDelete(S_END_CrownController_Complete_5424460f-8a64-45d6-863e-55e5425e271e);

IF
TimerFinished("END_MindBattle_Over")
AND
DB_END_BrainBattle_PausedMindCombat(_ID)
THEN
PROC_END_BrainBattle_ClearBrainBattle();
EndCombat(_ID);
PROC_SetRelationToPlayers((FACTION)ACT3_END_Netherbrain_04928f91-6658-431e-b652-65aea6403879, 50);
SetImmortal(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, 0);
Die(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759);

IF
Died(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1)
AND
QRY_OnlyOnce("END_MindBattle_Over")
AND
DB_END_BrainBattle_DominationCharacter(_DominationCharacter)
THEN
PROC_END_BrainBattle_QueueFullRestore(_DominationCharacter);
DB_END_BrainBattle_DominationCompletedReady(1);

IF
Died(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759)
AND
QRY_OnlyOnce("END_MindBattle_Over")
AND
DB_END_BrainBattle_DominationCharacter(_DominationCharacter)
THEN
PROC_END_BrainBattle_QueueFullRestore(_DominationCharacter);
DB_END_BrainBattle_DominationCompletedReady(1);

//Remove Orbs if dying
IF
Dying(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1)
AND
DB_Is_InCombat(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, _Combat)
AND
DB_Is_InCombat(_Orb, _Combat)
AND
IsItem(_Orb,1)
AND
HasActiveStatus(_Orb,"OBLITERATIONORB_AURA",1)
THEN
SetOnStage(_Orb,0);

//Remove Orbs if dying
IF
Dying(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759)
AND
DB_Is_InCombat(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, _Combat)
AND
DB_Is_InCombat(_Orb, _Combat)
AND
IsItem(_Orb,1)
AND
HasActiveStatus(_Orb,"OBLITERATIONORB_AURA",1)
THEN
SetOnStage(_Orb,0);

IF
DB_END_BrainBattle_QueuedRestoreCharacters(_Character)
THEN
SetCanJoinCombat(_Character, 0);
SetCanFight(_Character, 0);
PROC_CharacterFullRestore((CHARACTER)_Character);
RestoreParty((CHARACTER)_Character);

IF
DB_END_BrainBattle_QueuedRestoreCharacters(_Character)
AND
DB_OffStage(_Character)
THEN
SetOnStage(_Character, 1);

IF
DB_END_BrainBattle_QueuedRestoreCharacters(_Character)
AND
NOT DB_CantAct(_Character)
AND
NOT DB_Defeated(_Character)
AND
NOT DB_OffStage(_Character)
THEN
NOT DB_END_BrainBattle_QueuedRestoreCharacters(_Character);

PROC
PROC_END_BrainBattle_QueueFullRestore((CHARACTER)_DominationCharacter)
AND
DB_PartyMembers(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
DB_END_BrainBattle_QueuedRestoreCharacters((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

PROC
PROC_END_BrainBattle_QueueFullRestore((CHARACTER)_DominationCharacter)
AND
DB_PartyMembers(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
DB_END_BrainBattle_QueuedRestoreCharacters((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

PROC
PROC_END_BrainBattle_QueueFullRestore((CHARACTER)_DominationCharacter)
AND
DB_Players(_Player)	//TODO: Part of the team?
THEN
DB_END_BrainBattle_QueuedRestoreCharacters(_Player);

IF
DB_END_BrainBattle_DominationCompletedReady(1)
AND
NOT DB_END_BrainBattle_QueuedRestoreCharacters(_)
AND 
DB_END_BrainBattle_DominationCharacter(_DominationCharacter)
THEN
PROC_END_General_AssignMainAvatar(_DominationCharacter);
PROC_END_BrainBattle_DominationCompleted(_DominationCharacter);

PROC
PROC_END_BrainBattle_DominationCompleted((CHARACTER)_DominationCharacter)
AND
DB_Players(_Player)	//TODO: Part of the team?
THEN
PROC_RemoveMutingStatusses(_Player); //Don`t need them anymore anyway.

//Domination character is a player
PROC
PROC_END_BrainBattle_DominationCompleted((CHARACTER)_DominationCharacter)
AND
DB_END_General_MainDialogAnchor(_Avatar)
AND
QRY_StartDialogCustom(END_BrainBattle_FinalDecision_e5feae67-c6f1-1827-e9d6-a6b34647c8ea, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Avatar, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_FinalDecisionScene(1);

//Try other avatars as a fallback if the above fails.
PROC
PROC_END_BrainBattle_DominationCompleted((CHARACTER)_DominationCharacter)
AND
DB_Avatars(_Avatar)
AND
NOT DB_END_General_MainDialogAnchor(_Avatar)
AND
NOT DB_END_BrainBattle_FinalDecisionScene(1)
AND
QRY_StartDialogCustom(END_BrainBattle_FinalDecision_e5feae67-c6f1-1827-e9d6-a6b34647c8ea, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Avatar, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_FinalDecisionScene(1);

//Try any non-avatar player as a fallback if the above fails.
PROC
PROC_END_BrainBattle_DominationCompleted((CHARACTER)_DominationCharacter)
AND
DB_Players(_Player)
AND
NOT DB_Avatars(_Player)
AND
NOT DB_END_BrainBattle_FinalDecisionScene(1)
AND
QRY_StartDialogCustom(END_BrainBattle_FinalDecision_e5feae67-c6f1-1827-e9d6-a6b34647c8ea, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Player, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_FinalDecisionScene(1);

IF
DialogStarted(END_BrainBattle_FinalDecision_e5feae67-c6f1-1827-e9d6-a6b34647c8ea, _)
AND
DB_END_BrainBattle_Enemies(_Character)
THEN
SetOnStage(_Character, 0);

PROC
PROC_END_BrainBattle_DominationCompleted((CHARACTER)_Character)
AND
DB_Players(_Player)
THEN
RemoveAllPartyFollowers(_Player);

PROC
PROC_END_BrainBattle_DominationCompleted((CHARACTER)_Player)
AND
DB_END_BrainBattle_DominationCharacter(_DominationCharacter)
AND
NOT DB_END_BrainBattle_FinalDecisionScene(1)
THEN
PROC_END_BrainBattle_BrainDestructionScene();

IF
DialogEnded(END_BrainBattle_FinalDecision_e5feae67-c6f1-1827-e9d6-a6b34647c8ea, _)
THEN
PROC_END_BrainBattle_ProcessFinalDecision();

PROC
PROC_END_BrainBattle_ProcessFinalDecision()
AND
DB_GlobalFlag(END_BrainBattle_Event_EvilFinalDecision_71617aed-6f56-ad38-5657-189de2628cc8)
AND
DB_END_General_MainDialogAnchor(_Avatar)
AND
DB_ORI_DarkUrge(_Avatar)
AND
DB_GlobalFlag(ORI_DarkUrge_State_BhaalAccepted_904c45e0-bb06-40ed-b5d7-4f1c851b9d86)
THEN
PROC_GlobalSetFlagAndCache(ORI_DarkUrge_State_FinalDecisionForBhaal_a7683d15-4bca-4c96-a158-225acb497a8e);



PROC
PROC_END_BrainBattle_ProcessFinalDecision()
AND
DB_END_BrainBattle_EvilEndingFlag(_Flag, _Dialog)
AND
DB_GlobalFlag(_Flag)
AND
DB_END_General_MainDialogAnchor(_Avatar)
AND
QRY_StartDialogCustom(_Dialog, NULL_00000000-0000-0000-0000-000000000000, _Avatar, 0, 0, 0, 0)
THEN
PROC_Subregion_UpdateName(S_END_NetherbrainArena_001_SUB_a79f975d-d33a-455b-a444-9a0d08f59c57, "END_HighHall_SUB");
DB_END_BrainBattle_EvilEnding(_Dialog);

PROC
PROC_END_General_AddExtraSpeakersCustom((DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilDurge_dee4fb08-6170-7221-fb87-51733bbd7220, (INTEGER)_ID)
AND
DB_END_General_MainDialogAnchor(_Avatar)
AND
DB_ORI_Partnered(_Avatar, _Companion)
AND
DB_PartyMembers(_Companion)
THEN
DialogAddActorAt(_ID, _Companion, 16);

PROC
PROC_END_General_AddExtraSpeakersCustom((DIALOGRESOURCE)END_BrainBattle_FinalDecision_Nested_EvilEmperor_b5525d0a-e217-9ed9-bc06-e98e2ce1b362, (INTEGER)_ID)
AND
DB_END_General_MainDialogAnchor(_Avatar)
AND
QRY_GLO_DaisyDreams_GetDaisy((CHARACTER)_Avatar)
AND
DB_QRYRTN_GLO_DaisyDreams_GetDaisy(_Daisy)
THEN
PROC_DialogAddSpeakingActor(_ID, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 1, 1);
DialogAddActorAt(_ID, _Daisy, 16);

PROC
PROC_END_BrainBattle_ProcessFinalDecision()
AND
DB_GlobalFlag(END_BrainBattle_Event_EvilFinalDecision_71617aed-6f56-ad38-5657-189de2628cc8)
AND
NOT DB_END_BrainBattle_EvilEnding(_)
AND
DB_END_General_MainDialogAnchor(_Avatar)
THEN
PROC_END_GodsAndMonsters_RollCredits("END_GodsAndMonsters_GameFinished");

IF
DialogEnded(_Dialog, _)
AND
DB_END_BrainBattle_EvilEnding(_Dialog)
THEN
PROC_END_GodsAndMonsters_RollCredits("END_GodsAndMonsters_GameFinished");


PROC
PROC_END_BrainBattle_ProcessFinalDecision()
AND
NOT DB_GlobalFlag(END_BrainBattle_Event_EvilFinalDecision_71617aed-6f56-ad38-5657-189de2628cc8)
THEN
PROC_END_BrainBattle_BrainDestructionScene();

PROC
PROC_END_BrainBattle_BrainDestructionScene()
AND
DB_PartyMembers(_Character)
THEN
TeleportTo(_Character, S_END_DestructionOfBrainPos_46fc7d18-5357-449f-bb04-1df7948e0bfd, "");

PROC
PROC_END_BrainBattle_BrainDestructionScene()
AND
DB_END_General_MainDialogAnchor(_Avatar)
AND
QRY_StartDialogCustom(END_BrainBattle_DestructionOfBrain_5180d955-3d53-ee59-ce74-5866c5be8cd2, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, _Avatar, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_BrainDestructionScene(1);

//Try other avatars just in case original caster dialog start failed
PROC
PROC_END_BrainBattle_BrainDestructionScene()
AND
DB_Avatars(_Avatar)
AND
NOT DB_END_BrainBattle_BrainDestructionScene(1)
AND
QRY_StartDialogCustom(END_BrainBattle_DestructionOfBrain_5180d955-3d53-ee59-ce74-5866c5be8cd2, S_GLO_Netherbrain_3858e896-d7dd-4699-b37d-d3919ff15ba7, _Avatar, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_BrainDestructionScene(1);

PROC
PROC_END_BrainBattle_BrainDestructionScene()
AND
NOT DB_END_BrainBattle_BrainDestructionScene(1)
THEN
PROC_END_BrainBattle_RevelryScene();

PROC
PROC_StartDialog_AddExtraSpeakers(END_BrainBattle_DestructionOfBrain_5180d955-3d53-ee59-ce74-5866c5be8cd2, _ID)
AND
DB_END_RealPartOfTheTeam((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
PROC_DialogAddSpeakingActor(_ID, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

PROC
PROC_StartDialog_AddExtraSpeakers(END_BrainBattle_DestructionOfBrain_5180d955-3d53-ee59-ce74-5866c5be8cd2, _ID)
AND
DB_END_RealPartOfTheTeam((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
PROC_DialogAddSpeakingActor(_ID, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
DialogEnded(END_BrainBattle_DestructionOfBrain_5180d955-3d53-ee59-ce74-5866c5be8cd2, _)
THEN
PROC_END_BrainBattle_RevelryScene();

PROC
PROC_END_BrainBattle_RevelryScene()
AND
DB_PartOfTheTeam(_Player)
AND
HasAppliedStatus(_Player, "TAD_PARTIAL_CEREMORPH", 1)
THEN
RemoveStatus(_Player, "TAD_PARTIAL_CEREMORPH", _Player);
RemoveCustomMaterialOverride(_Player, "398ca8ae-c3c0-47f5-8e45-d9402e198389");

PROC
PROC_END_BrainBattle_RevelryScene()
AND
DB_PartyMembers(_Character)
THEN
RemoveSplatters(_Character);

PROC
PROC_END_BrainBattle_RevelryScene()
AND
DB_PartyMembers(_Character)
THEN
TeleportTo(_Character, S_END_CombatOverPos_8546debd-36b5-461e-971a-9cf6c2e67bbb, "");

PROC
PROC_END_BrainBattle_RevelryScene()
AND
DB_END_RealPartOfTheTeam(_Character)
AND
NOT DB_PartyMembers(_Character)
THEN
TeleportTo(_Character, S_END_CombatOverPos_8546debd-36b5-461e-971a-9cf6c2e67bbb, "");

PROC
PROC_END_BrainBattle_RevelryScene()
AND
DB_END_General_MainDialogAnchor(_Avatar)
AND
QRY_StartDialogCustom(END_GameFinale_TheHerosRevelry_ecd7cb66-d650-d92a-118f-6be977c4b0b2, _Avatar, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_RevelryScene(1);

//Try other avatars just in case original caster dialog start failed
PROC
PROC_END_BrainBattle_RevelryScene()
AND
DB_Avatars(_Avatar)
AND
NOT DB_END_BrainBattle_RevelryScene(1)
AND
QRY_StartDialogCustom(END_GameFinale_TheHerosRevelry_ecd7cb66-d650-d92a-118f-6be977c4b0b2, _Avatar, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_RevelryScene(1);

PROC
PROC_END_BrainBattle_RevelryScene()
AND
NOT DB_END_BrainBattle_RevelryScene(1)
THEN
PROC_END_BrainBattle_CombatOverScene();

PROC
PROC_StartDialog_AddExtraSpeakers(END_GameFinale_TheHerosRevelry_ecd7cb66-d650-d92a-118f-6be977c4b0b2, _ID)
AND
DB_END_RealPartOfTheTeam((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
PROC_DialogAddSpeakingActor(_ID, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

PROC
PROC_StartDialog_AddExtraSpeakers(END_GameFinale_TheHerosRevelry_ecd7cb66-d650-d92a-118f-6be977c4b0b2, _ID)
AND
DB_END_RealPartOfTheTeam((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
PROC_DialogAddSpeakingActor(_ID, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
DialogEnded(END_GameFinale_TheHerosRevelry_ecd7cb66-d650-d92a-118f-6be977c4b0b2, _)
THEN
PROC_END_BrainBattle_CombatOverScene();

PROC
PROC_END_BrainBattle_CombatOverScene()
AND
DB_END_General_MainDialogAnchor(_Avatar)
AND
QRY_StartDialogCustom(END_BrainBattle_CombatOver_8cb159d3-3390-4e58-a0ae-8414628bb813, _Avatar, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_CombatOverScene(1);

//Main anchor failed for some reason. Try other avatars just in case original caster dialog start failed
//If there is NO ANCHOR it means we likely don't have anyone available logically to play this scene, so skip it.
PROC
PROC_END_BrainBattle_CombatOverScene()
AND
DB_END_General_MainDialogAnchor(_Anchor)
AND
DB_Avatars(_Avatar)
AND
_Avatar != _Anchor
AND
NOT DB_END_General_ForcedListener(_Avatar, _)
AND
NOT DB_END_BrainBattle_CombatOverScene(1)
AND
QRY_StartDialogCustom(END_BrainBattle_CombatOver_8cb159d3-3390-4e58-a0ae-8414628bb813, _Avatar, 0, 0, 0, 0)
THEN
DB_END_BrainBattle_CombatOverScene(1);

PROC
PROC_END_BrainBattle_CombatOverScene()
AND
NOT DB_END_BrainBattle_CombatOverScene(1)
THEN
PROC_END_BrainBattle_Over();	//Cutscene couldn't play, end brain battle

IF
DialogEnded(END_BrainBattle_CombatOver_8cb159d3-3390-4e58-a0ae-8414628bb813, _)
AND
NOT DB_END_BrainBattle_DarkUrgeConclusion(1)
THEN
PROC_END_BrainBattle_ClearEmperorOrpheus();
PROC_END_BrainBattle_Over();	

IF
DialogEnded(END_BrainBattle_CombatOver_8cb159d3-3390-4e58-a0ae-8414628bb813, _)
AND
DB_END_BrainBattle_DarkUrgeConclusion(1)
THEN
PROC_END_BrainBattle_DarkUrgeConclusion();

PROC
PROC_END_BrainBattle_DarkUrgeConclusion()
AND
DB_ORI_DarkUrge(_Avatar)
AND
NOT QRY_StartDialogCustom(END_BrainBattle_CombatOver_SoloDurge_e94fbdf8-a9c5-ec9f-1679-a425e15cd7c3, _Avatar, 0, 0, 0, 0)
THEN
PROC_END_BrainBattle_ClearEmperorOrpheus();
PROC_END_BrainBattle_Over();	

PROC
PROC_END_BrainBattle_DarkUrgeConclusion()
THEN
DB_END_BrainBattle_DarkUrgeConclusionAttempt(1);

IF
DialogEnded(END_BrainBattle_CombatOver_SoloDurge_e94fbdf8-a9c5-ec9f-1679-a425e15cd7c3, _)
AND
DB_END_BrainBattle_DarkUrgeConclusionAttempt(1)
THEN
PROC_END_BrainBattle_ClearEmperorOrpheus();
PROC_END_BrainBattle_Over();	

PROC
PROC_END_BrainBattle_ClearEmperorOrpheus()
AND
DB_PartOfTheTeam(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
NOT DB_PartOfTheTeam(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
NOT DB_PartyMembers(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
NOT DB_END_RealPartOfTheTeam((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

PROC
PROC_END_BrainBattle_ClearEmperorOrpheus()
AND
DB_PartOfTheTeam(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
NOT DB_PartOfTheTeam(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
NOT DB_PartyMembers(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
NOT DB_END_RealPartOfTheTeam((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);


//END_REGION

//REGION CombatOver character management

IF
DialogActorJoined((DIALOGRESOURCE)END_BrainBattle_CombatOver_8cb159d3-3390-4e58-a0ae-8414628bb813, _, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _)
THEN
SetFlag(END_CombatOver_State_LaezelInDialog_0108f646-e2c5-02f6-96ca-675c542114cc, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogActorJoined((DIALOGRESOURCE)END_BrainBattle_CombatOver_8cb159d3-3390-4e58-a0ae-8414628bb813, _, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _)
AND
NOT DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
SetFlag(END_BrainBattle_State_KarlachIsTheOnlyCompanion_9d788bc3-4bf5-b0a3-8a83-647622aaab67, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(END_BrainBattle_State_KarlachIsTheOnlyCompanion_9d788bc3-4bf5-b0a3-8a83-647622aaab67)
AND
DB_END_General_PotentialInterjectionCandidate(_NotKarlach, _, (DIALOGRESOURCE)END_BrainBattle_CombatOver_8cb159d3-3390-4e58-a0ae-8414628bb813)
AND
_NotKarlach != S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c
THEN
ClearFlag(END_BrainBattle_State_KarlachIsTheOnlyCompanion_9d788bc3-4bf5-b0a3-8a83-647622aaab67, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogStarted((DIALOGRESOURCE)END_BrainBattle_CombatOver_8cb159d3-3390-4e58-a0ae-8414628bb813, _)
AND
DB_ORI_DarkUrge(_DarkUrge)
AND
NOT DB_GlobalFlag(ORI_DarkUrge_State_BhaalResisted_74944ac3-1ea0-4eae-9653-1f1319f8646b)
AND
NOT DB_END_General_MainDialogAnchor(_DarkUrge)
AND
QRY_OnlyOnce("END_BrainBattle_GiveMPDarkUrgeDecision")
THEN
SetFlag(END_BrainBattle_Event_DarkUrgeConclusion_713b759e-e31f-7adb-032b-3063732d8b92, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_END_BrainBattle_DarkUrgeConclusion(1);
DB_END_General_FullPartyDialog((DIALOGRESOURCE)END_BrainBattle_CombatOver_SoloDurge_e94fbdf8-a9c5-ec9f-1679-a425e15cd7c3, 0, 1, 1, 1, 1, 1, 2);

//END_REGION

//REGION Player ADs

IF
DB_END_BrainBattle_Start(1)
AND
DB_Players(_Character)
THEN
DB_END_BrainBattle_ADCandidates(_Character);

IF
DB_END_BrainBattle_Start(1)
AND
DB_PartyMembers(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
DB_END_BrainBattle_ADCandidates(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

IF
DB_END_BrainBattle_Start(1)
AND
DB_PartyMembers(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
DB_END_BrainBattle_ADCandidates(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
DB_END_BrainBattle_Start(1)
THEN
DB_END_BrainBattle_FirstTurnAD(1);

IF
TurnStarted((CHARACTER)_Character)
AND
DB_END_BrainBattle_ADCandidates(_Character)
THEN
PROC_END_BrainBattle_ProcessTurnAD(_Character);

//First turn hasn't happened yet, try play the AD explaining the goal of the fight.
PROC
PROC_END_BrainBattle_ProcessTurnAD((CHARACTER)_Character)
AND
NOT DB_END_BrainBattle_ADOnTurn(_Character)
AND
DB_END_BrainBattle_FirstTurnAD(1)
AND
DB_InRegion(_Character, S_END_BrainBattleArea_b0cbe773-d02f-4074-8507-eab6033c3b27)
AND
NOT DB_CantTalk_IgnoreCombat(_Character)
THEN
NOT DB_END_BrainBattle_FirstTurnAD(1);
PROC_END_BrainBattle_TryPlayerAD((DIALOGRESOURCE)END_BrainBattle_AD_FirstTurn_6786e4ca-d4ff-0351-6931-682118235705, _Character);
DB_END_BrainBattle_ADOnTurn((CHARACTER)_Character);

//Character outside the portal is urging players to go in the portal.
PROC
PROC_END_BrainBattle_ProcessTurnAD((CHARACTER)_Character)
AND
DB_END_BrainBattle_ADCandidates(_Character)
AND
DB_END_BrainBattle_EnterPortalAD(1)
AND
DB_InRegion(_Character, S_END_BrainBattleArea_b0cbe773-d02f-4074-8507-eab6033c3b27)
AND
NOT DB_CantTalk_IgnoreCombat(_Character)
THEN
DB_END_BrainBattle_ADOnTurn((CHARACTER)_Character);
NOT DB_END_BrainBattle_EnterPortalAD(1);
PROC_END_BrainBattle_TryPlayerAD((DIALOGRESOURCE)END_BrainBattle_AD_EnterPortal_e32b047f-9bfe-e30e-441c-cd964a4b2cd9, _Character);


//Hurry Up AD. Plays on (preferrably) a non-illithid character to urge them to dominate the brain.
//This is randomized every combat round in order to avoid having the same character always say this line.
IF
CombatRoundStarted(_, _Round)
AND
DB_END_BrainBattle_Start(1)
AND
DB_END_BrainBattle_CrownTurn(2)
AND
NOT DB_END_BrainBattle_OngoingDomination(1)
AND
NOT DB_END_BrainBattle_PortalOpened(1)
AND
NOT DB_END_BrainBattle_QueuedHurryUpAD(_)
AND
_Round > 1
THEN
PROC_END_BrainBattle_FindHurryUpCharacter();

PROC
PROC_END_BrainBattle_FindHurryUpCharacter()
AND
DB_END_BrainBattle_HurryUpCandidate(_Character)
THEN
NOT DB_END_BrainBattle_HurryUpCandidate(_Character);

PROC
PROC_END_BrainBattle_FindHurryUpCharacter()
AND
DB_END_BrainBattle_ADCandidates(_Character)
AND
NOT DB_CantTalk_IgnoreCombat(_Character)
AND
IsTagged(_Character, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 0)
THEN 
DB_END_BrainBattle_HurryUpCandidate(_Character);

PROC
PROC_END_BrainBattle_FindHurryUpCharacter()
AND
QRY_GetRandom("DB_END_BrainBattle_HurryUpCandidate", 1, "DB_END_BrainBattle_QueuedHurryUpAD")
THEN
DB_NOOP(1);

//Try ceremorph if the random query didn't find a random candidate
PROC
PROC_END_BrainBattle_FindHurryUpCharacter()
AND
DB_END_BrainBattle_ADCandidates(_Character)
AND
NOT DB_END_BrainBattle_QueuedHurryUpAD(_)
AND
NOT DB_CantTalk_IgnoreCombat(_Character)
AND
IsTagged(_Character, FULL_CEREMORPH_3797bfc4-8004-4a19-9578-61ce0714cc0b, 1)
THEN
DB_END_BrainBattle_QueuedHurryUpAD((CHARACTER)_Character);

PROC
PROC_END_BrainBattle_ProcessTurnAD((CHARACTER)_Character)
AND
DB_END_BrainBattle_QueuedHurryUpAD(_Character)
THEN
DB_END_BrainBattle_ADOnTurn((CHARACTER)_Character);
NOT DB_END_BrainBattle_QueuedHurryUpAD(_Character);
PROC_END_BrainBattle_TryPlayerAD(END_BrainBattle_AD_HurryUp_082ec0c4-51ab-5ab7-1282-9b38419b116d, _Character);

//If the domination is ongoing, another character starting a turn should say that they need to protect the caster.
PROC
PROC_END_BrainBattle_ProcessTurnAD((CHARACTER)_Character)
AND
DB_END_BrainBattle_ADCandidates(_Character)
AND
DB_END_BrainBattle_OngoingDomination(1)
AND
NOT DB_CantTalk_IgnoreCombat(_Character)
AND
HasActiveStatus(_Character, "END_KARSUSCOMPULSION_CHANNEL", 0)
AND
QRY_OnlyOnce("END_BrainBattle_ProtectCasterAD")
THEN
DB_END_BrainBattle_ADOnTurn((CHARACTER)_Character);
PROC_END_BrainBattle_TryPlayerAD(END_BrainBattle_AD_ProtectCaster_ead8ed48-1bcb-8007-7346-75cfcde2faa0, _Character);

//If a character hasn't talked this round, the brain harasses them.
IF
GainedControl((CHARACTER)_Character)
AND
DB_END_BrainBattle_RapidMindMeld(1)
AND
NOT DB_END_BrainBattle_ADOnTurn((CHARACTER)_Character)
AND
IsInTrigger(_Character, S_END_BrainBattleArea_b0cbe773-d02f-4074-8507-eab6033c3b27, 1)
AND
Random(2500, _MindMeldTimer)
THEN
DB_END_BrainBattle_ADOnTurn((CHARACTER)_Character);
DB_END_BrainBattle_RapidMindMeldCount((CHARACTER)_Character, 2);
RealtimeObjectTimerLaunch(_Character, "END_BrainBattle_RapidMindMeld", _MindMeldTimer);

IF
ObjectTimerFinished(_Character, "END_BrainBattle_RapidMindMeld")
THEN
PROC_END_MorphicPool_RapidMindMeldADCleanup();
PROC_END_MorphicPool_TryRapidMindMeldAD((CHARACTER)_Character, S_END_BrainBattleArea_b0cbe773-d02f-4074-8507-eab6033c3b27);

IF
ObjectTimerFinished(_Character, "END_MorphicPool_RapidMindMeldAD")
AND
DB_END_BrainBattle_RapidMindMeldCount((CHARACTER)_Character, _Count)
AND
_Count > 0
AND
QRY_END_BrainBattle_RapidMindMeldCountAdjust((CHARACTER)_Character, _Count)
THEN
PROC_END_MorphicPool_RapidMindMeldADCleanup();
PROC_END_MorphicPool_TryRapidMindMeldAD(_Character, S_END_BrainBattleArea_b0cbe773-d02f-4074-8507-eab6033c3b27);

QRY
QRY_END_BrainBattle_RapidMindMeldCountAdjust((CHARACTER)_Character, (INTEGER)_Count)
AND
DB_END_BrainBattle_RapidMindMeldCount(_Character, _Count)
AND
IntegerSubtract(_Count, 1, _NewCount)
THEN
NOT DB_END_BrainBattle_RapidMindMeldCount(_Character, _Count);
DB_END_BrainBattle_RapidMindMeldCount(_Character, _NewCount);

QRY
QRY_END_BrainBattle_RapidMindMeldCountAdjust((CHARACTER)_Character, (INTEGER)_Count)
AND
DB_END_BrainBattle_RapidMindMeldCount(_Character, 0)
THEN
NOT DB_END_BrainBattle_RapidMindMeldCount(_Character, 0);

IF
DialogEnded(END_BrainBattle_EnterMind_714b6fff-814f-ae03-f959-c15596aef2dd, _)
AND
DB_END_BrainBattle_QueueMindAD(_Character)
THEN
PROC_END_BrainBattle_TryPlayerAD(END_BrainBattle_AD_FirstMindTurn_df46df82-8d06-1e74-59bb-766c7c37d1ea, _Character);

IF
TurnStarted(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759)
AND
GetHitpointsPercentage(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759, _Percentage)
AND
_Percentage < 50.0
AND
QRY_OnlyOnce("END_MindBattle_LowHealthAD")
THEN
SetFlag(END_BrainBattle_Event_LowHealthBrain_10cc92be-132c-00ff-185b-78313f2a0e35, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
EntityEvent((CHARACTER)_Character, "END_MindBattle_TeleportedTo")
AND
NOT DB_END_BrainBattle_QueueMindAD(_Character)
THEN
PROC_END_BrainBattle_TryPlayerAD(END_BrainBattle_AD_FirstMindTurn_df46df82-8d06-1e74-59bb-766c7c37d1ea, _Character);

PROC
PROC_END_BrainBattle_TryPlayerAD((DIALOGRESOURCE)_Dialog, (CHARACTER)_Character)
AND
DB_Players(_Character)
THEN
PROC_TryStartAD(_Dialog, _Character);

PROC
PROC_END_BrainBattle_TryPlayerAD((DIALOGRESOURCE)_Dialog, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
PROC_TryStartAD(_Dialog, NULL_00000000-0000-0000-0000-000000000000, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

PROC
PROC_END_BrainBattle_TryPlayerAD((DIALOGRESOURCE)_Dialog, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
PROC_TryStartAD(_Dialog, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
KilledBy((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _Character, _, _)
AND
DB_Players((CHARACTER)_Character)
THEN
PROC_TryStartAD(END_BrainBattle_AD_KilledEmperor_e4c85c87-41e6-a9bd-aced-bb0223fecfc4, _Character);

IF
KilledBy((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _Character, _, _)
AND
NOT DB_Players((CHARACTER)_Character)
AND
IsCharacter(_Character, 1)
AND
CharacterGetOwner((CHARACTER)_Character, _Player)
AND
DB_Players(_Player)
THEN
PROC_TryStartAD(END_BrainBattle_AD_KilledEmperor_e4c85c87-41e6-a9bd-aced-bb0223fecfc4, _Player);

IF
KilledBy((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _Item, _, _)
AND
IsItem(_Item, 1)
AND
GetOwner((ITEM)_Item, _Player)
AND
DB_Players(_Player)
THEN
PROC_TryStartAD(END_BrainBattle_AD_KilledEmperor_e4c85c87-41e6-a9bd-aced-bb0223fecfc4, _Player);

IF
TurnEnded((CHARACTER)_Character)
AND
DB_END_BrainBattle_ADOnTurn((CHARACTER)_Character)
THEN
RealtimeObjectTimerCancel(_Character, "END_BrainBattle_RapidMindMeld");
NOT DB_END_BrainBattle_ADOnTurn((CHARACTER)_Character);

//END_REGION

//REGION Enemy ADs

IF
UsingSpell(_Daisy, _Spell, _, _, _)
AND
DB_END_BrainBattle_CombatDaisy(_Daisy)
AND
DB_END_BrainBattle_DaisySpells(_Spell, _Flag)
AND
NOT DB_END_BrainBattle_DaisyADBlocked(1)
THEN
DB_END_BrainBattle_DaisyADBlocked(1);
SetFlag(_Flag, _Daisy, 0);
PROC_TryStartAD(END_BrainBattle_AD_DaisySpell_95def1af-6d80-5b5e-fa46-77dd2ab2b81f, _Daisy);

IF
CombatRoundStarted(_, _)
AND
DB_END_BrainBattle_Start(1)
THEN
NOT DB_END_BrainBattle_DaisyADBlocked(1);

IF
TurnStarted(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
AND
NOT DB_PartyMembers(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
AND
DB_END_BrainBattle_Start(1)
THEN
PROC_TryStartAD(END_BrainBattle_AD_EnemyEmperor_bb2a48cc-8c22-0f9e-42a9-0038713a9c96, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

IF
UsingSpellOnTarget(_, S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "Target_END_Mindflayer_CrownDomination", _, _, _)
AND
QRY_OnlyOnce("END_BrainBattle_DominationReaction")
THEN
PROC_LoopEffect(VFX_Script_Brainquake_NoOffset_01_0d5c292e-0eca-5117-bdc5-75a56b1e5eb7, S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_BrainBattle_DominationReaction", "END_Main", "", 1.0);
ObjectTimerLaunch(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_BrainBattle_DominationReaction", 5000);
SetFlag(END_BrainBattle_Event_DominatedCrown_f1fa578a-0b5d-9f1a-033b-e0e9e7c9293b, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_TryStartAD(END_BrainBattle_AD_CrownBeingDominated_2cfbe30d-a1c8-ccfc-b528-b3c2a54cd257, S_END_CrownProxy_b06e8326-a034-4480-8652-6a66b3bd7d0a);

IF
TurnEnded(S_END_MindBattleHelper_be50f7cd-c14a-4131-82d3-29337f3a4759)
THEN
PROC_END_BrainBattle_ProcessEndOfMindBrainTurn();

//Chain didn't break. What happened? Break chain anyway.
PROC
PROC_END_BrainBattle_ProcessEndOfMindBrainTurn()
AND
NOT DB_END_BrainBattle_BrainBrokeChainThisTurn(1)
THEN
PROC_END_BrainBattle_ForceChainRemovalAtTurnEnd();

PROC
PROC_END_BrainBattle_ForceChainRemovalAtTurnEnd()
THEN
PROC_IncreaseCounter("END_BrainBattle_ChainCounter");

PROC
PROC_END_BrainBattle_ForceChainRemovalAtTurnEnd()
AND
DB_GlobalCounter("END_BrainBattle_ChainCounter", _Counter)
AND
DB_END_MindBattle_Chains(_Chain, _Counter)
THEN
RemoveStatus(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, _Chain, NULL_00000000-0000-0000-0000-000000000000);
PROC_END_BrainBattle_CheckMindGameOver(_Counter);

PROC
PROC_END_BrainBattle_ProcessEndOfMindBrainTurn()
AND
DB_END_BrainBattle_BrainBrokeChainThisTurn(1)
THEN
NOT DB_END_BrainBattle_BrainBrokeChainThisTurn(1);

IF
AutomatedDialogStarted(END_BrainBattle_AD_MindBrainTurn_fbc23a61-dd88-ca19-81ed-9578236a9b27, _)
AND
NOT DB_END_BrainBattle_BrainBrokeChainThisTurn(1)
THEN
DB_END_BrainBattle_BrainBrokeChainThisTurn(1);
PROC_IncreaseCounter("END_BrainBattle_ChainCounter");
PROC_END_MindBattle_BreakChain();

PROC
PROC_END_MindBattle_BreakChain()
AND
DB_GlobalCounter("END_BrainBattle_ChainCounter", _Counter)
AND
_Counter > 1
THEN
PlayAnimation(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, (ANIMATION)CUST_BreakingOutOfChains_01_047c1521-ffa3-43b1-89ed-db0c5445cfc5, "");
RealtimeObjectTimerLaunch(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, "END_MindBattle_BreakChainTimer", 2000);

IF
ObjectTimerFinished(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, "END_MindBattle_BreakChainTimer")
AND
DB_GlobalCounter("END_BrainBattle_ChainCounter", _Counter)
AND
DB_END_MindBattle_Chains(_Chain, _Counter)
THEN
RemoveStatus(S_END_MindBrain_f8bb04a3-22e5-41b0-aed7-5dcf852343d1, _Chain, NULL_00000000-0000-0000-0000-000000000000);
PROC_END_BrainBattle_CheckMindGameOver(_Counter);

IF
ObjectTimerFinished(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_BrainBattle_DominationReaction")
THEN
PROC_StopLoopEffect(S_END_Crown_704f1e91-8d56-4772-98d8-54c5d8a6af20, "END_BrainBattle_DominationReaction");
//END_REGION

IF
FlagSet(END_BrainBattle_Event_GaleCompanionTryGod_22bffdc3-3cd8-9f3e-0e73-b04a586e24c3, _, _)
AND
DB_GlobalFlag(ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9)
THEN
SetFlag(ORI_Gale_State_IsGod_ec94f9a4-b032-ce25-f4eb-ecf4ed37d65d, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_END_BrainBattle_Over()
THEN
GoalCompleted;
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3c"
