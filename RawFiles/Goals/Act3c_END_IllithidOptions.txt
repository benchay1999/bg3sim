Version 1
SubGoalCombiner SGC_AND
INITSECTION
PROC_END_RemoveRedundantOrb();
TeleportToPosition(S_END_OrbBoundHelper_002_d825c26a-6004-4dcb-acbc-1de1fa678762, 50.194, -25.149, 3241.005);
TeleportToPosition(S_END_OrbBoundHelper_005_c3ea9213-82f4-4b51-8f97-8528bf9d751e, 50.351, -25.065, 3239.638);
TeleportToPosition(S_END_OrbBoundHelper_006_e2c0aeac-b48f-4108-bff3-bfa5be31654c, 50.307, -25.234, 3241.988);
TeleportToPosition(S_END_OrbBoundHelper_008_13317d06-bd74-43eb-9f18-0ca72ca06353, 51.752, -25.149, 3239.204);

DB_END_IllithiOptions_GlobalNPC((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
DB_END_IllithiOptions_GlobalNPC((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
DB_END_IllithiOptions_GlobalNPC((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

DB_AutoSaveTrigger(S_END_AstralPlaneAutoSave_084d3ab1-ecf9-4da0-963c-cb630a8a8c2d);
DB_AutoSaveTrigger(S_END_SkullAutoSaveBox_36d8afba-d4cd-4a2a-8118-44383b801875);

DB_PermaDefeatedFlag(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, END_IllithidOptions_State_EmperorPermaDefeated_784fecdf-4d89-4e03-9cea-8fa45e1b2897);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)END_IllithidOptions_EmperorProposal_6769199a-452f-5a13-9178-55a899cccf59, (TRIGGER)S_END_AstralArrivalDialogBox_0101ab36-a4fa-4f52-866a-443d3608f436, 1, 1, 1);
DB_DropMutingStatussesDialog(END_IllithidOptions_EmperorProposal_6769199a-452f-5a13-9178-55a899cccf59);

DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704, 1, 1, 1);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_TadpoleGroupDiscussion_55831e5e-9916-4099-a397-37f5e6967d2e,END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_State_ExitPortalAvailable_b97872a1-59cc-40cd-8963-e06be614adc0,END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_State_ExitPortalAvailable_b97872a1-59cc-40cd-8963-e06be614adc0,END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_PlayerOpenedExitPortal_fe639a62-2f2f-441e-a2dc-00761cf7cca3,END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd,END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_State_OrpheusPathLaezelConfrontation_8b03c077-037b-49d4-a8d5-0c50643a5b07,END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb);
SetOnStage(S_END_ResolutionExitPortal_Illithid_2a62d420-290b-47e5-a224-71b5cda70f50,0);
SetOnStage(S_END_ResolutionExitPortal_Orpheus_b86aadd0-1cdd-460b-8c02-63c01a9a612e,0);

PROC_TriggerRegisterForParty(S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704);

DB_END_IllithidOptions_ExitPortals((ITEM)S_END_ResolutionExitPortal_Illithid_2a62d420-290b-47e5-a224-71b5cda70f50);
DB_END_IllithidOptions_ExitPortals((ITEM)S_END_ResolutionExitPortal_Orpheus_b86aadd0-1cdd-460b-8c02-63c01a9a612e);

SetCanJoinCombat(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,0);
SetCanJoinCombat(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,1);
PROC_CharacterDisableAllCrimes(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

TriggerRegisterForCharacter(S_END_MorphicPool_SUB_5a646d13-e9bb-42f0-84e6-1f8fad2bef81, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
TriggerRegisterForCharacter(S_END_MorphicPool_SUB_5a646d13-e9bb-42f0-84e6-1f8fad2bef81, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
TriggerRegisterForCharacter(S_END_MorphicPool_SUB_5a646d13-e9bb-42f0-84e6-1f8fad2bef81, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);
TriggerRegisterForCharacter(S_END_EmperorImmortalArea_80996c6e-72ff-43be-a2f1-53a2f87e929b, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

PROC_TriggerRegisterForPlayers(S_END_AstralArrivalDialogBox_0101ab36-a4fa-4f52-866a-443d3608f436);

DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_State_AcceptedRaphaelDeal_c4d409ef-d70e-9934-edf2-d6bd66201c19,END_IllithidOptions_RaphaelLastChance_e8b41315-b35c-5c7a-e3be-e921cd0c8741);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_RejectedRaphael_b2e6764d-828b-b125-3e9a-365d5fd9737b,END_IllithidOptions_RaphaelLastChance_e8b41315-b35c-5c7a-e3be-e921cd0c8741);

SetDetached(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,1);
ApplyStatus(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,"INT_ORPHEUS_INFERNALBINDSANIM",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,"INT_INFERNALCHAINS_LEFT",-1.0,0,(ITEM)S_END_CrystalShakle_002_75024e98-273c-4967-826c-470ca7ca7879);
ApplyStatus((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,"INT_INFERNALCHAINS_RIGHT",-1.0,0,(ITEM)S_END_CrystalShakle_001_ce41cb70-e763-460c-a368-61011365e589);
SetDoNotFaceFlag(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, 1);
DB_Dialogs(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f);

DB_END_IllithidOptions_CrystalShackles((ITEM)S_END_CrystalShakle_001_ce41cb70-e763-460c-a368-61011365e589, "INT_INFERNALCHAINS_RIGHT");
DB_END_IllithidOptions_CrystalShackles((ITEM)S_END_CrystalShakle_002_75024e98-273c-4967-826c-470ca7ca7879, "INT_INFERNALCHAINS_LEFT");
DB_DialogBlockAttackButton((DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f);

//TODO: Temp solution for walking through orb bounds
DB_END_IllithidOptions_OrbBounds(S_END_OrbBoundHelper_001_039dae0a-8a9c-4ad2-a6c6-432bd8b4799f);
DB_END_IllithidOptions_OrbBounds(S_END_OrbBoundHelper_007_d759dc68-a77e-450a-a8c3-773f4a164527);
DB_END_IllithidOptions_OrbBounds(S_END_OrbBoundHelper_008_13317d06-bd74-43eb-9f18-0ca72ca06353);
DB_END_IllithidOptions_OrbBounds(S_END_OrbBoundHelper_002_d825c26a-6004-4dcb-acbc-1de1fa678762);
DB_END_IllithidOptions_OrbBounds(S_END_OrbBoundHelper_003_4bdb1d7a-884f-4d88-9bd2-0016379b6eb9);
DB_END_IllithidOptions_OrbBounds(S_END_OrbBoundHelper_004_66a7c046-ecc5-4923-81d9-0c696a841e5b);
DB_END_IllithidOptions_OrbBounds(S_END_OrbBoundHelper_005_c3ea9213-82f4-4b51-8f97-8528bf9d751e);
DB_END_IllithidOptions_OrbBounds(S_END_OrbBoundHelper_006_e2c0aeac-b48f-4108-bff3-bfa5be31654c);

DB_END_IllithidOptions_LaezelBetraylCombatID(NULL_00000000-0000-0000-0000-000000000000);

DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_State_OrpheusPathLaezelConfrontation_8b03c077-037b-49d4-a8d5-0c50643a5b07,(DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_OrpheusPathLaezelBetrayed_2be665c6-da32-4e78-bae2-a83fb1b72368,(DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_OrpheusPathLaezelBetrayed_2be665c6-da32-4e78-bae2-a83fb1b72368,(DIALOGRESOURCE)Laezel_InPartyEND_10e8ff26-dea4-7ef3-ff8e-274ecb3e2868);
DB_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_VlaakithPathLaezelBetrayed_9d571d9a-fe2c-41eb-9e2c-2667364f8404, (DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f);

DB_END_IllithidOptions_NegotiatingPlayer((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

PROC_END_IllithidOptions_Setup();
KBSECTION
//REGION DEBUG
IF
TextEvent("end_gotoastralprism")
THEN
PROC_TeleportPartiesTo(S_DEBUG_TeleportIllithidChoice_Arrival_5e9b5e1d-ceab-44a6-9a2f-ccda5ba22c25, "");

IF
TextEvent("end_gotoassimation")
THEN
PROC_TeleportPartiesTo(S_DEBUG_TeleportIllithidChoice_Assimilation_36e1f5a2-fddf-4ad3-9f66-c8e6c68c3192, "");

IF
TextEvent("end_startillithidoptions")
AND
GetHostCharacter(_Player)
THEN
NOT DB_OnlyOnce("END_IllithidOptions_AstralArrival");
DB_END_MorphicPool_ConfrontationSpeaker(_Player);
PROC_END_MorphicPool_PostConfrontationCleanUp();
PROC_TeleportPartiesTo(S_END_ToAstralPlanePoint_66edc6ed-1584-47ac-983c-c6119ea7ddd4, "END_IllithidOptions_PlayersArrived");
TeleportTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,S_END_AstralEmperorPoint_a9932552-8c39-485b-8e5c-0aa8570824a3, "END_IllithidOptions_EmperorArrived");

IF
TextEvent("end_freeorpheus")
THEN
PROC_END_IllithidOptions_FreeOrpheus();

IF
TextEvent("end_toassimilation")
AND
GetHostCharacter(_Player)
THEN
PROC_END_DEBUG_IllithidOptions_Assimilation((CHARACTER)_Player);

PROC
PROC_END_DEBUG_IllithidOptions_Assimilation((CHARACTER)_Player)
THEN
PROC_END_IllithidOptions_SetEmperorScene();
TeleportTo(_Player, S_DEBUG_TeleportIllithidChoice_Assimilation_36e1f5a2-fddf-4ad3-9f66-c8e6c68c3192);
PROC_RemoveDialog(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
TeleportTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_EmperorAssimilationPoint_5bad94db-14cd-4aad-bf03-cc8e3e748e7e, "END_IllithidOptions_ArrivedAtAssimilation");

IF
TextEvent("end_assimilation")
AND
GetHostCharacter(_Player)
THEN
Resurrect(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
Resurrect(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
TeleportTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_EmperorAssimilationPoint_5bad94db-14cd-4aad-bf03-cc8e3e748e7e);
TeleportTo(_Player, S_DEBUG_TeleportIllithidChoice_Assimilation_36e1f5a2-fddf-4ad3-9f66-c8e6c68c3192);
ClearFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961);

IF
TextEvent("end_assimilation")
AND
GetHostCharacter(_Player)
AND
NOT QRY_StartDialog_Fixed(END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb,S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,_Player,S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
DB_NOOP(1);

IF
TextEvent("end_emperorleaving")
AND
GetHostCharacter(_Player)
THEN
PROC_END_DEBUG_IllithidOptions_EmperorLeaving((CHARACTER)_Player);

PROC
PROC_END_DEBUG_IllithidOptions_EmperorLeaving((CHARACTER)_Player)
THEN
SetFlag(END_IllithidOptions_State_ExitPortalAvailable_b97872a1-59cc-40cd-8963-e06be614adc0);
SetFlag(END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb);
SetFlag(END_IllithidOptions_State_ChosenFollowLeader_70668804-535b-4fee-915e-396d1faa3e84, _Player);
PROC_SceneOver("END_IllithidOptions_EmperorScene");
PROC_RemoveDialog(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
Die(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
TeleportTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_OpenExitPortalPoint_c6d5437e-ca42-4fa9-892f-f33a964c091c, "END_IllithidOptions_OpenExitPortal");

IF
TextEvent("end_orpheusleaving")
AND
GetHostCharacter(_Player)
THEN
PROC_END_DEBUG_IllithidOptions_OrpheusLeaving((CHARACTER)_Player);

PROC
PROC_END_DEBUG_IllithidOptions_OrpheusLeaving((CHARACTER)_Player)
THEN
SetFlag(END_IllithidOptions_State_ExitPortalAvailable_b97872a1-59cc-40cd-8963-e06be614adc0);
PROC_SceneOver("END_IllithidOptions_EmperorScene");
PROC_RemoveDialog(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
SetFlag(END_IllithidOptions_State_ChosenFollowLeader_70668804-535b-4fee-915e-396d1faa3e84, _Player);
TeleportTo(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, S_END_OpenExitPortalPoint_c6d5437e-ca42-4fa9-892f-f33a964c091c, "END_IllithidOptions_OpenExitPortal");

IF
TextEvent("end_arrivehighhall")
AND
GetHostCharacter(_Player)
THEN
PROC_END_DEBUG_HighHall_Arrive((CHARACTER)_Player);

PROC
PROC_END_DEBUG_HighHall_Arrive((CHARACTER)_Player)
THEN
DB_END_HighHall_ArrivalUser(_Player);
PROC_TeleportPartiesTo(S_END_HighHallStartPoint_250b3364-3f6a-48dc-aef9-0c82366f352d,"END_ArrivedInHighHall");
SysCompleteGoal("Act3b_END_IllithidOptions");

//Allow to repeat for debug purposes
IF
TextEvent("end_optionsgd")
AND
DB_GroupDiscussion_HasPlayed(END_IllithidOptions_GD_IVB_Undecided_37c12f37-df76-054e-fa2e-eeb6ed62fd15)
THEN
NOT DB_GroupDiscussion_HasPlayed(END_IllithidOptions_GD_IVB_Undecided_37c12f37-df76-054e-fa2e-eeb6ed62fd15);

IF
TextEvent("end_optionsgd")
AND
GetHostCharacter(_Player)
THEN
PROC_GroupDiscussion_InstantStart(_Player, END_IllithidOptions_GD_IVB_Undecided_37c12f37-df76-054e-fa2e-eeb6ed62fd15);

IF
TextEvent("end_morphicpoolreturn")
AND
GetHostCharacter(_Player)
THEN
TriggerUnregisterForPlayers(S_END_NetherbrainConfrontBox_6f265a52-a652-4762-99ba-4c1a9f8b4c06);
PROC_END_MorphicPool_PostConfrontationCleanUp();
SetOnStage(S_END_ToHighHallVines_11f19d26-e595-46c0-9de8-a34cbcc1ff82,1);
PROC_TeleportPartiesTo(S_END_AstralPrismExitPoint_49f5a0f2-0f98-4a54-a295-c40ea8f768d2,"END_IllithidOptions_LeftAstralPrism");

IF
TextEvent("end_getorphichammer")
AND
GetHostCharacter(_Player)
THEN
ToInventory(S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d, _Player, 1, 1, 1);
SetFlag(END_IllithidOptions_State_ArrivedWithOrphicHammer_a350e277-55a7-4e03-9c14-db154b6c682e);
SetFlag((FLAG)END_IllithidOptions_State_PartyHasOrphicHammer_90e5e1a5-2f6b-4b30-948f-c342d6adced5);

IF
TextEvent("end_morphicdestructionon")
THEN
LoadLevelTemplate(S_LT_PLT_END_MorphicPoolDestruction_20ca617c-ede6-460c-bd06-bfd6b945e76e);

IF
TextEvent("end_morphicdestructionoff")
THEN
UnloadLevelTemplate(S_LT_PLT_END_MorphicPoolDestruction_20ca617c-ede6-460c-bd06-bfd6b945e76e);

IF
TextEvent("end_tadpolechoicevb")
AND
DB_GroupDiscussion_HasPlayed(END_IllithidOptions_GD_IVB_TadpoleChoice_b9255477-aea1-edb0-4b17-8518348134ea)
THEN
NOT DB_GroupDiscussion_HasPlayed(END_IllithidOptions_GD_IVB_TadpoleChoice_b9255477-aea1-edb0-4b17-8518348134ea);

IF
TextEvent("end_tadpolechoicevb")
AND
GetHostCharacter(_Avatar)
THEN
PROC_GroupDiscussion_InstantStart(_Avatar, END_IllithidOptions_GD_IVB_TadpoleChoice_b9255477-aea1-edb0-4b17-8518348134ea);

IF
TextEvent("end_orpheuspathlaezel")
AND
GetHostCharacter(_Avatar)
AND
_Avatar != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
THEN
SetFlag(Debug_AddGith_39ecbda9-cb44-becf-57b9-c3b631a5517b, _Avatar);
SetFlag(ORI_State_PartneredWithLaezel_d169a786-6e56-4f0d-a2eb-33c48d8d1160, _Avatar);
SetFlag(ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56);

IF
TextEvent("end_orpheuspathlaezel")
AND
GetHostCharacter(_Avatar)
AND
_Avatar == S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
THEN
SetFlag(ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56);
DebugText(_Avatar, "Lae'zel is avatar, set Orpheus Path flag");

IF
TextEvent("end_orpheuspathlaezel")
AND
GetTextEventParamInteger(1, 1)
AND
GetHostCharacter(_Avatar)
THEN
ToInventory(S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d, _Avatar, 1, 1, 1);
SetFlag(END_IllithidOptions_State_ArrivedWithOrphicHammer_a350e277-55a7-4e03-9c14-db154b6c682e);
SetFlag((FLAG)END_IllithidOptions_State_PartyHasOrphicHammer_90e5e1a5-2f6b-4b30-948f-c342d6adced5);
//END_REGION
//REGION Setup
//Removing redundant Orb of domination left over from Intermezzo (if present)
PROC
PROC_END_RemoveRedundantOrb()
AND
Exists(S_EmperorRevealed_GlobeOfDomination_Small_8950891c-ad3a-434c-a463-615b5ab90ea7, 1)
THEN
TeleportToPosition(S_EmperorRevealed_GlobeOfDomination_Small_8950891c-ad3a-434c-a463-615b5ab90ea7, -1919.0, 0.0, 2687.0);
SetOnStage(S_EmperorRevealed_GlobeOfDomination_Small_8950891c-ad3a-434c-a463-615b5ab90ea7, 0);

//Clear any pesky scenes that might be still active
PROC
PROC_END_IllithidOptions_Setup()
AND
DB_END_IllithiOptions_GlobalNPC(_Char)
AND
DB_SceneManager(_Char, _Scene)
THEN
PROC_SceneOver(_Scene);

PROC
PROC_END_IllithidOptions_Setup()
AND
DB_Is_InCombat(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _ID)
THEN
NOT DB_Is_InCombat(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _ID);

PROC
PROC_END_IllithidOptions_Setup()
THEN
SetFaction(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,(FACTION)ACT3_END_Emperor_9ada321c-7aa0-4390-b725-126d2f53a5a2);
TeleportTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,S_END_AstralEmperorPoint_a9932552-8c39-485b-8e5c-0aa8570824a3, "");
PROC_Foop(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
TeleportTo(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, S_INT_OrpheusPos_13dd190c-9097-4c0e-be8e-1d9a743cbe02);
SetFaction(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,(FACTION)ACT3_END_Orpheus_b3c0e12d-1ed5-4c1a-8beb-02d6e625a1de);
TeleportTo(S_END_MiniDominationOrb_61352825-054d-4ac2-b946-09a10d326edb, S_END_MiniOrbPoint_45205144-10f1-43bd-944a-11dff3be6f70, "", 0, 0, 0, 0, 0);
PROC_SetAnubisConfig(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, "END_Emperor");
PROC_SetAnubisConfig(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, "END_Orpheus");
PROC_CharacterFullRestore(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
PROC_RemoveMutingStatusses(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
PROC_RemoveDialog(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);

IF
EnteredTrigger(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_EmperorImmortalArea_80996c6e-72ff-43be-a2f1-53a2f87e929b)
THEN
SetImmortal(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 1);

IF
LeftTrigger(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_EmperorImmortalArea_80996c6e-72ff-43be-a2f1-53a2f87e929b)
THEN
SetImmortal(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 0);

IF
DB_InRegion(_Char, (TRIGGER)S_END_AstralPrism_SUB_adf44e33-ae27-4186-aff7-84d61dbedcae)
AND
_Char != S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b
THEN
ApplyStatus(_Char, "CRE_ASTRALPRISON_GRAVITY", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
LeftTrigger(_Char, (TRIGGER)S_END_AstralPrism_SUB_adf44e33-ae27-4186-aff7-84d61dbedcae)
AND
_Char != S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b
THEN
RemoveStatus(_Char, "CRE_ASTRALPRISON_GRAVITY", NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION Arrival Dialog
IF
EntityEvent(_Player, "END_IllithidOptions_PlayersArrived")
THEN
RestoreParty((CHARACTER)_Player);
RemoveHarmfulStatuses(_Player);
RemoveStatus(_Player, "END_NETHERBRAIN_SLOW", NULL_00000000-0000-0000-0000-000000000000);

IF
EntityEvent(_Player, "END_IllithidOptions_PlayersArrived")
AND
DB_END_MorphicPool_ConfrontationSpeaker((CHARACTER)_Player)
THEN
DB_END_IllithidOptions_NetherstoneCasterArrived(_Player);
PROC_NotifyWhenReadyToTalk(_Player, "END_IllithidOptions_ArrivalDialogReady");
NOT DB_END_MorphicPool_ConfrontationSpeaker(_Player);
SetFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9);

IF
EntityEvent(_Char, "END_IllithidOptions_PlayersArrived")
AND
GetFlag((FLAG)GLO_Monitor_State_HasOrphicHammer_29842214-5482-dc25-fc89-02e474d7d96b, _Char, 1)
AND
DB_Players(_Player)
AND
IsInInventoryOf(S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d, _Player, 1) //DB_HasItemEvent with the new magic pockets behaviour sets the flag on everyone, even if the item is at camp and the player does not have access to camp
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_ArrivedWithOrphicHammer_a350e277-55a7-4e03-9c14-db154b6c682e)
THEN
SetFlag(END_IllithidOptions_State_ArrivedWithOrphicHammer_a350e277-55a7-4e03-9c14-db154b6c682e);
SetFlag((FLAG)END_IllithidOptions_State_PartyHasOrphicHammer_90e5e1a5-2f6b-4b30-948f-c342d6adced5); //Used to cover both arriving with the hammer and obtaining it from Raphael later, regardless of whether it's currently in player inventory (as long as it's somewhere in the astral plane)

IF
EntityEvent(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, "END_IllithidOptions_EmperorArrived")
THEN
ToInventory(S_END_SupremeTadpole_02a7596f-5dcb-4d2a-93c8-611de53096b5,S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,1,0,1);

IF
DB_END_IllithidOptions_NetherstoneCasterArrived(_Player)
AND
QRY_OnlyOnce("END_General_GivePlayerCombinedStonesOnce")
THEN
PROC_END_General_CombineStones((CHARACTER)_Player);

PROC
PROC_ReadyToTalk(_Player, "END_IllithidOptions_ArrivalDialogReady")
AND
DB_END_IllithidOptions_NetherstoneCasterArrived(_Player)
AND
QRY_OnlyOnce("END_IllithidOptions_AstralArrival")
AND
NOT QRY_StartDialog(END_IllithidOptions_EmperorProposal_6769199a-452f-5a13-9178-55a899cccf59,(CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,_Player)
THEN
NOT DB_END_IllithidOptions_NetherstoneCasterArrived(_Player);
PROC_END_IllithidOptions_SetEmperorScene();

IF
DialogEnded(END_IllithidOptions_EmperorProposal_6769199a-452f-5a13-9178-55a899cccf59, _)
AND
DB_END_IllithidOptions_NetherstoneCasterArrived(_Player)
THEN
NOT DB_END_IllithidOptions_NetherstoneCasterArrived(_Player);
PROC_END_IllithidOptions_SetEmperorScene();
//END_REGION
//REGION Assimilation Dialog
PROC
PROC_END_IllithidOptions_SetEmperorScene()
THEN
PROC_RemoveDialog(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
PROC_CharacterMoveTo((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_EmperorJumpReadyPoint_70aab428-e505-4ba4-9f1d-3d992827c624, "Walk", "END_IllithidOptions_JumptFromPoint");
SetFlag(END_IllithidOptions_State_EmperorMovingToAssimilation_7575a81a-f7dc-43ee-b066-11b75ebbf769);

IF
EntityEvent(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,"END_IllithidOptions_JumptFromPoint")
AND
QRY_OnlyOnce("END_IllithidOptions_NextFlightPoint")
THEN
UseSpell(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,"Projectile_END_Levitate_Emperor", S_END_EmperorJumpToPoint_001_b111d0be-008a-455b-8b38-193100b761f5);

IF 
CastedSpell(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, "Projectile_END_Levitate_Emperor", _, _, _ID)
AND
DB_GlobalFlag(END_IllithidOptions_State_EmperorMovingToAssimilation_7575a81a-f7dc-43ee-b066-11b75ebbf769)
THEN
DB_END_IllithidOptions_EmperorIsTraversing(1);

IF
DB_END_IllithidOptions_EmperorIsTraversing(1)
AND
NOT DB_CantAct(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
THEN
PROC_CharacterMoveTo((CHARACTER)S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, S_END_EmperorAssimilationPoint_5bad94db-14cd-4aad-bf03-cc8e3e748e7e, "Run", "END_IllithidOptions_ArrivedAtAssimilation");

IF
EntityEvent(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,"END_IllithidOptions_ArrivedAtAssimilation")
THEN
ClearFlag(END_IllithidOptions_State_EmperorMovingToAssimilation_7575a81a-f7dc-43ee-b066-11b75ebbf769);
DB_Dialogs(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, (DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb);

PROC
PROC_StartDialog_PreDialogStarted(END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, 1 , _, _, _, _, _, _, _)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
THEN
PROC_ForceStopDialog(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

PROC
PROC_StartDialog_AddExtraSpeakers(END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, _ID)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
THEN
DB_END_IllithidOptions_ReadyOrpheusAsSpeaker(_ID);

//PROC_ForceStopDialog takes too long, causing DB_CantTalk to not be cleared before PROC_StartDialog_AddExtraSpeakers is called
//But DB_CantTalk is still cleared within the window a character can be added as a speaking actor
IF
DB_END_IllithidOptions_ReadyOrpheusAsSpeaker(_ID)
AND
NOT DB_CantTalk(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
NOT DB_END_IllithidOptions_ReadyOrpheusAsSpeaker(_ID);
PROC_DialogAddSpeakingActor(_ID, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
FlagSet(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961, _, _)
THEN
SetDetached(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, 0); 
SetCharacterLootable(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, 1); //Setting just in case it's blocked from intermezzo
DB_DialogDeath(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
DB_GLO_CharacterCorpseDialog(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,END_IllithidOptions_Orpheus_Dead_7e5dfbb4-e9dc-e049-8ff0-6cf524b9e33f);
Die(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

IF
FlagSet(END_IllithidOptions_State_MiniDominationOrbRemoved_05db0c72-bfc8-45a9-8c29-04d11eaa986b, _, _)
THEN
PROC_END_IllithidOptions_ClearOrbBounds();
SetOnStage(S_END_MiniDominationOrb_61352825-054d-4ac2-b946-09a10d326edb, 0);
SetDetached(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,0);

PROC
PROC_END_IllithidOptions_ClearOrbBounds()
AND
DB_END_IllithidOptions_OrbBounds(_Helper)
THEN
SetOnStage(_Helper, 0);

//Event flag is eventually cleared, so use state flag to check if they already discussed or not
IF
FlagSet(END_IllithidOptions_Event_TadpoleGroupDiscussion_55831e5e-9916-4099-a397-37f5e6967d2e, _, _)
THEN
SetFlag(END_IllithidOptions_State_DiscussedOptions_0cbca6d6-8b48-455d-9c1e-f67cbc3f7735);

//END_REGION
//REGION Lae'zel Betrayal (Orpheus or Vlaakith Path)
IF
FlagSet(END_IllithidOptions_State_OrpheusPathLaezelConfrontation_8b03c077-037b-49d4-a8d5-0c50643a5b07, _, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_END_IllithidOptions_UpdateNegotiatingPlayer((CHARACTER)_Player);

IF
FlagSet(END_IllithidOptions_Event_VlaakithPathLaezelBetrayed_9d571d9a-fe2c-41eb-9e2c-2667364f8404, _, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_END_IllithidOptions_UpdateNegotiatingPlayer((CHARACTER)_Player);

IF
FlagSet(END_IllithidOptions_Event_OrpheusPathLaezelBetrayed_2be665c6-da32-4e78-bae2-a83fb1b72368, _, _ID)
AND
DB_DialogPlayers(_ID, _Player, 1)
THEN
PROC_END_IllithidOptions_UpdateNegotiatingPlayer((CHARACTER)_Player);

PROC
PROC_END_IllithidOptions_UpdateNegotiatingPlayer((CHARACTER)_NewPlayer)
AND
DB_END_IllithidOptions_NegotiatingPlayer(_OldPlayer)
AND
_NewPlayer != _OldPlayer
THEN
NOT DB_END_IllithidOptions_NegotiatingPlayer(_OldPlayer);
DB_END_IllithidOptions_NegotiatingPlayer(_NewPlayer);

PROC
PROC_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_VlaakithPathLaezelBetrayed_9d571d9a-fe2c-41eb-9e2c-2667364f8404)
THEN
PROC_END_IllithidOptions_BetrayedLaezel();

PROC
PROC_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_OrpheusPathLaezelBetrayed_2be665c6-da32-4e78-bae2-a83fb1b72368)
THEN
PROC_END_IllithidOptions_BetrayedLaezel();

//In the edge-case Lae'zel was not available in the Orpheus Freed dialog when the decision was made to side with Orpheus (Vlaakith Lae'zel), she will wait to kill Orpheus till Brain Battle Over
IF
DialogEnded(END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, _)
AND
DB_GlobalFlag(END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb) //So nothing happens while he is still locked up
AND
NOT DB_GlobalFlag(ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_TookMomentToChoose_4fc3d679-7bd5-4a2f-9175-4d5c028ed185) //Decision has not been made yet 
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_VlaakithPathLaezelBetrayed_9d571d9a-fe2c-41eb-9e2c-2667364f8404)
AND
NOT DB_GlobalFlag(ORI_Laezel_State_VlaakithPathOrpheusAlly_0a57a2d4-f61d-84b2-547a-99afcdd8ba98)
THEN
SetFlag(ORI_Laezel_State_VlaakithPathOrpheusAlly_0a57a2d4-f61d-84b2-547a-99afcdd8ba98);

//In case dialog is inturrupted before conlcuding
PROC
PROC_GlobalFlagReactionAfterDialog(END_IllithidOptions_State_OrpheusPathLaezelConfrontation_8b03c077-037b-49d4-a8d5-0c50643a5b07)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_SwayedLaezelForAssimilation_873e4e9d-8042-78d7-8275-666bd92be830)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_SidedWithLaezel_cd242512-90ba-4cd5-9b24-4e745b3a342c)
THEN
PROC_END_IllithidOptions_BetrayedLaezel();

PROC
PROC_END_IllithidOptions_BetrayedLaezel()
AND
NOT DB_END_IllithidOptions_LaezelBetrayed(1)
AND
DB_END_IllithidOptions_NegotiatingPlayer(_Player)
THEN
DB_END_IllithidOptions_LaezelBetrayed(1);
PROC_SceneOver("END_IllithidOptions_EmperorScene");
PROC_SceneOver("END_IllithidOptions_OrpheusScene");
PROC_END_IllithidOptions_LaezelTurnsHostile();

PROC_SetRelationToPlayers((FACTION)Origin_Laezel_bee8449b-d682-93c8-e7da-9e4bad369476, 0);
DB_CombatReact_AD_OnDeath(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, END_General_AD_LaezelBetrayedDeath_e8064996-c2f9-9c53-7540-f6f23dc66c19);

PROC
PROC_END_IllithidOptions_LaezelTurnsHostile()
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "TurnedHostile_MorphicPool_OrpheusPath");

PROC
PROC_END_IllithidOptions_LaezelTurnsHostile()
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_IsOnOrpheusPath_97244ccc-a6b5-403e-9cfe-a3502eb4af56)
THEN
PROC_Origins_CompanionLeavePermanently((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "TurnedHostile_MorphicPool_VlaakithPath");

PROC
PROC_GLO_PartyMembers_MakeNPCHook(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_END_IllithidOptions_LaezelBetrayed(1)
AND
DB_END_IllithidOptions_NegotiatingPlayer(_Player)
THEN
PROC_EnterCombat(_Player, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12);

IF
EnteredCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _NewCombatID)
AND
DB_END_IllithidOptions_LaezelBetrayed(1)
AND
DB_END_IllithidOptions_LaezelBetraylCombatID(_OldCombatID)
THEN
NOT DB_END_IllithidOptions_LaezelBetraylCombatID(_OldCombatID);
DB_END_IllithidOptions_LaezelBetraylCombatID(_NewCombatID);

IF
SwitchedCombat(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, _OldCombatID, _NewCombatID)
AND
DB_END_IllithidOptions_LaezelBetrayed(1)
AND
DB_END_IllithidOptions_LaezelBetraylCombatID(_OldCombatID)
THEN
NOT DB_END_IllithidOptions_LaezelBetraylCombatID(_OldCombatID);
DB_END_IllithidOptions_LaezelBetraylCombatID(_NewCombatID);

IF
CombatEnded(_CombatID)
AND
DB_END_IllithidOptions_LaezelBetraylCombatID(_CombatID)
AND
DB_PermaDefeated(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
DB_END_IllithidOptions_LaezelBetrayed(1)
THEN
PROC_END_IllithidOptions_BetrayedLaezelPermaDefeated();

PROC
PROC_END_IllithidOptions_BetrayedLaezelPermaDefeated()
AND
NOT DB_PermaDefeated(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
THEN
PROC_END_IllithidOptions_SetEmperorScene();

PROC
PROC_END_IllithidOptions_BetrayedLaezelPermaDefeated()
AND
DB_GlobalFlag(END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_OrpheusHostile_779f9ca6-4436-46dc-9e68-cb97e9ea1172)
THEN
PROC_END_IllithidOptions_SetOrpheusScene();
//END_REGION
//REGION Emperor Betrayed
PROC
PROC_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
THEN
PROC_END_IllithidOptions_EmperorEscapeToNetherbrain();

PROC
PROC_END_IllithidOptions_EmperorBetrayed((CHARACTER)_Player)
AND
DB_Players(_Player)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd) //Did not already have context provided in another dialog
AND
NOT DB_OnlyOnce("END_IllithidOptions_EmperorBetrayedOnce")
AND
QRY_StartDialogCustom(END_IllithidOptions_EmperorBetrayal_fdb71668-eb81-26e6-1341-50f351b796f8, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _Player, 0, 0, 0, 0)
THEN
DB_OnlyOnce("END_IllithidOptions_EmperorBetrayedOnce");

PROC
PROC_END_IllithidOptions_EmperorBetrayed((CHARACTER)_Char)
AND
NOT DB_Players(_Char)
AND
DB_PlayerSummons(_Char)
AND
CharacterGetOwner(_Char, _Owner)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd) 
AND
NOT DB_OnlyOnce("END_IllithidOptions_EmperorBetrayedOnce")
AND
QRY_StartDialogCustom(END_IllithidOptions_EmperorBetrayal_fdb71668-eb81-26e6-1341-50f351b796f8, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _Owner, 0, 0, 0, 0)
THEN
DB_OnlyOnce("END_IllithidOptions_EmperorBetrayedOnce");

PROC
PROC_END_IllithidOptions_EmperorBetrayed((CHARACTER)_Char)
AND
QRY_GetClosestAvailableCharacterTo(_Char, 0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar, _, _, _)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd) 
AND
NOT DB_OnlyOnce("END_IllithidOptions_EmperorBetrayedOnce")
AND
QRY_StartDialogCustom(END_IllithidOptions_EmperorBetrayal_fdb71668-eb81-26e6-1341-50f351b796f8, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _ClosestAvatar, 0, 0, 0, 0)
THEN
DB_OnlyOnce("END_IllithidOptions_EmperorBetrayedOnce");

PROC
PROC_END_IllithidOptions_EmperorBetrayed((CHARACTER)_Char)
AND
NOT DB_OnlyOnce("END_IllithidOptions_EmperorBetrayedOnce")
THEN
DB_OnlyOnce("END_IllithidOptions_EmperorBetrayedOnce");
PROC_END_IllithidOptions_EmperorEscapeToNetherbrain();

IF
DialogEnded(END_IllithidOptions_EmperorBetrayal_fdb71668-eb81-26e6-1341-50f351b796f8, _)
THEN
PROC_END_IllithidOptions_EmperorEscapeToNetherbrain();

PROC
PROC_END_IllithidOptions_EmperorEscapeToNetherbrain()
AND
QRY_OnlyOnce("END_IllithidOptions_EmperorLeftOnce")
THEN
PROC_AddCharactersInTriggerToDialog_Clear((DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704);
PROC_GlobalSetFlagAndCache(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd);
PROC_Poof(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, (EFFECTRESOURCE)VFX_Script_Emperor_Teleport_3772280c-c094-0b63-602e-2ad6045ec800);
SetHitpointsPercentage(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 100.0);
PROC_END_IllithidOptions_CheckEmperorLeftThrallOfTheAbsolute();
PROC_END_IllithidOptions_FallbackPortalCheck();
PROC_END_IllithidOptions_TryRaphaelLastChance();

PROC
PROC_END_IllithidOptions_FallbackPortalCheck()
AND
DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961) //If Orpheus is not assimilated, proceed with normal flow
AND
QRY_END_IllithidOptions_PlayerCanOpenPortal()
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_ExitPortalAvailable_b97872a1-59cc-40cd-8963-e06be614adc0)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_PlayerOpenedExitPortal_fe639a62-2f2f-441e-a2dc-00761cf7cca3)
THEN
SetFlag(END_IllithidOptions_Event_PlayerOpenedExitPortal_fe639a62-2f2f-441e-a2dc-00761cf7cca3);
PROC_END_IllithidOptions_OpenExitPortal((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_END_IllithidOptions_PlayerCanOpenPortal()
AND
DB_GlobalFlag(END_General_State_SupremeTadpoleAvailable_0177c452-90cc-4c29-83b8-4acaa2902b27)
THEN
DB_NOOP(1);

QRY
QRY_END_IllithidOptions_PlayerCanOpenPortal()
AND
DB_GlobalFlag(END_General_State_PlayerIsMindFlayer_d138f537-2268-49a6-8dc4-256bd9cf5633)
THEN
DB_NOOP(1);

PROC
PROC_END_IllithidOptions_CheckEmperorLeftThrallOfTheAbsolute()
AND
QRY_END_IllithidOptions_EmperorIsRequiredToContinue()
AND
QRY_GLO_ThrallOfTheAbsolute_GetNearestTadpoledPlayer(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b)
AND
DB_QRYRTN_GLO_ThrallOfTheAbsolute_NearestPlayer(_SelectedPlayer, _)
THEN
SetOnStage(S_END_ResolutionExitPortal_Illithid_2a62d420-290b-47e5-a224-71b5cda70f50, 0);
SetFlag(GLO_ThrallOfTheAbsolute_Event_AstralPrism_4d658c40-92a9-4c2b-9828-acc604789025, _SelectedPlayer);

QRY
QRY_END_IllithidOptions_EmperorIsRequiredToContinue()
AND
GetFlag(END_IllithidOptions_State_AssimilatorOfOrpheus_56989e8b-cca9-4f3b-aece-26a389e3b6ee, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 1) 
THEN
DB_NOOP(1);

QRY
QRY_END_IllithidOptions_EmperorIsRequiredToContinue()
AND
DB_GlobalFlag(END_IllithidOptions_State_GaveStones_18e3be1a-c1c0-437e-ad0a-a1426d8830f4) 
THEN
DB_NOOP(1);


PROC
PROC_END_IllithidOptions_SetEmperorScene()
THEN
DB_SceneTriggerManager("END_IllithidOptions_EmperorScene", (TRIGGER)S_END_AstralPrism_SUB_adf44e33-ae27-4186-aff7-84d61dbedcae);
DB_SceneManager(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, "END_IllithidOptions_EmperorScene");

PROC
PROC_SceneInterrupted((GUIDSTRING)_,(CHARACTER)_Player,"END_IllithidOptions_EmperorScene",(STRING)_Reason)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
THEN
ReadyCheckCancel("END_ReadyCheck_LeaveAstralPrism");
PROC_SceneOver("END_IllithidOptions_EmperorScene");
PROC_ForceStopDialog(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
PROC_END_IllithidOptions_EmperorBetrayed((CHARACTER)_Player);

//END_REGION
//REGION Raphael
PROC
PROC_END_IllithidOptions_TryRaphaelLastChance()
AND
NOT QRY_END_IllithidOptions_RaphaelCanAppear()
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
AND
GetClosestAlivePlayer(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Player, _)
AND
QRY_OnlyOnce("END_IllithidOptions_NoRaphaelVBOnce")
THEN
PROC_END_IllithidOptions_CheckNoMoreOptionsLeft((CHARACTER)_Player);
PROC_NotifyWhenReadyToMoveOn(_Player, "END_IllithidOptions_ReadyForRaphaelVB");

PROC
PROC_END_IllithidOptions_TryRaphaelLastChance()
AND
QRY_END_IllithidOptions_RaphaelCanAppear()
AND
GetClosestAlivePlayer(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Player, _)
THEN
SetFlag(END_IllithidOptions_Event_RaphaelAppeared_9cfb6023-25e5-4ae4-899f-d6142c7f1be0);
DB_SceneManager(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "END_IllithidOptions_RaphaelScene");
PROC_NotifyWhenReadyToMoveOn(_Player, "END_IllithidOptions_ReadyForRaphaelVB");

QRY
QRY_END_IllithidOptions_RaphaelCanAppear()
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_RaphaelAppeared_9cfb6023-25e5-4ae4-899f-d6142c7f1be0)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_ArrivedWithOrphicHammer_a350e277-55a7-4e03-9c14-db154b6c682e) //Player arrived without the hammer
AND
NOT DB_PermaDefeated(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8) //If hammer was stolen, Raphael should be dead in House of Hope
AND
NOT DB_GlobalFlag(END_General_State_SupremeTadpoleAvailable_0177c452-90cc-4c29-83b8-4acaa2902b27) //Supreme tadpole was never given
AND
NOT DB_GlobalFlag(END_General_State_PlayerIsMindFlayer_d138f537-2268-49a6-8dc4-256bd9cf5633) //Player didn't already transform
THEN
DB_NOOP(1);

PROC
PROC_ReadyToMoveOn(_Player, "END_IllithidOptions_ReadyForRaphaelVB")
THEN
StartVoiceBark((VOICEBARKRESOURCE)END_IllithidOptions_VB_OutOfOptions_91349046-4e96-2b6f-2972-f3668adba848, _Player);

IF
VoiceBarkEnded(END_IllithidOptions_VB_OutOfOptions_91349046-4e96-2b6f-2972-f3668adba848, _)
AND
DB_GlobalFlag(END_IllithidOptions_Event_RaphaelAppeared_9cfb6023-25e5-4ae4-899f-d6142c7f1be0)
THEN
PROC_END_IllithidOptions_ReadyRaphael();

IF
VoiceBarkFailed(END_IllithidOptions_VB_OutOfOptions_91349046-4e96-2b6f-2972-f3668adba848)
AND
DB_GlobalFlag(END_IllithidOptions_Event_RaphaelAppeared_9cfb6023-25e5-4ae4-899f-d6142c7f1be0)
THEN
PROC_END_IllithidOptions_ReadyRaphael();

PROC
PROC_END_IllithidOptions_ReadyRaphael()
THEN
PROC_RemoveDialog(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);
DB_Dialogs(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,END_IllithidOptions_RaphaelLastChance_e8b41315-b35c-5c7a-e3be-e921cd0c8741);
TeleportTo(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, S_END_LastChanceRaphaelPoint_9926cf49-968c-47e0-9d06-9f2e74a2d543, "END_IllithidOptions_RaphaelArrived");

IF
EntityEvent(_, "END_IllithidOptions_RaphaelArrived")
THEN
PROC_GLO_Monitor_Foop();
PROC_TryStartAD(END_IllithidOptions_AD_RaphaelAppears_92f13332-efa3-cfcf-9f7a-59af21f5d4eb, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

IF
FlagSet(END_IllithidOptions_Event_SpawnOrphicHammer_2d25bebd-6165-7a13-96b3-fabe32d2a627, _Player, _)
THEN
ToInventory(S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d, _Player, 1, 1, 1);

IF
FlagSet(END_IllithidOptions_Event_SpawnOrphicHammer_2d25bebd-6165-7a13-96b3-fabe32d2a627, _Player, _)
AND
NOT DB_GlobalFlag((FLAG)END_IllithidOptions_State_PartyHasOrphicHammer_90e5e1a5-2f6b-4b30-948f-c342d6adced5)
THEN
SetFlag((FLAG)END_IllithidOptions_State_PartyHasOrphicHammer_90e5e1a5-2f6b-4b30-948f-c342d6adced5);

PROC
PROC_GlobalFlagReactionAfterDialog(END_IllithidOptions_State_AcceptedRaphaelDeal_c4d409ef-d70e-9934-edf2-d6bd66201c19)
THEN
PROC_GLO_Monitor_Poof();
PROC_SceneOver("END_IllithidOptions_RaphaelScene");

PROC
PROC_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_RejectedRaphael_b2e6764d-828b-b125-3e9a-365d5fd9737b)
AND
GetClosestAlivePlayer(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _Player, _)
THEN
PROC_END_IllithidOptions_RaphaelExit((CHARACTER)_Player);
PROC_SceneOver("END_IllithidOptions_RaphaelScene");

PROC
PROC_SceneInterrupted((GUIDSTRING)_,(CHARACTER)_Player,"END_IllithidOptions_RaphaelScene",(STRING)_Reason)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
THEN
PROC_GlobalSetFlagAndCache(END_IllithidOptions_Event_RejectedRaphael_b2e6764d-828b-b125-3e9a-365d5fd9737b);
PROC_END_IllithidOptions_RaphaelExit((CHARACTER)_Player);

QRY
QRY_DialogAttackRequested_CustomResponse((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (CHARACTER)_Player)
AND
DB_DialogName((DIALOGRESOURCE)END_IllithidOptions_RaphaelLastChance_e8b41315-b35c-5c7a-e3be-e921cd0c8741, _DialogID)
AND
DB_DialogPlayers(_DialogID, _Player, _)
THEN
PROC_GlobalSetFlagAndCache(END_IllithidOptions_Event_RejectedRaphael_b2e6764d-828b-b125-3e9a-365d5fd9737b);
PROC_END_IllithidOptions_RaphaelExit((CHARACTER)_Player);

PROC
PROC_END_IllithidOptions_RaphaelExit((CHARACTER)_Player)
AND
QRY_OnlyOnce("END_IllithidOptions_RaphaelLeftOnce")
THEN
PROC_SceneOver("END_IllithidOptions_RaphaelScene");
PROC_ForceStopDialog(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);
PROC_GLO_Monitor_Poof();
PROC_END_IllithidOptions_CheckNoMoreOptionsLeft((CHARACTER)_Player);
//END_REGION
//REGION Freeing Orpheus
IF
UseFinished(_Player, S_END_MiniDominationOrb_61352825-054d-4ac2-b946-09a10d326edb, 1)
AND
DB_Players(_Player)
AND
QRY_END_IllithidOptions_EmperorAssimilationCanOverride((CHARACTER)_Player)
AND
NOT QRY_StartDialog_Fixed(END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _Player)
THEN
PROC_PlayCantUseItemAD(_Player);

IF
UseFinished(_Player, S_END_MiniDominationOrb_61352825-054d-4ac2-b946-09a10d326edb, 1)
AND
DB_Players(_Player)
AND
NOT QRY_END_IllithidOptions_EmperorAssimilationCanOverride((CHARACTER)_Player)
AND
NOT QRY_StartDialog_Fixed(END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Player)
THEN
PROC_PlayCantUseItemAD(_Player);

//Start Emperor Assimilation dialog if he's not betrayed yet when starting dialog with Orpheus chained up
QRY
QRY_SelectCustomDialog_AfterGenerics(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Player)
AND
QRY_END_IllithidOptions_EmperorAssimilationCanOverride((CHARACTER)_Player)
THEN
DB_SelectedDialog((DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _Player);

QRY
QRY_END_IllithidOptions_EmperorAssimilationCanOverride((CHARACTER)_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, _Player)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
DB_GlobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb)
THEN
DB_NOOP(1);
//Shackles
IF
StatusApplied(_Item, "END_ORPHICHAMMER_BREAKSHACKLES", _Causee, _)
AND
DB_END_IllithidOptions_CrystalShackles((ITEM)_Item, _)
THEN
PlayEffect(_Item, VFX_Status_NAT_Rock_Granite_Boulder_Big_360_H_Crystal_Overlay_01_3760be48-84db-afa2-afe1-f4ba5fd8df17, "", 1.0);
PROC_END_IllithidOptions_BreakCrystal((CHARACTER)_Causee, _Item);

PROC
PROC_END_IllithidOptions_BreakCrystal((CHARACTER)_Causee, (ITEM)_Item)
THEN
DB_END_IllithidOptions_OrphicHammerAttacker(_Causee);
RealtimeObjectTimerLaunch(_Item, "END_IllithidOptions_BreakCrystalsTimer", 2000);

PROC
PROC_END_IllithidOptions_BreakCrystal((CHARACTER)_Causee, (ITEM)_Item)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
THEN
PROC_END_IllithidOptions_EmperorBetrayed(_Causee);

IF
DB_END_IllithidOptions_OrphicHammerAttacker(_NewCausee)
AND
DB_END_IllithidOptions_OrphicHammerAttacker(_OldCausee)
AND
_NewCausee != _OldCausee
THEN 
NOT DB_END_IllithidOptions_OrphicHammerAttacker(_OldCausee);

IF
ObjectTimerFinished(_Item, "END_IllithidOptions_BreakCrystalsTimer")
AND
DB_END_IllithidOptions_CrystalShackles((ITEM)_Item, _ShackleStatus)
THEN
Die(_Item); 
RemoveStatus(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _ShackleStatus, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_END_IllithidOptions_CrystalShackles(_Item, _ShackleStatus);
PROC_END_IllithidOptions_TryFreeOrpheus();

PROC
PROC_END_IllithidOptions_TryFreeOrpheus()
AND
NOT DB_END_IllithidOptions_CrystalShackles(_, _)
THEN
PROC_END_IllithidOptions_FreeOrpheus();

IF
AttackedBy(S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d, _AttackerOwner, _, _, _, "InventoryThrow", _ID)
THEN
DB_END_IllithidOptions_OrphicHammerThrower(_AttackerOwner, _ID);

IF
DB_END_IllithidOptions_OrphicHammerThrower(_AttackerOwner, _ID)
AND
DB_END_IllithidOptions_OrphicHammerThrower(_OldAttackerOwner, _OldID)
AND
_ID != _OldID
THEN
NOT DB_END_IllithidOptions_OrphicHammerThrower(_OldAttackerOwner, _OldID);

IF
AttackedBy(_Item, _AttackerOwner, _, _, _, "InventoryThrow", _ID)
AND
DB_END_IllithidOptions_CrystalShackles((ITEM)_Item, _)
AND
DB_END_IllithidOptions_OrphicHammerThrower(_AttackerOwner, _ID)
AND
HasActiveStatus(_Item, "END_ORPHICHAMMER_BREAKSHACKLES", 0)
THEN
ApplyStatus(_Item,"END_ORPHICHAMMER_BREAKSHACKLES", -1.0, 1, _AttackerOwner);

PROC
PROC_END_IllithidOptions_FreeOrpheus()
AND
NOT DB_PermaDefeated(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
DB_END_IllithidOptions_OrphicHammerAttacker(_Causee)
AND
NOT DB_Players((CHARACTER)_Causee)
AND
QRY_GetClosestAvailableCharacterTo(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Player,S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b,_,1)
THEN
PROC_END_IllithidOptions_EmperorBetrayed((CHARACTER)_Player);
NOT DB_END_IllithidOptions_OrphicHammerAttacker(_Causee);
DB_END_IllithidOptions_OrphicHammerAttacker(_Player);
PROC_END_IllithidOptions_RaphaelExit((CHARACTER)_Player);

PROC
PROC_END_IllithidOptions_FreeOrpheus()
AND
NOT DB_PermaDefeated(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
THEN
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704, 1, 1, 1);
RemoveStatus(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,"INT_ORPHEUS_INFERNALBINDSANIM", NULL_00000000-0000-0000-0000-000000000000);
NOT DB_DialogBlockAttackButton((DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f);
SetFlag(END_IllithidOptions_State_MiniDominationOrbRemoved_05db0c72-bfc8-45a9-8c29-04d11eaa986b);
SetDoNotFaceFlag(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, 0);
SetDetached(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,0);
RemoveStatus(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,"INT_ORPHEUS_INFERNALPROTECTION", NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(END_IllithidOptions_Event_TookMomentToChoose_4fc3d679-7bd5-4a2f-9175-4d5c028ed185);
SetCanJoinCombat(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,1);
SetCanFight(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,1);
PROC_CharacterEnableAllCrimes(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
PROC_GlobalSetFlagAndCache(END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb);
PROC_END_IllithidOptions_SetOrpheusScene();
PROC_END_IllithidOptions_TryEmperorFreedDialog();

PROC
PROC_END_IllithidOptions_FreeOrpheus()
AND
GetEquippedItem((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,"Gloves",(ITEM)_Gloves)
AND
GetEquippedItem((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,"Helmet",(ITEM)_Helmet)
THEN
Unequip(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,_Gloves);
Unequip(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e,_Helmet);

//Try player who broke crystals if they are avatar
PROC
PROC_END_IllithidOptions_TryEmperorFreedDialog()
AND
DB_END_IllithidOptions_OrphicHammerAttacker(_Causee)
AND
DB_Avatars(_Causee)
AND
NOT DB_CantTalk(_Causee)
AND
QRY_StartDialog_Fixed(END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Causee)
THEN
DB_END_IllithidOptions_OrpheusFreedDialogStarted(1);

//Try nearest available avatar
PROC
PROC_END_IllithidOptions_TryEmperorFreedDialog()
AND
QRY_GetClosestAvailableCharacterTo(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, 0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_ClosestAvatar, _, _Dist, 1)
AND
_Dist <= 30 
AND
NOT DB_END_IllithidOptions_OrpheusFreedDialogStarted(1)
AND
QRY_StartDialog_Fixed(END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _ClosestAvatar)
THEN
DB_END_IllithidOptions_OrpheusFreedDialogStarted(1);

//Try any avatar within range
PROC
PROC_END_IllithidOptions_TryEmperorFreedDialog()
AND
DB_Avatars(_Player)
AND
NOT DB_CantTalk(_Player)
AND
GetDistanceTo(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Player, _Dist)
AND
_Dist <= 30
AND
NOT DB_END_IllithidOptions_OrpheusFreedDialogStarted(1)
AND
QRY_StartDialog_Fixed(END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Player)
THEN
DB_END_IllithidOptions_OrpheusFreedDialogStarted(1);

//Try companion if they broke the crystals and are not Lae'zel
PROC
PROC_END_IllithidOptions_TryEmperorFreedDialog()
AND
DB_END_IllithidOptions_OrphicHammerAttacker(_Causee)
AND
NOT DB_Avatars(_Causee)
AND
_Causee != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12 //Use companion Lae'zel as a last resort
AND
NOT DB_CantTalk(_Causee)
AND
NOT DB_END_IllithidOptions_OrpheusFreedDialogStarted(1)
AND
NOT QRY_StartDialog_Fixed(END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Causee)
THEN
DB_END_IllithidOptions_OrpheusFreedDialogStarted(1);

//Try companion that is not Lae'zel within range
PROC
PROC_END_IllithidOptions_TryEmperorFreedDialog()
AND
DB_Players(_Player)
AND
NOT DB_Avatars(_Player)
AND
_Player != S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12
AND
NOT DB_CantTalk(_Player)
AND
GetDistanceTo(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Player, _Dist)
AND
_Dist <= 30
AND
NOT DB_END_IllithidOptions_OrpheusFreedDialogStarted(1)
AND
QRY_StartDialog_Fixed(END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Player)
THEN
DB_END_IllithidOptions_OrpheusFreedDialogStarted(1);

//Try Lae'zel if she brokes the crystal
PROC
PROC_END_IllithidOptions_TryEmperorFreedDialog()
AND
DB_END_IllithidOptions_OrphicHammerAttacker(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_CantTalk(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
AND
NOT DB_END_IllithidOptions_OrpheusFreedDialogStarted(1)
AND
NOT QRY_StartDialog_Fixed(END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12)
THEN
DB_END_IllithidOptions_OrpheusFreedDialogStarted(1);

//Put Avatar party mind flayer in reserved speaker slot for cinematic purposes
PROC
PROC_StartDialog_AddExtraSpeakers(END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, _ID)
AND
QRY_END_IllithidOptions_OrpheusFreedLocallyAddingAvatarMindFlayerSpeaker()
AND
DB_END_General_PartyMindFlayer(_PlayerMF)
AND
QRY_END_IllithidOptions_IsAvatarOrKarlachMindFlayer((CHARACTER)_PlayerMF)
AND
IsSpeakerReserved(_PlayerMF, 0) //Make sure they are not already reserved (example, they started the dialog)
AND
GetDistanceTo(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _PlayerMF, _Dist)
AND
_Dist <= 30
THEN
PROC_DialogAddSpeakingActorAt(_ID, _PlayerMF, 5);

//Let above block handle adding party mind flayer
QRY
QRY_ShouldNotAddCharacterInTriggerToDialog((CHARACTER)_Player,(DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f,(TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704)
AND
QRY_END_IllithidOptions_IsAvatarOrKarlachMindFlayer((CHARACTER)_Player)
AND
QRY_END_IllithidOptions_OrpheusFreedLocallyAddingAvatarMindFlayerSpeaker()
THEN
DB_NOOP(1);

QRY
QRY_END_IllithidOptions_IsAvatarOrKarlachMindFlayer((CHARACTER)_Player)
AND
DB_END_General_PartyMindFlayer(_Player)
AND
DB_Avatars(_Player)
THEN
DB_NOOP(1);

QRY
QRY_END_IllithidOptions_IsAvatarOrKarlachMindFlayer((CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
DB_END_General_PartyMindFlayer(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
AND
NOT DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c)
THEN
DB_NOOP(1);

QRY
QRY_END_IllithidOptions_OrpheusFreedLocallyAddingAvatarMindFlayerSpeaker()
AND
DB_GlobalFlag(END_General_State_PlayerIsMindFlayer_d138f537-2268-49a6-8dc4-256bd9cf5633)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_ExitPortalAvailable_b97872a1-59cc-40cd-8963-e06be614adc0)
AND
DB_GlobalFlag(END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb)
THEN
DB_NOOP(1);

PROC
PROC_SceneInterrupted((GUIDSTRING)_,(CHARACTER)_Player,"END_IllithidOptions_OrpheusScene",(STRING)_Reason)
AND
DB_PartyMembers(_Player)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Reason)
AND
GetFaction(_Player, _PlayerFaction)
THEN
SetFlag(EEND_IllithidOptions_State_OrpheusHostile_779f9ca6-4436-46dc-9e68-cb97e9ea1172);
PROC_SceneOver("END_IllithidOptions_OrpheusScene");
PROC_ForceStopDialog(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
SetHostileAndEnterCombat((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, (FACTION)ACT3_END_Orpheus_b3c0e12d-1ed5-4c1a-8beb-02d6e625a1de, _Player, S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);
PROC_SetRelationToPlayers((FACTION)ACT3_END_Orpheus_b3c0e12d-1ed5-4c1a-8beb-02d6e625a1de, 0);

IF
FlagSet(END_IllithidOptions_State_OrpheusHostile_779f9ca6-4436-46dc-9e68-cb97e9ea1172, _, _)
AND
DB_GlobalFlag(END_IllithidOptions_State_ExitPortalAvailable_b97872a1-59cc-40cd-8963-e06be614adc0)
THEN
ReadyCheckCancel("END_ReadyCheck_LeaveAstralPrism");

IF
KilledBy(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _Player, _, _StoryID)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
AND
NOT DB_END_General_ExtractBrainCastID(_, _StoryID)
THEN
PROC_END_IllithidOptions_OrpheusKilled((CHARACTER)_Player);

IF
KilledBy(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _MindFlayerCaster, _, _StoryID)
AND
DB_END_General_ExtractBrainCastID(_MindFlayerCaster, _StoryID)
AND
NOT DB_GlobalFlag(END_IllithidOptions_Event_PlayerOpenedExitPortal_fe639a62-2f2f-441e-a2dc-00761cf7cca3)
THEN
SetFlag(END_IllithidOptions_Event_PlayerOpenedExitPortal_fe639a62-2f2f-441e-a2dc-00761cf7cca3);
PROC_END_IllithidOptions_OpenExitPortal((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

IF
KilledBy(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _MindFlayerCaster, _, _StoryID)
AND
DB_END_General_ExtractBrainCastID(_MindFlayerCaster, _StoryID)
AND
DB_END_IllithidOptionsFollower_Follower((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, _CharacterFlag, _GlobalFlag, _Dialog)
THEN
NOT DB_END_General_ExtractBrainCastID(_MindFlayerCaster, _StoryID);
DB_END_General_BrainExtractor((CHARACTER)_MindFlayerCaster);
SetFlag(END_IllithidOptions_Event_PlayerOpenedExitPortal_fe639a62-2f2f-441e-a2dc-00761cf7cca3);
DB_END_General_ReadyAssimilationVBReaction((CHARACTER)_MindFlayerCaster);
PROC_END_General_BrainExtract((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e);

PROC
PROC_END_IllithidOptions_OrpheusKilled((CHARACTER)_Player)
AND
DB_Avatars(_Player)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_LeftAstralPrism_db4fa8cd-9901-bda6-b5ee-b341075c02ce)
THEN
SetFlag(GLO_ThrallOfTheAbsolute_Event_AstralPrism_4d658c40-92a9-4c2b-9828-acc604789025, _Player);

PROC
PROC_END_IllithidOptions_OrpheusKilled((CHARACTER)_Char)
AND
NOT DB_Avatars(_Char)
AND
QRY_GLO_ThrallOfTheAbsolute_GetNearestTadpoledPlayer(_Char)
AND
DB_QRYRTN_GLO_ThrallOfTheAbsolute_NearestPlayer(_SelectedPlayer, _)
THEN
SetFlag(GLO_ThrallOfTheAbsolute_Event_AstralPrism_4d658c40-92a9-4c2b-9828-acc604789025, _SelectedPlayer);

PROC
PROC_StateSet_Defeated(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_LeftAstralPrism_db4fa8cd-9901-bda6-b5ee-b341075c02ce)
AND
NOT DB_END_General_ExtractBrainCastID(_, _)
AND
QRY_GLO_ThrallOfTheAbsolute_GetNearestTadpoledPlayer(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
DB_QRYRTN_GLO_ThrallOfTheAbsolute_NearestPlayer(_Player, _)
THEN
SetFlag(GLO_ThrallOfTheAbsolute_Event_AstralPrism_4d658c40-92a9-4c2b-9828-acc604789025, _Player);

PROC
PROC_END_IllithidOptions_SetOrpheusScene()
THEN
DB_SceneTriggerManager("END_IllithidOptions_OrpheusScene", (TRIGGER)S_END_AstralPrism_SUB_adf44e33-ae27-4186-aff7-84d61dbedcae);
DB_SceneManager(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e, "END_IllithidOptions_OrpheusScene");
//END_REGION
//REGION To High Hall
PROC
PROC_GlobalFlagReactionAfterDialog(END_IllithidOptions_Event_PlayerOpenedExitPortal_fe639a62-2f2f-441e-a2dc-00761cf7cca3)
THEN
PROC_END_IllithidOptions_OpenExitPortal((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GlobalFlagReactionAfterDialog(END_IllithidOptions_State_ExitPortalAvailable_b97872a1-59cc-40cd-8963-e06be614adc0)
AND
DB_END_IllithidOptionsFollower_Follower(_Char, _, _, _)
AND
NOT DB_PermaDefeated(_Char)
THEN
PROC_CharacterMoveTo(_Char, S_END_OpenExitPortalPoint_c6d5437e-ca42-4fa9-892f-f33a964c091c, "Run", "END_IllithidOptions_OpenExitPortal");
PROC_AddCharactersInTriggerToDialog_Clear((DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704);
PROC_AddCharactersInTriggerToDialog_Clear((DIALOGRESOURCE)END_IllithidOptions_OrpheusFreed_dd0df229-54bf-82cb-9869-a33edb46a57f, (TRIGGER)S_END_AssimilationAndFreedDialogBox_2d0e6a22-6370-44c3-98e5-ede4a0d18704);

IF
EntityEvent(_Char, "END_IllithidOptions_OpenExitPortal")
THEN
PROC_END_IllithidOptions_OpenExitPortal((CHARACTER)_Char);

PROC
PROC_END_IllithidOptions_OpenExitPortal((CHARACTER)S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
NOT DB_GlobalFlag(END_General_State_OrpheusIsMindFlayer_2b638127-f30a-424e-9d4a-a9f8f100a307)
AND
NOT DB_END_IllithidOptions_ExitPortalOpen(1)
THEN
DB_END_IllithidOptions_ExitPortalOpen(1);
SetOnStage(S_END_ResolutionExitPortal_Orpheus_b86aadd0-1cdd-460b-8c02-63c01a9a612e, 1);

PROC
PROC_END_IllithidOptions_OpenExitPortal((CHARACTER)_)
AND
NOT DB_END_IllithidOptions_ExitPortalOpen(1)
THEN
DB_END_IllithidOptions_ExitPortalOpen(1);
SetOnStage(S_END_ResolutionExitPortal_Illithid_2a62d420-290b-47e5-a224-71b5cda70f50, 1);

//Betrayed the Emperor after the portal was opened
IF
UseStarted(_Player, _Portal)
AND
DB_END_IllithidOptions_ExitPortals((ITEM)_Portal)
AND
DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
DB_GlobalFlag(END_EmperorPrelude_State_GaveStones_18e3be1a-c1c0-437e-ad0a-a1426d8830f4)
THEN
PROC_PlayCantUseItemAD(_Player);

//In combat with Orpheus
IF
UseStarted(_Player, _Portal)
AND
DB_END_IllithidOptions_ExitPortals((ITEM)_Portal)
AND
DB_GlobalFlag(END_IllithidOptions_State_OrpheusHostile_779f9ca6-4436-46dc-9e68-cb97e9ea1172)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
THEN
PROC_PlayCantUseItemAD(_Player);

//Assimilated Orpheus after he became hostile
IF
UseStarted(_Player, _Portal)
AND
DB_END_IllithidOptions_ExitPortals((ITEM)_Portal)
AND
DB_GlobalFlag(END_IllithidOptions_State_OrpheusHostile_779f9ca6-4436-46dc-9e68-cb97e9ea1172)
AND
DB_GlobalFlag(END_IllithidOptions_State_AssimilatedOrpheus_5562cc3f-c168-48c9-87c1-1598a5c58961)
THEN
PROC_END_IllithidOptions_TryLeaveAstralPrism((CHARACTER)_Player);

//Any other case
IF
UseStarted(_Player, _Portal)
AND
DB_END_IllithidOptions_ExitPortals((ITEM)_Portal)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_OrpheusHostile_779f9ca6-4436-46dc-9e68-cb97e9ea1172)
THEN
PROC_END_IllithidOptions_TryLeaveAstralPrism((CHARACTER)_Player);

PROC
PROC_END_IllithidOptions_TryLeaveAstralPrism((CHARACTER)_Player)
AND
DB_END_IllithidOptions_ReadyCheckPlayer(_Character)
THEN
NOT DB_END_IllithidOptions_ReadyCheckPlayer(_Character);


PROC
PROC_END_IllithidOptions_TryLeaveAstralPrism((CHARACTER)_Player)
AND
QRY_END_General_CanProceedTowardsFinale()
THEN
DB_END_IllithidOptions_ReadyCheckPlayer(_Player);
ReadyCheckGlobal("END_ReadyCheck_LeaveAstralPrism", "END_ReadyMessage_LeaveAstralPrism", 1, (CHARACTER)_Player);

PROC
PROC_END_IllithidOptions_TryLeaveAstralPrism((CHARACTER)_Player)
AND
NOT QRY_END_General_CanProceedTowardsFinale()
THEN
PROC_END_General_ThrallOfTheAbsoluteWarning((CHARACTER)_Player);

IF
ReadyCheckPassed("END_ReadyCheck_LeaveAstralPrism")
THEN
PROC_SceneOver("END_IllithidOptions_EmperorScene");
PROC_SceneOver("END_IllithidOptions_OrpheusScene");
SetOnStage(S_END_FakeNetherbrain_000_4a97b2f5-5633-4988-8036-a73866e28834, 0);
PROC_GlobalSetFlagAndCache(END_IllithidOptions_State_LeftAstralPrism_db4fa8cd-9901-bda6-b5ee-b341075c02ce);
PROC_END_IllithidOptions_LeaveAstralPrism();

PROC
PROC_END_IllithidOptions_LeaveAstralPrism()
AND
DB_PermaDefeated(S_GLO_Orpheus_47c90728-af68-4cbc-baaa-6497eebd8d7e)
AND
DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
DB_END_IllithidOptions_ReadyCheckPlayer(_Player)
THEN
PROC_END_IllithidOptions_TryToStartHighHall((CHARACTER)_Player);

PROC
PROC_END_IllithidOptions_LeaveAstralPrism()
AND
DB_END_IllithidOptionsFollower_Follower(_, _, _, _)
AND
NOT DB_END_IllithidOptions_WaitingForFollowerToJoin(1)
THEN
DB_END_IllithidOptions_WaitingForFollowerToJoin(1);
PROC_END_IllithidOptionsFollower_StartFollow();

IF
CharacterJoinedParty(_Char)
AND
DB_END_IllithidOptionsFollower_Follower(_Char, _, _, _)
AND
DB_END_IllithidOptions_WaitingForFollowerToJoin(1)
AND
DB_END_IllithidOptions_ReadyCheckPlayer(_Player)
THEN
NOT DB_END_IllithidOptions_WaitingForFollowerToJoin(1);
PROC_END_IllithidOptions_TryToStartHighHall((CHARACTER)_Player);

PROC
PROC_END_IllithidOptions_TryToStartHighHall((CHARACTER)_Player)
AND
QRY_END_General_CanProceedTowardsFinale()
THEN
DB_END_HighHall_ArrivalUser(_Player);
PROC_TeleportPartiesTo(S_END_HighHallStartPoint_250b3364-3f6a-48dc-aef9-0c82366f352d,"END_ArrivedInHighHall");
GoalCompleted;

PROC
PROC_END_IllithidOptions_TryToStartHighHall((CHARACTER)_Player)
AND
NOT QRY_END_General_CanProceedTowardsFinale()
THEN
PROC_END_General_ThrallOfTheAbsoluteWarning((CHARACTER)_Player);	
//END_REGION
//REGION No More Options
//Checks for if the player has truely burned every single option. Trigger Thrall of the Absolute in this case

//Called when Emperor is betrayed and when Raphael leaves
PROC
PROC_END_IllithidOptions_CheckNoMoreOptionsLeft((CHARACTER)_Player)
AND
QRY_END_IllithidOptions_CheckNoMoreOptionsLeft()
THEN
SetFlag(GLO_ThrallOfTheAbsolute_Event_AstralPrism_4d658c40-92a9-4c2b-9828-acc604789025, _Player);

//Raphael dead, no hammer or supreme tadpole, Emperor betrayed
QRY
QRY_END_IllithidOptions_CheckNoMoreOptionsLeft()
AND
DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
NOT DB_GlobalFlag(END_IllithidOptions_State_ArrivedWithOrphicHammer_a350e277-55a7-4e03-9c14-db154b6c682e)
AND
NOT DB_GlobalFlag(END_General_State_SupremeTadpoleAvailable_0177c452-90cc-4c29-83b8-4acaa2902b27)
AND
NOT DB_GlobalFlag(END_General_State_PartyMemberIsMindFlayer_3c42b03b-c51c-4f06-a5a3-a5ee416d9d8b)
AND
DB_GlobalFlag(GLO_Monitor_State_PermaDefeated_92f6d5f6-86af-4339-ad8a-da9d629f0dae)
THEN
DB_NOOP(1);

//Attacked Raphael in END, no supreme tadpole (should not appear anyways in this case), Emperor betrayed (only appears if the Emperor was betrayed)
QRY
QRY_END_IllithidOptions_CheckNoMoreOptionsLeft()
AND
DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
NOT DB_GlobalFlag(END_General_State_SupremeTadpoleAvailable_0177c452-90cc-4c29-83b8-4acaa2902b27)
AND
NOT DB_GlobalFlag(END_General_State_PartyMemberIsMindFlayer_3c42b03b-c51c-4f06-a5a3-a5ee416d9d8b)
AND
DB_GlobalFlag(END_IllithidOptions_Event_RejectedRaphael_b2e6764d-828b-b125-3e9a-365d5fd9737b)
THEN
DB_NOOP(1);


PROC
PROC_END_IllithidOptions_CheckNoMoreOptionsLeft((CHARACTER)_Player)
AND
DB_GlobalFlag(END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd)
AND
GetFlag(END_IllithidOptions_State_AssimilatorOfOrpheus_56989e8b-cca9-4f3b-aece-26a389e3b6ee, S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 1)
THEN
SetFlag(GLO_ThrallOfTheAbsolute_Event_AstralPrism_4d658c40-92a9-4c2b-9828-acc604789025, _Player);
//END_REGION
EXITSECTION
SetImmortal(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b, 0); //Goal always closes when the player leaves to high hall
NOT DB_PreventKnockedOutPermaDefeated(S_GLO_Emperor_73d49dc5-8b8b-45dc-a98c-927bb4e3169b);
ENDEXITSECTION
ParentTargetEdge "Act3c"
