Version 1
SubGoalCombiner SGC_AND
INITSECTION
NOT DB_HAV_FlorrickShouldLeave(0); //replaced with flag but used for patching
NOT DB_SCE_TieflingFollowUp_MasterBards((CHARACTER)NULL_00000000-0000-0000-0000-000000000000); //replaced with another database but used for patching
NOT DB_SHA_EntrancePuzzle_RingsVFX("", (EFFECTRESOURCE)NULL_00000000-0000-0000-0000-000000000000); // Used for patching since it's been replaced with a new one.
KBSECTION
//REGION GUS-297644
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,4,0)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_Assault")
THEN
PROC_BG3_SaveGamePatches_GUS_297644_CheckJaheriaBackToMoonrise(); //In the case she was hanging back in Haven after the player killed Isobel during the assault
PROC_MOO_Assault_ForceResolveFlamingSpy();

PROC
PROC_BG3_SaveGamePatches_GUS_297644_CheckJaheriaBackToMoonrise()
AND
DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
AND
DB_GlobalFlag(MOO_Assault_State_JaheiraPresent_7d113d3f-aae7-40fe-9672-55094729f3dd)
AND
NOT DB_InRegion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_ShadowCurse_SafeZone_MoonriseTower_b0b0721f-2a4f-4530-85cf-c67c0db25f92) //She is hanging out at haven, or at least where she shouldn't be
AND
NOT DB_GlobalFlag(COL_PartyProgress_EnteredColony_666abe92-f197-4c38-85a8-d879a9e258b6)
AND
NOT DB_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_PartOfTheTeam(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
THEN
PROC_BG3_SaveGamePatches_GUS_297644_TeleportJaheriaBackToMoonrise();

PROC
PROC_BG3_SaveGamePatches_GUS_297644_TeleportJaheriaBackToMoonrise()
AND
NOT DB_GlobalFlag(MOO_Assault_State_AllyReadyPositions_f0316e51-b885-472a-a8db-b5cf64aca732)
AND
DB_MOO_AssaultPositions(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Trigger, _)
AND
NOT DB_MOO_Assault_PATCH_TeleportedJaheriaBackToMoonrise(1)
THEN
DB_MOO_Assault_PATCH_TeleportedJaheriaBackToMoonrise(1);
TeleportTo(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Trigger);

PROC
PROC_BG3_SaveGamePatches_GUS_297644_TeleportJaheriaBackToMoonrise()
AND
DB_GlobalFlag(MOO_Assault_State_AllyReadyPositions_f0316e51-b885-472a-a8db-b5cf64aca732)
AND
NOT DB_GlobalFlag(MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6)
AND
NOT DB_MOO_Assault_PATCH_TeleportedJaheriaBackToMoonrise(1)
THEN
DB_MOO_Assault_PATCH_TeleportedJaheriaBackToMoonrise(1);
TeleportTo(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_MOO_AssaultAllyReadyPoints_001_2eb86f25-a51b-45c3-9134-922a0d812b0d);

PROC
PROC_BG3_SaveGamePatches_GUS_297644_TeleportJaheriaBackToMoonrise()
AND
DB_GlobalFlag(MOO_Assault_State_AllyReadyPositions_f0316e51-b885-472a-a8db-b5cf64aca732)
AND
DB_GlobalFlag(MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6)
AND
NOT DB_MOO_Assault_PATCH_TeleportedJaheriaBackToMoonrise(1)
THEN
DB_MOO_Assault_PATCH_TeleportedJaheriaBackToMoonrise(1);
TeleportTo(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, S_MOO_JaheiraRoofRecruitPoint_fb63ebfd-99ac-4e09-a258-478cd5a2a073);
//END_REGION 

//REGION GUS-298010

//If Jaheira is a follower, but is safely still inside the Moonrise Assault locale, then just make sure she's set up to be able to leave

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
IsPartyFollower(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 1)
AND
CharacterGetOwner(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player)
THEN
ClearFlag(MOO_Assault_State_JaheiraLeftParty_ba466ab9-fb7b-4821-8e31-36e57bab9d78, _Player, 0);
DB_BUGFIX_Marker("GUS-298010");

//If Jaheira is a follower, and happens to be outside, get rid - same as if she left the trigger

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
IsPartyFollower(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 1)
AND
CharacterGetOwner(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Player)
THEN
ClearFlag(MOO_Assault_State_JaheiraJoinedParty_6a6328d4-faab-4d97-9662-eba21c4dd613, _Player, 0);
DB_MOO_Jaheira_NeedsToAD(1);
PROC_MOO_Assault_TryToRemoveJaheiraFromParty(_Player);
DB_BUGFIX_Marker("GUS-298010");

//If Jaheira is not a follower, ensure that she can safely become a follower - remove the JoinedParty flag on everyone, just incase

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
IsPartyFollower(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 0)
AND
DB_Players(_Player)
THEN
ClearFlag(MOO_Assault_State_JaheiraJoinedParty_6a6328d4-faab-4d97-9662-eba21c4dd613, _Player, 0);
DB_BUGFIX_Marker("GUS-298010");

//And also make sure the new dialog atop the tower is the correct one

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
DB_Dialogs(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, MOO_Assault_Jaheira_TopOfTowerBackup_e1a54878-2256-5be7-e0b6-16c5a2dc4d26)
THEN
NOT DB_Dialogs(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, MOO_Assault_Jaheira_TopOfTowerBackup_e1a54878-2256-5be7-e0b6-16c5a2dc4d26);
DB_Dialogs(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, Jaheira_Recruitment_Moonrise_04443f0f-9c62-d474-a98a-3e13eec31c69);
DB_BUGFIX_Marker("GUS-298010");

//END_REGION GUS-298010

//REGION GUS-302422
//Force run the new script, just incase a save game has Jaheira currently trapped in a wildshape

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_Is_WildShaped(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_PartOfTheTeam(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
IsInCombat(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 0)
THEN
PROC_RemoveAllPolymorphs(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
RemoveStatus(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "INVISIBILITY_PANTHER");
RemoveStatus(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "PROWL");
DB_BUGFIX_Marker("GUS-302422");

//END_REGION GUS-302422

//REGION GUS-313205


//Give Jaheira a heal if the save has her out front of Moonrise

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-313205");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-313205")
AND
NOT DB_Dead(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_PartOfTheTeam(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
IsInCombat(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 0)
AND
GetFlag(MOO_Assault_State_MainFloorEnemiesDefeated_1016055f-387a-4564-b3f9-cac9d2735b9d, NULL_00000000-0000-0000-0000-000000000000, 0)
AND
QRY_BG3_SaveGamePatch_GUS313205_JaheiraHealChecker()
THEN
ApplyStatus(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "TUT_RESTORATION", 6.0, 1, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_BUGFIX_Marker("GUS-313205");

QRY
QRY_BG3_SaveGamePatch_GUS313205_JaheiraHealChecker()
AND
GetFlag(MOO_Assault_State_JaheiraPresent_7d113d3f-aae7-40fe-9672-55094729f3dd, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SaveGamePatch_GUS313205_JaheiraHealChecker()
AND
GetFlag(MOO_Assault_State_JaheiraOnly_251a3f08-c3b0-4a47-be1f-d694f7fade9e, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
DB_NOOP(1);

//END_REGION GUS-302422

//REGION GUS-299954
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
NOT DB_GlobalFlagReactionAfterDialog(HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686, HAV_EnteringHaven_TadpoleCheckpoint_e51408cc-4f7a-5a5f-52e8-caf1359c1d6c)
THEN
DB_GlobalFlagReactionAfterDialog(HAV_EnteringHaven_State_FlamingSpyRevealed_89e1eb87-a718-8dc2-026d-f4db8321b686, HAV_EnteringHaven_TadpoleCheckpoint_e51408cc-4f7a-5a5f-52e8-caf1359c1d6c);
TriggerRegisterForPlayers(S_HAV_EnteringHaven_CombatAddChecker_b053df36-f455-48c7-98fa-03d19839af21);
DB_BUGFIX_Marker("GUS-299954");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_HAV_EnteringHaven_ClawsActive(1)
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _CombatID)
AND
DB_HAV_EnteringHaven_Claws((CHARACTER)_Claw)
AND
DB_Is_InCombat(_Claw, _CombatID)
AND
DB_Players(_OtherPlayers)
AND
NOT DB_Is_InCombat(_OtherPlayers, _CombatID)
AND
DB_InRegion(_OtherPlayers, S_HAV_EnteringHaven_CombatAddChecker_b053df36-f455-48c7-98fa-03d19839af21)
THEN
EnterCombat(_OtherPlayers, _Claw);
DB_BUGFIX_Marker("GUS-299954");

//END_REGION GUS-299954

//REGION GUS-296849
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,4,0)
THEN
PROC_BG3_SaveGamePatches_GUS_296849_CheckSetupZrellAfterStart(); //In the case the player has already started the assault, but has not entered the tower yet

PROC
PROC_BG3_SaveGamePatches_GUS_296849_CheckSetupZrellAfterStart()
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_Assault")
AND
NOT DB_Defeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84) 
AND
DB_GlobalFlag(MOO_Execution_Knows_Executioner_53052e40-df9b-90a0-ad65-f2c06f996666) 
AND
NOT DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e) 
AND
NOT DB_SceneTriggerManager("MOO_Assault_ZrellGreetingScene", _) //Not currently active
AND
NOT DB_GlobalFlag(MOO_Assault_State_AllyReadyPositions_f0316e51-b885-472a-a8db-b5cf64aca732) //Haven't entered the tower yet
AND
NOT DB_GlobalFlag(MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6) //For sanity just in case this goal is still open but loaded at a point after assault
THEN
NOT DB_MOO_Assault_EnemyGroups("MOO_Assault_BazaarEnemies");
DB_MOO_Assault_NeutralGroups("MOO_Assault_BazaarEnemies");
NOT DB_OnlyOnce("MOO_Assault_BazaarSetHostile");
PROC_BG3_SaveGamePatches_GUS_296849_ZrellSwitchBackAndSetScene();
DB_BUGFIX_Marker("GUS-296849");

PROC
PROC_BG3_SaveGamePatches_GUS_296849_ZrellSwitchBackAndSetScene()
AND
DB_MOO_AssaultPositions(_Char,_Trigger,"MOO_Assault_BazaarEnemies")
THEN
PROC_MOO_Assault_SetFactions(_Char, "MOO_Assault_BazaarEnemies");

PROC
PROC_BG3_SaveGamePatches_GUS_296849_ZrellSwitchBackAndSetScene()
THEN
PROC_MOO_Assault_SetUpZrellScene();

//END_REGION

//REGION GUS-258879

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,4,0)
AND
HasActiveStatus(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "HAV_CHANNELING", 1)
THEN
RemoveStatus(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "HAV_CHANNELING");
DB_BUGFIX_Marker("GUS-258879");

//END_REGION GUS-258879

//REGION GUS-298205
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
AND
DB_SCL_Drider_HarpersGroup(_Harper, _, _)
AND
DB_AmbushTrigger_Ambusher((TRIGGER)S_SCL_Drider_HarpersAmbush_Trigger_74df3b45-284f-42f7-b0c4-b40359c1de55, _Harper, _)
AND
NOT QRY_State_IsBeforeState(_Harper, "SCL_DriderHarpers", "TakingMoonlantern")
THEN
PROC_SetRelationToPlayers((FACTION)ACT2_SCL_HarpersAmbush_f9940d88-f049-4522-a2ae-4b8304e4563c, 50);
DB_BUGFIX_Marker("GUS-298205");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
AND
DB_SCL_Drider_HarpersGroup(_Harper, _, _)
AND
NOT QRY_State_IsBeforeState(_Harper, "SCL_DriderHarpers", "TakingMoonlantern")
THEN
PROC_CancelAmbush((TRIGGER)S_SCL_Drider_HarpersAmbush_Trigger_74df3b45-284f-42f7-b0c4-b40359c1de55);
DB_BUGFIX_Marker("GUS-298205");

//END_REGION GUS-298205

//REGION GUS-291239 

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
QRY_MOO_Jailbreak_AreProdigiesDesynced()
THEN
PROC_MOO_Jailbreak_FixProdigiesDesync();

QRY
QRY_MOO_Jailbreak_AreProdigiesDesynced()
AND
NOT DB_MOO_Jailbreak_Started(1)
AND
DB_MOO_Jailbreak_Prisoner(S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, _)
AND
NOT DB_HAV_SavingPrisoners_InHaven(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
DB_NOOP(1);

QRY
QRY_MOO_Jailbreak_AreProdigiesDesynced()
AND
NOT DB_MOO_Jailbreak_Started(1)
AND
DB_MOO_Jailbreak_Prisoner(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _)
AND
NOT DB_HAV_SavingPrisoners_InHaven(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
DB_NOOP(1);

PROC
PROC_MOO_Jailbreak_FixProdigiesDesync()
THEN
NOT DB_MOO_Jailbreak_Prisoner(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, "Tieflings");
NOT DB_MOO_Jailbreak_Prisoner(S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, "Tieflings");
SetOnStage(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, 0);
SetOnStage(S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, 0);
DB_BUGFIX_Marker("GUS-291239");

//Pick new cell leader and change their config.
PROC
PROC_MOO_Jailbreak_FixProdigiesDesync()
AND
NOT DB_MOO_Jailbreak_Prisoner(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _)
AND
NOT DB_MOO_Jailbreak_Prisoner(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, _)
AND
DB_MOO_Jailbreak_Prisoner(S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, _)
THEN
PROC_SetAnubisConfig(S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, "MOO_ProdigySister");
SetFlag(MOO_Jailbreak_State_TieflingLeader_fa806828-c5a4-2691-ad46-be5e2ced9d67, S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c, 0);

PROC
PROC_MOO_Jailbreak_FixProdigiesDesync()
AND
NOT DB_MOO_Jailbreak_Prisoner(S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, _)
AND
DB_MOO_Jailbreak_Prisoner(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, _)
THEN
PROC_SetAnubisConfig(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, "MOO_ProdigySister");
SetFlag(MOO_Jailbreak_State_TieflingLeader_fa806828-c5a4-2691-ad46-be5e2ced9d67, S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, 0);

//END_REGION

//REGION GUS-298417

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
AND
DB_OnlyOnce("MOO_Roof_SendPlayersToColonyOnce")
THEN
PROC_MOO_Jailbreak_KillRemainingPrisoners();
DB_BUGFIX_Marker("GUS-298417");

//END_REGION 

//REGION GUS-294874

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
AND
DB_MOO_Jailbreak_Prisoner(_Character, _)
THEN
RequestSetSwarmGroup(_Character, "");
DB_BUGFIX_Marker("GUS-294874");

//END_REGION 

//REGION GUS-297609

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
AND
DB_OnlyOnce("HAV_SavingPrisoners_ArrivalDialog")
AND
DB_InRegion(_Player, S_HAV_ArrivalArea_c7b0b988-3584-4f38-a387-66333bbefa69)
AND
NOT DB_HAV_SavingPrisoners_CheckInspectionEnd(1)
THEN
DB_HAV_SavingPrisoners_CheckInspectionEnd(1);
DB_BUGFIX_Marker("GUS-297609");

//END_REGION 

//REGION GUS-298822

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
AND
DB_HAV_SavingPrisoners_PendingReturn(_Prisoner, _ReturnType)
AND
DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
THEN
NOT DB_HAV_SavingPrisoners_PendingReturn(_Prisoner, _ReturnType);
DB_MOO_Jailbreak_EpilogueReturn(_Prisoner, _ReturnType);
DB_BUGFIX_Marker("GUS-298822");

//END_REGION

//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
AND
DB_GlobalFlag((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd)
AND
NOT QRY_ORI_Gale_EligibleAvatarInLastNightAlive()
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);

//END_REGION 

//REGION GUS-305211
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-305211 1");
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_BeMyGod_0c7cb6c2-4097-9bb1-aa0e-6edfaa7abb2e);

//END_REGION GUS-305211


//REGION GUS-297672

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,5,0)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_Outcast")
THEN
PROC_BG3_SaveGamePatches_GUS_297672_SendKethericToRoof();
DB_BUGFIX_Marker("GUS-297672");

PROC
PROC_BG3_SaveGamePatches_GUS_297672_SendKethericToRoof()
AND
NOT DB_GlobalFlag(MOO_Execution_Event_CombatTransgression_1946f62a-afe1-4843-bdfa-590688f366d6)
THEN
SetFlag(MOO_Execution_Event_CombatTransgression_1946f62a-afe1-4843-bdfa-590688f366d6);

PROC
PROC_BG3_SaveGamePatches_GUS_297672_SendKethericToRoof()
AND
NOT DB_GlobalFlag(MOO_Execution_Event_KethericLeaves_b8718f8f-6313-dc0e-e20d-7435db4b74c4)
THEN
SetFlag(MOO_Execution_Event_KethericLeaves_b8718f8f-6313-dc0e-e20d-7435db4b74c4);
EndRepose(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
PROC_CharacterMoveTo((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_MOO_RoofIntermediatePoint_c9586639-f1b5-4b67-998b-a2efe790dd4f, "Walk", "MOO_Ketheric_LeaveExecutionToRoof");

//END_REGION

//REGION GUS-299141
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,6,0)
AND
DB_Crime_RequestedDialogWithTension("MOO_Trespass_UnaccompaniedIntruder",(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000,_NPC,_Criminal1,_Criminal2,_Criminal3,_Criminal4)
AND
GetHandlingCrimeID(_NPC,_CrimeID)
THEN
NOT DB_Crime_RequestedDialogWithTension("MOO_Trespass_UnaccompaniedIntruder",(DIALOGRESOURCE)NULL_00000000-0000-0000-0000-000000000000,_NPC,_Criminal1,_Criminal2,_Criminal3,_Criminal4);
CrimeConfrontationDone(_CrimeID,_NPC);
DB_BUGFIX_Marker("GUS-298822a");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,6,0)
AND
DB_MOO_UnwelcomeVisitors_VisitorCrimeRegistered(_Visitor, _CrimeID)
AND
HasAppliedStatus(_Visitor,"MOO_UNWELCOMEVISITORS_BLOCKVISITORCRIMES",1)
THEN
PROC_CRIME_StopForAllCriminals(_CrimeID);
DB_BUGFIX_Marker("GUS-298822b");
//END_REGION

//REGION GUS-297644
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)GLO_LiftingTheCurse_Event_TravelToLakeside_e06813a1-899a-498e-bd18-d22bee7d30e6, (DIALOGRESOURCE)CAMP_Halsin2_c0ab0f6f-3ffc-d06d-0d6d-d1aaef70dfe4);
DB_BUGFIX_Marker("GUS-297644");

//END_REGION GUS-297644

//REGION GUS-299055

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,6,0)
AND
NOT DB_Achievements_UnlockAfterDialogGlobalFlag("BG3_Quest48",(FLAG)ORI_Shadowheart_State_NightsongPoint_GaveNightOrchid_cd01256d-93df-4d80-8d94-1233fe16ddf6,(DIALOGRESOURCE)ShadowHeart_InParty2_Nested_ShadowCurseChapter_058b61ef-8af6-3f48-08c3-46cbd4374446)
THEN
DB_Achievements_UnlockAfterDialogGlobalFlag("BG3_Quest48",(FLAG)ORI_Shadowheart_State_NightsongPoint_GaveNightOrchid_cd01256d-93df-4d80-8d94-1233fe16ddf6,(DIALOGRESOURCE)ShadowHeart_InParty2_Nested_ShadowCurseChapter_058b61ef-8af6-3f48-08c3-46cbd4374446);
DB_BUGFIX_Marker("GUS-299055");

//END_REGION GUS-299055

//REGION GUS-299480

//Give Isobel enemy VFX in COL
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
AND
DB_GlobalFlag((FLAG)MOO_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
DB_GlobalFlag((FLAG)MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce)
AND
NOT DB_Dead((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
ApplyStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"COL_ISOBEL_ENEMY_VFX",-1.0,0,NULL_00000000-0000-0000-0000-000000000000);

//Make Isobel undead in COL if she's resurrected
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
AND
DB_GlobalFlag((FLAG)MOO_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
DB_GlobalFlag((FLAG)MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce)
AND
IsTagged(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727,1)
//Isobel will be perma-defeated despite being resurrected in COL (this is so we don't mess with old scripting)
AND
NOT DB_Dead((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
SetTag(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(TAG)UNDEAD_33c625aa-6982-4c27-904f-e47029a9b140);

//END_REGION

//REGION GUS-299118

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
AND
DB_MOO_Alarm_ScryingEyes(_Eye)
THEN
PROC_StopFollow(_Eye);
DB_BUGFIX_Marker("GUS-299118");

//END_REGION

//REGION GUS-299995

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
THEN
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_LearnSpell_393b05ff-d866-4115-8ece-872232ce44cf, (FLAG)ORI_Gale_State_ReadyForLastNightAlive_088c7213-0615-41a0-a4ac-1ab4d1341666);

//END_REGION

//REGION GUS-300045
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", _State)
AND
DB_MOO_BossFight_ValidStatesForDialog(_State)
AND
DB_MOO_AssaultPositions((CHARACTER)S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _, "MOO_Assault_RooftopEnemies")
AND
DB_OffStage(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab)
AND
NOT DB_PermaDefeated(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab)
AND
NOT DB_GlobalFlag(COL_PartyProgress_EnteredColony_666abe92-f197-4c38-85a8-d879a9e258b6)
THEN
SetOnStage(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, 1);
NOT DB_NightsongDeath_OffStage(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab);
DB_BG3_SaveGamePatches_GUS_300045_WaitingForDrider(1);
DB_BUGFIX_Marker("GUS-300045");

IF
WentOnStage(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, 1)
AND
DB_BG3_SaveGamePatches_GUS_300045_WaitingForDrider(1)
AND
DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab)
THEN
NOT DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab);
NOT DB_BG3_SaveGamePatches_GUS_300045_WaitingForDrider(1);
PROC_GLO_NarrativeCombat_JoinCombat("MOO_Assault_KethericRoofFight", S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", _State) 
AND
DB_MOO_BossFight_ValidStatesForDialog(_State)
AND
DB_MOO_Assault_PrepareBossFightDialog(1) //Dialog prepared but not started yet
THEN
DB_SceneTriggerManager("MOO_Assault_BossFightIntroScene", (TRIGGER)S_MOO_BossFIghtIntroSceneTrigger_69621203-8925-440e-ba5d-b5d23ec7e3a4);
PROC_BG3_SaveGamePatches_GUS_300045_SetupBossIntroScene();
DB_BUGFIX_Marker("GUS-300045");

PROC
PROC_BG3_SaveGamePatches_GUS_300045_SetupBossIntroScene()
AND
DB_MOO_AssaultPositions(_Char, _, "MOO_Assault_RooftopEnemies")
THEN
DB_SceneManager(_Char, "MOO_Assault_BossFightIntroScene");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
AND
QRY_State_IsBeforeState(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_Assault")
AND
NOT DB_SceneTriggerManager("MOO_Assault_BossFightIntroScene", _)
THEN
DB_SceneTriggerManager("MOO_Assault_BossFightIntroScene", (TRIGGER)S_MOO_BossFIghtIntroSceneTrigger_69621203-8925-440e-ba5d-b5d23ec7e3a4);
DB_BUGFIX_Marker("GUS-300045");
//END_REGION

//REGION


PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-307816");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-307816")
THEN
SetOnStage(S_HospitalLiftTop_a6a53109-3772-4cc6-9212-e35ef0b35c3d, 0);
SetOnStage(S_HospitalLiftMiddle_85391136-a631-40e1-a2e1-29015d637e42, 0);
SetOnStage(S_HospitalLiftLeverBottom_798ffdc6-c24d-417e-ba38-bca63726c71d, 0);


//END_REGION

//REGION GUS-299857

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,7,0)
THEN
DB_TopicalGreeting((FLAG)TG_DarkUrge_SparedIsobelNight_41745fbc-49e6-44dc-9c77-51dee7f1c21c);

//END_REGION

//REGION GUS-299944

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c)
THEN
DB_BUGFIX_Marker("GUS-299944");
ClearTag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, ACT2_SHADOW_CURSE_RESISTANT_DONT_PROPAGATE_87dc3ebb-0eca-47d8-971e-3c500c743dd7);

//END_REGION GUS-299944

//REGION GUS-299983

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
DB_PartyDialogSuppressionZone((TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0)
AND
DB_GlobalFlag((FLAG)SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa)
THEN
DB_BUGFIX_Marker("GUS-299983");
NOT DB_PartyDialogSuppressionZone((TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
DB_PartyDialogSuppressionZone((TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0)
AND
DB_GlobalFlag((FLAG)SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731)
THEN
DB_BUGFIX_Marker("GUS-299983");
NOT DB_PartyDialogSuppressionZone((TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
DB_PartyDialogSuppressionZone((TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_PermanentlyDead")
THEN
DB_BUGFIX_Marker("GUS-299983");
NOT DB_PartyDialogSuppressionZone((TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0);


//END_REGION GUS-299983

//REGION GUS-299742
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
NOT DB_GlobalFlag((FLAG)SCL_ShadowCurse_State_CurseLifted_af78af4a-48b2-46a8-be6f-f25dfa579471)
AND
NOT DB_PermaDefeated(S_HAV_AncientFist_MartCullagh_378938e2-2193-49a3-a06e-8e26cc128055)
THEN
DB_BUGFIX_Marker("GUS-299742");
SetCanTrade((CHARACTER)S_HAV_AncientFist_MartCullagh_378938e2-2193-49a3-a06e-8e26cc128055,0);
//END_REGION

//REGION GUS-300388
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
DB_RegionPrison((STRING)_RegionName,(TRIGGER)_PrisonTrigger,(TRIGGER)_PrisonSpawnPoint)
THEN
DB_Region_Prison_HasBeenRegionPrison(_RegionName,_PrisonTrigger);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
DB_RegionPrison_CustomCell((TRIGGER)_PrisonTrigger,(TRIGGER)_CellTrigger,(CHARACTER)_Char,(TRIGGER)_SpawnPoint,(ITEM)_CellDoor,(STRING)_KeyName)
AND
DB_RegionPrison((STRING)_RegionName,(TRIGGER)_PrisonTrigger,(TRIGGER)_PrisonSpawnPoint)
THEN
DB_Region_Prison_HasBeenRegionPrison(_RegionName,_CellTrigger);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
DB_Region_Prison_HasBeenRegionPrison( "SCL_Main_A_HAV",(TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00);
//END_REGION

//REGION GUS-300196
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
NOT DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_GLO_LiftingTheCurse_LiftedCurse_ac891d02-3650-4c3d-b180-f83465761882, (FLAG)VISITEDREGION_INT_Main_A_a2e1a618-d211-484e-9389-6b37308b8da1)
AND
DB_GlobalFlag((FLAG)VISITEDREGION_SCL_Main_A_f6e72539-9bc6-42e1-a20f-390f3a17ad8d)
AND
NOT DB_GlobalFlag((FLAG)VISITEDREGION_INT_Main_A_a2e1a618-d211-484e-9389-6b37308b8da1)
THEN
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_GLO_LiftingTheCurse_LiftedCurse_ac891d02-3650-4c3d-b180-f83465761882, (FLAG)VISITEDREGION_INT_Main_A_a2e1a618-d211-484e-9389-6b37308b8da1);
DB_BUGFIX_Marker("GUS-299742");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,8,0)
AND
DB_GlobalFlag((FLAG)VISITEDREGION_INT_Main_A_a2e1a618-d211-484e-9389-6b37308b8da1)
AND
DB_PartOfTheTeam(_Char)
AND
GetFlag((FLAG)TG_GLO_LiftingTheCurse_LiftedCurse_ac891d02-3650-4c3d-b180-f83465761882, _Char, 1)
THEN
ClearFlag((FLAG)TG_GLO_LiftingTheCurse_LiftedCurse_ac891d02-3650-4c3d-b180-f83465761882, _Char);
DB_BUGFIX_Marker("GUS-300196");

//END_REGION GUS-300196

//REGION GUS-300427

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_MOO_Jailbreak_PendingGuards(_Guard)
AND
DB_Defeated(_Guard)
THEN
TriggerUnregisterForCharacter(S_MOO_DisableEscapeArea_130ffe26-5c2c-4f5d-95a8-5b3e5480475c, _Guard);
DB_BUGFIX_Marker("GUS-300427");

//END_REGION

//REGION GUS-300435

QRY
QRY_SavegameCheck_NeedsToPatchHavenTieflings()
AND
DB_HAV_TieflingSurvivors(_, _Tiefling, _, _, _)
AND
DB_HAV_Siege_NPCs(_Tiefling)
AND
NOT DB_BUGFIX_Marker("GUS-300435")
THEN
DB_BUGFIX_Marker("GUS-300435");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
QRY_SavegameCheck_NeedsToPatchHavenTieflings()
THEN
PROC_HAV_Siege_CheckTieflings();

//Make sure all in HAV are in the DB.
PROC
PROC_HAV_Siege_CheckTieflings()
AND
DB_HAV_SavingPrisoners_InHaven(_Tiefling)
AND
_Tiefling != S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b
AND
NOT DB_HAV_Siege_NPCs((CHARACTER)_Tiefling)
AND
NOT DB_GlobalFlag(Debug_HAV_Siege_Start_bb8418df-ccfb-4a99-8bd9-6640eb7080e0)
AND
NOT DB_PermaDefeated(_Tiefling)
THEN
DB_HAV_Siege_NPCs((CHARACTER)_Tiefling);

//Remove all not in HAV from the DB.
PROC
PROC_HAV_Siege_CheckTieflings()
AND
DB_HAV_Siege_NPCs(_Tiefling)
AND
DB_HAV_TieflingSurvivors(_, _Tiefling, _, _, _)
AND
NOT DB_HAV_SavingPrisoners_InHaven((CHARACTER)_Tiefling)
THEN
DB_HAV_Siege_NPCs(_Tiefling);

//Special case for prodigy since he can leave. Clear him if he's not in HAV anymore.
PROC
PROC_HAV_Siege_CheckTieflings()
AND
DB_HAV_Siege_NPCs((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
DB_HAV_SavingPrisoners_InHaven((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
NOT DB_GlobalFlag(GLO_Prodigy_State_InHaven_fe9b4527-9d66-45db-8e04-490fd51b7be5)
THEN
NOT DB_HAV_Siege_NPCs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

//END_REGION

//REGION GUS-296661

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
NOT DB_BUGFIX_Marker("GUS-300435")
THEN
DB_BUGFIX_Marker("GUS-300435");

IF
DB_CurrentLevel("SCL_Main_A")
AND
DB_BUGFIX_Marker("GUS-300435")
AND
NOT DB_OnlyOnce("MOO_Jailbreak_RegisterTieflingCell")
THEN
DB_OnlyOnce("MOO_Jailbreak_RegisterTieflingCell");
PROC_TriggerRegisterForPlayers(S_MOO_TieflingCell_9dcd7544-1a52-4223-a11b-798a1c320dab);


//END_REGION

//REGION GUS-300427

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
THEN
DB_CampNight((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, 6048);
DB_CampNight_Camp((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, "SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, "HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, "MOONRISE");
DB_CampNight_Camp((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, "SHARTEMPLE");
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, MOO_Audience_Event_PassTeleporter_3115b554-2e0e-cbdc-6166-5fa7586cae45);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, (FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, (FLAG)NIGHT_Gale_LastNightAlive_Avatar_FollowedMystra_f45005bf-c598-4331-8cb8-fe246093f1db);
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, (FLAG)NIGHT_Gale_LastNightAlive_Avatar_46377049-b609-44ba-ae82-e931d2ff9953);
DB_CampNight_Requirement((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, (FLAG)ORI_Gale_State_ReadyForLastNightAlive_088c7213-0615-41a0-a4ac-1ab4d1341666, (FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, (FLAG)GALEAVATAR_e8043a21-c6e3-4d6d-802b-2a87abea044c);
NOT DB_CampNight_Requirement((FLAG)NIGHT_Gale_LastNightAlive_Avatar_46377049-b609-44ba-ae82-e931d2ff9953, (FLAG)ORI_Gale_State_ReadyForLastNightAlive_088c7213-0615-41a0-a4ac-1ab4d1341666, (FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, (FLAG)GALEAVATAR_e8043a21-c6e3-4d6d-802b-2a87abea044c, (FLAG)GALETRESSYM_a1b3e071-836c-4b7a-af10-9d8cbb74d165);
DB_CampNight_SoloDream((FLAG)NIGHT_Gale_LastNightAlive_Avatar_Fallback_f2ec5a37-d385-4787-8b0b-9d615f07ad37, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)CAMP_Gale_SD_LastNightAlive_fdabf765-0c88-414c-60c2-2221fde2b464);
DB_BUGFIX_Marker("GUS-300427");

//END_REGION

//REGION GUS-297639
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
DB_SavegamePatch_GUS297639(1);

IF
DB_SavegamePatch_GUS297639(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
DB_SavegamePatch_GUS297639_Mines((ITEM)PUZ_GEN_Trap_Mine_A_Copper_A_000_a8a7d6c3-0656-4f32-8d9d-5d6a8cdcd460, (ITEM)PUZ_GEN_CONST_Trap_Mine_A_Copper_A_000_8939393e-fed3-4232-b498-75303d8b942a);
DB_SavegamePatch_GUS297639_Mines((ITEM)PUZ_GEN_Trap_Mine_A_Copper_A_001_9f956431-232f-45aa-9f1d-68dac2b4e7c5, (ITEM)PUZ_GEN_CONST_Trap_Mine_A_Copper_A_001_10002930-859e-4165-9fb0-f439c0911af6);
DB_SavegamePatch_GUS297639_Mines((ITEM)PUZ_GEN_Trap_Mine_A_Copper_A_002_c8dc38d6-914b-40e8-8a9c-dd5a0ef84c93, (ITEM)PUZ_GEN_CONST_Trap_Mine_A_Copper_A_002_57867db9-1e12-47dd-b130-222123dfea9f);
PROC_SetOnStage(PUZ_GEN_Tripwire_C_000_86a911e3-09bf-43f7-80ba-a34d3200b853, 0);
NOT DB_SavegamePatch_GUS297639(1);

IF
DB_SavegamePatch_GUS297639_Mines(_Mine, _ReplacementMine)
AND
NOT DB_Destroyed(_Mine)
THEN
PROC_SetOnStage(_Mine, 0);
PROC_SetOnStage(_ReplacementMine, 1);
NOT DB_SavegamePatch_GUS297639_Mines(_Mine, _ReplacementMine);

IF
DB_SavegamePatch_GUS297639_Mines(_Mine, _ReplacementMine)
AND
DB_Destroyed(_Mine)
THEN
PROC_SetOnStage(_Mine, 1);
PROC_SetOnStage(_ReplacementMine, 0);
NOT DB_SavegamePatch_GUS297639_Mines(_Mine, _ReplacementMine);

//END_REGION

//REGION GUS-293946
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag(SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169)
AND
DB_ORI_DarkUrge(_DarkUrge)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_DarkUrge, "Act2_HauntedOne_NightsongKilled");



//END_REGION

//REGION GUS-300596

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
THEN
DB_DropMutingStatussesDialog((DIALOGRESOURCE)SHA_LastJusticiar_RatsPanicked_f5e8d130-fa60-7fbe-906e-27309b0b180d);
DB_BUGFIX_Marker("GUS-300596");

//END_REGION GUS-300596

//REGION GUS-300798
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_WillingToDie_3f22f471-60e6-11df-1c95-19f756f81994)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574,  (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);
DB_BUGFIX_Marker("GUS-300596");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag((FLAG)COL_PartyProgress_EnteredColony_666abe92-f197-4c38-85a8-d879a9e258b6)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574,  (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);
DB_BUGFIX_Marker("GUS-300596");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
THEN
DB_CampNight_CancelledBy((FLAG)NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, COL_PartyProgress_EnteredColony_666abe92-f197-4c38-85a8-d879a9e258b6);
DB_BUGFIX_Marker("GUS-300596");


//END_REGION

//REGION GUS-300728
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
NOT DB_GlobalFlag((FLAG)NIGHT_Wyll_MizorasCapture_3279549a-c467-4630-bd6d-a2aafeb8a2b9)
THEN
DB_BUGFIX_Marker("GUS-300728");
DB_CampNight_CRD((FLAG)NIGHT_Wyll_MizorasCapture_3279549a-c467-4630-bd6d-a2aafeb8a2b9, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (FLAG)ORI_Karlach_IPRD_MizoraInTown_b8daafd5-f52e-4c19-a5bd-76ec45a6ede6);
//END_REGION GUS-300728

//REGION GUS-294724

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "SCL_Main_A", "GUS-294724");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-294724")
THEN
DB_DontCreateMurder(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_BUGFIX_Marker("GUS-294724");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-294724")
AND
DB_DialogName(HAV_Siege_Intro_5ec5abc1-a0d5-5c4e-05bf-b65766c05b99, _)
THEN
DB_BUGFIX_Marker("GUS-294724-2");

//END_REGION

//REGION GUS-300732
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
THEN
DB_BUGFIX_Marker("GUS-300732");
DB_DropMutingStatussesDialog((DIALOGRESOURCE)SHA_Displacer_618b26dd-25a2-f1f1-be8f-79b6dcdcfab6);
//END_REGION GUS-300732

//REGION GUS-300549
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag((FLAG)MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6)
AND
DB_GlobalFlag((FLAG)MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5)
THEN
QuestUpdate("GLO_Moonrise", "FacedKethericMT_NoNS");
DB_BUGFIX_Marker("GUS-300549");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag((FLAG)MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6)
AND
DB_GlobalFlag((FLAG)SHA_Nightsong_State_PermaDefeated_d02e8ea4-dec7-4824-8117-efc075dee4ba)
THEN
QuestUpdate("GLO_Moonrise", "FacedKethericMT_NoNS");
DB_BUGFIX_Marker("GUS-300549");
//END_REGION GUS-300549

//REGION GUS-300627
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_QuestIsOpened("GLO_Moonrise_SUB_MarcusCapture")
AND
DB_GlobalFLag((FLAG)MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce)
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_State_SidedWithSpy_5eb745b2-5043-2f36-4d3a-ee3f09ed7a82)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "CaptureNotMet", 0)
THEN
QuestUpdate("GLO_Moonrise", "MarcusCapturedIsobel");
DB_BUGFIX_Marker("GUS-300627");
//END_REGION GUS-300627

//REGION NOJIRA Fix for SCL Lifting the curse flags freaking out
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
NOT QRY_Patch_SCL_LiftingTheCurse_CurseLifted()
THEN
SetFlag((FLAG)SCL_ShadowCurse_State_Default_13a8d7f3-9942-4c8c-9428-b4af0b433994,NULL_00000000-0000-0000-0000-000000000000,0,1);

QRY
QRY_Patch_SCL_LiftingTheCurse_CurseLifted()
AND
DB_GlobalFlag((FLAG)GLO_LiftingTheCurse_State_BreathHasBeenRestored_2113b54e-a140-4aa0-97ac-219fa7b7d038)
AND
DB_GlobalFlag((FLAG)SCE_Debrief_State_Setup_0ebc6b35-0f07-4a73-b6b8-9782ecbcaccf)
THEN
SetFlag((FLAG)SCL_ShadowCurse_State_CurseLifted_af78af4a-48b2-46a8-be6f-f25dfa579471,NULL_00000000-0000-0000-0000-000000000000,0,1);
//END_REGION

//REGION GUS-305126

PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("INT_Main_A")
AND
DB_GlobalFlag((FLAG)GLO_LiftingTheCurse_State_BreathHasBeenRestored_2113b54e-a140-4aa0-97ac-219fa7b7d038)
THEN
PROC_GlobalSetFlagAndCache(SCL_ShadowCurse_State_CurseLifted_af78af4a-48b2-46a8-be6f-f25dfa579471);
DB_BUGFIX_Marker("GUS-305126");

//END_REGION

//REGION GUS-295639

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_ORI_DarkUrge_ButlerExpectedAtMoonrise(_Point)
AND
DB_GlobalFlag((FLAG)HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
THEN
DB_BUGFIX_Marker("GUS-295639");

IF
DB_BUGFIX_Marker("GUS-295639")
AND
DB_ORI_DarkUrge_ButlerExpectedAtMoonrise(_Point)
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
THEN
NOT DB_ORI_DarkUrge_ButlerExpectedAtMoonrise(_Point);
PROC_MOO_Assault_ButlerLeaves();


//END_REGION GUS-295639


//REGION GUS-300526
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag(SHA_Shadowheart_State_SharMentionedSpear_e67bb9ed-1a0b-e4db-e0c5-cbae64ba46aa)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_Knows_NeedSpear_27a5363d-4167-4bf9-b4c0-39cf9fca5523);
DB_BUGFIX_Marker("GUS-300526");
//END_REGION GUS-300526

//REGION GUS-301053

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag((FLAG)VISITEDREGION_SCL_Main_A_f6e72539-9bc6-42e1-a20f-390f3a17ad8d)
AND
NOT DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_HAV_Misc_IsInHaven_f6e3f5a0-d553-41f2-9d6e-78cea503c992, (FLAG)HAV_Mood_State_Unprotected_7ac5d939-2c81-4871-81a5-fd5c6a0adba1)
THEN
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_HAV_Misc_IsInHaven_f6e3f5a0-d553-41f2-9d6e-78cea503c992, (FLAG)HAV_Mood_State_Unprotected_7ac5d939-2c81-4871-81a5-fd5c6a0adba1);
DB_BUGFIX_Marker("GUS-301053");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag((FLAG)VISITEDREGION_SCL_Main_A_f6e72539-9bc6-42e1-a20f-390f3a17ad8d)
AND
NOT DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_HAV_Misc_IsInHaven_f6e3f5a0-d553-41f2-9d6e-78cea503c992, (FLAG)HAV_Mood_State_Siege_b509af8b-a331-47ac-8230-3b8c5ef9956b)
THEN
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_HAV_Misc_IsInHaven_f6e3f5a0-d553-41f2-9d6e-78cea503c992, (FLAG)HAV_Mood_State_Siege_b509af8b-a331-47ac-8230-3b8c5ef9956b);
DB_BUGFIX_Marker("GUS-301053");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag((FLAG)VISITEDREGION_SCL_Main_A_f6e72539-9bc6-42e1-a20f-390f3a17ad8d)
AND
NOT DB_TopicalGreetingEndCondition_LeaveTrigger((FLAG)TG_HAV_Misc_IsInHaven_f6e3f5a0-d553-41f2-9d6e-78cea503c992, (TRIGGER)S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab)
THEN
DB_TopicalGreetingEndCondition_LeaveTrigger((FLAG)TG_HAV_Misc_IsInHaven_f6e3f5a0-d553-41f2-9d6e-78cea503c992, (TRIGGER)S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab);
DB_BUGFIX_Marker("GUS-301053");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag((FLAG)HAV_Mood_State_Siege_b509af8b-a331-47ac-8230-3b8c5ef9956b)
AND
DB_Players(_Player)
THEN
ClearFlag((FLAG)TG_HAV_Misc_IsInHaven_f6e3f5a0-d553-41f2-9d6e-78cea503c992, _Player);
DB_BUGFIX_Marker("GUS-301053");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag((FLAG)HAV_Mood_State_Unprotected_7ac5d939-2c81-4871-81a5-fd5c6a0adba1)
AND
DB_Players(_Player)
THEN
ClearFlag((FLAG)TG_HAV_Misc_IsInHaven_f6e3f5a0-d553-41f2-9d6e-78cea503c992, _Player);
DB_BUGFIX_Marker("GUS-301053");

//END_REGION GUS-301053

//REGION GUS-301117
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_HAV_LiftingTheCurse_ReactivityVBs((VOICEBARKRESOURCE)HAV_HalsinQuest_VB_WaveSpawned0_8308d5dc-108e-4a0c-b9b7-e9c0b763ee05, 0)
THEN
NOT DB_HAV_LiftingTheCurse_ReactivityVBs((VOICEBARKRESOURCE)HAV_HalsinQuest_VB_WaveSpawned1_bcee5dd5-b2b3-4dfb-805d-35c973078613, 1);
NOT DB_HAV_LiftingTheCurse_ReactivityVBs((VOICEBARKRESOURCE)HAV_HalsinQuest_VB_WaveSpawned2_6f411e3a-3315-74c1-8b73-d026ab864789, 2);
NOT DB_HAV_LiftingTheCurse_ReactivityVBs((VOICEBARKRESOURCE)HAV_HalsinQuest_VB_WaveSpawned3_b6dd47f8-988d-00d0-25c9-f6b87fcd8687, 3);
NOT DB_HAV_LiftingTheCurse_ReactivityVBs((VOICEBARKRESOURCE)HAV_HalsinQuest_VB_WaveSpawned4_d80b8045-6a27-0478-6647-2cc284733fc5, 4);
DB_HAV_LiftingTheCurse_ReactivityVBs((VOICEBARKRESOURCE)HAV_HalsinQuest_VB_WaveSpawned2_6f411e3a-3315-74c1-8b73-d026ab864789, 1);
DB_HAV_LiftingTheCurse_ReactivityVBs((VOICEBARKRESOURCE)HAV_HalsinQuest_VB_WaveSpawned3_b6dd47f8-988d-00d0-25c9-f6b87fcd8687, 2);
DB_HAV_LiftingTheCurse_ReactivityVBs((VOICEBARKRESOURCE)HAV_HalsinQuest_VB_WaveSpawned4_d80b8045-6a27-0478-6647-2cc284733fc5, 3);
DB_BUGFIX_Marker("GUS-301117");

//END_REGION

//REGION GUS-299293
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag(SCL_HarperScouts_State_ShadowsDefeated_bae50f7d-7347-4fb7-ae8a-9fda8f84fc9f)
THEN
NOT DB_CombatReact_AD_OnNextTurn(S_SCL_HarperScout_000_c6dfb2aa-809f-4b3e-8b32-968c10184ec3, (DIALOGRESOURCE)SCL_HarperScouts_AD_HarperScout_000_Combat_9495459c-cf6f-1e44-ea3d-641da8ebe19b);
NOT DB_CombatReact_AD_OnNextTurn(S_SCL_HarperScout_000_c6dfb2aa-809f-4b3e-8b32-968c10184ec3, (DIALOGRESOURCE)SCL_HarperScouts_AD_HarperScout_000_Combat2_9c278c13-063e-df6a-c7fc-b843b67b3731);
NOT DB_CombatReact_AD_OnNextTurn(S_SCL_HarperScout_000_c6dfb2aa-809f-4b3e-8b32-968c10184ec3, (DIALOGRESOURCE)SCL_HarperScouts_AD_HarperScout_000_Combat3_99988a3d-1baa-73c4-f21b-31f7fa23e168);
NOT DB_CombatReact_AD_OnNextTurn(S_SCL_HarperScout_001_25e154f6-d762-4bea-862e-98c48d7ebe3e, (DIALOGRESOURCE)SCL_HarperScouts_AD_HarperScout_001_Combat_98b745d0-cfcb-8b11-2913-2a94411da5cb);
NOT DB_CombatReact_AD_OnNextTurn(S_SCL_HarperScout_003_9bebec18-ca66-42e9-abce-8d6a5f9d2a1b, (DIALOGRESOURCE)SCL_HarperScouts_AD_HarperScout_003_Combat_d51ef7d9-4449-0fb9-53b5-08946ab565ea);
DB_BUGFIX_Marker("GUS-299293");
//END_REGION GUS-299293


//REGION GUS-301257
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_QuestIsOpened("SCL_CursedFist")
AND
DB_Players((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "SCL_CursedFist", "FoundLute", 1)
THEN
PROC_GlobalSetFlagAndCache(SCL_AncientFist_State_KnowsLuteImportant_713fdc97-387d-4baa-8152-a6617d630e44);
DB_BUGFIX_Marker("GUS-301257");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_QuestIsOpened("SCL_CursedFist")
AND
DB_Players((CHARACTER)_Player)
AND
QuestUpdateIsUnlocked(_Player, "SCL_CursedFist", "FoundLuteBeforeArt", 1)
THEN
PROC_GlobalSetFlagAndCache(SCL_AncientFist_State_KnowsLuteImportant_713fdc97-387d-4baa-8152-a6617d630e44);
DB_BUGFIX_Marker("GUS-301257");

//END_REGION

//REGION GUS-301259
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
THEN
NOT DB_QuestDef_ChainedState("GLO_Moonrise", "Altar_IsobelDead", "Infiltrator_RewardedKetheric");
NOT DB_QuestDef_ChainedState("GLO_Moonrise", "Altar_IsobelKidnapped", "Infiltrator_RewardedKetheric");
NOT DB_QuestDef_ChainedState("GLO_Moonrise", "IsobelDead", "CapturedIsobelForZrell");
NOT DB_QuestDef_ChainedState("GLO_Moonrise", "IsobelKidnapped", "CapturedIsobelForZrell");
NOT DB_QuestDef_ChainedState("GLO_Moonrise", "Altar_IsobelDead", "CapturedIsobelForKetheric");
NOT DB_QuestDef_ChainedState("GLO_Moonrise", "Altar_IsobelKidnapped", "CapturedIsobelForKetheric");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_MarcusCapture", "Altar_IsobelDead", "Infiltrator_RewardedKetheric");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_MarcusCapture", "Altar_IsobelKidnapped", "Infiltrator_RewardedKetheric");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_ZrellCapture", "IsobelDead", "CapturedIsobelForZrell");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_ZrellCapture", "IsobelKidnapped", "CapturedIsobelForZrell");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_ZrellCapture", "Altar_IsobelDead", "CapturedIsobelForKetheric");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_ZrellCapture", "Altar_IsobelKidnapped", "CapturedIsobelForKetheric");
DB_BUGFIX_Marker("GUS-301259");
//END_REGION GUS-301259

//REGION GUS-300520
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
DB_MOO_AssaultPositions((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _, _)
AND
NOT DB_PermaDefeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
THEN
PROC_SetAnubisConfig(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "MOO_FlamingSpy");
DB_BUGFIX_Marker("GUS-300520");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_MOO_AssaultPositions((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _, _)
AND
NOT DB_PermaDefeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
NOT DB_MOO_NightsongDeath_Positions(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _)
THEN
DB_MOO_NightsongDeath_Positions(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_MOO_NSDeathPositionPoint_014_b6aa87e5-f916-4cac-86e1-f69345b51ff9);
DB_BUGFIX_Marker("GUS-300520");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,10,0)
AND
DB_MOO_AssaultPositions((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _, _)
AND
NOT DB_PermaDefeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6)
AND
DB_MOO_NightsongDeath_Positions(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, S_MOO_NSDeathPositionPoint_014_b6aa87e5-f916-4cac-86e1-f69345b51ff9)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_NightsongDeath")
THEN
PROC_MOO_NightsongDeath_SetPositions((CHARACTER)S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6,(TRIGGER)S_MOO_NSDeathPositionPoint_014_b6aa87e5-f916-4cac-86e1-f69345b51ff9);
DB_BUGFIX_Marker("GUS-300520");

//END_REGION

//REGION GUS-300063
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
DB_GlobalFlag(SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e)
AND
NOT DB_SCE_RavenguardFollowUp_BlockFF(1)
THEN
PROC_BG3_SaveGamePatches_GUS_300063_TryRemoveRavenGuardFF();
DB_BUGFIX_Marker("GUS-300063");

PROC
PROC_BG3_SaveGamePatches_GUS_300063_TryRemoveRavenGuardFF()
AND
NOT QRY_State_IsBeforeState(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege")
AND
DB_SCE_RavenguardFollowUp_FlamingFists(_Char)
AND
DB_SCE_Debrief_CharactersInEpilogue(_Char)
THEN
SetOnStage(_Char, 0);
NOT DB_SCE_Debrief_CharactersInEpilogue(_Char);

PROC
PROC_BG3_SaveGamePatches_GUS_300063_TryRemoveRavenGuardFF()
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_NightsongDeath")
AND
DB_SCE_RavenguardFollowUp_FlamingFists(_Char)
AND
DB_SCE_Debrief_CharactersInEpilogue(_Char)
THEN
SetOnStage(_Char, 0);
NOT DB_SCE_Debrief_CharactersInEpilogue(_Char);

PROC
PROC_BG3_SaveGamePatches_GUS_300063_TryRemoveRavenGuardFF()
AND
NOT DB_GlobalFlag(HAV_HavenOutcasts_State_FlamingFistsInHaven_f8e5cd60-867a-4584-8c50-1ff917357acc)
AND
DB_SCE_RavenguardFollowUp_FlamingFists(_Char)
AND
DB_SCE_Debrief_CharactersInEpilogue(_Char)
THEN
SetOnStage(_Char, 0);
NOT DB_SCE_Debrief_CharactersInEpilogue(_Char);
//END_REGION 

//REGION GUS-300615
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,11,0)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_StartedTrials", 1)
AND
DB_SHA_RelicJournal_GemsTaken(_Gem)
THEN
DB_SHA_RelicJournal_GemsJournaled((ITEM)_Gem);
DB_BUGFIX_Marker("GUS-300615");
//END_REGION GUS-300615

//REGION GUS-301248
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
THEN
DB_BUGFIX_Marker("GUS-301248");
DB_GlobalFlagReactionAfterDialog((FLAG)SCL_HarperScouts_Event_ShadowCreaturesAppear_8fdb80e6-59fa-4582-8cb0-f44c7f646004, (DIALOGRESOURCE)SCL_HarperScouts_ShadowCreatures_f0f39648-db0f-8153-e626-185cae06033f);

//END_REGION GUS-301248

//REGION GUS-296849
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_Assault")
THEN
SysCompleteGoal("Act2_MOO_NightsongDeath");
DB_BUGFIX_Marker("GUS-296849");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5)
THEN
SysCompleteGoal("Act2_MOO_NightsongDeath");
DB_BUGFIX_Marker("GUS-296849");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_Assault")
AND
NOT DB_Defeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84) 
AND
DB_GlobalFlag(MOO_Execution_Knows_Executioner_53052e40-df9b-90a0-ad65-f2c06f996666) 
AND
NOT DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e) 
AND
NOT DB_GlobalFlag(MOO_Assault_State_AllyReadyPositions_f0316e51-b885-472a-a8db-b5cf64aca732) //Haven't entered the tower yet
AND
NOT DB_GlobalFlag(MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6) 
THEN
NOT DB_MOO_Assault_EnemyGroups("MOO_Assault_BazaarEnemies");
DB_MOO_Assault_NeutralGroups("MOO_Assault_BazaarEnemies");
NOT DB_OnlyOnce("MOO_Assault_BazaarSetHostile");
PROC_BG3_SaveGamePatches_GUS_296849_UndoNightsongDeathStateFactionSwitch();
DB_BUGFIX_Marker("GUS-296849");

PROC
PROC_BG3_SaveGamePatches_GUS_296849_UndoNightsongDeathStateFactionSwitch()
AND
DB_MOO_AssaultPositions(_Char,_Trigger,"MOO_Assault_BazaarEnemies")
THEN
PROC_MOO_Assault_SetFactions(_Char, "MOO_Assault_BazaarEnemies");

//END_REGION

//REGION GUS-301051
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
NOT QRY_State_IsBeforeState(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege")
AND
DB_OneShot_VoiceBarkTrigger(S_HAV_EnteringHaven_MoonshieldVBTrigger_7cb5f342-96db-48c7-95e1-98a1e439d03b, (VOICEBARKRESOURCE)HAV_EnteringHaven_VB_Moonshield_e7b5450d-0c48-c997-62ac-88f09e7b1dd2, "Global")
THEN
DB_BUGFIX_Marker("GUS-301051");
PROC_RemoveOneShotVoiceBarkTrigger((TRIGGER)S_HAV_EnteringHaven_MoonshieldVBTrigger_7cb5f342-96db-48c7-95e1-98a1e439d03b, (VOICEBARKRESOURCE)HAV_EnteringHaven_VB_Moonshield_e7b5450d-0c48-c997-62ac-88f09e7b1dd2);
//END_REGION GUS-301051

//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,15,0)
THEN
DB_BUGFIX_Marker("GUS-301051-1");
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,15,0)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c)
THEN
DB_BUGFIX_Marker("GUS-301051-2");
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Act2End_05706143-82c3-616d-6850-9281f08c9b9f, (FLAG)ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df);

//END_REGION


//REGION GUS-299645
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
NOT DB_CampNight_Completed((FLAG)NIGHT_Wyll_MizorasCapture_3279549a-c467-4630-bd6d-a2aafeb8a2b9)
THEN
DB_CampNight_CRD((FLAG)NIGHT_Wyll_MizorasCapture_3279549a-c467-4630-bd6d-a2aafeb8a2b9,(CHARACTER)S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d,(DIALOGRESOURCE)Wyll_InParty_6dff0a1f-1a51-725d-6e9a-52b5742ba9e6,Wyll_InParty2_Event_DiscussedLemure_b9e7a27f-b1a3-6f3b-32e7-dddbf17d589c);
DB_CampNight_EveryCRDGetsExclamationMark((FLAG)NIGHT_Wyll_MizorasCapture_3279549a-c467-4630-bd6d-a2aafeb8a2b9);

//END_REGION

//REGION GUS-301399
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
DB_SCL_Drider_PartOfEscort(_CaravanMember)
THEN
DB_BUGFIX_Marker("GUS-301399");
PROC_SCL_Drider_EnableForceUpdate(_CaravanMember);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,12,0)
AND
DB_SCL_Drider_LeadingEscort(1)
THEN
DB_BUGFIX_Marker("GUS-301399");
PROC_SCL_Drider_EnableForceUpdate(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab);
//END_REGION GUS-301399

//REGION GUS-299493
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 3")
AND
DB_SCL_Drider_CaravanMemebersAtTown(_CaravanMember)
THEN
DB_BUGFIX_Marker("GUS-299493");
DB_SCL_ShadowCurse_CustomCombatGroup("SCL_Drider_Cursed", _CaravanMember);
SetCombatGroupID(_CaravanMember, "SCL_Drider_Cursed");
//END_REGION GUS-299493

//REGION GUS-300737
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4,0,14,0)
AND
NOT DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_PermaDefeated(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d)
AND
NOT DB_GlobalFlagReactionAfterDialog((FLAG)SHA_NightsongPrison_Event_NecroSummonsSkellies_8649c31d-15bf-dd68-5cc0-828e6f44af0f, (DIALOGRESOURCE)SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385)
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)SHA_NightsongPrison_Event_NecroSummonsSkellies_8649c31d-15bf-dd68-5cc0-828e6f44af0f, (DIALOGRESOURCE)SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385);
DB_BUGFIX_Marker("GUS-300737");
//END_REGION GUS-300737

//REGION GUS-302427
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 1")
AND
IsTagged(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6, 0)
AND
GetFlag(ORI_State_Recruited_e78c0aab-fb48-98e9-3ed9-773a0c39988d, S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 0)
THEN
SetTag(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
DB_BUGFIX_Marker("GUS-302427");
//END_REGION GUS-302427

//REGION GUS-302544

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 2")
AND
GetHostCharacter(_Player)
THEN
RealtimeObjectTimerLaunch(_Player, "GUS-302544Timer", 1000); 
//There seems to be an issue where the join combat completes osiris side but is ignored by code within the time frame of the patch application. This will need to be fixed by code

IF
ObjectTimerFinished(_, "GUS-302544Timer")
AND
DB_GLO_NarrativeCombat_ID("MOO_Assault_KethericRoofFight", _ID)
AND
DB_GLO_NarrativeCombat_WasParticipant("MOO_Assault_KethericRoofFight", _ID, _Char)
AND
NOT DB_OffStage(_Char)
AND
NOT DB_Defeated(_Char)
AND
NOT DB_PartyMembers((CHARACTER)_Char)
AND
NOT DB_GLO_NarrativeCombat_GenericExceptionParticipant("MOO_Assault_KethericRoofFight", _Char) //Excludes checking Nightsong or Ketheric
THEN
TriggerRegisterForCharacter(S_MOO_NarrativeCombatRoofRegion_9a1c091e-f8da-4ab6-bdf0-e0db176e4ca3, _Char);
PROC_GLO_NarrativeCombat_JoinCombat("MOO_Assault_KethericRoofFight", _Char);
DB_BUGFIX_Marker("GUS-302544");

//END_REGION

//REGION GUS-302004

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 2")
THEN
PROC_BG3_SaveGamePatches_GUS_302004_RemoveUpperFloorCombatGroup();

PROC
PROC_BG3_SaveGamePatches_GUS_302004_RemoveUpperFloorCombatGroup()
AND
GetCombatGroupID(S_MOO_ExecutionerOgre_234ee81c-4fea-4aa5-adb4-670a73fdc511,  "MOO_ZrellBriefing_Squad")
THEN
SetCombatGroupID(S_MOO_ExecutionerOgre_234ee81c-4fea-4aa5-adb4-670a73fdc511, "");
DB_BUGFIX_Marker("GUS-302004");

PROC
PROC_BG3_SaveGamePatches_GUS_302004_RemoveUpperFloorCombatGroup()
AND
GetCombatGroupID(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84,  "MOO_ZrellBriefing_Squad")
THEN
SetCombatGroupID(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "");
DB_BUGFIX_Marker("GUS-302004");

PROC
PROC_BG3_SaveGamePatches_GUS_302004_RemoveUpperFloorCombatGroup()
AND
GetCombatGroupID(S_MOO_UpperGuard_000_556cec90-5ea1-4054-9874-abd8ee042703,  "MOO_ZrellBriefing_Squad")
THEN
SetCombatGroupID(S_MOO_UpperGuard_000_556cec90-5ea1-4054-9874-abd8ee042703, "");
DB_BUGFIX_Marker("GUS-302004");

PROC
PROC_BG3_SaveGamePatches_GUS_302004_RemoveUpperFloorCombatGroup()
AND
GetCombatGroupID(S_MOO_UpperGuard_001_3b5ad058-c872-4b1c-933b-2d8767b28aed,  "MOO_ZrellBriefing_Squad")
THEN
SetCombatGroupID(S_MOO_UpperGuard_001_3b5ad058-c872-4b1c-933b-2d8767b28aed, "");
DB_BUGFIX_Marker("GUS-302004");

//END_REGION

//REGION GUS-299826

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6)
THEN
PROC_MOO_Assault_ClearPartyDialogSuppression();
DB_BUGFIX_Marker("GUS-299826");

//END_REGION

//REGION GUS-292544 Added Rotten Reflux PAD and Brewer AD to their DB

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_TWN_AddRottenRefluxADs(1);

IF
DB_TWN_AddRottenRefluxADs(1)
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_PermaDefeated(S_TWN_Distillery_Brewer_4d9e3db3-9a78-4f4b-8101-1dd73c0f3be5)
THEN
DB_CombatReact_AD_AppliedStatus(S_TWN_Distillery_Brewer_4d9e3db3-9a78-4f4b-8101-1dd73c0f3be5, (DIALOGRESOURCE)TWN_Distillery_AD_Brewer_Necro_Combat_a33aed3f-d10a-d6d1-4bfd-c2b05097d7e1, "TWN_DISTILLERY_FORCE_NECRO");
DB_TWN_BrewerCombatVoiceBarks_Statuses("TWN_DISTILLERY_FORCE_NECRO", (DIALOGRESOURCE)TWN_Distillery_PAD_Brewer_Necro_147af4e0-37bf-2f3b-e995-d28b5b6fddf6);
NOT DB_TWN_AddRottenRefluxADs(1);
DB_BUGFIX_Marker("GUS-292544");

//END_REGION

//REGION GUS-285440 Tactician additions for Balthazar in Colony comba
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 2")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_COL_CheckBalthazarRitualItemsDifficultyStatus(1);

IF
DB_COL_CheckBalthazarRitualItemsDifficultyStatus(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
DB_Combat_DifficultyItems((ITEM)S_COL_NecromancerLab_Cage1_a69359df-f551-4e12-9665-c905004bc353, "COL_NECROWOMB_HARDCORE", "HARD");
DB_Combat_DifficultyItems((ITEM)S_COL_NecromancerLab_Cage2_5607107a-0a47-4591-9d7f-8e535fa11a35, "COL_NECROWOMB_HARDCORE", "HARD");
DB_Combat_DifficultyItems((ITEM)S_COL_NecromancerLab_Cage3_35b58c59-c8ca-4e1b-9d6c-d0718aed8c9e, "COL_NECROWOMB_HARDCORE", "HARD");
DB_Combat_DifficultyItems((ITEM)S_COL_NecromancerLab_Cage4_57ba5a61-e161-42c7-a2e0-384f2f9915e8, "COL_NECROWOMB_HARDCORE", "HARD");
DB_Combat_DifficultyItems((ITEM)S_COL_NecromancerLab_Cage5_912dd3ee-51cb-4d82-b225-cf85eeb81d26, "COL_NECROWOMB_HARDCORE", "HARD");
DB_Combat_DifficultyItems((ITEM)S_COL_NecromancerLab_Cage6_878f4593-25e1-4abc-8965-d4e6f9c21a73, "COL_NECROWOMB_HARDCORE", "HARD");
DB_Combat_DifficultyItems((ITEM)S_COL_NecromancerLab_Candle1_1f26256e-2cb9-45b4-ac80-dfd313081681 , "COL_RITUALCANDLE_HARDCORE", "HARD");
DB_Combat_DifficultyItems((ITEM)S_COL_NecromancerLab_Candle2_996f27d7-4072-4729-a433-38dec4cfdbe5 , "COL_RITUALCANDLE_HARDCORE", "HARD");
DB_Combat_DifficultyItems((ITEM)S_COL_NecromancerLab_Candle3_ab318017-e124-4cc7-a51b-85e9bb1a40b0 , "COL_RITUALCANDLE_HARDCORE", "HARD");
NOT DB_COL_CheckBalthazarRitualItemsDifficultyStatus(1);
DB_BUGFIX_Marker("GUS-285440");
//END_REGION

//REGION GUS-285440 Tactician additions for Cloaker combat
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A", "GUS-285440");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-285440")
THEN
DB_SHA_CloakerPhantasmSpawnTrigger((TRIGGER)S_SHA_PhantasmSpawnTrigger_Tactician_d9822968-38fb-49e9-bfc6-4c5e7edc82bc);
//END_REGION

//REGION GUS-302900
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_MOO_Assault_NoHarpersDeadEnemies((CHARACTER)S_MOO_GuardRoom_002_ba3c32e1-ebc2-441a-b121-d7977452c160,(TRIGGER)S_MOO_AssaultNoHarpersDeadEnemyPoint_001_a128b7ea-202a-47eb-96a4-50de144b8482, "MOO_Assault_BazaarEnemies");
DB_MOO_Assault_NoHarpersDeadEnemies((CHARACTER)S_MOO_UpperGuard_000_556cec90-5ea1-4054-9874-abd8ee042703,(TRIGGER)S_MOO_AssaultNoHarpersDeadEnemyPoint_002_581e992b-65ac-4268-9fbc-353a259fb5b2, "MOO_Assault_ThroneRoomEnemies");
DB_MOO_Assault_NoHarpersDeadEnemies((CHARACTER)S_MOO_BazaarGuard_000_1d5cdba7-f2e4-4568-9bb8-94abcf9081d6,(TRIGGER)S_MOO_AssaultNoHarpersDeadEnemyPoint_003_97635157-9c21-4d6e-9317-d0d794144c56, "MOO_Assault_BazaarEnemies");
DB_MOO_Assault_NoHarpersDeadEnemies((CHARACTER)S_MOO_WarehouseGuard_000_d161fc7f-801c-463c-bdbd-f638c8499361,(TRIGGER)S_MOO_AssaultNoHarpersDeadEnemyPoint_003_97635157-9c21-4d6e-9317-d0d794144c56, "MOO_Assault_BazaarEnemies");
DB_BUGFIX_Marker("GUS-302900");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(MOO_Assault_State_InProgress_0f3a8f5d-7402-4220-bebb-d4b21d3db08d)
AND
NOT QRY_MOO_Assault_AnyHarpersWithJaheira()
AND
NOT QRY_MOO_Assault_CanFlamingFistJoin()
THEN
PROC_MOO_Assault_KillAdditionalEnemies();
PROC_BG3_SaveGamePatches_GUS_302900_KillAdditionalEnemies();
DB_BUGFIX_Marker("GUS-302900");

PROC
PROC_BG3_SaveGamePatches_GUS_302900_KillAdditionalEnemies()
AND
DB_MOO_AssaultPositions(_Char, _DeadPoint, "MOO_Assault_DeadEnemy_Radiant")
AND
NOT DB_PermaDefeated(_Char)
THEN
PROC_MOO_Assault_TrySetupChar((CHARACTER)_Char, (TRIGGER)_DeadPoint, "MOO_Assault_DeadEnemy_Radiant");
DB_BUGFIX_Marker("GUS-302900");
//END_REGION

//REGION GUS-300503

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Hotfix 3")
AND
DB_MOO_Prison_DisabledLever(S_MOO_EmergencyLever_976d70e4-edec-4a03-a004-a8e1a6ac86c1)
THEN
NOT DB_RegionPrison("SCL_Main_A_MOO",S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7, S_MOO_PrisonSpawnPoint_aaf10d5a-4018-4a7b-84d5-52f276857eed);
NOT DB_PlayerPrison(S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7,"MOO_PrisonEscape","MOO_PrisonEscape_AD","GB_FUGITIVE_MOO");
NOT DB_PrisonReactionTrigger(S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7,(TRIGGER)S_MOO_CrimeRegionTrigger_f088177f-ceba-4019-8d1d-1c505d046a35);
NOT DB_PrisonReactionTrigger(S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7,(TRIGGER)S_MOO_CrimeRegionTrigger_Prison_0e3f7ebc-9932-488b-aef0-f55660b03cda);
NOT DB_PlayerPrison_Door(S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7, S_MOO_CellGate_003_505c4cbf-0f81-4774-aaff-aecd32a7ef32, "");
NOT DB_PrisonChest(S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7,S_MOO_PrisonChest_3c6a641f-169e-453c-b4ee-234ca670abcc);
NOT DB_PrisonEvidenceChest(S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7,S_MOO_EvidenceChest_2008a62e-8bbb-4981-b01a-1560277a205f);
PROC_MOO_Prison_CheckOpenPlayerCell();
DB_BUGFIX_Marker("GUS-300503");

PROC
PROC_MOO_Prison_CheckOpenPlayerCell()
AND
DB_CurrentLevel("SCL_Main_A")
AND
IsOpened(S_MOO_CellGate_003_505c4cbf-0f81-4774-aaff-aecd32a7ef32, 0)
THEN
Unlock(S_MOO_CellGate_003_505c4cbf-0f81-4774-aaff-aecd32a7ef32);
Open(S_MOO_CellGate_003_505c4cbf-0f81-4774-aaff-aecd32a7ef32);

//END_REGION

//REGION GUS-300489
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
NOT DB_ShovelArea(S_TWN_Distillery_AlchemyStash_BuriedMound_4f0b2658-edb7-4d4c-99c9-cf658a670447, _) // dug out already
AND
NOT DB_GlobalFlag((FLAG)TWN_Distillery_State_FoundAlchemyStash_3c0bc980-c628-4b4e-8009-429227e2056c)
THEN
DB_BUGFIX_Marker("GUS-300489");
PROC_GlobalSetFlagAndCache(TWN_Distillery_State_FoundAlchemyStash_3c0bc980-c628-4b4e-8009-429227e2056c);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
DB_ShovelArea(S_TWN_Distillery_AlchemyStash_BuriedMound_4f0b2658-edb7-4d4c-99c9-cf658a670447, _)  // initialized & not dug out yet
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_PartOfTheTeam(_Player)
AND
GetFlag(TWN_Distillery_Event_LearnedAlchemyStashLocation_a2a8979f-09d1-4ef9-87b4-9662760ab248, _Player, 1)
THEN
DB_BUGFIX_Marker("GUS-300489");
DB_GLO_Bugfix_300489_RevealDistilleryMound(_Player);

IF
DB_GLO_Bugfix_300489_RevealDistilleryMound(_Player)
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_GLO_Bugfix_300489_DistilleryMoundRevealed(1)
THEN
DB_GLO_Bugfix_300489_DistilleryMoundRevealed(1);
PROC_Shovel_RevealRemoteMound(S_TWN_Distillery_AlchemyStash_BuriedMound_4f0b2658-edb7-4d4c-99c9-cf658a670447, (CHARACTER)_Player);
//END_REGION

//REGION GUS-302978

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
THEN
DB_SHA_SilentLibrary_HideMarkerForPatch(1);

IF
DB_SHA_SilentLibrary_HideMarkerForPatch(1)
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_GlobalFlag(SHA_SilentLibrary_State_SecretDoorOpened_2c300a57-0b71-4dc5-9a4f-7290cad0c9bc)
AND
DB_Players(_Player)
THEN
NOT DB_SHA_SilentLibrary_HideMarkerForPatch(1);
DB_BUGFIX_Marker("GUS-302978");
PROC_HideMarker(_Player,"SHA_SilentLibrary_SpearOfTheNight");

//END_REGION GUS-302978

//REGION GUS-297146
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
DB_GlobalFlag((FLAG)GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e)
AND
DB_ORI_Karlach_ForgingOfTheHeart_HasSeenDammonInLevel("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-297146");
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindDammon_Act3");
//END_REGION GUS-297146

//REGION GUS-303578
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-303578");
NOT DB_GLO_Backgrounds_Goal((TAG)SOLDIER_d135f265-c2e1-4077-a836-b548ee871681, "Act2_Soldier_SheathedSword", 9960705b-2dd1-45f6-9681-458ecbda4bd0);
DB_GLO_Backgrounds_Goal((TAG)SOLDIER_d135f265-c2e1-4077-a836-b548ee871681, "Act2_Soldier_SheathedSword", b9a21732-4af4-456e-a011-f3b98baef85b);
DB_GLO_Backgrounds_Goal((TAG)SOLDIER_d135f265-c2e1-4077-a836-b548ee871681, "Act2_Soldier_NoInsurance", 9960705b-2dd1-45f6-9681-458ecbda4bd0);
//END_REGION

//REGION GUS-303384
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_TWN_Tollhouse_FacesCombatPositions(_Face, _)
THEN
DB_BUGFIX_Marker("GUS-303384");
SetTag(_Face, (TAG)MONSTER_90101158-141e-4896-8e60-f8db03f6dde3);
//END_REGION GUS-297146

//REGION GUS-298414
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_SHA_SilentLibrary_PatchDoor(1);

IF
DB_SHA_SilentLibrary_PatchDoor(1)
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_GlobalFlag(SHA_SilentLibrary_State_SecretDoorOpened_2c300a57-0b71-4dc5-9a4f-7290cad0c9bc)
THEN
NOT DB_SHA_SilentLibrary_PatchDoor(1);
Open((ITEM)S_DoorProxy_SharTemple_SecretSlidingPuzzleDoor_a4a89659-018b-432f-8ca5-e3b4227c9e69);
DB_BUGFIX_Marker("GUS-298414");
//END_REGION GUS-298414

//REGION GUS-300747

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_QuestDef_State((FLAG)SHA_LastJusticiar_State_SharedTreasure_bbd04557-5cae-4802-aa7e-9cb86af7b698, "SHA_OldEnemy", "RatDeal")
THEN
NOT DB_QuestDef_State((FLAG)SHA_LastJusticiar_State_SharedTreasure_bbd04557-5cae-4802-aa7e-9cb86af7b698, "SHA_OldEnemy", "RatDeal");
DB_SHA_LastJusticiar_KnowledgeFlag((FLAG)SHA_LastJusticiar_Knows_JusticiarStateBedReveal_6fbc2e53-9664-46b8-832e-2175a43631e9);
DB_SHA_LastJusticiar_KnowledgeFlag((FLAG)SHA_LastJusticiar_Knows_InfernalRitual_4ca0b9a8-503a-4a5e-990e-17d86762b0ca);
DB_BUGFIX_Marker("GUS-300747");

//END_REGION GUS-300747

//REGION GUS-303735
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelLoadedOnce("INT_Main_A")
THEN
PROC_CharacterDisableCrime(S_HAV_AncientFist_MartCullagh_378938e2-2193-49a3-a06e-8e26cc128055, "DangerousMonsterReaction");
PROC_CharacterDisableCrime(S_HAV_AncientFist_MartCullagh_378938e2-2193-49a3-a06e-8e26cc128055, "DangerousMonsterReactionFallback");
PROC_CharacterDisableCrime(S_HAV_AncientFist_MartCullagh_378938e2-2193-49a3-a06e-8e26cc128055, "DangerousMonsterReaction_Beast");
PROC_CharacterDisableCrime(S_HAV_AncientFist_MartCullagh_378938e2-2193-49a3-a06e-8e26cc128055, "DangerousMonsterReactionFallback_Beast");
PROC_CharacterDisableCrime(S_HAV_AncientFist_MartCullagh_378938e2-2193-49a3-a06e-8e26cc128055, "DangerousMonsterReactionFallback_Beast_Spider");
PROC_CharacterDisableCrime(S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373, "DangerousMonsterReaction");
PROC_CharacterDisableCrime(S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373, "DangerousMonsterReactionFallback");
PROC_CharacterDisableCrime(S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373, "DangerousMonsterReaction_Beast");
PROC_CharacterDisableCrime(S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373, "DangerousMonsterReactionFallback_Beast");
PROC_CharacterDisableCrime(S_HAV_FlamingFist_004_eb083eb6-066c-4693-8fb8-575bc4c71373, "DangerousMonsterReactionFallback_Beast_Spider");
DB_BUGFIX_Marker("GUS-303735");

//END_REGION GUS-303735

//REGION GUS-299464
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_GlobalFlag(SCE_IsobelNightsongReunion_State_ReunionHappened_40d1893e-20b2-407d-a131-0e9d0a0bdf04)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)S_SCE_ReunionDialog_StartTrigger_60bde26f-d9d2-499e-b062-1933658c3f42);
DB_BUGFIX_Marker("GUS-299464");
//END_REGION GUS-299464

//REGION GUS-302256
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_MOO_Jailbreak_TrackedPrisoner(_Prisoner, _)
AND
NOT DB_MOO_Jailbreak_Prisoner(_Prisoner, _)
AND
DB_CharacterAllCrimesDisabled(_Prisoner)
THEN
PROC_CharacterEnableAllCrimes(_Prisoner);
//END_REGION 

//REGION GUS-303278
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
NOT DB_Dialog_AddAllNearbyPlayersAtStart((DIALOGRESOURCE)MOO_EntranceCheckpoint_1093e6c8-71d0-fdd2-3729-71325e273403);
DB_BUGFIX_Marker("GUS-303278");
//END_REGION GUS-303278

//REGION GUS-304008
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(COL_PartyProgress_EnteredColony_666abe92-f197-4c38-85a8-d879a9e258b6)
AND
DB_MOO_AssaultPositions(_Char, _, _CombatGroup)
AND
GetCombatGroupID(_Char, _CombatGroup)
THEN
SetCombatGroupID(_Char, "");
DB_BUGFIX_Marker("GUS-304008");

//Already went to colony (or beyond)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(COL_PartyProgress_EnteredColony_666abe92-f197-4c38-85a8-d879a9e258b6)
THEN
PROC_MOO_Assault_ClearJaheriaFromAssault();
DB_BUGFIX_Marker("GUS-304008");

//Jaheira is waiting on the roof (harpers are on main floor, flag is not cleared after recruitment)
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(MOO_Assault_State_JaheiraWaitingOnRoof_3f57e1aa-6ed0-4c38-855d-fcf7ddadcffb)
THEN
PROC_MOO_Assault_ClearJaheriaFromAssault();
DB_BUGFIX_Marker("GUS-304008");

//END_REGION

//REGION GUS-303710
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-303710");
DB_HasItemEvent((ITEM)S_TWN_Hospital_ChairRestraintsKey_0848f66f-e4bd-4057-ada7-2c45dadd3165, (FLAG)TWN_Hospital_State_HasSurgicalBedKey_b5dbbbb5-6b24-4451-a3a5-92778311d310);
//END_REGION 

//REGION GUS-303993
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_SCL_Drider_LeadingEscort(1)
THEN
DB_BUGFIX_Marker("GUS-303993");
PROC_CRIME_DisableDangerousShapeshiftReactions((CHARACTER)S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_SCL_Drider_PartOfEscort(_Char)
THEN
DB_BUGFIX_Marker("GUS-303993");
PROC_CRIME_DisableDangerousShapeshiftReactions(_Char);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_SCL_Drider_LeadingEscort(1)
AND
DB_CRIME_KeepingAnEyeOut(_, (CHARACTER)S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _)
THEN
DB_BUGFIX_Marker("GUS-303993");
PROC_CRIME_KeepingAnEyeOut_Stop((CHARACTER)S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_SCL_Drider_PartOfEscort(_Char)
AND
DB_CRIME_KeepingAnEyeOut(_, _Char, _)
THEN
DB_BUGFIX_Marker("GUS-303993");
PROC_CRIME_KeepingAnEyeOut_Stop(_Char);
//END_REGION GUS-303993

//REGION GUS-301864
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-301864");
DB_GLO_Bugfix_301864_FixArabellasParents(1);

IF
DB_GLO_Bugfix_301864_FixArabellasParents(1)
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_GlobalFlag((FLAG)DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
THEN
NOT DB_GLO_Bugfix_301864_FixArabellasParents(1);
SetFlag((FLAG)TWN_ArabellasPowers_State_ParentA_DeadBeforeTown_c5d3fadc-0aae-40ae-8688-8b6c31450a8c);
SetFlag((FLAG)TWN_ArabellasPowers_State_ParentB_DeadBeforeTown_d7007710-b123-4725-9108-2b2e4fb24617);
//END_REGION

//REGION GUS-301270

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)SHA_LastJusticiar_State_Hostile_ed6bc07d-6041-49c3-9fc5-bc604bc8543b)
THEN
DB_SHA_LastJusticiar_PatchRatRemove(1);

IF
DB_SHA_LastJusticiar_PatchRatRemove(1)
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_SHA_LastJusticiar_RatActive(_Rat, _)
THEN
NOT DB_SHA_LastJusticiar_PatchRatRemove(1);
PROC_DisappearOutOfSight(_Rat, "Run" , 0 , "");
DB_BUGFIX_Marker("GUS-301270");

//END_REGION GUS-301270

//REGION GUS-300518
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_CurrentLevel("SCL_Main_A")
THEN
SetFaction(S_SCE_StandingFlamingFist_000_4dac1fd1-221d-477c-be32-8d95f34e5a90, (FACTION)Act2_HAV_FlamingFist_0441904a-424b-46a1-bca7-866333a033d6);
SetFaction(S_SCE_StandingFlamingFist_001_6b13e47a-35e4-4df6-9c7e-236fe960f506, (FACTION)Act2_HAV_FlamingFist_0441904a-424b-46a1-bca7-866333a033d6);
SetFaction(S_SCE_StandingFlamingFist_002_cbb990af-b9b5-4434-a503-3bacf55c042a, (FACTION)Act2_HAV_FlamingFist_0441904a-424b-46a1-bca7-866333a033d6);
SetFaction(S_SCE_StandingFlamingFist_003_9741b260-2595-402b-a262-7a5391934f14, (FACTION)Act2_HAV_FlamingFist_0441904a-424b-46a1-bca7-866333a033d6);
DB_BUGFIX_Marker("GUS-300518");

IF
FlagSet(SCE_Debrief_State_Setup_0ebc6b35-0f07-4a73-b6b8-9782ecbcaccf, _, _)
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_BUGFIX_Marker("GUS-300518")
THEN
SetFaction(S_SCE_StandingFlamingFist_000_4dac1fd1-221d-477c-be32-8d95f34e5a90, (FACTION)Act2_HAV_FlamingFist_0441904a-424b-46a1-bca7-866333a033d6);
SetFaction(S_SCE_StandingFlamingFist_001_6b13e47a-35e4-4df6-9c7e-236fe960f506, (FACTION)Act2_HAV_FlamingFist_0441904a-424b-46a1-bca7-866333a033d6);
SetFaction(S_SCE_StandingFlamingFist_002_cbb990af-b9b5-4434-a503-3bacf55c042a, (FACTION)Act2_HAV_FlamingFist_0441904a-424b-46a1-bca7-866333a033d6);
SetFaction(S_SCE_StandingFlamingFist_003_9741b260-2595-402b-a262-7a5391934f14, (FACTION)Act2_HAV_FlamingFist_0441904a-424b-46a1-bca7-866333a033d6);
DB_BUGFIX_Marker("GUS-300518");

//END_REGION GUS-300518

//REGION GUS-303755

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_SHA_Trials_MirrorCharacters(_Double, _)
THEN
DB_Tadpole_TadpoleBurstException(_Double);
DB_BUGFIX_Marker("GUS-303755");

//END_REGION GUS-303755

//REGION GUS-302978

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag((FLAG)SHA_SilentLibrary_SpearOfTheNightSecret_54d1eca1-45a5-493d-b638-bc7f94b300e1)
AND
DB_GlobalFlag(SHA_SilentLibrary_State_SecretDoorOpened_2c300a57-0b71-4dc5-9a4f-7290cad0c9bc)
THEN
DB_SHA_SilentLibrary_SpearMarker(1);

IF
DB_SHA_SilentLibrary_SpearMarker(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
NOT DB_SHA_SilentLibrary_SpearMarker(1);
PROC_HideMarker(NULL_00000000-0000-0000-0000-000000000000, "SHA_SilentLibrary_SpearOfTheNight");
DB_BUGFIX_Marker("GUS-302978");

//END_REGION GUS-302978

//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
DB_DEN_CurrentDefenderLeader(_Leader)
AND
_Leader != S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a
AND
DB_DEN_CurrentDefenderLeader(S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a)
THEN
NOT DB_DEN_CurrentDefenderLeader(S_DEN_TieflingLeader_475200ee-cc3c-4dbe-84b1-1820c02ea26a);
ClearFlag(HAV_TieflingSurvivors_State_ZevlorWasLeader_0d1c95e7-994d-cc63-26ea-5d2ee41d0177);

//END_REGION

//REGION GUS-304683
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelLoadedOnce("INT_Main_A")
AND
DB_GlobalFlag(SCL_OliversDiary_Event_RestoreAtHouse_29634249-bce8-4332-9683-0860f129184c)
AND
NOT DB_GlobalFlag(GLO_LiftingTheCurse_State_BreathHasBeenRestored_2113b54e-a140-4aa0-97ac-219fa7b7d038)
THEN
DB_SCL_OliversDeadBugfixMarker(1);
DB_BUGFIX_Marker("GUS-304683");

IF
DB_SCL_OliversDeadBugfixMarker(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
SetHasDialog(S_SCL_OliversDiary_OliverShadow_4f6e63a1-b143-46b1-ac0e-834494dfdc6a, 1);
NOT DB_SCL_OliversDeadBugfixMarker(1);
//END_REGION GUS-304683

//REGION GUS-304188
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_InRegion(S_GLO_DevilishOx_49eb5b4b-c6ed-4d37-8f68-97b1128b7d56, S_HAV_OxPaddock_1c300edd-42c4-43a0-9bd8-ee313cb0569e)
AND
NOT DB_Defeated(S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79)
THEN
TeleportTo(S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, S_HAV_TieflingSurvivors_BlacksmithSpot_1_cfe93bf1-55c4-423d-8d85-f650bfb2afef, "Dammon_GoToLastLight");
DB_BUGFIX_Marker("GUS-304188");
//END_REGION GUS-304188

//REGION GUS-306197
//checking the ox is in Haven, as it should be, and setting it up correctly if so
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
GetRegion(S_GLO_DevilishOx_49eb5b4b-c6ed-4d37-8f68-97b1128b7d56, "SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-306197");
PROC_GLO_DevilishOx_TeleportIfAlive();
//END_REGION GUS-306197

//REGION GUS-296638

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
DB_ORI_Shadowheart_TrialUpdates((ITEM)S_SHA_TrialGem_000_5e3d0d3b-6fcf-48b8-a10c-580ff4efd1ff, "CompletedStealthTrial");
DB_ORI_Shadowheart_TrialUpdates((ITEM)S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, "CompletedCloneTrial");
DB_ORI_Shadowheart_TrialUpdates((ITEM)S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, "CompletedDarknessTrial");
DB_BUGFIX_Marker("GUS-296638");

//END_REGION GUS-296638

//REGION GUS-304319

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_OffStage(S_SHA_LastJusticiar_594ba359-ce55-4b54-9efc-94eca306c540)
AND
NOT DB_PermaDefeated(S_SHA_LastJusticiar_594ba359-ce55-4b54-9efc-94eca306c540)
AND
NOT DB_DialogNPCs(_, S_SHA_LastJusticiar_594ba359-ce55-4b54-9efc-94eca306c540, _)
AND
NOT DB_Is_InCombat(S_SHA_LastJusticiar_594ba359-ce55-4b54-9efc-94eca306c540, _)
AND
DB_InRegion((CHARACTER)_Char, (TRIGGER)S_SHA_LastJusticiar_NegotiationArea_002_7ec4ae2a-d61b-441e-bc8e-a9e437a2b468)
THEN
PROC_EnterCombat(_Char, S_SHA_LastJusticiar_594ba359-ce55-4b54-9efc-94eca306c540);
DB_BUGFIX_Marker("GUS-304319");

//END_REGION GUS-304319

//REGION GUS-306193
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Hotfix 1")
AND
DB_MOO_UnwelcomeVisitors_VisitorCrimeRegistered(_Visitor, _CrimeID)
AND
NOT DB_PartyMembers(_Visitor)
THEN
DB_BUGFIX_Marker("GUS-306193",_Visitor);
CrimeConfrontationDone(_CrimeID,_Visitor);
CharacterStopCrimeWithID(_Visitor, _CrimeID);
NOT DB_MOO_UnwelcomeVisitors_VisitorCrimeRegistered(_Visitor, _CrimeID);
//END_REGION

//REGION GUS-302457

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_HAV_FlorrickShouldLeave(1)
THEN
NOT DB_HAV_FlorrickShouldLeave(1);
PROC_GlobalSetFlagAndCache((FLAG)HAV_Florrick_State_LeaveForCity_28f9ed3b-83e0-da1c-595d-2dcb8ffdafc4);

//END_REGION GUS-302457

//REGION GUS-305516

//In absence of CanPickUp patching
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
GetInventoryOwner(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_)
AND
DB_CurrentLevel("SCL_Main_A") //if you have Ketheric's body in your inventory and you're not in the Colony anymore, hey, fair game
THEN
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_COL_Showdown_KethericDeath_Point_21ab3fb3-f5dd-417f-ab4f-d752219ab7d2,"",0,0,0,1,1);

IF
AddedTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,_,_)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,S_COL_Showdown_KethericDeath_Point_21ab3fb3-f5dd-417f-ab4f-d752219ab7d2,"",0,0,0,1,1);

//END_REGION GUS-305516

//REGION GUS-305451
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-305451");
NOT DB_GiveItemToEvent((ITEM)S_HAV_InfernalReward_001_d0c4fde9-1baa-4b35-994b-fd91b1bfd0fc, (FLAG)HAV_TieflingSurvivors_Event_GiveReward_001_c1c4d2eb-ab94-42d0-812c-8985cf0d08e9);
NOT DB_GiveItemToEvent((ITEM)S_HAV_InfernalReward_002_6cf68d5c-aa28-4e77-aaff-5633b00ae1c1, (FLAG)HAV_TieflingSurvivors_Event_GiveReward_002_731a6948-354b-4fef-9688-c01d392549d9);
NOT DB_GiveItemToEvent((ITEM)S_HAV_InfernalReward_003_e8041d43-5059-4316-a0f9-6ab59a0d14d0, (FLAG)HAV_TieflingSurvivors_Event_GiveReward_003_75282b94-d0f5-44df-8b50-724fd09390b0);
DB_GiveNewItemFromTemplateEvent((ITEMROOT)QUEST_HAV_InfernalReward_001_d9863839-e955-47a2-8a06-070f5c3c9541, (FLAG)HAV_TieflingSurvivors_Event_GiveReward_001_c1c4d2eb-ab94-42d0-812c-8985cf0d08e9, 1);
DB_GiveNewItemFromTemplateEvent((ITEMROOT)QUEST_HAV_InfernalReward_002_6d60fcbb-e7a5-47ad-9cca-44565cbc0856, (FLAG)HAV_TieflingSurvivors_Event_GiveReward_002_731a6948-354b-4fef-9688-c01d392549d9, 1);
DB_GiveNewItemFromTemplateEvent((ITEMROOT)QUEST_HAV_InfernalReward_003_b673f1dc-d925-4811-a78e-53adcce847e8, (FLAG)HAV_TieflingSurvivors_Event_GiveReward_003_75282b94-d0f5-44df-8b50-724fd09390b0, 1);
//END_REGION GUS-305451

//REGION GUS-304931
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GLO_Backgrounds_ChainAfterDialogEndedWithGlobalFlag(HAV_MolsDeal_Lanceboard_ThreeWay_3fc20a5a-83a6-e4a9-d9c2-536b0558ec2c, (FLAG)HAV_MolsDeal_State_Lanceboard_ThreeWay_AstarionAskedRaphael_e1fabb89-91f2-d95f-a0e7-2870baebbaae, "Act2_Charlatan_MolRaphaelLanceboard")
THEN
DB_GLO_Backgrounds_ChainAfterDialogEndedWithGlobalFlag(HAV_MolsDeal_Lanceboard_ThreeWay_3fc20a5a-83a6-e4a9-d9c2-536b0558ec2c, (FLAG)HAV_MolsDeal_Event_Lanceboard_ThreeWay_Cheated_77f2effb-1157-4b54-b7b5-4b63d18269c3, "Act2_Charlatan_MolRaphaelLanceboard");
NOT DB_GLO_Backgrounds_ChainAfterDialogEndedWithGlobalFlag(HAV_MolsDeal_Lanceboard_ThreeWay_3fc20a5a-83a6-e4a9-d9c2-536b0558ec2c, (FLAG)HAV_MolsDeal_State_Lanceboard_ThreeWay_AstarionAskedRaphael_e1fabb89-91f2-d95f-a0e7-2870baebbaae, "Act2_Charlatan_MolRaphaelLanceboard");
DB_BUGFIX_Marker("GUS-304931");
//END_REGION GUS-304931

//REGION GUS-305187
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_Is_InCombat(S_SCL_OliversDiary_OliverShadow_4f6e63a1-b143-46b1-ac0e-834494dfdc6a, _ID)
AND
DB_GlobalFlag((FLAG)SCL_LiftingTheCurse_State_OliverFledToTown_47018478-a3ef-42cc-8334-1516c6ed40f7)
AND
NOT DB_GlobalFlag((FLAG)SCL_LiftingTheCurse_State_NightdomeDestroyed_ea76f9be-6d12-441d-8c63-de999d5b3e0c)
THEN
DB_SCL_OliversDiary_ConfrontationCombatID(_ID);
DB_BUGFIX_Marker("GUS-305187");
//END_REGION

//REGION GUS-305406
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_PlayerPrison((TRIGGER)S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7, "MOO_PrisonEscape", "MOO_PrisonEscape_AD", "GB_FUGITIVE_MOO")
AND
NOT DB_ActivePartyTriggers("SCL_Main_A", S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7, 0)
THEN
DB_GLO_Bugfix_305406(1);

IF
DB_GLO_Bugfix_305406(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
NOT DB_GLO_Bugfix_305406(1);
PROC_TriggerRegisterForPlayers((TRIGGER)S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7);
PROC_GLO_Bugfix_305406_RestorePlayer();

PROC
PROC_GLO_Bugfix_305406_RestorePlayer()
AND
DB_CRIME_PrisonArrestedNonShapeshifted(_Player,(TRIGGER)S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7,_ArrestedNotShapeshifted)
AND
DB_IsArrested(_Arrester,_Player)
AND
DB_PlayerPrison((TRIGGER)S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7,(STRING)_PrisonCrimeName,(STRING)_PrisonCrimeNameAD,(STRING)_FugitiveStatus)
THEN
NOT DB_CRIME_PrisonArrestedNonShapeshifted(_Player,(TRIGGER)S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7,_ArrestedNotShapeshifted);
PROC_CRIME_Prison_Escaped(_Player, _Arrester, (TRIGGER)S_MOO_PlayerCell_7b277f0f-3812-42e7-a4f3-e3c94b08e6a7, _ArrestedNotShapeshifted, _PrisonCrimeName, _PrisonCrimeNameAD, _FugitiveStatus);
//END_REGION

//REGION GUS-301716

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_SHA_Disc_ElevatorFix(1);

IF
DB_SHA_Disc_ElevatorFix(1)
AND
DB_CurrentLevel("SCL_Main_A")
AND
NOT DB_SHA_Disc_Moving(_)
AND
DB_SHA_Disc_Destination(1, _Destination, _Stone, _StoneDownPos, _StoneUpPos)
AND
DB_SHA_Disc_CurrentPos(_CurrentStone)
AND
_CurrentStone != NULL_00000000-0000-0000-0000-000000000000
AND
DB_SHA_Disc_SummonStone(_SummonStone, _Destination)
AND
_Stone != _CurrentStone
THEN
DB_BUGFIX_Marker("GUS-301716");
PROC_SHA_Disc_ActivateStone(_SummonStone);

IF
DB_SHA_Disc_ElevatorFix(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
NOT DB_SHA_Disc_ElevatorFix(1);

//END_REGION GUS-301716

//REGION GUS-305738
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_LevelUnreachable("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_EnemyOfSharPath_055bbe0f-05f5-444b-a7e2-0f66edd2178c)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143)
THEN
TemplateAddTo((ITEMROOT)MAG_SHA_SeluneBlessing_Spear_2eeabe97-8f29-4f4f-827e-6cfcd8fd1779, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1, 1);
PROC_GlobalSetFlagAndCache((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143);
DB_BUGFIX_Marker("GUS-305738");
//END_REGION GUS-305738

//REGION GUS-305705
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_QuestIsOpened("SHA_Nightsong")
AND
DB_Avatars(_Avatar)
AND
DB_GlobalFlag(SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731)
AND
QuestUpdateIsUnlocked(_Avatar, "SHA_Nightsong", "NightsongIsAPersonPrison", 1)
THEN
QuestUpdate("SHA_Nightsong", "NightsongWithBalthazar");
DB_BUGFIX_Marker("GUS-305738");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_QuestIsOpened("SHA_Nightsong")
AND
DB_Players(_Player)
AND
GetFlag(SHA_NightsongPrison_Event_StartNightsongFreedDialog_737d8c1e-7970-2c6c-06ec-8ccb3a9bf25e, _Player, 1)
AND
QuestUpdateIsUnlocked(_Player, "SHA_Nightsong", "NightsongIsAPersonPrison", 1)
THEN
QuestUpdate("SHA_Nightsong", "NightsongFreed");
DB_BUGFIX_Marker("GUS-305738");

//END_REGION GUS-305705

//REGION GUS-305500
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
NOT DB_CampNight_Requirement((FLAG)NIGHT_Astarion_Act2RomanceFallback_7c169c4d-c675-483c-8861-c96954ecaa46, (FLAG)GLO_MoonriseTower_EverEnteredBefore_26aeabb0-7644-4897-9bbd-7a95e3e8930f);
DB_CampNight_Requirement((FLAG)NIGHT_Astarion_Act2RomanceFallback_7c169c4d-c675-483c-8861-c96954ecaa46, (FLAG)GLO_MoonriseTower_EverEnteredBefore_26aeabb0-7644-4897-9bbd-7a95e3e8930f, (FLAG)NIGHT_Astarion_RaphaelsRevelation_3a3b2dca-7e94-47af-b81f-93194944c633);
NOT DB_CampNight_Requirement_Approval((FLAG)NIGHT_Astarion_Act2RomanceFallback_7c169c4d-c675-483c-8861-c96954ecaa46, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 50);
DB_CampNight_Requirement_Approval((FLAG)NIGHT_Astarion_Act2RomanceFallback_7c169c4d-c675-483c-8861-c96954ecaa46, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, 70);
DB_BUGFIX_Marker("GUS-305500");
//END_REGION

//REGION GUS-305274
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-305274");
DB_CampNight_CancelledBy((FLAG)NIGHT_Astarion_SeekingRaphael_fed2dd17-fb0d-46b0-8d75-dca07d5c2d76, (FLAG)ORI_Astarion_State_RaphaelLeftMasoleumEntrance_ee881edf-2d4d-40a2-a6f1-c790a01c9ed5);
//END_REGION

//REGION GUS-305503
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-305503");
PROC_GLO_Bugfix_305503();

PROC
PROC_GLO_Bugfix_305503()
THEN
DB_GLO_CompoundFlag(NIGHT_Astarion_Act2RomanceFallback_7c169c4d-c675-483c-8861-c96954ecaa46, ORI_Astarion_State_HadAct2RomanceNight_56890d6d-b019-44f5-8453-e689af158b22);
DB_GLO_CompoundFlag(NIGHT_Astarion_BloodMerchantAftermath_01e87577-fae7-4b09-9d54-4ce4c7b45fe4, ORI_Astarion_State_HadAct2RomanceNight_56890d6d-b019-44f5-8453-e689af158b22);

PROC
PROC_GLO_Bugfix_305503()
AND
DB_GlobalFlag((FLAG)NIGHT_Astarion_Act2RomanceFallback_7c169c4d-c675-483c-8861-c96954ecaa46)
THEN
SetFlag(ORI_Astarion_State_HadAct2RomanceNight_56890d6d-b019-44f5-8453-e689af158b22);

PROC
PROC_GLO_Bugfix_305503()
AND
DB_GlobalFlag((FLAG)NIGHT_Astarion_BloodMerchantAftermath_01e87577-fae7-4b09-9d54-4ce4c7b45fe4)
THEN
SetFlag(ORI_Astarion_State_HadAct2RomanceNight_56890d6d-b019-44f5-8453-e689af158b22);
//END_REGION

//REGION GUS-306914
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(HAV_LiftingTheCurse_Event_AddOliversHouseToMap_dff3b91b-d749-41f7-a6d6-2a3038aa8ee7)
AND
NOT DB_GlobalFlag(SCL_ShadowCurse_Knows_Oliver_Is_Thaniel_56af8bbd-eafe-3861-22a2-c253f16952e2)
THEN
PROC_GlobalSetFlagAndCache(SCL_ShadowCurse_Knows_Oliver_Is_Thaniel_56af8bbd-eafe-3861-22a2-c253f16952e2);
DB_BUGFIX_Marker("GUS-306914");
//END_REGION GUS-306914

//REGION GUS-289239

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_SCE_TieflingFollowUp_MasterBards(_Character)
THEN
NOT DB_SCE_TieflingFollowUp_MasterBards(_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_SCE_Debrief_CharactersInEpilogue((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
AND
QRY_SCE_TieflingFollowUp_AlfiraRequestedBard()
AND
HasActiveStatus((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "PERFORM_POSITIVE_THEPOWER", 1)
THEN
DB_SCE_TieflingFollowUp_DoingPerformance((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);
//other performers will be automatically added when this fact is added

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_SCE_Debrief_Participant_Config((CHARACTER)S_DEN_PickpocketTrader_e1fda08b-45d4-41db-84b5-20e9931ba5af, "SCE_Mattis")
THEN
NOT DB_SCE_Debrief_Participant_Config((CHARACTER)S_DEN_PickpocketTrader_e1fda08b-45d4-41db-84b5-20e9931ba5af, "SCE_Mattis");
NOT DB_SCE_Debrief_Participant_Config((CHARACTER)S_DEN_Trainee_001_1f839ad2-2bcb-47d2-8de9-db7a1fb5d67f, "SCE_Umi");
NOT DB_SCE_Debrief_Participant_Config((CHARACTER)S_DEN_Trainee_002_bd7f31a6-98e8-46cd-97be-4347fa45d387, "SCE_Ide");
NOT DB_SCE_Debrief_Participant_Config((CHARACTER)S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892, "SCE_Cerys");
DB_SCE_Debrief_Participant_Config((CHARACTER)S_DEN_PickpocketTrader_e1fda08b-45d4-41db-84b5-20e9931ba5af, "SCE_Mattis2");
DB_SCE_Debrief_Participant_Config((CHARACTER)S_DEN_Trainee_001_1f839ad2-2bcb-47d2-8de9-db7a1fb5d67f, "SCE_Umi2");
DB_SCE_Debrief_Participant_Config((CHARACTER)S_DEN_Trainee_002_bd7f31a6-98e8-46cd-97be-4347fa45d387, "SCE_Ide2");
DB_SCE_Debrief_Participant_Config((CHARACTER)S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892, "SCE_Cerys2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
GetAnubisConfig(S_DEN_PickpocketTrader_e1fda08b-45d4-41db-84b5-20e9931ba5af,"SCE_Mattis")
THEN
DEV_EnableAnubis(S_DEN_PickpocketTrader_e1fda08b-45d4-41db-84b5-20e9931ba5af,"SCE_Mattis2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
GetAnubisConfig(S_DEN_Trainee_001_1f839ad2-2bcb-47d2-8de9-db7a1fb5d67f,"SCE_Umi")
THEN
DEV_EnableAnubis(S_DEN_Trainee_001_1f839ad2-2bcb-47d2-8de9-db7a1fb5d67f,"SCE_Umi2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
GetAnubisConfig(S_DEN_Trainee_002_bd7f31a6-98e8-46cd-97be-4347fa45d387,"SCE_Ide")
THEN
DEV_EnableAnubis(S_DEN_Trainee_002_bd7f31a6-98e8-46cd-97be-4347fa45d387,"SCE_Ide2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
GetAnubisConfig(S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892,"SCE_Cerys")
THEN
DEV_EnableAnubis(S_DEN_BackupLeader_b304e07d-019c-4ec6-b5ea-c4ccb29ed892,"SCE_Cerys2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_SCE_Debrief_CharactersInEpilogue((CHARACTER)S_DEN_Trainee_002_bd7f31a6-98e8-46cd-97be-4347fa45d387)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
DB_DoNotFace(S_DEN_Trainee_002_bd7f31a6-98e8-46cd-97be-4347fa45d387); //he is sitting during his behaviour animation

//END_REGION GUS-289239

//REGION GUS-224118

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_COL_Vault_Neighbours_Direction((ITEM)_,(ITEM)_)
THEN
PROC_COL_Vault_DefineNeighbourDirections();

//END_REGION GUS-224118

//REGION GUS-169771

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
DB_PermaDefeatedFlag(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,GLO_Wulbren_State_PermaDefeated_1e67b51c-a13d-484b-9bf4-65fbc178b152);
DB_PermaDefeatedFlag(S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5,(FLAG)MOO_GnomePrisoner001_State_PermaDefeated_a75d7674-a909-4252-be15-673b4eeda75c);
DB_PermaDefeatedFlag(S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5,(FLAG)MOO_GnomePrisoner002_State_PermaDefeated_fc079d0c-2c74-437c-aa00-fb358d4658a2);

//END_REGION GUS-169771

//REGION GUS-307220

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
PROC_SCL_FixBanterSpots();
DB_BUGFIX_Marker("GUS-307220");

PROC
PROC_SCL_FixBanterSpots()
AND
DB_GlobalFlag((FLAG)BANTERREGION_SCL_MoonriseApproach_7050230d-bbae-4a97-b2b3-c97409542c1a)
AND
NOT DB_WorldGossip_RegionTrigger(S_PartyBanterTrigger_MoonriseBridge_479844df-dba7-47d9-8d94-efa2f6a10dee, BANTERREGION_SCL_MoonriseApproach_7050230d-bbae-4a97-b2b3-c97409542c1a)
THEN
ClearFlag((FLAG)BANTERREGION_SCL_MoonriseApproach_7050230d-bbae-4a97-b2b3-c97409542c1a);

PROC
PROC_SCL_FixBanterSpots()
AND
DB_GlobalFlag((FLAG)BANTERREGION_MOO_MoonriseTowers_4725d60a-fa99-416f-a888-e02472185de5)
AND
NOT DB_WorldGossip_RegionTrigger((TRIGGER)S_PartyBanterTrigger_Moonrise_12817fe2-43f6-4656-951f-61cae6f77826, (FLAG)BANTERREGION_MOO_MoonriseTowers_4725d60a-fa99-416f-a888-e02472185de5)
THEN
ClearFlag((FLAG)BANTERREGION_MOO_MoonriseTowers_4725d60a-fa99-416f-a888-e02472185de5);

PROC
PROC_SCL_FixBanterSpots()
AND
DB_GlobalFlag((FLAG)BANTERREGION_HAV_Haven_5e5c4c94-cf4f-42d7-a49d-053bc5c7df2b)
AND
NOT DB_WorldGossip_RegionTrigger((TRIGGER)S_PartyBanterTrigger_LastLight_93c166ad-cdbc-49b3-b551-8f3fdd6539ea, (FLAG)BANTERREGION_HAV_Haven_5e5c4c94-cf4f-42d7-a49d-053bc5c7df2b)
THEN
ClearFlag((FLAG)BANTERREGION_HAV_Haven_5e5c4c94-cf4f-42d7-a49d-053bc5c7df2b);

//END_REGION GUS-307220

//REGION GUS-306381
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
IsTagged(S_DEN_ParentA_d6d88c8b-6ba7-4350-b3b3-d60565a44e90, (TAG)ACT2_SHADOW_CURSE_IMMUNE_b47643e0-583c-4808-b108-f6d3b605b0a9, 1)
THEN
DB_BUGFIX_Marker("GUS-306381");
SetFlag((FLAG)TWN_ArabellaPowers_State_MovedToTown_9f385b21-1522-42c8-aa00-64dad6a46237);
//END_REGION GUS-306381

//REGION GUS-295613
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-295613");
NOT DB_QuestDef_State((FLAG)GLO_Pixie_State_KilledByDarkUrge_1ee1a751-e825-d343-4dba-d885d79175c9, "GLO_Moonrise", "ReleasedPixie");
DB_QuestDef_State((FLAG)GLO_Pixie_State_KilledByDarkUrge_1ee1a751-e825-d343-4dba-d885d79175c9, "GLO_Moonrise", "KilledPixie_DarkUrge");
DB_GLO_CompoundFlag((FLAG)GLO_Pixie_State_KilledByDarkUrge_1ee1a751-e825-d343-4dba-d885d79175c9, (FLAG)SCL_Pixie_State_Dead_379ba580-46dc-db81-dae1-581117e54e03);
//END_REGION GUS-295613

//REGION GUS-304861
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_CharacterMovement((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, "HAV_ProdigyLament_RolanLeaves", _)
THEN
DB_BUGFIX_Marker("GUS-304861");
PROC_ClearStoryMove((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_NotifyWhenReadyToMoveOn(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, "HAV_ProdigyLament_RolanLeaves");
//END_REGION GUS-304861

//REGION GUS-292586
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_GUS292586_ReplaceGoblinConfig(1);

IF
DB_BUGFIX_GUS292586_ReplaceGoblinConfig(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-292586");
NOT DB_BUGFIX_GUS292586_ReplaceGoblinConfig(1);
PROC_SetAnubisConfig((CHARACTER)S_SCL_EntryPointGoblin_0e978645-03c3-4fa7-aea4-3b3b04676bfb, "SCL_EntryPointGoblin");
//END_REGION GUS-304861

//REGION GUS-307672

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_CurrentLevel("SCL_Main_A")
AND
QRY_COL_MizorasRescue_CheckTeleportMizoraToSCL()
THEN
DB_BUGFIX_Marker("GUS-307672_MizoraNotInCOL");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_DialogRequestCache_SpeakerList_Speakers(COL_WyllDeath_cc3747c9-7160-cb21-fb1b-a578192d2c3b,_,_MainSpeaker,3)
AND
NOT DB_DialogName(COL_WyllDeath_cc3747c9-7160-cb21-fb1b-a578192d2c3b,_)
THEN
DB_BUGFIX_Marker("GUS-307672_StuckInWyllDeath");
PROC_BUGFIX_GUS_307672_StuckInWyllDeath((CHARACTER)_MainSpeaker);

PROC
PROC_BUGFIX_GUS_307672_StuckInWyllDeath((CHARACTER)_MainSpeaker)
AND
DB_DialogRequestCache_SpeakerList_Speakers(COL_WyllDeath_cc3747c9-7160-cb21-fb1b-a578192d2c3b,_,_Speaker,_)
THEN
PROC_ForceStopDialog(_Speaker);

PROC
PROC_BUGFIX_GUS_307672_StuckInWyllDeath((CHARACTER)_MainSpeaker)
THEN
PROC_COL_MizoraRescue_StartWyllDeath(_MainSpeaker);

//END_REGION GUS-307672

//REGION GUS-307684
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_GUS307684_SetShadowQuakesFactions(1);

IF
DB_BUGFIX_GUS307684_SetShadowQuakesFactions(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-307684");
NOT DB_BUGFIX_GUS307684_SetShadowQuakesFactions(1);
PROC_GLO_Bugfix_307684();

PROC
PROC_GLO_Bugfix_307684()
AND
DB_SHA_Necromancer_Shadowquake(_ShadowQuake, _)
THEN
SetFaction(_ShadowQuake, (FACTION)ACT2_SHA_Justiciars_ShadowQuakes_eac929fa-cfae-4c6e-af11-7bda2e2eb7bf);

PROC
PROC_GLO_Bugfix_307684()
THEN
SetFaction(S_SHA_TadpoledSkeletons_ShadowQuake_0_68513e92-7d3b-44e9-8454-f088c4f47679, (FACTION)ACT2_SHA_Justiciars_ShadowQuakes_eac929fa-cfae-4c6e-af11-7bda2e2eb7bf);
SetFaction(S_SHA_TadpoledSkeletons_ShadowQuake_1_185be763-f4f1-474c-b810-5efecaff3485, (FACTION)ACT2_SHA_Justiciars_ShadowQuakes_eac929fa-cfae-4c6e-af11-7bda2e2eb7bf);
SetFaction(S_SHA_TadpoledSkeletons_ShadowQuake_2_55844999-b524-42c4-a6ad-b91b9e958085, (FACTION)ACT2_SHA_Justiciars_ShadowQuakes_eac929fa-cfae-4c6e-af11-7bda2e2eb7bf);
//END_REGION GUS-307684

//REGION GUS-304595
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_SceneManager(_, "SCE_IsobelNightsongReunion_Scene_MainReunion")
AND
NOT DB_OnlyOnce("SCE_IsobelNightsongReunion_MainReunionStarted")
AND
QRY_OnlyOnce("SCE_IsobelNightsongReunion_SetDoorTrigger")
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)S_SCE_ReunionDialog_DoorStartTrigger_8c2e4f58-b680-47b6-9619-f19e2dd8db0c);
DB_BUGFIX_Marker("GUS-304595");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_SCE_IsobelNightsongReunion_ReunionTriggers((TRIGGER)S_SCE_ReunionDialog_StartTrigger_60bde26f-d9d2-499e-b062-1933658c3f42);
DB_SCE_IsobelNightsongReunion_ReunionTriggers((TRIGGER)S_SCE_ReunionDialog_DoorStartTrigger_8c2e4f58-b680-47b6-9619-f19e2dd8db0c);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelUnreachable("SCL_Main_A")
AND
NOT DB_OnlyOnce("SCE_IsobelNightsongReunion_MainReunionStarted")
AND
DB_GlobalFlag((FLAG)SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa)
THEN
PROC_SCE_NightsongIsobelReunion_MoveNightsongToCamp();
PROC_SCE_NightsongIsobelReunion_MoveIsobelToCamp();
DB_BUGFIX_Marker("GUS-304595");
//END_REGION GUS-304595

//REGION GUS-293603
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_FlagReactionAfterDialog((FLAG)SHA_SpiderMeatHunk_Event_PoisonPlayer_8d37409f-ae04-6161-bfc6-fd538bcdc382, (DIALOGRESOURCE)SHA_SpiderMeatHunk_9e191cf1-75cc-319e-c421-c79b44adab30);
DB_BUGFIX_Marker("GUS-293603");
//END_REGION GUS-293603

//REGION GUS-296185
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_GUS296185_BalthazarNotMessingAround(1);

IF
DB_BUGFIX_GUS296185_BalthazarNotMessingAround(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
NOT DB_BUGFIX_GUS296185_BalthazarNotMessingAround(1);
SetTag(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, (TAG)NOT_MESSING_AROUND_542b58f0-42ad-4157-a28e-27434e0e7b18);
DB_BUGFIX_Marker("GUS-296185");
//END_REGION GUS-296185

//REGION GUS-307713

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_307713_DoFix(1);

IF
DB_BUGFIX_307713_DoFix(1)
AND
DB_CurrentLevel("SCL_Main_A")
THEN
NOT DB_BUGFIX_307713_DoFix(1);
TeleportTo(S_SCE_AlfiraPoint_c19efaf9-20c8-428a-bace-9055f00e1a35,S_SCE_AlfiraPoint_PatchTarget_319fa738-4171-401f-bc61-ef574a197fd8);
TeleportTo(S_SCE_CerysPoint_c0600837-52c0-4e65-ad01-a8af7f15e346,S_SCE_CerysPoint_PatchTarget_8c0b4b81-e95e-40ab-8eb1-80adcb1b2abc);
TeleportTo(S_SCE_MattisPoint_f3df83ee-b69a-4d3c-b4a5-cb992c077b66,S_SCE_MattisPoint_PatchTarget_080ac9c5-fc00-4d41-adb6-ee79f4a0619a);
TeleportTo(S_SCE_UmePoint_df0300cd-5fd3-4ec4-a859-1717ef676599,S_SCE_UmePoint_PatchTarget_5dc47793-e69d-488c-9ab6-f92efaf4a5ed);
TeleportTo(S_SCE_IdePoint_15b5da8b-37ae-43b9-95b7-a551969f29bb,S_SCE_IdePoint_PatchTarget_d6dd758c-7984-4802-ae79-b77fc6e686cd);

//END_REGION GUS-307713

//REGION GUS-169771

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_SpotPlayers(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_RoofTransgression", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000)
THEN
DB_SpotPlayers_IncludeWildshapedPlayers(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_RoofTransgression");
DB_SpotPlayers_TargetIgnoreCantTalk(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_RoofTransgression");

//END_REGION GUS-169771

//REGION GUS-308421
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-308421");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-308421")
THEN
DB_BUGFIX_Marker("GUS-308421");
DB_CampNight((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18, 5900);
DB_CampNight_Camp((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18, "SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18, "SHARTEMPLE");
DB_CampNight_Camp((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18, "HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18, "MOONRISE");
DB_CampNight_Requirement((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18, (FLAG)ORI_Karlach_Event_UnlockFacingDeath_8103a9ee-585b-4209-aaf3-63d44365323f);
DB_CampNight_CancelledBy((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18, (FLAG)ORI_Karlach_State_BlockFacingDeath_2c251f2e-93fc-a5ac-e90f-f489b7847813);
DB_CampNight_CRD((FLAG)NIGHT_Karlach_FacingDeath_2b3b736e-2a59-40df-a4ae-a3dd450c6b18, (CHARACTER)S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (DIALOGRESOURCE)CAMP_Karlach_CRD_FacingDeath_ac41b9da-c61c-aefc-d82f-91744f88b3e6, (FLAG)NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_COL_KethericShowdown_CurrentPhase(3)
THEN
SetFlag((FLAG)ORI_Karlach_Event_UnlockFacingDeath_8103a9ee-585b-4209-aaf3-63d44365323f, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION GUS-308421

//REGION GUS-286099
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-286099");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-286099")
AND
DB_SHA_EntrancePuzzle_RingsVFX(_RingID, _VFX)
THEN
NOT DB_SHA_EntrancePuzzle_RingsVFX(_RingID, _VFX);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-286099")
THEN
DB_BUGFIX_Marker("GUS-286099");
DB_SHA_EntrancePuzzle_RingsVFX("SHA_InnerRing", (EFFECTRESOURCE)VFX_Script_SHA_Forcefield_Inner_01_59f36fd7-fdbe-e30d-b4c0-47f8560abd02, (FLAG)SHA_Crypt_State_InnerRingVisible_0b05bc9e-c819-4a79-93d9-1d9fbe89616b);
DB_SHA_EntrancePuzzle_RingsVFX("SHA_OuterRing", (EFFECTRESOURCE)VFX_Script_SHA_Forcefield_Outer_01_d550c5d2-6a3e-6a98-0094-d64d9f81b719, (FLAG)SHA_Crypt_State_OuterRingVisible_62901c14-3de5-4fb0-8892-b495c5de3ffe);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-286099")
AND
DB_SHA_Crypt_RingsDisabled(1)
AND
DB_SHA_EntrancePuzzle_RingVisible(_Ring, _)
THEN
PROC_SHA_Crypt_SetVisible(_Ring, 0);
//END_REGION GUS-286099

//REGION GUS-281882
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-281882");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-281882")
THEN
PROC_SHA_Necromancer_ZombifieNere();
//END_REGION GUS-281882

//REGION GUS-308195

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-308195");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-308195")
AND
DB_GlobalFlag(SHA_LastJusticiar_State_SharedTreasure_bbd04557-5cae-4802-aa7e-9cb86af7b698)
AND
NOT DB_ActivePartyTriggers("SCL_Main_A", S_SHA_LastJusticiar_StashBox_3f27273c-51f0-4116-8f80-ccd04e0eea44, 0)
THEN
PROC_HidePartyMarker("SHA_LastJusticiarStash");

//END_REGION GUS-308195

//REGION GUS-308509
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_PartOfTheTeam(_TeamMember)
AND
GetFlag(GLO_Companion_LeaveBlocked_4386e3a1-b16e-4331-92ec-29edbc359d51, _TeamMember, 1)
AND
IsInTrigger(_TeamMember, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, 0)
THEN
DB_BUGFIX_Marker("GUS-308509");
ClearFlag((FLAG)GLO_Companion_LeaveBlocked_4386e3a1-b16e-4331-92ec-29edbc359d51, _TeamMember);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
NOT DB_CurrentLevel("SCL_Main_A")
AND
DB_PartOfTheTeam(_TeamMember)
AND
GetFlag(GLO_Companion_LeaveBlocked_4386e3a1-b16e-4331-92ec-29edbc359d51, _TeamMember, 1)
THEN
DB_BUGFIX_Marker("GUS-308509");
ClearFlag((FLAG)GLO_Companion_LeaveBlocked_4386e3a1-b16e-4331-92ec-29edbc359d51, _TeamMember);
//END_REGION GUS-308509

//REGION GUS-302178
PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-302178");
PROC_GLO_Bugfix_302178();

PROC
PROC_GLO_Bugfix_302178()
AND
DB_PartOfTheTeam(_Player)
AND
GetFlag((FLAG)Astarion_InParty_Asked_MissedRaphael_04eb7a31-d4fb-aebd-d3f8-e37eb38313fb, _Player, 1)
AND
QRY_OnlyOnce("Bugfix_302178_ToldAboutMeeting")
THEN
SetFlag((FLAG)ORI_Astarion_State_WasToldAboutRaphaelsQuest_922705bf-1754-4e76-8ee8-eeca44a83c26);

PROC
PROC_GLO_Bugfix_302178()
THEN
DB_GLO_CompoundFlag((FLAG)ORI_Astarion_State_GotQuestFromRaphaelAtMasoleum_31f42f3f-78cd-48d8-a45a-ffb93f4345d1, (FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5);
DB_GLO_CompoundFlag((FLAG)ORI_Astarion_State_GotQuestFromRaphaelAtCamp_263aeee8-54c7-4a5b-8274-48fe7e530856, (FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5);
NOT DB_QuestDef_State((FLAG)ORI_Astarion_State_GotQuestFromRaphael_21b2c417-9d93-4df3-87b6-027e5d1cd4c5, "ORI_COM_Astarion", "MetRaphaelMasoleum");
DB_QuestDef_State((FLAG)ORI_Astarion_State_GotQuestFromRaphaelAtMasoleum_31f42f3f-78cd-48d8-a45a-ffb93f4345d1, "ORI_COM_Astarion", "MetRaphaelMasoleum");
DB_QuestDef_State((FLAG)ORI_Astarion_State_GotQuestFromRaphaelAtCamp_263aeee8-54c7-4a5b-8274-48fe7e530856, "ORI_COM_Astarion", "MetRaphaelCamp");
//END_REGION

//REGION GUS-303966
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT SysStatus("Act2_GLO_ShadowCurse", 2)
AND
DB_PartyMembers(_Character)
AND
DB_CustomDefeatedState(_Character, "SCL_Shadowcurse")
AND
DB_SCL_ShadowCurse_UndeadStatuses(_Status)
THEN
NOT DB_CustomDefeatedState(_Character, "SCL_Shadowcurse");
RemoveStatus(_Character, _Status);

//END_REGION

//REGION GUS-292500

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-292500");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-292500")
THEN
DB_BookFlags((ITEM)S_SHA_SilentLibrary_SharranBook_000_962f60a4-2e41-41bb-8f21-c366aad1b04c, (FLAG)SHA_Trials_Knows_ReadJusticiarBook_7e2e3a0a-c1d0-4438-81b7-a84f8db74aa5);
DB_BookFlags((ITEM)S_SHA_SilentLibrary_TempleLore_2de02be4-be2e-4427-ad16-409541f83d00, (FLAG)SHA_Trials_Knows_ReadTrialsBook_c64a695d-f134-442f-bf74-89aab5973596);

//END_REGION GUS-292500

//REGION GUS-308799
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-308799");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-308799")
THEN
TeleportToPosition(S_SCL_OliverFight_ShadowBarrier_fd308966-e4bd-4346-a80f-bdb60f60e4c5, 19.02, 1.496, -1395.0, "TWN_ShadowBarrierDupeTeleported", 0, 0, 0, 0, 0);

IF
EntityEvent(S_SCL_OliverFight_ShadowBarrier_fd308966-e4bd-4346-a80f-bdb60f60e4c5, "TWN_ShadowBarrierDupeTeleported")
THEN
PROC_SetOnStage(S_SCL_OliverFight_ShadowBarrier_fd308966-e4bd-4346-a80f-bdb60f60e4c5, 0);
//END_REGION

//REGION GUS-308608
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-308608");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-308608")
AND
IsInInventoryOf(S_SCL_HarperBlade_ae92ab6e-f0dc-4d4c-a1b2-b84f01325db6, S_SCL_HarperShadow_000_20fe1b42-edc1-415c-9537-519702284390, 1)
THEN
ToInventory(S_SCL_HarperBlade_ae92ab6e-f0dc-4d4c-a1b2-b84f01325db6, S_SCL_HarperScout_002_a0fecf82-7dde-4dd7-af67-eb0ef5aa67e0);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-308608")
AND
NOT DB_PermaDefeated((CHARACTER)S_SCL_HarperScout_001_25e154f6-d762-4bea-862e-98c48d7ebe3e)
AND
DB_GlobalFlag((FLAG)SCL_HarperScouts_State_InspectionFinished_5356e1fa-6d0b-43cd-9635-62a309096ad1)
THEN
AddGold((CHARACTER)S_SCL_HarperScout_001_25e154f6-d762-4bea-862e-98c48d7ebe3e, 500); // Give her the money for the sword reward.
//END_REGION GUS-308608

//REGION GUS-288226
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-288226");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-288226")
THEN
/*
DB_HAV_LiftingTheCurse_ArenaCams(0, "HAV_LakesideCombat_Wave0_ArenaStart");
DB_HAV_LiftingTheCurse_ArenaCams(1, "HAV_LakesideCombat_Wave1_ArenaStart");
DB_HAV_LiftingTheCurse_ArenaCams(2, "HAV_LakesideCombat_Wave2_ArenaStart");
*/
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave0_Wraith_001_d51f412c-8b40-4141-a65f-057a81d549fb, 4200);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave0_ShadowCursed_Warrior_Pilgrim_003_1a9b065b-d2cd-44c5-95e4-307d6bd82fe7, 3300);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave0_Shadow_007_7e722c07-0bd0-4091-aa5a-d7391404229a, 4000);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave0_Shadow_008_01e7cde6-a4df-403c-87c3-d5377682a6eb, 4400);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave0_Shadow_009_702751d5-1ac0-4399-b02e-972c7258e974, 4600);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave0_ShadowCursed_Warrior_Pilgrim_005_be15abb7-2ea6-4cf8-bf56-bd8465b570e3, 1600);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave0_ShadowCursed_Warrior_Pilgrim_006_2c25ec5b-c162-4579-9f1e-435fbdcfd6e3, 2000);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave4_ShadowMastiff_003_06c47934-bc30-48f0-b297-4f99272d1241, 900);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave4_ShadowMastiff_004_06451f28-98fa-4ab9-9b6b-92edb5ceb9af, 500);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave1_ShadowCursed_Ranger_Harper_005_5e59d1af-a2b7-43b7-8d6c-5a6439a129f6, 2400);
DB_HAV_LiftingTheCurse_Waves(0, (CHARACTER)S_HAV_Wave1_ShadowCursed_Ranger_Harper_007_2112e248-7cbc-4db6-a629-34dd87dc2386, 2900);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave1_ShadowCursed_Ranger_Harper_004_9430b751-a5f9-40bc-888d-e3e8abe4dcf3, 500);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_ShadowCursed_Warrior_Pilgrim_004_9f16d360-533a-43b2-8149-dc39632a4fed, 1300);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_ShadowCursed_Warrior_Pilgrim_007_e0d36900-5a00-4f11-b19b-74512d1554c8, 1600);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave1_ShadowCursed_Ranger_Harper_006_1108b8a5-0d22-4a0e-8973-37b0442f2070, 800);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)DarkVine_Tentacle_000_bb3e4ea7-7f7a-4c65-84c9-de788a2b3d7c, 4000);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)DarkVine_Tentacle_001_abd0896f-555c-43a1-b9d1-71144ff7e87d, 4500);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)DarkVine_Tentacle_002_c172ed73-4f81-4dbe-a577-0d5a56b42ffb, 5000);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave3_ShadowCursed_Melee_FlamingFist_007_66deff82-b495-489b-872a-4b544bc941bc, 1900);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave3_ShadowCursed_Melee_FlamingFist_005_da1e6ca1-6c54-4b82-b94a-901745d64f2e, 2200);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave3_ShadowCursed_Melee_FlamingFist_008_a410b3f0-f025-4fd1-8b90-d8c0d8fd21e6, 2500);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_Raven_Dire_ShadowCursed_007_2ad074e8-a5a4-452e-bcfe-7a946887a539, 3000);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_Raven_Dire_ShadowCursed_008_91b23b1d-0583-4118-81b6-a3f9c18e9fe8, 3100);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_Raven_Dire_ShadowCursed_009_2edb73bb-9831-44d3-bc6f-76b829e5d898, 3200);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_Raven_Dire_ShadowCursed_010_ddb92490-a75d-496e-9b8d-78dcf1f9fef3, 3300);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_Raven_Dire_ShadowCursed_011_77f588f6-e792-4b41-a61c-09bfe44d0bdc, 3400);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_Raven_Dire_ShadowCursed_012_1303ff46-5200-4986-9d73-d85ad7918ec5, 3500);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_Raven_Dire_ShadowCursed_013_fc6da3fd-f4d7-4ebf-b125-7d77387a746f, 3600);
DB_HAV_LiftingTheCurse_Waves(1, (CHARACTER)S_HAV_Wave0_Raven_Dire_ShadowCursed_014_1e41607c-ed56-43bb-9bd2-98de3796d52a, 3700);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave1_ShadowCursed_Warrior_Zealot_005_7c4c46d9-6d0d-4e8a-8473-476eb071bd49, 2000);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave3_ShadowCursed_Melee_FlamingFist_004_1ede9b50-0b85-4a48-8872-738ddd1fc4cd, 2400);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave1_ShadowCursed_Warrior_Zealot_003_4337f668-9c2d-47cc-8530-b620109de1b4, 2800);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave2_Shadow_001_61dfdf61-6860-464a-8e38-bce3458846a7, 4000);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave3_ShadowCursed_Melee_FlamingFist_006_e81fbbc9-a2ec-40e4-800e-fe02acc4fc69, 3500);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave2_Wraith_001_98dde2d9-06c1-4cfd-83b9-a9d2338b514d, 4400);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave3_ShadowCursed_Warrior_Githyanki_005_7052676a-7ba6-442b-8e63-b9670e4384a9, 600);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave3_ShadowCursed_Warrior_Githyanki_004_3ef3995a-a195-4982-987d-4cdf22b98235, 900);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave3_ShadowCursed_Warrior_Githyanki_003_06fe050e-86f5-47f8-bda9-53d91b9f6fdf, 1200);
DB_HAV_LiftingTheCurse_Waves(2, (CHARACTER)S_HAV_Wave1_ShadowCursed_Warrior_Zealot_004_f72a9c81-7fac-4bc2-a6ce-b775e3ea7721, 3200);
PROC_GLO_Bugfix_288226();
DB_BUGFIX_Marker("GUS-288226");

PROC
PROC_GLO_Bugfix_288226()
AND
DB_HAV_LiftingTheCurse_Waves(_Wave, _Shade, 0)
THEN
NOT DB_HAV_LiftingTheCurse_Waves(_Wave, _Shade, 0);
//END_REGION GUS-288226

//REGION GUS-307889
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-307889_SCL");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-307889_SCL")
THEN
Transform(S_HAV_DammonGrindingStone_e9af18c3-67a7-45d7-889a-90880a5426c4, INTERACT_TOOL_Smith_Whetstone_Wheel_B_985bb624-6726-4243-bc6a-9274a95bf5fd, (SHAPESHIFTRULE)Physical_4acc6277-6dcd-4110-9450-b9379beaedac);
//END_REGION GUS-307889

//REGION GUS-309381
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Dialogs((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (DIALOGRESOURCE)SCE_Minthara_b9533573-31a6-bcfe-9f91-fa720373e102)
AND
GetFlag((FLAG)SCE_State_AtEpilogue_3541abb5-6aaf-48c7-bf30-5a13b3abc718, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0)
THEN
DB_BUGFIX_Marker("GUS-309381");
PROC_RemoveAllDialogEntriesForSpeaker(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_Dialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (DIALOGRESOURCE)Minthara_InParty_13d72d55-0d47-c280-9e9c-da076d8876d8);
//END_REGION

//REGION GUS-309398

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_SHA_Trials_GemsNotTaken(S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b)
THEN
DB_BUGFIX_Marker("GUS-309398");
SetFlag(SHA_Trials_Event_TrialPassed_a2bf1d24-4f81-4bae-ac3f-68a5760d122c, (ITEM)S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe); 

//END_REGION GUS-309398

//REGION GUS-308860

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
HasPassive(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "FearOfWolves_Shadowheart", 1)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag((FLAG)CAMP_Shadowheart_State_HadNightsongMeeting_10b74e80-a963-420f-8c2a-d518b6aae143)
THEN
DB_BUGFIX_Marker("GUS-308860");
RemovePassive(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "FearOfWolves_Shadowheart");

//END_REGION GUS-308860

//REGION GUS-309469
// Set caravan members on stage if they were off stage because the harpers moved to the bridge but the players already met them
PROC
PROC_ApplySavegamePatches()
AND
NOT DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
DB_GlobalFlag((FLAG)SCL_Drider_Event_PlayersWillFindCaravanAtAmbush_b3f55a3b-4cbd-4181-8c8f-ecc8ff4eaf9c)
AND
DB_State_Current(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, "SCL_TheDrider", "EscortingCaravan")
AND
DB_OnlyOnce("SCL_Drider_HarpersGoToBridge")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-309469");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-309469")
AND
DB_SCL_Drider_CaravanGroup(_CaravanMember, _)
AND
NOT DB_SCL_Drider_DisappearAndCurseAfterDeactivation(_CaravanMember)
AND
NOT DB_PermaDefeated(_CaravanMember)
THEN
SetOnStage(_CaravanMember, 1);

// Journal entries
// Going back to checkpoint when they left
PROC
PROC_ApplySavegamePatches()
AND
DB_GlobalFlag((FLAG)SCL_Drider_State_CaravanEscortQuestPathBlocked_87e4813d-38af-4188-8c3d-b7d5ba207901)
AND
NOT DB_QuestIsClosed("GLO_Moonrise_SUB_Caravan")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-309469_BacktrackJournalEntry");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-309469_BacktrackJournalEntry")
THEN
DB_BUGFIX_Marker("GUS-309469");
PROC_TriggerRegisterForPlayers((TRIGGER)S_SCL_Drider_CheckpointArea_e5f3735e-9f6b-4526-b3bf-e199c83ef19a);

// Players hiding from the caravan
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-309469");
DB_QuestDef_State((FLAG)SCL_Drider_Event_CaravanAvoided_LeavesToMOO_87691b6f-39e6-eb50-927c-3e1dafbd61b5, "GLO_Moonrise", "HidFromCaravan");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)SCL_Drider_Event_CaravanAvoided_LeavesToMOO_87691b6f-39e6-eb50-927c-3e1dafbd61b5)
THEN
DB_BUGFIX_Marker("GUS-309469");
QuestUpdate("GLO_Moonrise", "HidFromCaravan");

//END_REGION GUS-309469

//REGION GUS-309657
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_InCamp(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_AD_Dialog((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,COL_KethericShowdown_AD_NightsongAfterCombat_d2060999-5499-e1a1-1a45-2f917b2a15f7)
THEN
PROC_RemoveNPCADs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_BUGFIX_Marker("GUS-309657");
//END_REGION GUS-309657

//REGION GUS-304222

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_GlobalFlag(MOO_MintharaFate_Event_TorturersLeave_cd79c131-aabf-7205-7cb7-c0ff5b0afe4f)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-304222");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-304222")
THEN
PROC_SetAnubisConfig(S_MOO_MindTorturer_001_480b89b1-ae6c-46e7-ad79-1b3babe3655e, "MOO_MindTorturer_001");
PROC_SetAnubisConfig(S_MOO_MindTorturer_002_5c744998-b3cb-4edb-8a32-4df06593e849, "MOO_MindTorturer_002");

//END_REGION

//REGION GUS-308617

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-308617");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-308617")
THEN
DB_GLO_FavouredSpeakerConditions("SHA_NightsongPrison_NightsongFateOM", (TAG)AVATAR_306b9b05-1057-4770-aa17-01af21acd650, "Tag", 1);

//END_REGION GUS-308617

//REGION GUS-308622
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-308622");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-308622")
AND
DB_Players(_Player)
THEN
PROC_HideMarker(_Player, "TWN_DeadGithyankiWithMapToCreche");
//END_REGION

//REGION GUS-310306

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-310306");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-310306")
AND
DB_OnlyOnce("COL_KethericShowdown_ChosenThree")
AND
DB_COL_TadpolingCentre_ZevlorInColony(1)
THEN
PROC_COL_TadpolingCentre_ZevlorPodFinished();

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-310306")
AND
DB_OnlyOnce("COL_KethericShowdown_ChosenThree")
AND
DB_COL_TadpolingCentre_DaisyAD_Registered(1)
THEN
PROC_TriggerUnregisterForPlayers(S_COL_TadpolingCentre_DaisyAD_Box_254c466d-ba73-4de6-bd0d-42ea29e232fb);

//END_REGION GUS-310306

//REGION GUS-308987
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-308987");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-308987")
AND
DB_ShadowStoneShadows(_Char, _, "TWN_MasonsGuild_RebelHideout")
AND
NOT DB_Defeated(_Char)
AND
NOT DB_Is_InCombat(_Char, _)
AND
NOT DB_Was_InCombat(_Char, _)
THEN
SetAmbushing(_Char, 1);
//END_REGION

//REGION GUS-311372
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_OnlyOnce("SHA_NightsongPrison_Player_Reached_Prison")
THEN
SetFlag((FLAG)GLO_Nightsong_Knows_Identity_1ef2f1fb-c790-a329-8d1c-4afe4e5cd571, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag((FLAG)SHA_Nightsong_HasMet_6b56f4b8-8bb3-5393-de12-d320fbb55218, NULL_00000000-0000-0000-0000-000000000000, 0);
DB_BUGFIX_Marker("GUS-311372");

//END_REGION

//REGION GUS-306959
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-306959");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-306959")
AND
DB_InCamp(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_GlobalFlag(HAV_LiftingTheCurse_State_HalsinAtLakeside_0bb942dc-420d-45f9-9594-83805760fd29)
THEN
DB_Camp_BlockCamperPosAdjustment(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
TeleportTo(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (TRIGGER)S_HAV_HalsinShorePoint_64c1cdf5-0a4c-462e-a9ea-71e5edc3031d, "", 0, 0, 0, 1, 1);
PROC_RemoveDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323);
DB_Dialogs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, (DIALOGRESOURCE)HAV_HalsinQuest_Portal_0eee8461-c736-e852-ff90-376d32b3823a);
SetHasDialog(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, 1);
DB_BUGFIX_Marker("GUS-306959");
//END_REGION GUS-306959

//REGION GUS-306029
PROC
PROC_ApplySavegamePatches()
AND
DB_GlobalCounter("SHA_LastJusticiar_UltimatumWaveCounter", _Count)
AND
_Count == 0
AND
DB_OnlyOnce("SHA_LastJusticiar_SpawnFallBack")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "SCL_Main_A", "GUS-306029");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-306029")
THEN
PROC_SHA_LastJusticiar_CheckWaveThreshold();
//END_REGION GUS-306029

//REGION GUS-310937
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
GetFlag((FLAG)SHA_NightsongPrison_Event_PermanentlyKillNightsong_097792de-6bd1-e7c9-77d3-fe6419e3170a, S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, 1)
THEN
SetTag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_SHARPATH_9624a3fe-bb9e-47c5-b9ab-417e6da6f84b);
DB_BUGFIX_Marker("GUS-310937");
//END_REGION GUS-310937

//REGION GUS-310154

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-310154");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-310154")
THEN
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)MOO_Assault_State_ConvincedKethericWithMelodia_cbe9f080-3377-92c2-bdb6-6ecb4b1d8bd4, "Act2_Entertainer_KethericRedemptionDialogue");
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)MOO_Assault_State_ConvincedKetheric_dffdf447-f3d6-32ad-2bbb-8f87402fef74, "Act2_Entertainer_KethericRedemptionDialogue");
NOT DB_GLO_Backgrounds_ChainAfterBookClosed((ITEM)S_MOO_MelodiaLetter_80590a99-b86d-4129-b763-c40f89e55e92, "Act2_Entertainer_KethericRedemptionDialogue");

//END_REGION GUS-310154

//REGION GUS-308491

//DB_MOO_WallTentacle_PlayerSpeakers
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT SysCount("DB_MOO_WallTentacle_PlayerSpeakers",1,0) //any facts in this database
THEN
DB_BUGFIX_Marker("GUS-308491"); //done before potentially removing any facts from the database above

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_OnlyOnce("COL_OnFirstEntry")
AND
DB_MOO_WallTentacle_PlayerSpeakers((CHARACTER)_Character)
THEN
NOT DB_MOO_WallTentacle_PlayerSpeakers((CHARACTER)_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_MOO_WallTentacle_PlayerSpeakers((CHARACTER)_Character)
AND
NOT DB_InRegion(_Character,S_MOO_MoonriseTowerNoRoof_SUB_54d40f5d-34e6-42fd-829b-bb2f5facfcda)
THEN
NOT DB_MOO_WallTentacle_PlayerSpeakers((CHARACTER)_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT SysCount("DB_MOO_WallTentacle_PlayerSpeakers",1,0) //any facts in this database
AND
NOT DB_DialogName(MOO_WallTentacle_Tentacle_b923613f-2680-f288-9b36-9da0cf0b06b2,_)
THEN
TimerLaunch("MOO_WallTentacle_Timeout_DaisyAD",20000);



//DB_MOO_Execution_DaisyADAvatar
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT SysCount("DB_MOO_Execution_DaisyADAvatar",1,0) //any facts in this database
THEN
DB_BUGFIX_Marker("GUS-308491-B"); //done before potentially removing any facts from the database above

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_OnlyOnce("COL_OnFirstEntry")
AND
DB_MOO_Execution_DaisyADAvatar((CHARACTER)_Avatar)
THEN
NOT DB_MOO_Execution_DaisyADAvatar((CHARACTER)_Avatar);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_MOO_Execution_DaisyADAvatar((CHARACTER)_Avatar)
AND
NOT DB_InRegion(_Avatar,S_MOO_MoonriseTowerNoRoof_SUB_54d40f5d-34e6-42fd-829b-bb2f5facfcda)
THEN
NOT DB_MOO_Execution_DaisyADAvatar((CHARACTER)_Avatar);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_MOO_Execution_DaisyADAvatar((CHARACTER)_Avatar) //still entries left? Start timeout timer
THEN
RealtimeObjectTimerLaunch(_Avatar,"MOO_Execution_Timeout_DaisyAD",20000);

//END_REGION GUS-308491

//REGION GUS-309785

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)SHA_Orthon_Event_SearchPersuasionSuccess_115ec894-0132-c67e-9eb6-baa4d44afbcc, "Act2_Charlatan_OrhtonContractDetails");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)SHA_OrthonLair_Event_KillOrthonsParty_7f658366-ee8e-459f-ba68-c423bc259fc8, "Act2_Charlatan_OrhtonContractDetails");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)SHA_OrthonLair_Event_OrthonKillsSelf_5779d2a2-1676-463d-905b-699e9c7b1bc7, "Act2_Charlatan_OrhtonContractDetails");
DB_BUGFIX_Marker("GUS-309785");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_BUGFIX_Marker("GUS-309785")
AND
NOT QRY_SHA_OrthonLair_GUS309785_ShouldGiveInspiration()
AND
DB_Players(_Player)
AND
NOT DB_GLO_Backgrounds_Blocked("Act2_Charlatan_OrhtonContractDetails")
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act2_Charlatan_OrhtonContractDetails");

QRY
QRY_SHA_OrthonLair_GUS309785_ShouldGiveInspiration()
AND
NOT DB_GlobalFlag((FLAG)SHA_Orthon_Event_SearchPersuasionSuccess_115ec894-0132-c67e-9eb6-baa4d44afbcc)
AND
NOT DB_GlobalFlag((FLAG)SHA_OrthonLair_Event_KillOrthonsParty_7f658366-ee8e-459f-ba68-c423bc259fc8)
AND
NOT DB_GlobalFlag((FLAG)SHA_OrthonLair_Event_OrthonKillsSelf_5779d2a2-1676-463d-905b-699e9c7b1bc7)
THEN
DB_NOOP(1);

//END_REGION

//REGION GUS-309143

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0);
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f);

//END_REGION GUS-309143

//REGION GUS-310608
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_Players((CHARACTER)_Player)
AND
CharacterGetOwner(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Player)
AND
NOT QRY_MOO_IsInMOO(_Player)
AND
DB_GlobalFlag((FLAG)MOO_MintharaFate_State_ToCamp_4e0701b1-c16d-4017-8be6-5781c3c682f4)
THEN
RemovePartyFollower(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Player);
//END_REGION
//REGION GUS-311406

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-311406");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-311406")
AND
DB_SHA_Trials_GemSockets_Counters(_Socket, _Counter)
THEN
PROC_SHA_Trials_ResolveTrialsThroughGems(_Counter);

//END_REGION GUS-311406

//REGION GUS-311648
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-311648");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-311648")
THEN
DB_QuestDef_State_ConditionalFlag((FLAG)TWN_ArabellaPowers_State_MovedToCamp_b5f880bc-272e-e8a3-8ca1-b3dca3bce191, "TWN_FindArabellasParents", "ArabellaStart", 0, (FLAG)TWN_ArabellasPowers_State_ParentsFoundDead_e3077a60-12dd-fe83-bc56-f646091d4029);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)TWN_ArabellaPowers_Event_AskedForHelp_7537b739-d975-625f-fb7f-d037d8a90bf2, "TWN_FindArabellasParents", "ArabellaStart", 0, (FLAG)TWN_ArabellasPowers_State_ParentsFoundDead_e3077a60-12dd-fe83-bc56-f646091d4029);
//END_REGION GUS-311648

//REGION GUS-299334
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-299334");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-299334")
AND
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa)
THEN
SetOnStage(S_SHA_SoulCage_1f62df99-914d-83b8-38cf-35708001f20c, 0);

//END_REGION GUS-299334

//REGION GUS-300544
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_BUGFIX_Marker("GUS-300544");
DB_MOO_Alarm_EyeCrimes("Steal", "MOO_Eye_SpottedTheft");
DB_MOO_Alarm_EyeCrimes("Vandalise", "MOO_Eye_SpottedVandalism");

//END_REGION

//REGION GUS-311162
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-311162");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-311162")
AND
IsOpened(S_SHA_NightsongChamberDoor_4689976f-7fe3-4d5f-933a-e872ce947d93, 1)
AND
NOT DB_GlobalFlag((FLAG)SHA_Trials_State_LeverUnlocked_65f3ee21-78b0-46c3-a36b-f81b11497a24)
THEN
PROC_GlobalSetFlagAndCache((FLAG)SHA_Trials_State_LeverUnlocked_65f3ee21-78b0-46c3-a36b-f81b11497a24);

//END_REGION GUS-311162

//REGION GUS-312081

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
HasAppliedStatus(S_COL_ResonanceStone_f487943a-3448-475d-a176-43cf2174a59c,"COL_RESONANCESTONE_AURA",0)
THEN
ApplyStatus(S_COL_ResonanceStone_f487943a-3448-475d-a176-43cf2174a59c,"COL_RESONANCESTONE_AURA",-1.0);
DB_BUGFIX_Marker("GUS-312081_RESONANCESTONE");

PROC
PROC_ApplySavegamePatches()
AND
NOT DB_PermaDefeatedOrOffstage(S_COL_Barracks_MistressOfSouls_6068a46e-bbe4-4fc6-b955-cd8886fa5542)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-312081_DARKURGE");

//If the spotting was stopped without the Dark Urge OM triggering, too bad for this playthrough
//We can however make it trigger if the Dark Urge talks to Kressa after the blessing is over
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-312081_DARKURGE")
THEN
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)COL_Barracks_MistressOfSouls_898cb681-7b6e-3607-7ddd-ffc09378dfb3,
(TAG)DARK_URGE_fe825e69-1569-471f-9b3f-28fd3b929683,COL_Barracks_MistressOfSouls_RecognizeDarkUrge_23028529-ccb6-094d-5401-570d54b432e5);

//END_REGION GUS-312081

//REGION "GUS-310052"

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-310052");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-310052")
THEN
PROC_TriggerRegisterForPlayers(S_MOO_EntranceGoalBox_2c4f4d85-6d96-4ac9-becd-8d3c23657854);

//END_REGION

//REGION GUS-312231

PROC
PROC_ApplySavegamePatches()
AND
DB_OnlyOnce("COL_OnFirstEntry")
AND
NOT DB_OnlyOnce("COL_KethericShowdown_ChosenThree")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-312231");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-312231")
AND
DB_COL_TadpolingCentre_PodCharacters(_Character,_,_,_,1)
AND
IsInTrigger(_Character,(TRIGGER)S_COL_Colony_SUB_c72269e5-0719-4379-a8ea-ca2ca199d0a3,1)
THEN
SetCombatGroupID(_Character,"COL_TadpolingCentre_Prisoners");

//END_REGION GUS-312231

//REGION GUS-308060
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_GlobalFlag(MOO_Assault_State_Started_60786c6f-0761-4035-a462-3b42a591fdc1)
THEN
DB_BUGFIX_Marker("GUS-308060");
PROC_Combat_CallingForHelp_CleanUp("MOO_KethericHoundHelp");
//END_REGION GUS-308060

//REGION GUS-310064
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_GlobalFlag((FLAG)HAV_TakingIsobel_State_IsobelGaveMoonlantern_2e9ac13e-9e09-c8b6-87e2-3f3998f5a6a7)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)SCL_Drider_State_HasDriderMoonlantern_a48372d0-609f-48a4-9774-956f6f614c3c, _Player, 1)
THEN
DB_BUGFIX_Marker("GUS-310064");
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act2_Criminal_DriderMoonlantern");
//END_REGION GUS-310064

//REGION GUS-309849
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-309849");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-309849")
AND
DB_SCL_ShamblingMound_Undead(_Undead)
AND
IsDead(_Undead, 1)
AND
DB_GLO_DefeatCounter(_Undead, "SCL_CombatGroups_BlightCombat2")
THEN
NOT DB_GLO_DefeatCounter(_Undead, "SCL_CombatGroups_BlightCombat2");
//END_REGION GUS-309849

//REGION GUS-312511

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-312511");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-312511")
AND
IsOnStage(S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421,1)
THEN
//Prevent PROC_SceneOver for this chair leaving the scene manager trigger
DB_SceneTriggerManager("HAV_MolDeal_MatchPlayed",S_HAV_LanceBoard_SceneManager_4379b45b-8820-4a55-a33b-089a5c6e5d3a,1);
NOT DB_SceneTriggerManager("HAV_MolDeal_MatchPlayed",S_HAV_LanceBoard_SceneManager_4379b45b-8820-4a55-a33b-089a5c6e5d3a,0);
SetOnStage(S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421,0);

IF
ItemLeftTrigger(S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421,S_HAV_LanceBoard_SceneManager_4379b45b-8820-4a55-a33b-089a5c6e5d3a,_)
THEN
SetEntityEvent(S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421,"HAV_MolsDeal_SceneManager_UndoIgnoreItems",1);
//Happens before ItemLeftTrigger in GLO_GenericSceneManager, wait a frame so that ItemLeftTrigger event fires

IF
EntityEvent(S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421,"HAV_MolsDeal_SceneManager_UndoIgnoreItems")
THEN
DB_SceneTriggerManager("HAV_MolDeal_MatchPlayed",S_HAV_LanceBoard_SceneManager_4379b45b-8820-4a55-a33b-089a5c6e5d3a,0);
NOT DB_SceneTriggerManager("HAV_MolDeal_MatchPlayed",S_HAV_LanceBoard_SceneManager_4379b45b-8820-4a55-a33b-089a5c6e5d3a,1);

IF
WentOnStage(S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421,0)
AND
IsReposedOnEntity(S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925,S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421,1)
THEN
Use(S_DEN_ThiefHideoutLeader_c8ab1ca6-96bb-467e-91c9-af87bc4d3925, (ITEM)S_HAV_MolsDeal_LanceboardChair_1_ca0d8ecf-29ad-4351-9a15-6b5ef5ed0ca2, 1, 1, "HAV_MolsDeal_SitsAtTable");

IF
WentOnStage(S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421,0)
THEN
TeleportTo(S_HAV_MolsDeal_LanceboardChair_1_ca0d8ecf-29ad-4351-9a15-6b5ef5ed0ca2,S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421);

IF
WentOnStage(S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421,0)
AND
DB_Destroyed(S_HAV_MolsDeal_LanceboardChair_1_OLD_8cca0090-625b-4453-82f7-52b938e3f421)
THEN
Die(S_HAV_MolsDeal_LanceboardChair_1_ca0d8ecf-29ad-4351-9a15-6b5ef5ed0ca2);

//END_REGION GUS-312511

//REGION GUS-312375
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-312375");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-312375")
THEN
DB_QuestDef_State(HAV_LastLightOx002_GaveReward_a07826a0-879d-574c-b192-bd4f508bd5a9, "HIDDEN_SCL_Boosters", "SCL_DevilishOx_LeftOxBe");
//END_REGION GUS-312375

//REGION GUS-311355
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelLoadedOnce("INT_Main_A")
THEN
DB_BUGFIX_Marker("GUS-311355");
DB_ForceRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
DB_GLO_DieFlag((FLAG)SHA_OrthonLair_Event_OrthonKillsSelf_5779d2a2-1676-463d-905b-699e9c7b1bc7, (CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, DEATHTYPE.Physical, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
//END_REGION GUS-311355

//REGION GUS-295076
PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-295076");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-295076")
THEN
PROC_GUS_SavegamePatches_GUS_295076_AddGemMapMarker((ITEM)S_SHA_TrialGem_000_5e3d0d3b-6fcf-48b8-a10c-580ff4efd1ff, (ITEM)S_SHA_Trial_MazeGem_MapMarkerHelper_9f35daf6-d0cf-4e46-8407-11892c9ff3b6);
PROC_GUS_SavegamePatches_GUS_295076_AddGemMapMarker((ITEM)S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, (ITEM)S_SHA_Trial_ClonesGem_MapMarkerHelper_4c2b3637-d7da-4036-b48b-21c373f63d2f);
PROC_GUS_SavegamePatches_GUS_295076_AddGemMapMarker((ITEM)S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, (ITEM)S_SHA_Trial_PlatformsGem_MapMarkerHelper_b04dbc0c-157c-47e6-9f06-4596dec2ef21);

PROC
PROC_GUS_SavegamePatches_GUS_295076_AddGemMapMarker((ITEM)_Gem, (ITEM)_MapMarkerHelper)
AND
DB_SHA_Trials_GemsNotTaken(_Gem)
THEN
DB_SHA_Misc_GemMapMarker(_Gem, _MapMarkerHelper);

PROC
PROC_GUS_SavegamePatches_GUS_295076_AddGemMapMarker((ITEM)_Gem, (ITEM)_MapMarkerHelper)
AND
DB_SHA_Misc_GemMapMarker(_Gem, _MapMarkerHelper)
AND
IsOnStage(_Gem, _OnStage)
THEN
TeleportTo(_MapMarkerHelper, _Gem, "", 0, 0, 0, 0, 0); // Make sure helper is always with gem when the map marker appears
SetOnStage(_MapMarkerHelper, _OnStage);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-295076")
AND
DB_SHA_Trials_GemsNotTaken((ITEM)S_SHA_TrialGem_006_7fbf6a88-bce1-49e0-a216-0cb2ce23b0eb)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)S_SHA_OrthonLair_GemDiscovery_e361f796-3050-4daa-8c43-e4a0fa8241f5);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-295076")
AND
DB_OnlyOnce("SHA_RelicJournal_FoundOrthonGem")
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundGemOrthon");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-295076")
THEN
DB_SHA_Trials_HasGemFlag((ITEM)S_SHA_TrialGem_000_5e3d0d3b-6fcf-48b8-a10c-580ff4efd1ff, (FLAG)SHA_Trials_State_HasMazeGem_ef352653-dfb1-4e1b-b578-4662689b5018);
DB_SHA_Trials_HasGemFlag((ITEM)S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, (FLAG)SHA_Trials_State_HasClonesGem_c7777b00-3d1d-4eff-9196-42bc3e7745cb);
DB_SHA_Trials_HasGemFlag((ITEM)S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, (FLAG)SHA_Trials_State_HasPlatformsGem_a85bb4af-4bed-48ac-8093-47d2bfc1955c);
DB_SHA_Trials_HasGemFlag((ITEM)S_SHA_TrialGem_006_7fbf6a88-bce1-49e0-a216-0cb2ce23b0eb, (FLAG)SHA_Trials_State_HasOrthonGem_763c3abb-4956-40d9-8559-1a92baaebb55);
//END_REGION GUS-295076

//REGION GUS-311012
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-311012");
NOT DB_GLO_Cinematic_PositionedDialog(HAV_TakingIsobel_JaheiraCallToArm_115de2ed-8330-d5f0-2c34-c32a673a5d1b, "HAV_CallToArm");
NOT DB_IgnoreMutingStatussesDialog(HAV_TakingIsobel_JaheiraCallToArm_115de2ed-8330-d5f0-2c34-c32a673a5d1b);
NOT DB_AddCharactersInTriggerToDialog(HAV_TakingIsobel_JaheiraCallToArm_115de2ed-8330-d5f0-2c34-c32a673a5d1b, S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, 1, 1);
//END_REGION GUS-311012
//REGION GUS-310398
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-310398");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-310398")
THEN
DB_GLO_Backgrounds_ChainAfterDialogEndedWithGlobalFlag((DIALOGRESOURCE)HAV_WrootRequest_Reunion_1daf117e-b3e7-a4b3-bf94-17f3f4257f08, (FLAG)HAV_WrootRequest_Event_GaveGift_7b1df8d9-36e9-2de8-3a77-1f1a8c6ff32e, "Act2_GuildArtisan_BrilliantRetortTaken");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-310398")
AND
DB_GlobalFlag(HAV_WrootRequest_Event_GaveGift_7b1df8d9-36e9-2de8-3a77-1f1a8c6ff32e)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act2_GuildArtisan_BrilliantRetortTaken");
//END_REGION GUS-310398

//REGION GUS-310273
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag((FLAG)GLO_Isobel_KnowsKethericFather_93182f99-8977-42bb-a3c5-094a7a686068)
AND
DB_GlobalFlag((FLAG)MOO_KethericsChambers_Knows_KethericsWife_265c4b21-25cb-4ea2-b9fe-0f37d035b886)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act2_Noble_KethericStoryLearned");
DB_BUGFIX_Marker("GUS-310273");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_BookFlags(S_MOO_MyrkulLetter_1ae2a112-e446-44c1-8fbe-094505e651e6,GLO_Ketheric_Knows_IsobelIsDaughter_4157aaed-4605-4f91-ba30-98d7735ff5f9)
THEN
NOT DB_BookFlags(S_MOO_MyrkulLetter_1ae2a112-e446-44c1-8fbe-094505e651e6,GLO_Ketheric_Knows_IsobelIsDaughter_4157aaed-4605-4f91-ba30-98d7735ff5f9);
DB_BookFlags(S_MOO_MyrkulLetter_1ae2a112-e446-44c1-8fbe-094505e651e6,GLO_Ketheric_Knows_Existence_aaf551db-484c-b549-4cc6-435086ae2d86);
//END_REGION GUS-310273

//REGION GUS-309916

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_GLO_Backgrounds_Blocked("Act2_Sage_SharTempleEntrancePuzzle") 
AND
DB_GlobalFlag(SHA_PartyProgress_EnteredSharTemple_d212e499-d006-4043-9dee-8aac504098e5)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act2_Sage_SharTempleEntrancePuzzle");
DB_BUGFIX_Marker("GUS-309916");

//END_REGION

//REGION GUS-307352
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-307352");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-307352")
AND
DB_GlobalFlag(HAV_FlamingSpy_Knows_HiddenCorpse_f30cddd1-1f88-53dd-5c4b-dd676fdfbcaf)
THEN
SetCanInteract(S_HAV_FlamingFistCorpse_Rocks_108b4837-0ba7-44de-ba6c-d31e8492fea5, 1);

//END_REGION GUS-307352

//REGION GUS-309901

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
NOT DB_GlobalFlag((FLAG)MOO_KethericsChambers_Knows_KethericsWife_265c4b21-25cb-4ea2-b9fe-0f37d035b886)
THEN
DB_BUGFIX_Marker("GUS-309901");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)MOO_KethericsChambers_Knows_KethericsWife_265c4b21-25cb-4ea2-b9fe-0f37d035b886, "Act2_Sage_KethericShameRedemptionTrigger");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)MOO_KethericsChambers_Knows_KethericsWife_265c4b21-25cb-4ea2-b9fe-0f37d035b886)
AND
DB_Players(_Player)
THEN
DB_BUGFIX_Marker("GUS-309901");
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act2_Sage_KethericShameRedemptionTrigger");

//END_REGION

//REGION GUS-309918

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)SHA_Nightsong_HasMet_6b56f4b8-8bb3-5393-de12-d320fbb55218)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act2_Sage_TruthOfNightsongDiscovered");

//END_REGION

//REGION GUS-313069
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "SCL_Main_A", "GUS-313069");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-313069")
THEN
PROC_COL_KethericShowdown_CheckDownedPlayers();

//END_REGION GUS-313069

//REGION GUS-312896
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-312896");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-312896")
THEN
DB_Subregion((TRIGGER)S_SHA_Mausoleum_SUB_66b74527-67c9-47bf-92a4-b90e1b189739,"SHA_Temple_SUB_Mausoleum",0,1);

//END_REGION GUS-312896

//REGION GUS-309421
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-309421");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-309421")
THEN
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)SHA_NightsongsFate_State_ShadowheartFailedShar_6ece6afb-e764-744c-11ae-8710b87bcf8d, "Act2_Acolyte_NightsongFateFreedom");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_GlobalFlag((FLAG)SHA_NightsongsFate_State_ShadowheartFailedShar_6ece6afb-e764-744c-11ae-8710b87bcf8d)
AND
DB_Players(_Player)
THEN
DB_BUGFIX_Marker("GUS-309421");
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act2_Acolyte_NightsongFateFreedom");

//END_REGION GUS-309421

//REGION GUS-309662
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-309662");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-309662")
AND
DB_PermaDefeated(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d)
AND
DB_GlobalFlag((FLAG)SHA_Necromancer_State_AskedHelp_1e06992f-24ad-254e-42aa-a0092f6f8431)
AND
QRY_State_IsBeforeState(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_Necromancer", "SHA_Necromancer_State_AtMoonrise")
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act2_Urchin_BalthazarKilledPostMeeting");

//END_REGION GUS-309662

//REGION GUS-311716

PROC
PROC_ApplySavegamePatches()
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_OnlyOnce("COL_OnFirstEntry")
AND
NOT DB_OnlyOnce("KethericShowdown_CrownController")
AND
DB_Players(_Player)
AND
IsInTrigger(_Player,S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b,0)
THEN
TeleportTo(_Player,(TRIGGER)S_COL_AssaultTeleportPoint_21b37cc1-8a65-46aa-8b63-59ccf71efed7, "COL_Entrance_PlayerArrived");
DB_BUGFIX_Marker("GUS-311716",_Player);

//END_REGION GUS-311716

//REGION GUS-313207
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-313207");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-313207")
AND
IsInCombat(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 0)
AND
DB_Is_WildShaped(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_PartyMembers(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
IsPartyFollower(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 0)
AND
HasActiveStatusWithGroup(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "SG_Polymorph_BeastShape", 1)
THEN
RemoveStatusesWithGroup(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "SG_Polymorph_BeastShape");
RemoveStatus(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "INVISIBILITY_PANTHER");
RemoveStatus(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "PROWL");

//END_REGION GUS-313207

//REGION GUS-287385
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-287385");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-287385")
AND
DB_GlobalCounter("SHA_NightsongChamber_Unlock", _Count)
AND
_Count > 0
AND
_Count < 3
AND
DB_Avatars(_Player)
AND
QRY_OnlyOnce("SHA_Trials_ReturnUsedGems")
THEN
PROC_DecreaseCounter("SHA_NightsongChamber_Unlock", _Count);
TemplateAddTo(QUEST_SHA_TrialOrb_fd3fd8a9-a5fc-4726-9b6e-77f5ecf54cea, _Player, _Count, 1);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-287385")
AND
DB_SHA_Trials_GemSockets((ITEM)S_SHA_LowerAltar_1a25fac4-dfb3-4103-91e2-e977c03681de, _Index, _Gem)
AND
DB_GlobalCounter("SHA_NightsongChamber_Unlock", _Count)
AND
_Count > 0
AND
_Count < 3
AND
_Index <= _Count
THEN
PROC_SetOnStage(_Gem, 0);

//END_REGION GUS-287385

//REGION GUS-310032

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-310032");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-310032")
AND
DB_GLO_NarrativeCombat_ID("MOO_Assault_KethericRoofFight", _Combat)
AND
DB_MOO_Assault_RoofNarrativeCombatEnemy(_Participant)
AND
DB_PermaDefeated(_Participant)
AND
IsInNarrativeCombat(_Participant,_Combat,1)
THEN
SetInNarrativeCombat(_Combat, _Participant,0);
PROC_GLO_NarrativeCombat_ParticipantLeft("MOO_Assault_KethericRoofFight", _Participant);
DB_BUGFIX_Marker("GUS-313502",_Participant);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-310032")
AND
NOT DB_GLO_NarrativeCombat_Participant("MOO_Assault_KethericRoofFight",_,_)
THEN
PROC_GLO_NarrativeCombat_EndCombat("MOO_Assault_KethericRoofFight");

//Fix for these database entries being mysteriously missing in this particular savegame
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-313502")
AND
NOT DB_MOO_Roof_ColonyTeleporters((ITEM)S_MOO_TentaclelessTeleporter_c29cec63-82da-4579-b11d-75a5a08bbe1b, (DIALOGRESOURCE)MOO_Assault_TentaclelessJump_671ddd7b-35dc-5f76-e5cc-b82afb118fa2, "MOO_Assault_ReadyCheck", 0)
THEN
DB_MOO_Roof_ColonyTeleporters((ITEM)S_MOO_RoofAltar_e0c3ef2e-c056-4131-b9fc-8bf0243ad2cd, (DIALOGRESOURCE)MOO_Audience_Altar_ffc48fe4-842d-489b-adb3-03e7b6cedde5, "MOO_Audience_ReadyCheck", 1);
DB_MOO_Roof_ColonyTeleporters((ITEM)S_MOO_TentaclelessTeleporter_c29cec63-82da-4579-b11d-75a5a08bbe1b, (DIALOGRESOURCE)MOO_Assault_TentaclelessJump_671ddd7b-35dc-5f76-e5cc-b82afb118fa2, "MOO_Assault_ReadyCheck", 0);

//END_REGION GUS-310032
//REGION GUS-308919
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-308919");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-308919")
THEN
TeleportToPosition(S_SHA_SilentLibrary_SecretCompartment_000_1b9b251b-4d95-4819-935b-ccd7464cb0e0, -634.048, -24.122, -714.611, "", 0, 0, 0, 0, 0);
//END_REGION GUS-308919

//REGION GUS_318742

PROC
PROC_ApplySavegamePatches()
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
SetFlag(SCL_SaveGamePatch_GUS_318742_28063004-0e4d-4135-a499-a150a1f5d5e3, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION GUS-292565
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
NOT DB_GlobalFlag((FLAG)SCL_ServantOfTheRaven_Event_ForgaveMadeline_1aa550bf-d606-3fca-484f-818ed1f8c59b)
THEN
DB_BUGFIX_Marker("GUS-292565");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)SCL_ServantOfTheRaven_Event_ForgaveMadeline_1aa550bf-d606-3fca-484f-818ed1f8c59b, "Act2_Acolyte_HeWhoWasQuestDenied");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelUnreachable("SCL_Main_A") // Mostly to avoid confusion in case it appears 15 hours after it happened
AND
DB_GlobalFlag((FLAG)SCL_ServantOfTheRaven_Event_ForgaveMadeline_1aa550bf-d606-3fca-484f-818ed1f8c59b)
AND
DB_Players(_Player)
THEN
DB_BUGFIX_Marker("GUS-292565");
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act2_Acolyte_HeWhoWasQuestDenied");
//END_REGION GUS-292565

//REGION GUS-314059

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","SCL_Main_A","GUS-314059");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-314059")
AND
DB_Dead((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
HasAppliedStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"GROUNDED_APPLYTODEAD",0)
THEN
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f,"GROUNDED_APPLYTODEAD",-1.0,0,NULL_00000000-0000-0000-0000-000000000000);

//END_REGION GUS-314059

//REGION GUS-314215

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5 Hotfix 5")
AND
DB_GlobalFlag(UND_GnomeWorkers_Event_Leave_ad897c6f-87d5-4a30-88f0-41c92b965bc8)
AND
DB_UND_GnomeWorkers(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,0,1)
AND
NOT DB_GlobalFlag(SCE_Debrief_State_Setup_0ebc6b35-0f07-4a73-b6b8-9782ecbcaccf)
AND
NOT DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
THEN
NOT DB_UND_GnomeWorkers(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976,NULL_00000000-0000-0000-0000-000000000000,NULL_00000000-0000-0000-0000-000000000000,0,1);

//END_REGION

//REGION GUS-302906
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT DB_LevelLoadedOnce("INT_Main_A")
AND
DB_GlobalFlag(MOO_Assault_State_Started_60786c6f-0761-4035-a462-3b42a591fdc1)
AND
DB_MOO_AssaultPositions((CHARACTER)_Corpse, _, _Group)
AND
NOT DB_MOO_Assault_AllyGroups(_Group)
AND
DB_Dead(_Corpse)
AND
NOT DB_CorpseCleanup_Ignore(_Corpse)
AND
NOT DB_CanBeResurrected(_Corpse)
AND
NOT DB_GLO_CharacterCorpseDialog(_Corpse,_)
AND
GetDefaultState(_Corpse, "")
AND
NOT DB_MOO_Assault_CorpseCleanup(_Corpse)
THEN
DB_MOO_Assault_CorpseCleanup(_Corpse);
DB_BUGFIX_Marker("GUS-302906",_Corpse);
//Will clean them up on the next long rest
//END_REGION GUS-302906

//REGION GUS-307645
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","SCL_Main_A","GUS-307645");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-307645")
AND
DB_PermaDefeated(S_SCL_OliverFight_Nightdome_d5ca84a9-98a4-47e4-ab5f-ee8b245c48d5)
THEN
PROC_SetOnStage(S_SCL_OliverPortal_a45b9f90-0a29-4777-acc1-7f154d07f104, 0);

//END_REGION GUS-307645

//REGION GUS-314218

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","SCL_Main_A","GUS-314218");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-314218")
THEN
PROC_SetRelationMutual((FACTION)ACT2_MOO_Absolute_6b0751e2-fbd4-45e1-92ac-d5edb31649d8,(FACTION)ACT2_COL_TadpolingCentre_Prisoners_064f9b52-e5b7-4b2e-8c21-a44b08d94aac,0);

//END_REGION GUS-314218

//REGION GUS-314391
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","SCL_Main_A","GUS-314391");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-314391")
THEN
SetTag(S_SCL_DriderCaravan_HalfOrcCaster_f9522205-623f-4a82-904a-128b26182707, (TAG)NOT_MESSING_AROUND_542b58f0-42ad-4157-a28e-27434e0e7b18);
SetTag(S_SCL_DriderCaravan_HalfOrcMelee_8e95a1ed-12f0-4b2e-9d22-d9b4522a1445, (TAG)NOT_MESSING_AROUND_542b58f0-42ad-4157-a28e-27434e0e7b18);
SetTag(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, (TAG)NOT_MESSING_AROUND_542b58f0-42ad-4157-a28e-27434e0e7b18);
//END_REGION GUS-314391

//REGION GUS-314523
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","SCL_Main_A","GUS-314523");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-314523")
THEN
DB_SCE_Participant_KeepFaction((CHARACTER)S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_SCE_Participant_KeepFaction((CHARACTER)S_GLO_JergalAvatar_0133f2ad-e121-4590-b5f0-a79413919805);
DB_SCE_Participant_KeepFaction((CHARACTER)S_HAV_SpiritOfTheLand_1403cdfd-0660-4592-90c6-bfe4607ccd3a);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-314523")
AND
DB_GlobalFlag((FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e)
AND
DB_SCE_Debrief_Participant(_Character, _, _)
AND
NOT DB_SCE_Participant_KeepFaction(_Character)
AND
NOT DB_PartOfTheTeam(_Character)
THEN
ApplyStatus(_Character, "SCE_EPILOGUE_FACTIONOVERRIDE", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-314523")
AND
DB_GlobalFlag((FLAG)SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e)
AND
DB_SCE_RavenguardFollowUp_FlamingFists(_Character)
THEN
ApplyStatus(_Character, "SCE_EPILOGUE_FACTIONOVERRIDE", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);


//END_REGION GUS-314523

//REGION GUS-309480
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
DB_DialogStarted_IgnoreStopConditions(MOO_Assault_FirstKethericInterruption_af3d4480-a770-b93e-ad54-a2e6e55a19ef);
DB_BUGFIX_Marker("GUS-309480");
//END_REGION GUS-309480

//REGION GUS-294728
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_SCL_OliverConfrontation(1)
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
DB_BUGFIX_Marker("GUS-294728");
SetFlag((FLAG)SCL_LiftingTheCurse_State_OliverLeftHome_0bde59b3-ccc2-4747-8def-ad4209d418f8);
//END_REGION GUS-294728

//REGION GUS-312447
PROC
PROC_ApplySavegamePatches()
AND
QRY_ShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A")
AND
NOT DB_CampNight_Completed(NIGHT_Astarion_BloodMerchantAftermath_01e87577-fae7-4b09-9d54-4ce4c7b45fe4)
THEN
DB_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-312447");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-312447")
THEN
NOT DB_CampNight_RomanceNight((FLAG)NIGHT_Astarion_BloodMerchantAftermath_01e87577-fae7-4b09-9d54-4ce4c7b45fe4, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)CAMP_Astarion_SD_ROM_BloodMerchantAftermath_30d45668-4bcf-d514-5e04-5f843d1b538b, (FLAG)ORI_State_DatingAstarion_ba298c56-26b6-4918-9bd4-616668d369d8);
DB_CampNight_RomanceNight((FLAG)NIGHT_Astarion_BloodMerchantAftermath_01e87577-fae7-4b09-9d54-4ce4c7b45fe4, (CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)CAMP_Astarion_SD_ROM_BloodMerchantAftermath_30d45668-4bcf-d514-5e04-5f843d1b538b, (FLAG)MOO_BloodMerchant_State_RomancePartnerDiscussedBloodWithAstarion_46c269e9-9d1b-49c2-909e-bf30198c7445);

// only set on the player who actually convinced Astarion to drink the blood (received the legendary potion)
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-312447")
AND
DB_GlobalFlag((FLAG)MOO_BloodMerchant_State_ConvincedAstarionToDrinkBlood_692d8d3b-c442-4615-b8d8-8bbff05fed9c)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)ORI_State_DatingAstarion_ba298c56-26b6-4918-9bd4-616668d369d8, _Player, 1)
AND
GetFlag(MOO_BloodMerchant_Event_GiveLegendaryPotion_690b3c89-709f-4b04-8921-f8587f2efc9b, _Player, 1)
THEN
SetFlag(MOO_BloodMerchant_State_RomancePartnerDiscussedBloodWithAstarion_46c269e9-9d1b-49c2-909e-bf30198c7445, _Player);

// set on the one who is dating Astarion as we can't check which character supported Astarion
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-312447")
AND
DB_GlobalFlag((FLAG)MOO_BloodMerchant_State_SupportedAstarionsDecisionNotToDrinkBlood_89c42491-69f6-43dd-b7ab-c912d11fe2a7)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)ORI_State_DatingAstarion_ba298c56-26b6-4918-9bd4-616668d369d8, _Player, 1)
THEN
SetFlag(MOO_BloodMerchant_State_RomancePartnerDiscussedBloodWithAstarion_46c269e9-9d1b-49c2-909e-bf30198c7445, _Player);
//END_REGION

//REGION GUS-319938

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "SCL_Main_A", "GUS-319938");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-319938")
AND
DB_PermaDefeated(S_HAV_AncientFist_MartCullagh_378938e2-2193-49a3-a06e-8e26cc128055)
AND
DB_HAV_SavingPrisoners_FlorrickAndManipScene(1)
THEN
NOT DB_HAV_SavingPrisoners_FlorrickAndManipScene(1);
DB_BUGFIX_Marker("GUS-319938");

//END_REGION 

//REGION GUS-315117
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A", "GUS-315117");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-315117")
AND
DB_State_Current(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_AFamiliarFace")
THEN
DB_DropMutingStatussesDialog(SHA_Raphael_b2456297-525e-fff7-e72b-7da3da48995a);
DB_SpotPlayers_IncludeWildshapedPlayers(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_RaphaelAtGraveyard");
DB_BUGFIX_Marker("GUS-315117");
//END_REGION GUS-315117

//REGION GUS-313378
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_CurrentLevel("SCL_Main_A")
AND
DB_PartOfTheTeam(_Char)
AND
GetFlag(SCL_Event_TravelBackToAct1_c1f1104f-3908-4013-a1f9-76ba2738e37c, _Char, 1)
THEN
ClearFlag(SCL_Event_TravelBackToAct1_c1f1104f-3908-4013-a1f9-76ba2738e37c, _Char, 0, 0);
DB_BUGFIX_Marker("GUS-313378");
//END_REGION GUS-313378

//REGION GUS-307345
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A", "GUS-307345");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-307345")
AND
DB_PartOfTheTeam(_Player)
AND
QuestUpdateIsUnlocked(_Player, "SCL_LiftingTheCurse", "SeekOliver", 0)
THEN
ShowMapMarker(_Player, "SCL_OliversHouseRevealed", 0);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-307345")
AND
DB_PartOfTheTeam(_Player)
AND
QuestUpdateIsUnlocked(_Player, "SCL_LiftingTheCurse", "TalkToThaniel", 1)
THEN
ShowMapMarker(_Player, "SCL_OliversHouseRevealed", 0);

//END_REGION GUS-307345

//REGION GUS-315023
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A", "GUS-315023");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-315023")
AND
DB_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_MOO_Execution_Goblin(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb, _)
AND
NOT DB_GlobalFlag(MOO_GroundFloor_State_ExecutionOver_1560c0ae-5fec-4e7c-a6e7-35e9c33bbbeb)
AND
NOT DB_GlobalFlag(MOO_Execution_Event_GoblinsSuffocate_bd978044-c6dd-8ef2-4bec-3e7da40defc1)
AND
NOT DB_GlobalFlag(MOO_Execution_Event_GoblinsKillThemselves_26ffc4b9-58d5-02b2-1e9a-ea32d8935d11)
THEN
DB_BG3_Act2_SaveGamePatches_ResurrectingSazza(1);
Resurrect((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

IF
Resurrected((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb)
AND
DB_BG3_Act2_SaveGamePatches_ResurrectingSazza(1)
THEN
NOT DB_BG3_Act2_SaveGamePatches_ResurrectingSazza(1);
PROC_CharacterFullRestore((CHARACTER)S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
NOT DB_Dead(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
NOT DB_PermaDefeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);
NOT DB_Defeated(S_DEN_CapturedGoblin_783d7572-a846-455f-b686-247a95263ebb);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-315023")
AND
NOT DB_GlobalFlag(MOO_GroundFloor_State_ExecutionOver_1560c0ae-5fec-4e7c-a6e7-35e9c33bbbeb)
AND
NOT DB_InternPlayerSpot_Spotting(_, "MOO_Execution") //Spotting stopped
AND
DB_MOO_Execution_Speakers(_) //This DB is cleared when the dialog has started, so if still populated but spotting stopped, it means the dialog failed
AND
QRY_OnlyOnce("MOO_Execution_GUS-315023_Once")
THEN
PROC_SpotPlayers_RestartSpotting(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "MOO_Execution");
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_Execution");


//END_REGION

//REGION GUS-306595
QRY
QRY_BUGFIX_GUS306595_HasBusyDialog((CHARACTER)_Character)
AND
DB_SCL_Drider_HarperIsBusy(_Character)
THEN
DB_NOOP(1);
//END_REGION GUS-306595

//REGION GUS-306145

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A", "GUS-306145");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-306145")
AND
DB_SHA_Trials_MirrorCharacters(_Double, _)
AND
DB_SHA_MirrorEncounter_Pairs(_Double, _)
AND
DB_SHA_MirrorEncounter_ClassData((TAG)_ClassTag,_SpellSet,_)
AND
IsTagged(_Double,_ClassTag,1)
THEN
PROC_BG3_SaveGamePatches_GUS_306145_RemoveClassSpells(_Double, _SpellSet,1);

PROC
PROC_BG3_SaveGamePatches_GUS_306145_RemoveClassSpells((CHARACTER)_Double, (STRING)_SpellSet, (INTEGER)_ActionIndex)
AND
DB_SHA_MirrorEncounter_ClassData(_,_SpellSet,_)
AND
GetSpellFromSet(_SpellSet,_ActionIndex,_Action)
AND
IntegerSum(_ActionIndex,1,_NextActionIndex)
THEN
RemoveSpell(_Double,_Action);
PROC_BG3_SaveGamePatches_GUS_306145_RemoveClassSpells(_Double,_SpellSet,_NextActionIndex);

PROC
PROC_BG3_SaveGamePatches_GUS_306145_RemoveClassSpells(_,_,_)
AND
NOT DB_BUGFIX_Marker("GUS-306145")
THEN
DB_BUGFIX_Marker("GUS-306145");

//END_REGION GUS-306145

//REGION GUS-314213
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_SCL_ShadowCurse_InCursedArea(_)
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A", "GUS-314213_RecheckInCurse");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-314213_RecheckInCurse")
AND
DB_SCL_ShadowCurse_InCursedArea(_Object)
AND
NOT QRY_SCL_Shadowcurse_ExcludedFromCurse(_Object)
AND
NOT QRY_SCL_ShadowCurse_InCursedArea(_Object)
THEN
NOT DB_SCL_ShadowCurse_InCursedArea(_Object);
//END_REGION GUS-314213

//REGION GUS-315072
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
DB_MOO_Execution_Speakers(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A", "GUS-315072");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-315072")
AND
DB_GlobalFlag(MOO_GroundFloor_State_ExecutionOver_1560c0ae-5fec-4e7c-a6e7-35e9c33bbbeb)
THEN
NOT DB_MOO_Execution_Speakers(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-315072")
AND
NOT QRY_State_IsBeforeState(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_MintharaFate", "MOO_MintharaFate_State_Escortee")
THEN
NOT DB_MOO_Execution_Speakers(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-315072")
AND
DB_PartOfTheTeam(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
NOT DB_MOO_Execution_Speakers(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
//END_REGION GUS-315072

//REGION GUS-315560
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
AND
NOT DB_GlobalFlag((FLAG)HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958)
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "SCL_Main_A", "GUS-315560");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-315560")
THEN
DB_CRIME_Guards_RegionInfo("SCL_Main_A_HAV", "HAV_Prison", (FLAG)HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958);
DB_CRIME_Guards_RegionReinforcements("SCL_Main_A_HAV", 2);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HavenOutcasts_DockGuard_Melee_f1f837ad-8e6a-442d-bba4-46f665c47675);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_EnteringHaven_Guard_f48078e6-ec51-49a2-a244-9d0a72af5257);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HavenOutcasts_BarricadeGuards_Melee_Dwarf_b1d8b327-1f27-4921-aa2b-dd18a9d67fc8);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HavenOutcasts_DockGuard_Left_Melee_bd46130e-1c2c-4888-9e9c-6dd58965ab4f);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HavenOutcasts_DockGuard_Left_Ranger_3a856945-e4a5-4214-89af-84a2b50789d8);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HavenOutcasts_DockGuard_Ranger_a0f9d7cb-d87c-4af8-87fa-d273a8ecba93);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HavenOutcasts_EntranceGuards_Caster_HighElf_825714dd-7df9-4cd1-aecb-edf577baa487);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HavenOutcasts_EntranceGuards_Halfling_Melee_c8bc8f03-c91c-42d4-829c-d16bb1df4a67);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HavenOutcasts_FountainGuards_Melee_1_3e2db417-c434-4f08-ab6a-dd60c8e9f3b5);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HavenOutcasts_FountainGuards_Melee_2_271478dd-7efb-4ca7-b40c-593bbea91a85);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_ArrivalGuard_232f53d1-d291-4e2a-bdfd-d2fed2dba630);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HarperGuard_001_8082f1d4-8942-492e-8d26-1e1ed6bd881f);
DB_CRIME_Guards_RegionGuard("SCL_Main_A_HAV", "HAV_Prison", (CHARACTER)S_HAV_HarperGuard_002_34a9bfd8-1ca2-4a1c-b72e-2bf1cfc046a4);
//END_REGION GUS-315560

//REGION GUS-315696

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_MOO_Jailbreak_Prisoner(_Character, "Tieflings")
AND
DB_GlobalFlag(MOO_Jailbreak_Knows_ToolsNeeded_c72f6921-97df-2ab3-6090-d20b1bd4e828)
AND
QRY_QuestUpdateIsUnlockedForAny("HAV_SaveTieflingPrisoners", "TalkToGnomes")
AND
QRY_OnlyOnce("GUS-315696")
THEN
DB_BUGFIX_Marker("GUS-315696");
QuestUpdate("HAV_SaveTieflingPrisoners", "FindTool");

//END_REGION

//REGION GUS-266146

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6","SCL_Main_A","GUS-266146");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-266146")
THEN
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf,(ROOT)COL_Zombie_Custom_Wulbren_8398e3ff-92cd-43e9-8c59-a4a737910f04);
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)S_GLO_GnomePrisoner_001_4fbd62e8-a486-471e-8a65-00966b058dd5,(ROOT)COL_Zombie_Custom_GnomePrisoner_001_4d492b56-b7f3-4993-a851-756f40223727);
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)S_GLO_GnomePrisoner_002_c9a7d921-bef0-4829-8792-d48c529daee5,(ROOT)COL_Zombie_Custom_GnomePrisoner_002_4db567a6-c040-4d68-b8e1-3f042cda29b6);
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,(ROOT)COL_Zombie_Custom_DrowCommander_c936979c-0bcb-4fe2-9bc8-a9531ea6ef3b);
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)S_GOB_GoblinKing_11337af0-6a57-426b-a820-c4b00923dd54,(ROOT)COL_Zombie_Custom_GoblinKing_06f7326b-9356-4f4e-97de-6628e1761a42);
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d,(ROOT)COL_Zombie_Custom_ProdigySister_2f1a738e-1401-4529-afb1-b3376cd06b0e);
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b,(ROOT)COL_Zombie_Custom_ProdigyBrother_b3b8f414-0cc2-4a0c-adbd-5114916d047f);
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)S_GLO_YoungLover_01_dd9178e7-1e3f-43bc-8a38-666dfcac7d0c,(ROOT)COL_Zombie_Custom_YoungLover_00fcfa6d-3551-464f-9822-0c545f85508b);
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c,(ROOT)COL_Zombie_Custom_Tiefling_010_8bcc2e65-c9e1-4e2e-a760-9967e045c547);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-266146")
AND
DB_COL_NecromancerLab_AllZombies(_Zombie)
AND
DB_COL_NecromancerLab_Candidates_CustomVisuals((CHARACTER)_Zombie,(ROOT)_Visual)
THEN
Transform((CHARACTER)_Zombie,_Visual,(SHAPESHIFTRULE)DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);
DB_BUGFIX_Marker("GUS-266146",_Zombie);

//END_REGION GUS-266146

//REGION GUS-315402

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelUnreachable("SCL_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-315402");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-315402")
AND
GetAnubisConfig(S_HAV_SpiritOfTheLand_1403cdfd-0660-4592-90c6-bfe4607ccd3a, "DefaultCharacter")
THEN
PROC_SetAnubisConfig(S_HAV_SpiritOfTheLand_1403cdfd-0660-4592-90c6-bfe4607ccd3a, "HAV_SpiritOfTheLand");

//END_REGION GUS-315402

//REGION GUS-314776

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
QRY_ORI_Shadowheart_HasNightSpear()
AND
DB_ORI_Shadowheart_SpearOMDefined(1)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "SCL_Main_A", "GUS-314776");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-314776")
THEN
NOT DB_ORI_Shadowheart_SpearOMDefined(1);
PROC_ClearOriginMoment((DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_AOM_OOM_62d859bc-9ee0-3a6a-19c8-444a8ceb9f44);
PROC_ClearOriginMoment((DIALOGRESOURCE)SHA_NightsongPrison_OM_Shadowheart_COM_594af605-3732-b2ee-bddc-e92a6b80b279);

//END_REGION GUS-314776

//REGION GUS-316812
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_OneShotPlayerTrigger(S_MOO_AudienceSceneSphere_11043bbb-22fe-41b0-917f-dc912fdc512f)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "SCL_Main_A", "GUS-316812");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-316812")
THEN
PROC_RemoveOneShotTrigger(S_MOO_AudienceSceneSphere_11043bbb-22fe-41b0-917f-dc912fdc512f);
DB_SpotPlayers((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_Ketheric_AudienceSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_Ketheric_AudienceSpotting", S_MOO_AudienceSceneSphere_11043bbb-22fe-41b0-917f-dc912fdc512f);
//END_REGION GUS-316812

//REGION GUS-316735

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "SCL_Main_A", "GUS-316735");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-316735")
THEN
SetCanFight(S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8,0);
SetCanJoinCombat(S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8,0);
SetFaction(S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8,(FACTION)Neutral_NPC_cfb709b3-220f-9682-bcfb-6f0d8837462e);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-316735")
AND
IsInTrigger(S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8,(TRIGGER)S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf,1)
THEN
SetOnStage(S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8,0);
DB_BUGFIX_Marker("GUS-316735_KethTransfInRoom");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-316735")
AND
DB_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
NOT DB_OnlyOnce("KethericShowdown_CrownController")
AND
IsOnStage(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,0)
THEN
PROC_ToInventoryAndOnStage(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d,S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

//END_REGION GUS-316735

//REGION GUS-309083

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "SCL_Main_A", "GUS-309083");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-309083")
AND
DB_Combat_DeathBloom((GUIDSTRING)_Deathbloom,(GUIDSTRING)_,(FACTION)_,(STRING)_)
AND
Exists(_Deathbloom,1)
AND
GetFaction(_Deathbloom,(FACTION)Evil_NPC_64321d50-d516-b1b2-cfac-2eb773de1ff6)
THEN
SetFaction(_Deathbloom,(FACTION)ACT2_MOO_Deathblooms_cb2499b1-41ba-4c6b-bcb9-4619852af5d2);
DB_BUGFIX_Marker("GUS-309083",_Deathbloom);

//END_REGION GUS-309083

//REGION GUS-316377
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
NOT DB_ORI_MintharaKnockedOutEquipment(_, _)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "SCL_Main_A", "GUS-316377");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-316377")
THEN
DB_ORI_MintharaKnockedOutEquipment((ITEM)NULL_00000000-0000-0000-0000-000000000000, "Breast");
DB_ORI_MintharaKnockedOutEquipment((ITEM)NULL_00000000-0000-0000-0000-000000000000, "Boots");
DB_ORI_MintharaKnockedOutEquipment((ITEM)S_ORI_MintharaReplacementTorso_9e0bec9a-8683-4ade-897b-05677d6a4856, "VanityBody");
DB_ORI_MintharaKnockedOutEquipment((ITEM)S_ORI_MintharaReplacementBoots_5a826c44-5c2b-4bf3-9ddb-c05a0b5571c0, "VanityBoots");
DB_ORI_MintharaKnockedOutEquipment((ITEM)S_ORI_MintharaReplacementUnderwear_5609353d-2081-4b7d-b385-eef2dda7a061, "Underwear");
PROC_MOO_MintharaFate_PatchClotheMinthara();

PROC
PROC_MOO_MintharaFate_PatchClotheMinthara()
AND
DB_ORI_MintharaKnockedOutEquipment((ITEM)_Armour, (STRING)_Slot)
AND
NOT QRY_GetEquippedItem((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Slot)
THEN
ToInventory(_Armour, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
Equip((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Armour);

PROC
PROC_MOO_MintharaFate_PatchClotheMinthara()
AND
NOT QRY_GetEquippedItem((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "Breast")
THEN
PROC_SetArmourSet((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, ARMOURSET.Vanity);

//END_REGION

//REGION GUS-304762
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "SCL_Main_A", "GUS-304762");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-304762")
THEN
NOT DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_000_f64911ce-012d-44ef-a3fb-35248bbf1618, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_000_6a28f53d-3819-4869-b961-fc564615962a);
NOT DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_001_b0407d81-3dd6-4707-bee4-95c9ecf917ca, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_001_9c2f8c45-a159-4932-ba8e-183d0f3b6ef7);
NOT DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_002_155162ae-74a2-4310-a9e4-a49b179f2ef6, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_002_791bd805-8200-488d-a97b-ed8de55eb524);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_FirstPart_000_63c16ba1-5a50-4f87-8f7c-53ca54af397b, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_000_6a28f53d-3819-4869-b961-fc564615962a);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_FirstPart_001_8a0c7286-e9d3-4972-bf93-9998845689d1, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_000_6a28f53d-3819-4869-b961-fc564615962a);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_SecondPart_000_ba79ac1d-bb1a-4f4e-adc0-51f14c396a69, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_001_9c2f8c45-a159-4932-ba8e-183d0f3b6ef7);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_SecondPart_001_ebca5d76-6f34-4355-92c6-425aa8966294, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_001_9c2f8c45-a159-4932-ba8e-183d0f3b6ef7);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_SecondPart_002_b5c25b89-54ff-4a2d-930f-ae26c1a86dd5, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_001_9c2f8c45-a159-4932-ba8e-183d0f3b6ef7);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_SecondPart_003_707bfed4-ac99-4ca8-8f02-3aa10ddc77d5, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_001_9c2f8c45-a159-4932-ba8e-183d0f3b6ef7);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_SecondPart_004_0cdf9e6e-5eea-41fc-9668-1fbc2e6954a5, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_001_9c2f8c45-a159-4932-ba8e-183d0f3b6ef7);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_ThirdPart_000_ecf223b0-7153-4165-92df-ffc86f116171, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_002_791bd805-8200-488d-a97b-ed8de55eb524);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_ThirdPart_001_ec408275-358f-4792-919c-0d9635b04b6d, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_002_791bd805-8200-488d-a97b-ed8de55eb524);
DB_SHA_Trials_DeathTriggers((ITEM)S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)S_SHA_DeathTrigger_ThirdPart_002_4778f5d8-8bf7-4b84-97b6-089ec80214ec, (TRIGGER)S_SHA_PathOfDarknessTrial_DeathTriggerTP_002_791bd805-8200-488d-a97b-ed8de55eb524);
//END_REGION GUS-304762

//REGION GUS-316377
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
NOT DB_GlobalFlag(CAMP_Halsin_Minthara_BothPresent_6e984e21-ad6b-4c1a-b038-473a6420dbdc)
AND
NOT DB_CAMP_HalsinAlternatePositions(_, _, _)
THEN
DB_CAMP_HalsinAlternatePositions("SCL_Main_A", "SCLMAIN", S_Spawnpoint_Halsin_Fallback_SCLMain_A_ace27f95-a2a8-47b7-af83-287dd088bdf6);
DB_CAMP_HalsinAlternatePositions("SCL_Main_A", "SHARTEMPLE", S_Spawnpoint_Halsin_Fallback_SharTemple_A_f9cfd474-036d-4fe8-bdb1-0f8c916b563d);
DB_CAMP_HalsinAlternatePositions("SCL_Main_A", "HAVEN", S_Spawnpoint_Halsin_Fallback_Haven_A_7a60ed5c-b61a-49ee-a76d-1d15ebd4545e);
DB_CAMP_HalsinAlternatePositions("SCL_Main_A", "MOONRISE", S_Spawnpoint_Halsin_Fallback_Moonrise_A_d5ff68c8-73bd-4775-98ba-6ec7105caeec);
DB_CAMP_HalsinAlternatePositions("INT_Main_A", "INTMAIN", S_Spawnpoint_Halsin_Fallback_Int_A_cf74b25f-8428-4f22-8a4e-cf00fe0b532e);
DB_CAMP_HalsinAlternatePositions("BGO_Main_A", "FARM", S_Spawnpoint_Halsin_Fallback_Farm_A_8c491e2c-a407-421c-bd11-fe21f666e557);
DB_CAMP_HalsinAlternatePositions("CTY_Main_A", "SLUMS", S_Spawnpoint_Halsin_Fallback_Slums_A_a5f3d75a-74b2-49e0-90a9-54a2c50bdfa0);
DB_CAMP_HalsinAlternatePositions("CTY_Main_A", "ELFSONG", S_Spawnpoint_Halsin_Fallback_Elfsong_A_19c8c3a3-d5c0-4ab1-af37-e054ec4c5346);
DB_BUGFIX_Marker("GUS-316377");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_PartOfTheTeam(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
DB_PartOfTheTeam(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
NOT DB_GlobalFlag(CAMP_Halsin_Minthara_BothPresent_6e984e21-ad6b-4c1a-b038-473a6420dbdc)
THEN
PROC_GlobalSetFlagAndCache(CAMP_Halsin_Minthara_BothPresent_6e984e21-ad6b-4c1a-b038-473a6420dbdc);

//END_REGION GUS-316377

//REGION GUS-317760
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
NOT DB_InRegion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0)
AND
DB_GlobalFlag((FLAG)SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa)
THEN
SetTag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_ENEMYOFSHARPATH_8eca8027-996c-4c61-bec6-77f853de295b);
DB_BUGFIX_Marker("GUS-317760");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
NOT DB_InRegion((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TRIGGER)S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0)
AND
DB_GlobalFlag((FLAG)SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731)
THEN
SetTag(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, (TAG)SHADOWHEART_ENEMYOFSHARPATH_8eca8027-996c-4c61-bec6-77f853de295b);
DB_BUGFIX_Marker("GUS-317760-Balthazar");
//END_REGION GUS-317760

//REGION GUS-307509

//All DB_Combat_DifficultyItems entries are in SCL
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6 Hotfix 1", "SCL_Main_A", "GUS-307509");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-307509")
AND
DB_Combat_DifficultyItems((ITEM)_Item,(STRING)_Status,(STRING)_Difficulty)
AND
Exists(_Item,1)
AND
GetRegion(_Item,"SCL_Main_A")
THEN
DB_ExecuteWhenObjectInCurrentLevel("Combat_DifficultyItems_DifficultyChanged",(GUIDSTRING)_Item);
DB_BUGFIX_Marker("GUS-307509",_Item);

//END_REGION GUS-307509

//REGION GUS-318707

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6 Hotfix 3")
THEN
DB_BUGFIX_Marker("GUS-318707");
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6 Hotfix 3", "SCL_Main_A", "GUS-318707");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-318707")
AND
DB_State_Current(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_MintharaFate", "MOO_MintharaFate_State_Freed")
AND
IsPartyFollower(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1)
AND
NOT QRY_MOO_IsInMOO(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
CharacterGetOwner(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Player)
THEN
PROC_MOO_MintharaFate_StartEscapeDialog(_Player);

//END_REGION

//REGION GUS-318923
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6 Hotfix 3", "SCL_Main_A", "GUS-318923");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-318923")
THEN
PROC_SetAnubisConfig(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "GLO_Halsin_Act2_2");
//END_REGION GUS-318923

//REGION GUS-317957
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "SCL_Main_A", "GUS-317957");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-317957")
AND
DB_MOO_Jailbreak_Prisoner(_Prisoner, _)
AND
GetFlag((FLAG)MOO_Jailbreak_State_Escaping_139ced4b-4340-eb70-4a33-14279f87b2be, _Prisoner, 1)
THEN
SetEntityEvent(_Prisoner, "MOO_Jailbreak_SavegamePatch_317957");
DB_BUGFIX_Marker("GUS-317957",_Prisoner);
//END_REGION GUS-317957

//REGION GUS-318844

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_MOO_MintharaFate_Torturers(_Torturer)
AND
NOT DB_CombatReact_AD_OnNextTurn((CHARACTER)_Torturer, MOO_MintharaFate_AD_TorturersInCombat_17bd5c7a-8a46-1fff-e01f-f6c7210d64d4)
THEN
DB_MOO_MintharaFate_DidCombatAD((GUIDSTRING)S_MOO_MindTorturer_001_480b89b1-ae6c-46e7-ad79-1b3babe3655e);
DB_BUGFIX_Marker("GUS-318844",_Torturer);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_MOO_MintharaFate_Torturers(_Torturer)
AND
DB_CombatReact_AD_OnNextTurn((CHARACTER)_Torturer, MOO_MintharaFate_AD_TorturersInCombat_17bd5c7a-8a46-1fff-e01f-f6c7210d64d4)
THEN
NOT DB_CombatReact_AD_OnNextTurn((CHARACTER)_Torturer, MOO_MintharaFate_AD_TorturersInCombat_17bd5c7a-8a46-1fff-e01f-f6c7210d64d4);

//END_REGION GUS-318844

//REGION GUS-319034
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6 Hotfix 4")
AND
DB_LevelUnreachable("SCL_Main_A")
AND
DB_PartOfTheTeam(_Char)
AND
GetFlag(SCL_Event_TravelBackToAct1_c1f1104f-3908-4013-a1f9-76ba2738e37c, _Char, 1)
THEN
ClearFlag(SCL_Event_TravelBackToAct1_c1f1104f-3908-4013-a1f9-76ba2738e37c, _Char, 0, 0);
DB_BUGFIX_Marker("GUS-319034");
//END_REGION GUS-319034

//REGION GUS-319311
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6 Hotfix 5")
AND
DB_GlobalFlag(COL_PartyProgress_EnteredColony_666abe92-f197-4c38-85a8-d879a9e258b6)
THEN
PROC_GLO_NarrativeCombat_EndCombat("MOO_Assault_KethericRoofFight");
DB_BUGFIX_Marker("GUS-319311");
//END_REGION GUS-319311

//REGION GUS-320116

PROC
PROC_ApplySavegamePatches()
AND
NOT DB_GlobalFlag((FLAG)HAV_LiftingTheCurse_State_ChannelingComplete_1afd47bc-e8d5-464d-823a-7dba82fcf5c3)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "SCL_Main_A", "GUS-320116");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-320116")
AND
IsOnStage(S_HAV_HalsinPortal_f2b5ad7f-013c-4c9e-a755-5fe9ff3287f6, 1)
AND
NOT DB_Destroyed(S_HAV_HalsinPortal_f2b5ad7f-013c-4c9e-a755-5fe9ff3287f6)
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
THEN
DB_OneShotPartyTrigger(S_HAV_BUGFIX_TryRestartCombat_1424dbe2-ef81-44c3-a75d-b3eb16045765);
DB_BUGFIX_Marker("GUS-320116");


//END_REGION 

//REGION GUS-295944
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7","SCL_Main_A","GUS-295944");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUS-295944")
AND
DB_GlobalFlag((FLAG)COL_PartyProgress_EnteredColony_666abe92-f197-4c38-85a8-d879a9e258b6)
AND
DB_GlobalFlag(TWN_Wyll_State_MizorasCaptureHappened_80cb617e-e3c3-3386-3919-6caef51bfd5d)
AND
IsInTrigger(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,S_COL_Mizora_InPodAD_Box_7f66fa8c-79bd-4353-b660-040c8eb88844,1)
AND
NOT DB_GlobalFlag(COL_MizorasRescue_State_SavedMizora_148bcec2-5367-2b72-3c93-29fb32fc0181)
AND
NOT DB_GlobalFlag(MOO_MizorasRescue_Event_WalkedAway_bc19238e-efd0-fb9c-5018-5c2f7fb74f4b)
AND
NOT DB_PermaDefeated(S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a)
THEN
PROC_TriggerRegisterForParty(S_COL_Mizora_InPodAD_Box_7f66fa8c-79bd-4353-b660-040c8eb88844);
DB_BUGFIX_Marker("GUS-295944");

//END_REGION GUS-295944

//REGION GUSX-7020
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7","SCL_Main_A","GUSX-7020");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUSX-7020")
AND
QRY_MOO_IsInMOO((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_PartyMembers(_PartyMember)
AND
GetItemByTemplateInPartyInventory((ITEMROOT)GOB_DrowCommander_Mace_4b0131e0-875a-4f3c-8b41-dbf653857d00, _PartyMember, _Xyanyde)
AND
IsInMagicPockets(_Xyanyde, _PartyMember, 0)
AND
IsInInventoryOf(_Xyanyde, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0)
THEN
ToInventory(_Xyanyde, S_MOO_PrisonChest_3c6a641f-169e-453c-b4ee-234ca670abcc);
SetOnStage(_Xyanyde, 1);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUSX-7020")
AND
QRY_MOO_IsInMOO((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
GetItemByTemplateInPartyInventory((ITEMROOT)GOB_DrowCommander_Mace_4b0131e0-875a-4f3c-8b41-dbf653857d00, (CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Xyanyde)
AND
IsInInventoryOf(_Xyanyde, S_MOO_PrisonChest_3c6a641f-169e-453c-b4ee-234ca670abcc, 0)
THEN
ToInventory(_Xyanyde, S_MOO_PrisonChest_3c6a641f-169e-453c-b4ee-234ca670abcc);
SetOnStage(_Xyanyde, 1);
//END_REGION

//REGION GUSX-858

PROC
PROC_ApplySavegamePatches()
AND
DB_GlobalFlag((FLAG)MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6)
AND
NOT DB_GlobalFlag((FLAG)MOO_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03)
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_OffStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7","SCL_Main_A","GUSX-858");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","GUSX-858")
THEN
RemoveStatusesWithGroup(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SG_RemoveOnRespec",NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUSX-858");

//END_REGION GUSX-858

//REGION GUSX-7120
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "SCL_Main_A", "GUSX-7120");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-7120")
AND
DB_RegionPrison("SCL_Main_A_HAV", (TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a, (TRIGGER)S_HAV_AltPrisonSpawnPoint_cc75ca8e-a382-493a-b032-451394574b32)
AND
DB_FugitiveArea((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, (TRIGGER)S_HAV_FugitiveTravelBlockArea_f70c44f6-3abc-4cc9-bcd5-f57a95709118)
THEN
PROC_BUGFIX_GUSX_7120_FixPrison();

PROC
PROC_BUGFIX_GUSX_7120_FixPrison()
THEN
NOT DB_FugitiveArea((TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, (TRIGGER)S_HAV_FugitiveTravelBlockArea_f70c44f6-3abc-4cc9-bcd5-f57a95709118);
DB_FugitiveArea((TRIGGER)S_HAV_Prison_AltPlayerCell_6ee4ab20-dfb6-4ba8-871d-b8b18cc7291a, (TRIGGER)S_HAV_FugitiveTravelBlockArea_f70c44f6-3abc-4cc9-bcd5-f57a95709118);

PROC
PROC_BUGFIX_GUSX_7120_FixPrison()
AND
DB_PlayerEscapedPrison(_Player, _Arrester, (TRIGGER)S_HAV_Prison_PlayerCell_bf18c7a9-098d-4f14-b988-e9d094673c00, _ArrestedNotShapeshifted, _PrisonCrimeName, _PrisonCrimeNameAD, _EscapeID, _EscapeADID, _FugitiveStatus)
THEN
DB_BUGFIX_Marker("GUSX_7120_ReregisterEscapedCrime");
DB_HAV_Prison_SwitchEscapedCrimeToAltCell((CHARACTER)_Player, (CHARACTER)_Arrester, (INTEGER)_ArrestedNotShapeshifted, (STRING)_PrisonCrimeName, (STRING)_PrisonCrimeNameAD, (STRING)_FugitiveStatus);

PROC
PROC_BUGFIX_GUSX_7120_FixPrison()
AND
DB_IsArrested(_Arrester, _Player)
AND
NOT QRY_CRIME_Prison_IsInAnyPrison(_Player)
THEN
DB_BUGFIX_Marker("GUSX_7120_Clear_DB_IsArrested");
ClearFlag((FLAG)IsInPrison_c9b75b21-6eba-065e-7680-fc9a0c5838e4, _Player);
NOT DB_IsArrested(_Arrester, _Player);
//END_REGION GUSX-7120

//REGION GUSX-6971
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_State_Current(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_MintharaFate", "MOO_MintharaFate_State_PermaDefeated")
AND
DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
IsPartyFollower((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 1)
AND
CharacterGetOwner((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Player)
THEN
DB_BUGFIX_Marker("GUSX-6971");
RemovePartyFollower((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, _Player);
//END_REGION

//REGION GUSX-981
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "SCL_Main_A", "GUSX-981");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-981")
AND
DB_GlobalFlag(COL_PartyProgress_EnteredColony_666abe92-f197-4c38-85a8-d879a9e258b6)
AND
GetAnubisConfig(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "")
THEN
PROC_SetAnubisConfig(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_Necromancer_Chosen_Act2");
DB_BUGFIX_Marker("GUSX-981");
//END_REGION GUSX-981

//REGION GUS-319481
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
NOT DB_PartOfTheTeam((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
QRY_MOO_IsInMOO((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
THEN
DB_BUGFIX_Marker("GUS-319481");
ApplyStatus(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "TUT_RESTORATION", 6.0, 1, S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
//END_REGION

//REGION GUSX-882
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)MOO_MintharaFate_State_Waiting_609996c8-75d1-89f0-9ad3-1b7f73aee11d)
AND
GetHasOsirisDialog(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, 0)
THEN
DB_BUGFIX_Marker("GUSX-882");
PROC_RemoveAllDialogEntriesForSpeaker(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b);
DB_Dialogs(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (DIALOGRESOURCE)MOO_MintharaFate_Drow_deaff457-a97a-fd8f-9c46-517d1488a42a);
//END_REGION

//REGION GUSX-7928

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag(HAV_EnteringHaven_State_AttackedJaheira_38e31278-b40b-4d39-b79b-ce56f9f973bf)
THEN
DB_BUGFIX_Marker("GUSX-7928");
PROC_SpotPlayers_StopSpotting("HAV_EnteringHaven_CheckpointSpot");

//END_REGION

//REGION GUSX-7420
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-7420");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-981")
AND
DB_TWN_MarchingArmy_Criminals(_MainCriminal, _OtherCriminal)
AND
NOT DB_TWN_MarchingArmy_MainCriminal(_MainCriminal)
THEN
DB_BUGFIX_Marker("GUSX-7420", _OtherCriminal);
NOT DB_TWN_MarchingArmy_Criminals(_MainCriminal, _OtherCriminal);
//END_REGION

//REGION GUSX-8352
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-8352");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-8352")
AND
GetAnubisConfig(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "")
THEN
PROC_SetAnubisConfig(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "MOO_Executioner");
//END_REGION

//REGION GUSX-9054

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
NOT DB_MOO_Jailbreak_Prisoner((CHARACTER)S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "Gnomes")
AND
GetCombatGroupID(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "MOO_Jailbreak_Guards")
THEN
DB_BUGFIX_Marker("GUSX-9054");
SetCombatGroupID(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "");
LeaveCombat(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);

//END_REGION

//REGION GUSX-9289
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-9289");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9289")
AND
DB_State_Current(_Harper, "SCL_DriderHarpers", "BackAtInn")
THEN
DB_BUGFIX_Marker("GUSX-9289", _Harper);
SetFaction(_Harper, (FACTION)Act2_HAV_Haven_e52bfc8c-7826-470d-a9f5-f6fae80dde82);
//END_REGION GUSX-9289

//REGION GUSX-9416
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-9416");

//In narrative combat but not marked as a participant
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9416")
AND
DB_Is_InCombat(_Entity, _ID)
AND
DB_GLO_NarrativeCombat_ID(_Identifier, _ID)
AND
IsInNarrativeCombat(_Entity, _ID, 1)
AND
IsCharacter(_Entity, 1)
THEN
PROC_BG3_SavegamePatch_GUSX9416_AddCharacterParticipant(_Entity, _Identifier, _ID);

PROC
PROC_BG3_SavegamePatch_GUSX9416_AddCharacterParticipant((GUIDSTRING)_Entity, (STRING)_Identifier, (GUIDSTRING)_ID)
AND
NOT QRY_GLO_NarrativeCombat_IsDefeated((CHARACTER)_Entity)
AND
NOT DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, (GUIDSTRING)_Entity)
THEN
DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, _Entity);	
DB_BUGFIX_Marker("GUSX-9416_MarkedLivingParticipant", _Entity);

PROC
PROC_BG3_SavegamePatch_GUSX9416_AddCharacterParticipant((GUIDSTRING)_Entity, (STRING)_Identifier, (GUIDSTRING)_ID)
AND
QRY_GLO_NarrativeCombat_IsDefeated((CHARACTER)_Entity)
AND
NOT DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, (GUIDSTRING)_Entity)
THEN
DB_GLO_NarrativeCombat_WasParticipant(_Identifier, _ID, _Entity);
SetInNarrativeCombat(_Entity, _ID, 0);
PROC_GLO_NarrativeCombat_ParticipantLeft(_Identifier, _Entity);
DB_BUGFIX_Marker("GUSX-9416_MarkedDeadParticipant", _Entity);

PROC
PROC_BG3_SavegamePatch_GUSX9416_AddCharacterParticipant((GUIDSTRING)_Entity, (STRING)_Identifier, (GUIDSTRING)_ID)
AND
DB_BUGFIX_Marker("GUSX-9416_MarkedLivingParticipant", _Entity)
AND
DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, _Entity)
AND
DB_GLO_NarrativeCombat_Region(_Identifier, _Trigger)
AND
IsInTrigger(_Entity, _Trigger, 0)
THEN
PROC_GLO_NarrativeCombat_LeaveCombat(_Identifier, _Entity);
DB_BUGFIX_Marker("GUSX-9416_OutOfRegion", _Entity);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9416")
AND
DB_Is_InCombat(_Entity, _ID)
AND
DB_GLO_NarrativeCombat_ID(_Identifier, _ID)
AND
IsInNarrativeCombat(_Entity, _ID, 1)
AND
IsItem(_Entity, 1)
THEN
PROC_BG3_SavegamePatch_GUSX9416_AddItemParticipant(_Entity, _Identifier, _ID);

PROC
PROC_BG3_SavegamePatch_GUSX9416_AddItemParticipant((GUIDSTRING)_Entity, (STRING)_Identifier, (GUIDSTRING)_ID)
AND
IsDestroyed((ITEM)_Entity, 0)
AND
NOT DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, (GUIDSTRING)_Entity)
THEN
DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, _Entity);	
DB_BUGFIX_Marker("GUSX-9416_MarkedItemParticipant", _Entity);

//In the combat when they are outside the region
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9416")
AND
DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, _Entity)
AND
DB_GLO_NarrativeCombat_Region(_Identifier, _Region)
AND
IsInTrigger(_Entity, _Region, 0)
AND
IsCharacter(_Entity, 1)
THEN
PROC_GLO_NarrativeCombat_CharacterLeftRegion(_Identifier, (CHARACTER)_Entity, _Region);
PROC_GLO_NarrativeCombat_CheckForAnyPlayersInRegion(_Region);
DB_BUGFIX_Marker("GUSX-9416_OutsideRegion", _Entity);

//Any stray summons that are not in the combat already (carry over from another issue that should be fixed)
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9416")
AND
DB_GLO_NarrativeCombat_Region("MOO_Assault_KethericRoofFight", _Region)
AND
DB_GLO_NarrativeCombat_ID("MOO_Assault_KethericRoofFight", _ID)
AND
DB_InRegion(_Char, _Region)
AND
NOT DB_GLO_NarrativeCombat_Participant("MOO_Assault_KethericRoofFight", _ID, _Char)
AND
NOT QRY_GLO_NarrativeCombat_IsDefeated(_Char)
AND
GetFaction(_Char, ACT2_MOO_Assault_Hostile_68597716-e217-4777-a391-026263f291b4)
THEN
PROC_GLO_NarrativeCombat_JoinCombat("MOO_Assault_KethericRoofFight", _Char);
DB_BUGFIX_Marker("GUSX-9416_AddStraysToCombat", _Char);

//Pause the combat in the case all the players are dead within the region
PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9416")
AND
DB_GLO_NarrativeCombat_ID("MOO_Assault_KethericRoofFight", _ID)
AND
DB_GLO_NarrativeCombat_Region("MOO_Assault_KethericRoofFight", _Region)
AND
NOT QRY_GLO_NarrativeCombat_AnyLivingPartyMembersInRegion(_Region)
AND
NOT DB_MOO_Assault_RoofNarrativeCombatIsPaused(1)
THEN
DB_MOO_Assault_RoofNarrativeCombatIsPaused(1);
PauseCombat(_ID);
DB_BUGFIX_Marker("GUSX-9416_AllPlayerDeadPause");
//END_REGION 

//REGION GUSX-9144
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-9144");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9144")
AND
GetFaction(S_HAV_GnomeCat_33e545f6-9a0a-48ae-88b4-896a0c21c8ca, _Faction)
AND
_Faction != Act2_HAV_Haven_e52bfc8c-7826-470d-a9f5-f6fae80dde82
THEN
SetFaction(S_HAV_GnomeCat_33e545f6-9a0a-48ae-88b4-896a0c21c8ca, (FACTION)Act2_HAV_Haven_e52bfc8c-7826-470d-a9f5-f6fae80dde82);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9144")
AND
GetFaction(S_HAV_SpiritOfTheLand_1403cdfd-0660-4592-90c6-bfe4607ccd3a, _Faction)
AND
_Faction != Act2_SCL_SpiritOfTheLand_e30c1bf8-de2b-46d8-85a6-3c0da62fc67d
THEN
SetFaction(S_HAV_SpiritOfTheLand_1403cdfd-0660-4592-90c6-bfe4607ccd3a, (FACTION)Act2_SCL_SpiritOfTheLand_e30c1bf8-de2b-46d8-85a6-3c0da62fc67d);
//END_REGION

//REGION GUSX-9144_SCL
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-9144_SCL");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9144_SCL")
THEN
DB_BUGFIX_Marker("GUSX-9144_SCL", S_SHA_LightTrial_Shadow_000_fb9095d7-e399-4cdb-b90a-e4dba3451882);
SetFaction(S_SHA_LightTrial_Shadow_000_fb9095d7-e399-4cdb-b90a-e4dba3451882, (FACTION)Act2_SHA_ShadowTrial_24116bb3-6424-42d3-8b28-83493c346be2);
DB_BUGFIX_Marker("GUSX-9144_SCL", S_SHA_LightTrial_Shadow_001_f4ef2c8e-02fd-4382-a395-4bebc674881d);
SetFaction(S_SHA_LightTrial_Shadow_001_f4ef2c8e-02fd-4382-a395-4bebc674881d, (FACTION)Act2_SHA_ShadowTrial_24116bb3-6424-42d3-8b28-83493c346be2);

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9144_SCL")
AND
DB_SCL_MastiffPoachers_Mastiffs(_Mastiff, _)
AND
GetBaseFaction(_Mastiff, (FACTION)NeutralNPC_cfb709b3-220f-9682-bcfb-6f0d8837462e)
THEN
DB_BUGFIX_Marker("GUSX-9144_SCL", _Mastiff);
SetFaction(_Mastiff, (FACTION)Act2_SCL_MastiffPoachers_Mastiffs_8b12962b-60e6-4434-9bcd-0073748ce504);
//END_REGION GUSX-9144_SCL


//REGION GUSX-10803
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
NOT DB_PermaDefeated(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_GlobalFlag(DEN_AttackOnDen_State_RaiderVictory_abe1bce8-c234-4afe-a490-76210d98a078)
AND
NOT DB_InCamp(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
AND
NOT DB_State_Current(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, "SCL_LiftingTheCurse", "SCL_LiftingTheCurse_State_HalsinAtHaven")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_LevelLoadedOnce("INT_Main_A")
AND
DB_Dialogs(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, CAMP_Halsin2_c0ab0f6f-3ffc-d06d-0d6d-d1aaef70dfe4)
THEN
PROC_ORI_Halsin_RestoreToSCLCamp();
DB_BUGFIX_Marker("GUSX-10803");
//END_REGION

//REGION GUSX-11358

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7 Hotfix 2", "SCL_Main_A", "GUSX-11358");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-11358")
THEN
DB_COL_Elevator_ChasmKillTriggers((TRIGGER)S_COL_Elevator_ChasmKillTrigger_001_1e1bc128-42f3-441f-878c-f006ef828db7,(TRIGGER)S_COL_Elevator_ChasmKillTrigger_ReturnPosition_001_ebedfca2-141c-48eb-aaf7-9c2e7560d414);
DB_COL_Elevator_ChasmKillTriggers((TRIGGER)S_COL_Elevator_ChasmKillTrigger_002_e3ebf46c-a9c7-41a6-8c5e-1f0a9992a9f3,(TRIGGER)S_COL_Elevator_ChasmKillTrigger_ReturnPosition_002_6ca3b0bf-3d95-4f40-88c7-daf4f42ac269);

//END_REGION GUSX-11358

//REGION GUSX-10629
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-10629");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-10629")
AND
DB_PartyMembers(_Player)
AND
GetFlag(MOO_MoonriseBazaarSoulCoins_Event_FloNoteHandoff_3ecdf2fb-b353-14f0-417c-7d8f99ae5c1e, _Player, 1)
THEN
SetFlag(MOO_MoonriseBazaarSoulCoins_State_NoteGiven_5b8c8557-ec28-4f2a-b1bb-da9df339cde7);
DB_BUGFIX_Marker("GUSX-10629", _Player);

//END_REGION GUSX-10629

//REGION GUSX-12218
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-12218");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-12218")
AND
DB_GLO_CharacterCorpseDialog(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,GOB_DrowCommander_Dead_fabcb4f5-d52f-b0c6-5101-566760e060c2)
AND
NOT QRY_State_IsBeforeState(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, "MOO_MintharaFate", "MOO_MintharaFate_State_Escortee")
THEN
NOT DB_GLO_CharacterCorpseDialog(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b,GOB_DrowCommander_Dead_fabcb4f5-d52f-b0c6-5101-566760e060c2);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, (DIALOGRESOURCE)SCE_Minthara_Dead_bad79925-03a8-6283-594e-41ca28fe224e);
//END_REGION GUSX-12218

//REGION GUSX-6271 //hatchery quest should no longer be active if the player can't go back to the creche
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-6271");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-6271")
AND
DB_GlobalFlag((FLAG)Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3)
AND
NOT DB_QuestIsClosed("CRE_Hatchery")
THEN
QuestClose("CRE_Hatchery");
//END_REGION GUSX-6271

//REGION GUSX-9144 (SCL)
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-9144-SCL");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9144-SCL")
THEN
// re-using an existing PROC
PROC_Bugfix_GUSX_9144_WYR_CheckChangeFaction((CHARACTER)S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, (FACTION)ORI_Gale_Double_e339933e-64a7-4168-8171-5ebd06aa8e8e);
DB_BUGFIX_Marker("GUSX-9144-SCL");
//END_REGION

//REGION GUSX-12175
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-12175");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-12175")
AND
NOT DB_PartyMembers((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
AND
DB_GlobalFlag((FLAG)SHA_NightsongPrison_Event_ShadowheartThereForFate_dea37dda-dafe-4052-9935-6ef1f92febfb)
THEN
PROC_GlobalClearFlagAndCache((FLAG)SHA_NightsongPrison_Event_ShadowheartThereForFate_dea37dda-dafe-4052-9935-6ef1f92febfb);
DB_BUGFIX_Marker("GUSX-12175");
//END_REGION

//REGION GUSX-5231
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-5231");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-5231") 
THEN
DB_CAMP_ThanielAlternatePositions("SCL_Main_A", "SCLMAIN", S_Spawnpoint_Thaniel_Fallback_SCLMain_A_53d6717e-0212-4631-bfba-3b81229b0e15);
DB_CAMP_ThanielAlternatePositions("SCL_Main_A", "SHARTEMPLE", S_Spawnpoint_Thaniel_Fallback_SharTemple_A_c404a6bf-273c-4869-a2d4-00b6fdbd3fd4);
DB_CAMP_ThanielAlternatePositions("SCL_Main_A", "HAVEN", S_Spawnpoint_Thaniel_Fallback_Haven_A_86b896c3-74a0-4baa-8b5f-125ea4274f50);
DB_CAMP_ThanielAlternatePositions("SCL_Main_A", "MOONRISE", S_Spawnpoint_Thaniel_Fallback_Moonrise_A_4278d06e-985b-4df0-8660-3a7240741df9);

//END_REGION GUSX-5231

//REGION GUSX-12582
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_ORI_DarkUrge_BecameHostileAfterMurder(_Avatar)
AND
DB_Avatars(_Avatar) //Should never happen on Avatar characters
THEN
PROC_Bugfix_GUSX_12582_FixBrokenCharacter(_Avatar);

PROC
PROC_Bugfix_GUSX_12582_FixBrokenCharacter((CHARACTER)_Avatar)
AND
GUIDToString(_Avatar, _AvatarString)
AND
Concatenate("GUSX-12582_", _AvatarString, _BugfixString)
THEN
DB_BUGFIX_Marker(_BugfixString);

PROC
PROC_Bugfix_GUSX_12582_FixBrokenCharacter((CHARACTER)_Avatar)
THEN
NOT DB_Origin_BecameHostile(_Avatar);
NOT DB_ORI_DarkUrge_BecameHostileAfterMurder(_Avatar);

PROC
PROC_Bugfix_GUSX_12582_FixBrokenCharacter((CHARACTER)_Avatar)
AND
DB_PermaDefeatedFlag(_Avatar, _Flag)
THEN
ClearFlag(_Flag);

PROC
PROC_Bugfix_GUSX_12582_FixBrokenCharacter((CHARACTER)_Avatar)
AND
DB_PermaDefeated(_Avatar)
THEN
NOT DB_Dead(_Avatar);
NOT DB_PermaDefeated(_Avatar);
ClearTag(_Avatar, PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
ClearTag(_Avatar, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
ClearTag(_Avatar, DOWNED_DISABLED_7095912e-fcb9-41dd-aec3-3cf7803e4b22);
DB_PartOfTheTeam(_Avatar);
Resurrect(_Avatar);
//END_REGION

//REGION GUSX-10203
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-10203");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-10203") 
THEN
PROC_DeclareCounter("SHA_SaveGamePatchGems_Counter");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-10203") 
AND
DB_SHA_Trials_HasGemFlag(_Gem, _)
AND
NOT DB_SHA_Trials_GemsNotTaken((ITEM)_Gem)
AND
Exists(_Gem, 1)
THEN
PROC_IncreaseCounter("SHA_SaveGamePatchGems_Counter");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-10203") 
THEN
PROC_SHA_SaveGamePatchGems_FindPlayer();

PROC
PROC_SHA_SaveGamePatchGems_FindPlayer()
AND
GetHostCharacter(_Player)
THEN
PROC_SHA_SaveGamePatchGems_CountGemsNeeded((CHARACTER)_Player);

PROC
PROC_SHA_SaveGamePatchGems_CountGemsNeeded((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)SHA_Upper_State_DiscUnlocked_4b056ce5-e145-4d90-8451-0ff502e11898)
AND
NOT DB_GlobalFlag((FLAG)SHA_Trials_Event_UnlockNightsongChamber_8e857d0c-990b-4029-aa28-f5b935fb8c0f)
THEN
PROC_SHA_SaveGamePatchGems_CheckLootedGems((CHARACTER)_Player, 4);

PROC
PROC_SHA_SaveGamePatchGems_CountGemsNeeded((CHARACTER)_Player)
AND
DB_GlobalFlag((FLAG)SHA_Upper_State_DiscUnlocked_4b056ce5-e145-4d90-8451-0ff502e11898)
AND
NOT DB_GlobalFlag((FLAG)SHA_Trials_Event_UnlockNightsongChamber_8e857d0c-990b-4029-aa28-f5b935fb8c0f)
THEN
PROC_SHA_SaveGamePatchGems_CheckLootedGems((CHARACTER)_Player, 3);

PROC
PROC_SHA_SaveGamePatchGems_CountGemsNeeded((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)SHA_Upper_State_DiscUnlocked_4b056ce5-e145-4d90-8451-0ff502e11898)
AND
DB_GlobalFlag((FLAG)SHA_Trials_Event_UnlockNightsongChamber_8e857d0c-990b-4029-aa28-f5b935fb8c0f)
THEN
PROC_SHA_SaveGamePatchGems_CheckLootedGems((CHARACTER)_Player, 1);

PROC
PROC_SHA_SaveGamePatchGems_CheckLootedGems((CHARACTER)_Player, (INTEGER)_SocketCount)
AND
DB_GlobalCounter("SHA_SaveGamePatchGems_Counter", _PlayerCount)
AND
DB_GlobalFlag((FLAG)SHA_Trials_Event_AllGemsFound_2d47ee89-2a15-4b33-b933-59f0b0aa6f3b)
AND
IntegerSubtract(_SocketCount, _PlayerCount, _Count)
THEN
TemplateAddTo(QUEST_SHA_TrialOrb_fd3fd8a9-a5fc-4726-9b6e-77f5ecf54cea, _Player, _Count, 1);

PROC
PROC_SHA_SaveGamePatchGems_CheckLootedGems((CHARACTER)_Player, (INTEGER)_SocketCount)
AND
DB_GlobalCounter("SHA_SaveGamePatchGems_Counter", _PlayerCount)
AND
DB_GlobalCounter("SHA_Trials_GemsTaken", _LootCount)
AND
_LootCount <= _SocketCount
AND
IntegerSubtract(_LootCount, _PlayerCount, _Count)
THEN
TemplateAddTo(QUEST_SHA_TrialOrb_fd3fd8a9-a5fc-4726-9b6e-77f5ecf54cea, _Player, _Count, 1);

PROC
PROC_SHA_SaveGamePatchGems_CheckLootedGems((CHARACTER)_Player, (INTEGER)_SocketCount)
AND
DB_GlobalCounter("SHA_SaveGamePatchGems_Counter", _PlayerCount)
AND
DB_GlobalCounter("SHA_Trials_GemsTaken", _LootCount)
AND
_LootCount > _SocketCount
AND
IntegerSubtract(_SocketCount, _PlayerCount, _Count)
THEN
TemplateAddTo(QUEST_SHA_TrialOrb_fd3fd8a9-a5fc-4726-9b6e-77f5ecf54cea, _Player, _Count, 1);


//END_REGION GUSX-10203

//REGION GUSX-11513
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-11513");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-11513")
AND
DB_GLO_NarrativeCombat_ID("MOO_Assault_KethericRoofFight", _ID)
AND
NOT DB_MOO_Assault_RoofNarrativeCombatEnemy(_)
THEN
PROC_GLO_NarrativeCombat_EndCombat("MOO_Assault_KethericRoofFight");
DB_BUGFIX_Marker("GUSX-11513");
//END_REGION 

//REGION GUSX-9162
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-9162");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-9162")
AND
NOT DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)SCL_OliverShadow_Acceptance_f268fd19-252c-9e06-5f77-996a975ecc59)
THEN
DB_IgnoreMutingStatussesDialog((DIALOGRESOURCE)SCL_OliverShadow_Acceptance_f268fd19-252c-9e06-5f77-996a975ecc59);
//END_REGION

//REGION GUSX-9766
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_GLO_NarrativeCombat_Participant(_Identifier, _ID, _Entity)
AND
DB_GLO_NarrativeCombat_Region(_Identifier, _Trigger)
AND
IsInTrigger(_Entity, _Trigger, 0)
AND
Concatenate("GUSX-9766_", _Identifier, _BugfixString)
THEN
PROC_GLO_NarrativeCombat_LeaveCombat(_Identifier, _Entity);
DB_BUGFIX_Marker(_BugfixString, _Entity);
//END_REGION GUSX-9766

//REGION GUSX-5898
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "SCL_Main_A", "GUSX-5898_AcceptedLastLightQuest");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUSX-5898_AcceptedLastLightQuest")
THEN
DB_GLO_PaladinMoments_AcceptedLastLightQuest((FLAG)GLO_HAV_IsobelGaveMission_4f0dd500-6de8-08ce-7db9-083c891e67e7);
DB_GLO_PaladinMoments_AcceptedLastLightQuest((FLAG)HAV_Isobel_State_ReceivedMoonriseQuest_3025b1d0-30ba-4572-baf9-a4e97fea8ae5);
DB_GLO_PaladinMoments_AcceptedLastLightQuest((FLAG)HAV_Jaheira_State_MissionGiven_7516666c-4c71-86d7-9d2b-9f3a4269970b);
//END_REGION GUSX-5898
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "__Start"
