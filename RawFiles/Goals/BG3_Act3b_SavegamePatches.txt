Version 1
SubGoalCombiner SGC_AND
INITSECTION
NOT DB_LOW_CazadorsPalace_RitualRoom_AstarionsFaction((FACTION)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_LOW_SorcerousSundries_BookBoundTo((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);
NOT DB_LOW_SorcerousSundries_ReadyToReadLastPage((CHARACTER)NULL_00000000-0000-0000-0000-000000000000);

KBSECTION
//REGION GUS-298342
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
NOT DB_QuestDef_State_ConditionalFlag(LOW_CazadorsPalace_Cells_Knows_GurChildren_0e263a7e-5d16-3753-c5ba-ae39e4cc16b6, "WYR_CazadorPalace", "ReleasedPrisoners_NoGur", 0, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
NOT DB_QuestDef_State_ConditionalFlag(LOW_CazadorsPalace_Cells_Knows_GurChildren_0e263a7e-5d16-3753-c5ba-ae39e4cc16b6, "WYR_CazadorPalace", "ReleasedPrisoners_GurQuest", 1, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
NOT DB_QuestDef_State_ConditionalFlag(LOW_CazadorsPalace_Cells_Knows_GurChildren_0e263a7e-5d16-3753-c5ba-ae39e4cc16b6, "WYR_CazadorPalace", "LeftPrisoners_NoGur", 0, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
NOT DB_QuestDef_State_ConditionalFlag(LOW_CazadorsPalace_Cells_Knows_GurChildren_0e263a7e-5d16-3753-c5ba-ae39e4cc16b6, "WYR_CazadorPalace", "LeftPrisoners_GurQuest", 1, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
DB_QuestDef_State_ConditionalFlag(LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240, "WYR_CazadorPalace", "ReleasedPrisoners_NoGur", 0, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
DB_QuestDef_State_ConditionalFlag(LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240, "WYR_CazadorPalace", "ReleasedPrisoners_GurQuest", 1, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
DB_QuestDef_State_ConditionalFlag(LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5, "WYR_CazadorPalace", "LeftPrisoners_NoGur", 0, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
DB_QuestDef_State_ConditionalFlag(LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5, "WYR_CazadorPalace", "LeftPrisoners_GurQuest", 1, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
DB_BUGFIX_Marker("GUS-298342");
//END_REGION

//REGION GUS-306288

//First, we need to make sure that if Jaheira is still an NPC in camp, that she's properly recruited.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_PartOfTheTeam(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a) //Might not be necessary? I presume PartOfTheTeam is cleared when this happens, but just incase
AND
NOT DB_OnlyOnce("RecruitedFirstTime_Jaheira")
AND
GetHostCharacter(_Player)
THEN
SetFlag(ORI_LaezelRecruitment_Event_InvitedToCamp_5ac352a5-58c2-a8ed-1957-199d8bc284da, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_CheckFirstTimeRecruited((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
RegisterAsCompanion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(CHARACTER)_Player);
PROC_ORI_SetupCamp(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
ClearTag(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (TAG)BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6);
PROC_ORI_Jaheira_PatchLeavingIfMinscUnrecruitable();

//Then we make sure that if Minsc has already died/been shooed away/left, then Jaheira should also start leaving
PROC
PROC_ORI_Jaheira_PatchLeavingIfMinscUnrecruitable()
AND
DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_Origins_ForceLowApprovalLeavingDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_ORI_Jaheira_PatchLeavingIfMinscUnrecruitable()
AND
DB_GlobalFlag(ORI_Minsc_State_SavedButNotRecruited_8d437b31-7b27-478a-8c76-4cc095006d3f)
THEN
PROC_Origins_ForceLowApprovalLeavingDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_ORI_Jaheira_PatchLeavingIfMinscUnrecruitable()
AND
DB_GlobalFlag(ORI_Minsc_State_LeftPermanently_e2deaab0-bcd6-4dfa-9e53-26e3b764035b)
THEN
PROC_Origins_ForceLowApprovalLeavingDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

//END_REGION

//REGION GUS-298318
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
PROC_GLO_Bugfix_298318_Remove_PlayableDBs();	// if Orin was in DB_GLO_Playable
PROC_GLO_Bugfix_298318_Remove_PlayableTag();	// if Orin was given PLAYABLE tag
PROC_GLO_Bugfix_298318_ShouldBePermaDefeated();	// if Orin was already defeated, need to make sure she really is PermaDefeated.
DB_BUGFIX_Marker("GUS-298318");

PROC
PROC_GLO_Bugfix_298318_Remove_PlayableDBs()
AND
DB_GLO_Playable(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
NOT DB_GLO_Playable(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
NOT DB_CanBeResurrected(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);

PROC
PROC_GLO_Bugfix_298318_Remove_PlayableTag()
AND
IsTagged(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (TAG)PLAYABLE_25bf5042-5bf6-4360-8df8-ab107ccb0d37, 1)
THEN
ClearTag(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, (TAG)PLAYABLE_25bf5042-5bf6-4360-8df8-ab107ccb0d37);

PROC
PROC_GLO_Bugfix_298318_ShouldBePermaDefeated()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575)
THEN
DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
//END_REGION

//REGION GUS-299893

//Here to specifically catch any ambushers that somehow remain in combat after the Sniper dies. Check for bosses wants to check that at least one is dead

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
AND
QRY_LOW_BhaalApproach_BhaalBossDead()
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _String)
AND
DB_Is_InCombat(_Ambusher, _GUID)
THEN
DB_LOW_UndercityRuins_AmbusherOffstageNextTurn(_Ambusher);
DB_BUGFIX_Marker("GUS-299893");

//And to just make sure incase any of them are still onstage, we make them run. Check for boss deaths wants to check that at least one of them is dead

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _String)
AND
QRY_LOW_BhaalApproach_BhaalBossDead()
AND
IsOnStage(_Ambusher, 1)
AND
NOT DB_Is_InCombat(_Ambusher, _)
THEN
PROC_Poof(_Ambusher);
DB_BUGFIX_Marker("GUS-299893");

//If both of them still live, this is a catch all to return any mistakenly offstaged to be back onstage

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
AND
NOT DB_PermaDefeated(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093)
AND
NOT DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_LOW_UndercityRuins_CultistAmbushCombatants(_Ambusher, _String)
AND
IsOnStage(_Ambusher, 0)
AND
NOT DB_PermaDefeated(_Ambusher)
THEN
SetOnStage(_Ambusher, 1);
DB_BUGFIX_Marker("GUS-299893");

QRY
QRY_LOW_BhaalApproach_BhaalBossDead()
AND
DB_PermaDefeated(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093)
THEN
DB_NOOP(1);

QRY
QRY_LOW_BhaalApproach_BhaalBossDead()
AND
DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
DB_NOOP(1);

//END_REGION GUS-299893

//REGION GUS-298947 Add to DB the new spiritual wall VFX marking the trigger where the Farslayer of Bhaal (sniper) can instakill you
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-298947");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-298947")
THEN
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_01_Red_002_bbc268ba-5a30-4165-bd02-731ce6769cbf);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_01_Red_003_3b4703af-94b0-4731-bb51-9da9f4a68523);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_01_Red_004_ff655eba-2663-4a07-8e69-0587fbb2d016);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_01_Red_005_c3c9d305-c445-42e9-ab3b-4acbc89975bf);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Big_Curve_Deep_02_Red_000_4e14308d-e8c8-4cf0-bc25-c6673d603020);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Big_Single_01_Red_000_fffd0c07-fb64-4a40-a964-200a060198d7);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Big_Single_01_Red_001_2b7cac6d-591e-4997-82f3-92963404645f);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Deep_01_Red_000_58de67f3-ab6d-4c2a-88d8-aeadfa94bb47);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Deep_01_Red_001_8b3adc08-1e4e-44b0-9610-a9211d9841c0);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Small_01_Red_000_6ea4e930-be61-4a01-8c9e-6e433ace8eb5);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Small_01_Red_001_03e079b5-1f00-475f-b4f3-d2ea9283249f);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Small_01_Red_002_35e97627-f705-416e-9ad9-8a1453343314);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Tall_01_Red_000_c8627cc3-56d2-4fea-915a-7cd3c2f179a2);
DB_UndercityRuins_SniperRitualWalls((ITEM)S_VFX_Environment_LOW_Hole_SlowFire_Tall_01_Red_001_adbdb286-1261-4f42-ae76-87a4f0a482e4);
DB_BUGFIX_Marker("GUS-298947");
//END_REGION

//REGION GUS-299606

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
AND
IsInCombat(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, 1)
AND
HasActiveStatus((CHARACTER)S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093,"LOW_BHAALCULTIST_SNIPING_AIMING", 1)
THEN
PROC_LOW_UndercityRuins_AddEntrancedStatusToAmbushers();
PROC_LOW_UndercityRuins_BlockExitDoor();

//END_REGION GUS-299606


//REGION GUS-301064

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
QRY_LOW_GuildhallEntrance_NinefingersFallen()
THEN
DB_LOW_GuildhallEntrance_CheckGuardsWhenInCity(1);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_GuildhallEntrance_CheckGuardsWhenInCity(1)
AND
DB_LOW_GuildhallEntrance_Guards(_Guard)
THEN
PROC_NotifyWhenReadyToMoveOn((CHARACTER)_Guard, "LOW_GuildhallEntrance_GuardsReadyToRun");
NOT DB_LOW_GuildhallEntrance_CheckGuardsWhenInCity(1);
DB_BUGFIX_Marker("GUS-301064");

//Query for the relevant flags - Returns QRY true if either are valid

QRY
QRY_LOW_GuildhallEntrance_NinefingersFallen()
AND
DB_GlobalFlag(LOW_Guildhall_State_PostCoup_ZhentControlled_bd914804-54c7-4de2-b51e-988919c2e644)
THEN
DB_BUGFIX_Marker("GUS-301064");

QRY
QRY_LOW_GuildhallEntrance_NinefingersFallen()
AND
DB_GlobalFlag(LOW_Guildhall_State_PostCoup_PlayerControlled_fd323316-a97e-4b00-8570-50552715b43b)
THEN
DB_BUGFIX_Marker("GUS-301064");

//END_REGION GUS-301064

//REGION GUS-298465
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_Avatars(_Avatar)
AND
NOT DB_ORI_Minsc_AlreadyInitializedApproval(_Avatar)
AND
ChangeApprovalRating((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, _Avatar, 0, 40, _)
THEN
DB_ORI_Minsc_AlreadyInitializedApproval(_Avatar);
DB_BUGFIX_Marker("GUS-298465");
//END_REGION

//REGION GUS-297002
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
THEN
NOT DB_QuestDef_State((FLAG)WYR_OrinsImpersonation_State_MetOrinOnce_5f82392a-6e8f-4c9b-a927-b9d77ee263ec, "LOW_FindBhaalTemple", "OrinImpersonatedFirst");
DB_BUGFIX_Marker("GUS-297002");
//END_REGION GUS-297002

//REGION GUS-298482
//Gondians aren't supposed to react to the player's trespassing
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,4,0)
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_ApplySavegamePatch_GUS_298482(1);

IF
DB_ApplySavegamePatch_GUS_298482(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_Gondians(_Gondian)
AND
NOT DB_PermaDefeated(_Gondian)
THEN
PROC_CharacterDisableCrime((CHARACTER)_Gondian, "Trespassing");
DB_BUGFIX_Marker("GUS-298482");
NOT DB_ApplySavegamePatch_GUS_298482(1);
//END_REGION

//REGION GUS-302001
//Specifically here to free you from Fig's spotting if she's spotted you and trapped you. Everything else is handled in the goal
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
GetFlag(LOW_JaheirasHouse_State_GranddaughterSawJaheira_4041963d-4576-4041-96e0-26501bff40ba, S_LOW_JaheirasHouse_JaheiraYoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, 1)
THEN
PROC_SpotPlayers_StopSpotting("LOW_JaheirasHouse_YoungestDaughterLookingForJaheira");
PROC_SpotPlayers_StopSpotting("LOW_JaheirasHouse_YoungestDaughterLookingForSomeone");
DB_BUGFIX_Marker("GUS-302001");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_GlobalFlag(LOW_JaheirasHouse_State_YoungestTriedToStopEntry_9556ac12-1bfd-4b4d-8008-cc89736c5f3f)
THEN
PROC_SpotPlayers_StopSpotting("LOW_JaheirasHouse_YoungestDaughterLookingForSomeone");
DB_BUGFIX_Marker("GUS-302001");
//END_REGION

//REGION GUS-305206

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlagReactionAfterDialog(WYR_Knows_MinscDisappeared_819a8b67-554c-4cf1-96ae-14834b873b3e, WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427)
THEN
NOT DB_GlobalFlagReactionAfterDialog(WYR_Knows_MinscDisappeared_819a8b67-554c-4cf1-96ae-14834b873b3e,WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427);
DB_GlobalFlagReactionAfterDialog(WYR_Knows_LookingForRashemaar_558b2edb-6ac1-4fab-977f-03d055c4bf2d, WYR_Axe_RealHarper_Alive_eeadc7c5-6927-c213-62bd-c1eb0493c427);
DB_BUGFIX_Marker("GUS-305206");

//END_REGION

//REGION GUS-297011

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_GlobalFlagReactionAfterDialog(LOW_KurwinCoffin_State_KidNecromancer_RaisedBrotherFromDead_50f20126-fafe-f712-8e3d-08d521ea183d, LOW_KurwinCoffin_KidNecromancer_ec5d912b-b3cd-0476-50b3-52598ac1b30d)
THEN
DB_GlobalFlagReactionAfterDialog(LOW_KurwinCoffin_State_KidNecromancer_RaisedBrotherFromDead_50f20126-fafe-f712-8e3d-08d521ea183d, LOW_KurwinCoffin_KidNecromancer_ec5d912b-b3cd-0476-50b3-52598ac1b30d);
DB_BUGFIX_Marker("GUS-297011");

//END_REGION GUS-297011

//REGION GUS-299050
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_001_a47c4303-7771-476d-8048-f970e28e9ef5, (ITEM)S_LOW_MistyStep_Helper_001_Return_050bcdb1-1ffc-46bd-b100-913f8a0517ee);
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_003_f530157f-0c10-4515-91e3-5e952948c0d1, (ITEM)S_LOW_MistyStep_Helper_003_Return_dfa817f1-fa69-4b72-89fd-c6ac01bbf04f);
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_002_06e2f47b-e627-4865-809e-d708227bdae8, (ITEM)S_LOW_MistyStep_Helper_002_Return_9af0d3cf-ce8f-44b6-a070-59efdfa972aa);
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_004_79fc3097-3dee-4542-985e-b1a4dbb76977, (ITEM)S_LOW_MistyStep_Helper_004_Return_689f7be5-93e0-4515-88a7-9a02f49cd844);
DB_LOW_SorcerousSundries_MistyStepTeleporters((ITEM)S_LOW_MistyStep_Helper_005_85f5339b-842b-4749-9f95-1d29beba544c, (ITEM)S_LOW_MistyStep_Helper_005_Return_f192d087-b0d9-4a53-a861-96086d1f9de2);
DB_BUGFIX_Marker("GUS-299050");

//END_REGION

//REGION GUS-299976
//TG Setup for meeting Jaheira's fam is missing
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
THEN
DB_TopicalGreeting((FLAG)TG_ORI_Jaheira_VisitedFamily_f9e7b57a-eb0d-45b4-b7d6-8ebf1f2bb327);
DB_BUGFIX_Marker("GUS-299976");

//END_REGION GUS-299976

//REGION GUS-298176, GUS-298494 and GUS-298385
// If she's meant to be dead by Act 3 - Make sure she's set up correctly to be dead.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
NOT DB_GlobalFlag(GLO_Jaheira_Knows_HarpersAtDanthelon_3d66ab2d-7997-3a14-8fcc-9291a8802c5c)
AND
NOT DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_IsEditor(1)
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelLoadedOnce("END_Main_A")
THEN
PROC_LOW_Jaheira_SetUpJaheiraLeaving();
DB_BUGFIX_Marker("GUS-298176");
DB_BUGFIX_Marker("GUS-298494");
DB_BUGFIX_Marker("GUS-298385");
// Otherwise, set her up to be a companion come act 3, and set the family back up

//If Jaheira has spoken to you about Danthelons, we assume she's tried to join in *some* way and make sure she's alive, and drag
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_GlobalFlag(GLO_Jaheira_Knows_HarpersAtDanthelon_3d66ab2d-7997-3a14-8fcc-9291a8802c5c)
AND
DB_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelLoadedOnce("END_Main_A")
THEN
PROC_GLO_Bugfix_Jahira_ReviveAndSetupFamily();

PROC
PROC_GLO_Bugfix_Jahira_ReviveAndSetupFamily()
THEN
PROC_GlobalClearFlagAndCache(LOW_JaheirasHouse_State_FamilyHasReasonToLeave_a60ebbac-f4a7-4ed8-a565-4a10dbb641e2);
Resurrect(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
NOT DB_Dead(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
NOT DB_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
PROC_ORI_SetupCamp(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_OriginNPCAlignment((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(FACTION)GLO_Jaheira_e7dfda4a-9696-4aa1-9abc-9a350a797ed6);
DB_OriginCampFlags((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(FLAG)JAHEIRA_8b7fd8c6-4d49-4932-b525-7dda10cf4a1b,(FLAG)JAHEIRAAVATAR_b8cb0de2-c543-4e3f-8270-7fe1c06b7a53,(FLAG)JAHEIRACOMPANION_cb886250-baf1-437e-b9de-ae97824a0e15,(FLAG)JAHEIRAPARTY_eb34cb38-9394-41bc-9ab3-15f5f32f60d3,(FLAG)JAHEIRACAMP_ec198187-5cf8-4c02-831c-3afc919ca2c4);
DB_OriginInPartyGlobal((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(FLAG)ORI_Jaheira_State_IsInParty_1b86aa78-a2db-4faa-b4a6-c5591c03bac9);
DB_OriginPartOfTheTeamFlag((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (FLAG)GLO_Origin_PartOfTheTeam_Jaheira_d7d29efe-70bb-47c2-9db3-bc8a10347bc6,(FLAG)GLO_Origin_Avatar_Jaheira_84e74ea2-5d12-4b81-812e-f21972974dde,(FLAG)ORI_Jaheira_ControlledByUser_c7addde5-54b9-4d34-b52d-88d67786d913);
DB_OriginKickFromPartyFlags((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (FLAG)ORI_Jaheira_Event_KickCompanion_69deb113-8b45-415c-9fa2-77fc3dcf86c6, (FLAG)ORI_Jaheira_State_CanBeKicked_716f221e-07f4-4647-a757-153eace2255a);
DB_OriginRecruitmentDialog((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(DIALOGRESOURCE)Jaheira_Recruitment_Moonrise_04443f0f-9c62-d474-a98a-3e13eec31c69);
DB_OriginInPartyDialog((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (DIALOGRESOURCE)Jaheira_InParty_e97481ba-961c-50a7-c54f-d34d6b75044d);
DB_OriginWarning1Dialog((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(DIALOGRESOURCE)Jaheira_Warning1_daf6d50c-05cf-656e-6398-b8e5be1dc053);
DB_OriginWarning2Dialog((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(DIALOGRESOURCE)Jaheira_Warning2_9ef55235-3e1d-d4a5-8652-41b613f42ef6);
DB_OriginLeavingDialog((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(DIALOGRESOURCE)Jaheira_Leaving_9c96c524-5692-ee30-3ee8-9b1ad4262fb1);
DB_Inclusion_Object((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a,(FLAG)GLO_Jaheira_Inclusion_Start_45daca8e-51d2-4aa0-b65a-e406e5ab7f7f,(FLAG)GLO_Jaheira_Inclusion_End_78bdb931-e4c1-4ffc-89f2-8595db9df932); //Make new flags?
DB_Debug_CharacterAddFlags((FLAG)Debug_AddJaheira_52dc4aeb-bb06-46bb-9c6c-ff3d3ef21857, (CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (FLAG)Debug_JaheiraIsPlayer_0b906e26-cee7-4505-b246-edf95bda67e4);
DB_Debug_CharacterRemoveHideFlags((FLAG)Debug_RemoveHideJaheira_d47267d6-86a4-4b2d-92fb-3a8e0b89ee2f, (CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_Dialogs(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, (DIALOGRESOURCE)Jaheira_InParty_e97481ba-961c-50a7-c54f-d34d6b75044d);
SetHasDialog(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 1);
DB_BUGFIX_Marker("GUS-298176");
DB_BUGFIX_Marker("GUS-298494");
DB_BUGFIX_Marker("GUS-298385");

PROC
PROC_GLO_Bugfix_Jahira_ReviveAndSetupFamily()
AND
GetHostCharacter(_Avatar)
AND
DB_Avatars(_Avatar)
AND
QRY_OnlyOnce("GLO_Jaheira_FindingAvatar")
THEN
PROC_DebugBook_RecruitCompanion(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Avatar);
PROC_DismissToCamp(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_GlobalFlag(GLO_Jaheira_Knows_HarpersAtDanthelon_3d66ab2d-7997-3a14-8fcc-9291a8802c5c)
AND
DB_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_LevelLoadedOnce("CTY_MAIN_A")
THEN
PROC_AppearOutOfSightTo((CHARACTER)S_LOW_JaheirasHouse_YoungestDaughter_26cf6556-8d9a-4d10-b2af-3b1d497cc115, S_LOW_JaheirasHouse_FigTrigger_c24252d6-d7fc-4411-8715-325482d928b3, S_LOW_JaheiraYoungestDaughterDisperseTrigger_1add9ee3-4ab2-4141-8cf8-70d8cf0e8efd ,"LOW_JaheirasHouse_FamilyReturn");
PROC_AppearOutOfSightTo((CHARACTER)S_LOW_JaheirasHouse_MiddleDaughter_3c83f569-7b33-43aa-bdb0-4dd9dfb5709b, S_LOW_JaheirasHouse_FigTrigger_c24252d6-d7fc-4411-8715-325482d928b3, S_LOW_JaheiraYoungestDaughterDisperseTrigger_87304e75-8462-47da-8341-1f6c0ef3ed08 ,"LOW_JaheirasHouse_FamilyReturn");
PROC_AppearOutOfSightTo((CHARACTER)S_LOW_JaheirasHouse_YoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c, S_LOW_JaheirasHouse_FigTrigger_c24252d6-d7fc-4411-8715-325482d928b3, S_LOW_JaheiraYoungestSonDisperseTrigger_77142563-520d-41ed-bfb1-b3dbf188e61f,"LOW_JaheirasHouse_FamilyReturn");
PROC_AppearOutOfSightTo((CHARACTER)S_LOW_JaheirasHouse_PostmasterBadger_4655b52d-4a43-4ddb-bb9b-7e18e47cb5d9, S_LOW_JaheiraGroveTrigger_2b289981-680a-4e3a-9e0c-23fa4f03642c, Expl_JaheiraBasement_702db029-ba16-4cff-aa08-4b7dc724d920,"LOW_JaheirasHouse_FamilyReturn");
PROC_AppearOutOfSightTo((CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestDaughter_8f5ab254-2d62-4115-a4d4-3b84e6d1896c, S_LOW_JaheirasHouse_FigTrigger_c24252d6-d7fc-4411-8715-325482d928b3, S_LOW_JaheiraEldestDaughterDisperseTrigger_e7f012be-87f6-465e-bb1c-77af312d8212, "LOW_JaheirasHouse_FamilyReturn");
PROC_AppearOutOfSightTo((CHARACTER)S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, S_LOW_JaheirasHouse_FigTrigger_c24252d6-d7fc-4411-8715-325482d928b3, S_LOW_JaheiraEldestSonDisperseTrigger_3b6dff28-e081-4447-9ea9-3e874af50afa, "LOW_JaheirasHouse_FamilyReturn");
DB_BUGFIX_Marker("GUS-298176");
DB_BUGFIX_Marker("GUS-298494");
DB_BUGFIX_Marker("GUS-298385");

//END_REGION

//REGION GUS-298426

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
THEN
DB_BUGFIX_Marker("GUS-298426");
DB_LOW_CazadorsPalace_RitualRoom_PostCombatAdditionalSpeakers((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_001_062ff971-d709-4f54-bb03-51c02844eacb);
DB_LOW_CazadorsPalace_RitualRoom_PostCombatAdditionalSpeakers((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_002_a612de01-a750-491a-bacd-e09a67fc0de3);
DB_LOW_CazadorsPalace_RitualRoom_PostCombatAdditionalSpeakers((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf);
DB_LOW_CazadorsPalace_RitualRoom_PostCombatAdditionalSpeakers((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_004_a4dc8e21-833c-4469-a72b-1969c688b8a4);
PROC_GLO_Bugfix_298426_RemoveCombatADs();

PROC
PROC_GLO_Bugfix_298426_RemoveCombatADs()
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _, _)
AND
DB_PermaDefeated(_Spawn)
THEN
NOT DB_CombatReact_AD_StatusRemoved(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, LOW_CazadorsPalace_RitualRoom_AD_BuffRemoved_001_Combat_ee4a186e-2009-f47a-be12-cfd4462a4219, "LOW_CAZADORSPALACE_SPAWNBUFF_007");
NOT DB_CombatReact_AD_StatusRemoved(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, LOW_CazadorsPalace_RitualRoom_AD_BuffRemoved_002_Combat_2c442107-0d6c-1133-344e-f8fb1e304d00, "LOW_CAZADORSPALACE_SPAWNBUFF_006");
//END_REGION

//REGION GUS-298699
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
THEN
DB_BUGFIX_Marker("GUS-298699");
NOT DB_LOW_GurFollowUp_GurFamilyInSewers((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_001_1fe747aa-f154-4507-b678-d51b3fffd20c,
	(TRIGGER)S_LOW_GurFollowUp_Undercity_Child_001_Pos_22f96fc4-dee8-40e8-90fe-02f29a456ab1,
	(TRIGGER)S_LOW_GurFollowUp_Sewers_KidsAppearPosition_f1d71ad7-f402-4797-a9b8-76f70baa5066,
	(DIALOGRESOURCE)LOW_GurFollowUp_Spawn_001_2e58197c-5b69-0e3c-efee-02a1f3197cf7);
NOT DB_LOW_GurFollowUp_GurFamilyInSewers((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_002_5086decf-b8f4-420d-84e0-487338a90f20,
	(TRIGGER)S_LOW_GurFollowUp_Undercity_Child_002_Pos_0c44a152-10d6-4626-9b47-9d5e2e7222c0,
	(TRIGGER)S_LOW_GurFollowUp_Sewers_KidsAppearPosition_f1d71ad7-f402-4797-a9b8-76f70baa5066,
	(DIALOGRESOURCE)LOW_GurFollowUp_Spawn_002_fef94050-4072-29db-3ab8-07e4abc59eed);
DB_LOW_GurFollowUp_GurFamilyInSewers((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_001_1fe747aa-f154-4507-b678-d51b3fffd20c,
	(TRIGGER)S_LOW_GurFollowUp_Undercity_Child_001_Pos_22f96fc4-dee8-40e8-90fe-02f29a456ab1,
	(TRIGGER)S_LOW_GurFollowUp_Sewers_KidsAppearPosition_f1d71ad7-f402-4797-a9b8-76f70baa5066,
	(DIALOGRESOURCE)LOW_GurFollowUp_Spawn_002_fef94050-4072-29db-3ab8-07e4abc59eed);
DB_LOW_GurFollowUp_GurFamilyInSewers((CHARACTER)S_LOW_CazadorsPalace_Cells_Child_002_5086decf-b8f4-420d-84e0-487338a90f20,
	(TRIGGER)S_LOW_GurFollowUp_Undercity_Child_002_Pos_0c44a152-10d6-4626-9b47-9d5e2e7222c0,
	(TRIGGER)S_LOW_GurFollowUp_Sewers_KidsAppearPosition_f1d71ad7-f402-4797-a9b8-76f70baa5066,
	(DIALOGRESOURCE)LOW_GurFollowUp_Spawn_001_2e58197c-5b69-0e3c-efee-02a1f3197cf7);
PROC_GLO_Bugfix_298699_ReplaceActiveDialogs();

PROC
PROC_GLO_Bugfix_298699_ReplaceActiveDialogs()
AND
DB_GlobalFlag((FLAG)LOW_GurFollowUp_State_GurHunterInSewers_d221bb1e-db32-40c5-8eb0-07714a272a1e)
AND
DB_LOW_GurFollowUp_GurFamilyInSewers(_NPC, _StandingPos, _, _Dialog)
AND
_NPC != S_GLO_GurHunter_0e47fcb9-c0c4-4b0c-902b-2d13d209e760
THEN
PROC_RemoveDialog(_NPC);
DB_Dialogs(_NPC, _Dialog);
//END_REGION

//REGION GUS-298702
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575) // Combat with Orin has not ended yet. If its already ended then there's nothing to do here.
AND
DB_Players(_Player)
AND
DB_Is_InCombat(_Player, _CombatID) // check if players are still in combat.
AND
QRY_GLO_Bugfix_298702_CheckOrinCombatID(_CombatID) // get Orin's combatID if she is/was in combat with players. 'Was' because she could be dead but skeletons still alive.
AND
DB_Is_InCombat(_SkeletonSpawn, _CombatID) // check if any of Orin's Skeleton spawn is in the same combat
AND
GetTemplate(_SkeletonSpawn, Undead_Skeleton_Blood_46056850-5aa7-461b-a49e-6599b9c286f9) // make sure its the skeleton spawn from her spell.
AND
NOT DB_GLO_DefeatCounter(_SkeletonSpawn, "LOW_BhaalTemple_CombatWin_Counter") // check if they are not in the defeat counter.
THEN
DB_BUGFIX_Marker("GUS-298702");
DB_GLO_DefeatCounter(_SkeletonSpawn, "LOW_BhaalTemple_CombatWin_Counter"); // add them in defeat counter.

QRY
QRY_GLO_Bugfix_298702_CheckOrinCombatID((GUIDSTRING)_CombatID)
AND
DB_Was_InCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CombatID)
THEN
DB_NOOP(1);

QRY
QRY_GLO_Bugfix_298702_CheckOrinCombatID((GUIDSTRING)_CombatID)
AND
DB_Is_InCombat(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, _CombatID)
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-298172
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
NOT DB_GlobalFlag(LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446)
AND
NOT DB_Defeated(S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16)
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16, "LOW_Elfsong_QueenTraitorScene");
NOT DB_OnlyOnce("LOW_Elfsong_QueenTraitorScene_Spotting");
DB_BUGFIX_Marker("GUS-298172");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
NOT DB_GlobalFlag(LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446)
AND
DB_Defeated(S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_Elfsong_Githyanki_e2c5c1ae-1797-44af-bd68-4071820b7e89, 0);
DB_BUGFIX_Marker("GUS-298172");

//END_REGION GUS-298172

//REGION GUS-281552
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
THEN
DB_DialogBlockTradeButton(LOW_Elfsong_Githyanki_InquisitorInterrogation_b14188e9-1319-367d-83ad-976ffc42c025);
DB_BUGFIX_Marker("GUS-281552");
//END_REGION GUS-281552

//REGION GUS-298758
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_GLO_DieFlag((FLAG)ORI_Shadowheart_State_KilledViconia_472e18f2-15f9-4004-bdae-a9340fff7b15, (CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000)
THEN
NOT DB_GLO_DieFlag((FLAG)ORI_Shadowheart_State_KilledViconia_472e18f2-15f9-4004-bdae-a9340fff7b15, (CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000);
DB_GLO_DieFlag((FLAG)ORI_Shadowheart_Event_KillViconia_551f236d-6e7f-461d-bbf6-94cf0cc4ae88, (CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-298758");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,5,0)
AND
DB_Dead((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_State_KilledViconia_472e18f2-15f9-4004-bdae-a9340fff7b15)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_KilledViconia_472e18f2-15f9-4004-bdae-a9340fff7b15);
//END_REGION GUS-298758

//REGION GUS-298432
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 5, 0)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
PROC_LOW_SorcerousSundries_PlaceRolanJournal();

//END_REGION  GUS-298432


//REGION GUS-298262
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 6, 0)
AND
DB_GlobalFlag((FLAG)LOW_Thrumbo_Event_TeleportJarFromThrumbo_504e5385-96bd-4215-85de-22b81374382c)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "Thrumbo_ThrowUp")
THEN
QuestUpdate("LOW_PhilgravesMansion", "Thrumbo_ThrowUp");

//END_REGION  GUS-298262

//REGION GUS-285440 Tactician addition for Ancient Lair combat

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_COL_AddAncientLairCurseDifficulties(1);

IF
DB_COL_AddAncientLairCurseDifficulties(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_COL_AddAncientLairCurseDifficulties(1);
DB_LOW_PhilgravesMansion_DifficultyLairCurses("LOW_ANCIENTLAIR_CURSE","EASY");
DB_LOW_PhilgravesMansion_DifficultyLairCurses("LOW_ANCIENTLAIR_CURSE","MEDIUM");
DB_LOW_PhilgravesMansion_DifficultyLairCurses("LOW_ANCIENTLAIR_CURSE_HARDCORE","HARD");
DB_BUGFIX_Marker("GUS-285440");

//END_REGION

//REGION GUS-297930
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 5, 0)
AND
DB_ActiveLevel("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)GLO_Gortash_State_WorldKnowsPermaDefeated_5bbc8258-a708-4486-aa3f-8757d9dce533)
THEN
PROC_LOW_HideStuffOnGortashDead();
//END_REGION  GUS-297930
//REGION GUS-299524
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 6, 0)
AND
DB_GiveTemplateFromPlayerDialogEvent(LOOT_GEN_Runepowder_Time_Bomb_A_9a711e91-04d0-4300-8ca8-b4cc07529a56, LOW_SteelWatchFoundry_Event_PlaceBomb_232b5c85-7f53-4c3f-8904-ac3217a1c4c6, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
NOT DB_GiveTemplateFromPlayerDialogEvent(LOOT_GEN_Runepowder_Time_Bomb_A_9a711e91-04d0-4300-8ca8-b4cc07529a56, LOW_SteelWatchFoundry_Event_PlaceBomb_232b5c85-7f53-4c3f-8904-ac3217a1c4c6, NULL_00000000-0000-0000-0000-000000000000, 1);
DB_BUGFIX_Marker("GUS-299524");
//END_REGION  GUS-299524

//REGION GUS-299451
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 6, 0)
AND
DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d)
THEN
DB_BUGFIX_Marker("GUS-299451");
PROC_GLO_Bugfix_299451_RemoveExtraDefaultFaction();

// If Laezel was abducted
PROC
PROC_GLO_Bugfix_299451_RemoveExtraDefaultFaction()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_WasAbductedLaezel_2f0ad86d-e4c7-47f9-bb8b-bb7b8f3ebc40)
THEN
NOT DB_GLO_PartyMembers_DefaultFaction(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, Origin_Laezel_bee8449b-d682-93c8-e7da-9e4bad369476);

// If Gale was abducted
PROC
PROC_GLO_Bugfix_299451_RemoveExtraDefaultFaction()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_WasAbductedGale_74d236e1-eff9-4b73-a6e7-4e6402d5c84c)
THEN
NOT DB_GLO_PartyMembers_DefaultFaction(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Origin_Gale_80064ba1-7440-4e2a-9959-ce5559be5bbb);

// If Halsin was abducted
PROC
PROC_GLO_Bugfix_299451_RemoveExtraDefaultFaction()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_WasAbductedHalsin_0265b4a7-cf01-4543-ac34-2a76da85d674)
THEN
NOT DB_GLO_PartyMembers_DefaultFaction(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323, GLO_Halsin_01ebccd1-8a58-4ca6-9726-c4bb484b85f2);

// If Minthara was abducted
PROC
PROC_GLO_Bugfix_299451_RemoveExtraDefaultFaction()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_WasAbductedMinthara_d1e51161-8462-4333-8676-74b4d0384054)
THEN
NOT DB_GLO_PartyMembers_DefaultFaction(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b, GLO_DrowCommander_f984f683-e819-439e-af7c-48906053c20b);
//END_REGION GUS-299451

//REGION GUS-298123
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 6, 0)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_SetSpottingAndCombatants")
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_Clerk)
THEN
PROC_LOW_SorcerousSundries_SetSpottingAndCombatants(_Clerk);
DB_BUGFIX_Marker("GUS-298123");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 6, 0)
AND
NOT DB_GLO_DefeatCounter(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, "LOW_SorcerousSundries_ShopCombatant")
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
DB_GLO_DefeatCounter(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"LOW_SorcerousSundries_ShopCombatant");
DB_BUGFIX_Marker("GUS-298123");

//END_REGION GUS-298123


//REGION GUS-299959

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_LeftWithoutEntering_9530d1e4-8740-423b-a989-d7912a5de9bc)
AND
NOT DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_State_SubmersibleReadyToDepart_a2ae474a-de65-4fde-b019-b1fdb6306acb)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_BellyOfTheBeast_Beastmaster_df47ddde-7444-42e9-a50f-3371a7b21cb8, 0);
DB_BUGFIX_Marker("GUS-299959");

//END_REGION

//REGION GUS-298999
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
AND
DB_CTY_ForrickConfrontationSetupDone(_Version)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_Event_PactScene_022d6a0a-15fe-09b2-2897-268d9a34a381)
THEN
PROC_ClearOriginMoment(LOW_FlorrickFightFallback_OM_Wyll_dfd8fab6-e0b2-bc4e-903b-f8f639b6244f);
PROC_LOW_FlorrickConfrontation_Cleanup(1);
NOT DB_CTY_ForrickConfrontationSetupDone(_Version);
DB_BUGFIX_Marker("GUS-298999");

//END_REGION GUS-298999

//REGION GUS-299666

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,6,0)
AND
DB_Players(_Character)
AND
IsInTrigger(_Character, S_WYR_Wyrmway_SUB_ac5390a3-ced8-477e-80ee-881b2e8372ef, 1)
THEN
SetFlag((FLAG)WYR_Wyrmway_State_InWyrmway_d4bc7aa7-82ff-5a3e-df31-8153b372839a, _Character, 0);

//END_REGION GUS-299666

//REGION GUS-299961
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
NOT DB_BUGFIX_Marker("GUS-299961")
AND
DB_GlobalFlag((FLAG)LOW_VoloFate_State_VoloArrivedInBG_5faacb8c-836d-4626-bb7d-418c643e494d)
AND
DB_SceneManager((CHARACTER)S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa, "GOB_VoloScene")
THEN
DB_BUGFIX_Marker("GUS-299961");
PROC_SceneOver("GOB_VoloScene");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_GlobalFlag((FLAG)LOW_VoloFate_State_VoloArrivedInBG_5faacb8c-836d-4626-bb7d-418c643e494d)
AND
SysIsActive("Act1_GOB_VoloBallad")
THEN
SysCompleteGoal("Act1_GOB_VoloBallad");
//END_REGION GUS-299961

//REGION GUS-299825

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_LOW_SharGrotto_ConfrontationParticipants(_, _Char)
AND
DB_PermaDefeated(_Char)
THEN
DB_BUGFIX_Marker("GUS-299825");
PROC_ClearCorpseOwner(_Char);

//END_REGION GUS-299825

//REGION GUS-293287
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,7,0)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal")
THEN
PROC_RemoveDialog(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
DB_BUGFIX_Marker("GUS-293287");
//END_REGION GUS-293287

//REGION GUS-299160
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
AND
QRY_LOW_SerialKiller_AlreadyDeadVictimSaw()
THEN
SetFlag(LOW_SerialKiller_State_SawDolorVictim_8ae5dc4c-4728-4f42-884a-791095955c92);
DB_BUGFIX_Marker("GUS-299160");

QRY
QRY_LOW_SerialKiller_AlreadyDeadVictimSaw()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "Stopmurders_FailFranc")
THEN
DB_NOOP(1);

QRY
QRY_LOW_SerialKiller_AlreadyDeadVictimSaw()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "Stopmurders_FailAlexander")
THEN
DB_NOOP(1);

//END_REGION GUS-299160

//REGION GUS-300065
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
THEN
NOT DB_Subregion((TRIGGER)S_LOW_CountingHouse_HeistDialogTrigger_feec2762-07b3-42c8-ae7f-57df907e74c0, "LOW_CountingHouse_Vaults_HighSecurity_SUB", 0, 1);
DB_Subregion((TRIGGER)S_LOW_CountingHouse_HighSecurityVault_SUB_6f7dfc3a-d7a0-49a6-b39a-1475c82cf263, "LOW_CountingHouse_Vaults_HighSecurity_SUB", 0, 1);
DB_BUGFIX_Marker("GUS-300065");
//END_REGION GUS-300065

//REGION GUS-300304

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
THEN
DB_LOW_HouseOfHope_ShouldUpdatePrisonMarker(1);
DB_BUGFIX_Marker("GUS-300304");

//END_REGION

//REGION GUS-300205
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
AND
IsInInventory(S_LOW_DevilsFee_InfernalScroll_d642189f-fa64-4538-8055-9578489140e8, 0)
THEN
SetOnStage(S_LOW_DevilsFee_InfernalScroll_d642189f-fa64-4538-8055-9578489140e8, 0);
DB_BUGFIX_Marker("GUS-300205");
//END_REGION GUS-300205

//REGION GUS-300282
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
AND
DB_CampNight_CancelledBy((FLAG)NIGHT_Shadowheart_NightfallRitual_8f1697d4-2402-4283-802a-ef7e1ebd8aa1, (FLAG)SHA_NightsongPrison_State_TriedToConvinceToSpare_040e2c72-5ff1-4e59-b43a-003c982aadd1)
THEN
NOT DB_CampNight_CancelledBy((FLAG)NIGHT_Shadowheart_NightfallRitual_8f1697d4-2402-4283-802a-ef7e1ebd8aa1, (FLAG)SHA_NightsongPrison_State_TriedToConvinceToSpare_040e2c72-5ff1-4e59-b43a-003c982aadd1);
DB_BUGFIX_Marker("GUS-300282");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,8,0)
AND
NOT DB_GlobalFlag((FLAG)NIGHT_Shadowheart_SharRomance_692ba0b6-e88d-4215-bbf9-6d89c141d1ad)
AND
DB_GlobalFlag((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9)
THEN
DB_CampNight_CancelledBy((FLAG)NIGHT_Shadowheart_SharRomance_692ba0b6-e88d-4215-bbf9-6d89c141d1ad, (FLAG)ORI_Shadowheart_State_ConcludedGrotto_438098b7-3b50-48d6-ac53-6960b2849e10);
DB_BUGFIX_Marker("GUS-300282");
//END_REGION GUS-300282

//REGION GUS-298516
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 8, 0)
THEN
DB_DiggableSecretMapMarker("LOW_DiggableSecret_Sewers_KoboldTreasure", (FLAG)LOW_DiggableSecret_Sewers_KoboldTreasure_Show_e830a9dd-cf31-4d82-b227-025ea40b9e28, (FLAG)LOW_DiggableSecret_Sewers_KoboldTreasure_Hide_14f70d88-caf2-4996-a6be-71fbc7102d78, NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_SetFlagOnReadDocument((ITEM)UNI_LOW_SewersKoboldMap_000_5cfb8a8e-aefd-405d-9a21-930bf500fed6, (FLAG)LOW_DiggableSecret_Sewers_KoboldTreasure_Show_e830a9dd-cf31-4d82-b227-025ea40b9e28);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 8, 0)
AND
NOT DB_DiggableSecretMapMarker_Custom_LOW_Sewers(_, 1) //player hasn't touched a single mound there -> free to blindly reinit the DB
THEN
DB_DiggableSecretMapMarker_Custom_LOW_Sewers((ITEM)S_LOW_SewersDiggingSpot_000_6043fd58-0abc-4aee-875c-a7a654a07d95, 0);
DB_DiggableSecretMapMarker_Custom_LOW_Sewers((ITEM)S_LOW_SewersDiggingSpot_002_cd0d42e1-fd73-4c2f-8847-9da73b0619fa, 0);
DB_DiggableSecretMapMarker_Custom_LOW_Sewers((ITEM)S_LOW_SewersDiggingSpot_003_9db1056c-1b2a-4420-b3ce-b785820d446f, 0);
DB_DiggableSecretMapMarker_Custom_LOW_Sewers((ITEM)S_LOW_SewersDiggingSpot_006_e720bd63-44bc-4d9c-ac62-c453c036b838, 0);
DB_DiggableSecretMapMarker_Custom_LOW_Sewers((ITEM)S_LOW_SewersKoboldTreasureSpot_dbd643b3-9bc6-488d-92be-8c19aef07f09, 0);
//END_REGION GUS-298516


//REGION GUS-296599
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 8, 0)
AND
NOT DB_LOW_Park_CiviliansSpreeTargets(_, _)
THEN
DB_LOW_Park_CiviliansSpreeTargets((CHARACTER)S_LOW_Park_RetiredFist_Dwarf01_a94d18f7-23ec-4f4b-868a-d6feaf9beaae, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_RetiredFist_Dwarf02_669e3ab9-acc1-4fe2-814a-4d21e901cf86, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_LoversFemale_bf8d1fd2-53ea-4df4-9924-5136a4345ef3, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_LoversMale_cc2aca46-3a9a-4637-98a4-dc812b71ff6d, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_RetiredFist_Elf01_08d2d3a7-6d87-40e7-8649-750e9857dd3c, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_RetiredFist_Elf02_d7cd0aa5-7303-45c7-a9e2-fac6a458f63e, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_FanclubMember01_32c18a38-6f75-4e72-8072-409dae627929, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_FanclubMember02_c11362d2-c6dd-48e7-87a1-775562ede7f1, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_FanclubMember03_b91ad1bf-f323-4378-bc47-3492efbd10ae, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_ElderlyCouple01_a7270d7b-7fc1-4205-a7be-5bef768705fd, 0);
DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_ElderlyCouple02_68da1638-59be-4cdd-8df6-93df9f08df82, 0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan(4, 0, 8, 0)
THEN
DB_LOW_Park_FixGUS296599(1);

IF
DB_LOW_Park_FixGUS296599(1)
AND
DB_ActiveLevel("CTY_Main_A")
THEN
NOT DB_LOW_Park_FixGUS296599(1);
PROC_LOW_Park_FixGUS296599();

PROC
PROC_LOW_Park_FixGUS296599()
AND
DB_LOW_Park_CiviliansSpreeTargets(_Char, _)
AND
DB_PermaDefeated(_Char)
THEN
NOT DB_LOW_Park_CiviliansSpreeTargets(_Char, 0);
DB_LOW_Park_CiviliansSpreeTargets(_Char, 1);

PROC
PROC_LOW_Park_FixGUS296599()
AND
DB_LOW_Park_CiviliansSpreeTargets(_Char, _)
AND
IsOnStage(_Char, 0)
THEN
NOT DB_LOW_Park_CiviliansSpreeTargets((CHARACTER)_Char, 0);
DB_LOW_Park_CiviliansSpreeTargets((CHARACTER)_Char, 1);


PROC
PROC_LOW_Park_FixGUS296599()
THEN
PROC_LOW_Park_EvaluateCultistTargets();
//END_REGION GUS-296599

//REGION GUS-300199
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
THEN
SetOnStage(S_LOW_Elfsong_CrowdDrinkers_F_002_10baea80-e979-4586-891a-9712903bc3b8, 0);


//END_REGION GUS-300199

//REGION GUS-300690

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
THEN
DB_TopicalGreeting((FLAG)TG_LOW_Mystra_COM_AgreedReturnCrown_466e3236-1707-48d3-a550-c5e07ec70dc4);
DB_TopicalGreeting((FLAG)TG_LOW_Mystra_COM_NonCommitToReturnCrown_4f21f8ac-4493-4b31-98bd-604b302578d7);
DB_TopicalGreeting((FLAG)TG_LOW_Mystra_COM_RefuseReturnCrown_6bdf5fdf-7c18-4d72-b839-db3aa7859a83);

//END_REGION

//REGION GUS-300406
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
DB_OffStage(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoWalkedOff_3ac36df2-ef73-4fa4-8800-0f694388073a)
THEN
PROC_SetOnStage(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, 1);
DB_BUGFIX_Marker("GUS-300406");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
DB_LOW_SteelWatchFoundry_DisappearAfterLongRest(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_FundangoWalkedOff_3ac36df2-ef73-4fa4-8800-0f694388073a)
THEN
NOT DB_LOW_SteelWatchFoundry_DisappearAfterLongRest(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);
DB_BUGFIX_Marker("GUS-300406");
//END_REGION GUS-300406

//REGION GUS-300074
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
THEN
DB_SaveGamePatch_GUS300074(1);

IF
DB_SaveGamePatch_GUS300074(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_SaveGamePatch_GUS300074(1);
PROC_SaveGamePatch_GUS300074();

PROC
PROC_SaveGamePatch_GUS300074()
THEN
PROC_TriggerRegisterForParty(S_LOW_MinscHideout_MeetingSceneDialogTrigger_AddChars_fb8bb0b2-af42-4029-98d0-5fb2e195e086);
DB_BUGFIX_Marker("GUS-300074");

PROC
PROC_SaveGamePatch_GUS300074()
AND
DB_SceneTriggerManager("LOW_MinscHideout_ZhentBribe", _, _)
AND
DB_GlobalFlag((FLAG)LOW_MinscHideout_State_ZhentLeaderEscaping_4333a451-024f-4c41-aea1-7046afdf0b4a)
THEN
PROC_SceneOver("LOW_MinscHideout_ZhentBribe");
PROC_SaveGamePatch_GUS300074_ResetMinscDialog();

PROC
PROC_SaveGamePatch_GUS300074_ResetMinscDialog()
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
QRY_OnlyOnce("PROC_SaveGamePatch_GUS300074_ResetMinscDialog")
THEN
DB_Dialogs(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)Minsc_InParty_d0554ced-ca60-938b-362c-07b0c77610d7);

PROC
PROC_SaveGamePatch_GUS300074_ResetMinscDialog()
AND
DB_GlobalFlag((FLAG)ORI_Minsc_State_ReunitedWithBoo_491635de-7395-5fe4-f8ce-be3288707a80)
AND
QRY_OnlyOnce("PROC_SaveGamePatch_GUS300074_ResetMinscDialog")
THEN
DB_Dialogs(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)Minsc_Recruitment_630440f5-b71a-8764-94e8-b62544254cff);

PROC
PROC_SaveGamePatch_GUS300074_ResetMinscDialog()
AND
NOT DB_GlobalFlag((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20)
AND
NOT DB_GlobalFlag((FLAG)ORI_Minsc_State_NotSavedFromAbsolute_c8fdabdd-a9fa-4dbb-b693-9c7b12e1f56b)
AND
DB_KnockedOut((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
QRY_OnlyOnce("PROC_SaveGamePatch_GUS300074_ResetMinscDialog")
THEN
DB_Dialogs(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, (DIALOGRESOURCE)LOW_Minsc_SaveFromAbsolute_eeb5d970-975f-5f16-80ba-4aa54cb65702);

PROC
PROC_SaveGamePatch_GUS300074()
AND
IsOnStage(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, 1)
AND
NOT DB_PermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_SetOnStage(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, 0);
//END_REGION GUS-300074

//REGION GUS-299878
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b);
DB_BUGFIX_Marker("GUS-299878");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
DB_GlobalFlag((FLAG)LOW_Rolan_State_RolanInChargeOfShop_d76ad357-97d9-49cc-bdb5-620e9a8242a5)
AND
IsTagged(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)ACT3_LOW_SORCEROUSSUNDRIES_VENDOR_9f66044c-876d-48cb-94c4-5b8c7a5f5d9e,1)
THEN
PROC_SetCustomTradeTreasure(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"Empty");
ClearTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)ACT3_LOW_SORCEROUSSUNDRIES_VENDOR_9f66044c-876d-48cb-94c4-5b8c7a5f5d9e);
ClearTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b);
DB_BUGFIX_Marker("GUS-299878");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1)
AND
NOT DB_LOW_SorcerousSundries_StartedConfrontation(1)
AND
GetRelation((FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,0)
AND
GetRelation((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0)
THEN
DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1);
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
DB_BUGFIX_Marker("GUS-299878");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1)
AND
NOT DB_LOW_SorcerousSundries_StartedConfrontation(1)
AND
GetRelation((FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,0)
THEN
DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1);
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
SetFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425);
PROC_LOW_SorcerousSundries_SetNightsongEnemy();
DB_BUGFIX_Marker("GUS-299878");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1)
AND
NOT DB_LOW_SorcerousSundries_StartedConfrontation(1)
AND
GetRelation((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0)
THEN
DB_LOW_SorcerousSundries_FinalConfrontationCanceled(1);
PROC_SetRelationMutual((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e, (FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
SetFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b);
PROC_LOW_SorcerousSundries_SetLorroakanEnemy();
DB_BUGFIX_Marker("GUS-299878");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
HasAppliedStatus((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec, "PUZ_CASTEDPORTAL_BLUE",0)
AND
GetCanInteract((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec,1)
THEN
SetCanInteract((ITEM)S_LOW_PortalToShop_46d33205-1dc4-43a8-8153-3bb95bc1e3ec,0);
DB_BUGFIX_Marker("GUS-299878");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
HasAppliedStatus((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5, "PUZ_CASTEDPORTAL_BLUE",0)
AND
GetCanInteract((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,1)
THEN
SetCanInteract((ITEM)S_LOW_PortalToRamazith_74a258c4-774f-49d2-a673-1389bca439b5,0);
DB_BUGFIX_Marker("GUS-299878");

//END_REGION GUS-299878

//REGION GUS-300036
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar()
THEN
DB_BUGFIX_Marker("GUS-300036");
TriggerRegisterForCharacter((TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355, (CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10);
PROC_GLO_Bugfix_300036_RestoreButler();

PROC
PROC_GLO_Bugfix_300036_RestoreButler()
AND
DB_Players(_Player)
AND
DB_InRegion((CHARACTER)_Player, (TRIGGER)S_LOW_BhaalTemple_OrinButler_WaitAtDoor_d76f46a2-e44a-49e4-a062-b8c865fff355)
AND
QRY_OnlyOnce("Bugfix_300036_RestoreButler")
THEN
SetDetached(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, 0);
//END_REGION

//REGION GUS-300836

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
NOT DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_SorcerousSundries_RamazithOwnershipTrigger_af5a1002-68b2-4b3e-8399-e077af9f1dd5, (CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
THEN
DB_ItemOwnerShipTriggers("CTY_Main_A",(TRIGGER)S_LOW_SorcerousSundries_RamazithOwnershipTrigger_af5a1002-68b2-4b3e-8399-e077af9f1dd5, (CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9);

//END_REGION

//REGION GUS-298264
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,9,0)
AND
DB_LOW_PhilgravesMansion_GoingInsideHouse((CHARACTER)_Zombie)
THEN
TriggerRegisterForCharacter((TRIGGER)S_LOW_PhilgravesMansion_MainHallTrigger_97b50e48-fc3e-435c-a3ba-2745eb733f2e,_Zombie);
DB_BUGFIX_Marker("GUS-298264");

//END_REGION

//REGION GUS-300981
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_GlobalFlag(LOW_MinscHideout_BooSittingAtMinscCorpse_f0a36d0c-70cb-4987-9332-36e5989d3327)
THEN
DB_AD_Dialog(S_GLO_Boo_d49e3b49-a089-4465-b453-28dc79e82bb3, LOW_MinscHideout_AD_MinscDied_BooAngry_15c5dcd7-c7e4-8987-815e-deb168d149c5);
DB_BUGFIX_Marker("GUS-300981");
//END_REGION

//REGION GUS-300479
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_BonecloakApothecary_State_BaelenDidntReachBG_0f67d8bd-7395-42bb-a55d-cadecd4ba489)
AND
NOT DB_GlobalFlag((FLAG)UND_MushroomHunter_State_Saved_cd1f8012-322b-4135-bb40-54580bf5cea1)
AND
NOT DB_LOW_Bonecloak_ShopIsAbandoned(1)
AND
NOT DB_BUGFIX_Marker("GUS-300479")
THEN
DB_BUGFIX_Marker("GUS-300479");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BonecloakApothecary_State_BaelenDidntReachBG_0f67d8bd-7395-42bb-a55d-cadecd4ba489);
//END_REGION

//REGION GUS-298202
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_LOW_SorcerousSundries_GaleQuestUpdates("FindBook2_Accidental")
THEN
NOT DB_LOW_SorcerousSundries_GaleQuestUpdates("FindBook2_Accidental");
NOT DB_LOW_SorcerousSundries_GaleQuestUpdates("NoTolna");
NOT DB_LOW_SorcerousSundries_GaleQuestUpdates("FindBook");
DB_BUGFIX_Marker("GUS-298202");
//END_REGION

//REGION GUS-301013
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_HouseOfGrief_GriefAttendant_31abb867-fe83-02ea-ccac-5367b2749027, 1000)
THEN
NOT DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_HouseOfGrief_GriefAttendant_31abb867-fe83-02ea-ccac-5367b2749027, 1000);
DB_DialogMoneyTransfer(1, (DIALOGRESOURCE)LOW_HouseOfGrief_GriefAttendant_31abb867-fe83-02ea-ccac-5367b2749027, 1000, 2);
DB_BUGFIX_Marker("GUS-301013");
//END_REGION GUS-301013

//REGION GUS-300963
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,10,0)
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
DB_GlobalFlag((FLAG)WYR_SmugglersCave_State_SmugglersDefeated_d6acc249-bd57-4076-ad5f-954c5eaad5c7)
AND
DB_GlobalFlag((FLAG)WYR_SmugglersCave_State_SmugglersWon_f82671e3-a381-49eb-bc02-d5fa27468428)
AND
NOT DB_BUGFIX_Marker("GUS-300963")
THEN
DB_BUGFIX_Marker("GUS-300963");
PROC_GlobalClearFlagAndCache((FLAG)WYR_SmugglersCave_State_SmugglersWon_f82671e3-a381-49eb-bc02-d5fa27468428);
//END_REGION

//REGION GUS-300763
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,11,0)
THEN
DB_BUGFIX_Marker("GUS-300763");
PROC_GLO_Bugfix_300763_UpdateTG();

PROC
PROC_GLO_Bugfix_300763_UpdateTG()
AND
DB_TopicalGreetingStartCondition_FlagSet((FLAG)TG_LOW_Orin_Killed_6aa79a7d-e0b8-407b-8528-3dc3d8d95221, (FLAG)GLO_Orin_State_PermaDefeated_c716e4d9-e6ed-445c-a710-ee4d91c67298)
THEN
NOT DB_TopicalGreetingStartCondition_FlagSet((FLAG)TG_LOW_Orin_Killed_6aa79a7d-e0b8-407b-8528-3dc3d8d95221, (FLAG)GLO_Orin_State_PermaDefeated_c716e4d9-e6ed-445c-a710-ee4d91c67298);

PROC
PROC_GLO_Bugfix_300763_UpdateTG()
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
NOT DB_TopicalGreetingStartCondition_FlagSet((FLAG)TG_WYR_Gortash_WarnedImpostor_fdb6ca98-8bb0-4196-bf6d-945526e56114, (FLAG)WYR_KillDirectorGortash_Knows_CampCompromised_62f279b8-9f36-4f4a-92d3-edc16cb4d760);
DB_TopicalGreetingStartCondition_FlagSet((FLAG)TG_DarkUrge_GortashOM_e7309f8a-f378-4cfb-8d55-4c5798acb443, (FLAG)ORI_DarkUrge_Event_GortashToldChosen_95308bd0-8327-4267-b18d-eb5d9e270059);
//END_REGION


//REGION GUS-293069
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,12,0)
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
NOT DB_GLO_DefeatCounter(S_LOW_Park_RetiredFist_Dwarf01_a94d18f7-23ec-4f4b-868a-d6feaf9beaae, "LOW_Park_CivilianMurders");
NOT DB_GLO_DefeatCounter(S_LOW_Park_RetiredFist_Dwarf02_669e3ab9-acc1-4fe2-814a-4d21e901cf86, "LOW_Park_CivilianMurders");
NOT DB_GLO_DefeatCounter(S_LOW_Park_RetiredFist_Elf01_08d2d3a7-6d87-40e7-8649-750e9857dd3c, "LOW_Park_CivilianMurders");
NOT DB_GLO_DefeatCounter(S_LOW_Park_RetiredFist_Elf02_d7cd0aa5-7303-45c7-a9e2-fac6a458f63e, "LOW_Park_CivilianMurders");
NOT DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_RetiredFist_Dwarf01_a94d18f7-23ec-4f4b-868a-d6feaf9beaae, 0);
NOT DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_RetiredFist_Dwarf02_669e3ab9-acc1-4fe2-814a-4d21e901cf86, 0);
NOT DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_RetiredFist_Elf01_08d2d3a7-6d87-40e7-8649-750e9857dd3c, 0);
NOT DB_LOW_Park_CiviliansSpreeTargets(S_LOW_Park_RetiredFist_Elf02_d7cd0aa5-7303-45c7-a9e2-fac6a458f63e, 0);
DB_BUGFIX_Marker("GUS-293069");
//END_REGION

//REGION GUS-303092
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_SaveGamePatches_GUS303092(1);

IF
DB_SaveGamePatches_GUS303092(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_SaveGamePatches_GUS303092(1);
ToInventory(S_LOW_ToobinFormulas_22ed4668-af60-48c9-bbf9-61d6c23ea5a0 ,S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, 1, 0, 1);
ToInventory(S_LOW_GondLoreBook_e3cbc4d4-80cc-49a1-bd9e-f0044d268e55, BOOK_GEN_Row_Multiple_Tileset_B_000_217ceab0-c32a-442f-8c9c-78a71011684a, 1, 0, 1);
DB_BUGFIX_Marker("GUS-303092");
//END_REGION GUS-303092

//REGION GUS-301443
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_GlobalFlag(LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446)
AND
NOT DB_Defeated(S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16)
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16, "LOW_Elfsong_QueenTraitorScene");
NOT DB_OnlyOnce("LOW_Elfsong_QueenTraitorScene_Spotting");
DB_BUGFIX_Marker("GUS-301443");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_GlobalFlag(LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446)
AND
DB_Defeated(S_LOW_Elfsong_Basement_Inquisitor_54467aa9-33dd-41c4-bd77-87a71ed22c16)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_Elfsong_Githyanki_e2c5c1ae-1797-44af-bd68-4071820b7e89, 0);
DB_BUGFIX_Marker("GUS-301443");
//END_REGION GUS-301443

//REGION GUS-301687
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
AND
DB_GlobalFlag((FLAG)ORI_Minsc_State_PartneredWithNineFingers_ff63b939-82d3-c670-ad59-c7cf6363d234)
THEN
SetFlag((FLAG)LOW_Guildhall_State_NinefingersWillHelpEND_bdab2f3d-d878-4367-9519-c52117dcf915);
DB_BUGFIX_Marker("GUS-301687");
//END_REGION

//REGION GUS-301733
//For those that haven't talked to Toobin yet, you should get an update to "Get Gortash's Netherestone" quest when you do
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_AgreedToHelpGondians_5acaf88a-ea7d-3e0d-ef62-c33e8b4203d1, "WYR_GetGortashGem", "MetGondianLeader")
THEN
NOT DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_AgreedToHelpGondians_5acaf88a-ea7d-3e0d-ef62-c33e8b4203d1, "WYR_GetGortashGem", "MetGondianLeader");
DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_Hasmet_FundangoToobin_94af332f-8038-48bf-8998-70028a73a887, "WYR_GetGortashGem", "MetGondianLeader");
DB_BUGFIX_Marker("GUS-301733");

//For those that have already talked to him, unlock the update to "Get Gortash's Netherestone" quest
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_Hasmet_FundangoToobin_94af332f-8038-48bf-8998-70028a73a887)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "WYR_GetGortashGem", "MetGondianLeader");
//END_REGION GUS-301733

//REGION GUS-301897
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
THEN
DB_ApplySavegamePatches_UpdateOffstageGondianFaction(1);
DB_BUGFIX_Marker("GUS-301897");

IF
DB_ApplySavegamePatches_UpdateOffstageGondianFaction(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
SetFaction(S_LOW_GondianWorker_PostIRN01_a4eb6135-5656-430f-b5f6-a217feb6eb0d, (FACTION)ACT3_LOW_SteelWatchFoundry_Gondians_98cec50e-60d9-4b18-a1f3-88e8b425d682);
SetFaction(S_LOW_GondianWorker_PostIRN02_b264c860-f30a-45a8-b35d-9f03a0d393b1, (FACTION)ACT3_LOW_SteelWatchFoundry_Gondians_98cec50e-60d9-4b18-a1f3-88e8b425d682);
//END_REGION GUS-301897

//REGION GUS-301702
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,13,0)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "LOW_RecoverRakathsGold", "ReturnedGold_RetrievedStolen", 1)
THEN
QuestClose("LOW_RecoverRakathsGold");
DB_BUGFIX_Marker("GUS-301702");
//END_REGION

//REGION GUS-301586
//For patch 2: to fix if players apply the patch on IRN or BGO
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_DevilsFee_Portals(_Portal, _, _)
AND
NOT DB_OffStage(_Portal)
AND
HasAppliedStatus(_Portal, "LOW_DEVILSFEE_PORTAL_HOUSEOFHOPE", 0)
THEN
ApplyStatus((ITEM)_Portal, "LOW_DEVILSFEE_PORTAL_HOUSEOFHOPE", -1.0);//Apply the visual state if the savegame has the bug that the portal is active but the VFX is not applied.
DB_BUGFIX_Marker("GUS-301586-2");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_DevilsFee_GUS301586(1);
DB_BUGFIX_Marker("GUS-301586-2");

IF
LevelLoaded("CTY_Main_A")
AND
DB_LOW_DevilsFee_GUS301586(1)
THEN
NOT DB_LOW_DevilsFee_GUS301586(1);
PROC_LOW_DevilsFee_PatchPortalStatus();

PROC
PROC_LOW_DevilsFee_PatchPortalStatus()
AND
DB_LOW_DevilsFee_Portals(_Portal, _, _)
AND
NOT DB_OffStage(_Portal)
AND
HasAppliedStatus(_Portal, "LOW_DEVILSFEE_PORTAL_HOUSEOFHOPE", 0)
THEN
ApplyStatus((ITEM)_Portal, "LOW_DEVILSFEE_PORTAL_HOUSEOFHOPE", -1.0);//Apply the visual state if the savegame has the bug that the portal is active but the VFX is not applied.

//END_REGION GUS-301586

//REGION GUS-301940
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_DialogMoneyTransfer(_ID, (DIALOGRESOURCE)LOW_OskarsBeloved_OskarAlternativeState_acb91bbe-0d1e-fda0-9a1a-23ebee0f4ad0, _Amount, _From, _To)
THEN
NOT DB_DialogMoneyTransfer(_ID, (DIALOGRESOURCE)LOW_OskarsBeloved_OskarAlternativeState_acb91bbe-0d1e-fda0-9a1a-23ebee0f4ad0, _Amount, _From, _To);
DB_BUGFIX_Marker("GUS-301940");
//END_REGION GUS-301940

//REGION GUS-301988

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "Figaro")
THEN
DB_LOW_SerialKiller_DolorWasInFigaros(1);
DB_BUGFIX_Marker("GUS-301988");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal")
AND
NOT DB_Dead(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09)
AND
NOT GetRelation(Act3_LOW_Figaro_d91dd3bb-b2b5-4d72-857b-e875cbbc2744, Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, 0)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, 0);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)Act3_LOW_Figaro_d91dd3bb-b2b5-4d72-857b-e875cbbc2744, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_FlamingFists_b1603934-1816-4a16-a400-46af52b5afa2, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
PROC_SetRelationMutual(Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, Act3_LOW_FlamingFistGuards_86d2eaf4-1da3-4dbe-94c0-7cf3b240f428, 0);
RemoveStatus(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, "LOW_SERIALKILLER_PARALYZED", NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, "LOW_SERIALKILLER_PARALYZED", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-301988");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal")
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
NOT GetRelation(ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, 0)
THEN
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_FigarosDoppelgangers_b8f157f8-161f-4915-b131-b585402e60a5, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
PROC_SetRelationMutual((FACTION)Act3_LOW_Dolor_OutsideDoppelgangers_f7fa73a1-1ea0-40e2-9897-30c4c3d647ee, (FACTION)ACT3_LOW_SerialKiller_DevellaAtFigaros_67d694d6-e90e-43f6-a6e3-5c5e94977799, 0);
RemoveStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", NULL_00000000-0000-0000-0000-000000000000);//Removing the unlimited paralysis
ApplyStatus(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_SERIALKILLER_PARALYSED_DEVELLA", 18.0, 1, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-301988");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal")
THEN
SetCombatGroupID(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "");
PROC_RemoveOneShotTrigger(S_LOW_SerialKiller_TriggerSoliloquy_bdf8d2c4-a5f0-4643-b597-07238364872e);

//END_REGION GUS-301988

//REGION GUS-301978
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_Bugfix_GUS301878();
DB_BUGFIX_Marker("GUS-301978");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,14,0)
AND
NOT DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_301978(1);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_BUGFIX_301978(1)
THEN
PROC_Bugfix_GUS301878();
DB_BUGFIX_Marker("GUS-301978");
NOT DB_BUGFIX_301978(1);

PROC
PROC_Bugfix_GUS301878()
AND
IsLocked(S_Teleport_Door_FireworksBasement_63500f96-0ba5-4c96-bffd-3579a567f6a4, 0)
THEN
Unlock(S_DOOR_Fireworks_Teleport_1c51e06d-f73f-4b90-8b38-e3e54759ae18);


PROC
PROC_Bugfix_GUS301878()
AND
IsLocked(S_DOOR_Fireworks_Teleport_1c51e06d-f73f-4b90-8b38-e3e54759ae18, 0)
THEN
Unlock(S_Teleport_Door_FireworksBasement_63500f96-0ba5-4c96-bffd-3579a567f6a4);


//END_REGION GUS-301978

//REGION GUS-302174
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83) // temple door has been opened.
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // and combat hasn't begun yet.
AND
QRY_AnyPlayerInTrigger((TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113)
THEN
DB_BUGFIX_Marker("GUS-302174");
PROC_LOW_BhaalTemple_ForceUpdateAltarArea_Start();
//END_REGION

//REGION GUS-302487

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_GlobalFlag((FLAG)WYR_RaphaelTango_Event_BeganSoloScene_1048973a-9ed0-89e5-ce68-11e03fafc22c)
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_WaitForDeal")
THEN
PROC_State_Progress(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,"GLO_Warlock", "GLO_Warlock_WaitForDeal");

//END_REGION

//REGION GUS-306172

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_ElminsterRevisit_8ff23293-52b0-943c-0fe6-8b4379cfabb5, _, _, _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_MystraOM_40a7e59c-2473-504b-27ec-b2903fd5cf96)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_ElminsterRevisit_8ff23293-52b0-943c-0fe6-8b4379cfabb5);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_ElminsterRevisit_8ff23293-52b0-943c-0fe6-8b4379cfabb5, _, _, _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_MystraOM_State_RefusedOM_617d8194-0aa8-4fd9-9c8c-c6fd545afd64)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_ElminsterRevisit_8ff23293-52b0-943c-0fe6-8b4379cfabb5);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_RelationshipDialog_Queue((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_ElminsterRevisit_8ff23293-52b0-943c-0fe6-8b4379cfabb5, _, _, _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_MystraOM_40a7e59c-2473-504b-27ec-b2903fd5cf96)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_ElminsterRevisit_8ff23293-52b0-943c-0fe6-8b4379cfabb5);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_RelationshipDialog_Queue((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_ElminsterRevisit_8ff23293-52b0-943c-0fe6-8b4379cfabb5, _, _, _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_MystraOM_State_RefusedOM_617d8194-0aa8-4fd9-9c8c-c6fd545afd64)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_ElminsterRevisit_8ff23293-52b0-943c-0fe6-8b4379cfabb5);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
THEN
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_ElminsterRevisit_8ff23293-52b0-943c-0fe6-8b4379cfabb5);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_LoopEffect((GUIDSTRING)ORI_Gale_State_SentToMystraShrine_0dd4342b-02ab-e50e-0e63-d11bce159625, _,"ORI_Gale_SummonedToMystra",_ ,_ ,_ , _)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_MystraOM_40a7e59c-2473-504b-27ec-b2903fd5cf96)
THEN
PROC_StopLoopEffect(S_LOW_MystraStatue_ab6b7142-2333-4b38-9506-fb3e72157145, "ORI_Gale_SummonedToMystra");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_LoopEffect((GUIDSTRING)ORI_Gale_State_SentToMystraShrine_0dd4342b-02ab-e50e-0e63-d11bce159625, _,"ORI_Gale_SummonedToMystra",_ ,_ ,_ , _)
AND
DB_PermaDefeated(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_StopLoopEffect(S_LOW_MystraStatue_ab6b7142-2333-4b38-9506-fb3e72157145, "ORI_Gale_SummonedToMystra");


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
IsInTrigger((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_LOW_StormshoreTabernacle_SUB_8ef5fd83-3fa2-48c1-b103-0846ee138206, 1)
THEN
SetFlag((FLAG)ORI_Gale_State_IsInTabernable_312c8e3f-3b5a-40a4-a76d-cc8be179a75c, NULL_00000000-0000-0000-0000-000000000000, 0, 1);

//END_REGION

//REGION GUS-302173
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_LOW_BhaalTemple_Denizens_IgnoreShapeshiftReactions();
//END_REGION

//REGION GUS-301729
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_DisguisedRedcapsDroppedDisguise_da4c2802-faa5-4e60-a591-f52c2622e6f9)
AND
NOT GetRelation((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,(FACTION)GLO_FlamingFists_Reinforcements_a2a56601-616b-4d85-b571-cf34fc5801a8,0)
THEN
DB_BUGFIX_Marker("GUS-301729");
PROC_SetRelationMutual((FACTION)ACT3_LOW_BlushingMermaid_DisguisedRedcaps_febcc72f-64ee-4e59-92a1-5a135af81ad5,(FACTION)GLO_FlamingFists_Reinforcements_a2a56601-616b-4d85-b571-cf34fc5801a8,0);
//END_REGION

//REGION GUS-302601
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_Dialogs(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,(DIALOGRESOURCE)LOW_HagSurvivors_HagSpy_Aggroed_41621532-a3a0-8d9a-de88-729d5cdc18a2)
AND
NOT DB_SceneManager(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HagSpyChallengesPlayersOnAggro_Scene")
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_HagSpyAggroed_74eca7c7-e83b-4f07-ac32-beac7cd5eff7)
THEN
DB_BUGFIX_Marker("GUS-302601");
BlockNewCrimeReactions(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,0);
DB_SceneManager(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,"LOW_HagSpyChallengesPlayersOnAggro_Scene");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
SysIsActive("Act1_HAG_Hagspawn_TriggerInitialScene")
THEN
SysCompleteGoal("Act1_HAG_Hagspawn_TriggerInitialScene");
//END_REGION

//REGION GUS-301877
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
THEN
DB_BUGFIX_Marker("GUS-301877");
PROC_GLO_Bugfix_301877_UpdateSpotting();

PROC
PROC_GLO_Bugfix_301877_UpdateSpotting()
AND
DB_LOW_BhaalTemple_OrinSpotting((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
DB_SpotPlayers_IncludeWildshapedPlayers(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,"LOW_BhaalTemple_Spotting_OrinInTemple"); // wildshape fix
DB_SpotPlayers_TargetIgnoreCantTalk(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101,"LOW_BhaalTemple_Spotting_OrinInTemple");  // wildshape fix
//END_REGION


//REGION GUS-302187

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_WYR_CourageTest_Tester((CHARACTER)_, _Combat)
AND
DB_Is_InCombat(_Character, _Combat)
AND
IsCharacter(_Character, 1)
THEN
DB_BUGFIX_Marker("GUS-302187");
DB_WYR_CourageTest_Combatant((CHARACTER)_Character);

//END_REGION

//REGION GUS-300876
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
DB_LOW_HagSurvivors_SetOffstageAdriellesJournals(1);

IF
DB_LOW_HagSurvivors_SetOffstageAdriellesJournals(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-300876");
NOT DB_LOW_HagSurvivors_SetOffstageAdriellesJournals(1);
TeleportTo(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalMayrinaLeader_000_65a2aacb-639d-44e6-95a9-46f53a678a5e,S_LOW_HagSurvivors_MarkerTrigger_f6ba1d1c-b75b-49ce-a006-198868ffc375);
TeleportTo(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalNoMayrina_000_eb73d969-cb4d-4510-8010-4d05fa9f696c,S_LOW_HagSurvivors_MarkerTrigger_f6ba1d1c-b75b-49ce-a006-198868ffc375);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalMayrinaLeader_000_65a2aacb-639d-44e6-95a9-46f53a678a5e,0);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalNoMayrina_000_eb73d969-cb4d-4510-8010-4d05fa9f696c,0);
//END_REGION

//REGION GUS-302619
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_GlobalFlag((FLAG)LOW_TheLodge_State_GaveHavkelaagGithEgg_689dea93-b42f-4b14-b268-a492ad5d0a12)
THEN
DB_BUGFIX_Marker("GUS-302619");
SetCanBePickpocketed(S_CRE_GithyankiEgg_999b6dd7-2901-4604-8280-1931a5217a94,0);
//END_REGION

//REGION GUS-280644
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
NOT DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac)
AND
NOT DB_PreventPermaDefeated(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
THEN
ClearFlag((FLAG)LOW_FatherCarrion_State_IsTempDefeated_56356b1f-9ddc-4d34-a22b-3b92dc2b6e8b);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
NOT DB_GlobalFlag((FLAG)LOW_Philgraves_State_HeartIsDestroyed_fcf8164a-742d-4ef4-af61-3773d8891a44)
AND
NOT DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac)
AND
NOT DB_PreventPermaDefeated(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
THEN
DB_PreventPermaDefeated(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_OnlyOnce("LOW_PhilgravesMansion_GetZombiesBack")
THEN
DB_LOW_PhilgravesMansion_ShouldResetJars(1);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_PhilgravesMansion_ShouldResetJars(1)
THEN
NOT DB_LOW_PhilgravesMansion_ShouldResetJars(1);
PROC_LOW_ResetJarsPosition();

PROC
PROC_LOW_ResetJarsPosition()
AND
DB_PhilgravesMansion_JarBasementLocation(_Jar,_Location)
AND
IsInTrigger(_Jar,(TRIGGER)S_LOW_PhilgravesMansion_BasementRegionTrigger_17a71a2b-98b2-470d-bb7b-f8cfeda2d4dc,1)
AND
NOT GetDirectInventoryOwner(_Jar,_)
THEN
SetGravity(_Jar, GRAVITYTYPE.DisabledUntilMove);
TeleportTo(_Jar, _Location,"",0,0,0,0,0);
DB_BUGFIX_Marker("GUS-280644");

//END_REGION

//REGION GUS-302745
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
THEN
DB_BUGFIX_Marker("GUS-302745");
PROC_GLO_Bugfix_302745();

// case 1 - Cazador in his coffin, flag KillCazador is not set - we make him immortal, restore his hp to 100% and remove all harmful statuses from him to prevent the bug from happening
PROC
PROC_GLO_Bugfix_302745()
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_CazadorInCoffin_15322f0b-da2e-48f8-b7d0-a6418c58893c)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611)
AND
IsImmortal((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0)
THEN
SetImmortal((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 1);
SetHitpointsPercentage(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 100.0);
RemoveHarmfulStatuses(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3);

// case 2 - Cazador was killed outside the dialog, the quest is broken - necessary flags weren't set
// we need to set different flags depending on whether Astarion was present or not when Cazador died (PostCombat OM dialog happened or not)
PROC
PROC_GLO_Bugfix_302745()
AND
DB_PermaDefeated(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611)
AND
DB_OriginDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b)
THEN
SetFlag((FLAG)ORI_Astarion_State_StayedVampireSpawn_2724b881-6be1-49a7-8375-a49e9acb4546);
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5);
DB_GLO_Bugfix_302745_GiveItems(1);
DB_GLO_Bugfix_302745_RemoveSpawns(1);

PROC
PROC_GLO_Bugfix_302745()
AND
DB_PermaDefeated(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611)
AND
NOT DB_OriginDialog((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_PostCombat_OM_Astarion_AOM_COM_OOM_28e5e4d3-f76e-5932-5426-c542619a745b)
THEN
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazador_d0ae6721-9927-405c-a98c-f3930506f611);
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_Event_KillCazadorWithClear_9253fd5b-c5b9-4621-893c-3fc1f36db6bd);
SetFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_LeftPrisonersRot_52cc991c-1d18-4d84-ab28-61e21ac958b5);
DB_GLO_Bugfix_302745_GiveItems(1);
DB_GLO_Bugfix_302745_RemoveSpawns(1);

IF
DB_GLO_Bugfix_302745_GiveItems(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_GLO_Bugfix_302745_GiveItems(1);
DB_GLO_Bugfix_302745_GiveItems(2);
PROC_GLO_Bugfix_302745_GiveItems();

IF
DB_GLO_Bugfix_302745_RemoveSpawns(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_GLO_Bugfix_302745_RemoveSpawns(1);
DB_GLO_Bugfix_302745_RemoveSpawns(2);
PROC_GLO_Bugfix_302745_RemoveSpawns();

PROC
PROC_GLO_Bugfix_302745_GiveItems()
AND
DB_Avatars(_Avatar)
AND
QRY_OnlyOnce("GLO_Bugfix_302745_GiveItems")
THEN
MoveAllItemsTo(S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, _Avatar, 1, 1, 1, 1);
ToInventory(S_LOW_CazadorsPalace_RitualRoom_RitualDagger_feae3d43-138d-4692-aa43-787e3f7e499f, _Avatar, 1, 1, 1);

PROC
PROC_GLO_Bugfix_302745_RemoveSpawns()
AND
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs(_Spawn, _)
AND
NOT DB_OffStage(_Spawn)
THEN
PROC_ForceStopDialog(_Spawn);
PROC_DisappearOutOfSightTo(_Spawn, S_LOW_CazadorsPalace_RitualRoom_SpawnDisappearPos_569c8fc4-b125-41ce-8905-f276f0b7c776, "Sprint", 1, "");
//END_REGION

//REGION GUS-301765
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
QRY_LOW_Elfsong_RoomDirty()
THEN
DB_LOW_Elfsong_GUS301765(8c9df10c-4c16-89de-27d6-4ea4ce03c6f6);
DB_LOW_Elfsong_GUS301765(062db6a2-d12b-8511-5041-15bbafd6651b);
DB_LOW_Elfsong_GUS301765(9bf9c1bf-b6a1-88d4-44c8-fcdfbaf029ff);
DB_LOW_Elfsong_GUS301765(ff4749f8-2c83-8541-5804-0b47ac2c1ffa);
DB_LOW_Elfsong_GUS301765(fd16a3b3-89cd-8458-248e-450b58a171dd);
DB_LOW_Elfsong_GUS301765(c7d53556-571c-800f-5ef3-48453be9eda2);
DB_LOW_Elfsong_GUS301765(51c70818-36d1-8686-2898-c85b0182e70d);
DB_LOW_Elfsong_GUS301765(6eec7b27-cb52-8f7f-340a-52e0f0ede61e);
DB_LOW_Elfsong_GUS301765(f79701a2-98b7-85ae-464c-71e110699907);
DB_LOW_Elfsong_GUS301765(46a1b420-6378-8220-3e61-d5e5dc9367a7);
DB_LOW_Elfsong_GUS301765(4d5d973e-b008-8410-5a3e-01be66b53256);
DB_LOW_Elfsong_GUS301765(485457db-7be9-8cf3-4e42-e1595b8046c7);
DB_LOW_Elfsong_GUS301765(2d57583d-4399-8a22-3097-09c11298b3e3);
DB_LOW_Elfsong_GUS301765(5a6af40b-9459-8b99-5e60-528fe6bcc3b5);
DB_LOW_Elfsong_GUS301765(3f382597-64c2-8b9e-4b56-a87c3aa87d27);
DB_LOW_Elfsong_GUS301765(c6310336-ea3f-83da-54f9-5a2464088582);
DB_LOW_Elfsong_GUS301765(db2dcaea-585d-838e-3509-8e2234b76937);
DB_LOW_Elfsong_GUS301765(f8ffabd1-4e01-8fca-289f-81ee05b967b6);
DB_LOW_Elfsong_GUS301765(d7b7c618-f83c-80a7-2ac2-a573d83d51eb);
DB_LOW_Elfsong_GUS301765(d239490b-f4c0-8738-5cf3-b2157fe909ae);
DB_LOW_Elfsong_GUS301765(64fd7317-2406-4192-9556-0fa731ad15bd);
DB_LOW_Elfsong_GUS301765(b3e28af4-e7c3-81b4-5ea3-d329663da0e5);
DB_LOW_Elfsong_GUS301765(f8ffabd1-4e01-8fca-289f-81ee05b967b6);
DB_LOW_Elfsong_GUS301765(d7b7c618-f83c-80a7-2ac2-a573d83d51eb);
DB_BUGFIX_Marker("GUS-301765");

IF
DB_LOW_Elfsong_GUS301765(_Item)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_SetOnStage(_Item, 0);

PROC
PROC_LOW_Elfsong_CleanElfsongTemplate()
AND
DB_LOW_Elfsong_GUS301765(_Item)
THEN
SetOnStage(_Item, 1);
NOT DB_LOW_Elfsong_GUS301765(_Item);

QRY
QRY_LOW_Elfsong_RoomDirty()
AND
DB_LOW_Elfsong_FlagsToChangePrivateRoom(_Flag)
AND
DB_GlobalFlag(_Flag)
THEN
DB_NOOP(1);
//END_REGION GUS-301765

//REGION GUS-298200
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_LOW_Camp_NeedHideDoor(1);

IF
DB_LOW_Camp_NeedHideDoor(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_SetOnStage(S_CAMP_DoorToCity_Secondary_fecd87f1-ca28-46c7-8088-64ca98273d46, 0);
DB_BUGFIX_Marker("GUS-298200");
//END_REGION GUS-298200

//REGION GUS-302476
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_GlobalFlag(DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
AND
NOT DB_PermaDefeated(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c)
THEN
DB_LOW_Elfsong_GUS302476(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_GlobalFlag(DEN_TieflingRefugees_State_LeftDen_003b304b-f058-4f8a-b9fa-a097e1b6b395)
AND
NOT DB_PermaDefeated(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
THEN
DB_LOW_Elfsong_GUS302476(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c);

IF
DB_LOW_Elfsong_GUS302476(_Character)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_Elfsong_GUS302476(_Character);
TeleportTo(_Character, S_LOW_Elfsong_KillingTeleport_61da17a6-2347-4d5c-ad96-ee07f0e74dbe, "");
Die(_Character, DEATHTYPE.Physical, NULL_00000000-0000-0000-0000-000000000000, 0, 1);
PROC_SetOnStage(_Character, 0);
DB_BUGFIX_Marker("GUS-302476");
//END_REGION GUS-302476

//REGION GUS-303114
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
DB_HostileToPlayerGroup((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, _Player)
AND
NOT DB_BUGFIX_Marker("GUS-303114")
THEN
DB_BUGFIX_Marker("GUS-303114");
PROC_SetRelationToPlayers_ClearIndivPlayerRelations((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e);
//END_REGION

//REGION GUS-302910
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
NOT DB_LevelLoadedOnce("END_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
AND
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b);
DB_BUGFIX_Marker("GUS-302910");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LOW_SorcerousSundries_NSAndIsobelLeaveCampPos("FARM",_)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_Event_NSAndIsobelLeaveCamp_64a6e5df-b6a0-42ab-93b6-818bc4e2859a)
THEN
DB_LOW_SorcerousSundries_NSAndIsobelLeaveCampPos("FARM",S_LOW_SorcerousSundries_Farm_NightsongLeaveCampPos_7099c20c-2710-4575-9f32-d4780dfe5965);
DB_BUGFIX_Marker("GUS-302910");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
THEN
ClearFlag((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662);
NOT DB_DoNotRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_BUGFIX_Marker("GUS-302910");

//Revert bringing back Nightsong if she was killed in act 2
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_OnlyOnce("LOW_SorcerousSundries_BringBackNSFromRamazith")
AND
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
DB_LOW_SorcerousSundries_NightsongShouldNotBeAtCamp("CTY_Main_A", S_LOW_SorcerousSundries_AngryNightsongAsylum_a76e7ee2-4d88-4977-977e-0dafb5f9662d);
DB_LOW_SorcerousSundries_NightsongShouldNotBeAtCamp("BGO_Main_A", S_LOW_SorcerousSundries_BGONightsongAsylum_9f324a58-c158-4c71-8796-4a463547f46d);

IF
DB_CurrentLevel(_Level)
AND
DB_LOW_SorcerousSundries_NightsongShouldNotBeAtCamp(_Level, _AsylumTrigger)
THEN
NOT DB_LOW_SorcerousSundries_NightsongShouldNotBeAtCamp("CTY_Main_A", S_LOW_SorcerousSundries_AngryNightsongAsylum_a76e7ee2-4d88-4977-977e-0dafb5f9662d);
NOT DB_LOW_SorcerousSundries_NightsongShouldNotBeAtCamp("BGO_Main_A", S_LOW_SorcerousSundries_BGONightsongAsylum_9f324a58-c158-4c71-8796-4a463547f46d);
ClearFlag((FLAG)LOW_SorcerousSundries_State_NSReturnedFromRamazith_b7cbc725-249c-48ba-9146-6cf9292c4c0c);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,_AsylumTrigger);
PROC_SetOnStage(S_LOW_NightsongThreat_d9df0940-238f-4451-a312-d2847ee04f9a,0);
PROC_SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0);
DB_BUGFIX_Marker("GUS-302910");

//Atempted to go to ramazith but failed because it was called in BGO camp
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
NOT DB_LevelLoadedOnce("END_Main_A")
AND
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
GetFlag((FLAG)LOW_Nightsong_Quest_HasGoneToConfrontLorroakan_ed98ef99-f229-44d4-b020-62c415dba302, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0)
AND
IsOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1)
THEN
PROC_DisappearOutOfSight((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"Run",0,"");
DB_LOW_SorcerousSundries_NSUnblockToRamazith(1);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_SorcerousSundries_NSUnblockToRamazith(1)
THEN
NOT DB_LOW_SorcerousSundries_NSUnblockToRamazith(1);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SetRelationToPlayers((FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 100);
ClearFlag((FLAG)LOW_Lorroakan_Quest_WaitingForCampNightsongDialog_ce238f16-8215-48f8-90b4-a503a4426efd);
SetFlag((FLAG)LOW_Nightsong_Quest_HasGoneToConfrontLorroakan_ed98ef99-f229-44d4-b020-62c415dba302, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_RamazithsJump_Start_12ca715e-872c-49be-93e1-65e17eacc8be, "LOW_SorcerousSundries_NightsongReadyToEnterRamazith",0,0,0,1,1);
DB_BUGFIX_Marker("GUS-302910");

//END_REGION GUS-302910

//REGION GUS-288780
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_LOW_Elfsong_GUS288780(1);

IF
DB_LOW_Elfsong_GUS288780(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_Elfsong_GUS288780(1);
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_014_f2759ac8-fb14-4c20-9ab0-0c9dd72c8b71, "LOW_Elfsong_Patron_014_ChangedExterior");
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_011_a69ca09c-3d04-4b21-bf79-6396a574763f, "LOW_Elfsong_Exterior_Patron_011_ExteriorChanged");
PROC_SetAnubisConfig(S_LOW_Elfsong_Exterior_Patron_000_c1a924a2-032a-4f21-9849-93cfa6af83f8, "LOW_Elfsong_Exterior_Patron_000");
PROC_SetAnubisConfig(S_LOW_Elfsong_Exterior_Patron_002_31d1b1ba-5d49-438a-849b-f6554bb361f9, "LOW_Elfsong_Patron_002_ChangedInterior");
DB_BUGFIX_Marker("GUS-288780");
//END_REGION GUS-288780


//REGION GUS-303000
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 3")
THEN
DB_BUGFIX_Marker("GUS-303000");
DB_GLO_Bugfix_303000_FixMinions(1);

IF
DB_GLO_Bugfix_303000_FixMinions(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_GLO_Bugfix_303000_FixMinions(1);
DB_GLO_Bugfix_303000_FixMinions(2);
IterateCharactersAround(S_LOW_CazadorsPalace_RitualRoom_CoffinLid_82b2b28f-c1cd-4baa-9341-71b465afd853, 45.0, "GLO_Bugfix_303000_MinionIterated", "GLO_Bugfix_303000_AllMinionsIterated");

IF
EntityEvent((CHARACTER)_Minion, "GLO_Bugfix_303000_MinionIterated")
AND
GetTemplate(_Minion, (CHARACTERROOT)_MinionTemplate)
AND
DB_LOW_CazadorsPalace_RitualRoom_AdditionalMinions(_MinionTemplate, _, _)
AND
GetCombatGroupID(_Minion, _MinionCombatGroupID)
AND
_MinionCombatGroupID != "LOW_CazadorsPalace_RitualRoom"
THEN
SetCombatGroupID(_Minion, "LOW_CazadorsPalace_RitualRoom");
//END_REGION

//REGION GUS-294511
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Subregion((TRIGGER)S_LOW_BloodMerchant_SUB_4977b65c-2b3b-463f-8b40-fdcbf07f2b92, "LOW_BloodMerchant_SUB", 0, 1)
THEN
NOT DB_Subregion((TRIGGER)S_LOW_BloodMerchant_SUB_4977b65c-2b3b-463f-8b40-fdcbf07f2b92, "LOW_BloodMerchant_SUB", 0, 1);
PROC_TriggerUnregisterForParty(S_LOW_BloodMerchant_SUB_4977b65c-2b3b-463f-8b40-fdcbf07f2b92);
DB_Subregion((TRIGGER)LOW_BloodMerchant_Poly_SUB_74075284-a9d0-44d0-be56-067d2769fd6f, "LOW_BloodMerchant_SUB", 0, 1);
DB_BUGFIX_Marker("GUS-294511");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_Subregion((TRIGGER)S_LOW_BloodMerchant_SUB_4977b65c-2b3b-463f-8b40-fdcbf07f2b92, "LOW_BloodMerchant_SUB", 0, 1)
THEN
DB_Subregion((TRIGGER)LOW_BloodMerchant_Poly_SUB_74075284-a9d0-44d0-be56-067d2769fd6f, "LOW_BloodMerchant_SUB", 0, 1);
DB_BUGFIX_Marker("GUS-294511");
//END_REGION GUS-294511

//REGION GUS-302843
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
PROC_GLO_Bugfix_302843_Restore_DarkUrgeDualState();

// if Dark Urge triggered MissedTempleFinale, but also already done Acceptance, then we're going to ignore and undo the MissedTempleFinale flow, and give back his slayer form.
PROC
PROC_GLO_Bugfix_302843_Restore_DarkUrgeDualState()
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalAccepted_904c45e0-bb06-40ed-b5d7-4f1c851b9d86)
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_MissedTempleFinale_640cb288-0b40-434a-b13c-0c871d931bcc)
THEN
PROC_GlobalClearFlagAndCache((FLAG)ORI_DarkUrge_State_MissedTempleFinale_640cb288-0b40-434a-b13c-0c871d931bcc);
PROC_GlobalClearFlagAndCache((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0);
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_GivenSlayerForm_14aec5bc-1013-4845-96ca-20722c5219e3); // since its Acceptance, give player back their slayer form
DB_BUGFIX_Marker("GUS-302843"); // mark it if savegame was patched with this.

// if Dark Urge triggered MissedTempleFinale, but also already done Resistance, we're going to ignore and undo the MissedTempleFinale,
PROC
PROC_GLO_Bugfix_302843_Restore_DarkUrgeDualState()
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalResisted_74944ac3-1ea0-4eae-9653-1f1319f8646b)
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_MissedTempleFinale_640cb288-0b40-434a-b13c-0c871d931bcc)
THEN
PROC_GlobalClearFlagAndCache((FLAG)ORI_DarkUrge_State_MissedTempleFinale_640cb288-0b40-434a-b13c-0c871d931bcc);
PROC_GlobalClearFlagAndCache((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0);
DB_BUGFIX_Marker("GUS-302843"); // mark it if savegame was patched with this.
//END_REGION

//REGION GUS_300727
// Making the portrait button owned
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_PermaDefeatedOrOffstage(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_IncubusLeft_aa307994-517c-f21a-e85c-37b6c4ef3062)
THEN
SetOwner((ITEM)S_LOW_HouseOfHope_PortraitButton_71a0ee93-bbbd-4fff-89ff-b7bb11c14e67, S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);
SetOwner((ITEM)S_LOW_HouseOfHope_SoulVesselSafe_adb5581e-b1cf-4d3e-9ace-5c75adfa2f47, S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

//END_REGION

//REGION GUS-302220
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag(LOW_BaldursMouth_State_NegativeArticleStarted_b1f2debb-9174-441f-9b1e-0e3bc9aba3eb)
AND
DB_LOW_BaldursMouth_Articles(_ArticleFlag, _Article, _String)
AND
DB_GlobalFlag(_ArticleFlag)
THEN
PROC_GlobalClearFlagAndCache(LOW_BaldursMouth_State_NegativeArticleStarted_b1f2debb-9174-441f-9b1e-0e3bc9aba3eb);
DB_BUGFIX_Marker("GUS-302220");
//END_REGION


//REGION GUS-285908
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Act3_GLO_Gazette_TodaysIssue(_)
THEN
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article085", 294, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle004", 293, "Headline");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle005", 292, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle006", 291, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle007", 290, "Footer");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle008", 289, "Headline");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle011", 288, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle012", 287, "Headline");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle014", 286, "Footer");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle017", 285, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle018", 284, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle021", 283, "Footer");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle022", 282, "Headline");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle023", 281, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle025", 280, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle028", 279, "Footer");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle034", 278, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_OldArticle035", 277, "Footer");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article102", 276, "Headline");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_BaldursMouth_ArticleBlock001", 275, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_BaldursMouth_ArticleBlock002", 274, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_BaldursMouth_ArticleBlock003", 273, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article035", 272, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article036", 271, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article043", 270, "Footer");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article059", 269, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article060", 268, "Footer");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article061", 267, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article062", 266, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article063", 265, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article064", 264, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article065", 263, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article066", 262, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article077", 261, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article078", 260, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article079", 259, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article080", 258, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article081", 257, "Footer");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article082", 256, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article083", 255, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article084", 254, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article087", 253, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article088", 252, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article089", 251, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article090", 249, "Article");
DB_Act3_GLO_Gazette_ArticlesRestock("LOW_Gazette_Article091", 248, "Article");
DB_BUGFIX_Marker("GUS-285908");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_Act3_GLO_Gazette_IssueNumber(_Num)
AND
_Num > 100
AND
NOT DB_OnlyOnce("Act3_GLO_Gazette_RefillGenericArticles")
THEN
PROC_GLO_Gazette_RestockArticles();

//END_REGION

//REGION GUS-298725
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_LOW_KurwinCoffin_FixBuriedManCasketPosition(1);

IF
DB_LOW_KurwinCoffin_FixBuriedManCasketPosition(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_KurwinCoffin_FixBuriedManCasketPosition(1);
DB_BUGFIX_Marker("GUS-298725");
TeleportTo(S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107,S_LOW_KurwinCoffin_BuriedManCasket_PointTrigger_367a2648-d824-482c-ac9d-3a7c78918728,"",1,1,1,1,0);
//END_REGION

//REGION GUS-303783
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Hotfix 4")
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_OrinInTemple_494df8e1-a986-4744-958f-b33880dd5bb2) // Orin should be in the temple
AND
GetRegion(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, "BGO_Main_A") // but she was accidentally put in BGO_Main_A due to a bug.
AND
NOT DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
THEN
DB_BUGFIX_Marker("GUS-303783");
TeleportTo((CHARACTER)S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, S_GLO_BhaalTemple_OrinTemple_TriggerPos_810e97df-6e10-4ff3-94d4-2a466a3ec7c7, "", 0, 0, 0, 0, 0);
//END_REGION

//REGION GUS-303423
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_BUGFIX_Marker("GUS-303423");

IF
DB_BUGFIX_Marker("GUS-303423")
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_GLO_Bugfix_303423_UpdatedTags(1)
THEN
DB_GLO_Bugfix_303423_UpdatedTags(1);
SetTag(S_LOW_CazadorsPalace_Cells_AdultDoor_aa404054-9dae-4684-82aa-48c948295e6c, (TAG)KNOCKBLOCK_e56e4df0-a4d7-480b-b69f-573c988b2f37);
SetTag(S_LOW_CazadorsPalace_Cells_ChildrenDoor_6bca442f-383d-46a6-be5b-a5e046aa853e, (TAG)KNOCKBLOCK_e56e4df0-a4d7-480b-b69f-573c988b2f37);
SetTag(S_LOW_CazadorsPalace_Cells_EntranceDoor_197240c8-d485-4e84-aede-ba1fed46b2fa, (TAG)KNOCKBLOCK_e56e4df0-a4d7-480b-b69f-573c988b2f37);
SetTag(S_LOW_CazadorsPalace_Crypt_EntranceDoor_5a1fccda-99bd-4c8d-befa-eec0b55e36b2, (TAG)KNOCKBLOCK_e56e4df0-a4d7-480b-b69f-573c988b2f37);
//END_REGION

//REGION GUS-303784
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_BUGFIX_Marker("GUS-303784");
PROC_GLO_303784_ClearButlerAnubisDB(); // clear the DB of older facts that weren't intended.
PROC_GLO_303784_SetButlerAnubisDB(); // set it to the correct DB, and assign the anubis config.

PROC
PROC_GLO_303784_ClearButlerAnubisDB()
AND
DB_QRYRTN_DarkUrgeButler_Config(_Config)
THEN
NOT DB_QRYRTN_DarkUrgeButler_Config(_Config);

PROC
PROC_GLO_303784_SetButlerAnubisDB()
AND
GetRegion(S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, _CurrentLevel) // get the Butler's current level.
AND
QRY_ORI_DarkUrgeButler_Config(_CurrentLevel)
AND
DB_QRYRTN_DarkUrgeButler_Config(_Config)
THEN
PROC_SetAnubisConfig((CHARACTER)S_GLO_DarkUrge_Butler_f3486165-268f-4e41-9e0c-51485dfdff10, _Config);
//END_REGION

//REGION GUS-303784-2
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-303784-2");
PROC_GLO_303784_2_UpdateButlerDB();

PROC
PROC_GLO_303784_2_UpdateButlerDB()
AND
DB_GLO_ORI_DarkUrge_ButlerConfigs("WYR_Main_A", "WYR_DarkUrge_Butler")
THEN
NOT DB_GLO_ORI_DarkUrge_ButlerConfigs("WYR_Main_A", "WYR_DarkUrge_Butler");
DB_GLO_ORI_DarkUrge_ButlerConfigs("BGO_Main_A", "WYR_DarkUrge_Butler");
//END_REGION

//REGION GUS-302884
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("BGO_Main_A")
THEN
PROC_ApplySavegamePatches_GUS_302884();
DB_BUGFIX_Marker("GUS-302884");

PROC
PROC_ApplySavegamePatches_GUS_302884()
AND
DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
DB_GlobalFlag((FLAG)Laezel_InParty2_Event_DiscussedRaphaelsDealWithParty_60343d64-923c-49c9-a771-05f7a0706fdf)
AND
NOT QRY_ORI_Laezel_VossInAct3()
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "ORI_COM_Laezel", "TalkToLaezelAfterGettingHammerFromHoH", 1)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "ORI_COM_Laezel", "EnteredAstralPlane_WithHammer", 0)
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "ORI_COM_Laezel", "EnteredAstralPlane_NoHammer", 0)
THEN
PROC_ORI_Laezel_QuestUpdate_RespectPriority((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "ORI_COM_Laezel", "GotHammer_VossNotPresent");

PROC
PROC_ApplySavegamePatches_GUS_302884()
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_VossWaitingForHammerInSewers_47b30289-c885-46a9-ab6e-82b5460c161d)
AND
DB_GlobalFlag((FLAG)WYR_RaphaelTango_Event_VossThreeWay_fc784019-f8b5-ea1c-420f-a21e27775f2f) //If Voss and Raph scene happened
AND
DB_State_Current(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, "WYR_RaphaelTango_GithKnight", "Left") //Voss shouldn't disappear if the ThreeWay scene happened
AND
QRY_ORI_Laezel_VossInAct3() //Checks for PermaDefeated as well
THEN
DB_ApplySavegamePatches_GUS_302884_WaitForBGO(1);

IF
DB_ApplySavegamePatches_GUS_302884_WaitForBGO(1)
AND
DB_CurrentLevel("BGO_Main_A")
THEN
PROC_State_Changed(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, "WYR_RaphaelTango_GithKnight","Left","TaproomWaiting");
PROC_SetOnStage(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 1);
TeleportTo(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, S_WYR_RaphaelTango_Voss_TaproomPos_b12f8da4-f190-4736-b5fc-f66c37c63759, "", 0, 0, 0, 0, 1);
DB_BUGFIX_Marker("GUS-302884");

PROC
PROC_ApplySavegamePatches_GUS_302884()
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)ORI_Laezel_State_ShowedVossTheHammer_5588f6a2-bb8c-4f91-a152-168492b9c09f, (DIALOGRESOURCE)WYR_RaphaelTango_Voss_140953a8-5d79-c6d0-d691-52694b875bc2);

//If Voss left because players had entered the House of Hope
PROC
PROC_ApplySavegamePatches_GUS_302884()
AND
DB_State_Current(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, "WYR_RaphaelTango_GithKnight", "Left")
AND
NOT DB_GlobalFlag((FLAG)WYR_RaphaelTango_Event_VossThreeWay_fc784019-f8b5-ea1c-420f-a21e27775f2f) //If Voss and Raph scene did not happen
THEN
DB_GLO_Voss_VossLeftSCWithoutMeetingPlayer(1);

PROC
PROC_ApplySavegamePatches_GUS_302884()
AND
DB_GlobalFlag((FLAG)Laezel_InParty2_Event_DiscussedRaphaelsDealWithParty_60343d64-923c-49c9-a771-05f7a0706fdf)
AND
NOT DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
NOT QRY_ORI_Laezel_VossInAct3()
AND
QuestUpdateIsUnlocked((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "ORI_COM_Laezel", "AfterRaphaelNoDeal_VossNotPresent", 0)
THEN
QuestUpdate((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "ORI_COM_Laezel", "AfterRaphaelNoDeal_VossNotPresent");

PROC
PROC_ApplySavegamePatches_GUS_302884()
AND
DB_Players(_Player)
AND
GetFlag((FLAG)ORI_Laezel_State_HasSilverSword_5fa3c5e1-c6c6-40a5-98ba-88e4c7f820db, _Player, 1)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_TookSilverSword_a1e6810f-08e9-4994-b780-098e1635f60a)
THEN
SetFlag((FLAG)ORI_Laezel_State_TookSilverSword_a1e6810f-08e9-4994-b780-098e1635f60a);

PROC
PROC_ApplySavegamePatches_GUS_302884()
AND
NOT DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c)
THEN
SetFlag((FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e);

PROC
PROC_ApplySavegamePatches_GUS_302884()
AND
DB_GlobalFlag((FLAG)LOW_DevilsFee_Knows_HelsikWayHoH_6beeb7f7-53ec-c6dc-0261-95b8d7c2fb4e)
AND
DB_GlobalFlag((FLAG)GLO_Orpheus_Knows_OrphicHammerIsTheKey_980541fb-1483-ea1a-3387-64405eace9a2)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
THEN
PROC_ORI_Laezel_QuestUpdate_RespectPriority((CHARACTER)S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "ORI_COM_Laezel", "LearnDevilsFeeEntrance");


//These are defined in a global goal
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_ORI_Laezel_QuestPriorityStepList(4550, "ORI_COM_Laezel", "VossIsGoneFromSC_OrpheusPath");
DB_ORI_Laezel_QuestPriorityStepList(4550, "ORI_COM_Laezel", "VossIsGoneFromSC_VlaakithPath");
DB_ORI_Laezel_QuestPriorityStepList(4550, "ORI_COM_Laezel", "VlaakithVisited_FindKeyToOrpheus_OrpheusPath");
DB_ORI_Laezel_QuestPriorityStepList(4550, "ORI_COM_Laezel", "VlaakithVisited_FindKeyToOrpheus_VlaakithPath");
DB_ORI_Laezel_QuestPriorityStepList(4600, "ORI_COM_Laezel", "LearnDevilsFeeEntrance");
DB_BUGFIX_Marker("GUS-302884");
//END_REGION

//REGION GUS-303090
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e)
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_VossWaitingForHammerInSewers_47b30289-c885-46a9-ab6e-82b5460c161d) //Flag is set when Voss leaves for the Sewers in BGO and cleared when Voss leaves for Endgame after you give show him the hammer
AND
NOT DB_PermaDefeated(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
THEN
DB_ApplySavegamePatches_GUS_303090_WaitForCTY(1);

IF
DB_ApplySavegamePatches_GUS_303090_WaitForCTY(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_SetOnStage(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 1);
TeleportTo(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, S_LOW_VossSewersPos_fdc43cdd-7442-4f89-bea9-6a1c8b820670, "", 0, 0, 0, 0, 1);
DB_BUGFIX_Marker("GUS-303090");
//END_REGION

//REGION GUS-303114
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
NOT DB_CompanionFactions(_)
THEN
DB_BUGFIX_Marker("GUS-303114");
DB_CompanionFactions((FACTION)Companion1_6ae41c2e-e72a-c682-a014-18e638ced83f);
DB_CompanionFactions((FACTION)Companion2_26bdc9a8-aa89-9a52-042d-3defee5855eb);
DB_CompanionFactions((FACTION)Companion3_afb9d9bb-9a52-4737-4d8d-c5c72f32b730);
DB_CompanionFactions((FACTION)Companion4_1b5bd02e-2178-c73c-3eb0-b8f4fc4f7dc5);
DB_CompanionFactions((FACTION)Companion5_82692ccd-1862-b8b1-5bfb-318fa17e4a8a);
DB_CompanionFactions((FACTION)Companion6_b0adf105-0c9d-9000-6f99-6f734ea327e0);
DB_CompanionFactions((FACTION)Companion7_8e465ee5-ad2b-008b-966b-d1641e37e3c5);
DB_CompanionFactions((FACTION)Companion8_16ff923d-ab9b-bbc1-4480-2ec8d38f05ee);
DB_CompanionFactions((FACTION)Companion9_4abec10d-c2d1-a505-a09a-719c83999847);
DB_CompanionFactions((FACTION)Companion10_fd96559f-010a-6e27-8689-eb29795ff2af);
DB_CompanionFactions((FACTION)Companion11_a36493ce-5798-d27f-1e24-01cb79fbdb1b);
DB_CompanionFactions((FACTION)Companion12_aeaf8c61-8ff3-1bc2-18fc-7da29495fc68);
DB_CompanionFactions((FACTION)Companion13_401f9d21-7a96-0f56-de79-21eff96f8d72);
DB_CompanionFactions((FACTION)Companion14_1ebdab21-fb0b-3dd8-a7b7-bfbc777d7a5d);
DB_CompanionFactions((FACTION)Companion15_9a7c52c8-ca88-4493-bca5-9b917494c94c);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
DB_HostileToPlayerGroup((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e, _Player)
AND
NOT DB_BUGFIX_Marker("GUS-303114")
THEN
DB_BUGFIX_Marker("GUS-303114");
PROC_SetRelationToPlayers_ClearHostileToPlayerGroup((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e);
PROC_SetRelationToPlayers_ClearIndivPlayerRelations((FACTION)GLO_Hag_313edae9-c797-2c65-9f7c-47e1f4e3221e);
//END_REGION

//REGION GUS-301668
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagTookMother_38dc6752-5ab3-e108-64ed-fe63971d69fd)
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_MetSurvivors_e60750e6-26bc-4b80-a782-32dcc7d1e397)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_SawMayrinaAsSheep_09ea45ca-113f-4b96-ad36-d349f3cc4b28)
AND
NOT DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_ReadMayrinasNote_3c9a4e69-a315-4a37-a677-fc9a59070714)
AND
HasActiveStatus(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,"LOW_HAGVICTIM_SHEEPCURSE",1)
THEN
DB_LOW_ClearMayrinaPresentHagReadables(1);

IF
DB_LOW_ClearMayrinaPresentHagReadables(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_ClearMayrinaPresentHagReadables(1);
DB_BUGFIX_Marker("GUS-301668");
PROC_GlobalClearFlagAndCache((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3);
PROC_LOW_ClearMayrinaPresentHagReadables();

PROC
PROC_LOW_ClearMayrinaPresentHagReadables()
THEN
PROC_SetOnStage(S_LOW_HagSurvivors_VoodooDoll_5b0a0081-d158-4c19-8796-5628cc03672a,0);
PROC_SetOnStage(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,0);
TeleportTo(S_HAG_Hagspawn_SurrogateMother_08c970d7-3138-45e8-8965-68eadf4b07cd,S_LOW_BlushingMermaid_MissingKid_Spot_a0c4ce02-fd08-482f-af14-0c4fb0283553);

PROC
PROC_LOW_ClearMayrinaPresentHagReadables()
THEN
PROC_LOW_ClearMayrinaPresentHagReadables_Internal((ITEMROOT)BOOK_LOW_HagSurvivors_HagSpysNote_97bfb610-9aa5-4183-bf60-972ad955b45a,S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,(ITEMROOT)BOOK_LOW_HagSurvivors_HagSpysNote_NoMayrina_658b0b6e-f60d-434c-8690-c2ea2b313f45);
PROC_LOW_ClearMayrinaPresentHagReadables_Internal((ITEMROOT)BOOK_LOW_BlushingMermaid_HagsInformantNote_785e14ea-78ad-4583-9268-a5e64354b481,S_LOW_BlushingMermaid_CaptainsTable_22fa5c73-4d3b-48da-9f61-a8dbf8ac6c27,(ITEMROOT)BOOK_LOW_BlushingMermaid_HagsInformantNote_NoMayrina_974a42f2-00a9-4753-ac67-e5053d06b69b);
TeleportTo(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalMayrinaLeader_000_65a2aacb-639d-44e6-95a9-46f53a678a5e,S_LOW_HagSurvivors_MarkerTrigger_f6ba1d1c-b75b-49ce-a006-198868ffc375);
TeleportTo(BOOK_LOW_AuntieEthelsRevenge_MayrinaContactLetter_000_d7f96c98-1b5b-407a-948d-0253d951caf4,S_LOW_HagSurvivors_MarkerTrigger_f6ba1d1c-b75b-49ce-a006-198868ffc375);
TeleportTo(S_LOW_HagSurvivors_MayrinasNote_95c84ab5-1eed-4c0f-950a-89b8862d229c,S_LOW_HagSurvivors_MarkerTrigger_f6ba1d1c-b75b-49ce-a006-198868ffc375);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalMayrinaLeader_000_65a2aacb-639d-44e6-95a9-46f53a678a5e,0);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_MayrinaContactLetter_000_d7f96c98-1b5b-407a-948d-0253d951caf4,0);
PROC_SetOnStage(S_LOW_HagSurvivors_MayrinasNote_95c84ab5-1eed-4c0f-950a-89b8862d229c,0);
PROC_SetOnStage(BOOK_LOW_AuntieEthelsRevenge_AdrielleJournalNoMayrina_000_eb73d969-cb4d-4510-8010-4d05fa9f696c,1);

PROC
PROC_LOW_ClearMayrinaPresentHagReadables_Internal((ITEMROOT)_MayrinaPresentTemplate,(GUIDSTRING)_Container,(ITEMROOT)_NoMayrinaTemplate)
AND
TemplateIsInInventory(_MayrinaPresentTemplate,_Container,1)
THEN
TemplateRemoveFrom(_MayrinaPresentTemplate,_Container,1);
TemplateAddTo(_NoMayrinaTemplate,_Container,1);
//END_REGION

//REGION GUS-304394
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_CurrentLevel("END_Main")
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_BarcusIsLeader_2feaf431-1f1d-d951-7b4f-daa744985a46)
AND
DB_LOW_SteelWatchFoundry_DisappearAfterLongRest(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
IsOnStage(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, 1)
THEN
PROC_SetOnStage(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, 0);
NOT DB_LOW_SteelWatchFoundry_DisappearAfterLongRest(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf);
DB_BUGFIX_Marker("GUS-304394");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
NOT DB_CurrentLevel("END_Main")
AND
DB_GlobalFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_BarcusIsLeader_2feaf431-1f1d-d951-7b4f-daa744985a46)
THEN
ClearFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98);
DB_BUGFIX_Marker("GUS-304394");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("END_Main")
AND
DB_GlobalFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98)
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_BarcusIsLeader_2feaf431-1f1d-d951-7b4f-daa744985a46)
AND
NOT DB_GlobalFlag(END_GatherYourAllies_State_BeyondHirelings_7b3f93f8-274d-4803-a9bc-5023590c91c4)
AND
NOT QRY_AnyPlayerInTrigger(S_END_PartyMemberTeleport_b8d5ff34-ccc2-425c-a712-172497273dc0)
THEN
ClearFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98);
PROC_SetOnStage(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, 0);
DB_BUGFIX_Marker("GUS-304394");

//END_REGION GUS-304394

//REGION GUS-304175

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_WaterQueensHouse_ApplyPatchWhenInLowerCity("GUS-304175");

IF
DB_LOW_WaterQueensHouse_ApplyPatchWhenInLowerCity("GUS-304175")
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_WaterQueensHouse_ApplyPatchWhenInLowerCity("GUS-304175");
PROC_LOW_WaterQueensHouse_ApplyPatchForWaveservantsReturn();

PROC
PROC_LOW_WaterQueensHouse_ApplyPatchForWaveservantsReturn()
AND
DB_GlobalFlag((FLAG)LOW_WaterQueensHouse_State_ReturnedFromIronThrone_e20263a4-359c-4454-aa07-76823cdbfe5e)
AND
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn(_Waveservant, _Spot)
AND
DB_PermaDefeated(_Waveservant)
THEN
PROC_SetOnStage(_Waveservant, 0);

PROC
PROC_LOW_WaterQueensHouse_ApplyPatchForWaveservantsReturn()
AND
DB_GlobalFlag((FLAG)LOW_WaterQueensHouse_State_ReturnedFromIronThrone_e20263a4-359c-4454-aa07-76823cdbfe5e)
AND
DB_GlobalFlag((FLAG)LOW_BellyOfTheBeast_Event_WaveservantsTurnHostile_75616c87-a135-430a-870c-fbbec5951736)
AND
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn(_Waveservant, _Spot)
AND
NOT DB_PermaDefeated(_Waveservant)
AND
QRY_OnlyOnce("LOW_WaterQueensHouse_WaveservantsBack")
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_WaterQueensHouse_Waveservants_65b74fbb-f418-4ed4-8681-c396c54dfc5d, 0);

PROC
PROC_LOW_WaterQueensHouse_ApplyPatchForWaveservantsReturn()
AND
DB_LOW_WaterQueensHouse_WaveservantAttackersReturn(_Waveservant, _)
THEN
SetFaction(_Waveservant, (FACTION)ACT3_LOW_WaterQueensHouse_Waveservants_65b74fbb-f418-4ed4-8681-c396c54dfc5d);
SetCombatGroupID(_Waveservant, "738f3f72-fe83-fee1-6ff5-ea36126d2bed");

PROC
PROC_LOW_WaterQueensHouse_ApplyPatchForWaveservantsReturn()
AND
DB_GlobalFlag((FLAG)LOW_WaterQueensHouse_State_ReturnedFromIronThrone_e20263a4-359c-4454-aa07-76823cdbfe5e)
THEN
DB_Dialogs((CHARACTER)S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8, (DIALOGRESOURCE)LOW_WaterQueensHouse_AllandraGrey_a6d65561-469f-e63f-a2a2-1c0c0ed8f43c);

//END_REGION

//REGION GUS-300376, GUS-301562
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-300376");
DB_BUGFIX_Marker("GUS-301562");
DB_GiveItemToEvent(S_LOW_FireworksHouse_FreeSampleDetonation_090693ce-7ed1-41b8-aec2-34634c67a732, (FLAG)LOW_FireworksHouse_Event_GiveFreeSample_284c52a5-503f-4827-a4a6-db820c2119e4);
DB_GiveItemToEvent(S_LOW_FireworksHouse_FreeSampleSmokepowder_03979e25-df90-47e6-8a7c-df37bd6a6d9d, (FLAG)LOW_FireworksHouse_Event_GiveFreeSample_284c52a5-503f-4827-a4a6-db820c2119e4);
DB_GiveItemToEvent(S_LOW_FireworksHouse_FreeSampleBomb_a04bc730-aa36-4acb-abcc-aa51cdfa7331, (FLAG)LOW_FireworksHouse_Event_GiveFreeSample_284c52a5-503f-4827-a4a6-db820c2119e4);
NOT DB_GiveItemToEvent(S_LOW_FireworksHouse_FreeSamplePlaceholder_159ed7a1-7884-4c99-bb8b-8d26da281b87, (FLAG)LOW_FireworksHouse_Event_GiveFreeSample_284c52a5-503f-4827-a4a6-db820c2119e4);

IF
LevelGameplayStarted("CTY_Main_A", _)
AND
NOT QRY_SaveGamePatches_FireworksHouse_AnyPlayerHasSamples()
AND
QRY_OnlyOnce("LOW_FireworksHouse_GiveAveryNewTreasures")
THEN
ToInventory(S_LOW_FireworksHouse_FreeSampleDetonation_090693ce-7ed1-41b8-aec2-34634c67a732, S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7, 1, 0, 1);
ToInventory(S_LOW_FireworksHouse_FreeSampleSmokepowder_03979e25-df90-47e6-8a7c-df37bd6a6d9d, S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7, 1, 0, 1);
ToInventory(S_LOW_FireworksHouse_FreeSampleBomb_a04bc730-aa36-4acb-abcc-aa51cdfa7331, S_LOW_FireworksHouse_AverySonshal_21359690-36ec-43d3-bfed-98c24f523fc7, 1, 0, 1);

QRY
QRY_SaveGamePatches_FireworksHouse_AnyPlayerHasSamples()
AND
DB_Players(_Player)
AND
GetFlag(LOW_FireworksHouse_Event_GiveFreeSample_284c52a5-503f-4827-a4a6-db820c2119e4, _Player, 1)
THEN
DB_NOOP(1);

//END_REGION GUS-300376, GUS-301562

//REGION

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
THEN
DB_DropMutingStatussesDialog(WYR_AnsurGhost_HelmetPickup_7fe755b8-967a-f495-7e06-de5d4122960e);
DB_BUGFIX_Marker("GUS-302268");
//END_REGION

//REGION GUS-304030
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_END_ToMorphicPool_BoatUser(_Player)
THEN
NOT DB_END_ToMorphicPool_BoatUser(_Player);
DB_BUGFIX_Marker("GUS-304030");
//END_REGION GUS-304030

//REGION GUS-303429
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_PermaDefeated(S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c)
THEN
SetFlag(LOW_Elfsong_State_AlfiraPermaDefeated_40cc6764-685b-4abd-ac41-ce20055c8d91);
DB_BUGFIX_Marker("GUS-303429");
//END_REGION GUS-303429

//REGION GUS-303746
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagInBaldursGate_68d1731c-7a20-4692-a093-5aa39b69d211)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369)
AND
GetHitpoints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,0)
THEN
DB_LOW_FixHagBuggedHP(1);

IF
DB_LOW_FixHagBuggedHP(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_FixHagBuggedHP(1);
DB_BUGFIX_Marker("GUS-303746");
SetHitpointsPercentage(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,100.0);
DB_LOW_HagEscapesOnBuggedHPRestored(1);

IF
HitpointsChanged(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_)
AND
DB_LOW_HagEscapesOnBuggedHPRestored(1)
AND
GetHitpoints(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d,_HP)
AND
_HP > 0
THEN
NOT DB_LOW_HagEscapesOnBuggedHPRestored(1);
PROC_LOW_HagEscapesOnBuggedHPRestored();

PROC
PROC_LOW_HagEscapesOnBuggedHPRestored()
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRevealed_aa751f69-f448-1436-c243-eb9f06a060ca)
THEN
PROC_LOW_HagRetreatsToOrlop();
//END_REGION

//REGION GUS-301261

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_OskarsBeloved_State_ArtistLeftHideout_76dca7be-5c6a-4444-afa4-3ae4b13d6315)
THEN
DB_LOW_OskarsBeloved_HauntedObjectsToRemove(FUR_GEN_Wardrobe_B_f0e3b11c-bf4a-4a2a-b053-d5feefb04d5e);
DB_LOW_OskarsBeloved_HauntedObjectsToRemove(FUR_GEN_House_Sofa_Rich_B_915b17b9-b4c0-46ca-8aec-2153ce901b14);
DB_LOW_OskarsBeloved_HauntedObjectsToRemove(LTS_DUN_Candles_A_Gold_001_95e43368-3bfc-44e7-9803-eb3927c72491);
DB_LOW_OskarsBeloved_HauntedObjectsToRemove(LTS_DUN_Candles_A_Gold_0b5e3af9-24fd-4149-9bf3-f7e2b3a706d9);
DB_LOW_OskarsBeloved_HauntedObjectsToRemove(LTS_DUN_Candles_A_Gold_67cbc249-7114-4480-a23d-cccd8378671b);
DB_LOW_OskarsBeloved_HauntedObjectsToRemove(LTS_DUN_Candles_A_Gold_79ebc978-1d9e-446c-ad9d-73111e495eea);
DB_LOW_OskarsBeloved_HauntedObjectsToRemove(DEC_GEN_Incense_B_ea418537-99bf-43ad-ba66-5a38670f12a5);
DB_LOW_OskarsBeloved_HauntedObjectsToRemove(LTS_DUN_Candles_A_Gold_ebf08e25-4676-4858-9f6b-d2e1b524c704);
DB_BUGFIX_Marker("GUS-301261");

IF
DB_LOW_OskarsBeloved_HauntedObjectsToRemove(_Item)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_SetOnStage(_Item, 0);
NOT DB_LOW_OskarsBeloved_HauntedObjectsToRemove(_Item);

//END_REGION GUS-301261

//REGION GUS-301582
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Event_SendHeartToChest_c3117ba0-ab0c-40f1-a73a-516af03c44a6)
THEN
QuestUpdate("LOW_PhilgravesMansion", "Carrion_GaveJar");
QuestUpdate("LOW_PhilgravesMansion", "HeartGiven");
DB_BUGFIX_Marker("GUS-301582");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_Event_SendHeartToChest_c3117ba0-ab0c-40f1-a73a-516af03c44a6)
THEN
DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_Event_SendHeartToChest_c3117ba0-ab0c-40f1-a73a-516af03c44a6, "LOW_PhilgravesMansion", "Carrion_GaveJar");
DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_Event_SendHeartToChest_c3117ba0-ab0c-40f1-a73a-516af03c44a6, "LOW_PhilgravesMansion", "HeartGiven");
NOT DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_Event_SetJarsToChest_98b9ea3e-835d-4cfe-8dca-def8b48affcb, "LOW_PhilgravesMansion", "Carrion_GaveJar");
NOT DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_Event_SetJarsToChest_98b9ea3e-835d-4cfe-8dca-def8b48affcb, "LOW_PhilgravesMansion", "HeartGiven");
DB_BUGFIX_Marker("GUS-301582");

//END_REGION GUS-301582

//REGION GUS-302986

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_JaheirasHouse_CheckSonForPin(1);

IF
DB_LOW_JaheirasHouse_CheckSonForPin(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
IsOnStage(S_LOW_JaheirasHouse_YoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c, 0)
AND
IsInInventoryOf(S_LOW_JaheirasHouse_JaheiraHarperPin_0897e01c-6f5f-484e-b10b-9dd772f11d1a, S_LOW_JaheirasHouse_YoungestSon_0d760747-8fab-414e-8ccc-a925ebb6da2c, 1)
THEN
NOT DB_LOW_JaheirasHouse_CheckSonForPin(1);
ToInventory(S_LOW_JaheirasHouse_JaheiraHarperPin_0897e01c-6f5f-484e-b10b-9dd772f11d1a, FUR_GEN_Wardrobe_B_000_2478aeb9-6a0c-4716-a95d-78c2b4766efe, 1, 0, 1);
DB_BUGFIX_Marker("GUS-302986");

//END_REGION GUS-302986

//REGION GUS-291914
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "Figaro")
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
THEN
NOT DB_GLO_DieFlag(LOW_SerialKiller_Event_DolorKillsFigaro_f0d3cf6c-3139-f174-b286-7f952381469f, (CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, DEATHTYPE.DoT, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
DB_GLO_DieFlag(LOW_SerialKiller_Event_DolorKillsFigaro_f0d3cf6c-3139-f174-b286-7f952381469f, (CHARACTER)S_LOW_Figaro_3ff2b7ea-3de2-4bdc-a600-c973f290bc09, DEATHTYPE.Physical, S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);
DB_BUGFIX_Marker("GUS-291914");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "Figaro")
AND
NOT DB_Is_InCombat(S_LOW_SerialKiller_Figaro_Doppelganger_001_a4f560e6-8869-4316-a674-aee94da4cee0, _)
AND
NOT DB_Defeated(S_LOW_SerialKiller_Figaro_Doppelganger_001_a4f560e6-8869-4316-a674-aee94da4cee0)
THEN
TeleportTo(S_LOW_SerialKiller_Figaro_Doppelganger_001_a4f560e6-8869-4316-a674-aee94da4cee0, S_LOW_DoppelgangerTrigger_001_Patch_4acd7a14-5b11-402d-9e1c-1ad0d3edd0a1, "", 0, 0, 0, 0, 1);
DB_BUGFIX_Marker("GUS-291914");
//END_REGION GUS-291914

//REGION GUS-302351
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
NOT DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_State_DestroyedNonHeartJar_0b8a48a7-b093-4ac2-a4b1-502e9b5dad31, "LOW_PhilgravesMansion", "NonHeartJarDestroyed");
NOT DB_QuestDef_State((FLAG)LOW_PhilgravesMansion_State_GrabbedFirstJarOtherThanHeart_6e4cb103-051d-4164-8c0a-84af4b2a3bff, "LOW_PhilgravesMansion", "LootedNonHeartJar");
DB_BUGFIX_Marker("GUS-302351");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "AncientLair_Explore")
THEN
DB_LOW_PhilgravesMansion_EnteredLair(1);
DB_BUGFIX_Marker("GUS-302351");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
DB_LOW_PhilgravesMansion_CarrionCombat(_)
THEN
QuestUpdate("LOW_PhilgravesMansion", "DealFellThrough");
DB_BUGFIX_Marker("GUS-302351");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
AND
QRY_LOW_PhilgravesMansion_CheckIfAlreadySeenHeart()
THEN
DB_LOW_PhilgravesMansion_HasSeenHeart(1);
DB_BUGFIX_Marker("GUS-302351");

QRY
QRY_LOW_PhilgravesMansion_CheckIfAlreadySeenHeart()
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_PhilgravesMansion_State_HasHeart_22154967-9777-4149-bbae-216409fea025, _Player,1)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("LOW_PhilgravesMansion", "LootedHeart")
THEN
DB_NOOP(1);

QRY
QRY_LOW_PhilgravesMansion_CheckIfAlreadySeenHeart()
AND
DB_GlobalFlag((FLAG)LOW_Thrumbo_Event_TeleportJarFromThrumbo_504e5385-96bd-4215-85de-22b81374382c)
THEN
DB_NOOP(1);
//END_REGION GUS-302351

//REGION GUS-302891
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_ApplySaveGamePatches_GUS_302891(1);

IF
DB_ApplySaveGamePatches_GUS_302891(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_SteelWatchFoudnry_WreckedWatcher(S_LOW_DestroyedWatcher_90398afc-adde-4c0c-a081-b09d182730b5);
DB_SteelWatchFoundry_WreckedWatcher_Onlookers(S_LOW_DestroyedWatcher_Onlooker01_5557a7bb-e153-408b-bb48-8bd648d84384);
DB_SteelWatchFoundry_WreckedWatcher_Onlookers(S_LOW_DestroyedWatcher_Onlooker02_3f54125c-5082-4f9b-8f15-4f90550ed3b2);
DB_SteelWatchFoundry_WreckedWatcher_Onlookers(S_LOW_DestroyedWatcher_Onlooker03_59d3bc11-ac88-4ad5-b0ac-cc07279898fd);
DB_SteelWatchFoundry_WreckedWatcher_Onlookers(S_LOW_DestroyedWatcher_Onlooker04_c440f859-b735-4241-a84a-a20f72048730);
DB_SteelWatchFoundry_WreckedWatcher_Onlookers(S_LOW_DestroyedWatcher_Onlooker05_b1f49ec0-4bd5-4881-9ea3-6598e4c9f98a);


//END_REGION GUS-302891

//REGION GUS-304584
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_State_Current(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "Finished")
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
AND
NOT DB_Defeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
NOT DB_GlobalFlag((FLAG)CAMP_Ravengard_State_RavengardInCamp_37309008-04cf-493c-8ca6-43034d331a8a)
THEN
RemoveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_PRISONER_RAVENGARD", NULL_00000000-0000-0000-0000-000000000000);
CharacterGiveEquipmentSet((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "EQP_GLO_Longsword_Shield_Plate_Ravengard");
PROC_LOW_IronThrone_MoveRavengardToCamp();
DB_BUGFIX_Marker("GUS-304584");
//END_REGION

//REGION GUS-300584
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_PermaDefeated(S_LOW_CoffinMaker_e78e15fe-f131-49b3-8b88-87b33cebf694)
AND
DB_GlobalFlag(LOW_KurwinCoffin_State_CoffinBeingMade_f7f8b7fc-7f7b-091f-fdf8-8b078e71d519)
THEN
PROC_GlobalClearFlagAndCache(LOW_KurwinCoffin_State_CoffinBeingMade_f7f8b7fc-7f7b-091f-fdf8-8b078e71d519);
DB_BUGFIX_Marker("GUS-300584");
//END_REGION

//REGION GUS-304662
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_ApplySavegamePatches_GUS_304662(1);
DB_BUGFIX_Marker("GUS-304662");

IF
DB_ApplySavegamePatches_GUS_304662(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_SteelWatchFoundry_DeadMansSwitches(_Baneite, _, _)
AND
_Baneite != NULL_00000000-0000-0000-0000-000000000000
AND
GetItemByTemplateInInventory((ITEMROOT)QUEST_LOW_DeadMansSwitch_Shield_10d9e4a8-8019-47a9-88e3-dac74f7b8ae5, _Baneite, _EquipableSwitch)
THEN
SetCanBePickpocketed(_EquipableSwitch, 0);
NOT DB_ApplySavegamePatches_GUS_304662(1);
//END_REGION GUS-304662

//REGION GUS-298865
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
SetCanTrade((CHARACTER)S_GLO_Cazador_2f1880e6-1297-4ca3-a79c-9fabc7f179d3, 0);
DB_BUGFIX_Marker("GUS-298865");
//END_REGION

//REGION GUS-304714
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_PreventKnockedOutPermaDefeated((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_CantCarveOutVanra_860c8e13-f2e6-4939-ace9-56cac5ae3626)
THEN
DB_BUGFIX_Marker("GUS-304714");
DB_PreventKnockedOutPermaDefeated((CHARACTER)S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
PROC_LOW_BUGFIX_ReassignSavingVanraDialogToHag();

PROC
PROC_LOW_BUGFIX_ReassignSavingVanraDialogToHag()
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_AllHagShroomsDefeated_20d9c78c-6f9d-4de8-8ee1-cdc13206ae33)
AND
DB_KnockedOut(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d)
THEN
NOT DB_PermaDefeated(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d);
DB_Dialogs(S_HAG_Hag_c457d064-83fb-4ec6-b74d-1f30dfafd12d, (DIALOGRESOURCE)LOW_BlushingMermaid_SavingVanra_9876ad52-05a5-2c96-ad9f-90372661b2d3);
//END_REGION

//REGION GUS-304471
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
PROC_LOW_KotS_CheckGateMastersDefeated();
PROC_LOW_KotS_RestartIfNeeded();
DB_BUGFIX_Marker("GUS-304471");

PROC
PROC_LOW_KotS_CheckGateMastersDefeated()
AND
NOT DB_PermaDefeated(S_LOW_Elfsong_GithyankiShield_GateMaster_001_f9cf10cf-0901-4568-bc95-2a09cb3228f0)
THEN
DB_LOW_Elfsong_GithyankiGateMasters((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_001_f9cf10cf-0901-4568-bc95-2a09cb3228f0, (ITEM)S_LOW_Elfsong_Basement_Portal_002_dbe864c5-0569-478d-b537-f6477b5e2180, (TRIGGER)S_LOW_Elfsong_Basement_PortalPoint_002_74e3e3b4-74c0-4541-ab84-b90df014ff6a);

PROC
PROC_LOW_KotS_CheckGateMastersDefeated()
AND
NOT DB_PermaDefeated(S_LOW_Elfsong_GithyankiShield_GateMaster_002_cd381392-a5fd-48e6-9b63-4d201ff0004c)
THEN
DB_LOW_Elfsong_GithyankiGateMasters((CHARACTER)S_LOW_Elfsong_GithyankiShield_GateMaster_002_cd381392-a5fd-48e6-9b63-4d201ff0004c, (ITEM)S_LOW_Elfsong_Basement_Portal_003_5e52b392-9074-4a63-a695-d6949d0e4d58, (TRIGGER)S_LOW_Elfsong_Basement_PortalPoint_003_ccb2ec84-5948-4237-9fa2-7e74d09e477c);

//END_REGION GUS-304471

//REGION GUS-304776
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
NOT DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83, "LOW_FindBhaalTemple", "MurderTribunal_BhaalTempleEntering_DU", 1, (FLAG)LOW_BhaalTemple_MainDoor_UserShortcut_a5498cc9-43eb-4b1f-b88c-16a593a7b75d);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)LOW_BhaalTemple_Event_OpenedMainDoor_6f6497c1-6254-46ad-a3e9-46fcd0909b83, "LOW_FindBhaalTemple", "MurderTribunal_BhaalTempleEntering", 0, (FLAG)LOW_BhaalTemple_MainDoor_UserShortcut_a5498cc9-43eb-4b1f-b88c-16a593a7b75d);
NOT DB_QuestDef_State((FLAG)LOW_BhaalTemple_MainDoor_UserShortcut_a5498cc9-43eb-4b1f-b88c-16a593a7b75d, "LOW_FindBhaalTemple", "UnholyAssassin_SkipQuestAfterStartedDU");
//END_REGION GUS-304776

//REGION GUS-304883
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LOW_HagShroomsDefeated(_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369)
AND
DB_OnlyOnce("LOW_HagRetreatsDueToShroomDefeated_OnlyOnce")
AND
QRY_OnlyOnce("LOW_BUGFIX_HagRetreatsToCellarDueToDefeatedShroom_OnlyOnce")
THEN
DB_LOW_BUGFIX_HagRetreatsToCellarDueToDefeatedShroom(1);

IF
DB_LOW_BUGFIX_HagRetreatsToCellarDueToDefeatedShroom(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-304883");
NOT DB_LOW_BUGFIX_HagRetreatsToCellarDueToDefeatedShroom(1);
PROC_LOW_ShroomDestroyedBeforeHagRetreat();
//END_REGION

//REGION GUS-300058

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_LOW_SorcerousSundries_NSNotices(_)
THEN
NOT DB_LOW_SorcerousSundries_NSNotices((ITEM)S_LOW_NightsongPamphlet_000_40ad72cb-ae54-4b45-a4ce-d9c85d61611d);
NOT DB_LOW_SorcerousSundries_NSNotices((ITEM)S_LOW_NightsongPamphlet_001_ff7fa76b-a555-4c37-a32a-e4834153a6cf);
NOT DB_LOW_SorcerousSundries_NSNotices((ITEM)S_LOW_NightsongPamphlet_002_8202b31a-1b30-4b4d-a457-fe47f1201a15);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
QRY_QuestUpdateIsUnlockedForAny("SHA_Nightsong", "NightsongSawPoster")
THEN
SetFlag((FLAG)GLO_AdventurersQuest_Knows_AboutBounty_93fcf273-334d-7aa8-d5c1-a4d154f0fe23);
SetFlag((FLAG)LOW_SorcerousSundries_Knows_AboutLorroakanGoingAfterNightsong_06fc1554-756a-4d3f-8560-5848313210fa);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
THEN
NOT DB_QuestDef_State((FLAG)LOW_SorcerousSundries_State_NightsongCaged_d9739530-c72a-4ad8-96f0-7ec71bbcfd98, "SHA_Nightsong", "GaveToWizard");
DB_QuestDef_State((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662, "SHA_Nightsong", "GaveToWizard");
DB_QuestDef_State((FLAG)LOW_Lorroakan_State_BelievesNightsongIsDead_8aee8177-d2f2-48f0-947b-8c33892152b8, "SHA_Nightsong", "LorroakanBelievedLies");
NOT DB_QuestDef_State((FLAG)LOW_SorcerousSundries_Lorroakan_KnowsNSGone_9410fa72-28f1-9175-6627-f326be005569, "SHA_Nightsong", "LorroakanLiedTo");
PROC_LOW_SorcerousSundries_SCLPatchJournal();
DB_BUGFIX_Marker("GUS-300058");

PROC
PROC_LOW_SorcerousSundries_SCLPatchJournal()
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662)
THEN
QuestUpdate("SHA_Nightsong", "GaveToWizard");

PROC
PROC_LOW_SorcerousSundries_SCLPatchJournal()
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_BelievesNightsongIsDead_8aee8177-d2f2-48f0-947b-8c33892152b8)
THEN
QuestUpdate("SHA_Nightsong", "LorroakanBelievedLies");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_QuestIsOpened("SHA_Nightsong")
THEN
PROC_LOW_SorcerousSundries_CTYPatchJournal();
DB_BUGFIX_Marker("GUS-300058");

PROC
PROC_LOW_SorcerousSundries_CTYPatchJournal()
AND
DB_GlobalFlag((FLAG)LOW_Nightsong_Event_GoToRamazithTower_59fab159-060f-424c-9fd9-43cc00a88db9)
THEN
QuestUpdate("SHA_Nightsong","NightsongLeft");

PROC
PROC_LOW_SorcerousSundries_CTYPatchJournal()
AND
DB_OnlyOnce("LOW_SorcerousSundries_SetupAradinAttack")
THEN
QuestUpdate("SHA_Nightsong","AfterAradinAttack");
SetFlag((FLAG)GLO_AdventurersQuest_Knows_AboutBounty_93fcf273-334d-7aa8-d5c1-a4d154f0fe23);

PROC
PROC_LOW_SorcerousSundries_CTYPatchJournal()
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithLorroakan_24c45d86-9027-48cc-afdd-3e6bac7d5425)
THEN
QuestUpdate("SHA_Nightsong","NightsongHostile");

PROC
PROC_LOW_SorcerousSundries_CTYPatchJournal()
AND
GetRelation((FACTION)Act3_LOW_Lorroakan_d6228e4a-48c0-4f03-869c-606b13558f2e,Hero_a1542c81-6895-929e-4522-10ce218bb360,0)
THEN
QuestUpdate("SHA_Nightsong","LorroakanHostile");

PROC
PROC_LOW_SorcerousSundries_CTYPatchJournal()
AND
DB_LevelLoadedOnce("END_Main")
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_BelievesNightsongIsDead_8aee8177-d2f2-48f0-947b-8c33892152b8)
THEN
QuestUpdate("SHA_Nightsong","LorroakanLiedTo");

PROC
PROC_LOW_SorcerousSundries_CTYPatchJournal()
AND
DB_LevelLoadedOnce("END_Main")
AND
NOT DB_GlobalFlag((FLAG)LOW_Lorroakan_State_BelievesNightsongIsDead_8aee8177-d2f2-48f0-947b-8c33892152b8)
THEN
PROC_LOW_SorcerousSundries_UpdateNoResolution();

PROC
PROC_LOW_SorcerousSundries_CTYPatchJournal()
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_HasDoneIntroduction_e5ecf031-2f8c-4739-aabd-84e9da54d267)
THEN
QuestUpdate("SHA_Nightsong","TalkedToProjection");

//END_REGION GUS-300058

//REGION GUS-304635
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
QuestUpdateExists("LOW_FindBhaalTemple", "FoundMessage_AnointAtMurderTribunal", 0)
THEN
DB_QuestDef_State((FLAG)GLO_OrinsMessages_Event_Read_GortashKilled_c450a024-9683-4c3f-a7f1-a958555f2afb, "LOW_FindBhaalTemple", "MurderTribunal_KillTwoVictims");//Generic message to acknowledge that we already know the password to enter at the Tribunal.
DB_BUGFIX_Marker("GUS-304635");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
QuestUpdateExists("LOW_FindBhaalTemple", "FoundMessage_AnointAtMurderTribunal", 1)
AND
QuestIsClosed("LOW_FindBhaalTemple", 0)
THEN
QuestUpdate("LOW_FindBhaalTemple", "MurderTribunal_KillTwoVictims");
DB_BUGFIX_Marker("GUS-304635");

//END_REGION GUS-304635

//REGION GUS-304920
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369)
AND
DB_LOW_HagShroomsDefeated(_)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61)
THEN
DB_LOW_BUGFIX_HagBossFightAfterSidingHerOnShroomDefeated(1);

IF
DB_LOW_BUGFIX_HagBossFightAfterSidingHerOnShroomDefeated(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-304920");
NOT DB_LOW_BUGFIX_HagBossFightAfterSidingHerOnShroomDefeated(1);
PROC_LOW_HagCellarBossFightStarted();

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagBossFightStarted_20001901-b4cb-48a3-900d-50838d67de61)
THEN
DB_LOW_BUGFIX_SetHagCombatGroupOnShrooms(1);

IF
DB_LOW_BUGFIX_SetHagCombatGroupOnShrooms(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_GLO_DefeatCounter(_HagShroom,"LOW_HagResurrectionShrooms_PermaDefeated")
AND
NOT DB_Defeated(_HagShroom)
THEN
NOT DB_LOW_BUGFIX_SetHagCombatGroupOnShrooms(1);
DB_BUGFIX_Marker("GUS-304920");
SetCombatGroupID(_HagShroom,"LOW_HagBossFight");
//END_REGION

//REGION GUS-304558
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(LOW_SerialKiller_State_DevellaOnBasiliskGate_c35f72bb-834c-496a-9d02-99679c612bc2)
THEN
PROC_SpotPlayers_StopSpotting(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Figaros_DevellaSpotting");
PROC_SpotPlayers_StopSpotting(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_ElfsongTavern_DevellaSpotting");
DB_BUGFIX_Marker("GUS-304558");
//END_REGION GUS-304558


//REGION GUS-303596

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_TopicalGreetingEndCondition_LeaveTriggerSet((FLAG)TG_LOW_RaphaelDefeated_ae4475b6-f303-4187-844b-903bd40d616f, "LOW_HouseOfHope")
THEN
DB_BUGFIX_Marker("GUS-303596");
NOT DB_TopicalGreetingEndCondition_LeaveTriggerSet((FLAG)TG_LOW_RaphaelDefeated_ae4475b6-f303-4187-844b-903bd40d616f, "LOW_HouseOfHope");
DB_TopicalGreetingEndCondition_LongRest((FLAG)TG_LOW_RaphaelDefeated_ae4475b6-f303-4187-844b-903bd40d616f);

//END_REGION

//REGION GUS-304980
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2")
THEN
DB_BUGFIX_Marker("GUS-304980");
PROC_GLO_Bugfix_304980_ApplyTagToAbductee();

PROC
PROC_GLO_Bugfix_304980_ApplyTagToAbductee()
AND
DB_GlobalFlag((FLAG)GLO_OrinsAbduction_State_AbductionOccured_98dda46d-871c-4807-aced-5dc3ff5f4c2d) // abduction has occurred.
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetChar)
AND
HasActiveStatus(_TargetChar, "WYR_ORINSIMPERSONATION_KNOCKEDOUT", 1) // still has the knocked out status, therefore should still be on the temple altar.
THEN
SetTag(_TargetChar, (TAG)DOWNED_DISABLED_7095912e-fcb9-41dd-aec3-3cf7803e4b22);

//END_REGION GUS-304980

//REGION GUS-305163
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e)
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_VossWaitingForHammerInSewers_47b30289-c885-46a9-ab6e-82b5460c161d)
AND
IsOnStage((CHARACTER)S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 0)
AND
NOT DB_PermaDefeated(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
THEN
DB_LOW_ApplySavegamePatches_GUS_305163(1);
DB_BUGFIX_Marker("GUS-305163");

IF
DB_LOW_ApplySavegamePatches_GUS_305163(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_LOW_VossSewers_SetupVoss();
NOT DB_LOW_ApplySavegamePatches_GUS_305163(1);

//END_REGION GUS-305163

//REGION GUS-304411
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
SysIsActive("Act3_GLO_Backgrounds_Goals")
THEN
NOT DB_GLO_Backgrounds_ChainAfterQuestUpdate("LOW_FindBhaalTemple", "MurderTribunal_FollowMurders_Completion_SarevokValeriaDead", "Act3_FolkHero_ValeriaInvestigationCompleted");
NOT DB_GLO_Backgrounds_ChainAfterQuestUpdate("LOW_FindBhaalTemple", "MurderTribunal_KillSarevok_ValeriaAlreadyDead", "Act3_FolkHero_ValeriaInvestigationCompleted");
DB_BUGFIX_Marker("GUS-304411");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
SysIsActive("Act3_GLO_Backgrounds_Goals")
AND
NOT DB_GlobalFlag(LOW_SerialKiller_Knows_DolorIsKiller_1f1adc6a-fb17-7f58-a510-3bf96289bd56)
THEN
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_SerialKiller_Knows_DolorIsKiller_1f1adc6a-fb17-7f58-a510-3bf96289bd56, "Act3_FolkHero_ValeriaInvestigationCompleted");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
SysIsActive("Act3_GLO_Backgrounds_Goals")
AND
DB_GlobalFlag(LOW_SerialKiller_Knows_DolorIsKiller_1f1adc6a-fb17-7f58-a510-3bf96289bd56)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_FolkHero_ValeriaInvestigationCompleted");
//END_REGION GUS-304411
//REGION GUS-305192
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
PROC_SavegamePatch_GUS305192();
DB_BUGFIX_Marker("GUS-305192");

PROC
PROC_SavegamePatch_GUS305192()
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "LOW_Guildhall", "AllLeadersDead", 1)
THEN
QuestClose("LOW_Guildhall");

PROC
PROC_SavegamePatch_GUS305192()
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "LOW_Guildhall", "LeftToEND", 1)
THEN
QuestClose("LOW_Guildhall");
//END_REGION

//REGION GUS-304363
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_LOW_HouseOfGrief_GrottoEntranceFix(1);

IF
DB_LOW_HouseOfGrief_GrottoEntranceFix(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
IsOpened((ITEM)S_LOW_SecretDoor_309650e9-6013-449e-a487-6d6d348d82bd, 0)
THEN
NOT DB_LOW_HouseOfGrief_GrottoEntranceFix(1);
SetCanInteract((ITEM)S_DOOR_Invisible_A_ToGrotto_fb614206-fede-4849-969c-a2f71ab33c6a, 0);
DB_BUGFIX_Marker("GUS-304363");

//END_REGION GUS-304363

//REGION GUS-305350
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
GetFlag((FLAG)GLO_CompanionHasBeenRecruited_57c070c4-9dfb-4d61-9e7b-4111bc1df030, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba , 1)
AND
GetFlag((FLAG)Jaheira_InParty_MinscRecruited_f8f3252f-641c-42a2-b420-49d2256aaba2, NULL_00000000-0000-0000-0000-000000000000, 0)
THEN
PROC_GlobalSetFlagAndCache(Jaheira_InParty_MinscRecruited_f8f3252f-641c-42a2-b420-49d2256aaba2);
DB_BUGFIX_Marker("GUS-305350");
//END_REGION

//REGION GUS-305004
//Devella change of position on long rest
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_PermaDefeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
DB_GlobalFlag(LOW_SerialKiller_State_DevellaOnBasiliskGate_c35f72bb-834c-496a-9d02-99679c612bc2)
THEN
NOT DB_AnubisConfigs((CHARACTER)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "DefaultCharacter"); //Removing the DB entry because, on this state, the DB will be already filled with the new anubis config, but the config is not properly assigned.
PROC_LOW_SerialKiller_DevellaToBasilisk();//Just move her again because we cannot check in a proper way if she is on Basilisk Gate or not.
DB_BUGFIX_Marker("GUS-305004-DevellaFigaros");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_PermaDefeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
AND
DB_GlobalFlag(LOW_SerialKiller_State_DevellaOnBasiliskGate_c35f72bb-834c-496a-9d02-99679c612bc2)
THEN
NOT DB_AnubisConfigs((CHARACTER)S_LOW_Elfsong_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "DefaultCharacter"); //Removing the DB entry because, on this state, the DB will be already filled with the new anubis config, but the config is not properly assigned.
DB_LOW_SerialKiller_DevellaToBasiliskAfterLoad(1);
DB_BUGFIX_Marker("GUS-305004-DevellaFigaros");

//Highberry's House ritual on long rest
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_GlobalFlag(LOW_SerialKiller_State_HighberrysRitualPerformed_00c1e2ab-8752-47f1-b847-51aedc0fb189)
THEN
PROC_LOW_HighberrysHouse_PerformRitual();//Force the ritual again just in case.
DB_BUGFIX_Marker("GUS-305004-HighberrysRitual");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag(LOW_SerialKiller_State_HighberrysRitualPerformed_00c1e2ab-8752-47f1-b847-51aedc0fb189)
THEN
DB_LOW_SerialKiller_PerformRitual(1);
DB_BUGFIX_Marker("GUS-305004-HighberrysRitual");

//If Dolor kill Cora in the Wine Festival, crime scene after long rest.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(-1)
AND
DB_OnlyOnce("LOW_SerialKiller_CrimeSceneWithoutRitual")
THEN
PROC_LOW_SerialKiller_CrimeScene(-1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LOW_SerialKiller_WineFestivalADs_CurrentOrder(-1)
AND
DB_OnlyOnce("LOW_SerialKiller_CrimeSceneWithoutRitual")
THEN
DB_LOW_SerialKiller_SetupCrimeScene(-1);
//END_REGION GUS-305004

//REGION GUS-305010
//Lakrissa and Alfira on Rooftop long rest
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74)
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_State_TalkWithAlfiraLakrissaRooftopOnce_d1031d99-f9a4-4b01-ac96-6bc2619ceab6)
AND
NOT GetAnubisConfig((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, "LOW_Elfsong_Lakrissa")
THEN
DB_LOW_Elfsong_Lakrissa_WaitToLevelLoad(1);
DB_BUGFIX_Marker("GUS-305010-Lakrissa");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_Elfsong_State_LakrissaWithAlfira_3de59238-18ec-4d57-9edb-c11fae84fc74)
AND
DB_GlobalFlag((FLAG)LOW_Elfsong_State_TalkWithAlfiraLakrissaRooftopOnce_d1031d99-f9a4-4b01-ac96-6bc2619ceab6)
AND
NOT GetAnubisConfig((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, "LOW_Elfsong_Lakrissa")
THEN
PROC_SetAnubisConfig((CHARACTER)S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c, "LOW_Elfsong_Lakrissa");
DB_BUGFIX_Marker("GUS-305010-Lakrissa");

//Changing level template long rest
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT DB_LOW_Elfsong_FlagsToChangePrivateRoom(LOW_SerialKiller_Event_DevellaGoingUpperCity_5aae63f9-594f-407d-8b34-078a0b688968)
THEN
DB_LOW_Elfsong_CleanElfsongTemplate(1);
DB_BUGFIX_Marker("GUS-305010-LevelTemplate");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LOW_Elfsong_FlagsToChangePrivateRoom(LOW_SerialKiller_Event_DevellaGoingUpperCity_5aae63f9-594f-407d-8b34-078a0b688968)
THEN
PROC_LOW_Elfsong_CleanElfsongTemplate();//Force to unload/load again. If the level templates are in the right position, nothing will happen.
DB_BUGFIX_Marker("GUS-305010-LevelTemplate");
//END_REGION GUS-305010

//REGION GUS-305045
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_OnlyOnce("LOW_CountingHouse_AllGuardsTurnHostileOnLongRest_OnlyOnce")
THEN
DB_BUGFIX_Marker("GUS-305045");
DB_LOW_BUGFIX_CountingHouse_AllGuardsHostileOnLongRest(1);

IF
DB_LOW_BUGFIX_CountingHouse_AllGuardsHostileOnLongRest(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_BUGFIX_CountingHouse_AllGuardsHostileOnLongRest(1);
PROC_LOW_CountingHouse_AllGuardsHostileOnLongRest();

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_OnlyOnce("LOW_CountingHouse_PanickedClerksDisappearOnLongRest_OnlyOnce")
THEN
DB_BUGFIX_Marker("GUS-305045");
DB_LOW_BUGFIX_CountingHouse_PanickedClerksSetOffstage(1);

IF
DB_LOW_BUGFIX_CountingHouse_PanickedClerksSetOffstage(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_BUGFIX_CountingHouse_PanickedClerksSetOffstage(1);
PROC_LOW_CountingHouse_PanickedClerksSetOffstage();
//END_REGION

//REGION GUS-305141

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 1")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_OskarsBeloved_State_ArtistLeftHideout_76dca7be-5c6a-4444-afa4-3ae4b13d6315)
THEN
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_OskarsBeloved_KerriLeavesPortrait_df3a05e2-e17b-b397-8e04-9a063b38c6e5);
DB_LOW_OskarsBeloved_PrepareToCheckKerri(1);
DB_BUGFIX_Marker("GUS-305141");

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_OskarsBeloved_PrepareToCheckKerri(1)
THEN
NOT DB_LOW_OskarsBeloved_PrepareToCheckKerri(1);
PROC_LOW_OskarsBeloved_CheckFreedKerri();
DB_BUGFIX_Marker("GUS-305141");

PROC
PROC_LOW_OskarsBeloved_CheckFreedKerri()
AND
DB_LOW_OskarsBeloved_DestroyerPlayer((CHARACTER)_Player)
AND
NOT DB_PermaDefeated(S_LOW_KerriEvenfield_b7e59d50-dad4-40b3-88f7-e05d27134356)
AND
IsInTrigger(S_LOW_KerriEvenfield_b7e59d50-dad4-40b3-88f7-e05d27134356, (TRIGGER)S_LOW_AtelierRegionTrigger_0e518c99-b205-4ad7-8ce6-e05f9f37ecbe, 1)
AND
NOT DB_DialogName((DIALOGRESOURCE)LOW_OskarsBeloved_KerriLeavesPortrait_df3a05e2-e17b-b397-8e04-9a063b38c6e5, _)
THEN
PROC_LOW_OskarsBeloved_KerriDialogOrTeleport(_Player);

PROC
PROC_LOW_OskarsBeloved_KerriDialogOrTeleport((CHARACTER)_Player)
AND
IsInTrigger(_Player, (TRIGGER)S_LOW_AtelierRegionTrigger_0e518c99-b205-4ad7-8ce6-e05f9f37ecbe, 1)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_OskarsBeloved_KerriLeavesPortrait_df3a05e2-e17b-b397-8e04-9a063b38c6e5, S_LOW_KerriEvenfield_b7e59d50-dad4-40b3-88f7-e05d27134356,_Player)
THEN
DB_NOOP(1);

PROC
PROC_LOW_OskarsBeloved_KerriDialogOrTeleport((CHARACTER)_Player)
AND
IsInTrigger(_Player, (TRIGGER)S_LOW_AtelierRegionTrigger_0e518c99-b205-4ad7-8ce6-e05f9f37ecbe, 0)
AND
QRY_OnlyOnce("LOW_OskarsBeloved_KerriTeleportToBedroom")
THEN
PROC_LOW_OskarsBeloved_SendKerriToBedroom(_Player);

//END_REGION

//REGION GUS-305043
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_OnlyOnce("LOW_SavedQuenoraReturnsInPub_OnlyOnce")
AND
NOT DB_PermaDefeated(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232)
AND
IsInTrigger(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,S_LOW_BlushingMermaid_CellarTrigger_2c889517-8252-49f0-a55c-ead662b8cb3f,1)
THEN
DB_LOW_BUGFIX_PostHagQuenoraGrizly_GoesUpstairsOnLongRest(1);

IF
DB_LOW_BUGFIX_PostHagQuenoraGrizly_GoesUpstairsOnLongRest(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-305043");
NOT DB_LOW_BUGFIX_PostHagQuenoraGrizly_GoesUpstairsOnLongRest(1);
TeleportTo(S_LOW_BlushingMermaid_QuenoraGrizly_9d475536-34f0-4a6f-9191-3a635b81a232,(TRIGGER)S_LOW_BlushingMermaid_QuenoraTeleportSpot_2244ed9b-e942-49f2-85aa-465f6defaef2);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_OnlyOnce("LOW_OrphanedVanraSetup")
AND
IsInTrigger(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,S_LOW_BlushingMermaid_CellarTrigger_2c889517-8252-49f0-a55c-ead662b8cb3f,1)
THEN
DB_LOW_BUGFIX_SetupOrphanedVanraOnLongRest(1);

IF
DB_LOW_BUGFIX_SetupOrphanedVanraOnLongRest(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-305043");
NOT DB_LOW_BUGFIX_SetupOrphanedVanraOnLongRest(1);
TeleportTo(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,S_LOW_BlushingMermaid_VanraAtHome_PointTrigger_b505d617-e82c-457c-a265-0759bdb3c4b2);
SetOnStage(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,1);
DB_Dialogs(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,(DIALOGRESOURCE)LOW_BlushingMermaid_Vanra_AtHome_81cdfc4a-53e6-0a14-a3a2-5c2d647c9dc7);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_OnlyOnce("LOW_OrphanedVanraSetup")
AND
NOT DB_Dialogs(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,(DIALOGRESOURCE)LOW_BlushingMermaid_Vanra_AtHome_81cdfc4a-53e6-0a14-a3a2-5c2d647c9dc7)
THEN
DB_BUGFIX_Marker("GUS-305043");
DB_Dialogs(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,(DIALOGRESOURCE)LOW_BlushingMermaid_Vanra_AtHome_81cdfc4a-53e6-0a14-a3a2-5c2d647c9dc7);
//END_REGION
//REGION GUS-305250
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)Minsc_InParty_Discussed9FPlotDiscovery_a1d9e514-d1ba-b414-b848-01ea48f46552)
THEN
SetFlag((FLAG)LOW_Guildhall_State_MinscAskedGoGuildhall_ce3c53c9-210b-b202-b558-3304d293b120);
DB_BUGFIX_Marker("GUS-305250");
//END_REGION

//REGION GUS-304570
//If the Foundry is resolved and the player is not currently in the explosion or outcome dialogs, and none of the outcome flags are set that means the dialog was interrupted before it could be resolved -> Autoresolve
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
AND
NOT DB_DialogName(LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _)
AND
NOT DB_DialogName(LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f, _)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_GainedGondianENDSupport_1bb09a8b-001d-4b43-9f39-ba89eb3aece9)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_SidedWithGondians_60345f15-6632-482e-ac4f-8a1b77d7fc36)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Event_WulbrenCombat_b4d7b17e-3c19-3140-b91a-3eb0574e9f7d)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_SidedWithWulbren_044a290e-2835-44a8-ac0e-0a59da02a316)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_GainedIronhandENDSupport_a090a831-c695-4478-8d0d-84661deabb98)
AND
NOT DB_GlobalFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98)
THEN
DB_ApplySavegamePatches_GUS_304570(1);
DB_BUGFIX_Marker("GUS-304570");

IF
DB_ApplySavegamePatches_GUS_304570(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_ApplySavegamePatches_GUS_304570(1);
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve();
//END_REGION GUS-304570

//REGION GUS-305373
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83, (DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f);
DB_BUGFIX_Marker("GUS-305373");
//END_REGION GUS-305373

//REGION GUS-305220
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_ApplySavegamePatches_GUS_305220(1);

IF
DB_ApplySavegamePatches_GUS_305220(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_CharacterDisableAllCrimes(S_LOW_HeadlessGhost_e9af0a05-9a9b-43aa-a2bd-d5f58d84de9c);
NOT DB_ApplySavegamePatches_GUS_305220(1);
DB_BUGFIX_Marker("GUS-305220");
//END_REGION GUS-305220

//REGION GUS-305373
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GLO_CharacterCorpseDialog(S_LOW_BaniteOfficer01_db345b42-35f7-4a31-b5f4-1c4b86ebd25c, (DIALOGRESOURCE)LOW_SteelWatchFoundry_SWD_BaniteOfficer01_af1bf298-1dac-d6d9-da70-5146f89efcfe)
THEN
NOT DB_GLO_CharacterCorpseDialog(S_LOW_BaniteOfficer01_db345b42-35f7-4a31-b5f4-1c4b86ebd25c, (DIALOGRESOURCE)LOW_SteelWatchFoundry_SWD_BaniteOfficer01_af1bf298-1dac-d6d9-da70-5146f89efcfe);
//END_REGION

//REGION GUS-282651

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 1")
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_Is_WildShaped((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313)
AND
DB_LOW_SharGrotto_ViconiaCombat(_)
AND
IsImmortal((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, 1)
AND
GetHitpoints((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, _HP)
AND
_HP <= 1
AND
HasActiveStatus(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, "KNOCKED_OUT", 0)
THEN
PROC_CombatReact_RemoveCombatADs((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313);
SetFaction(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, (FACTION)ACT3_LOW_ViconiaDefeated_873c1fe1-508c-45bb-969c-e986cdab1b3e);
PROC_SetRelationMutual((FACTION)ACT3_LOW_SharCultist_SwayedCultist_6829cbb6-ef01-4423-8b12-130912ce302a, (FACTION)ACT3_LOW_ViconiaDefeated_873c1fe1-508c-45bb-969c-e986cdab1b3e, 51);
ApplyStatus(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, "LOW_SHARGROTTO_VICONIADEFEAT", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-282651");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 1")
THEN
DB_LOW_SharGrotto_ViconiaImmortalFix(1);
DB_LOW_SharGrotto_ViconiaKnockOutFix(1);

IF
DB_LOW_SharGrotto_ViconiaImmortalFix(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
IsImmortal((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, 1)
AND
HasActiveStatus(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, "KNOCKED_OUT", 1)
THEN
NOT DB_LOW_SharGrotto_ViconiaImmortalFix(1);
PROC_CombatReact_RemoveCombatADs((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313);
SetFaction(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, (FACTION)ACT3_LOW_ViconiaDefeated_873c1fe1-508c-45bb-969c-e986cdab1b3e);
PROC_SetRelationMutual((FACTION)ACT3_LOW_SharCultist_SwayedCultist_6829cbb6-ef01-4423-8b12-130912ce302a, (FACTION)ACT3_LOW_ViconiaDefeated_873c1fe1-508c-45bb-969c-e986cdab1b3e, 51);
DB_BUGFIX_Marker("GUS-282651");

IF
DB_LOW_SharGrotto_ViconiaKnockOutFix(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LOW_SharGrotto_ViconiaCombat(_)
AND
IsImmortal((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, 1)
AND
HasActiveStatus(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, "KNOCKED_OUT", 1)
THEN
NOT DB_LOW_SharGrotto_ViconiaKnockOutFix(1);
PROC_CharacterDisableAllCrimes((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313,1);
PROC_GlobalSetFlagAndCache((FLAG)LOW_Grotto_State_ViconiaDefeated_8e27eb4e-8d52-4966-8aa4-e658ff595097);
PROC_RemoveDialog(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313);
SetHitpointsPercentage(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, 10.0);
SetImmortal(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, 0);
DB_Dialogs(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, (DIALOGRESOURCE)LOW_SharGrotto_ViconiaDefeated_NoShadowheart_6c6f05fc-391a-40f8-c7c0-68bd37dd1e09);
DB_BUGFIX_Marker("GUS-282651");

IF
DB_LOW_SharGrotto_ViconiaKnockOutFix(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SharGrotto_ViconiaKnockOutFix(1);
NOT DB_LOW_SharGrotto_ViconiaImmortalFix(1);
//END_REGION GUS-282651

//REGION GUS-300554
// In Lower City a group of vampire spawns might attack you during a camp night if you have Astarion in the camp.
// They try to kidnap him, so they use non-lethal damage.
// However, if Astarion is not in the active party, then when he receives KNOCKED OUT status you cannot use HELP action on him and you cannot remove the status from him.
// After a long rest he disappears (the system that removes knocked out NPCs from the game kicks in) and his companion quest is closed as if he died. He is now in DB_PermaDefeated.
// Since PROC_Origins_CompanionLeavePermanently is not called for him, the internal state of the game is now incorrect, for example he is still in DB_PartOfTheTeam.
// Also, him ending up in DB_PermaDefeated sets RitualCannotBeCompleted flag which we don't want here.

// For Patching:
// 	Main Goal scripting now needs to remove KNOCKED_OUT status after the fight is over. It's fine to have him unconcious for the duration of the fight, since he is not in the active party.
// 	For existing savegames:
//		If the player hasn't taken a long rest yet, we need to remove the status.
//		If the player has already taken the long rest, we need to do the internal clean up by calling PROC_Origins_CompanionLeavePermanently.
//		If RitualCannotBeCompleted is set, but the player hasn't entered the Dungeon (the ritual hasn't been initialized yet) - clear it
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 2 Rev 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-300554");
PROC_GLO_Bugfix_300554_FixAstarionState();
PROC_GLO_Bugfix_300554_FixRitualCannotBeCompletedFlag();

// ambush ended, but long rest - not
PROC
PROC_GLO_Bugfix_300554_FixAstarionState()
AND
DB_Camp_QueuedNight(NIGHT_Astarion_VampireSpawnsAttack_Companion_dae7e2c4-50b1-407b-a957-55cc5df9d38a) // long rest has not ended yet
AND
DB_GlobalFlag(CAMP_VampireAmbush_State_AmbushEnded_c1ec3905-8c4a-4300-bf20-e1a136065f8a) // but the ambush has already ended and the spawns retreated
AND
HasActiveStatus((CHARACTER)S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "KNOCKED_OUT", 1)
THEN
RemoveStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "KNOCKED_OUT", NULL_00000000-0000-0000-0000-000000000000);

// both ambush and long rest ended
PROC
PROC_GLO_Bugfix_300554_FixAstarionState()
AND
DB_GlobalFlag(NIGHT_Astarion_VampireSpawnsAttack_Companion_dae7e2c4-50b1-407b-a957-55cc5df9d38a)
AND
DB_PermaDefeated(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_KnockedOut(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
AND
DB_PartOfTheTeam(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255)
THEN
PROC_Origins_CompanionLeavePermanently(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "CompanionMurdered");

PROC
PROC_GLO_Bugfix_300554_FixRitualCannotBeCompletedFlag()
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCannotBeCompleted_71cb0aae-aea2-4304-9932-4c57bf6669a8)
AND
NOT QRY_LOW_CazadorsPalace_RitualRoom_RitualWasInitialized() // if the ritual wasn't initialized - the flag needs to be cleared
THEN
ClearFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_RitualCannotBeCompleted_71cb0aae-aea2-4304-9932-4c57bf6669a8);
//END_REGION

//REGION GUS-283641
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_DockWarehouse_Fishers_SetAnubisConfig(1);

IF
DB_LOW_DockWarehouse_Fishers_SetAnubisConfig(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-283641");
NOT DB_LOW_DockWarehouse_Fishers_SetAnubisConfig(1);
PROC_SetAnubisConfig(S_LOW_FisherBrother_092b641b-7cac-4fc5-81e2-ef9f21186e67,"LOW_DockWarehouse_Fisher");
PROC_SetAnubisConfig(S_LOW_FisherSister_78b65473-f053-4eea-9501-90958df96f82,"LOW_DockWarehouse_Fisher");
//END_REGION

//REGION GUS-305826
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_FlagReactionAfterDialog((FLAG)LOW_Guildhall_Event_PickSideGuild_474bf19e-0cbe-47dd-98b1-5231e3b2f004, (DIALOGRESOURCE)LOW_Guildhall_NineFingers_ef2cc5d5-b568-918e-a1d9-f95ef3b485eb);
DB_FlagReactionAfterDialog((FLAG)LOW_Guildhall_Event_PickSideZhent_d2db099b-9bf8-4f51-bac4-cb3c1732884e, (DIALOGRESOURCE)LOW_Guildhall_NineFingers_ef2cc5d5-b568-918e-a1d9-f95ef3b485eb);
DB_FlagReactionAfterDialog((FLAG)LOW_Guildhall_Event_PickSideGuild_474bf19e-0cbe-47dd-98b1-5231e3b2f004, (DIALOGRESOURCE)LOW_Guildhall_NineFingers_OM_Minsc_DuringCoup_OOM_8ff4dc80-87cb-561c-6701-6e7431ad3d12);
DB_FlagReactionAfterDialog((FLAG)LOW_Guildhall_Event_PickSideZhent_d2db099b-9bf8-4f51-bac4-cb3c1732884e, (DIALOGRESOURCE)LOW_Guildhall_NineFingers_OM_Minsc_DuringCoup_OOM_8ff4dc80-87cb-561c-6701-6e7431ad3d12);
DB_FlagReactionAfterDialog((FLAG)LOW_Guildhall_Event_PickSideGuild_474bf19e-0cbe-47dd-98b1-5231e3b2f004, (DIALOGRESOURCE)LOW_Guildhall_NineFingers_OM_MinscJaheira_COM_CCM_OOM_OCM_db0f86d4-7c39-25e9-d2e2-7d5a5340ee27);
DB_FlagReactionAfterDialog((FLAG)LOW_Guildhall_Event_PickSideZhent_d2db099b-9bf8-4f51-bac4-cb3c1732884e, (DIALOGRESOURCE)LOW_Guildhall_NineFingers_OM_MinscJaheira_COM_CCM_OOM_OCM_db0f86d4-7c39-25e9-d2e2-7d5a5340ee27);
DB_BUGFIX_Marker("GUS-305826");
//END_REGION

//REGION GUS-305021

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LOW_SorcerousSundries_NightsongCaged(1)
THEN
DB_LOW_SorcerousSundries_ReadyToCheckCagedState(1);
DB_BUGFIX_Marker("GUS-305021");

IF
DB_LOW_SorcerousSundries_ReadyToCheckCagedState(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckCagedState(1);
PROC_SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
PROC_SetOnStage(LOW_SorcerousSundries_LorroakanSoulCage_33fab5d8-f1e3-45ad-8f62-1247f7eadd37,1);
PROC_SetOnStage(LOW_SorcerousSundries_LorroakanSoulCage_Unfinished_26101e55-e8dd-498a-b2b5-d1d26c9b9a99,0);
DB_LOW_SorcerousSundries_CheckNSCagingStatuses(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9,"LOW_SORRCEROUSSUNDRIES_INVULNERABLE");
DB_LOW_SorcerousSundries_CheckNSCagingStatuses(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_NIGHTSONG_SOULCAGE");
PROC_LOW_SorcerousSundries_PatchCagedState();

PROC
PROC_LOW_SorcerousSundries_PatchCagedState()
AND
CanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1)
THEN
PROC_CharacterFullRestore(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0);

PROC
PROC_LOW_SorcerousSundries_PatchCagedState()
AND
GetDistanceTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_LorroakanSoulCagePosition_e1e9ccf3-831a-490e-919d-1e9e7c90cfd8,_dist)
AND
_dist > 1
THEN
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_LorroakanSoulCagePosition_e1e9ccf3-831a-490e-919d-1e9e7c90cfd8);

IF
DB_LOW_SorcerousSundries_CheckNSCagingStatuses(_Entity,_Status)
AND
HasActiveStatus(_Entity,_Status,0)
THEN
ApplyStatus(_Entity,_Status,-1.0,1);

IF
DB_LOW_SorcerousSundries_CheckNSCagingStatuses(_Entity,_Status)
THEN
NOT DB_LOW_SorcerousSundries_CheckNSCagingStatuses(_Entity,_Status);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_OnlyOnce("LOW_SorcerousSundries_BringBackNSFromRamazith")
THEN
DB_LOW_SorcerousSundries_ReadyToCheckNSBack(1);

IF
DB_LOW_SorcerousSundries_ReadyToCheckNSBack(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckNSBack(1);
PROC_LOW_SorcerousSundries_PatchNSBack();
DB_BUGFIX_Marker("GUS-305021");

PROC
PROC_LOW_SorcerousSundries_PatchNSBack()
AND
DB_LOW_SorcerousSundries_NightsongGoToRamaziths(1)
AND
DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
DB_LOW_SorcerousSundries_IsobelPermaDefeatedAtCamp(1)
THEN
PROC_SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0);
PROC_SetOnStage(S_LOW_NightsongThreat_d9df0940-238f-4451-a312-d2847ee04f9a,1);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,S_LOW_SorcerousSundries_AngryNightsongAsylum_a76e7ee2-4d88-4977-977e-0dafb5f9662d);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LOW_SorcerousSundries_PlayerTalkedToIsobelPostCaging(1)
THEN
DB_LOW_SorcerousSundries_ReadyToCheckIsobelInRamazith(1);

IF
DB_LOW_SorcerousSundries_ReadyToCheckIsobelInRamazith(1)
AND
DB_CurrentLevel("BGO_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckIsobelInRamazith(1);
PROC_LOW_SorcerousSundries_CheckIsobelInBGO();
DB_BUGFIX_Marker("GUS-305021");

PROC
PROC_LOW_SorcerousSundries_CheckIsobelInBGO()
AND
IsOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,1)
AND
NOT DB_Defeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckIsobelInRamazith(1);
PROC_NotifyWhenReadyToMoveOn(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "LOW_SorcerousSundries_IsobelLeavesCamp");

IF
DB_LOW_SorcerousSundries_ReadyToCheckIsobelInRamazith(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckIsobelInRamazith(1);
PROC_LOW_SorcerousSundries_CheckIsobelInCTY();

PROC
PROC_LOW_SorcerousSundries_CheckIsobelInCTY()
AND
IsInTrigger(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,(TRIGGER)S_LOW_SorcerousSundries_RamazithTower_SUB_97975f02-0bca-4ff2-bfd1-164d2c6e5b48,0)
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckIsobelInRamazith(1);
PROC_LOW_SorcerousSundries_MoveIsobelToCTY();

PROC
PROC_LOW_SorcerousSundries_MoveIsobelToCTY()
AND
IsOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 1)
THEN
PROC_NotifyWhenReadyToMoveOn(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "LOW_SorcerousSundries_IsobelLeavesCamp");

PROC
PROC_LOW_SorcerousSundries_MoveIsobelToCTY()
AND
IsOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 0)
THEN
TeleportTo(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, LOW_IsobelDeathTriggerPosition_f7133aaf-4b01-440e-90d3-a0f9476be56f, "", 0, 0, 1);
PROC_SetOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,1);
Die(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_CorpseCleanup_Ignore((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
SetFlag((FLAG)LOW_Isobel_State_GotKilledInRamazith_a9139bad-5d46-40ef-824d-fc3a3e09a1ef);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LOW_SorcerousSundries_NightsongCaged(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098)
AND
NOT DB_GlobalFlag((FLAG)LOW_Rolan_State_IsPermadefeated_86a666c2-6453-4aa2-b9d9-9e4c0a432640)
THEN
DB_LOW_SorcerousSundries_ReadyToCheckRolanBackToShop(1);
DB_BUGFIX_Marker("GUS-305021");

IF
DB_LOW_SorcerousSundries_ReadyToCheckRolanBackToShop(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckRolanBackToShop(1);
PROC_LOW_SorcerousSundries_CheckRolanBackToShop();

PROC
PROC_LOW_SorcerousSundries_CheckRolanBackToShop()
AND
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
IsInTrigger(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TRIGGER)S_LOW_SorcerousSundries_RamazithTower_SUB_97975f02-0bca-4ff2-bfd1-164d2c6e5b48,1)
THEN
PROC_LOW_SorcerousSundries_ResetRolanAsClerk();

PROC
PROC_LOW_SorcerousSundries_ResetRolanAsClerk()
THEN
PROC_Poof(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
SetFaction(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(FACTION)ACT3_LOW_SorcerousSundries_Shop_0a2e84ee-30af-49a7-9216-935318f1eae1);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
DB_Dialogs(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(DIALOGRESOURCE)LOW_SorcerousSundries_Rolan_c6d83bfb-ed34-af42-dbff-506114212e96);
PROC_SetCustomTradeTreasure(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,"LOW_SorcerousSundries_Trade");
SetTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)ACT3_LOW_SORCEROUSSUNDRIES_VENDOR_9f66044c-876d-48cb-94c4-5b8c7a5f5d9e);
SetTag(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,(TAG)TRADER_91d5ebc6-91ea-44db-8a51-216860d69b5b);

PROC
PROC_LOW_SorcerousSundries_ResetRolanAsClerk()
AND
IsOnStage(S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2,1)
THEN
PROC_Poof(S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2);

PROC
PROC_LOW_SorcerousSundries_ResetRolanAsClerk()
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_OldClerk)
THEN
NOT DB_LOW_SorcerousSundries_CurrentMainClerk(_OldClerk);
PROC_SpotPlayers_StopSpotting(_OldClerk,"LOW_SorcerousSundries_BannedSpotting");
PROC_LOW_SorcerousSundries_SetMainClerkSpotting((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

PROC
PROC_LOW_SorcerousSundries_ResetRolanAsClerk()
THEN
DB_LOW_SorcerousSundries_CurrentMainClerk((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_LOW_SorcerousSundries_ChangeOwnershipClerk((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
TeleportTo(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b,S_LOW_RolanTeleportTo_c76eb1ca-e97e-4b27-ad8d-51e4cc4fd381,"LOW_SorcerousSundries_NewClerkTeleported");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_CorpseCleanup_Ignore((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7)
THEN
DB_CorpseCleanup_Ignore((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7);
DB_BUGFIX_Marker("GUS-305021");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
GetRelation((FACTION)Act3_LOW_SorcerousSundries_Klank_f20b4417-45a0-49c0-bcc4-cd3437909f35, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, _Relation)
AND
_Relation > 0
THEN
DB_LOW_SorcerousSundries_ReadyToCheckKlankDead(1);

IF
DB_LOW_SorcerousSundries_ReadyToCheckKlankDead(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckKlankDead(1);
PROC_LOW_SorcerousSundries_ResetKlankResurrect();

PROC
PROC_LOW_SorcerousSundries_ResetKlankResurrect()
AND
DB_Defeated((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7)
THEN
PROC_CharacterFullRestore((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7);
DB_Dialogs((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,(DIALOGRESOURCE)LOW_SorcerousSundries_Klank_04e461be-8cd3-f261-3f12-3c70eb4cd0f6);
DB_BUGFIX_Marker("GUS-305021");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_Defeated(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
AND
DB_GlobalFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92)
THEN
ClearFlag((FLAG)LOW_Aradin_State_IsAtSorcerousSundriesYelling_bdd65a61-c0fc-45d7-bf58-23ad26ea9d92);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_OnlyOnce("LOW_SorcerousSundries_RolanTakeover")
THEN
DB_LOW_SorcerousSundries_ReadyToCheckRolanTakeover(1);

IF
DB_LOW_SorcerousSundries_ReadyToCheckRolanTakeover(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckRolanTakeover(1);
PROC_LOW_SorcerousSundries_ResetRolanTakeover();
DB_BUGFIX_Marker("GUS-305021");

PROC
PROC_LOW_SorcerousSundries_ResetRolanTakeover()
THEN
NOT DB_LOW_SorcerousSundries_CustomerADs((TRIGGER)S_LOW_ClientsDiscussionTrigger_09e59061-fef3-4443-a95c-f20bd38778e6, S_LOW_Client_004_e3fa81d4-53f3-49ad-8497-18673d399a37, S_LOW_Client_005_bf5f19cd-638f-4011-ae3d-45007163c637, (DIALOGRESOURCE)LOW_SorcerousSundries_AD_ClientsDiscussion_076f1b44-cd4f-9dd6-a046-274ad99b18d5,2);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_ClientsDiscussionTrigger_09e59061-fef3-4443-a95c-f20bd38778e6);
SetOnStage(S_LOW_Client_005_bf5f19cd-638f-4011-ae3d-45007163c637,0);
SetFlag((FLAG)LOW_SorcerousSundries_State_ProdigyHasStayedAtRamazith_524ab56a-8169-4926-9105-8bcaf8c87499);
PROC_LOW_SorcerousSundries_RemovePortals();
PROC_LOW_BUGFIX_SorcerousSundries_ResetSiblings((CHARACTER)S_GLO_ProdigyBrother_d0187724-c0e2-4019-a01d-a03ee8153f1b, S_LOW_CalTeleportTo_7ae1542c-49a8-4ea5-8367-d6bf447ca6be, (DIALOGRESOURCE)LOW_SorcerousSundries_Cal_a7b72e87-7538-6a81-e7f5-3cc0710b133d);
PROC_LOW_BUGFIX_SorcerousSundries_ResetSiblings((CHARACTER)S_GLO_ProdigySister_44d09b0b-0568-456c-b18d-559a0a3f981d, S_LOW_LiaTeleportTo_12dd3da1-208a-4e74-a1de-43df549c3bcc, (DIALOGRESOURCE)LOW_SorcerousSundries_Lia_545cfc32-f63a-7e90-5965-008457f14daa);

PROC
PROC_LOW_BUGFIX_SorcerousSundries_ResetSiblings((CHARACTER)_Sibling, (GUIDSTRING)_Location, (DIALOGRESOURCE)_Dialog)
AND
IsInTrigger(_Sibling,(TRIGGER)S_LOW_SorcerousSundries_RamazithTower_SUB_97975f02-0bca-4ff2-bfd1-164d2c6e5b48,0)
THEN
PROC_LOW_SorcerousSundries_CheckSibling(_Sibling, _Location, _Dialog);
PROC_LOW_SorcerousSundries_CheckSiblingKilledInRamaziths(_Sibling, _Location);

PROC
PROC_LOW_SorcerousSundries_CheckSiblingKilledInRamaziths((CHARACTER)_Sibling, (GUIDSTRING)_Location)
AND
DB_OnlyOnce("LOW_SorcerousSundries_FreeNightsong")
AND
DB_CorpseCleanup_Ignore(_Sibling)
THEN
TeleportTo(_Sibling,_Location);
PROC_SetOnStage(_Sibling, 1);

PROC
PROC_LOW_SorcerousSundries_CheckSiblingKilledInRamaziths((CHARACTER)_Sibling, (GUIDSTRING)_Location)
AND
DB_OnlyOnce("LOW_SorcerousSundries_FreeNightsong")
AND
DB_CorpseCleanup_Ignore(_Sibling)
AND
DB_PermaDefeated(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
QRY_OnlyOnce("LOW_SorcerousSundries_ResetNSThreat")
THEN
ToInventory(S_LOW_NightsongThreat_d9df0940-238f-4451-a312-d2847ee04f9a,S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_OnlyOnce("LOW_SorcerousSundries_FreeNightsong")
THEN
PROC_LOW_SorcerousSundries_TeleportIsobelAsylum();
DB_LOW_SorcerousSundries_ReadyToCheckFreeNightsong(1);

IF
DB_LOW_SorcerousSundries_ReadyToCheckFreeNightsong(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_SorcerousSundries_ReadyToCheckFreeNightsong(1);
PROC_LOW_SorcerousSundries_FreeNightsong();
DB_BUGFIX_Marker("GUS-305021");

//END_REGION

//REGION GUS-305403
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_QuestIsOpened("SHA_Nightsong")
AND
QRY_LOW_BUGFIX_SorcerousSundries_LeftCityNoResolution()
THEN
QuestClose("SHA_Nightsong");
DB_BUGFIX_Marker("GUS-305403");

QRY
QRY_LOW_BUGFIX_SorcerousSundries_LeftCityNoResolution()
AND
QRY_QuestUpdateIsUnlockedForAny("SHA_Nightsong","LeftCityNoResolution_HeardOfBounty")
THEN
DB_NOOP(1);

QRY
QRY_LOW_BUGFIX_SorcerousSundries_LeftCityNoResolution()
AND
QRY_QuestUpdateIsUnlockedForAny("SHA_Nightsong","LeftCityNoResolution_NotHeardOfBounty")
THEN
DB_NOOP(1);

//END_REGION

//REGION GUS-304501
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_LOW_Guildhall_Bursar_GiveKeyFlag((FLAG)LOW_Guildhall_Event_GivesVault1Key_03937a99-fa05-4685-9bd4-b56a98431bbe, "LOW_Guildhall_Bursar_GiveKey1");
DB_LOW_Guildhall_Bursar_GiveKeyFlag((FLAG)LOW_Guildhall_Event_GivesVault2Key_309df2bd-b257-4794-906b-28d1886917de, "LOW_Guildhall_Bursar_GiveKey2");
DB_LOW_Guildhall_Bursar_GiveKeyFlag((FLAG)LOW_Guildhall_Event_GivesVault3Key_c8a6f94d-a215-4087-ba89-749f6d7fef81, "LOW_Guildhall_Bursar_GiveKey3");
DB_LOW_Guildhall_Bursar_GiveKeyFlag((FLAG)LOW_Guildhall_Event_GivesVault4Key_84c25628-901b-4abc-96d0-cb62649dd873, "LOW_Guildhall_Bursar_GiveKey4");
DB_LOW_Guildhall_Bursar_GiveKeyFlag((FLAG)LOW_Guildhall_Event_GivesVault5Key_cee099b7-27b0-423b-849d-911a8b77893a, "LOW_Guildhall_Bursar_GiveKey5");
DB_LOW_Guildhall_Bursar_GiveKeyFlag((FLAG)LOW_Guildhall_Event_GivesVault6Key_1a70670f-dd3f-4efa-931e-6c4e1276cbdc, "LOW_Guildhall_Bursar_GiveKey6");
DB_LOW_Guildhall_Bursar_GiveKeyFlag((FLAG)LOW_Guildhall_Event_GivesVault7Key_f4364a08-519f-4937-a2e7-70e7272f987b, "LOW_Guildhall_Bursar_GiveKey7");
DB_LOW_Guildhall_Bursar_GiveKeyFlag((FLAG)LOW_Guildhall_Event_GivesVault8Key_d95e8e3a-ad09-4b66-a253-e4a4a0638a45, "LOW_Guildhall_Bursar_GiveKey8");
DB_LOW_Guildhall_Bursar_GiveKeyFlag((FLAG)LOW_Guildhall_Event_GivesVault9Key_78daedb4-4c6f-48b6-b34a-825673cf192f, "LOW_Guildhall_Bursar_GiveKey9");
DB_BUGFIX_Marker("GUS-304501");
PROC_SavegamePatch_GUS304501_GiveMissingRewards();

PROC
PROC_SavegamePatch_GUS304501_GiveMissingRewards()
AND
DB_LOW_Guildhall_Bursar_GiveKeyFlag(_Flag, _QuestStep)
AND
GetFlag(_Flag, S_LOW_Guildhall_Bursar_f571691c-9d96-4e7c-a605-c11201021c74, 1)
THEN
QuestUpdate("HIDDEN_CTY_Boosters", _QuestStep);
//END_REGION

//REGION GUS-305290
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_CurrentLevel("CTY_Main_A")
AND
QRY_LOW_Elfsong_CheckIfGuardsOnElfsong()
THEN
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, S_LOW_Elfsong_DevellaDissapearOutOfSighTo_6f5f2ef4-4329-4d8b-a6ec-355526d969f1, "Run", 1, "");
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, S_LOW_Elfsong_DevellaDissapearOutOfSighTo_6f5f2ef4-4329-4d8b-a6ec-355526d969f1, "Run", 1, "");
DB_BUGFIX_Marker("GUS-305290");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
QRY_LOW_Elfsong_CheckIfGuardsOnElfsong()
THEN
DB_LOW_Elfsong_GuardsShouldDisappear(1);
DB_BUGFIX_Marker("GUS-305290");

IF
LevelLoaded("CTY_Main_A")
AND
DB_LOW_Elfsong_GuardsShouldDisappear(1)
THEN
NOT DB_LOW_Elfsong_GuardsShouldDisappear(1);
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, S_LOW_Elfsong_DevellaDissapearOutOfSighTo_6f5f2ef4-4329-4d8b-a6ec-355526d969f1, "Run", 1, "");
PROC_DisappearOutOfSightTo((CHARACTER)S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, S_LOW_Elfsong_DevellaDissapearOutOfSighTo_6f5f2ef4-4329-4d8b-a6ec-355526d969f1, "Run", 1, "");

QRY
QRY_LOW_Elfsong_CheckIfGuardsOnElfsong()
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","Figaro")
THEN
DB_NOOP(1);

QRY
QRY_LOW_Elfsong_CheckIfGuardsOnElfsong()
AND
DB_GlobalFlag(LOW_SerialKiller_State_DevellaOnBasiliskGate_c35f72bb-834c-496a-9d02-99679c612bc2)
THEN
DB_NOOP(1);
//END_REGION GUS-305290

//REGION GUS-268043
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_UnloadingTheBrigg_DockworkersBehaviorsPatch(1);

IF
DB_LOW_UnloadingTheBrigg_DockworkersBehaviorsPatch(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-268043");
NOT DB_LOW_UnloadingTheBrigg_DockworkersBehaviorsPatch(1);
DB_DoNotFaceDialog(S_LOW_UnloadingTheBrigg_Dockworker_02_d01f0d0a-3f2f-4c86-8bcb-92a79897bd17,(DIALOGRESOURCE)LOW_UnloadingTheBrigg_AD_Dockworker_01_Dockworker_02_Dockworker_03_1f15dba6-1450-5427-cfc5-6b9b1cdb434c);
DB_DoNotFaceDialog(S_LOW_UnloadingTheBrigg_Dockworker_03_56660521-1b82-40a2-8cba-aec5e34235d2,(DIALOGRESOURCE)LOW_UnloadingTheBrigg_AD_Dockworker_01_Dockworker_02_Dockworker_03_1f15dba6-1450-5427-cfc5-6b9b1cdb434c);
PROC_SetAnubisConfig(S_LOW_UnloadingTheBrigg_Dockworker_02_d01f0d0a-3f2f-4c86-8bcb-92a79897bd17,"LOW_UnloadingTheBrigg_Dockworker");
PROC_SetAnubisConfig(S_LOW_UnloadingTheBrigg_Dockworker_03_56660521-1b82-40a2-8cba-aec5e34235d2,"LOW_UnloadingTheBrigg_Dockworker");
TeleportToPosition(S_LOW_UnloadingTheBrigg_Dockworker_Trigger_86a04101-d245-4dae-8651-2fc98875deca,-186.0,1.0,-134.0);
PROC_CharacterMoveTo((CHARACTER)S_LOW_UnloadingTheBrigg_Dockworker_01_8c7485ca-9105-425d-be85-2a4e39ef8c51,S_LOW_UnloadingTheBrigg_Dockworker_Trigger_86a04101-d245-4dae-8651-2fc98875deca,"","Walk");
//END_REGION

//REGION GUS-306250
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
DB_BUGFIX_Marker("GUS-306250");
DB_CorpseCleanup_Ignore((CHARACTER)S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f);
PROC_LOW_BUGFIX_SetPermaDefeatedHagSpyOnStage();

PROC
PROC_LOW_BUGFIX_SetPermaDefeatedHagSpyOnStage()
AND
DB_PermaDefeated(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f)
AND
IsOnStage(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,0)
THEN
PROC_SetOnStage(S_LOW_HagSurvivors_HagSpy_0cb0a73b-1f97-4481-b320-b8fff88cfe0f,1);
//END_REGION

//REGION GUS-302632
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_CazadorsPalace_ChamberlainNotPatched(1);
DB_BUGFIX_Marker("GUS-302632");
//END_REGION

//REGION GUS-306359
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_SaveGamePatches_GUS_306359(1);

IF
DB_SaveGamePatches_GUS_306359(1)
AND
DB_CurrentLevel("CTY_MAIN_A")
THEN
PROC_TriggerRegisterForPlayers(S_LOW_InstallationRoom_ca9a227a-afc2-4dc9-9984-41e6bb8baefd);
//END_REGION GUS-306359

//REGION GUS-305022

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_LOW_PhilgravesMansion_ProcessingLairRoll(_Char)
THEN
NOT DB_LOW_PhilgravesMansion_ProcessingLairRoll(_Char);
DB_BUGFIX_Marker("GUS-305022");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_OnlyOnce("LOW_PhilgravesMansion_GetZombiesBack")
AND
NOT DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsFullyDead_683c08ad-358d-400f-8dc8-c1a93f31dcac)
THEN
DB_LOW_PhilgravesMansion_CheckZombiesBack(1);

IF
DB_LOW_PhilgravesMansion_CheckZombiesBack(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_PhilgravesMansion_CheckZombiesBack(1);
PROC_LOW_BUGFIX_CheckZombiesAfterResurrection();
DB_BUGFIX_Marker("GUS-305022");

PROC
PROC_LOW_BUGFIX_CheckZombiesAfterResurrection()
AND
NOT DB_PermaDefeated(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb)
THEN
PROC_LOW_PhilgravesMansion_KillThrumboInHouse();
PROC_LOW_PhilgravesMansion_SendZombiesToBasement();

PROC
PROC_LOW_BUGFIX_CheckZombiesAfterResurrection()
AND
DB_LOW_PhilgravesMansion_ZombieBeggars(_Zombie)
AND
QRY_LOW_PhilgravesMansion_TeleportJarIfZombieHas((CHARACTER)_Zombie)
THEN
DB_NOOP(1);

//END_REGION

//REGION GUS-306702
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_QuestDef_State(LOW_SteelWatchFoundry_State_KillSwitchKilledGondians_8930425e-fa90-41b2-a222-67eacf8753f5, "LOW_SaveGondians","AllGondiansDead_BySwitch");
DB_BUGFIX_Marker("GUS-306702");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_OnlyOnce("LOW_SteelWatchFoundry_CollarsExplode")
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("ApplySaveGamePatch_GUS-306702")
THEN
QuestUpdate(_Player, "LOW_SaveGondians","AllGondiansDead_BySwitch");
SetFlag(LOW_SteelWatchFoundry_State_KillSwitchKilledGondians_8930425e-fa90-41b2-a222-67eacf8753f5);
//END_REGION GUS-306702

//REGION GUS-304824
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)ORI_Shadowheart_State_PermaUnavailable_068b6f26-6b5e-4ad7-991b-fac10f96000d)
THEN
DB_LOW_HouseOfGrief_ShadowheartAvailableFix(1);

IF
DB_LOW_HouseOfGrief_ShadowheartAvailableFix(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_HouseOfGrief_ShadowheartAvailableFix(1);
PROC_LOW_HouseOfGrief_OpenDoor();
DB_BUGFIX_Marker("GUS-304824");
//END_REGION GUS-304824

//REGION GUS-290932
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-290932");
DB_BUGFIX_290932_TadpoleTransportRevision(1);

IF
DB_BUGFIX_290932_TadpoleTransportRevision(1)
AND
DB_ActiveLevel("CTY_Main_A")
THEN
NOT DB_BUGFIX_290932_TadpoleTransportRevision(1);
PROC_LOW_TadpoleTransport_PatchRevision();


PROC
PROC_LOW_TadpoleTransport_PatchRevision()
AND
NOT GetRelation((FACTION)ACT3_LOW_TadpoleTransport_Steelwatch_8b9df0e8-e392-4e84-a565-866bb9ad65a0, (FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, 0)
AND
NOT DB_Is_InCombat(S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab,_)
AND
NOT DB_Is_InCombat(S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7,_)
AND
NOT DB_PermaDefeated(S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab)
AND
NOT DB_PermaDefeated(S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7)
THEN
PROC_SetAnubisConfig(S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7, "LOW_TadpoleTransport_PatrollingSteelwatcher");
TeleportTo(S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, S_LOW_TadpoleTransport_Patch3_Steelwatch01Spot_d892c651-d7f8-44a8-b9fc-b8db7a095475);
TeleportTo(S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7, S_LOW_TadpoleTransport_Patch3_Steelwatch02Spot_c4e0271e-c1f5-41dc-95f0-c82002f601cf);
TeleportToPosition(S_LOW_TadpoleTransport_Steelwatch01WarningTrigger_d126257c-f206-45de-ab87-b0eb0acab775, -212.372, 3.522, -133.872);

PROC
PROC_LOW_TadpoleTransport_PatchRevision()
THEN
DB_ItemDialog_NarratorAD((ITEM)S_LOW_TadpoleTransport_WarningBoard03_dce8e4ca-c2bd-4c0d-873c-3335b7c0bd83, LOW_TadpoleTransport_AD_WarningMessage_806352da-b7f9-e521-736f-8c6eec8f5d56);

PROC
PROC_LOW_TadpoleTransport_PatchRevision()
THEN
TeleportTo(S_LOW_TadpoleTransport_WarningBoard01_a0b442a4-f3a0-424f-9d9d-045ca36a188e, (TRIGGER)S_LOW_TadpoleTransport_Patch3_WarningBoard01Spot_70e161f4-3765-4ea8-b43b-d8349176035a);
TeleportTo(S_LOW_TadpoleTransport_WarningBoard02_0170544a-a3e3-4000-9437-07f50c091c5e, (TRIGGER)S_LOW_TadpoleTransport_Patch3_WarningBoard02Spot_06e906ff-ab06-4f06-bbd6-80fb8bddbef2);

PROC
PROC_LOW_TadpoleTransport_PatchRevision()
THEN
NOT DB_SpotPlayers((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7, "LOW_TadpoleTransport_Warning02", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7,  "LOW_TadpoleTransport_Warning02", (TRIGGER)S_LOW_TadpoleTransport_Steelwatch02WarningTrigger_03fe7822-0b51-4290-a35d-b9d442df9e14);
NOT DB_SpotPlayers_Continuous((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher02_16821be0-be89-4eb1-a1dd-667c7829f1c7, "LOW_TadpoleTransport_Warning02");

PROC
PROC_LOW_TadpoleTransport_PatchRevision()
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
THEN
DB_SpotPlayers_SpotterIgnoreCantTalk((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01");
DB_SpotPlayers_TargetIgnoreCantTalk((CHARACTER)S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_Warning01");

//END_REGION

//REGION GUS-305348
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT DB_InCamp((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_Event_NSAndIsobelLeaveCamp_64a6e5df-b6a0-42ab-93b6-818bc4e2859a)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_NSReturnedFromRamazith_b7cbc725-249c-48ba-9146-6cf9292c4c0c)
THEN
PROC_LOW_SorcerousSundries_TeleportNightsongToCamp();
DB_BUGFIX_Marker("GUS-305348");

//END_REGION
//REGION GUS-305344

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_BUGFIX_305344_PutPageInDesk(1);
DB_BookFlags(S_LOW_MurderTribunal_Page_SarevokOrinMother_23faac28-99b0-4ff2-bc23-13e70921a8ad,LOW_BhaalTemple_Knows_OrinsMother_329be152-2e04-4b9c-85c6-055efad23da8);

IF
DB_BUGFIX_305344_PutPageInDesk(1)
AND
DB_ActiveLevel("CTY_Main_A")
AND
IsInInventory(S_LOW_MurderTribunal_Page_SarevokOrinMother_23faac28-99b0-4ff2-bc23-13e70921a8ad,0)
THEN
NOT DB_BUGFIX_305344_PutPageInDesk(1);
ToInventory(S_LOW_MurderTribunal_Page_SarevokOrinMother_23faac28-99b0-4ff2-bc23-13e70921a8ad,S_LOW_MurderTribunal_PrisonOfficeDesk_668c30d1-ddb8-44a4-a14f-1eb0ccebfb9c);
DB_BUGFIX_Marker("GUS-305344");

//END_REGION GUS-305344

//REGION GUS-304863

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_DeathKnightsDefeated_e7cf2480-e981-45bd-80f1-740661f49ed9)
AND
NOT DB_BUGFIX_Marker("GUS-304863")
THEN
DB_BUGFIX_304863_GiveDeathKnightsStatus(1);

IF
DB_BUGFIX_304863_GiveDeathKnightsStatus(1)
AND
DB_ActiveLevel("CTY_Main_A")
AND
DB_LOW_MurderTribunal_DeathKnights(_DeathKnight)
AND
NOT DB_Dead(_DeathKnight)
AND
HasActiveStatus(_DeathKnight,"LOW_MURDERTRIBUNAL_SOULOATH",0)
THEN
ApplyStatus(_DeathKnight,"LOW_MURDERTRIBUNAL_SOULOATH",-1.0,0,S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6);

IF
DB_BUGFIX_304863_GiveDeathKnightsStatus(1)
AND
DB_ActiveLevel("CTY_Main_A")
THEN
NOT DB_BUGFIX_304863_GiveDeathKnightsStatus(1);
DB_BUGFIX_Marker("GUS-304863");

//END_REGION GUS-304863

//REGION GUS-305393
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_SpotPlayers(_, "LOW_FireworksHouse_TopFloorAttack", _, _)
THEN
DB_BUGFIX_Marker("GUS-304824");
DB_LOW_FireworksHouse_ClearSpottingPatch(1);
DB_LOW_FireworksHouse_ImplementSpottingPatch(1);

IF
LevelGameplayStarted("CTY_Main_A", _)
AND
DB_LOW_FireworksHouse_ImplementSpottingPatch(1)
THEN
DB_TrespassTrigger((TRIGGER)S_LOW_FireworksHouse_SecureAreaTrigger_7073ae40-7fce-4999-aaa9-ca71166cf4cd, NULL_00000000-0000-0000-0000-000000000000, "LOW_FireworksHouse_TopFloorTrespass");
NOT DB_LOW_FireworksHouse_ImplementSpottingPatch(1);

IF
LevelGameplayStarted("CTY_Main_A", _)
AND
DB_LOW_FireworksHouse_ClearSpottingPatch(1)
THEN
PROC_LOW_FireworksHouse_Debug_ClearSpotting();

PROC PROC_LOW_FireworksHouse_Debug_ClearSpotting()
AND
DB_LOW_FireworksHouse_BaniteGuards(_Guard)
THEN
NOT DB_SpotPlayers(_Guard, "LOW_FireworksHouse_TopFloorAttack", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SpotPlayers_Continuous(_Guard, "LOW_FireworksHouse_TopFloorAttack");
NOT DB_SpotPlayers_SpotTrigger(_Guard, "LOW_FireworksHouse_TopFloorAttack", (TRIGGER)S_LOW_FireworksHouse_SecureAreaTrigger_7073ae40-7fce-4999-aaa9-ca71166cf4cd);
NOT DB_LOW_FireworksHouse_ClearSpottingPatch(1);

//END_REGION GUS-305393

//REGION GUS-306202
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
THEN
DB_BUGFIX_Marker("GUS-306202");
NOT DB_QuestDef_State((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b, "GLO_GatherYourAllies", "IsobelPromisesSupport");

//END_REGION GUS-306202

//REGION GUS-305068
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_BUGFIX_CountingHouse_MediumSafe02_Key_RemoveStoryProperty(1);

IF
DB_LOW_BUGFIX_CountingHouse_MediumSafe02_Key_RemoveStoryProperty(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_BUGFIX_CountingHouse_MediumSafe02_Key_RemoveStoryProperty(1);
PROC_LOW_BUGFIX_CountingHouse_MediumSafe02_Key_RemoveStoryProperty();

PROC
PROC_LOW_BUGFIX_CountingHouse_MediumSafe02_Key_RemoveStoryProperty()
AND
GetDirectInventoryOwner(LOW_CountingHouse_MediumSafe02_Key_186ecca4-3023-4433-9716-8f1752513afa,S_LOW_Prison_Rat01_7ec18c86-b069-4e60-82dd-61a0263d46f0)
THEN
DB_BUGFIX_Marker("GUS-305068");
SetStoryItem((ITEM)LOW_CountingHouse_MediumSafe02_Key_186ecca4-3023-4433-9716-8f1752513afa,0);
//END_REGION

//REGION GUS-297000
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_WYR_KillDirectorGortash_Journal_GondBooksPatched(1)
THEN
NOT DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_KnownsHowToDisableNeurocitor_0df02f4a-0d44-f355-4638-9aee2ea61fde, "WYR_GetGortashGem", "ForcedGondianLeader");
DB_WYR_KillDirectorGortash_Journal_FoundryDestroyNoPassSteps("ConvincedGondianLeader");
DB_WYR_KillDirectorGortash_Journal_FoundryDestroyNoPassSteps("GondianLeaderDied");
DB_WYR_KillDirectorGortash_Journal_FoundryDestroyNoPassSteps("ReachedCentre_HasBomb");
DB_WYR_KillDirectorGortash_Journal_FoundryDestroyNoPassSteps("LostBombCentre");
DB_WYR_KillDirectorGortash_Journal_GondBooksPatched(1);
DB_BUGFIX_Marker("GUS-297000");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_PartyMembers(_Player)
AND
NOT DB_WYR_KillDirectorGortash_Journal_UsedControlPanel(1)
AND
GetFlag(LOW_SteelFoundry_SwitchBoard_State_PassedIntelligenceCheck_cded3718-5f77-6188-b3de-80099febb121, _Player, 1)
THEN
DB_WYR_KillDirectorGortash_Journal_UsedControlPanel(1);
DB_BUGFIX_Marker("GUS-297000-B");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_LOW_SteelWatchFoundry_ReadZannersBook(1)
AND
DB_LOW_SteelWatchFoundry_ReadGondBook(1)
THEN
DB_LOW_SteelWatchFoundry_ReadBothBooks(1);
DB_BUGFIX_Marker("GUS-297000-C");
//END_REGION GUS-297000

//REGION GUS-305710
//Only fixing the journal if players started the quest with Estra and haven't loaded an article in to the printer yet
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_QuestIsOpened("LOW_StopTheGazette")
AND
DB_Avatars(_Avatar)
AND
DB_GlobalFlag(LOW_BaldursMouth_State_EttvardsBusy_fbbe9492-8c01-4600-8a33-3d69cb9aa49a)
AND
QuestUpdateIsUnlocked(_Avatar, "LOW_StopTheGazette", "JournalistStart", 1)
AND
QuestUpdateIsUnlocked(_Avatar, "LOW_StopTheGazette", "ArticleLoaded", 0)
THEN
DB_BUGFIX_Marker("GUS-305068");
QuestUpdate("LOW_StopTheGazette", "EttvardStart");

//END_REGION GUS-305710
//REGION GUS-306321

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_SpotPlayers((CHARACTER)_DeathKnight,"LOW_MurderTribunal_DeathKnight",_,_)
THEN
DB_SpotPlayers_IncludeWildshapedPlayers(_DeathKnight,"LOW_MurderTribunal_DeathKnight");
DB_SpotPlayers_TargetIgnoreCantTalk(_DeathKnight,"LOW_MurderTribunal_DeathKnight");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_SpotPlayers(_Character,"LOW_MurderTribunal_Court",_,_)
THEN
DB_SpotPlayers_IncludeWildshapedPlayers(_Character,"LOW_MurderTribunal_Court");
DB_SpotPlayers_IncludeFollowers(_Character,"LOW_MurderTribunal_Court");
DB_SpotPlayers_IncludeSummons(_Character,"LOW_MurderTribunal_Court");
DB_SpotPlayers_TargetIgnoreCantTalk(_Character,"LOW_MurderTribunal_Court");

//END_REGION GUS-306321

//REGION GUS-303698
//Remove spotting for the old way if Devella is in combat but before triggering the new approach-and-talk design for this scene.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_SpotPlayers((CHARACTER)S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Figaros_DevellaSpotting", NULL_00000000-0000-0000-0000-000000000000, LOW_Elfsong_Event_DvellaStopSpotting_5fceb72f-1060-4754-9b65-99211513aac6)
AND
DB_Is_InCombat(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, _CombatGUID)
AND
DB_LOW_SerialKiller_PlayersIncombat_Figaros(_, _CombatGUID)
THEN
PROC_SpotPlayers_StopSpotting(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81, "LOW_Figaros_DevellaSpotting");
DB_BUGFIX_Marker("GUS-303698");
//END_REGION GUS-303698

//REGION GUS-305851
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("BGO_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
NOT DB_QuestDef_State_ConditionalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e, "WYR_CazadorPalace", "Ascended_GurQuest", 1, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
NOT DB_QuestDef_State_ConditionalFlag(LOW_GurFollowUp_State_GurPermaDefeated_7e06a146-ffc8-4491-bed2-9de18acf4883, "WYR_CazadorPalace", "GurHostile_GurQuest", 1, WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0);
DB_BUGFIX_Marker("GUS-305851");
PROC_GLO_Bugfix_305851();

PROC
PROC_GLO_Bugfix_305851()
AND
DB_GlobalFlag(ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
AND
DB_GlobalFlag(WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0)
AND
DB_PermaDefeated(S_WYR_GurCamp_GurLeader_5e52cf9c-b673-45b7-888c-2c105eb4d890)
AND
QuestIsClosed("WYR_CazadorPalace", 0)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_CazadorPalace", "GurHostile_GurQuest")
THEN
QuestUpdate("WYR_CazadorPalace", "GurHostile_GurQuest");
//END_REGION

//REGION GUS-296290
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LOW_BaldursMouth_Guards(S_LOW_BaldursMouth_Guard01_a74a49eb-1406-4570-8dda-065c929a228f)
THEN
DB_LOW_BaldursMouth_Guards(S_LOW_BaldursMouth_Guard01_a74a49eb-1406-4570-8dda-065c929a228f);
DB_LOW_BaldursMouth_Guards(S_LOW_BaldursMouth_Guard02_e7da54a2-214e-4873-bb82-1c20d6922a60);
DB_LOW_BaldursMouth_Guards(S_LOW_BaldursMouth_Guard03_72ff4031-a071-40bf-9c33-16a983f18436);
DB_LOW_BaldursMouth_Guards(S_LOW_BaldursMouth_Guard04_123f1c40-3276-44e9-97ec-116d6f5b3740);
DB_LOW_BaldursMouth_Guards(S_LOW_BaldursMouth_SteelWatcher_000_e2dcd3e3-cd9e-49e0-8fe2-70af63e13530);
DB_LOW_BaldursMouth_Guards(S_LOW_BaldursMouth_SteelWatcher_001_eb02c254-d5eb-4dff-8818-579cb3f8fde8);
DB_BUGFIX_Marker("GUS-296290");

//END_REGION GUS-296290

//REGION GUS-306442
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_QuestGrenadeThrownAtHag_f2466d9f-3eca-4820-b1b2-3aa82719af35)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_CantCarveOutVanra_860c8e13-f2e6-4939-ace9-56cac5ae3626)
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT DB_DialogName((DIALOGRESOURCE)LOW_BlushingMermaid_VomitsOutVanra_Hag_10f3400d-85f0-d324-5057-c0b6bdc6366c,_)
THEN
DB_LOW_BUGFIX_TeleportVanraToHag(1);

IF
DB_LOW_BUGFIX_TeleportVanraToHag(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-306442");
NOT DB_LOW_BUGFIX_TeleportVanraToHag(1);
PROC_GlobalSetFlagAndCache((FLAG)LOW_BlushingMermaid_Event_TeleportVanraToHag_161c3a43-f4ba-4aa5-aabe-d68a68b011c8);
PROC_LOW_BUGFIX_HagRetreatsToOrlop();

PROC
PROC_LOW_BUGFIX_HagRetreatsToOrlop()
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagRetreatedToCellar_0f973681-c559-4b66-9caf-d42809059369)
THEN
PROC_LOW_HagRetreatsToOrlop();

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_Event_VanraWentToMom_895cda4f-6348-45c0-ba2e-bac1a7a1a0b2)
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_BUGFIX_SavedVanraStuckInCellar(1);

IF
DB_LOW_BUGFIX_SavedVanraStuckInCellar(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_LOW_BUGFIX_SavedVanraStuckInCellar(1);
PROC_LOW_BUGFIX_SavedVanraStuckInCellar();

PROC
PROC_LOW_BUGFIX_SavedVanraStuckInCellar()
AND
IsInTrigger(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,(TRIGGER)S_LOW_BlushingMermaid_CellarTrigger_2c889517-8252-49f0-a55c-ead662b8cb3f,1)
THEN
TeleportTo(S_LOW_BlushingMermaid_Vanra_bfeac6a6-678e-46da-b873-cf7e4c7a1e4c,S_LOW_BlushingMermaid_VanraAtHome_PointTrigger_b505d617-e82c-457c-a265-0759bdb3c4b2);
//END_REGION

//REGION GUS-291011

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag(LOW_BloodMerchant_State_ArajAsTrader_74fec4cc-4c35-a05b-1c47-af36980adca1)
THEN
QuestUpdate("HIDDEN_CTY_Boosters", "LOW_BloodMerchantLair_DrinkPotion");
DB_BUGFIX_Marker("GUS-291011");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_GlobalFlag(LOW_BloodMerchant_State_ArajAsTrader_74fec4cc-4c35-a05b-1c47-af36980adca1)
AND
NOT DB_PermaDefeated(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a)
AND
QRY_LOW_SearchClonedCharacter()
THEN
DB_QuestDef_State(LOW_BloodMerchant_State_ArajAsTrader_74fec4cc-4c35-a05b-1c47-af36980adca1, "HIDDEN_CTY_Boosters", "LOW_BloodMerchantLair_DrinkPotion");
DB_BUGFIX_Marker("GUS-291011");

//END_REGION GUS-291011

//REGION GUS-291012
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
GetFlag(LOW_Elfsong_State_PatronNecklace_HasItem_f578df4d-7592-76fb-75ca-8a4fa5f9b8c1, S_LOW_Elfsong_Exterior_Patron_001_b0acaed9-296a-409c-8064-a8aff1131013, 1)
THEN
DB_QuestDef_State(LOW_ElfsongTavern_State_BuyedNecklace_acc89a5b-7660-0922-ca72-f7fc939ee499, "HIDDEN_CTY_Boosters", "LOW_Elfsong_BuyCollar");
//The flag to check if the collar was already sold is new. There is no proper way to check if the player stole (or kill) the necklace instead of buying it.
DB_BUGFIX_Marker("GUS-291012");
//END_REGION GUS-291012

//REGION GUS-306666
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_ApplySavegamePatches_GUS_306666(1);

IF
DB_ApplySavegamePatches_GUS_306666(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_GlobalFlag(IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
THEN
NOT DB_ApplySavegamePatches_GUS_306666(1);
PROC_RemoveDialog(S_LOW_ScryScreen02_1d221b28-9a9b-482a-9ef0-4e65a0e60bc7);
PROC_SetOnStage(S_LOW_ScryScreenVFX_f77f7f74-6027-4735-8257-0a086954d2b8, 0);
PROC_SetOnStage(S_LOW_ScryScreenSparks01_a3eae668-1974-498a-bb46-94a3eb737038, 1);
PROC_SetOnStage(S_LOW_ScryScreenSparks02_efed19bb-d35a-4e79-9e05-5de6bcc61298, 1);

IF
DB_ApplySavegamePatches_GUS_306666(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_GlobalFlag(IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
THEN
NOT DB_ApplySavegamePatches_GUS_306666(1);
PROC_SetOnStage(S_LOW_ScryScreenSparks01_a3eae668-1974-498a-bb46-94a3eb737038, 0);
PROC_SetOnStage(S_LOW_ScryScreenSparks02_efed19bb-d35a-4e79-9e05-5de6bcc61298, 0);
//END_REGION GUS-306666

//REGION GUS-305877
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_PartOfTheTeam(_Player)
AND
IsTagged(_Player, FORBIDDENKNOWLEDGE_673cb6af-f12b-4d6e-abfa-1bb83cf4ce44, 0)
AND
HasPassive(_Player, "CTY_NecromancyOfThay_ForbiddenKnowledge_Passive", 1)
THEN
RemovePassive(_Player, "CTY_NecromancyOfThay_ForbiddenKnowledge_Passive");
DB_BUGFIX_Marker("GUS-305877");
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_PartOfTheTeam(_Player)
AND
IsTagged(_Player, FORBIDDENKNOWLEDGE_673cb6af-f12b-4d6e-abfa-1bb83cf4ce44, 0)
AND
HasSpell(_Player, "Target_CursedTome_WakeTheDead", 1)
THEN
RemoveSpell(_Player, "Target_CursedTome_WakeTheDead", 1);
DB_BUGFIX_Marker("GUS-305877");
//END_REGION GUS-305877

//REGION GUS-290893
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)LOW_BasiliskGate_State_MissingKidsMother_WentHome_afe097ca-04a3-43f5-82d5-80ac5de0ea4a)
AND
NOT DB_Dialogs(S_LOW_BasiliskGate_Commander_915d074c-8f6f-4f5a-ae18-fb333ce6dc29,(DIALOGRESOURCE)LOW_BasiliskGate_Commander_8aa3f06a-8f3d-da91-1974-7bed5346767a)
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-290893");
DB_Dialogs(S_LOW_BasiliskGate_Commander_915d074c-8f6f-4f5a-ae18-fb333ce6dc29,(DIALOGRESOURCE)LOW_BasiliskGate_Commander_8aa3f06a-8f3d-da91-1974-7bed5346767a);
//END_REGION

//REGION GUS-296994
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_PartOfTheTeam(_Player)
AND
DB_QuestIsOpened("WYR_GetGortashGem")
AND
GetFlag(WYR_South_State_HaveReason_3657cfaa-345d-44de-b524-489b81c1a8da, _Player, 1)
THEN
QuestUpdate("WYR_GetGortashGem", "HadSouthCheckpointScene");
DB_BUGFIX_Marker("GUS-296994");

//END_REGION GUS-296994

//REGION GUS-305592
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e)
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_VossWaitingForHammerInSewers_47b30289-c885-46a9-ab6e-82b5460c161d)
AND
NOT DB_GlobalFlag((FLAG)ORI_Laezel_State_ShowedVossTheHammer_5588f6a2-bb8c-4f91-a152-168492b9c09f)
AND
NOT DB_PermaDefeated(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
THEN
DB_LOW_ApplySavegamePatches_GUS_305592_VossDialog(1);
DB_BUGFIX_Marker("GUS-305592");

IF
DB_LOW_ApplySavegamePatches_GUS_305592_VossDialog(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_LOW_VossSewers_SetupVoss();
NOT DB_LOW_ApplySavegamePatches_GUS_305592_VossDialog(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
DB_SceneManager((CHARACTER)S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, "PLA_GithChokepoint")
THEN
PROC_SceneOver("PLA_GithChokepoint");
DB_BUGFIX_Marker("GUS-305592");
//END_REGION

//REGION GUS-304992
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_LOW_KurwinCoffin_CatacombUnlocker(S_DOOR_Invisible_A_Interior_Catacomb_Hhune_e74ec421-fa84-452e-9505-91ff992617a8, S_DOOR_CTY_Catacomb_003_1b31b073-eb3a-4b61-b307-27e5158e9f71);
DB_LOW_KurwinCoffin_CatacombUnlocker(S_DOOR_Invisible_A_Interior_Catacomb_004_407a1f6b-266f-44de-a71f-53163ea3db20, S_DOOR_CTY_Catacomb_004_55a53cd9-ab72-448f-b0bf-2a1d27da1da4);
DB_BUGFIX_Marker("GUS-304992");


//END_REGION

//REGION GUS-292109
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_LOW_StormshoreTabernacle_Offerings(_Character, _Flag)
THEN
NOT DB_LOW_StormshoreTabernacle_Offerings(_Character, _Flag);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Selune_InvisibleHelper_ba443c9b-5831-4dbb-aac0-b1dd2ec1f655, (FLAG)LOW_StormshoreTabernacle_State_SeluneOfferingGiven_3e980934-f0c3-48f8-8649-46f8d3fbbd44, (TAG)ACT3_LOW_STORMSHORETABERNACLE_SELUNE_0d41b6a9-86e8-47b4-9b5a-a779c412abb1);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Helm_InvisibleHelper_b5592938-849d-49a7-88e2-8aaa03a228ee, (FLAG)LOW_StormshoreTabernacle_State_HelmOfferingGiven_d3c2a342-f9b9-4585-b73e-f227d2ed868a, (TAG)ACT3_LOW_STORMSHORETABERNACLE_HELM_0f0a7b98-c86d-4cb6-97ec-98a5d3ec16c6);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Mystra_InvisibleHelper_c5470b50-3ab0-4d5f-b84a-ed68cdc65676, (FLAG)LOW_StormshoreTabernacle_State_MystraOfferingGiven_b0ef683c-94aa-486d-8989-7b66ee9709e8, (TAG)ACT3_LOW_STORMSHORETABERNACLE_MYSTRA_948ae667-3541-42ea-9e73-8776dc436c21);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Tyr_InvisibleHelper_edbba625-2e51-4c06-b4f3-046f8b8a94c5, (FLAG)LOW_StormshoreTabernacle_State_TyrOfferingGiven_6d6eb3d8-e021-4250-83b8-0238166daa99, (TAG)ACT3_LOW_STORMSHORETABERNACLE_TYR_4c895d50-20dc-4891-bcf3-7c25ea92af28);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Ilmater_InvisibleHelper_7c3407d9-b8f4-4643-a2e7-04b13b021581, (FLAG)LOW_StormshoreTabernacle_State_IlmaterOfferingGiven_ce9b1087-7cc5-4d0a-a505-84e7fb4d34b0, (TAG)ACT3_LOW_STORMSHORETABERNACLE_ILMATER_9a88b755-f10e-4583-8794-abacf7f61e7a);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Lolth_InvisibleHelper_e99fdd8d-1e4f-4018-901e-d8f52aeba07c,(FLAG)LOW_StormshoreTabernacle_State_LolthOfferingGiven_1d9952f6-4a66-4ca0-82eb-beabe316a708, (TAG)ACT3_LOW_STORMSHORETABERNACLE_LOLTH_1f1d7b0f-1a7e-453c-abe6-676bc7c1eefb);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Eilistraee_InvisibleHelper_b11878e1-f544-44f9-a45a-ecaef1c0a374,(FLAG)LOW_StormshoreTabernacle_State_EilitraeeOfferingGiven_8e5cb9a6-df7e-4059-bbf8-fe97957dd38d, (TAG)ACT3_LOW_STORMSHORETABERNACLE_EILISTRAEE_9bbe6247-0eac-48e6-9a3d-7e8e28e99bd7);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Oghma_InvisibleHelper_8cf6593b-1811-44ea-af71-b7dd514c3c7c,(FLAG)LOW_StormshoreTabernacle_State_OghmaOfferingGiven_bd8b310e-4568-4ae3-bc2f-0e0b9b8daa0a, (TAG)ACT3_LOW_STORMSHORETABERNACLE_OGHMA_b0c0eea0-f60a-400c-af98-204d5c7a0c4f);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Bahamut_InvisibleHelper_fb278642-6d4b-490b-89e8-7060d1ce8a37,(FLAG)LOW_StormshoreTabernacle_State_BahamutOfferingGiven_20559dad-ec94-481c-a2ca-0158fb80cc78, (TAG)ACT3_LOW_STORMSHORETABERNACLE_BAHAMUT_a3b9315c-7001-44c2-8318-e1acbacc8230);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_GarlGlittergold_InvisibleHelper_78926edb-04ce-4461-b36f-13009f9ac970,(FLAG)LOW_StormshoreTabernacle_State_GarlGlittergoldOfferingGiven_04db943a-95ad-47be-87b3-442e89ac6f3b, (TAG)ACT3_LOW_STORMSHORETABERNACLE_GARLGLITTERGOLD_1f33d6cf-ab44-42ac-8601-392fc6260ead);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Vlaakith_InvisibleHelper_8bbdf039-bad0-4faf-899e-86ac139053ac,(FLAG)LOW_StormshoreTabernacle_State_VlaakithOfferingGiven_d9b13daf-2f4f-4f5e-a582-fb506c34b75d, (TAG)ACT3_LOW_STORMSHORETABERNACLE_VLAAKITH_48c33379-1e5c-4da4-b431-502cf8e96222);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Tempus_InvisibleHelper_c3738643-0a8a-4b1f-87e8-a783f446e1dd,(FLAG)LOW_StormshoreTabernacle_State_TempusOfferingGiven_93372e61-498a-4c98-b204-e37f2ebc2f04, (TAG)ACT3_LOW_STORMSHORETABERNACLE_TEMPUS_5ecb8e6f-d8b6-4472-9083-d4ce2e5a411b);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Kelemvor_InvisibleHelper_5d25d3f1-9602-43ba-b3e3-3d516e8d4d0a,(FLAG)LOW_StormshoreTabernacle_State_KelemvorOfferingGiven_deac351c-bd77-4042-b563-7a8bdb6f5280, (TAG)ACT3_LOW_STORMSHORETABERNACLE_KELEMVOR_2499ebcb-6a85-4467-94b6-343fbf03a4b0);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Moradin_InvisibleHelper_8759ab8a-9168-4ed7-9781-24fe37213034,(FLAG)LOW_StormshoreTabernacle_State_MoradinOfferingGiven_204697f9-659b-434a-b3be-4c1c280cfda2, (TAG)ACT3_LOW_STORMSHORETABERNACLE_MORADIN_77777169-9e97-4d81-8279-4f496a42c699);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Laduger_InvisibleHelper_fcf44392-8b7a-48d5-8501-1bfc86f576bd,(FLAG)LOW_StormshoreTabernacle_State_LadugerOfferingGiven_f79f6be4-a8a9-4865-86db-d64e3f0dea9b, (TAG)ACT3_LOW_STORMSHORETABERNACLE_LADUGUER_026336a7-a2bb-4f9c-8a04-1736b773cbc4);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Tiamat_InvisibleHelper_67200b50-234c-42b1-9d72-48962e6689a7,(FLAG)LOW_StormshoreTabernacle_State_TiamatOfferingGiven_c01d75c5-f9fa-4249-a28d-146505fd7b6d, (TAG)ACT3_LOW_STORMSHORETABERNACLE_TIAMAT_27441afb-d83e-4f09-ba71-39ad40e042f5);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Mielikki_InvisibleHelper_fa765946-6f18-4af6-b76a-03f95a806cd2,(FLAG)LOW_StormshoreTabernacle_State_MielikkiOfferingGiven_cd5700ab-79d1-4f6d-aaff-573ca8cd2da5, (TAG)ACT3_LOW_STORMSHORETABERNACLE_MIELIKKI_c1f482d7-bfac-4f67-b688-510982992359);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Gruumsh_InvisibleHelper_0a7b3a41-e3ee-40ee-96a0-6ae883ecadcf,(FLAG)LOW_StormshoreTabernacle_State_GruumshOfferingGiven_7ef5134c-8773-403e-a25c-d89f7e7cbd74, (TAG)ACT3_LOW_STORMSHORETABERNACLE_GRUUMSH_033b0956-aa65-4cff-9b57-b800d0a3cdc4);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_StormshoreTabernacle_Shar_b61259ec-5aef-4187-84f4-b183b7e7a3b8,(FLAG)LOW_StormshoreTabernacle_State_SharOfferingGiven_742966f3-330f-48d7-86a6-935532991943, (TAG)ACT3_LOW_STORMSHORETABERNACLE_SHAR_2387e65f-1135-401c-b539-310de48d6a85);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Yondalla_InvisibleHelper_5bf652cd-3714-4427-80b1-a78976b908a9,(FLAG)LOW_StormshoreTabernacle_State_YondallaOfferingGiven_b77a123f-4ac1-4f1b-aa78-db87479d853f, (TAG)ACT3_LOW_STORMSHORETABERNACLE_YONDALLA_9fe3ca2b-0c57-46bb-b5df-98740725cb6f);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Bhaal_InvisibleHelper_ff31fcbd-e103-40d2-852d-9624e5bb8aa3,(FLAG)LOW_StormshoreTabernacle_State_BhaalOfferingGiven_a2210af2-a37d-4521-a5cd-fed34f044529, (TAG)ACT3_LOW_STORMSHORETABERNACLE_BHAAL_2089f8fe-f812-42a5-be72-8a0739a53f69);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_CorellonLarethian_InvisibleHelper_45fc9b9d-c2ca-4a5f-92a3-4dc52c9ae7ba,(FLAG)LOW_StormshoreTabernacle_State_CorellonLarethianOfferingGiven_54334a50-02dd-4db1-836a-61cd1083ec51, (TAG)ACT3_LOW_STORMSHORETABERNACLE_CORELLON_1e113ed2-99cb-4012-90cd-2be84e5a0ae2);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Myrkul_InvisibleHelper_43821111-893a-4c2f-b62a-60b47cba1939,(FLAG)LOW_StormshoreTabernacle_State_MyrkulOfferingGiven_a4339775-10d8-4293-a1be-e427e01cd681, (TAG)ACT3_LOW_STORMSHORETABERNACLE_MYRKUL_daf0d9f4-6adf-4b92-ad01-9a2146ec1fed);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Lathander_InvisibleHelper_ea7befd9-3909-473a-bdc4-7caf159ab841,(FLAG)LOW_StormshoreTabernacle_State_LathanderOfferingGiven_3e9cf14b-b2fa-49a8-935b-7a0b8d1514e3, (TAG)ACT3_LOW_STORMSHORETABERNACLE_LATHANDER_a8877ac1-91ae-4828-a2e7-0e1c39596269);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Tymora_InvisibleHelper_a1ca2a2b-0516-4d8f-a862-b538a9aa01cd,(FLAG)LOW_StormshoreTabernacle_State_TymoraOfferingGiven_c2e79249-4960-4e3f-a0ba-9335eb6b486c, (TAG)ACT3_LOW_STORMSHORETABERNACLE_TYMORA_81c97b80-afc6-4410-8a08-1183b0efaf09);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Talos_InvisibleHelper_3d556ae8-d342-49bf-a52a-f92202f44fa5,(FLAG)LOW_StormshoreTabernacle_State_TalosOfferingGiven_55812d41-f79d-46cf-b02a-2c1cc789911b, (TAG)ACT3_LOW_STORMSHORETABERNACLE_TALOS_21cf6608-e7f7-4bf6-b441-dddf9c0b373b);
DB_LOW_StormshoreTabernacle_Offerings((CHARACTER)S_LOW_Bane_InvisibleHelper_db4d8f7c-a730-447b-8575-669e121908f5,(FLAG)LOW_StormshoreTabernacle_State_BaneOfferingGiven_28d3865c-2938-40fc-b501-cd68a9faa965, (TAG)ACT3_LOW_STORMSHORETABERNACLE_BANE_12f4c348-31ab-423b-a21f-dbe42e18dd44);
DB_BUGFIX_Marker("GUS-292109");
//END_REGION GUS-292109

//REGION GUS-306283

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_Player)
AND
DB_ActiveLevel("CTY_Main_A")
AND
NOT DB_DialogName((DIALOGRESOURCE)LOW_HouseOfHope_ROM_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006,_)
AND
NOT DB_PermaDefeatedOrOffstage(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
AND
NOT DB_HostileToPlayerGroup((FACTION)Act3_LOW_HouseOfHope_Incubus_c379b3f1-9f7b-411a-897c-228b7db333ff, (CHARACTER)_Player)
THEN
NOT DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_Player);
PROC_LOW_HouseOfHope_FixIncubusDialogue();

PROC
PROC_LOW_HouseOfHope_FixIncubusDialogue()
AND
NOT DB_BUGFIX_Marker("GUS-306283")
THEN
PROC_SpotPlayers_RestartSpotting((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "HoH_Incubus");
NOT DB_OnlyOnce("LOW_HouseOfHope_IncubusDialogue");
DB_BUGFIX_Marker("GUS-306283");

//END_REGION

//REGION GUS-294622
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_EastwayFoodCrisis_Chicken(_Chicken)
AND
NOT DB_PermaDefeatedOrOffstage(_Chicken)
THEN
PROC_CharacterDisableAllCrimes(_Chicken);
DB_BUGFIX_Marker("GUS-294622");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_EastwayFoodCrisis_Chicken(_Chicken)
AND
NOT DB_PermaDefeatedOrOffstage(_Chicken)
THEN
DB_LOW_EastwayFoodCrisis_Chicken_DelayDisableCrimes((CHARACTER)_Chicken);
DB_BUGFIX_Marker("GUS-294622");

IF
LevelLoaded("CTY_Main_A")
AND
DB_LOW_EastwayFoodCrisis_Chicken_DelayDisableCrimes(_Chicken)
THEN
PROC_CharacterDisableAllCrimes(_Chicken);
NOT DB_LOW_EastwayFoodCrisis_Chicken_DelayDisableCrimes(_Chicken);
//END_REGION GUS-294622

//REGION GUS-306314

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_LOW_BhaalApproach_AmbushBreaker(S_LOW_BhaalApproach_AmbushEnder_001_75ba19bf-3e9c-47ce-9311-13a8ed49fb7c, S_LOW_RangedCultistAmbushTrigger_2aba7da4-9fc6-4f82-b6d8-34f3eb151505);
DB_LOW_BhaalApproach_AmbushBreaker(S_LOW_BhaalApproach_AmbushEnder_000_b98cba8f-b9ea-411a-95a9-d87d7952005d, S_LOW_Undercity_BhaalCultists_Patrol1_AmbushTrigger_9301bb99-35b8-4dd3-8a90-ec769e40e1cb);
DB_LOW_BhaalApproach_RegisterTriggersWhenReady(1);

IF
DB_LOW_BhaalApproach_RegisterTriggersWhenReady(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_AmbushEnder_000_b98cba8f-b9ea-411a-95a9-d87d7952005d);
PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_AmbushEnder_001_75ba19bf-3e9c-47ce-9311-13a8ed49fb7c);
NOT DB_LOW_BhaalApproach_RegisterTriggersWhenReady(1);
DB_BUGFIX_Marker("GUS-306314");

//END_REGION GUS-306314

//REGION GUS-261342
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_Elfsong_GithyankiGateMasters(_, _Portal, _)
AND
HasActiveStatus(_Portal, "PUZ_CASTEDPORTAL_GREEN", 1)
THEN
RemoveStatus(_Portal, "PUZ_CASTEDPORTAL_GREEN", NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(_Portal, "PUZ_CASTEDPORTAL_PURPLE", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION GUS-261342

//REGION GUS-306693
//Check Foundry rooms for summons left behind and teleport them to their owner.
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
AND
DB_LOW_SteelWatchFoundry_RoomTriggers(_Room)
AND
DB_PlayerSummons(_Summon)
AND
IsInTrigger(_Summon, (TRIGGER)_Room, 1)
AND
QRY_GetSummonOwner(_Summon)
AND
DB_QRYRTN_GetSummonOwner(_Owner)
THEN
TeleportTo(_Summon, _Owner, "ApplySavegamePatches_GUS_306693_Teleported", 0, 0, 1, 1, 1);
DB_BUGFIX_Marker("GUS-306693");
//END_REGION GUS-306693

//REGION GUS-306127
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_QuestDef_State((FLAG)LOW_SharGrotto_Event_SurrenderShadowheart_bfc7f3b7-4e58-44e1-bb58-131ee77fc0ad, "GLO_GatherYourAllies", "ViconiaPromisesSupport")
THEN
NOT DB_QuestDef_State((FLAG)LOW_SharGrotto_Event_SurrenderShadowheart_bfc7f3b7-4e58-44e1-bb58-131ee77fc0ad, "GLO_GatherYourAllies", "ViconiaPromisesSupport");
DB_QuestDef_State((FLAG)LOW_SharGrotto_ConfrontViconia_SharranAlliance_ea829b7c-5f69-c4fc-6b4c-b8a190d31a86, "GLO_GatherYourAllies", "ViconiaPromisesSupport");
DB_BUGFIX_Marker("GUS-306127");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)LOW_SharGrotto_ConfrontViconia_SharranAlliance_ea829b7c-5f69-c4fc-6b4c-b8a190d31a86)
THEN
QuestUpdate("GLO_GatherYourAllies", "ViconiaPromisesSupport");
DB_BUGFIX_Marker("GUS-306127");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_GlobalFlag((FLAG)LOW_SharGrotto_ConfrontViconia_SharranAlliance_ea829b7c-5f69-c4fc-6b4c-b8a190d31a86)
AND
DB_PermaDefeated((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313)
THEN
QuestUpdate("GLO_GatherYourAllies", "ViconiaNoSupport");
DB_BUGFIX_Marker("GUS-306127");

//END_REGION GUS-306127


//REGION GUS-307431
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-307431");
PROC_GLO_Bugfix_307431_TryRestoreDaggerFromChasm();

// if Players are currently in CTY_Main_A
PROC
PROC_GLO_Bugfix_307431_TryRestoreDaggerFromChasm()
AND
DB_CurrentLevel("CTY_Main_A") // currently players are in CTY_Main_A, so local item/trigger exists
AND
QRY_GLO_Bugfix_307431_IsDarkUrgeResistedFlow()
THEN
PROC_GLO_Bugfix_307431_TryGiveDarkUrgeDagger();

// if Players are currently in BGO_Main_A, need to wait for them to enter CTY_Main_A again before we can check if local dagger is chasm.
PROC
PROC_GLO_Bugfix_307431_TryRestoreDaggerFromChasm()
AND
DB_CurrentLevel("BGO_Main_A") // currently players are in BGO_Main_A
AND
QRY_GLO_Bugfix_307431_IsDarkUrgeResistedFlow()
THEN
DB_GLO_Bugfix_307431_WaitForCTY(1); // start listening for when players return to CTY

// Players are back in CTY, check if Gore and Dagger is in chasm. If it is, savegame patch and transfer to player the dagger.
IF
DB_GLO_Bugfix_307431_WaitForCTY(1)
AND
DB_CurrentLevel("CTY_Main_A") // currently players are in CTY_Main_A, so next rule local trigger exists
THEN
NOT DB_GLO_Bugfix_307431_WaitForCTY(1);
PROC_GLO_Bugfix_307431_TryGiveDarkUrgeDagger();

// Check if the gore or dagger is indeed still in the chasm, if so, give to dark urge. QRY check only works in CTY.
PROC
PROC_GLO_Bugfix_307431_TryGiveDarkUrgeDagger()
AND
DB_ORI_DarkUrge(_DarkUrge) // Dark Urge must exist in this flow.
AND
NOT DB_GEN_OrinsAbduction_GaveDagger(1) // players were never given the dagger yet (they could have looted her body in combat before throwing it into the chasm)
AND
QRY_GLO_Bugfix_307431_IsDaggerOnGoreInChasm() // gore or dagger is in chasm
THEN
PROC_GEN_OrinsAbduction_GiveDagger_WithNetherstone(_DarkUrge); // give the Dark Urge the Netherstone Dagger.

// current playthrough is the Dark Urge Resisted flow
QRY
QRY_GLO_Bugfix_307431_IsDarkUrgeResistedFlow()
AND
DB_GlobalFlag((FLAG)ORI_DarkUrge_State_BhaalResisted_74944ac3-1ea0-4eae-9653-1f1319f8646b) // player's flow is resisting Bhaal
THEN
DB_NOOP(1);

// Orin gore is in the chasm, and the dagger is still in the gore. Has local item checks, so must be in CTY_Main_A
QRY
QRY_GLO_Bugfix_307431_IsDaggerOnGoreInChasm()
AND
IsInTrigger((ITEM)S_LOW_BhaalTemple_OrinCorpse_502e7d05-9f67-4092-a6ad-c349750720c9, (TRIGGER)S_LOW_BhaalTemple_ChasmArea_45fb4540-66ad-4eaa-bf88-94d49af6d7ee, 1) // Orin's gore is in the Chasm
AND
IsInInventoryOf((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, (ITEM)S_LOW_BhaalTemple_OrinCorpse_502e7d05-9f67-4092-a6ad-c349750720c9, 1) // netherstone dagger is still in Orin's gore
THEN
DB_NOOP(1);
//END_REGION

//REGION GUS-298132

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("SCL_Main_A")
AND
NOT DB_QuestIsClosed("SHA_Nightsong")
THEN
NOT DB_QuestDef_State((FLAG)LOW_Lorroakan_State_IsPermadefeated_2c446081-2f24-49c4-84d9-b8f64a3d3098, "SHA_Nightsong", "LorroakanDead");
NOT DB_QuestDef_State((FLAG)LOW_SorcerousSundries_State_ReadyToCageNightsong_2ce45480-d094-471a-b7eb-77d9f5150662, "SHA_Nightsong", "GaveToWizard");
DB_BUGFIX_Marker("GUS-298132");

//END_REGION GUS-298132

//REGION GUS-306596
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_ApplySavegamePatches_GUS_306596(1);

IF
DB_ApplySavegamePatches_GUS_306596(1)
AND
DB_CurrentLevel("CTY_Main_A")
AND
NOT DB_Dead(S_LOW_Overdose_Unconscious_5da78446-ff91-4432-b838-ac721160f6d4)
THEN
NOT DB_ApplySavegamePatches_GUS_306596(1);
SetFaction(S_LOW_Overdose_Unconscious_5da78446-ff91-4432-b838-ac721160f6d4, (FACTION)Act3_LOW_Sewers_Overdosed_15a99f98-0aa9-44d0-a795-a365488cca81);
RemoveStatus(S_LOW_Overdose_Unconscious_5da78446-ff91-4432-b838-ac721160f6d4, "UNCONSCIOUS", NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_LOW_Overdose_Unconscious_5da78446-ff91-4432-b838-ac721160f6d4, "LOW_OVERDOSED", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUS-306596");
//END_REGION GUS-306596

//REGION GUS-288454
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)HAG_Hag_State_HagDefeated_7a1acad0-589f-ae02-f712-f0d24080d720)
THEN
DB_BUGFIX_Marker("GUS-288454");
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_ToldAboutHagDeal_fb133357-495c-495f-919e-a62c72d3b061,"LOW_AvengeHagSurvivors","ToldAboutHagDeal");
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_ToldAboutHagDeal_fb133357-495c-495f-919e-a62c72d3b061,(DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_Cured_f776ecd3-8e2a-2c91-645c-5a91e0f5d646);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_ToldAboutHagDeal_fb133357-495c-495f-919e-a62c72d3b061,(DIALOGRESOURCE)LOW_HagSurvivors_Adrielle_b86566c4-3420-8842-a29e-19c0b72300dd);
//END_REGION

//REGION GUS-204545

PROC
PROC_ApplySavegamePatches()
AND
NOT DB_LOW_KurwinCoffin_CoffinFillers(S_LOW_KurwinCoffin_BuriedManCoffinSharer_b4b8e3b9-c8bd-40dd-8319-2aeee508f372, S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107, S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-204545");


PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-204545")
THEN
ToInventory(S_LOW_KurwinCoffin_BuriedManCoffinSharer_b4b8e3b9-c8bd-40dd-8319-2aeee508f372, S_LOW_KurwinCoffin_BuriedManCasket_e001696d-0dd4-4ab5-932d-9a9f0ffde107, 1, 0, 1);
ObjectTimerLaunch(S_LOW_KurwinCoffin_BuriedManCoffinSharer_b4b8e3b9-c8bd-40dd-8319-2aeee508f372, "LOW_KurwinCoffin_BloodTidier", 2000, 1);
//END_REGION

//REGION GUS-306688
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-306688");
PROC_GLO_Bugfix_306688_TryApplyFix();

PROC
PROC_GLO_Bugfix_306688_TryApplyFix()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // dark urge is currently in a duel. Flag is only set if a duel is ongoing. Gets unset when duel is over/broken.
THEN
PROC_LOW_BhaalTemple_Duel_DarkUrgeBlockFearMovement_Apply();

//END_REGION

//REGION GUS-305719

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT GetFaction((CHARACTER)S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,(FACTION)ACT1_DEN_AdventurerLeader_8276868b-adf0-4b7e-fc32-2f268e43f51e)
AND
NOT DB_PermaDefeated((CHARACTER)S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
THEN
SetFaction(S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c,(FACTION)ACT1_DEN_AdventurerLeader_8276868b-adf0-4b7e-fc32-2f268e43f51e);

//END_REGION

//REGION GUS-305681
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LOW_CazadorsPalace_RitualRoom_AstarionsFaction(_Faction)
THEN
DB_BUGFIX_Marker("GUS-305681");
NOT DB_LOW_CazadorsPalace_RitualRoom_AstarionsFaction(_Faction);
PROC_GLO_Bugfix_305681_RestoreFaction(_Faction);
PROC_GLO_Bugfix_305681_SetTag();

PROC
PROC_GLO_Bugfix_305681_RestoreFaction((FACTION)_Faction)
THEN
SetFaction(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, _Faction);

PROC
PROC_GLO_Bugfix_305681_SetTag()
AND
HasActiveStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", 1)
THEN
SetTag(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, (TAG)AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);
//END_REGION

//REGION GUS-307704
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-307704");
DB_GLO_Bugfix_307704(1);

IF
DB_GLO_Bugfix_307704(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
NOT DB_GLO_Bugfix_307704(1);
PROC_GLO_Bugfix_307704_CheckCombat();
PROC_LOW_CazadorsPalace_RitualRoom_CheckEndCombat();

PROC
PROC_GLO_Bugfix_307704_CheckCombat()
AND
DB_Is_InCombat(_NPC, _)
AND
GetCombatGroupID(_NPC, "LOW_CazadorsPalace_RitualRoom")
THEN
DB_LOW_CazadorsPalace_RitualRoom_EnemiesInCombat((CHARACTER)_NPC);
//END_REGION

//REGION GUS-301675

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-301675");
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorSword_5e46d5b5-0a24-4e01-adc9-96914091cdbe);
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorRascal_91e7d1ee-1455-47a8-b248-5e5c85940d43);
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorsLair_StelemanePortrait_44243a84-b27a-4535-b13f-fc9b05842cff);
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorsLair_ButterFork_23903b2e-558e-46e8-9470-90941dfeb892);
DB_LOW_Elfsong_EmperorsLair_UniqueADs_OneUseItems(S_LOW_Elfsong_EmperorLair_Shell_a950d326-273d-4853-9957-956ec75d0656);
PROC_LOW_Elfsong_GUS301675();

PROC
PROC_LOW_Elfsong_GUS301675()
AND
DB_PartOfTheTeam(_Character)
AND
DB_LOW_Elfsong_EmperorsLair_UniqueADs(_Item, _, _Flag)
AND
GetFlag(_Flag, _Character, 1)
THEN
DB_LOW_Elfsong_EmperorsLair_UniqueADs_UsedItems(_Character, _Item);

//END_REGION GUS-301675

//REGION GUS-307309
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_State_Current(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "Finished")
AND
NOT DB_Defeated(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
AND
HasActiveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_PRISONER_RAVENGARD", 1)
THEN
PROC_ApplySavegamePatches_GUS_307309_RestoreRavengardRequipment();
DB_BUGFIX_Marker("GUS-307309");

PROC
PROC_ApplySavegamePatches_GUS_307309_RestoreRavengardRequipment()
THEN
RemoveStatus(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, "IRN_PRISONER_RAVENGARD", NULL_00000000-0000-0000-0000-000000000000);
PROC_CAMP_Ravengard_RestoreEquipmentAfterIRN();

PROC
PROC_ApplySavegamePatches_GUS_307309_RestoreRavengardRequipment()
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_LOW_IronThrone_MoveRavengardToCamp(); //Sets correct dialogs and flags, even if he's already a camp follower
//END_REGION

//REGION GUS-307998
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_AutoSaveTrigger((TRIGGER)LOW_AutoSave_FoundryGroundFloor_4c5de2bf-c28a-403c-b532-74a95dcf10c9);
DB_AutoSaveTrigger((TRIGGER)LOW_Autosave_FoundryLabFloor_33446940-1258-44b4-88da-454176fd79e6);
DB_AutoSaveTrigger((TRIGGER)LOW_Autosave_FoundrySecOffice_d265abb9-2508-4ffd-aa22-1418abbc0c77);
DB_AutoSaveTrigger((TRIGGER)LOW_Autosave_FoundryControlCentre_eb2a8319-a097-4520-9ff3-6ddd8e7ba795);
DB_BUGFIX_Marker("GUS-307998");
//END_REGION GUS-307998

//REGION GUS-302471
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
NOT DB_LOW_SteelWatchFoundry_AfterIRNPositions(S_LOW_BaneiteOfficer17_AfterIRNPos_23c156ab-6ff3-4366-867f-4c46040128d8,S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd);
NOT DB_LOW_SteelWatchFoundry_AfterIRNPositions(S_LOW_BaneiteOfficer03_AfterIRNPos_5cc1e98b-b111-43f5-95b5-8abfad08966a,S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835);
NOT DB_LOW_SteelWatchFoundry_AfterIRNPositions(S_LOW_BaneiteOfficer01_AfterIRNPos_f895031c-9c8f-41af-b131-e4e1cde58066, S_LOW_BaneiteOfficer01_db345b42-35f7-4a31-b5f4-1c4b86ebd25c);
NOT DB_LOW_SteelWatchFoundry_AfterIRNPositions(S_LOW_BaneiteOfficer16_AfterIRNPos_5fefb855-109d-4f75-8d1b-22345378c8a4, S_LOW_BaneiteOfficer16_38d84851-00b5-400c-81eb-7767a861e8e0);
DB_LOW_SteelWatchFoundry_AfterIRNPositions(S_LOW_BaneiteOfficer17_AfterIRNPos_2_ff4c7b0d-bfb2-4cd6-abd6-2490e3709f16, S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd);
DB_LOW_SteelWatchFoundry_AfterIRNPositions(S_LOW_BaneiteOfficer03_AfterIRNPos_2_4af81353-1b43-40ff-b81c-6baaf1f4e8c9, S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835);
DB_LOW_SteelWatchFoundry_AfterIRNPositions(S_LOW_BaneiteOfficer01_AfterIRNPos_2_82019bfd-7f93-4f8e-aeef-55d2c376049e, S_LOW_BaneiteOfficer01_db345b42-35f7-4a31-b5f4-1c4b86ebd25c);
DB_LOW_SteelWatchFoundry_AfterIRNPositions(S_LOW_BaneiteOfficer16_AfterIRNPos_2_64966ef3-b907-48fd-9cad-87c392a82adb, S_LOW_BaneiteOfficer16_38d84851-00b5-400c-81eb-7767a861e8e0);
DB_BUGFIX_Marker("GUS-302471");
//END_REGION GUS-302471

//REGION GUS-306835
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_PartyMembers(_PartyMember)
AND
DB_Is_InCombat(_PartyMember, _CombatGuid)
AND
DB_Is_InCombat((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _CombatGuid)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","WineFestival")
AND
QRY_OnlyOnce("LOW_SerialKiller_WineFestivalCombat_BUGFIX_GUS-306835")
THEN
DB_BUGFIX_Marker("GUS-306835");
PROC_SetRelationMutual(Act3_LOW_Dolor_15f56a1e-42e3-458d-bf8d-140ed313b928, (FACTION)ACT3_LOW_SerialKiller_WineFestivalCivilians_e620bbb1-53ff-49f5-a324-14033c17a85e, 51);
PROC_SetRelationMutual(Act3_LOW_Dolor_HighberrysHouseDoppelgangers_d7decde4-a3f5-42ae-b63f-6b6dfeaff052, (FACTION)ACT3_LOW_SerialKiller_WineFestivalCivilians_e620bbb1-53ff-49f5-a324-14033c17a85e, 51);

//END_REGION GUS-306835

//REGION Elfsong Lighting Fix
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","Elfsong Lighting Fix");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","Elfsong Lighting Fix")
AND
DB_Camp_Ambiance("ELFSONG",
		(TRIGGER)ATM_CAMP_Elfsong_000_dd5d3776-214f-4c5e-8819-c27311159c3e,
		"9013cf0b-c4a5-3152-2884-d63b43490a84", //(ATMOSPHERERESOURCE)ATM_CTY_CMP_Elfsong_A_EV10_Day_9013cf0b-c4a5-3152-2884-d63b43490a84
		"c260ba84-3818-826e-5ee6-a4907cf7b265", //(ATMOSPHERERESOURCE)ATM_CTY_CMP_Elfsong_A_EV10_Night_c260ba84-3818-826e-5ee6-a4907cf7b265
		(TRIGGER)LTN_CAMP_Elfsong_000_1438e64e-be21-4d09-9579-3e0f0a6d3439,
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		(TRIGGER)Amb_SV_Camp_ELFSONG_QD_000_212dcdb3-b970-40d8-b872-eadca6e6a207)
THEN
NOT DB_Camp_Ambiance("ELFSONG",
		(TRIGGER)ATM_CAMP_Elfsong_000_dd5d3776-214f-4c5e-8819-c27311159c3e,
		"9013cf0b-c4a5-3152-2884-d63b43490a84", //(ATMOSPHERERESOURCE)ATM_CTY_CMP_Elfsong_A_EV10_Day_9013cf0b-c4a5-3152-2884-d63b43490a84
		"c260ba84-3818-826e-5ee6-a4907cf7b265", //(ATMOSPHERERESOURCE)ATM_CTY_CMP_Elfsong_A_EV10_Night_c260ba84-3818-826e-5ee6-a4907cf7b265
		(TRIGGER)LTN_CAMP_Elfsong_000_1438e64e-be21-4d09-9579-3e0f0a6d3439,
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		(TRIGGER)Amb_SV_Camp_ELFSONG_QD_000_212dcdb3-b970-40d8-b872-eadca6e6a207);
DB_Camp_Ambiance("ELFSONG",
		(TRIGGER)ATM_CAMP_Elfsong_000_dd5d3776-214f-4c5e-8819-c27311159c3e,
		"9013cf0b-c4a5-3152-2884-d63b43490a84", //(ATMOSPHERERESOURCE)ATM_CTY_CMP_Elfsong_A_EV10_Day_9013cf0b-c4a5-3152-2884-d63b43490a84
		"c260ba84-3818-826e-5ee6-a4907cf7b265", //(ATMOSPHERERESOURCE)ATM_CTY_CMP_Elfsong_A_EV10_Night_c260ba84-3818-826e-5ee6-a4907cf7b265
		(TRIGGER)LTN_CAMP_Elfsong_000_1438e64e-be21-4d09-9579-3e0f0a6d3439,
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit_9f666037-8330-b11f-bea6-2d534abe7dee
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit_9f666037-8330-b11f-bea6-2d534abe7dee
		(TRIGGER)Amb_SV_Camp_ELFSONG_QD_000_212dcdb3-b970-40d8-b872-eadca6e6a207);

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","SCL_Main_A","Moonrise Lighting Fix");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A","Moonrise Lighting Fix")
AND
DB_Camp_Ambiance("MOONRISE",
		(TRIGGER)S_ATM_CAMP_MOONRISE_888c6e97-a0d3-43c6-b3cf-e868b1748e12,
		"afeb993b-462c-994d-00e3-995e04154ee4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Day_afeb993b-462c-994d-00e3-995e04154ee4
		"063b0188-7089-f2f6-2ad9-ad9766e429c4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Night_063b0188-7089-f2f6-2ad9-ad9766e429c4
		(TRIGGER)S_LTN_CAMP_MOONRISE_15e42ea7-b53e-4e1a-a59d-fa810f12f056,
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		(TRIGGER)SoundVolumeTrigger_000_8239d564-6140-48a4-8c97-5b51d3a2a2c1)
THEN
NOT DB_Camp_Ambiance("MOONRISE",
		(TRIGGER)S_ATM_CAMP_MOONRISE_888c6e97-a0d3-43c6-b3cf-e868b1748e12,
		"afeb993b-462c-994d-00e3-995e04154ee4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Day_afeb993b-462c-994d-00e3-995e04154ee4
		"063b0188-7089-f2f6-2ad9-ad9766e429c4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Night_063b0188-7089-f2f6-2ad9-ad9766e429c4
		(TRIGGER)S_LTN_CAMP_MOONRISE_15e42ea7-b53e-4e1a-a59d-fa810f12f056,
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		"d6507cd9-da9c-af88-0279-e8e7f63f7a3b", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_d6507cd9-da9c-af88-0279-e8e7f63f7a3b
		(TRIGGER)SoundVolumeTrigger_000_8239d564-6140-48a4-8c97-5b51d3a2a2c1);
DB_Camp_Ambiance("MOONRISE",
		(TRIGGER)S_ATM_CAMP_MOONRISE_888c6e97-a0d3-43c6-b3cf-e868b1748e12,
		"afeb993b-462c-994d-00e3-995e04154ee4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Day_afeb993b-462c-994d-00e3-995e04154ee4
		"063b0188-7089-f2f6-2ad9-ad9766e429c4", //(ATMOSPHERERESOURCE)ATM_Default_EV10_Camp_Dungeon_A_Night_063b0188-7089-f2f6-2ad9-ad9766e429c4
		(TRIGGER)S_LTN_CAMP_MOONRISE_15e42ea7-b53e-4e1a-a59d-fa810f12f056,
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit_9f666037-8330-b11f-bea6-2d534abe7dee
		"9f666037-8330-b11f-bea6-2d534abe7dee", //(LIGHTINGRESOURCE)LTN_Default_EV10_Dungeon_HalfLit_9f666037-8330-b11f-bea6-2d534abe7dee
		(TRIGGER)SoundVolumeTrigger_000_8239d564-6140-48a4-8c97-5b51d3a2a2c1);

//END_REGION

//REGION GUS-308002
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_AutoSaveTrigger ((TRIGGER)LOW_Autosave_DockWarehouseSubRoom_84a8e521-7f0c-49fc-b5b9-2cf4b22b498b);
DB_BUGFIX_Marker("GUS-308002");

//If the player has already returned from the Iron throne Re-register certain autosave triggers in the Foundry
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
NOT DB_CurrentLevel("IRN_Main_A")
THEN
PROC_ApplySavegamePatches_GUS_308002();
DB_BUGFIX_Marker("GUS-308002");

PROC
PROC_ApplySavegamePatches_GUS_308002()
AND
NOT DB_AutoSaveTrigger ((TRIGGER)LOW_Autosave_FoundrySecOffice_d265abb9-2508-4ffd-aa22-1418abbc0c77)
THEN
DB_AutoSaveTrigger ((TRIGGER)LOW_Autosave_FoundrySecOffice_d265abb9-2508-4ffd-aa22-1418abbc0c77);

PROC
PROC_ApplySavegamePatches_GUS_308002()
AND
NOT DB_AutoSaveTrigger ((TRIGGER)LOW_Autosave_FoundryControlCentre_eb2a8319-a097-4520-9ff3-6ddd8e7ba795)
THEN
DB_AutoSaveTrigger ((TRIGGER)LOW_Autosave_FoundryControlCentre_eb2a8319-a097-4520-9ff3-6ddd8e7ba795);

PROC
PROC_ApplySavegamePatches_GUS_308002()
AND
NOT DB_AutoSaveTrigger ((TRIGGER)LOW_AutoSave_FoundryGroundFloor_4c5de2bf-c28a-403c-b532-74a95dcf10c9)
THEN
DB_AutoSaveTrigger ((TRIGGER)LOW_AutoSave_FoundryGroundFloor_4c5de2bf-c28a-403c-b532-74a95dcf10c9);
//END_REGION GUS-308002


//REGION GUS-307379
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-307379");


//If you reached the city and the quest is at any of the WYR stages, and it was cleared by exiting to the city, drag it kicking forward into the "Jaheira doesn't know yet what happened" quest update
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307379")
AND
DB_GlobalFlag(WYR_Axe_State_Cleared_6f752da0-a985-4fe2-ae9c-d5989042cfcb)
AND
QRY_GLO_Jaheira_PreCityQuestChecker()
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "ORI_HighHarper", "TalkToJaheira");
DB_BUGFIX_Marker("GUS-307379");

//If you reached the city and the quest is at any of the WYR stages, and that flag is not set, then assume it was safely finished and instead drag it kicking forward into the "Jaheira knows they were ambushed" quest update

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307379")
AND
NOT DB_GlobalFlag(WYR_Axe_State_Cleared_6f752da0-a985-4fe2-ae9c-d5989042cfcb)
AND
QRY_GLO_Jaheira_PreCityQuestChecker()
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "ORI_HighHarper", "EnteredCity");

//END_REGION GUS-307379

//REGION GUS-312972

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "BGO_Main_A", "GUS-312972");

PROC
PROC_ApplySavegamePatchInLevel("BGO_Main_A", "GUS-312972")
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_HighHarper", "TalkedSCE")
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "ORI_HighHarper", "FindHarpers");

//END_REGION GUS-312972


//REGION GUS-307588
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_ApplySavegamePatches_GUS_307588();
DB_BUGFIX_Marker("GUS-307588");

//If saved during destruction dialog
PROC
PROC_ApplySavegamePatches_GUS_307588()
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
AND
NOT DB_Defeated((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
DB_State_Current(S_GLO_IronThrone_StateProgressHelper_954459bd-8fc3-4c16-8224-0343cacb1a01, "IRN_IronThrone", "CountdownFinished")
THEN
PROC_RestoreAttitudeToPartyIfLower((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 50);

//If saved after returning to CTY
PROC
PROC_ApplySavegamePatches_GUS_307588()
AND
GetFlag((FLAG)IRN_IronThrone_State_IndividualPrisonerEscaped_a09945e7-6436-40e7-908e-22a699ef296e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 1)
AND
NOT DB_Defeated((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03)
AND
DB_LevelUnreachable("IRN_Main_A")
THEN
PROC_RestoreAttitudeToPartyIfLower((CHARACTER)S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, 50);

PROC
PROC_ApplySavegamePatches_GUS_307588()
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
DB_LevelUnreachable("IRN_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
GetCanInteract(S_LOW_SubmersibleInteriorLadder_8b3d25e5-4fb6-4207-8f67-82b7f6de1db9, 0)
THEN
PROC_LOW_IronThrone_LadderLowered();
//END_REGION

//REGION GUS-293273
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("BGO_Main_A")
THEN
DB_BUGFIX_Marker("GUS-293273");
DB_GLO_Backgrounds_Goal((TAG)ENTERTAINER_bd3cfefd-5fe2-47ea-bd3c-e99eaad9b714, "Act3_Entertainer_Sarevokmeet", ddc267af-1c1d-4694-a5eb-08c93f54e97c);
//END_REGION

//REGION GUS-305197
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_ApplySavegamePatches_GUS_305197(1);

IF
DB_ApplySavegamePatches_GUS_305197(1)
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_SetOnStage(DEC_Foundry_Neural_Switchboard_A_11a5dc17-2820-41f8-adbe-03213dee3328, 0);
PROC_SetOnStage(S_LOW_SteelWatchFoundry_MalfunctioningSwitchBoard_7c7afa83-46e5-4c4b-ac54-a02e91ada508, 0);
//END_REGION GUS-305197

//REGION GUS-305197
//Re-patching GUS-305197, as patch 3 didn't fix it for new players
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-305197");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-305197")
AND
IsOnStage(DEC_Foundry_Neural_Switchboard_A_11a5dc17-2820-41f8-adbe-03213dee3328, 1)
THEN
PROC_SetOnStage(DEC_Foundry_Neural_Switchboard_A_11a5dc17-2820-41f8-adbe-03213dee3328, 0);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-305197")
AND
IsOnStage(S_LOW_SteelWatchFoundry_MalfunctioningSwitchBoard_7c7afa83-46e5-4c4b-ac54-a02e91ada508, 1)
THEN
PROC_SetOnStage(S_LOW_SteelWatchFoundry_MalfunctioningSwitchBoard_7c7afa83-46e5-4c4b-ac54-a02e91ada508, 0);
//END_REGION GUS-305197

//REGION GUS-307424
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_GlobalFlag((FLAG)HAV_ProdigyLament_State_InShadowlands_68d204cb-3017-455e-9d80-c02abbc9f477)
AND
NOT DB_PermaDefeated(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
DB_GlobalFlag(GLO_Prodigy_State_InHaven_fe9b4527-9d66-45db-8e04-490fd51b7be5)
THEN
DB_BUGFIX_Marker("GUS-307424");
ClearFlag((FLAG)GLO_Prodigy_State_InHaven_fe9b4527-9d66-45db-8e04-490fd51b7be5);
//END_REGION

//REGION GUS-302681

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-302681");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-302681")
THEN
TeleportToPosition(CCT_BsG_RFG_TalkREAC_022_f3405570-7403-41cf-a34b-ee10c6727db9,33.109058,1.1265278,-168.02124);
TeleportToPosition(CCT_BsG_RFG_Talk_022_d20d77ad-4fce-4e55-8e60-177945f10909,32.686886,1.1952801,-169.3613);

//END_REGION GUS-302681

//REGION GUS-169771

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LOW_SerialKiller_DolorKnockOutImmuneStates(_)
THEN
DB_LOW_SerialKiller_DolorKnockOutImmuneStates("WineFestival");
DB_LOW_SerialKiller_DolorKnockOutImmuneStates("Figaro");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 3")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor",_State)
AND
DB_LOW_SerialKiller_DolorKnockOutImmuneStates(_State)
AND
NOT DB_PermaDefeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
THEN
DB_PreventKnockedOutPermaDefeated((CHARACTER)S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134);

//END_REGION GUS-169771

//REGION GUS-300725

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-300725");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-300725")
THEN
DB_DialogMoneyTransfer(1,LOW_CountingMoney_Beggar_a140e1dc-d799-b5fc-299b-35ee8e12eb55,1);
DB_DialogMoneyTransfer(2,LOW_CountingMoney_Beggar_a140e1dc-d799-b5fc-299b-35ee8e12eb55,10);

//END_REGION GUS-300725

//REGION GUS-307680
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-307680");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-307680")
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_PlayersKilledMayrina_75ea3027-8e3c-489b-a497-31889a83975a)
AND
NOT DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_MayrinaIsInBG_670c57b7-f0f1-41f1-b9d6-ff192153c0b3)
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_DollDestroyed_e99c5e75-57c4-4a7a-be5c-0ce8e3724e60)
AND
GetRelation((FACTION)Act3_LOW_HagSurvivors_8fe0bd59-dabe-4cd8-92b7-b90855867c54,(FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,0)
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_HagSurvivors_State_PlayersKilledMayrina_75ea3027-8e3c-489b-a497-31889a83975a);
PROC_BUGFIX_LOW_FixSurvivorsPermaHostility_DollDestroyedWhenMayrinaTakenByHag();

PROC
PROC_BUGFIX_LOW_FixSurvivorsPermaHostility_DollDestroyedWhenMayrinaTakenByHag()
AND
NOT DB_OnlyOnce("LOW_HagSpyDropsDisguise_OnlyOnce")
THEN
PROC_LOW_HagSpyDropsDisguise();

PROC
PROC_BUGFIX_LOW_FixSurvivorsPermaHostility_DollDestroyedWhenMayrinaTakenByHag()
AND
DB_OnlyOnce("LOW_HagSpyDropsDisguise_OnlyOnce")
THEN
PROC_LOW_HagSurvivors_SurvivorsRelationsOnDroppedDisguise();
//END_REGION GUS-307680

//REGION GUS-304976
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-304976");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-304976")
THEN
SetTag((CHARACTER)S_LOW_ShopAnimatedArmor_001_50e39747-fa44-4d2a-8427-186d2f9a5d1c,(TAG)AGGRESSIVE_CONSTRUCT_eb9d5af8-3efa-4fea-94e3-158b4e460d61);
SetTag((CHARACTER)S_LOW_ShopAnimatedArmor_002_4b741aa9-c2af-4196-a8fd-7bc9a8f5cd5d,(TAG)AGGRESSIVE_CONSTRUCT_eb9d5af8-3efa-4fea-94e3-158b4e460d61);
SetTag((CHARACTER)S_LOW_ShopAnimatedArmor_003_e57cc258-8f98-45d0-b6dc-063e945ce086,(TAG)AGGRESSIVE_CONSTRUCT_eb9d5af8-3efa-4fea-94e3-158b4e460d61);
SetTag((CHARACTER)S_LOW_ShopAnimatedArmor_004_9752ca37-cc97-42fc-b7d0-a0f0a8b1dfd3,(TAG)AGGRESSIVE_CONSTRUCT_eb9d5af8-3efa-4fea-94e3-158b4e460d61);
SetTag((CHARACTER)S_LOW_ShopAnimatedArmor_005_d42295ab-7169-4bba-9a7c-8124196caea7,(TAG)AGGRESSIVE_CONSTRUCT_eb9d5af8-3efa-4fea-94e3-158b4e460d61);
SetTag((CHARACTER)S_LOW_Klank_73ce2a17-b63d-41a1-a3a6-007b88ed95d7,(TAG)AGGRESSIVE_CONSTRUCT_eb9d5af8-3efa-4fea-94e3-158b4e460d61);
SetTag((CHARACTER)S_LOW_Krank_47a3de7a-049b-462d-b526-60a178a649db,(TAG)AGGRESSIVE_CONSTRUCT_eb9d5af8-3efa-4fea-94e3-158b4e460d61);

//END_REGION GUS-304976

//REGION GUS-309987

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-309987");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-309987")
AND
IsInInventory((ITEM)BOOK_LOW_Graveyard_HappyBirthdayNote_000_c413788f-f932-487b-b613-145c17299929, 0)
AND
GetPosition((ITEM)BOOK_LOW_Graveyard_HappyBirthdayNote_000_c413788f-f932-487b-b613-145c17299929, _X, _Y, _Z)
AND
QRY_Real3CompareWithThreshold(_X, _Y, _Z, 16.3574, 41.82, 14.4747, 0.01)
THEN
TeleportToPosition(BOOK_LOW_Graveyard_HappyBirthdayNote_000_c413788f-f932-487b-b613-145c17299929, 24.801, 41.82, 14.274);

//END_REGION GUS-309987

//REGION GUS-307706
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5","CTY_Main_A","GUS-307706");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-307706")
AND
DB_GlobalFlag(GLO_BrainEscalation_State_NetherBrainReleased_06e31f1d-7e29-47ab-bce6-0f17cdc9c47e)
AND
IsOnStage(S_LOW_BaldursMouth_Wanderer_03_6fd2d322-cd4f-42b4-8683-894d565a4aa2, 1)
THEN
SetOnStage(S_LOW_BaldursMouth_Wanderer_03_6fd2d322-cd4f-42b4-8683-894d565a4aa2, 0);
DB_BUGFIX_Marker("GUS-307706");

//END_REGION GUS-307706

//REGION GUS-293165


PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5","CTY_Main_A","GUS-293165");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-293165")
AND
IsDestroyed(S_Door_HeapsideBottomA_299081b0-8dbf-4aac-8a80-6bbb17c64375, 0)
THEN
SetOnStage(S_Door_HeapsideBottomA_299081b0-8dbf-4aac-8a80-6bbb17c64375, 0);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-293165")
AND
IsDestroyed(S_Door_HeapsideBottomA_299081b0-8dbf-4aac-8a80-6bbb17c64375, 1)
THEN
SetOnStage(S_Door_HeapsideBottomA2_7836c12d-15e6-48cd-90b3-293ebd592bf4, 0);


PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-293165")
AND
IsOpened(S_Door_HeapsideBottomA_299081b0-8dbf-4aac-8a80-6bbb17c64375, 1)
THEN
Open(S_Door_HeapsideBottomA2_7836c12d-15e6-48cd-90b3-293ebd592bf4);

//END_REGION GUS-293165

//REGION GUS-290664, GUS-282907
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-290664");

PROC
PROC_ApplySavegamePatches("CTY_Main_A","GUS-290664")
THEN
PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_CandleSpawnTrigger001_e2dcf425-89a2-438e-a55b-ab4cc4705a55);
PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_CandleSpawnTrigger002_2be44e32-f2ad-41a0-9445-3c8aef55f7a4);
PROC_TriggerRegisterForPlayers(S_LOW_BhaalApproach_CandleSpawnTrigger003_84e2152f-a9c9-444f-b88f-a59f24ab044e);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger001_e2dcf425-89a2-438e-a55b-ab4cc4705a55, S_LOW_BhaalApproach_Candle001_a4bfc5cb-f811-4b51-8621-a199d145174f);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger001_e2dcf425-89a2-438e-a55b-ab4cc4705a55, S_LOW_BhaalApproach_Candle002_e4176bcd-e165-4684-9572-04cb1ea76ddd);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger002_2be44e32-f2ad-41a0-9445-3c8aef55f7a4, S_LOW_BhaalApproach_Candle003_0b6afde4-0d84-4d71-8c34-753bc3761dd4);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger002_2be44e32-f2ad-41a0-9445-3c8aef55f7a4, S_LOW_BhaalApproach_Candle004_4084f302-bf41-44b4-86e5-2693e6fd4ab6);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger003_84e2152f-a9c9-444f-b88f-a59f24ab044e, S_LOW_BhaalApproach_Candle005_944e05f8-a8b7-4839-a73e-21596e7ba507);
DB_UndercityRuins_AppearingCandles(S_LOW_BhaalApproach_CandleSpawnTrigger003_84e2152f-a9c9-444f-b88f-a59f24ab044e, S_LOW_BhaalApproach_Candle006_04e73c9d-bcde-4964-ab70-d6514af7feb2);
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_BackGasTrap_001_99382cb8-fee1-4a79-b4ce-b2a798f56fbf, "LOW_BhaalApproach_ActivateBackTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_BackGasTrap_000_c1b68f93-947d-42e1-bbb5-b33223c08e13, "LOW_BhaalApproach_ActivateBackTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_MiddleGasTrap_002_2e0d41d8-3e70-4ec1-a5ae-d0207c4206b3, "LOW_BhaalApproach_ActivateMiddleTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_MiddleGasTrap_001_66de5d1c-33ec-439a-a93f-d57b19009a83, "LOW_BhaalApproach_ActivateMiddleTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_MiddleGasTrap_000_d7d3c4aa-ca76-4c5f-ab61-845a657af743, "LOW_BhaalApproach_ActivateMiddleTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_FrontGasTrap_000_9a052728-d0ac-4c7c-bff9-f836d790b10d, "LOW_BhaalApproach_ActivateFrontTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_FrontGasTrap_001_50abc78e-d242-4989-bb1f-ba2497b6ece9, "LOW_BhaalApproach_ActivateFrontTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_FrontGasTrap_002_6a27af16-dd11-4c78-a6a8-29c8d952b463, "LOW_BhaalApproach_ActivateFrontTraps");
DB_LOW_BhaalApproach_BridgeTraps(S_LOW_BhaalApproach_FrontGasTrap_003_ba5e5003-f18c-4c9d-a6c9-6dbd8d9b2fd4, "LOW_BhaalApproach_ActivateFrontTraps");
DB_State_Priority(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatStarted", 0);
DB_State_Priority(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CastingStarted", 50);
DB_State_Priority(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOver", 100);
DB_State_Priority(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOverPlayed", 150);
DB_State_Flags(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatStarted", (FLAG)LOW_UndercityRuins_State_CombatStarted_95940e63-9ee8-4903-8223-9848b4cea764);
DB_State_Flags(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CastingStarted", (FLAG)LOW_UndercityRuins_State_CastingStarted_ef010a65-57c5-4433-be88-81611c5d1f22);
DB_State_Flags(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOver", (FLAG)LOW_UndercityRuins_State_CombatEnded_380ee479-d611-450f-a083-4d3e14b07bd6);

PROC
PROC_ApplySavegamePatches("CTY_Main_A","GUS-290664")
AND
DB_Dead(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093)
THEN
PROC_State_Progress(S_LOW_UndercityRuins_Cultist_Sniper_876c18d6-fcf3-4934-abc1-c0939872c093, "LOW_UndercityRuins_CombatADs", "LOW_UndercityRuins_CombatADs_CombatOverPlayed"); //Using this instead of CombatOver for now, as we're still mulling over whether we want the combat over line to play

//END_REGION GUS-290664, GUS-282907

//REGION GUS-307720
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_CurrentLevel("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-307720");
PROC_GLO_Bugfix_307720_TryApplyFix();

PROC
PROC_GLO_Bugfix_307720_TryApplyFix()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // dark urge is currently in a duel. Flag is only set if a duel is ongoing. Gets unset when duel is over/broken.
AND
DB_ORI_DarkUrge((CHARACTER)_DarkUrge)
AND
DB_Players(_Player)
AND
_Player != _DarkUrge
THEN
PROC_LOW_BhaalTemple_Duel_Ally_BlockOrinsHitReaction_Apply(_Player);

// add the non-Combat cultists to the SceneManager so if they are attacked, it counts as breaking the duel as well.
PROC
PROC_GLO_Bugfix_307720_TryApplyFix()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_DarkUrgeIsDuel_bcaa9b35-be89-4775-b493-7f8d40338a1b) // dark urge is currently in a duel. Flag is only set if a duel is ongoing. Gets unset when duel is over/broken.
THEN
PROC_LOW_BhaalTemple_Duel_NonCombat_Setup();
//END_REGION GUS-307720

//REGION GUS-306832
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-306832");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-306832")
THEN
DB_LOW_SharGrotto_ConfrontationParticipants("Guard", (CHARACTER)S_LOW_GrottoCheckpointGuard_000_4502bf48-a7fc-4708-94ef-52bfd8285c6c);
DB_LOW_SharGrotto_ConfrontationParticipants("Guard", (CHARACTER)S_LOW_GrottoCheckpointGuard_001_1effcc57-318d-4d42-873d-7550a399a40b);
DB_LOW_SharGrotto_ConfrontationParticipants("Guard", (CHARACTER)S_LOW_GrottoCheckpointGuard_002_4ed10e2c-72d0-47cd-aee3-ecd531205ac8);
DB_LOW_SharGrotto_ConfrontationParticipants("Guard", (CHARACTER)S_LOW_GrottoCheckpointGuard_003_67f579e5-655b-41e3-b74c-37fe1abd03d4);
DB_LOW_SharGrotto_ConfrontationParticipants("Guard", (CHARACTER)S_LOW_GrottoSentry_90c54fce-9a57-4ff5-9d36-0363ef90c5f1);
PROC_LOW_SharGrotto_NoSummonBy_Patching();

PROC
PROC_LOW_SharGrotto_NoSummonBy_Patching()
AND
DB_LOW_SharGrotto_ConfrontationParticipants(_, _NPC)
AND
NOT DB_CRIME_Guards_NoSummonBy(_NPC)
THEN
DB_CRIME_Guards_NoSummonBy(_NPC);

//END_REGION GUS-306832

//REGION GUS-305869
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-305869");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-305869")
THEN
DB_GLO_FireBowls(LTS_DUN_Chandelier_C_Gold_001_eb1ddd1e-2d3d-465b-883e-67c4c1f81635,LTS_DUN_Chandelier_Hinge_A_Gold_000_42106fb4-7c19-494b-90e2-0773a0598c48);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_003_60114cfa-8adf-473a-9fef-6554f939ab81,LTS_DUN_Chandelier_Hinge_A_003_fb62f17a-eeef-48c9-8538-0d6680562caf);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_006_c8e561f0-6ea6-4e40-abca-bb8a2bdea79c,LTS_DUN_Chandelier_Hinge_A_007_872b81f4-8619-4f92-8b08-48d3857695ff);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_014_6aaea354-37d9-4906-9422-94ea67193061,LTS_DUN_Chandelier_Hinge_A_015_aecac2f6-e7ab-4b8e-9424-c285a5467c0f);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_015_e19c89e1-df15-48f5-b455-1cacd1a34ee7,LTS_DUN_Chandelier_Hinge_A_016_69361c38-813e-4402-ab03-1736285a4ff2);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_016_7df33aa9-e785-4b70-afbe-e9124fafc62e,LTS_DUN_Chandelier_Hinge_A_017_6516fa48-f38e-4b0a-ade1-f0b2926ccf96);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_021_be5b9ae4-80a2-45fe-a5ff-1fca2812738a,LTS_DUN_Chandelier_Hinge_A_008_14f0c041-a50e-4f2c-8e5e-54c9bfa822c2);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_019_2a01d65d-af4a-48a9-90ea-b6c8b9a03486,LTS_DUN_Chandelier_Hinge_A_020_bca1039f-5a07-40de-b3b2-eb600efa6d4b);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_020_862260c1-410f-4cb7-bc1e-61e1d079a31e,LTS_DUN_Chandelier_Hinge_A_021_08bc0803-0abe-4ced-a3a1-8f4725eb7ff1);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_017_e8aff108-2f6f-43af-b453-3724da3a75ad,LTS_DUN_Chandelier_Hinge_A_018_86ae1cdb-6f98-4505-a909-15ca750fa82e);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_018_66e43793-c66d-4404-9282-ac70abc2737a,LTS_DUN_Chandelier_Hinge_A_019_5902b8f3-8de5-4a2d-97ac-24f46ed736f2);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_997bda72-8539-498a-ab3c-8410450d3523,LTS_DUN_Chandelier_Hinge_A_f1d480db-f57e-4c06-977f-69a75da64c0a);
DB_GLO_FireBowls(LTS_DUN_Chandelier_B_e3ad3f6c-d54c-4050-9c04-89a1e9c5d313,LTS_DUN_Chandelier_Hinge_A_79c1e9fe-90aa-4f34-88db-295b02294375);
DB_GLO_FireBowls(LTS_DUN_Chandelier_A_e6dfe494-1355-470a-afb0-b6f96322e246,LTS_DUN_Chandelier_Hinge_A_ca8308fa-5725-4e73-9640-4e41f3448a71);
DB_GLO_FireBowls(LTS_DUN_Chandelier_A_2b4b453d-70ec-4681-85a3-fd35fd0b2ebb,LTS_DUN_Chandelier_Hinge_A_09328878-6e9f-48b6-b3ee-4210734eac08);
//END_REGION GUS-305869

//REGION GUS-306836
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-306836");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-306836")
AND
DB_LOW_VoloFate_Thugs(_Character)
AND
DB_OwnedCorpse(_Character,_)
AND
NOT DB_OffStage(_Character)
THEN
PROC_ClearCorpseOwner(_Character);
//END_REGION GUS-306836

//REGION GUS-308575
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-308575");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-308575")
AND
DB_Dead(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
NOT DB_Dead(S_LOW_MurderTribunal_Amelyssan_eca47258-a8ad-4453-a12a-3f39f8e1ca32)
THEN
ApplyStatus(S_LOW_MurderTribunal_Amelyssan_eca47258-a8ad-4453-a12a-3f39f8e1ca32,"LOW_SAREVOK_ESSENCE_AMELYSSAN_GHOST_SAREVOKDEAD",-1.0,0,S_LOW_MurderTribunal_Amelyssan_eca47258-a8ad-4453-a12a-3f39f8e1ca32);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-308575")
AND
DB_Dead(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
NOT DB_Dead(S_LOW_MurderTribunal_Illasera_df3a6de2-ba33-4717-9861-ea9f42d35fec)
THEN
ApplyStatus(S_LOW_MurderTribunal_Illasera_df3a6de2-ba33-4717-9861-ea9f42d35fec,"LOW_SAREVOK_ESSENCE_ILLASERA_GHOST_SAREVOKDEAD",-1.0,0,S_LOW_MurderTribunal_Illasera_df3a6de2-ba33-4717-9861-ea9f42d35fec);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-308575")
AND
DB_Dead(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
NOT DB_Dead(S_LOW_MurderTribunal_Sendai_565accd2-0fdc-423e-ad68-752988a509b4)
THEN
ApplyStatus(S_LOW_MurderTribunal_Sendai_565accd2-0fdc-423e-ad68-752988a509b4,"LOW_SAREVOK_ESSENCE_SENDAI_GHOST_SAREVOKDEAD",-1.0,0,S_LOW_MurderTribunal_Sendai_565accd2-0fdc-423e-ad68-752988a509b4);

//END_REGION GUS-308575

//REGION GUS-308759
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-308759");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308759")
THEN
SetDetached(S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, 1);
SetCanFight(S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, 0);
SetCanJoinCombat(S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, 0);
ApplyStatus(S_LOW_CazadorsPalace_Cells_InvisibleHelper_99f0cd39-ca7d-479b-bd3a-95d7b8446156, "INVULNERABLE_NOT_SHOWN", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

// prisoners are immortal and shouldn't run away from dangerous surfaces
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308759")
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_ReleasedPrisoners_5784cf70-bff9-467c-b150-39d1f5a78240)
AND
NOT DB_GlobalFlag((FLAG)LOW_CazadorsPalace_RitualRoom_State_KilledPrisoners_a138792f-04ae-410b-afce-1bf661e9c868)
AND
DB_LOW_CazadorsPalace_Cells_Prisoners(_Prisoner, _, _)
THEN
SetTag(_Prisoner, (TAG)IGNORE_DANGEROUS_SURFACES_bbf62461-4af4-4631-807a-eb0bd988d9a6);
//END_REGION GUS-308759

//REGION GUS-307869

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-307869");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-307869")
THEN
SetCanFight(S_LOW_HouseOfHope_PetrifiedDebtor1_60e5372b-e0af-4c4e-a8af-c97d99574bca, 0);
SetCanFight(S_LOW_HouseOfHope_PetrifiedDebtor2_9a85d4f1-47be-4c2c-b252-5179b496bc17, 0);
SetCanFight(S_LOW_HouseOfHope_PetrifiedDebtor3_579aa7d5-6220-4616-acfd-ee79a955b5fc, 0);
SetCanJoinCombat(S_LOW_HouseOfHope_PetrifiedDebtor1_60e5372b-e0af-4c4e-a8af-c97d99574bca, 0);
SetCanJoinCombat(S_LOW_HouseOfHope_PetrifiedDebtor2_9a85d4f1-47be-4c2c-b252-5179b496bc17, 0);
SetCanJoinCombat(S_LOW_HouseOfHope_PetrifiedDebtor3_579aa7d5-6220-4616-acfd-ee79a955b5fc, 0);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-307869")
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a)
THEN
SetCanFight(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 0);
SetCanJoinCombat(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 0);

//END_REGION GUS-307869

//REGION GUS-309020
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-309020");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-309020")
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_UndeadHusbandArrivedWithMayrina_c55490ca-a1ca-456c-bdad-2ae148db02c4)
THEN
NOT DB_PermaDefeatedFlag(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,(FLAG)LOW_HagSurvivors_State_Connor_PermaDefeated_98eb28de-726e-451c-990a-7314e7a1e20b);
DB_DefeatedStateFlag(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,(FLAG)LOW_HagSurvivors_State_Connor_Defeated_98eb28de-726e-451c-990a-7314e7a1e20b);
DB_CanBeResurrected(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HagSurvivors_State_MayrinaDestroyedHusbandWand_fde722e6-b512-4fe4-8a2e-de00027a4856,(DIALOGRESOURCE)LOW_HagSurvivors_SurrogateMother_Cured_f776ecd3-8e2a-2c91-645c-5a91e0f5d646);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-309020")
AND
DB_GlobalFlag((FLAG)LOW_HagSurvivors_State_UndeadHusbandArrivedWithMayrina_c55490ca-a1ca-456c-bdad-2ae148db02c4)
AND
DB_PermaDefeated(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5)
THEN
NOT DB_PermaDefeated(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5);
DB_Dialogs(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5,(DIALOGRESOURCE)LOW_HagSurvivors_UndeadHusband_015571b8-a869-77fa-374d-c173fb9df480);
PROC_LOW_BUGFIX_UndeadHusbandClearDefeatedFlag();

PROC
PROC_LOW_BUGFIX_UndeadHusbandClearDefeatedFlag()
AND
NOT DB_Defeated(S_HAG_Hagspawn_HusbandJake_133bf997-7c0d-4c64-88c9-9b9cd439dbb5)
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_HagSurvivors_State_Connor_Defeated_98eb28de-726e-451c-990a-7314e7a1e20b);
//END_REGION GUS-309020

//REGION GUS-307889
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-307889_CTY");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307889_CTY")
THEN
Transform(S_LOW_DammonsWhetstone_382bdff0-ff93-443d-9bcc-012440cd7f5c, INTERACT_TOOL_Smith_Whetstone_Wheel_B_985bb624-6726-4243-bc6a-9274a95bf5fd, (SHAPESHIFTRULE)Physical_4acc6277-6dcd-4110-9450-b9379beaedac);
//END_REGION GUS-307889

//REGION GUS-307827
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-307827");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-307827")
AND
DB_PermaDefeated(S_DEN_Tiefling_010_23129d6c-8d39-4a4c-a4f6-cfc6637b597c)
AND
NOT DB_GlobalFlag(LOW_Elfsong_State_LakrissaPermaDefeated_5db59b9f-a8a5-4c58-b386-0af81fab8eea)
THEN
SetFlag(LOW_Elfsong_State_LakrissaPermaDefeated_5db59b9f-a8a5-4c58-b386-0af81fab8eea);

//END_REGION GUS-307827

//REGION GUS-305076
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-305076");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-305076")
AND
DB_QuestIsClosed("LOW_ReachEmperorLair")
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_Elfsong_KitchenBeforeCellar_68d030d5-03a1-466c-a168-0115924c0c4a);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-305076")
AND
DB_QuestIsClosed("LOW_ReachEmperorLair")
AND
DB_CTY_DaisyElfsongApproach(_Trigger)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);
NOT DB_CTY_DaisyElfsongApproach(_Trigger);
//END_REGION GUS-305076

//REGION GUS-307728
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-307728");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-307728")
AND
DB_GLO_DefeatCounter(_Gith, "LOW_Elfsong_KotS_GithyankiCombat")
AND
HasActiveStatus(_Gith, "TEMPORARILY_HOSTILE", 1)
AND
QRY_OnlyOnce("GUS-307728")
THEN
PROC_SetRelationToPlayers(ACT3_LOW_Elfsong_Githyanki_e2c5c1ae-1797-44af-bd68-4071820b7e89, 0);
//END_REGION GUS-307728

//REGION GUS-308748
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-308748");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308748")
THEN
PROC_LOW_BUGFIX_CheckRamazithItemsPos((ITEM)S_LOW_MagicItemRamazith_000_7a15ab31-e722-4ce0-8f1c-907025e3bef0,(TRIGGER)S_LOW_SorcerousSundries_MagicItemTrigger_000_004c17ab-5cfc-44ab-99fc-0915206d29d4,(ITEM)S_LOW_MagicItemRamazith_Barrier_000_62b8513b-2e9f-405e-8f7e-7ea590a1e93c);
PROC_LOW_BUGFIX_CheckRamazithItemsPos((ITEM)S_LOW_MagicItemRamazith_001_8ed5daac-b55f-40df-938c-34dc189101ad,(TRIGGER)S_LOW_SorcerousSundries_MagicItemPosTrigger_001_7256ae8f-19f3-46de-94b6-876c7717f0f1,(ITEM)S_LOW_MagicItemRamazith_Barrier_001_1c250ae9-3ea6-43f8-b0a9-33da13d8c2f0);

PROC
PROC_LOW_BUGFIX_CheckRamazithItemsPos((ITEM)_Item,(TRIGGER)_Trigger,(ITEM)_Barrier)
AND
IsInTrigger(_Item,_Trigger,1)
AND
NOT DB_Defeated(_Barrier)
THEN
SetCanInteract(_Item,0);
DB_LOW_SorcerousSundries_Barriers(_Barrier, _Item);
//END_REGION GUS-308748

//REGION GUS-307824
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_Players(_InventoryHolder)
AND
IsInInventoryOf(S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, _InventoryHolder, 1)
THEN
DB_BUGFIX_Marker("GUS-307824");
PROC_SetCorpseOwner((CHARACTER)S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, _InventoryHolder);
SetCharacterLootOwned(S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, 0);
//END_REGION GUS-307824

//REGION GUS-302408
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-302408");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-302408")
THEN
SetCanJoinCombat(S_LOW_Elfsong_Cat_001_2108d072-77be-49b2-b3ad-9e9a94f71c40, 0);
SetCanJoinCombat(S_LOW_Elfsong_Cat_002_d7b843fe-3496-4129-826a-25e50aa189c9, 0);
//END_REGION GUS-302408

//REGION GUS-309917
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-309917");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309917")
THEN
DB_QuestDef_State((FLAG)LOW_DockWareHouse_State_ReadResignationLetter_e55051c0-1b34-444a-8247-12208ef5be27, "LOW_AvengeWaveservant", "FoundBeastMastersLetter");
DB_QuestDef_State((FLAG)LOW_DockWareHouse_State_ReadResignationLetter_WithRavengard_a65a0874-9c21-47af-879d-9cf27474b634, "LOW_AvengeWaveservant", "FoundBeastMastersLetter");
DB_QuestDef_State((FLAG)LOW_WaterQueensHouse_State_ToldAllandraBeastmasterGone_f1b6efee-4870-4aa0-b345-2dbf7057a001, "LOW_AvengeWaveservant", "ToldAllandraBeastGone");
DB_BookFlags(S_LOW_Beastmaster_LetterOfResignation_72d89d37-ed12-481d-b7f0-61a1039dbe58, (FLAG)LOW_DockWareHouse_State_ReadResignationLetter_e55051c0-1b34-444a-8247-12208ef5be27);
DB_BookFlags(S_LOW_Beastmaster_LetterOfResignation_Ravengard_78e123e6-90da-4368-8b1b-5d626b55b376, (FLAG)LOW_DockWareHouse_State_ReadResignationLetter_WithRavengard_a65a0874-9c21-47af-879d-9cf27474b634);
PROC_SetOnStage(S_LOW_Beastmaster_LetterOfResignation_Ravengard_78e123e6-90da-4368-8b1b-5d626b55b376, 0);

//Retroactive Wulben support flag
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "LOW_Foundry", "GortashDead", 1)
AND
NOT DB_PermaDefeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
SetFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98);

//Replacing the resignation letter on the ground if Ravengard died in the Iron Throne
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309917")
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
NOT IsInInventory(S_LOW_Beastmaster_LetterOfResignation_72d89d37-ed12-481d-b7f0-61a1039dbe58, 1)
THEN
PROC_SetOnStage(S_LOW_Beastmaster_LetterOfResignation_Ravengard_78e123e6-90da-4368-8b1b-5d626b55b376, 1);
PROC_SetOnStage(S_LOW_Beastmaster_LetterOfResignation_72d89d37-ed12-481d-b7f0-61a1039dbe58, 0);

//Replacing the resignation letter in inventory if Ravengard died in the Iron Throne
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309917")
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9)
AND
DB_GlobalFlag((FLAG)IRN_IronThrone_State_RavengardPresent_2e102a34-500a-4cd2-ba93-51d1a8b96496)
AND
NOT DB_GlobalFlag((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c)
AND
IsInInventory(S_LOW_Beastmaster_LetterOfResignation_72d89d37-ed12-481d-b7f0-61a1039dbe58, 1)
AND
GetInventoryOwner(S_LOW_Beastmaster_LetterOfResignation_72d89d37-ed12-481d-b7f0-61a1039dbe58, _Owner)
THEN
PROC_ToInventoryAndOnStage(S_LOW_Beastmaster_LetterOfResignation_Ravengard_78e123e6-90da-4368-8b1b-5d626b55b376, _Owner, 1, 0, 1);
RequestDelete(S_LOW_Beastmaster_LetterOfResignation_72d89d37-ed12-481d-b7f0-61a1039dbe58);

//Patching the patch
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_PermaDefeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_GlobalFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98)
THEN
ClearFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98);
//END_REGION GUS-309917

//REGION GUS-309749
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
NOT DB_CrimeType_CustomWarning((CHARACTER)S_LOW_TempleGuardian_32ec6ad3-c085-4fc5-943b-e2e3a05d9f2b,"UseForbiddenItem",(DIALOGRESOURCE)LOW_StormshoreTabernacle_PriestReactStealAttempt_8312057c-be25-c22a-ea1c-e7f9cfc1aac3);
DB_BUGFIX_Marker("GUS-309749");
//END_REGION GUS-309749

//REGION GUS-309771
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-309771");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309771")
THEN
PROC_SetAnubisConfig(S_LOW_Elfsong_Exterior_Patron_000_c1a924a2-032a-4f21-9849-93cfa6af83f8, "LOW_Elfsong_Exterior_Patron_000");
PROC_SetAnubisConfig(S_LOW_Elfsong_Exterior_Patron_002_31d1b1ba-5d49-438a-849b-f6554bb361f9, "LOW_Elfsong_Patron_002_ChangedInterior");
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_001_efb4061b-46b1-4e6d-94fb-394c69106088, "LOW_Elfsong_Patron_001");
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_006_b026b2d2-bd8a-4ca6-910d-03d23bfd637b, "LOW_Elfsong_Patron_006");
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_008_a29c8ff1-ce29-42c0-a426-c955cdb485bd, "LOW_Elfsong_Patron_008");
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_011_a69ca09c-3d04-4b21-bf79-6396a574763f, "LOW_Elfsong_Exterior_Patron_011_ExteriorChanged");
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_015_2c08c5c3-88a1-4eb0-9bd8-938a94e08b07, "LOW_Elfsong_Patron_015");
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_013_8e7088f7-500c-49fb-af01-1421b060bb8d, "LOW_Elfsong_Patron_013");
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_012_7ec9de35-051c-469a-a262-b99acb5c145f, "LOW_Elfsong_Patron_012");
PROC_SetAnubisConfig(S_LOW_Elfsong_Patron_014_f2759ac8-fb14-4c20-9ab0-0c9dd72c8b71, "LOW_Elfsong_Patron_014_ChangedExterior");
//END_REGION GUS-309771

//REGION GUS-305917
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-305917");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-305917")
AND
DB_OnlyOnce("LOW_SorcerousSundries_RolanMovesIn")
THEN
SetFlag((FLAG)GLO_Prodigy_State_InCity_5de01603-0dc7-4ebc-99f1-da5342ba9fd7);
DB_BUGFIX_Marker("GUS-305917");
//END_REGION GUS-305917

//REGION GUS-304288
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-304288");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-309462")
THEN
SetVisible((ITEM)S_Ramazith_Cannon_000_a6d7dd21-62d7-413a-aa1c-fdcc31fe5fec,0);
SetVisible((ITEM)S_Ramazith_Cannon_001_b9e1286d-1964-428c-8d8f-a3c0145994af,0);
DB_BUGFIX_Marker("GUS-309462");
//END_REGION GUS-304288

//REGION GUS-309462

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4","CTY_Main_A","GUS-309462");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-309462")
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfGrief_Event_ViconiaVanish_7fe5f6da-016e-458a-b181-5bd3bba75158, (DIALOGRESOURCE)LOW_HouseOfGrief_MeetingViconia_OM_Shadowheart_COM_7faa8762-49df-5912-49cd-79f8bb626e57);


//END_REGION GUS-309462

//REGION GUS-303149
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-303149");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-303149")
THEN
DB_LOW_OskarsBeloved_AuraItems((TRIGGER)S_LOW_OskarsBeloved_AuraItemTrigger_003_700ddfcc-a899-497d-9445-84c5783a96f6,(ITEM)S_LOW_AuraItem_003_54f8cff0-6ec9-4974-a49f-62622e854e0e);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-303149")
AND
DB_LOW_OskarsBeloved_NoblesPreparingDuel(1)
THEN
SetHasDialog(S_LOW_AngryNoble_001_4707eca2-13b3-4912-9f5f-7a8ae5307aeb,1);
SetHasDialog(S_LOW_AngryNoble_002_24376c44-ee3e-4131-86b1-25b738aee446,1);
NOT DB_LOW_OskarsBeloved_NoblesArguing(1);
//END_REGION GUS-303149

//REGION GUS-304977
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-304977");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304977")
AND
GetOwner((ITEM)S_LOW_NightsongPamphlet_000_40ad72cb-ae54-4b45-a4ce-d9c85d61611d,_Owner)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_Owner)
AND
IsInInventoryOf((ITEM)S_LOW_NightsongPamphlet_000_40ad72cb-ae54-4b45-a4ce-d9c85d61611d, _Owner,0)
THEN
ClearOwnership((ITEM)S_LOW_NightsongPamphlet_000_40ad72cb-ae54-4b45-a4ce-d9c85d61611d);
//END_REGION GUS-304977

//REGION GUS-307604
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4")
AND
NOT DB_Defeated(S_LOW_CarrionJarDiagrams_c8a2228a-adff-4fcd-b60a-81f81c033e2f)
THEN
DB_BUGFIX_307604_PrepareForDiagramsShapeshift(1);

IF
DB_CurrentLevel("CTY_Main_A")
AND
DB_BUGFIX_307604_PrepareForDiagramsShapeshift(1)
AND
IsOnStage(S_LOW_CarrionJarDiagrams_c8a2228a-adff-4fcd-b60a-81f81c033e2f,1)
THEN
PROC_BUGFIX_PhilgravesMansion_TransformDiagrams();

IF
DB_CurrentLevel("BGO_Main_A")
AND
DB_BUGFIX_307604_PrepareForDiagramsShapeshift(1)
AND
IsOnStage(S_LOW_CarrionJarDiagrams_c8a2228a-adff-4fcd-b60a-81f81c033e2f,1)
THEN
PROC_BUGFIX_PhilgravesMansion_TransformDiagrams();

PROC
PROC_BUGFIX_PhilgravesMansion_TransformDiagrams()
THEN
NOT DB_BUGFIX_307604_PrepareForDiagramsShapeshift(1);
Transform(S_LOW_CarrionJarDiagrams_c8a2228a-adff-4fcd-b60a-81f81c033e2f, (ITEMROOT)DEC_Druids_Tablet_Stone_C_27cfa136-43a4-42c4-9331-f9bce7352f8a, (SHAPESHIFTRULE)WildShapeKeepName_9c580a1d-dab9-4b17-b0da-b16c7d7360e0);
PROC_SetInvulnerable(S_LOW_CarrionJarDiagrams_c8a2228a-adff-4fcd-b60a-81f81c033e2f,1);

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-307604");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307604")
THEN
PROC_BUGFIX_PhilgravesMansion_SetGravityItemsAncientLair((ITEM)DEC_GEN_Corpse_Body_Part_Arm_A_001_c4b080ab-c2b2-4004-814a-a682d081820d);
PROC_BUGFIX_PhilgravesMansion_SetGravityItemsAncientLair((ITEM)DEC_GEN_Corpse_Body_Part_Leg_A_Githyanki_000_5741bb63-22d0-46c4-834e-936c86aec5e4);

PROC
PROC_BUGFIX_PhilgravesMansion_SetGravityItemsAncientLair((ITEM)_BodyPart)
AND
IsOnStage(_BodyPart,1)
THEN
SetGravity(_BodyPart,GRAVITYTYPE.Enabled);
//END_REGION GUS-307604
//REGION GUS-294895
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-294895");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-294895")
THEN
PROC_SetAnubisConfig(S_LOW_EastwayWizards_Wizard2_84f55c6c-66cb-48e4-b701-e2c9d2b58364, "LOW_EastwayWizards_Wizard2");
PROC_SetAnubisConfig(S_LOW_EastwayWizards_Wizard1_e8c13e82-d960-461e-97ad-7efa5c066ae8, "LOW_EastwayWizards_Wizard1");
PROC_SetAnubisConfig(S_LOW_EastwayWizards_Wizard3_96ee5c49-f45d-4657-b43d-fe7f4e74aab4, "LOW_EastwayWizards_Wizard3");
AddSpell(S_LOW_EastwayWizards_Wizard2_84f55c6c-66cb-48e4-b701-e2c9d2b58364, "Shout_Thaumaturgy", 0, 0);
AddSpell(S_LOW_EastwayWizards_Wizard2_84f55c6c-66cb-48e4-b701-e2c9d2b58364, "Target_DancingLights", 0, 0);
AddSpell(S_LOW_EastwayWizards_Wizard2_84f55c6c-66cb-48e4-b701-e2c9d2b58364, "Shout_BladeWard", 0, 0);
AddSpell(S_LOW_EastwayWizards_Wizard1_e8c13e82-d960-461e-97ad-7efa5c066ae8, "Target_DancingLights", 0, 0);
AddSpell(S_LOW_EastwayWizards_Wizard1_e8c13e82-d960-461e-97ad-7efa5c066ae8, "Shout_BladeWard", 0, 0);
AddSpell(S_LOW_EastwayWizards_Wizard1_e8c13e82-d960-461e-97ad-7efa5c066ae8, "Projectile_FireBolt", 0, 0);
AddSpell(S_LOW_EastwayWizards_Wizard3_96ee5c49-f45d-4657-b43d-fe7f4e74aab4, "Target_DancingLights", 0, 0);
AddSpell(S_LOW_EastwayWizards_Wizard3_96ee5c49-f45d-4657-b43d-fe7f4e74aab4, "Shout_BladeWard", 0, 0);
AddSpell(S_LOW_EastwayWizards_Wizard3_96ee5c49-f45d-4657-b43d-fe7f4e74aab4, "Projectile_RayOfFrost", 0, 0);
DB_LOW_EastwayWizards_TargetBox((CHARACTER)S_LOW_EastwayWizards_Wizard3_96ee5c49-f45d-4657-b43d-fe7f4e74aab4, (TRIGGER)S_LOW_EastwayWizards_Box_Illusion_000_3eed324b-7ace-4b5d-9b67-38ab8b7b6e9d);
DB_LOW_EastwayWizards_TargetBox((CHARACTER)S_LOW_EastwayWizards_Wizard1_e8c13e82-d960-461e-97ad-7efa5c066ae8, (TRIGGER)S_LOW_EastwayWizards_Box_Illusion_001_c63eb773-770a-4642-8c0b-2477c9902265);
//END_REGION GUS-294895

//REGION GUS-294094
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 4", "CTY_Main_A", "GUS-294094");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-294094")
AND
DB_OffStage(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103)
THEN
DB_SavegamePatch_GUS294094(1);
PROC_SetOnStage(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, 1);

IF
WentOnStage(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, 1)
AND
DB_SavegamePatch_GUS294094(1)
THEN
ApplyStatus(S_LOW_KurwinCoffin_ExplodingBody_75c8723c-9b08-435d-b053-eac14b482103, "LOW_KURWINCOFFIN_BLOATEDCORPSE", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SavegamePatch_GUS294094(1);
//END_REGION GUS-294094

//REGION GUS-310181
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310181");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310181")
THEN
NOT DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_CazadorsPalace_Bedrooms_DeadGirl_3a033a94-5313-4f28-94ef-f1f784aa8d74, (DIALOGRESOURCE)LOW_CazadorsPalace_Bedrooms_DeadGirl_Dead_f6c031f9-7a0c-e595-8a89-a4f74cfb9354);
//END_REGION GUS-310181

//REGION GUS-310675

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310675");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310675")
AND
NOT DB_OffStage(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb)
AND
NOT DB_DialogName((DIALOGRESOURCE)LOW_MurderTribunal_Sarevok_Trial_3915585f-80ff-ecd2-57fc-9dc268a7ce90,_)
THEN
PROC_FadeOutEntity(S_LOW_MurderTribunal_MurderVictim_997a264b-7650-4be8-a315-b27139f07efb);

//END_REGION GUS-310675

//REGION GUS-310179
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310179");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310179")
AND
IsInInventoryOf(97ae4db9-0503-4c1b-97ee-f1ff5a7264e4, CONT_GEN_Chest_Rich_C_002_1d945bfc-cbfb-42bd-8201-7e85a982a588, 1)
AND
TemplateIsInInventory(1a89dbdc-a8b6-4ab2-bade-8ee85eff6c33, CONT_GEN_Chest_Rich_C_002_1d945bfc-cbfb-42bd-8201-7e85a982a588, 2)
THEN
RequestDelete(97ae4db9-0503-4c1b-97ee-f1ff5a7264e4);
//END_REGION

//REGION GUS-306846
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-306846");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-306846")
AND
DB_DialogName((DIALOGRESOURCE)LOW_CazadorsPalace_Coffin_826f2df8-33c9-db18-6b87-0ca5755c9c09, _)
THEN
SetForceUpdate(S_LOW_CazadorsPalace_Cells_AdultDoor_aa404054-9dae-4684-82aa-48c948295e6c, 1);
SetForceUpdate(S_LOW_CazadorsPalace_Cells_ChildrenDoor_6bca442f-383d-46a6-be5b-a5e046aa853e, 1);
//END_REGION

//REGION GUS-311036
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_RemoveDialogEntryForSpeaker((CHARACTER)S_LOW_Refugee03_09218838-74c3-4b72-ab43-7abdfd997b8f, (DIALOGRESOURCE)LOW_Sewers_Refugee02_d68a0a25-3e7e-e3a6-27b8-e33d783cb960);
DB_Dialogs((CHARACTER)S_LOW_Refugee02_267decbc-7902-4e60-bb35-1fe4b6929bf4, (DIALOGRESOURCE)LOW_Sewers_Refugee02_d68a0a25-3e7e-e3a6-27b8-e33d783cb960);
DB_BUGFIX_Marker("GUS-311036");
//END_REGION GUS-311036

//REGION

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-306862");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-306862")
AND
NOT DB_GlobalFlag(LOW_Elfsong_State_GithDefeated_e71ce258-1948-4a32-8834-9e4a6d3e2446)
THEN
DB_LOW_Elfsong_KotS_GithDialogs(LOW_Elfsong_GithyankiShield_OM_Laezel_COM_32558c78-c252-ae93-9f78-1bee7dab002d);
DB_LOW_Elfsong_KotS_GithDialogs(LOW_Elfsong_GithyankiShieldo_OM_Laezel_AOM_OOM_2c9c71fe-ed2a-8181-42e9-9dee66b7743f);
DB_CustomDialogRange(S_LOW_Elfsong_GithyankiShield_Paladin_54467aa9-33dd-41c4-bd77-87a71ed22c16, 30);
//END_REGION

//REGION GUS-310331

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5","CTY_Main_A","GUS-310331");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-310331")
THEN
TriggerRegisterForItems(S_LOW_WaterQueensHouse_OfferingsZone_5c337e89-7408-45e6-9258-d53e0ba157dd);

//END_REGION

//REGION GUS-307776
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-307776");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307776")
THEN
DB_LOW_StormshoreTabernacle_CurseSummons((CHARACTERROOT)LOW_Cambion_Male_StormshoreTabernacle_Curse_2f2f3a4a-ebaa-4dba-9b14-47c6af82ffc6);
DB_LOW_StormshoreTabernacle_CurseSummons((CHARACTERROOT)LOW_Deva_Male_StormshoreTabernacle_Curse_c1095e3a-96f6-400b-95c2-fa6316d06a83);
DB_LOW_StormshoreTabernacle_CurseSummons((CHARACTERROOT)LOW_Djinni_StormshoreTabernacle_Curse_9db24399-3c91-4702-a267-5ead21a64f80);

//END_REGION GUS-307776

//REGION GUS-304348
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-304348");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304348")
THEN
DB_LOW_Elfsong_PrivateRoomPADs_OneUseItems(S_LOW_Elfsong_StelemaneRing_49114c66-a7cc-48d5-895f-9a31c71c4675);

//END_REGION GUS-304348

//REGION GUS-306720
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-306720");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-306720")
AND
IsInInventory(S_LOW_BhaalApproach_BraggingNote_656de8a9-aadc-4935-8b7d-c1695fed6f02, 0)
AND
GetPosition(S_LOW_BhaalApproach_BraggingNote_656de8a9-aadc-4935-8b7d-c1695fed6f02, _X, _Y, _Z)
AND
NOT QRY_Real3CompareWithThreshold(-101.97, -8.97, 1026.53, _X, _Y, _Z, 0.1)
THEN
TeleportToPosition(S_LOW_BhaalApproach_BraggingNote_656de8a9-aadc-4935-8b7d-c1695fed6f02, -101.97, -8.97, 1026.53, "LOW_BraggingNote_TeleportedToPosition", 0, 0, 0, 0, 1);

//END_REGION GUS-306720

//REGION GUS-311392
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_CurrentLevel("CTY_Main_A")
THEN
PROC_GLO_Bugfix_311392_TryRestoreBrokenDuelOnParty();
DB_BUGFIX_Marker("GUS-311392");

PROC
PROC_GLO_Bugfix_311392_TryRestoreBrokenDuelOnParty()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_DuelBroken_0fff2041-7f85-4143-abf3-d16783b4c45e) // duel was broken
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575) // Combat with Orin has not ended yet.
AND
DB_Players(_Player) // for each player
AND
HasActiveStatus((CHARACTER)_Player, "LOW_BHAALTEMPLE_DUEL_NOTIFICATION", 1) // check if they still have the duel status
THEN
PROC_LOW_BhaalTemple_Duel_StartFailFallback(_Player);

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-311392-2");

// savegame patching to move the old trigger locations to the new trigger locations.
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311392-2")
THEN
TeleportTo(S_LOW_BhaalTemple_Duel_Companion1_Pos_bde96a47-c724-4c6f-a237-e5a283d08a09, S_LOW_BhaalTemple_Duel_Companion1_NewPos_746311cb-867b-47f1-941f-40c04db507c8);
TeleportTo(S_LOW_BhaalTemple_Duel_Companion2_Pos_3486f7c9-090d-427d-bd01-16142a6c3d50, S_LOW_BhaalTemple_Duel_Companion2_NewPos_16710df0-7429-4798-8c91-e256adbb3b2b);
TeleportTo(S_LOW_BhaalTemple_Duel_Companion3_Pos_7babb553-989b-4687-a090-56a93cd223ed, S_LOW_BhaalTemple_Duel_Companion3_NewPos_62ea5ae6-b42f-4e39-86ff-fe639a721d86);
//END_REGION

//REGION GUS-311244
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-311244");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311244")
THEN
SetDisableUse(S_LOW_Elfsong_Basement_Portal_001_1b4bb4f5-9601-4ccc-a1b0-8ae1542d98e8, 1);
SetDisableUse(S_LOW_Elfsong_Basement_Portal_002_dbe864c5-0569-478d-b537-f6477b5e2180, 1);
SetDisableUse(S_LOW_Elfsong_Basement_Portal_003_5e52b392-9074-4a63-a695-d6949d0e4d58, 1);
SetDisableUse(S_LOW_Elfsong_Basement_Portal_004_c2514fc6-5cc4-4bf7-9d00-b544ec27f49b, 1);
SetDisableUse(S_LOW_Elfsong_Basement_Portal_005_2c34cf7b-089d-47a1-8794-067422d586a8, 1);

//END_REGION GUS-311244

//REGION GUS-306091

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-306091");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-306091")
THEN
PROC_SetAnubisConfig(S_LOW_SerialKiller_WineFestivalCivilian003_3a893643-8e1f-4b14-ae7a-d0a8e868d5de, "LOW_SerialKiller_WineFestivalCivilian003");
PROC_SetAnubisConfig(S_LOW_SerialKiller_WineFestivalCivilian002_4396e623-f09b-4599-91f3-63900a0c3382, "LOW_SerialKiller_WineFestivalCivilian002");
PROC_SetAnubisConfig(S_LOW_SerialKiller_WineFestivalCivilian001_6d7ef189-307e-4b7a-8c3c-be0c4031b18c, "LOW_SerialKiller_WineFestivalCivilian001");
PROC_SetAnubisConfig(S_LOW_SerialKiller_WineFestivalCivilian004_ce407b77-4218-4a8e-b5c8-399ee2aeffa4, "LOW_SerialKiller_WineFestivalCivilian004");
PROC_SetAnubisConfig(S_LOW_SerialKiller_WineFestivalCivilian005_e6f2dd59-7fee-4ae7-a913-940ceef7fb52, "LOW_SerialKiller_WineFestivalCivilian005");

//END_REGION GUS-306091

//REGION GUS-311853
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-311853");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311853")
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_Dialogs(_TargetVictim, (DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef)
AND
DB_Is_Polymorphed(_TargetVictim)
THEN
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
//END_REGION

//REGION GUS-309603
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-309603");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309603")
THEN
DB_LOW_OskarsBeloved_CarrionPasswordLetters((ITEM)S_LOW_LetterFatherCarrion_c4aae84c-c9b5-4941-a94f-c5c8ead07205);
DB_LOW_OskarsBeloved_CarrionPasswordLetters((ITEM)S_LOW_PhilgravesMansion_LetterFatherCarrion_002_dfcf8310-7986-4465-b71a-21bda436f84d);
DB_LOW_OskarsBeloved_CarrionPasswordLetters((ITEM)S_LOW_PhilgravesMansion_LetterFatherCarrion_003_6e985e7d-017c-45af-b197-255a6763d940);
//END_REGION

//REGION GUS-311220
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-311220");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311220")
THEN
TeleportToPosition(S_LOW_HouseOfHope_Prison_SUB_829b3df1-01b1-4d31-b251-0495c7692bec, -6478.977, -50.897, 2925.739, "", 0, 0, 0, 0, 0);

//END_REGION GUS-311220

//REGION GUS-311118
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-311118");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311118")
AND
DB_Avatars(_Avatar)
AND
GetFlag((FLAG)ORI_Karlach_State_WentToDate_b30f31df-474f-15f3-9bfb-1fc2983c846a, _Avatar, 1)
THEN
PROC_ORI_KarlachDate_TryReplaceBartender();

//END_REGION GUS-311118

//REGION GUS-311267
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-311267");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311267")
THEN
NOT DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Spawn_002_fc7c5cf5-3213-5044-8e7f-7b441391f75d);
DB_LOW_CazadorsPalace_RitualRoom_SpawnDialogs((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Spawn_003_d8b67abb-828e-8c61-4579-3bd7fac37e11);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311267")
AND
DB_Dialogs(S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Spawn_002_fc7c5cf5-3213-5044-8e7f-7b441391f75d)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf);
DB_Dialogs((CHARACTER)S_LOW_CazadorsPalace_RitualRoom_Spawn_003_52ede1c9-6caf-4f7a-8d97-984c0e90e9cf, (DIALOGRESOURCE)LOW_CazadorsPalace_RitualRoom_Spawn_003_d8b67abb-828e-8c61-4579-3bd7fac37e11);
//END_REGION

//REGION GUS-309332

PROC
PROC_ApplySavegamePatches()
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
AND
DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
DB_PreventPermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
THEN
NOT DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
ClearTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);
DB_BUGFIX_Marker("GUS-309332");

PROC
PROC_ApplySavegamePatches()
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-309332");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309332")
AND
NOT DB_GlobalFlag(LOW_HouseOfHope_Event_RaphaelAppeared_c25358e0-5ea1-929b-b511-6e745596d789)
THEN
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,
	(TRIGGER)S_LOW_HouseOfHope_OrthonPoint_a29bb35d-c5f3-404f-9a27-d75c67322bcb,
	(FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724);
PROC_SetOnStage(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, 0);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309332")
AND
DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75)
AND
HasAppliedStatus(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "KNOCKED_OUT", 0)
AND
DB_KnockedOut_RestoreProperties(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _CouldFight, _CouldJoinCombat, _HadOsirisDialog)
THEN
PROC_SetCanFight(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _CouldFight);
SetCanJoinCombat(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _CouldJoinCombat);
SetHasDialog(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _HadOsirisDialog);
NOT DB_DefeatedCauses(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "KnockedOut", 0);
NOT DB_KnockedOut((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
NOT DB_KnockedOut_RestoreProperties(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _CouldFight, _CouldJoinCombat, _HadOsirisDialog);
PROC_KnockedOut_Ended((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309332")
AND
DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75)
THEN
NOT DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
ClearTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (TAG)PERMA_DEFEATED_867f3a1e-1e4b-48c2-869e-343415231727);

//END_REGION GUS-309936

//REGION GUS-309936
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-309936");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309936")
THEN
DB_DefeatedStateFlag(S_LOW_ShadowheartFriend_2c10ff0f-d2ff-4dcb-8f8b-c6f870044f5d, (FLAG)LOW_ShadowheartFriend_State_Defeated_cc356b4c-c53b-4326-8eb2-ae463b670acd);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309936")
AND
DB_PermaDefeated(S_LOW_ShadowheartFriend_2c10ff0f-d2ff-4dcb-8f8b-c6f870044f5d)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_ShadowheartFriend_State_Defeated_cc356b4c-c53b-4326-8eb2-ae463b670acd);
//END_REGION GUS-309936


//REGION GUS-301907
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-301907");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-301907")
THEN
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_Thrumbo_Event_RunAfterBetrayal_00d54df6-0fe7-45c5-b794-e7b326f97ad2,(DIALOGRESOURCE)LOW_PhilgravesMansion_Thrumbo_eaa15ff1-12c2-a8fe-657e-b0e83d779339);
//END_REGION GUS-301907

//REGION GUS-311298
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4 Hotfix 2")
AND
DB_GLO_LevelTraveler((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "CTY_Main_A", "GLO_Shadowheart")
THEN
DB_BUGFIX_Marker("GUS-311298");
PROC_SetAnubisConfig(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679,"GLO_ShadowHeart");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 4 Hotfix 2")
AND
DB_GLO_LevelTraveler((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "CTY_Main_A", "GLO_Shadowheart")
THEN
DB_BUGFIX_Marker("GUS-311298");
NOT DB_GLO_LevelTraveler((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "CTY_Main_A", "GLO_Shadowheart");
DB_GLO_LevelTraveler((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "CTY_Main_A", "GLO_ShadowHeart");

//END_REGION GUS-311298

//REGION GUS-310617
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310617");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-310617")
THEN
NOT DB_LOW_HagDoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_018_bf0822d2-3024-4f12-92f2-34aa003de412);
NOT DB_HAG_HagLair_DoublesSpawnPoints((TRIGGER)S_LOW_BlushingMermaid_DoublesSpawnPoint_018_bf0822d2-3024-4f12-92f2-34aa003de412);
//END_REGION

//REGION GUS-311056
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-311056");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311056")
THEN
PROC_SetAnubisConfig(S_LOW_Elfsong_Exterior_Patron_005_1953efbc-6d0d-431c-8705-103be37192f8, "LOW_Elfsong_Exterior_Patron_005");
PROC_SetAnubisConfig(S_LOW_Elfsong_Exterior_Patron_009_b5c2a086-ff3a-4386-b581-e5befba8e702, "LOW_Elfsong_Exterior_Patron_009");
PROC_SetAnubisConfig(S_LOW_Elfsong_Exterior_Patron_008_25de2571-f001-4556-832a-91db150f0aab, "LOW_Elfsong_Exterior_Patron_008");
SetCanJoinCombat(S_LOW_Elfsong_ComedyPublic_003_1dab7218-58bc-4166-a775-ff923783e342, 1);
SetCanJoinCombat(S_LOW_Elfsong_ComedyPublic_002_241debf0-4efb-4f82-b0ec-bd75533de420, 1);
SetCanJoinCombat(S_LOW_Elfsong_HarvardWilloughby_8a69560f-3a7a-4e6e-81df-eb77de816197, 1);
SetCanJoinCombat(S_LOW_Elfsong_ComedyPublic_001_c1f1d97a-3549-4a03-b756-3a2040673af0, 1);
SetCanJoinCombat(S_LOW_Elfsong_ComedyPublic_004_9f8631d6-b512-45b6-943e-88bb5a985572, 1);
SetCanJoinCombat(S_LOW_Elfsong_ExteriorDrinker_001_0a85d876-472a-4505-a0d2-24c706cbd858, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_002_31d1b1ba-5d49-438a-849b-f6554bb361f9, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_005_1953efbc-6d0d-431c-8705-103be37192f8, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_008_25de2571-f001-4556-832a-91db150f0aab, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_007_5da0601f-e787-4657-b3da-f90de474cc3f, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Waiter_4c498970-d896-42de-b1e1-8757b02a552e, 1);
SetCanJoinCombat(S_LOW_Elfsong_ExteriorDrinker_002_6f46baf6-d0cc-4792-af07-8472605f3491, 1);
SetCanJoinCombat(S_LOW_Elfsong_Skoona_9a4e3f08-739f-4576-a50c-e051ce5126d1, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_000_c1a924a2-032a-4f21-9849-93cfa6af83f8, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_003_a2f68872-56c0-4ad7-ae32-31907d1c3b16, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_004_df00eb84-1d3e-4a65-8586-231e5b03f41f, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_001_b0acaed9-296a-409c-8064-a8aff1131013, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_009_b5c2a086-ff3a-4386-b581-e5befba8e702, 1);
SetCanJoinCombat(S_LOW_Elfsong_Exterior_Patron_006_dbb296c5-29e5-454c-bfd1-f555a8eea857, 1);
SetCanJoinCombat(S_LOW_Elfsong_ExteriorDrinker_003_deaaec38-03dd-4b46-ad87-02a710186d86, 1);
SetCanJoinCombat(S_LOW_Elfsong_Reevor_3e5b30c3-ae3a-48b6-9394-11adde54ad57, 1);
SetCanJoinCombat(S_LOW_Elfsong_Cooker_Assistant_d417bc4a-bb08-4593-b1ae-3241ddbd0d8d, 1);
SetCanJoinCombat(S_LOW_Elfsong_CrowdDrinker_M_001_0db2c322-03a3-4bd2-8be6-f3948ca0e4f8, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_015_2c08c5c3-88a1-4eb0-9bd8-938a94e08b07, 1);
SetCanJoinCombat(S_LOW_Elfsong_CrowdDrinkers_F_002_10baea80-e979-4586-891a-9712903bc3b8, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_009_12920d57-6bea-415f-bb2e-3b3f71d93319, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_003_47868c4b-f879-419e-97fa-bddd9ec526d7, 1);
SetCanJoinCombat(S_LOW_Elfsong_DrinkTest_M_000_1b5b2d4a-367d-45a6-8021-f6c097b0a550, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_005_71f808ce-26f8-435f-9e67-2ff66b0123ad, 1);
SetCanJoinCombat(S_LOW_Elfsong_CrowdDrinkers_F_003_68228876-0c79-4793-a554-c0c354986f4a, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_004_6c8278f3-21ca-439b-881f-7a9994a13972, 1);
SetCanJoinCombat(S_LOW_Elfsong_DrinkTest_M_001_7e960089-71ba-48ff-a3eb-44f814a13309, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_013_8e7088f7-500c-49fb-af01-1421b060bb8d, 1);
SetCanJoinCombat(S_LOW_Elfsong_Oloric_8083ab20-4877-4e16-adca-7f4f400ed87b, 1);
SetCanJoinCombat(S_LOW_Elfsong_CrowdDrinker_M_002_52ccede5-7720-45e1-9eca-321431e9c5a7, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_007_8ed56d53-43bd-407d-bf02-bd9c1035b357, 1);
SetCanJoinCombat(S_LOW_Elfsong_CrowdDrinkers_F_001_a6f5bbdc-8004-4180-b509-68d4d5a0d23f, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_006_b026b2d2-bd8a-4ca6-910d-03d23bfd637b, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_012_7ec9de35-051c-469a-a262-b99acb5c145f, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_008_a29c8ff1-ce29-42c0-a426-c955cdb485bd, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_001_efb4061b-46b1-4e6d-94fb-394c69106088, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_011_a69ca09c-3d04-4b21-bf79-6396a574763f, 1);
SetCanJoinCombat(S_LOW_Elfsong_Falten_f7a12012-0d77-4741-adea-26e9c5c58aea, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_010_beaa5595-dbf8-4bef-9543-3ca62c4564a5, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_002_bfce0ced-b83d-4156-bd90-0d5ac6ec241c, 1);
SetCanJoinCombat(S_LOW_Elfsong_Patron_014_f2759ac8-fb14-4c20-9ab0-0c9dd72c8b71, 1);
SetCanJoinCombat(S_LOW_Elfsong_Inkeeper_81651113-d779-44e8-9d46-d49d5577453b, 1);
SetCanJoinCombat(S_LOW_Elfsong_Yimiur_4e736c46-741a-4643-9b4a-e56dbf21699d, 1);
SetCanFight(S_LOW_Elfsong_ComedyPublic_003_1dab7218-58bc-4166-a775-ff923783e342, 1);
SetCanFight(S_LOW_Elfsong_ComedyPublic_002_241debf0-4efb-4f82-b0ec-bd75533de420, 1);
SetCanFight(S_LOW_Elfsong_HarvardWilloughby_8a69560f-3a7a-4e6e-81df-eb77de816197, 1);
SetCanFight(S_LOW_Elfsong_ComedyPublic_001_c1f1d97a-3549-4a03-b756-3a2040673af0, 1);
SetCanFight(S_LOW_Elfsong_ComedyPublic_004_9f8631d6-b512-45b6-943e-88bb5a985572, 1);
SetCanFight(S_LOW_Elfsong_ExteriorDrinker_001_0a85d876-472a-4505-a0d2-24c706cbd858, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_002_31d1b1ba-5d49-438a-849b-f6554bb361f9, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_005_1953efbc-6d0d-431c-8705-103be37192f8, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_008_25de2571-f001-4556-832a-91db150f0aab, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_007_5da0601f-e787-4657-b3da-f90de474cc3f, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Waiter_4c498970-d896-42de-b1e1-8757b02a552e, 1);
SetCanFight(S_LOW_Elfsong_ExteriorDrinker_002_6f46baf6-d0cc-4792-af07-8472605f3491, 1);
SetCanFight(S_LOW_Elfsong_Skoona_9a4e3f08-739f-4576-a50c-e051ce5126d1, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_000_c1a924a2-032a-4f21-9849-93cfa6af83f8, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_003_a2f68872-56c0-4ad7-ae32-31907d1c3b16, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_004_df00eb84-1d3e-4a65-8586-231e5b03f41f, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_001_b0acaed9-296a-409c-8064-a8aff1131013, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_009_b5c2a086-ff3a-4386-b581-e5befba8e702, 1);
SetCanFight(S_LOW_Elfsong_Exterior_Patron_006_dbb296c5-29e5-454c-bfd1-f555a8eea857, 1);
SetCanFight(S_LOW_Elfsong_ExteriorDrinker_003_deaaec38-03dd-4b46-ad87-02a710186d86, 1);
SetCanFight(S_LOW_Elfsong_Reevor_3e5b30c3-ae3a-48b6-9394-11adde54ad57, 1);
SetCanFight(S_LOW_Elfsong_Cooker_Assistant_d417bc4a-bb08-4593-b1ae-3241ddbd0d8d, 1);
SetCanFight(S_LOW_Elfsong_CrowdDrinker_M_001_0db2c322-03a3-4bd2-8be6-f3948ca0e4f8, 1);
SetCanFight(S_LOW_Elfsong_Patron_015_2c08c5c3-88a1-4eb0-9bd8-938a94e08b07, 1);
SetCanFight(S_LOW_Elfsong_CrowdDrinkers_F_002_10baea80-e979-4586-891a-9712903bc3b8, 1);
SetCanFight(S_LOW_Elfsong_Patron_009_12920d57-6bea-415f-bb2e-3b3f71d93319, 1);
SetCanFight(S_LOW_Elfsong_Patron_003_47868c4b-f879-419e-97fa-bddd9ec526d7, 1);
SetCanFight(S_LOW_Elfsong_DrinkTest_M_000_1b5b2d4a-367d-45a6-8021-f6c097b0a550, 1);
SetCanFight(S_LOW_Elfsong_Patron_005_71f808ce-26f8-435f-9e67-2ff66b0123ad, 1);
SetCanFight(S_LOW_Elfsong_CrowdDrinkers_F_003_68228876-0c79-4793-a554-c0c354986f4a, 1);
SetCanFight(S_LOW_Elfsong_Patron_004_6c8278f3-21ca-439b-881f-7a9994a13972, 1);
SetCanFight(S_LOW_Elfsong_DrinkTest_M_001_7e960089-71ba-48ff-a3eb-44f814a13309, 1);
SetCanFight(S_LOW_Elfsong_Patron_013_8e7088f7-500c-49fb-af01-1421b060bb8d, 1);
SetCanFight(S_LOW_Elfsong_Oloric_8083ab20-4877-4e16-adca-7f4f400ed87b, 1);
SetCanFight(S_LOW_Elfsong_CrowdDrinker_M_002_52ccede5-7720-45e1-9eca-321431e9c5a7, 1);
SetCanFight(S_LOW_Elfsong_Patron_007_8ed56d53-43bd-407d-bf02-bd9c1035b357, 1);
SetCanFight(S_LOW_Elfsong_CrowdDrinkers_F_001_a6f5bbdc-8004-4180-b509-68d4d5a0d23f, 1);
SetCanFight(S_LOW_Elfsong_Patron_006_b026b2d2-bd8a-4ca6-910d-03d23bfd637b, 1);
SetCanFight(S_LOW_Elfsong_Patron_012_7ec9de35-051c-469a-a262-b99acb5c145f, 1);
SetCanFight(S_LOW_Elfsong_Patron_008_a29c8ff1-ce29-42c0-a426-c955cdb485bd, 1);
SetCanFight(S_LOW_Elfsong_Patron_001_efb4061b-46b1-4e6d-94fb-394c69106088, 1);
SetCanFight(S_LOW_Elfsong_Patron_011_a69ca09c-3d04-4b21-bf79-6396a574763f, 1);
SetCanFight(S_LOW_Elfsong_Falten_f7a12012-0d77-4741-adea-26e9c5c58aea, 1);
SetCanFight(S_LOW_Elfsong_Patron_010_beaa5595-dbf8-4bef-9543-3ca62c4564a5, 1);
SetCanFight(S_LOW_Elfsong_Patron_002_bfce0ced-b83d-4156-bd90-0d5ac6ec241c, 1);
SetCanFight(S_LOW_Elfsong_Patron_014_f2759ac8-fb14-4c20-9ab0-0c9dd72c8b71, 1);
SetCanFight(S_LOW_Elfsong_Inkeeper_81651113-d779-44e8-9d46-d49d5577453b, 1);
SetCanFight(S_LOW_Elfsong_Yimiur_4e736c46-741a-4643-9b4a-e56dbf21699d, 1);
SetFaction(S_LOW_Elfsong_Patron_006_b026b2d2-bd8a-4ca6-910d-03d23bfd637b, (FACTION)Act3_LOW_Elfsong_Combatants_567aca2d-3233-4fda-b653-25b08bff36a8);
SetFaction(S_LOW_Elfsong_Patron_001_efb4061b-46b1-4e6d-94fb-394c69106088, (FACTION)Act3_LOW_Elfsong_Combatants_567aca2d-3233-4fda-b653-25b08bff36a8);
SetFaction(S_LOW_Elfsong_Skoona_9a4e3f08-739f-4576-a50c-e051ce5126d1, (FACTION)Act3_LOW_Elfsong_Combatants_567aca2d-3233-4fda-b653-25b08bff36a8);
//END_REGION GUS-311056

//REGION GUS-310336
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310336");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310336")
THEN
PROC_SetOnStage((ITEM)S_LOW_CazadorsPalace_Ballroom_MainDoorLever_17db95e4-5f30-468a-bbb4-b7fa60d609c3, 0);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310336")
AND
DB_GlobalFlag(LOW_CazadorsPalace_Ballroom_State_DoorOpenedOnce_ce614a26-b07b-4c51-a493-436c65281e8c)
AND
IsOpened(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, 1)
AND
IsLocked(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, 1)
THEN
Unlock(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37);
//END_REGION

//REGION GUS-310271
PROC
PROC_ApplySavegamePatches()
AND
NOT DB_GLO_Backgrounds_Blocked("Act3_Criminal_TabernacleOfferingStolen")
THEN
DB_GUS_310271_Patching((ITEM)S_LOW_TyrChest_8deff203-fc4c-4af0-8964-760570a6f0b6, "LOW_StormshoreTabernacle_Tyr_Treasure");
DB_GUS_310271_Patching((ITEM)S_LOW_GenericGodChest_8c43197d-6bfa-4ddf-9ee5-d3f75b1444d3, "LOW_StormshoreTabernacle_GenericGod_Treasure");
DB_GUS_310271_Patching((ITEM)S_LOW_HelmChest_7c134a77-9e01-4505-a0e8-d17618433198, "LOW_StormshoreTabernacle_Helm_Treasure");
DB_GUS_310271_Patching((ITEM)S_LOW_SeluneChest_f78b817a-6077-4f02-85e6-9de0538655c8, "LOW_StormshoreTabernacle_Selune_Treasure");
DB_GUS_310271_Patching((ITEM)S_LOW_MystraChest_9d264e11-9a5a-4e42-bf80-e3db095b50a9, "LOW_StormshoreTabernacle_Mystra_Treasure");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310271");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310271")
AND
DB_GUS_310271_Patching(_Chest, _TreasureID)
THEN
PROC_LOW_GUS310271(_Chest);

PROC
PROC_LOW_GUS310271((ITEM)_Chest)
AND
IsActive(_Chest,_Active)
THEN
DB_LOW_GUS310271_ActiveState(_Chest,_Active);

PROC
PROC_LOW_GUS310271((ITEM)_Chest)
AND
DB_LOW_GUS310271_ActiveState(_Chest,0)
THEN
SetForceUpdate(_Chest,1);

IF
Activated(_Chest)
AND
DB_LOW_GUS310271_ActiveState((ITEM)_Chest,0)
THEN
NOT DB_LOW_GUS310271_ActiveState((ITEM)_Chest,0);
DB_LOW_GUS310271_ActiveState((ITEM)_Chest,1);
SetForceUpdate(_Chest,0);

IF
DB_LOW_GUS310271_ActiveState((ITEM)_Chest,1)
AND
DB_GUS_310271_Patching(_Chest, _TreasureID)
AND
IsInventoryEmpty(_Chest, 1)
AND
GetHostCharacter(_Player)
THEN
NOT DB_GUS_310271_Patching(_Chest, _TreasureID);
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_TabernacleOfferingStolen");

IF
DB_LOW_GUS310271_ActiveState((ITEM)_Chest,1)
AND
DB_GUS_310271_Patching(_Chest, _TreasureID)
AND
IsInventoryEmpty(_Chest, 0)
THEN
NOT DB_GUS_310271_Patching(_Chest, _TreasureID);

IF
DB_LOW_GUS310271_ActiveState((ITEM)_Chest,1)
THEN
NOT DB_LOW_GUS310271_ActiveState((ITEM)_Chest,1);

IF
DB_GLO_Backgrounds_Blocked("Act3_Criminal_TabernacleOfferingStolen")
AND
DB_GUS_310271_Patching(_Chest, _TreasureID)
THEN
NOT DB_GUS_310271_Patching(_Chest, _TreasureID);
//END_REGION GUS-310271

//REGION GUS-310260

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Elfsong_State_WinComedyTournament_58ac0d2f-319e-e2c4-627f-15114b93c510, "Act3_Entertainer_WonComedyContest")
THEN
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Elfsong_State_WinComedyTournament_58ac0d2f-319e-e2c4-627f-15114b93c510, "Act3_Entertainer_WonComedyContest");
DB_BUGFIX_Marker("GUS-310260");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_GlobalFlag(LOW_Elfsong_State_WinComedyTournament_58ac0d2f-319e-e2c4-627f-15114b93c510)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("Act3_Entertainer_WonComedyContest")
THEN
DB_BUGFIX_Marker("GUS-310260");
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Entertainer_WonComedyContest");


//END_REGION GUS-310260

//REGION GUS-307435
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-307435");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307435")
THEN
PROC_LOW_CazadorsPalace_RemoveOldTrap();
//END_REGION GUS-307435

//REGION GUS-309864
PROC
PROC_ApplySavegamePatches()
AND
DB_BUGFIX_Marker("GUS-305010-LevelTemplate")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-309864");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309864")
AND
QRY_LOW_GUS309864_CheckCleanFlags()
THEN
UnloadLevelTemplate(LT_BGH_ElfsongTavern_PrivateRoom_Clean_000_ca85a03f-41d9-4326-aabc-7a59be90e694);
LoadLevelTemplate(LT_BGH_ElfsongTavern_PrivateRoom_Bloodied_000_46bc4222-ac7f-4acd-b9c9-e2fb2a3624d1);
DB_LOW_Elfsong_FlagsToChangePrivateRoom((FLAG)LOW_SerialKiller_Event_DevellaGoingUpperCity_5aae63f9-594f-407d-8b34-078a0b688968);
DB_LOW_Elfsong_FlagsToChangePrivateRoom(LOW_SerialKiller_State_DolorIsDead_fa48e3fe-dc3c-b5c5-09f1-039a5b6974cf);

QRY
QRY_LOW_GUS309864_CheckCleanFlags()
AND
NOT DB_GlobalFlag(LOW_SerialKiller_Event_DevellaGoingUpperCity_5aae63f9-594f-407d-8b34-078a0b688968)
THEN
DB_NOOP(1);

QRY
QRY_LOW_GUS309864_CheckCleanFlags()
AND
NOT DB_GlobalFlag(LOW_SerialKiller_State_DolorIsDead_fa48e3fe-dc3c-b5c5-09f1-039a5b6974cf)
THEN
DB_NOOP(1);


//END_REGION GUS-309864

//REGION GUS-310259
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog(LOW_Elfsong_State_LoseComedyTournament_bc0e4794-c81b-62c7-caaa-c3e5e451bf24, "Act3_Entertainer_LostComedyContest");
//END_REGION GUS-310259

//REGION GUS-312395
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-312395");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-312395")
THEN
PROC_GUS_312395_CheckSkullUpdate((ITEM)S_LOW_OskarsBeloved_Thunderwave_001_Caster_83f6f5fb-8382-4348-bcae-4d3c543bac9e,(TRIGGER)S_LOW_OskarsBeloved_SkullPatchTrigger_001_f57dc250-0239-4dec-b6c6-7f236f885f22);
PROC_GUS_312395_CheckSkullUpdate((ITEM)S_LOW_OskarsBeloved_Thunderwave_002_Caster_dee914e1-3452-450d-91f7-ed3429cf494f,(TRIGGER)S_LOW_OskarsBeloved_SkullPatchTrigger_002_f4b213a4-1546-4514-ba02-906c91104022);
PROC_GUS_312395_CheckSkullUpdate((ITEM)S_LOW_OskarsBeloved_Thunderwave_004_Caster_b07d0d52-a819-41a1-8ecd-9322c1c2b2d6,(TRIGGER)S_LOW_OskarsBeloved_SkullPatchTrigger_004_ca8dc18e-ea82-40c5-8ca9-3411f673c912);
PROC_GUS_312395_CheckSkullUpdate((ITEM)S_LOW_OskarsBeloved_Thunderwave_006_Caster_81a61e17-c4be-4fa3-8765-02852dc5fb58,(TRIGGER)S_LOW_OskarsBeloved_SkullPatchTrigger_006_2b4695ac-5ee7-4836-a5c2-6022828a4a42);

PROC
PROC_GUS_312395_CheckSkullUpdate((ITEM)_Caster,(TRIGGER)_Trigger)
AND
NOT DB_PermaDefeatedOrOffstage(_Caster)
THEN
TeleportTo(_Caster,_Trigger,"",0,0,0,0,0);
//END_REGION

//REGION GUS-306758
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
THEN
PROC_ApplySavegamePatches_GUS_306758();
DB_BUGFIX_Marker("GUS-306758");

PROC
PROC_ApplySavegamePatches_GUS_306758()
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_DeadOnceFlag(S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8, LOW_AllandraGrey_State_DiedOnce_e953dd67-ea9c-47f8-b2c2-b77e8cbdf0cf);

PROC
PROC_ApplySavegamePatches_GUS_306758()
AND
DB_Dead(S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8)
THEN
SetFlag(LOW_AllandraGrey_State_DiedOnce_e953dd67-ea9c-47f8-b2c2-b77e8cbdf0cf);
//END_REGION

//REGION GUS-308849
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-308849");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308849")
THEN
DB_PreventKnockedOutPermaDefeated(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313);
//END_REGION

//REGION
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310039");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310039")
AND
NOT DB_GlobalFlag((FLAG)LOW_BaldursMouth_HasMet_PrinterGremlin_f89f6d6f-17dc-4089-acb9-e859beec6e75)
THEN
NOT DB_GLO_Backgrounds_ChainAfterCharacterFlag((FLAG)LOW_BaldursMouth_HasMet_PrinterGremlin_f89f6d6f-17dc-4089-acb9-e859beec6e75, "Act3_Sage_PrintingPressMachinationsDiscovered");
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_BaldursMouth_HasMet_PrinterGremlin_f89f6d6f-17dc-4089-acb9-e859beec6e75, "Act3_Sage_PrintingPressMachinationsDiscovered");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310039")
AND
DB_GlobalFlag((FLAG)LOW_BaldursMouth_HasMet_PrinterGremlin_f89f6d6f-17dc-4089-acb9-e859beec6e75)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal(_Player, "Act3_Sage_PrintingPressMachinationsDiscovered");

//END_REGION

//REGION GUS-309045
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-309045");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309045")
THEN
DB_LOW_SorcerousSundries_Nightsong_Deva((CHARACTER)LOW_Nightsong_Deva_001_54ab1644-1ae1-4d85-8bb7-e870dbc2ea8c);
DB_LOW_SorcerousSundries_Nightsong_Deva((CHARACTER)LOW_Nightsong_Deva_002_3d2a675a-a945-44e3-b363-6e5b9f8c52b0);
DB_LOW_SorcerousSundries_Nightsong_Deva((CHARACTER)LOW_Nightsong_Deva_003_0d53dbe4-9991-49c8-9370-1f71e70564d9);
//END_REGION

//REGION GUS-312898
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_CTY_ForrickConfrontationSetupDone(_Version)
AND
NOT DB_GlobalFlag((FLAG)CAMP_MizorasPact_State_WyllReleasedFromPact_79a90490-b009-507c-e0d3-f79b0bdd4cb6)
AND
NOT DB_GlobalFlag((FLAG)LOW_FlorrickFighFallback_Event_Occurred_06b38288-ee5f-630c-153d-39c2e90ae55f)
AND
NOT DB_GlobalFlag((FLAG)LOW_FlorrickFight_Event_FlorrickFightStarted_dd53d2e3-09f8-edaf-162c-1ecd6a2f27d3)
THEN
PROC_ClearOriginMoment(LOW_FlorrickFightFallback_OM_Wyll_dfd8fab6-e0b2-bc4e-903b-f8f639b6244f);
PROC_LOW_FlorrickConfrontation_Cleanup(1);
NOT DB_CTY_ForrickConfrontationSetupDone(_Version);
DB_BUGFIX_Marker("GUS-312898");

//END_REGION

//REGION GUS-310399 + GUS-309933
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310399");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310399")
THEN
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Charlatan_SidedWithGuild");
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366, "Act3_Charlatan_SidedWithZhents");
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Criminal_SideWithGuild");
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366, "Act3_Criminal_SideWithZhents");
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Noble_GuildZhentAlliegenceChosen");
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366, "Act3_Noble_GuildZhentAlliegenceChosen");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Charlatan_SidedWithGuild");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366, "Act3_Charlatan_SidedWithZhents");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Criminal_SideWithGuild");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366, "Act3_Criminal_SideWithZhents");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5, "Act3_Noble_GuildZhentAlliegenceChosen");
DB_GLO_Backgrounds_ChainAfterGlobalFlagPartyWide((FLAG)LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366, "Act3_Noble_GuildZhentAlliegenceChosen");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310399")
AND
DB_GlobalFlag(LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Charlatan_SidedWithGuild");
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_SideWithGuild");
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Noble_GuildZhentAlliegenceChosen");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310399")
AND
DB_GlobalFlag(LOW_Guildhall_State_BetrayedNineFingers_2467deb6-1692-46b0-291f-fb52416b8366)
AND
DB_Players(_Player)
THEN
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Charlatan_SidedWithZhents");
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Criminal_SideWithZhents");
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Noble_GuildZhentAlliegenceChosen");
//END_REGION GUS-310399 + GUS-309933

//REGION GUS-309340
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-309340");
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309340")
AND
NOT DB_PermaDefeated(S_LOW_DevilsFee_Helsik_299a1c00-ff53-415e-ad8e-9bcbbae55597)
THEN
PROC_LOW_DevilsFee_AddButlerHat();

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309340")
AND
DB_PermaDefeated(S_LOW_DevilsFee_Helsik_299a1c00-ff53-415e-ad8e-9bcbbae55597)
THEN
PROC_SetOnStage(S_LOW_Helsik_ButlerHat_df031755-7b3b-4492-842e-90bc26556b60, 0);
//END_REGION GUS-309340

//REGION GUS-305519
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-305519");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-305519")
AND
IsInInventoryOf(S_LOW_HouseOfHope_Treasures_Gauntlets_HillGiantStrength_1cb8450d-016f-43d4-bb44-79688170f073, S_LOW_Helsik_299a1c00-ff53-415e-ad8e-9bcbbae55597, 1)
THEN
SetStoryItem(S_LOW_HouseOfHope_Treasures_Gauntlets_HillGiantStrength_1cb8450d-016f-43d4-bb44-79688170f073, 1);
//END_REGION GUS-305519

//REGION GUS-199485

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-199485");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-199485")
THEN
SetAmbushing(LOW_SorcerousSundries_PetSummoner_9a103ea7-e269-4ae0-ad4a-70a1b76e5135, 1);
SetDetached(LOW_SorcerousSundries_PetSummoner_9a103ea7-e269-4ae0-ad4a-70a1b76e5135, 1);
SetVisible(LOW_SorcerousSundries_PetSummoner_9a103ea7-e269-4ae0-ad4a-70a1b76e5135, 0);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-199485")
AND
NOT DB_PermaDefeatedOrOffstage((CHARACTER)S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
THEN
PROC_SetAnubisConfig(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, "LOW_SorcerousSundries_Prodigy");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-199485")
AND
NOT DB_PermaDefeatedOrOffstage((CHARACTER)S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
THEN
PROC_SetAnubisConfig(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9, "LOW_SorcerousSundries_Lorroakan");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-199485")
THEN
PROC_SetAnubisConfig(S_LOW_LorroakanProjection_7929fdf5-73f4-43e4-9375-13c965685af2,"LOW_SorcerousSundries_Projection");
PROC_SetAnubisConfig(S_LOW_LorroakanProjection_PuzzleGuardian_c65a2e91-34f1-4dd9-a784-2aca5a4d9cd2, "LOW_SorcerousSundries_StairsProjection");
PROC_SetAnubisConfig(S_LOW_RolanProjection_c6a47d05-5051-42de-86b0-776fe0285cd1,"LOW_SorcerousSundries_Projection");

//END_REGION GUS-199485

//REGION GUS-310604
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-310604");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310604")
AND
DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "Figaro")
AND
NOT DB_Is_InCombat(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, _)
THEN
DB_AmbushTrigger(S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, S_LOW_SerialKiller_Figaro_AmbushZone_Detection_334e8fe6-6760-48dd-9485-bab4f3de209d, Act3_Easy_5028066b-6ea0-4a6a-9e3e-53bee62559a7);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, (GUIDSTRING)S_LOW_SerialKiller_Figaro_Doppelganger_006_3344edd8-94a2-42f7-b2a3-4cd4aa639a12, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, (GUIDSTRING)S_LOW_SerialKiller_Figaro_Doppelganger_007_15884103-c8b3-4c5f-b3b5-67ae481074c6, 1);
DB_AmbushTrigger_Ambusher((TRIGGER)S_LOW_SerialKiller_Figaro_AmbushZone_19afd3ca-94fb-49fc-9893-cb19ee6cf5d9, (GUIDSTRING)S_LOW_SerialKiller_Figaro_Doppelganger_005_d2ad989b-3e08-448e-bd66-ab132d83fafd, 1);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310604")
AND
NOT DB_PermaDefeated(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134)
AND
NOT DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal")
AND
NOT DB_State_Current( S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "MurderTribunal_Assault")
THEN
DB_DialogBlockAttackButton(LOW_SerialKiller_Dolor_Soliloquy_e9dbbe8f-06f1-073a-e58a-0ff49ef5ecae);

//END_REGION GUS-310604

//REGION GUS-309416
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-309416");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309416")
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_Event_CampAttackAverted_f3441499-0574-48b0-bf5c-56615ee2d07e)
AND
NOT DB_GlobalFlag((FLAG)NIGHT_AradinAndNightsong_dcacfee4-ee39-4c30-9301-84790c969113)
AND
NOT DB_PermaDefeated((CHARACTER)S_DEN_AdventurerLeader_82d1b843-9e8c-48a5-9d87-caddea5c193c)
THEN
DB_DialogBlockTradeButton((DIALOGRESOURCE)CAMP_SCO_AradinAttack_cdc441b1-9530-da70-d479-6c572b0fc5ee);
//END_REGION GUS-309416

//REGION GUS-309940
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-309940");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309940")
AND
DB_LOW_Gondians(_Gondian)
THEN
PROC_GLO_DifficultyModes_AddHPBoostedEntity(_Gondian);
//END_REGION GUS-309940

//REGION GUS-308439

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-308439");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308439")
AND
NOT DB_PermaDefeated(S_LOW_BasiliskGate_CrimeComplainer_001_Dagger_059e43bb-de23-401a-bb48-2e45f12c6774)
THEN
DB_HasItemEvent(S_LOW_BasiliskGate_CrimeComplainer_001_Dagger_059e43bb-de23-401a-bb48-2e45f12c6774,LOW_BasiliskGate_State_HasItem_CrimeComplainer001_Dagger_f8189ccd-e091-c59a-d65b-07084d2a68ad);
Equip((CHARACTER)S_LOW_BasiliskGate_CrimeComplainer_001_461ce028-4293-4028-951b-a2c267b67216,S_LOW_BasiliskGate_CrimeComplainer_001_Dagger_059e43bb-de23-401a-bb48-2e45f12c6774,1,0,1);

//END_REGION GUS-308439

//REGION GUS-311635

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
DB_BUGFIX_Marker("GUS-311635");
NOT DB_GLO_PotentDrink_BlackedOutPrisons(
	"CTY_Main_A",
	"CTY_Main_A_LowerCity",
	(TRIGGER)S_LOW_Prison_CrimeRegion_65df8e10-39b5-4f28-aa10-fa438dc2249d,
	(CHARACTER)S_LOW_PrisonGuard_03_aebea090-1245-4d27-a105-46e37c5852b0,
	(DIALOGRESOURCE)LOW_PrisonGuard03_AfterCarousing_2f51494f-0921-4676-d30e-5ec9a572875a);
DB_GLO_PotentDrink_BlackedOutPrisons(
	"CTY_Main_A",
	"CTY_Main_A_LowerCity",
	(TRIGGER)S_LOW_Prison_CrimeRegion_65df8e10-39b5-4f28-aa10-fa438dc2249d,
	(CHARACTER)S_LOW_PrisonGuard01_6dd2049c-413c-4c68-b58f-2a0cf5094053,
	(DIALOGRESOURCE)LOW_PrisonGuard03_AfterCarousing_2f51494f-0921-4676-d30e-5ec9a572875a);

//END_REGION GUS-311635

//REGION GUS-309988

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)GLO_Orin_State_BrokeDealToKillGortash_2283f315-5fda-481c-87a1-635d04253759, "Act3_Charlatan_AllianceBetrayed"); // Player doesn't really break any deals at that node in dialogue
DB_BUGFIX_Marker("GUS-309988");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 5")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)GLO_Orin_State_AgreedToKillGortash_39af75d8-2442-8667-551e-6a0dc699398b)
AND
NOT DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
NOT DB_GLO_Backgrounds_Blocked("Act3_Charlatan_AllianceBetrayed")
THEN
DB_LOW_BhaalTemple_GUS309988_ShouldTriggerBackgroundGoal(1);
DB_BUGFIX_Marker("GUS-309988-OrinBetrayed");

IF
DB_LOW_BhaalTemple_GUS309988_ShouldTriggerBackgroundGoal(1)
AND
DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101)
AND
DB_Players(_Player)
THEN
NOT DB_LOW_BhaalTemple_GUS309988_ShouldTriggerBackgroundGoal(1);
PROC_GLO_Backgrounds_CompleteGoal((CHARACTER)_Player, "Act3_Charlatan_AllianceBetrayed");

//END_REGION

//REGION GUS-307656

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
DB_BUGFIX_Marker("GUS-307656");
TeleportTo(S_LOW_BasiliskGate_Cook_GrindSpice_TimelineTrigger_0ecbb931-0f46-44ae-819d-3498faa0145a,S_LOW_BasiliskGate_Cook_PatchTrigger_e67d808e-d2e1-4868-88ef-c533f4b92e67);
TeleportTo(S_LOW_BasiliskGate_Cook_MeatChop_TimelineTrigger_486254c0-10c6-4e75-a334-59218dbc9537,S_LOW_BasiliskGate_Cook_PatchTrigger_e67d808e-d2e1-4868-88ef-c533f4b92e67);

//END_REGION GUS-307656
//REGION GUS-311405
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-311405");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311405")
THEN
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_FetchersBrat_002_3352a47c-4259-464d-8047-65bc8a2adff9,"LOW_Guildhall_FetchersBrat_002_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_FetchersBrat_003_18c2988a-5902-4cb8-b620-4b0c67a2aceb,"LOW_Guildhall_FetchersBrat_003_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Zhent_Mercenary_001_5ac9c7ec-d26f-404e-bd17-e9d3dad000c4,"LOW_Guildhall_Zhent_Mercenary_001_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Zhent_Mercenary_002_1140624b-d27c-43ec-9329-b45d883c900d,"LOW_Guildhall_Zhent_Mercenary_002");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Zhent_Mercenary_004_6e6853b1-b422-4c18-b08b-e4c3a96b3b0e,"LOW_Guildhall_Zhent_Mercenary_004");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Zhent_Mercenary_005_0e5c8772-e931-48f8-9743-c9c09059efbc,"LOW_Guildhall_Zhent_Mercenary_005");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Zhent_Mercenary_007_6dc1a56a-19b7-4a4a-9530-ec41ba9dfef7,"LOW_Guildhall_Zhent_Mercenary_007");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Bodyguard_000_6d430ca2-660e-4000-bcf4-8ee5e2c88440, "LOW_Guildhall_Bodyguard_000");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Bodyguard_001_0962e1ca-7d48-4fde-af0e-250091e9d4e1, "LOW_Guildhall_Bodyguard_001_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Visitor_001_b8f45e3c-1ef2-4a66-bdfe-2d54c700a91d, "LOW_Guildhall_Visitor_001_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Visitor_002_d16d9c85-6d17-4e79-9c3b-864f033054b0, "LOW_Guildhall_Visitor_002_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Visitor_003_28610d0d-fee5-4f7b-b7d3-db60c717b1dd, "LOW_Guildhall_Visitor_003_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Visitor_004_e6abd16d-33b4-471b-9e6a-4338171a7a43, "LOW_Guildhall_Visitor_004_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Visitor_005_bf4caace-8ed0-42c4-8b17-a297b80fff9a, "LOW_Guildhall_Visitor_005_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Visitor_006_227941fa-8264-4a8f-b3b6-2ae0f7ec3356, "LOW_Guildhall_Visitor_006_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Member_001_d71b8ebb-83e4-4732-bce5-722685ec9f5a, "LOW_Guildhall_Member_001_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Member_002_899738c6-ac8e-44f0-9c4b-c0843c717ad4, "LOW_Guildhall_Member_002_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Member_003_28610d0d-fee5-4f7b-b7d3-db60c717b1dd, "LOW_Guildhall_Member_003_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Member_004_d40ae4a2-f29a-4d69-b9f7-9b078aeee0be, "LOW_Guildhall_Member_004_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Member_005_b34e82a2-f774-4f73-b808-c2e79cabdb2a, "LOW_Guildhall_Member_005_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Member_006_75cbf81e-0f16-459b-aa07-966eccf658ce, "LOW_Guildhall_Member_006_Patched");
PROC_SetAnubisConfig((CHARACTER)S_LOW_Guildhall_Member_008_81611144-c02a-411f-9d87-661fc1ceac2d, "LOW_Guildhall_Member_008_Patched");
//END_REGION

//REGION GUS-308720
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_BUGFIX_308720_CheckTG();
DB_BUGFIX_Marker("GUS-308720");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
THEN
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_LOW_SorcerousSundries_LorroakanStatesHisPlan_726a68c9-8af2-49db-9081-2a3c7b943133,(FLAG)LOW_Lorroakan_State_BelievesNightsongIsDead_8aee8177-d2f2-48f0-947b-8c33892152b8);
DB_BUGFIX_Marker("GUS-308720");

PROC
PROC_BUGFIX_308720_CheckTG()
AND
NOT QRY_BUGFIX_308720_CheckShouldLorroTGExist()
AND
DB_Players(_Player)
THEN
PROC_BUGFIX_308720_CheckTG((FLAG)TG_LOW_SorcerousSundries_PlayersConvincedNSIsDead_9736ba49-5730-4320-828f-e2d8b0fb63d4,_Player);
PROC_BUGFIX_308720_CheckTG((FLAG)TG_LOW_SorcerousSundries_LorroakanStatesHisPlan_726a68c9-8af2-49db-9081-2a3c7b943133,_Player);

PROC
PROC_BUGFIX_308720_CheckTG((FLAG)_Flag,(CHARACTER)_Player)
AND
GetFlag(_Flag,_Player,1)
THEN
ClearFlag(_Flag,_Player);

QRY
QRY_BUGFIX_308720_CheckShouldLorroTGExist()
AND
DB_GlobalFlag((FLAG)TG_LOW_SorcerousSundries_LorroakanStatesHisPlan_726a68c9-8af2-49db-9081-2a3c7b943133)
AND
NOT DB_GlobalFlag((FLAG)TG_LOW_SorcerousSundries_LorroakanStatesHisPlan_726a68c9-8af2-49db-9081-2a3c7b943133)
THEN
DB_NOOP(1);

//END_REGION GUS-308720


//REGION GUS-313066
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelUnreachable("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-313066");
PROC_GLO_BugFix_313066_RestoreAbducteeFollower();

PROC
PROC_GLO_BugFix_313066_RestoreAbducteeFollower()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // after battle with Orin has already started.
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // companion was awakened already
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_PartyFollowers(_TargetVictim) // but is still a follower
AND
IsPartyFollower(_TargetVictim, 1)
AND
CharacterGetOwner(_TargetVictim, _Owner)
THEN
NOT DB_PartyFollowers(_TargetVictim);
RemovePartyFollower(_TargetVictim, _Owner);
PROC_SetOnStage(_TargetVictim, 0);
//END_REGION


//REGION GUS-316893
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_GLO_BugFix_316893_RestoreAbducteeFollower_BeforeEND();

PROC
PROC_GLO_BugFix_316893_RestoreAbducteeFollower_BeforeEND() // players are still in CTY/BGO and have not left for END yet.
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // after battle with Orin has already started.
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // companion was awakened already
AND
DB_GEN_OrinsAbduction_ChosenChar(_TargetVictim)
AND
DB_PartyFollowers(_TargetVictim) // but is still a follower
AND
IsPartyFollower(_TargetVictim, 1)
AND
CharacterGetOwner(_TargetVictim, _Owner)
AND
IsInTrigger(_TargetVictim, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113, 0)
THEN
DB_BUGFIX_Marker("GUS-316893");
RemovePartyFollower(_TargetVictim, _Owner);
DB_LOW_BhaalTemple_State_WaitForLongRest("No"); // to stop from checking long rest anymore.
DB_LOW_BhaalTemple_State_SpokenToAbducteePostCombat("Yes"); // to disable the dialog override of the companion
PROC_GlobalSetFlagAndCache((FLAG)LOW_BhaalTemple_State_SpokenToAbducteePostCombat_8dca8ba2-f2ca-44ca-b966-75ff7d839075);
NOT DB_Dialogs(_TargetVictim, (DIALOGRESOURCE)LOW_BhaalTemple_PostBattleAbductee_970134ac-8c2b-a65a-496e-2551c7b245ef);
PROC_ORI_SendToCampAfterDialog(_TargetVictim, 0, "Sprint", (CHARACTER)_Owner);
//END_REGION


//REGION GUS-313476

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-313476");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313476")
THEN
PROC_SetAnubisConfig(S_LOW_TadpoleTransport_SteelWatcher01_7f4d2774-1770-4f08-bd18-6457e610f8ab, "LOW_TadpoleTransport_StandingSteelwatcher");

//END_REGION

//REGION GUS-288507
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-288507");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-288507")
THEN
DB_BUGFIX_Marker("GUS-288507");
PROC_SetAnubisConfig((CHARACTER)S_LOW_BaldursMouth_Wanderer_03_6fd2d322-cd4f-42b4-8683-894d565a4aa2, "LOW_BaldursMouth_Wanderer_03");
//END_REGION

//REGION GUS-312617
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_Destroyed_cdfffe24-5082-4e41-b7c2-f1fef6da3a8a)
AND
NOT DB_DialogName(LOW_SteelWatchFoundry_Explosion_bb9cb061-6ed9-c4c2-ad96-daf47b058ae5, _)
AND
NOT DB_DialogName(LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f, _)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_GainedGondianENDSupport_1bb09a8b-001d-4b43-9f39-ba89eb3aece9)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_SidedWithGondians_60345f15-6632-482e-ac4f-8a1b77d7fc36)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Event_WulbrenCombat_b4d7b17e-3c19-3140-b91a-3eb0574e9f7d)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_SidedWithWulbren_044a290e-2835-44a8-ac0e-0a59da02a316)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_GainedIronhandENDSupport_a090a831-c695-4478-8d0d-84661deabb98)
AND
NOT DB_GlobalFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-312617");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-312617")
THEN
PROC_LOW_SteelWatchFoundy_Outcome_AutoResolve();

//END_REGION GUS-312617

//REGION GUS-311077

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-311077");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311077")
THEN
Transform((CHARACTER)S_LOW_GrottoSentry_90c54fce-9a57-4ff5-9d36-0363ef90c5f1, (CHARACTERROOT)Halflings_Male_Harper_Melee_d2254595-972e-4286-bd5e-ba4bed78b9fd, (SHAPESHIFTRULE)RaceOnly_f007a112-a1a3-497b-8ea9-6105273aa24e);

//END_REGION GUS-311077

//REGION GUS-312867

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-312867");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-312867")
AND
NOT DB_GlobalFlag((FLAG)LOW_OskarsBeloved_State_ArtistLeftHideout_76dca7be-5c6a-4444-afa4-3ae4b13d6315)
AND
NOT DB_PermaDefeatedOrOffstage (S_LOW_AuraItem_003_54f8cff0-6ec9-4974-a49f-62622e854e0e)
THEN
PROC_SetOnStage(S_LOW_AuraItem_003_54f8cff0-6ec9-4974-a49f-62622e854e0e,0);
//END_REGION GUS-312867

//REGION GUS-311775

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-311775");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311775")
AND
DB_GlobalFlag((FLAG)LOW_OskarsBeloved_State_ArtistLeftHideout_76dca7be-5c6a-4444-afa4-3ae4b13d6315)
THEN
ClearOwnership((ITEM)S_LOW_OskarsBeloved_OfficeDoor_001_2aee5a95-e805-4660-9ece-02520e3dcecf);
ClearOwnership((ITEM)S_LOW_OskarsBeloved_OfficeDoor_002_2b65b35d-1980-4606-b067-080085807e40);
ClearOwnership((ITEM)S_LOW_OskarsBeloved_JannathRoomDoor_9909a9e0-16d3-4930-bb88-e3489ecc3628);
//END_REGION GUS-311775

//REGION GUS-283040
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-283040");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-283040")
THEN
PROC_SetAnubisConfig((CHARACTER)S_LOW_MyCabbages_Vendor_319ab552-7aa2-4b99-91c0-0aebe3996ae3, "LOW_Cabbage_Man");
//END_REGION

//REGION GUS-312368
PROC
PROC_ApplySavegamePatches()
AND
DB_MainCamp("CTY_Main_A","ELFSONG")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-312368");

//Declutter only work properly if there is no player in the camp. Wait until players leave Elfsong to execute the declutter.
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-312368")
AND
DB_ActiveCamp(_StringActiveCamp)
AND
DB_Camp(_StringActiveCamp, _, _CampAreaActive, _)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger(_CampAreaActive)
AND
DB_Camp("SLUMS", _, _CampArea, _)
THEN
DeclutterArea(_CampArea,0,1);

//Case players are in any camp, deferred declutter.
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-312368")
AND
DB_ActiveCamp(_StringActiveCamp)
AND
DB_Camp(_StringActiveCamp, _, _CampAreaActive, _)
AND
QRY_TriggerEvents_AnyPartyMemberInTrigger(_CampAreaActive)
AND
DB_Camp("SLUMS", _, _CampArea, _)
THEN
DB_LOW_BUGFIX_DeclutterSlumsCamp(_CampArea);

//If player travels from the camp directly to BGO, this still works because the event arrive before this level unloads.
IF
TeleportedFromCamp(_Player)
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_LOW_BUGFIX_DeclutterSlumsCamp(_CampArea)
AND
DB_ActiveCamp(_StringActiveCamp)
AND
DB_Camp(_StringActiveCamp, _, _CampAreaActive, _)
AND
NOT QRY_TriggerEvents_AnyPartyMemberInTrigger(_CampAreaActive)
THEN
DeclutterArea(_CampArea,0,1);
NOT DB_LOW_BUGFIX_DeclutterSlumsCamp(_CampArea);
//END_REGION GUS-312368

//REGION GUS-305110
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 5", "CTY_Main_A", "GUS-305110");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-305110")
AND
DB_GlobalFlag((FLAG)LOW_CazadorsPalace_Ballroom_State_DoorOpenedOnce_ce614a26-b07b-4c51-a493-436c65281e8c)
AND
IsLocked(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37, 1)
THEN
Unlock(S_LOW_CazadorsPalace_Ballroom_MainDoor_0dac6bdf-5f34-4bd9-bcc2-2dbe3e7aac37);
//END_REGION

//REGION GUS-313151
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-313151");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313151")
AND
NOT DB_LOW_SharGrotto_ViconiaCombat(_)
AND
QRY_LOW_SharGrotto_ViconiaStatus()
AND
QRY_OnlyOnce("LOW_SharGrotto_ViconiaConfronted")
THEN
ClearTag(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, (TAG)AI_AVOID_TARGET_3eebe42c-39ec-4165-9e70-b6811ab7b313);
ClearTag(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, (TAG)AI_UNPREFERRED_TARGET_9787450d-f34d-43bd-be88-d2bac00bb8ee);
PROC_CharacterDisableAllCrimes((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313,1);
PROC_RemoveDialog(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313);
SetHitpointsPercentage(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, 10.0);
SetImmortal(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, 0);
DB_Dialogs(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, (DIALOGRESOURCE)LOW_SharGrotto_ViconiaDefeated_NoShadowheart_6c6f05fc-391a-40f8-c7c0-68bd37dd1e09);
//END_REGION GUS-313151

//REGION GUS-309131
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_MAIN_A", "GUS-309131");

PROC
PROC_ApplySavegamePatchInLevel("CTY_MAIN_A", "GUS-309131")
AND
DB_EastwayFoodCrisis_Chicken(_Chicken)
AND
NOT DB_Dead(_Chicken)
THEN
RemoveStatus(_Chicken, "GROUNDED", NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(_Chicken, "LOW_EASTWAYCRISIS_CHICKEN", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION GUS-309131

//REGION GUS-311764
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-311764");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311764")
THEN
ClearOwnership((ITEM)S_LOW_BuriedMound_07_7726f589-3ae9-41ac-9d85-c03e23f47df6);
//END_REGION GUS-311764

//REGION GUS-310970
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-310970");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310970")
THEN
NOT DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_HighberrysHouse_Ownership_32048e8f-4afe-4f60-8e8c-0ac333a2217d, (CHARACTER)S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);
PROC_ItemOwnership_SetNewTriggerOwner(S_LOW_HighberrysHouse_Ownership_Patched_de3b7056-2e02-4a2d-82c1-70b5b5a631e2, S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404);
//END_REGION GUS-310970

//REGION GUS-308907
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-308907");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308907")
THEN
TeleportTo(S_LOW_MagicItemRamazith_CasterStatue_InvisibleHelper_001_b22c462b-1050-45fb-a62c-5d526df586b8,LOW_SorcerousSundries_StatueHelperPos_001_1b006771-092f-4138-9881-a7a30c4c7ebd,"",0,0,0,0,0);
TeleportTo(S_LOW_MagicItemRamazith_CasterStatue_InvisibleHelper_000_b6f3dbd9-1d50-49bd-9c57-69f9c66605a9,LOW_SorcerousSundries_StatueHelperPos_000_d6a69784-6286-40e5-b37d-19fe9e43cf51,"",0,0,0,0,0);

//END_REGION GUS-308907

//REGION GUS-311465

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "SCL_Main_A", "GUS-311465");

PROC
PROC_ApplySavegamePatchInLevel("SCL_Main_A", "GUS-311465")
AND
NOT DB_QuestIsClosed("SHA_Nightsong")
AND
NOT DB_OnlyOnce("SCE_IsobelNightsongReunion_MainReunionStarted")
THEN
DB_QuestDef_State((FLAG)SCE_Nightsong_Event_RefusedJoinCampSolo_88e8c011-f245-4feb-9205-bb7f35210973,"SHA_Nightsong","NightsongFreed_RefusedJoinCampSolo");
DB_QuestDef_State((FLAG)SCE_Nightsong_Event_RefusedJoinCampCouple_a11fa0e4-fcb8-47bf-92e2-dc7e1e9e7102,"SHA_Nightsong","NightsongFreed_RefusedJoinCampCouple");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelUnreachable("SCL_Main_A")
AND
DB_OnlyOnce("SCE_IsobelNightsongReunion_MainReunionStarted")
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
NOT DB_GlobalFlag((FLAG)CAMP_SharTempleEpilogue_State_NightsongInCamp_1e3475b8-ab7b-4a53-a079-0ac3f86899ed)
AND
NOT DB_QuestIsClosed("SHA_Nightsong")
THEN
PROC_BUGFIX_GUS_311465_CheckIsobelState();

PROC
PROC_BUGFIX_GUS_311465_CheckIsobelState()
AND
DB_SCE_Debrief_BeenInEpilogue((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
QuestUpdate("SHA_Nightsong","NightsongFreed_RefusedJoinCampCouple");

PROC
PROC_BUGFIX_GUS_311465_CheckIsobelState()
AND
NOT DB_SCE_Debrief_BeenInEpilogue((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211)
THEN
QuestUpdate("SHA_Nightsong","NightsongFreed_RefusedJoinCampSolo");
//END_REGION GUS-311465

//REGION GUS-313532
PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-313532");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313532")
AND
DB_LOW_Gondians(_Gondian)
AND
NOT DB_PermaDefeated(_Gondian)
THEN
PROC_CharacterDisableCrime((CHARACTER)_Gondian, "LOW_SteelWatchFoundry_Trespass");
PROC_CharacterDisableCrime((CHARACTER)_Gondian, "LOW_SteelWatchFoundry_Trespass_Aggressive");
//END_REGION GUS-313532

//REGION GUS-306061
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-306061");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-306061")
THEN
TeleportToPosition(S_LOW_BloodMerchant_StartDialogue_0f4ca0ce-5695-434b-9dbb-3e3b911c6bea, -90.226, 22.903, -79.879);
//END_REGION GUS-306061

//REGION GUS-307630
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-307630");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307630")
AND
HasAppliedStatus(S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, "UNCONSCIOUS", 1)
THEN
RemoveStatus(S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, "UNCONSCIOUS", NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_LOW_SerialKiller_Figaro_Assistant_001_d8dc6cf0-2063-49e8-831e-64d998d77061, "LOW_SERIALKILLER_UNCONSCIOUS", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307630")
AND
HasAppliedStatus(S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, "UNCONSCIOUS", 1)
THEN
RemoveStatus(S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, "UNCONSCIOUS", NULL_00000000-0000-0000-0000-000000000000);
ApplyStatus(S_LOW_SerialKiller_Figaro_Assistant_000_b503ab77-c714-47de-9def-2a07aaf51d9f, "LOW_SERIALKILLER_UNCONSCIOUS", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION GUS-307630

//REGION GUS-298462
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-298462");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-298462")
AND
NOT DB_LOW_SerialKiller_Victim_Marker_AlreadyDead((CHARACTER)S_LOW_SerialKiller_Franc_Peartree_1556e29c-a876-4853-9ea7-283a48703a56, "LOW_SerialKiller_Character_Peartree", "Stopmurders_FailFranc")
THEN
PROC_HideMarker(S_LOW_SerialKiller_Franc_Peartree_1556e29c-a876-4853-9ea7-283a48703a56, "LOW_SerialKiller_Character_Peartree");
//END_REGION GUS-298462

//REGION GUS-308803
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-308803");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308803")
THEN
TeleportToPosition(S_LOW_SharranGrotto_FlowerCave_SUB_e4a16835-3796-4d70-991a-6a5f8be4a597, -380.113, 35.447, -1696.783, "", 0, 0, 0, 0, 0);
//END_REGION

//REGION GUS-310459
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-310459");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310459")
THEN
PROC_ItemOwnership_SetNewTriggerOwner((TRIGGER)S_LOW_SteepsShop_Armor_Patched_3c613f12-c826-4e26-a2c2-e95aa0ebf5ef, (CHARACTER)S_LOW_SteepsTrader_Armor_dc7d1866-a206-4029-81a4-ad18ffbcf3ea);

//END_REGION

//REGION GUS-299161
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-299161");

//Wine festival never started
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-299161")
AND
QRY_LOW_SerialKiller_CanAddWineFestivalAttendants()
THEN
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalWorker02_42b6e6f1-07c5-4914-a434-75607aa24b6b, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalWorker02_ef2b97a5-d235-2c49-0574-96fe6ca138e9);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalWorker01_07663ad2-237c-4d11-9b55-fac1ac8e90ee, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalWorker01_2d3475a3-ae3f-b102-3007-1ac771627114);

//Wine festival flag is not set because it never started
QRY
QRY_LOW_SerialKiller_CanAddWineFestivalAttendants()
AND
NOT DB_GlobalFlag(LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5)
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "OffStage")
THEN
DB_NOOP(1);

//Wine festival is happening
QRY
QRY_LOW_SerialKiller_CanAddWineFestivalAttendants()
AND
DB_GlobalFlag(LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5)
THEN
DB_NOOP(1);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-299161")
AND
NOT QRY_IsEmptyDB("DB_LOW_SerialKiller_RunAwayAfterCombat", 2)
AND
DB_LOW_SerialKiller_RunAwayAfterCombat(_CombatGuid, _)
AND
QRY_OnlyOnce("GUS-299161-CrowdsCombatGUID")
THEN
PROC_LOW_SerialKiller_WineFestivalCrowds_RuneAwaySavegamePatching(_CombatGuid);

PROC
PROC_LOW_SerialKiller_WineFestivalCrowds_RuneAwaySavegamePatching((GUIDSTRING)_CombatGuid)
AND
DB_LOW_SerialKiller_WineFestivalCrowds(_CrowdTrigger)
THEN
TriggerSetCrowdBehaviour(_CrowdTrigger, CROWDBEHAVIOUR.Cower);
DB_LOW_SerialKiller_RunAwayAfterCombat_Crowds(_CrowdTrigger, _CombatGuid);
NOT DB_LOW_SerialKiller_WineFestivalCrowds(_CrowdTrigger);


PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-299161")
AND
NOT QRY_LOW_SerialKiller_CanAddWineFestivalAttendants()
THEN
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalWorker02_42b6e6f1-07c5-4914-a434-75607aa24b6b, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalWorker02_ef2b97a5-d235-2c49-0574-96fe6ca138e9);
DB_LOW_WineFestivalAttendants((CHARACTER)S_LOW_SerialKiller_WineFestivalWorker01_07663ad2-237c-4d11-9b55-fac1ac8e90ee, (DIALOGRESOURCE)LOW_SerialKiller_WineFestivalWorker01_2d3475a3-ae3f-b102-3007-1ac771627114);
PROC_LOW_SerialKiller_WineFestivalAttendantsRunAway(); //This call will make them to run away AND will clear the remaining entries of the DB_LOW_WineFestivalAttendants database.
//This will clean the posible remaining crowds too.

//END_REGION GUS-299161

//REGION GUS-313815
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-313815");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313815")
AND
NOT DB_PermaDefeatedOrOffstage(S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c)
THEN
PROC_SetAnubisConfig(S_LOW_Elfsong_FlamingFist_001_990ad029-d291-4788-86f9-dfceacdf771c, "LOW_Elfsong_FlamingFist1");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313815")
AND
NOT DB_PermaDefeatedOrOffstage(S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159)
THEN
PROC_SetAnubisConfig(S_LOW_Elfsong_FlamingFist_002_971f5890-e0ae-49ef-9a04-5e69ebdf8159, "LOW_Elfsong_FlamingFist2");
//END_REGION GUS-313815

//REGION GUS-311280

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-311280-A");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311280-A")
THEN
TeleportToPosition(S_LOW_Elfsong_Kitchen_AssistantPoint_002_47751910-2bfb-480e-bb11-b20f80aeda54, 57.791, 41.988, 6.938, "", 0, 0, 0, 0, 0);

//END_REGION GUS-311280

//REGION GUS-307738
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-307738");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307738")
AND
NOT DB_Destroyed((ITEM)S_LOW_AtelierPortrait_002_49b95036-c60b-4abb-8757-64fccd0e7ab6)
AND
IsInTrigger((GUIDSTRING)S_LOW_AtelierPortrait_002_49b95036-c60b-4abb-8757-64fccd0e7ab6, (TRIGGER)S_LOW_OskarsBeloved_InitialPosition_Portrait_002_75deef5f-4500-4931-a2e5-9c04f9d0e889, 1)
THEN
TeleportTo(S_LOW_AtelierPortrait_002_49b95036-c60b-4abb-8757-64fccd0e7ab6, S_LOW_AtelierPortraitOriginalPos_002_Patched_6a0d764a-e44b-4391-ac8e-79147aa9b3f6, "LOW_OskarsBeloved_AtelierPortrait_002_Moved");
//END_REGION GUS-307738

//REGION GUS-286741
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","CTY_Main_A","GUS-286741");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-286741")
THEN
NOT DB_GLO_CrowdSupport_DisperseVignette((CHARACTER)S_LOW_HeapsideKitchenHelper_Civilian1_fb90d37e-5fda-4660-bd27-6cf9a4aca4a4,"HeapsideKitchenHelper",1,0);
NOT DB_GLO_CrowdSupport_DisperseVignette(S_LOW_HeapsideKitchenHelper_Civilian4_a558a71c-075d-4271-8339-919da3284746,"HeapsideKitchenHelper",1,1);
DB_GLO_CrowdSupport_DisperseVignette(S_LOW_HeapsideKitchenHelper_Civilian1_fb90d37e-5fda-4660-bd27-6cf9a4aca4a4,"HeapsideKitchenHelper",1,1);
DB_GLO_CrowdSupport_DisperseVignette(S_LOW_HeapsideKitchenHelper_Civilian4_a558a71c-075d-4271-8339-919da3284746,"HeapsideKitchenHelper",1,0);
//END_REGION

//REGION GUS-298866
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","CTY_Main_A","GUS-298866");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-298866")
AND
DB_Players(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
GetRelation((FACTION)ACT3_LOW_JaheirasHouse_JaheirasTraps_760e3624-f809-4e23-8509-866cbd0738c6, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_JaheirasHouse_JaheirasTraps_760e3624-f809-4e23-8509-866cbd0738c6, 100);

//END_REGION

//REGION GUS-298114
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-298114");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-298114")
AND
GetOwner((ITEM)S_LOW_NightsongPamphlet_000_40ad72cb-ae54-4b45-a4ce-d9c85d61611d, _Owner)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_Owner)
THEN
ClearOwnership((ITEM)S_LOW_NightsongPamphlet_000_40ad72cb-ae54-4b45-a4ce-d9c85d61611d);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-298114")
AND
GetOwner((ITEM)S_LOW_NightsongPamphlet_001_ff7fa76b-a555-4c37-a32a-e4834153a6cf, _Owner)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_Owner)
THEN
ClearOwnership((ITEM)S_LOW_NightsongPamphlet_001_ff7fa76b-a555-4c37-a32a-e4834153a6cf);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-298114")
AND
GetOwner((ITEM)S_LOW_NightsongPamphlet_002_8202b31a-1b30-4b4d-a457-fe47f1201a15, _Owner)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_Owner)
THEN
ClearOwnership((ITEM)S_LOW_NightsongPamphlet_002_8202b31a-1b30-4b4d-a457-fe47f1201a15);
//END_REGION GUS-298114

//REGION GUS-309396
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-309396");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309396")
THEN
PROC_SetOnStage(S_LOW_TempleBrazier_ce666dd2-4a32-4008-8f1a-bd3cff574b80, 0);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309396")
THEN
PROC_SetOnStage(S_LOW_TempleBrazier_ce666dd2-4a32-4008-8f1a-bd3cff574b80, 0);
SetOwner(S_LOW_Stormshore_Brazier_New_727a3171-2cc7-4957-be16-f323dbb93318, S_LOW_TempleGuardian_32ec6ad3-c085-4fc5-943b-e2e3a05d9f2b);

//END_REGION GUS-309396

//REGION GUS-312135
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-312135-A");
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-312135-B");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-312135-A")
AND
IsInInventory(S_LOW_Elfsong_SitAndDrink_HUM_M_Mug_004_e308b28d-cf55-4e88-875d-5b0252e40598, 0)
THEN
PROC_SetOnStage(S_LOW_Elfsong_SitAndDrink_HUM_M_Mug_004_e308b28d-cf55-4e88-875d-5b0252e40598, 0);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-312135-B")
THEN
TeleportToPosition(S_Elfsong_Chair_005_30e01167-7a1f-46ad-b26b-af1a75cec03a, 56.503, 41.988, -14.957, "LOW_Elfsong_FixedChairPosition", 0, 0, 0, 0, 1);
//END_REGION GUS-312135

//REGION GUS-311765

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-311765");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311765")
AND
DB_LOW_FireworksHouse_BanitesHostile(1)
AND
DB_LOW_FireworksHouse_BaniteGuards(_Banite)
AND
DB_PermaDefeated(_Banite)
THEN
PROC_ClearCorpseOwner(_Banite);

//END_REGION

//REGION GUS-311492
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-311492");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311492")
THEN
TeleportToPosition(S_Elfsong_Chair_006_dd9b9bee-96fd-4c5b-ae45-d71c800e2b0e, 58.783, 41.988, -12.706, "LOW_Elfsong_FixedChairPosition2", 0, 0, 0, 0, 1);
//END_REGION GUS-311492

//REGION GUS-304662
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-304662");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304662")
AND
DB_LOW_SteelWatchFoundry_DeadMansSwitches(_Baneite, _Switch, _String)
THEN
SetCanBePickpocketed(_Switch, 0);
SetIsTradable(_Switch, TRADABLETYPE.NonTradable);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304662")
AND
DB_LOW_SteelWatchFoundry_DeadMansSwitches(_Baneite, _Switch, _String)
AND
_Baneite != NULL_00000000-0000-0000-0000-000000000000
AND
GetItemByTemplateInInventory((ITEMROOT)QUEST_LOW_DeadMansSwitch_Shield_10d9e4a8-8019-47a9-88e3-dac74f7b8ae5, _Baneite, _EquipableSwitch)
THEN
SetIsDroppedOnDeath(_EquipableSwitch, 0);
SetIsTradable(_EquipableSwitch, TRADABLETYPE.NonTradable);
//END_REGION GUS-304662

//REGION GUS-312169
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-304662");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-304662")
THEN
TeleportTo(BOOK_LOW_SteelWatchFoundry_ToClotilda_000_1f1cedea-2118-4583-b8b0-965e333b50fc, LOW_SteelWatchFoundry_AsylumPos_66106ef1-3213-4b8d-a06a-c8f68dfcbf29, "", 0, 0, 0, 0, 1);
TeleportTo(BOOK_LOW_SteelWatchFoundry_ToBendobrus_000_39c06fb4-722d-40a7-944b-92c9b71a2f83, LOW_SteelWatchFoundry_AsylumPos_66106ef1-3213-4b8d-a06a-c8f68dfcbf29, "", 0, 0, 0, 0, 1);
TeleportTo(BOOK_LOW_SteelWatchFoundry_PoemForLanpos_000_45bf581a-fb70-4e98-b411-87e98f59d354, LOW_SteelWatchFoundry_AsylumPos_66106ef1-3213-4b8d-a06a-c8f68dfcbf29, "", 0, 0, 0, 0, 1);
TeleportTo(BOOK_LOW_SteelWatchFoundry_ToClotilda_001_4b236746-1a97-4a6a-956e-c2297239c05c, LOW_SteelWatchFoundry_AsylumPos_66106ef1-3213-4b8d-a06a-c8f68dfcbf29, "", 0, 0, 0, 0, 1);
TeleportTo(BOOK_LOW_SteelWatchFoundry_TalisTactics_000_3068fe43-0206-4eb5-bbda-41ebe5e5880e, LOW_SteelWatchFoundry_AsylumPos_66106ef1-3213-4b8d-a06a-c8f68dfcbf29, "", 0, 0, 0, 0, 1);
TeleportTo(BOOK_LOW_SteelWatchFoundry_RivesFailures_000_9fb171b6-d8ef-4557-b5a3-bd1fec0d1688, LOW_SteelWatchFoundry_AsylumPos_66106ef1-3213-4b8d-a06a-c8f68dfcbf29, "", 0, 0, 0, 0, 1);
//END_REGION GUS-312169

//REGION GUS-314762

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 5 Hotfix 5")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_FlorrickFight_Event_WyllPresent_0651a592-0f1f-dc6e-862f-7b3840619e72)
THEN
DB_BUGFIX_Marker("GUS-314762-WyllKnowsFlag");
SetFlag(LOW_FlorrickFight_State_WyllKnowsAboutMizoraInvolvement_9aaf82d9-9bfe-72da-df9f-1f20055890ea);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_FlorrickFightFallback_Event_WyllPresent_06aba40d-202a-9386-b310-2c0f29fd06cc)
THEN
DB_BUGFIX_Marker("GUS-314762-WyllKnowsFlag");
SetFlag(LOW_FlorrickFight_State_WyllKnowsAboutMizoraInvolvement_9aaf82d9-9bfe-72da-df9f-1f20055890ea);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_Avatars(_Avatar)
AND
GetFlag((FLAG)Wyll_InParty2_Event_FlorrickEltanWyrm_49cdaaf3-805f-cba6-e0af-ec167bd803d7, _Avatar, 1)
THEN
DB_BUGFIX_Marker("GUS-314762-WyllKnowsFlag");
SetFlag(LOW_FlorrickFight_State_WyllKnowsAboutMizoraInvolvement_9aaf82d9-9bfe-72da-df9f-1f20055890ea);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_Avatars(_Avatar)
AND
GetFlag((FLAG)CAMP_Mizora_Event_Gloating_507fcad8-eba4-21a6-95c8-917d71d20daa,_Avatar,1)
THEN
DB_BUGFIX_Marker("GUS-314762-StopRomance");
DB_CAMP_Mizora_StopSuggestingRomance(1);


PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_Avatars(_Avatar)
AND
DB_GlobalFlag((FLAG)CAMP_Mizora_Event_FinalDiscussion_75b5d361-e4c9-2271-ce84-bd32752aa7b8)
THEN
DB_BUGFIX_Marker("GUS-314762-StopRomance");
DB_CAMP_Mizora_StopSuggestingRomance(1);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)CAMP_Mizora_State_SuggestRomance_7e3e4852-5fac-4b51-9fc9-036d315b720d)
AND
NOT QRY_GUS_314762_MizoraOfferedRomance()
AND
QRY_OnlyOnce_Reset("FCRD_Mizora_SuggestRomance")
THEN
DB_BUGFIX_Marker("GUS-314762-RestartCRD");
NOT DB_RelationshipDialogsFinished((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,(DIALOGRESOURCE)CAMP_Mizora_d1ad5fc6-6d64-e1b6-3f9d-e702a5c2d164,28755ce9-cb14-4baa-8e6a-bbdc88a4393d);
PROC_CampRelationshipDialog((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,(DIALOGRESOURCE)CAMP_Mizora_d1ad5fc6-6d64-e1b6-3f9d-e702a5c2d164,28755ce9-cb14-4baa-8e6a-bbdc88a4393d,0);
PROC_Try_CampRelationshipDialog((CHARACTER)S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a,1);

QRY
QRY_GUS_314762_MizoraOfferedRomance()
AND
DB_Avatars(_Avatar)
AND
GetFlag((FLAG)CAMP_Mizora_Event_RomanceOffered_c0544c56-c976-d8f5-6c77-accb1195c0ef, _Avatar, 1)
THEN
DB_NOOP(1);

//END_REGION

//REGION GUS-314613
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-314613");

// post battle fix
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314613")
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9) // victim is still alive
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575) // Orin and minions were already defeated
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_VictimUnlocked_6fd6bf7c-dee2-4987-8469-ba8dacd18231) // victim was already unlocked
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // but somehow still not awakened
THEN
PROC_LOW_BhaalTemple_Abductee_WakeUp();

// during battle fix
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314613")
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // combat had already begun
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_KilledVictim_ba91f332-45d5-483c-b460-dfec2e6d87e9) // victim is still alive
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575) // Orin and minions were not all defeated yet therefore combat should still be ongoing
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_VictimUnlocked_6fd6bf7c-dee2-4987-8469-ba8dacd18231) // victim was already unlocked
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_Event_VictimAwakened_cedc10cf-2d82-496e-ad98-83ea5a7b3565) // but somehow still not awakened
THEN
PROC_LOW_BhaalTemple_Abductee_WakeUp();
//END_REGION

//REGION GUS-313467
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("WLD_Main_A")
THEN
DB_BUGFIX_Marker("GUS-313467");
PROC_BUGFIX_GUS_313467_CheckLastPage();

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_QuestIsOpened("FOR_DangerousBook")
THEN
DB_BUGFIX_Marker("GUS-313467-B");
QuestSetCategory("FOR_DangerousBook","BaldursGate");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUS-313467");
PROC_BUGFIX_GUS_313467_CheckReachedCity();

PROC
PROC_BUGFIX_GUS_313467_CheckLastPage()
AND
NOT DB_GlobalFlag((FLAG)FOR_DangerousBook_State_BookFinished_489a23a0-758a-97bd-bd0c-d6b417c20af3)
THEN
DB_QuestDef_State((FLAG)FOR_DangerousBook_State_BookFinished_489a23a0-758a-97bd-bd0c-d6b417c20af3,"FOR_DangerousBook","ReachedLastPage");

PROC
PROC_BUGFIX_GUS_313467_CheckLastPage()
AND
DB_GlobalFlag((FLAG)FOR_DangerousBook_State_BookFinished_489a23a0-758a-97bd-bd0c-d6b417c20af3)
AND
DB_QuestIsOpened("FOR_DangerousBook")
THEN
QuestUpdate("FOR_DangerousBook","ReachedLastPage");

PROC
PROC_BUGFIX_GUS_313467_CheckReachedCity()
AND
DB_GlobalFlag((FLAG)FOR_DangerousBook_State_BookFinished_489a23a0-758a-97bd-bd0c-d6b417c20af3)
AND
DB_QuestIsOpened("FOR_DangerousBook")
THEN
QuestUpdate("FOR_DangerousBook","ReachedCity");
//END_REGION

//REGION GUS-308557
PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-308557");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308557")
THEN
PROC_BG3_SaveGamePatches_GUS_308557_SyncSecretDoor();
PROC_BG3_SaveGamePatches_GUS_308557_SyncTorch((ITEM)S_LOW_RainforestBasement_Torch_000_DEPRECATED_bf2366c1-8d63-4a43-bb1a-0e12d387a01f, (ITEM)S_LOW_RainforestBasement_Torch_000_718b357b-cc4c-48f7-a2d3-a73b1b4924e3);
PROC_BG3_SaveGamePatches_GUS_308557_SyncTorch((ITEM)S_LOW_RainforestBasement_Torch_001_DEPRECATED_788c8a8c-df91-4b9d-87bc-429048ade78d, (ITEM)S_LOW_RainforestBasement_Torch_001_360a9573-4326-4fcd-9fa4-116dcbaa6dec);
PROC_BG3_SaveGamePatches_GUS_308557_SyncTrap(S_LOW_RainforestBasement_Tripwire_000_Deprecated_669e6863-b1da-4930-b57e-061ece0b886a, S_LOW_RainforestBasement_Tripwire_000_47828eaf-a0a9-40b8-a36b-568cba1ec73b, S_LOW_RainforestBasement_Explosive_000_b9d9c88c-d6b8-4eff-a5a8-7f9c56c6c3f5, S_LOW_RainforestBasement_RevealHelper_000_d341b78c-66c4-4207-b9b4-ad2488256baf);
PROC_BG3_SaveGamePatches_GUS_308557_SyncTrap(S_LOW_RainforestBasement_Tripwire_001_Deprecated_5fb39058-d7d6-4079-8171-56f4ce16d298, S_LOW_RainforestBasement_Tripwire_001_0064d5fb-1969-45db-8f7b-1f1e13c4cd4a, S_LOW_RainforestBasement_Explosive_001_8d110976-4e55-479b-8588-c4d48d9137cb, S_LOW_RainforestBasement_RevealHelper_001_2d497086-8f5c-48c9-8e0e-3071de3a6141);
PROC_BG3_SaveGamePatches_GUS_308557_SyncTrap(S_LOW_RainforestBasement_Tripwire_002_Deprecated_3ee2a3c5-033a-41fa-b5c8-6c505232453d, S_LOW_RainforestBasement_Tripwire_002_64349d7e-000a-4682-8061-a2a437f9f6c1, S_LOW_RainforestBasement_Explosive_002_81fc40de-08c4-4f39-9413-8b18d95ccd10, S_LOW_RainforestBasement_RevealHelper_002_13562a00-9228-477a-a806-f923d8f684f3);

// Tripwire found and revealed
PROC
PROC_BG3_SaveGamePatches_GUS_308557_SyncTrap((ITEM)_OldTripwire, (ITEM)_NewTripwire, (ITEM)_NewExplosive, (GUIDSTRING)_RevealHelper)
AND
QRY_BG3_SaveGamePatches_GUS_308557_TripwireExistsAndNotDestroyed(_OldTripwire)
AND
GetCanInteract(_OldTripwire, 1)
THEN
DebugText(_NewTripwire, "Discovered");
SetOnStage(_OldTripwire, 0);
SetEntityEvent(_RevealHelper, "LOW_RainforestBasment_RevealTrap", 1);
DB_BG3_SaveGamePatches_GUS_308557_TrapSynced(_OldTripwire, _NewTripwire, _NewExplosive);

// Tripwire found and revealed
PROC
PROC_BG3_SaveGamePatches_GUS_308557_SyncTrap((ITEM)_OldTripwire, (ITEM)_NewTripwire, (ITEM)_NewExplosive, (GUIDSTRING)_RevealHelper)
AND
QRY_BG3_SaveGamePatches_GUS_308557_TripwireExistsAndNotDestroyed(_OldTripwire)
AND
GetCanInteract(_OldTripwire, 0)
THEN
DebugText(_NewTripwire, "Not Discovered");
SetOnStage(_OldTripwire, 0);
DB_BG3_SaveGamePatches_GUS_308557_TrapSynced(_OldTripwire, _NewTripwire, _NewExplosive);

// Tripwire destroyed
PROC
PROC_BG3_SaveGamePatches_GUS_308557_SyncTrap((ITEM)_OldTripwire, (ITEM)_NewTripwire, (ITEM)_NewExplosive, (GUIDSTRING)_RevealHelper)
AND
NOT QRY_BG3_SaveGamePatches_GUS_308557_TripwireExistsAndNotDestroyed(_OldTripwire)
THEN
DebugText(_NewTripwire, "Destroyed/activated");
SetOnStage(_NewTripwire, 0);
SetOnStage(_NewExplosive, 0);
DB_BG3_SaveGamePatches_GUS_308557_TrapSynced(_OldTripwire, _NewTripwire, _NewExplosive);

QRY
QRY_BG3_SaveGamePatches_GUS_308557_TripwireExistsAndNotDestroyed((ITEM)_Tripwire)
AND
Exists(_TripWire, 1)
AND
IsDestroyed(_TripWire, 0)
THEN
DB_NOOP(1);

// Tripwire not found yet
PROC
PROC_BG3_SaveGamePatches_GUS_308557_SyncTrap((ITEM)_OldTripwire, (ITEM)_NewTripwire, (ITEM)_NewExplosive, (GUIDSTRING)_ExplosiveRevealEvent)
AND
NOT DB_BG3_SaveGamePatches_GUS_308557_TrapSynced(_OldTripwire, _NewTripwire, _NewExplosive)
THEN
SetOnStage(_OldTripwire, 0);
DB_BG3_SaveGamePatches_GUS_308557_TrapSynced(_OldTripwire, _NewTripwire, _NewExplosive);

PROC
PROC_BG3_SaveGamePatches_GUS_308557_SyncSecretDoor()
AND
DB_PartyMembers(_Char)
AND
NOT DB_BG3_SaveGamePatches_GUS_308557_SecretDoorSynced(1)
AND
IsInTrigger(_Char, (TRIGGER)S_LOW_RainforestBasement_SecretRoom_0c7113bf-6b1f-40d9-a1f4-323c957cfb67, 1)
THEN
DB_BG3_SaveGamePatches_GUS_308557_SecretDoorSynced(1);
SetEntityEvent(S_LOW_RainforestBasement_SecretDoorHelper_bffca7c4-8812-47d6-aa03-60c5e85b6c51, "LOW_RainforestBasement_RevealSecretDoor", 1);

PROC
PROC_BG3_SaveGamePatches_GUS_308557_SyncSecretDoor()
AND
QRY_IsOpeneding((ITEM)S_LOW_RainforestBasement_SecretDoor_DEPRECATED_c237b313-3c49-4f83-84cf-14d5c159317d)
THEN
SetEntityEvent(S_LOW_RainforestBasement_SecretDoorHelper_bffca7c4-8812-47d6-aa03-60c5e85b6c51, "LOW_RainforestBasement_RevealSecretDoor", 1);
Open((ITEM)S_LOW_RainforestBasement_SecretDoor_cddaeb47-ff5d-4620-8ae9-d1b498cb09fe);

PROC
PROC_BG3_SaveGamePatches_GUS_308557_SyncSecretDoor()
THEN
SetOnStage(S_LOW_RainforestBasement_SecretDoor_DEPRECATED_c237b313-3c49-4f83-84cf-14d5c159317d, 0);

PROC
PROC_BG3_SaveGamePatches_GUS_308557_SyncTorch((ITEM)_OldTorch, (ITEM)_NewTorch)
AND
HasAppliedStatus(_OldTorch, "BURNING", 1)
THEN
ApplyStatus(_NewTorch, "BURNING", -1.0, 1);

PROC
PROC_BG3_SaveGamePatches_GUS_308557_SyncTorch((ITEM)_OldTorch, (ITEM)_NewTorch)
THEN
SetOnStage(_OldTorch, 0);
//END_REGION GUS-308557

//REGION GUS-309867-2
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
PROC_GLO_Bugfix_309867_2_TryRestoreCanJoin();

// post battle fix
PROC
PROC_GLO_Bugfix_309867_2_TryRestoreCanJoin()
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575) // Orin and minions were already defeated
AND
DB_LOW_BhaalTemple_BlockOrinsHitReaction_CanJoinCombat(_Player, _) // but for some reason a character in this DB isn't fully cleared yet.
AND
NOT DB_InRegion((CHARACTER)_Player, (TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113) // and the character isn't in the temple region anymore.
THEN
DB_BUGFIX_Marker("GUS-309867-2");
PROC_LOW_BhaalTemple_Duel_Ally_BlockOrinsHitReaction_Restore((CHARACTER)_Player);
//END_REGION

//REGION GUS-296495
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-296495");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-296495")
THEN
DB_BUGFIX_Marker("GUS-296495");
PROC_SetAnubisConfig((CHARACTER)S_LOW_SteepsEvacuation_Father_9cb808d0-305e-4983-acff-58313fc5ce3e, "LOW_SteepsEvacuation_Father");
PROC_SetAnubisConfig((CHARACTER)S_LOW_SteepsEvacuation_Mother_a50e70b0-972e-4fa0-bf0d-2fe54b11e713, "LOW_SteepsEvacuation_Mother");
PROC_SetAnubisConfig((CHARACTER)S_LOW_SteepsEvacuation_Child1_4d171372-75ff-40d1-8ea0-7c80273db8e5, "LOW_SteepsEvacuation_Child_01");
PROC_SetAnubisConfig((CHARACTER)S_LOW_SteepsEvacuation_Child2_8f095e66-076f-48cd-b85e-6e46b358675d, "LOW_SteepsEvacuation_Child_02");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-296495")
AND
DB_GlobalFlag((FLAG)LOW_Evacuation_HasMet_MadeDealWithSailor_76df3b6e-c3c2-f9b3-d6b6-7e1dd160725f)
THEN
PROC_GenericsSetBusyDialog((CHARACTER)S_LOW_SteepsEvacuation_Child1_4d171372-75ff-40d1-8ea0-7c80273db8e5);
PROC_GenericsSetBusyDialog((CHARACTER)S_LOW_SteepsEvacuation_Child2_8f095e66-076f-48cd-b85e-6e46b358675d);
//END_REGION

//REGION GUS-314524
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-314524");
DB_BUGFIX_Marker("GUS-314524");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314524")
THEN
DB_LOW_SorcerousSundries_NSRunToRamazithLocation("FARM",S_LOW_SorcerousSundries_Farm_NightsongLeaveCampPos_7099c20c-2710-4575-9f32-d4780dfe5965);
DB_LOW_SorcerousSundries_NSRunToRamazithLocation("ELFSONG",S_LOW_NightsongLeaveCampPos_385051cc-92b6-4dcf-af63-3f0d84906849);
DB_LOW_SorcerousSundries_NSRunToRamazithLocation("SLUMS",S_LOW_SlumsPosition_NightsongLeave_0d373811-b182-40da-9763-defdf9a1997c);
DB_BUGFIX_Marker("GUS-314524");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314524")
AND
DB_ItemShopTrigger((TRIGGER)S_LOW_OwnershipMainClerkTrigger_5a2b00ee-3f6d-471c-9888-1a55f4a729e5, (CHARACTER)_MainClerk)
THEN
NOT DB_ItemShopTrigger((TRIGGER)S_LOW_OwnershipMainClerkTrigger_5a2b00ee-3f6d-471c-9888-1a55f4a729e5, (CHARACTER)_MainClerk);
DB_ItemShopTrigger((TRIGGER)S_LOW_OwnershipMainClerkTrigger_c878a73d-b8d8-4b31-86b5-04182b134e1c, (CHARACTER)_MainClerk);
DB_BUGFIX_Marker("GUS-314524");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314524")
AND
DB_LOW_SorcerousSundries_StartedConfrontation(1)
AND
NOT DB_LOW_SorcerousSundries_FinalConfrontationDialogStarted(1)
THEN
DB_BUGFIX_Marker("GUS-314524");
SetFlag((FLAG)LOW_SorcerousSundries_State_FinalConfrontationOngoing_d2be5d4b-d315-4b28-9c76-78419b48e64f);
PROC_BUGFIX_GUS_314524_CheckNightsongPosition();

//Check for edgecase of Nightsong not having reached Ramazith's when it should
PROC
PROC_BUGFIX_GUS_314524_CheckNightsongPosition()
AND
NOT DB_OnlyOnce("LOW_SorcerousSundries_Conclude")
AND
NOT DB_InRegion(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (TRIGGER)S_LOW_UpperFloorRamazithTrigger_a7f7011a-b019-4cb1-b1c8-78308a9758a3)
THEN
PROC_SetOnStage((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,1);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_LOW_NightsongLorrokananTeleportTo_5c68bfc2-7e9b-4856-8f69-81f75f65feae,"",0,0,0,1,1);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314524")
AND
DB_LOW_SorcerousSundries_NightsongWillGoToRamazith(1)
THEN
NOT DB_LOW_SorcerousSundries_NightsongWillGoToRamazith(1);
DB_LOW_SorcerousSundries_NightsongWillAppearInRamazith(1);
DB_BUGFIX_Marker("GUS-314524");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314524")
AND
DB_LOW_SorcerousSundries_ReadyForConfrontation("Lorroakan")
THEN
NOT DB_LOW_SorcerousSundries_ReadyForConfrontation("Lorroakan");
DB_BUGFIX_Marker("GUS-314524");

//END_REGION

//REGION GUS-311639
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-311639");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311639")
AND
DB_GlobalFlag((FLAG)LOW_TheLodge_State_OmeluumArrived_a43b5a2a-2cd8-91df-0394-3a698f8c5da0)
AND
DB_PermaDefeated(S_GLO_SocietyOfBrilliance_Hobgoblin_db424bf6-81ad-463d-8974-f73f1df5af09)
AND
NOT GetRelation((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360,(FACTION)ACT1_UND_SocietyOfBrilliance_e367e82e-d7c3-40ad-ad92-bf59486af503,0)
AND
IsOnStage(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53,0)
THEN
DB_BUGFIX_Marker("GUS-311639");
PROC_GlobalClearFlagAndCache((FLAG)LOW_TheLodge_State_BlurgOrOmeluumTeleportedAway_77f1763f-2aa5-44be-a108-f2ad59a12873);
PROC_SetOnStage(S_GLO_SocietyOfBrilliance_MindFlayer_1f9937ef-9207-4db6-a833-e4083d571f53,1);
//END_REGION

//REGION GUS-311751
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-311751");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311751")
AND
NOT DB_GlobalFlag((FLAG)LOW_BonecloakApothecary_State_BaelenDidntReachBG_0f67d8bd-7395-42bb-a55d-cadecd4ba489)
AND
NOT GetFaction(S_GLO_Baelen_711bd763-780d-4132-9662-3a8a06da6b1b,(FACTION)Act3_LOW_Bonecloak_Civilians_8c64b097-10d6-4bd1-945a-34b4d216ce9e)
AND
DB_PermaDefeated(S_GLO_Baelen_711bd763-780d-4132-9662-3a8a06da6b1b)
THEN
DB_BUGFIX_Marker("GUS-311751");
PROC_GlobalSetFlagAndCache((FLAG)LOW_BonecloakApothecary_State_BaelenDidntReachBG_0f67d8bd-7395-42bb-a55d-cadecd4ba489);
//END_REGION

//REGION GUS-306257
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-306257");

// the anchor poster was initially inside a wall
// it was fixed in CL 3650693, but it wasn't patched for existing savegames
// we need to fix both the anchor poster and the actual instance
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-306257")
AND
GetPosition(S_LOW_BasiliskGate_Florrick_ExecutionNotice_05_e97244b2-c305-4b1a-a375-58896887996b, _X, _, _)
AND
_X <= -140.650
AND
_X >= -140.651
THEN
DB_BUGFIX_Marker("GUS-306257-AnchorPosition");
TeleportToPosition(S_LOW_BasiliskGate_Florrick_ExecutionNotice_05_e97244b2-c305-4b1a-a375-58896887996b, -140.66, 23.78, -99.62, "", 0, 0, 0, 0, 0);
PROC_GLO_Bugfix_306257_FixPosterPosition();

PROC
PROC_GLO_Bugfix_306257_FixPosterPosition()
AND
DB_LOW_BasiliskGate_FlorrickExecution_Posters(S_LOW_BasiliskGate_Florrick_ExecutionNotice_05_e97244b2-c305-4b1a-a375-58896887996b, _ActualPoster, 0) // 0 - wasn't destroyed. Can't be moved/picked up, so no need to check that
THEN
DB_BUGFIX_Marker("GUS-306257-PosterPosition");
TeleportToPosition(_ActualPoster, -140.66, 23.78, -99.62, "", 0, 0, 0, 0, 0);
//END_REGION

//REGION GUS-314220
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A") // have at least gone to LOW
AND
NOT DB_LevelUnreachable("CTY_Main_A") // and are not in END already.
THEN
PROC_GLO_Bugfix_314220_TrySetBhaalDisappointed();

PROC
PROC_GLO_Bugfix_314220_TrySetBhaalDisappointed()
AND
QRY_GEN_OrinsAbduction_HasDarkUrgeChar() // Dark Urge exist in this playthrough
AND
DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235) // after battle with Orin has already started.
AND
DB_GlobalFlag((FLAG)GLO_Orin_State_PermaDefeated_c716e4d9-e6ed-445c-a710-ee4d91c67298) // Orin is dead already
AND
NOT DB_GlobalFlag((FLAG)LOW_BhaalTemple_State_FacedOrinTemple_c770bc17-ffcd-400a-9316-b0d8f0202575) // Orin's gang was not wiped out yet or postBattle haven't triggered
AND
NOT QRY_AnyPlayerInTrigger((TRIGGER)S_LOW_BhaalTemple_Dangerzone_1d20188e-6154-4c9c-8cbd-39134c429113) // no player is in the temple
THEN
// Dark Urge will be counted as abandoning the duel Bhaal expects.
DB_BUGFIX_Marker("GUS-314220");
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_MissedTempleFinale_640cb288-0b40-434a-b13c-0c871d931bcc);
PROC_GlobalSetFlagAndCache((FLAG)ORI_DarkUrge_State_BhaalDisappointed_fb48dba0-24fd-e9ae-b6f9-4fadb9f8c4a0);
//END_REGION


//REGION GUS-314752
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-314752");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314752")
THEN
DB_BUGFIX_Marker("GUS-314752");
PROC_SetAnubisConfig(S_LOW_Elfsong_Yimiur_4e736c46-741a-4643-9b4a-e56dbf21699d, "LOW_Elfsong_Yimuir_Patched");
//END_REGION GUS-314752

//REGION GUS-313762
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-313762");

// Move characters that are still alive into position during coup, if they are not perma defeated.
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313762")
AND
DB_State_Current(S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae, "LOW_Guildhall_State", "LOW_Guildhall_State_DuringCoup")
AND
DB_LOW_Guildhall_CombatPositions(_Trigger, _Character)
AND
NOT DB_PermaDefeated(_Character)
AND
NOT QRY_IsInRange(_Character, _Trigger, 2.0)
THEN
PROC_NotifyWhenReadyToMoveOn(_Character, "SavegamePatch_GUS313762_ReadyToMove");

PROC
PROC_ReadyToMoveOn(_Character, "SavegamePatch_GUS313762_ReadyToMove")
AND
DB_LOW_Guildhall_CombatPositions(_Trigger, _Character)
THEN
PROC_CharacterMoveTo(_Character, _Trigger, "Run", "LOW_Guildhall_ZhentBetrayalPositioned");
DB_BUGFIX_Marker("GUS-313762-A", _Character);

// Define origin moment with Ninefingers if she survived the victory of the Guild over the Zhent after the coup.
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313762")
AND
DB_State_Current(S_LOW_Guildhall_SUB_adf8c225-5a74-4c9b-86ea-198aca6fabae, "LOW_Guildhall_State", "LOW_Guildhall_State_PostCoup_GuildControlled")
AND
NOT DB_PermaDefeated(S_LOW_Guildhall_NineFingers_ef1b7a12-6439-470a-885c-fa47851728cd)
AND
DB_GlobalFlag((FLAG)LOW_Guildhall_State_SidedWithNineFingers_9a6c3448-67c8-e23a-ed28-7b3cfba65bf5)
AND
NOT DB_DoubleOriginMoment((DIALOGRESOURCE)LOW_Guildhall_NineFingers_ef2cc5d5-b568-918e-a1d9-f95ef3b485eb,(TAG)REALLY_MINSC_aeb694fc-83fb-452d-819a-b97ba442dc42,_,_,_,_,_,_,_,_,_) // OM not defined
AND
NOT DB_GlobalFlag((FLAG)LOW_Guildhall_State_SpokenToNinefingersAfterSidingWithHer_8cc2cff6-0562-3733-4f80-e99797f0975b) // haven't spoken to Ninefingers yet
AND
QRY_OnlyOnce("LOW_Guildhall_NineFingersSetupAfterZhentAttack")
THEN
DB_Dialogs((CHARACTER)S_LOW_Guildhall_NineFingers_ef1b7a12-6439-470a-885c-fa47851728cd, (DIALOGRESOURCE)LOW_Guildhall_NineFingers_ef2cc5d5-b568-918e-a1d9-f95ef3b485eb);
PROC_DefineSingleOriginMoment((DIALOGRESOURCE)LOW_Guildhall_NineFingers_ef2cc5d5-b568-918e-a1d9-f95ef3b485eb, (TAG)REALLY_MINSC_aeb694fc-83fb-452d-819a-b97ba442dc42, NULL_00000000-0000-0000-0000-000000000000, (DIALOGRESOURCE)LOW_Guildhall_Ninefingers_OM_Minsc_COM_OOM_dcd969dc-5a4a-7ab9-915d-93254b05b88b, (DIALOGRESOURCE)LOW_Guildhall_Ninefingers_OM_Minsc_OOM_76086ae3-42dd-a56a-eaf9-d8f75f3877ba);
DB_BUGFIX_Marker("GUS-313762-B");
//END_REGION GUS-313762

//REGION GUS-315152
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-315152");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315152")
THEN
PROC_TriggerRegisterForPlayers(S_LOW_SerialKiller_AlexanderHouse_SawBody_89c03b92-8b39-42c4-ba1b-0ff8583fbfe2);
DB_BUGFIX_Marker("GUS-315152");
//END_REGION GUS-315152

//REGION GUS-307876
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-307876");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-307876")
AND
DB_GlobalFlag(ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff)
THEN
DB_FlagReactionAfterDialog(LOW_StormshoreTabernacle_State_WantsSurrenderCrown_4f748986-27db-df27-bd9d-115c101ab015, LOW_StormshoreTabernacle_MystraShrine_OM_Gale_AOM_OOM_41b0a0cd-ef82-7805-d7db-0e8ad71e6819);
DB_FlagReactionAfterDialog(LOW_StormshoreTabernacle_State_WantsSurrenderCrown_4f748986-27db-df27-bd9d-115c101ab015, LOW_StormshoreTabernacle_MystraShrine_OM_Gale_COM_0e9ad2bb-ef79-9d52-c34a-8fb59efb53f4);
DB_BUGFIX_Marker("GUS-307876");
//END_REGION GUS-307876

//REGION GUS-315392
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 6")
AND
NOT DB_BUGFIX_Marker("GUS-315392")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag(GLO_Volo_State_AtCamp_de1cadca-2eca-4cee-a3dc-e262bbb92277)
THEN
PROC_SetAnubisConfig(S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa, "GLO_Volo");
DB_BUGFIX_Marker("GUS-315392");
//END_REGION GUS-315392

//REGION GUS-315429
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("BGO_Main_A") // have at least gone to WYR
AND
NOT DB_LevelUnreachable("CTY_Main_A") // and are not in END already
THEN
DB_QuestDef_State((FLAG)LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b, "LOW_StopTheGazette", "EttvardDiedImmediate");
DB_Act3_GLO_Gazette_Articles("LOW_Gazette_Article127", 0, "Article");
DB_Act3_GLO_Gazette_Articles("LOW_Gazette_Article128", 0, "Article");
DB_Act3_GLO_Gazette_Articles("LOW_Gazette_Article129", 0, "Article");
DB_Act3_GLO_Gazette_Articles("LOW_Gazette_Article130", 0, "Article");
DB_Act3_GLO_Gazette_Articles("LOW_Gazette_Article131", 0, "Article");
DB_Act3_GLO_Gazette_Articles("LOW_Gazette_Article132", 0, "Article");
DB_Act3_GLO_Gazette_FlagReactions(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b, "LOW_Gazette_Article016", 6550);
DB_Act3_GLO_Gazette_FlagReactions(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b, "LOW_Gazette_Article127", 6500);
DB_Act3_GLO_Gazette_FlagReactions(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b, "LOW_Gazette_Article128", 6300);
DB_Act3_GLO_Gazette_FlagReactions(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b, "LOW_Gazette_Article129", 4200);
DB_Act3_GLO_Gazette_FlagReactions(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b, "LOW_Gazette_Article130", 1085);
DB_Act3_GLO_Gazette_FlagReactions(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b, "LOW_Gazette_Article131", 477);
DB_Act3_GLO_Gazette_FlagReactions(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b, "LOW_Gazette_Article132", 299);
DB_Act3_GLO_Gazette_FlagReactions(LOW_SerialKiller_State_WineFestival_a83198eb-b080-4001-bd00-d8368f1334a5 , "LOW_Gazette_Article017", 700);
NOT DB_Act3_GLO_Gazette_FlagReactions(LOW_BaldursMouth_State_EttvardIsDead_0719687b-df33-4bf6-b5ab-cf9cab372b5b, "LOW_Gazette_Article016", 1100);
DB_BUGFIX_Marker("GUS-315429");
//END_REGION GUS-315429

//REGION GUS-315370

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6","CTY_Main_A","GUS-315370");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315370")
AND
NOT DB_Destroyed(S_LOW_MurderTribunal_TombstoneShop_Front_Casket_cdb9d21c-0d97-4df9-a2b2-44b7d118090a)
THEN
ToInventory(S_LOW_MurderTribunal_GiantRat_41ca82a0-72d1-4e91-b645-7f9c13bdaa43,S_LOW_MurderTribunal_TombstoneShop_Front_Casket_cdb9d21c-0d97-4df9-a2b2-44b7d118090a, 1, 0, 0);
DB_BUGFIX_Marker("GUS-315370_ToInventory");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315370")
AND
DB_Destroyed(S_LOW_MurderTribunal_TombstoneShop_Front_Casket_cdb9d21c-0d97-4df9-a2b2-44b7d118090a)
THEN
SetOnStage(S_LOW_MurderTribunal_GiantRat_41ca82a0-72d1-4e91-b645-7f9c13bdaa43,0);
DB_BUGFIX_Marker("GUS-315370_OffStage");

//END_REGION GUS-315370

//REGION GUS-306595
QRY
QRY_BUGFIX_GUS306595_HasBusyDialog((CHARACTER)S_LOW_SteepsEvacuation_Child1_4d171372-75ff-40d1-8ea0-7c80273db8e5)
AND
DB_GlobalFlag((FLAG)LOW_Evacuation_HasMet_MadeDealWithSailor_76df3b6e-c3c2-f9b3-d6b6-7e1dd160725f)
THEN
DB_NOOP(1);

QRY
QRY_BUGFIX_GUS306595_HasBusyDialog((CHARACTER)S_LOW_SteepsEvacuation_Child2_8f095e66-076f-48cd-b85e-6e46b358675d)
AND
DB_GlobalFlag((FLAG)LOW_Evacuation_HasMet_MadeDealWithSailor_76df3b6e-c3c2-f9b3-d6b6-7e1dd160725f)
THEN
DB_NOOP(1);

QRY
QRY_BUGFIX_GUS306595_HasBusyDialog((CHARACTER)_Character)
AND
DB_LOW_VoloFate_Characters(_Character)
AND
_Character != S_GLO_Volo_2af25a85-5b9a-4794-85d3-0bd4c4d262fa
AND
_Character != S_LOW_VoloFate_Agitator_e896b270-21cd-4d5c-8b99-be87929f77f0
AND
DB_GlobalFlag((FLAG)LOW_VoloFate_State_AcceptedVolosFate_cdd3f96c-3b79-d4f7-cf60-a81c173d369a)
THEN
DB_NOOP(1);
//END_REGION GUS-306595

//REGION GUS-315904
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-315904");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315904")
AND
DB_LOW_CazadorsPalace_RitualRoom_Spawns(_Spawn, _, _, _)
AND
HasActiveStatus(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED", 1)
THEN
RequestSetSwarmGroup(_Spawn, "LOW_CAZADORSPALACE_RITUAL_CRYSTALLISED");
DB_BUGFIX_Marker("GUS-315904");
//END_REGION
//REGION GUS-307258
// Replace object flag with global flag
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_SorcerousSundries_Event_CypherReadBy_236b6a38-319c-448c-aef4-239f1842b622, _Player, 1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_SorcerousSundries_Event_CypherRead_2dd1c3d5-53b1-4884-849d-b0b72d3602b0);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)FOR_DangerousBook_Knows_TharchiateIsKey_7076b4da-9242-46d6-960d-793c820595b0)
AND
NOT DB_GlobalFlag((FLAG)LOW_SorcerousSundries_Event_CypherRead_2dd1c3d5-53b1-4884-849d-b0b72d3602b0)
AND
DB_Players(_Player)
AND
GetFlag(LOW_SorcerousSundries_State_HasTharchiate_79067d89-0cb1-47cf-a746-cc265948b527,_Player,1)
AND
QRY_OnlyOnce("FOR_DangerousBook_ReadyToUpdate_ReadTharchiate")
THEN
QuestUpdate((CHARACTER)_Player, "FOR_DangerousBook", "ReadTharchiateCodex");
DB_BUGFIX_Marker("GUS-307258-A");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_Event_CypherRead_2dd1c3d5-53b1-4884-849d-b0b72d3602b0)
AND
DB_GlobalFlag((FLAG)FOR_DangerousBook_Knows_TharchiateIsKey_7076b4da-9242-46d6-960d-793c820595b0)
AND
QRY_OnlyOnce("FOR_DangerousBook_ReadyToUpdate_LastStep")
THEN
QuestUpdate("FOR_DangerousBook", "ReadNecromancyOfThay");
DB_BUGFIX_Marker("GUS-307258-B");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LOW_SorcerousSundries_BookBoundTo(_Character)
THEN
NOT DB_LOW_SorcerousSundries_BookBoundTo(_Character);
DB_BUGFIX_Marker("GUS-307258-C");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LOW_SorcerousSundries_ReadyToReadLastPage(_Character)
THEN
NOT DB_LOW_SorcerousSundries_ReadyToReadLastPage(_Character);
DB_BUGFIX_Marker("GUS-307258-D");
//END_REGION GUS-307258

//REGION GUS-314946
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-314946");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314946")
THEN
TeleportToPosition(S_LOW_MinscHideout_MeetingSceneDialogTrigger_8796be50-6ccc-40f9-8c79-03e1467c80bb, -265.369, 16.5712, 876.161, "", 0, 0, 0, 0, 0);
DB_BUGFIX_Marker("GUS-314946");
//END_REGION GUS-314946

//REGION GUS-315903
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6","CTY_Main_A","GUS-315903");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315903")
AND
NOT DB_ItemDialog_NarratorAD((ITEM)S_LOW_Sign_BeachHouse_10dc8f8c-e955-4c83-8a69-d89188bf97ab, (DIALOGRESOURCE)LOW_AD_Sign_BeachHouse_bff2bd39-f7c7-084b-0145-2ffd199ac5d3)
THEN
TeleportToPosition(S_LOW_Sign_BeachHouse_10dc8f8c-e955-4c83-8a69-d89188bf97ab, 53.248, 6.558, -117.82, "", 0, 0, 0, 0, 0);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_Sign_BeachHouse_10dc8f8c-e955-4c83-8a69-d89188bf97ab, (DIALOGRESOURCE)LOW_AD_Sign_BeachHouse_bff2bd39-f7c7-084b-0145-2ffd199ac5d3);
DB_BUGFIX_Marker("GUS-315903");
//END_REGION GUS-315903

//REGION GUS-315923
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-315923");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315923")
THEN
DB_BUGFIX_Marker("GUS-315923");
NOT DB_QuestDef_State((FLAG)LOW_Elfsong_State_CellarRats_Killed_a0258996-aa49-46f7-a69d-07e56170e76c, "LOW_ElfsongRats", "Elfsong_RatsKilled");
NOT DB_QuestDef_State((FLAG)LOW_Elfsong_State_CellarRats_Killed_a0258996-aa49-46f7-a69d-07e56170e76c, "LOW_ReachEmperorLair", "Elfsong_FindButton");
DB_QuestDef_State((FLAG)LOW_Elfsong_State_RatsKilledGlobal_7416b42a-3c5b-4e6d-a584-84812e61fd1a, "LOW_ElfsongRats", "Elfsong_RatsKilled");
DB_QuestDef_State((FLAG)LOW_Elfsong_State_RatsKilledGlobal_7416b42a-3c5b-4e6d-a584-84812e61fd1a, "LOW_ReachEmperorLair", "Elfsong_FindButton");
//END_REGION GUS-315923

//REGION GUS-307970
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LOW_SteelWatchFoundry_ReadZannersBook(1)
THEN
SetFlag(LOW_SteelWatchFoundry_State_ReadToobinBook_a116650f-3212-4781-a9f3-10b3e0f66c45);
DB_BUGFIX_Marker("GUS-307970");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LOW_SteelWatchFoundry_ReadGondBook(1)
THEN
SetFlag(LOW_SteelWatchFoundry_State_ReadGondLoreBook_af3422fc-5ea9-4ee0-af17-6bd9c71ed0fd);
DB_BUGFIX_Marker("GUS-307970");
//END_REGION GUS-307970

//REGION GUS-283796
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6","CTY_Main_A","GUS-283796");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-283796")
THEN
PROC_SetAnubisConfig(S_LOW_CartLoading_Porter_01_d92da5e0-a132-4015-97ff-348d36675ce7, "LOW_CartLoading_Porter_01");
PROC_SetAnubisConfig(S_LOW_CartLoading_Porter_02_a6d25463-3e06-4f24-abd0-d5f3b2c393c0, "LOW_CartLoading_Porter_02");
DB_BUGFIX_Marker("GUS-283796");
//END_REGION GUS-283796

//REGION GUS-307652
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","CTY_Main_A","GUS-307652");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-307652")
AND
DB_LOW_Gondians(_Gondian)
THEN
RequestSetBaseArchetype(_Gondian, "act3_LOW_Mage_Smart_Gondian");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-307652")
THEN
RequestSetBaseArchetype(S_LOW_GondianWorker_PostIRN01_a4eb6135-5656-430f-b5f6-a217feb6eb0d, "act3_LOW_Mage_Smart_Gondian");
RequestSetBaseArchetype(S_LOW_GondianWorker_PostIRN02_b264c860-f30a-45a8-b35d-9f03a0d393b1, "act3_LOW_Mage_Smart_Gondian");
//END_REGION GUS-307652


//REGION GUS-315917
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6","CTY_Main_A","GUS-315917");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315917")
AND
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_Event_FundangoSignalsGondians_321b9521-b937-4cd9-8e49-ad02e5dc9bea)
AND
DB_LOW_LabGondians(_LabroomGondian)
AND
DB_Is_InCombat(_LabroomGondian, _)
AND
NOT DB_LOW_SteelWatchFoundry_BlurApplied(_LabroomGondian)
AND
IsInTrigger(_LabroomGondian, S_LOW_InstallationRoom_ca9a227a-afc2-4dc9-9984-41e6bb8baefd, 1)
THEN
ApplyStatus(_LabroomGondian, "BLUR", 60.0, 0, _LabroomGondian);
DB_LOW_SteelWatchFoundry_BlurApplied(_LabroomGondian);
//END_REGION GUS-315917

//REGION GUS-244291
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6","CTY_Main_A","GUS-244291");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-283796")
THEN
PROC_SetAnubisConfig(S_LOW_BaldursMouth_Malek_Stones_633663b4-a38a-4982-9f44-8ca368740f12, "LOW_BaldursMouth_Scribe_v2");
PROC_SetAnubisConfig(S_LOW_BaldursMouth_Reporter_02_0035276a-8d9e-4e70-b9ba-d525b5ee2670, "LOW_BaldursMouth_Scribe_v2");
PROC_SetAnubisConfig(S_LOW_BaldursMouth_Reporter_03_db9d9520-4d83-4d8a-bafd-1f668030a405, "LOW_BaldursMouth_Scribe_v2");
DB_BUGFIX_Marker("GUS-244291");

//END_REGION GUS-244291

//REGION GUS-309625
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_LOW_PhilgravesMansion_GoingInsideHouse(_Zombie)
THEN
NOT DB_LOW_PhilgravesMansion_GoingInsideHouse(_Zombie);
TriggerRegisterForCharacter((TRIGGER)S_LOW_TriggerEntranceDoor_3ecec798-f164-47c7-9e1a-8f1c4eeba7ba,_Zombie);
SetFlag((FLAG)LOW_PhilgravesMansion_ZombieMoving_9fa1155b-8a73-4cd2-8344-ae7faa34cbbb,_Zombie);
DB_BUGFIX_Marker("GUS-309625");
//END_REGION GUS-309625

//REGION GUS-313266
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6","CTY_Main_A","GUS-313266");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-313266")
THEN
PROC_SetAnubisConfig(S_LOW_ElfLover_000_b15d3b0d-eddd-4156-9dcc-77775d7c5975, "LOW_ElfLover_000");
PROC_SetAnubisConfig(S_LOW_ElfLover_001_47437f3d-70c5-4b88-a276-9a498280dc04, "LOW_ElfLover_001");
DB_BUGFIX_Marker("GUS-313266");

//END_REGION GUS-313266

//REGION GUS-283711
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6","CTY_Main_A","GUS-283711");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-283711")
THEN
PROC_SetAnubisConfig(S_LOW_FishAndGrime_Sailor_02_b72a36b1-20da-47a7-8e58-b6b53a7f23e7, "LOW_FishAndGrime_Sailor_02");
PROC_SetAnubisConfig(S_LOW_FishAndGrime_Sailor_01_b783dae8-e3d5-45ba-8937-1d7edcde5150, "LOW_FishAndGrime_Sailor_01");
DB_DoNotFaceDialog(S_LOW_FishAndGrime_Sailor_02_b72a36b1-20da-47a7-8e58-b6b53a7f23e7, (DIALOGRESOURCE)LOW_FishAndGrime_AD_Sailor_01_Sailor_02_9cff6514-9f6b-ae78-ad44-b4fec4c77d4c);
DB_DoNotFaceDialog(S_LOW_FishAndGrime_Sailor_01_b783dae8-e3d5-45ba-8937-1d7edcde5150, (DIALOGRESOURCE)LOW_FishAndGrime_AD_Sailor_01_Sailor_02_9cff6514-9f6b-ae78-ad44-b4fec4c77d4c);
DB_LOW_FishAndGrime_Barrels((ITEM)S_LOW_FishAndGrime_Barrel_01_fa009b15-7adf-4257-9fa7-9251862f1710, (TRIGGER)S_LOW_FishAndGrime_Barrel_01_Trigger_969f1688-e40d-4b68-8dcf-1ae5dcebb8de);
DB_LOW_FishAndGrime_Barrels((ITEM)S_LOW_FishAndGrime_Barrel_02_d02eb675-8c79-44a0-b054-3cc444135458, (TRIGGER)S_LOW_FishAndGrime_Barrel_02_Trigger_08534cd9-2a4c-4394-b641-123e9987f2d1);
DB_BUGFIX_Marker("GUS-283711");
//END_REGION GUS-283711

//REGION GUS-315494
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-315494");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315494")
AND
IsDestroyed(S_Door_HeapsideBottomA_299081b0-8dbf-4aac-8a80-6bbb17c64375, 0)
THEN
SetOnStage(S_Door_HeapsideBottomA_299081b0-8dbf-4aac-8a80-6bbb17c64375, 0);
DB_BUGFIX_Marker("GUS-315494");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315494")
AND
IsDestroyed(S_Door_HeapsideBottomA_299081b0-8dbf-4aac-8a80-6bbb17c64375, 1)
THEN
SetOnStage(S_Door_HeapsideBottomA2_7836c12d-15e6-48cd-90b3-293ebd592bf4, 0);
DB_BUGFIX_Marker("GUS-315494");

//END_REGION GUS-315494

//REGION GUS-316354
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-316354");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316354")
AND
NOT QRY_LOW_CazadorsPalace_IsSafe()
THEN
DB_BUGFIX_Marker("GUS-316354");
DB_DangerZone((TRIGGER)S_LOW_CazadorsPalace_AtticDangerZone_5a4a9581-4960-48ce-82da-b552f8a568ec, "LOW_CazadorsPalace_AtticArea");
DB_DangerZone((TRIGGER)S_LOW_CazadorsPalace_BasementDangerZone_c11bf16c-9944-4cc7-999d-7c34a7cba2ea, "LOW_CazadorsPalace_BasementArea");
//END_REGION

//REGION GUS-314962
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-314962");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314962")
THEN
DB_BUGFIX_Marker("GUS-314962");
TeleportTo(UNI_BOOK_LOW_StormshoreTabernacle_TabernacleAdrielleHelpRequest_000_beda39ae-c6d9-420f-a783-f2e1ddcce4fb, S_LOW_StormshoreTabernacle_SavegamePatch_ScrollPlea_ed9a0059-a1c3-4889-aec4-c87ae9b7898f);
//END_REGION GUS-314962

//REGION GUS-315916
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
QRY_BUGFIX_315916_CheckJarSeen()
THEN
SetFlag((FLAG)LOW_PhilgravesMansion_State_SeenHeart_1afe634c-dc0e-432b-b19c-231cfcffe4fe);
DB_BUGFIX_Marker("GUS-315916");

QRY
QRY_BUGFIX_315916_CheckJarSeen()
AND
DB_GlobalFlag((FLAG)LOW_Thrumbo_Event_ThrowUp_6e4e32f8-312b-4bfc-bd46-15af3831a1b5)
THEN
DB_NOOP(1);

QRY
QRY_BUGFIX_315916_CheckJarSeen()
AND
NOT DB_GlobalFlag((FLAG)LOW_Thrumbo_Event_ThrowUp_6e4e32f8-312b-4bfc-bd46-15af3831a1b5)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_PhilgravesMansion_State_HasHeart_22154967-9777-4149-bbae-216409fea025,_Player,1)
THEN
DB_NOOP(1);

//END_REGION GUS-315916

//REGION GUS-316782
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-316782");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316782")
THEN
PROC_SetAnubisConfig(S_LOW_SteelWatcher026_92c1d2f1-f1df-4a88-b599-7c0db7390ef9, "LOW_SteelWatcher_Roof");
//END_REGION GUS-316782

//REGION GUS-316655

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-316655");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316655")
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134,"LOW_Dolor","MurderTribunal")
AND
DB_GLO_Playable(_Player)
AND
NOT DB_OnlyOnce("LOW_MurderTribunal_HadDolorDeathKnightDialog")
AND
GetFlag((FLAG)LOW_MurderTribunal_HasMet_DolorAndDeathKnight_285630b5-9350-6144-5b05-34b0a9614f53,_Player,1)
THEN
DB_OnlyOnce("LOW_MurderTribunal_HadDolorDeathKnightDialog");
DB_BUGFIX_Marker("GUS-316655");

//END_REGION GUS-316655

//REGION GUS-312085
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-312085");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-312085")
AND
DB_ItemDialog_NarratorAD(S_LOW_KurwinCoffin_KurwinGravestone_2dfe90f5-cea1-4a21-9e9d-bf131fc35a7e, LOW_KurwinCoffin_AD_GraveKurwin_ccee4369-4234-f655-5a5c-16d2ab03bbc1)
THEN
NOT DB_ItemDialog_NarratorAD(S_LOW_KurwinCoffin_KurwinGravestone_2dfe90f5-cea1-4a21-9e9d-bf131fc35a7e, LOW_KurwinCoffin_AD_GraveKurwin_ccee4369-4234-f655-5a5c-16d2ab03bbc1);
DB_BUGFIX_Marker("GUS-312085");

//END_REGION GUS-312085

//REGION GUS-315577

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-315577");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315577")
AND
DB_OnlyOnce("LOW_OskarsBeloved_RevealPortals")
AND
QRY_BUGFIX_315577_CheckPortals()
THEN
PROC_LOW_SorcerousSundries_ActivatePuzzlePortals();
DB_BUGFIX_Marker("GUS-315577");

QRY
QRY_BUGFIX_315577_CheckPortals()
AND
DB_LOW_SorcerousSundriesPuzzlePortals(_Portal,_Effect)
AND
GetCanInteract(_Portal,0)
THEN
DB_NOOP(1);

//END_REGION

//REGION GUS-313323
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-313323");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-313323")
THEN
PROC_LOW_BUGFIX_312085_CheckRamazithItems((ITEM)S_LOW_MagicItemRamazith_000_7a15ab31-e722-4ce0-8f1c-907025e3bef0,(ITEM)S_LOW_MagicItemRamazith_Barrier_000_62b8513b-2e9f-405e-8f7e-7ea590a1e93c);
PROC_LOW_BUGFIX_312085_CheckRamazithItems((ITEM)S_LOW_MagicItemRamazith_001_8ed5daac-b55f-40df-938c-34dc189101ad,(ITEM)S_LOW_MagicItemRamazith_Barrier_001_1c250ae9-3ea6-43f8-b0a9-33da13d8c2f0);
DB_BUGFIX_Marker("GUS-313323");

PROC
PROC_LOW_BUGFIX_312085_CheckRamazithItems((ITEM)_Item,(ITEM)_Barrier)
AND
DB_Defeated((GUIDSTRING)_Barrier)
AND
GetCanInteract(_Item,0)
THEN
SetCanInteract(_Item,1);

PROC
PROC_LOW_BUGFIX_312085_CheckRamazithItems((ITEM)_Item,(ITEM)_Barrier)
AND
NOT DB_Defeated(_Barrier)
AND
NOT DB_LOW_SorcerousSundries_Barriers(_Barrier, _Item)
THEN
DB_LOW_SorcerousSundries_Barriers(_Barrier, _Item);
//END_REGION GUS-313323
//REGION GUS-316753
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-316753");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316753")
AND
DB_LOW_SorcerousSundries_Projections(_Projection)
AND
IsOnStage(_Projection,0)
AND
HasActiveStatus(_Projection,"LOW_SORCEROUSSUNDRIES_PROJECTION",1)
THEN
RemoveStatus(_Projection,"LOW_SORCEROUSSUNDRIES_PROJECTION");
DB_BUGFIX_Marker("GUS-316753");

//END_REGION

//REGION GUS-315398

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-315398");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315398")
AND
GetAnubisConfig(S_LOW_ShadowheartFather_c12d561f-beae-4ef6-917e-0bec2f829449, "DefaultCharacter")
THEN
PROC_SetAnubisConfig((CHARACTER)S_LOW_ShadowheartFather_c12d561f-beae-4ef6-917e-0bec2f829449, "LOW_ShadowheartFather");
PROC_SetAnubisConfig((CHARACTER)S_LOW_ShadowheartMother_d085272a-f1d0-4ff8-a498-80728030f83e, "LOW_ShadowheartMother");

//END_REGION GUS-315398

//REGION GUS-266245
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-266245");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-266245")
AND
GetAnubisConfig(S_LOW_SWS_BaldursMouth_FF_000_d25b7709-2d37-406e-be4d-a2f24390cf68, "LOW_SWS_Common")
THEN
PROC_SetAnubisConfig((CHARACTER)S_LOW_SWS_BaldursMouth_FF_000_d25b7709-2d37-406e-be4d-a2f24390cf68, "LOW_SWS_Inspector");
DB_BUGFIX_Marker("GUS-266245");

//END_REGION

//REGION GUS-310207

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6", "CTY_Main_A", "GUS-310207");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-310207")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT DB_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_PartOfTheTeam(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
DB_AddCharactersInTriggerToDialog(LOW_Minsc_SaveFromAbsolute_eeb5d970-975f-5f16-80ba-4aa54cb65702, S_LOW_MinscHideout_MeetingSceneDialogTrigger_AddChars_fb8bb0b2-af42-4029-98d0-5fb2e195e086, 1);
DB_OriginMoment_MaxDistance(LOW_Minsc_SaveFromAbsolute_eeb5d970-975f-5f16-80ba-4aa54cb65702, 50.0);
DB_OriginDialogTrigger(LOW_Minsc_SaveFromAbsolute_eeb5d970-975f-5f16-80ba-4aa54cb65702, (TRIGGER)S_LOW_MinscHideout_MeetingSceneDialogTrigger_AddChars_fb8bb0b2-af42-4029-98d0-5fb2e195e086);
DB_BUGFIX_Marker("GUS-310207");

//END_REGION

//REGION GUS-316332
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-316332");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316332")
AND
IsInTrigger(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, S_LOW_TitanRoom_94336e01-c407-48b9-96dd-eb3ace162cf3, 1)
THEN
DB_LOW_SteelWatchFoundry_WaitToobinLeaveTitanRoom(1);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316332")
THEN
TriggerRegisterForCharacter(S_LOW_TitanRoom_94336e01-c407-48b9-96dd-eb3ace162cf3, S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d);

IF
LeftTrigger(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d, S_LOW_TitanRoom_94336e01-c407-48b9-96dd-eb3ace162cf3)
AND
DB_LOW_SteelWatchFoundry_WaitToobinLeaveTitanRoom(1)
THEN
NOT DB_LOW_SteelWatchFoundry_WaitToobinLeaveTitanRoom(1);
//END_REGION GUS-316332

//REGION GUS-315783

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8","CTY_Main_A","GUS-315783_2");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUS-315783_2")
AND
Exists(LTS_GEN_Fire_Basket_A_000_9bbebf3a-6692-4b48-bc59-6353f6060eb4,1)
THEN
RequestDelete((ITEM)LTS_GEN_Fire_Basket_A_000_9bbebf3a-6692-4b48-bc59-6353f6060eb4);
DB_BUGFIX_Marker("GUS-315783_2");

//END_REGION

//REGION GUS-315588

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-315588");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315588")
AND
GetFlag((FLAG)LOW_HouseOfGrief_State_GossipReady_1fc1b11e-e622-4e6c-8ec3-4808c46c7aa3, LOW_HouseOfGrief_GriefGuard_000_73a30de9-9abd-c8a6-2f4c-cf3c3d8400c1, 1)
AND
GetFlag((FLAG)LOW_HouseOfGrief_State_GossipReady_1fc1b11e-e622-4e6c-8ec3-4808c46c7aa3, LOW_HouseOfGrief_GriefGuard_001_2d65a92a-5fe4-cd68-e64e-723ecb6d7246, 1)
AND
NOT DB_GlobalFlag(LOW_HouseOfGrief_State_GuardsGossiped_0f37bde1-0f00-4eaa-baaa-3dce8ae0dbd3)
THEN
PROC_GlobalSetFlagAndCache(LOW_HouseOfGrief_State_GuardsGossiped_0f37bde1-0f00-4eaa-baaa-3dce8ae0dbd3);

//END_REGION GUS-315588

//REGION GUS-315232

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6", "CTY_Main_A", "GUS-315232");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315232")
THEN
DB_GLO_LevelTraveler((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "CTY_Main_A", "LOW_Alfira");
NOT DB_GLO_LevelTraveler((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "CTY_Main_A", "DefaultCharacter");
PROC_SetAnubisConfig((CHARACTER)S_DEN_Bard_4a405fba-3000-4c63-97e5-a8001ebb883c, "LOW_Alfira");

//END_REGION GUS-315232

//REGION GUS-316521
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelUnreachable("WLD_Main_A")
AND
NOT QRY_PLA_DoubtingArtist_CheckIfFreed()
AND
DB_QuestIsOpened("GLO_DoubtingArtist")
THEN
QuestUpdate("GLO_DoubtingArtist","LeftDidntSave");
DB_BUGFIX_Marker("GUS-316521");
//END_REGION GUS-316521
//REGION GUS-316527

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)LOW_Guildhall_State_SpokenToNinefingersAfterSidingWithHer_8cc2cff6-0562-3733-4f80-e99797f0975b)
AND
NOT DB_GlobalFlag((FLAG)LOW_Guildhall_State_NinefingersWillHelpEND_bdab2f3d-d878-4367-9519-c52117dcf915)
THEN
PROC_GlobalClearFlagAndCache((FLAG)LOW_Guildhall_State_SpokenToNinefingersAfterSidingWithHer_8cc2cff6-0562-3733-4f80-e99797f0975b);
DB_BUGFIX_Marker("GUS-316527");

//END_REGION GUS-316527

//REGION GUS-313194
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_Event_CypherRead_2dd1c3d5-53b1-4884-849d-b0b72d3602b0)
AND
DB_QuestIsOpened("FOR_DangerousBook")
AND
QRY_OnlyOnce("FOR_DangerousBook_ReadyToUpdate_LastStep")
THEN
QuestUpdate("FOR_DangerousBook", "ReadNecromancyOfThay");
DB_BUGFIX_Marker("GUS-313194");
//END_REGION GUS-313194

//REGION GUS-313194
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_Event_CypherRead_2dd1c3d5-53b1-4884-849d-b0b72d3602b0)
AND
DB_QuestIsOpened("FOR_DangerousBook")
AND
QRY_OnlyOnce("FOR_DangerousBook_ReadyToUpdate_LastStep")
THEN
QuestUpdate("FOR_DangerousBook", "ReadNecromancyOfThay");
DB_BUGFIX_Marker("GUS-313194");
//END_REGION GUS-313194

//REGION GUS-314053
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-314053");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-314053")
THEN
PROC_BUGFIX_314053_CheckMystraFlag((FLAG)ORI_Gale_MystraOM_State_RefusedOM_617d8194-0aa8-4fd9-9c8c-c6fd545afd64);
PROC_BUGFIX_314053_CheckMystraFlag((FLAG)ORI_Gale_State_MystraOM_40a7e59c-2473-504b-27ec-b2903fd5cf96);

PROC
PROC_BUGFIX_314053_CheckMystraFlag((FLAG)_Flag)
AND
DB_GlobalFlag(_Flag)
AND
IsOnStage(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b,1)
THEN
DB_BUGFIX_Marker("GUS-314053");
DB_LOW_Gale_WaitingToDismissElminster(1);

//END_REGION GUS-314053

//REGION GUS-308049
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-308049");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-308049")
THEN
DB_BUGFIX_Marker("GUS-308049");
DB_LOW_CazadorsPalace_RitualRoom_ExtraBuffsHelpers("LOW_CAZADORSPALACE_SPAWNBUFF_ASTARION", "LOW_CAZADORSPALACE_SPAWNBUFF_ASTARION_TECHNICAL");
//END_REGION

//REGION GUS-311086
PROC
PROC_ApplySavegamePatches()
AND
DB_GlobalFlag((FLAG)LOW_Grotto_State_ViconiaDefeated_8e27eb4e-8d52-4966-8aa4-e658ff595097)
AND
DB_Dialogs(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, (DIALOGRESOURCE)LOW_SharGrotto_ConfrontViconia_NoShadowheart_78e68cb8-fc4e-fa55-c4a9-5f7224b86fe4)
AND
NOT DB_Dead((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-311086");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-311086")
AND
IsOnStage(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, 1)
THEN
PROC_RemoveDialog(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313);
DB_Dialogs(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, (DIALOGRESOURCE)LOW_SharGrotto_ViconiaDefeated_NoShadowheart_6c6f05fc-391a-40f8-c7c0-68bd37dd1e09);

//END_REGION GUS-311086

//REGION GUS-316980
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_DeadOnceFlag(S_LOW_GithKid_10403a03-aa9c-4c68-8a52-cbb381627906, (FLAG)LOW_GithKid_State_DiedOnce_03ae2d98-fa44-474e-8634-f40c64f3d010);
DB_BUGFIX_Marker("GUS-316980_DeadOnceDBSet");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 6")
AND
DB_Dead(S_LOW_GithKid_10403a03-aa9c-4c68-8a52-cbb381627906)
AND
NOT DB_GlobalFlag((FLAG)LOW_GithKid_State_DiedOnce_03ae2d98-fa44-474e-8634-f40c64f3d010)
THEN
SetFlag((FLAG)LOW_GithKid_State_DiedOnce_03ae2d98-fa44-474e-8634-f40c64f3d010);
DB_BUGFIX_Marker("GUS-316980_DeadOnceFlagSet");
//END_REGION

//REGION GUS-317267
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-317267");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317267")
THEN
DB_BUGFIX_Marker("GUS-317267");
NOT DB_LOW_SteelWatchFoundry_DeadMansSwitches(NULL_00000000-0000-0000-0000-000000000000, (ITEM)S_LOW_DeadMansSwitch10_38268e0d-ee64-4650-8c11-4038ff342864, "LOW_Switch11");
NOT DB_LOW_SteelWatchFoundry_DeadMansSwitches(NULL_00000000-0000-0000-0000-000000000000, (ITEM)S_LOW_DeadMansSwitch11_ed0e1a9a-c273-4d57-9c60-083de0b22ad6, "LOW_Switch12");
NOT DB_LOW_SteelWatchFoundry_DeadMansSwitches(NULL_00000000-0000-0000-0000-000000000000, (ITEM)S_LOW_DeadMansSwitch12_8c7b921f-8cd9-420f-a80b-06a4f26f14ed, "LOW_Switch13");
NOT DB_LOW_SteelWatchFoundry_DeadMansSwitches(NULL_00000000-0000-0000-0000-000000000000, (ITEM)S_LOW_DeadMansSwitch13_a70f3617-10a1-412f-8766-975fe370fa32, "LOW_Switch14");
NOT DB_LOW_SteelWatchFoundry_DeadMansSwitches(NULL_00000000-0000-0000-0000-000000000000, (ITEM)S_LOW_DeadMansSwitch14_e22874c8-f274-4521-a22d-19153fa9be91, "LOW_Switch15");
//END_REGION GUS-317267

//REGION GUS-314453
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT DB_QuestDef_State((FLAG)LOW_SharGrotto_ConfrontViconia_SharranAlliance_ea829b7c-5f69-c4fc-6b4c-b8a190d31a86, "ORI_COM_ShadowHeart", "SurrenderedShadowheart")
THEN
DB_QuestDef_State((FLAG)LOW_SharGrotto_ConfrontViconia_SharranAlliance_ea829b7c-5f69-c4fc-6b4c-b8a190d31a86, "ORI_COM_ShadowHeart", "SurrenderedShadowheart");
DB_BUGFIX_Marker("GUS-314453");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_SharGrotto_ConfrontViconia_SharranAlliance_ea829b7c-5f69-c4fc-6b4c-b8a190d31a86)
THEN
QuestUpdate((CHARACTER)S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "ORI_COM_ShadowHeart", "SurrenderedShadowheart");
DB_BUGFIX_Marker("GUS-314453_QuestUpdate");
//END_REGION GUS-314453

//REGION GUS-315647
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-315647");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315647")
AND
NOT DB_PermaDefeated(S_LOW_DevilsFee_Helsik_299a1c00-ff53-415e-ad8e-9bcbbae55597)
AND
NOT DB_Bugfix_Marker("GUS-309340")
AND
QRY_IsExistingItem(S_LOW_Helsik_ButlerHat_df031755-7b3b-4492-842e-90bc26556b60,1)
AND
IsInInventory(S_LOW_Helsik_ButlerHat_df031755-7b3b-4492-842e-90bc26556b60, 0)
AND
GetPosition(S_LOW_Helsik_ButlerHat_df031755-7b3b-4492-842e-90bc26556b60, -38.0, 38.0, 17.0) //To be sure that the butler hat was not interacted at all
THEN
PROC_LOW_DevilsFee_AddButlerHat();
DB_BUGFIX_Marker("GUS-315647");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315647")
AND
NOT DB_PermaDefeated(S_LOW_DevilsFee_Helsik_299a1c00-ff53-415e-ad8e-9bcbbae55597)
AND
NOT DB_Bugfix_Marker("GUS-309340")
AND
QRY_IsExistingItem(S_LOW_Helsik_ButlerHat_df031755-7b3b-4492-842e-90bc26556b60,1)
AND
IsInInventory(S_LOW_Helsik_ButlerHat_df031755-7b3b-4492-842e-90bc26556b60, 0)
AND
NOT GetPosition(S_LOW_Helsik_ButlerHat_df031755-7b3b-4492-842e-90bc26556b60, -38.0, 38.0, 17.0) //To be sure that the butler hat was not interacted at all
THEN
PROC_SetOnStage(S_LOW_Helsik_ButlerHat_df031755-7b3b-4492-842e-90bc26556b60, 0);
DB_BUGFIX_Marker("GUS-315647");
//END_REGION GUS-315647

//REGION GUS-314007
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_LOW_Baneites(_Baneite)
THEN
DB_ForceRemoveKnockedOutCharacterOnLongRest((CHARACTER)_Baneite);
DB_BUGFIX_Marker("GUS-314007");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172);
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c);
//END_REGION GUS-314007

//REGION GUS-317637
PROC
PROC_ApplySavegamePatches()
AND
DB_GlobalFlag(LOW_SteelWatchFoundry_State_ReturnedFromIronThrone_16f58dd6-71c1-41e8-b053-b32991ac8fa1)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-317637");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317637")
AND
DB_LOW_WorkroomGondians(_Gondian)
THEN
SetCombatGroupID(_Gondian, "LOW_SteelWatchFoundry_Workroom_AfterIRNFight");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317637")
THEN
SetCombatGroupID(S_LOW_GondianWorker_PostIRN01_a4eb6135-5656-430f-b5f6-a217feb6eb0d, "LOW_SteelWatchFoundry_Workroom_AfterIRNFight");
SetCombatGroupID(S_LOW_GondianWorker_PostIRN02_b264c860-f30a-45a8-b35d-9f03a0d393b1, "LOW_SteelWatchFoundry_Workroom_AfterIRNFight");
SetCombatGroupID(S_LOW_BaneiteOfficer_PostIRN01_36c0bb47-a8cc-4381-882b-a2ded38d0b5c, "LOW_SteelWatchFoundry_Workroom_AfterIRNFight");
SetCombatGroupID(S_LOW_BaneiteOfficer_PostIRN02_2cc225cf-794a-450a-bbb7-4b3400cb3c74, "LOW_SteelWatchFoundry_Workroom_AfterIRNFight");
SetCombatGroupID(S_LOW_BaneiteOfficer02_de084b09-99c6-426e-9159-f692d180d418, "LOW_SteelWatchFoundry_Workroom_AfterIRNFight");
SetCombatGroupID(S_LOW_BaneiteOfficer03_71dbaf54-1274-4671-ae51-c7e512f02835, "LOW_SteelWatchFoundry_Workroom_AfterIRNFight");
SetCombatGroupID(S_LOW_BaneiteOfficer17_f6614259-eec4-4c38-b87b-cf5c806be6fd, "LOW_SteelWatchFoundry_Workroom_AfterIRNFight");
//END_REGION GUS-317637

//REGION GUS-309132
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-309132");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309132")
AND
DB_OnlyOnce("LOW_PhilgravesMansion_BeggarTakeover")
THEN
PROC_LOW_PhilgravesMansion_RemoveBeggarVignettes();
DB_BUGFIX_Marker("GUS-309132");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-309132")
AND
DB_LOW_PhilgravesMansion_BeggarOneShotTriggers(_Trigger,(CHARACTER)_Zombie,_Civilian,_)
AND
DB_PermaDefeated(_Zombie)
THEN
PROC_RemoveOneShotTrigger(_Trigger);
PROC_LOW_PhilgravesMansion_RemoveCharacter(_Civilian,"Run");
DB_BUGFIX_Marker("GUS-309132-2");
//END_REGION GUS-309132

//REGION GUS-292088

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-292088");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-292088")
THEN
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_GLO_GeneralLoreBook_GuideToGoblinoids_000_cf52e3ec-3009-49a6-81a4-9a1cda2df265);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_GLO_GeneralLoreBook_TheQuartaSune_000_89239504-33db-48a1-9b7d-17962cf0b19d);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_BhaalTemple_DorghansDiary_000_bfff1c17-6bbc-470a-b5f9-a5411c4fc5e7);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_BhaalTemple_EcstasyOfMurder_000_539ffce8-bec9-4c06-8cfa-a8236380b086);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_BhaalTemple_ITalkToTheBones_000_14bb1f5b-c973-4d34-a31a-d8f3b5c351b3);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_BhaalTemple_MashasWeddingVows_000_05905cee-fc9e-4b5a-b3cf-71bca0f39cfc);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_BhaalTemple_StivsWeddingVows_000_c1ddbbbc-9f43-4e3f-a06a-b9667621430e);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_CazadorsPalace_DawsenKiltmakersConfession_000_97ae4db9-0503-4c1b-97ee-f1ff5a7264e4);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_CazadorsPalace_EverythingMustBePerfect_000_0a9ad8e5-6468-45e1-bc3a-2852fefacb7b);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_CazadorsPalace_GetYouIn_000_4c203a6d-7774-464e-abfe-906fb914b06b);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_SharranCloister_DearMam_000_b4d48601-97d9-4f16-9e6c-272be6e43737);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_SharranCloister_ExcitingNews_d5565940-ebef-4d09-ba33-9dd9e13d855e);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_SteelWatchFoundry_GondianGnomeOrders_001_65ca75b7-b591-4338-bf12-bde9be7a9eca);
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)BOOK_LOW_SharranCloister_NoteToSelf_Bloodstains_000_d10dc7ca-c758-4c22-875c-0b3351c523d6);

PROC
PROC_BUGFIX_292088_CheckBookAndPatch((ITEM)_LevelBook)
AND
Exists(_LevelBook,1)
AND
GetInventoryOwner(_LevelBook,_Owner)
AND
Exists(_Owner,1)
AND
GetTemplate(_LevelBook,_BookRoot)
AND
GetUUID(_LevelBook,_UUID)
AND
GetBookID(_LevelBook,_BookID)
AND
Concatenate("BUGFIX_292088_CheckBookRootAndPatch_",_UUID,_Identifier)
AND
Concatenate(_Identifier,"_Finish",_IdentifierFinish)
THEN
DB_BUGFIX_292088_CheckBookAndPatch((ITEM)_LevelBook,(STRING)_BookID,(STRING)_Identifier,(STRING)_IdentifierFinish);
IterateInventoryByTemplate(_Owner,_BookRoot,_Identifier,_IdentifierFinish);

IF
EntityEvent(_Book,_Identifier)
AND
DB_BUGFIX_292088_CheckBookAndPatch((ITEM)_LevelBook,(STRING)_BookID,(STRING)_Identifier,(STRING)_IdentifierFinish)
AND
_Book != _LevelBook
AND
Exists(_Book,1)
AND
GetBookID((ITEM)_Book,_BookID)
THEN
DB_BUGFIX_Marker_GUS_292088((GUIDSTRING)_Book,(GUIDSTRING)_LevelBook);
RequestDelete((ITEM)_Book);

IF
DB_BUGFIX_Marker_GUS_292088((GUIDSTRING)_Book,(GUIDSTRING)_LevelBook)
THEN
DB_NOOP(1);

IF
EntityEvent(_,_IdentifierFinish)
AND
DB_BUGFIX_292088_CheckBookAndPatch((ITEM)_LevelBook,(STRING)_BookID,(STRING)_Identifier,(STRING)_IdentifierFinish)
THEN
NOT DB_BUGFIX_292088_CheckBookAndPatch((ITEM)_LevelBook,(STRING)_BookID,(STRING)_Identifier,(STRING)_IdentifierFinish);

//END_REGION GUS-292088

//REGION GUS-315671
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-315671");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-315671")
THEN
DB_GiveItemToEvent(S_COL_NecromancerLab_MolEyepatch_fa9baba1-f855-449c-8327-9728a493b193, (FLAG)LOW_Guildhall_Event_GiveEyePatch_5fac5f13-a46f-4a15-a210-6704cdbfd946);
//END_REGION GUS-315671

//REGION GUS-317694
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-317694");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317694")
THEN
NOT DB_ORI_OriginCampData((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901,"ELFSONG",(TRIGGER)S_CAMP_ELFSONG_Courier_Dog_ba472550-71a7-47a1-9ee6-b0db07ec50d3);
DB_ORI_OriginCampData((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901,"ELFSONG",(TRIGGER)S_CAMP_ELFSONG_Courier_Dog_676adaee-add8-49ea-8512-0020c4f67edf);
SetEntityEvent(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901, "CampPosRequest", 1);
//END_REGION GUS-317694

//REGION GUS-296695
PROC
PROC_ApplySavegamePatches()
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT DB_DoNotFaceDialog(S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, LOW_JaheirasHouse_AD_JordAndRion_17c60a81-617b-e57e-f0a6-52f626a6e129)
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-296695");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-296695")
THEN
TeleportToPosition(S_LOW_JaheiraEldestSonKitchenTrigger_3b6dff28-e081-4447-9ea9-3e874af50afa, -223.0, 27.0, -39.0, "TeleportJaheiraKitchenTrigger", 0, 0, 0, 0, 1);
TeleportToPosition(S_LOW_JaheiraEldestSonRepairTrigger_e7f012be-87f6-465e-bb1c-77af312d8212, -226.0, 28.0, -39.0, "TeleportJaheiraKitchenTrigger", 0, 0, 0, 0, 1);
DB_DoNotFaceDialog(S_LOW_JaheirasHouse_JaheirasEldestSon_ebfe9029-2a74-40eb-bbd1-8e5d0ec8fe1f, LOW_JaheirasHouse_AD_JordAndRion_17c60a81-617b-e57e-f0a6-52f626a6e129);

//END_REGION GUS-296695

//REGION GUS-317745

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-317745");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_StartedBaptism_9231a565-3cf9-4754-a9c4-db02e7f0eeb8)
AND
NOT DB_Is_InCombat(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,_)
AND
IsLocked(S_LOW_MurderTribunal_Abattoir_Door_7e86f8f7-3e80-4035-a0e3-451b18a5b7bf,1)
AND
IsInTrigger(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,S_LOW_MurderTribunal_Baptism_Sarevok_Box_f13624f9-c9b8-45e2-80bd-7c627342b706,0)
THEN
DB_BUGFIX_Marker("GUS-317745_SplitCombatGroup");
DB_LOW_MurderTribunal_CourtCombatGroupSplit(1);
SetCombatGroupID(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"LOW_MurderTribunal_Sarevok");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_LOW_MurderTribunal_CourtCombatGroupSplit(1)
AND
DB_LOW_MurderTribunal_Court_NPCs(_Character,_,_)
AND
_Character != S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6
THEN
SetCombatGroupID(_Character,"LOW_MurderTribunal_Court");


PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_LOW_MurderTribunal_Cultists((CHARACTER)_Cultist)
AND
NOT DB_LOW_MurderTribunal_Cultists_OffStage((CHARACTER)_Cultist)
THEN
DB_GLO_DefeatCounter(_Cultist,"LOW_MurderTribunal_Bhaalists");
DB_BUGFIX_Marker("GUS-317745_CultistDefeatCounterFix",_Cultist);
DB_BUGFIX_Marker("GUS-317745_CultistDefeatCounterFix");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_BUGFIX_Marker("GUS-317745_CultistDefeatCounterFix")
THEN
PROC_GLO_DefeatCounter_CheckFinished("LOW_MurderTribunal_Bhaalists");


PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_TrialResolved_f3fe8b2d-50ea-3b9c-91ea-13f18f60d617)
AND
NOT DB_PermaDefeated((CHARACTER)S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58)
AND
NOT DB_Dialogs(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,(DIALOGRESOURCE)LOW_MurderTribunal_Valeria_b16af572-5cc7-ac8c-15a8-2ca2e68b9da2)
AND
NOT DB_DisappearedOutOfSight(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,_,_,_,"LOW_MurderTribunal_ValeriaLeaves",_,_)
AND
IsInTrigger(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,S_LOW_MurderTribunal_Baptism_AfterKill_Trigger_486f0c1a-2543-4930-8f3c-7a5f6409f80f,1)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58);
DB_Dialogs(S_GLO_HollyphantDetective_acf70307-3bb9-4b91-b894-fa2120916f58,(DIALOGRESOURCE)LOW_MurderTribunal_Valeria_b16af572-5cc7-ac8c-15a8-2ca2e68b9da2);
DB_BUGFIX_Marker("GUS-317745_ValeriaNoDialogFix");


PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_PermaDefeated(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6)
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_State_BhaalistsDefeated_4f6e1415-fd18-4179-ab94-3efa59a2d1e9)
THEN
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,0);
DB_BUGFIX_Marker("GUS-317745_TribunalHostileIfSarevokPermaDefeated");


PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_Players(_Player)
AND
GetFaction(_Player,_Faction)
AND
GetRelation((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,_Faction,0)
AND
HasActiveStatus(S_LOW_MurderTribunal_Sarevok_ae9f784a-ea64-4297-95a7-8377e85231b6,"TEMPORARILY_HOSTILE",1)
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_MurderTribunal_2d4a232d-7c80-47a4-b46d-f8a1e91bb936,_Faction,0);
DB_BUGFIX_Marker("GUS-317745_FixTribunalTemporaryHostility");


PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_Players(_Player)
AND
GetFaction(_Player,_Faction)
AND
GetRelation((FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585,_Faction,0)
AND
HasActiveStatus(ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585,"TEMPORARILY_HOSTILE",1)
THEN
PROC_SetRelationMutual((FACTION)ACT3_LOW_MurderTribunal_DeathKnight_da0da758-98aa-468c-a13e-8e36fac86585,_Faction,0);
DB_BUGFIX_Marker("GUS-317745_FixDeathKnightTemporaryHostility");


PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_Dead(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraMinscSacrifice_d391d86e-d30f-e4db-6650-a97a2e38a79f)
THEN
Die(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_BUGFIX_Marker("GUS-317745_ForcePermaDefeatedJaheiraDeath");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_Dead(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraMinscSacrifice_d391d86e-d30f-e4db-6650-a97a2e38a79f)
THEN
Die(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
DB_BUGFIX_Marker("GUS-317745_ForcePermaDefeatedMinscDeath");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_PermaDefeated(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
NOT DB_Dead(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedJaheiraSacrifice_4d34ecc5-705a-2081-2826-a62076e705d9)
THEN
Die(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);
DB_BUGFIX_Marker("GUS-317745_ForcePermaDefeatedJaheiraDeath");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317745")
AND
DB_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_Dead(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_GlobalFlag((FLAG)LOW_MurderTribunal_State_OfferedMinscSacrifice_5bda0a8c-eea3-8403-2965-82d9e8b24bfe)
THEN
Die(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
DB_BUGFIX_Marker("GUS-317745_ForcePermaDefeatedMinscDeath");

//END_REGION GUS-317745

//REGION GUS-313987
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_Act3RomanceSceneEnded_d06b1484-55db-4a6b-988b-cbb26cb70c70)
AND
NOT DB_GlobalFlag((FLAG)ORI_Astarion_State_BecameVampireLord_c446ce94-efd8-45d5-b407-284177b6b57e)
THEN
SetFlag((FLAG)ORI_Astarion_State_NotVampireLordPostBlackMass_f9bde842-2fb6-4a95-9e64-4e5d214b0a13);
DB_BUGFIX_Marker("GUS-313987_SetFlagMarkNotVampireLord");

//END_REGION

//REGION GUS-313983
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_Players(_Player)
AND
GetFlag(ORI_Karlach_State_WentToDate_b30f31df-474f-15f3-9bfb-1fc2983c846a, _Player, 1)
THEN
DB_BUGFIX_Marker("GUS-313983_KarlachDate");
SetFlag(ORI_Karlach_State_SingingLuteDate_0e4020d6-f2de-4a4d-8e4d-bb38260ca6e4);
//END_REGION GUS-313983

//REGION GUS-318037
// prevent LOW_SWS_BasiliskGate civilians and flaming fist talking at the same time
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-318037");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-318037")
THEN
DB_LOW_SWS_BasiliskGate_CriminalCivilians((CHARACTER)S_LOW_SWS_BasiliskGate_Civilian_000_f2aaa9c2-3b19-422f-93ac-bbceeb8100d2);
DB_LOW_SWS_BasiliskGate_CriminalCivilians((CHARACTER)S_LOW_SWS_BasiliskGate_Civilian_002_2e746867-2f83-477a-b14e-24b84ecd480a);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-318037")
AND
QRY_LOW_SWS_BasiliskGate_CriminalCivilian_CheckCantTalk()
THEN
DB_BUGFIX_Marker("GUS-318037-B");
//END_REGION

//REGION GUS-317998
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-317998");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-317998")
THEN
PROC_GLO_Bugfix_317998_TryRemoveBond();

// If Dagger was teleported back to Orin's body due to it being picked up and thrown by a Cultist.
PROC
PROC_GLO_Bugfix_317998_TryRemoveBond() // remove the bond if Orin is already dead.
AND
DB_PermaDefeated(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101) // Orin was already killed
AND
HasActiveStatus(S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, "MAG_WEAPON_BOND", 1)
AND
NOT DB_Bugfix_317998_RemovingStatus(1)
THEN
RemoveStatus(S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, "MAG_WEAPON_BOND"); // remove Bond from Dagger regardless if its in Orin's inventory or on the ground
DB_Bugfix_317998_RemovingStatus(1);

// only once status is removed, we try to restore the dagger back near the altar.
IF
StatusRemoved(S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, "MAG_WEAPON_BOND", _, _)
AND
DB_Bugfix_317998_RemovingStatus(1)
THEN
PROC_GLO_Bugfix_317998_TryRestoreDagger();

// if the Ntherstone Dagger is still in Orin's inventory,
PROC
PROC_GLO_Bugfix_317998_TryRestoreDagger()
AND
IsInInventoryOf(S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, 1) // dagger is still in the inventory of Orin, most likely due to Bond returning it to her body after an NPC threw it.
THEN
TeleportTo((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, (TRIGGER)S_LOW_BhaalTemple_NonDuel_Orin_Pos_dd0e2e0f-a5ce-4dc4-a69d-15e8fa5df336); // move it onto the altar platform.
PROC_SetOnStage((ITEM)S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, 1); // need to put it on stage again, as it was most likely put offstage when it Bond-teleported to Orin when she was already offstaged.
//END_REGION

//REGION GUSX-1011
// Hooks up to GUS-317998 since it removes the MAG_WEAPON_BOND status there already.
// if the Netherstone Dagger is still in OrinDummy's inventory for some reason. Speculative fix as we can't repo how this could occur in the first place.
PROC
PROC_GLO_Bugfix_317998_TryRestoreDagger()
AND
IsInInventoryOf(S_GLO_Orin_Bhaalist_Dagger_Netherstone_7051fd5c-d777-457e-9aaf-e007b4cbbb55, S_GLO_BhaalTemple_OrinDummy_879a56ce-1e1c-4b2c-bac7-db7b3c6354ec, 1) // dagger is still in the inventory of OrinDummy. Speculative fix as we can't repo how this could occur in the first place.
THEN
DB_BUGFIX_Marker("GUSX-1011");
PROC_LOW_BhaalTemple_MoveDaggerToSafeLocation(); // moves the dagger to OrinCorpse or altar depending on if the corpse is in the chasm or not.
//END_REGION


//REGION GUS-318467
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_DangerZone((TRIGGER)S_LOW_BaldursMouth_BasementDangerZone_c4d8a700-b4ea-4603-8cef-c3ad07f350eb, "LOW_BaldursMouth_BasementDangerZone")
THEN
DB_BUGFIX_Marker("GUS-318467");
DB_DangerZone((TRIGGER)S_LOW_BaldursMouth_BasementDangerZone2_bdc07ceb-0983-4001-8fc7-1f6bc6ea4d84, "LOW_BaldursMouth_BasementDangerZone");
NOT DB_DangerZone((TRIGGER)S_LOW_BaldursMouth_BasementDangerZone_c4d8a700-b4ea-4603-8cef-c3ad07f350eb, "LOW_BaldursMouth_BasementDangerZone");

//END_REGION GUS-318467
//REGION GUS-316471
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-316471");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-316471")
THEN
DB_LOW_BloodMerchant_BarricadedDoors(S_LOW_BloodMerchant_Barricade_000_f211d987-614c-4511-b88b-9a70e88741cd, S_DOOR_BloodMerchantA_0d8cc61c-64ae-406d-a4d3-1553b6a1e1e5);
DB_LOW_BloodMerchant_BarricadedDoors(S_LOW_BloodMerchant_Barricade_001_0b35a759-2c9d-4540-a0df-2c10790bfb2b, S_Door_BloodmechantB_a2a9c95d-f1a0-4d7b-a4db-2b4811290c47);
//END_REGION GUS-316471


//REGION GUS-318884
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 6 Hotfix 4", "CTY_Main_A", "GUS-318884-OutcomeBroken");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-318884-OutcomeBroken")
AND
DB_LOW_SteelWatchFoundry_OutcomeExtra(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53)
AND
DB_PermaDefeated(S_LOW_GondianWoker_15_1eb9d68b-2d0d-4b62-ba8f-0d8b01f08b53)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Event_GnomesLeave_0b336df5-be7f-4f09-92f7-ea3f14076593)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_GainedGondianENDSupport_1bb09a8b-001d-4b43-9f39-ba89eb3aece9)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_SidedWithGondians_60345f15-6632-482e-ac4f-8a1b77d7fc36)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_Event_WulbrenCombat_b4d7b17e-3c19-3140-b91a-3eb0574e9f7d)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_SidedWithWulbren_044a290e-2835-44a8-ac0e-0a59da02a316)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_Outcome_MurderedGondians_22bc82fe-88f1-832f-14c0-cf3c937d0e83)
AND
NOT DB_GlobalFlag(LOW_SteelWatchFoundry_State_GainedIronhandENDSupport_a090a831-c695-4478-8d0d-84661deabb98)
AND
NOT DB_GlobalFlag(END_GatherYourAllies_State_WulbrenGaveIronhandSupport_dd929cfa-685e-41d6-8e04-be2f1a14da98)
THEN
DB_BUGFIX_Marker("GUS-318884-OutcomeBroken");
PROC_GUS31884_OverrideOutcomeDialogue();

PROC
PROC_GUS31884_OverrideOutcomeDialogue()
AND
DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player)
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren)
AND
DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango)
AND
DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus)
AND
DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra)
THEN
NOT DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player);
NOT DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren);
NOT DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango);
NOT DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus);
NOT DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra);

PROC
PROC_GUS31884_OverrideOutcomeDialogue()
AND
NOT DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
DB_BUGFIX_Marker("GUS-318884-RestartOutcome");
DB_GUS31884_NeedToOverrideDialogue(1);

PROC
PROC_GUS31884_OverrideOutcomeDialogue()
AND
DB_Defeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
THEN
DB_BUGFIX_Marker("GUS-318884-ClearOutcome");
PROC_GUS31884_ClearOffOutcome();

PROC
PROC_StateSet_PermaDefeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
DB_GUS31884_NeedToOverrideDialogue(1)
THEN
NOT DB_GUS31884_NeedToOverrideDialogue(1);
DB_BUGFIX_Marker("GUS-318884-ClearOutcome");
PROC_GUS31884_ClearOffOutcome();

QRY
QRY_SelectCustomDialog(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, _Player)
AND
DB_GUS31884_NeedToOverrideDialogue(1)
THEN
DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player);
PROC_GUS31884_StartOutcomeDialogue();

QRY
QRY_SelectCustomDialog(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, _Player)
AND
DB_GUS31884_NeedToOverrideDialogue(1)
THEN
DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player);
PROC_GUS31884_StartOutcomeDialogue();

PROC
PROC_GUS31884_StartOutcomeDialogue()
AND
QRY_LOW_SteelWatchFoundry_GetImportantGnomesForDialog()
AND
DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player)
AND
DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren)
AND
DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango)
AND
DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus)
AND
DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra)
AND
QRY_StartDialogCustom_Fixed((DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f, _Wulbren, _Fundango, _Barcus, _Extra, _Player, 0, 0, 0, 0)
THEN
NOT DB_GUS31884_NeedToOverrideDialogue(1);
NOT DB_LOW_SteelWatchFoundry_OutcomeDialogMainSpeaker(_Player);
NOT DB_LOW_SteelWatchFoundy_OutcomeWulbren(_Wulbren);
NOT DB_LOW_SteelWatchFoundry_OutcomeFundango(_Fundango);
NOT DB_LOW_SteelWatchFoundry_OutcomeBarcus(_Barcus);
NOT DB_LOW_SteelWatchFoundry_OutcomeExtra(_Extra);

PROC
PROC_GUS31884_ClearOffOutcome()
AND
NOT DB_Defeated(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
PROC_DisappearOutOfSight(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976, "Run", 0, "");

PROC
PROC_GUS31884_ClearOffOutcome()
AND
DB_Defeated(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
AND
DB_KnockedOut(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976)
THEN
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_FOR_UnfortunateGnome_6e45a00b-bad2-40bb-9403-147b9e92d976);

PROC
PROC_GUS31884_ClearOffOutcome()
AND
NOT DB_Defeated(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172)
THEN
PROC_DisappearOutOfSight(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172, "Run", 0, "");

PROC
PROC_GUS31884_ClearOffOutcome()
AND
DB_Defeated(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172)
AND
DB_KnockedOut(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172)
THEN
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_LOW_WulbrensGuard01_4f0fa9cc-a2d0-4450-a1d1-9cbfe521f172);

PROC
PROC_GUS31884_ClearOffOutcome()
AND
NOT DB_Defeated(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c)
THEN
PROC_DisappearOutOfSight(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c, "Run", 0, "");

PROC
PROC_GUS31884_ClearOffOutcome()
AND
DB_Defeated(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c)
AND
DB_KnockedOut(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c)
THEN
DB_ForceRemoveKnockedOutCharacterOnLongRest(S_LOW_WulbrensGuard02_fac964a4-f709-47a9-8a6e-7407a375316c);

//END_REGION

//REGION GUS-318888
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6 Hotfix 3", "CTY_Main_A", "GUS-318888");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-318888")
AND
DB_PartyMembers(_PartyMember)
AND
NOT IsInTrigger(_PartyMember, S_LOW_SteelWatchFoundry_LabFloor_SUB_65a2f1d8-f8f9-41ae-b9b6-e561b6069af9, 1)
AND
NOT IsInTrigger(_PartyMember, S_LOW_OutsideTresspassArea03_3d06883b-c7d2-492a-af68-50b2e4897095, 1)
THEN
CharacterStopCrime(_PartyMember, "LOW_SteelWatchFoundry_Trespass_Aggressive", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-318888")
AND
DB_PartOfTheTeam(_TeamMember)
AND
NOT DB_PartyMembers(_TeamMember)
AND
NOT IsInTrigger(_TeamMember, S_LOW_SteelWatchFoundry_LabFloor_SUB_65a2f1d8-f8f9-41ae-b9b6-e561b6069af9, 1)
AND
NOT IsInTrigger(_TeamMember, S_LOW_OutsideTresspassArea03_3d06883b-c7d2-492a-af68-50b2e4897095, 1)
THEN
CharacterStopCrime(_TeamMember, "LOW_SteelWatchFoundry_Trespass_Aggressive", NULL_00000000-0000-0000-0000-000000000000);

//Further patching needed for Patch 6 HF 4
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 6 Hotfix 4", "CTY_Main_A", "GUS-318888_HF4");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-318888_HF4")
AND
DB_PartyMembers(_PartyMember)
AND
NOT IsInTrigger(_PartyMember, S_LOW_SteelWatchFoundry_LabFloor_SUB_65a2f1d8-f8f9-41ae-b9b6-e561b6069af9, 1)
THEN
CharacterStopCrime(_PartyMember, "LOW_SteelWatchFoundry_Trespass_Aggressive", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-318888_HF4")
AND
DB_PartOfTheTeam(_TeamMember)
AND
NOT DB_PartyMembers(_TeamMember)
THEN
CharacterStopCrime(_TeamMember, "LOW_SteelWatchFoundry_Trespass_Aggressive", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-318888_HF4")
AND
DB_PlayerTrespassing(_Char, _CrimeId, S_LOW_OutsideTresspassArea03_3d06883b-c7d2-492a-af68-50b2e4897095)
THEN
NOT DB_PlayerTrespassing(_Char, _CrimeId, S_LOW_OutsideTresspassArea03_3d06883b-c7d2-492a-af68-50b2e4897095);
//END_REGION GUS-318888

//REGION GUSX-906

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
NOT DB_QuestIsOpened("LOW_BreakHagHex")
THEN
QuestClose("LOW_BreakHagHex");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
DB_QuestIsOpened("LOW_BreakHagHex")
AND
DB_GlobalFlag(LOW_HagSurvivors_State_KillHagQuestCompleted_300469ac-2022-4b4b-85f1-b611ba4abfee)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "LOW_BreakHagHex","HagPermaDefeated_MetSurvivors");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)LOW_BlushingMermaid_State_HagIsTrulyDead_c7c3e64d-dcfc-431b-a224-535a0c4a8e9c)
AND
DB_QuestIsOpened("LOW_BreakHagHex")
AND
NOT DB_GlobalFlag(LOW_HagSurvivors_State_KillHagQuestCompleted_300469ac-2022-4b4b-85f1-b611ba4abfee)
THEN
DB_QuestDef_State((FLAG)LOW_HagSurvivors_State_KillHagQuestCompleted_300469ac-2022-4b4b-85f1-b611ba4abfee,"LOW_BreakHagHex","HagPermaDefeated_MetSurvivors");

//END_REGION

//REGION GUS-257955
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-257955");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-257955")
AND
NOT DB_SceneManager(_, "LOW_Prison_VendorRat")
THEN
DB_SceneManager((CHARACTER)S_LOW_Prison_Rat01_7ec18c86-b069-4e60-82dd-61a0263d46f0, "LOW_Prison_VendorRat");
DB_BUGFIX_Marker("GUS-257955");
//END_REGION GUS-257955

//REGION GUS-319919

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUS-319919");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-319919")
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_HouseOfHope_HasMet_HopeAfterFight_fc49467e-d82e-a7e9-0b46-cd90f986141e, _Player, 1)
AND
QuestIsClosed("LOW_SaveHope", 0)
THEN
ClearFlag((FLAG)LOW_HouseOfHope_HasMet_HopeAfterFight_fc49467e-d82e-a7e9-0b46-cd90f986141e, _Player);
DB_BUGFIX_Marker("GUS-319919");

//END_REGION

//REGION GUS-317714
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)LOW_GurFollowUp_State_PeacefulResolution_260836ee-6f67-4ea4-9e2c-ccae94a75035)
AND
QRY_WYR_CazadorPalaceJournal_NoGurCazadorKilled()
THEN
QuestUpdate("WYR_CazadorPalace", "GurPeaceful_GurQuest");
DB_BUGFIX_Marker("GUS-317714-GurPeaceful_GurQuest");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)GLO_GurCamp_State_GurLeaderPermaDefeated_2dd63ae4-02c6-4360-8bdd-4d8d938a56e0)
AND
QRY_WYR_CazadorPalaceJournal_NoGurCazadorKilled()
THEN
QuestUpdate("WYR_CazadorPalace", "GurHostile_GurQuest");
DB_BUGFIX_Marker("GUS-317714-GurHostile_GurQuest");
//END_REGION GUS-317714

//REGION GUS-305807
PROC
PROC_ApplySavegamePatches()
AND
DB_GlobalFlag(LOW_SorcerousSundries_State_ProdigyHasStayedAtRamazith_524ab56a-8169-4926-9105-8bcaf8c87499)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUS-305807");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUS-305807")
THEN
ApplyStatus(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, "LOW_ROLAN_MASTER", -1.0, 0, NULL_00000000-0000-0000-0000-000000000000);
SetLevel(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b, 11);
//END_REGION GUS-305807

//REGION GUSX-7328
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
DB_OwnedCorpse(_Item, _Owner)
AND
IsItem(_Item, 1)
THEN
NOT DB_OwnedCorpse(_Item, _Owner);
DB_BUGFIX_Marker("GUSX-7328", _Item);
//END_REGION GUSX-7328

//REGION GUSX-7292
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_GlobalFlag((FLAG)WYR_GurCamp_State_GaveQuestToKillCazador_109ed582-3803-4e0d-9e4a-7440e4fe02d0)
AND
DB_GlobalFlag((FLAG)ORI_Astarion_State_CazadorPermaDefeated_5258c8d8-09a3-4343-bb6e-13ff5b8e3438)
AND
DB_GlobalFlag((FLAG)GLO_GurCamp_State_GurLeaderPermaDefeated_2dd63ae4-02c6-4360-8bdd-4d8d938a56e0)
AND
DB_QuestIsOpened("WYR_CazadorPalace")
THEN
QuestUpdate("WYR_CazadorPalace", "GurHostile_GurQuest");
//END_REGION GUSX-7292

//REGION GUSX-1330

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7","CTY_Main_A","GUSX-1330");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A","GUSX-1330")
AND
DB_LOW_MurderTribunal_Cultists((CHARACTER)_Cultist)
AND
NOT DB_PermaDefeated(_Cultist)
AND
HasActiveStatus(_Cultist,"LOW_SAREVOK_ESSENCE_CULTIST_GHOST",0)
THEN
ApplyStatus(_Cultist,"LOW_SAREVOK_ESSENCE_CULTIST_GHOST",-1.0,1,NULL_00000000-0000-0000-0000-000000000000);
DB_BUGFIX_Marker("GUSX-1330",_Cultist);

//END_REGION GUSX-1330


//REGION GUSX-862

PROC
PROC_ApplySavegamePatches()
THEN
DB_BUGFIX_GUSX_862(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "ORI_Astarion");
DB_BUGFIX_GUSX_862(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "GLO_ShadowHeart");
DB_BUGFIX_GUSX_862(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_Karlach_CampFix");
DB_BUGFIX_GUSX_862(S_Player_Laezel_58a69333-40bf-8358-1d17-fff240d7fb12, "ORI_Laezel");
DB_BUGFIX_GUSX_862(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale");
DB_BUGFIX_GUSX_862(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "ORI_Wyll");


PROC
PROC_ApplySavegamePatches()
AND
DB_BUGFIX_GUXS_862_Fixed(_Character)
THEN
NOT DB_BUGFIX_GUXS_862_Fixed(_Character);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_AnubisConfigs((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "GLO_Jaheira_Act3_2")
AND
GetAnubisConfig(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "")
AND
NOT DB_AnubisConfigsOverrideStack((CHARACTER)S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _, _)
THEN
DEV_EnableAnubis(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, "GLO_Jaheira_Act3_2");
DB_BUGFIX_Marker("GUSX-862", S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 1);
DB_BUGFIX_GUXS_862_Fixed(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

PROC
PROC_ApplySavegamePatches()
AND
DB_PartOfTheTeam(_Character)
AND
NOT DB_BUGFIX_GUXS_862_Fixed(_Character)
AND
GetAnubisConfig(_Character, "")
AND
NOT DB_AnubisConfigsOverrideStack(_Character, _, _)
AND
DB_AnubisConfigs(_Character, _IntendedConfig)
THEN
DEV_EnableAnubis(_Character, _IntendedConfig);
DB_BUGFIX_Marker("GUSX-862", _Character, 2);
DB_BUGFIX_GUXS_862_Fixed(_Character);

PROC
PROC_ApplySavegamePatches()
AND
DB_PartOfTheTeam(_Character)
AND
NOT DB_BUGFIX_GUXS_862_Fixed(_Character)
AND
GetAnubisConfig(_Character, "")
AND
NOT DB_AnubisConfigsOverrideStack(_Character, _, _)
AND
DB_CurrentLevel(_Level)
AND
DB_GLO_LevelTraveler(_Character, _Level, _IntendedConfig)
THEN
DEV_EnableAnubis(_Character, _IntendedConfig);
DB_BUGFIX_Marker("GUSX-862", _Character, 3);
DB_BUGFIX_GUXS_862_Fixed(_Character);


PROC
PROC_ApplySavegamePatches()
AND
DB_PartOfTheTeam(_Character)
AND
NOT DB_BUGFIX_GUXS_862_Fixed(_Character)
AND
GetAnubisConfig(_Character, "")
AND
DB_BUGFIX_GUSX_862(_Character, _IntendedConfig)
THEN
DEV_EnableAnubis(_Character, _IntendedConfig);
DB_BUGFIX_Marker("GUSX-862", _Character, 4);
DB_BUGFIX_GUXS_862_Fixed(_Character);

//END_REGION

//REGION GUSX-7378
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
THEN
DB_BUGFIX_Marker("GUSX-7378");
PROC_GUS314216_DoFix();
//END_REGION GUSX-7378

//REGION GUSX-1107
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 7", "CTY_Main_A", "GUSX-1107");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-1107")
AND
DB_State_Current(S_LOW_Dolor_55837c0f-0171-4020-a4a3-dd6de7ffc134, "LOW_Dolor", "Figaro")
AND
NOT DB_PermaDefeated(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81)
THEN
DB_BUGFIX_Marker("GUSX-1107");
PROC_ClearStoryMove(S_LOW_Devella_Fountainhead_048defbd-d386-4272-a5b7-40c1a9e75b81);
//END_REGION GUSX-1107

//REGION GUSX-703
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 7", "CTY_Main_A", "GUSX-703");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-703")
THEN
DB_LOW_SorcerousSundries_Client(S_LOW_Client_002_91a348f4-a6a4-423d-8f3c-c48ceeb7383d);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_001_9504e91f-b535-411b-ac3b-b4047150f93f);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_007_9e4e8404-4f2e-43ed-8bc5-f83c40127900);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_000_7d85aa52-0d27-4389-a5c9-9bc329fd7376);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_003_8d2f44b7-7fa1-4586-a2c8-c49f730a3f2b);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_005_bf5f19cd-638f-4011-ae3d-45007163c637);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_006_d3239308-d0d6-49dd-a3b9-39605f5b57e9);
DB_LOW_SorcerousSundries_Client(S_LOW_NecromancyBuyer_d33d47b9-299e-4be3-8867-eaf53b200b46);
DB_LOW_SorcerousSundries_Client(S_LOW_Client_004_e3fa81d4-53f3-49ad-8497-18673d399a37);

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-703")
AND
DB_LOW_SorcerousSundries_AllCombatantsDead(1)
THEN
SetFlag((FLAG)LOW_SorcerousSundries_State_ShopEmptied_afa22562-ce57-4377-a153-59d60674d997);
PROC_LOW_SorcerousSundries_PatronsFlee();

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-703")
AND
DB_LOW_SorcerousSundries_AllCombatantsDead(1)
AND
DB_LOW_SorcerousSundries_CurrentMainClerk(_Clerk)
THEN
PROC_NotifyWhenReadyToMoveOn(_Clerk,"LOW_SorcerousSundries_ReadyToDisappearProjection");

PROC
PROC_ReadyToMoveOn(_Clerk,"LOW_SorcerousSundries_ReadyToDisappearProjection")
THEN
PROC_SetOnStage(_Clerk,0);
//END_REGION GUSX-703

//REGION GUSX-7675

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-7675");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-7675")
AND
DB_GLO_EmperorPrelude_NetherStoneTrackers((ITEM)_Netherstone, _, _, _, _ItemAtCampFlag, _)
AND
NOT DB_GlobalFlag(_ItemAtCampFlag)
AND
GetInventoryOwner(_Netherstone,_CampChest)
AND
GetTemplate(_CampChest, _CampChestTemplate)
AND
DB_GLO_Tutorials_CampTravellerChestRoots((ITEMROOT)_CampChestTemplate)
THEN
PROC_GlobalSetFlagAndCache(_ItemAtCampFlag);
DB_BUGFIX_Marker("GUSX-7675",(GUIDSTRING)_Netherstone);

//END_REGION GUSX-7675

//REGION GUSX-967
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_FOR_CourierDog_ActiveScratch((CHARACTER)S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901)
AND
DB_Dialogs(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901,(DIALOGRESOURCE)CAMP_Courier_Dog_2f2ab0f4-9b0e-3991-b6dd-44474a25e7a3)
AND
GetHasOsirisDialog(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901,0)
THEN
SetHasDialog(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901,1);
DB_BUGFIX_Marker("GUSX-967");

//END_REGION GUSX-967

//REGION GUSX-7862
// Fix for some spawns losing "MONSTER" tag after being transformed into their shirtless version
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-7862");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-7862")
AND
DB_LOW_CazadorsPalace_RitualRoom_RitualParticipants(_Spawn)
AND
IsTagged(_Spawn, (TAG)MONSTER_90101158-141e-4896-8e60-f8db03f6dde3, 0)
THEN
SetTag(_Spawn, (TAG)MONSTER_90101158-141e-4896-8e60-f8db03f6dde3);
DB_BUGFIX_Marker("GUSX-7862", _Spawn);
//END_REGION GUSX-7675

//REGION GUSX-7721
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 8", "CTY_Main_A", "GUSX-7721");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-7721")
THEN
DB_DropMutingStatussesDialog(LOW_CountingHouse_Heist_63210311-4b3b-85e3-7278-2032e2a65bd7);

// Check if the cinematic that should always start did not start
PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-7721")
AND
DB_OnlyOnce("LOW_CountingHouse_StartHeistDialog")
AND
NOT DB_GlobalFlag(LOW_CountingHouse_State_RobbersEscaped_16197488-9cc2-48e2-94ae-36225025d4d8)
AND
NOT DB_DialogRequestCache_DialogInstance(LOW_CountingHouse_Heist_63210311-4b3b-85e3-7278-2032e2a65bd7, _)
THEN
SetFlag(LOW_CountingHouse_State_RobbersEscaped_16197488-9cc2-48e2-94ae-36225025d4d8);
PROC_SavegamePatch_GUSX7721_FixHeistDialogDidntStart();

// Minsc still alive in Counting House and not recruited -> reset Minsc
PROC
PROC_SavegamePatch_GUSX7721_FixHeistDialogDidntStart()
AND
NOT DB_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
NOT DB_PartOfTheTeam(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
DialogRequestStop(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
PROC_GlobalClearFlagAndCache((FLAG)LOW_MinscHideout_State_StoneLordDisabled_1a138353-72eb-4442-80bf-d99baf3daa5d);
PROC_GlobalClearFlagAndCache((FLAG)ORI_Minsc_State_SavedFromAbsolute_62e1d5ec-7c7e-70c2-68de-cadc7c7f5f20);
PROC_GlobalClearFlagAndCache((FLAG)ORI_Minsc_State_NotSavedFromAbsolute_c8fdabdd-a9fa-4dbb-b693-9c7b12e1f56b);
PROC_GlobalClearFlagAndCache((FLAG)ORI_Minsc_State_SavingBoo_c0bb9916-a2e0-416a-9117-1724bc5854c4);
PROC_GlobalClearFlagAndCache((FLAG)ORI_Minsc_State_KnockedOutOnce_036e01e6-181d-404b-8fb2-51f9f93ed666);
ClearFlag((FLAG)GLO_KnockedOut_Event_Wake_4095904d-ce99-1d77-7dfd-a77f04005032, S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
NOT DB_OnlyOnce("Minsc_StartSaveFromAbsoluteDialog");
DB_DontRemoveDialogsOnKnockedOut((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
DB_PreventKnockedOutPermaDefeated((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba);
DB_Dialogs((CHARACTER)S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba, LOW_Minsc_SaveFromAbsolute_eeb5d970-975f-5f16-80ba-4aa54cb65702);
PROC_LOW_CountingHouse_AfterHeistScene();
DB_BUGFIX_Marker("GUSX-7721-MinscAlive");

// Minsc recruited -> don't progress state, leave Minsc in party
PROC
PROC_SavegamePatch_GUSX7721_FixHeistDialogDidntStart()
AND
NOT DB_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
AND
DB_PartOfTheTeam(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_SceneOver("LOW_CountingHouse_HeistScene");
PROC_SetRelationMutual((FACTION)ACT3_LOW_CountingHouse_Robbers_b949b011-9fd1-4ed8-b7bf-223c88838327, (FACTION)ACT3_LOW_CountingHouse_Rakaths_d8c61e85-7473-4b87-9df0-e3c5785d894f, 0);
PROC_SetRelationToPlayers((FACTION)ACT3_LOW_CountingHouse_Robbers_b949b011-9fd1-4ed8-b7bf-223c88838327,0);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_CountingHouse_GreatDoor_QuestUpdate_Trigger_3388109d-41a3-4530-a847-0f6c1e5c7121);
DB_BUGFIX_Marker("GUSX-7721-MinscRecruited");

// Minsc permadefeated in Counting House -> leave Minsc dead but progress state
PROC
PROC_SavegamePatch_GUSX7721_FixHeistDialogDidntStart()
AND
DB_PermaDefeated(S_Player_Minsc_0de603c5-42e2-4811-9dad-f652de080eba)
THEN
PROC_LOW_CountingHouse_AfterHeistScene();
DB_BUGFIX_Marker("GUSX-7721-MinscPermaDefeated");
//END_REGION GUSX-7721

//REGION GUSX-7895
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
HasActiveStatus(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED", 1)
THEN
DB_GLO_BUGFIX_GUSX7895_AddCustomDefeatedState(1);

IF
LevelGameplayReady("CTY_Main_A", _)
AND
DB_GLO_BUGFIX_GUSX7895_AddCustomDefeatedState(1)
THEN
NOT DB_GLO_BUGFIX_GUSX7895_AddCustomDefeatedState(1);
DB_BUGFIX_Marker("GUSX-7895");
DB_CustomDefeatedState(S_Player_Astarion_c7c13742-bacd-460a-8f65-f864fe41f255, "LOW_CAZADORSPALACE_RITUAL_INCAPACITATED");
//END_REGION

//REGION GUSX-8556
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
NOT DB_PermaDefeated(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf)
AND
HasActiveStatus(S_GLO_Wulbren_2d70edbf-1a70-4047-8099-48f3e75d93bf, "PEACEFUL_RESOLUTION_XP", 1)
THEN
SetFlag(LOW_SteelWatchFoundry_State_Outcome_WulbrenLeft_498c6f1b-871e-4c2a-9c23-a85df85cfe5c);
DB_BUGFIX_Marker("GUSX-8556_FixJournal");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SavegameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("CTY_Main_A")
THEN
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_SteelWatchFoundry_Outcome_48c04ebf-a688-ab2c-da8d-e54d427a796f);
DB_BUGFIX_Marker("GUSX-8556_ForSafety");
//END_REGION GUSX-8556

//REGION GUSX-8880
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_Dead((CHARACTER)S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313)
AND
NOT DB_GlobalFlag((FLAG)ORI_Shadowheart_State_KilledViconia_472e18f2-15f9-4004-bdae-a9340fff7b15)
THEN
DB_BUGFIX_Marker("GUSX-8880-A");
PROC_GlobalSetFlagAndCache((FLAG)ORI_Shadowheart_State_KilledViconia_472e18f2-15f9-4004-bdae-a9340fff7b15);

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
DB_BUGFIX_Marker("GUSX-8880-B");
DB_PermaDefeatedEvent(S_LOW_Viconia_b1ea974d-96fb-47ca-b6d9-9c85fcb69313, (FLAG)ORI_Shadowheart_State_KilledViconia_472e18f2-15f9-4004-bdae-a9340fff7b15);
//END_REGION

//REGION GUSX-7513

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 8", "CTY_Main_A", "GUSX-7513");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-7513")
AND
IsInInventory(BOOK_UNI_LOW_HoH_TamingHope_PartTwo_001_d01d38aa-c775-8869-421d-e15e7304a631, 0)
THEN
PROC_SetOnStage(BOOK_UNI_LOW_HoH_TamingHope_PartTwo_001_d01d38aa-c775-8869-421d-e15e7304a631, 0);
DB_BUGFIX_Marker("GUSX-7513-WasntPickedUp");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-7513")
AND
IsInInventory(BOOK_UNI_LOW_HoH_TamingHope_PartTwo_001_d01d38aa-c775-8869-421d-e15e7304a631, 1)
AND
GetInventoryOwner(BOOK_UNI_LOW_HoH_TamingHope_PartTwo_001_d01d38aa-c775-8869-421d-e15e7304a631, _InventoryOwner)
THEN
TeleportTo(BOOK_UNI_LOW_HoH_TamingHope_PartTwo_001_d01d38aa-c775-8869-421d-e15e7304a631, _InventoryOwner);
PROC_SetOnStage(BOOK_UNI_LOW_HoH_TamingHope_PartTwo_001_d01d38aa-c775-8869-421d-e15e7304a631, 0);
ToInventory(BOOK_UNI_LOW_HoH_TamingHope_PartThree_000_577228f3-1ee6-8928-6f19-854d31731d60, _InventoryOwner, 1, 0);
DB_BUGFIX_Marker("GUSX-7513-WasPickedUp");

//END_REGION

//REGION GUSX-10305
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_CurrentLevel("CTY_Main_A")
AND
DB_GlobalFlag(LOW_HouseOfHope_Event_RaphaelAppeared_c25358e0-5ea1-929b-b511-6e745596d789)
AND
IsInTrigger(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213, 0)
THEN
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,
	(TRIGGER)S_LOW_HouseOfHope_OrthonPoint_a29bb35d-c5f3-404f-9a27-d75c67322bcb,
	(FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724);
DB_BUGFIX_Marker("GUSX-10305");

//END_REGION

//REGION GUSX-9248

// In the previous case that funeral could end (the dialogue doesn't really support it, it was always expected that it's either the end of the quest, or waveservants are hostile)

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_GlobalFlag((FLAG)LOW_WaterQueensHouse_State_FuneralEnded_cebde540-6e92-ea5d-2187-c40eb9f5f95f)
AND
DB_GlobalFlag((FLAG)LOW_Allandra_State_AcceptedQuest_d0f4ea27-21a9-b8e9-f799-de5de71d441e)
AND
NOT DB_PermaDefeated(S_LOW_AllandraGrey_32d78583-07c6-4160-9ec7-3a24b15149c8)
THEN
PROC_RemoveDBTrespassTrigger((TRIGGER)S_LOW_WaterQueensHouse_AllandraOffice_TrespassTrigger_aff0f58f-da00-42cf-b942-9aeed53d4e2b);
PROC_SpotPlayers_StopSpotting("LOW_GuardWaveservant_Spotted");
DB_BUGFIX_Marker("GUSX-9248");

//END_REGION

//REGION GUSX-10936
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 8", "CTY_Main_A", "GUSX-10936");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-10936")
AND
DB_GlobalFlag(LOW_Sewer_State_FireWizardPeace_dc00f52a-cbc2-c709-80a5-a291a97829da)
THEN
SetHasDialog(S_LOW_FireWizard_5a4f7f77-43c9-4f84-b3f4-4076d876ccde, 1);
//END_REGION GUSX-10936

//REGION GUSX-9906
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 7")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_OnlyOnce("LOW_VossSewers_SetupDragonborn")
AND
DB_Dialogs((CHARACTER)S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, (DIALOGRESOURCE)WYR_RaphaelTango_Voss_140953a8-5d79-c6d0-d691-52694b875bc2)
THEN
SetFaction(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, (FACTION)ACT3_LOW_VossSewers_030be19c-5505-4491-b0e4-4ed28357426d);
PROC_RemoveDialog(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea);
DB_Dialogs(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, LOW_VossSewers_6a70d80c-2c97-445b-4850-e6ac62c3b4bc);
DB_BUGFIX_Marker("GUSX-9906");
//END_REGION

//REGION GUSX-9144-ShadowheartParents

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 8", "CTY_Main_A", "GUSX-9144-ShadowheartParents");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-9144-ShadowheartParents")
AND
DB_LOW_SharGrotto_ShadowheartParents(_Parent, _, _, _)
THEN
SetFaction(_Parent, (FACTION)ACT3_LOW_ShadowheartParents_d1e07405-3878-4a83-b85d-6c7b4e46c86b);
DB_BUGFIX_Marker("GUSX-9144-ShadowheartParents");

//END_REGION

//REGION GUSX-9144
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 8", "CTY_Main_A", "GUSX-9144");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-9144")
AND
GetFaction(S_LOW_JaheirasHouse_Rat004_c9e8fe58-0c94-4c86-9854-23c90f56b92d, _Faction)
AND
_Faction != ACT3_LOW_JaheirasHouse_JaheirasFamily_2a1a2442-56e9-48a9-9b33-94f5857f7b09
THEN
SetFaction(S_LOW_JaheirasHouse_Rat004_c9e8fe58-0c94-4c86-9854-23c90f56b92d, (FACTION)ACT3_LOW_JaheirasHouse_JaheirasFamily_2a1a2442-56e9-48a9-9b33-94f5857f7b09);
DB_BUGFIX_Marker("GUSX-9144-RatFactionUpdate");
//END_REGION

//REGION GUSX-9124
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker("Release Patch 8", "CTY_Main_A", "GUSX-9124");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-9124")
AND
DB_PermaDefeated(S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b)
AND
QRY_QuestUpdateIsUnlockedForAny("SHA_Nightsong", "NightsongDefeated_LorroakanDefeated")
AND
QuestIsClosed("SHA_Nightsong",0)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_ProdigyHasStayedAtRamazith_524ab56a-8169-4926-9105-8bcaf8c87499)
THEN
TeleportTo(S_LOW_SorcerousSundries_KilledOffscreenRolanTrigger_cb007c54-43f5-48da-ba62-a762a33affe4,S_GLO_Prodigy_b6a3a9e9-b6eb-4c19-ab3f-4c431178fe1b);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_SorcerousSundries_KilledOffscreenRolanTrigger_cb007c54-43f5-48da-ba62-a762a33affe4);
DB_BUGFIX_Marker("GUSX-9124");
//END_REGION

//REGION GUSX-8040
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-8040");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-8040")
AND
NOT DB_GlobalFlag((FLAG)LOW_CountingHouse_State_PassedLobbyCheckpoint_085b0568-d4e7-72f4-9281-712589a0733c)
AND
NOT DB_TrespassTrigger((TRIGGER)S_LOW_CountingHouse_RestrictedAreaTrespass_Trigger_8d239901-9f60-46ca-8774-2aab55b715c3, (TRIGGER)S_LOW_CountingHouse_LobbyTrespassOutTrigger_1bca742f-67a0-445d-b88a-0bec24fcd24f,"LOW_CountingHouse_BankPass_Trespassing")
THEN
DB_TrespassTrigger((TRIGGER)S_LOW_CountingHouse_RestrictedAreaTrespass_Trigger_8d239901-9f60-46ca-8774-2aab55b715c3, (TRIGGER)S_LOW_CountingHouse_LobbyTrespassOutTrigger_1bca742f-67a0-445d-b88a-0bec24fcd24f,"LOW_CountingHouse_BankPass_Trespassing");
DB_BUGFIX_Marker("GUSX-8040-ReappliedTrespass");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-8040")
AND
DB_GlobalFlag((FLAG)LOW_OskarsBeloved_State_ArtistLeftHideout_76dca7be-5c6a-4444-afa4-3ae4b13d6315)
THEN
PROC_RemoveDBTrespassTrigger((TRIGGER)S_LOW_OskarsBeloved_UpperMansionTrespassArea_4c9a3444-39d0-4f73-a97c-d16f728d1e2a);
DB_BUGFIX_Marker("GUSX-8040-RemovedTrespass");

//END_REGION

//REGION GUSX-10220
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_SerialKiller_PlayerWarnCoraAboutPoison_8c1d6f61-b422-ef19-1707-a107515a7159, "Act3_Sage_AnsurDiscovered")
THEN
NOT DB_GLO_Backgrounds_ChainAfterGlobalFlagInDialog((FLAG)LOW_SerialKiller_PlayerWarnCoraAboutPoison_8c1d6f61-b422-ef19-1707-a107515a7159, "Act3_Sage_AnsurDiscovered");
DB_BUGFIX_Marker("GUSX-10220");
//END_REGION GUSX-10220

//REGION GUSX-8172
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_DoubtingArtist", "LootedTorch")
AND
QuestIsClosed("GLO_DoubtingArtist",0)
THEN
DB_OskarsBeloved_TorchInfoUpdates("TalkedToCarrion_MentionedTorch");
DB_OskarsBeloved_TorchInfoUpdates("ReadClientList");
DB_BUGFIX_Marker("GUSX-8172-AddedDBs");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
GetFlag((FLAG)LOW_FatherCarrion_State_WasAskedAboutOskar_9f6778f0-4cb2-4459-98a5-240241ea6b6e, S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e,1)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_DoubtingArtist", "TalkedToCarrion_MentionedTorch")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_DoubtingArtist", "TalkedToCarrion_NotKnowAboutTorch")
AND
QuestIsClosed("GLO_DoubtingArtist",0)
THEN
QuestUpdate("GLO_DoubtingArtist", "TalkedToCarrion_NotKnowAboutTorch");
DB_BUGFIX_Marker("GUSX-8172-TalkedToCarrionApplied");

PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("CTY_Main_A")
AND
QuestIsClosed("GLO_DoubtingArtist",0)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_PhilgravesMansion_State_HasTorch_963a8ced-1976-41fa-8994-c5b71330cc9b,_Player,1)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_DoubtingArtist", "LootedTorch")
AND
QRY_LOW_OskarsBeloved_KnowAboutTorch()
THEN
QuestUpdate("GLO_DoubtingArtist", "LootedTorch");
DB_BUGFIX_Marker("GUSX-8172-LootedTorchedBeApplied");

//END_REGION

//REGION GUSX-7226
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-7226");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-7226")
AND
DB_GlobalFlag((FLAG)LOW_FatherCarrion_State_IsIndebtedToPlayers_b2e22b4d-f88a-437a-b893-1f20e3e5ebf9)
AND
DB_GlobalFlag((FLAG)LOW_PhilgravesMansion_State_HeartInThrumbosInventory_46beba15-84e7-47ac-bc46-922cf0345b1a)
AND
IsInTrigger(S_LOW_Thrumbo_c20c1d4e-eea9-473b-b26e-abe5973ba0eb,(TRIGGER)S_LOW_PhilgravesMansion_MainHallTrigger_97b50e48-fc3e-435c-a3ba-2745eb733f2e,1)
AND
NOT DB_Dead(S_LOW_FatherCarrion_b003409c-364f-4065-94bf-7436001d890e)
AND
NOT DB_Destroyed((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492)
THEN
PROC_PhilgravesMansion_SendJarToBasement((ITEM)S_LOW_UNI_CarrionJar_Heart_13d8bafe-6614-4ae8-be27-2e1e1d294492);
DB_BUGFIX_Marker("GUSX-7226");
//END_REGION

//REGION GUSX-7226
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelUnreachable("INT_Main_A")
AND
NOT DB_LevelUnreachable("CTY_Main_A")
AND
DB_Camp_PreCampFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT2_SCE_EpilogueFaction_9c896609-f2f6-4f1a-8967-c83140977975)
THEN
NOT DB_Camp_PreCampFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT2_SCE_EpilogueFaction_9c896609-f2f6-4f1a-8967-c83140977975);
DB_Camp_PreCampFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4);
DB_BUGFIX_Marker("GUSX-7226-UpdatedPreCamp");

PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-7226");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-7226")
AND
GetFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT2_SCE_EpilogueFaction_9c896609-f2f6-4f1a-8967-c83140977975)
THEN
SetFaction((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FACTION)ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4);
DB_BUGFIX_Marker("GUSX-7226");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-7226")
AND
IsInTrigger((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(TRIGGER)S_LOW_SorcerousSundries_RamazithOwnershipTrigger_af5a1002-68b2-4b3e-8399-e077af9f1dd5,1)
AND
NOT DB_OnlyOnce("LOW_SorcerousSundries_Conclude")
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_PlayersSideWithNightsong_992ec758-9536-40ce-9a45-72193c81ec1b)
AND
IsInCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,0)
AND
DB_PermaDefeated(S_LOW_Lorroakan_a9d4b71d-b0ef-429e-8210-6dc8be986ee9)
THEN
PROC_LOW_SorcerousSundries_SetupConclusion(NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION GUSX-3719
PROC
PROC_ApplySavegamePatches()
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-3719");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-3719")
AND
DB_LOW_DevilsFee_CellarUnlocked(1)
AND
GetRotation(S_LOW_DevilsFee_CellarLockBust_11221eb7-0681-4a8b-99fb-dd63e544573b, _X, _Y, _Z)
THEN
ItemRotateYToAngle(S_LOW_DevilsFee_Cellar_Bust_92e9d1a9-189b-42f7-9025-ba88f889eab7, _Y, 90.0);
PROC_SetOnStage(S_LOW_DevilsFee_CellarLockBust_11221eb7-0681-4a8b-99fb-dd63e544573b, 0);
DB_BUGFIX_Marker("GUSX-3719");
//END_REGION GUSX-3719

//REGION GUSX-8203
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_LevelLoadedOnce("INT_Main_A")
AND
CanTrade(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 1)
THEN
SetCanTrade(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, 0);
DB_BUGFIX_Marker("GUSX-8203-RemoveJaheiraTrade");

//END_REGION GUSX-8203

//REGION GUSX-2099
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
NOT DB_GlobalFlag(LOW_MurderTribunal_Knows_WordOfPassage_839150e6-d168-4c89-a980-68b9e9f60556)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "LOW_FindBhaalTemple", "MurderTribunal_KillTwoVictims", 1)
AND
QRY_OnlyOnce("GUSX-2099")
THEN
QuestUpdateRevert(_Player, "LOW_FindBhaalTemple", "MurderTribunal_KillTwoVictims");
DB_BUGFIX_Marker("GUSX-2099");
//END_REGION GUSX-2099

//REGION GUSX-2062
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-2062");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-2062")
THEN
PROC_SetRelationMutual(GLO_SteelWatcher_BrainControlled_f0bb90ec-b609-4864-9716-0ad5d7222689, ACT3_LOW_BaldursMouth_Security_1c0ff36f-78a7-4c16-b624-70cb8e18f346, 100);
DB_BUGFIX_Marker("GUSX-2062");

//END_REGION

//REGION GUSX-6747
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
NOT DB_GlobalFlag((FLAG)PLA_ZhentShipment_State_ChestSentAway_5d9f274d-a38b-4d81-bc9f-bc8c1fcb59ca)
AND
GetFlag((FLAG)PLA_ZhentShipment_State_HadShipment_3bb17316-cbb3-4e73-95d8-04b826a5cecd, S_LOW_Guildhall_Zhent_Mercenary_001_5ac9c7ec-d26f-404e-bd17-e9d3dad000c4, 1)
THEN
QuestUpdate("HIDDEN_CTY_Boosters", "LOW_Guildhall_DeliveredZhentShipment");
DB_BUGFIX_Marker("GUS-304501");
//END_REGION GUSX-6747

//REGION GUSX-12210
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-12210");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-12210")
AND
DB_GlobalFlag((FLAG)ORI_Laezel_State_VossWaitingForHammerInSewers_47b30289-c885-46a9-ab6e-82b5460c161d)
AND
IsOnStage(S_LOW_VossDragonborn_7952187b-7636-418f-884c-adfdd33fda8b, 1)
AND
IsOnStage(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea, 0)
AND
NOT DB_PermaDefeated(S_LOW_VossDragonborn_7952187b-7636-418f-884c-adfdd33fda8b)
AND
NOT DB_PermaDefeated(S_GLO_GithKnight_2adce2df-0799-49dc-b867-ba7ca21e9aea)
THEN
PROC_LOW_VossSewers_SetupVoss();
DB_BUGFIX_Marker("GUSX-12210");
//END_REGION GUSX-12210

//REGION GUSX-6534
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_GlobalFlag((FLAG)LOW_WindmillMindflayeFollowup_Event_MetLOWFamily_7bc6936a-eb73-742e-f9cd-80660cb12f9c)
AND
DB_Players(_Player)
THEN
SetFlag(LOW_WindmillMindflayeFollowup_Event_PlayerMetLOWFamily_b561aad0-d0f1-4b8c-b275-059d056fd3d2, _Player);
DB_BUGFIX_Marker("GUSX-6534");
//END_REGION GUSX-6534

//REGION GUSX-8382
PROC
PROC_ApplySavegamePatches()
AND
NOT DB_LevelUnreachable("CTY_Main_A")
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-8382");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-8382")
AND
IsInTrigger(S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd, (TRIGGER)S_LOW_OskarsBeloved_ConclusionSpotTrigger_fb48ce73-fad6-4df8-9204-14ea37c75cf5,1)
AND
DB_OnlyOnce("LOW_OskarsBeloved_HandleOskarDiabled")
AND
NOT DB_OnlyOnce("LOW_OskarsBeloved_FreeKerri")
AND
NOT DB_Dead((CHARACTER)S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd)
AND
QRY_GUSX_8382_CheckOskarWrongStatuses()
THEN
ApplyStatus(S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd,"KNOCKED_OUT",-1.0);
ApplyStatus(S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd,"KNOCKED_OUT_PERMANENTLY",-1.0);
DB_BUGFIX_Marker("GUSX-8382");

QRY
QRY_GUSX_8382_CheckOskarWrongStatuses()
AND
HasActiveStatus(S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd,"KNOCKED_OUT",0)
THEN
DB_NOOP(1);

QRY
QRY_GUSX_8382_CheckOskarWrongStatuses()
AND
HasActiveStatus(S_GLO_DoubtingArtist_3ae152be-8ff6-420c-81a0-68d6a55cd5bd,"KNOCKED_OUT_TEMPORARILY",1)
THEN
DB_NOOP(1);

//END_REGION GUSX-8382

//REGION GUSX-12566
PROC
PROC_ApplySavegamePatches()
THEN
PROC_CheckShouldSavegamePatchInLevel("Release Patch 8", "CTY_Main_A", "GUSX-12566");

PROC
PROC_ApplySavegamePatchInLevel("CTY_Main_A", "GUSX-12566")
AND
QRY_GUSX_12566_IsRogerOutWineFestivalIfCoraDies()
THEN
DB_BUGFIX_Marker("GUSX-12566");
TeleportTo(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, S_LOW_SerialKiller_RogerToFestival_e9581a27-db04-4ceb-9060-72d1867210e2);


QRY
QRY_GUSX_12566_IsRogerOutWineFestivalIfCoraDies()
AND
DB_PermaDefeated(S_LOW_CoraHighberry_8a520cf7-c5da-419f-bdd4-792b27c5c679)
AND
IsInTrigger(S_LOW_RogerHighberry_09559a52-5b22-42aa-abfa-04098ecae404, S_LOW_SerialKiller_VisitWineFestival_f5419edc-b46c-4f87-9853-eaf67eaefa23, 0)//Character could be anywhere if players move the corpse around the map.
THEN
DB_NOOP(1);
//END_REGION GUSX-12566

//REGION GUSX-9352
PROC
PROC_ApplySavegamePatches()
AND
QRY_BG3_SaveGameIsOlderThan("Release Patch 8")
AND
DB_QuestIsOpened("GLO_DoubtingArtist")
AND
DB_GlobalFlag((FLAG)LOW_Oskar_State_Leaving_da5734d2-74ad-4e35-92e6-d477ece23571)
THEN
QuestClose("GLO_DoubtingArtist");
DB_BUGFIX_Marker("GUSX-9352");
//END_REGION GUSX-9352


EXITSECTION

ENDEXITSECTION
ParentTargetEdge "__Start"
