Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_BG3_Released_Versions("Release Hotfix 1",4,0,100,0);
DB_BG3_Released_Versions("Release Hotfix 2",4,0,200,0);
DB_BG3_Released_Versions("Release Hotfix 3",4,0,300,0);
DB_BG3_Released_Versions("Release Hotfix 4",4,0,400,0);
DB_BG3_Released_Versions("Release Patch 1",4,1,0,0);
DB_BG3_Released_Versions("Release Patch 2",4,2,0,0); // Internal version, not released
DB_BG3_Released_Versions("Release Patch 2 Rev 1",4,2,1,0);
DB_BG3_Released_Versions("Release Patch 2 Rev 2",4,2,2,0);
DB_BG3_Released_Versions("Release Patch 2 Rev 3",4,2,3,0);
DB_BG3_Released_Versions("Release Patch 2 Rev 4",4,2,4,0);
DB_BG3_Released_Versions("Release Patch 2 Hotfix 1",4,2,100,0);
DB_BG3_Released_Versions("Release Patch 2 Hotfix 3",4,2,300,0);
DB_BG3_Released_Versions("Release Patch 3",4,3,0,0);
DB_BG3_Released_Versions("Release Patch 3 Hotfix 1",4,3,100,0);
DB_BG3_Released_Versions("Release Patch 3 Hotfix 2",4,3,200,0);
DB_BG3_Released_Versions("Release Patch 3 Hotfix 3",4,3,300,0);
DB_BG3_Released_Versions("Release Patch 4",4,4,0,0);
DB_BG3_Released_Versions("Release Patch 4 Hotfix 1",4,4,100,0);
DB_BG3_Released_Versions("Release Patch 4 Hotfix 2",4,4,200,0);
DB_BG3_Released_Versions("Release Patch 4 Hotfix 3",4,4,300,0);
DB_BG3_Released_Versions("Release Patch 5",4,5,0,0);
DB_BG3_Released_Versions("Release Patch 5 Hotfix 1",4,5,100,0);
DB_BG3_Released_Versions("Release Patch 5 Hotfix 2",4,5,200,0);
DB_BG3_Released_Versions("Release Patch 5 Hotfix 3",4,5,300,0);
DB_BG3_Released_Versions("Release Patch 5 Hotfix 4",4,5,400,0);
DB_BG3_Released_Versions("Release Patch 5 Hotfix 5",4,5,500,0);
DB_BG3_Released_Versions("Release Patch 5 Hotfix 6",4,5,600,0);
DB_BG3_Released_Versions("Release Patch 6",4,6,0,0);
DB_BG3_Released_Versions("Release Patch 6 Hotfix 1",4,6,100,0); //released as hotfix2 because of emergency fixes
DB_BG3_Released_Versions("Release Patch 6 Hotfix 3",4,6,300,0); 
DB_BG3_Released_Versions("Release Patch 6 Hotfix 4",4,6,400,0);
DB_BG3_Released_Versions("Release Patch 6 Hotfix 5",4,6,500,0);
DB_BG3_Released_Versions("Release Patch 6 Hotfix 7",4,6,700,0);
DB_BG3_Released_Versions("Release Patch 6 Hotfix 8",4,6,800,0);
DB_BG3_Released_Versions("Release Patch 6 Hotfix 9",4,6,900,0);
DB_BG3_Released_Versions("Release Patch 7",4,7,0,0);
DB_BG3_Released_Versions("Release Patch 7 Beta Hotfix 2",4,7,20,0);
DB_BG3_Released_Versions("Release Patch 7 Beta Hotfix 3",4,7,30,0);
DB_BG3_Released_Versions("Release Patch 7 Hotfix 2",4,7,200,0);
DB_BG3_Released_Versions("Release Patch 8",4,8,0,0);
DB_BG3_Released_Versions("Release Patch 8 Beta Hotfix 1",4,8,10,0);
DB_BG3_Released_Versions("Release Patch 8 Beta Hotfix 2",4,8,30,0);
KBSECTION
//REGION savegame patch helpers
IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,16,0)
THEN
DB_BG3_Released_Versions("Release Hotfix 1",4,0,100,0);
DB_BG3_Released_Versions("Release Hotfix 2",4,0,200,0);
DB_BG3_Released_Versions("Release Patch 1",4,1,0,0);
DB_BG3_Released_Versions("Release Patch 2",4,2,0,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,300,0)
THEN
DB_BG3_Released_Versions("Release Hotfix 3",4,0,300,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,0,400,0)
THEN
DB_BG3_Released_Versions("Release Hotfix 4",4,0,400,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,2,1,0)
THEN
DB_BG3_Released_Versions("Release Patch 2 Rev 1",4,2,1,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,2,2,0)
THEN
DB_BG3_Released_Versions("Release Patch 2 Rev 2",4,2,2,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,2,3,0)
THEN
NOT DB_BG3_Released_Versions("Release Patch 2 Rev 1",4,2,2,0);
DB_BG3_Released_Versions("Release Patch 2 Rev 2",4,2,2,0);
DB_BG3_Released_Versions("Release Patch 2 Rev 3",4,2,3,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,2,4,0)
THEN
DB_BG3_Released_Versions("Release Patch 2 Rev 4",4,2,4,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,2,100,0)
THEN
DB_BG3_Released_Versions("Release Patch 2 Hotfix 1",4,2,100,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,2,300,0)
THEN
DB_BG3_Released_Versions("Release Patch 2 Hotfix 3",4,2,300,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,3,0,0)
THEN
DB_BG3_Released_Versions("Release Patch 3",4,3,0,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,3,100,0)
THEN
DB_BG3_Released_Versions("Release Patch 3 Hotfix 1",4,3,100,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,3,200,0)
THEN
DB_BG3_Released_Versions("Release Patch 3 Hotfix 2",4,3,200,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,3,300,0)
THEN
DB_BG3_Released_Versions("Release Patch 3 Hotfix 3",4,3,300,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,4,0,0)
THEN
DB_BG3_Released_Versions("Release Patch 4",4,4,0,0);
DB_BG3_Released_Versions("Release Patch 4 Hotfix 1",4,4,100,0);
DB_BG3_Released_Versions("Release Patch 4 Hotfix 2",4,4,200,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,4,300,0)
THEN
DB_BG3_Released_Versions("Release Patch 4 Hotfix 3",4,4,300,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,5,0,0)
THEN
DB_BG3_Released_Versions("Release Patch 5",4,5,0,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,5,100,0)
THEN
DB_BG3_Released_Versions("Release Patch 5 Hotfix 1",4,5,100,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,5,200,0)
THEN
DB_BG3_Released_Versions("Release Patch 5 Hotfix 2",4,5,200,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,5,300,0)
THEN
DB_BG3_Released_Versions("Release Patch 5 Hotfix 3",4,5,300,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,5,400,0)
THEN
DB_BG3_Released_Versions("Release Patch 5 Hotfix 4",4,5,400,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,5,500,0)
THEN
DB_BG3_Released_Versions("Release Patch 5 Hotfix 5",4,5,500,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,5,600,0)
THEN
DB_BG3_Released_Versions("Release Patch 5 Hotfix 6",4,5,600,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,6,0,0)
THEN
DB_BG3_Released_Versions("Release Patch 6",4,6,0,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,6,100,0)
THEN
DB_BG3_Released_Versions("Release Patch 6 Hotfix 1",4,6,100,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,6,300,0)
THEN
DB_BG3_Released_Versions("Release Patch 6 Hotfix 3",4,6,300,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,6,400,0)
THEN
DB_BG3_Released_Versions("Release Patch 6 Hotfix 4",4,6,400,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,6,500,0)
THEN
DB_BG3_Released_Versions("Release Patch 6 Hotfix 5",4,6,500,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,6,700,0)
THEN
DB_BG3_Released_Versions("Release Patch 6 Hotfix 7",4,6,700,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,6,800,0)
THEN
DB_BG3_Released_Versions("Release Patch 6 Hotfix 8",4,6,800,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,6,900,0)
THEN
DB_BG3_Released_Versions("Release Patch 6 Hotfix 9",4,6,900,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,7,0,0)
THEN
DB_BG3_Released_Versions("Release Patch 7",4,7,0,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,7,20,0)
THEN
DB_BG3_Released_Versions("Release Patch 7 Beta Hotfix 2",4,7,20,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,7,30,0)
THEN
DB_BG3_Released_Versions("Release Patch 7 Beta Hotfix 3",4,7,30,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,7,200,0)
THEN
DB_BG3_Released_Versions("Release Patch 7 Hotfix 2",4,7,200,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,8,0,0)
THEN
DB_BG3_Released_Versions("Release Patch 8",4,8,0,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,8,10,0)
THEN
DB_BG3_Released_Versions("Release Patch 8 Beta Hotfix 1",4,8,10,0);


IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,8,20,0)
THEN
DB_BG3_Released_Versions("Release Patch 8 Beta Hotfix 2",4,8,20,0);

IF
SavegameLoaded()
AND
QRY_BG3_SaveGameIsOlderThan(4,8,30,0)
THEN
DB_BG3_Released_Versions("Release Patch 8 Beta Hotfix 3",4,8,30,0);

//END_REGION


IF
GameModeStarted(_,0,0)
THEN
PROC_BG3_StoreCurrentVersion();

IF
SavegameLoadStarted()
THEN
PROC_BG3_StoreCurrentVersion();

PROC
PROC_BG3_StoreCurrentVersion()
AND
GetModuleVersion("GustavX",_Major,_Minor,_Revision,_Build)
THEN
DB_BG3Version_Trace(_Major,_Minor,_Revision,_Build);	//log all versions we encounter
SysClear("DB_BG3Version",4);
DB_BG3Version(_Major,_Minor,_Revision,_Build);

IF
ModuleLoadedinSavegame("GustavDev",_Major,_Minor,_Revision,_Build)
AND
// In case this arrives after getting the event for GustavX
QRY_BG3_SavegameUndefinedOrIsOlderThan(_Major,_Minor,_Revision,_Build)
THEN
SysClear("DB_BG3Version_Savegame",4);
DB_BG3Version_Savegame(_Major,_Minor,_Revision,_Build);

IF
ModuleLoadedinSavegame("GustavX",_Major,_Minor,_Revision,_Build)
AND
// In case this is a savegame that was saved with the GustavX mod 1.0.0.0 version,
// and the GustavDev loaded event arrived earlier
QRY_BG3_SavegameUndefinedOrIsOlderThan(_Major,_Minor,_Revision,_Build)
THEN
SysClear("DB_BG3Version_Savegame",4);
DB_BG3Version_Savegame(_Major,_Minor,_Revision,_Build);

IF
SavegameLoaded()
THEN
DB_BG3_PatchingSavegame(1);
PROC_ApplySavegamePatches();
NOT DB_BG3_PatchingSavegame(1);

PROC
PROC_ApplySavegamePatches()
THEN
DB_NOOP(1);

//REGION Version queries

QRY
QRY_BG3_SaveGameIsOlderThan((STRING)_Version)
AND
DB_BG3_Released_Versions(_Version,_Major,_Minor,_Revision,_Build)
AND
QRY_BG3_SaveGameIsOlderThan(_Major,_Minor,_Revision,_Build)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SavegameUndefinedOrIsOlderThan((INTEGER)_CompMajor,(INTEGER)_CompMinor,(INTEGER)_CompRev,(INTEGER)_CompBuild)
AND
QRY_BG3_SavegameIsOlderThan(_CompMajor,_CompMinor,_CompRev,_CompBuild)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SavegameUndefinedOrIsOlderThan((INTEGER)_CompMajor,(INTEGER)_CompMinor,(INTEGER)_CompRev,(INTEGER)_CompBuild)
AND
NOT DB_BG3Version_Savegame(_,_,_,_)
THEN
DB_NOOP(1);

QRY
QRY_BG3_SavegameIsOlderThan((INTEGER)_CompMajor,(INTEGER)_CompMinor,(INTEGER)_CompRev,(INTEGER)_CompBuild)
AND
DB_BG3Version_Savegame(_Major,_Minor,_Revision,_Build)
AND
QRY_VersionIsOlderThan(_Major,_Minor,_Revision,_Build,_CompMajor,_CompMinor,_CompRev,_CompBuild)
THEN
DB_NOOP(1);

//END_REGION

//REGION misc helpers

QRY
QRY_BG3_IsPatchingSavegame()
AND
DB_BG3_PatchingSavegame(1)
THEN
DB_NOOP(1);

PROC
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker((INTEGER)_Major,(INTEGER)_Minor,(INTEGER)_Rev,(INTEGER)_Build,(STRING)_Level,(STRING)_Identifier)
AND
QRY_BG3_SavegameIsOlderThan((INTEGER)_Major,(INTEGER)_Minor,(INTEGER)_Rev,(INTEGER)_Build)
AND
DB_LevelLoadedOnce(_Level)
AND
NOT DB_LevelUnreachable(_Level)
THEN
DB_ApplySavegamePatchInLevel(_Level,_Identifier);

PROC
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker((STRING)_PatchVersion,(STRING)_Level,(STRING)_Identifier)
AND
DB_BG3_Released_Versions(_PatchVersion,_Major,_Minor,_Rev,_Build)
THEN
PROC_CheckShouldSavegamePatchInLevel_SetBugfixMarker((INTEGER)_Major,(INTEGER)_Minor,(INTEGER)_Rev,(INTEGER)_Build,(STRING)_Level,(STRING)_Identifier);

PROC
PROC_CheckShouldSavegamePatchInLevel((INTEGER)_Major,(INTEGER)_Minor,(INTEGER)_Rev,(INTEGER)_Build,(STRING)_Level,(STRING)_Identifier)
AND
QRY_BG3_SavegameIsOlderThan((INTEGER)_Major,(INTEGER)_Minor,(INTEGER)_Rev,(INTEGER)_Build)
AND
DB_LevelLoadedOnce(_Level)
AND
NOT DB_LevelUnreachable(_Level)
THEN
DB_ApplySavegamePatchInLevel_ManualBugfixMarker(_Level,_Identifier);

PROC
PROC_CheckShouldSavegamePatchInLevel((STRING)_PatchVersion,(STRING)_Level,(STRING)_Identifier)
AND
DB_BG3_Released_Versions(_PatchVersion,_Major,_Minor,_Rev,_Build)
THEN
PROC_CheckShouldSavegamePatchInLevel((INTEGER)_Major,(INTEGER)_Minor,(INTEGER)_Rev,(INTEGER)_Build,(STRING)_Level,(STRING)_Identifier);

IF
DB_CurrentLevel((STRING)_Level)
AND
DB_ApplySavegamePatchInLevel((STRING)_Level,(STRING)_Identifier)
THEN
PROC_ApplySavegamePatchInLevel((STRING)_Level,(STRING)_Identifier);
DB_BUGFIX_Marker(_Identifier);
NOT DB_ApplySavegamePatchInLevel((STRING)_Level,(STRING)_Identifier);

IF
DB_LevelUnreachable((STRING)_Level)
AND
DB_ApplySavegamePatchInLevel((STRING)_Level,(STRING)_Identifier)
THEN
NOT DB_ApplySavegamePatchInLevel((STRING)_Level,(STRING)_Identifier);

IF
DB_CurrentLevel((STRING)_Level)
AND
DB_ApplySavegamePatchInLevel_ManualBugfixMarker((STRING)_Level,(STRING)_Identifier)
THEN
PROC_ApplySavegamePatchInLevel((STRING)_Level,(STRING)_Identifier);
NOT DB_ApplySavegamePatchInLevel_ManualBugfixMarker((STRING)_Level,(STRING)_Identifier);

IF
DB_LevelUnreachable((STRING)_Level)
AND
DB_ApplySavegamePatchInLevel_ManualBugfixMarker((STRING)_Level,(STRING)_Identifier)
THEN
NOT DB_ApplySavegamePatchInLevel_ManualBugfixMarker((STRING)_Level,(STRING)_Identifier);

PROC
PROC_ApplySavegamePatchInLevel((STRING)_Level,(STRING)_Identifier)
THEN
DB_NOOP(1);

QRY
QRY_ShouldSavegamePatchInLevel((INTEGER)_Major,(INTEGER)_Minor,(INTEGER)_Rev,(INTEGER)_Build,(STRING)_Level)
AND
QRY_BG3_SavegameIsOlderThan((INTEGER)_Major,(INTEGER)_Minor,(INTEGER)_Rev,(INTEGER)_Build)
AND
DB_LevelLoadedOnce(_Level)
AND
NOT DB_LevelUnreachable(_Level)
THEN
DB_NOOP(1);

QRY
QRY_ShouldSavegamePatchInLevel((STRING)_PatchVersion,(STRING)_Level)
AND
DB_BG3_Released_Versions(_PatchVersion,_Major,_Minor,_Rev,_Build)
AND
QRY_ShouldSavegamePatchInLevel((INTEGER)_Major,(INTEGER)_Minor,(INTEGER)_Rev,(INTEGER)_Build,(STRING)_Level)
THEN
DB_NOOP(1);
//END_REGION

EXITSECTION

ENDEXITSECTION
