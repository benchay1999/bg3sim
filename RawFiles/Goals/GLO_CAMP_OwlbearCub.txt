Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_OriginInPartyDialog((CHARACTER)S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,(DIALOGRESOURCE)CAMP_OwlbearCub_b040f859-255a-f8aa-fba7-3e31a1b8c641);

//REGION Camp Night Definitions - Owlbear Cub
// 1st camp night encounter
DB_CampNight((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,1040);
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"WLDBAS");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"CREMAIN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"CREINSIDE");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"SHARTEMPLE");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,"MOONRISE");
DB_CampNight_Requirement((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,(FLAG)GOB_ChickenChase_State_OwlbearAcquired_da704027-02ea-717c-4390-f538e5e5cd7a);
DB_CampNight_SCO((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,(DIALOGRESOURCE)CAMP_OwlbearCub_CRD_1_b8d1c425-089c-d04d-b63f-40cc99b1c747);
DB_CampNight_CancelledBy((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,(FLAG)GLO_OwlbearCub_State_PermaDefeated_e407829a-d8ff-4759-9dbc-89f2b2f33151);

// 2nd camp night encounter, after this one the owlbear may stay in the camp as a camper
DB_CampNight((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,1030);
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"WLDBAS");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"CREMAIN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"CREINSIDE");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"SHARTEMPLE");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,"MOONRISE");
DB_CampNight_Requirement((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,(FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4);
DB_CampNight_SCO((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,(DIALOGRESOURCE)CAMP_OwlbearCub_CRD_2_aaccfa43-76c2-b9b2-1415-1377def80251);
DB_CampNight_CancelledBy((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,(FLAG)CAMP_OwlbearCub_Event_Fight_036f6f5f-b2a2-52b1-8229-e5ce6da0c676);
DB_CampNight_CancelledBy((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,(FLAG)GLO_OwlbearCub_State_PermaDefeated_e407829a-d8ff-4759-9dbc-89f2b2f33151);

// Final owlbear cub night that involves Scratch
DB_CampNight((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,1010);
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"WLDMAIN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"WLDDUNABB");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"WLDBAS");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"WLDCAVGRN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"WLDDUNSHA");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"WLDCAVSND");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"WLDUND");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"CREMAIN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"CREINSIDE");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"SCLMAIN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"HAVEN");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"SHARTEMPLE");
DB_CampNight_Camp((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,"MOONRISE");
DB_CampNight_Requirement((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,(FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,(FLAG)COURIERDOG_9a7eacd5-a43f-4258-a07f-d55725fa20f2,(FLAG)CAMP_OwlbearCub_State_BecameCampFollower_a9742288-21b5-428a-9efa-a2e73981c02f);
DB_CampNight_SCO((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,(DIALOGRESOURCE)CAMP_OwlbearCub_CFM_Dog_547dc3a3-f899-bc24-cb8e-43af4c721197);
DB_CampNight_CancelledBy((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,(FLAG)CAMP_OwlbearCub_Event_Fight_036f6f5f-b2a2-52b1-8229-e5ce6da0c676);
DB_CampNight_CancelledBy((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,(FLAG)GLO_OwlbearCub_State_PermaDefeated_e407829a-d8ff-4759-9dbc-89f2b2f33151);
DB_CampNight_CancelledBy((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,(FLAG)GLO_CourierDog_State_IsPermaDefeated_4d17c54b-9507-4948-bbcc-0fe307f79f0b);

DB_GLO_OwlbearCub_CampNights((FLAG)NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4,(DIALOGRESOURCE)CAMP_OwlbearCub_CRD_1_b8d1c425-089c-d04d-b63f-40cc99b1c747);
DB_GLO_OwlbearCub_CampNights((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,(DIALOGRESOURCE)CAMP_OwlbearCub_CRD_2_aaccfa43-76c2-b9b2-1415-1377def80251);
DB_GLO_OwlbearCub_CampNights((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,(DIALOGRESOURCE)CAMP_OwlbearCub_CFM_Dog_547dc3a3-f899-bc24-cb8e-43af4c721197);
//END_REGION
KBSECTION
//REGION Starting OwlbearCub Night Logic 
PROC
PROC_CampNight_StartSleepMoments_PreHook()
AND
NOT DB_Camp_QueuedNight((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed)
AND
DB_Camp_QueuedNight(_Flag)
AND
NOT DB_CampNight_Completed(_Flag)
AND
DB_GLO_OwlbearCub_CampNights(_Flag,_)
AND
DB_ActiveCamp(_ActiveCamp)
AND
DB_Camp(_ActiveCamp,_,_,_Entrypoint)
THEN
TeleportTo(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,_Entrypoint);
PROC_SetOnStage(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,1);

PROC
PROC_CampNight_StartSleepMoments_PreHook()
AND
DB_Camp_QueuedNight((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed)
THEN
// TODO: Once the cutscene is reworked, teleport the duo to a trigger inside the CLT where it takes place
TeleportTo(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901,S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);
PROC_SetOnStage(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,1);
PROC_SetOnStage(S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901,1);

QRY
QRY_Camp_SleepCutsceneOverride_CustomDialogStart(_Dialog,_Player,_Player2,_Player3,_Player4)
AND
NOT DB_Camp_QueuedNight((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed)
AND
DB_Camp_QueuedNight(_Flag)
AND
DB_GLO_OwlbearCub_CampNights(_Flag,_Dialog)
AND
QRY_StartDialog_Fixed(_Dialog,S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09, _Player,_Player2,_Player3,_Player4)
THEN
DB_NOOP(1);

QRY
QRY_Camp_SleepCutsceneOverride_CustomDialogStart((DIALOGRESOURCE)CAMP_OwlbearCub_CFM_Dog_547dc3a3-f899-bc24-cb8e-43af4c721197,_Player,_Player2,_Player3,_Player4)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)CAMP_OwlbearCub_CFM_Dog_547dc3a3-f899-bc24-cb8e-43af4c721197,S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,S_FOR_Courier_Dog_3059f69c-068d-4e28-8491-55953c027901,_Player,_Player2,_Player3,_Player4)
THEN
DB_NOOP(1);

// Ensures that the owlbear SCO won't start with a player in owlbear slot in QRY_Camp_StartSleepCutsceneDialog
QRY
QRY_Camp_SleepCutsceneOverride_CustomDialogStart(_Dialog,_Player,_Player2,_Player3,_Player4)
AND
DB_GLO_OwlbearCub_CampNights(_Flag,_Dialog)
THEN
DB_NOOP(1);

IF
FlagSet(CAMP_OwlbearCub_Event_Fight_036f6f5f-b2a2-52b1-8229-e5ce6da0c676,_,_)
THEN
DB_Camp_PreventEndOfNight(1);

IF
FlagSet(CAMP_OwlbearCub_State_BecameCampFollower_a9742288-21b5-428a-9efa-a2e73981c02f,_,_)
AND
DB_Camp_QueuedNight((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc)
THEN
DB_Dialogs(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,(DIALOGRESOURCE)CAMP_OwlbearCub_CRD_2_aaccfa43-76c2-b9b2-1415-1377def80251);
DB_Camp_PreventEndOfNight(1);
//END_REGION

//REGION Feeding the owlbear in NIGHT_OwlbearCub1
IF
FlagSet(CAMP_OwlbearCub_Event_Feed_b1f8123f-5049-b3aa-0e30-9f288d98fd1b,(CHARACTER)_Char,_)
THEN
MagicPocketsDestroyLocalItemsByTag(_Char,"FOOD_c86e0114-a5ab-48f6-b497-de321ebff577",1);

IF
FlagSet((FLAG)CAMP_OwlbearCub_Event_PlayersAteFood_09198ba5-ecea-4e13-8d4a-d3fe07abb456,(CHARACTER)_Char,_)
THEN
MagicPocketsDestroyLocalItemsByTag(_Char,"FOOD_c86e0114-a5ab-48f6-b497-de321ebff577",1);
//END_REGION

//REGION Befriending owlbear so it becomes a camper, in NIGHT_OwlbearCub3
IF
FlagSet((FLAG)CAMP_OwlbearCub_State_BecameCampFollower_a9742288-21b5-428a-9efa-a2e73981c02f,_,_)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player,"HIDDEN_WLD_Boosters","CAMP_OwlbearCub_Tamed");

IF
FlagSet((FLAG)NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc,_,_)
AND
DB_GlobalFlag(CAMP_OwlbearCub_State_BecameCampFollower_a9742288-21b5-428a-9efa-a2e73981c02f)
THEN
PROC_ORI_SetupCamp(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,1);
//END_REGION

//REGION Owlbear fooping/running away after camp night dialog
IF
DialogEnded(_Dialog,_)
AND
DB_GLO_OwlbearCub_CampNights(_Flag,_Dialog)
AND
NOT DB_GlobalFlag(CAMP_OwlbearCub_State_BecameCampFollower_a9742288-21b5-428a-9efa-a2e73981c02f)
AND
NOT DB_GlobalFlag(CAMP_OwlbearCub_Event_Fight_036f6f5f-b2a2-52b1-8229-e5ce6da0c676)
THEN
PROC_SetOnStage(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,0);
TeleportTo(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,S_FOR_OwlbearCub_WanderTrigger_889db7ef-5cd5-4761-a061-69759892c4f5);

IF
EnteredCombat(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,_CombatID)
AND
DB_GlobalFlag(CAMP_OwlbearCub_Event_Fight_036f6f5f-b2a2-52b1-8229-e5ce6da0c676)
AND
QRY_OnlyOnce("CAMP_OwlbearCub_CombatStarted_OnlyOnce")
THEN
DB_CAMP_OwlbearCub_NightCombat(_CombatID);

IF
LeftCombat(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,_CombatID)
AND
DB_CAMP_OwlbearCub_NightCombat(_CombatID)
AND
NOT DB_Defeated(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
THEN
PROC_DisappearOutOfSight(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"Run",0,"CAMP_OwlbearCub_RanAwayAtNight");

IF
EntityEvent(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,"CAMP_OwlbearCub_RanAwayAtNight")
THEN
TeleportTo(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,S_FOR_OwlbearCub_WanderTrigger_889db7ef-5cd5-4761-a061-69759892c4f5);

// Fail safe for the owlbear not to be set on stage when the night is over in case players fight it
IF
DB_Camp_InvisibleCamper(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
AND
DB_GlobalFlag(CAMP_OwlbearCub_Event_Fight_036f6f5f-b2a2-52b1-8229-e5ce6da0c676)
THEN
NOT DB_Camp_InvisibleCamper(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);
//END_REGION

//REGION Clearing the state flag used in anubis of owlbear and Scratch for NIGHT_OwlbearCubDog
PROC 
PROC_LongRest()
AND
DB_GlobalFlag(CAMP_OwlbearCubDog_State_NightActive_e092ebb1-f756-4644-b4dc-5bf0c0df3fd7)
THEN
ClearFlag(CAMP_OwlbearCubDog_State_NightActive_e092ebb1-f756-4644-b4dc-5bf0c0df3fd7, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION

//REGION Debug
PROC
PROC_CAMPDEBUG_QueueNight(_Flag,(INTEGER)_IgnoreCampType)
AND
DB_GLO_OwlbearCub_CampNights(_Flag,_)
THEN
DB_OnlyOnce("PROC_FOR_OwlBear_LastCubResolution");
DB_OnlyOnce("FOR_OwlBearCub_LastCubLeaveCombat");
Die(S_WLD_FOR_OwlBear_e903a41f-8ef7-46dc-a847-7d0ec2804d08,DEATHTYPE.Physical,0);
PROC_SetOnStage(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,0);
PROC_RemoveAllDialogEntriesForSpeaker(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09);
SetFaction(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,(FACTION)ACT1_FOR_OwlbearLastCub_71235128-c21a-4ccf-7552-71824901405c);

PROC
PROC_CAMPDEBUG_QueueNight((FLAG)NIGHT_OwlbearCubDog_902e10f8-e9d8-4eb6-ac0f-9ad8ba8787ed,(INTEGER)_IgnoreCampType)
AND
NOT DB_PermaDefeated(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09)
THEN
SetFlag(CAMP_OwlbearCub_State_BecameCampFollower_a9742288-21b5-428a-9efa-a2e73981c02f);
PROC_CampNight_ForceComplete(NIGHT_OwlbearCub1_43696ea8-3bff-440d-bee8-9cd912e4e8b4);
PROC_CampNight_ForceComplete(NIGHT_OwlbearCub2_5cc6fbd5-0b70-4fb5-a29c-9b7ed9e39fcc);
PROC_FOR_Courier_Dog_MoveToCamp();
PROC_ORI_SetupCamp(S_FOR_OwlBear_Cub_001_c66b2865-6613-4372-b97a-e330c1d75d09,1);
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Start"
