Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION GLO_PathToMoonrise
DB_QuestDef_BookReadState("GLO_PathToMoonrise", "ReadHalsinDiary_MT", S_GLO_HalsinDiary_5e4aafd4-f56c-4b05-ad5a-00eccdb87d9d);
DB_QuestDef_BookReadState("GLO_PathToMoonrise", "HalsinToldPath_Dead", (ITEM)S_GLO_HalsinDiary_5e4aafd4-f56c-4b05-ad5a-00eccdb87d9d);

DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Unknown", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Unknown_Asharak", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Unknown_Cerys", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Unknown_Talked", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Known", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Known_Asharak", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Known_Cerys", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinAtGrove_Known_Talked", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinLeft_NoHelp_Known", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "HalsinLeft_NoHelp_Unknown", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "FoundHalsin_Known_KillLeaders", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "FoundHalsin_Known_AoD", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "FoundHalsin_Known_LeadershipDead", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "FoundHalsin_Unknown_KillLeaders", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "FoundHalsin_Unknown_AoD", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "FoundHalsin_Unknown_LeadershipDead", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "GoToMoonrise", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "GoToMoonrise_NoIntro", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");
DB_QuestDef_ChainedState("GLO_Tadpole", "GoToMoonrise_SkippedGrove", "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");

DB_QuestDef_State((FLAG)UND_TheDrowNere_Event_ToldGeneral_bb4e2597-65af-4ef4-fbe9-02167cd02963, "GLO_PathToMoonrise", "ToldMoonrise_Nere");
DB_QuestDef_State_ConditionalFlag((FLAG)UND_TheDrowNere_Event_DeadToldGeneral_d4e8dab1-8358-12ed-b4c7-25025378f8b0, "GLO_PathToMoonrise", "ToldMoonrise_Nere", 0, UND_TheDrowNere_Event_ToldGeneral_bb4e2597-65af-4ef4-fbe9-02167cd02963);
DB_QuestDef_State((FLAG)CAMP_GoblinHuntCelebration_DrowToldMoonrise_350ef7df-6bef-1294-9a07-53066292efd0, "GLO_PathToMoonrise", "ToldMoonrise_Minthara");
DB_QuestDef_State((FLAG)GLO_Daisy_Event_ToldToGoToMoonrise_f51feeff-096d-44b3-8453-0c486e88f8a4, "GLO_PathToMoonrise", "ToldMoonrise_Daisy");

DB_QuestDef_LevelLoaded("GLO_PathToMoonrise", "EnteredCRE_Parent", "CRE_Main_A");

// GLO_PathToMoonrise_SUB_UnderdarkPath
DB_QuestDef_State((FLAG)GLO_Shadowcurse_Knows_FromDuergar_493ad2e1-44cd-2f9d-7d24-4697233a0a3b, "GLO_PathToMoonrise", "Underdark_DuergarToldAboutCurse");
DB_QuestDef_State((FLAG)GLO_Shadowcurse_Knows_FromGnome_f81ae4ea-a095-11f2-fc60-1b7b61a4ba03, "GLO_PathToMoonrise", "Underdark_DuergarToldAboutCurse");
DB_QuestDef_State(GLO_PathToMoonrise_HalsinDeadRiver_75e1ac13-29bf-4c2d-9a66-476072fd7bf0, "GLO_PathToMoonrise", "HalsinToldPath_DeadRiver");
DB_QuestDef_State(UND_TheDrowNere_FollowUp_ToldGoToKetheric_4e86c9ca-b9aa-3216-eef2-e58273a7dd99, "GLO_PathToMoonrise", "Underdark_LearnedSearch");
DB_QuestDef_State(UND_Elevator_Event_GotWarning_fd2f3420-e1ee-e977-16f2-a21344e23918, "GLO_PathToMoonrise", "Underdark_LearnedSearch");
DB_QuestDef_State((FLAG)UND_TheDrowNere_Event_GiveSpidersLyre_769a260f-9f93-4187-a535-ccc427d2babb, "GLO_PathToMoonrise", "Underdark_NereGaveLyre");
DB_QuestDef_State((FLAG)GLO_Underdark_EverEnteredBefore_dd5cd5b4-2ad5-4dbd-4972-2afaa7538994, "GLO_PathToMoonrise", "Underdark_EnteredUnderdark");

DB_QuestDef_BookReadState("GLO_PathToMoonrise", "Underdark_FoundPuzzle", S_GOB_TempleAccess_Lorebook_283d7eff-f6e5-401f-852e-7ad7fb728b88);
DB_QuestDef_BookReadState("GLO_PathToMoonrise", "Underdark_FoundPuzzle", S_GOB_LogbookOfSendings_b441a1c8-541c-4921-9b95-f035923fe6ab);
DB_QuestDef_BookReadState("GLO_PathToMoonrise", "Underdark_FoundPuzzle", S_GOB_SharTempleMap_f01b15a1-e670-43ac-abeb-e7ec9d5fc803);

DB_QuestDef_ChainedState("GLO_PathToMoonrise", "HalsinToldPath", "Underdark_HalsinToldPath");
DB_QuestDef_ChainedState("GLO_PathToMoonrise", "HalsinToldPath_Dead", "Underdark_HalsinToldPath_Dead");

// GLO_PathToMoonrise_SUB_MountainPath
DB_QuestDef_ChainedState("GLO_PathToMoonrise", "HalsinToldPath", "Mountain_HalsinToldPath");
DB_QuestDef_ChainedState("GLO_PathToMoonrise", "MintharaToldPath", "Mountain_MintharaToldPath");
DB_QuestDef_LevelLoaded("GLO_PathToMoonrise", "Mountain_EnteredCRE", "CRE_Main_A");

DB_GLO_PathToMoonrise_MintharaBecameUnavailable_Patched(1);
//END_REGION

//REGION GLO_PrinceOrpheus
DB_BookFlags((ITEM)S_GLO_OrpheusChapter2_4dbaf850-49ff-4e41-adc2-7054e416c960, (FLAG)GLO_OrpheusChapters_State_ReadOrpheusChapter2_c382e9a1-c34d-42b2-8eca-ecfdb660e0ac);
DB_QuestDef_BookReadState("GLO_PrinceOrpheus", "DecipherBook2", (ITEM)S_GLO_OrpheusChapter2_4dbaf850-49ff-4e41-adc2-7054e416c960);
DB_QuestDef_State((FLAG)GLO_OrpheusChapters_State_ReadOrpheusChapter1_c8fa6c18-6491-48b6-9197-43285a07f9c9, "GLO_PrinceOrpheus", "DecipherBook1");
DB_QuestDef_State((FLAG)GLO_OrpheusChapters_State_ReadOrpheusChapter3_cd913886-8e41-47d2-bba1-fda22b129001, "GLO_PrinceOrpheus", "DecipherBook3");
DB_QuestDef_State((FLAG)GLO_OrpheusChapters_State_FailedToDecipher_41ec29c6-de1f-4168-894c-8029b3275469, "GLO_PrinceOrpheus", "DidntDecipherABook");
DB_QuestDef_State((FLAG)INT_EmperorRevealed_Event_SceneComplete_2fa4811a-8757-40e7-a0bb-dc7e210dd6e6, "GLO_PrinceOrpheus", "DiscoveredOrpheusIsInArtefact");
//END_REGION

//REGION Discover the secret of the artefact
DB_QuestDef_State((FLAG)PLA_GithChokepoint_Event_MentionedWeapon_569656de-2acb-6d5d-236c-c86df165e9b6, "GLO_ArtefactDiscovery", "AtGithChokepoint");
DB_QuestDef_State((FLAG)GLO_SecretOfArtefact_MintharaMentionedWeapon_ccca0874-11d3-430f-8e59-cfd8d209b125, "GLO_ArtefactDiscovery", "GoblinCampMinthara");
DB_QuestDef_State((FLAG)GOB_GoblinKing_Event_ToldAboutWeapon_a059e124-737c-bcaa-f95b-7fe727263655, "GLO_ArtefactDiscovery", "GoblinCampGoblinKing");
DB_QuestDef_State((FLAG)GLO_GithChokepoint_Knows_DecipheredMap_604768b9-c983-414d-8c3b-ba1dee3da387, "GLO_ArtefactDiscovery", "DecypheredMap");
DB_QuestDef_BookReadState("GLO_ArtefactDiscovery", "DecypheredMap", (ITEM)S_ORI_Laezel_DeadGithyankiMapForCreche_7c48ba55-4644-4e41-ae1a-f056222f6580);
DB_QuestDef_State((FLAG)GLO_SecretOfArtefact_GuardMentionedCaptain_1dea0195-bf42-4368-be02-f2149ad787ab, "GLO_ArtefactDiscovery", "InGithCreche");
DB_QuestDef_State((FLAG)CRE_UpperGuards_State_GainedAccess_764df691-d1f0-4bde-ba36-73c4abe6a4e7, "GLO_ArtefactDiscovery", "GainedAccessToCreche");
DB_QuestDef_State((FLAG)CRE_ChainOfCommand_State_StartedCaptain_234209eb-5e38-4bf3-97e3-fdec61c1677d, "GLO_ArtefactDiscovery", "EnteredCaptainsOffice");
DB_QuestDef_State((FLAG)CRE_ChainOfCommand_State_CaptainBarrierDeactivated_fdfdbc4d-1713-495e-ad74-e969cfaf2b00, "GLO_ArtefactDiscovery", "TalkedToCaptain");
DB_QuestDef_State((FLAG)CRE_ChainOfCommand_State_PlanecasterActive_5e5e9cb6-41d8-4a93-942d-3dca4d357561, "GLO_ArtefactDiscovery", "SpokenToVlaakith");
DB_QuestDef_State((FLAG)CRE_AstralPrison_State_AstralPrisonWasEntered_2203e87a-6c7b-4aba-b2e8-e22ed96b9762, "GLO_ArtefactDiscovery", "EnteredAstralPrism");
DB_QuestDef_State((FLAG)CRE_AstralPrison_State_KilledDaisyDuringDialog_f19ad2b1-a8b8-48b8-8f38-f3c83e580f1e, "GLO_ArtefactDiscovery", "SpokenToDreamVisitor_Kill");
DB_QuestDef_State((FLAG)CRE_AstralPrison_State_SavedDaisyDuringDialog_929c9f76-537e-4ac4-bd23-a3299ece5db5, "GLO_ArtefactDiscovery", "SpokenToDreamVisitor_Save");
//END_REGION

//REGION Unleash your powers
DB_QuestDef_State((FLAG)NIGHT_DaisyDream1_52669b07-9584-4c9d-8219-49679811fd4f, "GLO_UnleashPowers", "FindTadpole");
DB_QuestDef_State((FLAG)GLO_Tadpole_Event_FirstConsumed_fab5ae97-23b5-4bf2-88ae-0b1bd57523d8, "GLO_UnleashPowers", "FindMoreTadpoles");
DB_QuestDef_State((FLAG)INT_EmperorRevealed_State_PartialCeremorph_bc1c1148-0ed1-8586-39b2-5aff43c3b393, "GLO_UnleashPowers", "UsedAstralTadpole");
DB_QuestDef_State((FLAG)GLO_Tadpole_Event_AstralTouchedTadpoleDestroyed_7c43d181-2bb0-ed4d-5fed-c19752617955, "GLO_UnleashPowers", "NotUsedAstralTadpole");
//END_REGION

//REGION WYR_GetGortashGem
DB_QuestDef_State((FLAG)COL_KethericShowdown_State_HasNetherstone_0243527e-408f-4711-97a0-7759847bb00a, "WYR_GetGortashGem", "GotKethericGem");
DB_QuestDef_State((FLAG)VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9, "WYR_GetGortashGem", "EnteredWyrmsCrossing");

DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_Knows_CeremonyLocationAndGortashName_5eb9384c-4108-4a68-85eb-ba72931a7bc9, "WYR_GetGortashGem", "LearnedCeremony");

DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_SteelWatcherInvitationHappened_f73940d9-d4d9-43d1-9a4c-766713b6d984, "WYR_GetGortashGem", "LearnedGortashSW");

// No clue update only happens if we enter the ceremony without learning that Gortash is there
DB_GLO_CompoundFlag((FLAG)WYR_KillDirectorGortash_State_SteelWatcherInvitationHappened_f73940d9-d4d9-43d1-9a4c-766713b6d984, (FLAG)WYR_KillDirectorGortash_Knows_CeremonyLocationAndGortashName_5eb9384c-4108-4a68-85eb-ba72931a7bc9);
DB_QuestDef_State_ConditionalFlag((FLAG)WYR_KillDirectorGortash_State_VisitedAudienceHall_8984a8f4-c0fa-4797-967b-b8024a7db9b7, "WYR_GetGortashGem", "EnteredCeremony_NoClue", 0, (FLAG)WYR_KillDirectorGortash_State_SteelWatcherInvitationHappened_f73940d9-d4d9-43d1-9a4c-766713b6d984);

// Steel Watch update only happens if the Foundry is not destroyed
DB_QuestDef_State_ConditionalFlag((FLAG)WYR_KillDirectorGortash_State_VisitedAudienceHall_8984a8f4-c0fa-4797-967b-b8024a7db9b7, "WYR_GetGortashGem", "NoticedSteelWatch", 0, (FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b);

DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_OfferedAlliance_03713386-ba9a-46b8-9911-554b89072d88, "WYR_GetGortashGem", "OfferedPact");
DB_QuestDef_State((FLAG)LOW_BhaalTemple_State_HasNetherstone_818fd00e-6780-4712-980e-5c7c25ba9987, "WYR_GetGortashGem", "GotOrinGem");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_AgreedToMeetInUndercity_1375d542-cf0a-49fd-927b-5c6bbce13ce4, "WYR_GetGortashGem", "ForgedAllianceGortash");
DB_QuestDef_State(WYR_KillDirectorGortash_State_GortashTurnedHostile_c003c217-b263-4473-9e4f-9a90aaf43cc9, "WYR_GetGortashGem", "GortashHostile");
DB_QuestDef_ChainedState("GLO_DealWithTheBrain", "GortashDead", "WYR_GetGortashGem", "ElderBrain");

DB_QuestDef_State_ConditionalFlag(
	(FLAG)WYR_KillDirectorGortash_State_HasNetherstone_27dbf056-29ee-4d43-9ad9-4831fa2c8739, "WYR_GetGortashGem", "GotGortashGem",
	0, (FLAG)END_MorphicPool_Event_GortashHeadPop_a596f4f1-fcce-416c-bf0e-31037a1f4fb0);
DB_QuestDef_State_ConditionalFlag(
	(FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769, "WYR_GetGortashGem", "GortashDefeated",
	0, (FLAG)END_MorphicPool_Event_GortashHeadPop_a596f4f1-fcce-416c-bf0e-31037a1f4fb0);
DB_QuestDef_State_ConditionalFlag(
	(FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b, "WYR_GetGortashGem", "DestroyedFoundry_BeforeDeal",
	0, WYR_KillDirectorGortash_State_OfferedAlliance_03713386-ba9a-46b8-9911-554b89072d88);
DB_QuestDef_State_ConditionalFlag(
	(FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b, "WYR_GetGortashGem", "DestroyedFoundry",
	1, WYR_KillDirectorGortash_State_OfferedAlliance_03713386-ba9a-46b8-9911-554b89072d88);
DB_QuestDef_State_ConditionalFlag(
	(FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c, "WYR_GetGortashGem", "DockedIRN_Parent",
	1, WYR_KillDirectorGortash_State_OfferedAlliance_03713386-ba9a-46b8-9911-554b89072d88);

//REGION WYR_GetGortashGem_SUB_Bargain
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_OfferedAlliance_03713386-ba9a-46b8-9911-554b89072d88, "WYR_GetGortashGem", "GortashOfferedPact");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_Event_WarnedDealBreakIRN_29e280ce-e0a0-b1e7-0483-6aa8b56fac77, "WYR_GetGortashGem", "GortashWarnedIRN");
DB_QuestDef_State((FLAG)LOW_BhaalTemple_State_HasNetherstone_818fd00e-6780-4712-980e-5c7c25ba9987, "WYR_GetGortashGem", "GotOrinGemForGortash");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_AgreedToMeetInUndercity_1375d542-cf0a-49fd-927b-5c6bbce13ce4, "WYR_GetGortashGem", "SentToPool");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_GortashBecameHostile_990f1c60-6ecb-4898-ab2e-0a92d2dc0a2c, "WYR_GetGortashGem", "GortashBecameHostile");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_FailedConditions_1a56706c-cca6-4faf-bdd9-47008f061974, "WYR_GetGortashGem", "FailedConditions");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_BetrayedPlayer_e7144173-11a7-4b26-86a1-f3ef892c1fca, "WYR_GetGortashGem", "FailedTest");
DB_QuestDef_State((FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b, "WYR_GetGortashGem", "DestroyedSteelWatchFoundry");
DB_QuestDef_State((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9, "WYR_GetGortashGem", "DestroyedIronThrone");
DB_QuestDef_State((FLAG)IRN_IronThrone_State_Visited_5b3fb5a7-61e8-44a9-a0a1-b6b45b59a23c, "WYR_GetGortashGem", "DockedIRN");
//END_REGION

//REGION WYR_GetGortashGem_SUB_SteelWatch
DB_QuestDef_State((FLAG)GLO_OrinsMessages_Event_Read_SteelWatchFought_d4500cec-3261-45b1-9bce-460864095379, "WYR_GetGortashGem", "LearnedFromOrin");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_OrinToldSteelWatch_f935b068-ed34-40d9-b7c0-ca476e73d156, "WYR_GetGortashGem", "LearnedFromOrin");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_WulbrenToldSteelWatch_48b3c3f0-e78a-4277-8ef9-b9cc0a4d8960, "WYR_GetGortashGem", "LearnedFromGnomes");
DB_QuestDef_State((FLAG)WYR_Wulbren_State_InterruptedByBarcus_f2211dd4-5494-66b1-5e7b-01664f7287b0, "WYR_GetGortashGem", "BarcusAgainst");
DB_QuestDef_State((FLAG)WYR_Ironhand_Event_InvestigateQuest_Offered_bf4bd7b5-8a79-43a6-bc7b-4ae62cfe4302, "WYR_GetGortashGem", "BarcusAgainst");
// only if Control Centre is not destroyed
DB_QuestDef_State_ConditionalFlag(
	(FLAG)WYR_KillDirectorGortash_State_VisitedAudienceHall_8984a8f4-c0fa-4797-967b-b8024a7db9b7, "WYR_GetGortashGem", "LearnedAtCeremony",
	0, (FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b);
DB_QuestDef_State((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306, "WYR_GetGortashGem", "GotBombAndLocation");
DB_QuestDef_State_ConditionalFlag(
	(FLAG)WYR_KillDirectorGortash_State_LearnedFoundryLocation_56e0ff1b-8cc9-4996-be5c-9cb4724c611d, "WYR_GetGortashGem", "LearnedFoundryLocation",
	0, (FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306);

DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_Hasmet_FundangoToobin_94af332f-8038-48bf-8998-70028a73a887, "WYR_GetGortashGem", "MetGondianLeader");

DB_QuestDef_State((FLAG)LOW_SteelWatchFoundry_State_FundangoFollower_a3021d6d-9cc1-3545-54f3-53a35d44d89b, "WYR_GetGortashGem", "ConvincedGondianLeader");
DB_QuestDef_State((FLAG)GLO_Foundry_State_ControlCentreDestroyed_456906c5-40a6-429e-8e1c-7120a2ef631b, "WYR_GetGortashGem", "DisabledSteelWatch");
DB_QuestDef_State((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769, "WYR_GetGortashGem", "DefeatedNoFoundry");

DB_WYR_KillDirectorGortash_Journal_LearnFoundryInsideDialogs((DIALOGRESOURCE)LOW_SteelWatchFoundry_DeadMansSwitchThreat_47d40827-597b-d211-395a-75429620f340);
DB_WYR_KillDirectorGortash_Journal_LearnFoundryInsideDialogs((DIALOGRESOURCE)LOW_SteelWatchFoundry_GondianWorker08_Leader_9d7d9cf1-437a-bba8-b087-456483f85edc);

DB_WYR_KillDirectorGortash_Journal_FoundryDestroyNoPassSteps("ConvincedGondianLeader");
DB_WYR_KillDirectorGortash_Journal_FoundryDestroyNoPassSteps("GondianLeaderDied");
DB_WYR_KillDirectorGortash_Journal_FoundryDestroyNoPassSteps("ReachedCentre_HasBomb");
DB_WYR_KillDirectorGortash_Journal_FoundryDestroyNoPassSteps("LostBombCentre");

DB_WYR_KillDirectorGortash_Journal_GondBooksPatched(1);
//END_REGION

//END_REGION

//REGION GLO_OrinContolGem
DB_QuestDef_LevelLoaded("LOW_FindBhaalTemple", "EnteredCity", "BGO_Main_A");
DB_QuestDef_State((FLAG)LOW_BhaalTemple_State_TempleCombatBegun_b3cf3252-a9af-47b1-9d06-8eae5a397235, "LOW_FindBhaalTemple", "DefeatedOrin");
DB_QuestDef_State((FLAG)GLO_EmperorPrelude_State_OrinStoneCollected_3e629422-74fd-49d0-9e15-d078f6a9c02c, "LOW_FindBhaalTemple", "HaveControlGem");
//END_REGION

//REGION GLO_DealWithTheBrain
//Finding the stones
DB_QuestDef_LevelLoaded("GLO_DealWithTheBrain", "ArrivedInBaldursGate", "BGO_Main_A");
DB_QuestDef_State((FLAG)GLO_EmperorPrelude_State_GortashStoneCollected_c608f192-c5ab-4be9-b13d-4c4ca3c6b971, "GLO_DealWithTheBrain", "GotGortashStone");
DB_QuestDef_State((FLAG)GLO_EmperorPrelude_State_OrinStoneCollected_3e629422-74fd-49d0-9e15-d078f6a9c02c, "GLO_DealWithTheBrain", "GotOrinStone");
DB_QuestDef_State((FLAG)WYR_KillDirectorGortash_State_AgreedToMeetInUndercity_1375d542-cf0a-49fd-927b-5c6bbce13ce4, "GLO_DealWithTheBrain" ,"MadeDealWithGortash");
DB_QuestDef_State((FLAG)END_MorphicPool_Event_GortashHeadPop_a596f4f1-fcce-416c-bf0e-31037a1f4fb0, "GLO_DealWithTheBrain","GortashDead");
//Facing the brain (Morphic Pool)
DB_QuestDef_State((FLAG)END_MorphicPool_Event_GortashMove_7f2b9da1-250e-4bc1-b773-0468cb509fe6, "GLO_DealWithTheBrain", "FaceBrainAfterGortash"); //Spoke with Gortash (or ran past him)
//Failing to dominate the brain
DB_QuestDef_State((FLAG)END_IllithidOptions_Event_EmperorBetrayal_411c2575-bfbc-449c-9762-edad4285aafd, "GLO_DealWithTheBrain", "DroveOffEmperor");
DB_QuestDef_State((FLAG)END_IllithidOptions_State_AcceptedRaphaelDeal_c4d409ef-d70e-9934-edf2-d6bd66201c19, "GLO_DealWithTheBrain", "RaphaelOffer");
DB_QuestDef_State((FLAG)END_IllithidOptions_State_OrpheusIsFree_3b747050-1be0-432e-9de6-e48faa4b74bb, "GLO_DealWithTheBrain", "FreedOrpheus");
//Illithid transformations
DB_QuestDef_State((FLAG)END_General_State_EmperorIsPartyMindFlayer_4e9c31b2-f298-48f6-853c-e74dd88591e9, "GLO_DealWithTheBrain", "EmperorIllithid");
DB_QuestDef_State((FLAG)END_General_State_OrpheusIsMindFlayer_2b638127-f30a-424e-9d4a-a9f8f100a307, "GLO_DealWithTheBrain", "OrpheusIllithid");
//High Hall
DB_QuestDef_State((FLAG)END_General_State_CurrentlyInHighHall_118b3dc5-dab8-4872-92da-ab01c15fa55e, "GLO_DealWithTheBrain", "GetToTheBrainStem");
DB_QuestDef_State((FLAG)END_HighHallInterior_State_NautiloidArrived_31c66f5f-9606-42bf-a315-c06430504065, "GLO_DealWithTheBrain", "InteriorNautiloid");
DB_QuestDef_State((FLAG)END_HighHallInterior_State_NautiloidLeft_ed57695e-adb6-4a4e-8f84-4e9dfc28f318, "GLO_DealWithTheBrain", "ReadyToClimb");
//Going through the Portal
DB_QuestDef_State((FLAG)END_BrainBattle_State_PortalOpen_d55bc4d7-eabb-1c01-88e4-28e3456bd1c7, "GLO_DealWithTheBrain", "OpenedPortalToMindArena");
//destroying the brain
DB_QuestDef_State((FLAG)END_FinalDecisions_Event_PlayerDestroyedBrain_86f3e51d-873b-204d-7328-0c982f83e623, "GLO_DealWithTheBrain", "ChoseDestruction"); //closing off the opposite side quest
DB_QuestDef_State((FLAG)END_FinalDecisions_Event_PlayerDestroyedBrain_86f3e51d-873b-204d-7328-0c982f83e623, "GLO_DealWithTheBrain", "DestroyedElderBrain"); //closing off this side quest
DB_QuestDef_State((FLAG)END_FinalDecisions_Event_PlayerDestroyedBrain_86f3e51d-873b-204d-7328-0c982f83e623, "GLO_DealWithTheBrain", "DealtWithBrain"); //closing off the main quest
//dominating the brain
DB_QuestDef_State((FLAG)END_BrainBattle_Event_EvilFinalDecision_71617aed-6f56-ad38-5657-189de2628cc8, "GLO_DealWithTheBrain", "ChoseDomination"); //closing off the opposite side quest
DB_QuestDef_State((FLAG)END_BrainBattle_Event_EvilFinalDecision_71617aed-6f56-ad38-5657-189de2628cc8, "GLO_DealWithTheBrain", "DominatedElderBrain"); //closing off this side quest
DB_QuestDef_State((FLAG)END_BrainBattle_Event_EvilFinalDecision_71617aed-6f56-ad38-5657-189de2628cc8, "GLO_DealWithTheBrain", "DealtWithBrain"); //closing off the main quest
//END_REGION

//REGION LOW_FindMol
DB_QuestDef_State((FLAG)HAV_TieflingSurvivors_State_PromisedToSaveMol_9b927edd-a5e7-4462-bea6-ff1969c8c00f, "LOW_FindMol", "LearnedMolDisappeared");
DB_QuestDef_State((FLAG)COL_NecromancerLab_HasItem_MolEyepatch_46133bb6-6a7f-38cd-df32-d8f596a1cd7c, "LOW_FindMol", "FoundMolEyePatch");

DB_QuestDef_State((FLAG)COL_FindMol_Event_AskedNecromancerAboutMol_c782e2aa-d8ef-6694-3dc8-6af2e720631a, "LOW_FindMol", "MolNotInColonyBalthazaarLab");
DB_QuestDef_State((FLAG)COL_TadpolingCentre_Event_PurgePods_e9c700a3-5ba8-07e9-e13f-c2e081a3a1c5, "LOW_FindMol", "MolNotInColonyPods");
DB_QuestDef_State((FLAG)COL_TadpolingCentre_Event_ReleasePods_3e81dc65-eb2d-86aa-5163-28450894f868, "LOW_FindMol", "MolNotInColonyPods");
DB_QuestDef_State((FLAG)COL_TadpolingCentre_State_NoInnocentOccupants_04462b73-768d-a59f-0d90-ff55a048090f, "LOW_FindMol", "MolNotInColonyPods");

DB_QuestDef_State((FLAG)SCE_TieflingFollowUp_Knows_MolMissingEyepatch_d3b3d606-5a19-cad9-8f7d-e36a27d9f211, "LOW_FindMol", "MolStillMissing");
DB_QuestDef_State((FLAG)SCE_TieflingFollowUp_Alfira_AskedAboutKids_85e5266c-9663-1a2d-dc54-ce93ed3b5d4e, "LOW_FindMol", "MolStillMissing");

DB_QuestDef_State((FLAG)WYR_RefugeeCamp_Event_MattisMentionedMolInBG_a18054f8-9ec4-9248-c983-399f4c8c0447, "LOW_FindMol", "MolInCity");

DB_QuestDef_State((FLAG)LOW_Guildhall_State_HasMolsContract_d781d435-91ea-454a-807c-a89a418d52f7, "LOW_FindMol", "FoundMolContract");

DB_QuestDef_State((FLAG)LOW_Guildhall_HasMet_ThiefHideoutLeader_e69d09e3-d3ab-fe5f-b8e4-41c274ee1d2f, "LOW_FindMol", "MolInGuildhall");

DB_QuestDef_LevelLoaded("LOW_FindMol", "NeverFoundMol", "END_Main");

DB_LOW_FindMol_ChangeCategoryEntries("MolInCity");
DB_LOW_FindMol_ChangeCategoryEntries("MolStillMissing");
DB_LOW_FindMol_ChangeCategoryEntries("FoundMolContract");
//END_REGION

//REGION Ironhand Gnomes

DB_QuestDef_State((FLAG)SCE_GnomeFollowUp_State_PlayerInvitedToIronhandHideout_e2546bb4-5ec6-40db-aef4-5c4680cf3c9c, "LOW_Foundry", "HadAct2Epilogue");

//END_REGION

//REGION Reached END
DB_QuestDef_LevelLoaded("LOW_AvengeWaveservant", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_PhilgravesMansion", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_ReachEmperorLair", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_RecoverRakathsGold", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_SaveOmeluum", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("LOW_StopTheGazette", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("WYR_FreeFlorrick", "ReachedEND", "END_Main");
DB_QuestDef_LevelLoaded("GLO_DoubtingArtist", "ReachedEND", "END_Main");
//END_REGION

//REGION Epilogue Party
DB_QuestDef_State((FLAG)EPI_Epilogue_State_PartyGameplayStarted_1ff87c8c-a363-45fb-aeb8-762abc69b99e, "EPI_EnjoyParty", "EnjoyTheParty");
//END_REGION



KBSECTION
//REGION GLO_PathToMoonrise
IF
FlagSet(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec, _, _)
AND
DB_Players(_Player)
AND
QuestIsAccepted(_Player, "GLO_Tadpole_SUB_Druid", 0)
THEN
QuestUpdate(_Player, "GLO_PathToMoonrise", "ToldMoonrise_Known_MT");

// Entering Underdark
IF
QuestAccepted(_, "GLO_PathToMoonrise_SUB_UnderdarkPath")
AND
DB_GlobalFlag((FLAG)GLO_Underdark_EverEnteredBefore_dd5cd5b4-2ad5-4dbd-4972-2afaa7538994)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Underdark_LearnedSearch")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Underdark_NereGaveLyre")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Underdark_DuergarToldAboutCurse")
THEN
QuestUpdate("GLO_PathToMoonrise", "Underdark_EnteredUnderdark");

// Arriving to SCL
IF
EnteredTrigger(_Player, S_SCL_EntryBox_Mountain_4d4ccb57-e568-4536-b71b-6993ed640265)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "GLO_PathToMoonrise", "Mountain_ReachedSCL_MountainPass");
QuestUpdate(_Player, "GLO_PathToMoonrise", "Underdark_ReachedSCL_MountainPass");
QuestUpdate(_Player, "GLO_PathToMoonrise", "ReachedSCL");

IF
EnteredTrigger(_Player, S_SCL_Act1ReturnAttemptDialogBox_ToUNDFromSCL_7a5bb6d4-9c7e-495f-bdf2-f49f52bad40a)
AND
DB_Players(_Player)
THEN
QuestUpdate(_Player, "GLO_PathToMoonrise", "Mountain_ReachedSCL_Grymforge");
QuestUpdate(_Player, "GLO_PathToMoonrise", "Underdark_ReachedSCL_KethericCity");
QuestUpdate(_Player, "GLO_PathToMoonrise", "ReachedSCL");

IF
FlagSet(UND_TheDrowNere_FollowUp_ToldGoToKetheric_4e86c9ca-b9aa-3216-eef2-e58273a7dd99, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
QuestUpdate(_Player, "GLO_PathToMoonrise", "ToldMoonrise_PromisedNere");

//Underdark Path Subquest
IF
EnteredTrigger(_Player, S_GOB_TempleBox_001_754d69fd-f1aa-486d-8f9f-ee8957215780)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "GLO_PathToMoonrise", "Underdark_HalsinToldPath", 1)
THEN
QuestUpdate(_Player, "GLO_PathToMoonrise", "Underdark_FindPuzzle");

IF
EnteredTrigger(_Player, S_GOB_TempleBox_001_754d69fd-f1aa-486d-8f9f-ee8957215780)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "GLO_PathToMoonrise", "Underdark_HalsinToldPath_Dead", 1)
THEN
QuestUpdate(_Player, "GLO_PathToMoonrise", "Underdark_FindPuzzle");

IF
DB_GlobalFlag((FLAG)GLO_Moonrise_Knows_AbsoluteAtGrymforge_95f18900-7644-dabb-5add-c8f0cf71cba0)
AND
DB_QuestIsAccepted("GLO_PathToMoonrise")
THEN
QuestUpdate("GLO_PathToMoonrise", "Underdark_LearnedSearch");

IF
DB_GlobalFlag((FLAG)GLO_Moonrise_Knows_AbsoluteAtGrymforge_NoName_e0b97077-996b-45ac-2403-c68226a88ef2)
AND
DB_GLobalFlag((FLAG)GLO_DuergarCamp_EverEnteredBefore_ac0bae57-7006-4676-88b8-7498dde79c41)
AND
DB_QuestIsAccepted("GLO_PathToMoonrise")
THEN
QuestUpdate("GLO_PathToMoonrise", "Underdark_LearnedSearch");

// Underdark_OpenedPuzzle
IF
FlagSet(GOB_TempleAccess_Event_PuzzleSolved_e48a7760-a5b2-4f2e-9e9c-52645d772bd3, _,_)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Underdark_FoundPuzzle")
THEN
QuestUpdate("GLO_PathToMoonrise", "Underdark_OpenedPuzzle");

IF
QuestUpdateUnlocked(_, "GLO_PathToMoonrise", "Underdark_FoundPuzzle")
AND
DB_GlobalFlag(GOB_TempleAccess_Event_PuzzleSolved_e48a7760-a5b2-4f2e-9e9c-52645d772bd3)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Underdark_OpenedPuzzle")
THEN
QuestUpdate("GLO_PathToMoonrise", "Underdark_OpenedPuzzle");

//Mountain Path Subquest
IF
DialogEnded(GOB_DrowCommander_b31382b6-355d-9ab4-3d20-4680e2c26477, _)
AND
DB_GlobalFlag(GOB_DrowCommander_Quest_AskedAboutPassage_d5ae14f8-5997-a9c2-2cc8-04a090fb3725)
AND
DB_GlobalFlag(GOB_DrowCommander_State_ReadyToGo_ac6a5aac-ab85-1109-afd0-559a75dca04e)
AND
DB_GlobalFlag(GOB_DrowCommander_Event_RaidersSortie_26816b01-2d64-b50c-3bf6-bffd7dc5f0b9)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_State_Hostile_27a5c5a6-70bc-81e2-6aa9-ca1f4e619623)
THEN
QuestUpdate("GLO_PathToMoonrise", "Mountain_RaidGrove");

IF
DB_GlobalFlag(DEN_AttackOnDen_State_RaiderVictory_abe1bce8-c234-4afe-a490-76210d98a078)
AND
DB_QuestIsOpened("GLO_PathToMoonrise_SUB_MountainPath")
AND
DB_GlobalFlag(GOB_DrowCommander_Quest_AskedAboutPassage_d5ae14f8-5997-a9c2-2cc8-04a090fb3725)
AND
NOT DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
NOT DB_GlobalFlag(GOB_DrowCommander_State_Hostile_27a5c5a6-70bc-81e2-6aa9-ca1f4e619623)
THEN
QuestUpdate("GLO_PathToMoonrise", "Mountain_GoblinCelebration");

IF
DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_QuestIsOpened("GLO_PathToMoonrise_SUB_MountainPath")
AND
DB_GLO_PathToMoonrise_MintharaBecameUnavailable_Patched(1)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Mountain_RaidGrove")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Mountain_MintharaToldPath")
THEN
QuestUpdate("GLO_PathToMoonrise", "Mountain_MintharaBecameUnavailable");

IF
DB_PermaDefeated(S_GOB_DrowCommander_25721313-0c15-4935-8176-9f134385451b)
AND
DB_QuestIsOpened("GLO_PathToMoonrise_SUB_MountainPath")
AND
DB_GLO_PathToMoonrise_MintharaBecameUnavailable_Patched(1)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Mountain_GoblinCelebration")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("GLO_PathToMoonrise", "Mountain_MintharaToldPath")
THEN
QuestUpdate("GLO_PathToMoonrise", "Mountain_MintharaBecameUnavailable");

IF
LevelLoaded("SCL_Main_A")
AND
DB_QuestIsOpened("GLO_Tadpole")
AND
NOT DB_GlobalFlag(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec)
AND
DB_InCamp(S_GLO_Halsin_7628bc0e-52b8-42a7-856a-13a6fd413323)
THEN
PROC_GlobalSetFlagAndCache(GLO_Halsin_Quest_GoToMoonrise_f334b6de-349a-01e6-2a04-d794a62b38ec);
//END_REGION

//REGION GLO_PrinceOrpheus
IF
DB_GlobalFlag((FLAG)GLO_OrpheusChapters_State_ReadOrpheusChapter1_c8fa6c18-6491-48b6-9197-43285a07f9c9)
AND
DB_GlobalFlag((FLAG)GLO_OrpheusChapters_State_ReadOrpheusChapter2_c382e9a1-c34d-42b2-8eca-ecfdb660e0ac)
AND
DB_GlobalFlag((FLAG)GLO_OrpheusChapters_State_ReadOrpheusChapter3_cd913886-8e41-47d2-bba1-fda22b129001)
THEN
QuestUpdate("GLO_PrinceOrpheus", "DecipheredAllBooks");
//END_REGION

//REGION Discover the secret of the artefact
//start the quest after Shadowheart's tutorial dialog where she collects the artefact by default
IF
DialogEnded(TUT_Start_OM_Shadowheart_AOM_c989b41e-3af8-40ec-31d6-309d3f37b129, _)
THEN
DB_TUT_Start_JournalUpdate((CHARACTER) NULL_00000000-0000-0000-0000-000000000000,"GLO_ArtefactDiscovery", "AcceptedQuestReceivedArtefact");

//start the quest if we recruit Shadowheart at the goblin camp after the Orpheus scene
IF
DialogEnded(ShadowHeart_Recruitment_Gob_cd0dd81e-a7b4-1cae-6d4c-750a7a65ff59, _)
AND
DB_GlobalFlag((FLAG)ORI_ShadowheartRecruitment_State_BoxRecruit_7b706c7d-f23e-49b8-9171-6d493c947ee8)
THEN
QuestUpdate("GLO_ArtefactDiscovery", "AcceptedQuestRecruitedShadowheart");

IF
NestedDialogPlayed(ShadowHeart_Recruitment_Gob_cd0dd81e-a7b4-1cae-6d4c-750a7a65ff59, _)
AND
DB_GlobalFlag((FLAG)ORI_ShadowheartRecruitment_State_BoxRecruit_7b706c7d-f23e-49b8-9171-6d493c947ee8)
THEN
QuestUpdate("GLO_ArtefactDiscovery", "AcceptedQuestRecruitedShadowheart");

//start the quest if Shadowheart is already in our party and the Orpheus scene has ended
IF
DialogEnded(GOB_Orpheus_VoiceOfAbsolute_ShadowheartHasBox_8996ac21-4624-8bd4-02f2-24c92219d8cd, _)
AND
DB_PartyMembers(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679)
THEN
QuestUpdate("GLO_ArtefactDiscovery", "AcceptedQuestRecruitedShadowheart");

//start the quest if we see Shadowheart tinkering with the box in camp
IF
DB_CampNight_Completed((FLAG)NIGHT_ShadowHeart_Box_2de162ec-4272-4750-945f-9d306c5ba0da)
AND
QRY_OnlyOnce("GLO_SecretOfArtefact_QuestStart")
THEN
QuestUpdate("GLO_ArtefactDiscovery", "AcceptedQuestSawShadowHeartAndBoxAtCamp");

//start the quest if we haven't recruited Shadowheart and the artefact appears in our camp
IF
DB_CampNight_Completed((FLAG)NIGHT_InfernalBoxAppears_47942a99-c44e-4e90-a0a2-6956bed9dc5b)
AND
QRY_OnlyOnce("GLO_SecretOfArtefact_QuestStart")
THEN
QuestUpdate("GLO_ArtefactDiscovery", "AcceptedQuestArtefactAtCamp");

IF
DB_CurrentLevel("CRE_Main_A")
AND
DB_GlobalFlag(GLO_GithChokepoint_Knows_DecipheredMap_604768b9-c983-414d-8c3b-ba1dee3da387)
THEN
QuestUpdate("GLO_ArtefactDiscovery", "EnteredCRERegion");

IF
DB_GlobalFlag((FLAG)CRE_ChainOfCommand_Event_TemplarLeavesCaptainDialog_c5263176-8df5-4e8d-a51e-e5bc35715f51)
AND
DB_Defeated(S_CRE_CrecheCaptain_5093da9b-237a-491f-9402-4f9da73c1565)
AND
QRY_OnlyOnce("GLO_SecretOfArtefact_TalkedToCaptain")
THEN
QuestUpdate("GLO_ArtefactDiscovery", "TalkedToCaptain");

IF
DialogEnded(CRE_ChainOfCommand_Templar_5b966f52-b647-b971-e783-437801218856, _)
AND
DB_GlobalFlag((FLAG)CRE_ChainOfCommand_State_SecurityOfficeHostile_04a08ea2-98de-4711-8cd1-9fa6e145a841)
THEN
QuestUpdate("GLO_ArtefactDiscovery", "KeptArtefact");

IF
EntityEvent(_Player, "CRE_AstralPrison_Returned")
AND
NOT DB_GlobalFlag((FLAG)CRE_AstralPrison_Quest_AttemptedToKillDaisy_1d5878d4-1909-453a-aa6a-c43c2faf0c65)
THEN
QuestUpdate("GLO_ArtefactDiscovery", "LeftPrisonSavedDaisy");

IF
EntityEvent(_Player, "CRE_AstralPrison_Returned")
AND
DB_GlobalFlag((FLAG)CRE_AstralPrison_Quest_AttemptedToKillDaisy_1d5878d4-1909-453a-aa6a-c43c2faf0c65)
THEN
QuestUpdate("GLO_ArtefactDiscovery", "LeftPrisonUpsetDaisy");

//end quest in intermezzo if creche is skipped
IF
DialogEnded((DIALOGRESOURCE)INT_EmperorRevealed_WokenUpAtNight_SCO_2dd56c1b-66b0-5c6e-00d3-e6fdd5cab379, _)
THEN
QuestUpdate("GLO_ArtefactDiscovery", "WokenAtNight");
//END_REGION

//REGION GLO_UnleashPowers
IF
TemplateAddedTo(Tadpole_6426104b-3e00-4ff5-90c7-c25cc27b916f, _Tadpole, _Player, _)
AND
DB_Players((CHARACTER)_Player)
THEN
QuestUpdate(_Player, "GLO_UnleashPowers", "FoundTadpole");

IF
TemplateAddedTo(_Template, _Tadpole, _Player, _)
AND
DB_TadpolePowers_TadpolePowerJar_Templates(_Template)
AND
DB_Players((CHARACTER)_Player)
THEN
QuestUpdate(_Player, "GLO_UnleashPowers", "FoundTadpole");

IF
TemplateAddedTo((ITEMROOT)LOOT_MF_Tadpole_Astral_A_4a82e6f2-839f-434e-addf-b07dd1578194,_,_Player,_)
AND
DB_Players((CHARACTER)_Player)
THEN
QuestUpdate(_Player, "GLO_UnleashPowers", "UseAstralTadpole");

IF
DialogStarted((DIALOGRESOURCE)GLO_Tadpole_Consume_b8af6722-476f-9d04-d36d-484db6e0d56f,_)
THEN
QuestUpdate("GLO_UnleashPowers", "DaisyAskedConsume");

PROC
PROC_GLO_Tadpole_CorruptionIncrease(_)
AND
NOT DB_CurrentLevel("TUT_Avernus_C")
THEN
QuestUpdate("GLO_UnleashPowers", "UsedIllithidPersuasion");
//END_REGION

//REGION WYR_GetGortashGem
// Had South Checkpoint Scan scene
IF
FlagSet(WYR_South_State_HaveReason_3657cfaa-345d-44de-b524-489b81c1a8da, _, _)
THEN
QuestUpdate("WYR_GetGortashGem", "HadSouthCheckpointScene");

// Main Quest
IF
RelationChanged((FACTION)Hero_a1542c81-6895-929e-4522-10ce218bb360, _GortashFaction, _NewRelation, 1)
AND
_NewRelation < 50
AND
GetFaction(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _GortashFaction)
THEN
SetFlag((FLAG)WYR_KillDirectorGortash_State_GortashBecameHostile_990f1c60-6ecb-4898-ab2e-0a92d2dc0a2c);

// Fallback for one-hit kill

IF
FlagSet((FLAG)GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769,_,_)
AND
DB_CurrentLevel("BGO_Main_A")
THEN
SetFlag((FLAG)WYR_KillDirectorGortash_State_GortashBecameHostile_990f1c60-6ecb-4898-ab2e-0a92d2dc0a2c);

// destroying Iron Throne (most likely will not trigger, since docking should trigger DockedIRN_Parent, unless we-ll change the flow here in the future)
IF
FlagSet((FLAG)IRN_IronThrone_State_Destroyed_91795368-af06-4b56-9ac1-b78995aa9ea9,_,_)
AND
DB_GlobalFlag(WYR_KillDirectorGortash_State_OfferedAlliance_03713386-ba9a-46b8-9911-554b89072d88)
AND
NOT DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "DockedIRN_Parent")
THEN
QuestUpdate("WYR_GetGortashGem", "DestroyedIRN");

// Foundry
IF
AutomatedDialogEnded(LOW_SteelWatchFoundry_AD_BrokenWatcherReturnTo_c9b8a683-e3b2-b8dc-2a50-fa2deeeef845,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_FoundryVisited_5c929efe-ffe2-4eeb-8853-da29735b53ab)
THEN
QuestUpdate("WYR_GetGortashGem", "LearnedFoundryLocation");

IF
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_FoundryVisited_5c929efe-ffe2-4eeb-8853-da29735b53ab)
AND
NOT DB_GlobalFlag((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306)
THEN
QuestUpdate("WYR_GetGortashGem", "EnteredFoundry");

IF
FlagSet((FLAG)LOW_SteelWatchFoundry_State_FoundryVisited_5c929efe-ffe2-4eeb-8853-da29735b53ab,_,_)
AND
DB_GlobalFlag((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_SteelWatchFoundry_State_HasBomb_8a262fbb-6d98-48cc-bebf-d52773eb38f7, _Player, 1)
THEN
QuestUpdate(_Player, "WYR_GetGortashGem", "EnteredFoundry_HasBomb");

IF
DialogStarted(_Dialog, _)
AND
DB_WYR_KillDirectorGortash_Journal_LearnFoundryInsideDialogs(_Dialog)
AND
NOT DB_GlobalFlag(WYR_KillDirectorGortash_State_LearnedFoundryLocation_56e0ff1b-8cc9-4996-be5c-9cb4724c611d)
AND
NOT DB_GlobalFlag((FLAG)WYR_Ironhand_Event_TerroristQuest_Accepted_0dae7572-9ff4-4991-900b-dadfe153d306)
THEN
QuestUpdate("WYR_GetGortashGem", "LearnedInside");

IF
FlagSet(LOW_SteelWatchFoundry_State_TitanDefeatedWithoutToobinPresent_b0c70e67-f759-4e42-8568-93bc695e7437,_,_)
AND
DB_Players(_Player)
AND
GetFlag((FLAG)LOW_SteelWatchFoundry_State_HasBomb_8a262fbb-6d98-48cc-bebf-d52773eb38f7, _Player, 1)
THEN
QuestUpdate(_Player, "WYR_GetGortashGem", "ReachedCentre_HasBomb");

IF
FlagSet(WYR_Ironhand_BombDestroyed_8ed705b5-6f86-4cff-8c14-cc1c7b87ad9c,_,_)
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "ReachedCentre_HasBomb")
THEN
QuestUpdate("WYR_GetGortashGem", "LostBombCentre");

IF
DB_PermaDefeated(S_LOW_GondianWorker08_Leader_3607ec31-f939-41aa-a7d2-e32f8c46979d)
AND
DB_Players(_Player)
AND
QuestUpdateIsUnlocked(_Player, "WYR_GetGortashGem", "ConvincedGondianLeader", 1)
AND
QuestUpdateIsUnlocked(_Player, "WYR_GetGortashGem", "GondianLeaderDied", 0)
THEN
QuestUpdate(_Player, "WYR_GetGortashGem", "GondianLeaderDied");

IF
AddedTo(S_WYR_Ironhand_RunepowderBomb_8b926cb4-9dd3-4bbf-8b76-9d628270cf1f, _Player, _)
AND
DB_PartyMembers((CHARACTER)_Player)
AND
NOT DB_GlobalFlag((FLAG)WYR_Ironhand_Event_TerroristQuest_Offered_681451d3-6186-4c59-aba7-94ef8fdef701)
THEN
PROC_GlobalSetFlagAndCache((FLAG)WYR_KillDirectorGortash_State_StoleBomb_9c8f4663-50f4-4468-8bbc-994090c3110e);

// Using the controler center switch board
IF
FlagSet(LOW_SteelFoundry_SwitchBoard_State_PassedIntelligenceCheck_cded3718-5f77-6188-b3de-80099febb121,_,_)
THEN
DB_WYR_KillDirectorGortash_Journal_UsedControlPanel(1);

IF
DB_WYR_KillDirectorGortash_Journal_UsedControlPanel(1)
AND
DB_WYR_KillDirectorGortash_Journal_GondBooksPatched(1)
AND
NOT QRY_WYR_KillDirectorGortash_Journal_KnowsHowDestroy()
AND
NOT QRY_WYR_KillDirectorGortash_Journal_OnDestroyNoPassObjective()
THEN
QuestUpdate("WYR_GetGortashGem", "UsedControlPanel_DoesntKnow");

IF
DB_WYR_KillDirectorGortash_Journal_UsedControlPanel(1)
AND
DB_WYR_KillDirectorGortash_Journal_GondBooksPatched(1)
AND
NOT QRY_WYR_KillDirectorGortash_Journal_KnowsHowDestroy()
AND
QRY_WYR_KillDirectorGortash_Journal_OnDestroyNoPassObjective()
THEN
QuestUpdate("WYR_GetGortashGem", "UsedControlPanel_Knows");

QRY
QRY_WYR_KillDirectorGortash_Journal_KnowsHowDestroy()
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "ReachedCentre_HasBomb")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "LostBombCentre")
THEN
DB_NOOP(1);

QRY
QRY_WYR_KillDirectorGortash_Journal_KnowsHowDestroy()
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "ConvincedGondianLeader")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "GondianLeaderDied")
THEN
DB_NOOP(1);

QRY
QRY_WYR_KillDirectorGortash_Journal_KnowsHowDestroy()
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "ReadBothGondianBooks")
THEN
DB_NOOP(1);

QRY
QRY_WYR_KillDirectorGortash_Journal_KnowsHowDestroy()
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "ForcedGondianLeader")
THEN
DB_NOOP(1);

// ReadToobinBook
IF
DB_LOW_SteelWatchFoundry_ReadZannersBook(1)
AND
DB_WYR_KillDirectorGortash_Journal_GondBooksPatched(1)
AND
DB_QuestIsOpened("WYR_GetGortashGem_SUB_SteelWatch")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "ForcedGondianLeader")
AND
NOT QRY_WYR_KillDirectorGortash_Journal_OnDestroyNoPassObjective()
THEN
QuestUpdate("WYR_GetGortashGem", "ReadToobinBook");

IF
DB_LOW_SteelWatchFoundry_ReadZannersBook(1)
AND
DB_WYR_KillDirectorGortash_Journal_GondBooksPatched(1)
AND
DB_QuestIsOpened("WYR_GetGortashGem_SUB_SteelWatch")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "ForcedGondianLeader")
AND
QRY_WYR_KillDirectorGortash_Journal_OnDestroyNoPassObjective()
THEN
QuestUpdate("WYR_GetGortashGem", "ReadToobinBook_After");

QRY
QRY_WYR_KillDirectorGortash_Journal_OnDestroyNoPassObjective()
AND
DB_WYR_KillDirectorGortash_Journal_FoundryDestroyNoPassSteps(_QuestUpdate)
AND
QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", _QuestUpdate)
THEN
DB_NOOP(1);

// ReadBothGondianBooks
IF
DB_LOW_SteelWatchFoundry_ReadBothBooks(1)
AND
DB_QuestIsOpened("WYR_GetGortashGem_SUB_SteelWatch")
AND
NOT QRY_QuestUpdateIsUnlockedForAny("WYR_GetGortashGem", "ForcedGondianLeader")
THEN
QuestUpdate("WYR_GetGortashGem", "ReadBothGondianBooks");

IF
DB_GlobalFlag((FLAG)LOW_SteelWatchFoundry_State_KnownsHowToDisableNeurocitor_0df02f4a-0d44-f355-4638-9aee2ea61fde)
AND
DB_QuestIsOpened("WYR_GetGortashGem_SUB_SteelWatch")
AND
NOT DB_LOW_SteelWatchFoundry_ReadBothBooks(1)
THEN
QuestUpdate("WYR_GetGortashGem", "ForcedGondianLeader");

// Debug 
// start in SCL and then teleport to WYR
IF
TextEvent("journal_ggcg_complete")
AND
GetHostCharacter(_Player)
THEN
// Quest begins
QuestUpdate(_Player, "WYR_GetGortashGem", "GotKethericGem");
// Bargain Sub Quest Steps
QuestUpdate(_Player, "WYR_GetGortashGem", "GortashOfferedPact");
QuestUpdate(_Player, "WYR_GetGortashGem", "GotOrinGemForGortash");
QuestUpdate(_Player, "WYR_GetGortashGem", "SentToPool");
// Disable Steel Watch Sub Quest Steps
QuestUpdate(_Player, "WYR_GetGortashGem", "LearnedFromOrin");
QuestUpdate(_Player, "WYR_GetGortashGem", "LearnedFromGnomes");
QuestUpdate(_Player, "WYR_GetGortashGem", "LearnedAtCeremony");
QuestUpdate(_Player, "WYR_GetGortashGem", "StoleBomb");
QuestUpdate(_Player, "WYR_GetGortashGem", "GotBombAndLocation");
QuestUpdate(_Player, "WYR_GetGortashGem", "LearnedFoundryLocation");
QuestUpdate(_Player, "WYR_GetGortashGem", "LocatedFoundry");
QuestUpdate(_Player, "WYR_GetGortashGem", "EnteredFoundry");
QuestUpdate(_Player, "WYR_GetGortashGem", "MetGondianLeader");
QuestUpdate(_Player, "WYR_GetGortashGem", "ConvincedGondianLeader");
QuestUpdate(_Player, "WYR_GetGortashGem", "GondianLeaderDied");
QuestUpdate(_Player, "WYR_GetGortashGem", "ForcedGondianLeader");
QuestUpdate(_Player, "WYR_GetGortashGem", "DisabledSteelWatch");
// Main Quest Steps
QuestUpdate(_Player, "WYR_GetGortashGem", "EnteredWyrmsCrossing");
QuestUpdate(_Player, "WYR_GetGortashGem", "LearnedCeremony");
QuestUpdate(_Player, "WYR_GetGortashGem", "LearnedGortashSW");
QuestUpdate(_Player, "WYR_GetGortashGem", "EnteredCeremony_NoClue");
QuestUpdate(_Player, "WYR_GetGortashGem", "NoticedSteelWatch");
QuestUpdate(_Player, "WYR_GetGortashGem", "OfferedPact");
QuestUpdate(_Player, "WYR_GetGortashGem", "GotOrinGem");
QuestUpdate(_Player, "WYR_GetGortashGem", "ForgedAllianceGortash");
QuestUpdate(_Player, "WYR_GetGortashGem", "GotGortashGem");
QuestUpdate(_Player, "WYR_GetGortashGem", "ElderBrain");
//END_REGION

//REGION GLO_OrinContolGem
IF
DialogEnded((DIALOGRESOURCE)COL_KethericShowdown_CrownController_1bcd7cc6-6b38-3cf7-ca60-686d4eadc2b2,_)
THEN
QuestUpdate("LOW_FindBhaalTemple", "LearnedAboutOrin");

IF
DB_GlobalFlag(WYR_OrinsImpersonation_State_MetOrinOnce_5f82392a-6e8f-4c9b-a927-b9d77ee263ec)
AND
NOT QRY_GLO_OrinControlGem_StartObjectiveReached()
THEN
QuestUpdate("LOW_FindBhaalTemple", "OrinImpersonatedFirst");

IF
DB_GlobalFlag(WYR_OrinsImpersonation_State_MetOrinOnce_5f82392a-6e8f-4c9b-a927-b9d77ee263ec)
AND
QRY_GLO_OrinControlGem_StartObjectiveReached()
THEN
QuestUpdate("LOW_FindBhaalTemple", "OrinImpersonatedFirst_SecondQuestStep");

//REGION QRY_GLO_OrinControlGem_StartObjectiveReached()
QRY
QRY_GLO_OrinControlGem_StartObjectiveReached()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "BecomeOrFollowMurders")
THEN
DB_NOOP(1);

QRY
QRY_GLO_OrinControlGem_StartObjectiveReached()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "FindBhaalTemple_StartPoint_Devella_Clueless")
THEN
DB_NOOP(1);

QRY
QRY_GLO_OrinControlGem_StartObjectiveReached()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "FindBhaalTemple_StartPoint_Gortash_Ceremony")
THEN
DB_NOOP(1);

QRY
QRY_GLO_OrinControlGem_StartObjectiveReached()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "FindBhaalTemple_TableauxOfMurder")
THEN
DB_NOOP(1);

QRY
QRY_GLO_OrinControlGem_StartObjectiveReached()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "OrinImpersonatedFirst_SecondQuestStep")
THEN
DB_NOOP(1);

QRY
QRY_GLO_OrinControlGem_StartObjectiveReached()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "StartPoint_NoTargetList_AbductionOccured_Companion")
THEN
DB_NOOP(1);

QRY
QRY_GLO_OrinControlGem_StartObjectiveReached()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "StartPoint_NoTargetList_AbductionOccured_Yenna")
THEN
DB_NOOP(1);

QRY
QRY_GLO_OrinControlGem_StartObjectiveReached()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "StartPoint_NoTargetList_FindBhaalTempleDoor")
THEN
DB_NOOP(1);

QRY
QRY_GLO_OrinControlGem_StartObjectiveReached()
AND
QRY_QuestUpdateIsUnlockedForAny("LOW_FindBhaalTemple", "StartPoint_NoTargetList_OrinNote")
THEN
DB_NOOP(1);
//END_REGION

IF
DB_GlobalFlag((FLAG)GLO_Orin_State_PermaDefeated_c716e4d9-e6ed-445c-a710-ee4d91c67298)
AND
NOT DB_GlobalFlag((FLAG)GLO_EmperorPrelude_State_OrinStoneCollected_3e629422-74fd-49d0-9e15-d078f6a9c02c)
THEN
QuestUpdate("LOW_FindBhaalTemple", "RetrievedDagger");
//END_REGION

//REGION GLO_DealWithTheBrain
//Starting the quest and both sidequests
IF
DialogEnded((DIALOGRESOURCE)INT_EmperorRevealed_WokenUpAtNight_SCO_2dd56c1b-66b0-5c6e-00d3-e6fdd5cab379, _)
THEN
QuestUpdate("GLO_DealWithTheBrain", "LearnedOfElderBrain");
QuestUpdate("GLO_DealWithTheBrain", "LearnedOfDestroyOption");
QuestUpdate("GLO_DealWithTheBrain", "LearnedOfDominateOption");

//have all the nethersones
IF
DB_GlobalFlag(GLO_EmperorPrelude_State_GortashStoneCollected_c608f192-c5ab-4be9-b13d-4c4ca3c6b971)
AND
DB_GlobalFlag(GLO_EmperorPrelude_State_OrinStoneCollected_3e629422-74fd-49d0-9e15-d078f6a9c02c)
AND
NOT DB_GLobalFlag(END_General_State_CurrentlyInMorphicPool_06208edf-4c61-44a2-932b-b158d9ddd2f0)
THEN
QuestUpdate("GLO_DealWithTheBrain", "GotAllStones");

//Looted the stone after killing Gortash in Morphic Pool
IF
FlagSet(GLO_EmperorPrelude_State_GortashStoneCollected_c608f192-c5ab-4be9-b13d-4c4ca3c6b971, _, _)
AND
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac)
AND
DB_GlobalFlag(END_General_State_CurrentlyInMorphicPool_06208edf-4c61-44a2-932b-b158d9ddd2f0)
AND
DB_GlobalFlag(END_MorphicPool_Event_AttackedGortash_d3c03c7a-d153-4d4e-bc90-6f7b3bb9af1f)
THEN
QuestUpdate("GLO_DealWithTheBrain", "FaceBrainAfterGortash");

//Failed to dominate the brain
PROC
PROC_END_MorphicPool_TeleportToAstralPrism()
THEN
QuestUpdate("GLO_DealWithTheBrain", "FailedToControlBrain");

IF
DialogStarted((DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, _)
THEN
QuestUpdate("GLO_DealWithTheBrain", "LearnedMindflayerNeeded");

//Got the supreme tadpole for later use
IF
DialogEnded((DIALOGRESOURCE)END_IllithidOptions_Assimilation_f909fcc9-a3dc-b91d-e91c-33f0479c55bb, _)
AND
DB_GlobalFlag(END_General_State_SupremeTadpoleAvailable_0177c452-90cc-4c29-83b8-4acaa2902b27)
THEN
QuestUpdate("GLO_DealWithTheBrain", "SupremeTadpole");

//Illithid Transformations
IF
FlagSet(END_General_State_CompKarlachIsMindFlayer_4f403cb8-c9d8-4e50-ff3a-e56a90c8f1d0, _, _)
AND
DB_GLobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9)
THEN
QuestUpdate("GLO_DealWithTheBrain", "CompanionKarlachIllithid");

IF
FlagSet(END_General_State_PlayerIsMindFlayer_d138f537-2268-49a6-8dc4-256bd9cf5633, _, _)
AND
DB_GLobalFlag(END_General_State_CurrentlyInAstralPlane_b3cf6c91-4d1c-4dcf-bc57-262f7d0f02b9)
THEN
QuestUpdate("GLO_DealWithTheBrain", "AvatarIllithid");

IF
FlagSet(END_General_State_CompKarlachIsMindFlayer_4f403cb8-c9d8-4e50-ff3a-e56a90c8f1d0, _, _)
AND
DB_GLobalFlag(END_General_State_CurrentlyInHighHall_118b3dc5-dab8-4872-92da-ab01c15fa55e)
THEN
QuestUpdate("GLO_DealWithTheBrain", "CompanionKarlachIllithid_HH");

IF
FlagSet(END_General_State_PlayerIsMindFlayer_d138f537-2268-49a6-8dc4-256bd9cf5633, _, _)
AND
DB_GLobalFlag(END_General_State_CurrentlyInHighHall_118b3dc5-dab8-4872-92da-ab01c15fa55e)
THEN
QuestUpdate("GLO_DealWithTheBrain", "AvatarIllithid_HH");

IF
FlagSet(END_General_State_CompKarlachIsMindFlayer_4f403cb8-c9d8-4e50-ff3a-e56a90c8f1d0, _, _)
AND
DB_GLobalFlag(END_General_State_CurrentlyInBrainBattle_0d7205b2-0d55-4540-8737-543253873cd6)
THEN
QuestUpdate("GLO_DealWithTheBrain", "CompanionKarlachIllithid_BB");

IF
FlagSet(END_General_State_PlayerIsMindFlayer_d138f537-2268-49a6-8dc4-256bd9cf5633, _, _)
AND
DB_GLobalFlag(END_General_State_CurrentlyInBrainBattle_0d7205b2-0d55-4540-8737-543253873cd6)
THEN
QuestUpdate("GLO_DealWithTheBrain", "AvatarIllithid_BB");

//Standing Atop the Brain
IF
DialogEnded((DIALOGRESOURCE)END_BrainBattle_Intro_4565e114-0153-0449-ea83-de3b972c7679, _)
AND
DB_PartyMembers(_PartyMember)
AND
DB_END_BrainBattle_Start(1)
THEN
QuestUpdate("GLO_DealWithTheBrain", "StandingAtopTheBrain");

IF
EnteredTrigger(_PartyMember, S_END_NetherbrainArena_001_SUB_a79f975d-d33a-455b-a444-9a0d08f59c57)
AND
DB_PartyMembers(_PartyMember)
THEN
QuestUpdate(_PartyMember, "GLO_DealWithTheBrain", "EnteredMindArena");
//END_REGION

//REGION EPI_EnjoyParty
IF
DialogStarted((DIALOGRESOURCE)EPI_Epilogue_FinalToast_d5e29da5-4c48-8920-91d8-00b72c149771, _)
THEN
QuestUpdate("EPI_EnjoyParty", "LeaveTheParty");

IF
DialogStarted((DIALOGRESOURCE)EPI_Epilogue_ViolentClosure_7be90d08-883d-6e91-eef1-60371a9ac045, _)
THEN
QuestUpdate("EPI_EnjoyParty", "LeaveTheParty_Violent");
//END_REGION

//REGION LOW_FindMol
IF
DB_PermaDefeated((CHARACTER)S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
THEN
QuestUpdate("LOW_FindMol", "MolNotInColonyDefeatedKetheric");

IF
QuestUpdateUnlocked(_, "LOW_FindMol", _QuestUpdate)
AND
DB_LOW_FindMol_ChangeCategoryEntries(_QuestUpdate)
THEN
QuestSetCategory("LOW_FindMol", "BaldursGate");
//END_REGION

//REGION CAMP

IF
TeleportedToCamp(_Player)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("HIDDEN_WLD_Boosters_CAMP_FirstGoToCamp")
THEN
QuestUpdate(_Player,"HIDDEN_WLD_Boosters","CAMP_FirstGoToCamp");

//END_REGION

//REGION SHA_Nightsong
IF
UseFinished(_, S_GOB_ThroneRoom_Door_Entrance_bf8a7b29-383d-4344-bbe6-b72f10c1ba50, 1)
THEN
QuestUpdate("SHA_Nightsong", "SearchTemple");

//END_REGION

//REGION Moves all completed quests to the *Completed Quests* category on the bottom of the journal.
IF
QuestClosed(_Quest)
THEN
QuestSetCategory(_Quest, "CompletedQuests");
//END_REGION

//REGION Debug
IF
TextEvent("getgems")
AND
GetHostCharacter(_Player)
THEN
ToInventory(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, _Player, 1, 1, 1);
ToInventory(S_WYR_CrownController_Gortash_383be300-d328-4152-86df-4927482d1fd7, _Player, 1, 1, 1);
ToInventory(S_LOW_CrownController_Orin_360b0dfd-8e0b-48d2-a079-fcf68c104d6b, _Player, 1, 1, 1);

IF
TextEvent("journal_testall")
AND
DB_QuestDef_State(_, _QuestID, _StepID)
THEN
QuestUpdate(_QuestID, _StepID);

IF
TextEvent("journal_dealwithbrainstart")
THEN
QuestUpdate("GLO_DealWithTheBrain", "LearnedOfElderBrain");
QuestUpdate("GLO_DealWithTheBrain", "LearnedOfDestroyOption");
QuestUpdate("GLO_DealWithTheBrain", "LearnedOfDominateOption");
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Start"
