Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION Nightsong States
DB_State_Priority(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtTemple", 0);
DB_State_Priority(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtInn", 1000);
DB_State_Priority(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtMoo", 2000);
DB_State_Priority(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_Freed", 2500);
DB_State_Priority(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", 2600);
DB_State_Priority(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_KethericDefeated", 3000);
DB_State_Priority(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_PermanentlyDead", 4000);

DB_State_Flags(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtInn", HAV_Nightsong_State_AtInn_a54c06a7-2b9f-47fa-9821-3d346f378237);
DB_State_Flags(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_PermanentlyDead", SHA_Nightsong_State_PermaDefeated_d02e8ea4-dec7-4824-8117-efc075dee4ba);

DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtTemple");

DB_GLO_Nightsong_AwaitsResurrection(0);
DB_GLO_Nightsong_ActiveCombat(NULL_00000000-0000-0000-0000-000000000000);
DB_DefeatedStateFlag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,GLO_Nightsong_State_Defeated_64cfde96-b6d3-4d55-86c2-993a97f82ea6);
//END_REGION

//REGION Combat ADs
// Shadowfell ADs
DB_CombatReact_AD_OnTurn(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)SHA_Nightsong_AD_TauntPlayer_4e2e1a1c-c1e1-2585-1d0f-5d43a537a49b, 1);
DB_CombatReact_AD_OnTurn(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)SHA_Nightsong_AD_TauntPlayer_4e2e1a1c-c1e1-2585-1d0f-5d43a537a49b, 2);
DB_CombatReact_AD_OnTurn(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)SHA_Nightsong_AD_TauntPlayer_4e2e1a1c-c1e1-2585-1d0f-5d43a537a49b, 3);
DB_CombatReact_AD_OnTurn(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)SHA_Nightsong_AD_TauntPlayer_4e2e1a1c-c1e1-2585-1d0f-5d43a537a49b, 4);
DB_CombatReact_AD_OnDeath(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)GLO_Nightsong_AD_Killed_6161a78d-0bbf-9cb0-fa36-f2de99124fdd);
DB_CombatReact_AD_StatusRemoved(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)GLO_Nightsong_AD_Resurrected_cd43a273-bb72-209d-ad81-98fe720e3f7a, "NIGHTSONG_DOWNED");
//END_REGION

//Event for when Nightsong dies
DB_Inclusion_Object((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(FLAG)SHA_Nightsong_Inclusion_Start_c88a28f7-443a-bb7c-fb2d-888077ce7a14,(FLAG)SHA_Nightsong_Inclusion_End_1d089a1b-2251-7a03-075b-f6e025ae9a82);

// Nightsong Resurrection Setup
DB_PreventPermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_NoLowAttitudeDialog((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SelfHealing_Disable((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

NOT DB_GLO_Nightsong_ActiveStatuses("");

SetTag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(TAG)CHASM_IMMUNE_1063224a-a5ab-41b1-b309-0ac730e4e8ce); //So this won't be removed by transformations
KBSECTION
//REGION State Changes
PROC
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtMoo")
THEN
PROC_Poof(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_MOO_RoofNightsongPoint_3c9754d2-0c00-4859-a95e-d27ea15c6701, "SHA_Nightsong_ToMoonrise");

PROC
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_Freed")
THEN
PROC_Poof(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_MOO_Assault_TrySetupChar(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_MOO_RoofNightsongPoint_3c9754d2-0c00-4859-a95e-d27ea15c6701, "MOO_Assault_Nightsong");
PROC_GLO_Nightsong_GiveNightsongEquipment();

PROC
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_KethericDefeated")
AND
NOT DB_OnlyOnce("GaveNightsongHerEquipment")
THEN
PROC_GLO_Nightsong_GiveNightsongEquipment();

PROC
PROC_SCE_SetupDebrief()
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_KethericDefeated");

IF
DB_LevelUnreachable("SCL_Main_A")
AND
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
NOT DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_KethericDefeated")
THEN
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_KethericDefeated");

//For debug
IF
LeftLevel(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SCL_Main_A")
AND
DB_LevelUnreachable("SCL_Main_A")
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_SOULCAGE", 1)
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_NIGHTSONG_SOULCAGE");

IF
LeftLevel((CHARACTER)S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"SCL_Main_A")
AND
DB_LevelUnreachable("SCL_Main_A")
AND
HasActiveStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_ISOBEL_MOONRITUAL", 1)
THEN
RemoveStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211,"HAV_ISOBEL_MOONRITUAL");

PROC
PROC_State_Changed(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_Nightsong","SHA_State_Nightsong_KethericDefeated")
AND
DB_SceneManager((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_NightsongPrison_MeetingNightsong")
THEN
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");

PROC
PROC_State_Changed(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_Nightsong","SHA_State_Nightsong_KethericDefeated")
AND
DB_SceneManager((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SCE_IsobelNightsongReunion_Scene_MainReunion")
THEN
PROC_SceneOver("SCE_IsobelNightsongReunion_Scene_MainReunion");

PROC
PROC_State_Changed(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,"SHA_Nightsong", "SHA_State_Nightsong_KethericDefeated")
THEN
SetTag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(TAG)NOT_MESSING_AROUND_542b58f0-42ad-4157-a28e-27434e0e7b18);

IF
DB_Dead((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_SHARSPEAR_MORTALWOUND", 1)
THEN
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_PermanentlyDead");

PROC
PROC_GLO_Nightsong_GiveNightsongEquipment()
AND
QRY_OnlyOnce("GaveNightsongHerEquipment")
THEN
DB_GLO_Chasms_ChasmRecoveryAnimation((GUIDSTRING)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b,(ANIMATION)CUST_NightsongFlightRecovery_348ef802-c475-41e7-a8b3-cb38fbc66669);
Transform(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, Humans_Female_Strong_NightSong_9671ecbb-4030-48ff-b63e-f138e988835f, (SHAPESHIFTRULE)Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
CharacterGiveEquipmentSet((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong");

IF
TextEvent("GLO_NightsongTransform")
THEN
PROC_GLO_Nightsong_GiveNightsongEquipment();

IF
Resurrected(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
SetFlag((FLAG)SHA_Nightsong_Event_Resurrected_43ea94b5-f929-4eb4-baea-b9cdc459b53f, NULL_00000000-0000-0000-0000-000000000000, 0);
TimerCancel("Nightsong_PostResurrection");
TimerLaunch("Nightsong_PostResurrection", 2000);

//END_REGION

//REGION Combat ADs
PROC
PROC_State_Changed(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtTemple", _, _)
THEN
NOT DB_CombatReact_AD_OnTurn(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)SHA_Nightsong_AD_TauntPlayer_4e2e1a1c-c1e1-2585-1d0f-5d43a537a49b, 1);
NOT DB_CombatReact_AD_OnTurn(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)SHA_Nightsong_AD_TauntPlayer_4e2e1a1c-c1e1-2585-1d0f-5d43a537a49b, 2);
NOT DB_CombatReact_AD_OnTurn(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)SHA_Nightsong_AD_TauntPlayer_4e2e1a1c-c1e1-2585-1d0f-5d43a537a49b, 3);
NOT DB_CombatReact_AD_OnTurn(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)SHA_Nightsong_AD_TauntPlayer_4e2e1a1c-c1e1-2585-1d0f-5d43a537a49b, 4);

// Have to play this combat reaction manually since Nightsong is dead and removed from combat when this status is active
IF
StatusRemoved(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION", _, _)
AND
NOT DB_OnlyOnce("SHA_Nightsong_PlayedResurrectionAD")
AND
QRY_StartDialog((DIALOGRESOURCE)GLO_Nightsong_AD_Resurrected_cd43a273-bb72-209d-ad81-98fe720e3f7a, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
DB_OnlyOnce("SHA_Nightsong_PlayedResurrectionAD");
NOT DB_CombatReact_AD_StatusRemoved(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (DIALOGRESOURCE)GLO_Nightsong_AD_Resurrected_cd43a273-bb72-209d-ad81-98fe720e3f7a, "NIGHTSONG_DOWNED");

IF
Dying((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_SHARSPEAR_MORTALWOUND", 0)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_SOULCAGE", 1)
AND
QRY_OnlyOnce("SHA_Nightsong_PlayedKilledAD")
AND
NOT QRY_StartDialog((DIALOGRESOURCE)GLO_Nightsong_AD_Killed_6161a78d-0bbf-9cb0-fa36-f2de99124fdd, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
NOT DB_OnlyOnce("SHA_Nightsong_PlayedKilledAD");

//END_REGION

//REGION Permanently Kill Nightsong
PROC
PROC_SHA_Nightsong_PermaKill((CHARACTER)_Killer)
THEN
NOT DB_KeepDialogsOnDeath((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
NOT DB_PreventPermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_SHARSPEAR_MORTALWOUND", -1.0, 1, _Killer);
PROC_MusicPlayGeneral("NightsongDead");

//END_REGION

//REGION Nightsong In Camp
//Track Statuses on NS
IF
StatusApplied(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Status, _, _)
AND
NOT DB_GLO_Nightsong_ActiveStatuses(_Status)
AND
_Status != "GLO_NIGHTSONG_RESURRECTION"
THEN
DB_GLO_Nightsong_ActiveStatuses(_Status);

IF
StatusRemoved(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Status, _, _)
AND
DB_GLO_Nightsong_ActiveStatuses(_Status)
THEN
NOT DB_GLO_Nightsong_ActiveStatuses(_Status);

//Heal after long rest
IF
TeleportedToCamp(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
THEN
SetHitpointsPercentage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 100.0);

IF
TeleportedToCamp(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_GLO_Nightsong_ActiveStatuses(_Status)
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Status);
//END_REGION

//REGION Nightsong resurrection for Act 3
IF
EnteredCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _CombatID)
AND
NOT DB_CurrentLevel("SCL_Main_A")
THEN
DB_GLO_Nightsong_ActiveCombat(_CombatID);

IF
DB_Dead((CHARACTER)S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b)
AND
DB_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f)
AND
NOT DB_CurrentLevel("SCL_Main_A")
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_SHARSPEAR_MORTALWOUND", 0)
AND
QRY_SHA_NightsongPrison_NightsongCanResurrect()
THEN
DB_GLO_Nightsong_AwaitsResurrection(1);

IF
CombatRoundStarted(_CombatID, _)
AND
DB_GLO_Nightsong_ActiveCombat(_CombatID)
AND
DB_GLO_Nightsong_AwaitsResurrection(1)
AND
QRY_SHA_NightsongPrison_NightsongCanResurrect()
AND
GetBaseFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Faction)
THEN
NOT DB_GLO_Nightsong_AwaitsResurrection(1);
PROC_SetRelationToPlayers(_Faction, 100);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION", 0.0, 0, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

IF
CombatEnded(_)
AND
DB_GLO_Nightsong_AwaitsResurrection(1)
AND
QRY_SHA_NightsongPrison_NightsongCanResurrect()
AND
GetBaseFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Faction)
THEN
NOT DB_GLO_Nightsong_AwaitsResurrection(1);
PROC_SetRelationToPlayers(_Faction, 100);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION", 6.0, 0, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

IF
CombatEnded(_CombatID)
AND
DB_GLO_Nightsong_ActiveCombat(_CombatID)
THEN
NOT DB_GLO_Nightsong_ActiveCombat(_CombatID);


IF
StatusRemoved(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION", _, _)
AND
NOT DB_CurrentLevel("SCL_Main_A")
THEN
NOT DB_Dead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
NOT DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);

//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Start"
