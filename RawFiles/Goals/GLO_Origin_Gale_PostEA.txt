Version 1
SubGoalCombiner SGC_AND
INITSECTION
SetOnStage(S_ORI_Gale_TressymItem_39fed5b1-1f0b-40d4-96bb-14bd45901c97, 0);
DB_GiveItemToEventWithClear(S_ORI_Gale_TressymItem_39fed5b1-1f0b-40d4-96bb-14bd45901c97, (FLAG)ORI_Gale_Event_GiveTressymItem_cbc2a5b6-cc9d-4c9b-9e71-5f740e37bb8a);

DB_TadpolePowers_UnlockedByDefault((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_GLO_CharacterCorpseDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_Dead_0d778ae3-1eae-a1db-1902-951d3be7b619);

DB_ORI_Gale_GoalFlag(1, 1, (FLAG)ORI_Gale_State_WillingForCrown_3d441746-263e-4e4d-b904-a00f5cc70265);
DB_ORI_Gale_GoalFlag(1, 6, (FLAG)ORI_Gale_State_EagerForCrown_e3b1b1af-9952-428b-a7df-8370656d3f35);
DB_ORI_Gale_GoalFlag(1, 3, (FLAG)ORI_Gale_State_SwayedTowardsCrown_76150a10-511d-4eeb-b263-46994bab0b48);

DB_ORI_Gale_GoalFlag(0, 6, (FLAG)ORI_Gale_State_EagerToDie_99da124a-3995-4fd5-90c5-47a89d7e277e);
DB_ORI_Gale_GoalFlag(0, 3, (FLAG)ORI_Gale_State_ReadyToDie_53a7fbbd-7920-4e7f-894f-bcdb46f6221a);
DB_ORI_Gale_GoalFlag(0, 1, (FLAG)ORI_Gale_State_WillingToDie_3f22f471-60e6-11df-1c95-19f756f81994);

DB_ORI_Gale_ChangeGoal(0, 1, (FLAG)ORI_Gale_Event_PushTowardsDeath_34bfb6e7-f557-4d3f-835f-2f42b5791c0d, (FLAG)ORI_Gale_State_PushedTowardsDeath_a693b8d5-5ac6-4982-8bd3-851c7f212423);
DB_ORI_Gale_ChangeGoal(1, 1, (FLAG)ORI_Gale_Event_PushTowardsCrown_96fad101-7c29-495c-91d3-3645b30c2bab, (FLAG)ORI_Gale_State_PushedTowardsCrown_83843c4f-6c61-4f0f-8ace-b2c17066bb04);
DB_ORI_Gale_ChangeGoal(1, -1, (FLAG)ORI_Gale_Event_PushAwayFromCrown_303eeb6d-22cb-4832-a186-f366a4a6eacc, (FLAG)ORI_Gale_State_PushedAwayFromCrown_b0870966-4fb1-442e-88ae-c39881bb1fe0);
DB_ORI_Gale_ChangeGoal(0, -1, (FLAG)ORI_Gale_Event_PushAwayFromDeath_98241d31-012b-4b01-a153-aad9c02e3c32, (FLAG)ORI_Gale_State_PushedAwayFromDeath_f62aa105-4816-4589-b716-f44b85226e75);

DB_ORI_Gale_GoalForceFlag(0, 0, (FLAG)ORI_Gale_Event_ForceSetUnwillingToDie_5b3fd6a1-0942-42c1-9913-90efa3588315);

DB_OriginMayLeaveDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574);

DB_ORI_Gale_IncubusUnderwear(Underwear_Incubus_5fa043bf-0445-49ad-9e82-0df77c639fe2);
DB_ORI_Gale_IncubusUnderwear(Underwear_Incubus_B_82c84433-0464-442a-8e5a-0891d829f99a);

DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_Act2End_05706143-82c3-616d-6850-9281f08c9b9f);
DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);
DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem1_c1899c40-e4c4-72d6-4360-444cea41e72f);
DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem2_170a6564-a01e-f145-6958-bf84312d0e03);
DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicItem3_b2db2afd-74a2-b432-df34-6073d7c78b62);
DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_NeedMagicReminder_3834abc3-f70e-7bbf-b286-32b795cfc3c4);

DB_ORI_Gale_IPRDOverFlag((FLAG)ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a, (FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735);

DB_TopicalGreeting((FLAG)TG_ORI_Gale_ConsumedItem_d891c321-8124-a88d-0a88-fad59e3d2ce8);
DB_TopicalGreeting((FLAG)TG_ORI_Gale_ElminsterVisit_702a96d6-192a-00b6-5e9b-bd5bd46bd7c8);
DB_TopicalGreeting((FLAG)TG_ORI_GaleResurrected_6b24c954-9738-4c47-8995-5a701cb25378);

DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_ORI_Gale_ConsumedItem_d891c321-8124-a88d-0a88-fad59e3d2ce8,(FLAG)ORI_Gale_Event_CoveredConsumedItemTG_c1044864-2596-4da2-9eab-a353e31011d0);
DB_TopicalGreetingEndCondition_FlagSet((FLAG)TG_ORI_Gale_ElminsterVisit_702a96d6-192a-00b6-5e9b-bd5bd46bd7c8,(FLAG)ORI_Gale_Knows_Avatar_ReactedElminster_7ff035bf-0a38-34bb-f949-0bf2808094e1);

DB_ORI_Gale_Companion_AteMagicItemIPRDs((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d, (FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3);
DB_ORI_Gale_Companion_AteMagicItemIPRDs((FLAG)ORI_Gale_State_GotTwoMagicItems_c757086e-4696-441d-b19c-fdb65982776f, (FLAG)ORI_Gale_IPRD_Ate2Items_359f4afc-378f-83f0-3602-21f1ec6511a0);
DB_ORI_Gale_Companion_AteMagicItemIPRDs((FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307, (FLAG)ORI_Gale_IPRD_Ate3Items_a8e84a1d-7cfe-574a-b92d-34c58a02ba8b);

DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate1Item_3ec52828-6eb2-e2cd-6a2a-f5b7d1b443e3, (FLAG)ORI_Gale_Event_ThankedForItem1_Global_b64a5b68-42a4-4136-85e3-db588cf21871);
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate2Items_359f4afc-378f-83f0-3602-21f1ec6511a0, (FLAG)ORI_Gale_Event_ThankedForItem2_2c6edb9b-ce0e-359b-abcc-412520192560);
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag((FLAG)ORI_Gale_IPRD_Ate3Items_a8e84a1d-7cfe-574a-b92d-34c58a02ba8b, (FLAG)ORI_Gale_Knows_LearnedBackstory_0a9731cf-4769-249f-818d-b4c6e542083d);

SetFlag(ORI_Gale_State_NotDating_21f19438-754d-4ad2-883e-fd3f8814b917, NULL_00000000-0000-0000-0000-000000000000, 0);


//Avatar Journal

DB_QuestDef_State((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93, "ORI_Avatar_Gale", "NeedItem1");
DB_QuestDef_State((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem2_fd8f43cd-a2c1-4211-8978-de2db47fafe8, "ORI_Avatar_Gale", "NeedItem2");
DB_QuestDef_State((FLAG)ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9, "ORI_Avatar_Gale", "NeedItem3");
DB_QuestDef_State((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d, "ORI_Avatar_Gale", "GotItem1");
DB_QuestDef_State((FLAG)ORI_Gale_State_GotTwoMagicItems_c757086e-4696-441d-b19c-fdb65982776f, "ORI_Avatar_Gale", "GotItem2");
DB_QuestDef_State((FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307, "ORI_Avatar_Gale", "GotItem3");
DB_QuestDef_State((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, "ORI_Avatar_Gale", "ElminsterBrief");
DB_QuestDef_State((FLAG)ORI_Gale_Knows_ReadKarsusNotes_2b0e541f-f49e-7e82-27d6-15fccd6ff1ff,  "ORI_Avatar_Gale", "ReadNotes");
DB_QuestDef_State((FLAG)ORI_Gale_Quest_MystraRequest_3b3e7fbc-08c5-4b03-bace-40250a99ce7b,  "ORI_Avatar_Gale", "MystraRequest");
DB_QuestDef_State((FLAG)ORI_Gale_Knows_KarsiteWeave_22350fca-200a-bbf7-90ad-8d15168641f9,  "ORI_Avatar_Gale", "KarsiteWeave");
DB_QuestDef_State((FLAG)ORI_Gale_State_Met_ElminsterInWYR_82b0cbde-1d3b-1f67-86a8-d05744462209, "ORI_Avatar_Gale", "MeetElminsterCTY");
DB_QuestDef_State((FLAG)ORI_Gale_Quest_NoTolna_c105de73-0701-4289-95f4-f6c79cb85ba3, "ORI_Avatar_Gale", "NoTolna");
DB_QuestDef_State((FLAG)ORI_Gale_Quest_FindBook2_Accidental_20ddb12d-1ae4-46cd-80ad-363416d60d10, "ORI_Avatar_Gale", "FindBook2_Accidental");
DB_QuestDef_State((FLAG)ORI_Gale_Quest_FoundBook_3f0fc364-1d8b-4327-a234-d6623c698ec9, "ORI_Avatar_Gale", "FoundBook");
DB_QuestDef_State((FLAG)ORI_Gale_Quest_FindBook2_6202429c-e813-43bb-a431-040cc6214069, "ORI_Avatar_Gale", "FindBook2");
DB_QuestDef_State((FLAG)LOW_SorcerousSundries_State_GotVaultHint_e912c718-92e7-27bd-fd24-848e9d43f5dc, "ORI_Avatar_Gale", "TolnaDirectedOffice");
DB_QuestDef_State((FLAG)ORI_Gale_Quest_TolnaRefusedVault_bfa16247-9659-6d16-a999-06667134b492, "ORI_Avatar_Gale", "TolnaRefusedVault");
DB_QuestDef_State((FLAG)ORI_Gale_State_OpenedPouch_a533861d-a4f9-482a-8be2-7c9523df9c90, "ORI_Avatar_Gale", "OpenedPouch");
DB_QuestDef_State((FLAG)ORI_Gale_DeathNote_State_Open_6e3af093-fce9-fcb1-87ec-bd6c45788ac5, "ORI_Avatar_Gale", "GotScroll");
DB_QuestDef_State((FLAG)ORI_Gale_State_DestroyedPouch_5b7b8189-7b89-4cf5-a4a1-a80cc992a654, "ORI_Avatar_Gale", "DestroyedPouch");
DB_QuestDef_State((FLAG)LOW_SorcerousSundries_State_TolnaWarnedBooksNotForSaleOnce_6c76ca24-9373-f3ec-0621-801a4b2d70a6, "ORI_Avatar_Gale", "TolnaMentionedVault");

DB_ORI_Gale_MystraUpdate((FLAG)ORI_Gale_Quest_PromiseMystra_f8fbe426-fa11-4bf8-b4c1-913f4a82d371, "PromiseMystra", "ContractAfterPromisedMystra");
DB_ORI_Gale_MystraUpdate((FLAG)ORI_Gale_Quest_RefusedMystra_6e414e31-5d35-4416-8ac2-786e6451ee4e, "RefusedMystra", "ContractAfterRefusedMystra");
DB_ORI_Gale_MystraUpdate((FLAG)ORI_Gale_Quest_DelayedMystra_d749277f-942b-43b5-baa7-74fc4cdc9930, "DelayedMystra", "ContractAfterDelayedMystra");

DB_QuestDef_State((FLAG)LOW_SorcerousSundries_State_GotVaultHint_e912c718-92e7-27bd-fd24-848e9d43f5dc, "ORI_COM_Gale", "TolnaDirectedOffice");
DB_QuestDef_State((FLAG)ORI_Gale_Quest_TolnaRefusedVault_bfa16247-9659-6d16-a999-06667134b492, "ORI_COM_Gale", "TolnaRefusedVault");
DB_QuestDef_State((FLAG)ORI_Gale_Quest_FindBook_Tolna_bac7b8d2-22ca-d22e-715f-1d8b52b001a9, "ORI_COM_Gale", "FindBook_Tolna");
DB_QuestDef_State((FLAG)LOW_SorcerousSundries_State_TolnaWarnedBooksNotForSaleOnce_6c76ca24-9373-f3ec-0621-801a4b2d70a6, "ORI_COM_Gale", "TolnaMentionedVault");

DB_ORI_Gale_SearchVaultFlag((FLAG)ORI_Gale_Quest_FindBook2_Accidental_20ddb12d-1ae4-46cd-80ad-363416d60d10);
DB_ORI_Gale_SearchVaultFlag((FLAG)ORI_Gale_Quest_TeleportedVault_eeef2800-2e55-4e3b-b816-35fa583a9ca3);

DB_QuestDef_State_CompanionLeft(REALLY_GALE_9b0354c0-56d9-4723-8034-918ac9abab19, "ORI_COM_Gale", "ORI_Gale_AbandonedBombNotDisarmed");
DB_QuestDef_State_CompanionLeft(REALLY_GALE_9b0354c0-56d9-4723-8034-918ac9abab19, "ORI_COM_Gale", "ORI_Gale_BombNotDisarmed");

DB_ORI_Gale_FlagOnDialogEnd((FLAG)ORI_Gale_Event_LastNightAlive_Postpone_e35b00dc-29d6-b60b-e9d2-bb3b446d83ce, (FLAG)ORI_Gale_State_LastNightAlive_Postponed_c1788e86-d540-6332-7bb5-d7234aeaa770);
DB_ORI_Gale_FlagOnDialogEnd((FLAG)ORI_Gale_Event_BeMyGodDiscussion_Postpone_c172ca69-daf8-b1fe-2d81-dd77fae1ec6c, (FLAG)ORI_Gale_State_PostponedBeMyGodDiscussion_34fac8ad-14b8-f82a-bbbb-7aa65acd886b);


DB_ORI_Gale_SuicideSpell("Shout_END_Gale_ActivateNethereseOrb");
DB_ORI_Gale_SuicideSpell("Target_END_Gale_ActivateNethereseOrb");
KBSECTION
//REGION DEBUG
IF
TextEvent("gale_ignoregoalscore")
AND
NOT DB_DEBUG_Gale_IgnoreGoalScore(1)
THEN
DB_DEBUG_Gale_IgnoreGoalScore(1);
PROC_DEBUG_Gale_ClearGoalFlags();

PROC
PROC_DEBUG_Gale_ClearGoalFlags()
AND
DB_ORI_Gale_GoalFlag(_, _, _Flag)
THEN
ClearFlag(_Flag);

IF
TextEvent("gale_enablegoalscore")
AND
DB_DEBUG_Gale_IgnoreGoalScore(1)
THEN
NOT DB_DEBUG_Gale_IgnoreGoalScore(1);
//END_REGION

//REGION IPRDs - repeat if the relevant bits haven't been reached

IF
DB_RelationshipDialogsFinished((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Dialog, _Flag)
AND
DB_ORI_Gale_IPRDOverFlag(_Flag, _OverFlag)
AND
NOT DB_GlobalFlag(_OverFlag)
THEN
NOT DB_RelationshipDialogsFinished((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Dialog, _Flag);
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Dialog, _Flag, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

//END_REGION


//REGION Tara
PROC
PROC_CampNight_GaleTressym_ToCamp((INTEGER)_WillTeleport)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);
DB_Dialogs(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, (DIALOGRESOURCE)CAMP_Gale_Tressym_00706ce9-cbf7-95ee-912d-b42909b483a7);
PROC_ORI_SetupCamp((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _WillTeleport);
SetStoryDisplayName((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, "Gale_Tressym_Name");

IF
FlagSet((FLAG)ORI_Gale_Event_GiveTressymItem_cbc2a5b6-cc9d-4c9b-9e71-5f740e37bb8a, _, _)
THEN
SetOnStage(S_ORI_Gale_TressymItem_39fed5b1-1f0b-40d4-96bb-14bd45901c97, 1);
//END_REGION

//REGION Post-EA needing items

QRY
QRY_ORI_Gale_NeedsMoreMagicItems()
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307)
THEN
DB_NOOP(1);

//END_REGION

//REGION TGs

IF
FlagSet((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d, _, _)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag((FLAG)TG_ORI_Gale_ConsumedItem_d891c321-8124-a88d-0a88-fad59e3d2ce8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
FlagSet((FLAG)ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d, _, _)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars(_Avatar)
THEN
SetFlag((FLAG)TG_ORI_Gale_ConsumedItem_d891c321-8124-a88d-0a88-fad59e3d2ce8, _Avatar, 0);

IF
FlagSet((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, _, _)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag((FLAG)TG_ORI_Gale_ConsumedItem_d891c321-8124-a88d-0a88-fad59e3d2ce8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
FlagSet((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, _, _)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars(_Avatar)
THEN
SetFlag((FLAG)TG_ORI_Gale_ElminsterVisit_702a96d6-192a-00b6-5e9b-bd5bd46bd7c8, _Avatar, 0);

IF
Resurrected((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_GlobalFlag(Gale_DeathVoice_KnowProtocol_d40c7790-7dd7-6e76-df72-81d8e7cdcf23)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(TG_ORI_GaleResurrected_6b24c954-9738-4c47-8995-5a701cb25378, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

//END_REGION

//REGION Death State ends

IF
FlagSet(ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, _, _)
THEN
AddSpell(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "Target_END_Gale_ActivateNethereseOrb", 1, 0);
SetTag(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, ORI_GALE_BOMBDISARMED_f37724b5-9235-4ab2-8d65-78efcf50f95b);
PROC_ORI_Gale_DisableDeathEffect();

IF
CastedSpell(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Spell, _, _, _)
AND
DB_ORI_Gale_SuicideSpell(_Spell)
AND
NOT QRY_ORI_Gale_InterruptOrbGameOver()
THEN
SetFlag((FLAG)ORI_Gale_Event_CommittedSuicide_78354925-1f86-8675-5bd0-11dbf09193a1, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_ORI_Gale_Explosion();

QRY
QRY_ORI_Gale_InterruptOrbGameOver()
AND
1 == 0
THEN
DB_NOOP(1);

//END_REGION


//REGION Check if Gale is an Avatar

IF
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag((FLAG)ORI_Gale_State_IsAvatar_578ee9d2-a8eb-b44f-c39a-7a16a82dd023, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag((FLAG)ORI_Gale_State_IsAvatar_578ee9d2-a8eb-b44f-c39a-7a16a82dd023)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
ClearFlag((FLAG)ORI_Gale_State_IsAvatar_578ee9d2-a8eb-b44f-c39a-7a16a82dd023, NULL_00000000-0000-0000-0000-000000000000, 0);


//END_REGION

//REGION If Tara dies


IF
KilledBy((CHARACTER)S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _Player, _, _)
AND
QRY_ORI_Gale_TaraRecognised()
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
SetFlag(ORI_Gale_State_TaraKiller_08844f2a-aab5-4d93-b810-e952d24d76b7, _Player, 0);

QRY
QRY_ORI_Gale_TaraRecognised()
AND
DB_Is_InCombat(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _ID)
AND
DB_Is_InCombat(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _ID)
THEN
PROC_ORI_Gale_ReactTaraDeath();

QRY
QRY_ORI_Gale_TaraRecognised()
AND
CanSee((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 1)
THEN
PROC_ORI_Gale_ReactTaraDeath();

PROC
PROC_ORI_Gale_ReactTaraDeath()
AND
NOT DB_OnlyOnce("ORI_Gale_ReactTaraDeath")
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)ORI_Gale_TaraKilled_AD_2b71a795-464a-d564-23eb-47b6f1a8b44b, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);


//END_REGION

//REGION Gale - endgame decision calculation

IF
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_ORI_Gale_GoalScore(_, _)
THEN
DB_ORI_Gale_GoalScore(0, 0);
DB_ORI_Gale_GoalScore(1, 3); //Gale starts out with no desire to die, and some eagerness to use the Crown.

IF
DB_ORI_Gale_ChangeGoal(_Index, 1, _Flag, _)
AND
DB_Negate(_Index, _AntiIndex)
THEN
DB_ORI_Gale_ChangeGoal(_AntiIndex, -1, _Flag, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(_Flag, _Character, _)
AND
NOT DB_DEBUG_Gale_IgnoreGoalScore(1)
AND
DB_ORI_Gale_ChangeGoal(_Index, _Delta, _Flag, _)
AND
DB_ORI_Gale_GoalScore(_Index, _CurrentScore)
AND
IntegerSum(_CurrentScore, _Delta, _NewScore)
THEN
NOT DB_ORI_Gale_GoalScore(_Index, _CurrentScore);
DB_ORI_Gale_GoalScore(_Index, _NewScore);
ClearFlag(_Flag, _Character, 0);

IF
FlagSet(_Flag, _Character, _)
AND
NOT DB_DEBUG_Gale_IgnoreGoalScore(1)
AND
DB_ORI_Gale_ChangeGoal(_, _, _Flag, _HappenedFlag)
AND
_HappenedFlag != NULL_00000000-0000-0000-0000-000000000000
THEN
SetFlag(_HappenedFlag, _Character, 0);

IF
DB_ORI_Gale_GoalScore(_Index, _Score)
AND
NOT DB_DEBUG_Gale_IgnoreGoalScore(1)
AND
DB_ORI_Gale_GoalFlag(_Index, _Threshold, _Flag)
AND
_Score >= _Threshold
AND
NOT DB_GlobalFlag(_Flag)
THEN
PROC_GlobalSetFlagAndCache(_Flag);

IF
DB_ORI_Gale_GoalScore(_Index, _Score)
AND
NOT DB_DEBUG_Gale_IgnoreGoalScore(1)
AND
DB_ORI_Gale_GoalFlag(_Index, _Threshold, _Flag)
AND
_Score < _Threshold
AND
DB_GlobalFlag(_Flag)
THEN
PROC_GlobalClearFlagAndCache(_Flag);

IF
FlagSet(ORI_Gale_Event_ForceSetUnwillingToDie_5b3fd6a1-0942-42c1-9913-90efa3588315, _, _)
AND
DB_ORI_Gale_GoalForceFlag(_Index, _NewScore, _Flag)
AND
DB_ORI_Gale_GoalScore(_Index, _CurrentScore)
THEN
NOT DB_ORI_Gale_GoalScore(_Index, _CurrentScore);
DB_ORI_Gale_GoalScore(_Index, _NewScore);
ClearFlag(ORI_Gale_Event_ForceSetUnwillingToDie_5b3fd6a1-0942-42c1-9913-90efa3588315, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION


PROC
PROC_ORI_Gale_ConsumedMagicItem()
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotTwoMagicItems_c757086e-4696-441d-b19c-fdb65982776f)
THEN
SetFlag((FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307);
SetTag(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (TAG)ORI_GALE_BOMBDISARMED_f37724b5-9235-4ab2-8d65-78efcf50f95b);

//REGION Gale reacts to an Avatar talking to his Tressym

IF
DB_DialogSpeakers(_ID, _Avatar, _)
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
DB_ORI_Partnered(_Avatar, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_DialogSpeakers(_ID, S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _)
AND
QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_DiscussedTressymEncounter_e1b72019-f2b1-bbeb-8190-20756fb3f55d)
THEN
SetFlag(ORI_Gale_State_MetTressym_d794b24d-b68b-441c-a405-4dded461b1a3, _Avatar, 0);
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_MetTressym_f07a0073-f70e-0ddb-1f64-1701d6369cf8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);


QRY
QRY_SelectCustomDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
AND
DB_Avatars((CHARACTER)_Avatar)
AND
DB_HandlingRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (FLAG)ORI_Gale_IPRD_MetTressym_f07a0073-f70e-0ddb-1f64-1701d6369cf8, _, _, _)
AND
QRY_SameUser((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
AND
GetFlag(ORI_Gale_State_MetTressym_d794b24d-b68b-441c-a405-4dded461b1a3, _Avatar, 0)
THEN
DB_SelectedDialog(GLO_AD_NonBondedCompanionDialog_62ba7c46-8d22-c591-f04c-2e99441cd02a, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);


//END_REGION

//REGION Gale consuming magic items - mark objects

IF
TagSet(_Item, (TAG)ORI_GALE_CONSUMABLEARTEFACT_7b96246c-54ba-43ea-b01d-4e0b20ad35f1)
AND
NOT QRY_ORI_Gale_UninterestedInMagicItems()
THEN
DB_ORI_Gale_Consumables(_Item);

IF
TagCleared(_Item, (TAG)ORI_GALE_CONSUMABLEARTEFACT_7b96246c-54ba-43ea-b01d-4e0b20ad35f1)
AND
DB_ORI_Gale_Consumables(_Item)
THEN
NOT DB_ORI_Gale_Consumables(_Item);

//Reasons why he wouldn't be interested.
QRY
QRY_ORI_Gale_UninterestedInMagicItems()
AND
DB_PermaDefeated(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_UninterestedInMagicItems()
AND
DB_GlobalFlag((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_UninterestedInMagicItems()
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307)
THEN
DB_NOOP(1);

//Clean up DB when he isn't interested.
IF
DB_ORI_Gale_Consumables(_Item)
AND
DB_PermaDefeated(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
NOT DB_ORI_Gale_Consumables(_Item);

IF
DB_ORI_Gale_Consumables(_Item)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c)
THEN
NOT DB_ORI_Gale_Consumables(_Item);

IF
DB_ORI_Gale_Consumables(_Item)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307)
THEN
NOT DB_ORI_Gale_Consumables(_Item);

//Apply status to tracked items while Gale is interested in magic items.
IF
DB_ORI_Gale_Consumables(_Item)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_ORI_Gale_ConsumableMarkedObject(_Item)
AND
Exists(_Item, 1)
THEN
ApplyStatus(_Item, "ORI_GALE_CONSUMABLE", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_ORI_Gale_Consumables(_Item)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
AND
NOT DB_ORI_Gale_ConsumableMarkedObject(_Item)
AND
Exists(_Item, 1)
THEN
ApplyStatus(_Item, "ORI_GALE_CONSUMABLE", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
LevelLoaded(_)
AND
DB_ORI_Gale_Consumables(_Item)
AND
QRY_ORI_Gale_PlayersKnowWantsMagicItem()
AND
NOT DB_ORI_Gale_ConsumableMarkedObject(_Item)
AND
Exists(_Item, 1)
THEN
ApplyStatus(_Item, "ORI_GALE_CONSUMABLE", -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(_Object, "ORI_GALE_CONSUMABLE", _, _)
THEN
DB_ORI_Gale_ConsumableMarkedObject(_Object);

IF
FlagSet((FLAG)ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, _, _)
AND
DB_ORI_Gale_ConsumableMarkedObject(_Item)
AND
Exists(_Item, 1)
THEN
RemoveStatus(_Item, "ORI_GALE_CONSUMABLE", NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((FLAG)ORI_Gale_State_GotThreeMagicItems_484d97f2-5c79-a557-0635-fbf81e8c0307, _, _)
AND
DB_ORI_Gale_ConsumableMarkedObject(_Item)
AND
Exists(_Item, 1)
THEN
RemoveStatus(_Item, "ORI_GALE_CONSUMABLE", NULL_00000000-0000-0000-0000-000000000000);

IF
LevelLoaded(_)
AND
DB_ORI_Gale_ConsumableMarkedObject(_Item)
AND
QRY_ORI_Gale_UninterestedInMagicItems()
AND
Exists(_Item, 1)
THEN
RemoveStatus(_Item, "ORI_GALE_CONSUMABLE", NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved(_Item,  "ORI_GALE_CONSUMABLE", _, _)
THEN
NOT DB_ORI_Gale_ConsumableMarkedObject(_Item);

QRY
QRY_ORI_Gale_PlayersKnowWantsMagicItem()
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_PlayersKnowWantsMagicItem()
AND
DB_GlobalFlag((FLAG)ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735)
THEN
DB_NOOP(1);

//END_REGION

//REGION Gale comments on Incubus underwear
PROC
PROC_DialogFlagSetup((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _, _Player)
AND
NOT DB_OnlyOnce("ORI_Gale_Event_WoreIncubusUnderwear")
AND
QRY_ORI_Gale_WearingOnlyIncubusUnderwear((CHARACTER)_Player)
THEN
SetFlag((FLAG)ORI_Gale_State_WearingIncubusUnderwear_057df7e4-19ca-e0b1-bc8d-63a8784a4a2c, _Player, 0);

IF
DialogEnded((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _ID)
AND
DB_DialogSpeakers(_ID, _Player, 2)
THEN
ClearFlag((FLAG)ORI_Gale_State_WearingIncubusUnderwear_057df7e4-19ca-e0b1-bc8d-63a8784a4a2c, _Player, 0);

QRY
QRY_ORI_Gale_WearingOnlyIncubusUnderwear((CHARACTER)_Player)
AND
QRY_ORI_Gale_WearingIncubusUnderwear((CHARACTER)_Player)
AND
NOT QRY_ORI_Gale_UnderwearInvisible((CHARACTER)_Player)
THEN
DB_OnlyOnce("ORI_Gale_Event_WoreIncubusUnderwear");

QRY
QRY_ORI_Gale_WearingIncubusUnderwear((CHARACTER)_Player)
AND
GetEquippedItem(_Player, "Underwear", _Item)
AND
GetTemplate(_Item, _Root)
AND
DB_ORI_Gale_IncubusUnderwear(_Root)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_UnderwearInvisible((CHARACTER)_Player)
AND
QRY_GetArmourSet(_Player)
AND
DB_QRYRTN_GetArmourSet(ARMOURSET.Normal)
AND
GetEquippedItem(_Player, "Breast", _Item)
AND
_Item != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_UnderwearInvisible((CHARACTER)_Player)
AND
QRY_GetArmourSet(_Player)
AND
DB_QRYRTN_GetArmourSet(ARMOURSET.Vanity)
AND
GetEquippedItem(_Player, "VanityBody", _Item)
AND
_Item != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_NOOP(1);


//END_REGION

//REGION Tara flies off in a huff

IF
DialogEnded((DIALOGRESOURCE)CAMP_Gale_Tressym_00706ce9-cbf7-95ee-912d-b42909b483a7, _)
AND
DB_GlobalFlag((FLAG)CAMP_Gale_Tressym_Event_FlyOff_38725547-4917-b375-f825-4f7a390c78d4)
THEN
DB_ORI_Gale_Tara_Disappearing(1);
SetHasDialog(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
CharacterDisableAllCrimes(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);
PROC_ORI_Gale_Tara_CheckPlayersInCamp();
SetDetached(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 1);
PROC_SetInvulnerable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 1);
PlayAnimation(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236,CUST_FlyAway_01_8c213e7c-ae64-4dab-b254-af09e8e9c0d1, "GLO_Gale_Tressym_Disappeared");
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236);
ClearFlag(CAMP_Gale_Tressym_Event_FlyOff_38725547-4917-b375-f825-4f7a390c78d4);

IF
EntityEvent(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, "GLO_Gale_Tressym_Disappeared")
AND
NOT DB_ORI_Gale_Tara_DisappearingInterrupted(1)
THEN
DB_ORI_Gale_Tara_Disappearing(1);
SetOnStage(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
PROC_ORI_Gale_Tara_CheckPlayersInCamp();
DB_ORI_Gale_Tara_Disappeared(1);

IF
EntityEvent(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, "GLO_Gale_Tressym_Disappeared")
AND
DB_ORI_Gale_Tara_DisappearingInterrupted(1)
THEN
NOT DB_ORI_Gale_Tara_DisappearingInterrupted(1);
SetDetached(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
PROC_SetInvulnerable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
SetOnStage(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 1);
PROC_CampNight_GaleTressym_ToCamp(1);

PROC
PROC_ORI_Gale_Tara_CheckPlayersInCamp()
AND
DB_Players(_Character)
AND
DB_InCamp(_Character)
THEN
DB_ORI_Gale_Tara_InCampPlayers(_Character);

IF
DB_ORI_Gale_Tara_InCampPlayers(_Character)
AND
NOT DB_Players(_Character)
THEN
NOT DB_ORI_Gale_Tara_InCampPlayers(_Character);

IF
DB_ORI_Gale_Tara_InCampPlayers(_Character)
AND
NOT DB_InCamp(_Character)
THEN
NOT DB_ORI_Gale_Tara_InCampPlayers(_Character);

IF
DB_ORI_Gale_Tara_Disappeared(1)
AND
DB_Players(_Character)
AND
DB_InCamp(_Character)
THEN
DB_ORI_Gale_Tara_InCampPlayers(_Character);

IF
DB_ORI_Gale_Tara_Disappeared(1)
AND
NOT DB_ORI_Gale_Tara_InCampPlayers(_)
THEN
NOT DB_ORI_Gale_Tara_Disappeared(1);
SetDetached(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
PROC_SetInvulnerable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
SetOnStage(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 1);
PROC_CampNight_GaleTressym_ToCamp(1);

PROC
PROC_Camp_SetModeToDay()
AND
DB_ORI_Gale_Tara_Disappeared(1)
THEN
NOT DB_ORI_Gale_Tara_Disappeared(1);
SetDetached(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
PROC_SetInvulnerable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
SetOnStage(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 1);
PROC_CampNight_GaleTressym_ToCamp(1);

PROC
PROC_Camp_SetModeToDay()
AND
DB_ORI_Gale_Tara_Disappearing(1)
THEN
NOT DB_ORI_Gale_Tara_Disappearing(1);
StopAnimation(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 1);
DB_ORI_Gale_Tara_DisappearingInterrupted(1);

PROC
PROC_Camp_SetModeToNight()
AND
DB_ORI_Gale_Tara_Disappeared(1)
THEN
NOT DB_ORI_Gale_Tara_Disappeared(1);
SetDetached(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
PROC_SetInvulnerable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 0);
SetOnStage(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 1);
PROC_CampNight_GaleTressym_ToCamp(1);

PROC
PROC_Camp_SetModeToNight()
AND
DB_ORI_Gale_Tara_Disappearing(1)
THEN
NOT DB_ORI_Gale_Tara_Disappearing(1);
StopAnimation(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, 1);
DB_ORI_Gale_Tara_DisappearingInterrupted(1);

//END_REGION

//REGION Gale consumes magic item from inventory - Companion.

IF
DB_ORI_Gale_Companion_AteMagicItemIPRDs(_, _Flag)
THEN
DB_ExclamationDialog_NeverStop((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _Flag);
DB_RelationshipDialog_WRD_TriggerInCamp((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _Flag);

PROC
PROC_ORI_Gale_ConsumedMagicItem()
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_OnlyOnce_Reset("ORI_Gale_AteMagicItemIPRDs")
AND
DB_ORI_Gale_Companion_AteMagicItemIPRDs(_Flag, _IRPDFlag)
AND
GetFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
QRY_OnlyOnce("ORI_Gale_AteMagicItemIPRDs")
THEN
PROC_ORI_Gale_QueueAteMagicItemIPRDs(_IRPDFlag);
NOT DB_ORI_Gale_Companion_AteMagicItemIPRDs(_Flag, _IRPDFlag);

PROC
PROC_ORI_Gale_ConsumedMagicItem()
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_ORI_Gale_TradingMagicItem(_Character, _)
AND
ChangeApprovalRating((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)_Character, 0, 10, _)
THEN
DB_NOOP(1);

PROC
PROC_ORI_Gale_ConsumedMagicItem()
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_ORI_Gale_TradingMagicItem(_, _)
AND
DB_Avatars(_Avatar)
AND
QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
ChangeApprovalRating((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)_Avatar, 0, 10, _)
THEN
DB_NOOP(1);


PROC
PROC_ORI_Gale_QueueAteMagicItemIPRDs((FLAG)_IRPDFlag)
AND
NOT DB_InteractiveDialogSpeaker(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IRPDFlag, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);
DB_RelationshipDialog_Autostart((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IRPDFlag);

PROC
PROC_ORI_Gale_QueueAteMagicItemIPRDs((FLAG)_IRPDFlag)
AND
NOT DB_InteractiveDialogSpeaker(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_Camp_NightMode(1)
THEN
DB_RelationshipDialog_Autostart((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IRPDFlag);

PROC
PROC_ORI_Gale_QueueAteMagicItemIPRDs((FLAG)_IRPDFlag)
AND
NOT DB_InteractiveDialogSpeaker(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Camp_NightMode(1)
AND
DB_Players((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_OnlyOnce_Reset("ORI_Gale_TryNightStartAteMagicIPRD")
AND
DB_Avatars(_Avatar)
AND
IsControlled(_Avatar, 1)
AND
QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SpeakerIsInDialogRange(_Avatar, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_StartDialog((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
THEN
DB_OnlyOnce("ORI_Gale_TryNightStartAteMagicIPRD");
SetFlag(_IRPDFlag, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

PROC
PROC_ORI_Gale_QueueAteMagicItemIPRDs((FLAG)_IRPDFlag)
AND
NOT DB_InteractiveDialogSpeaker(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Camp_NightMode(1)
AND
DB_Players((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT DB_OnlyOnce("ORI_Gale_TryNightStartAteMagicIPRD")
AND
DB_Avatars(_Avatar)
AND
IsControlled(_Avatar, 0)
AND
QRY_SameUser(_Avatar, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_SpeakerIsInDialogRange(_Avatar, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
QRY_StartDialog((DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Avatar)
THEN
DB_OnlyOnce("ORI_Gale_TryNightStartAteMagicIPRD");
SetFlag(_IRPDFlag, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

PROC
PROC_ORI_Gale_QueueAteMagicItemIPRDs((FLAG)_IRPDFlag)
AND
DB_InteractiveDialogSpeaker(_ID, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_ORI_Gale_AteMagicItemIRPD_DelayUntilDialogEnd(_IRPDFlag, _ID);

IF
DialogEnded(_, _ID)
AND
DB_ORI_Gale_AteMagicItemIRPD_DelayUntilDialogEnd(_IRPDFlag, _ID)
THEN
PROC_RelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IRPDFlag, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
FlagSet(_CancelFlag, _, _)
AND
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag(_IPRDFlag, _CancelFlag)
AND
DB_ORI_Gale_AteMagicItemIRPD_DelayUntilDialogEnd(_IRPDFlag, _ID)
THEN
NOT DB_ORI_Gale_AteMagicItemIRPD_DelayUntilDialogEnd(_IRPDFlag, _ID);

IF
FlagSet(_CancelFlag, _, _)
AND
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag(_IPRDFlag, _CancelFlag)
THEN
PROC_CancelRelationshipDialog((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (DIALOGRESOURCE)Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, _IPRDFlag);
NOT DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag(_IPRDFlag, _CancelFlag);

//END_REGION


IF
TadpolePowerAssigned((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
THEN
SetFlag(ORI_Gale_State_HasTadpolePowers_74cb9768-43ce-41f6-b4a4-829dbf996fe5, NULL_00000000-0000-0000-0000-000000000000, 0);

//REGION Quest Update

IF
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
QuestUpdate((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "Start");

//END_REGION


//REGION Gale explodes dialogue

PROC
PROC_ORI_Gale_Explosion()
AND
NOT QRY_Gale_PreventGameOver()
AND
QRY_Gale_BuildGaleExplosionSpeakerList()
AND
NOT DB_ORI_Gale_Teleporting(1)
AND
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(1, _Speaker1)
AND
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(2, _Speaker2)
AND
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(3, _Speaker3)
AND
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(4, _Speaker4)
AND
QRY_ORI_Gale_Explosion_SetDialogDeath(_Speaker1)
AND
NOT QRY_StartDialogCustom_Fixed(Gale_Explosion_120fa809-81a9-79da-1d2b-4acf31ec602e, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Speaker1, _Speaker2, _Speaker3, _Speaker4, 0, 0, 0, 0)
THEN
ShowGameOverMenu();

QRY
QRY_ORI_Gale_Explosion_SetDialogDeath((GUIDSTRING)_Speaker1)
THEN
DB_DialogDeath((CHARACTER)_Speaker1); //Just in case Speaker 1 is also dead.
DB_DialogDeath((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

QRY
QRY_Gale_PreventGameOver()
AND
1 == 0
THEN
DB_NOOP(1);

IF
DialogEnded(Gale_Explosion_120fa809-81a9-79da-1d2b-4acf31ec602e, _)
THEN
ShowGameOverMenu();

//If this gets changed, look into using UnpackDB
QRY
QRY_Gale_BuildGaleExplosionSpeakerList()
AND
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(_I, _Speaker)
THEN
NOT DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(_I, _Speaker);

QRY
QRY_Gale_BuildGaleExplosionSpeakerList()
AND
DB_CurrentLevel(_Level)
AND
GetRegion(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _GaleLevel)
AND
_GaleLevel != _Level
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Gale_State_OtherLevel_25036f69-3877-c0a8-d7e9-bb837a119fbc);

QRY
QRY_Gale_BuildGaleExplosionSpeakerList()
AND
QRY_DoNTimes(4)
AND
DB_QRY_RTN_DoNTimes(_I)
AND
NOT QRY_Gale_BuildGaleExplosionSpeaker(_I)
THEN
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(_I, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(_, _Player)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_OtherLevel_25036f69-3877-c0a8-d7e9-bb837a119fbc)
AND //Recheck if still in other level.
DB_CurrentLevel(_Level)
AND
GetRegion(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _GaleLevel)
AND
_GaleLevel != _Level
AND
NOT DB_ORI_Gale_Teleporting(1)
AND
_Player != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_ORI_Gale_Teleporting(1);
SetOnStage(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);
TeleportTo(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Player, "ORI_Gale_PostDeathTeleport");

QRY
QRY_Gale_BuildGaleExplosionSpeakerList()
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_OtherLevel_25036f69-3877-c0a8-d7e9-bb837a119fbc)
AND
DB_MiniCampTrigger("WLDUND", _Trigger)
AND
IsInTrigger(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Trigger, 1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)ORI_Gale_State_UNDDeath_6198e28a-643f-0783-876e-49a7cb84c746);

QRY
QRY_Gale_BuildGaleExplosionSpeaker(1)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_OtherLevel_25036f69-3877-c0a8-d7e9-bb837a119fbc)
AND
DB_Players(_Player)
AND
_Player != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
NOT DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(_, _Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Player, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
NOT QRY_ORI_Gale_GaleExplosionSpeakerUnavailable(1, _Player)
THEN
SetFlag((FLAG)ORI_Gale_State_PlayerAvailableForDeath_56175253-c303-c80d-f00c-c41acc6d790b, _Player, 0);
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(1, _Player);

QRY
QRY_Gale_BuildGaleExplosionSpeaker(_I)
AND
DB_Players(_Player)
AND
_Player != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
NOT QRY_ORI_Gale_GaleExplosionSpeakerUnavailable(_I, _Player)
THEN
PROC_ForceStopDialog(_Player);
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(_I, _Player);

QRY
QRY_ORI_Gale_GaleExplosionSpeakerUnavailable((INTEGER)_I, (CHARACTER)_Player)
AND
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(_, _Player)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_GaleExplosionSpeakerUnavailable((INTEGER)_I, (CHARACTER)_Player)
AND
DB_QRYRTN_Gale_BuildGaleExplosionSpeakerList(_I, _) 
THEN
DB_NOOP(1);

//END_REGION

//REGION Markers that point to Gale
IF
EnteredLevel(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _Level)
THEN
MapMarkerChangeLevel("ORI_Gale_Companion", _Level);
//END_REGION

//REGION Track if Gale is single

IF
FlagSet((FLAG)ORI_State_Dating_a3346d5b-c54b-4c73-bf18-0a2bf90c35da, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
THEN
SetFlag(ORI_Gale_State_Dating_6e5dc80a-db14-4659-a790-e81aa6490307, NULL_00000000-0000-0000-0000-000000000000, 0);
ClearFlag(ORI_Gale_State_NotDating_21f19438-754d-4ad2-883e-fd3f8814b917, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagCleared((FLAG)ORI_State_Dating_a3346d5b-c54b-4c73-bf18-0a2bf90c35da, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _)
THEN
ClearFlag(ORI_Gale_State_Dating_6e5dc80a-db14-4659-a790-e81aa6490307, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(ORI_Gale_State_NotDating_21f19438-754d-4ad2-883e-fd3f8814b917, NULL_00000000-0000-0000-0000-000000000000, 0);

//END_REGION

//REGION Journal

IF
FlagSet(_Flag, _, _)
AND
DB_ORI_Gale_MystraUpdate(_Flag, _Update, _)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Journal)
THEN
PROC_ORI_Gale_MystraUpdate(_Character, _Journal, _Update);


IF
FlagSet(GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc, _, _)
AND
DB_ORI_Gale_MystraUpdate(_Flag, _, _Update)
AND
DB_GlobalFlag(_Flag)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
THEN
QuestUpdate(_Character, _Quest, _Update);

QRY
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Journal)
THEN
NOT DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Journal);

QRY
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
DB_QRYRTN_Gale_JournalUpdateCandidate((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale");

QRY
QRY_ORI_Gale_JournalUpdateCandidate()
AND
NOT DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
DB_Avatars(_Avatar)
THEN
DB_QRYRTN_Gale_JournalUpdateCandidate((CHARACTER)_Avatar, "ORI_COM_Gale");

PROC
PROC_ORI_Gale_MystraUpdate((CHARACTER)_Character, (STRING)_Quest, (STRING)_Update)
THEN
QuestUpdate(_Character, _Quest, _Update);

PROC
PROC_ORI_Gale_MystraUpdate((CHARACTER)_Character, (STRING)_Quest, (STRING)_Update)
AND
DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
NOT DB_GlobalFlag(LOW_HouseOfHope_State_ContractIsDestroyed_1a51a77c-d549-4d50-95df-97ab9d1ef9f6)
THEN
QuestUpdate(_Character, _Quest, "MystraWithContract");

IF
FlagSet((FLAG)WYR_RaphaelTango_Knows_WantsCrown_bb036e77-187b-f44d-9b26-8abc004bd9f6, _, _ID)
THEN
DB_ORI_Gale_LearnedRaphaelWantsCrown(_ID);

IF
DialogEnded(_, _ID)
AND
DB_ORI_Gale_LearnedRaphaelWantsCrown(_ID)
AND
NOT DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
AND
DB_ORI_Gale_MystraUpdate(_Flag, _, _)
AND
DB_GlobalFlag(_Flag)
THEN
QuestUpdate(_Character, _Quest, "NoContractAfterMystra");

IF
FlagSet(LOW_HouseOfHope_State_ContractIsDestroyed_1a51a77c-d549-4d50-95df-97ab9d1ef9f6, _, _)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
AND
DB_ORI_Gale_MystraUpdate(_Flag, _, _)
AND
DB_GlobalFlag(_Flag)
THEN
QuestUpdate(_Character, _Quest, "DestroyedContract");

IF
FlagSet((FLAG)ORI_Gale_Knows_BrainHasCrownOfKarsus_FromRaphael_4451456b-6f9b-7de2-9fae-68fc5a86f9d9, _, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_BrainHasCrownOfKarsus_e456f90c-13ac-4f79-b7b1-e21db1800fe4)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
THEN
QuestUpdate(_Character, _Quest, "FindBook_Raphael");

IF
FlagSet((FLAG)ORI_Gale_Knows_BrainHasCrownOfKarsus_e456f90c-13ac-4f79-b7b1-e21db1800fe4 , _, _)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Knows_BrainHasCrownOfKarsus_FromRaphael_4451456b-6f9b-7de2-9fae-68fc5a86f9d9)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
THEN
QuestUpdate(_Character, _Quest, "FindBook_Raphael");

IF
DB_GlobalFlag((FLAG)ORI_Gale_Quest_TeleportedVault_eeef2800-2e55-4e3b-b816-35fa583a9ca3)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_GotVaultHint_e912c718-92e7-27bd-fd24-848e9d43f5dc)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_OpenedPortal_3500399d-ca3b-4e3f-bae4-befc600a0a5d)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_FoundBook_3f0fc364-1d8b-4327-a234-d6623c698ec9)
AND
NOT DB_ORI_Gale_EnteredOffice(1)
THEN
PROC_ORI_Gale_JournalUpdate("TeleportedToVault1");


IF
DB_GlobalFlag((FLAG)ORI_Gale_Quest_TeleportedVault_eeef2800-2e55-4e3b-b816-35fa583a9ca3)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df)
AND
DB_Avatars((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
THEN
QuestUpdate((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "TeleportedToVault2");

IF
DB_GlobalFlag((FLAG)ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_GotVaultHint_e912c718-92e7-27bd-fd24-848e9d43f5dc)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_TeleportedVault_eeef2800-2e55-4e3b-b816-35fa583a9ca3)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_OpenedPortal_3500399d-ca3b-4e3f-bae4-befc600a0a5d)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_FoundBook_3f0fc364-1d8b-4327-a234-d6623c698ec9)
THEN
DB_OneShotPartyTrigger(S_ORI_Gale_TolnaOffice_1f835834-46e1-4e7f-8afd-2e85935ac488);

PROC
PROC_OneShotTriggerEntered(_, S_ORI_Gale_TolnaOffice_1f835834-46e1-4e7f-8afd-2e85935ac488)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
THEN
DB_ORI_Gale_EnteredOffice(1);
QuestUpdate(_Character, _Quest, "EnteredOffice");

PROC
PROC_LOW_SorcerousSundries_ActivateBasementRoute()
THEN
SetFlag(ORI_Gale_Quest_OpenedPortal_3500399d-ca3b-4e3f-bae4-befc600a0a5d, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_RemoveOneShotTrigger(S_ORI_Gale_TolnaOffice_1f835834-46e1-4e7f-8afd-2e85935ac488);

IF
DB_GlobalFlag(ORI_Gale_Quest_OpenedPortal_3500399d-ca3b-4e3f-bae4-befc600a0a5d)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_TeleportedVault_eeef2800-2e55-4e3b-b816-35fa583a9ca3)
AND
DB_GlobalFlag((FLAG)ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df)
AND
DB_GlobalFlag((FLAG)LOW_SorcerousSundries_State_GotVaultHint_e912c718-92e7-27bd-fd24-848e9d43f5dc)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_FoundBook_3f0fc364-1d8b-4327-a234-d6623c698ec9)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Journal)
THEN
QuestUpdate(_Character, _Journal, "OpenedPortal");
PROC_RemoveOneShotTrigger(S_ORI_Gale_TolnaOffice_1f835834-46e1-4e7f-8afd-2e85935ac488);
DB_ORI_Gale_SearchVaultFlag((FLAG)ORI_Gale_Quest_OpenedPortal_3500399d-ca3b-4e3f-bae4-befc600a0a5d);

IF
DB_GlobalFlag(_Flag)
AND
DB_ORI_Gale_SearchVaultFlag(_Flag)
THEN
DB_ORI_Gale_SearchingVault(1);

IF
GameBookInterfaceClosed(BOOK_LOW_SorcerousSundries_SorcerousBasementMystrylVaultHint_001_e66c8178-c987-4724-a21f-a76191b5a9a4, _Character)
THEN
SetFlag(ORI_Gale_Quest_ReadVaultPath_2d329a79-0465-4e13-84d0-056efeac45c5, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_ORI_Gale_SearchingVault(1)
AND
DB_GlobalFlag(ORI_Gale_Quest_ReadVaultPath_2d329a79-0465-4e13-84d0-056efeac45c5)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_FoundBook_3f0fc364-1d8b-4327-a234-d6623c698ec9)
AND
QRY_OnlyOnce("ORI_Gale_ReadVaultPath")
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Journal)
THEN
QuestUpdate(_Character, _Journal, "BookHintPath");

IF
DialogEnded(_Dialog, _)
AND
DB_ORI_Gale_DeathVoiceDialogs(_Dialog)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
AND
QuestUpdateIsUnlocked(_Character, _Quest, "LearnedMephit", 0)
THEN
QuestUpdate(_Character, _Quest, "PrematureProjectionEnd");

IF
GameBookInterfaceClosed(BOOK_LOW_SorcerousSundries_SorcerousBasementInvisibleLootHint_000_bf11de73-2ac6-4160-af0a-e588f79371ec, _Character)
THEN
SetFlag(ORI_Gale_Quest_ReadInvisibilityHint_cda4fbb5-e568-40f2-aecc-6c2ca0d54565, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DualEntityEvent(_, _Character, "LOW_RamazithsTower_TeleportedToSorcerousCellar")
AND
DB_PartyMembers((CHARACTER)_Character)
THEN
SetFlag(ORI_Gale_Quest_TeleportedVault_eeef2800-2e55-4e3b-b816-35fa583a9ca3, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(ORI_Gale_Quest_ReadInvisibilityHint_cda4fbb5-e568-40f2-aecc-6c2ca0d54565)
AND
NOT DB_ORI_Gale_SearchingVault(1)
AND
DB_GlobalFlag(LOW_SorcerousSundries_State_GotVaultHint_e912c718-92e7-27bd-fd24-848e9d43f5dc)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_FoundBook_3f0fc364-1d8b-4327-a234-d6623c698ec9)
AND
QRY_OnlyOnce("BookHintInvisibility")
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
THEN
QuestUpdate(_Character, _Quest, "BookHintInvisibility3");

IF
DB_GlobalFlag(ORI_Gale_Quest_ReadInvisibilityHint_cda4fbb5-e568-40f2-aecc-6c2ca0d54565)
AND
NOT DB_ORI_Gale_SearchingVault(1)
AND
DB_GlobalFlag(LOW_SorcerousSundries_State_GotVaultHint_e912c718-92e7-27bd-fd24-848e9d43f5dc)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_FoundBook_3f0fc364-1d8b-4327-a234-d6623c698ec9)
AND
QRY_OnlyOnce("BookHintInvisibility")
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
THEN
QuestUpdate(_Character, _Quest, "BookHintInvisibility3");

IF
DB_GlobalFlag(ORI_Gale_Quest_ReadInvisibilityHint_cda4fbb5-e568-40f2-aecc-6c2ca0d54565)
AND
DB_ORI_Gale_SearchingVault(1)
AND
DB_GlobalFlag(ORI_Gale_Quest_ReadVaultPath_2d329a79-0465-4e13-84d0-056efeac45c5)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_FoundBook_3f0fc364-1d8b-4327-a234-d6623c698ec9)
AND
DB_GlobalFlag((FLAG)ORI_Gale_Quest_ReadVaultPath_2d329a79-0465-4e13-84d0-056efeac45c5)
AND
QRY_OnlyOnce("BookHintInvisibility")
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
THEN
QuestUpdate(_Character, _Quest, "BookHintInvisibility2");

IF
DB_GlobalFlag(ORI_Gale_Quest_ReadInvisibilityHint_cda4fbb5-e568-40f2-aecc-6c2ca0d54565)
AND
DB_ORI_Gale_SearchingVault(1)
AND
DB_GlobalFlag(ORI_Gale_Quest_ReadVaultPath_2d329a79-0465-4e13-84d0-056efeac45c5)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_FoundBook_3f0fc364-1d8b-4327-a234-d6623c698ec9)
AND
NOT DB_GlobalFlag((FLAG)ORI_Gale_Quest_ReadVaultPath_2d329a79-0465-4e13-84d0-056efeac45c5)
AND
QRY_OnlyOnce("BookHintInvisibility")
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
THEN
QuestUpdate(_Character, _Quest, "BookHintInvisibility1");

PROC
PROC_ORI_Gale_JournalUpdate((STRING)_Update)
AND
QRY_ORI_Gale_JournalUpdateCandidate()
AND
DB_QRYRTN_Gale_JournalUpdateCandidate(_Character, _Quest)
THEN
QuestUpdate(_Character, _Quest, _Update);

//END_REGION

//REGION
IF
FlagSet(_Flag, _Character, _ID)
AND
DB_ORI_Gale_FlagOnDialogEnd(_Flag, _NewFlag)
THEN
DB_ORI_Gale_SetFlagAfterDialog(_NewFlag, _Character, _ID);
NOT DB_ORI_Gale_FlagOnDialogEnd(_Flag, _NewFlag);

IF
DialogEnded(_, _ID)
AND
DB_ORI_Gale_SetFlagAfterDialog(_NewFlag, _Character, _ID)
THEN
SetFlag(_NewFlag, _Character, 0);
NOT DB_ORI_Gale_SetFlagAfterDialog(_NewFlag, _Character, _ID);

//END_REGION

//REGION Elminster crimes

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_CrimeID, _, _, _, _Victim)
AND
_Victim != S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b
AND
NOT DB_OffStage(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b)
AND
CrimeIsContinuous(_CrimeID, 0)
AND
IsActive(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, 1)
THEN
CrimeIgnoreCrime(_CrimeID, S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b);

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_CrimeID, _, _, _, _Victim)
AND
_Victim != S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b
AND
NOT DB_OffStage(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b)
AND
CrimeIsContinuous(_CrimeID, 1)
THEN
CrimeIgnoreCrime(_CrimeID, S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b);

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_CrimeID, _, _, _, _Victim)
AND
_Victim != S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b
AND
DB_OffStage(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b)
AND
DB_PartOfTheTeam((CHARACTER)S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604)
AND
CrimeIsContinuous(_CrimeID, 1)
THEN
CrimeIgnoreCrime(_CrimeID, S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "ModWrapper_Gustav"
