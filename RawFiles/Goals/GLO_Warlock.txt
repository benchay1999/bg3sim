Version 1
SubGoalCombiner SGC_AND
INITSECTION
SetOnStage(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, 0);

DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_NotAppeared", 0);
DB_State_Current((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_NotAppeared");

// ACT 1
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_Proposal", 900);
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_Act1", 1000);

// ACT 2
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_Act2", 1500);

// ACT 3 (Korrilla the Spy)
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_Circus", 2000);

// ACT 3 (Raphael)
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_InviteToRaphael", 3000);
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_WaitForDeal", 3200);
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_AfterDeal", 3400);
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_LeftBaldursGate", 3600);

DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_Archive", 4000);
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_OffStage", 4200);
DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_WithRaphael", 4500);

DB_State_Priority((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_DefeatedInHell", 5000);

//Dead/defeated handling
DB_PermaDefeatedFlag(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, (FLAG)GLO_Warlock_State_PermaDefeated_9ddd355f-a036-494b-9da2-09e835b1a3bd);
DB_DefeatedStateFlag(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, (FLAG)GLO_Warlock_State_Defeated_c45bb049-b0e2-47f7-8367-39af9d0586ea);

DB_DeadOnceFlag((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, (FLAG)GLO_Warlock_State_Dead_5879eb0a-4667-4d87-90b8-8eee6a38ff85);
KBSECTION
//REGION Korrilla attacked handling 

//IF Korrilla is attacked teleport her out (that logic should stop working after Korrilla gets into a fight with players during Raphael's encounter in House of Hope)
IF
AttackedBy(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Attacker, _, _, _, _, _)
AND
DB_PartyMembers((CHARACTER)_Attacker)
THEN
PROC_GLO_Warlock_TeleportOut();

// Also players comment Korrilla's disappearance after they attack (should stop working after encountering her "resting")
IF
AttackedBy(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Player, _, _, _, _, _)
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_InviteToRaphael")
THEN
PROC_TryStartAD(GLO_KorrillaTheSpy_PAD_KorrillaVanishesReaction_d67b6532-f773-6e07-3a4f-615aa3b949dc, _Player);

PROC
PROC_GLO_Warlock_TeleportOut()
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_WithRaphael")
THEN
PROC_GLO_Warlock_TeleportOut_Internal();

PROC
PROC_GLO_Warlock_TeleportOut_Internal()
AND
IsOnStage(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, 1)
THEN
PROC_ForceStopDialog(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
PROC_RemoveDialog(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
PurgeOsirisQueue(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
PROC_GLO_Monitor_EntityPoof(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
SetHitpointsPercentage(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, 100.0);


//END_REGION

//REGION Korrilla statuses handling

PROC
PROC_GLO_Warlock_ApplyAllStatuses()
THEN
PROC_GLO_Warlock_ApplyStatus("GLO_KORRILLA_PROJECTEDIMAGE");
PROC_GLO_Warlock_ApplyStatus("GLO_KORRILLA_STEALTH");
PROC_GLO_Warlock_ApplyStatus("TWN_KORRILLATHESPY_PROXIMITYAURA");

PROC
PROC_GLO_Warlock_RemoveAllStatuses()
THEN
PROC_GLO_Warlock_RemoveStatus("GLO_KORRILLA_PROJECTEDIMAGE");
PROC_GLO_Warlock_RemoveStatus("GLO_KORRILLA_STEALTH");
PROC_GLO_Warlock_RemoveStatus("TWN_KORRILLATHESPY_PROXIMITYAURA");


PROC
PROC_GLO_Warlock_ApplyStatus((STRING)_Status)
AND
HasAppliedStatus((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Status, 0)
THEN
ApplyStatus(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Status, -1.0, 1, NULL_00000000-0000-0000-0000-000000000000);


PROC
PROC_GLO_Warlock_RemoveStatus((STRING)_Status)
AND
HasAppliedStatus((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Status, 1)
THEN
RemoveStatus(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Status, NULL_00000000-0000-0000-0000-000000000000);

//END_REGION

//REGION Korrilla flagging

IF
FlagSet(GLO_WarlockProposal_State_RaphaelWarlockMet_82d9eb12-512c-4f64-bd49-0630173168ed,_,_)
THEN
SetFlag((FLAG)GLO_Warlock_State_Encountered_eccb50a6-605a-423e-9f75-a49d16b71d16);
SetFlag((FLAG)GLO_Warlock_State_ShouldAppearInArchive_aaf145de-d32f-47f9-9334-49697509b561);

IF
FlagSet((FLAG)GLO_KorrillaTheSpy_State_Talked_822981af-61bc-211c-44c2-e23c0917ee65,_,_)
THEN
SetFlag((FLAG)GLO_Warlock_State_Encountered_eccb50a6-605a-423e-9f75-a49d16b71d16);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Start"
